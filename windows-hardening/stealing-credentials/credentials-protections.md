# Windows рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реБрд░рдХреНрд╖рд╛

## рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реБрд░рдХреНрд╖рд╛

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

## WDigest

[WDigest](https://technet.microsoft.com/pt-pt/library/cc778868\(v=ws.10\).aspx?f=255\&MSPPError=-2147217396) рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ Windows XP рдореЗрдВ рдкреЗрд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ рдЗрд╕реЗ HTTP рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред Microsoft рдиреЗ рдЗрд╕ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдИ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рд╣реИ** (Windows XP тАФ Windows 8.0 рдФрд░ Windows Server 2003 тАФ Windows Server 2012) рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **рдкреНрд▓реЗрди-рдЯреЗрдХреНрд╕реНрдЯ рдкрд╛рд╕рд╡рд░реНрдб LSASS рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ** (Local Security Authority Subsystem Service). **Mimikatz** LSASS рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдгреЛрдВ рдХреЛ **рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**:
```
sekurlsa::wdigest
```
рдпрд╣ рд╡реНрдпрд╡рд╣рд╛рд░ **рдирд┐рд╖реНрдХреНрд░рд┐рдп/рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ 1 рд╕реЗрдЯ рдХрд░рдХреЗ** _**UseLogonCredential**_ рдФрд░ _**Negotiate**_ рдХреЗ рдорд╛рди рдХреЛ _**HKEY\_LOCAL\_MACHINE\System\CurrentControlSet\Control\SecurityProviders\WDigest**_ рдореЗрдВред\
рдпрджрд┐ рдпреЗ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬрд┐рдпрд╛рдБ **рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИрдВ** рдпрд╛ рдорд╛рди **"0"** рд╣реИ, рддреЛ WDigest **рдирд┐рд╖реНрдХреНрд░рд┐рдп** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
```
reg query HKLM\SYSTEM\CurrentControlSet\Control\SecurityProviders\WDigest /v UseLogonCredential
```
## LSA рд╕реБрд░рдХреНрд╖рд╛

Microsoft рдиреЗ **Windows 8.1 рдФрд░ рдмрд╛рдж рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ** рдореЗрдВ LSA рдХреЗ рд▓рд┐рдП рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рджрд╛рди рдХреА рд╣реИ рддрд╛рдХрд┐ рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдЗрд╕рдХреА рдореЗрдореЛрд░реА рдХреЛ **рдкрдврд╝рдиреЗ** рдпрд╛ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рд╕реЗ **рд░реЛрдХ** рд╕рдХреЗрдВред рдЗрд╕рд╕реЗ рд╕рд╛рдорд╛рдиреНрдп `mimikatz.exe sekurlsa:logonpasswords` рдХрд╛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд╛рдо рдХрд░рдирд╛ рд░реБрдХ рдЬрд╛рдПрдЧрд╛ред\
рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ **рд╕рдХреНрд░рд┐рдп рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ _**RunAsPPL**_ рдХрд╛ рдорд╛рди _**HKEY\_LOCAL\_MACHINE\SYSTEM\CurrentControlSet\Control\LSA**_ рдореЗрдВ 1 рд╕реЗрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред
```
reg query HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\LSA /v RunAsPPL
```
### рдмрд╛рдпрдкрд╛рд╕

Mimikatz рдбреНрд░рд╛рдЗрд╡рд░ mimidrv.sys рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:

![](../../.gitbook/assets/mimidrv.png)

## Credential Guard

**Credential Guard** рд╡рд┐рдВрдбреЛрдЬ 10 (рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рдФрд░ рдПрдЬреБрдХреЗрд╢рди рд╕рдВрд╕реНрдХрд░рдг) рдореЗрдВ рдПрдХ рдирдИ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬреЛ рдЖрдкрдХреЗ рдорд╢реАрди рдкрд░ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХрд░рддреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдкрд╛рд╕ рдж рд╣реИрд╢ рд╕реЗред рдпрд╣ Virtual Secure Mode (VSM) рдирд╛рдордХ рддрдХрдиреАрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдЬреЛ CPU рдХреЗ рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬреЗрд╢рди рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ (рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдирд╣реАрдВ рд╣реИ) рддрд╛рдХрд┐ **рдореЗрдореЛрд░реА рдХреЗ рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХреЗ** (рдЖрдк рдЗрд╕реЗ Virtualization Based Security рдпрд╛ VBS рдХреЗ рд░реВрдк рдореЗрдВ рд╕реБрди рд╕рдХрддреЗ рд╣реИрдВ)ред VSM рдореБрдЦреНрдп **рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо** рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рд╕реЗ рдЕрд▓рдЧ рдПрдХ "рдмрдмрд▓" рдмрдирд╛рддрд╛ рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХрд░реНрдиреЗрд▓ рднреА рдФрд░ **рдХреЗрд╡рд▓ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рд╣реА VSM рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ** (рдЬрд┐рдиреНрд╣реЗрдВ **trustlets** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ) рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреА рд╣реИрдВред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдореБрдЦреНрдп OS рдХреА рдХреЛрдИ рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ VSM рдХреА рдореЗрдореЛрд░реА рдХреЛ рдкрдврд╝ рдирд╣реАрдВ рд╕рдХрддреА рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХрд░реНрдиреЗрд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рднреАред **Local Security Authority (LSA) VSM рдореЗрдВ trustlets рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ** рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдореБрдЦреНрдп OS рдореЗрдВ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рд╕рд╛рдорд╛рдиреНрдп **LSASS** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рднреА рд╣реИ рдЬреЛ рдореМрдЬреВрджрд╛ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕рдорд░реНрдерди рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рд▓реЗрдХрд┐рди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдпрд╣ VSM рдореЗрдВ рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░реЙрдХреНрд╕реА рдпрд╛ рд╕реНрдЯрдм рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ VSM рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдкрд░ рдЪрд▓рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рд▓рд┐рдП рд╣рдорд▓реЗ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рд╣рддреЗ рд╣реИрдВред рд╡рд┐рдВрдбреЛрдЬ 10 рдХреЗ рд▓рд┐рдП, Credential Guard рдХреЛ рдЪрд╛рд▓реВ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рдЖрдкрдХреЗ рд╕рдВрдЧрдарди рдореЗрдВ рддреИрдирд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИред**
[https://www.itprotoday.com/windows-10/what-credential-guard](https://www.itprotoday.com/windows-10/what-credential-guard) рд╕реЗред Credential Guard рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдФрд░ PS1 рд╕реНрдХреНрд░рд┐рдкреНрдЯ [рдпрд╣рд╛рдВ рдкрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИ](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage)ред рд╣рд╛рд▓рд╛рдВрдХрд┐, Windows 11 Enterprise, рд╕рдВрд╕реНрдХрд░рдг 22H2 рдФрд░ Windows 11 Education, рд╕рдВрд╕реНрдХрд░рдг 22H2 рдореЗрдВ, рд╕рдВрдЧрдд рд╕рд┐рд╕реНрдЯрдореЛрдВ рдореЗрдВ Windows Defender Credential Guard [рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЪрд╛рд▓реВ рд╣реЛрддрд╛ рд╣реИ](https://learn.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage#Default%20Enablement)ред

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **Mimikatz LSASS рд╕реЗ рд╣реИрд╢реЗрд╕ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╣реБрдд рдХреБрдЫ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛**ред рд▓реЗрдХрд┐рди рдЖрдк рд╣рдореЗрд╢рд╛ рдЕрдкрдирд╛ **рдХрд╕реНрдЯрдо SSP** рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреИрдкреНрдЪрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдХреНрд▓рд┐рдпрд░-рдЯреЗрдХреНрд╕реНрдЯ** рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИред\
[**SSP рдФрд░ рдпрд╣ рдХреИрд╕реЗ рдХрд░реЗрдВ рдпрд╣рд╛рдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА**](../active-directory-methodology/custom-ssp.md)ред

Credentials Guard рдХреЛ **рд╡рд┐рднрд┐рдиреНрди рддрд░реАрдХреЛрдВ рд╕реЗ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдпрд╣ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдпрд╛ рдирд╣реАрдВ, рдЖрдк _**HKLM\System\CurrentControlSet\Control\LSA**_ рдореЗрдВ рдХреБрдВрдЬреА _**LsaCfgFlags**_ рдХреЗ рдорд╛рди рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдЧрд░ рдорд╛рди **"1"** рд╣реИ рддреЛ рдпрд╣ UEFI рд▓реЙрдХ рдХреЗ рд╕рд╛рде рд╕рдХреНрд░рд┐рдп рд╣реИ, рдЕрдЧрд░ **"2"** рд╣реИ рддреЛ рд▓реЙрдХ рдХреЗ рдмрд┐рдирд╛ рд╕рдХреНрд░рд┐рдп рд╣реИ рдФрд░ рдЕрдЧрд░ **"0"** рд╣реИ рддреЛ рдпрд╣ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реИред\
рдпрд╣ **Credentials Guard рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдирд╣реАрдВ рд╣реИ** (рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рдордЬрдмреВрдд рд╕рдВрдХреЗрддрдХ рд╣реИ)ред\
Credential Guard рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдФрд░ PS1 рд╕реНрдХреНрд░рд┐рдкреНрдЯ [рдпрд╣рд╛рдВ рдкрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИ](https://docs.microsoft.com/en-us/windows/security/identity-protection/credential-guard/credential-guard-manage)ред
```
reg query HKLM\System\CurrentControlSet\Control\LSA /v LsaCfgFlags
```
## RDP RestrictedAdmin Mode

Windows 8.1 рдФрд░ Windows Server 2012 R2 рдХреЗ рд╕рд╛рде, рдирдП рд╕реБрд░рдХреНрд╖рд╛ рдлреАрдЪрд░реНрд╕ рдкреЗрд╢ рдХрд┐рдП рдЧрдП рдереЗред рдЗрди рд╕реБрд░рдХреНрд╖рд╛ рдлреАрдЪрд░реНрд╕ рдореЗрдВ рд╕реЗ рдПрдХ рд╣реИ _RDP рдХреЗ рд▓рд┐рдП Restricted Admin mode_ред рдпрд╣ рдирдпрд╛ рд╕реБрд░рдХреНрд╖рд╛ рдлреАрдЪрд░ [pass the hash](https://blog.ahasayen.com/pass-the-hash/) рд╣рдорд▓реЛрдВ рдХреЗ рдЬреЛрдЦрд┐рдо рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреЗрд╢ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдЬрдм рдЖрдк RDP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рджреВрд░рд╕реНрде рдХрдВрдкреНрдпреВрдЯрд░ рд╕реЗ рдЬреБрдбрд╝рддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреА рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдЙрд╕ рджреВрд░рд╕реНрде рдХрдВрдкреНрдпреВрдЯрд░ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛ рдЬрд╛рддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдЖрдк RDP рдХрд░ рд░рд╣реЗ рд╣реЛрддреЗ рд╣реИрдВред рдЖрдорддреМрд░ рдкрд░ рдЖрдк рджреВрд░рд╕реНрде рд╕рд░реНрд╡рд░реЛрдВ рд╕реЗ рдЬреБрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдЖрдкрдХреА рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдХрд╛ рдЗрди рд╕рднреА рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрдирд╛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдЦрддрд░рд╛ рд╣реИред

_RDP рдХреЗ рд▓рд┐рдП Restricted Admin mode_ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдЬрдм рдЖрдк рдХрдорд╛рдВрдб **mstsc.exe /RestrictedAdmin** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рджреВрд░рд╕реНрде рдХрдВрдкреНрдпреВрдЯрд░ рд╕реЗ рдЬреБрдбрд╝рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЙрд╕ рджреВрд░рд╕реНрде рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ рдкреНрд░рддрд┐ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реЛрдВрдЧреЗ, рд▓реЗрдХрд┐рди **рдЖрдкрдХреА рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдЙрд╕ рджреВрд░рд╕реНрде рдХрдВрдкреНрдпреВрдЯрд░ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдирд╣реАрдВ рдХреА рдЬрд╛рдПрдЧреА**, рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рд╣реЛрддрд╛ рдерд╛ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЕрдЧрд░ рдХреЛрдИ рдореИрд▓рд╡реЗрдпрд░ рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХреЛрдИ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЙрд╕ рджреВрд░рд╕реНрде рд╕рд░реНрд╡рд░ рдкрд░ рд╕рдХреНрд░рд┐рдп рд╣реИ, рддреЛ рдЖрдкрдХреА рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдЙрд╕ рджреВрд░рд╕реНрде рдбреЗрд╕реНрдХрдЯреЙрдк рд╕рд░реНрд╡рд░ рдкрд░ рдореИрд▓рд╡реЗрдпрд░ рдХреЗ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реЛрдЧреАред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЪреВрдВрдХрд┐ рдЖрдкрдХреА рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ RDP рд╕рддреНрд░ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдирд╣реАрдВ рдХреА рдЬрд╛ рд░рд╣реА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк **рдиреЗрдЯрд╡рд░реНрдХ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ** рддреЛ рдЖрдкрдХреА рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред **рдЗрд╕рдХреЗ рдмрдЬрд╛рдп рдорд╢реАрди рдХреА рдкрд╣рдЪрд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред

![](../../.gitbook/assets/ram.png)

[рдпрд╣рд╛рдБ](https://blog.ahasayen.com/restricted-admin-mode-for-rdp/) рд╕реЗред

## Cached Credentials

**рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛** рдХрд╛ рдЙрдкрдпреЛрдЧ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдШрдЯрдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ **Local** **Security Authority** (LSA) рджреНрд╡рд╛рд░рд╛ **рдкреНрд░рдорд╛рдгрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЖрдорддреМрд░ рдкрд░, рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╕реНрдерд╛рдкрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИ рдЬрдм рдПрдХ рдкрдВрдЬреАрдХреГрдд рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдХреЗрдЬ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓реЙрдЧрдСрди рдбреЗрдЯрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдкрдВрдЬреАрдХреГрдд рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдХреЗрдЬ **Kerberos** рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдпрд╛ **NTLM** рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

**Windows рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдСрдлрд▓рд╛рдЗрди рд╣реЛрдиреЗ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЕрдВрддрд┐рдо рджрд╕ рдбреЛрдореЗрди рд▓реЙрдЧрд┐рди рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ**ред рдЕрдЧрд░ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдСрдлрд▓рд╛рдЗрди рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдЕрднреА рднреА рдЕрдкрдиреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдореЗрдВ рд▓реЙрдЧ рдЗрди рдХрд░ рдкрд╛рдПрдЧрд╛**ред рдпрд╣ рдлреАрдЪрд░ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд▓реИрдкрдЯреЙрдк рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд╣реИ рдЬреЛ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЗ рдбреЛрдореЗрди рдореЗрдВ рд▓реЙрдЧ рдЗрди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред рдХрдВрдкреНрдпреВрдЯрд░ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣реАрдд рдкреНрд░рдорд╛рдгрд┐рдХрддрд╛ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд **рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рджреНрд╡рд╛рд░рд╛, рдпрд╛ рдЧреНрд░реБрдк рдкреЙрд▓рд┐рд╕реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ** рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
reg query "HKEY_LOCAL_MACHINE\SOFTWARE\MICROSOFT\WINDOWS NT\CURRENTVERSION\WINLOGON" /v CACHEDLOGONSCOUNT
```
рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рд╕реЗ рдЫрд┐рдкреЗ рд╣реЛрддреЗ рд╣реИрдВ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдЦрд╛рддреЛрдВ рд╕реЗ рднреАред **SYSTEM** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реА рдПрдХрдорд╛рддреНрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдЗрди **рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдХреЛ **рджреЗрдЦрдиреЗ** рдХреЗ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рд╣реЛрддреЗ рд╣реИрдВред рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рдЗрди рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рджреЗрдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдХреЛ SYSTEM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рддрдХ рдкрд╣реБрдБрдЪрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред\
рдХреИрд╢реНрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд░рдЬрд┐рд╕реНрдЯреНрд░реА рд╕реНрдерд╛рди рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ:
```
HKEY_LOCAL_MACHINE\SECURITY\Cache
```
**Mimikatz рд╕реЗ рдирд┐рдХрд╛рд▓рдирд╛**: `lsadump::cache`\
[рдпрд╣рд╛рдБ](http://juggernaut.wikidot.com/cached-credentials) рд╕реЗред

## рд╕реБрд░рдХреНрд╖рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛

рдЬрдм рд╕рд╛рдЗрди рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдореВрд╣ рдХрд╛ рд╕рджрд╕реНрдп рд╣реЛрддрд╛ рд╣реИ рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ:

* рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ (CredSSP) рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕рд╛рджрд╛ рдкрд╛рда рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдХреИрд╢ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛, рднрд▓реЗ рд╣реА **Allow delegating default credentials** рд╕рдореВрд╣ рдиреАрддрд┐ рд╕реЗрдЯрд┐рдВрдЧ рд╕рдХреНрд╖рдо рд╣реЛред
* Windows 8.1 рдФрд░ Windows Server 2012 R2 рдХреЗ рд╢реБрд░реВ рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде, Windows Digest рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕рд╛рджрд╛ рдкрд╛рда рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдХреИрд╢ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛, рднрд▓реЗ рд╣реА Windows Digest рд╕рдХреНрд╖рдо рд╣реЛред
* **NTLM** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ **рд╕рд╛рджрд╛ рдкрд╛рда рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕** рдпрд╛ NT **рдПрдХ-рддрд░рдлрд╛ рдлрдВрдХреНрд╢рди** (NTOWF) рдХреЛ **рдХреИрд╢ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛**ред
* **Kerberos** рдЕрдм **DES** рдпрд╛ **RC4 рдХреБрдВрдЬрд┐рдпрд╛рдБ** рдирд╣реАрдВ рдмрдирд╛рдПрдЧрд╛ред рд╕рд╛рде рд╣реА рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕рд╛рджрд╛ рдкрд╛рда рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдпрд╛ рджреАрд░реНрдШрдХрд╛рд▓рд┐рдХ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХ TGT рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рдХреЗ рдмрд╛рдж рдХреИрд╢ рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ред
* **рд╕рд╛рдЗрди-рдЗрди рдпрд╛ рдЕрдирд▓реЙрдХ рдХреЗ рд╕рдордп рдХреИрд╢реНрдб рд╕рддреНрдпрд╛рдкрдирдХрд░реНрддрд╛ рдирд╣реАрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдСрдлрд▓рд╛рдЗрди рд╕рд╛рдЗрди-рдЗрди рдЕрдм рд╕рдорд░реНрдерд┐рдд рдирд╣реАрдВ рд╣реИред

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдореВрд╣ рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рдмрд╛рдж, рд╕реБрд░рдХреНрд╖рд╛ рддрдм рд╢реБрд░реВ рд╣реЛрдЧреА рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбрд┐рд╡рд╛рдЗрд╕ рдореЗрдВ рд╕рд╛рдЗрди рдЗрди рдХрд░реЗрдЧрд╛ред [**рдпрд╣рд╛рдБ**](https://docs.microsoft.com/en-us/windows-server/security/credentials-protection-and-management/protected-users-security-group) рд╕реЗред

| Windows Server 2003 RTM | Windows Server 2003 SP1+ | <p>Windows Server 2012,<br>Windows Server 2008 R2,<br>Windows Server 2008</p> | Windows Server 2016          |
| ----------------------- | ------------------------ | ----------------------------------------------------------------------------- | ---------------------------- |
| Account Operators       | Account Operators        | Account Operators                                                             | Account Operators            |
| Administrator           | Administrator            | Administrator                                                                 | Administrator                |
| Administrators          | Administrators           | Administrators                                                                | Administrators               |
| Backup Operators        | Backup Operators         | Backup Operators                                                              | Backup Operators             |
| Cert Publishers         |                          |                                                                               |                              |
| Domain Admins           | Domain Admins            | Domain Admins                                                                 | Domain Admins                |
| Domain Controllers      | Domain Controllers       | Domain Controllers                                                            | Domain Controllers           |
| Enterprise Admins       | Enterprise Admins        | Enterprise Admins                                                             | Enterprise Admins            |
|                         |                          |                                                                               | Enterprise Key Admins        |
|                         |                          |                                                                               | Key Admins                   |
| Krbtgt                  | Krbtgt                   | Krbtgt                                                                        | Krbtgt                       |
| Print Operators         | Print Operators          | Print Operators                                                               | Print Operators              |
|                         |                          | Read-only Domain Controllers                                                  | Read-only Domain Controllers |
| Replicator              | Replicator               | Replicator                                                                    | Replicator                   |
| Schema Admins           | Schema Admins            | Schema Admins                                                                 | Schema Admins                |
| Server Operators        | Server Operators         | Server Operators                                                              | Server Operators             |

**рддрд╛рд▓рд┐рдХрд╛ [**рдпрд╣рд╛рдБ**](https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-c--protected-accounts-and-groups-in-active-directory) рд╕реЗред**

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЛ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░рдХреЗ PRs рдЬрдорд╛ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ рдпреЛрдЧрджрд╛рди рджреЗрдВред

</details>
