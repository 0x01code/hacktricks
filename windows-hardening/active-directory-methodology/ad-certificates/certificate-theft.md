# AD CS рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

- рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!

- рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)

- рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud)** рдХреЛ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## рдореИрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ

рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдЪреБрд░рд╛рдиреЗ рдХреЗ рддрд░реАрдХреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдпрд╣рд╛рдВ рдЖрдкрдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рд╣реИ:
```powershell
# Powershell
$CertPath = "C:\path\to\cert.pfx"
$CertPass = "P@ssw0rd"
$Cert = New-Object
System.Security.Cryptography.X509Certificates.X509Certificate2 @($CertPath, $CertPass)
$Cert.EnhancedKeyUsageList

# cmd
certutil.exe -dump -v cert.pfx
```
## рдХреНрд░рд┐рдкреНрдЯреЛ API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдирд┐рдХрд╛рд▓рдирд╛ - рдЪреЛрд░реА1

рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ **рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдбреЗрд╕реНрдХрдЯреЙрдк рд╕рддреНрд░** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реИред рдпрджрд┐ **рдирд┐рдЬреА рдХреБрдВрдЬреА** **рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп** рд╣реИ, рддреЛ рдХреЛрдИ рднреА рд╕реАрдзреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрд░ рджрд╛рдпрд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ `certmgr.msc` рдореЗрдВ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ `All Tasks тЖТ Export` ... рдкрд░ рдЬрд╛рдХрд░ рдкрд╛рд╕рд╡рд░реНрдб рд╕рдВрд░рдХреНрд╖рд┐рдд .pfx рдлрд╝рд╛рдЗрд▓ рдХреЛ рдирд┐рд░реНрдпрд╛рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред \
рдЗрд╕реЗ **рдХрд╛рд░реНрдпрдХреНрд░рдорд╛рддреНрдордХ рд░реВрдк рд╕реЗ** рднреА рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ PowerShell рдХрд╛ `ExportPfxCertificate` cmdlet рдпрд╛ [TheWover рдХрд╛ CertStealer C# рдкреНрд░реЛрдЬреЗрдХреНрдЯ](https://github.com/TheWover/CertStealer) рд╢рд╛рдорд┐рд▓ рд╣реИред

рдЗрди рддрд░реАрдХреЛрдВ рдХреЗ рдиреАрдЪреЗ, рдпреЗ рд╡рд┐рдзрд┐рдпрд╛рдБ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдЧреНрд░рд╣ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХреНрд░рд┐рдкреНрдЯреЛрдПрдкреАрдЖрдИ** (CAPI) рдпрд╛ рдЕрдзрд┐рдХ рдЖрдзреБрдирд┐рдХ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлреА рдПрдкреАрдЖрдИ: рдЕрдЧрд▓реА рдкреАрдврд╝реА (CNG) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВред рдпреЗ рдПрдкреАрдЖрдИ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдЧреНрд░рд╣ рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╡рд┐рднрд┐рдиреНрди рдЧрдгрд┐рддреАрдп рд╕реЗрд╡рд╛рдПрдВ рдХрд░рддреЗ рд╣реИрдВ (рдЕрдиреНрдп рдЙрдкрдпреЛрдЧреЛрдВ рдХреЗ рдмреАрдЪ)ред

рдпрджрд┐ рдирд┐рдЬреА рдХреБрдВрдЬреА рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп рдирд╣реАрдВ рд╣реИ, рддреЛ CAPI рдФрд░ CNG рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдВрдЧреЗред **Mimikatz рдХреЗ** `crypto::capi` рдФрд░ `crypto::cng` рдХрдорд╛рдВрдб CAPI рдФрд░ CNG рдХреЛ **рдирд┐рдЬреА рдХреБрдВрдЬреА** рдХреА рдирд┐рд░реНрдпрд╛рдд рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдкреИрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `crypto::capi` **рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдореЗрдВ CAPI рдХреЛ **рдкреИрдЪ рдХрд░рддрд╛ рд╣реИ** рдЬрдмрдХрд┐ `crypto::cng` **lsass.exe** рдХреА рдореЗрдореЛрд░реА рдХреЛ **рдкреИрдЪ рдХрд░рдиреЗ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

## рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА DPAPI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ - рдЪреЛрд░реА2

DPAPI рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../../windows-local-privilege-escalation/dpapi-extracting-passwords.md" %}
[dpapi-extracting-passwords.md](../../windows-local-privilege-escalation/dpapi-extracting-passwords.md)
{% endcontent-ref %}

Windows **DPAPI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕рдВрдЧреНрд░рд╣рд┐рдд рдХрд░рддрд╛ рд╣реИ**ред рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдорд╢реАрди рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЗ рд▓рд┐рдП рд╕рдВрдЧреНрд░рд╣ рд╕реНрдерд╛рдиреЛрдВ рдХреЛ рдЕрд▓рдЧ рдХрд░рддрд╛ рд╣реИред DPAPI рдмреНрд▓реЙрдмреНрд╕ рдХреЛ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рддреЗ рд╕рдордп, рдПрдХ рдбреЗрд╡рд▓рдкрд░ рдХреЛ рд╕рдордЭрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдиреЗ рдХреМрди рд╕реА рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлреА рдПрдкреАрдЖрдИ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рджреЛ рдПрдкреАрдЖрдИ рдХреЗ рдмреАрдЪ рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ рдЕрдВрддрд░ рд╣реЛрддрд╛ рд╣реИред SharpDPAPI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЗрди рдлрд╝рд╛рдЗрд▓ рдкреНрд░рд╛рд░реВрдк рдЕрдВрддрд░реЛрдВ рдХрд╛ рдзреНрдпрд╛рди рд░рдЦрддрд╛ рд╣реИред&#x20;

Windows рд╕рдмрд╕реЗ **рдЖрдорддреМрд░ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ** рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ `HKEY_CURRENT_USER\SOFTWARE\Microsoft\SystemCertificates` рдХреБрдВрдЬреА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣рд┐рдд рдХрд░рддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХреБрдЫ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рднреА `%APPDATA%\Microsoft\SystemCertificates\My\Certificates` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред рд╕рдВрдмрдВрдзрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕реНрдерд╛рди** рдореБрдЦреНрдп рд░реВрдк рд╕реЗ `%APPDATA%\Microsoft\Crypto\RSA\User SID\` рдХреЗ рд▓рд┐рдП **CAPI** рдХреБрдВрдЬреА рдФрд░ `%APPDATA%\Microsoft\Crypto\Keys\` рдХреЗ рд▓рд┐рдП **CNG** рдХреБрдВрдЬреА рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВред

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдЗрд╕рдХреЗ рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ:

1. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдЧреНрд░рд╣ рд╕реЗ **рдХрд┐рд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдЪреБрд░рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдЙрд╕реЗ рдкрд╣рдЪрд╛рдиреЗрдВ рдФрд░ рдХреБрдВрдЬреА рд╕рдВрдЧреНрд░рд╣ рдХрд╛ рдирд╛рдо рдирд┐рдХрд╛рд▓реЗрдВред
2. рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ **DPAPI рдорд╛рд╕реНрдЯрд░рдХреА** рдЦреЛрдЬреЗрдВред
3. рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ**ред

**рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**:
```bash
# With mimikatz
## Running in a process in the users context
dpapi::masterkey /in:"C:\PATH\TO\KEY" /rpc

# with mimikatz
## knowing the users password
dpapi::masterkey /in:"C:\PATH\TO\KEY" /sid:accountSid /password:PASS
```
рдЧреЛрдкрдиреАрдпрддрд╛ рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓ рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, [**SharpDPAPI**](https://github.com/GhostPack/SharpDPAPI) рдХреЗ `certificates` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ `/pvk`, `/mkfile`, `/password`, рдпрд╛ `{GUID}:KEY` рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдирд┐рдЬреА рдХреБрдВрдЬреА рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рдПрдХ `.pem` рдкрд╛рда рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЖрдЙрдЯрдкреБрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред
```bash
SharpDPAPI.exe certificates /mkfile:C:\temp\mkeys.txt

# Transfor .pem to .pfx
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
## рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА DPAPI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ - THEFT3

Windows рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреА рдХреБрдВрдЬреА `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЦрд╛рддреЗ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╕реНрдерд╛рдиреЛрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, SharpDPAPI рдЗрди рд╕рднреА рд╕реНрдерд╛рдиреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░реЗрдЧрд╛, рд▓реЗрдХрд┐рди рд╕рдмрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдкрд░рд┐рдгрд╛рдо `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\RSA\MachineKeys` (CAPI) рдФрд░ `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\Keys` (CNG) рд╕реЗ рдЖрддреЗ рд╣реИрдВред рдпреЗ **рдирд┐рдЬреА рдХреБрдВрдЬреА** рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдЧреНрд░рд╣ рдХреЗ рд╕рд╛рде рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИрдВ рдФрд░ Windows рдЗрдиреНрд╣реЗрдВ **рдорд╢реАрди рдХреЗ DPAPI рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА** рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рддрд╛ рд╣реИред\
рдЗрди рдХреБрдВрдЬреАрдпреЛрдВ рдХреЛ рдбреЛрдореЗрди рдХреА DPAPI рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд╣реАрдВ рдЦреЛрд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ рдЗрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ **рдХреЗрд╡рд▓ SYSTEM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рджреНрд╡рд╛рд░рд╛ рдкрд╣реБрдВрдЪрдиреЗ рдпреЛрдЧреНрдп **DPAPI\_SYSTEM LSA рд╕реАрдХреНрд░реЗрдЯ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЖрдк рдЗрд╕реЗ рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ **Mimikatz** рдХреЗ **`lsadump::secrets`** рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдирд┐рдХрд╛рд▓реА рдЧрдИ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдорд╢реАрди рдорд╛рд╕реНрдЯрд░рдХреБрдВрдЬреА** рдХреЛ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдЖрдк CAPI/CNG рдХреЛ рдкреИрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ **Mimikatz** рдХреЗ `crypto::certificates /export /systemstore:LOCAL_MACHINE` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
**SharpDPAPI** рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде **`/machine`** рдлреНрд▓реИрдЧ (рдЙрдЪреНрдЪрд╕реНрддрд░ рдкрд░) рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ **SYSTEM** рдХреЛ **рдЙрдЪреНрдЪрд╕реНрддрд░** рдХрд░реЗрдЧрд╛, **DPAPI\_SYSTEM** LSA рд╕реАрдХреНрд░реЗрдЯ рдХреЛ рдбрдВрдк рдХрд░реЗрдЧрд╛, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╢реАрди DPAPI рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдЧрд╛ рдФрд░ рдХреБрдВрдЬреА рдХреЗ рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ рдХреЛ рдПрдХ рдЦреЛрдЬ рд╕рд╛рд░рдгреА рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдЧрд╛ред

## рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЦреЛрдЬрдирд╛ - THEFT4

рдХрднреА-рдХрднреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рд┐рд░реНрдлрд╝ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдлрд╝рд╛рдЗрд▓ рд╢реЗрдпрд░реНрд╕ рдпрд╛ рдбрд╛рдЙрдирд▓реЛрдбреНрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВред\
рд╣рдордиреЗ рджреЗрдЦрд╛ рд╣реИ рдХрд┐ Windows рдХреЗ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рд╕рдмрд╕реЗ рдЖрдо рдкреНрд░рдХрд╛рд░ **`.pfx`** рдФрд░ **`.p12`** рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ, рдЬрдмрдХрд┐ рдХрднреА-рдХрднреА **`.pkcs12`** рдФрд░ **`.pem`** рднреА рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХрдо рдмрд╛рд░ред\
рдЕрдиреНрдп рджрд┐рд▓рдЪрд╕реНрдк рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╣реИрдВ: **`.key`** (_рдирд┐рдЬреА рдХреБрдВрдЬреА_), **`.crt/.cer`** (_рдХреЗрд╡рд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░_), **`.csr`** (_рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХрд╛ рдЕрдиреБрд░реЛрдз, рдЗрд╕рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдпрд╛ рдирд┐рдЬреА рдХреБрдВрдЬреА рд╢рд╛рдорд┐рд▓ рдирд╣реАрдВ рд╣реЛрддреА_), **`.jks/.keystore/.keys`** (_рдЬрд╛рд╡рд╛ рдХреАрд╕реНрдЯреЛрд░ред рдЬрд╛рд╡рд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ + рдирд┐рдЬреА рдХреБрдВрдЬреА рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ_)

рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдкрд╛рд╡рд░рд╢реЗрд▓ рдпрд╛ cmd рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрди рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреА рдЦреЛрдЬ рдХрд░реЗрдВред

рдпрджрд┐ рдЖрдкрдХреЛ рдПрдХ **PKCS#12** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓ рдорд┐рд▓рддреА рд╣реИ рдФрд░ рд╡рд╣ **рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд** рд╣реИ, рддреЛ рдЖрдк [pfx2john.py](https://fossies.org/dox/john-1.9.0-jumbo-1/pfx2john\_8py\_source.html) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╣реИрд╢ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ JohnTheRipper рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕реЗ **рдХреНрд░реИрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ NTLM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЪреЛрд░реА - THEFT5

> NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП \[MS-NLMP] рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП, PKCA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, KDC рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рд╡рд┐рд╢реЗрд╖рддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ (PAC) **`PAC_CREDENTIAL_INFO`** рдмрдлрд░ рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ NTLM рд╡рди-рд╡реЗрддрд╛рдирд┐рдХ рдлрд╝рдВрдХреНрд╢рди (OWF) рд▓реМрдЯрд╛рддрд╛ рд╣реИ

рддреЛ, рдпрджрд┐ рдЦрд╛рддрд╛ рдкреНрд░рдорд╛рдгреАрдХреГрдд рд╣реЛрддрд╛ рд╣реИ рдФрд░ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ **TGT рдкреНрд░рд╛рдкреНрдд** рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡рд░реНрддрдорд╛рди рд╣реЛрд╕реНрдЯ рдХреЛ **рд╣рдорд╛рд░реЗ NTLM рд╣реИрд╢ рдХреЛ TGT рд╕реЗ рдкреНрд░рд╛рдкреНрдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ "рдлреЗрд▓рд╕реЗрдл" рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдкреБрд░рд╛рдиреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП NTLM рд╕рд╛рджрд╛-рдкрд╛рда рдХреА рдПрдХ **`PAC_CREDENTIAL_DATA`** **рд╕рдВрд░рдЪрдирд╛** рдХреЛ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдбреЗрдЯрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ (NDR) рд╕реАрд░реАрдпрд▓рд╛рдЗрдЬрд╝ рдХреА рдЧрдИ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рд╣реИред

[**Kekeo**](https://github.com/gentilkiwi/kekeo) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде рдПрдХ TGT рдХреЗ рд▓рд┐рдП рдкреВрдЫ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ NTML рд╣реИрд╢ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
```bash
tgt::pac /caname:thename-DC-CA /subject:harmj0y /castore:current_user /domain:domain.local
```
Kekeo рдХрд╛ рдЕрдиреБрдкрд╛рд▓рди рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдЕрдВрддрд░реНрдЧрдд рдпрд╣ рднреА рдХрд╛рдо рдХрд░реЗрдЧрд╛ рдЬреЛ рд╕реНрдорд╛рд░реНрдЯрдХрд╛рд░реНрдб рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╣реИрдВ рдЬреЛ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдкреНрд▓рдЧ рдЗрди рд╣реИрдВ, рдпрджрд┐ рдЖрдк [**рдкрд┐рди рдХреЛ рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**](https://github.com/CCob/PinSwipe)**.** рдпрд╣ [**Rubeus**](https://github.com/GhostPack/Rubeus) рдореЗрдВ рднреА рд╕рдорд░реНрдерд┐рдд рд╣реЛрдЧрд╛ред

## рд╕рдВрджрд░реНрдн

* рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА [https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf) рд╕реЗ рд▓реА рдЧрдИ рд╣реИред

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

- рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!

- рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ред

- рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com)

- **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рдХреЛ [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред**

</details>
