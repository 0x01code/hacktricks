# рдПрдбреА рд╕реАрдПрд╕ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЪреЛрд░реА

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks_live) рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

**рдпрд╣ [https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf) рд╕реЗ рдЕрджреНрднреБрдд рд╢реЛрдз рдХреЗ рдЪреЛрд░реА рдЕрдзреНрдпрд╛рдпреЛрдВ рдХрд╛ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИ**


## рдореИрдВ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ

рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЪреЛрд░реА рдХреИрд╕реЗ рдХрд░реЗрдВ рдЗрд╕реЗ рдЬрд╛рдВрдЪрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдпрд╣рд╛рдБ рдЖрдкрдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреНрдпрд╛ рд╣реИ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рд╣реИ:
```powershell
# Powershell
$CertPath = "C:\path\to\cert.pfx"
$CertPass = "P@ssw0rd"
$Cert = New-Object
System.Security.Cryptography.X509Certificates.X509Certificate2 @($CertPath, $CertPass)
$Cert.EnhancedKeyUsageList

# cmd
certutil.exe -dump -v cert.pfx
```
## рдХреНрд░рд┐рдкреНрдЯреЛ API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдирд┐рдХрд╛рд▓рдирд╛ - рдЪреЛрд░реА1

**рдПрдХ рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдбреЗрд╕реНрдХрдЯреЙрдк рд╕рддреНрд░** рдореЗрдВ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛, рд╕рд╛рде рд╣реА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдпрджрд┐ **рдирд┐рдЬреА рдХреБрдВрдЬреА рдирд┐рд░реНрдпрд╛рддреАрдп рд╣реИ**, рдЖрд╕рд╛рдиреА рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕реЗ `certmgr.msc` рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рддрдХ рдкрд╣реБрдВрдЪрдХрд░, рдЙрд╕ рдкрд░ рджрд╛рдпрд╛рдБ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдФрд░ `All Tasks тЖТ Export` рдХрд╛ рдЪрдпрди рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд .pfx рдлрд╝рд╛рдЗрд▓ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

**рдХрд╛рд░реНрдпрдХреНрд░рдорд╛рддреНрдордХ рджреГрд╖реНрдЯрд┐рдХреЛрдг** рдХреЗ рд▓рд┐рдП, PowerShell `ExportPfxCertificate` cmdlet рдЬреИрд╕реЗ рдЙрдкрдХрд░рдг рдпрд╛ [TheWoverтАЩs CertStealer C# project](https://github.com/TheWover/CertStealer) рдЬреИрд╕реЗ рдкрд░рд┐рдпреЛрдЬрдирд╛рдПрдБ рдЙрдкрд▓рдмреНрдз рд╣реИрдВред рдпреЗ **Microsoft CryptoAPI** (CAPI) рдпрд╛ Cryptography API: Next Generation (CNG) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реНрдЯреЛрд░ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рдпреЗ API рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рд╕реЗрд╡рд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ, рдЬрд┐рдирдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдЧреНрд░рд╣ рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЗрд╡рд╛рдПрдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдирд┐рд░реНрдпрд╛рддреАрдп рд░реВрдк рд╕реЗ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЙрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреА рдирд┐рдХрд╛рд╕реА рдХреЛ рдЖрдо рддреМрд░ рдкрд░ CAPI рдФрд░ CNG рджреЛрдиреЛрдВ рдмреНрд▓реЙрдХ рдХрд░реЗрдВрдЧреЗред рдЗрд╕ рдкреНрд░рддрд┐рдмрдВрдз рдХреЛ рджреВрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, Mimikatz рдЬреИрд╕реЗ рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред Mimikatz `crypto::capi` рдФрд░ `crypto::cng` рдХрдорд╛рдВрдб рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреБрдВрдЬреА рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, `crypto::capi` рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рднреАрддрд░ CAPI рдХреЛ рдкреИрдЪ рдХрд░рддрд╛ рд╣реИ, рдЬрдмрдХрд┐ `crypto::cng` **lsass.exe** рдХреА рд╕реНрдореГрддрд┐ рдХреЛ рдкреИрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рдХреНрд╖реНрдп рд░рдЦрддрд╛ рд╣реИред

## рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА DPAPI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ - рдЪреЛрд░реА2

DPAPI рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА:

{% content-ref url="../../windows-local-privilege-escalation/dpapi-extracting-passwords.md" %}
[dpapi-extracting-passwords.md](../../windows-local-privilege-escalation/dpapi-extracting-passwords.md)
{% endcontent-ref %}

Windows рдореЗрдВ, **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА DPAPI рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ**ред рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдорд╢реАрди рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЗ рднрдВрдбрд╛рд░рдг рд╕реНрдерд╛рди** рдЕрд▓рдЧ рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ рдлрд╝рд╛рдЗрд▓ рд╕рдВрд░рдЪрдирд╛рдПрдБ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рд╡рд┐рдЬреНрдЮрд╛рди рдХреНрд░рд┐рдпрд╛рддреНрдордХ API рдкрд░ рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИрдВред **SharpDPAPI** рдПрдХ рдЙрдкрдХрд░рдг рд╣реИ рдЬреЛ DPAPI рдмреНрд▓реЙрдм рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рддреЗ рд╕рдордп рдЗрди рдЕрдВрддрд░ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдиреЗрд╡рд┐рдЧреЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ `HKEY_CURRENT_USER\SOFTWARE\Microsoft\SystemCertificates` рдХреЗ рддрд╣рдд рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреБрдЫ рдХреЛ рднреА `%APPDATA%\Microsoft\SystemCertificates\My\Certificates` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрди рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд╕рдВрдмрдВрдзрд┐рдд **рдирд┐рдЬреА рдХреБрдВрдЬреА** рд╕рд╛рдорд╛рдиреНрдпрдд: `%APPDATA%\Microsoft\Crypto\RSA\User SID\` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреА рд╣реИрдВ **CAPI** рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдФрд░ `%APPDATA%\Microsoft\Crypto\Keys\` рдореЗрдВ **CNG** рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдПред

**рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдЗрд╕рдХреА рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ** рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ:

1. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╕реНрдЯреЛрд░ рд╕реЗ **рд▓рдХреНрд╖реНрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЪрдпрди** рдХрд░рдирд╛ рдФрд░ рдЙрд╕рдХреА рдХреБрдВрдЬреА рд╕реНрдЯреЛрд░ рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ред
2. **рдЙрд╕ рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА** рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ред
3. **рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛ред

**рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рджреГрд╖реНрдЯрд┐рдХреЛрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
# With mimikatz, when running in the user's context
dpapi::masterkey /in:"C:\PATH\TO\KEY" /rpc

# With mimikatz, if the user's password is known
dpapi::masterkey /in:"C:\PATH\TO\KEY" /sid:accountSid /password:PASS
```
рдЕрдзрд┐рдХрддрдо рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреА рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреЛ рд╕реБрдЧрдо рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, [**SharpDPAPI**](https://github.com/GhostPack/SharpDPAPI) рд╕реЗ `certificates` рдХрдорд╛рдВрдб рдлрд╛рдпрджреЗрдордВрдж рд╕рд╛рдмрд┐рдд рд╣реЛрддрд╛ рд╣реИред рдпрд╣ `/pvk`, `/mkfile`, `/password`, рдпрд╛ `{GUID}:KEY` рдХреЛ рддрд░реНрдХ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдирд┐рдЬреА рдХреБрдВрдЬреА рдФрд░ рдЬреБрдбрд╝реЗ рд╣реБрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░ рд╕рдХреЗ, рдЬрд┐рд╕рд╕реЗ рдПрдХ `.pem` рдлрд╝рд╛рдЗрд▓ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИред
```bash
# Decrypting using SharpDPAPI
SharpDPAPI.exe certificates /mkfile:C:\temp\mkeys.txt

# Converting .pem to .pfx
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
## рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА DPAPI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ - THEFT3

Windows рджреНрд╡рд╛рд░рд╛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates` рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдЬреЛ `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\RSA\MachineKeys` (CAPI рдХреЗ рд▓рд┐рдП) рдФрд░ `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\Keys` (CNG рдХреЗ рд▓рд┐рдП) рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рдорд╢реАрди рдХреЗ DPAPI рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпреЗ рдХреБрдВрдЬрд┐рдпрд╛рдБ рдбреЛрдореЗрди рдХреА DPAPI рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХреЗ рд╕рд╛рде рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдирд╣реАрдВ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ; рдЗрд╕рдХреЗ рдмрдЬрд╛рдп, **DPAPI_SYSTEM LSA рд╕реАрдХреНрд░реЗрдЯ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдЬрд┐рд╕рдХреЛ рдХреЗрд╡рд▓ SYSTEM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддрд╛ рд╣реИред

рдореИрдиреБрдЕрд▓ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреЛ **Mimikatz** рдореЗрдВ `lsadump::secrets` рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ DPAPI_SYSTEM LSA рд╕реАрдХреНрд░реЗрдЯ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛ рд╕рдХреЗ, рдФрд░ рдЗрд╕рдХреЗ рдмрд╛рдж рдЗрд╕ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╢реАрди рдорд╛рд╕реНрдЯрд░рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, Mimikatz рдХрд╛ `crypto::certificates /export /systemstore:LOCAL_MACHINE` рдХрдорд╛рдВрдб рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм CAPI/CNG рдХреЛ рдкреИрдЪ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

**SharpDPAPI** рдЕрдкрдиреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдЬрдм `/machine` рдлреНрд▓реИрдЧ рдХреЛ рдЙрдЪреНрдЪ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ SYSTEM рдореЗрдВ рдЙрдиреНрдирддрд┐ рдХрд░рддрд╛ рд╣реИ, DPAPI_SYSTEM LSA рд╕реАрдХреНрд░реЗрдЯ рдХреЛ рдбрдВрдк рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдорд╢реАрди DPAPI рдорд╛рд╕реНрдЯрд░рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЗрди рд╕рд╛рджрд╛ рдХреБрдВрдЬрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬреАрдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЦреЛрдЬ рд╕рд╛рд░рдгреА рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред


## рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЦреЛрдЬрдирд╛ - THEFT4

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрднреА-рдХрднреА рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╕реАрдзреЗ рдорд┐рд▓рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдлрд╝рд╛рдЗрд▓ рд╢реЗрдпрд░реНрд╕ рдпрд╛ рдбрд╛рдЙрдирд▓реЛрдбреНрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВред Windows рд╡рд╛рддрд╛рд╡рд░рдг рдХреЗ рд▓рд┐рдП рд▓рдХреНрд╖рд┐рдд рд╕рдмрд╕реЗ рдЖрдо рдкреНрд░рдХрд╛рд░ рдХреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ `.pfx` рдФрд░ `.p12` рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХрдо рдЖрдорддреМрд░ рдкрд░, `.pkcs12` рдФрд░ `.pem` рдЬреИрд╕реЗ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╡рд╛рд▓реА рдлрд╝рд╛рдЗрд▓реЗрдВ рднреА рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИрдВред рдЕрддрд┐рд░рд┐рдХреНрдд рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:
- рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП `.key`,
- рдХреЗрд╡рд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд▓рд┐рдП `.crt`/`.cer`,
- рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рд╛рдЗрдирд┐рдВрдЧ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдП `.csr`, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдпрд╛ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВ,
- рдЬрд╛рд╡рд╛ рдХреЗрд╕реНрдЯреЛрд░реНрд╕ рдХреЗ рд▓рд┐рдП `.jks`/`.keystore`/`.keys`, рдЬрд┐рдирдореЗрдВ рдЬрд╛рд╡рд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд╕рд╛рде рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ рд╣реЛ рд╕рдХрддреА рд╣реИрдВред

рдЗрди рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ PowerShell рдпрд╛ рдХрдорд╛рдВрдб рдкреНрд░реЙрдореНрдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреА рдЦреЛрдЬ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

рдЬрдм рдПрдХ PKCS#12 рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдлрд╝рд╛рдЗрд▓ рдорд┐рд▓рддреА рд╣реИ рдФрд░ рдЗрд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ `pfx2john.py` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣реИрд╢ рдХрд╛ рдирд┐рдХрд╛рд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ [fossies.org](https://fossies.org/dox/john-1.9.0-jumbo-1/pfx2john_8py_source.html) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред рдЗрд╕рдХреЗ рдмрд╛рдж, JohnTheRipper рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдХреНрд░реИрдХ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
```powershell
# Example command to search for certificate files in PowerShell
Get-ChildItem -Recurse -Path C:\Users\ -Include *.pfx, *.p12, *.pkcs12, *.pem, *.key, *.crt, *.cer, *.csr, *.jks, *.keystore, *.keys

# Example command to use pfx2john.py for extracting a hash from a PKCS#12 file
pfx2john.py certificate.pfx > hash.txt

# Command to crack the hash with JohnTheRipper
john --wordlist=passwords.txt hash.txt
```
## NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪреЛрд░реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪреЛрд░реА

рджрд┐рдпрд╛ рдЧрдпрд╛ рд╕рд╛рдордЧреНрд░реА NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЪреЛрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рдзрд┐ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддреА рд╣реИ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЪреЛрд░реА рд╡рд┐рдзрд┐ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ THEFT5. рдпрд╣рд╛рдБ рдПрдХ рдкрд╛рд╕рд┐рд╡ рд╡реЙрдпрд╕ рдореЗрдВ рдкреБрдирд░реНрд╡рд┐рд╡рд░рдг рд╣реИ, рд╕рд╛рдордЧреНрд░реА рдХреЛ рдЕрдирд╛рдорд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЬрд╣рд╛рдБ рдпреЛрдЧреНрдп рд╣реЛ, рд╕рдВрдХреНрд╖реЗрдкрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:

рдПрдирдЯреАрдПрд▓рдПрдо рдкреНрд░рдорд╛рдгреАрдХрд░рдг [рдПрдордПрд╕-рдПрдирдПрд▓рдПрдордкреА] рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдРрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЬреЛ рдХреЗрд░рдмреЗрд░реЛрд╕ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рд╕реБрд╡рд┐рдзрд╛ рдирд╣реАрдВ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ, рдХреЗрдбреАрд╕реА рдХреЛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рдЙрдкрдпреБрдХреНрддрддрд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ (рдкреАрдПрд╕реА) рдХреЗ рднреАрддрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдПрдирдЯреАрдПрд▓рдПрдо рд╡рди-рд╡реЗ рдлрд╝рдВрдХреНрд╢рди (рдУрдбрдмреНрд▓реНрдпреВрдПрдл) рд▓реМрдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ `PAC_CREDENTIAL_INFO` рдмрдлрд░ рдореЗрдВ, рдЬрдм рдкреАрдХреЗрд╕реАрдП рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдпрджрд┐ рдПрдХ рдЦрд╛рддрд╛ рдкреАрдХреЗрдЖрдИрдПрдирдЖрдИрдЯреА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдЯрд┐рдХрдЯ-рдЧреНрд░рд╛рдВрдЯрд┐рдВрдЧ рдЯрд┐рдХрдЯ (рдЯреАрдЬреАрдЯреА) рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡рд░реНрддрдорд╛рди рд╣реЛрд╕реНрдЯ рдХреЛ рдПрдирдЯреАрдПрд▓рдПрдо рд╣реИрд╢ рдХреЛ рдЯреАрдЬреАрдЯреА рд╕реЗ рдирд┐рдХрд╛рд▓рдиреЗ рдХреА рдПрдХ рдпрд╛рдВрддреНрд░рд┐рдХ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рддреА рд╣реИ рдЬреЛ рдкреБрд░рд╛рдиреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `PAC_CREDENTIAL_DATA` рд╕рдВрд░рдЪрдирд╛ рдХрд╛ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреЛ рдореМрд▓рд┐рдХ рд░реВрдк рд╕реЗ рдПрдирдбреАрдЖрд░ рд╕реАрд░реАрдпрд▓рд╛рдЗрдЬреНрдб рдЪрд┐рддреНрд░рдг рд╣реИ рдПрдирдЯреАрдПрд▓рдПрдо рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ рдХрд╛ред

**Kekeo** рдЙрдкрдпреЛрдЧрд┐рддрд╛, [https://github.com/gentilkiwi/kekeo](https://github.com/gentilkiwi/kekeo) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИ, рдЬрд┐рд╕реЗ рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рдбреЗрдЯрд╛ рдХреЛ рд╕рдореЗрдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдПрдХ рдЯреАрдЬреАрдЯреА рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрд▓реНрд▓реЗрдЦрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдПрдирдЯреАрдПрд▓рдПрдо рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдореЗрдВ рд╕рд╣рд╛рдпрддрд╛ рдорд┐рд▓рддреА рд╣реИред рдЗрд╕ рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдЖрджреЗрд╢ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```bash
tgt::pac /caname:generic-DC-CA /subject:genericUser /castore:current_user /domain:domain.local
```
Additionally, рдпрд╣ рдиреЛрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ Kekeo рд╕реНрдорд╛рд░реНрдЯрдХрд╛рд░реНрдб рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдкрд┐рди рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, [https://github.com/CCob/PinSwipe](https://github.com/CCob/PinSwipe) рдкрд░ рд╕рдВрджрд░реНрдн рджреЗрддреЗ рд╣реБрдПред рдпрд╣реА рдХреНрд╖рдорддрд╛ **Rubeus** рджреНрд╡рд╛рд░рд╛ рднреА рд╕рдорд░реНрдерд┐рдд рд╣реЛрдиреЗ рдХрд╛ рд╕рдВрдХреЗрдд рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ [https://github.com/GhostPack/Rubeus](https://github.com/GhostPack/Rubeus) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред

рдпрд╣ рд╡реНрдпрд╛рдЦреНрдпрд╛ NTLM рдкреНрд░рдорд╛рдг рдкрддреНрд░ рдЪреЛрд░реА рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдФрд░ рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рд╕рдВрдХреНрд╖реЗрдкрд┐рдд рдХрд░рддреА рд╣реИ рдЬреЛ PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ NTLM рд╣реИрд╢ рдХреА рдкреБрдирд░реНрдкреНрд░рд╛рдкреНрддрд┐ рдкрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ, рдФрд░ рдЙрдкрдХрд░рдгреЛрдВ рдХреЛ рдЬреЛ рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддреЗ рд╣реИрдВред
