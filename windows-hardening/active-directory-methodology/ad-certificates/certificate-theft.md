# AD CS рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ **рдореБрдЭреЗ рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

## рдореИрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдХреНрдпрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ

рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдЪреБрд░рд╛рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдЬрд╛рдВрдЪрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдпрд╣рд╛рдБ рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА рд╣реИ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд┐рд╕ рдХрд╛рдо рдЖ рд╕рдХрддрд╛ рд╣реИ:
```powershell
# Powershell
$CertPath = "C:\path\to\cert.pfx"
$CertPass = "P@ssw0rd"
$Cert = New-Object
System.Security.Cryptography.X509Certificates.X509Certificate2 @($CertPath, $CertPass)
$Cert.EnhancedKeyUsageList

# cmd
certutil.exe -dump -v cert.pfx
```
## рдХреНрд░рд┐рдкреНрдЯреЛ APIs рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рд░реНрдпрд╛рдд рдХрд░рдирд╛ тАУ THEFT1

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рдорд╢реАрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдирд┐рдХрд╛рд▓рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рдПрдХ **рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдбреЗрд╕реНрдХрдЯреЙрдк рд╕рддреНрд░** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реИред рдпрджрд┐ **рдирд┐рдЬреА рдХреБрдВрдЬреА** **рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп** рд╣реИ, рддреЛ рдХреЛрдИ рднреА `certmgr.msc` рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрд░ рд░рд╛рдЗрдЯ рдХреНрд▓рд┐рдХ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ `All Tasks тЖТ Export`... рдкрд░ рдЬрд╛рдХрд░ рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб рд╕реБрд░рдХреНрд╖рд┐рдд .pfx рдлрд╛рдЗрд▓ рдирд┐рд░реНрдпрд╛рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред \
рдЗрд╕реЗ **рдкреНрд░реЛрдЧреНрд░рд╛рдореЗрдЯрд┐рдХрд▓реА** рднреА рдкреВрд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдгреЛрдВ рдореЗрдВ PowerShell рдХрд╛ `ExportPfxCertificate` cmdlet рдпрд╛ [TheWover рдХреА CertStealer C# рдкреНрд░реЛрдЬреЗрдХреНрдЯ](https://github.com/TheWover/CertStealer) рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

рдЗрди рддрд░реАрдХреЛрдВ рдХреЗ рдиреАрдЪреЗ, рдпреЗ **Microsoft CryptoAPI** (CAPI) рдпрд╛ рдЕрдзрд┐рдХ рдЖрдзреБрдирд┐рдХ Cryptography API: Next Generation (CNG) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реНрдЯреЛрд░ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░рддреЗ рд╣реИрдВред рдпреЗ APIs рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рдВрдЧреНрд░рд╣рдг рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рд╕реЗрд╡рд╛рдПрдВ рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВ (рдЕрдиреНрдп рдЙрдкрдпреЛрдЧреЛрдВ рдХреЗ рдмреАрдЪ рдореЗрдВ)ред

рдпрджрд┐ рдирд┐рдЬреА рдХреБрдВрдЬреА рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп рдирд╣реАрдВ рд╣реИ, рддреЛ CAPI рдФрд░ CNG рдирд┐рд░реНрдпрд╛рдд рдпреЛрдЧреНрдп рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХрд╛ рдирд┐рд╖реНрдХрд░реНрд╖рдг рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗред **Mimikatz рдХреЗ** `crypto::capi` рдФрд░ `crypto::cng` рдХрдорд╛рдВрдбреНрд╕ CAPI рдФрд░ CNG рдХреЛ **рдирд┐рд░реНрдпрд╛рдд рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдкреИрдЪ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `crypto::capi` **рдкреИрдЪ** **CAPI** рдХреЛ рд╡рд░реНрддрдорд╛рди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдЬрдмрдХрд┐ `crypto::cng` **lsass.exe рдХреА** рдореЗрдореЛрд░реА рдХреЛ **рдкреИрдЪ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред

## DPAPI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЪреЛрд░реА тАУ THEFT2

DPAPI рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП:

{% content-ref url="../../windows-local-privilege-escalation/dpapi-extracting-passwords.md" %}
[dpapi-extracting-passwords.md](../../windows-local-privilege-escalation/dpapi-extracting-passwords.md)
{% endcontent-ref %}

Windows **DPAPI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ**ред Microsoft рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдФрд░ рдорд╢реАрди рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдВрдЧреНрд░рд╣рдг рд╕реНрдерд╛рдиреЛрдВ рдХреЛ рдЕрд▓рдЧ рдХрд░рддрд╛ рд╣реИред рдЬрдм рдореИрдиреНрдпреБрдЕрд▓ рд░реВрдк рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб DPAPI рдмреНрд▓реЙрдмреНрд╕ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдбреЗрд╡рд▓рдкрд░ рдХреЛ рд╕рдордЭрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ OS рдиреЗ рдХреМрди рд╕рд╛ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлреА API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдирд┐рдЬреА рдХреБрдВрдЬреА рдлрд╛рдЗрд▓ рд╕рдВрд░рдЪрдирд╛ рджреЛ APIs рдХреЗ рдмреАрдЪ рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИред SharpDPAPI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдпрд╣ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдЗрди рдлрд╛рдЗрд▓ рдкреНрд░рд╛рд░реВрдк рднрд┐рдиреНрдирддрд╛рдУрдВ рдХреЛ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рддрд╛ рд╣реИред

Windows рд╕рдмрд╕реЗ **рдЖрдорддреМрд░ рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ `HKEY_CURRENT_USER\SOFTWARE\Microsoft\SystemCertificates` рдХреБрдВрдЬреА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ**, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдХреБрдЫ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП **рднреА** `%APPDATA%\Microsoft\SystemCertificates\My\Certificates` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВред рд╕рдВрдмрдВрдзрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдирд┐рдЬреА рдХреБрдВрдЬреА рд╕реНрдерд╛рди** рдореБрдЦреНрдп рд░реВрдк рд╕реЗ `%APPDATA%\Microsoft\Crypto\RSA\User SID\` рдкрд░ **CAPI** рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рдФрд░ `%APPDATA%\Microsoft\Crypto\Keys\` рдкрд░ **CNG** рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЗ рд▓рд┐рдП рд╣реЛрддреЗ рд╣реИрдВред

рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдЙрд╕рдХреА рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ:

1. рдкрд╣рдЪрд╛рдиреЗрдВ рдХрд┐ **рдХреМрди рд╕рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЖрдк рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реНрдЯреЛрд░ рд╕реЗ рдЪреБрд░рд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдФрд░ рдХреБрдВрдЬреА рд╕реНрдЯреЛрд░ рдХрд╛ рдирд╛рдо рдирд┐рдХрд╛рд▓реЗрдВред
2. **DPAPI рдорд╛рд╕реНрдЯрд░рдХреА** рдЦреЛрдЬреЗрдВ рдЬреЛ рд╕рдВрдмрдВрдзрд┐рдд рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред
3. рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░реЗрдВ**ред

**рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ DPAPI рдорд╛рд╕реНрдЯрд░рдХреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**:
```bash
# With mimikatz
## Running in a process in the users context
dpapi::masterkey /in:"C:\PATH\TO\KEY" /rpc

# with mimikatz
## knowing the users password
dpapi::masterkey /in:"C:\PATH\TO\KEY" /sid:accountSid /password:PASS
```
рдорд╛рд╕реНрдЯрд░рдХреА рдлрд╛рдЗрд▓ рдФрд░ рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдХреА рдлрд╛рдЗрд▓ рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрд╢рди рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, [**SharpDPAPIтАЩs**](https://github.com/GhostPack/SharpDPAPI) `certificates` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ `/pvk`, `/mkfile`, `/password`, рдпрд╛ `{GUID}:KEY` рдЖрд░реНрдЧреНрдпреВрдореЗрдВрдЯреНрд╕ рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдХреАрдЬрд╝ рдФрд░ рд╕рдВрдмрдВрдзрд┐рдд рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдЬрд┐рд╕рд╕реЗ рдПрдХ `.pem` рдЯреЗрдХреНрд╕реНрдЯ рдлрд╛рдЗрд▓ рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдорд┐рд▓рддрд╛ рд╣реИред
```bash
SharpDPAPI.exe certificates /mkfile:C:\temp\mkeys.txt

# Transfor .pem to .pfx
openssl pkcs12 -in cert.pem -keyex -CSP "Microsoft Enhanced Cryptographic Provider v1.0" -export -out cert.pfx
```
## рдорд╢реАрди рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЪреЛрд░реА DPAPI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ тАУ THEFT3

Windows рдорд╢реАрди рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдХреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА `HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\SystemCertificates` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдЦрд╛рддреЗ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдХрдИ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╕реНрдерд╛рдиреЛрдВ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐ SharpDPAPI рдЗрди рд╕рднреА рд╕реНрдерд╛рдиреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░реЗрдЧрд╛, рд╕рдмрд╕реЗ рджрд┐рд▓рдЪрд╕реНрдк рдкрд░рд┐рдгрд╛рдо рдЕрдХреНрд╕рд░ `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\RSA\MachineKeys` (CAPI) рдФрд░ `%ALLUSERSPROFILE%\Application Data\Microsoft\Crypto\Keys` (CNG) рд╕реЗ рдЖрддреЗ рд╣реИрдВред рдпреЗ **рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ** **рдорд╢реАрди рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рд╕реНрдЯреЛрд░ рд╕реЗ рдЬреБрдбрд╝реА рд╣реЛрддреА рд╣реИрдВ рдФрд░ Windows рдЙрдиреНрд╣реЗрдВ **рдорд╢реАрди рдХреЗ DPAPI рдорд╛рд╕реНрдЯрд░ рдХреБрдВрдЬрд┐рдпреЛрдВ** рд╕реЗ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рддрд╛ рд╣реИред\
рдЗрди рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбреЛрдореЗрди рдХреА DPAPI рдмреИрдХрдЕрдк рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ **рдЕрд╡рд╢реНрдп** **DPAPI\_SYSTEM LSA рд╕реАрдХреНрд░реЗрдЯ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдкрд░ **рдХреЗрд╡рд▓ SYSTEM рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╣реА рд╕реБрд▓рдн рд╣реИ**ред&#x20;

рдЖрдк рдЗрд╕реЗ рдореИрдиреНрдпреБрдЕрд▓реА **MimikatzтАЩ** рдХреЗ **`lsadump::secrets`** рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рдирд┐рдХрд╛рд▓реА рдЧрдИ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдорд╢реАрди рдорд╛рд╕реНрдЯрд░рдХреАрдЬрд╝ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред \
рдЖрдк CAPI/CNG рдХреЛ рдкрд╣рд▓реЗ рдХреА рддрд░рд╣ рдкреИрдЪ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **MimikatzтАЩ** рдХреЗ `crypto::certificates /export /systemstore:LOCAL_MACHINE` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред \
**SharpDPAPIтАЩs** рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдХрдорд╛рдВрдб **`/machine`** рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде (рдЬрдм рдПрд▓рд┐рд╡реЗрдЯреЗрдб рд╣реЛ) рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ **SYSTEM** рдХреЛ **рдПрд▓рд┐рд╡реЗрдЯ** рдХрд░реЗрдЧрд╛, **DPAPI\_SYSTEM** LSA рд╕реАрдХреНрд░реЗрдЯ рдХреЛ **рдбрдВрдк** рдХрд░реЗрдЧрд╛, рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╢реАрди DPAPI рдорд╛рд╕реНрдЯрд░рдХреАрдЬрд╝ рдХреЛ **рдбрд┐рдХреНрд░рд┐рдкреНрдЯ** рдХрд░реЗрдЧрд╛, рдФрд░ рдХреБрдВрдЬреА рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рднреА рдорд╢реАрди рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпреЛрдВ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓реБрдХрдЕрдк рдЯреЗрдмрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░реЗрдЧрд╛ред

## рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдлрд╛рдЗрд▓реЗрдВ рдЦреЛрдЬрдирд╛ тАУ THEFT4

рдХрднреА-рдХрднреА **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╣реА рд╣реЛрддреЗ рд╣реИрдВ**, рдЬреИрд╕реЗ рдХрд┐ рдлрд╛рдЗрд▓ рд╢реЗрдпрд░реНрд╕ рдпрд╛ рдбрд╛рдЙрдирд▓реЛрдбреНрд╕ рдлреЛрд▓реНрдбрд░ рдореЗрдВред\
рд╣рдордиреЗ рдЬреЛ рд╕рдмрд╕реЗ рдЖрдо рдкреНрд░рдХрд╛рд░ рдХреЗ Windows-рдХреЗрдВрджреНрд░рд┐рдд рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдлрд╛рдЗрд▓реЗрдВ рджреЗрдЦреА рд╣реИрдВ, рд╡реЗ рд╣реИрдВ **`.pfx`** рдФрд░ **`.p12`** рдлрд╛рдЗрд▓реЗрдВ, рдЬрд┐рдирдореЗрдВ **`.pkcs12`** рдФрд░ ** `.pem` ** рдХрднреА-рдХрднреА рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдХрдо рдмрд╛рд░ред\
рдЕрдиреНрдп рджрд┐рд▓рдЪрд╕реНрдк рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ-рд╕рдВрдмрдВрдзрд┐рдд рдлрд╛рдЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╣реИрдВ: **`.key`** (_рдирд┐рдЬреА рдХреБрдВрдЬреА_), **`.crt/.cer`** (_рдХреЗрд╡рд▓ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ_), **`.csr`** (_рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд╕рд╛рдЗрдирд┐рдВрдЧ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ, рдЗрд╕рдореЗрдВ рд╕рд░реНрдЯреНрд╕ рдпрд╛ рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ рдирд╣реАрдВ рд╣реЛрддреА_), **`.jks/.keystore/.keys`** (_рдЬрд╛рд╡рд╛ рдХреАрд╕реНрдЯреЛрд░. рдЬрд╛рд╡рд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рд░реНрдЯреНрд╕ + рдирд┐рдЬреА рдХреБрдВрдЬрд┐рдпрд╛рдБ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ_)ред

рдЗрди рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╕ рдЙрди рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП powershell рдпрд╛ cmd рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЦреЛрдЬреЗрдВред

рдпрджрд┐ рдЖрдк рдПрдХ **PKCS#12** рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдлрд╛рдЗрд▓ рдкрд╛рддреЗ рд╣реИрдВ рдФрд░ рдпрд╣ **рдкрд╛рд╕рд╡рд░реНрдб рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ**, рддреЛ рдЖрдк [pfx2john.py](https://fossies.org/dox/john-1.9.0-jumbo-1/pfx2john\_8py\_source.html) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╣реИрд╢ рдирд┐рдХрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ JohnTheRipper рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреНрд░реИрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## NTLM рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдЪреЛрд░реА PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ тАУ THEFT5

> рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рд╕реЗ рдЬреБрдбрд╝рдиреЗ рд╡рд╛рд▓реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП **NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЬреЛ **Kerberos рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ**, рдЬрдм PKCA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, KDC **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ NTLM** рд╡рди-рд╡реЗ рдлрдВрдХреНрд╢рди (OWF) рдХреЛ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ (PAC) **`PAC_CREDENTIAL_INFO`** рдмрдлрд░ рдореЗрдВ рд▓реМрдЯрд╛рддрд╛ рд╣реИ

рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЦрд╛рддрд╛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рддрд╛ рд╣реИ рдФрд░ **PKINIT рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ TGT рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ**, рддреЛ рдПрдХ рдмрд┐рд▓реНрдЯ-рдЗрди "рдлреЗрд▓рд╕реЗрдл" рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рд╡рд░реНрддрдорд╛рди рд╣реЛрд╕реНрдЯ рдХреЛ **TGT рд╕реЗ рд╣рдорд╛рд░реЗ NTLM рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ** рддрд╛рдХрд┐ рдкреБрд░рд╛рдиреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдЗрд╕рдореЗрдВ **`PAC_CREDENTIAL_DATA`** **рд╕рдВрд░рдЪрдирд╛ рдХреЛ рдбрд┐рдХреНрд░рд┐рдкреНрдЯ рдХрд░рдирд╛** рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ NTLM рдкреНрд▓реЗрдирдЯреЗрдХреНрд╕реНрдЯ рдХрд╛ рдПрдХ Network Data Representation (NDR) рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреНрдб рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рд╣реИред

[**Kekeo**](https://github.com/gentilkiwi/kekeo) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде TGT рдХреЗ рд▓рд┐рдП рдкреВрдЫрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ NTML рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред
```bash
tgt::pac /caname:thename-DC-CA /subject:harmj0y /castore:current_user /domain:domain.local
```
Kekeo рдХрд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рд╕реНрдорд╛рд░реНрдЯрдХрд╛рд░реНрдб-рд╕рдВрд░рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд╕рд╛рде рднреА рдХрд╛рдо рдХрд░реЗрдЧрд╛ рдЬреЛ рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдкреНрд▓рдЧ рдЗрди рд╣реИрдВ рдпрджрд┐ рдЖрдк [**рдкрд┐рди рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд**](https://github.com/CCob/PinSwipe) рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ [**Rubeus**](https://github.com/GhostPack/Rubeus) рдореЗрдВ рднреА рд╕рдорд░реНрдерд┐рдд рд╣реЛрдЧрд╛ред

## рд╕рдВрджрд░реНрдн

* рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА [https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf) рд╕реЗ рд▓реА рдЧрдИ рдереАред

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
