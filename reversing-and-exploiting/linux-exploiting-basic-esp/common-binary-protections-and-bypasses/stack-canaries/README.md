# Stack Canaries

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **StackGuard y StackShield**

**StackGuard** inserta un valor especial conocido como **canary** antes del **EIP (Puntero de Instrucci√≥n Extendido)**, espec√≠ficamente `0x000aff0d` (que representa nulo, nueva l√≠nea, EOF, retorno de carro) para protegerse contra desbordamientos de b√∫fer. Sin embargo, funciones como `recv()`, `memcpy()`, `read()` y `bcopy()` siguen siendo vulnerables, y no protege el **EBP (Puntero Base)**.

**StackShield** adopta un enfoque m√°s sofisticado que StackGuard al mantener una **Pila de Retorno Global**, que almacena todas las direcciones de retorno (**EIPs**). Esta configuraci√≥n garantiza que cualquier desbordamiento no cause da√±o, ya que permite comparar las direcciones de retorno almacenadas con las reales para detectar ocurrencias de desbordamiento. Adem√°s, StackShield puede verificar la direcci√≥n de retorno frente a un valor l√≠mite para detectar si el **EIP** apunta fuera del espacio de datos esperado. Sin embargo, esta protecci√≥n puede ser eludida mediante t√©cnicas como Return-to-libc, ROP (Programaci√≥n Orientada a Retorno) o ret2ret, lo que indica que StackShield tampoco protege las variables locales.

## **Protector de Stack Smash (ProPolice) `-fstack-protector`:**

Este mecanismo coloca un **canary** antes del **EBP** y reorganiza las variables locales para posicionar los b√∫feres en direcciones de memoria m√°s altas, evitando que sobrescriban otras variables. Tambi√©n copia de forma segura los argumentos pasados en la pila por encima de las variables locales y utiliza estas copias como argumentos. Sin embargo, no protege los arrays con menos de 8 elementos o los b√∫feres dentro de una estructura de usuario.

El **canary** es un n√∫mero aleatorio derivado de `/dev/urandom` o un valor predeterminado de `0xff0a0000`. Se almacena en **TLS (Almacenamiento Local de Hilos)**, lo que permite que los espacios de memoria compartidos entre hilos tengan variables globales o est√°ticas espec√≠ficas del hilo. Estas variables se copian inicialmente del proceso padre, y los procesos hijos pueden modificar sus datos sin afectar al padre o a los hermanos. Sin embargo, si se utiliza un **`fork()` sin crear un nuevo canary, todos los procesos (padre e hijos) comparten el mismo canary**, volvi√©ndolo vulnerable. En la arquitectura **i386**, el canary se almacena en `gs:0x14`, y en **x86\_64**, en `fs:0x28`.

Esta protecci√≥n local identifica funciones con b√∫feres vulnerables a ataques e inyecta c√≥digo al inicio de estas funciones para colocar el canary, y al final para verificar su integridad.

Cuando un servidor web utiliza `fork()`, habilita un ataque de fuerza bruta para adivinar el byte del canary uno por uno. Sin embargo, usar `execve()` despu√©s de `fork()` sobrescribe el espacio de memoria, anulando el ataque. `vfork()` permite que el proceso hijo se ejecute sin duplicaci√≥n hasta que intenta escribir, momento en el que se crea una duplicaci√≥n, ofreciendo un enfoque diferente para la creaci√≥n de procesos y el manejo de memoria.

## Bypasses

**Filtrar el canary** y luego sobrescribirlo (por ejemplo, desbordamiento de b√∫fer) con su propio valor.

* Si el **canary se bifurca en procesos hijos** podr√≠a ser posible **atacarlo por fuerza bruta** byte a byte:

{% content-ref url="bf-forked-stack-canaries.md" %}
[bf-forked-stack-canaries.md](bf-forked-stack-canaries.md)
{% endcontent-ref %}

* Si hay alguna vulnerabilidad de filtrado interesante en el binario, podr√≠a ser posible filtrarlo:

{% content-ref url="print-stack-canary.md" %}
[print-stack-canary.md](print-stack-canary.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
