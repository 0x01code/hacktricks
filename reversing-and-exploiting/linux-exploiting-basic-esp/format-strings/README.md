# Cadenas de formato

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n del PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

En C, **`printf`** es una funci√≥n que se puede utilizar para **imprimir** una cadena. El **primer par√°metro** que espera esta funci√≥n es el **texto sin formato con los formateadores**. Los **par√°metros siguientes** esperados son los **valores** para **sustituir** los **formateadores** del texto sin formato.

La vulnerabilidad aparece cuando un **texto del atacante se coloca como el primer argumento** de esta funci√≥n. El atacante podr√° crear una **entrada especial abusando** de las capacidades de **cadena de formato printf** para **escribir cualquier dato en cualquier direcci√≥n**. De esta manera, puede **ejecutar c√≥digo arbitrario**.

Formateadores:
```bash
%08x ‚Äî> 8 hex bytes
%d ‚Äî> Entire
%u ‚Äî> Unsigned
%s ‚Äî> String
%n ‚Äî> Number of written bytes
%hn ‚Äî> Occupies 2 bytes instead of 4
<n>$X ‚Äî> Direct access, Example: ("%3$d", var1, var2, var3) ‚Äî> Access to var3
```
**`%n`** **escribe** el **n√∫mero de bytes escritos** en la **direcci√≥n indicada. Escribir** tantos **bytes** como el n√∫mero hexadecimal que necesitamos **escribir** es la forma en que se puede **escribir cualquier dato**.
```bash
AAAA%.6000d%4\$n ‚Äî> Write 6004 in the address indicated by the 4¬∫ param
AAAA.%500\$08x ‚Äî> Param at offset 500
```
### **Flujo de Explotaci√≥n**

Como se explic√≥ anteriormente, esta vulnerabilidad permite **escribir cualquier cosa en cualquier direcci√≥n (escritura arbitraria).**

El objetivo ser√° **sobrescribir** la **direcci√≥n** de una **funci√≥n** en la tabla **GOT** que ser√° llamada m√°s adelante. Idealmente podr√≠amos establecer la **direcci√≥n a un shellcode** ubicado en una secci√≥n ejecutable, pero es muy probable que no puedas escribir un shellcode en una secci√≥n ejecutable.\
Entonces, una opci√≥n diferente es **sobrescribir** una **funci√≥n** que **recibe** sus **argumentos** del **usuario** y **apuntarla** a la **funci√≥n `system`**.

Para escribir la direcci√≥n, generalmente se realizan 2 pasos: Primero se **escriben 2 bytes** de la direcci√≥n y luego los otros 2. Para hacerlo se utiliza **`$hn`**.

**HOB** se refiere a los 2 bytes m√°s altos de la direcci√≥n\
**LOB** se refiere a los 2 bytes m√°s bajos de la direcci√≥n

Por lo tanto, debido a c√≥mo funciona la cadena de formato, necesitas **escribir primero el m√°s peque√±o** de \[HOB, LOB] y luego el otro.

Si HOB < LOB\
`[direcci√≥n+2][direcci√≥n]%.[HOB-8]x%[offset]\$hn%.[LOB-HOB]x%[offset+1]`

Si HOB > LOB\
`[direcci√≥n+2][direcci√≥n]%.[LOB-8]x%[offset+1]\$hn%.[HOB-LOB]x%[offset]`

HOB LOB HOB\_shellcode-8 N¬∫Param\_dir\_HOB LOB\_shell-HOB\_shell N¬∫Param\_dir\_LOB

\`python -c 'print "\x26\x97\x04\x08"+"\x24\x97\x04\x08"+ "%.49143x" + "%4$hn" + "%.15408x" + "%5$hn"'\`

## Plantilla de Pwntools

Puedes encontrar una plantilla para preparar una explotaci√≥n para este tipo de vulnerabilidad en:

{% content-ref url="format-strings-template.md" %}
[format-strings-template.md](format-strings-template.md)
{% endcontent-ref %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n del PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
