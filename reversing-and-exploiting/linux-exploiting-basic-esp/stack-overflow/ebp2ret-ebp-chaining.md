# EBP2Ret - EBP 链接

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的 **公司广告** 或 **下载 PDF 版本的 HackTricks**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或 **关注** 我们的 **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

## 基本信息

这种技术利用了操纵 **基指针（EBP）** 的能力，通过精心使用 EBP 寄存器和 `leave; ret` 指令序列来链接执行多个函数。

作为提醒，**`leave`** 的基本含义是：
```
movl               %ebp, %esp
popl               %ebp
ret
```
### EBP2Ret

这种技术在你可以**改变 EBP 寄存器但无法直接改变 EIP 寄存器**时特别有用。它利用了函数执行完毕时的行为。

如果在 `fvuln` 执行期间，你成功地在栈中注入一个指向内存中你的 shellcode 地址的**伪造 EBP**（再加上 4 个字节以考虑 `pop` 操作），你就可以间接控制 EIP。当 `fvuln` 返回时，ESP 被设置为这个精心构造的位置，随后的 `pop` 操作将 ESP 减少 4，有效地使其指向你的 shellcode。当执行 `ret` 指令时，控制权就转移到了你的 shellcode。

#### 利用构建

首先，你需要**在可执行内存中的某处注入你的 shellcode**并**获取地址**，或获取到一个有效的 [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) 的地址，或让 ESP 指向一个包含 `system()` 地址后跟**4 个无效字节**和 `"/bin/sh"` 地址的位置。

然后，创建填充并用 shellcode/one_gadget 地址减去 4 的地址**损害 EBP**。这必须是 `-4`，因为有 `pop` 操作。然后，ESP 将指向我们期望的地址，`ret` 将被执行。

#### Off-By-One Exploit

这种技术的一个特定变体被称为“Off-By-One Exploit”。当你**只能修改 EBP 的最低有效字节**时，就会使用它。在这种情况下，存储 shellcode 地址的内存位置必须与 EBP 的前三个字节相同，从而允许在更受限制的条件下进行类似的操作。

### **EBP Chaining**

因此，在栈的 `EBP` 条目中放入一个可控地址，并在 `EIP` 中放入一个指向 `leave; ret` 的地址，就可以**将 `ESP` 移动到栈中受控 `EBP` 地址**。

现在，**`ESP`** 被控制，指向一个期望的地址，下一个要执行的指令是 `RET`。为了利用这一点，可以在受控 ESP 位置放置以下内容：

- **`&(下一个伪造 EBP)`** -> 由于 `leave` 指令的 `pop ebp`，加载新的 EBP
- **`system()`** -> 被 `ret` 调用
- **`&(leave;ret)`** -> 在 system 结束后被调用，它将移动 ESP 到伪造 EBP 并重新开始
- **`&("/bin/sh")`**-> `system` 的参数

基本上，通过这种方式，可以链接多个伪造的 EBP 来控制程序的流程。

说实话，这有点像 [ret2lib](ret2lib/)，但更复杂，没有明显的好处，但在某些边缘情况下可能会很有趣。
