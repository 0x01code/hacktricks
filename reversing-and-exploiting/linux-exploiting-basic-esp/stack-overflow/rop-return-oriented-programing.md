# ROP - Return Oriented Programing

<details>

<summary><strong>htARTE (HackTricks AWS Red Team 전문가)로부터 AWS 해킹을 처음부터 전문가까지 배우세요</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>

## **기본 정보**

**Return-Oriented Programming (ROP)**은 **No-Execute (NX)** 또는 **Data Execution Prevention (DEP)**과 같은 보안 조치를 우회하는 데 사용되는 고급 공격 기법입니다. 공격자는 셸코드를 삽입하고 실행하는 대신, **바이너리나 로드된 라이브러리에 이미 존재하는 코드 조각인 "가젯"**을 활용합니다. 각 가젯은 일반적으로 `ret` 명령으로 끝나며 데이터를 레지스터 간에 이동하거나 산술 연산을 수행하는 등의 작은 작업을 수행합니다. 이러한 가젯을 연결하여 공격자는 임의의 작업을 수행하는 페이로드를 구성하여 NX/DEP 보호를 우회할 수 있습니다.

### 호출 규약

함수를 호출하거나 데이터를 조작할 때 **호출 규약**을 이해하는 것은 효과적인 ROP 체인을 구성하는 데 중요합니다.

**x86 (32비트)**

* **cdecl**: 호출자가 스택을 정리합니다. 함수 인수는 역순으로 스택에 푸시됩니다 (오른쪽에서 왼쪽으로). **인수는 스택에 오른쪽에서 왼쪽으로 푸시됩니다.**
* **stdcall**: cdecl과 유사하지만 호출된 함수가 스택을 정리합니다.

**x64 (64비트)**

* Unix 계열 시스템에서 **System V AMD64 ABI** 호출 규약을 사용하며 **첫 번째 여섯 개의 정수 또는 포인터 인수는 레지스터 `RDI`, `RSI`, `RDX`, `RCX`, `R8` 및 `R9`에 전달**됩니다. 추가 인수는 스택에 전달됩니다. 반환 값은 `RAX`에 배치됩니다.
* **Windows x64** 호출 규약은 첫 네 개의 정수 또는 포인터 인수에 `RCX`, `RDX`, `R8` 및 `R9`를 사용하며 추가 인수는 스택에 전달됩니다. 반환 값은 `RAX`에 배치됩니다.
* **레지스터**: 64비트 레지스터에는 `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, `R8`에서 `R15`까지 포함됩니다.

{% hint style="danger" %}
이러한 호출 규약에서 **32비트에서는 함수에 대한 인수**가 **스택을 통해 전달**되는 반면 **x64**에서는 **특정 레지스터에 배치**됨을 알 수 있습니다.
{% endhint %}

### ROP 작동 방식

1. **제어 흐름 탈취**: 먼저, 공격자는 프로그램의 제어 흐름을 탈취해야 합니다. 일반적으로 버퍼 오버플로우를 이용하여 스택에 저장된 반환 주소를 덮어씁니다.
2. **가젯 체이닝**: 그런 다음 공격자는 원하는 작업을 수행하기 위해 신중하게 가젯을 선택하고 연결합니다. 이는 함수 호출을 위한 인수 설정, 함수 호출 (예: `system("/bin/sh")`), 필요한 정리 또는 추가 작업을 처리하는 것을 포함할 수 있습니다.
3. **페이로드 실행**: 취약한 함수가 반환될 때 합법적인 위치로 반환하는 대신 가젯 체인을 실행하기 시작합니다.

### x86에서의 ROP 체인

32비트 바이너리에서 ROP를 사용하여 `system("/bin/sh")`를 호출하려는 가상 시나리오를 고려해 봅시다:

1. **가젯 찾기**: 바이너리나 로드된 라이브러리에서 다음 가젯을 찾았다고 가정해 봅시다:
* `pop eax; ret`: 스택의 맨 위에 있는 값을 `EAX`로 팝하고 반환합니다.
* `pop ebx; ret`: 스택의 맨 위에 있는 값을 `EAX`로 팝하고 반환합니다.
* `mov [ebx], eax; ret`: `EBX`가 가리키는 위치에 있는 값을 `EAX`로 이동합니다.
* `system` 함수의 주소.
2. **체인 준비**: 다음과 같이 보이는 스택을 준비해야 합니다:
* `EBX`를 설정하는 가젯의 주소.
* `pop eax; ret` 가젯의 주소.
* 메모리에 있는 문자열 `"/bin/sh"`의 주소 (또는 쓸 위치).
* `mov [ebx], eax; ret` 가젯의 주소, `EBX`가 가리키는 위치로 `"/bin/sh"`를 이동합니다.
* `system` 함수의 주소, `EBX`가 우리의 문자열을 가리키도록 합니다.
3. **실행**: 취약한 함수가 반환되면 가젯 체인을 실행하여 `system("/bin/sh")`를 호출하고 셸을 팝합니다.

### x64에서의 ROP

System V AMD64 ABI를 사용하는 x64 시스템에서 `execve("/bin/sh", NULL, NULL)`를 호출하려는 가상 시나리오를 고려해 봅시다:

1. **가젯 찾기**: `execve`의 인수인 `RDI`, `RSI`, `RDX` 레지스터를 제어할 수 있는 가젯을 먼저 찾아야 합니다.
2. **체인 구성**:
* **`RDI`를 문자열 `"/bin/sh"`를 가리키도록 설정**: 일반적으로 `pop RDI; ret` 가젯으로 이 작업을 수행한 다음 문자열의 주소를 따릅니다 (페이로드에 배치하거나 메모리에서 찾아야 할 수 있음).
* **`RSI`와 `RDX`를 0으로 설정**: `execve`의 두 번째 및 세 번째 인수가 `NULL`이므로 `xor RSI, RSI; ret` 및 `xor RDX, RDX; ret`와 같이 이러한 레지스터를 0으로 설정하는 가젯이 필요합니다.
* **`execve` 호출**: 마지막으로 `execve`로 이동하는 (또는 간접적으로 호출하는) 가젯이 필요합니다.
3. **페이로드 실행**: 이러한 페이로드를 구성하고 취약한 응용 프로그램에 전송한 후 ROP 체인이 실행되어 셸이 생성됩니다.

x64는 처음 몇 인수에 대해 레지스터를 사용하므로 간단한 함수 호출에는 x86보다 적은 가젯이 필요하지만 올바른 가젯을 찾고 연결하는 것은 레지스터 수의 증가와 더 큰 주소 공간으로 인해 더 복잡할 수 있습니다. **x64** 아키텍처의 증가한 레지스터 수와 더 큰 주소 공간은 특히 Return-Oriented Programming (ROP)의 맥락에서 취약점 개발에 대한 기회와 도전을 제공합니다.

<details>

<summary><strong>htARTE (HackTricks AWS Red Team 전문가)로부터 AWS 해킹을 처음부터 전문가까지 배우세요</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요
* **💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 가입하거나 **트위터** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**를 팔로우하세요.**
* **HackTricks** 및 **HackTricks Cloud** github 저장소에 PR을 제출하여 해킹 요령을 공유하세요.

</details>
