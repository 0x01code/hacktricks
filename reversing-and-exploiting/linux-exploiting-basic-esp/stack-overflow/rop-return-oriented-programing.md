# ROP - рд░рд┐рдЯрд░реНрди рдУрд░рд┐рдПрдВрдЯреЗрдб рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди **HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**рджреА рдкреАрдПрдПрд╕ рдкрд░рд┐рд╡рд╛рд░**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**рдПрдирдПрдлрдЯреА**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## **рдореВрд▓рднреВрдд рдЬрд╛рдирдХрд╛рд░реА**

**рд░рд┐рдЯрд░реНрди-рдУрд░рд┐рдПрдВрдЯреЗрдб рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ (ROP)** рдПрдХ рдЙрдиреНрдирдд рд╢реЛрд╖рдг рддрдХрдиреАрдХ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ **No-Execute (NX)** рдпрд╛ **Data Execution Prevention (DEP)** рдЬреИрд╕реА рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдпреЛрдВ рдХреЛ рдирд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╢реЗрд▓рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдФрд░ рдирд┐рд╖реНрдкрд╛рджрди рдХреА рдмрдЬрд╛рдп, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдмрд╛рдЗрдирд░реА рдпрд╛ рд▓реЛрдбреЗрдб рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрдж рдХреЛрдб рдХреЗ рдЯреБрдХрдбрд╝реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рдиреНрд╣реЗрдВ **"рдЧреИрдЬреЗрдЯреНрд╕"** рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдкреНрд░рддреНрдпреЗрдХ рдЧреИрдЬреЗрдЯ рд╕рд╛рдорд╛рдиреНрдпрдд: рдПрдХ `ret` рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд╕рд╛рде рд╕рдорд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдПрдХ рдЫреЛрдЯреЗ рд╕реЗ рдХрд╛рд░реНрдп рдХреЛ рдХрд░рддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рд░рдЬрд┐рд╕реНрдЯрд░реНрд╕ рдХреЗ рдмреАрдЪ рдбреЗрдЯрд╛ рдХреЛ рд▓реЗ рдЬрд╛рдирд╛ рдпрд╛ рдЕрдВрдХрдЧрдгрд┐рддреАрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдХрд░рдирд╛ред рдЗрди рдЧреИрдЬреЗрдЯреНрд╕ рдХреЛ рдПрдХ рд╕рд╛рде рдЬреЛрдбрд╝рдХрд░, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ рдкреЗрд▓реЛрдб рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рд╡рд╣ рд╡рд┐рднрд┐рдиреНрди рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, NX/DEP рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЕрд╕рдлрд▓ рдХрд░рддреЗ рд╣реБрдПред

### рдХреЙрд▓рд┐рдВрдЧ рдХрдирд╡реЗрдВрд╢рди

**рдХреЙрд▓рд┐рдВрдЧ рдХрдирд╡реЗрдВрд╢рди** рдХреЛ рд╕рдордЭрдирд╛ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛рдПрдВ рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рд╡рд┐рд╢реЗрд╖рдХрд░ рдЬрдм рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрд╛ рдбреЗрдЯрд╛ рдХреЛ рд╕рдВрдЪрд╛рд▓рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:

**x86 (32-рдмрд┐рдЯ)**

* **cdecl**: рдХреЙрд▓рд░ рд╕реНрдЯреИрдХ рдХреЛ рд╕рд╛рдл рдХрд░рддрд╛ рд╣реИред рдлрд╝рдВрдХреНрд╢рди рддрд░реНрдХреЛрдВ рдХреЛ рд╕реНрдЯреИрдХ рдкрд░ рдЙрд▓рдЯреЗ рдХреНрд░рдо рдореЗрдВ рдврдХреЗрдВ (рджрд╛рдПрдВ рд╕реЗ рдмрд╛рдПрдВ)ред **рддрд░реНрдХ рд╕реНрдЯреИрдХ рдкрд░ рджрд╛рдПрдВ рд╕реЗ рдмрд╛рдПрдВ рдХреА рдУрд░ рдврдХреЗ рдЬрд╛рддреЗ рд╣реИрдВред**
* **stdcall**: cdecl рдХреЗ рд╕рдорд╛рди рд╣реИ, рд▓реЗрдХрд┐рди рд╕реНрдЯреИрдХ рдХреЛ рд╕рд╛рдл рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрд▓реА рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реИред

**x64 (64-рдмрд┐рдЯ)**

* Unix-рдЬреИрд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ **System V AMD64 ABI** рдХреЙрд▓рд┐рдВрдЧ рдХрдирд╡реЗрдВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬрд╣рд╛рдВ **рдкрд╣рд▓реЗ рдЫрд╣ рдкреВрд░реНрдгрд╛рдВрдХ рдпрд╛ рдкреЙрдЗрдВрдЯрд░ рддрд░реНрдХреЛрдВ рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░ `RDI`, `RSI`, `RDX`, `RCX`, `R8`, рдФрд░ `R9`** рдореЗрдВ рдкрд╛рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЕрддрд┐рд░рд┐рдХреНрдд рддрд░реНрдХ рд╕реНрдЯреИрдХ рдкрд░ рдкрд╛рд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рд░рд┐рдЯрд░реНрди рдорд╛рди `RAX` рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **Windows x64** рдХреЙрд▓рд┐рдВрдЧ рдХрдирд╡реЗрдВрд╢рди рдореЗрдВ рдкрд╣рд▓реЗ рдЪрд╛рд░ рдкреВрд░реНрдгрд╛рдВрдХ рдпрд╛ рдкреЙрдЗрдВрдЯрд░ рддрд░реНрдХреЛрдВ рдХреЗ рд▓рд┐рдП `RCX`, `RDX`, `R8`, рдФрд░ `R9` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЕрддрд┐рд░рд┐рдХреНрдд рддрд░реНрдХ рд╕реНрдЯреИрдХ рдкрд░ рдкрд╛рд░рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рд░рд┐рдЯрд░реНрди рдорд╛рди `RAX` рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **рд░рдЬрд┐рд╕реНрдЯрд░реНрд╕**: 64-рдмрд┐рдЯ рд░рдЬрд┐рд╕реНрдЯрд░реНрд╕ рдореЗрдВ `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, рдФрд░ `R8` рд╕реЗ `R15` рд╢рд╛рдорд┐рд▓ рд╣реИрдВред

{% hint style="danger" %}
рдЙрди рдХреЙрд▓рд┐рдВрдЧ рдХрдирд╡реЗрдВрд╢рди рд╕реЗ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ **32 рдмрд┐рдЯ рдореЗрдВ рддрд░реНрдХ** рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ **рдЖрд░реНрдЧреНрдпреВрдореЗрдВрдЯ** рдХреЛ **рд╕реНрдЯреИрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╛рд░рд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдмрдХрд┐ **x64** рдореЗрдВ рд╡реЗ **рдирд┐рд╢реНрдЪрд┐рдд рд░рдЬрд┐рд╕реНрдЯрд░реНрд╕ рдореЗрдВ рд░рдЦреЗ** рдЬрд╛рддреЗ рд╣реИрдВред
{% endhint %}

### ROP рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ

1. **рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╡рд╛рд╣ рдЙрджреНрдзрд╛рд░рдг**: рдкрд╣рд▓реЗ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдХрд┐рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╡рд╛рд╣ рдХреЛ рдЙрджреНрдзрд╛рд░рдг рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рд╕рд╛рдорд╛рдиреНрдпрдд: рдПрдХ рдмрдлрд░ рдУрд╡рд░рдлреНрд▓реЛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдХреЗ рд╕реНрдЯреИрдХ рдкрд░ рд╕рд╣реЗрдЬреА рдЧрдИ рд░рд┐рдЯрд░реНрди рдкрддрд╛ рдХреЛ рдЕрдзрд┐рдХреГрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
2. **рдЧреИрдЬреЗрдЯ рд╢реНрд░реГрдВрдЦрд▓рд╛**: рдлрд┐рд░ рд╣рдорд▓рд╛рд╡рд░ рдзреНрдпрд╛рдирдкреВрд░реНрд╡рдХ рдЧреИрдЬреЗрдЯреНрд╕ рдХрд╛ рдЪрдпрди рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдПрдХ рд╕рд╛рде рдЬреЛрдбрд╝рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рд╡рд╛рдВрдЫрд┐рдд рдХреНрд░рд┐рдпрд╛рдПрдБ рдХрд░ рд╕рдХреЗред рдЗрд╕рдореЗрдВ рдХрд┐рд╕реА рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рддрд░реНрдХреЛрдВ рдХреЗ рд▓рд┐рдП рддрд░реНрдХреЛрдВ рдХреЛ рд╕реЗрдЯ рдХрд░рдирд╛, рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ (рдЬреИрд╕реЗ, `system("/bin/sh")`), рдФрд░ рдХрд┐рд╕реА рдЖрд╡рд╢реНрдпрдХ рд╕рдлрд╛рдИ рдпрд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рд╕рдВрднрд╛рд▓рди рд╢рд╛рдорд┐рд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
3. **рдкреЗрд▓реЛрдб рдирд┐рд╖реНрдкрд╛рджрди**: рдЬрдм рднреАрд╖рдг рдлрд╝рдВрдХреНрд╢рди рд╡рд╛рдкрд╕ рдЖрддрд╛ рд╣реИ, рд╡рд╛рд╕реНрддрд╡рд┐рдХ рд╕реНрдерд╛рди рдкрд░ рд╡рд╛рдкрд╕ рди рдЬрд╛рдиреЗ рдХреА рдмрдЬрд╛рдп, рд╡рд╣ рдЧреИрдЬреЗрдЯреЛрдВ рдХреА рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХрд░рдиреЗ рд▓рдЧрддрд╛ рд╣реИред

### x86 рдореЗрдВ ROP рд╢реНрд░реГрдВрдЦрд▓рд╛

рдЪрд▓рд┐рдП рдПрдХ рдХрд╛рд▓реНрдкрдирд┐рдХ рд╕реНрдерд┐рддрд┐ рдХрд╛ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ рдЬрд╣рд╛рдВ рд╣рдо ROP рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ 32-рдмрд┐рдЯ рдмрд╛рдЗрдирд░реА рдореЗрдВ `system("/bin/sh")` рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ:

1. **рдЧреИрдЬреЗрдЯреНрд╕ рдЦреЛрдЬреЗрдВ**: рдорд╛рди рд▓реЗрдВ рд╣рдордиреЗ рдмрд╛рдЗрдирд░реА рдпрд╛ рд▓реЛрдбреЗрдб рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЧреИрдЬреЗрдЯреНрд╕ рдкрд╛рдП рд╣реИрдВ:
* `pop eax; ret`: рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдХреЛ `EAX` рдореЗрдВ рдкреЙрдк рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╡рд╛рдкрд╕ рд▓реМрдЯрддрд╛ рд╣реИред
* `pop ebx; ret`: рд╕реНрдЯреИрдХ рдХреЗ рд╢реАрд░реНрд╖ рдХреЛ `EAX` рдореЗрдВ рдкреЙрдк рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╡рд╛рдкрд╕ рд▓реМрдЯрддрд╛ рд╣реИред
* `mov [ebx], eax; ret`: `EAX` рдореЗрдВ рдореМрдЬреВрдж рдорд╛рди рдХреЛ `EBX` рджреНрд╡рд╛рд░рд╛ рд╕рдВрдХреЗрддрд┐рдд рд╕реНрдерд╛рди рдореЗрдВ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред
* `system` рдХрд╛ рдкрддрд╛ред
2. **рд╢реНрд░реГрдВрдЦрд▓рд╛ рддреИрдпрд╛рд░ рдХрд░реЗрдВ**: рд╣рдореЗрдВ рдПрдХ рд╕реНрдЯреИрдХ рддреИрдпрд╛рд░ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджрд┐рдЦрддрд╛ рд╣реИ:
* `EBX` рд╕реЗрдЯ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдЧреИрдЬреЗрдЯ рдХрд╛ рдкрддрд╛ред
* `pop eax; ret` рдЧреИрдЬреЗрдЯ рдХрд╛ рдкрддрд╛ред
* рдореЗрдореЛрд░реА рдореЗрдВ рд╕реНрдЯреНрд░рд┐рдВрдЧ `"/bin/sh"` рдХрд╛ рдкрддрд╛ (рдпрд╛ рд╣рдо рдЗрд╕реЗ рд▓рд┐рдЦрдиреЗ рдХреА рдпреЛрдЬрдирд╛ рдмрдирд╛рддреЗ рд╣реИрдВ)ред
* `mov [ebx], eax; ret` рдЧреИрдЬреЗрдЯ рдХрд╛ рдкрддрд╛, `EBX` рджреНрд╡рд╛рд░рд╛ рд╕рдВрдХреЗрддрд┐рдд рд╕реНрдерд╛рди рдореЗрдВ `"/bin/sh"` рдХреЛ рд▓реЗ рдЬрд╛рдиреЗ рдХреЗ рд▓рд┐рдПред
* `system` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдкрддрд╛, `EBX` рд╣рдорд╛рд░реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рд╕рдВрдХреЗрддрд┐рдд рдХрд░рддреЗ рд╣реБрдПред
3. **рдирд┐рд╖реНрдкрд╛рджрди**: рдЬрдм рднреАрд╖рдг рдлрд╝рдВрдХреНрд╢рди рд╡рд╛рдкрд╕ рдЖрддрд╛ рд╣реИ, рд╡рд╣ рд╣рдорд╛рд░реА рдЧреИрдЬреЗрдЯ рд╢реНрд░реГрдВрдЦрд▓рд╛ рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рдХрд░рдиреЗ рд▓рдЧрддрд╛ рд╣реИ, рдЕрдВрддрддрдГ `system("/bin/sh")` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ, рдФрд░ рдПрдХ рд╢реИрд▓ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИред

### x64 рдореЗрдВ ROP

рд╕реЛрдЪрд┐рдП рдПрдХ рдХрд╛рд▓реНрдкрдирд┐рдХ рд╕реНрдерд┐рддрд┐ рдЬрд╣рд╛рдВ рдЖрдк System V AMD64 ABI рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ x64 рд╕рд┐рд╕реНрдЯрдо рдкрд░ `execve("/bin/sh", NULL, NULL)` рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ:

1. **рдЧреИрдЬреЗрдЯреНрд╕ рдЦреЛрдЬрдирд╛**: рдкрд╣рд▓реЗ рдЖрдкрдХреЛ `RDI`, `RSI`, рдФрд░ `RDX` рд░рдЬрд┐рд╕реНрдЯрд░реНрд╕ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐
