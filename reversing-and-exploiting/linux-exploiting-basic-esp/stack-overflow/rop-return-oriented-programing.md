# ROP - Programu ya Kurudi kwa Mwelekeo

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## **Taarifa Msingi**

**Programu ya Kurudi kwa Mwelekeo (ROP)** ni mbinu ya kudukua ya juu inayotumika kuzunguka hatua za usalama kama **No-Execute (NX)** au **Data Execution Prevention (DEP)**. Badala ya kuingiza na kutekeleza shellcode, muhusika anatumia vipande vya nambari tayari zilizopo kwenye faili ya binary au maktaba zilizopakiwa, inayoitwa **"gadgets"**. Kila gadget kawaida hukamilika na maagizo ya `ret` na hufanya operesheni ndogo, kama vile kuhamisha data kati ya rejista au kufanya operesheni za hisabati. Kwa kuunganisha vipande hivi vya gadgets pamoja, muhusika anaweza kujenga mzigo wa data kutekeleza operesheni za kupindukia, kwa ufanisi kupuuza ulinzi wa NX/DEP.

### Mipangilio ya Wito

Kuelewa **mipangilio ya wito** ni muhimu kwa kujenga minyororo ya ROP yenye ufanisi, hasa wakati wa kuita kazi au kubadilisha data:

**x86 (32-bit)**

* **cdecl**: Mwito hufuta steki. Vigezo vya kazi hupakuliwa kwenye steki kwa mpangilio wa kurudi (kulia-kushoto). **Vigezo hupakuliwa kwenye steki kutoka kulia kwenda kushoto.**
* **stdcall**: Kama cdecl, lakini mpokeaji anahusika na kufuta steki.

**x64 (64-bit)**

* Hutumia mbinu ya kuita ya **System V AMD64 ABI** kwenye mifumo inayofanana na Unix, ambapo **vigezo sita vya nambari au pointa hupitishwa kwenye rejista `RDI`, `RSI`, `RDX`, `RCX`, `R8`, na `R9`**. Vigezo vingine hupitishwa kwenye steki. Thamani ya kurudi hutiwa kwenye `RAX`.
* Mbinu ya kuita ya **Windows x64** hutumia `RCX`, `RDX`, `R8`, na `R9` kwa vigezo vinne vya kwanza vya nambari au pointa, na vigezo vingine hupitishwa kwenye steki. Thamani ya kurudi hutiwa kwenye `RAX`.
* **Rejista**: Rejista za 64-bit ni pamoja na `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, na `R8` hadi `R15`.

{% hint style="danger" %}
Kutoka kwenye mifumo hiyo ya kuita, inawezekana kuona kwamba katika **biti 32 vigezo** kwa kazi zinapitishwa kupitia **steki** wakati katika **x64** zinawekwa kwenye **rejista maalum**.
{% endhint %}

### Jinsi ROP Inavyofanya Kazi

1. **Udukuzi wa Mwelekeo wa Udhibiti**: Kwanza, muhusika anahitaji kudukua mwelekeo wa udhibiti wa programu, kwa kawaida kwa kutumia kosa la kujaza kijazo ili kubadilisha anwani iliyohifadhiwa ya kurudi kwenye steki.
2. **Ujenzi wa Minyororo ya Gadgets**: Muhusika kisha kwa uangalifu huchagua na kuunganisha vipande vya gadgets kutekeleza vitendo vinavyotakiwa. Hii inaweza kuhusisha kuweka vigezo kwa wito wa kazi, kuita kazi (k.m., `system("/bin/sh")`), na kushughulikia usafi au operesheni zingine zinazohitajika.
3. **Utekelezaji wa Mzigo wa Data**: Wakati kazi inayoweza kudukuliwa inaporudi, badala ya kurudi kwenye eneo halali, inaanza kutekeleza minyororo ya gadgets.

### Minyororo ya ROP katika x86

Tuchukulie hali ya dhana ambapo tunataka kuita `system("/bin/sh")` kwa kutumia ROP kwenye binary ya biti 32:

1. **Pata Gadgets**: Fikiria tumepata vipande vifuatavyo vya gadgets kwenye binary au maktaba zilizopakiwa:
* `pop eax; ret`: Hupakua juu ya steki kwenda `EAX` na kurudi.
* `pop ebx; ret`: Hupakua juu ya steki kwenda `EAX` na kurudi.
* `mov [ebx], eax; ret`: Inahamisha thamani kwenye `EAX` kwenye eneo linaloelekezwa na `EBX`.
* Anwani ya `system`.
2. **Andaa Minyororo**: Tunahitaji kuandaa steki inayoonekana kama hii:
* Anwani ya gadget inayoweka `EBX`.
* Anwani ya gadget ya `pop eax; ret`.
* Anwani ya herufi `"/bin/sh"` kwenye kumbukumbu (au mahali ambapo tunapanga kuandika).
* Anwani ya gadget ya `mov [ebx], eax; ret`, kuhamisha `"/bin/sh"` kwenye eneo linaloelekezwa na `EBX`.
* Anwani ya kazi ya `system`, na `EBX` ikiashiria herufi yetu.
3. **Utekelezaji**: Wakati kazi inayoweza kudukuliwa inaporudi, inaanza kutekeleza minyororo yetu ya gadgets, hatimaye kuita `system("/bin/sh")`, na kutoa kidhibiti.

### ROP katika x64

Fikiria hali ya dhana ambapo unataka kuita `execve("/bin/sh", NULL, NULL)` kwenye mfumo wa x64 ukitumia System V AMD64 ABI:

1. **Kupata Gadgets**: Kwanza unahitaji kupata vipande vya gadgets vinavyokuwezesha kudhibiti rejista za `RDI`, `RSI`, na `RDX`, kwani hizi zitashikilia vigezo vya `execve`.
2. **Ujenzi wa Minyororo**:
* **Weka `RDI` iashirie herufi `"/bin/sh"`**: Kawaida hii hufanywa na gadget ya `pop RDI; ret` ikifuatiwa na anwani ya herufi (ambayo inaweza kuhitajiweka kwenye mzigo wa data au kupatikana kwenye kumbukumbu).
* **Futa `RSI` na `RDX`**: Kwa kuwa vigezo vya pili na tatu kwa `execve` ni `NULL`, unahitaji vipande vya kufuta rejista hizi, kama vile `xor RSI, RSI; ret` na `xor RDX, RDX; ret`.
* **Piga simu kwa `execve`**: Hatimaye, gadget inayoruka kwa `execve` (au kuita kwa njia isiyo moja kwa moja) inahitajika.
3. **Utekelezaji wa Mzigo wa Data**: Baada ya kujenga na kutuma mzigo huu kwa programu inayoweza kudukuliwa, minyororo ya ROP inatekelezwa, ikizalisha kidhibiti.

Kwa kuwa x64 inatumia rejista kwa vigezo vya mwanzo vichache, mara nyingi inahitaji vipande vichache kuliko x86 kwa wito rahisi wa kazi, lakini kupata na kuunganisha vipande sahihi vya gadgets kunaweza kuwa ngumu zaidi kutokana na idadi kubwa ya rejista na nafasi kubwa ya anwani. Idadi kubwa ya rejista na nafasi kubwa ya anwani katika usanidi wa **x64** hutoa fursa na changamoto katika maendeleo ya udanganyifu, hasa katika muktadha wa Programu ya Kurudi kwa Mwelekeo (ROP).

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
