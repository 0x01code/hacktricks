# ROP - Return Oriented Programing

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking püf noktalarınızı göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>

## **Temel Bilgiler**

**Return-Oriented Programming (ROP)**, **No-Execute (NX)** veya **Data Execution Prevention (DEP)** gibi güvenlik önlemlerini atlatmak için kullanılan gelişmiş bir sızma tekniğidir. Bir saldırgan, shellcode enjekte etmek ve yürütmek yerine, binary veya yüklenmiş kütüphanelerde zaten bulunan kod parçalarını, yani **"gadget"** olarak bilinen parçaları kullanır. Her gadget genellikle bir `ret` talimatı ile biter ve veri taşıma veya aritmetik işlemler gibi küçük bir işlem gerçekleştirir. Bu gadget'ları bir araya getirerek, bir saldırgan, NX/DEP korumalarını atlayarak keyfi işlemler gerçekleştirmek için bir yük oluşturabilir.

### Çağrı Kavramları

**Çağrı kavramlarını** anlamak, özellikle fonksiyonları çağırırken veya veri manipülasyonu yaparken etkili ROP zincirleri oluşturmak için hayati önem taşır:

**x86 (32-bit)**

* **cdecl**: Çağrı yapan yığını temizler. Fonksiyon argümanları ters sırayla (sağdan sola) yığına itilir. **Argümanlar sağdan sola doğru yığına itilir.**
* **stdcall**: cdecl'e benzer, ancak yığındaki temizleme işlemi çağrıyı yapan tarafından yapılır.

**x64 (64-bit)**

* Unix benzeri sistemlerde **System V AMD64 ABI** çağrı kavramını kullanır, burada **ilk altı tamsayı veya işaretçi argümanlar `RDI`, `RSI`, `RDX`, `RCX`, `R8` ve `R9`** registerlara geçirilir. Ek argümanlar yığında geçirilir. Dönüş değeri `RAX` registerına yerleştirilir.
* **Windows x64** çağrı kavramı, ilk dört tamsayı veya işaretçi argümanlar için `RCX`, `RDX`, `R8` ve `R9` kullanır, ek argümanlar yığında geçirilir. Dönüş değeri `RAX` registerına yerleştirilir.
* **Registerler**: 64-bit registerlar `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` ve `R8` ile `R15` içerir.

{% hint style="danger" %}
Bu çağrı kavramlarından, **32 bitlerde fonksiyonlara argümanların yığın üzerinden** geçtiği, **x64**'te ise **belirli registerlara yerleştirildiği** görülebilir.
{% endhint %}

### ROP Nasıl Çalışır

1. **Kontrol Akışı Kaçırma**: İlk olarak, bir saldırganın bir programın kontrol akışını ele geçirmesi gerekir, genellikle bir tampon taşması kullanarak yığında kaydedilen bir dönüş adresini üzerine yazarak.
2. **Gadget Zinciri**: Saldırgan daha sonra istenilen işlemleri gerçekleştirmek için dikkatlice gadget'ları seçer ve birbirine bağlar. Bu, bir fonksiyon çağrısı için argümanları ayarlamayı, fonksiyonu çağırmayı (örneğin, `system("/bin/sh")`), gerekli temizlik veya ek işlemleri ele almayı içerebilir.
3. **Yük Yürütme**: Zayıf olan fonksiyon geri döndüğünde, meşru bir konuma dönmemek yerine, gadget zincirini yürütmeye başlar.

### x86'da ROP Zinciri

32-bit bir binary'de ROP kullanarak `system("/bin/sh")` çağırmak istediğimiz varsayımsal bir senaryoyu ele alalım:

1. **Gadget'ları Bulma**: Varsayalım ki binary veya yüklenmiş kütüphanelerde aşağıdaki gadget'ları bulduk:
* `pop eax; ret`: Yığının en üstündeki değeri `EAX`'a çıkarır ve döner.
* `pop ebx; ret`: Yığının en üstündeki değeri `EAX`'a çıkarır ve döner.
* `mov [ebx], eax; ret`: `EAX` içindeki değeri `EBX` tarafından işaret edilen konuma taşır.
* `system` fonksiyonunun adresi.
2. **Zinciri Hazırlama**: Aşağıdaki gibi görünen bir yığın hazırlamamız gerekiyor:
* `EBX`'i ayarlayan gadget'ın adresi.
* `pop eax; ret` gadget'ın adresi.
* Bellekteki `"/bin/sh"` dizesinin adresi (veya yazmayı planladığımız yer).
* `mov [ebx], eax; ret` gadget'ın adresi, `EBX` tarafından işaret edilen yere `"/bin/sh"`'i taşımak için.
* `system` fonksiyonunun adresi, `EBX`'in dizesini işaret ettiği yerde.
3. **Yürütme**: Zayıf olan fonksiyon geri döndüğünde, gadget zincirimizi yürütmeye başlar, sonunda `system("/bin/sh")`'i çağırır ve bir shell açar.

### x64'te ROP

System V AMD64 ABI'yi kullanarak x64 sistemde `execve("/bin/sh", NULL, NULL)` çağırmak istediğiniz varsayımsal bir senaryoyu ele alalım:

1. **Gadget'ları Bulma**: İlk olarak, `execve`'ye geçirilecek olan `RDI`, `RSI` ve `RDX` registerlarını kontrol etmenizi sağlayan gadget'ları bulmanız gerekir.
2. **Zincir Oluşturma**:
* **`RDI`'yi `"/bin/sh"` dizesine işaret etmek**: Bu genellikle bir `pop RDI; ret` gadget'ı ile yapılır ve ardından dizenin adresi (yüklü olması gereken veya bellekte bulunması gereken) takip edilir.
* **`RSI` ve `RDX`'i sıfırla**: `execve`'nin ikinci ve üçüncü argümanları `NULL` olduğundan, bu registerları sıfırlayan gadget'lara ihtiyacınız vardır, örneğin `xor RSI, RSI; ret` ve `xor RDX, RDX; ret`.
* **`execve`'yi çağırma**: Son olarak, `execve`'ye atlayan bir gadget'a (veya dolaylı olarak çağıran bir gadget) ihtiyaç vardır.
3. **Yük Yürütme**: Bu yükü oluşturup zayıf bir uygulamaya gönderdikten sonra, ROP zinciri yürütülür ve bir shell başlatılır.

x64, ilk birkaç argüman için registerları kullandığından, basit fonksiyon çağrıları için genellikle x86'dan daha az gadget gerektirir, ancak doğru gadget'ları bulup birleştirmek, artan register sayısı ve daha büyük adres alanı nedeniyle daha karmaşık olabilir. **x64** mimarisindeki artan register sayısı ve daha büyük adres alanı, özellikle Return-Oriented Programming (ROP) bağlamında, sızma geliştirme için hem fırsatlar hem de zorluklar sunar.

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini alın**](https://peass.creator-spring.com)
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin**.
* **Hacking püf noktalarınızı göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR gönderin.

</details>
