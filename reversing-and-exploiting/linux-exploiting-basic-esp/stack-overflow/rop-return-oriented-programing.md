# ROP - Return Oriented Programing

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## **Osnovne informacije**

**Return-Oriented Programming (ROP)** je napredna tehnika eksploatacije koja se koristi za zaobilaženje sigurnosnih mera poput **No-Execute (NX)** ili **Data Execution Prevention (DEP)**. Umesto ubacivanja i izvršavanja shell koda, napadač koristi delove koda već prisutne u binarnom fajlu ili u učitanim bibliotekama, poznate kao **"gadgeti"**. Svaki gadget obično završava sa `ret` instrukcijom i obavlja malu operaciju, poput premeštanja podataka između registara ili izvođenja aritmetičkih operacija. Spajanjem ovih gadgeta, napadač može konstruisati payload za izvođenje proizvoljnih operacija, efikasno zaobilazeći NX/DEP zaštite.

### Pozivni konvencije

Razumevanje **pozivnih konvencija** je ključno za konstruisanje efikasnih ROP lanaca, posebno prilikom pozivanja funkcija ili manipulisanja podacima:

**x86 (32-bit)**

* **cdecl**: Pozivaoc čisti stek. Argumenti funkcije se guraju na stek u obrnutom redosledu (desno-levo). **Argumenti se guraju na stek s desna na levo.**
* **stdcall**: Slično cdecl-u, ali je callee odgovoran za čišćenje steka.

**x64 (64-bit)**

* Koristi **System V AMD64 ABI** pozivnu konvenciju na Unix-sličnim sistemima, gde se **prva šest celobrojnih ili pokazivačkih argumenata prosleđuje u registre `RDI`, `RSI`, `RDX`, `RCX`, `R8`, i `R9`**. Dodatni argumenti se prosleđuju na steku. Povratna vrednost se smešta u `RAX`.
* **Windows x64** pozivna konvencija koristi `RCX`, `RDX`, `R8`, i `R9` za prva četiri celobrojna ili pokazivačka argumenta, sa dodatnim argumentima prosleđenim na steku. Povratna vrednost se smešta u `RAX`.
* **Registri**: 64-bitni registri uključuju `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, i `R8` do `R15`.

{% hint style="danger" %}
Iz ovih pozivnih konvencija je moguće primetiti da se u **32 bitima argumenti** funkcija **prosleđuju preko steka** dok se u **x64** smeštaju u **specifične registre**.
{% endhint %}

### Kako ROP funkcioniše

1. **Preuzimanje kontrole nad tokom izvršavanja**: Prvo, napadač mora preuzeti kontrolu nad tokom izvršavanja programa, obično iskorišćavanjem prelivanja bafera da bi prepisao sačuvanu adresu povratka na steku.
2. **Spajanje Gadgeta**: Napadač zatim pažljivo bira i spaja gadgete da bi izvršio željene akcije. To može uključivati postavljanje argumenata za poziv funkcije, pozivanje funkcije (npr. `system("/bin/sh")`), i rukovanje neophodnim čišćenjem ili dodatnim operacijama.
3. **Izvršavanje Payload-a**: Kada ranjiva funkcija završi, umesto povratka na legitimnu lokaciju, počinje izvršavanje lanca gadgeta.

### ROP Lanac u x86

Razmotrimo hipotetički scenario gde želimo pozvati `system("/bin/sh")` koristeći ROP u 32-bitnom binarnom fajlu:

1. **Pronalaženje Gadgeta**: Pretpostavimo da smo pronašli sledeće gadzete u binarnom fajlu ili učitanim bibliotekama:
* `pop eax; ret`: Skida vrh steka u `EAX` i vraća se.
* `pop ebx; ret`: Skida vrh steka u `EAX` i vraća se.
* `mov [ebx], eax; ret`: Premešta vrednost iz `EAX` na lokaciju na koju pokazuje `EBX`.
* Adresa `system` funkcije.
2. **Priprema Lanca**: Potrebno je pripremiti stek koji izgleda ovako:
* Adresa gadgeta koji postavlja `EBX`.
* Adresa gadgeta `pop eax; ret`.
* Adresa stringa `"/bin/sh"` u memoriji (ili gde planiramo da ga napišemo).
* Adresa gadgeta `mov [ebx], eax; ret`, da premesti `"/bin/sh"` na lokaciju na koju pokazuje `EBX`.
* Adresa funkcije `system`, sa `EBX` koji pokazuje naš string.
3. **Izvršavanje**: Kada ranjiva funkcija završi, počinje izvršavanje našeg lanca gadgeta, što na kraju poziva `system("/bin/sh")`, i otvara shell.

### ROP u x64

Razmotrimo hipotetički scenario gde želite pozvati `execve("/bin/sh", NULL, NULL)` na x64 sistemu koristeći System V AMD64 ABI:

1. **Pronalaženje Gadgeta**: Prvo biste trebali pronaći gadzete koji vam omogućavaju kontrolu nad registrima `RDI`, `RSI`, i `RDX`, jer će oni držati argumente za `execve`.
2. **Konstrukcija Lanca**:
* **Postavite `RDI` da pokazuje na string `"/bin/sh"`**: Ovo se obično radi sa `pop RDI; ret` gadgetom praćenim adresom stringa (koji može biti potreban da se stavi u payload ili pronađe u memoriji).
* **Postavite `RSI` i `RDX` na nulu**: Pošto su drugi i treći argumenti za `execve` `NULL`, trebate gadzete da postavite ove registre na nulu, poput `xor RSI, RSI; ret` i `xor RDX, RDX; ret`.
* **Pozovite `execve`**: Na kraju, potreban je gadzet koji skače na `execve` (ili ga indirektno poziva).
3. **Izvršavanje Payload-a**: Nakon konstruisanja i slanja ovog payload-a ranjivoj aplikaciji, ROP lanac se izvršava, otvarajući shell.

Pošto x64 koristi registre za prvih nekoliko argumenata, često zahteva manje gadgeta od x86 za jednostavne pozive funkcija, ali pronalaženje i spajanje pravih gadgeta može biti složenije zbog povećanog broja registara i većeg adresnog prostora. Povećan broj registara i veći adresni prostor u **x64** arhitekturi pružaju i mogućnosti i izazove za razvoj eksploatacije, posebno u kontekstu Return-Oriented Programming (ROP).

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
