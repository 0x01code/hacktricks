# ROP - Programa√ß√£o Orientada a Retorno

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks Especialista em Equipe Vermelha AWS)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## **Informa√ß√µes B√°sicas**

**Programa√ß√£o Orientada a Retorno (ROP)** √© uma t√©cnica avan√ßada de explora√ß√£o usada para contornar medidas de seguran√ßa como **No-Execute (NX)** ou **Preven√ß√£o de Execu√ß√£o de Dados (DEP)**. Em vez de injetar e executar shellcode, um atacante aproveita peda√ßos de c√≥digo j√° presentes no bin√°rio ou em bibliotecas carregadas, conhecidos como **"gadgets"**. Cada gadget geralmente termina com uma instru√ß√£o `ret` e realiza uma pequena opera√ß√£o, como mover dados entre registradores ou realizar opera√ß√µes aritm√©ticas. Ao encadear esses gadgets, um atacante pode construir uma carga √∫til para realizar opera√ß√µes arbitr√°rias, contornando efetivamente as prote√ß√µes NX/DEP.

### Conven√ß√µes de Chamada

Compreender as **conven√ß√µes de chamada** √© crucial para construir cadeias ROP eficazes, especialmente ao chamar fun√ß√µes ou manipular dados:

**x86 (32 bits)**

* **cdecl**: O chamador limpa a pilha. Os argumentos da fun√ß√£o s√£o empurrados para a pilha em ordem reversa (da direita para a esquerda). **Os argumentos s√£o empurrados para a pilha da direita para a esquerda.**
* **stdcall**: Semelhante ao cdecl, mas o chamado √© respons√°vel por limpar a pilha.

**x64 (64 bits)**

* Usa a conven√ß√£o de chamada **System V AMD64 ABI** em sistemas semelhantes ao Unix, onde os **primeiros seis argumentos inteiros ou de ponteiro s√£o passados nos registradores `RDI`, `RSI`, `RDX`, `RCX`, `R8` e `R9`**. Argumentos adicionais s√£o passados na pilha. O valor de retorno √© colocado em `RAX`.
* A conven√ß√£o de chamada **Windows x64** usa `RCX`, `RDX`, `R8` e `R9` para os quatro primeiros argumentos inteiros ou de ponteiro, com argumentos adicionais passados na pilha. O valor de retorno √© colocado em `RAX`.
* **Registradores**: Os registradores de 64 bits incluem `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` e `R8` a `R15`.

{% hint style="danger" %}
A partir dessas conven√ß√µes de chamada, √© poss√≠vel observar que em **32 bits os argumentos** das fun√ß√µes s√£o **passados pela pilha** enquanto em **x64** eles s√£o **colocados em registradores espec√≠ficos**.
{% endhint %}

### Como ROP Funciona

1. **Sequestro de Fluxo de Controle**: Primeiramente, um atacante precisa sequestrar o fluxo de controle de um programa, geralmente explorando um estouro de buffer para sobrescrever um endere√ßo de retorno salvo na pilha.
2. **Encadeamento de Gadgets**: O atacante ent√£o seleciona cuidadosamente e encadeia gadgets para realizar as a√ß√µes desejadas. Isso pode envolver configurar argumentos para uma chamada de fun√ß√£o, chamar a fun√ß√£o (por exemplo, `system("/bin/sh")`), e lidar com qualquer limpeza necess√°ria ou opera√ß√µes adicionais.
3. **Execu√ß√£o da Carga √ötil**: Quando a fun√ß√£o vulner√°vel retorna, em vez de retornar para uma localiza√ß√£o leg√≠tima, ela come√ßa a executar a cadeia de gadgets.

### Cadeia ROP em x86

Vamos considerar um cen√°rio hipot√©tico onde queremos chamar `system("/bin/sh")` usando ROP em um bin√°rio de 32 bits:

1. **Encontrar Gadgets**: Suponha que encontramos os seguintes gadgets no bin√°rio ou em bibliotecas carregadas:
* `pop eax; ret`: Desempilha o topo da pilha em `EAX` e retorna.
* `pop ebx; ret`: Desempilha o topo da pilha em `EAX` e retorna.
* `mov [ebx], eax; ret`: Move o valor em `EAX` para a localiza√ß√£o apontada por `EBX`.
* O endere√ßo do `system`.
2. **Preparar a Cadeia**: Precisamos preparar uma pilha que se pare√ßa com isso:
* O endere√ßo do gadget que define `EBX`.
* O endere√ßo do gadget `pop eax; ret`.
* O endere√ßo da string `"/bin/sh"` na mem√≥ria (ou onde planejamos escrev√™-la).
* O endere√ßo do gadget `mov [ebx], eax; ret`, para mover `"/bin/sh"` para a localiza√ß√£o apontada por `EBX`.
* O endere√ßo da fun√ß√£o `system`, com `EBX` apontando para nossa string.
3. **Execu√ß√£o**: Quando a fun√ß√£o vulner√°vel retorna, ela come√ßa a executar nossa cadeia de gadgets, eventualmente chamando `system("/bin/sh")` e abrindo um shell.

### ROP em x64

Considere um cen√°rio hipot√©tico onde voc√™ deseja chamar `execve("/bin/sh", NULL, NULL)` em um sistema x64 usando a conven√ß√£o de chamada System V AMD64 ABI:

1. **Encontrar Gadgets**: Primeiramente, voc√™ precisaria encontrar gadgets que permitam controlar os registradores `RDI`, `RSI` e `RDX`, pois estes conter√£o os argumentos para `execve`.
2. **Constru√ß√£o da Cadeia**:
* **Definir `RDI` para apontar para a string `"/bin/sh"`**: Isso √© tipicamente feito com um gadget `pop RDI; ret` seguido pelo endere√ßo da string (que pode precisar ser colocada na carga √∫til ou encontrada na mem√≥ria).
* **Zerar `RSI` e `RDX`**: Como os segundo e terceiro argumentos para `execve` s√£o `NULL`, voc√™ precisa de gadgets para zerar esses registradores, como `xor RSI, RSI; ret` e `xor RDX, RDX; ret`.
* **Chamar `execve`**: Por fim, √© necess√°rio um gadget que salte para `execve` (ou o chame indiretamente).
3. **Execu√ß√£o da Carga √ötil**: Ap√≥s construir e enviar essa carga √∫til para uma aplica√ß√£o vulner√°vel, a cadeia ROP √© executada, abrindo um shell.

Como o x64 usa registradores para os primeiros argumentos, muitas vezes requer menos gadgets do que o x86 para chamadas de fun√ß√£o simples, mas encontrar e encadear os gadgets corretos pode ser mais complexo devido ao aumento do n√∫mero de registradores e ao maior espa√ßo de endere√ßo. O aumento do n√∫mero de registradores e do espa√ßo de endere√ßo maior na arquitetura **x64** oferece tanto oportunidades quanto desafios para o desenvolvimento de exploits, especialmente no contexto da Programa√ß√£o Orientada a Retorno (ROP).

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks Especialista em Equipe Vermelha AWS)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
