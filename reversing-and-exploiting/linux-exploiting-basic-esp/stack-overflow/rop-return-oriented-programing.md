# ROP - Return Oriented Programing

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 **@hacktricks\_live**（https://twitter.com/hacktricks\_live）**をフォローする**
* **HackTricks**（https://github.com/carlospolop/hacktricks）と**HackTricks Cloud**（https://github.com/carlospolop/hacktricks-cloud）のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>

## **基本情報**

**Return-Oriented Programming (ROP)**は、**No-Execute (NX)**や**Data Execution Prevention (DEP)**などのセキュリティ対策を回避するために使用される高度なエクスプロイト技術です。シェルコードを注入して実行する代わりに、攻撃者はバイナリやロードされたライブラリに既に存在するコード片（**"ガジェット"**として知られる）を利用します。各ガジェットは通常、`ret`命令で終わり、データをレジスタ間で移動したり算術演算を行ったりするなどの小さな操作を実行します。これらのガジェットを連鎖させることで、攻撃者は任意の操作を実行するペイロードを構築し、NX/DEP保護をバイパスできます。

### 呼び出し規約

**呼び出し規約**を理解することは、効果的なROPチェーンを構築するために重要です。特に関数の呼び出しやデータの操作を行う場合には：

**x86（32ビット）**

* **cdecl**：呼び出し元がスタックをクリーンアップします。関数引数はスタックに逆順でプッシュされます（右から左）。**引数は右から左にスタックにプッシュされます。**
* **stdcall**：cdeclに似ていますが、呼び出し先がスタックのクリーンアップを担当します。

**x64（64ビット）**

* Unix系システムでは**System V AMD64 ABI**呼び出し規約を使用し、**最初の6つの整数またはポインタ引数はレジスタ`RDI`、`RSI`、`RDX`、`RCX`、`R8`、`R9`に渡されます**。追加の引数はスタックに渡されます。戻り値は`RAX`に配置されます。
* **Windows x64**呼び出し規約では、最初の4つの整数またはポインタ引数に`RCX`、`RDX`、`R8`、`R9`が使用され、追加の引数はスタックに渡されます。戻り値は`RAX`に配置されます。
* **レジスタ**：64ビットレジスタには`RAX`、`RBX`、`RCX`、`RDX`、`RSI`、`RDI`、`RBP`、`RSP`、`R8`から`R15`が含まれます。

{% hint style="danger" %}
これらの呼び出し規約から、**32ビットでは関数への引数**が**スタックを介して渡され**、**x64**では**特定のレジスタに配置**されることがわかります。
{% endhint %}

### ROPの動作

1. **制御フローのハイジャック**：まず、攻撃者は通常、バッファオーバーフローを悪用してスタック上の保存された戻りアドレスを上書きすることで、プログラムの制御フローをハイジャックする必要があります。
2. **ガジェットの連鎖**：次に、攻撃者は慎重にガジェットを選択して連鎖させ、必要な操作を実行します。これには関数呼び出しの引数の設定、関数の呼び出し（例：`system("/bin/sh")`）、必要なクリーンアップや追加の操作の処理が含まれる可能性があります。
3. **ペイロードの実行**：脆弱な関数が返されると、正規の場所に戻る代わりに、ガジェットの連鎖を実行し始めます。

### x86のROPチェーン

32ビットバイナリでROPを使用して`system("/bin/sh")`を呼び出したいと仮定した仮想的なシナリオを考えてみましょう：

1. **ガジェットの検索**：バイナリやロードされたライブラリで次のガジェットを見つけたとします：
* `pop eax; ret`：スタックのトップを`EAX`にポップして返します。
* `pop ebx; ret`：スタックのトップを`EAX`にポップして返します。
* `mov [ebx], eax; ret`：`EAX`の値を`EBX`が指す場所に移動します。
* `system`関数のアドレス。
2. **チェーンの準備**：次のようなスタックを準備する必要があります：
* `EBX`を設定するガジェットのアドレス。
* `pop eax; ret`ガジェットのアドレス。
* メモリ内の文字列`"/bin/sh"`のアドレス（または書き込む予定の場所）のアドレス。
* `mov [ebx], eax; ret`ガジェットのアドレス、`EBX`が指す場所に`"/bin/sh"`を移動します。
* `system`関数のアドレスで、`EBX`が私たちの文字列を指しています。
3. **実行**：脆弱な関数が返されると、ガジェットチェーンを実行し、最終的に`system("/bin/sh")`を呼び出してシェルをポップします。

### x64のROP

System V AMD64 ABIを使用してx64システムで`execve("/bin/sh", NULL, NULL)`を呼び出したいと仮定した仮想的なシナリオを考えてみましょう：

1. **ガジェットの検索**：`execve`の引数を保持する`RDI`、`RSI`、`RDX`レジスタを制御できるガジェットを最初に見つける必要があります。
2. **チェーンの構築**：
* **`RDI`を文字列`"/bin/sh"`を指すように設定**：通常、`pop RDI; ret`ガジェットに続いて文字列のアドレス（ペイロードに配置する必要があるか、メモリ内で見つける必要があるかもしれません）が続きます。
* **`RSI`と`RDX`をゼロにする**：`execve`の2番目と3番目の引数が`NULL`であるため、これらのレジスタをゼロにするための`xor RSI, RSI; ret`や`xor RDX, RDX; ret`などのガジェットが必要です。
* **`execve`を呼び出す**：最後に、`execve`にジャンプする（または間接的に呼び出す）ガジェットが必要です。
3. **ペイロードの実行**：このペイロードを構築して脆弱なアプリケーションに送信した後、ROPチェーンが実行され、シェルが生成されます。

x64は最初の数個の引数にレジスタを使用するため、単純な関数呼び出しにはx86よりも少ないガジェットが必要ですが、適切なガジェットを見つけて連鎖させることがより複雑になる可能性があります。**x64**アーキテクチャの増加したレジスタ数と大きなアドレス空間は、特にReturn-Oriented Programming（ROP）の文脈でのエクスプロイト開発において、機会と課題の両方を提供します。

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 **@hacktricks\_live**（https://twitter.com/hacktricks\_live）**をフォローする**
* **HackTricks**（https://github.com/carlospolop/hacktricks）と**HackTricks Cloud**（https://github.com/carlospolop/hacktricks-cloud）のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有してください。

</details>
