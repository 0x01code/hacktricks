# ROP - Return Oriented Programing

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## **Informations de base**

**La programmation orient√©e retour (ROP)** est une technique d'exploitation avanc√©e utilis√©e pour contourner les mesures de s√©curit√© telles que **No-Execute (NX)** ou **Data Execution Prevention (DEP)**. Au lieu d'injecter et d'ex√©cuter du shellcode, un attaquant exploite des morceaux de code d√©j√† pr√©sents dans le binaire ou dans les biblioth√®ques charg√©es, appel√©s **"gadgets"**. Chaque gadget se termine g√©n√©ralement par une instruction `ret` et effectue une petite op√©ration, telle que le d√©placement de donn√©es entre les registres ou l'ex√©cution d'op√©rations arithm√©tiques. En encha√Ænant ces gadgets, un attaquant peut construire une charge utile pour effectuer des op√©rations arbitraires, contournant ainsi efficacement les protections NX/DEP.

### Conventions d'appel

Comprendre les **conventions d'appel** est crucial pour construire des cha√Ænes ROP efficaces, en particulier lors de l'appel de fonctions ou de la manipulation de donn√©es :

**x86 (32 bits)**

* **cdecl** : L'appelant nettoie la pile. Les arguments de fonction sont pouss√©s sur la pile dans l'ordre inverse (de droite √† gauche). **Les arguments sont pouss√©s sur la pile de droite √† gauche**.
* **stdcall** : Similaire √† cdecl, mais c'est le destinataire qui est responsable du nettoyage de la pile.

**x64 (64 bits)**

* Utilise la convention d'appel **System V AMD64 ABI** sur les syst√®mes de type Unix, o√π les **six premiers arguments entiers ou pointeurs sont pass√©s dans les registres `RDI`, `RSI`, `RDX`, `RCX`, `R8` et `R9`**. Les arguments suppl√©mentaires sont pass√©s sur la pile. La valeur de retour est plac√©e dans `RAX`.
* La convention d'appel **Windows x64** utilise `RCX`, `RDX`, `R8` et `R9` pour les quatre premiers arguments entiers ou pointeurs, les arguments suppl√©mentaires √©tant pass√©s sur la pile. La valeur de retour est plac√©e dans `RAX`.
* **Registres** : Les registres 64 bits incluent `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` et `R8` √† `R15`.

{% hint style="danger" %}
√Ä partir de ces conventions d'appel, il est possible d'observer que dans les **32 bits, les arguments** des fonctions sont **pass√©s via la pile** tandis que dans **x64** ils sont **plac√©s dans des registres sp√©cifiques**.
{% endhint %}

### Fonctionnement de ROP

1. **D√©tournement du flux de contr√¥le** : Tout d'abord, un attaquant doit d√©tourner le flux de contr√¥le d'un programme, g√©n√©ralement en exploitant un d√©passement de tampon pour √©craser une adresse de retour sauvegard√©e sur la pile.
2. **Encha√Ænement de gadgets** : L'attaquant s√©lectionne ensuite soigneusement et encha√Æne des gadgets pour effectuer les actions souhait√©es. Cela pourrait impliquer la configuration des arguments pour un appel de fonction, l'appel de la fonction (par exemple, `system("/bin/sh")`), et la gestion de toute op√©ration de nettoyage ou suppl√©mentaire n√©cessaire.
3. **Ex√©cution de la charge utile** : Lorsque la fonction vuln√©rable retourne, au lieu de retourner √† un emplacement l√©gitime, elle commence √† ex√©cuter la cha√Æne de gadgets.

### Cha√Æne ROP en x86

Consid√©rons un sc√©nario hypoth√©tique o√π nous voulons appeler `system("/bin/sh")` en utilisant ROP dans un binaire 32 bits :

1. **Trouver des gadgets** : Supposons que nous ayons trouv√© les gadgets suivants dans le binaire ou les biblioth√®ques charg√©es :
* `pop eax; ret` : D√©pile le sommet de la pile dans `EAX` et retourne.
* `pop ebx; ret` : D√©pile le sommet de la pile dans `EAX` et retourne.
* `mov [ebx], eax; ret` : D√©place la valeur dans `EAX` √† l'emplacement point√© par `EBX`.
* L'adresse de `system`.
2. **Pr√©parer la cha√Æne** : Nous devons pr√©parer une pile qui ressemble √† ceci :
* L'adresse du gadget qui d√©finit `EBX`.
* L'adresse du gadget `pop eax; ret`.
* L'adresse de la cha√Æne `"/bin/sh"` en m√©moire (ou o√π nous pr√©voyons de l'√©crire).
* L'adresse du gadget `mov [ebx], eax; ret`, pour d√©placer `"/bin/sh"` √† l'emplacement point√© par `EBX`.
* L'adresse de la fonction `system`, avec `EBX` pointant vers notre cha√Æne.
3. **Ex√©cution** : Lorsque la fonction vuln√©rable retourne, elle commence √† ex√©cuter notre cha√Æne de gadgets, appelant finalement `system("/bin/sh")`, et ouvrant un shell.

### ROP en x64

Consid√©rons un sc√©nario hypoth√©tique o√π vous souhaitez appeler `execve("/bin/sh", NULL, NULL)` sur un syst√®me x64 en utilisant la convention d'appel System V AMD64 ABI :

1. **Trouver des gadgets** : Vous devriez d'abord trouver des gadgets qui vous permettent de contr√¥ler les registres `RDI`, `RSI` et `RDX`, car ils contiendront les arguments de `execve`.
2. **Construction de la cha√Æne** :
* **D√©finir `RDI` pour pointer vers la cha√Æne `"/bin/sh"`** : Cela se fait g√©n√©ralement avec un gadget `pop RDI; ret` suivi de l'adresse de la cha√Æne (qui peut devoir √™tre plac√©e dans la charge utile ou trouv√©e en m√©moire).
* **Mettre √† z√©ro `RSI` et `RDX`** : Comme les deuxi√®me et troisi√®me arguments de `execve` sont `NULL`, vous avez besoin de gadgets pour mettre √† z√©ro ces registres, comme `xor RSI, RSI; ret` et `xor RDX, RDX; ret`.
* **Appeler `execve`** : Enfin, un gadget qui saute vers `execve` (ou l'appelle indirectement) est requis.
3. **Ex√©cution de la charge utile** : Apr√®s avoir construit et envoy√© cette charge utile √† une application vuln√©rable, la cha√Æne ROP s'ex√©cute, ouvrant un shell.

√âtant donn√© que x64 utilise des registres pour les premiers arguments, il n√©cessite souvent moins de gadgets que x86 pour des appels de fonction simples, mais trouver et encha√Æner les bons gadgets peut √™tre plus complexe en raison du nombre accru de registres et de l'espace d'adressage plus grand. Le nombre accru de registres et l'espace d'adressage plus grand dans l'architecture **x64** offrent √† la fois des opportunit√©s et des d√©fis pour le d√©veloppement d'exploits, en particulier dans le contexte de la programmation orient√©e retour (ROP).

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
