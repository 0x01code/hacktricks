# ROP - Return Oriented Programing

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>

## **Informazioni di Base**

**Return-Oriented Programming (ROP)** √® una tecnica avanzata di exploit utilizzata per aggirare misure di sicurezza come **No-Execute (NX)** o **Data Execution Prevention (DEP)**. Invece di iniettare ed eseguire shellcode, un attaccante sfrutta pezzi di codice gi√† presenti nel binario o nelle librerie caricate, noti come **"gadget"**. Ogni gadget termina tipicamente con un'istruzione `ret` e esegue una piccola operazione, come spostare dati tra registri o eseguire operazioni aritmetiche. Concatenando questi gadget, un attaccante pu√≤ costruire un payload per eseguire operazioni arbitrarie, aggirando efficacemente le protezioni NX/DEP.

### Convenzioni di Chiamata

Comprendere le **convenzioni di chiamata** √® cruciale per costruire catene ROP efficaci, specialmente quando si chiamano funzioni o si manipolano dati:

**x86 (32-bit)**

* **cdecl**: Il chiamante pulisce lo stack. Gli argomenti delle funzioni vengono spinti sullo stack in ordine inverso (da destra a sinistra). **Gli argomenti vengono spinti sullo stack da destra a sinistra.**
* **stdcall**: Simile a cdecl, ma il chiamato √® responsabile della pulizia dello stack.

**x64 (64-bit)**

* Utilizza la convenzione di chiamata **System V AMD64 ABI** su sistemi simili a Unix, dove i **primi sei argomenti interi o puntatori vengono passati nei registri `RDI`, `RSI`, `RDX`, `RCX`, `R8` e `R9`**. Gli argomenti aggiuntivi vengono passati sullo stack. Il valore di ritorno viene posto in `RAX`.
* La convenzione di chiamata **Windows x64** utilizza `RCX`, `RDX`, `R8` e `R9` per i primi quattro argomenti interi o puntatori, con argomenti aggiuntivi passati sullo stack. Il valore di ritorno viene posto in `RAX`.
* **Registri**: I registri a 64 bit includono `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP` e `R8` a `R15`.

{% hint style="danger" %}
Dalle convenzioni di chiamata √® possibile osservare che nei **32 bit gli argomenti** delle funzioni vengono **passati attraverso lo stack** mentre in **x64** vengono **posti in registri specifici**.
{% endhint %}

### Come Funziona ROP

1. **Dirottamento del Flusso di Controllo**: Innanzitutto, un attaccante deve dirottare il flusso di controllo di un programma, tipicamente sfruttando un buffer overflow per sovrascrivere un indirizzo di ritorno salvato nello stack.
2. **Concatenazione di Gadget**: L'attaccante seleziona attentamente e concatena i gadget per eseguire le azioni desiderate. Ci√≤ potrebbe coinvolgere la configurazione degli argomenti per una chiamata di funzione, la chiamata della funzione (ad esempio, `system("/bin/sh")`), e la gestione di eventuali operazioni di pulizia o aggiuntive.
3. **Esecuzione del Payload**: Quando la funzione vulnerabile ritorna, anzich√© tornare a una posizione legittima, inizia ad eseguire la catena di gadget.

### Catena ROP in x86

Consideriamo uno scenario ipotetico in cui vogliamo chiamare `system("/bin/sh")` utilizzando ROP in un binario a 32 bit:

1. **Trova i Gadget**: Supponiamo di aver trovato i seguenti gadget nel binario o nelle librerie caricate:
* `pop eax; ret`: Estrae il valore in cima allo stack in `EAX` e ritorna.
* `pop ebx; ret`: Estrae il valore in cima allo stack in `EAX` e ritorna.
* `mov [ebx], eax; ret`: Sposta il valore in `EAX` nella posizione indicata da `EBX`.
* L'indirizzo di `system`.
2. **Prepara la Catena**: √à necessario preparare uno stack che assomigli a questo:
* L'indirizzo del gadget che imposta `EBX`.
* L'indirizzo del gadget `pop eax; ret`.
* L'indirizzo della stringa `"/bin/sh"` in memoria (o dove intendiamo scriverla).
* L'indirizzo del gadget `mov [ebx], eax; ret`, per spostare `"/bin/sh"` nella posizione indicata da `EBX`.
* L'indirizzo della funzione `system`, con `EBX` che punta alla nostra stringa.
3. **Esecuzione**: Quando la funzione vulnerabile ritorna, inizia ad eseguire la nostra catena di gadget, chiamando alla fine `system("/bin/sh")`, e aprendo una shell.

### ROP in x64

Consideriamo uno scenario ipotetico in cui si desidera chiamare `execve("/bin/sh", NULL, NULL)` su un sistema x64 utilizzando la convenzione di chiamata System V AMD64 ABI:

1. **Trova i Gadget**: Prima di tutto √® necessario trovare gadget che ti permettano di controllare i registri `RDI`, `RSI` e `RDX`, poich√© questi conterranno gli argomenti per `execve`.
2. **Costruzione della Catena**:
* **Imposta `RDI` per puntare alla stringa `"/bin/sh"`**: Di solito questo viene fatto con un gadget `pop RDI; ret` seguito dall'indirizzo della stringa (che potrebbe essere necessario inserire nel payload o trovare in memoria).
* **Azzerare `RSI` e `RDX`**: Poich√© il secondo e il terzo argomento per `execve` sono `NULL`, sono necessari gadget per azzerare questi registri, come `xor RSI, RSI; ret` e `xor RDX, RDX; ret`.
* **Chiama `execve`**: Infine, √® necessario un gadget che salti a `execve` (o lo chiami indirettamente).
3. **Esecuzione del Payload**: Dopo aver costruito e inviato questo payload a un'applicazione vulnerabile, la catena ROP si esegue, generando una shell.

Poich√© x64 utilizza registri per i primi pochi argomenti, spesso richiede meno gadget rispetto a x86 per chiamate di funzioni semplici, ma trovare e concatenare i gadget giusti pu√≤ essere pi√π complesso a causa del numero maggiore di registri e dello spazio degli indirizzi pi√π ampio. Il numero maggiore di registri e lo spazio degli indirizzi pi√π ampio nell'architettura **x64** offrono sia opportunit√† che sfide nello sviluppo di exploit, specialmente nel contesto della Return-Oriented Programming (ROP).

<details>

<summary><strong>Impara l'hacking su AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repository di Github.

</details>
