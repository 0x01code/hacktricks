# ROP - Return Oriented Programing

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## **Basiese Inligting**

**Return-Oriented Programming (ROP)** is 'n gevorderde uitbuitingstegniek wat gebruik word om sekuriteitsmaatre√´ls soos **No-Execute (NX)** of **Data Execution Prevention (DEP)** te omseil. In plaas van om shellcode in te spuit en uit te voer, maak 'n aanvaller gebruik van stukke kode wat reeds teenwoordig is in die bin√™re l√™er of in gelaai biblioteke, bekend as **"gadgets"**. Elke gadget eindig tipies met 'n `ret` instruksie en voer 'n klein operasie uit, soos die skuif van data tussen registre of die uitvoer van rekenkundige operasies. Deur hierdie gadgets aan mekaar te koppel, kan 'n aanvaller 'n lading konstrueer om arbitr√™re operasies uit te voer, wat effektief NX/DEP-beskerming omseil.

### Oproepkonvensies

Begrip van **oproepkonvensies** is noodsaaklik vir die konstruksie van effektiewe ROP-reekse, veral wanneer funksies opgeroep word of data gemanipuleer word:

**x86 (32-bis)**

* **cdecl**: Die aanroeper maak die stok skoon. Funksie-argumente word in omgekeerde volgorde (regs-na-links) op die stok gedruk. **Argumente word van regs na links op die stok gedruk.**
* **stdcall**: Soortgelyk aan cdecl, maar die ontvanger is verantwoordelik vir die skoonmaak van die stok.

**x64 (64-bis)**

* Gebruik die **System V AMD64 ABI** oproepkonvensie op Unix-soort stelsels, waar die **eerste ses heelgetal- of wysaanduidingsargumente in die registre `RDI`, `RSI`, `RDX`, `RCX`, `R8`, en `R9`** oorgedra word. Addisionele argumente word op die stok oorgedra. Die terugvoerwaarde word in `RAX` geplaas.
* **Windows x64** oproepkonvensie gebruik `RCX`, `RDX`, `R8`, en `R9` vir die eerste vier heelgetal- of wysaanduidingsargumente, met addisionele argumente wat op die stok oorgedra word. Die terugvoerwaarde word in `RAX` geplaas.
* **Registre**: 64-bis registre sluit in `RAX`, `RBX`, `RCX`, `RDX`, `RSI`, `RDI`, `RBP`, `RSP`, en `R8` tot `R15`.

{% hint style="danger" %}
Vanuit hierdie oproepkonvensies is dit moontlik om op te merk dat in **32-bis die argumente** vir funksies deur die stok **oorgedra word** terwyl dit in **x64** in **spesifieke registre geplaas word**.
{% endhint %}

### Hoe ROP Werk

1. **Beheerstroomkaping**: Eerstens moet 'n aanvaller die beheerstroom van 'n program kap, tipies deur 'n buffer-oorvloei te benut om 'n gestoorde terugvoeradres op die stok te oorskryf.
2. **Gadgetkoppeling**: Die aanvaller kies sorgvuldig gadgets en koppel hulle om die gewenste aksies uit te voer. Dit kan die opstel van argumente vir 'n funksieoproep, die aanroep van die funksie (bv., `system("/bin/sh")`), en die hanteer van enige nodige skoonmaak of addisionele operasies insluit.
3. **Ladinguitvoering**: Wanneer die kwesbare funksie terugkeer, begin dit ons gadgetketting uitvoer, wat uiteindelik `system("/bin/sh")` aanroep en 'n skaal oopmaak.

### ROP-reeks in x86

Laat ons 'n hipotetiese scenario oorweeg waar ons `system("/bin/sh")` wil aanroep deur ROP in 'n 32-bis bin√™re l√™er te gebruik:

1. **Vind Gadgets**: Stel ons het die volgende gadgets in die bin√™re l√™er of gelaai biblioteke gevind:
* `pop eax; ret`: Haal die boonste van die stok in `EAX` uit en keer terug.
* `pop ebx; ret`: Haal die boonste van die stok in `EAX` uit en keer terug.
* `mov [ebx], eax; ret`: Skuif die waarde in `EAX` na die plek wat deur `EBX` aangedui word.
* Die adres van `system`.
2. **Berei die Ketting Voor**: Ons moet 'n stok voorberei wat soos volg lyk:
* Die adres van die gadget wat `EBX` instel.
* Die adres van die `pop eax; ret` gadget.
* Die adres van die string `"/bin/sh"` in geheue (of waar ons beplan om dit te skryf).
* Die adres van die `mov [ebx], eax; ret` gadget, om `"/bin/sh"` na die plek wat deur `EBX` aangedui word, te skuif.
* Die adres van die `system`-funksie, met `EBX` wat na ons string wys.
3. **Uitvoering**: Wanneer die kwesbare funksie terugkeer, begin dit ons gadgetketting uitvoer, wat uiteindelik `system("/bin/sh")` aanroep en 'n skaal oopmaak.

### ROP in x64

Oorweeg 'n hipotetiese scenario waar jy `execve("/bin/sh", NULL, NULL)` op 'n x64-stelsel wil aanroep deur die System V AMD64 ABI te gebruik:

1. **Vind Gadgets**: Eerstens moet jy gadgets vind wat jou in staat stel om die `RDI`, `RSI`, en `RDX` registre te beheer, aangesien hierdie die argumente vir `execve` sal hou.
2. **Kettingkonstruksie**:
* **Stel `RDI` in om na die string `"/bin/sh"` te wys**: Dit word tipies gedoen met 'n `pop RDI; ret` gadget gevolg deur die adres van die string (wat in die lading geplaas moet word of in geheue gevind moet word).
* **Nulstel `RSI` en `RDX`**: Aangesien die tweede en derde argumente vir `execve` `NULL` is, het jy gadgets nodig om hierdie registre nul te stel, soos `xor RSI, RSI; ret` en `xor RDX, RDX; ret`.
* **Roep `execve` aan**: Laastens is 'n gadget wat na `execve` spring (of dit indirek aanroep) nodig.
3. **Ladinguitvoering**: Nadat hierdie lading saamgestel en na 'n kwesbare aansoek gestuur is, voer die ROP-reeks uit en skep 'n skaal.

Aangesien x64 registre gebruik vir die eerste paar argumente, vereis dit dikwels minder gadgets as x86 vir eenvoudige funksieoproepe, maar die vind en koppel van die regte gadgets kan meer kompleks wees as gevolg van die verhoogde aantal registre en die groter adresruimte. Die verhoogde aantal registre en die groter adresruimte in **x64**-argitektuur bied geleenthede en uitdagings vir uitbuitontwikkeling, veral in die konteks van Return-Oriented Programming (ROP).

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling van eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Deel jou hacking-truuks deur PRs in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
