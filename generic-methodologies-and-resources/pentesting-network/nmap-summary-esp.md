# Resumo do Nmap (ESP)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Par√¢metros

### IPs para escanear

* **`<ip>,<net/mask>`:** Indique os ips diretamente
* **`-iL <ips_file>`:** list\_IPs
* **`-iR <number>`**: N√∫mero de Ips aleat√≥rios, voc√™ pode excluir Ips poss√≠veis com `--exclude <Ips>` ou `--excludefile <file>`.

### Descoberta de equipamentos

Por padr√£o, o Nmap inicia uma fase de descoberta consistindo em: `-PA80 -PS443 -PE -PP`

* **`-sL`**: N√£o √© invasivo, lista os alvos fazendo solicita√ß√µes **DNS** para resolver nomes. √â √∫til para saber se, por exemplo, www.prueba.es/24 todas as Ips s√£o nossos alvos.
* **`-Pn`**: **No ping**. Isso √© √∫til se voc√™ sabe que todos eles est√£o ativos (se n√£o, voc√™ poderia perder muito tempo, mas essa op√ß√£o tamb√©m produz falsos negativos dizendo que eles n√£o est√£o ativos), evita a fase de descoberta.
* **`-sn`** : **No port scan**. Ap√≥s completar a fase de reconhecimento, n√£o escaneia portas. √â relativamente furtivo e permite um pequeno escaneamento de rede. Com privil√©gios, envia um ACK (-PA) para 80, um SYN(-PS) para 443 e uma solicita√ß√£o de eco e uma solicita√ß√£o de Timestamp, sem privil√©gios, sempre completa conex√µes. Se o alvo for a rede, s√≥ usa ARP(-PR). Se usado com outra op√ß√£o, apenas os pacotes da outra op√ß√£o s√£o descartados.
* **`-PR`**: **Ping ARP**. √â usado por padr√£o ao analisar computadores em nossa rede, √© mais r√°pido do que usar pings. Se voc√™ n√£o quiser usar pacotes ARP, use `--send-ip`.
* **`-PS <ports>`**: Envia pacotes SYN para os quais, se responder SYN/ACK, est√° aberto (para o qual responde com RST para n√£o terminar a conex√£o), se responder RST est√° fechado e se n√£o responder est√° inacess√≠vel. Caso n√£o tenha privil√©gios, √© usado automaticamente uma conex√£o total. Se nenhum porto for dado, ele joga para 80.
* **`-PA <ports>`**: Como o anterior, mas com ACK, combinando ambos d√° melhores resultados.
* **`-PU <ports>`**: O objetivo √© o oposto, s√£o enviados para portas que se espera que estejam fechadas. Alguns firewalls s√≥ verificam conex√µes TCP. Se estiver fechado, √© respondido com porta inacess√≠vel, se for respondido com outro icmp ou n√£o respondido, √© deixado como destino inacess√≠vel.
* **`-PE, -PP, -PM`** : ICMP PINGS: replay de eco, timestamp e addresmask. S√£o lan√ßados para descobrir se o alvo est√° ativo.
* **`-PY<ports>`**: Envia sondas SCTP INIT para 80 por padr√£o, INIT-ACK(aberto) ou ABORT(fechado) ou nada ou ICMP inacess√≠vel(inativo) pode ser respondido.
* **`-PO <protocols>`**: Um protocolo √© indicado nos cabe√ßalhos, por padr√£o 1(ICMP), 2(IGMP) e 4(Encap IP). Para os protocolos ICMP, IGMP, TCP (6) e UDP (17), os cabe√ßalhos do protocolo s√£o enviados, para o resto, apenas o cabe√ßalho IP √© enviado. O prop√≥sito disso √© que, devido √† m√° forma√ß√£o dos cabe√ßalhos, Protocolo inacess√≠vel ou respostas do mesmo protocolo s√£o respondidas para saber se est√° ativo.
* **`-n`**: No DNS
* **`-R`**: DNS sempre

### T√©cnicas de escaneamento de portas

* **`-sS`**: N√£o completa a conex√£o, ent√£o n√£o deixa rastro, muito bom se puder ser usado.(privil√©gios) √â o que √© usado por padr√£o.
* **`-sT`**: Completa a conex√£o, ent√£o deixa rastro, mas pode ser usado com certeza. Por padr√£o sem privil√©gios.
* **`-sU`**: Mais lento, para UDP. Principalmente: DNS(53), SNMP(161,162), DHCP(67 e 68), (-sU53,161,162,67,68): aberto(resposta), fechado(porta inacess√≠vel), filtrado (outro ICMP), aberto/filtrado (nada). Em caso de aberto/filtrado, -sV envia numerosas solicita√ß√µes para detectar qualquer uma das vers√µes que o nmap suporta e pode detectar o verdadeiro estado. Aumenta muito o tempo.
* **`-sY`**: Protocolo SCTP falha em estabelecer a conex√£o, ent√£o n√£o h√° logs, funciona como -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, podem penetrar em alguns firewalls e extrair informa√ß√µes. Baseiam-se no fato de que m√°quinas em conformidade com o padr√£o devem responder com RST todas as solicita√ß√µes que n√£o t√™m as flags SYN, RST ou ACK levantadas: aberto/filtrado(nada), fechado(RST), filtrado (ICMP inacess√≠vel). N√£o confi√°vel no Windows, Cisco, BSDI e OS/400. No unix sim.
* **`-sM`**: Maimon scan: Envia flags FIN e ACK, usado para BSD, atualmente retornar√° todos como fechados.
* **`-sA, sW`**: ACK e Janela, √© usado para detectar firewalls, para saber se os portos est√£o filtrados ou n√£o. O -sW distingue entre aberto/fechado, pois os abertos respondem com um valor de janela diferente: aberto (RST com janela diferente de 0), fechado (RST janela = 0), filtrado (ICMP inacess√≠vel ou nada). Nem todos os computadores funcionam dessa maneira, ent√£o se tudo estiver fechado, n√£o est√° funcionando, se for alguns abertos, est√° funcionando bem, e se for muitos abertos e poucos fechados, est√° funcionando ao contr√°rio.
* **`-sI`:** Idle scan. Para os casos em que h√° um firewall ativo, mas sabemos que ele n√£o filtra para um certo Ip (ou quando simplesmente queremos anonimato), podemos usar o scanner zumbi (funciona para todos os portos), para procurar poss√≠veis zumbis podemos usar o script ipidseq ou o exploit auxiliary/scanner/ip/ipidseq. Este scanner baseia-se no n√∫mero IPID dos pacotes IP.
* **`--badsum`:** Envia a soma errada, os computadores descartariam os pacotes, mas os firewalls poderiam responder algo, √© usado para detectar firewalls.
* **`-sZ`:** Scanner SCTP "estranho", ao enviar sondas com fragmentos de eco de cookie, eles devem ser descartados se abertos ou respondidos com ABORT se fechados. Pode passar por firewalls que o init n√£o passa, o ruim √© que n√£o distingue entre filtrado e aberto.
* **`-sO`:** Protocolo Ip scan. Envia cabe√ßalhos ruins e vazios nos quais √†s vezes nem o protocolo pode ser distinguido. Se chegar ICMP protocolo inacess√≠vel est√° fechado, se chegar porta inacess√≠vel est√° aberto, se chegar outro erro, filtrado, se n√£o chegar nada, aberto|filtrado.
* **`-b <server>`:** FTPhost--> √â usado para escanear um host a partir de outro, isso √© feito conectando-se ao ftp de outra m√°quina e pedindo para enviar arquivos para os portos que voc√™ deseja escanear de outra m√°quina, de acordo com as respostas saberemos se est√£o abertos ou n√£o. \[\<user>:\<password>@]\<server>\[:\<port>] Quase todos os servidores ftp n√£o permitem mais fazer isso e, portanto, √© de pouca utilidade pr√°tica.

### **Centrar an√°lisis**

**-p:** Serve para dar os portos a escanear. Para selecionar os 65335: **-p-** ou **-p all**. O Nmap tem uma classifica√ß√£o interna de acordo com sua popularidade. Por padr√£o, usa os 1000 principais. Com **-F** (fast scan) analisa os 100 principais. Com **--top-ports \<numero>** Analisa esse n√∫mero de principais (de 1 at√© 65335). Verifica os portos em ordem aleat√≥ria, para que isso n√£o aconte√ßa **-r**. Tamb√©m podemos selecionar portos: 20-30,80,443,1024- Isso √∫ltimo significa que olhe para frente do 1024. Tamb√©m podemos agrupar os portos por protocolos: U:53,T:21-25,80,139,S:9. Tamb√©m podemos escolher um intervalo dentro dos portos populares do nmap: -p \[-1024] analisa at√© o 1024 dos inclu√≠dos em nmap-services. **--port-ratio \<ratio>** Analisa os portos mais comuns que uma propor√ß√£o que deve estar entre 0 e 1

**-sV** Escaneamento de vers√£o, pode-se regular a intensidade de 0 a 9, por padr√£o 7.

**--version-intensity \<numero>** Regulamos a intensidade, de forma que quanto mais baixo s√≥ lan√ßar√° as sondas mais prov√°veis, mas n√£o todas. Com isso podemos reduzir consideravelmente o tempo de escaneamento UDP

**-O** Detec√ß√£o de os

**--osscan-limit** Para escanear bem um host √© necess√°rio que pelo menos haja 1 porto aberto e outro fechado, se n√£o for dada essa condi√ß√£o e tivermos colocado isso, n√£o tenta fazer previs√£o de os (economiza tempo)

**--osscan-guess** Quando a detec√ß√£o de os n√£o √© perfeita, isso faz com que se esforce mais

**Scripts**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

Para usar os de por efeito vale com -sC ou --script=default

Os tipos que h√° s√£o de: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, and vuln

* **Auth:** executa todos seus _scripts_ dispon√≠veis para autentica√ß√£o
* **Default:** executa os _scripts_ b√°sicos por defeito da ferramenta
* **Discovery:** recupera informa√ß√£o do _target_ ou v√≠tima
* **External:** _script_ para utilizar recursos externos
* **Intrusive:** utiliza _scripts_ que s√£o considerados intrusivos para a v√≠tima ou _target_
* **Malware:** revisa se h√° conex√µes abertas por c√≥digos maliciosos ou _backdoors_ (portas traseiras)
* **Safe:** executa _scripts_ que n√£o s√£o intrusivos
* **Vuln:** descobre as vulnerabilidades mais conhecidas
* **All:** executa absolutamente todos os _scripts_ com extens√£o NSE dispon√≠veis

Para buscar scripts:

**nmap --script-help="http-\*" -> Os que come√ßam por http-**

**nmap --script-help="not intrusive" -> Todos menos esses**

**nmap --script-help="default or safe" -> Os que est√£o em um ou no outro ou em ambos**

**nmap --script-help="default and safe" --> Os que est√£o em ambos**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> D√° info de como vai o script

\--script-updatedb

**Para usar um script s√≥ tem que colocar: namp --script Nome\_do\_script objetivo** --> Ao colocar o script, ser√° executado tanto o script quanto o escaner, ent√£o tamb√©m se podem colocar op√ß√µes do escaner, podemos adicionar **‚Äúsafe=1‚Äù** para que se executem s√≥ os que s√£o seguros.

**Controle de tempo**

**Nmap pode modificar o tempo em segundos, minutos, ms:** --host-timeout arguments 900000ms, 900, 900s, and 15m all do the same thing.

Nmap divide o n√∫mero total de host a escanear em grupos e analisa esses grupos em blocos de forma que at√© que n√£o tenham sido analisados todos, n√£o passa ao seguinte bloco (e o usu√°rio tamb√©m n√£o recebe nenhuma atualiza√ß√£o at√© que se tenha analisado o bloco) de esta forma, √© mais √≥timo para nmap usar grupos grandes. Por defeito em classe C usa 256.

Pode-se mudar com\*\*--min-hostgroup\*\* _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ (Adjust parallel scan group sizes)

Pode-se controlar o n√∫mero de escaners em paralelo, mas √© melhor que n√£o (nmap j√° incorpora controle autom√°tico baseado no estado da rede): **--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

Podemos modificar o rtt timeout, mas n√£o costuma ser necess√°rio: **--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

Podemos modificar o n√∫mero de tentativas:**--max-retries** _**\<numtries>**_

Podemos modificar o tempo de escaneamento de um host: **--host-timeout** _**\<time>**_

Podemos modificar o tempo entre cada prova para que v√° devagar: **--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**_

Podemos modificar o n√∫mero de pacotes por segundo: **--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

Muitos portos demoram muito em responder ao estar filtrados ou fechados, se s√≥ nos interessam os abertos, podemos ir mais r√°pido com: **--defeat-rst-ratelimit**

Para definir o qu√£o agressivo queremos que seja o nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> S√≥ se escaneia 1 porto de cada vez e se espera 5min at√© o seguinte

\-T1 e T2 --> Muito parecidos, mas s√≥ esperam 15 e 0,4seg respectivamente entre cada prova

\-T3 --> Funcionamento por defeito, inclui em paralelo

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

N√£o deixam passar a portos e analisam pacotes.

**-f** Para fragmentar pacotes, por defeito os fragmenta em 8bytes depois da cabe√ßalha, para especificar esse tamanho usamos ..mtu (com isso, n√£o usar -f), o offset deve ser m√∫ltiplo de 8. **Escaners de vers√£o e scripts n√£o suportam a fragmenta√ß√£o**

**-D decoy1,decoy2,ME** Nmap envia escaneres, mas com outras dire√ß√µes IPs como origem, dessa forma te escondem a ti. Se colocares o ME na lista, nmap te situar√° a√≠, melhor colocar 5 ou 6 antes de ti para que te mascarem completamente. Pode-se gerar IPs aleat√≥rias com RND:\<numero> Para gerar \<numero> de IPs aleat√≥rias. N√£o funcionam com detector de vers√µes sem conex√£o de TCP. Se est√°s dentro de uma rede, te interessa usar IPs que estejam ativas, pois sen√£o ser√° muito f√°cil descobrir que tu √©s a √∫nica ativa.

Para usar IPs aleat√≥rias: nmap-D RND: 10 Ip\_objetivo

**-S IP** Para quando Nmap n√£o pega tua dire√ß√£o Ip tens que dar com isso. Tamb√©m serve para fazer pensar que h√° outro objetivo escaneandoles.

**-e \<interface>** Para escolher a interface

Muitos administradores deixam portos de entrada abertos para que tudo funcione corretamente e lhes √© mais f√°cil que buscar outra solu√ß√£o. Estes podem ser os portos DNS ou os de FTP... para buscar essa vulnerabilidade nmap incorpora: **--source-port** _**\<portnumber>**_**;-g** _**\<portnumber>**_ _S√£o equivalentes_

**--data** _**\<hex string>**_ Para enviar texto hexadecimal: --data 0xdeadbeef and --data \xCA\xFE\x09

**--data-string** _**\<string>**_ Para enviar um texto normal: --data-string "Scan conducted by Security Ops,
