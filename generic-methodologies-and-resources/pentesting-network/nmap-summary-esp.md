# Podsumowanie Nmap (ESP)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repozytoriów github.

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parametry

### Adresy IP do skanowania

* **`<ip>,<net/mask>`:** Wskazuje bezpośrednio adresy IP
* **`-iL <ips_file>`:** lista\_IPs
* **`-iR <number>`**: Liczba losowych adresów IP, można wykluczyć możliwe adresy IP za pomocą `--exclude <Ips>` lub `--excludefile <file>`.

### Odkrywanie urządzeń

Domyślnie Nmap uruchamia fazę odkrywania składającą się z: `-PA80 -PS443 -PE -PP`

* **`-sL`**: Nieinwazyjne, wyświetla cele, wykonując żądania **DNS** w celu rozwiązania nazw. Jest przydatne, aby dowiedzieć się, czy na przykład www.prueba.es/24 wszystkie adresy IP są naszymi celami.
* **`-Pn`**: **Brak pinga**. Jest to przydatne, jeśli wiesz, że wszystkie są aktywne (jeśli nie, możesz stracić dużo czasu, ale ta opcja również generuje fałszywe negatywy mówiące, że nie są aktywne), zapobiega fazie odkrywania.
* **`-sn`** : **Brak skanowania portów**. Po zakończeniu fazy rozpoznawczej nie skanuje portów. Jest stosunkowo dyskretny i umożliwia skanowanie małej sieci. Z uprawnieniami wysyła ACK (-PA) do 80, SYN(-PS) do 443 oraz żądanie echo i żądanie Timestamp, bez uprawnień zawsze kończy połączenia. Jeśli celem jest sieć, używane jest tylko ARP(-PR). Jeśli używane z inną opcją, odrzucane są tylko pakiety z tej innej opcji.
* **`-PR`**: **Ping ARP**. Jest używany domyślnie podczas analizowania komputerów w naszej sieci, jest szybszy niż pingi. Jeśli nie chcesz używać pakietów ARP, użyj `--send-ip`.
* **`-PS <ports>`**: Wysyła pakiety SYN do portów, na które jeśli odpowie SYN/ACK, oznacza to, że port jest otwarty (odpowiada RST, aby nie zakończyć połączenia), jeśli odpowie RST, port jest zamknięty, a jeśli nie odpowie, port jest nieosiągalny. W przypadku braku uprawnień automatycznie używane jest pełne połączenie. Jeśli nie podano portów, wysyłane jest na port 80.
* **`-PA <ports>`**: Jak poprzednia opcja, ale z ACK, połączenie obu daje lepsze wyniki.
* **`-PU <ports>`**: Celem jest przeciwność, wysyłane są do portów, które powinny być zamknięte. Niektóre firewalle sprawdzają tylko połączenia TCP. Jeśli port jest zamknięty, odpowiada portem niedostępnym, jeśli odpowiada innym icmp lub nie odpowiada, jest uznawany za niedostępny.
* **`-PE, -PP, -PM`** : ICMP PINGS: odpowiedź echo, znacznik czasu i maska adresu. Są wysyłane, aby dowiedzieć się, czy cel jest aktywny.
* **`-PY<ports>`**: Wysyła sondy SCTP INIT domyślnie do 80, może odpowiedzieć INIT-ACK (otwarte) lub ABORT (zamknięte) lub nic lub ICMP niedostępne (nieaktywne).
* **`-PO <protocols>`**: W nagłówkach wskazany jest protokół, domyślnie 1 (ICMP), 2 (IGMP) i 4 (Encap IP). Dla protokołów ICMP, IGMP, TCP (6) i UDP (17) wysyłane są nagłówki protokołów, dla reszty wysyłany jest tylko nagłówek IP. Celem tego jest to, że ze względu na zniekształcenie nagłówków, odpowiedzi na niedostępny protokół lub odpowiedzi tego samego protokołu są udzielane, aby dowiedzieć się, czy jest dostępny.
* **`-n`**: Brak DNS
* **`-R`**: Zawsze DNS

### Techniki skanowania portów

* **`-sS`**: Nie kończy połączenia, więc nie pozostawia śladu, bardzo dobre, jeśli można go użyć (uprawnienia). Jest to domyślnie używane.
* **`-sT`**: Kończy połączenie, więc pozostawia ślad, ale można go użyć bezpiecznie. Domyślnie bez uprawnień.
* **`-sU`**: Wolniejsze, dla UDP. Najczęściej: DNS(53), SNMP(161,162), DHCP(67 i 68), (-sU53,161,162,67,68): otwarte (odpowiedź), zamknięte (port niedostępny), filtrowane (inny ICMP), otwarte/filtrowane (nic). W przypadku otwartych/filtrowanych, -sV wysyła liczne żądania, aby wykryć jedną z wersji obsługiwanych przez nmap i może wykryć prawdziwy stan. Zwiększa to znacznie czas.
* **`-sY`**: Protokół SCTP nie może nawiązać połączenia, więc nie ma logów, działa jak -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, mogą przenikać przez niektóre firewalle i wydobywać informacje. Opierają się na tym, że zgodne ze standardem maszyny powinny odpowiadać RST na wszystkie żądania, które nie mają podniesionych flag SYN, RST lub ACK: otwarte/filtrowane (nic), zamknięte (RST), filtrowane (ICMP niedostępne). Niepewne na systemach Windows, CIsco, BSDI i OS/400. Na systemach Unix tak.
* **`-sM`**: Skan Maimon: Wysyła flagi FIN i ACK, używane dla BSD, obecnie wszystkie zwracają zamknięte.
* **`-sA, sW`**: ACK i Window, służy do wykrywania firewalli, aby dowiedzieć się, czy porty są filtrowane czy nie. -sW rozróżnia między otwartymi/zamkniętymi, ponieważ otwarte odpowiadają inną wartością okna: otwarte (RST z wartością okna inną niż 0), zamknięte (RST okno = 0), filtrowane (ICMP niedostępne lub nic). Nie wszystkie komputery działają w ten sposób, więc jeśli wszystko jest zamknięte, to nie działa, jeśli kilka jest otwartych, to działa dobrze, a jeśli jest wiele otwartych i niewielu zamkniętych, to działa odwrotnie.
* **`-sI`:** Skan bezczynnościowy. W przypadkach, gdy istnieje aktywny firewall, ale wiemy, że nie filtruje określonego adresu IP (lub gdy po prostu chcemy zachować anonimowość), możemy użyć skanera zombie (działa dla wszystkich portów), aby znaleźć możliwe zombi, możemy użyć skryptu ipidseq lub eksploitu auxiliary/scanner/ip/ipidseq. Ten skaner opiera się na numerze IPID pakietów IP.
* **`--badsum`:** Wysyła nieprawid
**--osscan-guess** Gdy wykrywanie systemu operacyjnego nie jest idealne, to zwiększa wysiłek.

**Skrypty**

\--script _\<nazwapliku>_|_\<kategoria>_|_\<katalog>_|_\<wyrażenie>_\[,...]

Aby użyć domyślnych skryptów, wystarczy użyć -sC lub --script=default

Dostępne kategorie to: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version i vuln

* **Auth:** wykonuje wszystkie dostępne skrypty uwierzytelniania
* **Default:** wykonuje podstawowe domyślne skrypty narzędzia
* **Discovery:** pobiera informacje o celu lub ofierze
* **External:** skrypt do korzystania z zewnętrznych zasobów
* **Intrusive:** używa skryptów uważanych za natrętne dla ofiary lub celu
* **Malware:** sprawdza, czy istnieją otwarte połączenia złośliwego oprogramowania lub tylnych drzwi (backdoor)
* **Safe:** wykonuje skrypty, które nie są natrętne
* **Vuln:** odkrywa najbardziej znane podatności
* **All:** wykonuje wszystkie dostępne skrypty NSE z rozszerzeniem

Aby wyszukać skrypty:

**nmap --script-help="http-\*" -> Te, które zaczynają się od http-**

**nmap --script-help="not intrusive" -> Wszystkie oprócz tych**

**nmap --script-help="default or safe" -> Te, które są w jednym lub drugim lub obu**

**nmap --script-help="default and safe" --> Te, które są w obu**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<nazwapliku>_

\--script-help _\<nazwapliku>_|_\<kategoria>_|_\<katalog>_|_\<wyrażenie>_|all\[,...]

\--script-trace ---> Udostępnia informacje o postępie skryptu

\--script-updatedb

Aby użyć skryptu, wystarczy wpisać: nmap --script Nazwa\_skryptu cel --> Po wpisaniu skryptu zostanie wykonany zarówno skrypt, jak i skaner, więc można również dodać opcje skanera, można dodać **"safe=1"** aby wykonać tylko bezpieczne skrypty.

Kontrola czasu

Nmap może zmieniać czas w sekundach, minutach, ms: --host-timeout arguments 900000ms, 900, 900s, and 15m all do the same thing.

Nmap dzieli całkowitą liczbę hostów do zeskanowania na grupy i analizuje te grupy blokami, tak że dopóki wszystkie nie zostaną zanalizowane, nie przechodzi do następnego bloku (i użytkownik nie otrzymuje żadnych aktualizacji, dopóki blok nie zostanie zanalizowany). Dzięki temu Nmap jest bardziej wydajny przy użyciu większych grup. Domyślnie w klasie C używa 256.

Można to zmienić za pomocą **--min-hostgroup** _**\<liczba_hostów>**_**;** **--max-hostgroup** _**\<liczba_hostów>**_ (Dopasuj rozmiary grup skanowania równoległego)

Można kontrolować liczbę skanerów równoległych, ale lepiej tego nie robić (Nmap ma już wbudowaną automatyczną kontrolę na podstawie stanu sieci): **--min-parallelism** _**\<liczba_sond>**_**;** **--max-parallelism** _**\<liczba_sond>**_

Możemy zmienić limit czasu RTT, ale zazwyczaj nie jest to konieczne: **--min-rtt-timeout** _**\<czas>**_**,** **--max-rtt-timeout** _**\<czas>**_**,** **--initial-rtt-timeout** _**\<czas>**_

Możemy zmienić liczbę prób: **--max-retries** _**\<liczba_prób>**_

Możemy zmienić czas skanowania hosta: **--host-timeout** _**\<czas>**_

Możemy zmienić czas między każdym testem, aby działał wolniej: **--scan-delay** _**\<czas>**_**;** **--max-scan-delay** _**\<czas>**_

Możemy zmienić liczbę pakietów na sekundę: **--min-rate** _**\<liczba>**_**;** **--max-rate** _**\<liczba>**_

Wiele portów długo odpowiada, gdy są filtrowane lub zamknięte, jeśli interesują nas tylko otwarte, możemy działać szybciej za pomocą: **--defeat-rst-ratelimit**

Aby określić, jak agresywny ma być Nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> Skanuje tylko 1 port na raz i czeka 5 minut przed kolejnym

\-T1 i T2 --> Bardzo podobne, ale czekają tylko 15 i 0,4 sekundy między każdym testem

\-T3 --> Domyślne działanie, obejmuje równolegle

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

Firewall/IDS

Blokuje porty i analizuje pakiety.

**-f** Fragmentuje pakiety, domyślnie fragmentuje je co 8 bajtów po nagłówku, aby określić ten rozmiar używamy ..mtu (zamiast -f), przesunięcie musi być wielokrotnością 8. **Skanery wersji i skrypty nie obsługują fragmentacji**

**-D decoy1,decoy2,ME** Nmap wysyła skanery, ale z innymi adresami IP jako źródłowymi, w ten sposób ukrywasz się. Jeśli dodasz ME do listy, nmap umieści cię tam, lepiej dodać 5 lub 6 przed tobą, aby całkowicie ukryć swoją tożsamość. Można generować losowe adresy IP za pomocą RND:\<liczba> aby wygenerować \<liczba> losowych adresów IP. Nie działają z wykrywaniem wersji bez połączenia TCP. Jeśli jesteś wewnątrz sieci, warto używać aktywnych adresów IP, w przeciwnym razie łatwo będzie ustalić, że jesteś jedynym aktywnym.

Aby użyć losowych adresów IP: nmap -D RND: 10 Cel\_IP

**-S IP** Gdy Nmap nie wykrywa twojego adresu IP, musisz go podać za pomocą tej opcji. Może również służyć do zmylenia, że inny cel przeprowadza skanowanie.

**-e \<interfejs>** Wybór interfejsu

Wielu administratorów pozostawia otwarte porty wejściowe, aby wszystko działało poprawnie i ł
**--proxies** _**\<Lista oddzielonych przecinkami adresów URL proxy>**_ Aby korzystać z proxy, czasami proxy nie utrzymuje takiej liczby otwartych połączeń, jakiej oczekuje nmap, więc trzeba zmodyfikować równoległość: --max-parallelism

**-sP** Do odkrywania hostów w sieci za pomocą ARP

Wielu administratorów tworzy regułę w firewallu, która pozwala na przepuszczenie wszystkich pakietów pochodzących z określonego portu (np. 20, 53 i 67), możemy powiedzieć nmapowi, aby wysyłał nasze pakiety z tych portów: **nmap --source-port 53 Ip**

**Wyjścia**

**-oN plik** Normalne wyjście

**-oX plik** Wyjście XML

**-oS plik** Wyjście dla script kiddies

**-oG plik** Wyjście w formacie grepable

**-oA plik** Wszystkie oprócz -oS

**-v poziom** poziom szczegółowości

**-d poziom** poziom debugowania

**--reason** Powód hosta i jego stanu

**--stats-every czas** Co jakiś czas informuje nas o postępie

**--packet-trace** Aby zobaczyć, jakie pakiety są wysyłane, można określić filtry, takie jak: --version-trace lub --script-trace

**--open** pokazuje otwarte, otwarte|filtrowane i niefiltrowane

**--resume plik** Generuje podsumowanie

**Różne**

**-6** Włącza ipv6

**-A** To samo co -O -sV -sC --traceroute

**Czas działania**

Podczas działania nmap możemy zmieniać opcje:

v / V Zwiększ / zmniejsz poziom szczegółowości

d / D Zwiększ / zmniejsz poziom debugowania

p / P Włącz / wyłącz śledzenie pakietów

? Wyświetl pomoc dotyczącą interakcji w czasie rzeczywistym

**Vulscan**

Skrypt nmap, który sprawdza wersje usług na podstawie bazy danych offline (pobranej z innych ważnych źródeł) i zwraca potencjalne podatności.

Używane bazy danych to:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Aby go pobrać i zainstalować w folderze Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap\_nse\_vulscan-2.0.tar.gz && tar -czvf nmap\_nse\_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

Należy również pobrać pakiety z baz danych i dodać je do /usr/share/nmap/scripts/vulscan/

Użycie:

Aby użyć wszystkich: sudo nmap -sV --script=vulscan HOST\_DO\_Skanowania

Aby użyć konkretnej bazy danych: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST\_DO\_Skanowania

## Przyspiesz skanowanie usług Nmap x16

Zgodnie z [**tym postem**](https://joshua.hu/nmap-speedup-service-scanning-16x) można przyspieszyć analizę usług nmap, modyfikując wszystkie wartości **`totalwaitms`** w pliku **`/usr/share/nmap/nmap-service-probes`** na **300**, a **`tcpwrappedms`** na **200**.

Ponadto, sondy, które nie mają określonej wartości **`servicewaitms`**, używają domyślnej wartości **`5000`**. Dlatego możemy albo dodać wartości do każdej z sond, albo **skompilować nmap** samodzielnie i zmienić domyślną wartość w [**service\_scan.h**](https://github.com/nmap/nmap/blob/master/service\_scan.h#L79).

Jeśli nie chcesz w ogóle zmieniać wartości **`totalwaitms`** i **`tcpwrappedms`** w pliku `/usr/share/nmap/nmap-service-probes`, możesz zmodyfikować [kod parsowania](https://github.com/nmap/nmap/blob/master/service\_scan.cc#L1358), aby te wartości w pliku `nmap-service-probes` były całkowicie ignorowane.

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
