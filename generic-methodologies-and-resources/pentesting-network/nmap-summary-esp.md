# R√©sum√© de Nmap (ESP)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
```markdown
## Param√®tres

### IPs √† scanner

* **`<ip>,<net/mask>`:** Indiquez les ips directement
* **`-iL <ips_file>`:** list\_IPs
* **`-iR <number>`**: Nombre d'IPs al√©atoires, vous pouvez exclure des Ips possibles avec `--exclude <Ips>` ou `--excludefile <file>`.

### D√©couverte d'√©quipement

Par d√©faut, Nmap lance une phase de d√©couverte consistant en : `-PA80 -PS443 -PE -PP`

* **`-sL`**: Non invasif, il liste les cibles en faisant des requ√™tes **DNS** pour r√©soudre les noms. Utile pour savoir si par exemple www.prueba.es/24 toutes les Ips sont nos cibles.
* **`-Pn`**: **Pas de ping**. Utile si vous savez que tous sont actifs (sinon, vous pourriez perdre beaucoup de temps, mais cette option produit aussi des faux n√©gatifs en disant qu'ils ne sont pas actifs), cela emp√™che la phase de d√©couverte.
* **`-sn`** : **Pas de scan de port**. Apr√®s avoir termin√© la phase de reconnaissance, il ne scanne pas les ports. Relativement discret, et permet un petit scan de r√©seau. Avec des privil√®ges, il envoie un ACK (-PA) √† 80, un SYN(-PS) √† 443 et une demande d'√©cho et une demande de Timestamp, sans privil√®ges, il compl√®te toujours les connexions. Si la cible est le r√©seau, il utilise seulement ARP(-PR). Si utilis√© avec une autre option, seuls les paquets de l'autre option sont supprim√©s.
* **`-PR`**: **Ping ARP**. Utilis√© par d√©faut lors de l'analyse d'ordinateurs dans notre r√©seau, c'est plus rapide que d'utiliser des pings. Si vous ne voulez pas utiliser de paquets ARP, utilisez `--send-ip`.
* **`-PS <ports>`**: Il envoie des paquets SYN auxquels s'il r√©pond SYN/ACK, il est ouvert (auquel il r√©pond avec RST pour ne pas terminer la connexion), s'il r√©pond RST, il est ferm√© et s'il ne r√©pond pas, il est injoignable. En cas de non privil√®ges, une connexion totale est automatiquement utilis√©e. Si aucun port n'est donn√©, il les envoie √† 80.
* **`-PA <ports>`**: Comme le pr√©c√©dent mais avec ACK, combiner les deux donne de meilleurs r√©sultats.
* **`-PU <ports>`**: L'objectif est l'oppos√©, ils sont envoy√©s √† des ports qui sont cens√©s √™tre ferm√©s. Certains pare-feu ne v√©rifient que les connexions TCP. S'il est ferm√©, il est r√©pondu avec port unreachable, s'il est r√©pondu avec un autre icmp ou pas r√©pondu, il est laiss√© comme destination unreachable.
* **`-PE, -PP, -PM`** : ICMP PINGS : echo replay, timestamp et addresmask. Lanc√©s pour savoir si la cible est active.
* **`-PY<ports>`**: Envoie des sondes SCTP INIT √† 80 par d√©faut, INIT-ACK(ouvert) ou ABORT(ferm√©) ou rien ou ICMP unreachable(inactif) peut √™tre r√©pondu.
* **`-PO <protocols>`**: Un protocole est indiqu√© dans les en-t√™tes, par d√©faut 1(ICMP), 2(IGMP) et 4(Encap IP). Pour les protocoles ICMP, IGMP, TCP (6) et UDP (17), les en-t√™tes de protocole sont envoy√©s, pour les autres, seul l'en-t√™te IP est envoy√©. Le but est que, en raison de la malformation des en-t√™tes, Protocol unreachable ou des r√©ponses du m√™me protocole sont r√©pondues pour savoir s'il est actif.
* **`-n`**: Pas de DNS
* **`-R`**: DNS toujours

### Techniques de scan de ports

* **`-sS`**: Ne compl√®te pas la connexion donc ne laisse pas de trace, tr√®s bon si cela peut √™tre utilis√©. (privil√®ges) C'est celui utilis√© par d√©faut.
* **`-sT`**: Compl√®te la connexion, donc laisse une trace, mais peut √™tre utilis√© avec certitude. Par d√©faut sans privil√®ges.
* **`-sU`**: Plus lent, pour UDP. Principalement : DNS(53), SNMP(161,162), DHCP(67 et 68), (-sU53,161,162,67,68) : ouvert(r√©ponse), ferm√©(port unreachable), filtr√© (un autre ICMP), ouvert/filtr√© (rien). En cas d'ouvert/filtr√©, -sV envoie de nombreuses demandes pour d√©tecter l'une des versions que nmap prend en charge et peut d√©tecter l'√©tat r√©el. Cela augmente beaucoup le temps.
* **`-sY`**: Le protocole SCTP √©choue √† √©tablir la connexion, donc il n'y a pas de logs, fonctionne comme -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, ils peuvent p√©n√©trer certains pare-feu et extraire des informations. Ils sont bas√©s sur le fait que les machines conformes aux normes devraient r√©pondre avec RST toutes les demandes qui n'ont pas de drapeaux SYN, RST ou ACK lev√©s : ouvert/filtr√©(rien), ferm√©(RST), filtr√© (ICMP unreachable). Non fiable sur Windows, Cisco, BSDI et OS/400. Sur unix oui.
* **`-sM`**: Scan Maimon : Envoie des drapeaux FIN et ACK, utilis√© pour BSD, actuellement renverra tout comme ferm√©.
* **`-sA, sW`**: ACK et Window, est utilis√© pour d√©tecter les pare-feu, pour savoir si les ports sont filtr√©s ou non. Le -sW distingue entre ouvert/ferm√© puisque les ouverts r√©pondent avec une valeur de fen√™tre diff√©rente : ouvert (RST avec fen√™tre autre que 0), ferm√© (RST fen√™tre = 0), filtr√© (ICMP unreachable ou rien). Tous les ordinateurs ne fonctionnent pas de cette mani√®re, donc si tout est ferm√©, cela ne fonctionne pas, si quelques-uns sont ouverts, cela fonctionne bien, et si beaucoup sont ouverts et peu ferm√©s, cela fonctionne √† l'envers.
* **`-sI`:** Idle scan. Pour les cas o√π il y a un pare-feu actif mais nous savons qu'il ne filtre pas vers une certaine Ip (ou lorsque nous voulons simplement l'anonymat), nous pouvons utiliser le scanner zombie (il fonctionne pour tous les ports), pour chercher des zombies possibles, nous pouvons utiliser le script ipidseq ou l'exploit auxiliary/scanner/ip/ipidseq. Ce scanner est bas√© sur le num√©ro IPID des paquets IP.
* **`--badsum`:** Il envoie la somme incorrecte, les ordinateurs devraient rejeter les paquets, mais les pare-feu pourraient r√©pondre √† quelque chose, il est utilis√© pour d√©tecter les pare-feu.
* **`-sZ`:** Scanner SCTP "√©trange", lors de l'envoi de sondes avec des fragments d'√©cho de cookie, ils devraient √™tre abandonn√©s si ouverts ou r√©pondus avec ABORT si ferm√©s. Il peut passer √† travers des pare-feu que init ne traverse pas, le mauvais est qu'il ne distingue pas entre filtr√© et ouvert.
* **`-sO`:** Scan de protocole Ip. Envoie des en-t√™tes mauvais et vides dans lesquels parfois m√™me le protocole ne peut pas √™tre distingu√©. Si ICMP unreachable protocol arrive, il est ferm√©, si port unreachable arrive, il est ouvert, si une autre erreur arrive, filtr√©, si rien n'arrive, ouvert|filtr√©.
* **`-b <server>`:** FTPhost--> Utilis√© pour scanner un h√¥te depuis un autre, cela se fait en se connectant au ftp d'une autre machine et en lui demandant d'envoyer des fichiers aux ports que vous voulez scanner depuis une autre machine, selon les r√©ponses, nous saurons s'ils sont ouverts ou non. \[\<user>:\<password>@]\<server>\[:\<port>] Presque tous les serveurs ftp ne vous laissent plus faire cela et donc c'est de peu d'utilit√© pratique.

### **Centrer l'analyse**

**-p:** Sert √† donner les ports √† scanner. Pour s√©lectionner les 65335 : **-p-** ou **-p all**. Nmap a une classification interne selon leur popularit√©. Par d√©faut, il utilise les 1000 principaux. Avec **-F** (scan rapide), il analyse les 100 principaux. Avec **--top-ports \<numero>** Analyse ce nombre de principaux (de 1 √† 65335). V√©rifie les ports dans un ordre al√©atoire, pour que cela ne se produise pas **-r**. Nous pouvons √©galement s√©lectionner des ports : 20-30,80,443,1024- Cela signifie qu'il regarde au-del√† du 1024. Nous pouvons √©galement regrouper les ports par protocoles : U:53,T:21-25,80,139,S:9. Nous pouvons √©galement choisir une plage dans les ports populaires de nmap : -p \[-1024] analyse jusqu'au 1024 inclus dans nmap-services. **--port-ratio \<ratio>** Analyse les ports les plus communs qu'un ratio qui doit √™tre entre 0 et 1

**-sV** Scan de version, l'intensit√© peut √™tre r√©gl√©e de 0 √† 9, par d√©faut 7.

**--version-intensity \<numero>** Nous r√©glons l'intensit√©, de sorte que plus elle est basse, seules les sondes les plus probables seront lanc√©es, mais pas toutes. Avec cela, nous pouvons consid√©rablement r√©duire le temps de scan UDP

**-O** D√©tection d'os

**--osscan-limit** Pour bien scanner un h√¥te, il faut qu'il y ait au moins 1 port ouvert et un autre ferm√©, si cette condition n'est pas remplie et que nous avons mis cela, il n'essaie pas de faire de pr√©diction d'os (√©conomise du temps)

**--osscan-guess** Quand la d√©tection d'os n'est pas parfaite, cela fait qu'il s'efforce plus

**Scripts**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

Pour utiliser ceux par d√©faut, il suffit de -sC ou --script=default

Les types disponibles sont : auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, et vuln

* **Auth:** ex√©cute tous ses _scripts_ disponibles pour l'authentification
* **Default:** ex√©cute les _scripts_ de base par d√©faut de l'outil
* **Discovery:** r√©cup√®re des informations sur la _cible_ ou la victime
* **External:** _script_ pour utiliser des ressources externes
* **Intrusive:** utilise des _scripts_ consid√©r√©s comme intrusifs pour la victime ou la _cible_
* **Malware:** v√©rifie s'il y a des connexions ouvertes par des codes malveillants ou des _backdoors_ (portes d√©rob√©es)
* **Safe:** ex√©cute des _scripts_ qui ne sont pas intrusifs
* **Vuln:** d√©couvre les vuln√©rabilit√©s les plus connues
* **All:** ex√©cute absolument tous les _scripts_ avec extension NSE disponibles

Pour rechercher des scripts :

**nmap --script-help="http-\*" -> Ceux qui commencent par http-**

**nmap --script-help="not intrusive" -> Tous sauf ceux-l√†**

**nmap --script-help="default or safe" -> Ceux qui sont dans l'un ou l'autre ou les deux**

**nmap --script-help="default and safe" --> Ceux qui sont dans les deux**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> Donne des infos sur le d√©roulement du script

\--script-updatedb

**Pour utiliser un script, il suffit de mettre : nmap --script Nom\_du\_script cible** --> En mettant le script, il ex√©cutera √† la fois le script et le scanner, donc vous pouvez √©galement mettre des options de scanner, nous pouvons ajouter **‚Äúsafe=1‚Äù** pour que seuls ceux qui sont s√ªrs soient ex√©cut√©s.

**Contr√¥le du temps**

**Nmap peut modifier le temps en secondes, minutes, ms :** --host-timeout arguments 900000ms, 900, 900s, et 15m font tous la m√™me chose.

Nmap divise le nombre total d'h√¥tes √† scanner en groupes et analyse ces groupes en blocs de sorte que jusqu'√† ce que tous aient √©t√© analys√©s, il ne passe pas au bloc suivant (et l'utilisateur ne re√ßoit aucune mise √† jour jusqu'√† ce que le bloc ait √©t√© analys√©) de cette fa√ßon, il est plus optimal pour nmap d'utiliser de grands groupes. Par d√©faut en classe C, il utilise 256.

On peut le changer avec **--min-hostgroup** _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ (Ajuster les tailles des groupes de scan parall√®les)

On peut contr√¥ler le nombre de scanners en parall√®le mais il vaut mieux ne pas le faire (nmap int√®gre d√©j√† un contr√¥le automatique en fonction de l'√©tat du r√©seau) : **--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

Nous pouvons modifier le rtt timeout, mais ce n'est g√©n√©ralement pas n√©cessaire : **--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

Nous pouvons modifier le nombre de tentatives : **--max-retries** _**\<numtries>**_

Nous pouvons modifier le temps de scan d'un h√¥te : **--host-timeout** _**\<time>**_

Nous pouvons modifier le temps entre chaque test pour qu'il aille lentement : **--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**_

Nous pouvons modifier le nombre de paquets par seconde : **--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

Beaucoup de ports mettent du temps √† r√©pondre car ils sont filtr√©s ou ferm√©s, si seuls les ouverts nous int√©ressent, nous pouvons aller plus vite avec : **--defeat-rst-ratelimit**

Pour d√©finir l'agressivit√© avec laquelle nous voulons que nmap agisse : -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> Seulement 1 port est scann√© √† la fois et on attend 5min jusqu'au suivant

\-T1 et T2 --> Tr√®s similaires mais n'attendent que 15 et 0,4sec respectivement entre chaque test

\-T3 --> Fonctionnement par d√©faut, inclut en parall√®le

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Pare-feu/IDS**

Ils ne laissent pas passer aux ports et analysent les paquets.

**-f** Pour fragmenter les paquets, par d√©faut il les fragmente en 8 octets apr√®s l'en-t√™te, pour sp√©cifier cette taille nous utilisons ..mtu (avec cela, ne pas utiliser -f), le d√©calage doit √™tre un multiple de 8. **Les scanners de version et les scripts ne supportent pas la fragmentation**

**-D decoy1,decoy2,ME** Nmap envoie des scanners mais avec d'autres adresses IP comme origine, de cette fa√ßon ils vous cachent. Si vous mettez le ME dans la liste, nmap vous placera l√†, mieux vaut mettre 5 ou 6 avant vous pour que vous soyez compl√®tement masqu√©. Des IPs al√©atoires peuvent √™tre g√©n√©r√©es avec RND:\<nombre> Pour g√©n√©rer \<nombre> d'IPs al√©atoires. Ne fonctionne pas avec le d√©tecteur de versions sans connexion TCP. Si vous √™tes √† l'int√©rieur d'un r√©seau, vous √™tes int√©ress√© √† utiliser des IPs qui sont actives, sinon il sera tr√®s facile de d√©couvrir que vous √™tes le seul actif.

Pour utiliser des IPs al√©atoires : nmap-D R
