# Resumo do Nmap (ESP)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Par√¢metros

### IPs a serem escaneados

* **`<ip>,<net/mask>`:** Indica os IPs diretamente
* **`-iL <ips_file>`:** lista_IPs
* **`-iR <number>`**: N√∫mero de IPs aleat√≥rios, √© poss√≠vel excluir IPs poss√≠veis com `--exclude <Ips>` ou `--excludefile <file>`.

### Descoberta de equipamentos

Por padr√£o, o Nmap inicia uma fase de descoberta consistindo em: `-PA80 -PS443 -PE -PP`

* **`-sL`**: N√£o invasivo, lista os alvos fazendo solicita√ß√µes **DNS** para resolver nomes. √â √∫til para saber, por exemplo, se todos os IPs de www.prueba.es/24 s√£o nossos alvos.
* **`-Pn`**: **Sem ping**. √ötil se voc√™ souber que todos est√£o ativos (caso contr√°rio, poderia perder muito tempo, mas essa op√ß√£o tamb√©m produz falsos negativos dizendo que n√£o est√£o ativos), evita a fase de descoberta.
* **`-sn`** : **Sem varredura de portas**. Ap√≥s completar a fase de reconhecimento, n√£o varre portas. √â relativamente furtivo e permite uma pequena varredura de rede. Com privil√©gios, envia um ACK (-PA) para 80, um SYN(-PS) para 443 e uma solicita√ß√£o de eco e uma solicita√ß√£o de timestamp, sem privil√©gios sempre completa conex√µes. Se o alvo for a rede, ele usa apenas ARP(-PR). Se usado com outra op√ß√£o, apenas os pacotes da outra op√ß√£o s√£o descartados.
* **`-PR`**: **Ping ARP**. Usado por padr√£o ao analisar computadores em nossa rede, √© mais r√°pido do que usar pings. Se n√£o quiser usar pacotes ARP, use `--send-ip`.
* **`-PS <ports>`**: Envia pacotes SYN para os quais, se responder SYN/ACK, est√° aberto (responde com RST para n√£o encerrar a conex√£o), se responder RST est√° fechado e se n√£o responder est√° inacess√≠vel. Caso n√£o tenha privil√©gios, uma conex√£o total √© usada automaticamente. Se nenhum porto for fornecido, ele envia para 80.
* **`-PA <ports>`**: Como o anterior, mas com ACK, combinando ambos d√° melhores resultados.
* **`-PU <ports>`**: O objetivo √© o oposto, s√£o enviados para portas que se espera estarem fechadas. Alguns firewalls verificam apenas conex√µes TCP. Se estiver fechado, √© respondido com porta inalcan√ß√°vel, se for respondido com outro icmp ou n√£o for respondido, √© considerado inalcan√ß√°vel.
* **`-PE, -PP, -PM`** : PINGS ICMP: resposta de eco, timestamp e m√°scara de endere√ßo. S√£o enviados para descobrir se o alvo est√° ativo.
* **`-PY<ports>`**: Envia sondas SCTP INIT para 80 por padr√£o, INIT-ACK(aberto) ou ABORT(fechado) ou nada ou ICMP inalcan√ß√°vel(inativo) podem ser respondidos.
* **`-PO <protocols>`**: Um protocolo √© indicado nos cabe√ßalhos, por padr√£o 1(ICMP), 2(IGMP) e 4(Encap IP). Para ICMP, IGMP, TCP (6) e UDP (17) s√£o enviados os cabe√ßalhos do protocolo, para o restante apenas o cabe√ßalho IP √© enviado. O objetivo disso √© que, devido √† m√° forma√ß√£o dos cabe√ßalhos, Protocolo inalcan√ß√°vel ou respostas do mesmo protocolo s√£o respondidas para saber se est√° ativo.
* **`-n`**: Sem DNS
* **`-R`**: Sempre DNS

### T√©cnicas de varredura de portas

* **`-sS`**: N√£o completa a conex√£o, portanto n√£o deixa rastros, muito bom se puder ser usado (privil√©gios). √â o usado por padr√£o.
* **`-sT`**: Completa a conex√£o, portanto deixa rastros, mas pode ser usado com certeza. Por padr√£o sem privil√©gios.
* **`-sU`**: Mais lento, para UDP. Principalmente: DNS(53), SNMP(161,162), DHCP(67 e 68), (-sU53,161,162,67,68): aberto(resposta), fechado(porta inalcan√ß√°vel), filtrado (outro ICMP), aberto/filtrado (nada). Em caso de aberto/filtrado, -sV envia numerosas solicita√ß√µes para detectar qualquer uma das vers√µes que o nmap suporta e pode detectar o verdadeiro estado. Aumenta muito o tempo.
* **`-sY`**: O protocolo SCTP falha em estabelecer a conex√£o, portanto n√£o h√° logs, funciona como -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, podem penetrar em alguns firewalls e extrair informa√ß√µes. Baseiam-se no fato de que m√°quinas compat√≠veis com padr√µes devem responder com RST a todas as solicita√ß√µes que n√£o possuem flags SYN, RST ou ACK levantados: aberto/filtrado(nada), fechado(RST), filtrado (ICMP inalcan√ß√°vel). N√£o confi√°vel no Windows, CIsco, BSDI e OS/400. No Unix sim.
* **`-sM`**: Varredura Maimon: Envia flags FIN e ACK, usada para BSD, atualmente retornar√° todos como fechados.
* **`-sA, sW`**: ACK e Window, √© usado para detectar firewalls, para saber se as portas est√£o filtradas ou n√£o. O -sW distingue entre aberto/fechado, j√° que os abertos respondem com um valor de janela diferente: aberto (RST com janela diferente de 0), fechado (RST janela = 0), filtrado (ICMP inalcan√ß√°vel ou nada). Nem todos os computadores funcionam dessa maneira, ent√£o se estiverem todos fechados, n√£o est√° funcionando, se alguns estiverem abertos, est√° funcionando bem, e se muitos estiverem abertos e poucos fechados, est√° funcionando ao contr√°rio.
* **`-sI`:** Varredura ociosa. Para os casos em que h√° um firewall ativo, mas sabemos que n√£o filtra para um determinado IP (ou quando simplesmente queremos anonimato), podemos usar o scanner zumbi (funciona para todas as portas), para procurar poss√≠veis zumbis podemos usar o script ipidseq ou o exploit auxiliary/scanner/ip/ipidseq. Este scanner √© baseado no n√∫mero IPID dos pacotes IP.
* **`--badsum`:** Envia a soma errada, os computadores descartariam os pacotes, mas os firewalls poderiam responder algo, √© usado para detectar firewalls.
* **`-sZ`:** Scanner SCTP "estranho", ao enviar sondas com fragmentos de eco de cookie, eles devem ser descartados se estiverem abertos ou respondidos com ABORT se estiverem fechados. Pode passar por firewalls que o init n√£o passa, o ruim √© que n√£o distingue entre filtrado e aberto.
* **`-sO`:** Varredura de protocolo Ip. Envia cabe√ßalhos ruins e vazios nos quais √†s vezes nem mesmo o protocolo pode ser distinguido. Se chegar um protocolo ICMP inalcan√ß√°vel √© fechado, se chegar uma porta inalcan√ß√°vel √© aberto, se chegar outro erro, filtrado, se n√£o chegar nada, aberto|filtrado.
* **`-b <server>`:** FTPhost--> √â usado para escanear um host de outro, isso √© feito conectando o ftp de outra m√°quina e pedindo para enviar arquivos para as portas que deseja escanear de outra m√°quina, de acordo com as respostas saberemos se est√£o abertas ou n√£o. \[\<user>:\<password>@]\<server>\[:\<port>] A maioria dos servidores ftp n√£o permite mais isso e, portanto, tem pouco uso pr√°tico.

### **An√°lise centralizada**

**-p:** Serve para fornecer as portas a serem escaneadas. Para selecionar as 65335: **-p-** ou **-p all**. O Nmap tem uma classifica√ß√£o interna de acordo com sua popularidade. Por padr√£o, usa as 1000 principais. Com **-F** (varredura r√°pida) analisa as 100 principais. Com **--top-ports \<numero>** Analisa esse n√∫mero de principais (de 1 a 65335). Verifica as portas em ordem aleat√≥ria, para evitar isso **-r**. Tamb√©m podemos selecionar portas: 20-30,80,443,1024- Isso √∫ltimo significa que olhe para frente do 1024. Tamb√©m podemos agrupar as portas por protocolos: U:53,T:21-25,80,139,S:9. Tamb√©m podemos escolher um intervalo dentro das portas populares do nmap: -p \[-1024] analisa at√© o 1024 dos inclu√≠dos em nmap-services. **--port-ratio \<ratio>** Analisa as portas mais comuns que um ratio que deve estar entre 0 e 1

**-sV** Varredura de vers√£o, a intensidade pode ser ajustada de 0 a 9, por padr√£o 7.

**--version-intensity \<numero>** Regula a intensidade, de modo que quanto mais baixa, apenas lan√ßar√° as sondas mais prov√°veis, mas n√£o todas. Com isso, podemos encurtar consideravelmente o tempo de varredura UDP

**-O** Detec√ß√£o de SO

**--osscan-limit** Para escanear bem um host, √© necess√°rio que pelo menos uma porta esteja aberta e outra fechada, se essa condi√ß√£o n√£o for atendida e tivermos isso, n√£o tenta prever o SO (economiza tempo)

**--osscan-guess** Quando a detec√ß√£o de SO n√£o √© perfeita, isso faz com que se esforce mais

**Scripts**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

Para usar os padr√£o, basta usar -sC ou --script=default

Os tipos dispon√≠veis s√£o: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version e vuln

* **Auth:** executa todos os _scripts_ dispon√≠veis para autentica√ß√£o
* **Default:** executa os _scripts_ b√°sicos padr√£o da ferramenta
* **Discovery:** recupera informa√ß√µes do _target_ ou v√≠tima
* **External:** _script_ para usar recursos externos
* **Intrusive:** usa _scripts_ considerados intrusivos para a v√≠tima ou _target_
* **Malware:** verifica se h√° conex√µes abertas por c√≥digos maliciosos ou _backdoors_
* **Safe:** executa _scripts_ que n√£o s√£o intrusivos
* **Vuln:** descobre as vulnerabilidades mais conhecidas
* **All:** executa todos os _scripts_ com extens√£o NSE dispon√≠veis

Para buscar scripts:

**nmap --script-help="http-\*" -> Os que come√ßam com http-**

**nmap --script-help="not intrusive" -> Todos exceto esses**

**nmap --script-help="default or safe" -> Os que est√£o em um ou em outro ou em ambos**

**nmap --script-help="default and safe" --> Os que est√£o em ambos**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> Fornece informa√ß√µes sobre como o script est√° funcionando

\--script-updatedb

**Para usar um script, basta digitar: namp --script Nome_do_script alvo** --> Ao inserir o script, tanto o script quanto o scanner ser√£o executados, portanto, tamb√©m √© poss√≠vel adicionar **‚Äúsafe=1‚Äù** para executar apenas os seguros.

**Controle de tempo**

**O Nmap pode modificar o tempo em segundos, minutos, ms:** --host-timeout arguments 900000ms, 900, 900s e 15m fazem a mesma coisa.

O Nmap divide o n√∫mero total de hosts a serem escaneados em grupos e analisa esses grupos em blocos, de modo que at√© que todos tenham sido analisados, n√£o passa para o pr√≥ximo bloco (e o usu√°rio tamb√©m n√£o recebe nenhuma atualiza√ß√£o at√© que o bloco tenha sido analisado), dessa forma, √© mais eficiente para o Nmap usar grupos grandes. Por padr√£o, em classe C usa 256.

Pode ser alterado com\*\*--min-hostgroup\*\* _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ (Ajustar tamanhos de grupo de varredura paralela)

√â poss√≠vel controlar o n√∫mero de scanners em paralelo, mas √© melhor n√£o fazer (o nmap j√° incorpora controle autom√°tico com base no estado da rede): **--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

Podemos modificar o tempo limite rtt, mas geralmente n√£o √© necess√°rio: **--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

Podemos modificar o n√∫mero de tentativas:**--max-retries** _**\<numtries>**_

Podemos modificar o tempo de varredura de um host: **--host-timeout** _**\<time>**

Podemos modificar o tempo entre cada varredura para torn√°-lo mais lento: **--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**

Podemos modificar o n√∫mero de pacotes por segundo: **--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

Muitas portas demoram a responder por estarem filtradas ou fechadas, se apenas as abertas nos interessam, podemos acelerar com: **--defeat-rst-ratelimit**

Para definir o qu√£o agressivo queremos que o nmap seja: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> Apenas uma porta √© varrida de cada vez e aguarda 5min at√© a pr√≥xima

\-T1 e T2 --> Muito semelhantes, mas aguardam apenas 15 e 0,4seg, respectivamente, entre cada varredura

\-T3 --> Funcionamento padr√£o, inclui em paralelo

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Impedem a passagem de portas e analisam pacotes.

**-f** Para fragmentar pacotes, por padr√£o os fragmenta em 8bytes ap√≥s o cabe√ßalho, para especificar esse tamanho usamos ..mtu (com isso, n√£o usar -f), o deslocamento deve ser m√∫ltiplo de 8. **Varreduras de servi√ßo e scripts n√£o suportam fragmenta√ß√£o**

**-D decoy1,decoy2,ME** O Nmap envia varreduras, mas com outros IPs como origem, assim voc√™ se esconde. Se colocar o ME na lista, o Nmap te colocar√° l√°, √© melhor colocar 5 ou 6 antes de voc√™ para se camuflar completamente. IPs aleat√≥rios podem ser gerados com RND:\<numero> Para gerar \<numero> de IPs aleat√≥rios. N√£o funcionam com detec√ß√£o de vers√µes sem conex√£o TCP. Se estiver dentro de uma rede, √© interessante usar IPs que estejam ativos, caso contr√°rio ser√° muito f√°cil descobrir que voc√™ √© o √∫nico ativo.

Para usar IPs aleat√≥rios: nmap-D RND: 10 Ip_objetivo

**-S IP** Quando o Nmap n√£o detecta seu endere√ßo IP, voc√™ precisa fornec√™-lo com isso. Tamb√©m serve para fazer parecer que h√° outro alvo os escaneando.

**-e \<interface>** Para escolher a interface

Muitos administradores deixam portas de entrada abertas para que tudo funcione corretamente e seja mais f√°cil do que procurar outra solu√ß√£o. Essas podem ser as portas DNS ou as de FTP... para buscar essa vulnerabilidade, o nmap incorpora: **--source-port** _**\<portnumber>**_**;-g** _**\<portnumber>**_ _S√£o equivalentes_

**--data** _**\<hex string>**_ Para enviar texto hexadecimal: --data 0xdeadbeef e --data \xCA\xFE\x09

**--
