# Nmap总结 (ESP)

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## 参数

### 要扫描的IP

* **`<ip>,<net/mask>`:** 直接指定ip
* **`-iL <ips_file>`:** list\_IPs
* **`-iR <number>`**: 随机Ip数量，可以用 `--exclude <Ips>` 或 `--excludefile <file>` 排除特定Ip。

### 设备发现

默认情况下，Nmap启动一个由 `-PA80 -PS443 -PE -PP` 组成的发现阶段

* **`-sL`**: 非侵入式，列出目标并发起**DNS**请求解析名称。如果想知道例如 www.prueba.es/24 是否所有Ip都是我们的目标，这很有用。
* **`-Pn`**: **不ping**。如果你知道它们都是活动的（否则可能会浪费很多时间，但这个选项也会产生假阴性，即显示它们不活动），这很有用，它会阻止发现阶段。
* **`-sn`** : **不扫描端口**。完成侦察阶段后，不扫描端口。相对隐蔽，允许小范围网络扫描。有权限时发送ACK (-PA)到80，SYN(-PS)到443，回声请求和时间戳请求，无权限时总是完成连接。如果目标是网络，只使用ARP(-PR)。如果与其他选项一起使用，只有其他选项的数据包会被丢弃。
* **`-PR`**: **ARP Ping**。在分析我们网络中的计算机时默认使用，比使用ping快。如果不想使用ARP数据包，请使用 `--send-ip`。
* **`-PS <ports>`**: 发送SYN数据包，如果回复SYN/ACK则为开放（回复RST以避免结束连接），如果回复RST则为关闭，如果没有回复则为不可达。如果没有权限，会自动使用完整连接。如果没有给出端口，默认向80端口发送。
* **`-PA <ports>`**: 与前者类似，但使用ACK，两者结合使用效果更好。
* **`-PU <ports>`**: 目标相反，发送到预期关闭的端口。一些防火墙只检查TCP连接。如果关闭，则回复端口不可达，如果回复其他icmp或不回复，则标记为目的地不可达。
* **`-PE, -PP, -PM`** : ICMP PINGS：回声回复，时间戳和地址掩码。它们被用来确定目标是否活动。
* **`-PY<ports>`**: 默认向80端口发送SCTP INIT探测，可能回复INIT-ACK（开放）或ABORT（关闭）或无回复或ICMP不可达（不活动）。
* **`-PO <protocols>`**: 在头部指定协议，默认为1(ICMP)，2(IGMP)和4(Encap IP)。对于ICMP、IGMP、TCP (6)和UDP (17)协议，发送协议头部，对于其他协议，只发送IP头部。目的是由于头部畸形，协议不可达或相同协议的回复可以用来判断是否在线。
* **`-n`**: 不使用DNS
* **`-R`**: 总是使用DNS

### 端口扫描技术

* **`-sS`**: 不完成连接，因此不留痕迹，如果可以使用的话非常好。（需要权限）默认使用。
* **`-sT`**: 完成连接，因此会留下痕迹，但可以肯定使用。默认无权限时使用。
* **`-sU`**: 较慢，用于UDP。主要是：DNS(53)，SNMP(161,162)，DHCP(67和68)，(-sU53,161,162,67,68)：开放（回复），关闭（端口不可达），过滤（其他ICMP），开放/过滤（无回复）。在开放/过滤的情况下，-sV会发送大量请求以检测nmap支持的任何版本，并可以检测真实状态。这会大大增加时间。
* **`-sY`**: SCTP协议未能建立连接，因此没有日志，工作方式类似于-PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas，它们可以穿透一些防火墙并提取信息。它们基于这样一个事实：符合标准的机器应该对所有没有提升SYN、RST或ACK标志的请求回复RST：开放/过滤（无回复），关闭（RST），过滤（ICMP不可达）。在Windows、CIsco、BSDI和OS/400上不可靠。在unix上可以。
* **`-sM`**: Maimon扫描：发送FIN和ACK标志，用于BSD，目前会返回所有端口都关闭。
* **`-sA, sW`**: ACK和Window，用于检测防火墙，了解端口是否被过滤。-sW可以区分开放/关闭，因为开放的会以不同的窗口值回复：开放（RST窗口非0），关闭（RST窗口=0），过滤（ICMP不可达或无回复）。并非所有计算机都是这样工作的，所以如果全部关闭，则不工作，如果有少数开放，则工作正常，如果有很多开放和少数关闭，则工作相反。
* **`-sI`:** 空闲扫描。在有活动防火墙但我们知道它不会过滤某个Ip（或者当我们想要匿名时）的情况下，我们可以使用僵尸扫描器（适用于所有端口），寻找可能的僵尸可以使用脚本ipidseq或利用auxiliary/scanner/ip/ipidseq。这个扫描器基于IP数据包的IPID号。
* **`--badsum`:** 发送错误的和校验，计算机会丢弃数据包，但防火墙可能会回复一些东西，用于检测防火墙。
* **`-sZ`:** "奇怪"的SCTP扫描器，发送带有cookie echo片段的探测，如果开放应该被丢弃或者如果关闭则回复ABORT。它可以穿过init无法穿过的防火墙，坏处是它无法区分过滤和开放。
* **`-sO`:** Ip协议扫描。发送错误和空的头部，有时甚至无法区分协议。如果收到ICMP不可达协议，则关闭，如果收到不可达端口，则开放，如果收到其他错误，则过滤，如果没有收到，则开放|过滤。
* **`-b <server>`:** FTPhost--> 用于通过另一台机器扫描主机，通过连接另一台机器的ftp并要求它向你想要扫描的端口发送文件，根据回复我们将知道它们是否开放。 \[\<user>:\<password>@]\<server>\[:\<port>] 几乎所有的ftp服务器都不再允许这样做，因此实际用途不大。

### **集中分析**

**-p:** 用于指定要扫描的端口。要选择65335个：**-p-** 或 **-p all**。Nmap根据其流行度进行内部分类。默认使用前1000个。使用 **-F**（快速扫描）分析前100个。使用 **--top-ports \<numero>** 分析该数量的主要端口（从1到65335）。检查端口的顺序是随机的，为了避免这种情况使用 **-r**。我们也可以选择端口：20-30,80,443,1024- 这最后意味着查看1024之后的端口。我们还可以按协议对端口进行分组：U:53,T:21-25,80,139,S:9。我们还可以在nmap-services中选择nmap流行端口的范围：-p \[-1024] 分析nmap-services中包含的端口直到1024。**--port-ratio \<ratio>** 分析比率最常见的端口，比率必须在0到1之间

**-sV** 版本扫描，可以调整强度从0到9，默认为7。

**--version-intensity \<numero>** 我们调整强度，这样越低只会发起最可能的探测，但不是全部。这样我们可以大大缩短UDP扫描时间

**-O** 操作系统检测

**--osscan-limit** 为了好好扫描一个主机，需要至少有一个端口开放和一个关闭，如果不满足这个条件并且我们设置了这个，它不会尝试做操作系统预测（节省时间）

**--osscan-guess** 当操作系统检测不完美时，这会使它更加努力

**脚本**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

使用默认脚本只需 -sC 或 --script=default

类型包括：auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, 和 vuln

* **Auth:** 执行所有可用的认证脚本
* **Default:** 执行工具默认的基本脚本
* **Discovery:** 检索目标或受害者的信息
* **External:** 使用外部资源的脚本
* **Intrusive:** 使用被认为对受害者或目标具有侵入性的脚本
* **Malware:** 检查是否有由恶意代码或后门打开的连接
* **Safe:** 执行非侵入性脚本
* **Vuln:** 发现最知名的漏洞
* **All:** 执行所有可用的NSE扩展脚本

搜索脚本：

**nmap --script-help="http-\*" -> 以http-开头的**

**nmap --script-help="not intrusive" -> 除了这些之外的所有**

**nmap --script-help="default or safe" -> 在一个或两个或两者中的**

**nmap --script-help="default and safe" --> 在两者中的**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> 提供脚本运行信息

\--script-updatedb

**要使用单个脚本，只需输入：namp --script 脚本名称 目标** --> 输入脚本时，将同时执行脚本和扫描器，因此也可以输入扫描器选项，我们可以添加 **“safe=1”** 以便只执行安全的脚本。

**时间控制**

**Nmap可以以秒、分钟、毫秒修改时间：** --host-timeout arguments 900000ms, 900, 900s, 和 15m 都是一样的。

Nmap将要扫描的主机总数分成组，并按块分析这些组，这样直到所有块都被分析完毕，才会进行下一个块（用户也不会收到任何更新，直到块被分析完毕），因此，对于Nmap来说，使用大组更优。默认在C类网络中使用256。

可以用\*\*--min-hostgroup\*\* _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ 改变（调整并行扫描组大小）

可以控制并行扫描器的数量，但最好不要（nmap已经根据网络状态自动控制）：**--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

我们可以修改rtt超时，但通常不需要：**--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

我们可以修改尝试次数：**--max-retries** _**\<numtries>**_

我们可以修改扫描一个主机的时间：**--host-timeout** _**\<time>**_

我们可以修改每次测试之间的时间，以便慢速进行：**--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**_

我们可以修改每秒的数据包数量：**--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

许多端口响应慢是因为被过滤或关闭，如果我们只对开放的感兴趣，我们可以更快地进行：**--defeat-rst-ratelimit**

为了定义我们希望nmap有多激进：-T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> 一次只扫描1个端口，并等待5分钟直到下一个

\-T1 和 T2 --> 非常相似，但只分别等待15秒和0.4秒

\-T3 --> 默认操作，包括并行

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**防火墙/IDS**

不允许通过端口并分析数据包。

**-f** 用于分段数据包，默认在头部之后将数据包分成8字节，要指定该大小使用..mtu（这样做时不要使用-f），偏移量必须是8的倍数。**版本扫描器和脚本不支持分段**

**-D decoy1,decoy2,ME** Nmap发送扫描，但使用其他IP地址作为源，这样可以隐藏你。如果在列表中放入ME，nmap会将你放在那里，最好在你之前放5或6个，以完全掩盖你。可以使用RND:\<number> 生成 \<number> 个随机IP。不适用于没有TCP连接的版本检测器。如果你在一个网络内，你会希望使用活动的IP，否则很容易发现你是唯一活动的。

使用随机IP：nmap-D RND: 10 Ip\_目标

**-S IP** 当Nmap没有捕获到你的IP地址时，你需要用这个给它。也可以用来让别人以为有其他目标在扫描它们。

**-e \<interface>** 选择接口

许多管理员为了让一切正常运行而保持开放的入口端口，而不是寻找其他解决方案
