# Nmap サマリー（ESP）

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks をPDFでダウンロードしたい** 場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f) に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live) をフォローする**
* **ハッキングトリックを共有するために、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **と** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## パラメータ

### スキャンするIP

* **`<ip>,<net/mask>`:** 直接IPを示す
* **`-iL <ips_file>`:** IPリスト
* **`-iR <number>`**: ランダムなIPの数、`--exclude <Ips>`または`--excludefile <file>`で除外できる。

### 機器の発見

デフォルトでは、Nmapは次のような発見フェーズを実行します: `-PA80 -PS443 -PE -PP`

* **`-sL`**: 侵入しないで、ターゲットをリストアップし、名前を解決するためのDNSリクエストを行います。たとえば、www.prueba.es/24のすべてのIPがターゲットであるかどうかを知るのに役立ちます。
* **`-Pn`**: ピングなし。すべてがアクティブであることを知っている場合に便利です（そうでない場合、多くの時間を無駄にする可能性がありますが、このオプションは、アクティブでないと言って誤った否定を生じます）、発見フェーズを防止します。
* **`-sn`** : ポートスキャンなし。偵察フェーズを完了した後、ポートをスキャンしません。比較的ステルシーで、小規模なネットワークスキャンを許可します。特権を持っている場合、80にACK(-PA)、443にSYN(-PS)、エコーリクエストとタイムスタンプリクエストを送信し、特権を持っていない場合は常に接続を完了します。ターゲットがネットワークの場合、ARP(-PR)のみを使用します。他のオプションと併用する場合、他のオプションのパケットのみが破棄されます。
* **`-PR`**: ARPへのPING。ネットワーク内のコンピュータを分析する際には、PINGを使用するよりも高速です。ARPパケットを使用したくない場合は、`--send-ip`を使用します。
* **`-PS <ports>`**: SYNパケットを送信し、SYN/ACKで応答するとオープンです（接続を終了しないようにRSTで応答します）、RSTで応答すると閉じており、応答がない場合は到達不能です。特権を持っていない場合、自動的に合計接続が使用されます。ポートが指定されていない場合、80に送信されます。
* **`-PA <ports>`**: 前述のものと同様ですが、ACKを使用し、両方を組み合わせるとより良い結果が得られます。
* **`-PU <ports>`**: 目的は逆で、閉じていると予想されるポートに送信されます。一部のファイアウォールはTCP接続のみをチェックします。閉じている場合はポート到達不能で応答され、他のicmpで応答されるか、応答がない場合は宛先到達不能となります。
* **`-PE, -PP, -PM`** : ICMP PINGS: エコーリプライ、タイムスタンプ、アドレスマスク。ターゲットがアクティブかどうかを調べるために送信されます。
* **`-PY<ports>`**: デフォルトでは80にSCTP INITプローブを送信し、INIT-ACK(オープン)またはABORT(閉じている)または何も応答しないか、ICMP到達不能(非アクティブ)が返される可能性があります。
* **`-PO <protocols>`**: ヘッダーにプロトコルが指定されます。ICMP、IGMP、TCP(6)、UDP(17)プロトコルの場合、プロトコルヘッダーが送信され、それ以外の場合はIPヘッダーのみが送信されます。これは、ヘッダーの不正形式により、プロトコルが到達不能または同じプロトコルの応答が返されることで、ターゲットがアップかどうかを知るために使用されます。
* **`-n`**: DNSなし
* **`-R`**: 常にDNS

### ポートスキャン技術

* **`-sS`**: 接続を完了しないため、痕跡を残しません。使用可能な場合非常に優れています（特権）。デフォルトで使用されるものです。
* **`-sT`**: 接続を完了するため、痕跡を残しますが、確実に使用することができます。特権なしの場合はデフォルトです。
* **`-sU`**: より遅い、UDP用。主に: DNS(53)、SNMP(161,162)、DHCP(67および68)、(-sU53,161,162,67,68): オープン(応答)、閉じている(ポート到達不能)、フィルタリング(他のICMP)、オープン/フィルタリング(何もなし)。オープン/フィルタリングの場合、-sVは、nmapがサポートするバージョンのいずれかを検出できるように多数のリクエストを送信します。時間がかかります。
* **`-sY`**: SCTPプロトコルは接続を確立できず、したがってログが残りません。-PYと同様に機能します。
* **`-sN,-sX,-sF`:** Null、Fin、Xmas、いくつかのファイアウォールを貫通し、情報を抽出できます。標準に準拠したマシンは、SYN、RST、ACKフラグがないリクエストにはすべてRSTで応答するはずであることに基づいています: オープン/フィルタリング(何もなし)、閉じている(RST)、フィルタリング(ICMP到達不能)。Windows、CIsco、BSDI、OS/400では信頼性がありません。UNIXでははい。
* **`-sM`**: Maimonスキャン: FINとACKフラグを送信し、現在はすべてを閉じて返します。
* **`-sA, sW`**: ACKとWindow、ファイアウォールを検出し、ポートがフィルタリングされているかどうかを知るために使用されます。-sWはオープン/閉じているを区別します。オープンは(ウィンドウが0以外の)RSTで応答し、閉じているは(RSTウィンドウ=0)、フィルタリングは(ICMP到達不能または何もなし)で応答します。すべてのコンピュータがこの方法で動作するわけではないため、すべて閉じている場合は動作していないこと、いくつかがオープンの場合は正常に動作していること、多くがオープンで少数が閉じている場合は逆に動作していることを知ることができます。
* **`-sI`:** アイドルスキャン。アクティブなファイアウォールがある場合でも、特定のIPにフィルタリングされていないことを知っている場合（または単に匿名性を望む場合）は、ゾンビスキャナーを使用して、可能なゾンビを探すことができます。スクリプトipidseqまたはexploit auxiliary/scanner/ip/ipidseqを使用して、ゾンビを探すことができます。このスキャナーは、IPパケットのIPID番号に基づいています。
* **`--badsum`:** サムを誤って送信し、コンピュータはパケットを破棄しますが、ファイアウォールは何かを返信する可能性があります。ファイアウォールを検出するために使用されます。
* **`-sZ`:** "奇妙な" SCTPスキャナー、cookie echo fragmentsを送信すると、オープンの場合は破棄されるか、閉じている場合はABORTで応答されるはずです。initを通過できないファイアウォールを通過することができますが、フィルタリングされたものとオープンなものを区別しません。
* **`-sO`:** プロトコルIPスキャン。時々プロトコルさえ区別できない空のヘッダーを送信します。ICMP到達不能プロトコルが到着した場合は閉じており、到達不能ポートが到着した場合はオープンです。他のエラーが到着した場合はフィルタリングされ、何も到着しない場合はオープン|フィルタリングです。
* **`-b <server>`:** FTPhost--> 他のホストからホストをスキャンするために使用され、他のマシンのFTPに接続して、他のマシンからスキャンしたいポートにファイルを送信するように要求します。応答に基づいて、ポートが開いているかどうかを知ることができます。\[\<user>:\<password>@]\<server>\[:\<port>] ほとんどのFTPサーバーはこれを許可しなくなっているため、実用的な用途はほとんどありません。

### 分析を中心に置く

**-p:** スキャンするポートを指定するために使用されます。65335を選択するには: **-p-** または **-p all**。Nmapには、人気に応じた内部分類があります。デフォルトでは、主要な1000ポートを使用します。**-F** (高速スキャン) では、主要な100ポートを分析します。**--top-ports \<numero>** 指定された数の主要なポートを分析します（1から65335まで）。ポートをランダムな順序でチェックするためには、**-r** を使用します。また、ポートを選択することもできます: 20-30,80,443,1024- これは1024以降をチェックすることを意味します。また、ポートをプロトコル別にグループ化することもできます: U:53,T:21-25,80,139,S:9。Nmapの一般的なポート範囲から選択することもできます: -p \[-1024] nmap-servicesに含まれるポート1024までを分析します。**--port-ratio \<ratio>** 指定された比率の一般的なポートを分析します。比率は0から1の間でなければなりません。

**-sV** バージョンスキャン、強度を0から9まで調整できます。デフォルトは7です。

**--version-intensity \<numero>** 強度を調整でき、より低い値では最も可能性の高い調査だけを実行しますが、すべてを実行しません。これにより、UDPスキャンの時間を大幅に短縮できます。

**-O** OSの検出

**--osscan-limit** ホストを適切にスキャンするには、少なくとも1つのポートが開いており、もう1つのポートが閉じている必要があります。この条件が満たされていない場合、このオプションを設定している場合、OSの予測を試みず、時間を節約します。
**--osscan-guess** OS検出が完璧でない場合、より多くの努力が必要になります。

**スクリプト**

\--script _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_\[,...]

デフォルトで使用するには、-sCまたは--script=defaultを使用します。

利用可能なタイプ: auth、broadcast、default、discovery、dos、exploit、external、fuzzer、intrusive、malware、safe、version、vuln

* **Auth:** 利用可能なすべての認証スクリプトを実行します
* **Default:** ツールのデフォルトの基本スクリプトを実行します
* **Discovery:** ターゲットまたは被害者から情報を取得します
* **External:** 外部リソースを利用するスクリプト
* **Intrusive:** 被害者またはターゲットにとって侵入的と見なされるスクリプトを使用します
* **Malware:** 悪意のあるコードやバックドアによるオープンコネクションをチェックします
* **Safe:** 侵入的でないスクリプトを実行します
* **Vuln:** 最もよく知られた脆弱性を発見します
* **All:** 利用可能なすべてのNSE拡張子スクリプトを実行します

スクリプトを検索するには:

**nmap --script-help="http-\*" -> http-で始まるもの**

**nmap --script-help="not intrusive" -> それ以外のすべて**

**nmap --script-help="default or safe" -> どちらかまたは両方にあるもの**

**nmap --script-help="default and safe" --> 両方にあるもの**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<filename>_

\--script-help _\<filename>_|_\<category>_|_\<directory>_|_\<expression>_|all\[,...]

\--script-trace ---> スクリプトの進行状況を表示します

\--script-updatedb

**スクリプトを使用するには、単に次のように入力します: namp --script ScriptName target** --> スクリプトを入力すると、スクリプトとスキャナーの両方が実行されます。スキャナーのオプションも指定できます。安全なもののみを実行するには、**"safe=1"** を追加できます。

**時間制御**

**Nmapは秒、分、ミリ秒で時間を変更できます:** --host-timeout arguments 900000ms、900、900s、15m はすべて同じです。

Nmapはスキャンするホストの総数をグループに分割し、それらのグループをブロックごとに分析します。すべてのグループが分析されるまで次のブロックには移動せず（ユーザーにはブロックが分析されるまで更新が表示されません）、Nmapにとっては大きなグループを使用する方が効率的です。デフォルトでは、クラスCでは256を使用します。

変更できます\*\*--min-hostgroup\*\* _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_（並列スキャングループのサイズを調整）

並列スキャンの数を制御できますが、推奨されません（Nmapはネットワークの状態に基づいて自動制御を組み込んでいます）:**--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

RTTタイムアウトを変更できますが、通常は必要ありません:**--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

試行回数を変更できます:**--max-retries** _**\<numtries>**_

ホストのスキャン時間を変更できます:**--host-timeout** _**\<time>**_

各テスト間の時間を遅くするためにスキャン遅延を変更できます:**--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**_

秒間のパケット数を変更できます:**--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

多くのポートはフィルタリングされているか閉じられているため、応答に時間がかかる場合があります。開いているポートのみに興味がある場合は、次のオプションを使用して高速化できます:**--defeat-rst-ratelimit**

Nmapの攻撃の強度を定義するには: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-5)

\-T0 --> 1度に1つのポートのみをスキャンし、次のポートまで5分待機します

\-T1およびT2 --> 非常に似ていますが、それぞれ15秒と0.4秒待機します

\-T3 --> デフォルトの動作で、並列処理を含みます

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**ファイアウォール/IDS**

ポートを通さずパケットを分析します。

**-f** パケットをフラグメント化するために使用され、デフォルトではヘッダーの後に8バイトでフラグメント化されます。特定のサイズを指定するには..mtuを使用します（これを使用すると-fを使用しないでください）、オフセットは8の倍数である必要があります。**バージョンスキャナーやスクリプトはフラグメンテーションをサポートしていません**

**-D decoy1,decoy2,ME** Nmapは他のIPアドレスを送信元として使用してスキャンを実行します。MEをリストに含めると、NmapはそのIPアドレスを使用します。完全にマスクするためには、自分の前に5つまたは6つのデコイを置くと良いでしょう。RND:\<number>を使用してランダムなIPを生成できます。TCP接続のないバージョン検出とは互換性がありません。ネットワーク内にいる場合は、アクティブなIPを使用すると良いでしょう。そうしないと、あなたが唯一のアクティブなIPであることが非常に簡単に特定されます。

ランダムなIPを使用するには: nmap-D RND: 10 Ip\_target

**-S IP** NmapがあなたのIPアドレスを取得できない場合は、このオプションで指定する必要があります。また、他の目標がスキャンしているかのように見せるためにも使用できます。

**-e \<interface>** インターフェースを選択するために使用します

多くの管理者は、すべてが正常に機能するように入力ポートを開いたままにしておくことを好み、他の解決策を探すよりも簡単です。これらはDNSやFTPのポートなどである可能性があります。この脆弱性を検索するためにNmapには次のオプションが組み込まれています: **--source-port** _**\<portnumber>**_**;-g** _**\<portnumber>**_ _同等です_

**--data** _**\<hex string>**_ ヘキサ文字列を送信するために: --data 0xdeadbeef および --data \xCA\xFE\x09

**--data-string** _**\<string>**_ 通常のテキストを送信するために: --data-string "Scan conducted by Security Ops, extension 7192"

**--data-length** _**\<number>**_ Nmapはヘッダーのみを送信しますが、これにより指定したバイト数が追加されます（ランダムに生成されます）

IPパケットを完全に構成するには**--ip-options**を使用します

送信および受信されるパケットのオプションを表示する場合は、--packet-traceを指定します。IPオプションを使用したNmapの詳細と例については、[http://seclists.org/nmap-dev/2006/q3/52](http://seclists.org/nmap-dev/2006/q3/52)を参照してください。

**--ttl** _**\<value>**_

**--randomize-hosts** 攻撃をより明白にしないために使用します

**--spoof-mac** _**\<MAC address, prefix, or vendor name>**_ MACアドレスを変更するために使用します。例: Apple、0、01:02:03:04:05:06、deadbeefcafe、0020F2、Cisco
**--proxies** _**\<Comma-separated list of proxy URLs>**_ プロキシを使用するには、nmapが必要とするよりも少ない接続を維持するプロキシがあるため、並列処理を変更する必要があります: --max-parallelism

**-sP** ARPによるネットワーク内のホストの検出

多くの管理者は、特定のポート（たとえば20、53、67など）からのすべてのパケットを通過させるファイアウォールルールを作成します。nmapにこれらのポートからパケットを送信するよう指示できます: **nmap --source-port 53 Ip**

**出力**

**-oN file** 通常の出力

**-oX file** XML出力

**-oS file** スクリプトキディの出力

**-oG file** grepable出力

**-oA file** -oS以外のすべて

**-v level** 冗長性

**-d level** デバッグ

**--reason** ホストと状態の理由

**--stats-every time** その時間ごとに進捗状況を表示

**--packet-trace** 送信されるパケットを表示するために、--version-traceや--script-traceなどのフィルタを指定できます

**--open** 開いている、開いている|フィルタされている、フィルタされていないものを表示

**--resume file** サマリを出力

**その他**

**-6** IPv6を許可

**-A** -O -sV -sC --tracerouteと同じ

**実行時間**

nmapが実行されている間にオプションを変更できます:

v / V 冗長性レベルを増減

d / D デバッグレベルを増減

p / P パケットトレースをオン/オフ

? ランタイムインタラクションヘルプ画面を表示

**Vulscan**

nmapのスクリプトで、オフラインのデータベース（非常に重要な他のデータベースからダウンロードされる）で取得したサービスのバージョンを調べ、可能な脆弱性を返します

使用するデータベースは次のとおりです:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Nmapのフォルダにダウンロードしてインストールするには:

wget http://www.computec.ch/projekte/vulscan/download/nmap\_nse\_vulscan-2.0.tar.gz && tar -czvf nmap\_nse\_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

また、データベースのパッケージをダウンロードして/usr/share/nmap/scripts/vulscan/に追加する必要があります

使用方法:

すべてを使用するには: sudo nmap -sV --script=vulscan HOST\_A\_ESCANEAR

特定のデータベースを使用するには: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST\_A\_ESCANEAR

## Nmapサービススキャンを16倍高速化

[**この投稿**](https://joshua.hu/nmap-speedup-service-scanning-16x)によると、**`/usr/share/nmap/nmap-service-probes`**内のすべての**`totalwaitms`**値を**300**、**`tcpwrappedms`**を**200**に変更することで、nmapサービス解析を高速化できます。

さらに、明示的に定義されていない**`servicewaitms`**を持たないプローブは、デフォルト値**`5000`**を使用します。したがって、各プローブに値を追加するか、**`service_scan.h`**でデフォルト値を変更するためにnmapを**コンパイル**することができます。

`/usr/share/nmap/nmap-service-probes`ファイルの**`totalwaitms`**および**`tcpwrappedms`**の値を一切変更したくない場合は、`nmap-service-probes`ファイル内のこれらの値が完全に無視されるように[解析コード](https://github.com/nmap/nmap/blob/master/service\_scan.cc#L1358)を編集できます。
