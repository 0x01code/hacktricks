# Riassunto di Nmap (ESP)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
nmap -sV -sC -O -n -oA nmapscan 192.168.0.1/24
```
## Parametri

### Indirizzi IP da scansionare

* **`<ip>,<net/mask>`:** Indica gli indirizzi IP direttamente
* **`-iL <ips_file>`:** lista_IPs
* **`-iR <number>`**: Numero di indirizzi IP casuali, √® possibile escludere possibili indirizzi IP con `--exclude <Ips>` o `--excludefile <file>`.

### Scoperta dell'attrezzatura

Per impostazione predefinita, Nmap avvia una fase di scoperta che consiste in: `-PA80 -PS443 -PE -PP`

* **`-sL`**: Non invasivo, elenca gli obiettivi effettuando richieste **DNS** per risolvere i nomi. √à utile per sapere se ad esempio www.prueba.es/24 tutti gli indirizzi IP sono i nostri obiettivi.
* **`-Pn`**: **No ping**. Questo √® utile se si sa che sono tutti attivi (altrimenti si potrebbe perdere molto tempo, ma questa opzione produce anche falsi negativi dicendo che non sono attivi), impedisce la fase di scoperta.
* **`-sn`** : **No scansione delle porte**. Dopo aver completato la fase di ricognizione, non esegue la scansione delle porte. √à relativamente stealthy e consente una piccola scansione di rete. Con i privilegi invia un ACK (-PA) a 80, un SYN(-PS) a 443 e una richiesta di echo e una richiesta di timestamp, senza privilegi completa sempre le connessioni. Se l'obiettivo √® la rete, utilizza solo ARP(-PR). Se utilizzato con un'altra opzione, vengono scartati solo i pacchetti dell'altra opzione.
* **`-PR`**: **Ping ARP**. Viene utilizzato per impostazione predefinita quando si analizzano computer nella nostra rete, √® pi√π veloce rispetto all'utilizzo dei ping. Se non si desidera utilizzare i pacchetti ARP, utilizzare `--send-ip`.
* **`-PS <ports>`**: Invia pacchetti SYN ai quali, se risponde SYN/ACK, √® aperto (risponde con RST per non terminare la connessione), se risponde RST √® chiuso e se non risponde √® irraggiungibile. Nel caso in cui non si abbiano privilegi, viene utilizzata automaticamente una connessione totale. Se non vengono fornite porte, le invia a 80.
* **`-PA <ports>`**: Come il precedente ma con ACK, combinando entrambi si ottengono risultati migliori.
* **`-PU <ports>`**: L'obiettivo √® opposto, vengono inviati a porte che si prevede siano chiuse. Alcuni firewall controllano solo le connessioni TCP. Se √® chiuso, viene risposto con port unreachable, se viene risposto con un altro icmp o non viene risposto, viene considerato come destination unreachable.
* **`-PE, -PP, -PM`** : PING ICMP: echo replay, timestamp e addresmask. Vengono inviati per scoprire se l'obiettivo √® attivo.
* **`-PY<ports>`**: Invia sonde SCTP INIT a 80 per impostazione predefinita, pu√≤ essere risposto con INIT-ACK(aperto) o ABORT(chiuso) o niente o ICMP unreachable(inattivo).
* **`-PO <protocols>`**: Viene indicato un protocollo negli header, per impostazione predefinita 1(ICMP), 2(IGMP) e 4(Encap IP). Per i protocolli ICMP, IGMP, TCP (6) e UDP (17) vengono inviati gli header del protocollo, per il resto viene inviato solo l'header IP. Lo scopo di ci√≤ √® che a causa della deformazione degli header, vengono risposti Protocol unreachable o risposte dello stesso protocollo per sapere se √® attivo.
* **`-n`**: No DNS
* **`-R`**: DNS sempre

### Tecniche di scansione delle porte

* **`-sS`**: Non completa la connessione quindi non lascia tracce, molto buono se pu√≤ essere utilizzato (con privilegi). √à quello utilizzato per impostazione predefinita.
* **`-sT`**: Completa la connessione, quindi lascia una traccia, ma pu√≤ essere utilizzato in modo sicuro. Di default senza privilegi.
* **`-sU`**: Pi√π lento, per UDP. Principalmente: DNS(53), SNMP(161,162), DHCP(67 e 68), (-sU53,161,162,67,68): aperto(risposta), chiuso(port unreachable), filtrato (altro ICMP), aperto/filtrato (niente). In caso di aperto/filtrato, -sV invia numerose richieste per rilevare una delle versioni supportate da nmap e pu√≤ rilevare lo stato reale. Aumenta molto il tempo.
* **`-sY`**: Il protocollo SCTP non riesce a stabilire la connessione, quindi non ci sono registri, funziona come -PY
* **`-sN,-sX,-sF`:** Null, Fin, Xmas, possono penetrare alcuni firewall ed estrarre informazioni. Si basano sul fatto che le macchine conformi allo standard dovrebbero rispondere con RST a tutte le richieste che non hanno sollevato flag SYN, RST o ACK: aperto/filtrato(niente), chiuso(RST), filtrato (ICMP unreachable). Non affidabile su Windows, CIsco, BSDI e OS/400. Su Unix s√¨.
* **`-sM`**: Scansione Maimon: Invia flag FIN e ACK, utilizzato per BSD, attualmente restituir√† tutto come chiuso.
* **`-sA, sW`**: ACK e Window, viene utilizzato per rilevare i firewall, per sapere se le porte sono filtrate o meno. Il -sW distingue tra aperto/chiuso poich√© quelli aperti rispondono con un valore di finestra diverso: aperto (RST con finestra diversa da 0), chiuso (finestra RST = 0), filtrato (ICMP unreachable o niente). Non tutti i computer funzionano in questo modo, quindi se sono tutti chiusi, non funziona, se sono pochi aperti, funziona correttamente e se sono molti aperti e pochi chiusi, funziona al contrario.
* **`-sI`:** Scansione inattiva. Nei casi in cui √® presente un firewall attivo ma si sa che non filtra verso un determinato IP (o quando si desidera semplicemente l'anonimato) √® possibile utilizzare lo scanner zombie (funziona per tutte le porte) per cercare possibili zombie si pu√≤ utilizzare lo script ipidseq o l'exploit auxiliary/scanner/ip/ipidseq. Questo scanner si basa sul numero IPID dei pacchetti IP.
* **`--badsum`:** Invia la somma in modo errato, i computer scarterebbero i pacchetti, ma i firewall potrebbero rispondere qualcosa, viene utilizzato per rilevare i firewall.
* **`-sZ`:** Scanner SCTP "strano", quando invia sonde con frammenti di cookie echo dovrebbero essere scartati se aperti o risposti con ABORT se chiusi. Pu√≤ passare attraverso firewall che init non riesce a superare, il problema √® che non distingue tra filtrato e aperto.
* **`-sO`:** Scansione del protocollo IP. Invia intestazioni errate e vuote in cui talvolta non √® possibile distinguere nemmeno il protocollo. Se arriva un protocollo ICMP unreachable √® chiuso, se arriva una porta irraggiungibile √® aperto, se arriva un altro errore, filtrato, se non arriva nulla, aperto|filtrato.
* **`-b <server>`:** FTPhost--> Viene utilizzato per scansionare un host da un altro, ci√≤ viene fatto collegandosi all'ftp di un'altra macchina e chiedendo di inviare file alle porte che si desider
**--osscan-guess** Quando la rilevazione del sistema operativo non √® perfetta, questo sforza maggiormente

**Script**

\--script _\<nomefile>_|_\<categoria>_|_\<directory>_|_\<espressione>_\[,...]

Per utilizzare quelli predefiniti, √® sufficiente utilizzare -sC o --script=default

I tipi disponibili sono: auth, broadcast, default, discovery, dos, exploit, external, fuzzer, intrusive, malware, safe, version, and vuln

* **Auth:** esegue tutti gli script disponibili per l'autenticazione
* **Default:** esegue gli script di base predefiniti dello strumento
* **Discovery:** recupera informazioni sul target o sulla vittima
* **External:** script per utilizzare risorse esterne
* **Intrusive:** utilizza script considerati intrusivi per la vittima o il target
* **Malware:** verifica se ci sono connessioni aperte da codici maligni o backdoor
* **Safe:** esegue script non intrusivi
* **Vuln:** scopre le vulnerabilit√† pi√π note
* **All:** esegue tutti gli script NSE disponibili

Per cercare script:

**nmap --script-help="http-\*" -> Quelli che iniziano con http-**

**nmap --script-help="not intrusive" -> Tutti tranne quelli**

**nmap --script-help="default or safe" -> Quelli che sono in uno o nell'altro o in entrambi**

**nmap --script-help="default and safe" --> Quelli che sono in entrambi**

**nmap --script-help="(default or safe or intrusive) and not http-\*"**

\--script-args _\<n1>_=_\<v1>_,_\<n2>_={_\<n3>_=_\<v3>_},_\<n4>_={_\<v4>_,_\<v5>_}

\--script-args-file _\<nomefile>_

\--script-help _\<nomefile>_|_\<categoria>_|_\<directory>_|_\<espressione>_|all\[,...]

\--script-trace ---> Fornisce informazioni su come sta procedendo lo script

\--script-updatedb

**Per utilizzare uno script √® sufficiente inserire: nmap --script Nome\_dello\_script obiettivo** --> Inserendo lo script verr√† eseguito sia lo script che la scansione, quindi √® possibile aggiungere **"safe=1"** per eseguire solo quelli sicuri.

**Controllo del tempo**

**Nmap pu√≤ modificare il tempo in secondi, minuti, ms:** --host-timeout arguments 900000ms, 900, 900s, and 15m fanno la stessa cosa.

Nmap divide il numero totale di host da scansionare in gruppi e analizza quei gruppi a blocchi in modo che fino a quando tutti i blocchi non sono stati analizzati, non passa al blocco successivo (e l'utente non riceve alcun aggiornamento fino a quando il blocco non √® stato analizzato) in questo modo, √® pi√π efficiente per nmap utilizzare gruppi pi√π grandi. Di default, in una classe C, ne utilizza 256.

Pu√≤ essere modificato con **--min-hostgroup** _**\<numhosts>**_**;** **--max-hostgroup** _**\<numhosts>**_ (Regola le dimensioni dei gruppi di scansione parallela)

√à possibile controllare il numero di scanner in parallelo, ma √® meglio evitarlo (nmap incorpora gi√† un controllo automatico in base allo stato della rete): **--min-parallelism** _**\<numprobes>**_**;** **--max-parallelism** _**\<numprobes>**_

√à possibile modificare il timeout rtt, ma di solito non √® necessario: **--min-rtt-timeout** _**\<time>**_**,** **--max-rtt-timeout** _**\<time>**_**,** **--initial-rtt-timeout** _**\<time>**_

√à possibile modificare il numero di tentativi: **--max-retries** _**\<numtries>**_

√à possibile modificare il tempo di scansione di un host: **--host-timeout** _**\<time>**_

√à possibile modificare il tempo tra ogni prova per rallentare: **--scan-delay** _**\<time>**_**;** **--max-scan-delay** _**\<time>**_

√à possibile modificare il numero di pacchetti al secondo: **--min-rate** _**\<number>**_**;** **--max-rate** _**\<number>**_

Molti porte impiegano molto tempo a rispondere se sono filtrate o chiuse, se siamo interessati solo a quelle aperte, possiamo accelerare il processo con: **--defeat-rst-ratelimit**

Per definire il livello di aggressivit√† di nmap: -T paranoid|sneaky|polite|normal|aggressive|insane

\-T (0-1)

\-T0 --> Viene scansionata solo una porta alla volta e si attendono 5 minuti prima della successiva

\-T1 e T2 --> Molto simili ma attendono solo 15 e 0,4 secondi rispettivamente tra ogni prova

\-T3 --> Funzionamento predefinito, include in parallelo

\-T4 --> --max-rtt-timeout 1250ms --min-rtt-timeout 100ms --initial-rtt-timeout 500ms --max-retries 6 --max-scan-delay 10ms

\-T5 --> --max-rtt-timeout 300ms --min-rtt-timeout 50ms --initial-rtt-timeout 250ms --max-retries 2 --host-timeout 15m --max-scan-delay 5ms

**Firewall/IDS**

Impediscono l'accesso alle porte e analizzano i pacchetti.

**-f** Per frammentare i pacchetti, di default li frammenta in 8 byte dopo l'intestazione, per specificare quella dimensione usiamo ..mtu (in questo caso, non usare -f), l'offset deve essere multiplo di 8. **Gli scanner di versione e gli script non supportano la frammentazione**

**-D decoy1,decoy2,ME** Nmap invia scanner ma con altri indirizzi IP come origine, in questo modo ti nasconde. Se inserisci ME nella lista, nmap ti posizioner√† l√¨, √® meglio inserire 5 o 6 indirizzi prima del tuo per mascherarti completamente. √à possibile generare indirizzi IP casuali con RND:\<numero> per generare \<numero> di indirizzi IP casuali. Non funzionano con il rilevamento delle versioni senza connessione TCP. Se sei all'interno di una rete, √® consigliabile utilizzare indirizzi IP attivi, altrimenti sar√† molto facile capire che sei l'unico attivo.

Per utilizzare indirizzi IP casuali: nmap -D RND: 10 Ip\_obiettivo

**-S IP** Quando Nmap non rileva il tuo indirizzo IP, devi fornirlo con questo. √à anche utile per far pensare che ci sia un altro obiettivo che li sta scansionando.

**-e \<interfaccia>** Per scegliere l'interfaccia

Molti amministratori lasciano aperte le porte di ingresso affinch√© tutto funzioni correttamente e sia pi√π facile per loro trovare un'altra soluzione. Queste possono essere le porte DNS o quelle FTP... per cercare questa vulnerabilit√†, nmap include: **--source-port** _**\<numerodiporta>**_**;-g** _**\<numerodiporta>**_ _Sono equivalenti_

**--data** _**\<stringaesadecimale>**_ Per inviare testo esadecimale: --data 0xdeadbeef and --data \xCA\xFE\x09

**--data-string** _**\<stringa>**_ Per inviare un testo normale: --data-string "Scansione condotta da Security Ops, estensione 7192"

**--data-length** _**\<numero>**_ Nmap invia solo intestazioni, con questo facciamo in modo che aggiunga a queste un numero di byte in pi√π (che verranno generati casualmente)

Per configurare completamente il pacchetto IP, utilizzare **
**--proxies** _**\<Elenco separato da virgole di URL proxy>**_ Per utilizzare i proxy, a volte un proxy non mantiene aperte cos√¨ tante connessioni come nmap desidera, quindi √® necessario modificare la parallelit√†: --max-parallelism

**-sP** Per scoprire gli host nella rete in cui ci troviamo tramite ARP

Molti amministratori creano una regola nel firewall che consente di passare tutti i pacchetti provenienti da una porta specifica (come la 20, 53 e 67), possiamo dire a nmap di inviare i nostri pacchetti da quelle porte: **nmap --source-port 53 Ip**

**Output**

**-oN file** Output normale

**-oX file** Output XML

**-oS file** Output per script kiddies

**-oG file** Output grepable

**-oA file** Tutti tranne -oS

**-v level** verbosit√†

**-d level** debug

**--reason** Motivo dell'host e stato

**--stats-every time** Ogni tanto ci dice come sta andando

**--packet-trace** Per vedere quali pacchetti vengono inviati, √® possibile specificare filtri come: --version-trace o --script-trace

**--open** mostra gli aperti, aperti|filtrati e non filtrati

**--resume file** Genera un riassunto

**Miscellanea**

**-6** Consente ipv6

**-A** √à lo stesso di -O -sV -sC --traceroute

**Run time**

Durante l'esecuzione di nmap possiamo modificare le opzioni:

v / V Aumenta / diminuisce il livello di verbosit√†

d / D Aumenta / diminuisce il livello di debug

p / P Attiva / disattiva il tracciamento dei pacchetti

? Stampa una schermata di aiuto interattiva durante l'esecuzione

**Vulscan**

Script di nmap che controlla le versioni dei servizi ottenuti in un database offline (scaricato da altri database molto importanti) e restituisce le possibili vulnerabilit√†

I database utilizzati sono:

1. Scipvuldb.csv | [http://www.scip.ch/en/?vuldb](http://www.scip.ch/en/?vuldb)
2. Cve.csv | [http://cve.mitre.org](http://cve.mitre.org/)
3. Osvdb.csv | [http://www.osvdb.org](http://www.osvdb.org/)
4. Securityfocus.csv | [http://www.securityfocus.com/bid/](http://www.securityfocus.com/bid/)
5. Securitytracker.csv | [http://www.securitytracker.com](http://www.securitytracker.com/)
6. Xforce.csv | [http://xforce.iss.net](http://xforce.iss.net/)
7. Exploitdb.csv | [http://www.exploit-db.com](http://www.exploit-db.com/)
8. Openvas.csv | [http://www.openvas.org](http://www.openvas.org/)

Per scaricarlo e installarlo nella cartella di Nmap:

wget http://www.computec.ch/projekte/vulscan/download/nmap\_nse\_vulscan-2.0.tar.gz && tar -czvf nmap\_nse\_vulscan-2.0.tar.gz vulscan/ && sudo cp -r vulscan/ /usr/share/nmap/scripts/

√à anche necessario scaricare i pacchetti dei database e aggiungerli a /usr/share/nmap/scripts/vulscan/

Utilizzo:

Per utilizzare tutti i database: sudo nmap -sV --script=vulscan HOST\_DA\_SCANSIONARE

Per utilizzare un database specifico: sudo nmap -sV --script=vulscan --script-args vulscandb=cve.csv HOST\_DA\_SCANSIONARE

## Accelerare la scansione dei servizi di Nmap x16

Secondo [**questo post**](https://joshua.hu/nmap-speedup-service-scanning-16x) √® possibile accelerare l'analisi dei servizi di nmap modificando tutti i valori **`totalwaitms`** in **`/usr/share/nmap/nmap-service-probes`** a **300** e **`tcpwrappedms`** a **200**.

Inoltre, le sonde che non hanno un valore specificamente definito **`servicewaitms`** utilizzano un valore predefinito di **`5000`**. Pertanto, possiamo aggiungere valori a ciascuna delle sonde, oppure possiamo **compilare nmap** noi stessi e modificare il valore predefinito in [**service\_scan.h**](https://github.com/nmap/nmap/blob/master/service\_scan.h#L79).

Se non si desidera modificare i valori di **`totalwaitms`** e **`tcpwrappedms`** nel file `/usr/share/nmap/nmap-service-probes`, √® possibile modificare il [codice di parsing](https://github.com/nmap/nmap/blob/master/service\_scan.cc#L1358) in modo che questi valori nel file `nmap-service-probes` vengano completamente ignorati.

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
