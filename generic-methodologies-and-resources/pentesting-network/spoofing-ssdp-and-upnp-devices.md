# Falsificando Dispositivos SSDP e UPnP com o EvilSSDP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

**Este post foi copiado de** [**https://www.hackingarticles.in/evil-ssdp-spoofing-the-ssdp-and-upnp-devices/**](https://www.hackingarticles.in/evil-ssdp-spoofing-the-ssdp-and-upnp-devices/)

## **Introdu√ß√£o**

### **O que √© SSDP?**

SSDP ou Simple Service Discovery Protocol √© um protocolo de rede projetado para **an√∫ncio e descoberta de servi√ßos de rede**. Ele pode funcionar sem qualquer configura√ß√£o DHCP ou DNS. Foi projetado para ser usado em ambientes residenciais ou pequenos escrit√≥rios. Ele usa UDP como protocolo de transporte subjacente na **porta 1900**. Ele usa o m√©todo HTTP NOTIFY para anunciar o estabelecimento ou retirada de servi√ßos para um grupo multicast. √â a base do protocolo de descoberta UPnP.

### **O que s√£o dispositivos UPnP?**

UPnP ou Universal Plug and Play √© um conjunto de **protocolos de rede** que permite que dispositivos em rede, como computadores pessoais, impressoras, gateways de Internet, pontos de acesso Wi-Fi e dispositivos m√≥veis, **descubram a disponibilidade uns dos outros na rede** e estabele√ßam servi√ßos de rede para comunica√ß√µes, compartilhamento de dados e entretenimento. A arquitetura UPnP suporta a rede de configura√ß√£o zero. Um dispositivo compat√≠vel com UPnP de qualquer fornecedor pode se juntar dinamicamente a uma rede, obter um endere√ßo IP, **anunciar seu nome, anunciar ou transmitir suas capacidades** mediante solicita√ß√£o e aprender sobre a presen√ßa e capacidades de outros dispositivos.

### **Fluxo**

A pilha **UPnP** consiste em **seis camadas**: endere√ßamento, descoberta, descri√ß√£o, controle, eventos e apresenta√ß√£o.

Na camada de endere√ßamento, os sistemas habilitados para UPnP tentam obter um endere√ßo IP atrav√©s do **DHCP**. Se isso n√£o for poss√≠vel, eles **autoatribuem um endere√ßo** da faixa 169.254.0.0/16 (RFC 3927), um processo conhecido como AutoIP.

Em seguida, vem a camada de descoberta, na qual o sistema procura outros dispositivos na rede usando o **Simple Service Discovery Protocol** (SSDP). As duas maneiras de descobrir dispositivos s√£o **ativamente** e **passivamente**. Ao usar o m√©todo **ativo**, dispositivos compat√≠veis com UPnP **enviam uma mensagem de descoberta** (chamada de **solicita√ß√£o M-SEARCH**) para o endere√ßo multicast **239.255.255.250 na porta UDP 1900**. Chamamos essa solicita√ß√£o de HTTPU (HTTP sobre UDP) porque ela cont√©m um cabe√ßalho semelhante ao cabe√ßalho HTTP. A solicita√ß√£o M-SEARCH se parece com isso:
```
  M-SEARCH * HTTP/1.1
  ST: ssdp:all
  MX: 5
  MAN: ssdp:discover
  HOST: 239.255.255.250:1900
```
Sistemas UPnP que ouvem essa solicita√ß√£o devem responder com uma mensagem unicast UDP que anuncia a localiza√ß√£o HTTP do arquivo XML de descri√ß√£o, que lista os servi√ßos suportados pelo dispositivo.

Ao usar o m√©todo **passivo** para descobrir dispositivos, dispositivos compat√≠veis com UPnP anunciam periodicamente seus servi√ßos na rede enviando uma mensagem **NOTIFY para o endere√ßo multicast** 239.255.255.250 na porta UDP 1900. Essa mensagem, que segue abaixo, parece com a enviada em resposta √† descoberta ativa:
```
  NOTIFY * HTTP/1.1\r\n
  HOST: 239.255.255.250:1900\r\n
  CACHE-CONTROL: max-age=60\r\n
  LOCATION: http://192.168.10.254:5000/rootDesc.xml\r\n
  SERVER: OpenWRT/18.06-SNAPSHOT UPnP/1.1 MiniUPnPd/2.1\r\n
  NT: urn:schemas-upnp-org:service:WANIPConnection:2
```
A descri√ß√£o de cada perfil UPnP √© referenciada no valor do campo LOCATION da mensagem de resposta recebida durante a descoberta ativa ou na mensagem NOTIFY recebida durante a descoberta passiva.

A camada de controle √© provavelmente a mais importante; ela permite que os clientes enviem comandos para o dispositivo UPnP usando as URLs do arquivo de descri√ß√£o. Eles podem fazer isso usando o Protocolo de Acesso a Objetos Simples (SOAP), um protocolo de mensagens que usa XML sobre HTTP. Os dispositivos enviam solicita√ß√µes SOAP para o endpoint controlURL, descrito na tag \<service> dentro do arquivo de descri√ß√£o. Uma tag \<service> se parece com isso:
```xml
 <service>
     <serviceType>urn:schemas-upnp-org:service:WANIPConnection:2</serviceType>
     <serviceId>urn:upnp-org:serviceId:WANIPConn1</serviceId>
     <SCPDURL>/WANIPCn.xml</SCPDURL>
     <controlURL>/ctl/IPConn</controlURL>
     <eventSubURL>/evt/IPConn</eventSubURL>
 </service>
```
### **IGD - Dispositivo de Gateway de Internet**

**IGD** mapeia portas em configura√ß√µes de tradu√ß√£o de endere√ßo de rede (NAT). O IGD permite que um aplicativo adicione dinamicamente um mapeamento de porta tempor√°rio no roteador por um determinado per√≠odo de tempo (sem precisar que o usu√°rio execute nenhuma etapa manual).

A maioria dos dispositivos normalmente n√£o aceita pacotes SSDP atrav√©s da interface WAN, mas alguns deles ainda podem aceitar comandos IGD atrav√©s de pontos de controle SOAP abertos.

Na se√ß√£o de ferramentas Umap, voc√™ pode encontrar uma maneira de explorar esse vetor.

## **Ferramentas**

### **Miranda**

[**Miranda**](https://raw.githubusercontent.com/0x90/miranda-upnp/master/src/miranda.py) √© um **cliente UPnP em python2** que pode ser √∫til para **descobrir** servi√ßos UPnP, obter **detalhes** e **enviar comandos** para eles:
```
upnp> msearch

Entering discovery mode for 'upnp:rootdevice', Ctl+C to stop...


SSDP reply message from 192.168.1.254:49152
XML file is located at http://192.168.1.254:49152/wps_device.xml
Device is running Unspecified, UPnP/1.0, Unspecified



SSDP reply message from 192.168.1.254:53350
XML file is located at http://192.168.1.254:53350/37699b14/rootDesc.xml
Device is running Linux/3.4.11 UPnP/1.0 MiniUPnPd/1.9


upnp> host list
	[0] 192.168.1.254:49152
	[1] 192.168.1.254:53350

upnp> host get 0
upnp> host details 0

Host name:         192.168.1.254:49152
UPNP XML File:     http://192.168.1.254:49152/wps_device.xml


Device information:
	Device Name: WFADevice
		Service Name: WFAWLANConfig
			controlURL: wps_control
			eventSubURL: wps_event
			serviceId: urn:wifialliance-org:serviceId:WFAWLANConfig1
			SCPDURL: wps_scpd.xml
			fullName: urn:schemas-wifialliance-org:service:WFAWLANConfig:1
			ServiceActions:
				PutMessage
					NewInMessage 
						InMessage:
							dataType: bin.base64

[...]

upnp> host send 0 WFADevice WFAWLANConfig PutMessage
```
### Umap

A ferramenta [**umap**](https://github.com/0x90/upnp-arsenal/blob/master/umap-bypass.py) pode ajudar a **descobrir comandos upnp** que est√£o **dispon√≠veis** nas **interfaces WAN** mesmo que n√£o sejam anunciados nessas interfaces (isso ocorre devido a implementa√ß√µes com falhas). Note que se, por exemplo, voc√™ estiver testando um roteador e tiver acesso a ele tanto pela rede interna quanto pela interface WAN, voc√™ deve tentar **enumerar todos os servi√ßos da rede interna** (usando **miranda**, por exemplo) e depois tentar **chamar esses servi√ßos da rede externa**.

### **Outras ferramentas UPnP**

Encontre em [**https://github.com/0x90/upnp-arsenal**](https://github.com/0x90/upnp-arsenal) mais ferramentas upnp.

### **Evil SSDP**

A ferramenta Evil SSDP foi desenvolvida por [initstring](https://twitter.com/init\_string). Esta ferramenta est√° hospedada no GitHub. Usaremos o comando git clone para clonar todo o conte√∫do do git em nossa m√°quina de ataque. O comando git clone criar√° um diret√≥rio com o mesmo nome do GitHub. Como a ferramenta √© desenvolvida na vers√£o 3 do Python, teremos que usar o python3 seguido pelo nome do arquivo .py para executar o programa. Aqui podemos ver uma tela de ajuda b√°sica da ferramenta.
```bash
git clone https://github.com/initstring/evil-ssdp.git
cd evil-ssdp/ls
python3 evil-ssdp.py --help
```
![](https://i0.wp.com/1.bp.blogspot.com/-O6lddDvxqts/Xkq5PHqeE\_I/AAAAAAAAisQ/FKOCxVwT9cMy54lLy0SsYcKoM5Q95K5mQCLcBGAsYHQ/s1600/1.png?w=687\&ssl=1)

No diret√≥rio clonado, encontraremos um diret√≥rio chamado templates. Ele cont√©m todos os modelos pr√©-compilados que podem ser usados para phishing do usu√°rio alvo.

## **Spoofing Scanner SSDP**

Agora que executamos a ferramenta sem problemas, vamos us√°-la para obter algumas credenciais. Nesta primeira pr√°tica, estaremos falsificando um Scanner como um dispositivo UPnP confi√°vel. Para come√ßar, teremos que configurar o modelo.

### **Configura√ß√£o do Modelo**

Para usar a ferramenta, teremos que fornecer a interface de rede. Aqui, em nossa m√°quina atacante, temos o "eth0" como nossa interface, voc√™ pode encontrar sua interface usando o comando "ifconfig".

Depois de fornecer a interface, usaremos o par√¢metro "--template" para passar um modelo que encontramos anteriormente no diret√≥rio de modelos. Para falsificar um scanner, executaremos o seguinte comando. Como podemos ver, a ferramenta fez seu trabalho e hospedou v√°rios arquivos de modelo em nossa m√°quina atacante na porta 8888. Tamb√©m temos o ponteiro SMB hospedado.
```bash
ls temlates/
python3 evil-ssdp.py eth0 --template scanner
```
### **Manipula√ß√£o do Usu√°rio**

O pr√≥ximo passo l√≥gico √© manipular o usu√°rio para clicar no aplicativo. Estar na mesma rede que o alvo mostrar√° nosso scanner falso em seu explorador. √â aqui que o UPnP entra em a√ß√£o. A ferramenta Evil SSDP cria esse scanner com apar√™ncia genu√≠na no sistema do alvo sem nenhum tipo de intera√ß√£o for√ßada com o alvo.

Ao clicar no √≠cone dentro do Explorer, seremos redirecionados para o navegador da Web padr√£o, abrindo nosso link hospedado. Os modelos que usamos est√£o em jogo aqui. O usu√°rio agora est√° ciente de que est√° conectado a um scanner genu√≠no ou a um dispositivo UPnP falso que geramos. O alvo inconsciente, sem ter ideia, insere as credenciais v√°lidas neste modelo, conforme mostrado na imagem abaixo.

### **Obtendo as Credenciais**

Assim que o usu√°rio-alvo insere as credenciais, verificamos nosso terminal na m√°quina do atacante para descobrir que temos as credenciais inseridas pelo usu√°rio. Como n√£o h√° conversa necess√°ria para cada dispositivo de destino, nosso scanner falso √© vis√≠vel para todos os usu√°rios na rede. Isso significa que o escopo desse tipo de ataque √© ilimitado.

## **Falsificando o SSDP do Office365**

Na pr√°tica anterior, falsificamos o scanner para o usu√°rio-alvo. Agora, ao percorrer o diret√≥rio de modelos, encontramos o modelo do Office365. Vamos us√°-lo.

### **Configura√ß√£o do Modelo**

Como fizemos anteriormente, vamos come√ßar com a configura√ß√£o do modelo, bem como da ferramenta. Vamos usar o python3 para executar a ferramenta, seguido pelo nome do arquivo python. Em seguida, fornecendo a interface de rede que ser√° seguida pelo par√¢metro do modelo com o office365.
```bash
python3 evil-ssdp.py eth0 --template office365
```
![](https://i1.wp.com/1.bp.blogspot.com/-8GWxmKPDkIo/Xkq5RmgF8\_I/AAAAAAAAis0/bxVTcd4aBCUZBEDuUIg3-G39aMu7l5YCgCLcBGAsYHQ/s1600/6.png?w=687\&ssl=1)

Como podemos ver, a ferramenta fez o seu trabalho e hospedou v√°rios arquivos de modelo em nossa m√°quina atacante na porta 8888.

### **Manipulando o Usu√°rio**

Assim que executamos a ferramenta, temos um dispositivo UPnP chamado Office365 Backups. Isso foi feito pela ferramenta sem precisar enviar nenhum arquivo, payload ou qualquer outro tipo de intera√ß√£o para o usu√°rio-alvo. Tudo o que resta √© o usu√°rio clicar no √≠cone.

![](https://i0.wp.com/1.bp.blogspot.com/-txqBOw02D6w/Xkq5RgolUcI/AAAAAAAAis4/wkQTzYBmtdU\_Nbq9X1qI47FlJtdqHvIjQCLcBGAsYHQ/s1600/7.png?w=687\&ssl=1)

Ao ser clicado pelo usu√°rio, o usu√°rio-alvo √© redirecionado para nossa p√°gina de modelo falsa por meio de seu navegador padr√£o. Esta √© uma p√°gina da Microsoft com apar√™ncia muito genu√≠na. O usu√°rio desavisado insere suas credenciais v√°lidas nesta p√°gina.

![](https://i1.wp.com/1.bp.blogspot.com/-69Tf3PRpvhM/Xkq5RziDXzI/AAAAAAAAis8/vjejKgh0XigRHFC2Ib8QCpPlzx\_RAu4eACLcBGAsYHQ/s1600/8.png?w=687\&ssl=1)

### **Obtendo as Credenciais**

Assim que o usu√°rio insere as credenciais e elas s√£o passadas como a solicita√ß√£o de postagem para o servidor, que √© nossa m√°quina-alvo, vemos que em nosso terminal, temos as credenciais.

![](https://i0.wp.com/1.bp.blogspot.com/-3KXN6DKT\_E0/Xkq5SEwhKHI/AAAAAAAAitA/a2gTi5UwNE0JsMH-XQEW33MchkxgjPGSwCLcBGAsYHQ/s1600/9.png?w=687\&ssl=1)

## **Desviando o Usu√°rio para um SSDP de Armazenamento de Senhas**

At√© agora, falsificamos com sucesso o usu√°rio-alvo para obter algumas credenciais de scanner e algumas credenciais de backup do Office365. Mas agora vamos para a coisa mais importante que √© usada como um UPnP, o Armazenamento de Senhas.

### **Configura√ß√£o do Modelo**

Como fizemos em nossas pr√°ticas anteriores, teremos que configurar o modelo para o armazenamento de senhas. Em pouco tempo, a ferramenta hospeda o modelo de armazenamento de senhas na porta 8888.
```bash
python3 evil-ssdp.py eth0 --template password-vault
```
### **Manipula√ß√£o do Usu√°rio**

Ao acessar a m√°quina alvo, vemos que o Password Vault UPnP √© vis√≠vel no Explorer. Agora, o usu√°rio clica no dispositivo e fica preso em nosso ataque. Vendo algo como Password Vault, o usu√°rio ser√° tentado a clicar no √≠cone.

Como o usu√°rio n√£o sabe o que est√° acontecendo, ele/ela pensa que conseguiu as chaves e senhas falsas mais importantes. Isso funciona como uma distra√ß√£o para o usu√°rio, pois isso levar√° o usu√°rio a tentar essa lista exaustiva de credenciais sem sucesso.

## **Falsificando o SSDP da Microsoft Azure**

Ao trabalhar com falsifica√ß√£o, uma das tarefas mais importantes √© n√£o deixar que o usu√°rio alvo saiba que ele/ela foi v√≠tima de falsifica√ß√£o. Isso pode ser alcan√ßado redirecionando o usu√°rio depois de obtermos as credenciais ou cookies ou qualquer coisa que o atacante queira adquirir. A ferramenta evil\_ssdp tem um par√¢metro (-u) que redireciona o usu√°rio alvo para qualquer URL escolhida pelo atacante. Vamos dar uma olhada no funcionamento desse par√¢metro em a√ß√£o.

Para come√ßar, usaremos o python3 para carregar a ferramenta. Em seguida, mencionamos a Interface de Rede que deve ser usada. Agora, para este pr√°tico, usaremos o Modelo de Armazenamento do Microsoft Azure. Depois de selecionar o modelo, colocamos o par√¢metro (-u) e mencionamos qualquer URL para onde queremos redirecionar o usu√°rio. Aqui estamos usando o link oficial da Microsoft. Mas isso pode ser qualquer site malicioso.
```bash
python3 evil-ssdp.py eth0 --template microsoft-azure -u https://malicous-site.com
```
### **Manipula√ß√£o do Usu√°rio**

Agora que iniciamos a ferramenta, ela criar√° um dispositivo UPnP na M√°quina Alvo, como mostrado na imagem abaixo. Para que o ataque seja bem-sucedido, o alvo precisa clicar no dispositivo.

![](https://i1.wp.com/1.bp.blogspot.com/-rROTfEGP3z8/Xkq5QBn46dI/AAAAAAAAisc/7RDv7fI3BPYt1XmrKVRKOEHurkGY1xeogCLcBGAsYHQ/s1600/14.png?w=687\&ssl=1)

Ap√≥s clicar no √≠cone, vemos que o usu√°rio √© redirecionado para a p√°gina oficial da Microsoft. Isso pode ser o que o atacante quiser.

![](https://i2.wp.com/1.bp.blogspot.com/-gU36s2kyIbg/Xkq5QVRh61I/AAAAAAAAisg/hN3uVMTPh-suDiH5ID3-mWcQiNvDVYeJACLcBGAsYHQ/s1600/15.png?w=687\&ssl=1)

Isso conclui nossa pr√°tica com essa incr√≠vel ferramenta de spoofing.

## **Mitiga√ß√£o**

* Desative dispositivos UPnP.
* Eduque os usu√°rios para evitar ataques de phishing.
* Monitore a rede para o tr√°fego de senhas em texto claro.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
