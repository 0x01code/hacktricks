# GLBP & HSRP 攻撃

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* サイバーセキュリティ会社で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロードしたりしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション
* [**公式のPEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れましょう
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

**このページは** [**https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9**](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9) **からコピーされました。**

## FHRP ハイジャッキング <a href="#6196" id="6196"></a>

### FHRP とは？ <a href="#b12d" id="b12d"></a>

FHRP（First Hop Redundancy Protocol）は、ネットワークプロトコルのクラスであり、冗長なルーティングシステムを作成するために設計されています。FHRPを使用すると、物理ルータを1つの論理デバイスに組み合わせることができ、信頼性を向上させ、負荷を分散するのに役立ちます。

**Cisco Systems のエンジニアは、GLBP と HSRP の2つの FHRP プロトコルを開発しました。次にデモンストレーションします。**

### GLBP プロトコル <a href="#8a26" id="8a26"></a>

**Cisco Systems のエンジニアによって開発されました。** HSRP と同様に、このプロトコルは TCP/IP プロトコルスタックの上に実装されています。そのため、サービス情報の変換にはポート番号 3222 の UDP トランスポート層プロトコルが使用されます。GLBP ルータは同じ論理グループ内で特別な「ハロー」パケットを3秒ごとに交換しますが、10秒以内に同じグループの GLBP ルータからハローパケットを受信しなかった場合、それを「死んだ」と認識します。ただし、タイマーの値は管理者のニーズに応じて設定することができます。

### GLBP の骨組みと仕組み <a href="#3bb3" id="3bb3"></a>

GLBP は、1つの仮想 IP アドレスと複数の仮想 MAC アドレスを使用して、複数のルータ（ゲートウェイ）に負荷を分散します。各ホストは同じ仮想 IP アドレスで構成され、仮想グループ内のすべてのルータがパケットの送信に参加します。

HSRP および VRRP プロトコルとは異なる方法で動作します。真の負荷分散メカニズムを使用するため、以下に示します。

**ホスト依存。** NAT が存在するネットワークで使用される負荷分散の一種。ホスト依存は、ホストが以前に使用された AVF デバイスの同じ MAC アドレスを取得することを保証し、ホストへの設定された NAT が壊れないことを保証します。

**ラウンドロビン。** このモードでは、AVG デバイスが交互に AVF メンバーに MAC アドレスを配布します。これはデフォルトで使用されるメカニズムです。

**重みベースのラウンドロビン**。特別な「重み」メトリックに基づく負荷分散

### GLBP ドメインの役割と用語 <a href="#febd" id="febd"></a>

**AVG（Active Virtual Gateway）** - リーダーの役割を持つルータであり、同じ GLBP グループ内の他のルータに MAC アドレスを配布する責任もあります。GLBP ドメイン内の「ボス」のような存在です。ARP リクエストが到着すると、AVG は他のルータにトラフィックをどのように分散するかを伝えるために MAC アドレスを配布します。GLBP ドメインには AVG ルータが1つしか存在できませんが、AVF メンバーでもあることができます。

**AVF（Active Virtual Forwarder）** - ネットワーク内でトラフィックを処理する GLBP グループのルータです。

**GLBP 優先度** - GLBP グループ内のどのルータが AVG になるかを決定する優先度値です。デフォルト値は100です（優先度の範囲は1から255までです）。手動で設定することもできます。つまり、ネットワークエンジニア自身が「上位」のルータと「スレーブ」のルータを決定します。優先度が高いほど、ルータが AVG の役割を得る可能性が高くなります。通常、AVG の役割はより強力なルータに与えられます。

**GLBP ウェイト** - GLBP グループのルータの GLBP ウェイトと呼ばれる値。GLBP ウェイトはルータの負荷レベルを定義します。この値は「浮動的」であり、物理チャネルの負荷に応じて変動することができます（オブジェクトトラッキングメカニズムが関与します）、しかし、手動で設定することもできます。

**GLBP 仮想 IP アドレス** - GLBP ドメイン内の仮想 IP アドレス。正当なホストのデフォルトゲートウェイアドレスとして使用されます。

GLBP は予約されたグループメーリング IP アドレス **224.0.0.102** と UDP トランスポート層プロトコルポート番号 **3222** を使用してサービス情報を送信および処理します。特別な GLBP ハローパケットは **3秒ごと** に送信されます。GLBP ルータが隣接するルータから **10秒以内** にハローパケットを受信しなかった場合、隣接ルータは「死んだ」と見なされ、GLBP ドメインから削除されます。
### GLBP攻撃メカニズム <a href="#3260" id="3260"></a>

このネットワーク攻撃の技術は、**最大優先度値を持つ悪意のあるGLBPパケットを注入することにより、自分のデバイスをメインルーターとして押し付ける**ことです。**成功した攻撃は、ネットワーク内のトラフィックを傍受したり、リダイレクトを行ったり、AVGルーターの役割を引き継ぐことでDoS攻撃やMITM攻撃を引き起こすことができます。**必要なのは、最高優先度値255を持つGLBPパケットを構築し、ローカルネットワークに向けて送信するだけです。

<figure><img src="../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (14) (2).png" alt=""><figcaption></figcaption></figure>

### GLBPインジェクション（Loki） <a href="#fb69" id="fb69"></a>

この攻撃をデモンストレーションするために、[**Loki**](https://github.com/raizo62/loki\_on\_kali)を使用します。これにより、最大優先度値255と最大ウェイト値255を持つ悪意のあるGLBPインジェクションが実行されます。ただし、攻撃を実行する前に、次の情報を調査する必要があります：

* **GLBPドメインで使用される仮想IPアドレス**
* **認証の可用性**
* **ルーターの優先度の値**

これらの情報は、GLBPトラフィックを分析することで抽出することができます。**Wireshark**を使用します。

見てわかるように、GLBPプロセスには2つのルーターのみが関与しています：**10.10.100.100と10.10.100.200**。

<figure><img src="../../.gitbook/assets/image (158) (3).png" alt=""><figcaption><p><strong>GLBP広告</strong></p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption><p>最初のルーターからのGLBP広告</p></figcaption></figure>

GLBPトラフィックを分析した結果、次のことがわかります：

* **優先度設定において設定ミスが検出されました。AVGルーターは優先度200のGLBPルーターと見なされるため、GLBPハイジャックのためのベクターが存在します**
* **認証なし**
* **GLBPドメインで使用される仮想IPアドレスは10.10.100.254です**

この情報を元に、**簡単にGLBPを攻撃することができます**。

<figure><img src="../../.gitbook/assets/image (174).png" alt=""><figcaption><p>Lokiが2つのルーターからGLBP広告を見つけました</p></figcaption></figure>

攻撃を行う前に、**プロミスキャスモードに切り替えてトラフィックルーティングを許可してください：**
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
次の手順で、IPアドレス**10.10.100.100**のルーターを選択し、**Get IP**オプションを有効にします。また、**Gratuitous ARP**を生成する必要があります。

<figure><img src="../../.gitbook/assets/image (222).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (161) (2).png" alt=""><figcaption><p>悪意のあるGLBPインジェクションの構造</p></figcaption></figure>

ご覧の通り、AVGルーターは攻撃システムを装っています。**優先値は255で、重み値も255です。つまり、最大値です。**

**インジェクションを実行した後、GLBPドメインの仮想IPアドレスの値でネットワークインターフェースにセカンダリIPアドレスを作成する必要があります。また、24ビットのマスクを設定する必要もあります。**

**これにより、正規のトラフィックは私たちにループバックされます。なぜなら、GLBPドメインで使用される仮想IPアドレスはホストのデフォルトゲートウェイアドレスだからです:**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
**SNAT (マスカレーディング) のための小さなルール**を作成することで、着信トラフィックだけでなく送信トラフィックも表示することができます。
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
**私たちは、マシン上のデフォルトルートを削除し、新しいルートを書く必要があります。この新しいルートは、以前のAVGルーター（アドレスは10.10.100.100）を経由します。** ルーターからAVGの役割を乗っ取ったとしても、それはまだトラフィックをルーティングすることができます。
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
それで、**私たちは今、「中間者」となりました！** 重要なデータを探すために、トラフィックを分析するためにツール[**net-creds.py**](https://github.com/DanMcInerney/net-creds)を実行します。 **例えば、暗号化されていないFTPトラフィックやNTLMハッシュなどです。**
```
~$ sudo python2 net-creds.py -i eth0
```
ユーティリティを実行した後、GLBPルーターの背後にあるIPアドレス**172.16.100.70**のSMB共有を読み取ろうとします。
```
user@Boundless:~$ smbclient -L \\172.16.100.70 --user mercy
```
<figure><img src="../../.gitbook/assets/image (243).png" alt=""><figcaption></figcaption></figure>

**ネットワーク内のトラフィックを傍受する方法は、GLBPドメインを攻撃することです。**

### HSRPハイジャッキング <a href="#595f" id="595f"></a>

**HSRP（Hot Standby Router/Redundancy Protocol）**は、ネットワークゲートウェイの冗長性を提供するためのCisco独自のプロトコルです。一般的なアイデアは、複数の物理ルータを1つの論理ルータに組み合わせ、共通のIPアドレスを持つものとして扱うことです。仮想ルータのアドレスは、マスター役割を持つルータのインターフェースに割り当てられ、後者はトラフィックの転送を担当します。HSRPドメインでは、トラフィックの処理は主にプライマリ役割を持つルータによって行われます。これはGLBPとは異なり、特殊なメトリック（優先度と重み）を使用して負荷分散が提案されたプロトコルです。

### HSRPドメインの役割と用語 <a href="#4185" id="4185"></a>

**HSRPアクティブルータ** - ソースネットワークから宛先ネットワークへのトラフィックの転送を提供する仮想ルータとして機能するデバイスです。\
**HSRPスタンバイルータ** - アクティブルータの故障を待ち、アクティブルータの役割を引き継ぎます。プライマリアクティブルータが故障した場合、スタンバイルータはプライマリ役割を引き継ぎ、アクティブルータの役割を引き継ぎます。\
**HSRPグループ** - 論理ルータの動作と耐障害性を確保するデバイスのグループです。\
**HSRP MACアドレス** - HSRPドメイン内の論理ルータの仮想MACアドレスです。\
**HSRP仮想IPアドレス** - HSRPグループ内で使用される特別な仮想IPアドレスです。このIPアドレスはエンドホストのデフォルトゲートウェイとして使用され、論理ルータ自体で使用されます。

### HSRPプロトコルのバージョン <a href="#eda3" id="eda3"></a>

HSRPプロトコルにはHSRPv1とHSRPv2の2つのバージョンがあります。これらは以下のパラメータで異なります。

* **可能な論理グループの数。** HSRPv1は最大255グループを持つことができます。HSRPv2は最大4096グループを持つことができます。
* **マルチキャストIPアドレス。** HSRPv1はサービス情報を送信するためにIPアドレス**224.0.0.2**を使用し、HSRPv2は**224.0.0.102**を使用します。
* **仮想MACアドレス。** HSRPv1は仮想MACアドレスとして**00:00:0C:07:AC:XX**を使用します。HSRPv2は仮想MACアドレスとして**00:00:0C:9F:FX:XX**を使用します（XXはHSRPグループ番号です）。

HSRPは予約されたIPアドレス**224.0.0.2**または**224.0.0.102**（HSRPバージョンによって異なる）と、UDPトランスポート層プロトコルを使用し、ポート番号**1985**でサービス情報をブロードキャストおよび処理します。特別なHSRPハローパケットは**3秒ごとに**送信されます。HSRPルータが隣接ルータから**10秒以内にハローパケットを受信しない**場合、隣接ルータは「ダウン」と見なされ、HSRPドメインから削除されます。

### HSRP攻撃のメカニズム <a href="#d4a3" id="d4a3"></a>

**これはGLBPハイジャッキングとまったく同じです。最大優先度値255で悪意のあるHSRPインジェクションを実行する必要があります。**これにより、アクティブルータの役割をハイジャックし、**MITM**攻撃の道を開くことができます。ただし、攻撃を実行する前に以下の情報を調査する必要があります。

* **HSRPドメインで使用される仮想IPアドレス**
* **認証の有無**
* **ルータの優先度の値**

HSRPトラフィックを分析することで、この情報を抽出することができます。**Wiresharkを使用しましょう。**

スクリーンショットでわかるように、HSRPプロセスには10.10.100.100と10.10.100.200の2つのルータが関与しています。

<figure><img src="../../.gitbook/assets/image (181).png" alt=""><figcaption><p>HSRP広告</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (212).png" alt=""><figcaption><p>最初のHSRPルータ</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (304).png" alt=""><figcaption><p>2番目のHSRPルータ</p></figcaption></figure>

HSRPトラフィックの分析に基づいて、次の情報が得られます。

* **優先度設定内でミス構成が検出されました。優先度200のHSRPルータがアクティブルータと見なされるため、HSRPハイジャッキングのためのベクトルがあります**
* **HSRPドメインで使用される仮想IPアドレスは10.10.100.254です**
* **MD5認証が使用されています**

ドメイン内で認証が行われているため、私たちは制約されていますが、それを修正します。

### HSRP認証のバイパス <a href="#d9fd" id="d9fd"></a>

HSRPトラフィックのダンプを**.pcap**形式で保存し、エクストラクタがダンプから正しくMD5ハッシュを抽出できるようにします。エクストラクタとして**hsrp2john.py**を使用します。
```
~/cisconightmare/exfiltrate$ python2 hsrp2john.py hsrp_with_authentication.pcap
```
<figure><img src="../../.gitbook/assets/image (287).png" alt=""><figcaption><p>HSRPトラフィックダンプから抽出したMD5ハッシュ</p></figcaption></figure>

私は**John the Ripper**を使用してハッシュをクラックします。入力としてハッシュ自体を指定します。そして、**--wordlist**スイッチを使用して辞書のパスを指定します。
```
~/cisconightmare/exfiltrate$ john hsrp_hashes --wordlist=wordlistforbrute
```
<figure><img src="../../.gitbook/assets/image (203).png" alt=""><figcaption><p>HSRPドメインのパスワードがクラックされました</p></figcaption></figure>

その結果、HSRPドメインに入るためのキーである**endgame**を手に入れました。

### HSRPインジェクション（Loki）<a href="#6a2b" id="6a2b"></a>

同じLokiを使用してHSRPプロトコルを攻撃します。その中には、認証をバイパスするのに役立つキーインジェクション機能があります。以前のHSRPハイジャックのセクションで、HSRPドメインに関するすべての必要な情報を取得しました。

Lokiを起動します。

<figure><img src="../../.gitbook/assets/image (309).png" alt=""><figcaption><p>LokiがHSRP広告を検出しました</p></figcaption></figure>

攻撃を実施する前に、プロミスキャスモードに切り替えてトラフィックルーティングを許可することを忘れないでください。
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
次のアドレスを持つルーターを選択します：**10.10.100.100**、優先度は**200**です。**Secret**パラメータには、HSRPドメインから**クラックされたパスワード**を入力し、Gratuitous ARPを生成し、**Get IP**オプションを選択します。

<figure><img src="../../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (237).png" alt=""><figcaption></figcaption></figure>

**見てわかるように、アクティブなルーターは攻撃システムになりました。優先度の値は255です。**

**インジェクション後、HSRPドメインの仮想IPアドレスの値でネットワークインターフェースにセカンダリIPアドレスを作成する必要があります。また、24ビットのマスクを指定する必要があります。この方法で、正規のトラフィックはループバックされ、HSRPドメインで使用される仮想IPアドレスはホストのデフォルトゲートウェイアドレスです。**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
**私たちは、すべてのトラフィックを傍受するために、よく知られたソースNAT（マスカレーディング）を設定しました:**
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
**デフォルトルートを削除し、新しいルートを書き込みます。この新しいルートは、以前のアクティブルーター（アドレスは10.10.100.100です）を経由して通信を行います。ルーターのアクティブな役割を乗っ取ったにもかかわらず、ルーターは依然としてトラフィックをルーティングすることができます。**
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
**今、私たちは「中間者」となります。**[**net-creds.py**](https://github.com/DanMcInerney/net-creds)**を実行しましょう:**
```
~$ sudo python2 net-creds.py -i eth0
```
ユーティリティを実行した後、172.16.100.140のFTPサーバーへの認証試行を再現します。
```
~$ ftp 172.16.100.140
```
<figure><img src="../../.gitbook/assets/image (179).png" alt=""><figcaption></figcaption></figure>

その結果、FTPサーバーからクレデンシャルを取得します: **insomnia:betrayal**

これがHSRPドメインを攻撃し、トラフィックを傍受する方法です。基本的に、すべてはGLBPと同様です。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
