# Attaques GLBP & HSRP

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


## Vue d'ensemble du d√©tournement FHRP

### Comprendre le FHRP
Le First Hop Redundancy Protocol (FHRP) est une suite de protocoles assurant la r√©silience du r√©seau en combinant plusieurs routeurs physiques en une seule entit√© virtuelle. Cela am√©liore la distribution de charge et la tol√©rance aux pannes. Cisco Systems a introduit deux protocoles FHRP notables : GLBP et HSRP.

### D√©tails du protocole GLBP
D√©velopp√© par Cisco, le GLBP (Gateway Load Balancing Protocol) fonctionne au-dessus de la pile TCP/IP, utilisant UDP sur le port 3222 pour la communication. Les routeurs au sein d'un groupe GLBP envoient des paquets "hello" toutes les 3 secondes. L'absence de ces paquets pendant 10 secondes de la part d'un routeur indique sa d√©faillance. Cependant, ces param√®tres de temporisation sont ajustables.

### Fonctionnement et √©quilibrage de charge GLBP
Le GLBP permet le partage de charge entre plusieurs routeurs en utilisant une seule adresse IP virtuelle et diverses adresses MAC virtuelles. Chaque routeur du groupe participe au transfert des paquets. Le GLBP se distingue du HSRP/VRRP en offrant un v√©ritable √©quilibrage de charge, qui comprend :

- **D√©pendant de l'h√¥te :** Assure qu'un h√¥te re√ßoit la m√™me adresse MAC AVF, pr√©servant les configurations NAT.
- **Round-Robin :** Le mode par d√©faut o√π les adresses MAC AVF sont distribu√©es alternativement.
- **Round-Robin bas√© sur le poids :** √âquilibre la charge en fonction d'une m√©trique "Poids" pr√©d√©finie.

### R√¥les et terminologie du domaine GLBP
- **AVG (Active Virtual Gateway) :** Le routeur principal, distribuant les adresses MAC aux autres routeurs.
- **AVF (Active Virtual Forwarder) :** Un routeur g√©rant le trafic r√©seau.
- **Priorit√© GLBP :** D√©cide de l'AVG, avec une valeur par d√©faut de 100 et une plage de 1 √† 255.
- **Poids GLBP :** Indique le niveau de charge du routeur, ajustable manuellement ou via le suivi d'objet.
- **Adresse IP virtuelle GLBP :** Sert de passerelle par d√©faut pour les appareils connect√©s.

Pour la communication, le GLBP utilise l'adresse multicast r√©serv√©e 224.0.0.102 et le port UDP 3222. Les paquets "hello" sont envoy√©s toutes les 3 secondes, et les routeurs sont marqu√©s comme "morts" si un paquet n'est pas re√ßu dans les 10 secondes.

### M√©canisme d'attaque GLBP
Un attaquant peut devenir le routeur principal en envoyant un paquet GLBP avec la valeur de priorit√© la plus √©lev√©e (255). Cela peut conduire √† des attaques de DoS ou MITM, permettant l'interception ou la redirection du trafic.

### Ex√©cution d'une attaque GLBP avec Loki
[Loki](https://github.com/raizo62/loki_on_kali) peut r√©aliser une attaque GLBP en injectant un paquet avec la priorit√© et le poids d√©finis sur 255. Les √©tapes pr√©alables √† l'attaque impliquent de recueillir des informations telles que l'adresse IP virtuelle, la pr√©sence d'authentification et les valeurs de priorit√© des routeurs √† l'aide d'outils comme Wireshark.

√âtapes de l'attaque :
1. Passer en mode promiscuous et activer l'IP forwarding.
2. Identifier le routeur cible et r√©cup√©rer son IP.
3. G√©n√©rer un ARP Gratuit.
4. Injecter un paquet GLBP malveillant, se faisant passer pour l'AVG.
5. Assigner une adresse IP secondaire √† l'interface r√©seau de l'attaquant, refl√©tant l'adresse IP virtuelle GLBP.
6. Mettre en place un SNAT pour une visibilit√© compl√®te du trafic.
7. Ajuster le routage pour assurer la continuit√© de l'acc√®s √† Internet via le routeur AVG original.

En suivant ces √©tapes, l'attaquant se positionne comme un "homme au milieu", capable d'intercepter et d'analyser le trafic r√©seau, y compris les donn√©es non chiffr√©es ou sensibles.

Pour d√©monstration, voici les extraits de commande requis :
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Surveillance et interception du trafic peuvent √™tre r√©alis√©es en utilisant net-creds.py ou des outils similaires pour capturer et analyser les donn√©es circulant √† travers le r√©seau compromis.

### Explication passive du d√©tournement de HSRP avec d√©tails des commandes

#### Vue d'ensemble de HSRP (Hot Standby Router/Redundancy Protocol)
HSRP est un protocole propri√©taire de Cisco con√ßu pour la redondance de passerelle r√©seau. Il permet la configuration de plusieurs routeurs physiques en une seule unit√© logique avec une adresse IP partag√©e. Cette unit√© logique est g√©r√©e par un routeur principal responsable de la direction du trafic. Contrairement √† GLBP, qui utilise des m√©triques telles que la priorit√© et le poids pour l'√©quilibrage de charge, HSRP s'appuie sur un seul routeur actif pour la gestion du trafic.

#### R√¥les et terminologie dans HSRP
- **Routeur actif HSRP** : L'appareil agissant comme passerelle, g√©rant le flux de trafic.
- **Routeur de secours HSRP** : Un routeur de sauvegarde, pr√™t √† prendre le relais si le routeur actif √©choue.
- **Groupe HSRP** : Un ensemble de routeurs collaborant pour former un seul routeur virtuel r√©silient.
- **Adresse MAC HSRP** : Une adresse MAC virtuelle attribu√©e au routeur logique dans la configuration HSRP.
- **Adresse IP virtuelle HSRP** : L'adresse IP virtuelle du groupe HSRP, agissant comme passerelle par d√©faut pour les appareils connect√©s.

#### Versions de HSRP
HSRP existe en deux versions, HSRPv1 et HSRPv2, se diff√©renciant principalement par la capacit√© du groupe, l'utilisation d'IP multicast et la structure de l'adresse MAC virtuelle. Le protocole utilise des adresses IP multicast sp√©cifiques pour l'√©change d'informations de service, avec des paquets Hello envoy√©s toutes les 3 secondes. Un routeur est pr√©sum√© inactif si aucun paquet n'est re√ßu dans un intervalle de 10 secondes.

#### M√©canisme d'attaque HSRP
Les attaques HSRP impliquent de prendre de force le r√¥le du routeur actif en injectant une valeur de priorit√© maximale. Cela peut conduire √† une attaque de type Man-In-The-Middle (MITM). Les √©tapes pr√©alables essentielles √† l'attaque comprennent la collecte de donn√©es sur la configuration HSRP, qui peut √™tre r√©alis√©e en utilisant Wireshark pour l'analyse du trafic.

#### √âtapes pour contourner l'authentification HSRP
1. Sauvegardez le trafic r√©seau contenant les donn√©es HSRP dans un fichier .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrayez les hachages MD5 du fichier .pcap en utilisant hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Cassez les hachages MD5 en utilisant John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ex√©cution de l'injection HSRP avec Loki**

1. Lancez Loki pour identifier les annonces HSRP.
2. R√©glez l'interface r√©seau en mode promiscuous et activez le transfert IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Utilisez Loki pour cibler le routeur sp√©cifique, entrez le mot de passe HSRP craqu√© et effectuez les configurations n√©cessaires pour vous faire passer pour le routeur actif.
4. Apr√®s avoir obtenu le r√¥le de routeur actif, configurez votre interface r√©seau et les tables IP pour intercepter le trafic l√©gitime.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifiez la table de routage pour acheminer le trafic via l'ancien routeur actif.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Utilisez net-creds.py ou un utilitaire similaire pour capturer les identifiants √† partir du trafic intercept√©.
```shell
sudo python2 net-creds.py -i eth0
```

L'ex√©cution de ces √©tapes place l'attaquant dans une position pour intercepter et manipuler le trafic, de mani√®re similaire √† la proc√©dure de d√©tournement de GLBP. Cela met en √©vidence la vuln√©rabilit√© dans les protocoles de redondance comme HSRP et la n√©cessit√© de mesures de s√©curit√© robustes.


# R√©f√©rences
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs exclusifs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
