# Attaques GLBP & HSRP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Cette page a √©t√© copi√©e depuis** [**https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9**](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)\*\*\*\*

## Piratage FHRP <a href="#6196" id="6196"></a>

### Qu'est-ce que FHRP ? <a href="#b12d" id="b12d"></a>

FHRP (First Hop Redundancy Protocol) est une classe de protocoles r√©seau con√ßus pour cr√©er un syst√®me de routage redondant √† chaud. Avec FHRP, des routeurs physiques peuvent √™tre combin√©s en un seul dispositif logique, ce qui augmente la tol√©rance aux pannes et aide √† r√©partir la charge.

**Les ing√©nieurs de Cisco Systems ont d√©velopp√© deux protocoles FHRP, GLBP et HSRP, que je vais vous pr√©senter ci-dessous.**

### Protocole GLBP <a href="#8a26" id="8a26"></a>

**D√©velopp√© par les ing√©nieurs de Cisco Systems.** Comme HSRP, ce protocole est impl√©ment√© sur la pile de protocoles TCP/IP, c'est pourquoi le protocole de couche de transport UDP sous le num√©ro de port 3222 est utilis√© pour la traduction des informations de service. Les routeurs GLBP au sein du m√™me groupe logique √©changent des paquets "hello" sp√©ciaux toutes les 3 secondes, mais si un routeur GLBP dans le m√™me groupe n'a pas re√ßu de paquet hello de son voisin GLBP dans les 10 secondes, il le reconna√Æt comme "mort". Cependant, les valeurs de minuterie peuvent √™tre configur√©es en fonction des besoins de l'administrateur.

### La structure et le fonctionnement de GLBP <a href="#3bb3" id="3bb3"></a>

GLBP permet le partage de charge entre plusieurs routeurs (passerelles) en utilisant une adresse IP virtuelle et plusieurs adresses MAC virtuelles. Chaque h√¥te est configur√© avec la m√™me adresse IP virtuelle et tous les routeurs du groupe virtuel participent √† la transmission de paquets.

Fonctionne de mani√®re tr√®s diff√©rente des protocoles HSRP et VRRP car il utilise de vrais m√©canismes de r√©partition de charge, que je vais d√©crire ci-dessous :

**D√©pendant de l'h√¥te.** Un type de r√©partition de charge utilis√© sur un r√©seau o√π il y a une NAT. Le mode D√©pendant de l'h√¥te garantit que l'h√¥te r√©cup√©rera la m√™me adresse MAC de l'appareil AVF qui a √©t√© utilis√© √† un moment ant√©rieur, de sorte que la NAT configur√©e pour l'h√¥te ne sera pas rompue.

**Round-Robin.** Dans ce mode, l'appareil AVG distribue les adresses MAC aux membres AVF de mani√®re alternative. C'est le m√©canisme utilis√© par d√©faut.

**Round-robin bas√© sur le poids.** R√©partition de charge bas√©e sur une m√©trique sp√©ciale "Poids".

### R√¥les dans le domaine GLBP et terminologie <a href="#febd" id="febd"></a>

**AVG (Active Virtual Gateway)** - le routeur avec le r√¥le principal est √©galement responsable de la distribution des adresses MAC aux autres routeurs du m√™me groupe GLBP. Une sorte de "patron" dans le domaine GLBP. L'AVG indique aux autres routeurs comment distribuer le trafic en distribuant des adresses MAC lorsqu'une demande ARP arrive. Il convient de noter qu'il ne peut y avoir qu'un seul routeur AVG dans un domaine GLBP, mais il peut √©galement √™tre un membre AVF.

**AVF (Active Virtual Forwarder)** - un routeur dans un groupe GLBP qui g√®re le trafic dans le r√©seau.

**Priorit√© GLBP** - La valeur de priorit√© qui d√©termine quel routeur dans le groupe GLBP sera l'AVG. La valeur par d√©faut est 100 (la plage de priorit√© peut √™tre de 1 √† 255). Elle peut √™tre d√©finie manuellement, c'est-√†-dire que l'ing√©nieur r√©seau d√©termine lui-m√™me quel routeur sera le "sup√©rieur" et lequel sera l'esclave. Plus la priorit√© est √©lev√©e, plus il est probable que le routeur obtiendra le r√¥le AVG. En g√©n√©ral, le r√¥le AVG est attribu√© aux routeurs les plus puissants.

**Poids GLBP** - La valeur du soi-disant poids GLBP d'un routeur dans un groupe GLBP. Le poids GLBP d√©finit le niveau de charge du routeur. Cette valeur est "flottante" et peut varier en fonction de la charge sur le canal physique (le m√©canisme de suivi d'objet est impliqu√©), mais elle peut √©galement √™tre configur√©e manuellement.

**Adresse IP virtuelle GLBP** - l'adresse IP virtuelle dans le domaine GLBP. Utilis√©e comme adresse de passerelle par d√©faut pour les h√¥tes l√©gitimes.

GLBP utilise l'adresse IP de diffusion de groupe r√©serv√©e **224.0.0.102** et le num√©ro de port du protocole de couche de transport UDP **3222** pour envoyer et traiter des informations de service. Des paquets GLBP Hello sp√©ciaux sont envoy√©s toutes les **3 secondes**. Si le routeur GLBP n'a pas re√ßu de paquet hello d'un voisin dans les **10 secondes**, le voisin sera consid√©r√© comme "mort" et sortira du domaine GLBP.

### M√©canisme d'attaque GLBP <a href="#3260" id="3260"></a>

La technique de cette attaque r√©seau consiste √† imposer votre appareil en tant que routeur principal **en injectant un paquet GLBP malveillant avec une valeur de priorit√© maximale.** **L
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
S√©lectionnez le routeur √† l'adresse IP **10.10.100.100** et activez l'option **Obtenir une adresse IP**. Vous devez √©galement g√©n√©rer une **ARP gratuit**.

<figure><img src="../../.gitbook/assets/image (222).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (161) (2).png" alt=""><figcaption><p>La structure d'une injection GLBP malveillante</p></figcaption></figure>

Comme vous pouvez le voir, le routeur AVG pr√©tend maintenant √™tre un syst√®me d'attaque. **La valeur de priorit√© est de 255, la valeur de poids est de 255, c'est-√†-dire le maximum.**

**Apr√®s avoir effectu√© l'injection, nous devons cr√©er une adresse IP secondaire sur notre interface r√©seau avec la valeur de l'adresse IP virtuelle dans le domaine GLBP. Vous devez √©galement d√©finir un masque de 24 bits.**

**De cette fa√ßon, le trafic l√©gitime sera renvoy√© vers nous, car l'adresse IP virtuelle utilis√©e dans le domaine GLBP est l'adresse de passerelle par d√©faut pour les h√¥tes :**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
Pour voir non seulement le trafic entrant mais aussi le trafic sortant, nous avons besoin d'une petite r√®gle pour **SNAT (masquerading) :**
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
Nous devons √©galement supprimer la route par d√©faut sur notre machine et en √©crire une nouvelle qui passera par l'ancien routeur AVG (l'adresse est 10.10.100.100). M√™me si nous avons d√©tourn√© le r√¥le AVG du routeur, il pourra toujours acheminer le trafic.
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
C'est bon, **nous sommes maintenant l'homme du milieu**! Je vais ex√©cuter l'outil [**net-creds.py**](https://github.com/DanMcInerney/net-creds) pour analyser le trafic √† la recherche de donn√©es importantes. **Par exemple, le trafic FTP non crypt√© ou les hachages NTLM.**
```
~$ sudo python2 net-creds.py -i eth0
```
Apr√®s avoir ex√©cut√© l'utilitaire, je vais essayer de lire le partage SMB avec l'adresse IP **172.16.100.70**, qui se trouve derri√®re les routeurs GLBP.
```
user@Boundless:~$ smbclient -L \\172.16.100.70 --user mercy
```
<figure><img src="../../.gitbook/assets/image (243).png" alt=""><figcaption></figcaption></figure>

**Voici comment vous pouvez intercepter le trafic au sein du r√©seau en attaquant les domaines GLBP.**

### Piratage HSRP <a href="#595f" id="595f"></a>

**HSRP (Hot Standby Router/Redundancy Protocol) ‚Äî** est un protocole propri√©taire de Cisco qui permet la redondance de la passerelle r√©seau. L'id√©e g√©n√©rale est de combiner plusieurs routeurs physiques en un seul routeur logique avec une adresse IP commune. Cette adresse du routeur virtuel sera assign√©e √† l'interface du routeur avec le r√¥le principal, et ce dernier, √† son tour, se chargera de la transmission du trafic. Dans le domaine HSRP, la t√¢che de g√©rer tout le trafic incombe pr√©cis√©ment au routeur avec le r√¥le principal, contrairement √† GLBP, o√π l'√©quilibrage de charge en utilisant des m√©triques sp√©ciales (priorit√© et poids) a √©t√© propos√©.

### R√¥les dans le domaine HSRP et terminologie <a href="#4185" id="4185"></a>

**Routeur actif HSRP** ‚Äî un dispositif qui agit en tant que routeur virtuel et assure la transmission du trafic des r√©seaux sources aux r√©seaux de destination.\
**Routeur de secours HSRP** ‚Äî un dispositif qui agit en tant que routeur de secours, attendant que le routeur actif tombe en panne. Lorsque le routeur actif primaire tombe en panne, le routeur de secours prendra le r√¥le principal et assumera les fonctions du routeur actif.\
**Groupe HSRP** ‚Äî un groupe de dispositifs qui assure le fonctionnement et la tol√©rance aux pannes d'un routeur logique.\
**Adresse MAC HSRP** ‚Äî l'adresse MAC virtuelle du routeur logique dans le domaine HSRP.\
**Adresse IP virtuelle HSRP** ‚Äî il s'agit d'une adresse IP virtuelle sp√©ciale dans le groupe HSRP. Cette adresse IP sera la passerelle par d√©faut pour les h√¥tes finaux, utilis√©e sur le routeur logique lui-m√™me.

### Versions du protocole HSRP <a href="#eda3" id="eda3"></a>

Le protocole HSRP a deux versions ‚Äî HSRPv1 et HSRPv2. Ils diff√®rent selon les param√®tres suivants :

* **Le nombre de groupes logiques possibles.** HSRPv1 peut avoir jusqu'√† 255 groupes. HSRPv2 peut avoir jusqu'√† 4096 groupes.
* **Adresse IP multicast.** HSRPv1 utilise l'adresse IP **224.0.0.2** pour envoyer des informations de service, et HSRPv2 utilise **224.0.0.102**.
* **Adresse MAC virtuelle.** HSRPv1 utilise **00:00:0C:07:AC:XX** comme adresse MAC virtuelle. HSRPv2 a une adresse MAC virtuelle de **00:00:0C:9F:FX:XX** (o√π XX est le num√©ro de groupe HSRP).

HSRP utilise l'adresse IP r√©serv√©e **224.0.0.2** ou **224.0.0.102** (selon la version de HSRP) et le protocole de couche de transport UDP avec le num√©ro de port **1985** pour diffuser et traiter les informations de service. Des paquets HSRP Hello sp√©ciaux sont envoy√©s **toutes les 3 secondes.** Si le routeur HSRP ne re√ßoit pas de paquet hello d'un voisin **dans les 10 secondes**, le voisin sera consid√©r√© comme "mort" et sortira du domaine HSRP.

### M√©canisme d'attaque HSRP <a href="#d4a3" id="d4a3"></a>

**C'est exactement la m√™me chose que le piratage GLBP. Nous devons effectuer une injection HSRP malveillante avec une valeur de priorit√© maximale de 255.** Cela nous permet de prendre le r√¥le du routeur actif, ouvrant la porte √† une attaque **MITM**. Mais encore une fois, nous devons examiner les informations suivantes avant de mener l'attaque :

* **L'adresse IP virtuelle utilis√©e dans le domaine HSRP**
* **La pr√©sence d'authentification**
* **Valeur des priorit√©s des routeurs**

Nous pouvons extraire ces informations en analysant le trafic HSRP. **Utilisons Wireshark.**

Comme vous pouvez le voir sur la capture d'√©cran, le processus HSRP implique seulement deux routeurs avec les adresses 10.10.100.100 et 10.10.100.200

<figure><img src="../../.gitbook/assets/image (181).png" alt=""><figcaption><p>HSRP Ads</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (212).png" alt=""><figcaption><p>Premier routeur HSRP</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (304).png" alt=""><figcaption><p>Deuxi√®me routeur HSRP</p></figcaption></figure>

Sur la base de l'analyse du trafic HSRP, nous avons ce qui suit :

* **Une mauvaise configuration a √©t√© d√©tect√©e dans le param√®tre de priorit√©. Le routeur actif est consid√©r√© comme un routeur HSRP avec une priorit√© de 200, c'est-√†-dire que nous avons un vecteur pour le piratage HSRP**
* **l'adresse IP virtuelle utilis√©e dans le domaine HSRP est 10.10.100.254**
* **L'authentification MD5 est utilis√©e**

Avoir une authentification dans le domaine nous lie les mains, mais je vais arranger √ßa.

### Contournement de l'authentification HSRP <a href="#d9fd" id="d9fd"></a>

Enregistrez le dump de trafic HSRP au format **.pcap**, afin que l'exfiltrateur puisse extraire correctement les hachages MD5 du dump. J'utiliserai **hsrp2john.py** comme exfiltrateur :
```
~/cisconightmare/exfiltrate$ python2 hsrp2john.py hsrp_with_authentication.pcap
```
<figure><img src="../../.gitbook/assets/image (287).png" alt=""><figcaption><p>Hashes MD5 extraites de la capture de trafic HSRP</p></figcaption></figure>

Je vais casser les hashes avec **John the Ripper**, en sp√©cifiant les hashes eux-m√™mes en tant qu'entr√©e. Et avec l'option **--wordlist**, je vais sp√©cifier le chemin d'acc√®s au dictionnaire :
```
~/cisconightmare/exfiltrate$ john hsrp_hashes --wordlist=wordlistforbrute
```
<figure><img src="../../.gitbook/assets/image (203).png" alt=""><figcaption><p>Mot de passe de domaine HSRP craqu√©</p></figcaption></figure>

En cons√©quence, nous avons une cl√© pour entrer dans le domaine HSRP - **endgame**.

### Injection HSRP (Loki) <a href="#6a2b" id="6a2b"></a>

Je vais utiliser le m√™me Loki pour attaquer le protocole HSRP. Entre autres, il dispose d'une fonctionnalit√© d'injection de cl√©, qui nous aide √† contourner l'authentification. Plus t√¥t, dans la section de d√©tournement HSRP, nous avons obtenu toutes les informations n√©cessaires sur le domaine HSRP.

D√©marrage de Loki.

<figure><img src="../../.gitbook/assets/image (309).png" alt=""><figcaption><p>Loki a d√©tect√© des annonces HSRP</p></figcaption></figure>

N'oubliez pas de passer en mode promiscuous et d'autoriser le routage du trafic avant de proc√©der √† l'attaque :
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
S√©lectionnez le routeur ayant l'adresse **10.10.100.100** et une priorit√© de **200**. En tant que param√®tre **Secret**, **entrez le mot de passe craqu√©** du domaine HSRP, g√©n√©rez une ARP gratuit et s√©lectionnez l'option **Get IP**.

<figure><img src="../../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (237).png" alt=""><figcaption></figcaption></figure>

**Comme nous pouvons le voir, le routeur actif est maintenant notre syst√®me d'attaque. La valeur de priorit√© est de 255.**

**Apr√®s l'injection, nous devons cr√©er une adresse IP secondaire sur notre interface r√©seau avec la valeur de l'adresse IP virtuelle dans le domaine HSRP. Vous devez √©galement sp√©cifier un masque de 24 bits. De cette mani√®re, le trafic l√©gitime sera renvoy√© vers nous, car l'adresse IP virtuelle utilis√©e dans le domaine HSRP est l'adresse de passerelle par d√©faut pour les h√¥tes.**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
Nous avons mis en place le NAT source bien connu (masquerading) pour intercepter tout le trafic :
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
Nous supprimons la route par d√©faut sur notre machine et √©crivons une nouvelle route qui passera par l'ancien routeur actif (son adresse est 10.10.100.100). M√™me si nous avons d√©tourn√© le r√¥le actif du routeur, il pourra toujours acheminer le trafic.
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
**Maintenant, nous sommes l'¬´ homme du milieu ¬ª. Ex√©cutons** [**net-creds.py**](https://github.com/DanMcInerney/net-creds)**:**
```
~$ sudo python2 net-creds.py -i eth0
```
Apr√®s avoir ex√©cut√© l'utilitaire, je vais reproduire une tentative d'authentification sur le serveur FTP √† l'adresse 172.16.100.140 :
```
~$ ftp 172.16.100.140
```
En cons√©quence, nous obtenons des identifiants du serveur FTP : **insomnia:betrayal**

C'est ainsi que vous pouvez attaquer le domaine HSRP et intercepter le trafic. Fondamentalement, tout est similaire √† GLBP.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
