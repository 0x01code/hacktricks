# Ataques GLBP & HSRP

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>


## Vis√£o Geral do Sequestro FHRP

### Compreendendo FHRP
O Protocolo de Redund√¢ncia do Primeiro Salto (FHRP) √© um conjunto de protocolos que garante a resili√™ncia da rede combinando v√°rios roteadores f√≠sicos em uma √∫nica entidade virtual. Isso melhora a distribui√ß√£o de carga e a toler√¢ncia a falhas. A Cisco Systems introduziu dois protocolos FHRP not√°veis: GLBP e HSRP.

### Detalhes do Protocolo GLBP
Desenvolvido pela Cisco, o GLBP (Protocolo de Balanceamento de Carga de Gateway) opera sobre a pilha TCP/IP, usando UDP na porta 3222 para comunica√ß√£o. Roteadores dentro de um grupo GLBP enviam pacotes "hello" a cada 3 segundos. A aus√™ncia desses pacotes por 10 segundos de um roteador indica sua falha. No entanto, essas configura√ß√µes de temporizador s√£o ajust√°veis.

### Opera√ß√£o e Balanceamento de Carga do GLBP
O GLBP permite o compartilhamento de carga entre v√°rios roteadores usando um √∫nico IP virtual e v√°rios endere√ßos MAC virtuais. Cada roteador no grupo participa do encaminhamento de pacotes. O GLBP difere do HSRP/VRRP ao oferecer um verdadeiro balanceamento de carga, que inclui:

- **Dependente do Host:** Garante que um host receba o mesmo endere√ßo MAC AVF, preservando as configura√ß√µes NAT.
- **Round-Robin:** O modo padr√£o onde os endere√ßos MAC AVF s√£o distribu√≠dos alternadamente.
- **Round-Robin Baseado em Peso:** Equilibra a carga com base em uma m√©trica de "Peso" predefinida.

### Fun√ß√µes e Terminologia do Dom√≠nio GLBP
- **AVG (Gateway Virtual Ativo):** O roteador principal, distribuindo endere√ßos MAC para outros roteadores.
- **AVF (Encaminhador Virtual Ativo):** Um roteador que lida com o tr√°fego de rede.
- **Prioridade GLBP:** Decide o AVG, com um padr√£o de 100 e uma faixa de 1 a 255.
- **Peso GLBP:** Indica o n√≠vel de carga do roteador, ajust√°vel manualmente ou via Rastreamento de Objetos.
- **Endere√ßo IP Virtual GLBP:** Age como o gateway padr√£o para dispositivos conectados.

Para comunica√ß√£o, o GLBP usa o endere√ßo multicast reservado 224.0.0.102 e a porta UDP 3222. Pacotes "hello" s√£o enviados a cada 3 segundos, e os roteadores s√£o marcados como "mortos" se um pacote n√£o for recebido dentro de 10 segundos.

### Mecanismo de Ataque GLBP
Um atacante pode se tornar o roteador principal enviando um pacote GLBP com o valor de prioridade mais alto (255). Isso pode levar a ataques de DoS ou MITM, permitindo a intercepta√ß√£o ou redirecionamento de tr√°fego.

### Executando um Ataque GLBP com Loki
[Loki](https://github.com/raizo62/loki_on_kali) pode realizar um ataque GLBP injetando um pacote com prioridade e peso definidos como 255. As etapas pr√©-ataque envolvem a coleta de informa√ß√µes como o endere√ßo IP virtual, presen√ßa de autentica√ß√£o e valores de prioridade do roteador usando ferramentas como Wireshark.

Passos do Ataque:
1. Alterar para o modo prom√≠scuo e ativar o encaminhamento IP.
2. Identificar o roteador alvo e recuperar seu IP.
3. Gerar um ARP Gratuito.
4. Injetar um pacote GLBP malicioso, se passando pelo AVG.
5. Atribuir um endere√ßo IP secund√°rio √† interface de rede do atacante, espelhando o IP virtual do GLBP.
6. Implementar SNAT para visibilidade total do tr√°fego.
7. Ajustar o roteamento para garantir o acesso cont√≠nuo √† internet atrav√©s do roteador AVG original.

Seguindo esses passos, o atacante se posiciona como um "homem no meio", capaz de interceptar e analisar o tr√°fego de rede, incluindo dados n√£o criptografados ou sens√≠veis.

Para demonstra√ß√£o, aqui est√£o os trechos de comando necess√°rios:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
### Explica√ß√£o Passiva do Sequestro de HSRP com Detalhes de Comando

#### Vis√£o Geral do HSRP (Protocolo de Redund√¢ncia/Roteador em Espera)
HSRP √© um protocolo propriet√°rio da Cisco projetado para redund√¢ncia de gateway de rede. Ele permite a configura√ß√£o de v√°rios roteadores f√≠sicos em uma unidade l√≥gica √∫nica com um endere√ßo IP compartilhado. Essa unidade l√≥gica √© gerenciada por um roteador prim√°rio respons√°vel por direcionar o tr√°fego. Ao contr√°rio do GLBP, que usa m√©tricas como prioridade e peso para balanceamento de carga, o HSRP depende de um √∫nico roteador ativo para o gerenciamento de tr√°fego.

#### Fun√ß√µes e Terminologia no HSRP
- **Roteador Ativo do HSRP**: O dispositivo que atua como gateway, gerenciando o fluxo de tr√°fego.
- **Roteador em Espera do HSRP**: Um roteador de backup, pronto para assumir se o roteador ativo falhar.
- **Grupo HSRP**: Um conjunto de roteadores colaborando para formar um √∫nico roteador virtual resiliente.
- **Endere√ßo MAC do HSRP**: Um endere√ßo MAC virtual atribu√≠do ao roteador l√≥gico na configura√ß√£o do HSRP.
- **Endere√ßo IP Virtual do HSRP**: O endere√ßo IP virtual do grupo HSRP, atuando como gateway padr√£o para dispositivos conectados.

#### Vers√µes do HSRP
O HSRP possui duas vers√µes, HSRPv1 e HSRPv2, diferindo principalmente em capacidade de grupo, uso de IP multicast e estrutura de endere√ßo MAC virtual. O protocolo utiliza endere√ßos IP multicast espec√≠ficos para a troca de informa√ß√µes de servi√ßo, com pacotes Hello enviados a cada 3 segundos. Um roteador √© considerado inativo se nenhum pacote for recebido dentro de um intervalo de 10 segundos.

#### Mecanismo de Ataque do HSRP
Os ataques do HSRP envolvem assumir √† for√ßa o papel do Roteador Ativo injetando um valor de prioridade m√°ximo. Isso pode levar a um ataque de Homem-no-Meio (MITM). Etapas essenciais pr√©-ataque incluem coletar dados sobre a configura√ß√£o do HSRP, o que pode ser feito usando o Wireshark para an√°lise de tr√°fego.

#### Etapas para Bypassing da Autentica√ß√£o do HSRP
1. Salve o tr√°fego de rede contendo dados do HSRP como um arquivo .pcap.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extraia hashes MD5 do arquivo .pcap usando hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Quebre os hashes MD5 usando o John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Executando a Inje√ß√£o de HSRP com Loki**

1. Inicie o Loki para identificar an√∫ncios do HSRP.
2. Defina a interface de rede para o modo prom√≠scuo e ative o encaminhamento de IP.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Use o Loki para mirar o roteador espec√≠fico, insira a senha do HSRP quebrada e fa√ßa as configura√ß√µes necess√°rias para se passar pelo Roteador Ativo.
4. Ap√≥s obter o papel de Roteador Ativo, configure sua interface de rede e tabelas de IP para interceptar o tr√°fego leg√≠timo.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. Modifique a tabela de roteamento para rotear o tr√°fego atrav√©s do antigo Roteador Ativo.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Use net-creds.py ou uma ferramenta similar para capturar credenciais do tr√°fego interceptado.
```shell
sudo python2 net-creds.py -i eth0
```

Executar essas etapas coloca o atacante em uma posi√ß√£o para interceptar e manipular o tr√°fego, semelhante ao procedimento para o sequestro de GLBP. Isso destaca a vulnerabilidade em protocolos de redund√¢ncia como o HSRP e a necessidade de medidas de seguran√ßa robustas.


# Refer√™ncias
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
