# Ataques GLBP y HSRP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Consigue el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Esta p√°gina fue copiada de** [**https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9**](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)\*\*\*\*

## Secuestro de FHRP <a href="#6196" id="6196"></a>

### ¬øQu√© es FHRP? <a href="#b12d" id="b12d"></a>

FHRP (Protocolo de redundancia de primer salto) es una clase de protocolos de red dise√±ados para crear un sistema de enrutamiento redundante en caliente. Con FHRP, los routers f√≠sicos se pueden combinar en un solo dispositivo l√≥gico, lo que aumenta la tolerancia a fallos y ayuda a distribuir la carga.

**Los ingenieros de Cisco Systems han desarrollado dos protocolos FHRP, GLBP y HSRP, que demostrar√© a continuaci√≥n.**

### Protocolo GLBP <a href="#8a26" id="8a26"></a>

**Desarrollado por ingenieros de Cisco Systems.** Al igual que HSRP, este protocolo se implementa en la parte superior de la pila de protocolos TCP/IP, por lo que se utiliza el protocolo de capa de transporte UDP en el puerto n√∫mero 3222 para la traducci√≥n de la informaci√≥n del servicio. Los routers GLBP dentro del mismo grupo l√≥gico intercambian paquetes especiales "hello" cada 3 segundos, pero si un router GLBP dentro del mismo grupo no ha recibido un paquete hello de su vecino GLBP en 10 segundos, lo reconoce como "muerto". Sin embargo, los valores del temporizador se pueden configurar seg√∫n las necesidades del administrador.

### La estructura y mec√°nica de GLBP <a href="#3bb3" id="3bb3"></a>

GLBP proporciona el uso compartido de carga a m√∫ltiples routers (gateways) utilizando una direcci√≥n IP virtual y m√∫ltiples direcciones MAC virtuales. Cada host est√° configurado con la misma direcci√≥n IP virtual y todos los routers en el grupo virtual participan en la transmisi√≥n de paquetes.

Funciona de manera muy diferente a los protocolos HSRP y VRRP porque utiliza mecanismos de equilibrio de carga reales, que se denotan a continuaci√≥n:

**Dependiente del host.** Un tipo de equilibrio de carga utilizado en una red donde hay NAT. Host-Dependent garantiza el hecho de que el host recibir√° la misma direcci√≥n MAC del dispositivo AVF que se utiliz√≥ en un momento anterior, por lo que el NAT configurado para el host no se romper√°.

**Round-Robin.** En este modo, el dispositivo AVG distribuye direcciones MAC a los miembros AVF alternativamente. Este es el mecanismo utilizado de forma predeterminada.

**Round-robin basado en peso**. Equilibrio de carga basado en una m√©trica especial de "peso".

### Roles en el dominio GLBP y terminolog√≠a <a href="#febd" id="febd"></a>

**AVG (Gateway virtual activo)** - el router con el papel principal tambi√©n es responsable de distribuir direcciones MAC a otros routers dentro del mismo grupo GLBP. Una especie de "jefe" en el dominio GLBP. AVG le dice a los otros routers c√≥mo distribuir el tr√°fico entregando direcciones MAC cuando llega una solicitud ARP. Vale la pena se√±alar que solo puede haber un router AVG en un dominio GLBP, pero tambi√©n puede ser un miembro AVF.

**AVF (Reenviador virtual activo)** - un router en un grupo GLBP que maneja el tr√°fico en la red.

**Prioridad GLBP** - El valor de prioridad que determina qu√© router en el grupo GLBP ser√° el AVG. El valor predeterminado es 100 (el rango de prioridad puede ser de 1 a 255). Se puede establecer manualmente, es decir, el ingeniero de red determina qu√© router ser√° el "superior" y cu√°l ser√° el "esclavo". Cuanto mayor sea la prioridad, es m√°s probable que el router obtenga el papel de AVG. Por lo general, el papel de AVG se otorga a routers m√°s potentes.

**Peso GLBP** - El valor del llamado Peso GLBP de un router en un grupo GLBP. El peso GLBP define el nivel de carga del router. Este valor es "flotante" y puede variar seg√∫n la carga en el canal f√≠sico (se involucra el mecanismo de seguimiento de objetos), pero tambi√©n se puede configurar manualmente.

**Direcci√≥n IP virtual GLBP** - la direcci√≥n IP virtual en el dominio GLBP. Se utiliza como direcci√≥n de puerta de enlace predeterminada para hosts leg√≠timos.

GLBP utiliza la direcci√≥n IP de env√≠o de grupo reservada **224.0.0.102** y el n√∫mero de puerto del protocolo de capa de transporte UDP **3222** para enviar y procesar informaci√≥n del servicio. Se env√≠an paquetes especiales de GLBP Hello cada **3 segundos**. Si el router GLBP no ha recibido un paquete hello de un vecino dentro de **10 segundos**, se considerar√° que el vecino est√° "muerto" y se eliminar√° del dominio GLBP.

### Mecanismo de ataque GLBP <a href="#3260" id="3260"></a>

La t√©cnica de este ataque de red es imponer su dispositivo como el enrutador principal **inyectando un paquete GLBP malicioso con un valor de prioridad m√°ximo.** **La explotaci√≥n exitosa conduce a un ataque DoS o MITM en el que puede interceptar el tr√°fico dentro de la red, realizar una redirecci√≥n o causar un DoS al asumir el papel de enrutador AVG.** Todo lo que tienes que hacer es construir un paquete GLBP con el valor de prioridad m√°s alto de 255 y
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
Selecciona el router con direcci√≥n IP **10.10.100.100** y activa la opci√≥n **Obtener IP**. Tambi√©n necesitas generar un **ARP Gratuito**.

<figure><img src="../../.gitbook/assets/image (222).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (161) (2).png" alt=""><figcaption><p>La estructura de una inyecci√≥n maliciosa de GLBP</p></figcaption></figure>

Como puedes ver, el router AVG ahora est√° fingiendo ser un sistema atacante. **El valor de prioridad es 255, el valor de peso es 255, es decir, el m√°ximo.**

**Despu√©s de realizar la inyecci√≥n, necesitamos crear una direcci√≥n IP secundaria en nuestra interfaz de red con el valor de la direcci√≥n IP virtual en el dominio GLBP. Tambi√©n necesitas establecer una m√°scara de 24 bits.**

**De esta manera, el tr√°fico leg√≠timo se redirigir√° hacia nosotros, porque la direcci√≥n IP virtual utilizada en el dominio GLBP es la direcci√≥n de la puerta de enlace predeterminada para los hosts:**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
Para ver no solo el tr√°fico entrante sino tambi√©n el tr√°fico saliente, necesitamos una peque√±a regla para **SNAT (enmascaramiento):**
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
Tambi√©n necesitamos eliminar la ruta predeterminada en nuestra m√°quina y escribir una nueva que pase a trav√©s del antiguo router AVG (la direcci√≥n es 10.10.100.100). Aunque hayamos secuestrado el rol AVG del router, a√∫n podr√° enrutar el tr√°fico.
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
¬°Listo, ahora somos el "hombre en el medio"! Ejecutar√© la herramienta [**net-creds.py**](https://github.com/DanMcInerney/net-creds) para analizar el tr√°fico y buscar datos importantes. Por ejemplo, tr√°fico FTP no encriptado o hashes NTLM.
```
~$ sudo python2 net-creds.py -i eth0
```
Despu√©s de ejecutar la utilidad, intentar√© leer el recurso compartido SMB con la direcci√≥n IP **172.16.100.70**, que se encuentra detr√°s de los routers GLBP.
```
user@Boundless:~$ smbclient -L \\172.16.100.70 --user mercy
```
<figure><img src="../../.gitbook/assets/image (243).png" alt=""><figcaption></figcaption></figure>

**As√≠ es como se puede interceptar el tr√°fico dentro de la red atacando los dominios GLBP.**

### Secuestro de HSRP <a href="#595f" id="595f"></a>

**HSRP (Hot Standby Router/Redundancy Protocol) ‚Äî** es un protocolo propietario de Cisco que permite la redundancia de la puerta de enlace de la red. La idea general es combinar varios routers f√≠sicos en un solo router l√≥gico con una direcci√≥n IP com√∫n. Esta direcci√≥n del router virtual se asignar√° a la interfaz del router con el rol principal, y este √∫ltimo, a su vez, se encargar√° del reenv√≠o de tr√°fico. En el dominio HSRP, la tarea de manejar todo el tr√°fico recae precisamente en el router con el rol principal, a diferencia de GLBP, donde se propuso el equilibrio de carga mediante el uso de m√©tricas especiales (prioridad y peso).

### Roles en el dominio HSRP y terminolog√≠a <a href="#4185" id="4185"></a>

**Router activo de HSRP** ‚Äî un dispositivo que act√∫a como un router virtual y proporciona el reenv√≠o de tr√°fico desde redes de origen a redes de destino.\
**Router en espera de HSRP** ‚Äî un dispositivo que act√∫a como un router en espera, esperando que falle el router activo. Cuando falla el router activo principal, el router en espera tomar√° el rol principal y asumir√° las funciones del router activo.\
**Grupo de HSRP** ‚Äî un grupo de dispositivos que asegura el funcionamiento y la tolerancia a fallos de un router l√≥gico.\
**Direcci√≥n MAC de HSRP** ‚Äî la direcci√≥n MAC virtual del router l√≥gico en el dominio HSRP.\
**Direcci√≥n IP virtual de HSRP** ‚Äî Esta es una direcci√≥n IP virtual especial en el grupo HSRP. Esta direcci√≥n IP ser√° la puerta de enlace predeterminada para los hosts finales, utilizada en el propio router l√≥gico.

### Versiones del protocolo HSRP <a href="#eda3" id="eda3"></a>

El protocolo HSRP tiene dos versiones: HSRPv1 y HSRPv2. Difieren en los siguientes par√°metros:

* **El n√∫mero de grupos l√≥gicos posibles.** HSRPv1 puede tener hasta 255 grupos. HSRPv2 puede tener hasta 4096 grupos.
* **Direcci√≥n IP multicast.** HSRPv1 utiliza la direcci√≥n IP **224.0.0.2** para enviar informaci√≥n de servicio, y HSRPv2 utiliza **224.0.0.102**.
* **Direcci√≥n MAC virtual.** HSRPv1 utiliza **00:00:0C:07:AC:XX** como su direcci√≥n MAC virtual. HSRPv2 tiene una direcci√≥n MAC virtual de **00:00:0C:9F:FX:XX** (donde XX es el n√∫mero de grupo HSRP).

HSRP utiliza la direcci√≥n IP reservada **224.0.0.2** o **224.0.0.102** (dependiendo de la versi√≥n de HSRP) y el protocolo de capa de transporte UDP con el n√∫mero de puerto **1985** para difundir y procesar la informaci√≥n de servicio. Se env√≠an paquetes especiales de HSRP Hello **cada 3 segundos**. Si el router HSRP no recibe un paquete hello de un vecino **dentro de los 10 segundos**, el vecino se considerar√° "muerto" y saldr√° del dominio HSRP.

### Mecanismo de ataque HSRP <a href="#d4a3" id="d4a3"></a>

**Esto es exactamente lo mismo que el secuestro de GLBP. Necesitamos realizar una inyecci√≥n maliciosa de HSRP con un valor de prioridad m√°xima de 255.** Esto nos permite secuestrar el rol del router activo, abriendo la puerta a un ataque **MITM**. Pero nuevamente, necesitamos examinar la siguiente informaci√≥n antes de realizar el ataque:

* **La direcci√≥n IP virtual utilizada en el dominio HSRP**
* **La presencia de autenticaci√≥n**
* **Valor de las prioridades del router**

Podemos extraer esta informaci√≥n analizando el tr√°fico de HSRP. **Utilicemos Wireshark.**

Como se puede ver en la captura de pantalla, el proceso de HSRP involucra solo dos routers con direcciones 10.10.100.100 y 10.10.100.200

<figure><img src="../../.gitbook/assets/image (181).png" alt=""><figcaption><p>Anuncios de HSRP</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (212).png" alt=""><figcaption><p>Primer router de HSRP</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (304).png" alt=""><figcaption><p>Segundo router de HSRP</p></figcaption></figure>

Bas√°ndonos en el an√°lisis del tr√°fico de HSRP, tenemos lo siguiente:

* **Se detect√≥ una mala configuraci√≥n dentro del ajuste de prioridad. Se considera que el router activo es un router de HSRP con prioridad 200, es decir, tenemos un vector para el secuestro de HSRP.**
* **la direcci√≥n IP virtual utilizada en el dominio HSRP es 10.10.100.254**
* **Se utiliza autenticaci√≥n MD5**

Tener autenticaci√≥n en el dominio nos ata las manos, pero lo arreglar√©.

### Saltarse la autenticaci√≥n de HSRP <a href="#d9fd" id="d9fd"></a>

Guarde el volcado de tr√°fico de HSRP en formato **.pcap**, para que el exfiltrador pueda extraer correctamente los hashes MD5 del volcado. Usar√© **hsrp2john.py** como exfiltrador:
```
~/cisconightmare/exfiltrate$ python2 hsrp2john.py hsrp_with_authentication.pcap
```
<figure><img src="../../.gitbook/assets/image (287).png" alt=""><figcaption><p>Hashes MD5 extra√≠das del volcado de tr√°fico HSRP</p></figcaption></figure>

Voy a crackear los hashes con **John the Ripper**, especificando los hashes como entrada. Y con el comando **--wordlist** especificar√© la ruta al diccionario:
```
~/cisconightmare/exfiltrate$ john hsrp_hashes --wordlist=wordlistforbrute
```
<figure><img src="../../.gitbook/assets/image (203).png" alt=""><figcaption><p>Contrase√±a del dominio HSRP descifrada</p></figcaption></figure>

Como resultado, tenemos una clave para ingresar al dominio HSRP: **endgame**.

### Inyecci√≥n HSRP (Loki) <a href="#6a2b" id="6a2b"></a>

Usar√© el mismo Loki para atacar el protocolo HSRP. Entre otras cosas, tiene una funci√≥n de inyecci√≥n de clave, que nos ayuda a evitar la autenticaci√≥n. Anteriormente, en la secci√≥n de Secuestro de HSRP, obtuvimos toda la informaci√≥n necesaria sobre el dominio HSRP.

Iniciando Loki.

<figure><img src="../../.gitbook/assets/image (309).png" alt=""><figcaption><p>Loki detect√≥ anuncios HSRP</p></figcaption></figure>

No olvide cambiar al modo promiscuo y permitir el enrutamiento de tr√°fico antes de realizar el ataque:
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
Selecciona el router con direcci√≥n **10.10.100.100** y una prioridad de **200**. Como par√°metro **Secret**, introduce la contrase√±a descifrada del dominio HSRP, genera un ARP gratuito y selecciona la opci√≥n **Get IP**.

<figure><img src="../../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (237).png" alt=""><figcaption></figcaption></figure>

**Como podemos ver, el router activo ahora es nuestro sistema atacante. El valor de prioridad es 255.**

**Despu√©s de la inyecci√≥n, necesitamos crear una direcci√≥n IP secundaria en nuestra interfaz de red con el valor de la direcci√≥n IP virtual en el dominio HSRP. Tambi√©n debemos especificar una m√°scara de 24 bits. De esta manera, el tr√°fico leg√≠timo se redirigir√° hacia nosotros, ya que la direcci√≥n IP virtual utilizada en el dominio HSRP es la direcci√≥n de la puerta de enlace predeterminada para los hosts.**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
Establecemos el conocido NAT de origen (enmascaramiento) para interceptar todo el tr√°fico:
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
Eliminamos la ruta predeterminada en nuestra m√°quina y escribimos una nueva que pasar√° a trav√©s del antiguo enrutador activo (su direcci√≥n es 10.10.100.100). Aunque hayamos secuestrado el rol activo del enrutador, a√∫n podr√° enrutar el tr√°fico.
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
**Ahora somos el "hombre en el medio". Ejecutemos** [**net-creds.py**](https://github.com/DanMcInerney/net-creds)**:**
```
~$ sudo python2 net-creds.py -i eth0
```
Despu√©s de ejecutar la utilidad, reproducir√© un intento de autenticaci√≥n en el servidor FTP en 172.16.100.140:
```
~$ ftp 172.16.100.140
```
<figure><img src="../../.gitbook/assets/image (179).png" alt=""><figcaption></figcaption></figure>

Como resultado, obtenemos credenciales del servidor FTP: **insomnia:betrayal**

De esta manera se puede atacar el dominio HSRP e interceptar el tr√°fico. B√°sicamente, todo es similar a GLBP.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
