# GLBP & HSRP Angriffe

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>


## FHRP-Hijacking-√úbersicht

### Einblicke in FHRP
FHRP ist darauf ausgelegt, Netzwerkrobustheit zu bieten, indem mehrere Router zu einer einzigen virtuellen Einheit zusammengef√ºhrt werden, um die Lastverteilung und Ausfallsicherheit zu verbessern. Cisco Systems hat prominente Protokolle in dieser Suite eingef√ºhrt, wie z.B. GLBP und HSRP.

### Einblicke in das GLBP-Protokoll
Die von Cisco entwickelte GLBP funktioniert auf dem TCP/IP-Stack und verwendet UDP auf Port 3222 f√ºr die Kommunikation. Router in einer GLBP-Gruppe tauschen "Hello"-Pakete in 3-Sekunden-Intervallen aus. Wenn ein Router diese Pakete 10 Sekunden lang nicht sendet, wird er als offline angesehen. Diese Timer sind jedoch nicht festgelegt und k√∂nnen ge√§ndert werden.

### GLBP-Operationen und Lastverteilung
GLBP zeichnet sich dadurch aus, dass es die Lastverteilung √ºber Router mithilfe einer einzigen virtuellen IP in Verbindung mit mehreren virtuellen MAC-Adressen erm√∂glicht. In einer GLBP-Gruppe ist jeder Router an der Paketweiterleitung beteiligt. Im Gegensatz zu HSRP/VRRP bietet GLBP echte Lastverteilung durch mehrere Mechanismen:

- **Hostabh√§ngige Lastverteilung:** Beh√§lt die Zuweisung der AVF-MAC-Adresse an einen Host bei, was f√ºr stabile NAT-Konfigurationen wichtig ist.
- **Round-Robin-Lastverteilung:** Der Standardansatz, bei dem die Zuweisung der AVF-MAC-Adresse abwechselnd an anfragende Hosts erfolgt.
- **Gewichtete Round-Robin-Lastverteilung:** Verteilt die Last basierend auf vordefinierten "Gewichts"-Metriken.

### Schl√ºsselkomponenten und Terminologien in GLBP
- **AVG (Active Virtual Gateway):** Der Hauptrouter, der MAC-Adressen an Peer-Router zuweist.
- **AVF (Active Virtual Forwarder):** Ein Router, der f√ºr die Verwaltung des Netzwerkverkehrs zust√§ndig ist.
- **GLBP-Priorit√§t:** Eine Metrik, die den AVG bestimmt, beginnend mit einem Standardwert von 100 und im Bereich von 1 bis 255.
- **GLBP-Gewicht:** Spiegelt die aktuelle Last auf einem Router wider und kann entweder manuell oder √ºber Objektverfolgung angepasst werden.
- **GLBP-Virtuelle IP-Adresse:** Dient als Standardgateway des Netzwerks f√ºr alle verbundenen Ger√§te.

F√ºr Interaktionen verwendet GLBP die reservierte Multicast-Adresse 224.0.0.102 und den UDP-Port 3222. Router senden "Hello"-Pakete in 3-Sekunden-Intervallen und gelten als nicht betriebsbereit, wenn ein Paket √ºber einen Zeitraum von 10 Sekunden verpasst wird.

### GLBP-Angriffsmechanismus
Ein Angreifer kann zum prim√§ren Router werden, indem er ein GLBP-Paket mit dem h√∂chsten Priorit√§tswert (255) sendet. Dies kann zu DoS- oder MITM-Angriffen f√ºhren, die das Abfangen oder Umleiten von Datenverkehr erm√∂glichen.

### Ausf√ºhren eines GLBP-Angriffs mit Loki
[Loki](https://github.com/raizo62/loki_on_kali) kann einen GLBP-Angriff durchf√ºhren, indem ein Paket mit Priorit√§t und Gewicht auf 255 injiziert wird. Vor dem Angriff m√ºssen Informationen wie die virtuelle IP-Adresse, die Authentifizierungspr√§senz und die Routerpriorit√§tswerte mithilfe von Tools wie Wireshark gesammelt werden.

Angriffsschritte:
1. Wechseln Sie in den Promiscuous-Modus und aktivieren Sie die IP-Weiterleitung.
2. Identifizieren Sie den Zielrouter und rufen Sie dessen IP ab.
3. Generieren Sie eine Gratuits ARP.
4. Injizieren Sie ein b√∂sartiges GLBP-Paket, das den AVG imitiert.
5. Weisen Sie der Netzwerkschnittstelle des Angreifers eine sekund√§re IP-Adresse zu, die der GLBP-Virtual-IP entspricht.
6. Implementieren Sie SNAT f√ºr eine vollst√§ndige Sichtbarkeit des Datenverkehrs.
7. Passen Sie die Routing-Einstellungen an, um weiterhin √ºber den urspr√ºnglichen AVG-Router auf das Internet zugreifen zu k√∂nnen.

Durch Befolgen dieser Schritte positioniert sich der Angreifer als "Man in the Middle" und ist in der Lage, den Netzwerkverkehr abzufangen und zu analysieren, einschlie√ülich unverschl√ºsselter oder sensibler Daten.

F√ºr eine Demonstration finden Sie hier die erforderlichen Befehlsschnipsel:
```bash
# Enable promiscuous mode and IP forwarding
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1

# Configure secondary IP and SNAT
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE

# Adjust routing
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
Die √úberwachung und Abfangen von Datenverkehr kann mithilfe von net-creds.py oder √§hnlichen Tools erfolgen, um Daten, die durch das kompromittierte Netzwerk flie√üen, zu erfassen und zu analysieren.

### Passive Erkl√§rung des HSRP-Hijackings mit Befehlsdetails

#### √úberblick √ºber HSRP (Hot Standby Router/Redundancy Protocol)
HSRP ist ein von Cisco entwickeltes propriet√§res Protokoll zur Redundanz von Netzwerk-Gateways. Es erm√∂glicht die Konfiguration mehrerer physischer Router zu einer einzigen logischen Einheit mit einer gemeinsamen IP-Adresse. Diese logische Einheit wird von einem prim√§ren Router verwaltet, der den Datenverkehr leitet. Im Gegensatz zu GLBP, das Metriken wie Priorit√§t und Gewicht f√ºr die Lastverteilung verwendet, verl√§sst sich HSRP auf einen einzigen aktiven Router f√ºr das Datenverkehrsmanagement.

#### Rollen und Terminologie in HSRP
- **HSRP Active Router**: Das Ger√§t, das als Gateway fungiert und den Datenfluss verwaltet.
- **HSRP Standby Router**: Ein Backup-Router, der bereit ist, die Rolle des aktiven Routers zu √ºbernehmen, falls dieser ausf√§llt.
- **HSRP-Gruppe**: Eine Gruppe von Routern, die zusammenarbeiten, um einen einzigen widerstandsf√§higen virtuellen Router zu bilden.
- **HSRP-MAC-Adresse**: Eine virtuelle MAC-Adresse, die dem logischen Router in der HSRP-Konfiguration zugewiesen ist.
- **HSRP-Virtuelle IP-Adresse**: Die virtuelle IP-Adresse der HSRP-Gruppe, die als Standardgateway f√ºr verbundene Ger√§te fungiert.

#### HSRP-Versionen
HSRP gibt es in zwei Versionen, HSRPv1 und HSRPv2, die sich haupts√§chlich in der Gruppenkapazit√§t, der Verwendung von Multicast-IPs und der Struktur der virtuellen MAC-Adresse unterscheiden. Das Protokoll verwendet spezifische Multicast-IP-Adressen f√ºr den Austausch von Dienstinformationen, wobei alle 3 Sekunden Hello-Pakete gesendet werden. Ein Router gilt als inaktiv, wenn innerhalb eines Intervalls von 10 Sekunden kein Paket empfangen wird.

#### HSRP-Angriffsmechanismus
HSRP-Angriffe beinhalten das gewaltsame √úbernehmen der Rolle des aktiven Routers durch das Einspritzen eines maximalen Priorit√§tswerts. Dies kann zu einem Man-in-the-Middle (MITM)-Angriff f√ºhren. Wesentliche Schritte vor dem Angriff umfassen das Sammeln von Daten √ºber die HSRP-Konfiguration, was mithilfe von Wireshark zur Verkehrsanalyse erfolgen kann.

#### Schritte zum Umgehen der HSRP-Authentifizierung
1. Speichern Sie den Netzwerkverkehr mit HSRP-Daten als .pcap-Datei.
```shell
tcpdump -w hsrp_traffic.pcap
```
2. Extrahieren Sie MD5-Hashes aus der .pcap-Datei mithilfe von hsrp2john.py.
```shell
python2 hsrp2john.py hsrp_traffic.pcap > hsrp_hashes
```
3. Knacken Sie die MD5-Hashes mit John the Ripper.
```shell
john --wordlist=mywordlist.txt hsrp_hashes
```

**Ausf√ºhren der HSRP-Injektion mit Loki**

1. Starten Sie Loki, um HSRP-Anzeigen zu identifizieren.
2. Setzen Sie die Netzwerkschnittstelle in den Promiscuous-Modus und aktivieren Sie die IP-Weiterleitung.
```shell
sudo ip link set eth0 promisc on
sudo sysctl -w net.ipv4.ip_forward=1
```
3. Verwenden Sie Loki, um den spezifischen Router anzugreifen, geben Sie das geknackte HSRP-Passwort ein und f√ºhren Sie die erforderlichen Konfigurationen durch, um sich als aktiver Router auszugeben.
4. Nachdem Sie die Rolle des aktiven Routers √ºbernommen haben, konfigurieren Sie Ihre Netzwerkschnittstelle und IP-Tabellen, um den legitimen Datenverkehr abzufangen.
```shell
sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
5. √Ñndern Sie die Routing-Tabelle, um den Datenverkehr √ºber den ehemaligen aktiven Router zu leiten.
```shell
sudo route del default
sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
6. Verwenden Sie net-creds.py oder ein √§hnliches Dienstprogramm, um Anmeldeinformationen aus dem abgefangenen Datenverkehr zu erfassen.
```shell
sudo python2 net-creds.py -i eth0
```

Durch Ausf√ºhren dieser Schritte befindet sich der Angreifer in der Lage, den Datenverkehr abzufangen und zu manipulieren, √§hnlich wie beim Verfahren zum GLBP-Hijacking. Dies verdeutlicht die Schwachstelle in Redundanzprotokollen wie HSRP und die Notwendigkeit robuster Sicherheitsma√ünahmen.


## Referenzen
- [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)


<details>

<summary><strong>Lernen Sie das Hacken von AWS von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) **bei oder folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories senden.**

</details>
