# Malware-Analyse

{% hint style="success" %}
Lernen Sie AWS-Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen Sie GCP-Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>
{% endhint %}

## Forensik-Spickzettel

[https://www.jaiminton.com/cheatsheet/DFIR/#](https://www.jaiminton.com/cheatsheet/DFIR/)

## Online-Dienste

* [VirusTotal](https://www.virustotal.com/gui/home/upload)
* [HybridAnalysis](https://www.hybrid-analysis.com)
* [Koodous](https://koodous.com)
* [Intezer](https://analyze.intezer.com)
* [Any.Run](https://any.run/)

## Offline-Antiviren- und Erkennungstools

### Yara

#### Installieren
```bash
sudo apt-get install -y yara
```
#### Vorbereitung von Regeln

Verwenden Sie dieses Skript, um alle Yara-Malware-Regeln von GitHub herunterzuladen und zusammenzuf√ºhren: [https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9](https://gist.github.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9)\
Erstellen Sie das Verzeichnis _**rules**_ und f√ºhren Sie es aus. Dadurch wird eine Datei namens _**malware\_rules.yar**_ erstellt, die alle Yara-Regeln f√ºr Malware enth√§lt.
```bash
wget https://gist.githubusercontent.com/andreafortuna/29c6ea48adf3d45a979a78763cdc7ce9/raw/4ec711d37f1b428b63bed1f786b26a0654aa2f31/malware_yara_rules.py
mkdir rules
python malware_yara_rules.py
```
#### Scannen
```bash
yara -w malware_rules.yar image  #Scan 1 file
yara -w malware_rules.yar folder #Scan the whole folder
```
#### YaraGen: √úberpr√ºfen von Malware und Erstellen von Regeln

Sie k√∂nnen das Tool [**YaraGen**](https://github.com/Neo23x0/yarGen) verwenden, um Yara-Regeln aus einem Bin√§rfile zu generieren. Schauen Sie sich diese Tutorials an: [**Teil 1**](https://www.nextron-systems.com/2015/02/16/write-simple-sound-yara-rules/), [**Teil 2**](https://www.nextron-systems.com/2015/10/17/how-to-write-simple-but-sound-yara-rules-part-2/), [**Teil 3**](https://www.nextron-systems.com/2016/04/15/how-to-write-simple-but-sound-yara-rules-part-3/)
```bash
python3 yarGen.py --update
python3.exe yarGen.py --excludegood -m  ../../mals/
```
### ClamAV

#### Installation
```
sudo apt-get install -y clamav
```
#### Scannen
```bash
sudo freshclam      #Update rules
clamscan filepath   #Scan 1 file
clamscan folderpath #Scan the whole folder
```
### [Capa](https://github.com/mandiant/capa)

**Capa** erkennt potenziell b√∂sartige **F√§higkeiten** in ausf√ºhrbaren Dateien: PE, ELF, .NET. Es wird also Dinge wie Att\&ck-Taktiken oder verd√§chtige F√§higkeiten wie:

* √úberpr√ºfung auf OutputDebugString-Fehler
* Ausf√ºhren als Dienst
* Prozess erstellen

Holen Sie es sich im [**Github-Repo**](https://github.com/mandiant/capa).

### IOCs

IOC bedeutet Indicator Of Compromise. Ein IOC ist eine Reihe von **Bedingungen, die** einige potenziell unerw√ºnschte Software oder best√§tigte **Malware identifizieren**. Blue Teams verwenden diese Art von Definition, um nach solchen b√∂sartigen Dateien in ihren **Systemen** und **Netzwerken** zu suchen.\
Das Teilen dieser Definitionen ist sehr n√ºtzlich, da, wenn Malware auf einem Computer identifiziert wird und ein IOC f√ºr diese Malware erstellt wird, andere Blue Teams es verwenden k√∂nnen, um die Malware schneller zu identifizieren.

Ein Tool zum Erstellen oder Modifizieren von IOCs ist der [**IOC-Editor**](https://www.fireeye.com/services/freeware/ioc-editor.html)**.**\
Sie k√∂nnen Tools wie [**Redline**](https://www.fireeye.com/services/freeware/redline.html) verwenden, um **definierte IOCs auf einem Ger√§t zu suchen**.

### Loki

[**Loki**](https://github.com/Neo23x0/Loki) ist ein Scanner f√ºr einfache Indikatoren f√ºr Kompromittierungen.\
Die Erkennung basiert auf vier Erkennungsmethoden:
```
1. File Name IOC
Regex match on full file path/name

2. Yara Rule Check
Yara signature matches on file data and process memory

3. Hash Check
Compares known malicious hashes (MD5, SHA1, SHA256) with scanned files

4. C2 Back Connect Check
Compares process connection endpoints with C2 IOCs (new since version v.10)
```
### Linux Malware Detect

[**Linux Malware Detect (LMD)**](https://www.rfxn.com/projects/linux-malware-detect/) ist ein Malware-Scanner f√ºr Linux, der unter der GNU GPLv2-Lizenz ver√∂ffentlicht wurde und der um die Bedrohungen herum entwickelt wurde, denen man in gemeinsam genutzten Hosting-Umgebungen gegen√ºbersteht. Er verwendet Bedrohungsdaten von Netzwerkrand-Eindringungserkennungssystemen, um Malware zu extrahieren, die aktiv bei Angriffen verwendet wird, und generiert Signaturen zur Erkennung. Dar√ºber hinaus stammen Bedrohungsdaten auch aus Benutzereinreichungen mit der LMD-Checkout-Funktion und aus Malware-Community-Ressourcen.

### rkhunter

Tools wie [**rkhunter**](http://rkhunter.sourceforge.net) k√∂nnen verwendet werden, um das Dateisystem auf m√∂gliche **Rootkits** und Malware zu √ºberpr√ºfen.
```bash
sudo ./rkhunter --check -r / -l /tmp/rkhunter.log [--report-warnings-only] [--skip-keypress]
```
### FLOSS

[**FLOSS**](https://github.com/mandiant/flare-floss) ist ein Tool, das versucht, obfuskierte Zeichenfolgen in ausf√ºhrbaren Dateien mithilfe verschiedener Techniken zu finden.

### PEpper

[PEpper](https://github.com/Th3Hurrican3/PEpper) √ºberpr√ºft einige grundlegende Dinge innerhalb der ausf√ºhrbaren Datei (Bin√§rdaten, Entropie, URLs und IPs, einige Yara-Regeln).

### PEstudio

[PEstudio](https://www.winitor.com/download) ist ein Tool, das Informationen √ºber Windows-Executable wie Imports, Exports, Header liefert, aber auch Virus Total √ºberpr√ºft und potenzielle Att\&ck-Techniken findet.

### Detect It Easy(DiE)

[**DiE**](https://github.com/horsicq/Detect-It-Easy/) ist ein Tool, um festzustellen, ob eine Datei **verschl√ºsselt** ist und auch **Packer** zu finden.

### NeoPI

[**NeoPI**](https://github.com/CiscoCXSecurity/NeoPI) ist ein Python-Skript, das eine Vielzahl von **statistischen Methoden** verwendet, um **obfuskierte** und **verschl√ºsselte** Inhalte in Text-/Skriptdateien zu erkennen. Der beabsichtigte Zweck von NeoPI besteht darin, bei der **Erkennung von verstecktem Web-Shell-Code** zu helfen.

### **php-malware-finder**

[**PHP-malware-finder**](https://github.com/nbs-system/php-malware-finder) tut sein Bestes, um **obfuskierten**/**fragw√ºrdigen Code** sowie Dateien zu erkennen, die **PHP**-Funktionen verwenden, die h√§ufig in **Malware**/Webshells verwendet werden.

### Apple Binary Signatures

Beim √úberpr√ºfen einer **Malware-Probe** sollten Sie immer die Signatur der Bin√§rdatei √ºberpr√ºfen, da der **Entwickler**, der sie signiert hat, m√∂glicherweise bereits mit **Malware** in Verbindung gebracht wird.
```bash
#Get signer
codesign -vv -d /bin/ls 2>&1 | grep -E "Authority|TeamIdentifier"

#Check if the app‚Äôs contents have been modified
codesign --verify --verbose /Applications/Safari.app

#Check if the signature is valid
spctl --assess --verbose /Applications/Safari.app
```
## Erkennungstechniken

### Dateistapelung

Wenn Sie wissen, dass ein Ordner, der die **Dateien** eines Webservers enth√§lt, zuletzt am **Datum** aktualisiert wurde. √úberpr√ºfen Sie das **Datum**, an dem alle **Dateien** im **Webserver erstellt und ge√§ndert** wurden, und wenn ein Datum **verd√§chtig** ist, √ºberpr√ºfen Sie diese Datei.

### Baselines

Wenn die Dateien eines Ordners **nicht ge√§ndert worden sein sollten**, k√∂nnen Sie den **Hash** der **urspr√ºnglichen Dateien** des Ordners berechnen und sie mit den **aktuellen** vergleichen. Alles, was ge√§ndert wurde, wird **verd√§chtig** sein.

### Statistische Analyse

Wenn die Informationen in Protokollen gespeichert sind, k√∂nnen Sie **Statistiken √ºberpr√ºfen, wie oft auf jede Datei eines Webservers zugegriffen wurde, da eine Webshell eine der h√§ufigsten** sein k√∂nnte.
