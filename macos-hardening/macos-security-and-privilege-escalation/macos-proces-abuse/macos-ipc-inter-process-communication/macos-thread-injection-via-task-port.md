# macOS Thread Injection via Task port

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

рджреВрд╕рд░реЗ рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдФрд░ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## рдХреЛрдб

* [https://github.com/bazad/threadexec](https://github.com/bazad/threadexec)
* [https://gist.github.com/knightsc/bd6dfeccb02b77eb6409db5601dcef36](https://gist.github.com/knightsc/bd6dfeccb02b77eb6409db5601dcef36)


## 1. рдереНрд░реЗрдб рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

рдкрд╣рд▓реЗ, рджреВрд░рд╕реНрде рдХрд╛рд░реНрдп рд╕реЗ рдереНрд░реЗрдб рд╕реВрдЪреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкрд░ **`task_threads()`** рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдПрдХ рдереНрд░реЗрдб рдЪреБрдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдкрд╛рд░рдВрдкрд░рд┐рдХ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рд╡рд┐рдзрд┐рдпреЛрдВ рд╕реЗ рднрд┐рдиреНрди рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдирдП рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдмрдирд╛рдирд╛ рдирдП рдорд┐рдЯрд┐рдЧреЗрд╢рди рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖рд┐рджреНрдз рд╣реИ рдЬрд┐рд╕рдХреЗ рдХрд╛рд░рдг `thread_create_running()` рдХреЛ рдмреНрд▓реЙрдХ рдХрд░ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдереНрд░реЗрдб рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **`thread_suspend()`** рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд░реЛрдХ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдкрд░ рдХреЗрд╡рд▓ **рд░реЛрдХрдирд╛** рдФрд░ **рд╢реБрд░реВ** рдХрд░рдиреЗ, **рд░рдЬрд┐рд╕реНрдЯрд░ рдорд╛рдиреЛрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд** рдФрд░ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИред рджреВрд░рд╕реНрде рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдЖрд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд░рдЬрд┐рд╕реНрдЯрд░ `x0` рд╕реЗ `x7` рдХреЛ **рдЖрд░реНрдЧреНрдпреВрдореЗрдВрдЯреНрд╕** рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗ, **`pc`** рдХреЛ рд▓рдХреНрд╖рд┐рдд рдлрд╝рдВрдХреНрд╢рди рдкрд░ рд╕реЗрдЯ рдХрд░рдХреЗ, рдФрд░ рдереНрд░реЗрдб рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рдХреЗ рджреВрд░рд╕реНрде рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рд╡рд╛рдкрд╕реА рдХреЗ рдмрд╛рдж рдереНрд░реЗрдб рдХреНрд░реИрд╢ рди рд╣реЛрдиреЗ рдХреА рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд╛рдкрд╕реА рдХреЛ рдкрд╣рдЪрд╛рдирдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИред

рдПрдХ рд░рдгрдиреАрддрд┐ рдореЗрдВ **рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдкрд╡рд╛рдж рд╣реИрдВрдбрд▓рд░ рд░рдЬрд┐рд╕реНрдЯрд░** рдХрд░рдирд╛ `thread_set_exception_ports()` рдЬрд┐рд╕рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рд╕реЗ рдкрд╣рд▓реЗ `lr` рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЛ рдПрдХ рдЕрд╡реИрдз рдкрддреЗ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдирд┐рд╖реНрдкрд╛рджрди рдХреЗ рдмрд╛рдж рдПрдХ рдЕрдкрд╡рд╛рдж рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ, рдереНрд░реЗрдб рдХреА рд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╛рдкрд╕реА рдореВрд▓реНрдп рдХреЛ рдкреБрдирдГ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рд╡реИрдХрд▓реНрдкрд┐рдХ рд░реВрдк рд╕реЗ, рдЗрдпрд╛рди рдмреАрдпрд░ рдХреЗ рдЯреНрд░рд┐рдкрд▓_рдлреЗрдЪ рдзреЛрдЦрд╛рдзрдбрд╝реА рд╕реЗ рдЕрдкрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, `lr` рдХреЛ рдЕрдирдВрддрддрд╛ рд╕реЗ рд▓реВрдк рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдлрд┐рд░ рдереНрд░реЗрдб рдХреЗ рд░рдЬрд┐рд╕реНрдЯрд░реЛрдВ рдХреЛ рдирд┐рд░рдВрддрд░ рдореЙрдирд┐рдЯрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рддрдХ **`pc` рдЙрд╕ рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдирд╣реАрдВ рджрд┐рдЦрд╛рддрд╛** рд╣реИред

## 2. рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рдореИрдХ рдкреЛрд░реНрдЯреНрд╕

рдЕрдЧрд▓реЗ рдЪрд░рдг рдореЗрдВ, рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рд╕реБрд╡рд┐рдзрд╛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдореИрдХ рдкреЛрд░реНрдЯреНрд╕ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред рдпреЗ рдкреЛрд░реНрдЯреНрд╕ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ рд╡рд┐рднрд┐рдиреНрди рднреЗрдЬрдиреЗ рдФрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИрдВред

рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП, рджреЛ рдореИрдХ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдмрдирд╛рдП рдЬрд╛рддреЗ рд╣реИрдВ: рдПрдХ рд╕реНрдерд╛рдиреАрдп рдФрд░ рджреВрд░рд╕реНрде рдХрд╛рд░реНрдп рдореЗрдВред рдЗрд╕рдХреЗ рдмрд╛рдж, рдкреНрд░рддреНрдпреЗрдХ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рд╡рд┐рдкрд░реАрдд рдХрд╛рд░реНрдп рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╕рдВрджреЗрд╢ рд╡рд┐рдирд┐рдордп рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВред

рд╕реНрдерд╛рдиреАрдп рдкреЛрд░реНрдЯ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ, рд╕реНрдерд╛рдиреАрдп рдХрд╛рд░реНрдп рджреНрд╡рд╛рд░рд╛ рдкреНрд░рд╛рдкреНрддрд┐ рдЕрдзрд┐рдХрд╛рд░ рдХреЛ рдзрд╛рд░рдг рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдкреЛрд░реНрдЯ `mach_port_allocate()` рдХреЗ рд╕рд╛рде рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЪреБрдиреМрддреА рдЗрд╕рдореЗрдВ рд╣реИ рдХрд┐ рдЗрд╕ рдкреЛрд░реНрдЯ рдореЗрдВ рдПрдХ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рджреВрд░рд╕реНрде рдХрд╛рд░реНрдп рдореЗрдВ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдирд╛ред

рдПрдХ рд░рдгрдиреАрддрд┐ рд╢рд╛рдорд┐рд▓ рд╣реИ `thread_set_special_port()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЬрд┐рд╕рд╕реЗ рд╕реНрдерд╛рдиреАрдп рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдХреЗ `THREAD_KERNEL_PORT` рдореЗрдВ рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред рдлрд┐рд░, рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдХреЛ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ `mach_thread_self()` рдХреЙрд▓ рдХрд░реЗрдВ рддрд╛рдХрд┐ рд╡рд╣ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХреЗред

рджреВрд░рд╕реНрде рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП, рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореВрд▓ рд░реВрдк рд╕реЗ рдЙрд▓рдЯ рджреА рдЬрд╛рддреА рд╣реИред рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдХреЛ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ `mach_reply_port()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рдореИрдХ рдкреЛрд░реНрдЯ рдЙрддреНрдкрдиреНрди рдХрд░реЗрдВ (рдХреНрдпреЛрдВрдХрд┐ `mach_port_allocate()` рдЕрдкрдиреЗ рд╡рд╛рдкрд╕реА рддрдВрддреНрд░ рдХреЗ рдХрд╛рд░рдг рдЕрдиреБрдЪрд┐рдд рд╣реИ)ред рдкреЛрд░реНрдЯ рдирд┐рд░реНрдорд╛рдг рдХреЗ рдмрд╛рдж, рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдореЗрдВ `mach_port_insert_right()` рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдПрдХ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рд╕реНрдерд╛рдкрд┐рдд рд╣реЛ рд╕рдХреЗред рдпрд╣ рдЕрдзрд┐рдХрд╛рд░ рдлрд┐рд░ рдХрд░реНрдгрд▓ рдореЗрдВ `thread_set_special_port()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЫрд┐рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╕реНрдерд╛рдиреАрдп рдХрд╛рд░реНрдп рдореЗрдВ, рджреВрд░рд╕реНрде рдереНрд░реЗрдб рдкрд░ `thread_get_special_port()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рджреВрд░рд╕реНрде рдХрд╛рд░реНрдп рдореЗрдВ рдирд╡реАрди рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдореИрдХ рдкреЛрд░реНрдЯ рдХреЗ рд▓рд┐рдП рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрди рдХрджрдореЛрдВ рдХреЗ рдкреВрд░рд╛ рд╣реЛрдиреЗ рд╕реЗ рдореИрдХ рдкреЛрд░реНрдЯреНрд╕ рдХреА рд╕реНрдерд╛рдкрдирд╛ рд╣реЛрддреА рд╣реИ, рдЬреЛ рджреНрд╡рд┐рджрд┐рд╢реАрдп рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рдЖрдзрд╛рд░ рд░рдЦрддреА рд╣реИред

## 3. рдореВрд▓ рдореЗрдореЛрд░реА рдкрдарди/рд▓реЗрдЦрди рдЖрдзрд╛рд░

рдЗрд╕ рдЦрдВрдб рдореЗрдВ, рдХрд╛рд░реНрдп рдХреЛ рдмреБрдирд┐рдпрд╛рджреА рдореЗрдореЛрд░реА рдкрдарди рдФрд░ рд▓реЗрдЦрди рдЖрдзрд╛рд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд╖реЗрддреНрд░рд┐рдп рдкреНрд░рдпреЛрдЧ рдХрд░рдиреЗ рдкрд░ рдзреНрдпрд╛рди рдХреЗрдВрджреНрд░рд┐рдд рд╣реИред рдпреЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдХрджрдо рджреВрд░рд╕реНрде рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдЕрдзрд┐рдХ рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИрдВ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕ рд╕реНрддрд░ рдкрд░ рдкреНрд░рд╛рдердорд┐рдХ рдЖрдзрд╛рд░ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдЙрджреНрджреЗрд╢реНрдпреЛрдВ рдХреА рд╕реЗрд╡рд╛ рдирд╣реАрдВ рдХрд░реЗрдВрдЧреЗред рдЬрд▓реНрдж рд╣реА, рд╡реЗ рдЕрдзрд┐рдХ рдЙрдиреНрдирдд рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЕрдкрдЧреНрд░реЗрдб рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред

### рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдкреНрд░рд┐рдорд┐рдЯрд┐рд╡ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореЗрдореЛрд░реА рдкрдарди рдФрд░ рд▓реЗрдЦрди

рд▓рдХреНрд╖реНрдп рд╣реИ рдХрд┐ рд╡рд┐рд╢реЗрд╖ рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдореЗрдореЛрд░реА рдкрдарди рдФрд░ рд▓реЗрдЦрди рдХрд┐рдпрд╛ рдЬрд╛рдПред рдореЗрдореЛрд░реА рдкрдарди рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрд░рдЪрдирд╛ рдХреА рддреБрд▓рдирд╛ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```c
uint64_t read_func(uint64_t *address) {
return *address;
}
```
рдФрд░ рдореЗрдореЛрд░реА рдореЗрдВ рд▓реЗрдЦрди рдХреЗ рд▓рд┐рдП, рдЗрд╕ рд╕рдВрд░рдЪрдирд╛ рдХреЗ рд╕рдорд╛рди рдХрд╛рд░реНрдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```c
void write_func(uint64_t *address, uint64_t value) {
*address = value;
}
```
рдпреЗ рдлрд╝рдВрдХреНрд╢рди рджрд┐рдП рдЧрдП рдЕрд╕реЗрдореНрдмрд▓реА рдЗрдВрд╕реНрдЯреНрд░рдХреНрд╢рдВрд╕ рдХреЗ рд╕рдорд╛рди рд╣реИрдВ:
```
_read_func:
ldr x0, [x0]
ret
_write_func:
str x1, [x0]
ret
```
### рдЙрдкрдпреБрдХреНрдд рдлрд╝рдВрдХреНрд╢рдиреНрд╕ рдХреА рдкрд╣рдЪрд╛рди

рд╕рд╛рдорд╛рдиреНрдп рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдиреЗ рдЗрди рдСрдкрд░реЗрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреБрдХреНрдд рдЙрдореНрдореАрджрд╡рд╛рд░реЛрдВ рдХреА рдкрд╣рдЪрд╛рди рдХреА:

1. **рдореЗрдореЛрд░реА рдкрдврд╝рдирд╛:**
[Objective-C runtime library](https://opensource.apple.com/source/objc4/objc4-723/runtime/objc-runtime-new.mm.auto.html) рд╕реЗ `property_getName()` рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдореЗрдореЛрд░реА рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрдкрдпреБрдХреНрдд рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рдЪрд╛рдирд╛ рдЧрдпрд╛ рд╣реИред рдиреАрдЪреЗ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡рд┐рд╡рд░рдг рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```c
const char *property_getName(objc_property_t prop) {
return prop->name;
}
```
рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдкрд╣рд▓реЗ рдХреНрд╖реЗрддреНрд░ рдХреЛ рд╡рд╛рдкрд╕ рдХрд░рдХреЗ `objc_property_t` рдХрд╛ рдкрд╣рд▓рд╛ рдлрд╝реАрд▓реНрдб рд╡рд╛рдкрд╕ рдХрд░рдиреЗ рдХреА рддрд░рд╣ рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред

2. **рдореЗрдореЛрд░реА рд▓рд┐рдЦрдирд╛:**
рдореЗрдореЛрд░реА рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреВрд░реНрд╡-рдирд┐рд░реНрдорд┐рдд рдлрд╝рдВрдХреНрд╢рди рдЦреЛрдЬрдирд╛ рдЕрдзрд┐рдХ рдЪреБрдиреМрддреАрдкреВрд░реНрдг рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, `libxpc` рд╕реЗ `_xpc_int64_set_value()` рдлрд╝рдВрдХреНрд╢рди рдПрдХ рдЙрдкрдпреБрдХреНрдд рдЙрдореНрдореАрджрд╡рд╛рд░ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд disassembly рд╣реИ:
```c
__xpc_int64_set_value:
str x1, [x0, #0x18]
ret
```
рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкрддреЗ рдкрд░ 64-рдмрд┐рдЯ рд▓реЗрдЦ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд░рд┐рдореЛрдЯ рдХреЙрд▓ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕рдВрд░рдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```c
_xpc_int64_set_value(address - 0x18, value)
```
## 4. рд╕рд╛рдЭрд╛ рд╕реНрдореГрддрд┐ рд╕реЗрдЯрдЕрдк

рдЙрджреНрджреЗрд╢реНрдп рд╕реНрдерд╛рдиреАрдп рдФрд░ рджреВрд░рд╕реНрде рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ рд╕рд╛рдЭрд╛ рд╕реНрдореГрддрд┐ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИ, рдбреЗрдЯрд╛ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рдХреЛ рд╕рд░рд▓ рдмрдирд╛рдирд╛ рдФрд░ рдПрдХрд╛рдзрд┐рдХ рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдирд╛ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдмрдирд╛рдирд╛ред рдЗрд╕ рджреГрд╖реНрдЯрд┐рдХреЛрдг рдореЗрдВ `libxpc` рдФрд░ рдЗрд╕рдХреЗ `OS_xpc_shmem` рдСрдмреНрдЬреЗрдХреНрдЯ рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╕рд╣рд╛рд░рд╛ рд▓реЗрдирд╛ рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреЛ рдореИрдХ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реАрдЬрд╝ рдкрд░ рдирд┐рд░реНрдорд┐рдд рд╣реИред

### рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╡рд▓реЛрдХрди:

1. **рд╕реНрдореГрддрд┐ рдЖрд╡рдВрдЯрди**:
- `mach_vm_allocate()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реНрдореГрддрд┐ рдЖрд╡рдВрдЯрд┐рдд рдХрд░реЗрдВред
- рдЖрд╡рдВрдЯрд┐рдд рд╕реНрдореГрддрд┐ рдХреНрд╖реЗрддреНрд░ рдХреЗ рд▓рд┐рдП рдПрдХ `OS_xpc_shmem` рдСрдмреНрдЬ
```c
mach_vm_allocate();
xpc_shmem_create();
```
рджреВрд░рд╕реНрде рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╕рд╛рдЭрд╛ рд╕реНрдореГрддрд┐ рд╡рд╕реНрддреБ рдмрдирд╛рдиреЗ рдФрд░ рд╕реБрдзрд╛рд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:
```c
malloc(); // for allocating memory remotely
thread_set_special_port(); // for inserting send right
```
## 5. рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛

рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдФрд░ рд╡рд┐рдЪрд╛рд░рд╢реАрд▓ рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рдХреНрд╖рдорддрд╛рдУрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдкрд░ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ, рд╣рдордиреЗ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд▓рдХреНрд╖реНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░ рд▓рд┐рдпрд╛ рд╣реИред рдЗрд╕ рдирд┐рдпрдВрддреНрд░рдг рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рд╡рд╛рд▓реЗ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдПрдБ рд╣реИрдВ:

1. **рд╡рд┐рдЪрд╛рд░рд╢реАрд▓ рдореЗрдореЛрд░реА рдкрд░рд┐рдЪрд╛рд▓рди**:
   - рд╕рд╛рдЭрд╛ рдХреНрд╖реЗрддреНрд░ рд╕реЗ рдбреЗрдЯрд╛ рдХреЙрдкреА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `memcpy()` рдХреЛ рдЖрд╣реНрд╡рд╛рди рдХрд░рдХреЗ рд╡рд┐рдЪрд╛рд░рд╢реАрд▓ рдореЗрдореЛрд░реА рдкрдврд╝рд╛рдИ рдХрд░реЗрдВред
   - рд╕рд╛рдЭрд╛ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдбреЗрдЯрд╛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `memcpy()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡рд┐рдЪрд╛рд░рд╢реАрд▓ рдореЗрдореЛрд░реА рд▓рд┐рдЦреЗрдВред

2. **рдПрдХрд╛рдзрд┐рдХ рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд╛ рд╕рдВрдЪрд╛рд▓рди**:
   - 8 рд╕реЗ рдЕрдзрд┐рдХ рддрд░реНрдХреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╡рд╛рд▓реЗ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рд▓рд┐рдП, рдХреЙрд▓рд┐рдВрдЧ рдХрдиреНрд╡реЗрдВрд╢рди рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдЕрддрд┐рд░рд┐рдХреНрдд рддрд░реНрдХреЛрдВ рдХреЛ рд╕реНрдЯреИрдХ рдкрд░ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░реЗрдВред

3. **Mach рдкреЛрд░реНрдЯ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг**:
   - рдкрд╣рд▓реЗ рд╕реНрдерд╛рдкрд┐рдд рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Mach рд╕рдВрджреЗрд╢реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмреАрдЪ Mach рдкреЛрд░реНрдЯ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВред

4. **рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг**:
   - `triple_fetch` рдореЗрдВ рдЙрдЬрд╛рдЧрд░ рдХрд┐рдП рдЧрдП рддрдХрдиреАрдХ рдлрд╛рдЗрд▓рдкреЛрд░реНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдмреАрдЪ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░реЗрдВред

рдпрд╣ рд╡реНрдпрд╛рдкрдХ рдирд┐рдпрдВрддреНрд░рдг [threadexec](https://github.com/bazad/threadexec) рдкреБрд╕реНрддрдХрд╛рд▓рдп рдореЗрдВ рд╕рдорд╛рд╣рд┐рдд рд╣реИ, рдЬреЛ рдкреАрдбрд╝рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╕реНрддреГрдд рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдФрд░ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдорд┐рддреНрд░рдкреВрд░реНрдг API рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

## рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╡рд┐рдЪрд╛рд░:

- рд╕рд┐рд╕реНрдЯрдо рд╕реНрдерд┐рд░рддрд╛ рдФрд░ рдбреЗрдЯрд╛ рдЕрдЦрдВрдбрддрд╛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдкрдврд╝рдиреЗ/рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП `memcpy()` рдХрд╛ рдЙрдЪрд┐рдд рдЙрдкрдпреЛрдЧ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВред
- Mach рдкреЛрд░реНрдЯ рдпрд╛ рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рдХрд░рддреЗ рд╕рдордп, рдЙрдЪрд┐рдд рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ рдФрд░ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдЬрд┐рдореНрдореЗрджрд╛рд░реАрдкреВрд░реНрд╡рдХ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ рд▓реАрдХ рдпрд╛ рдЕрдирд╣реЗрддреБ рдкрд╣реБрдВрдЪ рд╕реЗ рдмрдЪрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрди рджрд┐рд╢рд╛рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ рдФрд░ `threadexec` рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ, рдХрд┐рд╕реА рднреА рд▓рдХреНрд╖реНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рд╕реВрдХреНрд╖реНрдо рд╕реНрддрд░ рдкрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдФрд░ рдмрд╛рддрдЪреАрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

# рд╕рдВрджрд░реНрдн
* [https://bazad.github.io/2018/10/bypassing-platform-binary-task-threads/](https://bazad.github.io/2018/10/bypassing-platform-binary-task-threads/)
