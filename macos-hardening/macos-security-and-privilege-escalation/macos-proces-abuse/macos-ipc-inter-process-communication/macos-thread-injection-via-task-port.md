# macOS рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдереНрд░реЗрдб рдЗрдВрдЬреЗрдХреНрд╢рди

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреА рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓** рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**.
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**hacktricks рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks-cloud) **рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред**

</details>

рдпрд╣ рдкреЛрд╕реНрдЯ [https://bazad.github.io/2018/10/bypassing-platform-binary-task-threads/](https://bazad.github.io/2018/10/bypassing-platform-binary-task-threads/) рд╕реЗ рдХреЙрдкреА рдХреА рдЧрдИ рд╣реИ (рдЬрд┐рд╕рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рд╣реИ)

### рдХреЛрдб

* [https://github.com/bazad/threadexec](https://github.com/bazad/threadexec)
* [https://gist.github.com/knightsc/bd6dfeccb02b77eb6409db5601dcef36](https://gist.github.com/knightsc/bd6dfeccb02b77eb6409db5601dcef36)

### 1. рдереНрд░реЗрдб рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рд╣рдо рдХрд░рддреЗ рд╣реИрдВ **`task_threads()`** рдХреЛ рдЯрд╛рд╕реНрдХ рдкреЛрд░реНрдЯ рдкрд░ рдХреЙрд▓ рдХрд░рдХреЗ рд░рд┐рдореЛрдЯ рдЯрд╛рд╕реНрдХ рдореЗрдВ рдереНрд░реЗрдб рдХреА рд╕реВрдЪреА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдФрд░ рдлрд┐рд░ рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рдХреЛ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЪреБрдирддреЗ рд╣реИрдВред рдкрд╛рд░рдВрдкрд░рд┐рдХ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдлреНрд░реЗрдорд╡рд░реНрдХ рдХреЗ рд╡рд┐рдкрд░реАрдд, рд╣рдо **рдирдпрд╛ рд░рд┐рдореЛрдЯ рдереНрд░реЗрдб рдирд╣реАрдВ рдмрдирд╛ рд╕рдХрддреЗ** рдХреНрдпреЛрдВрдХрд┐ `thread_create_running()` рдирдИ рдорд┐рдЯрд┐рдЧреЗрд╢рди рджреНрд╡рд╛рд░рд╛ рдмреНрд▓реЙрдХ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

рдлрд┐рд░, рд╣рдо **`thread_suspend()`** рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдереНрд░реЗрдб рдХреЛ рд░рдирд┐рдВрдЧ рд╕реЗ рд░реЛрдХ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд░рд┐рдореЛрдЯ рдереНрд░реЗрдб рдкрд░ рдХреЗрд╡рд▓ рдпрд╣ рдЙрдкрдпреЛрдЧреА рдирд┐рдпрдВрддреНрд░рдг рд╣реИ рдХрд┐ рд╣рдо рдЙрд╕реЗ рд░реЛрдХ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрд╕реЗ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЙрд╕рдХреЗ рд░рдЬрд┐рд╕реНрдЯрд░ рдорд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЙрд╕рдХреЗ рд░рдЬрд┐рд╕реНрдЯрд░ рдорд╛рди рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рд╣рдо рд░рд┐рдореЛрдЯ рдлрдВрдХреНрд╢рди рдХреЛрд▓ рдЖрд░рдВрдн рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП рд╣рдо рд░рд┐рдореЛрдЯ рдереНрд░реЗрдб рдореЗрдВ рд░рдЬрд┐рд╕реНрдЯрд░ `x0` рд╕реЗ `x7` рдХреЛ рдЖрд░реНрдЧреНрдпреВрдореЗрдВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд░рд┐рдореЛрдЯ рдлрдВрдХреНрд╢рди рдХреЛрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `pc` рдХреЛ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдереНрд░реЗрдб рдХреЛ рд╢реБрд░реВ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд╣рдореЗрдВ рд╡рд╛рдкрд╕реА рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ рдФрд░ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдереНрд░реЗрдб рдХреНрд░реИрд╢ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдХреБрдЫ рддрд░реАрдХреЗ рд╣реИрдВред рдПрдХ рддрд░реАрдХрд╛ рдпрд╣ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рд╣рдо `thread_set_exception_ports()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд░рд┐рдореЛрдЯ рдереНрд░реЗрдб рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдкрд╡рд╛рдж рд╣реИрдВрдбрд▓рд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ рдФрд░ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЕрдорд╛рдиреНрдп рдкрддреЗ рдкрд░ рд░рд┐рдЯрд░реНрди рдПрдбреНрд░реЗрд╕ рд░рдЬрд┐рд╕реНрдЯрд░, `lr`, рд╕реЗрдЯ рдХрд░реЗрдВ; рдЗрд╕ рддрд░реАрдХреЗ рд╕реЗ, рдлрд╝рдВрдХреНрд╢рди рдЪрд▓рд╛рдиреЗ рдХреЗ рдмрд╛рдж рдПрдХ рдЕрдкрд╡рд╛рдж рдЙрддреНрдкрдиреНрди рд╣реЛрдЧрд╛ рдФрд░ рдПрдХ рд╕рдВрджреЗрд╢ рд╣рдорд╛рд░реЗ рдЕрдкрд╡рд╛рдж рдкреЛрд░реНрдЯ рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛, рдЬрд┐рд╕ рдкрд░ рд╣рдо рдереНрд░реЗрдб рдХреА рд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ рд░рд┐рдЯрд░реНрди рдорд╛рди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╕рд░рд▓рддрд╛ рдХреЗ рд▓рд┐рдП рдореИрдВрдиреЗ рдЗрдпрд╛рди рдмреАрдпрд░ рдХреЗ рдЯреНрд░рд┐рдкрд▓_рдлреЗрдЪ рдзреЛрдЦрд╛рдзрдбрд╝реА рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЧрдП рд░рдгрдиреАрддрд┐ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдХреА рд╣реИ, рдЬрд┐рд╕рдореЗрдВ **`lr` рдХреЛ рдПрдХ рдРрд╕реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЗ рдкрддреЗ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдЕрдирдВрдд рд▓реВрдк рдХрд░реЗрдЧрд╛** рдФрд░ рдлрд┐рд░ рдереНрд░реЗрдб рдХреЗ рд░рдЬрд┐рд╕реНрдЯрд░ рдХреЛ рдмрд╛рд░-рдмрд╛рд░ рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВ рдЬрдм рддрдХ **`pc` рдЙрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛
### 3. рдореВрд▓ рдпрд╛рдж-рд▓реЗрдЦрди <a href="#step-3-basic-memory-readwrite" id="step-3-basic-memory-readwrite"></a>

рдЕрдм рд╣рдо рдирд┐рд╖реНрдкрд╛рджрди рдЖрдзрд╛рд░рднреВрдд рдпрд╛рдж-рд▓реЗрдЦрди рдФрд░ рд▓реЗрдЦрди рдЖрдзрд╛рд░рднреВрдд рдпрд╛рдж рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред рдпреЗ рдЖрдзрд╛рд░рднреВрдд рдпрд╛рдж рдмрд╣реБрдд рдХреБрдЫ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ (рд╣рдо рдЬрд▓реНрдж рд╣реА рдЕрдзрд┐рдХ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рдЖрдзрд╛рд░рднреВрдд рдХреЛ рдЕрдкрдЧреНрд░реЗрдб рдХрд░реЗрдВрдЧреЗ), рд▓реЗрдХрд┐рди рдпреЗ рд╣рдореЗрдВ рд░рд┐рдореЛрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдирд┐рдпрдВрддреНрд░рдг рдХреЛ рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдХрд░рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рдиреЗ рдХрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдХрджрдо рд╣реИред

рд╣рдорд╛рд░реЗ рдирд┐рд╖реНрдкрд╛рджрди рдЖрдзрд╛рд░рднреВрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрд╛рдж рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдЗрди рддрд░рд╣ рдХреЗ рдлрд╝рдВрдХреНрд╢рди рдХреА рддрд▓рд╛рд╢ рдХрд░реЗрдВрдЧреЗ:
```c
uint64_t read_func(uint64_t *address) {
return *address;
}
void write_func(uint64_t *address, uint64_t value) {
*address = value;
}
```
рд╡реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ рд╕рдорд╛рди рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ:
```
_read_func:
ldr     x0, [x0]
ret
_write_func:
str     x1, [x0]
ret
```
рдХреБрдЫ рд╕рд╛рдорд╛рдиреНрдп рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА рддреНрд╡рд░рд┐рдд рд╕реНрдХреИрди рдиреЗ рдХреБрдЫ рдЕрдЪреНрдЫреЗ рдЙрдореНрдореАрджрд╡рд╛рд░реЛрдВ рдХреА рдкрд╣рдЪрд╛рди рдХреАред рдореЗрдореЛрд░реА рдХреЛ рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо [Objective-C рд░рдирдЯрд╛рдЗрдо рдкреБрд╕реНрддрдХрд╛рд▓рдп](https://opensource.apple.com/source/objc4/objc4-723/runtime/objc-runtime-new.mm.auto.html) рдХреЗ `property_getName()` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```c
const char *property_getName(objc_property_t prop)
{
return prop->name;
}
```
рдЬреИрд╕рд╛ рдХрд┐ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ, `prop` `objc_property_t` рдХрд╛ рдкрд╣рд▓рд╛ рдлрд╝реАрд▓реНрдб рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕реАрдзреЗ рдЕрдиреБрдорд╛рдирд┐рдд `read_func` рдХреЗ рд╕рдорд╛рди рд╣реИред рд╣рдореЗрдВ рдмрд╕ рдкрд╣рд▓реЗ рддрд░реНрдХ рдХреЗ рд╕рд╛рде рдПрдХ рджреВрд░рд╕реНрде рдХрд╛рд░реНрдп рдХреЛрд▓ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдкрд╣рд▓рд╛ рддрд░реНрдХ рд╣рдореЗрдВ рдкрдардирд╛ рд╣реИ, рдФрд░ рд╡рд╛рдкрд╕реА рдореВрд▓реНрдп рдЙрд╕ рдкрддреЗ рдкрд░ рдбреЗрдЯрд╛ рд╣реЛрдЧрд╛ред

рдореЗрдореЛрд░реА рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреВрд░реНрд╡-рддреИрдпрд╛рд░ рдХрд╛рд░реНрдп рдвреВрдВрдврд╝рдирд╛ рдереЛрдбрд╝рд╛ рдореБрд╢реНрдХрд┐рд▓ рд╣реИ, рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рдмрд╛рд╡рдЬреВрдж рдЕрдирдЪрд╛рд╣реЗ рдкреНрд░рднрд╛рд╡реЛрдВ рдХреЗ рдмрд┐рдирд╛ рднреА рдмрдбрд╝реЗ рд╡рд┐рдХрд▓реНрдк рд╣реИрдВред libxpc рдореЗрдВ, `_xpc_int64_set_value()` рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдбрд┐рд╕рдЕрд╕реЗрдВрдмрд▓реА рд╣реЛрддрд╛ рд╣реИ:
```
__xpc_int64_set_value:
str     x1, [x0, #0x18]
ret
```
рдЗрд╕ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдареАрдХ рдкрддреЗ `address` рдкрд░ 64-рдмрд┐рдЯ рд▓реЗрдЦ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреВрд░рд╕реНрде рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```c
_xpc_int64_set_value(address - 0x18, value)
```
рдЗрди рдкреНрд░рд╛рдердорд┐рдХрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде, рд╣рдо рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рддреИрдпрд╛рд░ рд╣реИрдВред

### 4. рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА

рдЕрдЧрд▓рд╛ рдХрджрдо рд╣реИ рд░рд┐рдореЛрдЯ рдФрд░ рд╕реНрдерд╛рдиреАрдп рдЯрд╛рд╕реНрдХ рдХреЗ рдмреАрдЪ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдмрдирд╛рдирд╛ред рдЗрд╕рд╕реЗ рд╣рдореЗрдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдмреАрдЪ рдбреЗрдЯрд╛ рдХреЛ рдЖрд╕рд╛рдиреА рд╕реЗ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реЗрдЧреА: рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рдХреЗ рд╕рд╛рде, рд╡рд┐рдЪрд┐рддреНрд░ рдореЗрдореЛрд░реА рдкрдарди рдФрд░ рд▓реЗрдЦрди рдХреЛ `memcpy()` рдХреЗ рд░рд┐рдореЛрдЯ рдХреЙрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд░рдирд╛ рдЗрддрдирд╛ рд╕рд░рд▓ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рд╣реЛрдиреЗ рд╕реЗ рд╣рдореЗрдВ рдЖрд╕рд╛рдиреА рд╕реЗ рдПрдХ рд╕реНрдЯреИрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реЗрдЧреА, рддрд╛рдХрд┐ рд╣рдо 8 рд╕реЗ рдЕрдзрд┐рдХ рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХреЗрдВред

рдЪреАрдЬреЛрдВ рдХреЛ рдЖрд╕рд╛рди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рд▓рд┐рдмреНрд░реЗрд░реА libxpc рдХреА рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХрд╛ рдкреБрдирдГ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред Libxpc рдПрдХ XPC рдСрдмреНрдЬреЗрдХреНрдЯ рдкреНрд░рдХрд╛рд░, `OS_xpc_shmem` рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ XPC рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред Libxpc рдХреЛ рдкрд▓рдЯрдХрд░, рд╣рдо рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдХрд┐ `OS_xpc_shmem` рдореИрдЪ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ, рдЬреЛ рдореИрдЪ рдкреЛрд░реНрдЯ рд╣реИрдВ рдЬреЛ рдПрдХ рд╡рд░реНрдЪреБрдЕрд▓ рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рдХреЛ рдкреНрд░рддрд┐рд╖реНрдард┐рдд рдХрд░рддреЗ рд╣реИрдВред рдФрд░ рдХреНрдпреЛрдВрдХрд┐ рд╣рдо рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рджрд┐рдЦрд╛ рдЪреБрдХреЗ рд╣реИрдВ рдХрд┐ рд░рд┐рдореЛрдЯ рдЯрд╛рд╕реНрдХ рдХреЛ рдореИрдЪ рдкреЛрд░реНрдЯ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХреИрд╕реЗ рднреЗрдЬрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕реЗ рд╣рдо рдЕрдкрдиреА рд╕реНрд╡рдпрдВ рдХреА рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╕рд╛рдиреА рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ `mach_vm_allocate()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рд╡рд╛рд▓реА рдореЗрдореЛрд░реА рдХрд╛ рдЖрд╡рдВрдЯрди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рд╣рдореЗрдВ `mach_vm_allocate()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рддрд╛рдХрд┐ рд╣рдо `xpc_shmem_create()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреНрд╖реЗрддреНрд░ рдХреЗ рд▓рд┐рдП `OS_xpc_shmem` рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛ рд╕рдХреЗрдВред `xpc_shmem_create()` рд╣рдорд╛рд░реЗ рд▓рд┐рдП рдореИрдЪ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдХреЛ рдмрдирд╛рдиреЗ рдХрд╛ рдзреНрдпрд╛рди рд░рдЦреЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдЕрдиреБрдкреНрд░рдпреЛрдЧ `OS_xpc_shmem` рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ `0x18` рдСрдлрд╝рд╕реЗрдЯ рдкрд░ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдХреЗ рд▓рд┐рдП рдореИрдЪ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рд░рдЦреЗрдЧрд╛ред

рдПрдХ рдмрд╛рд░ рдЬрдм рд╣рдореЗрдВ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдкреЛрд░реНрдЯ рдорд┐рд▓ рдЬрд╛рдПрдЧрд╛, рд╣рдо рд░рд┐рдореЛрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдПрдХ `OS_xpc_shmem` рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рдПрдВрдЧреЗ рдЬреЛ рд╕рдорд╛рди рдореЗрдореЛрд░реА рдХреНрд╖реЗрддреНрд░ рдХреЛ рдкреНрд░рддрд┐рд╖реНрдард┐рдд рдХрд░реЗрдЧрд╛, рдЬрд┐рд╕рд╕реЗ рд╣рдо `xpc_shmem_map()` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдореИрдкрд┐рдВрдЧ рд╕реНрдерд╛рдкрд┐рдд рдХрд░ рд╕рдХреЗрдВрдЧреЗред рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдо рд░рд┐рдореЛрдЯ рдХреЙрд▓ рдХрд░рдХреЗ `malloc()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `OS_xpc_shmem` рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдЖрд╡рдВрдЯрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЕрдкрдиреА рдореВрд▓ рд▓рд┐рдЦрдиреЗ рдХреА рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реНрдерд╛рдиреАрдп `OS_xpc_shmem` рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рддреЗ рд╣реИрдВред рджреБрд░реНрднрд╛рдЧреНрдп рд╕реЗ, рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдСрдмреНрдЬреЗрдХреНрдЯ рдереЛрдбрд╝рд╛ рд╕рд╣реА рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ: рдЗрд╕рдХрд╛ рдореИрдЪ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдлрд╝реАрд▓реНрдб `0x18` рдСрдлрд╝рд╕реЗрдЯ рдкрд░ рд╕реНрдерд╛рдиреАрдп рдЯрд╛рд╕реНрдХ рдХреЗ рд▓рд┐рдП рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдХрд╛ рдирд╛рдо рд╢рд╛рдорд┐рд▓ рд╣реЛрддрд╛ рд╣реИ, рди рдХрд┐ рд░рд┐рдореЛрдЯ рдЯрд╛рд╕реНрдХ рдХрд╛ рдирд╛рдоред рдЗрд╕реЗ рдареАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо `thread_set_special_port()` рдЪрд╛рд▓ рдЪрд▓рд╛рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд░рд┐рдореЛрдЯ рдЯрд╛рд╕реНрдХ рдореЗрдВ рдореИрдЪ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ рднреЗрдЬрдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдбрд╛рд▓ рд╕рдХреЗрдВ рдФрд░ рдлрд┐рд░ рдлрд╝реАрд▓реНрдб `0x18` рдХреЛ рд░рд┐рдореЛрдЯ рдореЗрдореЛрд░реА рдПрдВрдЯреНрд░реА рдХреЗ рдирд╛рдо рд╕реЗ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░реЗрдВред рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд░рд┐рдореЛрдЯ `OS_xpc_shmem` рдСрдмреНрдЬреЗрдХреНрдЯ рдорд╛рдиреНрдп рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдореЗрдореЛрд░реА рдореИрдкрд┐рдВрдЧ рдХреЛ рд░рд┐рдореЛрдЯ рдХреЙрд▓ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ `xpc_shmem_remote()`ред

### 5. рдкреВрд░реНрдг рдирд┐рдпрдВрддреНрд░рдг <a href="#step-5-full-control" id="step-5-full-control"></a>

рдирд┐рд╢реНрдЪрд┐рдд рдкрддреЗ рдкрд░ рд╕рд╛рдЭрд╛ рдореЗрдореЛрд░реА рдФрд░ рдПрдХ рдРрдЪреНрдЫрд┐рдХ рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рдХреЗ рд╕рд╛рде, рд╣рдо рдмрд╕ рдЦрддреНрдо рд╣реЛ рдЬрд╛рддреЗ рд╣реИрдВред рд╡рд┐рдЪрд┐рддреНрд░ рдореЗрдореЛрд░реА рдкрдарди рдФрд░ рд▓реЗрдЦрди рдХреЛ `memcpy()` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рд╕рд╛рдЭрд╛ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред 8 рд╕реЗ рдЕрдзрд┐рдХ рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХреЙрд▓рд┐рдВрдЧ рдирд┐рдпрдо рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдкрд╣рд▓реЗ 8 рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдЕрддрд┐рд░рд┐рдХреНрдд рддрд░реНрдХреЛрдВ рдХреЛ рд╕реНрдЯреИрдХ рдкрд░ рд╡реНрдпрд╡рд╕реНрдерд┐рдд рдХрд░рдХреЗ рдХрд░рддреЗ рд╣реИрдВред рдЯрд╛рд╕реНрдХ рдХреЗ рдмреАрдЪ рд╡рд┐рдЪрд┐рддреНрд░ рдореИрдЪ рдкреЛрд░реНрдЯ рдХреЛ рдореИрдЪ рд╕рдВрджреЗрд╢ рднреЗрдЬрдХрд░ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╣рдо рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рдмреАрдЪ рдлрд╝рд╛рдЗрд▓ рдбреЗрд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рднреА рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рддрд┐рдЧреБрдирд╛ рд▓рд╛рдн рдХреЗ рд▓рд┐рдП рдЗрд╕ рддрдХрдиреАрдХ рдХреЛ рджрд┐рдЦрд╛рдиреЗ рдХреЗ рд▓рд┐рдП Ian Beer рдХрд╛ рдзрдиреНрдпрд╡рд╛рдж рджреЗрддреЗ рд╣реИрдВ!)ред

рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ, рдЕрдм рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдкреАрдбрд╝рд┐
