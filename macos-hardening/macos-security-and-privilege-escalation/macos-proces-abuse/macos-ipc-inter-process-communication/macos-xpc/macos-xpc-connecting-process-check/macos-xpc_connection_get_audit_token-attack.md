# Επίθεση xpc\_connection\_get\_audit\_token στο macOS

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs** στα αποθετήρια του [**HackTricks**](https://github.com/carlospolop/hacktricks) και του [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) στο github.

</details>

**Για περαιτέρω πληροφορίες, ελέγξτε την αρχική ανάρτηση: [https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/)**. Αυτό είναι ένα σύνοψη:


## Βασικές πληροφορίες για τα Mach Messages

Εάν δεν γνωρίζετε τι είναι τα Mach Messages, αρχίστε ελέγχοντας αυτήν τη σελίδα:

{% content-ref url="../../../../mac-os-architecture/macos-ipc-inter-process-communication/" %}
[macos-ipc-inter-process-communication](../../../../mac-os-architecture/macos-ipc-inter-process-communication/)
{% endcontent-ref %}

Για την ώρα, θυμηθείτε ότι ([ορισμός από εδώ](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):\
Τα Mach μηνύματα αποστέλλονται μέσω ενός _mach port_, το οποίο είναι ένας **μοναδικός παραλήπτης, πολλαπλοί αποστολείς** κανάλι επικοινωνίας που έχει ενσωματωθεί στον πυρήνα mach. **Πολλές διεργασίες μπορούν να στείλουν μηνύματα** σε ένα mach port, αλλά ανά πάσα στιγμή **μόνο μια διεργασία μπορεί να τα διαβάσει**. Όπως και οι περιγραφείς αρχείων και τα sockets, τα mach ports εκχωρούνται και διαχειρίζονται από τον πυρήνα και οι διεργασίες βλέπουν μόνο έναν ακέραιο αριθμό, τον οποίο μπορούν να χρησιμοποιήσουν για να υποδείξουν στον πυρήνα ποιο από τα mach ports τους θέλουν να χρησιμοποιήσουν.

## Σύνδεση XPC

Εάν δεν γνωρίζετε πώς δημιουργείται μια σύνδεση XPC, ελέγξτε:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## Σύνοψη ευπάθειας

Αυτό που είναι ενδιαφέρον για εσάς να γνωρίζετε είναι ότι η αφαίρεση του XPC είναι μια σύνδεση μιας προς μία, αλλά βασίζεται σε μια τεχνολογία που **μπορεί να έχει πολλούς αποστολείς**, έτσι:

* Τα mach ports είναι μοναδικοί παραλήπτες, **πολλαπλοί αποστολείς**.
* Το audit token μιας σύνδεσης XPC είναι το audit token που **αντιγράφηκε από το πιο πρόσφατο ληφθέν μήνυμα**.
* Η απόκτηση του **audit token** μιας σύνδεσης XPC είναι κρίσιμη για πολλούς **έλεγχους ασφαλείας**.

Παρόλο που η προηγούμενη κα
4. Το επόμενο βήμα περιλαμβάνει την εντολή του `diagnosticd` να ξεκινήσει την παρακολούθηση ενός επιλεγμένου διεργασίας (πιθανώς της ίδιας του χρήστη). Ταυτόχρονα, αποστέλλεται ένας κατακλυσμός από κανονικά μηνύματα 1004 στο `smd`. Ο σκοπός εδώ είναι να εγκατασταθεί ένα εργαλείο με αυξημένα προνόμια.
5. Αυτή η ενέργεια προκαλεί μια κούρσα συνθηκών μέσα στη συνάρτηση `handle_bless`. Ο χρονισμός είναι κρίσιμος: η κλήση της συνάρτησης `xpc_connection_get_pid` πρέπει να επιστρέψει το PID της διεργασίας του χρήστη (καθώς το εργαλείο με τα προνόμια βρίσκεται στο bundle της εφαρμογής του χρήστη). Ωστόσο, η συνάρτηση `xpc_connection_get_audit_token`, ειδικότερα μέσα στην υπορουτίνα `connection_is_authorized`, πρέπει να αναφέρεται στο αναγνωριστικό ελέγχου που ανήκει στο `diagnosticd`.

## Παραλλαγή 2: προώθηση απάντησης

Σε ένα περιβάλλον XPC (Cross-Process Communication), αν και οι χειριστές γεγονότων δεν εκτελούνται ταυτόχρονα, η χειριστής των μηνυμάτων απάντησης έχει ένα μοναδικό συμπεριφορά. Συγκεκριμένα, υπάρχουν δύο διακριτές μεθόδοι για την αποστολή μηνυμάτων που αναμένουν μια απάντηση:

1. **`xpc_connection_send_message_with_reply`**: Εδώ, το μήνυμα XPC λαμβάνεται και επεξεργάζεται σε μια καθορισμένη ουρά.
2. **`xpc_connection_send_message_with_reply_sync`**: Αντίθετα, σε αυτήν τη μέθοδο, το μήνυμα XPC λαμβάνεται και επεξεργάζεται στην τρέχουσα ουρά εκτέλεσης.

Αυτή η διάκριση είναι κρίσιμη επειδή επιτρέπει τη δυνατότητα **παράλληλης ανάλυσης των πακέτων απάντησης με την εκτέλεση ενός χειριστή γεγονότος XPC**. Είναι σημαντικό να σημειωθεί ότι, ενώ η `_xpc_connection_set_creds` υλοποιεί κλειδαριές για την προστασία από τη μερική αντικατάσταση του αναγνωριστικού ελέγχου, δεν επεκτείνει αυτήν την προστασία σε ολόκληρο το αντικείμενο σύνδεσης. Ως αποτέλεσμα, δημιουργείται μια ευπάθεια όπου το αναγνωριστικό ελέγχου μπορεί να αντικατασταθεί κατά το διάστημα μεταξύ της ανάλυσης ενός πακέτου και της εκτέλεσης του χειριστή γεγονότος του.

Για να εκμεταλλευτείτε αυτήν την ευπάθεια, απαιτείται η ακόλουθη ρύθμιση:

- Δύο υπηρεσίες mach, που αναφέρονται ως **`A`** και **`B`**, και οι δύο μπορούν να εγκαθιδρύσουν μια σύνδεση.
- Η υπηρεσία **`A`** πρέπει να περιλαμβάνει έλεγχο εξουσιοδότησης για μια συγκεκριμένη ενέργεια που μόνο η **`B`** μπορεί να εκτελέσει (η εφαρμογή του χρήστη δεν μπορεί).
- Η υπηρεσία **`A`** πρέπει να στείλει ένα μήνυμα που αναμένει μια απάντηση.
- Ο χρήστης μπορεί να στείλει ένα μήνυμα στη **`B`** στο οποίο αυτή θα απαντήσει.

Η διαδικασία εκμετάλλευσης περιλαμβάνει τα εξής βήματα:

1. Αναμονή για την υπηρεσία **`A`** να στείλει ένα μήνυμα που αναμένει μια απάντηση.
2. Αντί να απαντήσει απευθείας στη **`A`**, η θύρα απάντησης καταλαμβάνεται και χρησιμοποιείται για να σταλεί ένα μήνυμα στην υπηρεσία **`B`**.
3. Στη συνέχεια, αποστέλλεται ένα μήνυμα που αφορά την απαγορευμένη ενέργεια, με την προσδοκία ότι θα επεξεργαστεί παράλληλα με την απάντηση από την **`B`**.

Παρακάτω παρουσιάζεται μια οπτική αναπαράσταση του περιγραφόμενου σεναρίου επίθεσης:

![https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/variant2.png](../../../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png)


<figure><img src="../../../../../../.gitbook/assets/image (1) (1) (1)
