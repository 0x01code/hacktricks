# macOS xpc\_connection\_get\_audit\_token рд╣рдорд▓рд╛

<details>

<summary><strong>рдЬреАрд░реЛ рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди **The PEASS Family** рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдореВрд▓ рдкреЛрд╕реНрдЯ рджреЗрдЦреЗрдВ:** [**https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/**](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/). рдпрд╣ рдПрдХ рд╕рд╛рд░рд╛рдВрд╢ рд╣реИ:

## Mach Messages рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

рдЕрдЧрд░ рдЖрдкрдХреЛ рдкрддрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ Mach Messages рдХреНрдпрд╛ рд╣реИрдВ, рддреЛ рдЗрд╕ рдкреЗрдЬ рдХреА рдЬрд╛рдБрдЪ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ:

{% content-ref url="../../../../mac-os-architecture/macos-ipc-inter-process-communication/" %}
[macos-ipc-inter-process-communication](../../../../mac-os-architecture/macos-ipc-inter-process-communication/)
{% endcontent-ref %}

рдЗрд╕ рд╕рдордп рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ ([рдпрд╣рд╛рдБ рд╕реЗ рдкрд░рд┐рднрд╛рд╖рд╛](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):\
Mach messages _mach port_ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЬреЛ рдореИрдХ рдХрд░реНрдирд▓ рдореЗрдВ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ **рдПрдХрд▓ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛, рдПрдХрд╛рдзрд┐рдХ рдкреНрд░реЗрд╖рдХ рд╕рдВрдЪрд╛рд░** рдЪреИрдирд▓ рд╣реИред **рдПрдХрд╛рдзрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ** рдПрдХ рдореИрдХ рдкреЛрд░реНрдЯ рдХреЛ рдореИрд╕реЗрдЬ рднреЗрдЬ рд╕рдХрддреА рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХрд┐рд╕реА рднреА рд╕рдордп **рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛** рдЗрд╕реЗ рдкрдврд╝ рд╕рдХрддреА рд╣реИред рдлрд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдФрд░ рд╕реЙрдХреЗрдЯ рдХреА рддрд░рд╣, рдореИрдХ рдкреЛрд░реНрдЯреНрд╕ рдХрд░реНрдирд▓ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рдВрдЯрд┐рдд рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдБ рдХреЗрд╡рд▓ рдПрдХ рдкреВрд░реНрдгрд╛рдВрдХ рджреЗрдЦрддреА рд╣реИрдВ, рдЬрд┐рд╕реЗ рд╡реЗ рдХрд░реНрдирд▓ рдХреЛ рдЗрдВрдбрд┐рдХреЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреА рд╣реИрдВ рдХрд┐ рд╡реЗ рдЕрдкрдиреЗ рдореИрдХ рдкреЛрд░реНрдЯреНрд╕ рдореЗрдВ рд╕реЗ рдХреМрди рд╕рд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реИрдВред

## XPC рдХрдиреЗрдХреНрд╢рди

рдЕрдЧрд░ рдЖрдкрдХреЛ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ XPC рдХрдиреЗрдХреНрд╢рди рдХреИрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЬрд╛рдБрдЪреЗрдВ:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## рд╕реБрд░рдХреНрд╖рд╛ рд╕рдВрдХреНрд╖реЗрдк

рдЖрдкрдХреЗ рд▓рд┐рдП рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХрд┐ **XPC рдХрд╛ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рдПрдХ-рд╕реЗ-рдПрдХ рдХрдиреЗрдХреНрд╢рди** рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдПрдХ рд╕реЗ рдЕрдзрд┐рдХ рдкреНрд░реЗрд╖рдХ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП:**

* Mach рдкреЛрд░реНрдЯреНрд╕ рдПрдХрд▓ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛, **рдПрдХрд╛рдзрд┐рдХ рдкреНрд░реЗрд╖рдХ** рд╣реИрдВред
* рдПрдХ XPC рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдСрдбрд┐рдЯ рдЯреЛрдХрди **рд╕рдмрд╕реЗ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рд╕рдВрджреЗрд╢ рд╕реЗ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ**ред
* рдПрдХ XPC рдХрдиреЗрдХреНрд╢рди рдХреЗ **рдСрдбрд┐рдЯ рдЯреЛрдХрди** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рдХрдИ **рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ** рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐ рдкрд┐рдЫрд▓реА рд╕реНрдерд┐рддрд┐ рдЖрд╢рд╛рдЬрдирдХ рд▓рдЧрддреА рд╣реИ, рд╡рд╣рд╛рдБ рдХреБрдЫ рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рд╣реИрдВ рдЬрд╣рд╛рдБ рдпрд╣ рд╕рдорд╕реНрдпрд╛рдПрдБ рдирд╣реАрдВ рдЙрддреНрдкрдиреНрди рд╣реЛрдВрдЧреА ([рдпрд╣рд╛рдБ рд╕реЗ](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):

* рдСрдбрд┐рдЯ рдЯреЛрдХрди рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдЕрдХреНрд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕реЗрд╡рд╛ рдкреЛрд░реНрдЯ рдХреЗ рдПрдХ рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рдХрд╛ **рдХреЛрдИ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ**ред рдЗрд╕ рдкреЛрд░реНрдЯ рдкрд░ рдЕрдзрд┐рдХ рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрдиреЗрдХреНрд╢рди рдЕрдиреБрд░реЛрдз рдХреЗ рд░реВрдк рдореЗрдВ рд╣реИрдВрдбрд▓ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП **рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХрд┐рд╕реА рднреА рдЬрд╛рдВрдЪ** (рдпрд╣ рдпрд╣ рднреА рдорддрд▓рдм рд╣реИ рдХрд┐ `-listener:shouldAcceptNewConnection:` рдХреЗ рднреАрддрд░ рдСрдбрд┐рдЯ рдЯреЛрдХрди рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ)ред рд╣рдо рдЗрд╕рд▓рд┐рдП **рдРрд╕реЗ XPC рдХрдиреЗрдХреНрд╢рди рдвреВрдВрдврд╝ рд░рд╣реЗ рд╣реИрдВ рдЬреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХреНрд░рд┐рдпрд╛рдПрдБ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддреЗ рд╣реИрдВ**ред
* XPC рдШрдЯрдирд╛ рд╣реИрдВрдбрд▓рд░ рд╕рдордХрд╛рд▓рд┐рдХ рд░реВрдк рд╕реЗ рд╣реИрдВрдбрд▓ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╕рдВрджреЗрд╢ рдХреЗ рд▓рд┐рдП рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЛ рдкреВрд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП рдкрд╣рд▓реЗ рдЙрд╕рдХреЗ рдмрд╛рдж рдЙрд╕рдХреЗ рд▓рд┐рдП рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдП, рдпрд╣рд╛рдБ рддрдХ рдХрд┐ рд╕рдордХрд╛рд▓рд┐рдХ рдбрд┐рд╕реНрдкреИрдЪ рдХреНрдпреВрдЬрд╝ рдкрд░ рднреАред рдЗрд╕рд▓рд┐рдП рдПрдХ **XPC рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рднреАрддрд░ рдСрдбрд┐рдЯ рдЯреЛрдХрди** рдХреЛ рдЕрдиреНрдп рд╕рд╛рдзрд╛рд░рд┐рдд (рдЧреИрд░-рдЬрд╡рд╛рдм!) рд╕рдВрджреЗрд╢ рджреНрд╡рд╛рд░рд╛ рдЕрдзрд┐рд▓рд┐рдЦрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред

рдЗрд╕рдХреЛ рджреЛ рд╡рд┐рднрд┐рдиреНрди рддрд░реАрдХреЛрдВ рд╕реЗ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

1. рд╡реЗрд░рд┐рдПрдВрдЯ1:
* **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рд╕реЗрд╡рд╛ **A** рдФрд░ рд╕реЗрд╡рд╛ **B** рд╕реЗ **рдХрдиреЗрдХреНрдЯ** рдХрд░рддрд╛ рд╣реИ
* рд╕реЗрд╡рд╛ **B** рд╕реЗрд╡рд╛ **A** рдореЗрдВ рдПрдХ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдХрд╛рд░реНрдп** рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛
* рд╕реЗрд╡рд╛ **A** **`xpc_connection_get_audit_token`** рдХреЛ рдХреЙрд▓ рдХрд░рддреА рд╣реИ рдЬрдмрдХрд┐ рдПрдХ **рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░** рдореЗрдВ рдирд╣реАрдВ рд╣реИ рдПрдХ **`dispatch_async`** рдореЗрдВред
* рдЗрд╕рд▓рд┐рдП рдПрдХ **рд╡рд┐рднрд┐рдиреНрди** рд╕рдВрджреЗрд╢ **рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдЕрдзрд┐рд▓рд┐рдЦрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рдмрд╛рд╣рд░ рдЕрд╕рдордпрд┐рдХ рд░реВрдк рд╕реЗ рдбрд┐рд╕реНрдкреИрдЪ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред
* рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ **рд╕реЗрд╡рд╛ A рдХреЛ SEND рд░рд╛рдЗрдЯ рд╕реЗрд╡рд╛ B рдХреЛ рдкрд╛рд╕** рдХрд░рддрд╛ рд╣реИред
* рдЗрд╕рд▓рд┐рдП рд╕реЗрд╡рд╛ **B** рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╕реЗрд╡рд╛ **A** рдХреЛ **рд╕рдВрджреЗрд╢** рднреЗрдЬ рд░рд╣реА рд╣реИред
* **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рдХреЛ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдХреНрд░рд┐рдпрд╛ рдХреЙрд▓** рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддрд╛ рд╣реИред рдПрдХ RC рд╕реЗрд╡рд╛ **A** рдЗрд╕ **рдХреНрд░рд┐рдпрд╛** рдХреА рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреА рд╣реИ рдЬрдмрдХрд┐ **рд╕реЗрд╡рд╛ B рдиреЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдЕрдзрд┐рд▓рд┐рдЦрд┐рдд рдХрд┐рдпрд╛** рд╣реИ (рдЬрд┐рд╕рд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдХреНрд░рд┐рдпрд╛ рдХреЙрд▓ рдХрд░рдиреЗ рдХрд╛ рдЕрдзрд┐рдХрд╛рд░ рдорд┐рд▓рддрд╛ рд╣реИ)ред
2. рд╡реЗрд░рд┐рдПрдВрдЯ 2:
* рд╕реЗрд╡рд╛ **B** рд╕реЗрд╡рд╛ **A** рдореЗрдВ рдПрдХ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдХрд╛рд░реНрдп** рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреА рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛
* рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ **рд╕реЗрд╡рд╛ A** рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдиреЗ рдПрдХ **рд╡рд┐рд╢реЗрд╖ рдЬрд╡рд╛рдм рдХреА рдЙрдореНрдореАрдж** рдореЗрдВ рдПрдХ **рд╕рдВрджреЗрд╢ рднреЗрдЬрд╛** рд╣реИ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ **рд░рд┐рдкреНрд▓реЗ** **рдкреЛрд░реНрдЯ** рдореЗрдВред
* рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╕реЗрд╡рд╛ **B** рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ рдЬреЛ **рдЙрд╕ рд░рд┐рдкреНрд▓рд╛рдИ рдкреЛрд░реНрдЯ** рдХреЛ рдкрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИред
* рдЬрдм рд╕реЗрд╡рд╛ **B рдЬрд╡рд╛рдм рджреЗрддреА рд╣реИ**, рддреЛ рд╡рд╣ рд╕рдВрджреЗрд╢ рд╕реЗрд╡рд╛ **A рдХреЛ рднреЗрдЬрддреА рд╣реИ**, **рдЬрдмрдХрд┐** **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рдПрдХ рд╡рд┐рднрд┐рдиреНрди **рд╕рдВрджреЗрд╢ рд╕реЗрд╡рд╛ A рдХреЛ** рднреЗрдЬрддрд╛ рд╣реИ рдЬреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЙрдореНрдореАрдж рдХрд░ рд░рд╣рд╛ рд╣реИ рдХрд┐ рд╕реЗрд╡рд╛ B рд╕реЗ рдЖрдиреЗ рд╡рд╛рд▓рд╛ рдЬрд╡рд╛рдм рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рд╕рд╣реА рд╕рдордп рдкрд░ рдЕрдзрд┐рд▓рд┐рдЦрд┐рдд рдХрд░реЗрдЧрд╛ (рд░реЗрд╕ рдХрдВрдбреАрд╢рди)ред

## рд╡реЗрд░рд┐рдПрдВрдЯ 1: рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рдмрд╛рд╣рд░ xpc\_connection\_get\_audit\_token рдХреЙрд▓ рдХрд░рдирд╛ <a href="#variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler" id="variant-1-calling-xpc
4. рдЕрдЧрд▓рд╛ рдХрджрдо рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ `diagnosticd` рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкреНрд░рдХреНрд░рд┐рдпрд╛ (рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдЕрдкрдиреА) рдХреА рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рд╕рд╛рде рд╣реА, `smd` рдХреЛ рдПрдХ рдмрд╛рд░реАрдХ 1004 рд╕рдВрджреЗрд╢реЛрдВ рдХрд╛ рдмрд╛рдврд╝ рднреЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣рд╛рдБ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рдЙрдЪреНрдЪ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рд╡рд╛рд▓реЗ рдПрдХ рдЙрдкрдХрд░рдг рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИред
5. рдпрд╣ рдХрд╛рд░реНрд░рд╡рд╛рдИ `handle_bless` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рднреАрддрд░ рдПрдХ рд░реЗрд╕ рдХрдВрдбреАрд╢рди рдХреЛ рдкреНрд░реЗрд░рд┐рдд рдХрд░рддреА рд╣реИред рд╕рдордпрд┐рдХрддрд╛ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ: `xpc_connection_get_pid` рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдирд╛ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдкреАрдЖрдИрдбреА рд╡рд╛рдкрд╕ рдЖрдП (рдХреНрдпреЛрдВрдХрд┐ рдЙрдЪреНрдЪ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рд╡рд╛рд▓рд╛ рдЙрдкрдХрд░рдг рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдРрдк рдмрдВрдбрд▓ рдореЗрдВ рд╕реНрдерд┐рдд рд╣реИ)ред рд╣рд╛рд▓рд╛рдВрдХрд┐, `xpc_connection_get_audit_token` рдлрд╝рдВрдХреНрд╢рди, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ `connection_is_authorized` рд╕рдмрд░реВрдЯреАрди рдХреЗ рднреАрддрд░, `diagnosticd` рдХреЗ рд╕реНрд╡рд╛рдорд┐рддреНрд╡ рдореЗрдВ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХрд╛ рд╕рдВрджрд░реНрдн рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред
