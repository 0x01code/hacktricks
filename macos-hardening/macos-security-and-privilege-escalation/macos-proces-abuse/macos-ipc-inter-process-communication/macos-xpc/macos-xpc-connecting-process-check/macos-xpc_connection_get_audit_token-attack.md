# macOS xpc\_connection\_get\_audit\_token рд╣рдорд▓рд╛

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреА рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓** рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ**

</details>

**рдпрд╣ рддрдХрдиреАрдХ** [**https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/**](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/) **рд╕реЗ рдХреЙрдкреА рдХреА рдЧрдИ рд╣реИ**

## Mach рд╕рдВрджреЗрд╢ рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

рдпрджрд┐ рдЖрдкрдХреЛ рдкрддрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ Mach рд╕рдВрджреЗрд╢ рдХреНрдпрд╛ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕ рдкреГрд╖реНрда рдХреА рдЬрд╛рдВрдЪ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░реЗрдВ:

{% content-ref url="../../../../mac-os-architecture/macos-ipc-inter-process-communication/" %}
[macos-ipc-inter-process-communication](../../../../mac-os-architecture/macos-ipc-inter-process-communication/)
{% endcontent-ref %}

рдЕрднреА рдХреЗ рд▓рд┐рдП рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐:\
Mach рд╕рдВрджреЗрд╢ _mach рдкреЛрд░реНрдЯ_ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЬреЛ рдореИрдХрд░реНрдирд▓ рдореЗрдВ рдмрдиреЗ рдПрдХ **рдПрдХрд▓ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛, рдПрдХрд╛рдзрд┐рдХ рднреЗрдЬрдиреЗ рд╡рд╛рд▓рд╛ рд╕рдВрдЪрд╛рд░** рдЪреИрдирд▓ рд╣реИред **рдПрдХрд╛рдзрд┐рдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреА рд╣реИрдВ** рдПрдХ рдореИрдХ рдкреЛрд░реНрдЯ рдХреЛ, рд▓реЗрдХрд┐рди рдХрд┐рд╕реА рднреА рд╕рдордп **рдХреЗрд╡рд▓ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рдВрджреЗрд╢ рдкрдврд╝ рд╕рдХрддреА рд╣реИ**ред рдлрд╝рд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдФрд░ рд╕реЙрдХреЗрдЯ рдХреА рддрд░рд╣, рдореИрдХ рдкреЛрд░реНрдЯ рдХрд░реНрдирд▓ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рдВрдЯрд┐рдд рдФрд░ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рдХреЗрд╡рд▓ рдПрдХ рдкреВрд░реНрдгрд╛рдВрдХ рджреЗрдЦрддреА рд╣реИрдВ, рдЬрд┐рд╕реЗ рд╡реЗ рдХрд░реНрдирд▓ рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреА рд╣реИрдВ рдХрд┐ рд╡реЗ рдЕрдкрдиреЗ рдореИрдХ рдкреЛрд░реНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреА рд╣реИрдВред

## XPC рдХрдиреЗрдХреНрд╢рди

рдпрджрд┐ рдЖрдкрдХреЛ рдкрддрд╛ рдирд╣реАрдВ рд╣реИ рдХрд┐ XPC рдХрдиреЗрдХреНрд╢рди рдХреИрд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЬрд╛рдВрдЪреЗрдВ:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## Vuln рд╕рд╛рд░рд╛рдВрд╢

рдЖрдкрдХреЗ рд▓рд┐рдП рджрд┐рд▓рдЪрд╕реНрдк рд╣реЛрдиреЗ рд╡рд╛рд▓реА рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ **XPC рдХрд╛ рдЕрднрд┐рдХрд▓реНрдкрди рдПрдХ-рд╕реЗ-рдПрдХ рдХрдиреЗрдХреНрд╢рди рд╣реИ**, рд▓реЗрдХрд┐рди рдпрд╣ рдПрдХ рддрдХрдиреАрдХ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдЬрд┐рд╕рдореЗрдВ **рдПрдХрд╛рдзрд┐рдХ рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП:

* Mach рдкреЛрд░реНрдЯ рдПрдХрд▓ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛, _**рдПрдХрд╛рдзрд┐рдХ рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ**_ рд╣реЛрддреЗ рд╣реИрдВред
* XPC рдХрдиреЗрдХреНрд╢рди рдХрд╛ рдСрдбрд┐рдЯ рдЯреЛрдХрди _**рд╕рдмрд╕реЗ рд╣рд╛рд▓ рд╣реА рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рд╕рдВрджреЗрд╢ рд╕реЗ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**_ред
* XPC рдХрдиреЗрдХреНрд╢рди рдХреЗ **рдСрдбрд┐рдЯ рдЯреЛрдХрди** рдХреЛ рдмрд╣реБрдд рд╕рд╛рд░реЗ **рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ** рдХреЗ рд▓рд┐рдП рдкреНрд░рд╛рдердорд┐рдХрддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рдкрд┐рдЫрд▓реА рд╕реНрдерд┐рддрд┐ рд╡рд╛рджрд╛рд╕реНрддрд╡рд┐рдХ рд▓рдЧрддреА рд╣реИ, рдЬрд╣рд╛рдВ рдпрд╣ рд╕рдорд╕реНрдпрд╛ рдЙрддреНрдкрдиреНрди рдирд╣реАрдВ рд╣реЛрдЧреА:

* рдСрдбрд┐рдЯ рдЯреЛрдХрди рдЕрдХреНрд╕рд░ рдПрдХ рдЕрдзрд┐рдХреГрддрддрд╛ рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рд╣реЛрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдХрдиреЗрдХреНрд╢рди рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдВрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕реЗрд╡рд╛ рдкреЛрд░реНрдЯ рдХреЛ рдХрд░рддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП **рдЕрднреА рддрдХ рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд рдирд╣реАрдВ рд╣реБрдЖ рд╣реИ**ред рдЗрд╕ рдкреЛрд░реНрдЯ рдкрд░ рдЕрдзрд┐рдХ рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ рдЕрддрд┐рд░рд┐рдХреНрдд рдХрдиреЗрдХреНрд╢рди рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реИрдВрдбрд▓ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП рдХрд┐рд╕реА рднреА **рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдХреА рдЬрд╛рдВрдЪреЗрдВ рд╡рд┐рдХрд▓реНрдкрдирд╢реАрд▓ рдирд╣реАрдВ рд╣реЛрддреАрдВ** (рдЗрд╕рдХрд╛ рдпрд╣ рднреА рдорддрд▓рдм рд╣реИ рдХрд┐ `-listener:shouldAcceptNewConnection:` рдХреЗ рднреАрддрд░ рдСрдбрд┐рдЯ рдЯреЛрдХрди рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ
## рд╡реЗрд░рд┐рдПрдВрдЯ 1: рдЗрд╡реЗрдВрдЯ рд╣реИрдВрдбрд▓рд░ рдХреЗ рдмрд╛рд╣рд░ xpc_connection_get_audit_token рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ <a href="#variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler" id="variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler"></a>

рдкрд░рд┐рджреГрд╢реНрдп:

* рджреЛ рдореИрдХ **рд╕реЗрд╡рд╛рдПрдВ** _**A**_ рдФрд░ _**B**_ рдЬрд┐рдирд╕реЗ рд╣рдо рджреЛрдиреЛрдВ рдХрдиреЗрдХреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдФрд░ рдХрдиреЗрдХреНрд╢рди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг рдЬрд╛рдВрдЪреЛрдВ рдкрд░ рдЖрдзрд╛рд░рд┐рдд)ред
* _**A**_ рдХреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖ **рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг рдЬрд╛рдВрдЪ** рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ _**B**_ рдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ (рд▓реЗрдХрд┐рди рд╣рдорд╛рд░реЗ рдРрдк рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛)ред
* рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ B рдХреЗ рдкрд╛рд╕ рдХреБрдЫ **рдЕрдзрд┐рдХрд╛рд░** рд╣реИрдВ рдпрд╛ рдпрд╣ **рд░реВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рддреЛ рдпрд╣ рдЙрд╕реЗ рдЕрдзрд┐рдХрд╛рд░реАрдХреГрдд рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред
* рдЗрд╕ рдЕрдзрд┐рдХрд╛рд░реАрдХрд░рдг рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП, _**A**_ **рдЕрд╕рд┐рдВрдХреНрд░реЛрдирд╕реНрд▓реА рдСрдбрд┐рдЯ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ**, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `dispatch_async` рд╕реЗ `xpc_connection_get_audit_token` рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗред

{% hint style="danger" %}
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рд░реЗрд╕ рдХрдВрдбреАрд╢рди** рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рдПрдХ **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рдмрдирд╛рддрд╛ рд╣реИ рдЬреЛ **A рд╕реЗ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рддрд╛ рд╣реИ** рдХрдИ рдмрд╛рд░ рдЬрдмрдХрд┐ **B A рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ**ред рдЬрдм RC **рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ**, рддреЛ **B** рдХрд╛ **рдСрдбрд┐рдЯ рдЯреЛрдХрди** рдореЗрдореЛрд░реА рдореЗрдВ рдХреЙрдкреА рд╣реЛ рдЬрд╛рдПрдЧрд╛ **рдЬрдмрдХрд┐** рд╣рдорд╛рд░реЗ **рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ** рдХрд╛ рдЕрдиреБрд░реЛрдз A рджреНрд╡рд╛рд░рд╛ **рд╣реИрдВрдбрд▓** рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕реЗ **рдЕрдзрд┐рдХрд╛рд░реА рдХрд╛рд░реНрд░рд╡рд╛рдИ рддрдХ рдкрд╣реБрдВрдЪ рдорд┐рд▓рддреА рд╣реИ рдЬрд┐рд╕реЗ рдХреЗрд╡рд▓ B рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред
{% endhint %}

рдпрд╣ _**A**_ рдХреЗ рд░реВрдк рдореЗрдВ `smd` рдФрд░ _**B**_ рдХреЗ рд░реВрдк рдореЗрдВ `diagnosticd` рдХреЗ рд╕рд╛рде рд╣реБрдЖред [`SMJobBless`](https://developer.apple.com/documentation/servicemanagement/1431078-smjobbless?language=objc) рд╕реЗ smb рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдирдпрд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рд╕рд╣рд╛рдпрдХ рдЯреВрд▓ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ **рд░реВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ)ред рдпрджрд┐ **рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕рдВрдкрд░реНрдХ** рдХрд░рддреА рд╣реИ **smd**, рддреЛ рдХреЛрдИ рдЕрдиреНрдп рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рдЬрд╛рдПрдЧреАред

рдЗрд╕рд▓рд┐рдП, рд╕реЗрд╡рд╛ **B** **`diagnosticd`** рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **рд░реВрдЯ** рдХреЗ рд░реВрдк рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ **рдореЙрдирд┐рдЯрд░** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдПрдХ рдмрд╛рд░ рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рд╢реБрд░реВ рд╣реЛ рдЬрд╛рдПрдЧреА, рдпрд╣ **рд╣рд░ рд╕реЗрдХрдВрдб рдПрдХрд╛рдзрд┐рдХ рд╕рдВрджреЗрд╢ рднреЗрдЬреЗрдЧрд╛ред**

рд╣рдо рд╣рдорд▓рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрд░рддреЗ рд╣реИрдВ:

1. рд╣рдо рдЖрдо XPC рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдкрд╛рд▓рди рдХрд░рдХреЗ **`smd`** рдХреЗ рд╕рд╛рде рдЕрдкрдирд╛ **рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд** рдХрд░рддреЗ рд╣реИрдВред
2. рдлрд┐рд░, рд╣рдо **`diagnosticd`** рдХреЗ рд╕рд╛рде рдПрдХ **рдХрдиреЗрдХреНрд╢рди рд╕реНрдерд╛рдкрд┐рдд** рдХрд░рддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рджреЛ рдирдП рдореИрдХ рдкреЛрд░реНрдЯ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдФрд░ рдЙрдиреНрд╣реЗрдВ рднреЗрдЬрдиреЗ рдХреА рдмрдЬрд╛рдп, рд╣рдо рдХреНрд▓рд╛рдЗрдВрдЯ рдкреЛрд░реНрдЯ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП **`smd`** рдХреЗ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рддреЗ рд╣реИрдВред
3. рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо **`diagnosticd`** рдХреЛ XPC рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдХреЛрдИ рднреА **рд╕рдВрджреЗрд╢ `diagnosticd` `smd` рдкрд░ рдЬрд╛рддреЗ рд╣реИрдВ**ред&#x20;
* `smd` рдХреЗ рд▓рд┐рдП, рд╣рдорд╛рд░реЗ рдФрд░ `diagnosticd` рдХреЗ рд╕рдВрджреЗрд╢ рджреЛрдиреЛрдВ рд╣реА рдПрдХ рд╣реА рдХрдиреЗрдХреНрд╢рди рдкрд░ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддреЗ рд╣реИрдВред

<figure><img src="../../../../../../.gitbook/assets/image (1) (1) (1).png" alt="" width="563"><figcaption></figcaption></figure>

4. рд╣рдо **`diagnosticd`** рд╕реЗ рдХрд╣рддреЗ рд╣реИрдВ рдХрд┐ рд╣рдорд╛рд░реА (рдпрд╛ рдХрд┐рд╕реА рднреА рд╕рдХреНрд░рд┐рдп) рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреА рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ рд╢реБрд░реВ рдХрд░реЗрдВ рдФрд░ рд╣рдо **`smd`** рдХреЛ 1004 рд╕рдВрджреЗрд╢реЛрдВ рдХреА рд░реВрдЯреАрди рдХреЛ рд╕реНрдкреИрдо рдХрд░рддреЗ рд╣реИрдВ (рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рдЙрдкрдХрд░рдг рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП)ред
5. рдЗрд╕рд╕реЗ рдПрдХ рд░реЗрд╕ рдХрдВрдбреАрд╢рди рдмрдирддрд╛ рд╣реИ рдЬреЛ `handle_bless` рдореЗрдВ рдПрдХ рдмрд╣реБрдд рд╡рд┐рд╢реЗрд╖ рдЦрд┐рдбрд╝рдХреА рдореЗрдВ рд╣рд┐рдЯ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рд╣рдореЗрдВ `xpc_connection_get_pid` рдХреЛ рд╣рдорд╛рд░реА рдЦреБрдж рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдкреАрдЖрдИрдбреА рд▓реМрдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмреБрд▓рд╛рдирд╛ рд╣реЛрдЧрд╛, рдХреНрдпреЛрдВрдХрд┐ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░рд┐рдд рд╕рд╣рд╛рдпрдХ рдЙрдкрдХрд░рдг рд╣рдорд╛рд░реЗ рдРрдк рдмрдВрдбрд▓ рдореЗрдВ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, `connection_is_authorized` рдлрд╝рдВрдХреНрд╢рди рдХреЗ рднреАрддрд░ `xpc_connection_get_audit_token` рдХреЛ рдХреЙрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП `diganosticd` рдХреЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдПред

## рд╡реЗрд░рд┐рдПрдВрдЯ 2: рдЙрддреНрддрд░ рдлрд╝реЙрд░рд╡рд░реНрдбрд┐рдВрдЧ

рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдХрд╣рд╛ рдЧрдпрд╛ рд╣реИ, XPC рдХрдиреЗрдХреНрд╢рди рдХреЗ рд▓
## рд╕реБрдзрд╛рд░ <a href="#the-fix" id="the-fix"></a>

рдЕрдВрдд рдореЗрдВ, рд╣рдордиреЗ `smd` рдореЗрдВ рд╕рд╛рдорд╛рдиреНрдп рд╕рдорд╕реНрдпрд╛ рдФрд░ рд╡рд┐рд╢реЗрд╖ рд╕рдорд╕реНрдпрд╛ рдХреА рд░рд┐рдкреЛрд░реНрдЯ рдХреАред Apple рдиреЗ рдЗрд╕реЗ рдХреЗрд╡рд▓ `smd` рдореЗрдВ рд╣реА рдареАрдХ рдХрд┐рдпрд╛ рд╣реИ, `xpc_connection_get_audit_token` рдХреЛ `xpc_dictionary_get_audit_token` рдХреЗ рд╕рд╛рде рдмрджрд▓рдХрд░ред

`xpc_dictionary_get_audit_token` рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдореИрдХ рдореИрд╕реЗрдЬ рд╕реЗ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, `xpc_dictionary_get_audit_token` рдХреА рддрд░рд╣, рдпрд╣ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ API рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рдирд╣реАрдВ рд╣реИред рдЙрдЪреНрдЪ рд╕реНрддрд░реАрдп `NSXPCConnection` API рдХреЗ рд▓рд┐рдП, рдореМрдЬреВрджрд╛ рд╕рдВрджреЗрд╢ рдХреЗ рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рдХреЛрдИ рд╕реНрдкрд╖реНрдЯ рддрд░реАрдХрд╛ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рд╕рднреА рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рд╡рд┐рдзрд┐ рдХреЙрд▓ рдореЗрдВ рдЫрд┐рдкрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рд╣рдореЗрдВ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдирд╣реАрдВ рд╣реИ рдХрд┐ Apple рдиреЗ рдХреНрдпреЛрдВ рдПрдХ рдФрд░ рд╕рд╛рдорд╛рдиреНрдп рд╕реБрдзрд╛рд░ рдирд╣реАрдВ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдХрдиреЗрдХреНрд╢рди рдХреЗ рд╕рд╣реЗрдЬреЗ рдЧрдП рдСрдбрд┐рдЯ рдЯреЛрдХрди рдХреЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдЫреЛрдбрд╝ рджреЗрдирд╛ред рдРрд╕реЗ рд╕реНрдерд┐рддрд┐рдпрд╛рдБ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬрд╣рд╛рдВ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд╛ рдСрдбрд┐рдЯ рдЯреЛрдХрди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдХрдиреЗрдХреНрд╢рди рдЦреБрд▓реА рд░рд╣рдиреА рдЪрд╛рд╣рд┐рдП (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `setuid` рдХреЛрд▓ рдХрд░рдиреЗ рдкрд░ UID рдлрд╝реАрд▓реНрдб рдмрджрд▓ рдЬрд╛рддрд╛ рд╣реИ), рд▓реЗрдХрд┐рди рдПрдХ рдЕрд▓рдЧ PID рдпрд╛ PID рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рддрд░рд╣ рдХреЗ рдмрджрд▓рд╛рд╡ рдЕрдкреЗрдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИрдВред

рдХрд┐рд╕реА рднреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рдпрд╣ рд╕рдорд╕реНрдпрд╛ рдЕрднреА рднреА iOS 17 рдФрд░ macOS 14 рдХреЗ рд╕рд╛рде рдореМрдЬреВрдж рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ рдЖрдк рдЗрд╕реЗ рдЦреЛрдЬрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рд╢реБрднрдХрд╛рдордирд╛рдПрдВ!

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рдХреА рдЬрд╛рдП? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ рджреЗрдЦреЗрдВ
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред**

</details>
