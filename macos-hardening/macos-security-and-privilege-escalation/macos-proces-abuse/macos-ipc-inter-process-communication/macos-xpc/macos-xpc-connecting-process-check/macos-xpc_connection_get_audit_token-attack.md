# –ê—Ç–∞–∫–∞ macOS xpc\_connection\_get\_audit\_token

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –≤ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—Ç–∞** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub**.

</details>

**–î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó –ø–µ—Ä–µ–≥–ª—è–Ω—å—Ç–µ –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –ø–æ—Å—Ç:** [**https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/**](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/). –¶–µ –∫—Ä–∞—Ç–∫–∏–π –æ–≥–ª—è–¥:

## –û—Å–Ω–æ–≤–Ω–∞ —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—è –ø—Ä–æ Mach Messages

–Ø–∫—â–æ –≤–∏ –Ω–µ –∑–Ω–∞—î—Ç–µ, —â–æ —Ç–∞–∫–µ Mach Messages, –ø–æ—á–Ω—ñ—Ç—å –∑ —Ü—ñ—î—ó —Å—Ç–æ—Ä—ñ–Ω–∫–∏:

{% content-ref url="../../../../mac-os-architecture/macos-ipc-inter-process-communication/" %}
[macos-ipc-inter-process-communication](../../../../mac-os-architecture/macos-ipc-inter-process-communication/)
{% endcontent-ref %}

–ù–∞ –¥–∞–Ω–∏–π –º–æ–º–µ–Ω—Ç –∑–∞–ø–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ ([–≤–∏–∑–Ω–∞—á–µ–Ω–Ω—è –∑–≤—ñ–¥—Å–∏](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):\
–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è Mach –Ω–∞–¥—Å–∏–ª–∞—é—Ç—å—Å—è —á–µ—Ä–µ–∑ _mach port_, —è–∫–∏–π —î **–∫–∞–Ω–∞–ª–æ–º –∑–≤'—è–∑–∫—É –æ–¥–µ—Ä–∂—É–≤–∞—á–∞, –±–∞–≥–∞—Ç—å–æ—Ö –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫—ñ–≤**, –≤–±—É–¥–æ–≤–∞–Ω–∏–º —É —è–¥—Ä–æ mach. **–î–µ–∫—ñ–ª—å–∫–∞ –ø—Ä–æ—Ü–µ—Å—ñ–≤ –º–æ–∂—É—Ç—å –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** –Ω–∞ mach port, –∞–ª–µ –≤ –±—É–¥—å-—è–∫–∏–π –º–æ–º–µ–Ω—Ç **–ª–∏—à–µ –æ–¥–∏–Ω –ø—Ä–æ—Ü–µ—Å –º–æ–∂–µ —á–∏—Ç–∞—Ç–∏ –∑ –Ω—å–æ–≥–æ**. –¢–∞–∫ —Å–∞–º–æ, —è–∫ —Ñ–∞–π–ª–æ–≤—ñ –¥–µ—Å–∫—Ä–∏–ø—Ç–æ—Ä–∏ —Ç–∞ —Å–æ–∫–µ—Ç–∏, mach ports –≤–∏–¥—ñ–ª—è—é—Ç—å—Å—è —Ç–∞ –∫–µ—Ä—É—é—Ç—å—Å—è —è–¥—Ä–æ–º, —ñ –ø—Ä–æ—Ü–µ—Å–∏ –±–∞—á–∞—Ç—å –ª–∏—à–µ —Ü—ñ–ª–µ —á–∏—Å–ª–æ, —è–∫–µ –≤–æ–Ω–∏ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –≤–∫–∞–∑—ñ–≤–∫–∏ —è–¥—Ä—É, —è–∫–∏–π –∑ —ó—Ö–Ω—ñ—Ö mach ports –≤–æ–Ω–∏ —Ö–æ—á—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏.

## –ü—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è XPC

–Ø–∫—â–æ –≤–∏ –Ω–µ –∑–Ω–∞—î—Ç–µ, —è–∫ –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è XPC, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ:

{% content-ref url="../" %}
[..](../)
{% endcontent-ref %}

## –ü—ñ–¥—Å—É–º–æ–∫ —É—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ

–í–∞–∂–ª–∏–≤–æ –∑–Ω–∞—Ç–∏, —â–æ **–∞–±—Å—Ç—Ä–∞–∫—Ü—ñ—è XPC - —Ü–µ –∑'—î–¥–Ω–∞–Ω–Ω—è –æ–¥–∏–Ω –¥–æ –æ–¥–Ω–æ–≥–æ**, –∞–ª–µ –≤–æ–Ω–∞ –±–∞–∑—É—î—Ç—å—Å—è –Ω–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥—ñ—ó, —è–∫–∞ **–º–æ–∂–µ –º–∞—Ç–∏ –∫—ñ–ª—å–∫–∞ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫—ñ–≤, –æ—Ç–∂–µ:**

* Mach ports - —Ü–µ –æ–¥–µ—Ä–∂—É–≤–∞—á –æ–¥–Ω–æ–≥–æ, **–±–∞–≥–∞—Ç–æ –≤—ñ–¥–ø—Ä–∞–≤–Ω–∏–∫—ñ–≤**.
* –ê—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω –∑'—î–¥–Ω–∞–Ω–Ω—è XPC - —Ü–µ –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω, **—Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∏–π –∑ –æ—Å—Ç–∞–Ω–Ω—å–æ–≥–æ –æ—Ç—Ä–∏–º–∞–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è**.
* –û—Ç—Ä–∏–º–∞–Ω–Ω—è **–∞—É–¥–∏—Ç–∏–≤–Ω–æ–≥–æ —Ç–æ–∫–µ–Ω—É** –∑'—î–¥–Ω–∞–Ω–Ω—è XPC —î –∫—Ä–∏—Ç–∏—á–Ω–∏–º –¥–ª—è –±–∞–≥–∞—Ç—å–æ—Ö **–ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –±–µ–∑–ø–µ–∫–∏**.

–•–æ—á–∞ –ø–æ–ø–µ—Ä–µ–¥–Ω—è —Å–∏—Ç—É–∞—Ü—ñ—è –∑–≤—É—á–∏—Ç—å –ø–µ—Ä—Å–ø–µ–∫—Ç–∏–≤–Ω–æ, —î —Å—Ü–µ–Ω–∞—Ä—ñ—ó, –¥–µ —Ü–µ –Ω–µ –≤–∏–∫–ª–∏—á–µ –ø—Ä–æ–±–ª–µ–º ([–∑–≤—ñ–¥—Å–∏](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing)):

* –ê—É–¥–∏—Ç–∏–≤–Ω—ñ —Ç–æ–∫–µ–Ω–∏ —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –¥–ª—è –≤–∏—Ä—ñ—à–µ–Ω–Ω—è –ø—Ä–∏–π–Ω—è—Ç—Ç—è –∑'—î–¥–Ω–∞–Ω–Ω—è. –û—Å–∫—ñ–ª—å–∫–∏ —Ü–µ –≤—ñ–¥–±—É–≤–∞—î—Ç—å—Å—è –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ —Å–ª—É–∂–±–æ–≤–∏–π –ø–æ—Ä—Ç, **–∑'—î–¥–Ω–∞–Ω–Ω—è —â–µ –Ω–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ**. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –Ω–∞ —Ü—å–æ–º—É –ø–æ—Ä—Ç—ñ –±—É–¥—É—Ç—å –ø—Ä–æ—Å—Ç–æ –æ–±—Ä–æ–±–ª—è—Ç–∏—Å—è —è–∫ –¥–æ–¥–∞—Ç–∫–æ–≤—ñ –∑–∞–ø–∏—Ç–∏ –Ω–∞ –∑'—î–¥–Ω–∞–Ω–Ω—è. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, **–ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –ø–µ—Ä–µ–¥ –ø—Ä–∏–π–Ω—è—Ç—Ç—è–º –∑'—î–¥–Ω–∞–Ω–Ω—è –Ω–µ —î –≤—Ä–∞–∑–ª–∏–≤–∏–º–∏** (—Ü–µ —Ç–∞–∫–æ–∂ –æ–∑–Ω–∞—á–∞—î, —â–æ –≤ –º–µ–∂–∞—Ö `-listener:shouldAcceptNewConnection:` –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω —î –±–µ–∑–ø–µ—á–Ω–∏–º). –¢–æ–º—É –º–∏ **—à—É–∫–∞—î–º–æ –∑'—î–¥–Ω–∞–Ω–Ω—è XPC, —è–∫—ñ –ø–µ—Ä–µ–≤—ñ—Ä—è—é—Ç—å –∫–æ–Ω–∫—Ä–µ—Ç–Ω—ñ –¥—ñ—ó**.
* –û–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π XPC –æ–±—Ä–æ–±–ª—è—é—Ç—å—Å—è —Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –æ–±—Ä–æ–±–Ω–∏–∫ –ø–æ–¥—ñ–π –¥–ª—è –æ–¥–Ω–æ–≥–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –ø–æ–≤–∏–Ω–µ–Ω –±—É—Ç–∏ –∑–∞–≤–µ—Ä—à–µ–Ω–∏–π –ø–µ—Ä–µ–¥ –π–æ–≥–æ –≤–∏–∫–ª–∏–∫–æ–º –¥–ª—è –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ, –Ω–∞–≤—ñ—Ç—å –Ω–∞ –æ–¥–Ω–æ—á–∞—Å–Ω–∏—Ö —á–µ—Ä–≥–∞—Ö —Ä–æ–∑–ø–æ–¥—ñ–ª—É. –¢–∞–∫–∏–º —á–∏–Ω–æ–º, –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–æ–±—Ä–æ–±–Ω–∏–∫–∞ –ø–æ–¥—ñ–π XPC –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω –Ω–µ –º–æ–∂–µ –±—É—Ç–∏ –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–Ω–∏–π** —ñ–Ω—à–∏–º–∏ –∑–≤–∏—á–∞–π–Ω–∏–º–∏ (–Ω–µ-–≤—ñ–¥–ø–æ–≤—ñ–¥—å!) –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º–∏.

–î–≤–∞ —Ä—ñ–∑–Ω–∏—Ö –º–µ—Ç–æ–¥–∏, —è–∫ —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–æ:

1. –í–∞—Ä—ñ–∞–Ω—Ç1:
* **–ï–∫—Å–ø–ª–æ–π—Ç –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è** –¥–æ —Å–ª—É–∂–±–∏ **A** —Ç–∞ —Å–ª—É–∂–±–∏ **B**
* –°–ª—É–∂–±–∞ **B** –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å** –≤ —Å–ª—É–∂–±—ñ **A**, —è–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –º–æ–∂–µ
* –°–ª—É–∂–±–∞ **A** –≤–∏–∫–ª–∏–∫–∞—î **`xpc_connection_get_audit_token`** –ø–æ–∫–∏ _**–Ω–µ**_ –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ **–æ–±—Ä–æ–±–Ω–∏–∫–∞ –ø–æ–¥—ñ–π** –¥–ª—è –∑'—î–¥–Ω–∞–Ω–Ω—è –≤ **`dispatch_async`**.
* –¢–∞–∫–∏–º —á–∏–Ω–æ–º, **—ñ–Ω—à–µ** –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –º–æ–∂–µ **–ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞—Ç–∏ –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω**, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–æ —Ä–æ–∑—Å–∏–ª–∞—î—Ç—å—Å—è –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –ø–æ–∑–∞ –æ–±—Ä–æ–±–Ω–∏–∫–æ–º –ø–æ–¥—ñ–π.
* –ï–∫—Å–ø–ª–æ–π—Ç –ø–µ—Ä–µ–¥–∞—î **—Å–ª—É–∂–±—ñ B –ø—Ä–∞–≤–æ –ù–ê–î–°–ò–õ–ê–ù–ù–Ø —Å–ª—É–∂–±—ñ A**.
* –¢–∞–∫–∏–º —á–∏–Ω–æ–º, svc **B** —Ñ–∞–∫—Ç–∏—á–Ω–æ **–Ω–∞–¥—Å–∏–ª–∞—î** **–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è** —Å–ª—É–∂–±—ñ **A**.
* **–ï–∫—Å–ø–ª–æ–π—Ç** –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è **–≤–∏–∫–ª–∏–∫–∞—Ç–∏** **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—É –¥—ñ—é**. –£ RC svc **A** **–ø–µ—Ä–µ–≤—ñ—Ä—è—î** –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—é —Ü—ñ—î—ó **–¥—ñ—ó**, —Ç–æ–¥—ñ —è–∫ **svc B –ø–µ—Ä–µ–∑–∞–ø–∏—Å–∞–≤ –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω** (–Ω–∞–¥–∞—é—á–∏ –µ–∫—Å–ø–ª–æ–π—Ç—É –¥–æ—Å—Ç—É–ø –¥–æ –≤–∏–∫–ª–∏–∫—É –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ—ó –¥—ñ—ó).
2. –í–∞—Ä—ñ–∞–Ω—Ç 2:
* –°–ª—É–∂–±–∞ **B** –º–æ–∂–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—É —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω—ñ—Å—Ç—å** –≤ —Å–ª—É–∂–±—ñ **A**, —è–∫—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á –Ω–µ –º–æ–∂–µ
* –ï–∫—Å–ø–ª–æ–π—Ç –ø—ñ–¥–∫–ª—é—á–∞—î—Ç—å—Å—è –¥–æ **—Å–ª—É–∂–±–∏ A**, —è–∫–∞ **–Ω–∞–¥—Å–∏–ª–∞—î** –µ–∫—Å–ø–ª–æ–π—Ç—É **–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –∑ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è–º –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ** –Ω–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π **–ø–æ—Ä—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ**.
* –ï–∫—Å–ø–ª–æ–π—Ç –Ω–∞–¥—Å–∏–ª–∞—î **—Å–ª—É–∂–±—ñ B –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø–µ—Ä–µ–¥–∞—é—á–∏ —Ü–µ–π –ø–æ—Ä—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ**.
* –ö–æ–ª–∏ —Å–ª—É–∂–±–∞ **B –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—î**, –≤–æ–Ω–∞ **–Ω–∞–¥—Å–∏–ª–∞—î –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–ª—É–∂–±—ñ A**, **—Ç–æ–¥—ñ —è–∫** **–µ–∫—Å–ø–ª–æ–π—Ç** –Ω–∞–¥—Å–∏–ª–∞—î —ñ–Ω—à–µ **–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–ª—É–∂–±—ñ A**, –Ω–∞–º–∞–≥–∞—é—á–∏—Å—å **–¥–æ—Å—è–≥—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ—ó —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ** —Ç–∞ –æ—á—ñ–∫—É—î, —â–æ –≤—ñ–¥–ø–æ–≤—ñ–¥—å –≤—ñ–¥ —Å–ª—É–∂–±–∏ B –ø–µ—Ä–µ–∑–∞–ø–∏—à–µ –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω —É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π –º–æ–º–µ–Ω—Ç (–£–º–æ–≤–∞ –≥–æ–Ω–∫–∏).

## –í–∞—Ä—ñ–∞–Ω—Ç 1: –≤–∏–∫–ª–∏–∫ xpc\_connection\_get\_audit\_token –ø–æ–∑–∞ –æ–±—Ä–æ–±–Ω–∏–∫–æ–º –ø–æ–¥—ñ–π <a href="#variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler" id="variant-1-calling-xpc_connection_get_audit_token-outside-of-an-event-handler"></a>

–°—Ü–µ–Ω–∞—Ä—ñ–π:

* –î–≤—ñ —Å–ª—É–∂–±–∏ mach **`A`** —Ç–∞ **`B`**, –¥–æ —è–∫–∏—Ö –º–∏ –º–æ–∂–µ–º–æ –ø—ñ–¥–∫–ª—é—á–∏—Ç–∏—Å—è –æ–±–æ–º–∞ (–Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø—Ä–æ—Ñ—ñ–ª—é –ø—ñ—Å–æ—á–Ω–∏—Ü—ñ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä–æ–∫ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –ø–µ—Ä–µ–¥ –ø—Ä–∏–π–Ω—è—Ç—Ç—è–º –∑'—î–¥–Ω–∞–Ω–Ω—è).
* _**A**_ –ø–æ–≤–∏–Ω–Ω–∞ –º–∞—Ç–∏ **–ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó** –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –¥—ñ—ó, —è–∫—É **`B`** –º–æ–∂–µ –ø–µ—Ä–µ–¥–∞—Ç–∏ (–∞–ª–µ –Ω–∞—à–æ–º—É –¥–æ–¥–∞—Ç–∫—É –Ω–µ –≤–¥–∞—Å—Ç—å—Å—è).
* –ù–∞–ø—Ä–∏–∫–ª–∞–¥, —è–∫—â–æ —É B —î –¥–µ—è–∫—ñ **–ø—Ä–∏–≤—ñ–ª–µ—ó** –∞–±–æ –≤—ñ–Ω –ø—Ä–∞—Ü—é—î —è–∫ **root**, —Ü–µ –º–æ–∂–µ –¥–æ–∑–≤–æ–ª–∏—Ç–∏ –π–æ–º—É –ø–æ–ø—Ä–æ—Å–∏—Ç–∏ A –≤–∏–∫–æ–Ω–∞—Ç–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω—É –¥—ñ—é.
* –î–ª—è —Ü—ñ—î—ó –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó **`A`** –∞—Å–∏–Ω—Ö—Ä–æ–Ω–Ω–æ –æ—Ç—Ä–∏–º—É—î –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏–∫–ª–∏–∫–∞—é—á–∏ `xpc_connection_get_audit_token` –∑ **`dispatch_async`**.

{% hint style="danger" %}
–£ —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ —Å–ø—Ä–æ–≤–æ–∫—É–≤–∞—Ç–∏ **–£–º–æ–≤—É –≥–æ–Ω–∫–∏**, —Å—Ç–≤–æ—Ä–∏–≤—à–∏ **–µ–∫—Å–ø–ª–æ–π—Ç**, —è–∫–∏–π **–ø—Ä–æ—Å–∏—Ç—å A –≤–∏–∫–æ–Ω–∞—Ç–∏ –¥—ñ—é** –∫—ñ–ª—å–∫–∞ —Ä–∞–∑—ñ–≤, –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑–º—É—à—É—é—á–∏ **B –Ω–∞–¥—Å–∏–ª–∞—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è A**. –ö–æ–ª–∏ **–£–º–æ–≤–∞ –≥–æ–Ω–∫–∏ —É—Å–ø—ñ—à–Ω–∞**, –∞—É–¥–∏—Ç–∏–≤–Ω–∏–π —Ç–æ–∫–µ–Ω **B** –±—É–¥–µ —Å–∫–æ–ø—ñ–π–æ–≤–∞–Ω–∏–π –≤ –ø–∞–º'—è—Ç—å **–ø—ñ–¥ —á–∞—Å** –æ–±—Ä–æ–±–∫–∏ –∑–∞–ø–∏—Ç—É –Ω–∞—à–∏–º **–µ–∫—Å–ø–ª–æ–π—Ç–æ–º** A, –Ω–∞–¥–∞—é—á–∏ –π–æ–º—É **–¥–æ—Å—Ç—É–ø –¥–æ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ—ó –¥—ñ—ó, —è–∫—É –º—ñ–≥ –∑–∞–ø—Ä–æ—Å–∏—Ç–∏ –ª–∏—à–µ B**.
{% endhint %}

–¶–µ —Å—Ç–∞–ª–æ—Å—è –∑ **`A`** —è–∫ `smd` —Ç–∞ **`B`** —è–∫ `diagnosticd`. –§—É–Ω–∫—Ü—ñ—é [`SMJobBless`](https://developer.apple.com/documentation/servicemanagement/1431078-smjobbless?language=objc) –∑ smb –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –¥–ª—è –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –Ω–æ–≤–æ–≥–æ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–æ–≥–æ –¥–æ–ø–æ–º—ñ–∂–Ω–æ–≥–æ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É (—è–∫ **root**). –Ø–∫—â–æ **–ø—Ä–æ—Ü–µ—Å, —â–æ –ø—Ä–∞—Ü—é—î —è–∫ root**, –∑–≤'—è–∑—É—î—Ç—å—Å—è –∑ **smd**, —ñ–Ω—à—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –Ω–µ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è.

–û—Ç–∂–µ, —Å–ª—É–∂–±–∞ **B** - —Ü–µ **`diagnosticd`**, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ –ø—Ä–∞—Ü—é—î —è–∫ **root** —ñ –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∞ –¥–ª—è **–º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –ø—Ä–æ—Ü–µ—Å—É**, —Ç–æ–º—É –ø—ñ—Å–ª—è –ø–æ—á–∞—Ç–∫—É –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥—É –≤–æ–Ω–∞ **–Ω–∞–¥—Å–∏–ª–∞—î –∫—ñ–ª—å–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –Ω–∞ —Å–µ–∫—É–Ω–¥—É.**

–î–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫–∏:

1. –Ü–Ω—ñ—Ü—ñ—é–π—Ç–µ **–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è** –¥–æ —Å–ª—É–∂–±–∏ –∑ –Ω–∞–∑–≤–æ—é `smd`, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å—Ç–∞–Ω–¥–∞—Ä—Ç–Ω–∏–π –ø—Ä–æ—Ç–æ–∫–æ–ª XPC.
2. –°—Ñ–æ—Ä–º—É–π—Ç–µ –¥–æ–¥–∞—Ç–∫–æ–≤–µ **–ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è** –¥–æ `diagnosticd`. –ù–∞–≤–ø–∞–∫–∏, –∑–∞–º—ñ—Å—Ç—å —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ç–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –¥–≤–æ—Ö –Ω–æ–≤–∏—Ö mach ports, –ø—Ä–∞–≤–æ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è –∫–ª—ñ—î–Ω—Ç—Å—å–∫–æ–≥–æ –ø–æ—Ä—Ç—É –∑–∞–º—ñ–Ω—é—î—Ç—å—Å—è –Ω–∞ –∫–æ–ø—ñ—é **–ø—Ä–∞–≤–∞ –Ω–∞–¥—Å–∏–ª–∞–Ω–Ω—è**, –ø–æ–≤'—è–∑–∞–Ω–æ–≥–æ –∑ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è–º –¥–æ `smd`.
3. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è XPC –º–æ–∂—É—Ç—å –±—É—Ç–∏ —Ä–æ–∑—Å–∏–ª–∞–Ω—ñ –¥–æ `diagnosticd`, –∞–ª–µ –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –≤—ñ–¥ `diagnosticd` –ø–µ—Ä–µ–Ω–∞–ø—Ä–∞–≤–ª—è—é—Ç—å—Å—è –¥–æ `smd`. –î–ª—è `smd` –∑–¥–∞—î—Ç—å—Å—è, —â–æ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —è–∫ –≤—ñ–¥ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Ç–∞–∫ —ñ –≤—ñ–¥ `diagnosticd` –ø–æ—Ö–æ–¥—è—Ç—å –∑ –æ–¥–Ω–æ–≥–æ –∑'—î–¥–Ω–∞–Ω–Ω—è.

![–ó–æ–±—Ä–∞–∂–µ–Ω–Ω—è, —â–æ –∑–æ–±—Ä–∞–∂—É—î –ø—Ä–æ—Ü–µ—Å –µ–∫—Å–ø–ª–æ–π—Ç—É](https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/exploit.png)
4. –ù–∞—Å—Ç—É–ø–Ω–∏–π –∫—Ä–æ–∫ –ø–æ–ª—è–≥–∞—î –≤ –Ω–∞–∫–∞–∑—ñ `diagnosticd` —ñ–Ω—ñ—Ü—ñ—é–≤–∞—Ç–∏ –º–æ–Ω—ñ—Ç–æ—Ä–∏–Ω–≥ –æ–±—Ä–∞–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É (–ø–æ—Ç–µ–Ω—Ü—ñ–π–Ω–æ –≤–ª–∞—Å–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞). –û–¥–Ω–æ—á–∞—Å–Ω–æ –¥–æ `smd` –≤—ñ–¥–ø—Ä–∞–≤–ª—è—î—Ç—å—Å—è –ø–æ—Ç—ñ–∫ —Ä—É—Ç–∏–Ω–Ω–∏—Ö –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å 1004. –ú–µ—Ç–∞ –ø–æ–ª—è–≥–∞—î –≤ —É—Å—Ç–∞–Ω–æ–≤—Ü—ñ —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—É –∑ –ø—ñ–¥–≤–∏—â–µ–Ω–∏–º–∏ –ø—Ä–∏–≤—ñ–ª–µ—è–º–∏.
5. –¶—è –¥—ñ—è —Å–ø—Ä–∏—á–∏–Ω—é—î –≥–æ–Ω–∫—É —Å—Ç–∞–Ω—É –≤ –º–µ–∂–∞—Ö —Ñ—É–Ω–∫—Ü—ñ—ó `handle_bless`. –ß–∞—Å—É–≤–∞–Ω–Ω—è –∫—Ä–∏—Ç–∏—á–Ω–µ: –≤–∏–∫–ª–∏–∫ —Ñ—É–Ω–∫—Ü—ñ—ó `xpc_connection_get_pid` –ø–æ–≤–∏–Ω–µ–Ω –ø–æ–≤–µ—Ä—Ç–∞—Ç–∏ PID –ø—Ä–æ—Ü–µ—Å—É –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ (–æ—Å–∫—ñ–ª—å–∫–∏ –ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π —ñ–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –ø–∞–∫–µ—Ç—ñ –¥–æ–¥–∞—Ç–∫–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞). –û–¥–Ω–∞–∫ —Ñ—É–Ω–∫—Ü—ñ—è `xpc_connection_get_audit_token`, –∑–æ–∫—Ä–µ–º–∞ –≤ –º–µ–∂–∞—Ö –ø—ñ–¥–ø—Ä–æ–≥—Ä–∞–º–∏ `connection_is_authorized`, –ø–æ–≤–∏–Ω–Ω–∞ –ø–æ—Å–∏–ª–∞—Ç–∏—Å—è –Ω–∞ –∞—É–¥–∏—Ç-—Ç–æ–∫–µ–Ω, —â–æ –Ω–∞–ª–µ–∂–∏—Ç—å `diagnosticd`.

## –í–∞—Ä—ñ–∞–Ω—Ç 2: –ø–µ—Ä–µ—Å–∏–ª–∞–Ω–Ω—è –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ

–£ —Å–µ—Ä–µ–¥–æ–≤–∏—â—ñ XPC (–º—ñ–∂–ø—Ä–æ—Ü–µ—Å–æ–≤–∞ –∫–æ–º—É–Ω—ñ–∫–∞—Ü—ñ—è) —Ö–æ—á–∞ –æ–±—Ä–æ–±–Ω–∏–∫–∏ –ø–æ–¥—ñ–π –Ω–µ –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è –æ–¥–Ω–æ—á–∞—Å–Ω–æ, –æ–±—Ä–æ–±–∫–∞ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –º–∞—î —É–Ω—ñ–∫–∞–ª—å–Ω—É –ø–æ–≤–µ–¥—ñ–Ω–∫—É. –ó–æ–∫—Ä–µ–º–∞, —ñ—Å–Ω—É—é—Ç—å –¥–≤–∞ –≤—ñ–¥–º—ñ–Ω–Ω–∏—Ö –º–µ—Ç–æ–¥–∏ –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —è–∫—ñ –æ—á—ñ–∫—É—é—Ç—å –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ:

1. **`xpc_connection_send_message_with_reply`**: –¢—É—Ç XPC-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è —Ç–∞ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –Ω–∞ –≤–∏–∑–Ω–∞—á–µ–Ω—ñ–π —á–µ—Ä–∑—ñ.
2. **`xpc_connection_send_message_with_reply_sync`**: –ù–∞–≤–ø–∞–∫–∏, —É —Ü—å–æ–º—É –º–µ—Ç–æ–¥—ñ XPC-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è —Ç–∞ –æ–±—Ä–æ–±–ª—è—î—Ç—å—Å—è –Ω–∞ –ø–æ—Ç–æ—á–Ω—ñ–π —á–µ—Ä–∑—ñ –≤–∏–∫–ª–∏–∫—É.

–¶—è –≤—ñ–¥–º—ñ–Ω–Ω—ñ—Å—Ç—å —î –∫—Ä–∏—Ç–∏—á–Ω–æ—é, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ –¥–æ–∑–≤–æ–ª—è—î –º–æ–∂–ª–∏–≤—ñ—Å—Ç—å **–æ–¥–Ω–æ—á–∞—Å–Ω–æ–≥–æ —Ä–æ–∑–±–æ—Ä—É –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏—Ö –ø–∞–∫–µ—Ç—ñ–≤ –∑ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º –æ–±—Ä–æ–±–Ω–∏–∫–∞ –ø–æ–¥—ñ–π XPC**. –ó–æ–∫—Ä–µ–º–∞, —Ö–æ—á–∞ `_xpc_connection_set_creds` —Ä–µ–∞–ª—ñ–∑—É—î –±–ª–æ–∫—É–≤–∞–Ω–Ω—è –¥–ª—è –∑–∞—Ö–∏—Å—Ç—É –≤—ñ–¥ —á–∞—Å—Ç–∫–æ–≤–æ–≥–æ –ø–µ—Ä–µ–∑–∞–ø–∏—Å—É –∞—É–¥–∏—Ç-—Ç–æ–∫–µ–Ω–∞, –≤–æ–Ω–æ –Ω–µ —Ä–æ–∑–ø–æ–≤—Å—é–¥–∂—É—î —Ü–µ–π –∑–∞—Ö–∏—Å—Ç –Ω–∞ –≤–µ—Å—å –æ–±'—î–∫—Ç –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –í —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ —Ü—å–æ–≥–æ —Å—Ç–≤–æ—Ä—é—î—Ç—å—Å—è –≤—Ä–∞–∑–ª–∏–≤—ñ—Å—Ç—å, –¥–µ –∞—É–¥–∏—Ç-—Ç–æ–∫–µ–Ω –º–æ–∂–µ –±—É—Ç–∏ –∑–∞–º—ñ–Ω–µ–Ω–∏–π –ø—Ä–æ—Ç—è–≥–æ–º —ñ–Ω—Ç–µ—Ä–≤–∞–ª—É –º—ñ–∂ —Ä–æ–∑–±–æ—Ä–æ–º –ø–∞–∫–µ—Ç–∞ —Ç–∞ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º –π–æ–≥–æ –æ–±—Ä–æ–±–Ω–∏–∫–∞ –ø–æ–¥—ñ–π.

–î–ª—è –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó —Ü—ñ—î—ó –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –ø–æ—Ç—Ä—ñ–±–Ω–æ –Ω–∞—Å—Ç—É–ø–Ω–µ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è:

* –î–≤–∞ —Å–ª—É–∂–±–∏ mach, –ø–æ–∑–Ω–∞—á–µ–Ω—ñ —è–∫ **`A`** —Ç–∞ **`B`**, –æ–±–∏–¥–≤—ñ –º–æ–∂—É—Ç—å –≤—Å—Ç–∞–Ω–æ–≤–ª—é–≤–∞—Ç–∏ –∑'—î–¥–Ω–∞–Ω–Ω—è.
* –°–ª—É–∂–±–∞ **`A`** –ø–æ–≤–∏–Ω–Ω–∞ –≤–∫–ª—é—á–∞—Ç–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü—ñ—ó –¥–ª—è –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ—ó –¥—ñ—ó, —è–∫—É –º–æ–∂–µ –≤–∏–∫–æ–Ω–∞—Ç–∏ –ª–∏—à–µ **`B`** (–¥–æ–¥–∞—Ç–æ–∫ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –Ω–µ –º–æ–∂–µ).
* –°–ª—É–∂–±–∞ **`A`** –ø–æ–≤–∏–Ω–Ω–∞ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫–µ –æ—á—ñ–∫—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
* –ö–æ—Ä–∏—Å—Ç—É–≤–∞—á –º–æ–∂–µ –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç–∏ –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è –¥–æ **`B`**, –Ω–∞ —è–∫–µ –≤—ñ–Ω –≤—ñ–¥–ø–æ–≤—ñ—Å—Ç—å.

–ü—Ä–æ—Ü–µ—Å –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—ó –≤–∫–ª—é—á–∞—î –Ω–∞—Å—Ç—É–ø–Ω—ñ –∫—Ä–æ–∫–∏:

1. –ó–∞—á–µ–∫–∞—Ç–∏, –ø–æ–∫–∏ —Å–ª—É–∂–±–∞ **`A`** –≤—ñ–¥–ø—Ä–∞–≤–∏—Ç—å –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —è–∫–µ –æ—á—ñ–∫—É—î –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ.
2. –ó–∞–º—ñ—Å—Ç—å –ø—Ä—è–º–æ—ó –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ **`A`**, –ø–æ—Ä—Ç –≤—ñ–¥–ø–æ–≤—ñ–¥—ñ –ø–µ—Ä–µ—Ö–æ–ø–ª—é—î—Ç—å—Å—è —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è —Å–ª—É–∂–±—ñ **`B`**.
3. –ü–æ–¥–∞–ª—å—à–µ –≤—ñ–¥–ø—Ä–∞–≤–ª–µ–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, —â–æ –≤–∫–ª—é—á–∞—î –∑–∞–±–æ—Ä–æ–Ω–µ–Ω—É –¥—ñ—é, –∑ –æ—á—ñ–∫—É–≤–∞–Ω–Ω—è–º, —â–æ –≤–æ–Ω–æ –±—É–¥–µ –æ–±—Ä–æ–±–ª–µ–Ω–æ –æ–¥–Ω–æ—á–∞—Å–Ω–æ –∑ –≤—ñ–¥–ø–æ–≤—ñ–¥–¥—é –≤—ñ–¥ **`B`**.

–ù–∏–∂—á–µ –Ω–∞–≤–µ–¥–µ–Ω–æ –≤—ñ–∑—É–∞–ª—å–Ω–µ –ø—Ä–µ–¥—Å—Ç–∞–≤–ª–µ–Ω–Ω—è –æ–ø–∏—Å–∞–Ω–æ–≥–æ —Å—Ü–µ–Ω–∞—Ä—ñ—é –∞—Ç–∞–∫–∏:

!\[https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/variant2.png]\(../../../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1).png)

<figure><img src="../../../../../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="https://sector7.computest.nl/post/2023-10-xpc-audit-token-spoofing/variant2.png" width="563"><figcaption></figcaption></figure>

## –ü—Ä–æ–±–ª–µ–º–∏ –≤–∏—è–≤–ª–µ–Ω–Ω—è

* **–°–∫–ª–∞–¥–Ω–æ—â—ñ —É –í–∏—è–≤–ª–µ–Ω–Ω—ñ –ï–∫–∑–µ–º–ø–ª—è—Ä—ñ–≤**: –ü–æ—à—É–∫ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `xpc_connection_get_audit_token` –±—É–≤ —Å–∫–ª–∞–¥–Ω–∏–º —è–∫ —Å—Ç–∞—Ç–∏—á–Ω–æ, —Ç–∞–∫ —ñ –¥–∏–Ω–∞–º—ñ—á–Ω–æ.
* **–ú–µ—Ç–æ–¥–æ–ª–æ–≥—ñ—è**: –î–ª—è –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó `xpc_connection_get_audit_token` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤—Å—è Frida, —Ñ—ñ–ª—å—Ç—Ä—É—é—á–∏ –≤–∏–∫–ª–∏–∫–∏, —â–æ –Ω–µ –ø–æ—Ö–æ–¥–∏–ª–∏ –≤—ñ–¥ –æ–±—Ä–æ–±–Ω–∏–∫—ñ–≤ –ø–æ–¥—ñ–π. –û–¥–Ω–∞–∫ —Ü–µ–π –º–µ—Ç–æ–¥ –±—É–≤ –æ–±–º–µ–∂–µ–Ω–∏–π –¥–æ –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—É —Ç–∞ –≤–∏–º–∞–≥–∞–≤ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è.
* **–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏ –ê–Ω–∞–ª—ñ–∑—É**: –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–∏, —Ç–∞–∫—ñ —è–∫ IDA/Ghidra, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–ª–∏—Å—è –¥–ª—è –¥–æ—Å–ª—ñ–¥–∂–µ–Ω–Ω—è –¥–æ—Å—è–∂–Ω–∏—Ö —Å–ª—É–∂–± mach, –∞–ª–µ –ø—Ä–æ—Ü–µ—Å –±—É–≤ —á–∞—Å–æ–º—ñ—Å—Ç–∫–∏–º, —É—Å–∫–ª–∞–¥–Ω–µ–Ω–∏–º –≤–∏–∫–ª–∏–∫–∞–º–∏, —â–æ –≤–∫–ª—é—á–∞–ª–∏ –∫–µ—à —Å–ø—ñ–ª—å–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫ dyld.
* **–û–±–º–µ–∂–µ–Ω–Ω—è –°—Ü–µ–Ω–∞—Ä—ñ—ó–≤**: –°–ø—Ä–æ–±–∏ –Ω–∞–ø–∏—Å–∞—Ç–∏ —Å–∫—Ä–∏–ø—Ç –¥–ª—è –∞–Ω–∞–ª—ñ–∑—É –≤–∏–∫–ª–∏–∫—ñ–≤ `xpc_connection_get_audit_token` –∑ –±–ª–æ–∫—ñ–≤ `dispatch_async` –±—É–ª–∏ —É—Å–∫–ª–∞–¥–Ω–µ–Ω—ñ —Å–∫–ª–∞–¥–Ω–æ—Å—Ç—è–º–∏ —É —Ä–æ–∑–±–æ—Ä—ñ –±–ª–æ–∫—ñ–≤ —Ç–∞ –≤–∑–∞—î–º–æ–¥—ñ—ó –∑ –∫–µ—à–µ–º —Å–ø—ñ–ª—å–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫ dyld.

## –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è <a href="#the-fix" id="the-fix"></a>

* **–ü–æ–≤—ñ–¥–æ–º–ª–µ–Ω—ñ –ü—Ä–æ–±–ª–µ–º–∏**: –ë—É–ª–æ –Ω–∞–¥—ñ—Å–ª–∞–Ω–æ –∑–≤—ñ—Ç Apple –∑ –¥–µ—Ç–∞–ª—è–º–∏ –∑–∞–≥–∞–ª—å–Ω–∏—Ö —Ç–∞ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –ø—Ä–æ–±–ª–µ–º, –≤–∏—è–≤–ª–µ–Ω–∏—Ö —É `smd`.
* **–í—ñ–¥–ø–æ–≤—ñ–¥—å Apple**: Apple –≤–∏–ø—Ä–∞–≤–∏–ª–∞ –ø—Ä–æ–±–ª–µ–º—É –≤ `smd`, –∑–∞–º—ñ–Ω–∏–≤—à–∏ `xpc_connection_get_audit_token` –Ω–∞ `xpc_dictionary_get_audit_token`.
* **–•–∞—Ä–∞–∫—Ç–µ—Ä –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**: –§—É–Ω–∫—Ü—ñ—è `xpc_dictionary_get_audit_token` –≤–≤–∞–∂–∞—î—Ç—å—Å—è –±–µ–∑–ø–µ—á–Ω–æ—é, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∞ –æ—Ç—Ä–∏–º—É—î –∞—É–¥–∏—Ç-—Ç–æ–∫–µ–Ω –±–µ–∑–ø–æ—Å–µ—Ä–µ–¥–Ω—å–æ –∑ mach-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è, –ø–æ–≤'—è–∑–∞–Ω–æ–≥–æ –∑ –æ—Ç—Ä–∏–º–∞–Ω–∏–º XPC-–ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω–Ω—è–º. –û–¥–Ω–∞–∫ –≤–æ–Ω–∞ –Ω–µ —î —á–∞—Å—Ç–∏–Ω–æ—é –ø—É–±–ª—ñ—á–Ω–æ–≥–æ API, –ø–æ–¥—ñ–±–Ω–æ –¥–æ `xpc_connection_get_audit_token`.
* **–í—ñ–¥—Å—É—Ç–Ω—ñ—Å—Ç—å –®–∏—Ä—à–æ–≥–æ –í–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è**: –ù–µ–≤—ñ–¥–æ–º–æ, —á–æ–º—É Apple –Ω–µ —Ä–µ–∞–ª—ñ–∑—É–≤–∞–ª–∞ –±—ñ–ª—å—à –∫–æ–º–ø–ª–µ–∫—Å–Ω–µ –≤–∏–ø—Ä–∞–≤–ª–µ–Ω–Ω—è, —Ç–∞–∫–µ —è–∫ –≤—ñ–¥–∫–∏–¥–∞–Ω–Ω—è –ø–æ–≤—ñ–¥–æ–º–ª–µ–Ω—å, —è–∫—ñ –Ω–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–∞—é—Ç—å –∑–±–µ—Ä–µ–∂–µ–Ω–æ–º—É –∞—É–¥–∏—Ç-—Ç–æ–∫–µ–Ω—É –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è. –ú–æ–∂–ª–∏–≤—ñ—Å—Ç—å –ª–µ–≥—ñ—Ç–∏–º–Ω–∏—Ö –∑–º—ñ–Ω –∞—É–¥–∏—Ç-—Ç–æ–∫–µ–Ω—É –≤ –ø–µ–≤–Ω–∏—Ö —Å—Ü–µ–Ω–∞—Ä—ñ—è—Ö (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è `setuid`) –º–æ–∂–µ –±—É—Ç–∏ —Ñ–∞–∫—Ç–æ—Ä–æ–º.
* **–ü–æ—Ç–æ—á–Ω–∏–π –°—Ç–∞—Ç—É—Å**: –ü—Ä–æ–±–ª–µ–º–∞ –∑–∞–ª–∏—à–∞—î—Ç—å—Å—è –≤ iOS 17 —Ç–∞ macOS 14, —Å—Ç–≤–æ—Ä—é—é—á–∏ –≤–∏–∫–ª–∏–∫ –¥–ª—è —Ç–∏—Ö, —Ö—Ç–æ –Ω–∞–º–∞–≥–∞—î—Ç—å—Å—è —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫—É–≤–∞—Ç–∏ —Ç–∞ –∑—Ä–æ–∑—É–º—ñ—Ç–∏ —ó—ó.
