# macOS Library Injection

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é –≤ —Ä–µ–∫–ª–∞–º—ñ –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –î—ñ–∑–Ω–∞–π—Ç–µ—Å—è –ø—Ä–æ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub.

</details>

{% hint style="danger" %}
–ö–æ–¥ **dyld —î –≤—ñ–¥–∫—Ä–∏—Ç–∏–º –¥–∂–µ—Ä–µ–ª–æ–º** —ñ –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ –∑–∞ –ø–æ—Å–∏–ª–∞–Ω–Ω—è–º [https://opensource.apple.com/source/dyld/](https://opensource.apple.com/source/dyld/) —Ç–∞ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —É –≤–∏–≥–ª—è–¥—ñ tar –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **URL, —Ç–∞–∫–æ–≥–æ —è–∫** [https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz](https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz)
{% endhint %}

## **DYLD\_INSERT\_LIBRARIES**

–¶–µ —Å—Ö–æ–∂–µ –Ω–∞ [**LD\_PRELOAD –Ω–∞ Linux**](../../../../linux-hardening/privilege-escalation/#ld\_preload). –¶–µ –¥–æ–∑–≤–æ–ª—è—î –≤–∫–∞–∑–∞—Ç–∏ –ø—Ä–æ—Ü–µ—Å—É, —â–æ –±—É–¥–µ –∑–∞–ø—É—â–µ–Ω–æ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –ø–µ–≤–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑ —à–ª—è—Ö—É (—è–∫—â–æ –∑–º—ñ–Ω–Ω–∞ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –≤–≤—ñ–º–∫–Ω–µ–Ω–∞).

–¶—é —Ç–µ—Ö–Ω—ñ–∫—É —Ç–∞–∫–æ–∂ –º–æ–∂–Ω–∞ **–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —è–∫ —Ç–µ—Ö–Ω—ñ–∫—É ASEP**, –æ—Å–∫—ñ–ª—å–∫–∏ –∫–æ–∂–Ω–∞ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞ –ø—Ä–æ–≥—Ä–∞–º–∞ –º–∞—î —Ñ–∞–π–ª plist –ø—ñ–¥ –Ω–∞–∑–≤–æ—é "Info.plist", —è–∫–∏–π –¥–æ–∑–≤–æ–ª—è—î **–ø—Ä–∏–∑–Ω–∞—á–∞—Ç–∏ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –∫–ª—é—á–∞ –ø—ñ–¥ –Ω–∞–∑–≤–æ—é `LSEnvironmental`.

{% hint style="info" %}
–ü–æ—á–∏–Ω–∞—é—á–∏ –∑ 2012 —Ä–æ–∫—É **Apple –¥—Ä–∞–º–∞—Ç–∏—á–Ω–æ –∑–º–µ–Ω—à–∏–ª–∞ –ø–æ—Ç—É–∂–Ω—ñ—Å—Ç—å** **`DYLD_INSERT_LIBRARIES`**.

–ü–µ—Ä–µ–π–¥—ñ—Ç—å –¥–æ –∫–æ–¥—É —Ç–∞ **–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ `src/dyld.cpp`**. –£ —Ñ—É–Ω–∫—Ü—ñ—ó **`pruneEnvironmentVariables`** –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏, —â–æ –∑–º—ñ–Ω–Ω—ñ **`DYLD_*`** –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è.

–£ —Ñ—É–Ω–∫—Ü—ñ—ó **`processRestricted`** –≤—Å—Ç–∞–Ω–æ–≤–ª—é—î—Ç—å—Å—è –ø—Ä–∏—á–∏–Ω–∞ –æ–±–º–µ–∂–µ–Ω–Ω—è. –ü–µ—Ä–µ–≤—ñ—Ä–∏–≤—à–∏ —Ü–µ–π –∫–æ–¥, –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ, —â–æ –ø—Ä–∏—á–∏–Ω–∏ —Ç–∞–∫—ñ:

* –ë—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –º–∞—î `setuid/setgid`
* –Ü—Å–Ω—É–≤–∞–Ω–Ω—è —Ä–æ–∑–¥—ñ–ª—É `__RESTRICT/__restrict` —É –±—ñ–Ω–∞—Ä–Ω–æ–º—É —Ñ–∞–π–ª—ñ macho.
* –ü—Ä–æ–≥—Ä–∞–º–Ω–µ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –º–∞—î entitlements (–∑–∞—Ö–∏—â–µ–Ω–∏–π —Ä–µ–∂–∏–º) –±–µ–∑ entitlement [`com.apple.security.cs.allow-dyld-environment-variables`](https://developer.apple.com/documentation/bundleresources/entitlements/com\_apple\_security\_cs\_allow-dyld-environment-variables)
* –ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ **entitlements** –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é: `codesign -dv --entitlements :- </path/to/bin>`

–£ –±—ñ–ª—å—à –æ–Ω–æ–≤–ª–µ–Ω–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö –≤–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ —Ü—é –ª–æ–≥—ñ–∫—É —É –¥—Ä—É–≥—ñ–π —á–∞—Å—Ç–∏–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó **`configureProcessRestrictions`.** –û–¥–Ω–∞–∫, —É –Ω–æ–≤—ñ—à–∏—Ö –≤–µ—Ä—Å—ñ—è—Ö –≤–∏–∫–æ–Ω—É—é—Ç—å—Å—è **–ø–æ—á–∞—Ç–∫–æ–≤—ñ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ —Ñ—É–Ω–∫—Ü—ñ—ó** (–≤–∏ –º–æ–∂–µ—Ç–µ –≤–∏–¥–∞–ª–∏—Ç–∏ —É–º–æ–≤–∏, —â–æ —Å—Ç–æ—Å—É—é—Ç—å—Å—è iOS –∞–±–æ —Å–∏–º—É–ª—è—Ü—ñ—ó, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–æ–Ω–∏ –Ω–µ –±—É–¥—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –≤ macOS.
{% endhint %}

### –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫

–ù–∞–≤—ñ—Ç—å —è–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –∑–º—ñ–Ω–Ω—É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ **`DYLD_INSERT_LIBRARIES`**, —è–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –ø–µ—Ä–µ–≤—ñ—Ä—è—î –ø—ñ–¥–ø–∏—Å –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –¥–ª—è —ó—ó –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è, –≤—ñ–Ω –Ω–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç—å –≤–ª–∞—Å–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É.

–î–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤–ª–∞—Å–Ω–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –ø–æ–≤–∏–Ω–µ–Ω –º–∞—Ç–∏ **–æ–¥–∏–Ω –∑ –Ω–∞—Å—Ç—É–ø–Ω–∏—Ö entitlements**:

* [`com.apple.security.cs.disable-library-validation`](../../macos-security-protections/macos-dangerous-entitlements.md#com.apple.security.cs.disable-library-validation)
* [`com.apple.private.security.clear-library-validation`](../../macos-security-protections/macos-dangerous-entitlements.md#com.apple.private.security.clear-library-validation)

–∞–±–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª **–Ω–µ –ø–æ–≤–∏–Ω–µ–Ω** –º–∞—Ç–∏ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å **hardened runtime** –∞–±–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å **library validation**.

–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –º–∞—î –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª **hardened runtime** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `codesign --display --verbose <bin>` –ø–µ—Ä–µ–≤—ñ—Ä—è—é—á–∏ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å runtime –≤ **`CodeDirectory`** –Ω–∞–ø—Ä–∏–∫–ª–∞–¥: **`CodeDirectory v=20500 size=767 flags=0x10000(runtime) hashes=13+7 location=embedded`**

–í–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É, —è–∫—â–æ –≤–æ–Ω–∞ **–ø—ñ–¥–ø–∏—Å–∞–Ω–∞ —Ç–∏–º —Å–∞–º–∏–º —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç–æ–º, —â–æ –π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª**.

–ó–Ω–∞–π–¥—ñ—Ç—å –ø—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ (–∑–ª–æ–≤–∂–∏–≤–∞—Ç–∏) –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü–µ —Ç–∞ –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –æ–±–º–µ–∂–µ–Ω–Ω—è –≤:

{% content-ref url="macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

## –ü–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è Dylib

{% hint style="danger" %}
–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ **–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ —Ç–∞–∫–æ–∂ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫ –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è Dylib.
{% endhint %}

–Ø–∫ —ñ –≤ Windows, –≤ MacOS –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ **–ø–µ—Ä–µ—Ö–æ–ø–ª—é–≤–∞—Ç–∏ dylibs**, —â–æ–± –∑—Ä–æ–±–∏—Ç–∏, —â–æ–± **–¥–æ–¥–∞—Ç–∫–∏ –≤–∏–∫–æ–Ω—É–≤–∞–ª–∏** **–¥–æ–≤—ñ–ª—å–Ω–∏–π** **–∫–æ–¥** (–Ω—É, —Ñ–∞–∫—Ç–∏—á–Ω–æ –≤—ñ–¥ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ —Ü–µ –º–æ–∂–µ –±—É—Ç–∏ –Ω–µ–º–æ–∂–ª–∏–≤–æ, –æ—Å–∫—ñ–ª—å–∫–∏ –≤–∞–º –º–æ–∂–µ –∑–Ω–∞–¥–æ–±–∏—Ç–∏—Å—è –¥–æ–∑–≤—ñ–ª TCC –¥–ª—è –∑–∞–ø–∏—Å—É –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ –ø–∞–∫–µ—Ç–∞ `.app` —Ç–∞ –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏).\
–û–¥–Ω–∞–∫, —Å–ø–æ—Å—ñ–±, —è–∫–∏–º **–¥–æ–¥–∞—Ç–∫–∏ MacOS** **–∑–∞–≤–∞–Ω—Ç–∞–∂—É—é—Ç—å** **–±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏**, **–±—ñ–ª—å—à –æ–±–º–µ–∂–µ–Ω–∏–π**, –Ω—ñ–∂ –≤ Windows. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —Ä–æ–∑—Ä–æ–±–Ω–∏–∫–∏ **—à–∫—ñ–¥–ª–∏–≤–æ–≥–æ –ø—Ä–æ–≥—Ä–∞–º–Ω–æ–≥–æ –∑–∞–±–µ–∑–ø–µ—á–µ–Ω–Ω—è –≤—Å–µ —â–µ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É –¥–ª—è** **–ø—Ä–∏—Ö–æ–≤—É–≤–∞–Ω–Ω—è**, –∞–ª–µ –π–º–æ–≤—ñ—Ä–Ω—ñ—Å—Ç—å **–∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è —Ü–∏–º –¥–ª—è –ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ –Ω–∞–±–∞–≥–∞—Ç–æ –Ω–∏–∂—á–∞**.

–ü–æ-–ø–µ—Ä—à–µ, **—á–∞—Å—Ç—ñ—à–µ –∑—É—Å—Ç—Ä—ñ—á–∞—î—Ç—å—Å—è**, —â–æ **–±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ MacOS –≤–∫–∞–∑—É—é—Ç—å –ø–æ–≤–Ω–∏–π —à–ª—è—Ö** –¥–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –Ü –ø–æ-–¥—Ä—É–≥–µ, **MacOS –Ω—ñ–∫–æ–ª–∏ –Ω–µ —à—É–∫–∞—î** –≤ –ø–∞–ø–∫–∞—Ö **$PATH** –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏.

**–û—Å–Ω–æ–≤–Ω–∞** —á–∞—Å—Ç–∏–Ω–∞ **–∫–æ–¥—É**, —â–æ —Å—Ç–æ—Å—É—î—Ç—å—Å—è —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ, –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ **`ImageLoader::recursiveLoadLibraries`** –≤ `ImageLoader.cpp`.

–Ü—Å–Ω—É—é—Ç—å **4 —Ä—ñ–∑–Ω—ñ –∫–æ–º–∞–Ω–¥–∏ –∑–∞–≥–æ–ª–æ–≤–∫–∞**, —è–∫—ñ –º–æ–∂–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª macho –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫:

* –ö–æ–º–∞–Ω–¥–∞ **`LC_LOAD_DYLIB`** - —Ü–µ –∑–∞–≥–∞–ª—å–Ω–∞ –∫–æ–º–∞–Ω–¥–∞ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è dylib.
* –ö–æ–º–∞–Ω–¥–∞ **`LC_LOAD_WEAK_DYLIB`** –ø—Ä–∞—Ü—é—î —Ç–∞–∫ —Å–∞–º–æ, —è–∫ –ø–æ–ø–µ—Ä–µ–¥–Ω—è, –∞–ª–µ —è–∫—â–æ dylib –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–æ, –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –ø—Ä–æ–¥–æ–≤–∂—É—î—Ç—å—Å—è –±–µ–∑ –±—É–¥—å-—è–∫–æ—ó –ø–æ–º–∏–ª–∫–∏.
* –ö–æ–º–∞–Ω–¥–∞ **`LC_REEXPORT_DYLIB`** - —Ü–µ –ø—Ä–æ–∫—Å—ñ (–∞–±–æ –ø–æ–≤—Ç–æ—Ä–Ω–µ –µ–∫—Å–ø–æ—Ä—Ç—É–≤–∞–Ω–Ω—è) —Å–∏–º–≤–æ–ª—ñ–≤ –∑ —ñ–Ω—à–æ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏.
* –ö–æ–º–∞–Ω–¥–∞ **`LC_LOAD_UPWARD_DYLIB`** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è, –∫–æ–ª–∏ –¥–≤—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –∑–∞–ª–µ–∂–∞—Ç—å –æ–¥–Ω–∞ –≤—ñ–¥ –æ–¥–Ω–æ—ó (—Ü–µ –Ω–∞–∑–∏–≤–∞—î—Ç—å—Å—è _upward dependency_).

–û–¥–Ω–∞–∫ —ñ—Å–Ω—É—é—Ç—å **2 —Ç–∏–ø–∏ –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è dylib**:

* **–í—ñ–¥—Å—É—Ç–Ω—ñ —Å–ª–∞–±–∫—ñ –∑–≤'—è–∑–∞–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏**: –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ –¥–æ–¥–∞—Ç–æ–∫ —Å–ø—Ä–æ–±—É—î –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É, —è–∫–æ—ó –Ω–µ —ñ—Å–Ω—É—î, –Ω–∞–ª–∞—à—Ç–æ–≤–∞–Ω—É –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é **LC\_LOAD\_WEAK\_DYLIB**. –ü–æ—Ç—ñ–º, **—è–∫—â–æ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ —Ä–æ–∑–º—ñ—Å—Ç–∏—Ç—å dylib —Ç–∞–º, –¥–µ –≤–æ–Ω–∞ –æ—á—ñ–∫—É—î—Ç—å—Å—è, –≤–æ–Ω–∞ –±—É–¥–µ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–∞**.
* –¢–µ, —â–æ –ø–æ—Å–∏–ª–∞–Ω–Ω—è —î "—Å–ª–∞–±–∫–∏–º", –æ–∑–Ω–∞—á–∞—î, —â–æ –¥–æ–¥–∞—Ç–æ–∫ –ø—Ä–æ–¥–æ–≤–∂–∏—Ç—å –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –Ω–µ –∑–Ω–∞–π–¥–µ–Ω–∞.
* **–ö–æ–¥, —â–æ —Å—Ç–æ—Å—É—î—Ç—å—Å—è —Ü—å–æ–≥–æ**, –∑–Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ —Ñ—É–Ω–∫—Ü—ñ—ó `ImageLoaderMachO::doGetDependentLibraries` —Ñ–∞–π–ª—É `ImageLoaderMachO.cpp`, –¥–µ `lib->required` —î –ª–∏—à–µ `false`, –∫–æ–ª–∏ `LC_LOAD_WEAK_DYLIB` —î true.
* **–ó–Ω–∞–π–¥—ñ—Ç—å —Å–ª–∞–±–∫—ñ –∑–≤'—è–∑–∞–Ω—ñ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏** —É –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö (–ø—ñ–∑–Ω—ñ—à–µ –≤–∏ –ø–æ–±–∞—á–∏—Ç–µ –ø—Ä–∏–∫–ª–∞–¥ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –¥–ª—è –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è):
* ```bash
  ```

otool -l \</path/to/bin> | grep LC\_LOAD\_WEAK\_DYLIB -A 5 cmd LC\_LOAD\_WEAK\_DYLIB cmdsize 56 name /var/tmp/lib/libUtl.1.dylib (offset 24) time stamp 2 Wed Jun 21 12:23:31 1969 current version 1.0.0 compatibility version 1.0.0

````
* **–ù–∞–ª–∞—à—Ç–æ–≤–∞–Ω–æ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é @rpath**: –ë—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏ Mach-O –º–æ–∂—É—Ç—å –º—ñ—Å—Ç–∏—Ç–∏ –∫–æ–º–∞–Ω–¥–∏ **`LC_RPATH`** —Ç–∞ **`LC_LOAD_DYLIB`**. –ù–∞ –æ—Å–Ω–æ–≤—ñ **–∑–Ω–∞—á–µ–Ω—å** —Ü–∏—Ö –∫–æ–º–∞–Ω–¥ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –±—É–¥—É—Ç—å **–∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—ñ** –∑ **—Ä—ñ–∑–Ω–∏—Ö –∫–∞—Ç–∞–ª–æ–≥—ñ–≤**.
* **`LC_RPATH`** –º—ñ—Å—Ç–∏—Ç—å —à–ª—è—Ö–∏ –¥–æ –¥–µ—è–∫–∏—Ö –ø–∞–ø–æ–∫, —è–∫—ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –±—ñ–Ω–∞—Ä–Ω–∏–º —Ñ–∞–π–ª–æ–º.
* **`LC_LOAD_DYLIB`** –º—ñ—Å—Ç–∏—Ç—å —à–ª—è—Ö –¥–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –¶—ñ —à–ª—è—Ö–∏ –º–æ–∂—É—Ç—å –º—ñ—Å—Ç–∏—Ç–∏ **`@rpath`**, —è–∫–∏–π –±—É–¥–µ **–∑–∞–º—ñ–Ω–µ–Ω–∏–π** –∑–Ω–∞—á–µ–Ω–Ω—è–º–∏ –≤ **`LC_RPATH`**. –Ø–∫—â–æ –≤ **`LC_RPATH`** —î –∫—ñ–ª—å–∫–∞ —à–ª—è—Ö—ñ–≤, –∫–æ–∂–µ–Ω –∑ –Ω–∏—Ö –±—É–¥–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è –ø–æ—à—É–∫—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è. –ü—Ä–∏–∫–ª–∞–¥:
* –Ø–∫—â–æ **`LC_LOAD_DYLIB`** –º—ñ—Å—Ç–∏—Ç—å `@rpath/library.dylib` —ñ **`LC_RPATH`** –º—ñ—Å—Ç–∏—Ç—å `/application/app.app/Contents/Framework/v1/` —Ç–∞ `/application/app.app/Contents/Framework/v2/`. –û–±–∏–¥–≤–∞ –∫–∞—Ç–∞–ª–æ–≥–∏ –±—É–¥—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏—Å—è –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è `library.dylib`**.** –Ø–∫—â–æ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞ –Ω–µ —ñ—Å–Ω—É—î –≤ `[...]/v1/` —ñ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–æ–∂–µ –ø–æ–º—ñ—Å—Ç–∏—Ç–∏ —ó—ó —Ç—É–¥–∏, —â–æ–± –ø–µ—Ä–µ—Ö–æ–ø–∏—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –≤ `[...]/v2/`, –æ—Å–∫—ñ–ª—å–∫–∏ –¥–æ—Ç—Ä–∏–º—É—î—Ç—å—Å—è –ø–æ—Ä—è–¥–æ–∫ —à–ª—è—Ö—ñ–≤ —É **`LC_LOAD_DYLIB`**.
* **–ó–Ω–∞–π–¥—ñ—Ç—å —à–ª—è—Ö–∏ rpath —Ç–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏** –≤ –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª–∞—Ö –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é: `otool -l </path/to/binary> | grep -E "LC_RPATH|LC_LOAD_DYLIB" -A 5`

<div data-gb-custom-block data-tag="hint" data-style='info'>

**`@executable_path`**: –¶–µ **—à–ª—è—Ö** –¥–æ –∫–∞—Ç–∞–ª–æ–≥—É, —â–æ –º—ñ—Å—Ç–∏—Ç—å **–≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª**.

**`@loader_path`**: –¶–µ **—à–ª—è—Ö** –¥–æ **–∫–∞—Ç–∞–ª–æ–≥—É**, —â–æ –º—ñ—Å—Ç–∏—Ç—å **Mach-O binary**, —è–∫–∏–π –º—ñ—Å—Ç–∏—Ç—å –∫–æ–º–∞–Ω–¥—É –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è.

* –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–æ–º—É —Ñ–∞–π–ª—ñ, **`@loader_path`** —Ñ–∞–∫—Ç–∏—á–Ω–æ —î **—Ç–∞–∫–∏–º —Å–∞–º–∏–º**, —è–∫ **`@executable_path`**.
* –ö–æ–ª–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –≤ **dylib**, **`@loader_path`** –≤–∫–∞–∑—É—î **—à–ª—è—Ö** –¥–æ **dylib**.

</div>

–°–ø–æ—Å—ñ–± **–ø—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤** –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ –ø–æ–ª—è–≥–∞—î –≤ —Ç–æ–º—É, —â–æ –≤ —Ä—ñ–¥–∫—ñ—Å–Ω–æ–º—É –≤–∏–ø–∞–¥–∫—É **–∑–∞—Å—Ç–æ—Å—É–Ω–æ–∫**, —è–∫–∏–π –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è **–≤—ñ–¥** **root**, —à—É–∫–∞—î –¥–µ—è–∫—É **–±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –≤ –¥–µ—è–∫–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ, –¥–µ –∑–ª–æ–≤–º–∏—Å–Ω–∏–∫ –º–∞—î –ø—Ä–∞–≤–∞ –Ω–∞ –∑–∞–ø–∏—Å.**

<div data-gb-custom-block data-tag="hint" data-style='success'>

–ß—É–¥–æ–≤–∏–π **—Å–∫–∞–Ω–µ—Ä** –¥–ª—è –ø–æ—à—É–∫—É **–≤—ñ–¥—Å—É—Ç–Ω—ñ—Ö –±—ñ–±–ª—ñ–æ—Ç–µ–∫** –≤ –∑–∞—Å—Ç–æ—Å—É–Ω–∫–∞—Ö - —Ü–µ [**Dylib Hijack Scanner**](https://objective-see.com/products/dhs.html) –∞–±–æ [**CLI –≤–µ—Ä—Å—ñ—è**](https://github.com/pandazheng/DylibHijack).\
–ß—É–¥–æ–≤–∏–π **–∑–≤—ñ—Ç –∑ —Ç–µ—Ö–Ω—ñ—á–Ω–∏–º–∏ –¥–µ—Ç–∞–ª—è–º–∏** –ø—Ä–æ —Ü—é —Ç–µ—Ö–Ω—ñ–∫—É –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ [**—Ç—É—Ç**](https://www.virusbulletin.com/virusbulletin/2015/03/dylib-hijacking-os-x).

</div>

**–ü—Ä–∏–∫–ª–∞–¥**

<div data-gb-custom-block data-tag="content-ref" data-url='../../macos-dyld-hijacking-and-dyld_insert_libraries.md'>

[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](../../macos-dyld-hijacking-and-dyld\_insert\_libraries.md)

</div>

## –ü—ñ–¥–≤–∏—â–µ–Ω–Ω—è –ø—Ä–∏–≤—ñ–ª–µ—ó–≤ Dlopen

<div data-gb-custom-block data-tag="hint" data-style='danger'>

–ü–∞–º'—è—Ç–∞–π—Ç–µ, —â–æ **–ø–æ–ø–µ—Ä–µ–¥–Ω—ñ –æ–±–º–µ–∂–µ–Ω–Ω—è –ø–µ—Ä–µ–≤—ñ—Ä–∫–∏ –±—ñ–±–ª—ñ–æ—Ç–µ–∫ —Ç–∞–∫–æ–∂ –∑–∞—Å—Ç–æ—Å–æ–≤—É—é—Ç—å—Å—è** –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∞—Ç–∞–∫ Dlopen hijacking.

</div>

–ó **`man dlopen`**:

* –ö–æ–ª–∏ —à–ª—è—Ö **–Ω–µ –º—ñ—Å—Ç–∏—Ç—å —Å–∏–º–≤–æ–ª–∞ –∫–æ—Å–æ—ó —Ä–∏—Å–∫–∏** (—Ç–æ–±—Ç–æ —Ü–µ –ª–∏—à–µ —ñ–º'—è –ª–∏—Å—Ç–∫–∞), **dlopen() –±—É–¥–µ —Ä–æ–±–∏—Ç–∏ –ø–æ—à—É–∫**. –Ø–∫—â–æ **`$DYLD_LIBRARY_PATH`** –±—É–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É, dyld —Å–ø–æ—á–∞—Ç–∫—É **–ø–æ–¥–∏–≤–∏—Ç—å—Å—è –≤ —Ç–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ**. –î–∞–ª—ñ, —è–∫—â–æ –≤–∏–∫–ª–∏–∫–∞—é—á–∏–π —Ñ–∞–π–ª mach-o –∞–±–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª –≤–∫–∞–∑—É—é—Ç—å **`LC_RPATH`**, —Ç–æ dyld –±—É–¥–µ **–¥–∏–≤–∏—Ç–∏—Å—è –≤ —Ü–∏—Ö** –∫–∞—Ç–∞–ª–æ–≥–∞—Ö. –î–∞–ª—ñ, —è–∫—â–æ –ø—Ä–æ—Ü–µ—Å **–Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π**, dyld –±—É–¥–µ —à—É–∫–∞—Ç–∏ –≤ **–ø–æ—Ç–æ—á–Ω–æ–º—É —Ä–æ–±–æ—á–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ**. –ù–∞—Ä–µ—à—Ç—ñ, –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤ dyld —Å–ø—Ä–æ–±—É—î –¥–µ—è–∫—ñ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏. –Ø–∫—â–æ **`$DYLD_FALLBACK_LIBRARY_PATH`** –±—É–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É, dyld –±—É–¥–µ —à—É–∫–∞—Ç–∏ –≤ **—Ü–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö**, —ñ–Ω–∞–∫—à–µ dyld –ø–æ–¥–∏–≤–∏—Ç—å—Å—è –≤ **`/usr/local/lib/`** (—è–∫—â–æ –ø—Ä–æ—Ü–µ—Å –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π), –∞ –ø–æ—Ç—ñ–º –≤ **`/usr/lib/`** (—Ü—é —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é –±—É–ª–æ –≤–∑—è—Ç–æ –∑ **`man dlopen`**).
1. `$DYLD_LIBRARY_PATH`
2. `LC_RPATH`
3. `CWD`(—è–∫—â–æ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π)
4. `$DYLD_FALLBACK_LIBRARY_PATH`
5. `/usr/local/lib/` (—è–∫—â–æ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π)
6. `/usr/lib/`

<div data-gb-custom-block data-tag="hint" data-style='danger'>

–Ø–∫—â–æ –≤ —ñ–º–µ–Ω—ñ –Ω–µ–º–∞—î –∫–æ—Å–æ—ó —Ä–∏—Å–∫–∏, —î 2 —Å–ø–æ—Å–æ–±–∏ –∑–¥—ñ–π—Å–Ω–∏—Ç–∏ –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è:

* –Ø–∫—â–æ –±—É–¥—å-—è–∫–∏–π **`LC_RPATH`** —î **–∑–∞–ø–∏—Å—É–≤–∞–Ω–∏–º** (–∞–ª–µ –ø–µ—Ä–µ–≤—ñ—Ä—è—î—Ç—å—Å—è –ø—ñ–¥–ø–∏—Å, —Ç–æ–º—É –¥–ª—è —Ü—å–æ–≥–æ —Ç–∞–∫–æ–∂ –ø–æ—Ç—Ä—ñ–±–Ω–æ, —â–æ–± –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –±—É–≤ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–º)
* –Ø–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª **–Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π**, —Ç–æ–¥—ñ –º–æ–∂–ª–∏–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–æ—Å—å –∑ CWD (–∞–±–æ –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –æ–¥–Ω—ñ—î—é –∑ –∑–∞–∑–Ω–∞—á–µ–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞)

</div>

* –ö–æ–ª–∏ —à–ª—è—Ö **–≤–∏–≥–ª—è–¥–∞—î —è–∫ —à–ª—è—Ö –¥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `/stuff/foo.framework/foo`), —è–∫—â–æ **`$DYLD_FRAMEWORK_PATH`** –±—É–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É, dyld —Å–ø–æ—á–∞—Ç–∫—É –ø–æ–¥–∏–≤–∏—Ç—å—Å—è –≤ —Ü—å–æ–º—É –∫–∞—Ç–∞–ª–æ–∑—ñ –¥–ª—è **—á–∞—Å—Ç–∫–æ–≤–æ–≥–æ —à–ª—è—Ö—É —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, `foo.framework/foo`). –î–∞–ª—ñ dyld —Å–ø—Ä–æ–±—É—î **–ø–æ–¥–∞–Ω–æ–≥–æ —à–ª—è—Ö—É —è–∫ —î** (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–æ–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤—ñ–¥–Ω–æ—Å–Ω–∏—Ö —à–ª—è—Ö—ñ–≤). –ù–∞—Ä–µ—à—Ç—ñ, –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤ dyld —Å–ø—Ä–æ–±—É—î –¥–µ—è–∫—ñ —Ä–µ–∑–µ—Ä–≤–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏. –Ø–∫—â–æ **`$DYLD_FALLBACK_FRAMEWORK_PATH`** –±—É–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É, dyld –±—É–¥–µ —à—É–∫–∞—Ç–∏ –≤ —Ü–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö. –í —ñ–Ω—à–æ–º—É –≤–∏–ø–∞–¥–∫—É –≤—ñ–Ω –±—É–¥–µ —à—É–∫–∞—Ç–∏ –≤ **`/Library/Frameworks`** (–Ω–∞ macOS, —è–∫—â–æ –ø—Ä–æ—Ü–µ—Å –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π), –∞ –ø–æ—Ç—ñ–º –≤ **`/System/Library/Frameworks`**.
1. `$DYLD_FRAMEWORK_PATH`
2. –ø–æ–¥–∞–Ω–∏–π —à–ª—è—Ö (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–æ–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤—ñ–¥–Ω–æ—Å–Ω–∏—Ö —à–ª—è—Ö—ñ–≤, —è–∫—â–æ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π)
3. `$DYLD_FALLBACK_FRAMEWORK_PATH`
4. `/Library/Frameworks` (—è–∫—â–æ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π)
5. `/System/Library/Frameworks`

<div data-gb-custom-block data-tag="hint" data-style='danger'>

–Ø–∫—â–æ —à–ª—è—Ö –¥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É, —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –±—É–¥–µ:

* –Ø–∫—â–æ –ø—Ä–æ—Ü–µ—Å **–Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π**, –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è **–≤—ñ–¥–Ω–æ—Å–Ω–∏–º —à–ª—è—Ö–æ–º –≤—ñ–¥ CWD** –∑–≥–∞–¥–∞–Ω–∏–º–∏ –∑–º—ñ–Ω–Ω–∏–º–∏ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ (–Ω–∞–≤—ñ—Ç—å —è–∫—â–æ –≤ –¥–æ–∫—É–º–µ–Ω—Ç–∞—Ü—ñ—ó –Ω–µ —Å–∫–∞–∑–∞–Ω–æ, —â–æ —è–∫—â–æ –ø—Ä–æ—Ü–µ—Å –æ–±–º–µ–∂–µ–Ω–∏–π, –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ DYLD\_\* –≤–∏–¥–∞–ª—è—é—Ç—å—Å—è)

</div>

* –ö–æ–ª–∏ —à–ª—è—Ö **–º—ñ—Å—Ç–∏—Ç—å –∫–æ—Å—É —Ä–∏—Å–∫—É, –∞–ª–µ –Ω–µ —î —à–ª—è—Ö–æ–º –¥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É** (—Ç–æ–±—Ç–æ –ø–æ–≤–Ω–∏–π —à–ª—è—Ö –∞–±–æ —á–∞—Å—Ç–∫–æ–≤–∏–π —à–ª—è—Ö –¥–æ dylib), dlopen() —Å–ø–æ—á–∞—Ç–∫—É –ø–æ–¥–∏–≤–∏—Ç—å—Å—è (—è–∫—â–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ) –≤ **`$DYLD_LIBRARY_PATH`** (–∑ –ª–∏—Å—Ç–∫–æ–≤–æ—é —á–∞—Å—Ç–∏–Ω–æ—é –≤—ñ–¥ —à–ª—è—Ö—É). –î–∞–ª—ñ dyld **—Å–ø—Ä–æ–±—É—î –ø–æ–¥–∞–Ω–∏–π —à–ª—è—Ö** (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–æ–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤—ñ–¥–Ω–æ—Å–Ω–∏—Ö —à–ª—è—Ö—ñ–≤ (–∞–ª–µ –ª–∏—à–µ –¥–ª—è –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏—Ö –ø—Ä–æ—Ü–µ—Å—ñ–≤)). –ù–∞—Ä–µ—à—Ç—ñ, –¥–ª—è —Å—Ç–∞—Ä–∏—Ö –±—ñ–Ω–∞—Ä–Ω–∏–∫—ñ–≤ dyld —Å–ø—Ä–æ–±—É—î —Ä–µ–∑–µ—Ä–≤–Ω—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏. –Ø–∫—â–æ **`$DYLD_FALLBACK_LIBRARY_PATH`** –±—É–≤ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–π –ø—Ä–∏ –∑–∞–ø—É—Å–∫—É, dyld –±—É–¥–µ —à—É–∫–∞—Ç–∏ –≤ —Ü–∏—Ö –∫–∞—Ç–∞–ª–æ–≥–∞—Ö, —ñ–Ω–∞–∫—à–µ dyld –ø–æ–¥–∏–≤–∏—Ç—å—Å—è –≤ **`/usr/local/lib/`** (—è–∫—â–æ –ø—Ä–æ—Ü–µ—Å –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π), –∞ –ø–æ—Ç—ñ–º –≤ **`/usr/lib/`**.
1. `$DYLD_LIBRARY_PATH`
2. –ø–æ–¥–∞–Ω–∏–π —à–ª—è—Ö (–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –ø–æ—Ç–æ—á–Ω–∏–π —Ä–æ–±–æ—á–∏–π –∫–∞—Ç–∞–ª–æ–≥ –¥–ª—è –≤—ñ–¥–Ω–æ—Å–Ω–∏—Ö —à–ª—è—Ö—ñ–≤, —è–∫—â–æ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π)
3. `$DYLD_FALLBACK_LIBRARY_PATH`
4. `/usr/local/lib/` (—è–∫—â–æ –Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π)
5. `/usr/lib/`

<div data-gb-custom-block data-tag="hint" data-style='danger'>

–Ø–∫—â–æ –≤ —ñ–º–µ–Ω—ñ —î –∫–æ—Å—ñ —Ä–∏—Å–∫–∏ —ñ —Ü–µ –Ω–µ —à–ª—è—Ö –¥–æ —Ñ—Ä–µ–π–º–≤–æ—Ä–∫—É, —Å–ø–æ—Å—ñ–± –ø–µ—Ä–µ—Ö–æ–ø–ª–µ–Ω–Ω—è –±—É–¥–µ:

* –Ø–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª **–Ω–µ–æ–±–º–µ–∂–µ–Ω–∏–π**, —Ç–æ–¥—ñ –º–æ–∂–ª–∏–≤–æ –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —â–æ—Å—å –∑ CWD –∞–±–æ `/usr/local/lib` (–∞–±–æ –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è –æ–¥–Ω—ñ—î—é –∑ –∑–∞–∑–Ω–∞—á–µ–Ω–∏—Ö –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞)

</div>

<div data-gb-custom-block data-tag="hint" data-style='info'>

–ü—Ä–∏–º—ñ—Ç–∫–∞: –ù–µ–º–∞—î **—Ñ–∞–π–ª—ñ–≤ –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—ó –¥–ª—è –∫–µ—Ä—É–≤–∞–Ω–Ω—è –ø–æ—à—É–∫–æ–º dlopen**.

–ü—Ä–∏–º—ñ—Ç–∫–∞: –Ø–∫—â–æ –≤–∏–∫–æ–Ω—É–≤–∞–Ω–∏–π —Ñ–∞–π–ª —î **set\[ug\]id binary –∞–±–æ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –∑ entitlements**, —Ç–æ–¥—ñ **–≤—Å—ñ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ —ñ–≥–Ω–æ—Ä—É—é—Ç—å—Å—è**, —ñ –º–æ–∂–Ω–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ –ª–∏—à–µ –ø–æ–≤–Ω–∏–π —à–ª—è—Ö ([–ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ –æ–±–º–µ–∂–µ–Ω–Ω—è DYLD\_INSERT\_LIBRARIES](../../macos-dyld-hijacking-and-dyld\_insert\_libraries.md#check-dyld\_insert\_librery-restrictions) –¥–ª—è –±—ñ–ª—å—à –¥–µ—Ç–∞–ª—å–Ω–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó)

–ü—Ä–∏–º—ñ—Ç–∫–∞: –ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö Apple –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è "—É–Ω—ñ–≤–µ—Ä—Å–∞–ª—å–Ω—ñ" —Ñ–∞–π–ª–∏ –¥–ª—è –ø–æ—î–¥–Ω–∞–Ω–Ω—è –±—ñ–±–ª—ñ–æ—Ç–µ–∫ 32-–±—ñ—Ç —ñ 64-–±—ñ—Ç. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ **–æ–∫—Ä–µ–º–∏—Ö —à–ª—è—Ö—ñ–≤ –ø–æ—à—É–∫—É –¥–ª—è 32-–±—ñ—Ç —Ç–∞ 64-–±—ñ—Ç –±—ñ–±–ª—ñ–æ—Ç–µ–∫ –Ω–µ–º–∞—î**.

–ü—Ä–∏–º—ñ—Ç–∫–∞: –ù–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞—Ö Apple –±—ñ–ª—å—à—ñ—Å—Ç—å OS dylibs **–æ–±'—î–¥–Ω–∞–Ω—ñ –≤ –∫–µ—à dyld** —ñ –Ω–µ —ñ—Å–Ω—É—é—Ç—å –Ω–∞ –¥–∏—Å–∫—É. –¢–æ–º—É –≤–∏–∫–ª–∏–∫ **`stat()`** –¥–ª—è –ø–æ–ø–µ—Ä–µ–¥–Ω—å–æ–≥–æ –ø–µ—Ä–µ–≥–ª—è–¥—É —Ç–æ–≥–æ, —á–∏ —ñ—Å–Ω—É—î OS dylib, **–Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ**. –û–¥–Ω–∞–∫ **`dlopen_preflight()`** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î —Ç—ñ —Å–∞–º—ñ –∫—Ä–æ–∫–∏, —â–æ –π **`dlopen()`**, –¥–ª—è –ø–æ—à—É–∫—É —Å—É–º—ñ—Å–Ω–æ–≥–æ —Ñ–∞–π–ª—É mach-o.

</div>

**–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ —à–ª—è—Ö–∏**

–î–∞–≤–∞–π—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏–º–æ –≤—Å—ñ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –Ω–∞—Å—Ç—É–ø–Ω–æ–≥–æ –∫–æ–¥—É:
```c
// gcc dlopentest.c -o dlopentest -Wl,-rpath,/tmp/test
#include <dlfcn.h>
#include <stdio.h>

int main(void)
{
void* handle;

fprintf("--- No slash ---\n");
handle = dlopen("just_name_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative framework ---\n");
handle = dlopen("a/framework/rel_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs framework ---\n");
handle = dlopen("/a/abs/framework/abs_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative Path ---\n");
handle = dlopen("a/folder/rel_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs Path ---\n");
handle = dlopen("/a/abs/folder/abs_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

return 0;
}
````

–Ø–∫—â–æ –≤–∏ —Å–∫–æ–º–ø—ñ–ª—é—î—Ç–µ —Ç–∞ –≤–∏–∫–æ–Ω–∞—î—Ç–µ —Ü–µ, –≤–∏ –º–æ–∂–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **–¥–µ –±–µ–∑—É—Å–ø—ñ—à–Ω–æ —à—É–∫–∞–ª–∞—Å—è –∫–æ–∂–Ω–∞ –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∞**. –ö—Ä—ñ–º —Ç–æ–≥–æ, –≤–∏ –º–æ–∂–µ—Ç–µ **—Ñ—ñ–ª—å—Ç—Ä—É–≤–∞—Ç–∏ –∂—É—Ä–Ω–∞–ª–∏ —Ñ–∞–π–ª–æ–≤–æ—ó —Å–∏—Å—Ç–µ–º–∏**:

```bash
sudo fs_usage | grep "dlopentest"
```

## –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –≤—ñ–¥–Ω–æ—Å–Ω–∏—Ö —à–ª—è—Ö—ñ–≤ –¥–ª—è –≤–∏–∫—Ä–∞–¥–µ–Ω–Ω—è

–Ø–∫—â–æ **–ø—Ä–∏–≤—ñ–ª–µ–π–æ–≤–∞–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª/–¥–æ–¥–∞—Ç–æ–∫** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, SUID –∞–±–æ –¥–µ—è–∫–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –∑ –ø–æ—Ç—É–∂–Ω–∏–º–∏ entitlements) **–∑–∞–≤–∞–Ω—Ç–∞–∂—É—î –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –∑–∞ –≤—ñ–¥–Ω–æ—Å–Ω–∏–º —à–ª—è—Ö–æ–º** (–Ω–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ `@executable_path` –∞–±–æ `@loader_path`) —ñ –º–∞—î **–≤–∏–º–∫–Ω–µ–Ω—É –ø–µ—Ä–µ–≤—ñ—Ä–∫—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫**, –º–æ–∂–ª–∏–≤–æ –ø–µ—Ä–µ–º—ñ—Å—Ç–∏—Ç–∏ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –¥–æ –º—ñ—Å—Ü—è, –¥–µ –∞—Ç–∞–∫—É—é—á–∏–π –º–æ–∂–µ **–∑–º—ñ–Ω–∏—Ç–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω—É –±—ñ–±–ª—ñ–æ—Ç–µ–∫—É –∑–∞ –≤—ñ–¥–Ω–æ—Å–Ω–∏–º —à–ª—è—Ö–æ–º**, —ñ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏ —Ü–µ –¥–ª—è –≤–ø—Ä–æ–≤–∞–¥–∂–µ–Ω–Ω—è –∫–æ–¥—É –≤ –ø—Ä–æ—Ü–µ—Å.

## –û–±—Ä—ñ–∑–∞–Ω–Ω—è –∑–º—ñ–Ω–Ω–∏—Ö —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ `DYLD_*` —Ç–∞ `LD_LIBRARY_PATH`

–£ —Ñ–∞–π–ª—ñ `dyld-dyld-832.7.1/src/dyld2.cpp` –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ —Ñ—É–Ω–∫—Ü—ñ—é **`pruneEnvironmentVariables`**, —è–∫–∞ –≤–∏–¥–∞–ª–∏—Ç—å –±—É–¥—å-—è–∫—É –∑–º—ñ–Ω–Ω—É —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞, —è–∫–∞ **–ø–æ—á–∏–Ω–∞—î—Ç—å—Å—è –∑ `DYLD_`** —Ç–∞ **`LD_LIBRARY_PATH=`**.

–¢–∞–∫–æ–∂ –±—É–¥–µ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ –Ω–∞ **null** –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ **`DYLD_FALLBACK_FRAMEWORK_PATH`** —Ç–∞ **`DYLD_FALLBACK_LIBRARY_PATH`** –¥–ª—è –±—ñ–Ω–∞—Ä–Ω–∏—Ö —Ñ–∞–π–ª—ñ–≤ –∑ –ø—Ä–∞–≤–∞–º–∏ **suid** —Ç–∞ **sgid**.

–¶—è —Ñ—É–Ω–∫—Ü—ñ—è –≤–∏–∫–ª–∏–∫–∞—î—Ç—å—Å—è –∑ —Ñ—É–Ω–∫—Ü—ñ—ó **`_main`** —Ç–æ–≥–æ –∂ —Ñ–∞–π–ª—É, —è–∫—â–æ —Ü—ñ–ª—å–æ–≤–∞ –ø–ª–∞—Ç—Ñ–æ—Ä–º–∞ - OSX, —Ç–∞–∫–∏–º —á–∏–Ω–æ–º:

```cpp
#if TARGET_OS_OSX
if ( !gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache ) {
pruneEnvironmentVariables(envp, &apple);
```

—ñ —Ü—ñ –±—É–ª–µ–≤—ñ –ø—Ä–∞–ø–æ—Ä—Ü—ñ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω—ñ –≤ —Ç–æ–º—É –∂ —Ñ–∞–π–ª—ñ —É –∫–æ–¥—ñ:

```cpp
#if TARGET_OS_OSX
// support chrooting from old kernel
bool isRestricted = false;
bool libraryValidation = false;
// any processes with setuid or setgid bit set or with __RESTRICT segment is restricted
if ( issetugid() || hasRestrictedSegment(mainExecutableMH) ) {
isRestricted = true;
}
bool usingSIP = (csr_check(CSR_ALLOW_TASK_FOR_PID) != 0);
uint32_t flags;
if ( csops(0, CS_OPS_STATUS, &flags, sizeof(flags)) != -1 ) {
// On OS X CS_RESTRICT means the program was signed with entitlements
if ( ((flags & CS_RESTRICT) == CS_RESTRICT) && usingSIP ) {
isRestricted = true;
}
// Library Validation loosens searching but requires everything to be code signed
if ( flags & CS_REQUIRE_LV ) {
isRestricted = false;
libraryValidation = true;
}
}
gLinkContext.allowAtPaths                = !isRestricted;
gLinkContext.allowEnvVarsPrint           = !isRestricted;
gLinkContext.allowEnvVarsPath            = !isRestricted;
gLinkContext.allowEnvVarsSharedCache     = !libraryValidation || !usingSIP;
gLinkContext.allowClassicFallbackPaths   = !isRestricted;
gLinkContext.allowInsertFailures         = false;
gLinkContext.allowInterposing         	 = true;
```

–©–æ –≤ –æ—Å–Ω–æ–≤–Ω–æ–º—É –æ–∑–Ω–∞—á–∞—î, —â–æ —è–∫—â–æ –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª –º–∞—î **suid** –∞–±–æ **sgid**, –∞–±–æ –º–∞—î —Å–µ–≥–º–µ–Ω—Ç **RESTRICT** —É –∑–∞–≥–æ–ª–æ–≤–∫–∞—Ö –∞–±–æ –±—É–≤ –ø—ñ–¥–ø–∏—Å–∞–Ω–∏–π –∑ –ø—Ä–∞–ø–æ—Ä—Ü–µ–º **CS\_RESTRICT**, —Ç–æ–¥—ñ **`!gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache`** —î —ñ—Å—Ç–∏–Ω–Ω–∏–º, —ñ –∑–º—ñ–Ω–Ω—ñ —Å–µ—Ä–µ–¥–æ–≤–∏—â–∞ –æ–±—Ä—ñ–∑–∞—é—Ç—å—Å—è.

–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ —è–∫—â–æ **CS\_REQUIRE\_LV** —î —ñ—Å—Ç–∏–Ω–Ω–∏–º, —Ç–æ–¥—ñ –∑–º—ñ–Ω–Ω—ñ –Ω–µ –±—É–¥—É—Ç—å –æ–±—Ä—ñ–∑–∞–Ω—ñ, –∞–ª–µ –ø–µ—Ä–µ–≤—ñ—Ä–∫–∞ –≤–∞–ª—ñ–¥–∞—Ü—ñ—ó –±—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç—å, —â–æ –≤–æ–Ω–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å —Ç–æ–π —Å–∞–º–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç, —â–æ –π –æ—Ä–∏–≥—ñ–Ω–∞–ª—å–Ω–∏–π –±—ñ–Ω–∞—Ä–Ω–∏–π —Ñ–∞–π–ª.

## –ü–µ—Ä–µ–≤—ñ—Ä–∫–∞ –æ–±–º–µ–∂–µ–Ω—å

### SUID —Ç–∞ SGID

```bash
# Make it owned by root and suid
sudo chown root hello
sudo chmod +s hello
# Insert the library
DYLD_INSERT_LIBRARIES=inject.dylib ./hello

# Remove suid
sudo chmod -s hello
```

### –†–æ–∑–¥—ñ–ª `__RESTRICT` –∑ —Å–µ–≥–º–µ–Ω—Ç–æ–º `__restrict`

```bash
gcc -sectcreate __RESTRICT __restrict /dev/null hello.c -o hello-restrict
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-restrict
```

### –ó–∞—Ö–∏—â–µ–Ω–∏–π —Ä–µ–∂–∏–º –≤–∏–∫–æ–Ω–∞–Ω–Ω—è

–°—Ç–≤–æ—Ä—ñ—Ç—å –Ω–æ–≤–∏–π —Å–µ—Ä—Ç–∏—Ñ—ñ–∫–∞—Ç —É Keychain —Ç–∞ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ –π–æ–≥–æ –¥–ª—è –ø—ñ–¥–ø–∏—Å—É –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É:

{% code overflow="wrap" %}
```bash
# Apply runtime proetction
codesign -s <cert-name> --option=runtime ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello #Library won't be injected

# Apply library validation
codesign -f -s <cert-name> --option=library ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed #Will throw an error because signature of binary and library aren't signed by same cert (signs must be from a valid Apple-signed developer certificate)

# Sign it
## If the signature is from an unverified developer the injection will still work
## If it's from a verified developer, it won't
codesign -f -s <cert-name> inject.dylib
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed

# Apply CS_RESTRICT protection
codesign -f -s <cert-name> --option=restrict hello-signed
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed # Won't work
```
{% endcode %}

{% hint style="danger" %}
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –Ω–∞–≤—ñ—Ç—å —è–∫—â–æ —î –±—ñ–Ω–∞—Ä–Ω—ñ —Ñ–∞–π–ª–∏, –ø—ñ–¥–ø–∏—Å–∞–Ω—ñ —Ñ–ª–∞–≥–∞–º–∏ **`0x0(none)`**, –≤–æ–Ω–∏ –º–æ–∂—É—Ç—å –¥–∏–Ω–∞–º—ñ—á–Ω–æ –æ—Ç—Ä–∏–º–∞—Ç–∏ –ø—Ä–∞–ø–æ—Ä **`CS_RESTRICT`** –ø—Ä–∏ –≤–∏–∫–æ–Ω–∞–Ω–Ω—ñ, —Ç–æ–º—É —Ü—è —Ç–µ—Ö–Ω—ñ–∫–∞ –≤ –Ω–∏—Ö –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏–º–µ.

–í–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–≤—ñ—Ä–∏—Ç–∏, —á–∏ –º–∞—î —Ü–µ–π –ø—Ä–∞–ø–æ—Ä –ø—Ä–æ—Ü–µ—Å –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é (–æ—Ç—Ä–∏–º–∞—Ç–∏ [**csops —Ç—É—Ç**](https://github.com/axelexic/CSOps)):

```bash
csops -status <pid>
```

—ñ –ø–æ—Ç—ñ–º –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —á–∏ —É–≤—ñ–º–∫–Ω–µ–Ω–æ –ø—Ä–∞–ø–æ—Ä–µ—Ü—å 0x800.
{% endhint %}

## References

* [https://theevilbit.github.io/posts/dyld\_insert\_libraries\_dylib\_injection\_in\_macos\_osx\_deep\_dive/](https://theevilbit.github.io/posts/dyld\_insert\_libraries\_dylib\_injection\_in\_macos\_osx\_deep\_dive/)

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –≤ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π –º–µ—Ä—á PEASS & HackTricks**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤.

</details>
