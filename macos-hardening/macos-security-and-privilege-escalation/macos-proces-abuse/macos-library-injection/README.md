# macOS рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЗрдВрдЬреЗрдХреНрд╢рди

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS рд░реЗрдб рдЯреАрдо рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>

{% hint style="danger" %}
**dyld рдХрд╛ рдХреЛрдб рдУрдкрди рд╕реЛрд░реНрд╕ рд╣реИ** рдФрд░ рдЗрд╕реЗ [https://opensource.apple.com/source/dyld/](https://opensource.apple.com/source/dyld/) рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдПрдХ **URL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ** рдПрдХ tar рдХреЗ рд░реВрдк рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ [https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz](https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz)
{% endhint %}

## **DYLD\_INSERT\_LIBRARIES**

> рдпрд╣ рдПрдХ рдХреЛрд▓реЛрди рд╕реЗ рдЕрд▓рдЧ **рдбрд╛рдпрдирд╛рдорд┐рдХ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА рд╕реВрдЪреА** рд╣реИ рдЬрд┐рд╕реЗ **рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рд╕реЗ рдкрд╣рд▓реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдпрд╣ рдЖрдкрдХреЛ рдлреНрд▓реИрдЯ-рдиреЗрдорд╕реНрдкреЗрд╕ рдЗрдореЗрдЬреЗрд╕ рдореЗрдВ рдкреНрд░рдпреБрдХреНрдд рдбрд╛рдпрдирд╛рдорд┐рдХ рд╢реЗрдпрд░реНрдб рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рдореМрдЬреВрджрд╛ рдореЙрдбреНрдпреВрд▓ рдХреЗ рдирдП рдореЙрдбреНрдпреВрд▓ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдХреЗрд╡рд▓ рдирдП рдореЙрдбреНрдпреВрд▓ рдХреЗ рд╕рд╛рде рдПрдХ рдЕрд╕реНрдерд╛рдпреА рдбрд╛рдпрдирд╛рдорд┐рдХ рд╢реЗрдпрд░реНрдб рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рд╣реЛрддрд╛ рд╣реИред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕рдХрд╛ рдХреЛрдИ рдкреНрд░рднрд╛рд╡ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ рдЙрди рдЗрдореЗрдЬреЗрд╕ рдкрд░ рдЬреЛ рджреЛ-рд╕реНрддрд░реАрдп рдиреЗрдорд╕реНрдкреЗрд╕ рдЗрдореЗрдЬреЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рдЬрдм рддрдХ рдХрд┐ DYLD\_FORCE\_FLAT\_NAMESPACE рдХрд╛ рднреА рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ред

рдпрд╣ [**LD\_PRELOAD on Linux**](../../../../linux-hardening/privilege-escalation#ld\_preload) рдХреА рддрд░рд╣ рд╣реИред

рдпрд╣ рддрдХрдиреАрдХ **ASEP рддрдХрдиреАрдХ рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рд╣рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдПрдХ plist рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕реЗ "Info.plist" рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ `LSEnvironmental` рдХрд╣реЗ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкрд░реНрдпрд╛рд╡рд░рдгреАрдп рдЪрд░ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ**ред

{% hint style="info" %}
2012 рдХреЗ рдмрд╛рдж рд╕реЗ **Apple рдиреЗ `DYLD_INSERT_LIBRARIES` рдХреА рд╢рдХреНрддрд┐ рдХреЛ рдХрд╛рдлреА рдХрдо рдХрд░ рджрд┐рдпрд╛ рд╣реИ**ред

рдХреЛрдб рдкрд░ рдЬрд╛рдПрдВ рдФрд░ **`src/dyld.cpp` рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ**ред **`pruneEnvironmentVariables`** рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **`DYLD_*`** рдЪрд░ рд╣рдЯрд╛ рджрд┐рдП рдЧрдП рд╣реИрдВред

**`processRestricted`** рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдз рдХрд╛ рдХрд╛рд░рдг рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЙрд╕ рдХреЛрдб рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХрд╛рд░рдг рд╣реИрдВ:

* рдмрд╛рдЗрдирд░реА `setuid/setgid` рд╣реИ
* рдореИрдХреЛ рдмрд╛рдЗрдирд░реА рдореЗрдВ `__RESTRICT/__restrict` рд╕реЗрдХреНрд╢рди рдХрд╛ рдЕрд╕реНрддрд┐рддреНрд╡ рд╣реИред
* рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдореЗрдВ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ (рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо) рд╣реИрдВ рдмрд┐рдирд╛ [`com.apple.security.cs.allow-dyld-environment-variables`](https://developer.apple.com/documentation/bundleresources/entitlements/com\_apple\_security\_cs\_allow-dyld-environment-variables) рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рдХреЗ
* рдмрд╛рдЗрдирд░реА рдХреЗ **рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ** `codesign -dv --entitlements :- </path/to/bin>`

рдЕрдзрд┐рдХ рдЕрдкрдбреЗрдЯреЗрдб рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЖрдк рдЗрд╕ рддрд░реНрдХ рдХреЛ рдлрд╝рдВрдХреНрд╢рди **`configureProcessRestrictions`** рдХреЗ рджреВрд╕рд░реЗ рднрд╛рдЧ рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдирдП рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЬреЛ рдХреБрдЫ рднреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рд╡рд╣ рдлрд╝рдВрдХреНрд╢рди рдХреА **рд╢реБрд░реБрдЖрддреА рдЬрд╛рдВрдЪ рд╣реИ** (рдЖрдк iOS рдпрд╛ рд╕рд┐рдореБрд▓реЗрд╢рди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд ifs рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ macOS рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред
{% endhint %}

### рдкреБрд╕реНрддрдХрд╛рд▓рдп рдорд╛рдиреНрдпрддрд╛

рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЕрдЧрд░ рдмрд╛рдЗрдирд░реА **`DYLD_INSERT_LIBRARIES`** env рдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИ, рдЕрдЧрд░ рдмрд╛рдЗрдирд░реА рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреА рд╣реИ рддреЛ рд╡рд╣ рдХрд╕реНрдЯрдо рдХреНрдпрд╛ рдирд╣реАрдВ рд▓реЛрдб рдХрд░реЗрдЧреАред

рдХрд╕реНрдЯрдо рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдмрд╛рдЗрдирд░реА рдХреЗ рдкрд╛рд╕ **рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдореЗрдВ рд╕реЗ рдПрдХ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**:

* &#x20;[`com.apple.security.cs.disable-library-validation`](../../macos-security-protections/macos-dangerous-entitlements.md#com.apple.security.cs.disable-library-validation)
* [`com.apple.private.security.clear-library-validation`](../../macos-security-protections/macos-dangerous-entitlements.md#com.apple.private.security.clear-library-validation)

рдпрд╛ рдмрд╛рдЗрдирд░реА рдХреЗ рдкрд╛рд╕ **рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо рдлреНрд▓реИрдЧ** рдпрд╛ **рдкреБрд╕реНрддрдХрд╛рд▓рдп рдорд╛рдиреНрдпрддрд╛ рдлреНрд▓реИрдЧ** рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЖрдк рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдПрдХ рдмрд╛рдЗрдирд░реА рдореЗрдВ **рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо** рд╣реИ `codesign --display --verbose <bin>` рдХреЗ рд╕рд╛рде **`CodeDirectory`** рдореЗрдВ рдлреНрд▓реИрдЧ рд░рдирдЯрд╛рдЗрдо рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ рдЬреИрд╕реЗ: **`CodeDirectory v=20500 size=767 flags=0x10000(runtime) hashes=13+7 location=embedded`**

рдЖрдк рдпрд╣ рднреА рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЕрдЧрд░ рдпрд╣ **рдмрд╛рдЗрдирд░реА рдХреЗ рд░реВрдк рдореЗрдВ рд╣реА рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реИ**ред

рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ рдФрд░ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЗрд╕рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдпрд╣рд╛рдВ рдкрд╛рдПрдВ:

{% content-ref url="../../macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](../../macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

## Dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

{% hint style="danger" %}
рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ **рдкрд┐рдЫрд▓реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рддрд┐рдмрдВрдз рднреА рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВ** Dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд╣рдорд▓реЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
{% endhint %}

Windows рдХреА рддрд░рд╣, MacOS рдореЗрдВ рднреА рдЖрдк **dylibs рдХреЛ рд╣рд╛рдЗрдЬреИрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди** **рдордирдорд╛рдиреЗ** **рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░реЗрдВред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, MacOS рдПрдкреНрд▓рд┐рдХреЗрд╢рди рджреНрд╡рд╛рд░рд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ **рд▓реЛрдб** рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ Windows рдХреА рддреБрд▓рдирд╛ рдореЗрдВ **рдЕрдзрд┐рдХ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд** рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ **рдореИрд▓рд╡реЗрдпрд░** рдбреЗрд╡рд▓рдкрд░реНрд╕ рдЕрднреА рднреА рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЪреБрдкрдХреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдмрд╣реБрдд рдХрдо рд╣реИред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рдпрд╣ **рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп** рд╣реИ рдХрд┐ MacOS рдмрд╛рдЗрдирд░реА рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рдкреВрд░реНрдг рдкрде рдХреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддреА рд╣реИред рдФрд░ рджреВрд╕рд░рд╛, **MacOS рдХрднреА рднреА $PATH рдХреЗ рдлреЛрд▓реНрдбрд░реЛрдВ рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреА рдЦреЛрдЬ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ**ред

**рдореБрдЦреНрдп** рднрд╛рдЧ **рдХреЛрдб** рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рд╣реИ **`ImageLoader::recursiveLoadLibraries`** `ImageLoader.cpp` рдореЗрдВред

рдореИрдХреЛ рдмрд╛рдЗрдирд░реА рджреНрд╡рд╛рд░рд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **4 рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╣реЗрдбрд░ рдХрдорд╛рдВрдбреНрд╕** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ:

* **`LC_LOAD_DYLIB`** рдХрдорд╛рдВрдб рдПрдХ рдбрд╛рдпрд▓рд┐рдм рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдХрдорд╛рдВрдб рд╣реИред
* **`LC_LOAD_WEAK_DYLIB`** рдХрдорд╛рдВрдб рдкрд┐рдЫрд▓реЗ рдПрдХ рдХреА рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдЧрд░ рдбрд╛рдпрд▓рд┐рдм рдирд╣реАрдВ рдорд┐рд▓рддреА рд╣реИ, рддреЛ рдирд┐рд╖реНрдкрд╛рджрди рдХрд┐рд╕реА рднреА рддреНрд░реБрдЯрд┐ рдХреЗ рдмрд┐рдирд╛ рдЬрд╛рд░реА рд░рд╣рддрд╛ рд╣реИред
* **
```c
// gcc dlopentest.c -o dlopentest -Wl,-rpath,/tmp/test
#include <dlfcn.h>
#include <stdio.h>

int main(void)
{
void* handle;

fprintf("--- No slash ---\n");
handle = dlopen("just_name_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative framework ---\n");
handle = dlopen("a/framework/rel_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs framework ---\n");
handle = dlopen("/a/abs/framework/abs_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative Path ---\n");
handle = dlopen("a/folder/rel_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs Path ---\n");
handle = dlopen("/a/abs/folder/abs_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

return 0;
}
```
рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдХреЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ **рдкреНрд░рддреНрдпреЗрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдЕрд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдХрд╣рд╛рдБ рдЦреЛрдЬрд╛ рдЧрдпрд╛ рдерд╛**ред рд╕рд╛рде рд╣реА, рдЖрдк **FS рд▓реЙрдЧреНрд╕ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
sudo fs_usage | grep "dlopentest"
```
## рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

рдпрджрд┐ рдХреЛрдИ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдмрд╛рдЗрдирд░реА/рдРрдк** (рдЬреИрд╕реЗ рдХрд┐ SUID рдпрд╛ рдХреБрдЫ рдмрд╛рдЗрдирд░реА рдЬрд┐рд╕рдореЗрдВ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рд╣реЛрддреЗ рд╣реИрдВ) рдПрдХ рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рд▓рд╛рдЗрдмреНрд░реЗрд░реА (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `@executable_path` рдпрд╛ `@loader_path` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ) рд▓реЛрдб рдХрд░ рд░рд╣рд╛ рд╣реИ рдФрд░ рдЗрд╕рдореЗрдВ **рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╡реИрд▓рд┐рдбреЗрд╢рди рдЕрдХреНрд╖рдо** рд╣реИ, рддреЛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдмрд╛рдЗрдирд░реА рдХреЛ рдЙрд╕ рд╕реНрдерд╛рди рдкрд░ рд▓реЗ рдЬрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╣рдорд▓рд╛рд╡рд░ рд╕рд╛рдкреЗрдХреНрд╖ рдкрде рд▓реЛрдбреЗрдб рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ**, рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

## `DYLD_*` рдФрд░ `LD_LIBRARY_PATH` env рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЛ рдкреНрд░реВрди рдХрд░реЗрдВ

рдлрд╛рдЗрд▓ `dyld-dyld-832.7.1/src/dyld2.cpp` рдореЗрдВ **`pruneEnvironmentVariables`** рдирд╛рдордХ рдлрдВрдХреНрд╢рди рдХреЛ рдвреВрдВрдврд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рдХрд┐рд╕реА рднреА env рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ рдЬреЛ **`DYLD_` рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ** рдФрд░ **`LD_LIBRARY_PATH=`**.

рдпрд╣ **suid** рдФрд░ **sgid** рдмрд╛рдЗрдирд░реАрдЬ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ env рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ **`DYLD_FALLBACK_FRAMEWORK_PATH`** рдФрд░ **`DYLD_FALLBACK_LIBRARY_PATH`** рдХреЛ рднреА **null** рдкрд░ рд╕реЗрдЯ рдХрд░ рджреЗрдЧрд╛ред

рдпрд╣ рдлрдВрдХреНрд╢рди рдЙрд╕реА рдлрд╛рдЗрд▓ рдХреЗ **`_main`** рдлрдВрдХреНрд╢рди рд╕реЗ рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдпрджрд┐ OSX рдХреЛ рдЗрд╕ рддрд░рд╣ рдЯрд╛рд░рдЧреЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реЛ:
```cpp
#if TARGET_OS_OSX
if ( !gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache ) {
pruneEnvironmentVariables(envp, &apple);
```
рдФрд░ рд╡реЗ рдмреВрд▓рд┐рдпрди рдлреНрд▓реИрдЧреНрд╕ рдЙрд╕реА рдлрд╛рдЗрд▓ рдореЗрдВ рдХреЛрдб рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ:
```cpp
#if TARGET_OS_OSX
// support chrooting from old kernel
bool isRestricted = false;
bool libraryValidation = false;
// any processes with setuid or setgid bit set or with __RESTRICT segment is restricted
if ( issetugid() || hasRestrictedSegment(mainExecutableMH) ) {
isRestricted = true;
}
bool usingSIP = (csr_check(CSR_ALLOW_TASK_FOR_PID) != 0);
uint32_t flags;
if ( csops(0, CS_OPS_STATUS, &flags, sizeof(flags)) != -1 ) {
// On OS X CS_RESTRICT means the program was signed with entitlements
if ( ((flags & CS_RESTRICT) == CS_RESTRICT) && usingSIP ) {
isRestricted = true;
}
// Library Validation loosens searching but requires everything to be code signed
if ( flags & CS_REQUIRE_LV ) {
isRestricted = false;
libraryValidation = true;
}
}
gLinkContext.allowAtPaths                = !isRestricted;
gLinkContext.allowEnvVarsPrint           = !isRestricted;
gLinkContext.allowEnvVarsPath            = !isRestricted;
gLinkContext.allowEnvVarsSharedCache     = !libraryValidation || !usingSIP;
gLinkContext.allowClassicFallbackPaths   = !isRestricted;
gLinkContext.allowInsertFailures         = false;
gLinkContext.allowInterposing         	 = true;
```
## рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ

### SUID & SGID
```bash
# Make it owned by root and suid
sudo chown root hello
sudo chmod +s hello
# Insert the library
DYLD_INSERT_LIBRARIES=inject.dylib ./hello

# Remove suid
sudo chmod -s hello
```
### рдЕрдиреБрднрд╛рдЧ `__RESTRICT` рд╕реЗрдЧрдореЗрдВрдЯ `__restrict` рдХреЗ рд╕рд╛рде
```bash
gcc -sectcreate __RESTRICT __restrict /dev/null hello.c -o hello-restrict
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-restrict
```
### рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо

рдХреАрдЪреЗрди рдореЗрдВ рдПрдХ рдирдпрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдПрдВ рдФрд░ рдЙрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрд╛рдЗрдирд░реА рдХреЛ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реЗрдВ:

{% code overflow="wrap" %}
```bash
# Apply runtime proetction
codesign -s <cert-name> --option=runtime ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello #Library won't be injected

# Apply library validation
codesign -f -s <cert-name> --option=library ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed #Will throw an error because signature of binary and library aren't signed by same cert (signs must be from a valid Apple-signed developer certificate)

# Sign it
## If the signature is from an unverified developer the injection will still work
## If it's from a verified developer, it won't
codesign -f -s <cert-name> inject.dylib
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed

# Apply CS_RESTRICT protection
codesign -f -s <cert-name> --option=restrict hello-signed
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed # Won't work
```
{% endcode %}

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдХреЛрдИ рдмрд╛рдЗрдирд░реА **`0x0(none)`** рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рд╕рд╛рдЗрди рдХреА рдЧрдИ рд╣реИ, рддреЛ рднреА рдЙрдиреНрд╣реЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдиреЗ рдкрд░ рдбрд╛рдпрдирд╛рдорд┐рдХ рд░реВрдк рд╕реЗ **`CS_RESTRICT`** рдлреНрд▓реИрдЧ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рд▓рд┐рдП рдпрд╣ рддрдХрдиреАрдХ рдЙрди рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреАред

рдЖрдк рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХрд┐рд╕реА рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рдпрд╣ рдлреНрд▓реИрдЧ рд╣реИ рдпрд╛ рдирд╣реАрдВ (get [**csops here**](https://github.com/axelexic/CSOps)):&#x20;
```bash
csops -status <pid>
```
рдФрд░ рдлрд┐рд░ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ 0x800 рдлреНрд▓реИрдЧ рд╕рдХреНрд╖рдо рд╣реИред
{% endhint %}

<details>

<summary><strong>рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**ред
* **HackTricks** рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
