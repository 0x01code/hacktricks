# macOS рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЗрдВрдЬреЗрдХреНрд╢рди

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFT рд╕рдВрдЧреНрд░рд╣**](https://opensea.io/collection/the-peass-family)
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВ**.
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**hacktricks рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud рд░реЗрдкреЛ**](https://github.com/carlospolop/hacktricks-cloud) **рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗ рдЕрдкрдирд╛ рдпреЛрдЧрджрд╛рди рджреЗрдВред**

</details>

{% hint style="danger" %}
**dyld рдХрд╛ рдХреЛрдб рдУрдкрди рд╕реЛрд░реНрд╕ рд╣реИ** рдФрд░ рдЗрд╕реЗ [https://opensource.apple.com/source/dyld/](https://opensource.apple.com/source/dyld/) рдкрд░ рдвреВрдВрдврд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ **URL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЯрд╛рд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** рдЬреИрд╕реЗ рдХрд┐ [https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz](https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz)
{% endhint %}

## **DYLD\_INSERT\_LIBRARIES**

> рдпрд╣ рдПрдХ рдХреЛрд▓рди рд╕реЗ рдЕрд▓рдЧ **рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреА рд╕реВрдЪреА рд╣реИ** рдЬреЛ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреА рдЧрдИ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕реЗ рдкрд╣рд▓реЗ рд▓реЛрдб рд╣реЛрддреА рд╣реИред рдЗрд╕рд╕реЗ рдЖрдк рдкрд╣рд▓реЗ рд╕реЗ рдореМрдЬреВрджрд╛ рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рд╛рдЭрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдирдП рдореЙрдбреНрдпреВрд▓реЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдлреНрд▓реИрдЯ-рдиреЗрдорд╕реНрдкреЗрд╕ рдЗрдореЗрдЬреЗрдЬрд╝ рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрддреЗ рд╣реИрдВ, рдХреЗрд╡рд▓ рдирдП рдореЙрдбреНрдпреВрд▓реЛрдВ рд╡рд╛рд▓реА рдПрдХ рдЕрд╕реНрдерд╛рдпреА рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рд╛рдЭрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдХрд░рдХреЗред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрд╣ рдХрд┐рд╕реА рднреА рдкреНрд░рднрд╛рд╡ рдХрд╛ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдПрдХ рдбрд╛рдпрдирд╛рдорд┐рдХ рд╕рд╛рдЭрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреЛ-рд╕реНрддрд░реАрдп рдиреЗрдорд╕реНрдкреЗрд╕ рдЗрдореЗрдЬреЗрдЬрд╝ рдХреЛ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрдм рддрдХ DYLD\_FORCE\_FLAT\_NAMESPACE рднреА рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣ [**LD\_PRELOAD on Linux**](../../../../linux-hardening/privilege-escalation#ld\_preload) рдХреА рддрд░рд╣ рд╣реИред

рдпрд╣ рддрдХрдиреАрдХ рдПрдХ ASEP рддрдХрдиреАрдХ рдХреЗ рд░реВрдк рдореЗрдВ рднреА **рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рд╕реНрдерд╛рдкрд┐рдд рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рдкрд╛рд╕ "Info.plist" рдирд╛рдордХ рдПрдХ plist рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдореЗрдВ `LSEnvironmental` рдирд╛рдордХ рдПрдХ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкрд░реНрдпрд╛рд╡рд░рдгреАрдп рдЪрд░реЛрдВ рдХрд╛ рдирд┐рд░реНрдзрд╛рд░рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="info" %}
2012 рд╕реЗ рд╢реБрд░реВ рд╣реЛрдХрд░ **Apple рдиреЗ DYLD\_INSERT\_LIBRARIES рдХреА рд╢рдХреНрддрд┐ рдХреЛ рдмрд╣реБрдд рдХрдо рдХрд░ рджрд┐рдпрд╛ рд╣реИ**ред

рдХреЛрдб рдкрд░ рдЬрд╛рдПрдВ рдФрд░ **`src/dyld.cpp`** рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред рдлрд╝рдВрдХреНрд╢рди **`pruneEnvironmentVariables`** рдореЗрдВ рдЬрд╛рдХрд░ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **`DYLD_*`** рдЪрд░реЛрдВ рдХреЛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдлрд╝рдВрдХреНрд╢рди **`processRestricted`** рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдз рдХрд╛ рдХрд╛рд░рдг рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЙрд╕ рдХреЛрдб рдХреА рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╕рдордп рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХрд╛рд░рдг рд╣реИрдВ:

* рдмрд╛рдЗрдирд░реА `setuid/setgid` рд╣реИ
* рдореИрдЪреЛ рдмрд╛рдЗрдирд░реА рдореЗрдВ `__RESTRICT/__restrict` рд╕реЗрдХреНрд╢рди рдХреА рдореМрдЬреВрджрдЧреАред
* рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдореЗрдВ entitlements (рд╣рд╛рд░реНрдбрдиреЗрдб рд░рдирдЯрд╛рдЗрдо) рд╣реИрдВ рдЬрд┐рдирдореЗрдВ [`com.apple.security.cs.allow-dyld-environment-variables`](https://developer.apple.com/documentation/bundleresources/entitlements/com\_apple\_security\_cs\_allow-dyld-environment-variables) entitlement рд╣реИ
* рдПрдХ рдмрд╛рдЗрдирд░реА рдХреА entitlements рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ: `codesign -dv --entitlements :- </path/to/bin>`

рдЕрджреНрдпрддрд┐рдд рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЖрдк рдЗрд╕ рддрд░реНрдХ рдХреЛ рдлрд╝рдВрдХреНрд╢рди **`configureProcessRestrictions`** рдХреЗ рджреВрд╕рд░реЗ рд╣рд┐рд╕реНрд╕реЗ рдореЗрдВ рднреА рдвреВрдВрдв рд╕рдХрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдирдП рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рд╡рд╣ рдХреНрдпрд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддрд╛ рд╣реИ, рд╡рд╣ рддреЛ рдлрд╝рдВрдХреНрд╢рди рдХреЗ **рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЬрд╛рдВрдЪреЛрдВ рдХреЛ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** (рдЖрдк iOS рдпрд╛ рд╕рд┐рдореНрдпреБрд▓реЗрд╢рди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд ifs рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ macOS рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рд╣реЛрдВрдЧ
## Dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдкрд┐рдЫрд▓реЗ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рддрд┐рдмрдВрдз рднреА рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ** рддрд╛рдХрд┐ Dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд╣рдорд▓реЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред
{% endhint %}

рд╡рд┐рдВрдбреЛрдЬ рдХреА рддрд░рд╣, MacOS рдореЗрдВ рдЖрдк рднреА **рдбрд╛рдпрд▓рд┐рдмреНрд╕ рдХреЛ рд╣рд╛рдЗрдЬреИрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди** **рд╡рд┐рдЪрд╛рд░рд╢реАрд▓** **рдХреЛрдб** **рдЪрд▓рд╛ рд╕рдХреЗрдВ**ред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, MacOS рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреЛрдВ рдХреЛ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╡рд┐рдВрдбреЛрдЬ рдХреА рддреБрд▓рдирд╛ рдореЗрдВ **рдЕрдзрд┐рдХ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд** рд╣реИред рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **рдореИрд▓рд╡реЗрдпрд░** рд╡рд┐рдХрд╛рд╕рдХ рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЕрднреА рднреА **рдЫрд┐рдкрд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ рдЙрдиреНрдирддрд┐ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХрдо рд╣реЛрддреА рд╣реИред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, **рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп рд╣реИ** рдХрд┐ **MacOS рдмрд╛рдЗрдирд░реАрдЬрд╝ рдкреВрд░рд╛ рдкрде рджрд┐рдЦрд╛рддреА рд╣реИрдВ** рдЬрд┐рд╕рдореЗрдВ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдХреА рдЬрдЧрд╣ рджрд┐рдЦрд╛рдИ рдЬрд╛рддреА рд╣реИред рдФрд░ рджреВрд╕рд░рд╛, **MacOS рдХрднреА рднреА** **$PATH** рдХреЗ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдЦреЛрдЬрддрд╛ рдирд╣реАрдВ рд╣реИред

рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖реЗрддреНрд░ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд **рдХреЛрдб** рдХрд╛ **рдореБрдЦреНрдп** рд╣рд┐рд╕реНрд╕рд╛ `ImageLoader.cpp` рдореЗрдВ `ImageLoader::recursiveLoadLibraries` рдореЗрдВ рд╣реИред

рдореИрдЪреЛ рдмрд╛рдЗрдирд░реА рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **4 рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╣реЗрдбрд░ рдХрдорд╛рдВрдб** рд╣реИрдВ:

* **`LC_LOAD_DYLIB`** рдХрдорд╛рдВрдб рдПрдХ dylib рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдХрдорд╛рдВрдб рд╣реИред
* **`LC_LOAD_WEAK_DYLIB`** рдХрдорд╛рдВрдб рдкрд┐рдЫрд▓реЗ рдХрдорд╛рдВрдб рдХреА рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрджрд┐ dylib рдирд╣реАрдВ рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдмрд┐рдирд╛ рдХрд┐рд╕реА рддреНрд░реБрдЯрд┐ рдХреЗ рдЪрд▓рд╛рдирд╛ рдЬрд╛рд░реА рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **`LC_REEXPORT_DYLIB`** рдХрдорд╛рдВрдб рдпрд╣ рдкреНрд░реЙрдХреНрд╕реА рдХрд░рддрд╛ рд╣реИ (рдпрд╛ рдкреБрдирдГ рдирд┐рд░реНрдпрд╛рдд рдХрд░рддрд╛ рд╣реИ) рдПрдХ рдЕрд▓рдЧ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╕реЗ рдкреНрд░рддреАрдХред
* **`LC_LOAD_UPWARD_DYLIB`** рдХрдорд╛рдВрдб рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рджреЛ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдПрдХ-рджреВрд╕рд░реЗ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреА рд╣реИрдВ (рдЗрд╕реЗ _рдКрдкрд░реА рдирд┐рд░реНрднрд░рддрд╛_ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ)ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рджреЛ рддрд░рд╣ рдХреА dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд╣реЛрддреА рд╣реИ:

* **рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдХреА рдХрдореА**: рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдПрдХ рдРрд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛ рдЬреЛ рдХрд┐ **LC\_LOAD\_WEAK\_DYLIB** рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рд╣реИред рдлрд┐рд░, **рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ рдЙрд╕ рдЬрдЧрд╣ рдкрд░ рдПрдХ dylib рд░рдЦрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд▓реЛрдб рд╣реЛрдиреЗ рдХреА рдЙрдореНрдореАрдж рд╣реИ** рддреЛ рд╡рд╣ рд▓реЛрдб рд╣реЛ рдЬрд╛рдПрдЧреАред
* рдпрд╣ рддрдереНрдп рдХрд┐ рд▓рд┐рдВрдХ "рдХрдордЬреЛрд░" рд╣реИ рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЪрд▓рддреА рд░рд╣реЗрдЧреА рднрд▓реЗ рд╣реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдирд╣реАрдВ рдорд┐рд▓рддреА рд╣реЛред
* рдЗрд╕рдХреЗ рд╕рдВрдмрдВрдзрд┐рдд **рдХреЛрдб** рдореЗрдВ `ImageLoaderMachO.cpp` рдХреЗ `ImageLoaderMachO::doGetDependentLibraries` рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рд╣реИ рдЬрд╣рд╛рдВ `lib->required` рдХреЗрд╡рд▓ рддрдм `false` рд╣реЛрддрд╛ рд╣реИ рдЬрдм `LC_LOAD_WEAK_DYLIB` рд╕рдЪ рд╣реЛрддрд╛ рд╣реИред
* **рдмрд╛рдЗрдирд░реАрдЬрд╝ рдореЗрдВ рдХрдордЬреЛрд░ рд▓рд┐рдВрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдвреВрдВрдвреЗрдВ** (рдЖрдкрдХреЗ рдкрд╛рд╕ рдмрд╛рдж рдореЗрдВ рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдмрдирд╛рдиреЗ рдХрд╛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ):
* ```bash
otool -l </path/to/bin> | grep LC_LOAD_WEAK_DYLIB -A 5 cmd LC_LOAD_WEAK_DYLIB
cmdsize 56
name /var/tmp/lib/libUtl.1.dylib (offset 24)
time stamp 2 Wed Jun 21 12:23:31 1969
current version 1.0.0
compatibility version 1.0.0
```
* **@rpath рдХреЗ рд╕рд╛рде рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛**: Mach-O рдмрд╛рдЗрдирд░реАрдЬрд╝ рдореЗрдВ рдХрдорд╛рдВрдб **`LC_RPATH`** рдФрд░ **`LC_LOAD_DYLIB`** рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВред рдЗрди рдХрдорд╛рдВрдбреЛрдВ рдХреЗ **рдорд╛рдиреЛрдВ** рдХреЗ рдЖрдзрд╛рд░ рдкрд░, рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ **рдЕрд▓рдЧ-рдЕрд▓рдЧ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ** рд╕реЗ **рд▓реЛрдб** рд╣реЛрдВрдЧреАред
* **`LC_RPATH`** рдмрд╛рдЗрдирд░реА рджреНрд╡рд╛рд░рд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреБрдЫ рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдХреЗ рдкрде рдХреЛ рд╕рдореЗрдЯрддрд╛ рд╣реИред
* **`LC_LOAD_DYLIB`** рд╡рд┐рд╢реЗрд╖ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХ
* рдЬрдм рдкрде **рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрде рдХреА рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ** (рдЙрджрд╛ред `/stuff/foo.framework/foo`), рдЕрдЧрд░ **`$DYLD_FRAMEWORK_PATH`** рд▓реЙрдиреНрдЪ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld рдкрд╣рд▓реЗ рдЙрд╕ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдлреНрд░реЗрдорд╡рд░реНрдХ рдЖрдВрд╢рд┐рдХ рдкрде (рдЙрджрд╛ред `foo.framework/foo`) рдХреЗ рд▓рд┐рдП рдЦреЛрдЬреЗрдЧрд╛ред рдЕрдЧрд▓реЗ, dyld рд╕рдкреНрд▓рд╛рдЗрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде рдХреЛ рдЕрд╕реАрдорд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░реЗрдЧрд╛ (рд╕рдВрдмрдВрдзрд┐рдд рдкрдереЛрдВ рдХреЗ рд▓рд┐рдП рдореМрдЬреВрджрд╛ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП)ред рдЕрдВрдд рдореЗрдВ, рдкреБрд░рд╛рдиреЗ рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП, dyld рдХреБрдЫ рдлреЙрд▓рдмреИрдХ рдХреЛрд╢рд┐рд╢реЗрдВ рдХрд░реЗрдЧрд╛ред рдЕрдЧрд░ рд▓реЙрдиреНрдЪ рдкрд░ **`$DYLD_FALLBACK_FRAMEWORK_PATH`** рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld рдЙрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛ред рдЕрдиреНрдпрдерд╛, рдпрд╣ **`/Library/Frameworks`** (macOS рдкрд░ рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ) рдФрд░ рдлрд┐рд░ **`/System/Library/Frameworks`** рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛ред
1. `$DYLD_FRAMEWORK_PATH`
2. рд╕рдкреНрд▓рд╛рдЗрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде (рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ рддреЛ рдореМрдЬреВрджрд╛ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП)
3. `$DYLD_FALLBACK_FRAMEWORK_PATH`
4. `/Library/Frameworks` (рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ)
5. `/System/Library/Frameworks`

{% hint style="danger" %}
рдЕрдЧрд░ рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрде рд╣реИ, рддреЛ рдЗрд╕реЗ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛:

* рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдЕрд╕реАрдорд┐рдд рд╣реИ**, рддреЛ рдореМрдЬреВрджрд╛ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реЗ **CWD рдХреЗ рдЕрдиреБрдкрд╛рд▓рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░реЗрдВ (рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдпрджрд┐ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдореЗрдВ рдпрд╣ рдХрд╣рд╛ рдирд╣реАрдВ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реИ рддреЛ DYLD\_\* env vars рд╣рдЯрд╛ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ)
{% endhint %}

* рдЬрдм рдкрде рдореЗрдВ **рдПрдХ рд╕реНрд▓реИрд╢ рд╣реЛрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрде рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ** (рдЕрд░реНрдерд╛рдд рдкреВрд░рд╛ рдкрде рдпрд╛ dylib рдХреЗ рд▓рд┐рдП рдЖрдВрд╢рд┐рдХ рдкрде), dlopen() рдкрд╣рд▓реЗ (рдпрджрд┐ рд╕реЗрдЯ рд╣реИ) **`$DYLD_LIBRARY_PATH`** рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛ (рдкрде рдХреЗ рдкрддреЗ рдХреЗ рд▓рд┐рдП рдкрддреНрддрд╛ рднрд╛рдЧ рдХреЗ рд╕рд╛рде)ред рдЕрдЧрд▓реЗ, dyld **рд╕рдкреНрд▓рд╛рдЗрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛** (рдХреЗрд╡рд▓ рдЕрд╕реАрдорд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдореМрдЬреВрджрд╛ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП)ред рдЕрдВрдд рдореЗрдВ, рдкреБрд░рд╛рдиреЗ рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП, dyld рдХреБрдЫ рдлреЙрд▓рдмреИрдХ рдХреЛрд╢рд┐рд╢реЗрдВ рдХрд░реЗрдЧрд╛ред рдЕрдЧрд░ рд▓реЙрдиреНрдЪ рдкрд░ **`$DYLD_FALLBACK_LIBRARY_PATH`** рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld рдЙрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛, рдЕрдиреНрдпрдерд╛, dyld **`/usr/local/lib/`** (рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ) рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛, рдФрд░ рдлрд┐рд░ **`/usr/lib/`** рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛ред
1. `$DYLD_LIBRARY_PATH`
2. рд╕рдкреНрд▓рд╛рдЗрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде (рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ рддреЛ рдореМрдЬреВрджрд╛ рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП)
3. `$DYLD_FALLBACK_LIBRARY_PATH`
4. `/usr/local/lib/` (рдЕрдЧрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ)
5. `/usr/lib/`

{% hint style="danger" %}
рдЕрдЧрд░ рдирд╛рдо рдореЗрдВ рд╕реНрд▓реИрд╢ рд╣реИ рдФрд░ рдлреНрд░реЗрдорд╡рд░реНрдХ рдирд╣реАрдВ рд╣реИ, рддреЛ рдЗрд╕реЗ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛:

* рдЕрдЧрд░ рдмрд╛рдЗрдирд░реА **рдЕрд╕реАрдорд┐рдд рд╣реИ** рдФрд░ рдлрд┐рд░ CWD рдпрд╛ `/usr/local/lib` рд╕реЗ рдХреБрдЫ рд▓реЛрдб рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ (рдпрд╛ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд env variables рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛)
{% endhint %}

{% hint style="info" %}
рдиреЛрдЯ: **dlopen рдЦреЛрдЬрдиреЗ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ** рдХреЛрдИ рднреА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рдирд╣реАрдВ рд╣реИрдВред

рдиреЛрдЯ: рдЕрдЧрд░ рдореБрдЦреНрдп executable рдПрдХ **set\[ug]id рдмрд╛рдЗрдирд░реА рд╣реИ рдпрд╛ entitlements рдХреЗ рд╕рд╛рде codesigned** рд╣реИ, рддреЛ **рд╕рднреА environment variables рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдФрд░ рдХреЗрд╡рд▓ рдкреВрд░рд╛ рдкрде рд╣реА рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддреГрдд рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [DYLD\_INSERT\_LIBRARIES restrictions рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ](../../macos-dyld-hijacking-and-dyld\_insert\_libraries.md#check-dyld\_insert\_librery-restrictions))

рдиреЛрдЯ: Apple platforms рдореЗрдВ 32-рдмрд┐рдЯ рдФрд░ 64-рдмрд┐рдЯ рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬрд╝ рдХреЛ рдПрдХрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП "universal" рдлрд╝рд╛рдЗрд▓реЗрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ **рдЕрд▓рдЧ 32-рдмрд┐рдЯ рдФрд░ 64-рдмрд┐рдЯ рдЦреЛрдЬрдиреЗ рдХреЗ рдкрде рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВ**ред

рдиреЛрдЯ: Apple platforms рдкрд░ рдЕрдзрд┐рдХрд╛рдВрд╢ OS dylibs рдХреЛ dyld рдХреИрд╢ рдореЗрдВ **рдПрдХреАрдХреГрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рдФрд░ рдбрд┐рд╕реНрдХ рдкрд░ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реЛрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП, рдХрд┐рд╕реА OS dylib рдХреА рдореМрдЬреВрджрдЧреА рдХреА рдкреВрд░реНрд╡-рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП **`stat()`** рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ **рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, **`dlopen_preflight()`** рдПрдХ рд╕рдВрдЧрдд mach-o рдлрд╝рд╛рдЗрд▓ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП **`dlopen()`** рдХреЗ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред
{% endhint %}

**рдкрдереЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ**

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреЗ рд╕рд╛рде рд╕рднреА рд╡рд┐рдХрд▓реНрдкреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:
```c
// gcc dlopentest.c -o dlopentest -Wl,-rpath,/tmp/test
#include <dlfcn.h>
#include <stdio.h>

int main(void)
{
void* handle;

fprintf("--- No slash ---\n");
handle = dlopen("just_name_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative framework ---\n");
handle = dlopen("a/framework/rel_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs framework ---\n");
handle = dlopen("/a/abs/framework/abs_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative Path ---\n");
handle = dlopen("a/folder/rel_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs Path ---\n");
handle = dlopen("/a/abs/folder/abs_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

return 0;
}
```
рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ **рд╣рд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреА рд╡рд╣рд╛рдБ рдЕрд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЦреЛрдЬреА рдЧрдИ рдереА**ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдк **рдПрдлрдПрд╕ рд▓реЙрдЧ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
sudo fs_usage | grep "dlopentest"
```
## рдбрд╛рдпрд▓реНрдб `DYLD_*` рдФрд░ `LD_LIBRARY_PATH` рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рдХрд╛рдЯреЗрдВ

рдлрд╝рд╛рдЗрд▓ `dyld-dyld-832.7.1/src/dyld2.cpp` рдореЗрдВ рд╣рдореЗрдВ рдлрд╝рдВрдХреНрд╢рди **`pruneEnvironmentVariables`** рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рдХрд┐рд╕реА рднреА рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ рдЬреЛ **`DYLD_`** рдФрд░ **`LD_LIBRARY_PATH=`** рд╕реЗ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИред

рдпрд╣ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **suid** рдФрд░ **sgid** рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ **`DYLD_FALLBACK_FRAMEWORK_PATH`** рдФрд░ **`DYLD_FALLBACK_LIBRARY_PATH`** рдХреЛ **null** рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдЧрд╛ред

рдпрджрд┐ OSX рдХреЛ рд▓рдХреНрд╖реНрдп рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдЙрд╕реА рдлрд╝рд╛рдЗрд▓ рдХреЗ **`_main`** рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```cpp
#if TARGET_OS_OSX
if ( !gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache ) {
pruneEnvironmentVariables(envp, &apple);
```
рдФрд░ рд╡реЗ рдмреВрд▓рд┐рдпрди рдлреНрд▓реИрдЧреНрд╕ рдХреЛрдб рдореЗрдВ рд╣реА рдЙрд╕реА рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ:
```cpp
#if TARGET_OS_OSX
// support chrooting from old kernel
bool isRestricted = false;
bool libraryValidation = false;
// any processes with setuid or setgid bit set or with __RESTRICT segment is restricted
if ( issetugid() || hasRestrictedSegment(mainExecutableMH) ) {
isRestricted = true;
}
bool usingSIP = (csr_check(CSR_ALLOW_TASK_FOR_PID) != 0);
uint32_t flags;
if ( csops(0, CS_OPS_STATUS, &flags, sizeof(flags)) != -1 ) {
// On OS X CS_RESTRICT means the program was signed with entitlements
if ( ((flags & CS_RESTRICT) == CS_RESTRICT) && usingSIP ) {
isRestricted = true;
}
// Library Validation loosens searching but requires everything to be code signed
if ( flags & CS_REQUIRE_LV ) {
isRestricted = false;
libraryValidation = true;
}
}
gLinkContext.allowAtPaths                = !isRestricted;
gLinkContext.allowEnvVarsPrint           = !isRestricted;
gLinkContext.allowEnvVarsPath            = !isRestricted;
gLinkContext.allowEnvVarsSharedCache     = !libraryValidation || !usingSIP;
gLinkContext.allowClassicFallbackPaths   = !isRestricted;
gLinkContext.allowInsertFailures         = false;
gLinkContext.allowInterposing         	 = true;
```
рдЬреЛ рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдмрд╛рдЗрдирд░реА **suid** рдпрд╛ **sgid** рд╣реИ, рдпрд╛ рд╣реЗрдбрд░ рдореЗрдВ **RESTRICT** рд╕реЗрдЧрдореЗрдВрдЯ рд╣реИ рдпрд╛ рдпрд╣ **CS\_RESTRICT** рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ **`!gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache`** рд╕рддреНрдп рд╣реЛрддрд╛ рд╣реИ рдФрд░ env variables рдХреЛ рдХрд╛рдЯ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ CS\_REQUIRE\_LV рд╕рддреНрдп рд╣реИ, рддреЛ рдЪрд░ env variables рдХреЛ рдХрд╛рдЯрд╛ рдирд╣реАрдВ рдЬрд╛рдПрдЧрд╛ рд▓реЗрдХрд┐рди рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдпрд╣ рдЬрд╛рдВрдЪреЗрдЧрд╛ рдХрд┐ рд╡реЗ рдореВрд▓ рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рд╛рде рд╕рдорд╛рди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВред

## рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ

### SUID рдФрд░ SGID
```bash
# Make it owned by root and suid
sudo chown root hello
sudo chmod +s hello
# Insert the library
DYLD_INSERT_LIBRARIES=inject.dylib ./hello

# Remove suid
sudo chmod -s hello
```
### рдзрд╛рд░рд╛ `__RESTRICT` рдФрд░ рд╕реЗрдЧрдореЗрдВрдЯ `__restrict`
```bash
gcc -sectcreate __RESTRICT __restrict /dev/null hello.c -o hello-restrict
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-restrict
```
### рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо

рдХреАрдЪреЗрди рдореЗрдВ рдПрдХ рдирдпрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдПрдВ рдФрд░ рдЗрд╕реЗ рдмрд╛рдЗрдирд░реА рдХреЛ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:

{% code overflow="wrap" %}
```bash
# Apply runtime proetction
codesign -s <cert-name> --option=runtime ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello #Library won't be injected

# Apply library validation
codesign -f -s <cert-name> --option=library ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed #Will throw an error because signature of binary and library aren't signed by same cert (signs must be from a valid Apple-signed developer certificate)

# Sign it
## If the signature is from an unverified developer the injection will still work
## If it's from a verified developer, it won't
codesign -f -s <cert-name> inject.dylib
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed

# Apply CS_RESTRICT protection
codesign -f -s <cert-name> --option=restrict hello-signed
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed # Won't work
```
{% endcode %}

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдХрд┐рд╕реА рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рд╛рде рдЭрдВрдбреЗ **`0x0(none)`** рдХреЗ рд╕рд╛рде рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╣реИрдВ, рддреЛ рдЬрдм рдЙрдиреНрд╣реЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡реЗ рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗ **`CS_RESTRICT`** рдЭрдВрдбрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рд▓рд┐рдП рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЙрдирдореЗрдВ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЖрдк рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдХрд┐рд╕реА рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рдЗрд╕ рдЭрдВрдбреЗ рд╣реИ рдпрд╛ рдирд╣реАрдВ (рдпрд╣рд╛рдВ [**csops**](https://github.com/axelexic/CSOps) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ):&#x20;
```bash
csops -status <pid>
```
рдФрд░ рдлрд┐рд░ рдпрд╣ рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдлреНрд▓реИрдЧ 0x800 рд╕рдХреНрд╖рдо рд╣реИред
{% endhint %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛** рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХрд▓ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ рд╣рдореЗрдВ PR рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред**

</details>
