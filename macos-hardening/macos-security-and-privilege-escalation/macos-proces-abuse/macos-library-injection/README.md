# macOS рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЗрдВрдЬреЗрдХреНрд╢рди

<details>

<summary><strong>рдЬреАрд░реЛ рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди **HackTricks** рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ "The PEASS Family" рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PR рдЬрдорд╛ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github рд░реЗрдкреЛ рдореЗрдВред

</details>

{% hint style="danger" %}
**dyld рдХрд╛ рдХреЛрдб рдУрдкрди рд╕реЛрд░реНрд╕** рд╣реИ рдФрд░ рдЗрд╕реЗ [https://opensource.apple.com/source/dyld/](https://opensource.apple.com/source/dyld/) рдкрд░ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдПрдХ **URL рдЬреИрд╕реЗ** [https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz](https://opensource.apple.com/tarballs/dyld/dyld-852.2.tar.gz) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЯрд╛рд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
{% endhint %}

## **Dyld рдкреНрд░рдХреНрд░рд┐рдпрд╛**

рджреЗрдЦреЗрдВ рдХрд┐ Dyld рдХреИрд╕реЗ рдмрд╛рдЗрдирд░реА рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ:

{% content-ref url="macos-dyld-process.md" %}
[macos-dyld-process.md](macos-dyld-process.md)
{% endcontent-ref %}

## **DYLD\_INSERT\_LIBRARIES**

рдпрд╣ [**LD\_PRELOAD on Linux**](../../../../linux-hardening/privilege-escalation/#ld\_preload) рдХреА рддрд░рд╣ рд╣реИред рдЗрд╕рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕реВрдЪрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдП рдХрд┐ рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рдПрдХ рдорд╛рд░реНрдЧ рд╕реЗ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ (рдпрджрд┐ env рдЪрд░ рд╕рдХреНрд╖рдо рд╣реИ)

рдпрд╣ рддрдХрдиреАрдХ рдПрдХ ASEP рддрдХрдиреАрдХ рдХреЗ рд░реВрдк рдореЗрдВ рднреА **рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** рдХреНрдпреЛрдВрдХрд┐ рд╣рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЙрд╕рдХреЗ рдкрд╛рд╕ "Info.plist" рдирд╛рдордХ рдПрдХ plist рд╣реЛрддрд╛ рд╣реИ рдЬреЛ `LSEnvironmental` рдирд╛рдордХ рдПрдХ рдХреБрдВрдЬреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдкрд░реНрдпрд╛рд╡рд░рдгреАрдп рдЪрд░реЛрдВ рдХрд╛ рдирд┐рд░реБрдкрдг** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

{% hint style="info" %}
2012 рд╕реЗ **Apple рдиреЗ DYLD_INSERT_LIBRARIES** рдХреА **рд╢рдХреНрддрд┐ рдХреЛ рдмрд╣реБрдд рдХрдо рдХрд░ рджрд┐рдпрд╛ рд╣реИ**ред

рдХреЛрдб рдкрд░ рдЬрд╛рдПрдВ рдФрд░ **`src/dyld.cpp`** рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред рдлрд╝рдВрдХреНрд╢рди **`pruneEnvironmentVariables`** рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **`DYLD_*`** рдЪрд░ рд╣рдЯрд╛рдП рдЧрдП рд╣реИрдВред

рдлрд╝рдВрдХреНрд╢рди **`processRestricted`** рдореЗрдВ рдкреНрд░рддрд┐рдмрдВрдз рдХрд╛ рдХрд╛рд░рдг рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЙрд╕ рдХреЛрдб рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХрд╛рд░рдг рд╣реИрдВ:

* рдмрд╛рдЗрдирд░реА `setuid/setgid` рд╣реИ
* рдореИрдЪреЛ рдмрд╛рдЗрдирд░реА рдореЗрдВ `__RESTRICT/__restrict` рдЦрдВрдб рдХрд╛ рдореМрдЬреВрдж рд╣реЛрдирд╛ред
* рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдореЗрдВ entitlements рд╣реИрдВ (рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо) рдмрд┐рдирд╛ [`com.apple.security.cs.allow-dyld-environment-variables`](https://developer.apple.com/documentation/bundleresources/entitlements/com\_apple\_security\_cs\_allow-dyld-environment-variables) entitlement
* рдПрдХ рдмрд╛рдЗрдирд░реА рдХреА **entitlements** рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ: `codesign -dv --entitlements :- </path/to/bin>`

рдЕрдзрд┐рдХ рдЕрджреНрдпрддрд┐рдд рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЖрдк рдЗрд╕ рддрд░реНрдХ рдХреЛ **`configureProcessRestrictions`** рдХреЗ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рджреВрд╕рд░реЗ рд╣рд┐рд╕реНрд╕реЗ рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдирдП рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рд╡рд╣ рддрд░реНрдХ рдХрд╛ рдЖрд░рдВрдн рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдирдП рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдирд╣реАрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ (рдЖрдИрдУрдПрд╕ рдпрд╛ рд╕рд┐рдореНрдпреБрд▓реЗрд╢рди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд ifs рдХреЛ рд╣рдЯрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ macOS рдореЗрдВ рдЙрдкрдпреЛрдЧ рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ)ред
{% endhint %}

### рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди

рдпрджрд┐ рдмрд╛рдЗрдирд░реА **`DYLD_INSERT_LIBRARIES`** env рдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рддреЛ рдпрджрд┐ рдмрд╛рдЗрдирд░реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ рддреЛ рдПрдХ рдХрд╕реНрдЯрдо рдХреНрдпрд╛ рдирд╣реАрдВ рд▓реЛрдб рдХрд░реЗрдЧрд╛ред

рдХрд╕реНрдЯрдо рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╛рдЗрдирд░реА рдХреЗ рдкрд╛рд╕ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд entitlements рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдП:

* [`com.apple.security.cs.disable-library-validation`](../../macos-security-protections/macos-dangerous-entitlements.md#com.apple.security.cs.disable-library-validation)
* [`com.apple.private.security.clear-library-validation`](../../macos-security-protections/macos-dangerous-entitlements.md#com.apple.private.security.clear-library-validation)

рдпрд╛ рддреЛ рдмрд╛рдЗрдирд░реА рдХреЗ рдкрд╛рд╕ **рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо рдЭрдВрдбрд╛** рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдпрд╛ **рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдЭрдВрдбрд╛** рдирд╣реАрдВ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЖрдк рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдПрдХ рдмрд╛рдЗрдирд░реА рдореЗрдВ **рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо** рд╣реИ `codesign --display --verbose <bin>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **`CodeDirectory`** рдореЗрдВ рдЭрдВрдбрд╛ рджреЗрдЦрдХрд░ рдЬреИрд╕реЗ: **`CodeDirectory v=20500 size=767 flags=0x10000(runtime) hashes=13+7 location=embedded`**

рдЖрдк рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рднреА рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рд╡рд╣ **рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рд╛рде рд╕рдорд╛рди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд** рд╣реИред

рдЗрд╕реЗ (рдЕрдм)рдпрд╣ рдХреИрд╕реЗ (рдЕрдм) рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрджрд╛рд╣рд░рдг рдЦреЛрдЬреЗрдВ рдФрд░ рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:

{% content-ref url="macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

## Dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдкрд┐рдЫрд▓реЗ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдкреНрд░рддрд┐рдмрдВрдз** рднреА Dylib рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд╣рдорд▓реЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддреЗ рд╣реИрдВред
{% endhint %}

рд╡рд┐рдВрдбреЛрдЬ рдореЗрдВ, MacOS рдореЗрдВ рднреА рдЖрдк **рдбрд╛рдЗрд▓рд┐рдмреНрд╕ рдХреЛ рд╣рд╛рдЗрдЬреИрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди** **рдХреЛрдб** **рдХреЛ** **рдЕрд╡рд╢реНрдпрдХ** **рдХрд░реЗрдВ** (рдареАрдХ рд╣реИ, рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдпрд╣ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдкрдХреЛ рдПрдХ `.app` рдмрдВрдбрд▓ рдореЗрдВ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП TCC рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИ рдФрд░ рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП)ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, **MacOS** рдПрдкреНрд▓рд┐рдХреЗрд╢рди **рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб** рдХрд░рдиреЗ рдХрд╛ **рдкреНрд░рдорд╛рдг** **рд╡рд┐рдВрдбреЛрдЬ** рд╕реЗ **рдЕрдзрд┐рдХ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд** рд╣реИред рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ **рдореИрд▓рд╡реЗрдпрд░** рд╡рд┐рдХрд╛рд╕рдХ рдЗрд╕ рддрдХрдиреАрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЫрд┐рдкрд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди рдЗрд╕реЗ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рдЙрдиреНрдирдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХрдо рд╣реИ**ред

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, **рдЕрдзрд┐рдХ рд╕рд╛рдорд╛рдиреНрдп** рд╣реИ рдХрд┐ **MacOS рдмрд╛рдЗрдирд░реА** рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рд▓рд┐рдП **рдкреВрд░рд╛ рдорд╛рд░реНрдЧ рдирд┐рд░реНрджрд┐рд╖реНрдЯ** рдХрд░рддреЗ рд╣реИрдВред рдФрд░ рджреВрд╕рд░рд╛, **MacOS рдХрднреА рдирд╣реАрдВ рдЦреЛрдЬрддрд╛** рд╣реИ **$PATH** рдХреЗ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЗ рд▓рд┐рдПред

рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖реЗрддреНрд░ рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд **рдореБрдЦреНрдп** рд╣рд┐рд╕реНрд╕рд╛ **`ImageLoader::recursiveLoadLibraries`** рдореЗрдВ `ImageLoader.cpp` рдореЗрдВ рд╣реИред

рдореИрдЪреЛ рдмрд╛рдЗрдирд░реА рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпреЗ **4 рд╡рд┐рднрд┐рдиреНрди рд╣реЗрдбрд░ рдХрдорд╛рдВрдб** рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

* **`LC_LOAD_DYLIB`** рдХрдорд╛рдВрдб рдПрдХ dylib рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдорд╛рдиреНрдп рдХрдорд╛рдВрдб рд╣реИред
* **`LC_LOAD_WEAK_DYLIB`** рдХрдорд╛рдВрдб рдкрд┐рдЫрд▓реЗ рдХрдорд╛рдВрдб рдХреА рддрд░рд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрджрд┐ dylib рдирд╣реАрдВ рдорд┐рд▓рддрд╛ рд╣реИ, рддреЛ рдХреЛрдИ рддреНрд░реБрдЯрд┐ рдХреЗ рдмрд┐рдирд╛ рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдЬрд╛рд░реА рд░рд╣реЗрдЧрд╛ред
* **`LC_REEXPORT_DYLIB`** рдХрдорд╛рдВрдб рдпрд╣ рдкреНрд░реЙрдХреНрд╕реА рдХрд░рддрд╛ рд╣реИ (рдпрд╛ рдкреБрдирдГ рдирд┐рд░реНрдпрд╛рдд рдХрд░рддрд╛ рд╣реИ) рд╡рд┐рднрд┐рдиреНрди рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рд╕реЗ рдкреНрд░рддреАрдХреЛрдВ рдХреЛред
* **`LC_LOAD_UPWARD_DYLIB`** рдХрдорд╛рдВрдб рдЬрдм рджреЛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдПрдХ-рджреВрд╕рд░реЗ рдкрд░ рдирд┐рд░реНрднрд░ рд╣реЛрддреЗ рд╣реИрдВ (рдЗрд╕реЗ _
* **`LC_LOAD_DYLIB`** рдореЗрдВ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдорд╛рд░реНрдЧ рд╢рд╛рдорд┐рд▓ рд╣реИрдВред рдпреЗ рдорд╛рд░реНрдЧ **`@rpath`** рднреА рд╢рд╛рдорд┐рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреЛ **`LC_RPATH`** рдореЗрдВ рдореМрдЬреВрдж рдорд╛рдиреЛрдВ рджреНрд╡рд╛рд░рд╛ **рдкреНрд░рддрд┐рд╕реНрдерд╛рдкрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЕрдЧрд░ **`LC_RPATH`** рдореЗрдВ рдХрдИ рдорд╛рд░реНрдЧ рд╣реИрдВ рддреЛ рд╕рднреА рдХреЛ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЙрджрд╛рд╣рд░рдг:
* рдЕрдЧрд░ **`LC_LOAD_DYLIB`** рдореЗрдВ `@rpath/library.dylib` рд╣реИ рдФрд░ **`LC_RPATH`** рдореЗрдВ `/application/app.app/Contents/Framework/v1/` рдФрд░ `/application/app.app/Contents/Framework/v2/` рд╣реИред рддреЛ рджреЛрдиреЛрдВ рдлреЛрд▓реНрдбрд░ `library.dylib` рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред рдЕрдЧрд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп `[...]/v1/` рдореЗрдВ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ рдФрд░ рд╣рдорд▓рд╛рд╡рд░ рдЙрд╕реЗ рд╡рд╣рд╛рдВ рд░рдЦ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рд▓реЛрдб рдХреЛ `[...]/v2/` рдореЗрдВ рд╣рд╛рдЗрдЬреИрдХ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдХреНрдпреЛрдВрдХрд┐ **`LC_LOAD_DYLIB`** рдореЗрдВ рдорд╛рд░реНрдЧреЛрдВ рдХрд╛ рдХреНрд░рдо рдЕрдиреБрд╕рд░рдг рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
* `otool -l </path/to/binary> | grep -E "LC_RPATH|LC_LOAD_DYLIB" -A 5` рдХреЗ рд╕рд╛рде рдмрд╛рдЗрдирд░реА рдореЗрдВ **rpath рдорд╛рд░реНрдЧ рдФрд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп** рдЦреЛрдЬреЗрдВред

{% hint style="info" %}
**`@executable_path`**: **рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдлрд╝рд╛рдЗрд▓** рдХреЛ рд╕рдореЗрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдХрд╛ **рдорд╛рд░реНрдЧ** рд╣реИред

**`@loader_path`**: **Mach-O рдмрд╛рдЗрдирд░реА** рдХреЛ рд╕рдореЗрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдХрд╛ **рдорд╛рд░реНрдЧ** рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд▓реЛрдб рдХрдорд╛рдВрдб рд╣реИред

* рдЬрдм рдХрд┐рд╕реА рдХрд╛рд░реНрдпрдХреНрд░рдо рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **`@loader_path`** рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`@executable_path`** рдХреЗ рд╕рдорд╛рди рд╣реЛрддрд╛ рд╣реИред
* рдЬрдм рдХрд┐рд╕реА **dylib** рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **`@loader_path`** рджреНрд╡рд┐рддреАрдп **dylib** рдХрд╛ **рдорд╛рд░реНрдЧ** рджреЗрддрд╛ рд╣реИред
{% endhint %}

рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╡рд░реНрдЪрд╕реНрд╡ рдЙрдиреНрдирддрд┐** рдХрд╛ рддрд░реАрдХрд╛ рд╡рд╣ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм **рдХрд┐рд╕реА** **рд░реВрдЯ** рджреНрд╡рд╛рд░рд╛ **рдЪрд▓рд╛рдИ рдЬрд╛ рд░рд╣реА рдПрдкреНрд▓рд┐рдХреЗрд╢рди** рдХреЛ рдХрд┐рд╕реА **рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдХреБрдЫ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЦреЛрдЬрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рд▓реЗрдЦрди рдЕрдиреБрдорддрд┐рдпрд╛рдБ рд╣реИрдВред

{% hint style="success" %}
рдПрдХ рдЕрдЪреНрдЫрд╛ **рд╕реНрдХреИрдирд░** рдЬреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ **рдЧрд╛рдпрдм рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ** рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ [**Dylib Hijack Scanner**](https://objective-see.com/products/dhs.html) рдпрд╛ рдПрдХ [**CLI рд╕рдВрд╕реНрдХрд░рдг**](https://github.com/pandazheng/DylibHijack)ред\
рдЗрд╕ рддрдХрдиреАрдХ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдПрдХ рдЕрдЪреНрдЫреА **рд░рд┐рдкреЛрд░реНрдЯ рддрдХрдиреАрдХреА рд╡рд┐рд╡рд░рдг** рдпрд╣рд╛рдБ рдорд┐рд▓ рд╕рдХрддрд╛ рд╣реИ [**рдпрд╣рд╛рдБ**](https://www.virusbulletin.com/virusbulletin/2015/03/dylib-hijacking-os-x)ред
{% endhint %}

**рдЙрджрд╛рд╣рд░рдг**

{% content-ref url="macos-dyld-hijacking-and-dyld_insert_libraries.md" %}
[macos-dyld-hijacking-and-dyld\_insert\_libraries.md](macos-dyld-hijacking-and-dyld\_insert\_libraries.md)
{% endcontent-ref %}

## Dlopen Hijacking

{% hint style="danger" %}
рдзреНрдпрд╛рди рд░рдЦреЗрдВ рдХрд┐ **рдкрд┐рдЫрд▓реА рдкреБрд╕реНрддрдХрд╛рд▓рдп рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рддрд┐рдмрдВрдз** рднреА Dlopen рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рд╣рдорд▓реЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИред
{% endhint %}

**`man dlopen`** рд╕реЗ:

* рдЬрдм рдкрде рдореЗрдВ **рдХреЛрдИ рд╕реНрд▓реИрд╢ рд╡рд╛рд▓рд╛ рд╡рд░реНрдг рдирд╣реАрдВ рд╣реЛрддрд╛** рд╣реИ (рдЕрд░реНрдерд╛рдд рдХреЗрд╡рд▓ рдПрдХ рдкрддреНрддрд╛ рдирд╛рдо рд╣реИ), рддреЛ **dlopen() рдЦреЛрдЬ рдХрд░реЗрдЧрд╛**ред рдЕрдЧрд░ **`$DYLD_LIBRARY_PATH`** рд▓реЙрдиреНрдЪ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld рдкрд╣рд▓реЗ **рдЙрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рджреЗрдЦреЗрдЧрд╛**ред рдЕрдЧрд▓реЗ, рдпрджрд┐ рдХреЙрд▓рд┐рдВрдЧ mach-o рдлрд╝рд╛рдЗрд▓ рдпрд╛ рдореБрдЦреНрдп рдХрд╛рд░реНрдпрдХреНрд░рдо рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рддреЗ рд╣реИрдВ **`LC_RPATH`**, рддреЛ dyld **рдЙрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рджреЗрдЦреЗрдЧрд╛**ред рдЕрдЧрд▓реЗ, рдпрджрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдЕрд╕реАрдорд┐рдд** рд╣реИ, рддреЛ dyld **рд╡рд░реНрддрдорд╛рди рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдЦреЛрдЬреЗрдЧрд╛**ред рдЕрдВрддрддрдГ, рдкреБрд░рд╛рдиреЗ рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП, dyld рдХреБрдЫ рдлреЙрд▓рдмреИрдХ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛ред рдпрджрд┐ **`$DYLD_FALLBACK_LIBRARY_PATH`** рд▓реЙрдиреНрдЪ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld **рдЙрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рджреЗрдЦреЗрдЧрд╛**, рдЕрдиреНрдпрдерд╛, dyld **`/usr/local/lib/`** рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ (рдпрджрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ), рдФрд░ рдлрд┐рд░ **`/usr/lib/`** рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ред
1. `$DYLD_LIBRARY_PATH`
2. `LC_RPATH`
3. `CWD`(рдЕрд╕реАрдорд┐рдд рд╣реЛрдиреЗ рдкрд░)
4. `$DYLD_FALLBACK_LIBRARY_PATH`
5. `/usr/local/lib/` (рдЕрд╕реАрдорд┐рдд рд╣реЛрдиреЗ рдкрд░)
6. `/usr/lib/`

{% hint style="danger" %}
рдирд╛рдо рдореЗрдВ рдХреЛрдИ рд╕реНрд▓реИрд╢ рдирд╣реАрдВ рд╣реИ, рддреЛ рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ рдХрд░рдиреЗ рдХреЗ рджреЛ рддрд░реАрдХреЗ рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ:

* рдпрджрд┐ рдХреЛрдИ **`LC_RPATH`** **рд▓рд┐рдЦрдиреЗ рдпреЛрдЧреНрдп** рд╣реИ (рд▓реЗрдХрд┐рди рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЬрд╛рдВрдЪ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдмрд╛рдЗрдирд░реА рдХреЛ рдЕрд╕реАрдорд┐рдд рдХрд░рдиреЗ рдХреА рднреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ)
* рдпрджрд┐ рдмрд╛рдЗрдирд░реА **рдЕрд╕реАрдорд┐рдд** рд╣реИ рдФрд░ рдлрд┐рд░ CWD рд╕реЗ рдХреБрдЫ рд▓реЛрдб рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ (рдпрд╛ рдЙрдкрд░реЛрдХреНрдд env рдЪрд░рдгреЛрдВ рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рдПрдХ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛)
{% endhint %}

* рдЬрдм рдкрде **рдПрдХ рдлреНрд░реЗрдорд╡рд░реНрдХ рдХреА рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ** (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `/stuff/foo.framework/foo`), рдЕрдЧрд░ **`$DYLD_FRAMEWORK_PATH`** рд▓реЙрдиреНрдЪ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld рдкрд╣рд▓реЗ рдЙрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ **рдлреНрд░реЗрдорд╡рд░реНрдХ рдЖрдВрд╢рд┐рдХ рдкрде** (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `foo.framework/foo`)ред рдЕрдЧрд▓реЗ, dyld **рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде рдХреЛ рдЬреИрд╕рд╛ рд╣реИ** (рд╡рд░реНрддрдорд╛рди рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП)ред рдЕрдВрддрддрдГ, рдкреБрд░рд╛рдиреЗ рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП, dyld рдХреБрдЫ рдлреЙрд▓рдмреИрдХ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛ред рдпрджрд┐ **`$DYLD_FALLBACK_FRAMEWORK_PATH`** рд▓реЙрдиреНрдЪ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld **рдЙрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рджреЗрдЦреЗрдЧрд╛**ред рдЕрдиреНрдпрдерд╛, рдпрд╣ **`/Library/Frameworks`** рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ (macOS рдкрд░ рдпрджрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ), рдлрд┐рд░ **`/System/Library/Frameworks`** рдореЗрдВред
1. `$DYLD_FRAMEWORK_PATH`
2. рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде (рдЕрд╕реАрдорд┐рдд рд╣реЛрдиреЗ рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛)
3. `$DYLD_FALLBACK_FRAMEWORK_PATH`
4. `/Library/Frameworks` (рдЕрд╕реАрдорд┐рдд рд╣реЛрдиреЗ рдкрд░)
5. `/System/Library/Frameworks`

{% hint style="danger" %}
рдЕрдЧрд░ рдПрдХ рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрде рд╣реИ, рддреЛ рдЙрд╕реЗ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:

* рдпрджрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ **рдЕрд╕реАрдорд┐рдд** рд╣реИ, CWD рд╕реЗ **рдирд┐рд░реНрджреЗрд╢рд┐рдд рдкрде** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛ (рдпрд╣рд╛рдБ рддрдХ рдХрд┐ рдпрджрд┐ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдореЗрдВ рдирд╣реАрдВ рдХрд╣рд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рд╣реИ рддреЛ DYLD\_\* env рдЪрд░рдг рд╣рдЯрд╛ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ)
{% endhint %}

* рдЬрдм рдкрде **рдПрдХ рд╕реНрд▓реИрд╢ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрде рдирд╣реАрдВ рд╣реИ** (рдЕрд░реНрдерд╛рдд рдПрдХ рдкреВрд░реНрдг рдкрде рдпрд╛ рдПрдХ dylib рдХреЗ рд▓рд┐рдП рдЖрдВрд╢рд┐рдХ рдкрде), dlopen() рдкрд╣рд▓реЗ (рдпрджрд┐ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ) **`$DYLD_LIBRARY_PATH`** рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ (рдкрде рдХреЗ рдкрддреНрддреЗ рдХреЗ рд╕рд╛рде)ред рдЕрдЧрд▓реЗ, dyld **рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде рдХреЛ рдЬреИрд╕рд╛ рд╣реИ** (рд╡рд░реНрддрдорд╛рди рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП)ред рдЕрдВрддрддрдГ, рдкреБрд░рд╛рдиреЗ рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП, dyld рдХреБрдЫ рдлреЙрд▓рдмреИрдХ рдХреЛрд╢рд┐рд╢ рдХрд░реЗрдЧрд╛ред рдпрджрд┐ **`$DYLD_FALLBACK_LIBRARY_PATH`** рд▓реЙрдиреНрдЪ рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ dyld **рдЙрди рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рджреЗрдЦреЗрдЧрд╛**, рдЕрдиреНрдпрдерд╛, dyld **`/usr/local/lib/`** рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ (рдпрджрд┐ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрд╕реАрдорд┐рдд рд╣реИ), рдФрд░ рдлрд┐рд░ **`/usr/lib/`** рдореЗрдВ рджреЗрдЦреЗрдЧрд╛ред
1. `$DYLD_LIBRARY_PATH`
2. рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрде (рдЕрд╕реАрдорд┐рдд рд╣реЛрдиреЗ рдкрд░ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд░реНрддрдорд╛рди рдХрд╛рдо рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛)
3. `$DYLD_FALLBACK_LIBRARY_PATH`
4. `/usr/local/lib/` (рдЕрд╕реАрдорд┐рдд рд╣реЛрдиреЗ рдкрд░)
5. `/usr/lib/`

{% hint style="danger" %}
рдирд╛рдо рдореЗрдВ рд╕реНрд▓реИрд╢ рд╣реИ рдФрд░ рдлреНрд░реЗрдорд╡рд░реНрдХ рдирд╣реАрдВ рд╣реИ, рддреЛ
```c
// gcc dlopentest.c -o dlopentest -Wl,-rpath,/tmp/test
#include <dlfcn.h>
#include <stdio.h>

int main(void)
{
void* handle;

fprintf("--- No slash ---\n");
handle = dlopen("just_name_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative framework ---\n");
handle = dlopen("a/framework/rel_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs framework ---\n");
handle = dlopen("/a/abs/framework/abs_framework_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Relative Path ---\n");
handle = dlopen("a/folder/rel_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

fprintf("--- Abs Path ---\n");
handle = dlopen("/a/abs/folder/abs_folder_dlopentest.dylib",1);
if (!handle) {
fprintf(stderr, "Error loading: %s\n\n\n", dlerror());
}

return 0;
}
```
рдпрджрд┐ рдЖрдк рдЗрд╕реЗ рдХрдВрдкрд╛рдЗрд▓ рдФрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдЖрдк **рд╣рд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рдЕрд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЦреЛрдЬрд╛ рдЧрдпрд╛ рдерд╛ рдХрд╣рд╛рдБ** рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдк **рдПрдлрдПрд╕ рд▓реЙрдЧ рдХреЛ рдлрд╝рд┐рд▓реНрдЯрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**:
```bash
sudo fs_usage | grep "dlopentest"
```
## рд╕рд╛рдВрдЦреНрдпрд┐рдХ рдорд╛рд░реНрдЧ рд╣рд╛рдЗрдЬреИрдХрд┐рдВрдЧ

рдпрджрд┐ рдПрдХ **рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реА рдмрд╛рдЗрдирд░реА/рдПрдкреНрд▓рд┐рдХреЗрд╢рди** (рдЬреИрд╕реЗ SUID рдпрд╛ рдХреБрдЫ рд╢рдХреНрддрд┐рд╢рд╛рд▓реА entitlements рд╡рд╛рд▓рд╛ рдмрд╛рдЗрдирд░реА) **рдПрдХ рд╕рд╛рдВрдЦреНрдпрд┐рдХ рдорд╛рд░реНрдЧ** рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЛ рд▓реЛрдб рдХрд░ рд░рд╣рд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `@executable_path` рдпрд╛ `@loader_path` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ) рдФрд░ **рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рддреНрдпрд╛рдкрди рдЕрдХреНрд╖рдо рд╣реИ**, рддреЛ рд╣рдореЗрдВ рдмрд╛рдЗрдирд░реА рдХреЛ рдПрдХ рд╕реНрдерд╛рди рдкрд░ рдореВрд╡ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╣рдореЗрдВ рдЖрдХреНрд░рдордгрдХрд╛рд░реА рдХреЛ **рд╕рдВрдмрдВрдзрд┐рдд рдорд╛рд░реНрдЧ рд▓реЛрдб рдХреА рдЧрдИ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдореЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛ, рдФрд░ рдЗрд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## `DYLD_*` рдФрд░ `LD_LIBRARY_PATH` env рдЪрд░реЛрдВ рдХреЛ рдХрд╛рдЯрдирд╛

рдлрд╝рд╛рдЗрд▓ `dyld-dyld-832.7.1/src/dyld2.cpp` рдореЗрдВ рдлрд╝рдВрдХреНрд╢рди **`pruneEnvironmentVariables`** рдХреЛ рдЦреЛрдЬрдирд╛ рд╕рдВрднрд╡ рд╣реИ, рдЬреЛ рдХрд┐рд╕реА рднреА env рдЪрд░ рдХреЛ рд╣рдЯрд╛ рджреЗрдЧрд╛ рдЬреЛ **`DYLD_`** рд╕реЗ **рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ** рдФрд░ **`LD_LIBRARY_PATH=`**ред

рдпрд╣ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **suid** рдФрд░ **sgid** рдмрд╛рдЗрдирд░реА рдХреЗ рд▓рд┐рдП env рдЪрд░ **`DYLD_FALLBACK_FRAMEWORK_PATH`** рдФрд░ **`DYLD_FALLBACK_LIBRARY_PATH`** рдХреЛ **null** рдкрд░ рд╕реЗрдЯ рдХрд░реЗрдЧрд╛ред

рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдЙрд╕реА рдлрд╝рд╛рдЗрд▓ рдХреЗ **`_main`** рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рдУрдПрд╕рдПрдХреНрд╕ рдХреЛ рд▓рдХреНрд╖рд┐рдд рдХрд░рддреЗ рд╣реБрдП рдмреБрд▓рд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```cpp
#if TARGET_OS_OSX
if ( !gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache ) {
pruneEnvironmentVariables(envp, &apple);
```
рдФрд░ рд╡реЗ рдмреВрд▓рд┐рдпрди рдлреНрд▓реИрдЧреНрд╕ рдХреЛрдб рдореЗрдВ рдПрдХ рд╣реА рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕реЗрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ:
```cpp
#if TARGET_OS_OSX
// support chrooting from old kernel
bool isRestricted = false;
bool libraryValidation = false;
// any processes with setuid or setgid bit set or with __RESTRICT segment is restricted
if ( issetugid() || hasRestrictedSegment(mainExecutableMH) ) {
isRestricted = true;
}
bool usingSIP = (csr_check(CSR_ALLOW_TASK_FOR_PID) != 0);
uint32_t flags;
if ( csops(0, CS_OPS_STATUS, &flags, sizeof(flags)) != -1 ) {
// On OS X CS_RESTRICT means the program was signed with entitlements
if ( ((flags & CS_RESTRICT) == CS_RESTRICT) && usingSIP ) {
isRestricted = true;
}
// Library Validation loosens searching but requires everything to be code signed
if ( flags & CS_REQUIRE_LV ) {
isRestricted = false;
libraryValidation = true;
}
}
gLinkContext.allowAtPaths                = !isRestricted;
gLinkContext.allowEnvVarsPrint           = !isRestricted;
gLinkContext.allowEnvVarsPath            = !isRestricted;
gLinkContext.allowEnvVarsSharedCache     = !libraryValidation || !usingSIP;
gLinkContext.allowClassicFallbackPaths   = !isRestricted;
gLinkContext.allowInsertFailures         = false;
gLinkContext.allowInterposing         	 = true;
```
рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдмрд╛рдЗрдирд░реА **suid** рдпрд╛ **sgid** рд╣реИ, рдпрд╛ рд╣реЗрдбрд░реНрд╕ рдореЗрдВ **RESTRICT** рд╕реЗрдЧрдореЗрдВрдЯ рд╣реИ рдпрд╛ рдпрд╣ **CS\_RESTRICT** рдлреНрд▓реИрдЧ рдХреЗ рд╕рд╛рде рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ **`!gLinkContext.allowEnvVarsPrint && !gLinkContext.allowEnvVarsPath && !gLinkContext.allowEnvVarsSharedCache`** рд╕рддреНрдп рд╣реИ рдФрд░ env variables рдХреЛ рдХрд╛рдЯ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ CS\_REQUIRE\_LV рд╕рддреНрдп рд╣реИ, рддреЛ рдЪрд░рдгреЛрдВ рдХреЛ рдХрд╛рдЯрд╛ рдирд╣реАрдВ рдЬрд╛рдПрдЧрд╛ рд▓реЗрдХрд┐рди рдкреБрд╕реНрддрдХрд╛рд▓рдп рдорд╛рдиреНрдпрддрд╛ рдЬрд╛рдВрдЪреЗрдЧреА рдХрд┐ рд╡реЗ рдореВрд▓ рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рд╛рде рд╕рдорд╛рди рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВред

## рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреА рдЬрд╛рдВрдЪ

### SUID рдФрд░ SGID
```bash
# Make it owned by root and suid
sudo chown root hello
sudo chmod +s hello
# Insert the library
DYLD_INSERT_LIBRARIES=inject.dylib ./hello

# Remove suid
sudo chmod -s hello
```
### рдЦрдВрдб `__RESTRICT` рд╕реЗрдЧрдореЗрдВрдЯ `__restrict` рдХреЗ рд╕рд╛рде
```bash
gcc -sectcreate __RESTRICT __restrict /dev/null hello.c -o hello-restrict
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-restrict
```
### рд╣рд╛рд░реНрдбрдиреНрдб рд░рдирдЯрд╛рдЗрдо

рдХреАрдЪреЗрди рдореЗрдВ рдПрдХ рдирдпрд╛ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдмрдирд╛рдПрдВ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдмрд╛рдЗрдирд░реА рдХреЛ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░реЗрдВ:
```bash
# Apply runtime proetction
codesign -s <cert-name> --option=runtime ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello #Library won't be injected

# Apply library validation
codesign -f -s <cert-name> --option=library ./hello
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed #Will throw an error because signature of binary and library aren't signed by same cert (signs must be from a valid Apple-signed developer certificate)

# Sign it
## If the signature is from an unverified developer the injection will still work
## If it's from a verified developer, it won't
codesign -f -s <cert-name> inject.dylib
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed

# Apply CS_RESTRICT protection
codesign -f -s <cert-name> --option=restrict hello-signed
DYLD_INSERT_LIBRARIES=inject.dylib ./hello-signed # Won't work
```
{% endcode %}

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдХрд┐рд╕реА рднреА рдмрд╛рдЗрдирд░реА рдХреЗ рд╕рд╛рде рдЭрдВрдбреЗ **`0x0(none)`** рдХреЗ рд╕рд╛рде рд╣реИрдВ, рддреЛ рдЬрдм рд╡реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддреЗ рд╣реИрдВ рддреЛ рд╡реЗ рдбрд╛рдпрдирд╛рдорд┐рдХ рд░реВрдк рд╕реЗ **`CS_RESTRICT`** рдЭрдВрдбрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рд▓рд┐рдП рдпрд╣ рддрдХрдиреАрдХ рдЙрдирдореЗрдВ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреАред

рдЖрдк рдпрд╣ рдЭрдВрдбрд╛ рдХрд┐рд╕реА рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рд╣реИ рдпрд╛ рдирд╣реАрдВ рдЗрд╕реЗ рдЪреЗрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдпрд╣рд╛рдБ [**csops рдпрд╣рд╛рдБ**](https://github.com/axelexic/CSOps) рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ):
```bash
csops -status <pid>
```
and then check if the flag 0x800 is enabled.
{% endhint %}

## рд╕рдВрджрд░реНрдн

* [https://theevilbit.github.io/posts/dyld\_insert\_libraries\_dylib\_injection\_in\_macos\_osx\_deep\_dive/](https://theevilbit.github.io/posts/dyld\_insert\_libraries\_dylib\_injection\_in\_macos\_osx\_deep\_dive/)
* [**\*OS Internals, Volume I: User Mode. By Jonathan Levin**](https://www.amazon.com/MacOS-iOS-Internals-User-Mode/dp/099105556X)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рд╣реЛ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рдЬреБрдбрд╝реЗрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
