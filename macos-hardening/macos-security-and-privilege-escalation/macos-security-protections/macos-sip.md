# macOS SIP

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## **Βασικές Πληροφορίες**

Το **System Integrity Protection (SIP)** στο macOS είναι ένας μηχανισμός που έχει σχεδιαστεί για να εμποδίζει ακόμα και τους πιο προνομιούχους χρήστες να πραγματοποιούν μη εξουσιοδοτημένες αλλαγές σε βασικούς φακέλους του συστήματος. Αυτή η λειτουργία παίζει έναν κρίσιμο ρόλο στη διατήρηση της ακεραιότητας του συστήματος περιορίζοντας ενέργειες όπως η προσθήκη, η τροποποίηση ή η διαγραφή αρχείων σε προστατευμένες περιοχές. Οι κύριοι φάκελοι που προστατεύονται από το SIP περιλαμβάνουν:

* **/System**
* **/bin**
* **/sbin**
* **/usr**

Οι κανόνες που διέπουν τη συμπεριφορά του SIP καθορίζονται στο αρχείο ρυθμίσεων που βρίσκεται στη διαδρομή **`/System/Library/Sandbox/rootless.conf`**. Μέσα σε αυτό το αρχείο, οι διαδρομές που προηγούνται από ένα αστερίσκο (*) θεωρούνται εξαιρέσεις από τους αυστηρούς περιορισμούς του SIP.

Λάβετε υπόψη το παρακάτω παράδειγμα:
```javascript
/usr
* /usr/libexec/cups
* /usr/local
* /usr/share/man
```
Αυτό το απόσπασμα υπονοεί ότι ενώ το SIP ασφαλίζει γενικά τον κατάλογο **`/usr`**, υπάρχουν συγκεκριμένοι υποκατάλογοι (`/usr/libexec/cups`, `/usr/local` και `/usr/share/man`) όπου επιτρέπονται τροποποιήσεις, όπως υποδεικνύεται από το αστερίσκο (*) που προηγείται των διαδρομών τους.

Για να επαληθεύσετε εάν ένας κατάλογος ή ένα αρχείο προστατεύεται από το SIP, μπορείτε να χρησιμοποιήσετε την εντολή **`ls -lOd`** για να ελέγξετε την παρουσία των σημαιών **`restricted`** ή **`sunlnk`**. Για παράδειγμα:
```bash
ls -lOd /usr/libexec/cups
drwxr-xr-x  11 root  wheel  sunlnk 352 May 13 00:29 /usr/libexec/cups
```
Σε αυτήν την περίπτωση, η σημαία **`sunlnk`** υποδηλώνει ότι ο ίδιος ο κατάλογος `/usr/libexec/cups` **δεν μπορεί να διαγραφεί**, αν και μπορούν να δημιουργηθούν, τροποποιηθούν ή διαγραφούν αρχεία μέσα σε αυτόν.

Από την άλλη πλευρά:
```bash
ls -lOd /usr/libexec
drwxr-xr-x  338 root  wheel  restricted 10816 May 13 00:29 /usr/libexec
```
Εδώ, η **`restricted`** σημαία υποδεικνύει ότι ο κατάλογος `/usr/libexec` προστατεύεται από το SIP. Σε έναν προστατευμένο από το SIP κατάλογο, τα αρχεία δεν μπορούν να δημιουργηθούν, να τροποποιηθούν ή να διαγραφούν.

Επιπλέον, αν ένα αρχείο περιέχει το επεκτεινόμενο **`com.apple.rootless`** χαρακτηριστικό, το αρχείο αυτό θα προστατεύεται επίσης από το SIP.

**Το SIP περιορίζει επίσης άλλες ενέργειες του ριζικού** όπως:

* Φόρτωση μη αξιόπιστων επεκτάσεων πυρήνα
* Λήψη task-ports για διεργασίες που έχουν υπογραφεί από την Apple
* Τροποποίηση μεταβλητών NVRAM
* Επιτροπή αποσφαλμάτωσης πυρήνα

Οι επιλογές διατηρούνται στη μεταβλητή nvram ως bitflag (`csr-active-config` στο Intel και `lp-sip0` διαβάζεται από το Device Tree που έχει εκκινηθεί για το ARM). Μπορείτε να βρείτε τις σημαίες στον πηγαίο κώδικα XNU στο αρχείο `csr.sh`:

<figure><img src="../../../.gitbook/assets/image (720).png" alt=""><figcaption></figcaption></figure>

### Κατάσταση SIP

Μπορείτε να ελέγξετε εάν το SIP είναι ενεργοποιημένο στο σύστημά σας με την παρακάτω εντολή:
```bash
csrutil status
```
Εάν χρειάζεστε να απενεργοποιήσετε το SIP, πρέπει να επανεκκινήσετε τον υπολογιστή σας σε λειτουργία ανάκτησης (πατώντας Command+R κατά την εκκίνηση), και στη συνέχεια να εκτελέσετε την παρακάτω εντολή:
```bash
csrutil disable
```
Εάν επιθυμείτε να διατηρήσετε ενεργοποιημένο το SIP αλλά να αφαιρέσετε τις προστασίες από αποσφαλμάτωση, μπορείτε να το κάνετε με:
```bash
csrutil enable --without debug
```
### Άλλοι Περιορισμοί

- **Απαγορεύει τη φόρτωση μη υπογεγραμμένων πυρήνας επεκτάσεων** (kexts), εξασφαλίζοντας ότι μόνο επαληθευμένες επεκτάσεις αλληλεπιδρούν με τον πυρήνα του συστήματος.
- **Αποτρέπει την αποσφαλμάτωση** των διεργασιών του συστήματος macOS, προστατεύοντας τα βασικά συστατικά του συστήματος από μη εξουσιοδοτημένη πρόσβαση και τροποποίηση.
- **Αναστέλλει τα εργαλεία** όπως το dtrace από τον έλεγχο των διεργασιών του συστήματος, προστατεύοντας περαιτέρω την ακεραιότητα της λειτουργίας του συστήματος.

**[Μάθετε περισσότερα για τις πληροφορίες του SIP σε αυτήν την ομιλία](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship).**

## Παράκαμψη του SIP

Η παράκαμψη του SIP επιτρέπει σε έναν επιτιθέμενο να:

- **Αποκτήσει πρόσβαση σε δεδομένα χρήστη**: Διαβάσει ευαίσθητα δεδομένα χρήστη, όπως τα email, τα μηνύματα και το ιστορικό του Safari από όλους τους λογαριασμούς χρηστών.
- **Παράκαμψη του TCC**: Αλλοιώσει απευθείας τη βάση δεδομένων TCC (Transparency, Consent, and Control) για να παραχωρήσει μη εξουσιοδοτημένη πρόσβαση στην κάμερα, το μικρόφωνο και άλλους πόρους.
- **Δημιουργήσει Μόνιμη Παρουσία**: Τοποθετήσει κακόβουλο λογισμικό σε προστατευμένες από το SIP τοποθεσίες, καθιστώντας το ανθεκτικό στην αφαίρεση, ακόμη και από τα δικαιώματα root. Αυτό περιλαμβάνει επίσης τη δυνατότητα παρεμβολής στο Εργαλείο Αφαίρεσης Κακόβουλου Λογισμικού (MRT).
- **Φόρτωση Πυρήνα Επεκτάσεων**: Παρόλο που υπάρχουν επιπλέον μέτρα προστασίας, η παράκαμψη του SIP απλοποιεί τη διαδικασία φόρτωσης μη υπογεγραμμένων πυρήνας επεκτάσεων.

### Πακέτα Εγκατάστασης

**Τα πακέτα εγκατάστασης που έχουν υπογραφεί με το πιστοποιητικό της Apple** μπορούν να παρακάμψουν τις προστασίες του SIP. Αυτό σημαίνει ότι ακόμη και τα πακέτα που έχουν υπογραφεί από τυπικούς προγραμματιστές θα αποκλειστούν εάν προσπαθήσουν να τροποποιήσουν καταλόγους που προστατεύονται από το SIP.

### Ανύπαρκτο αρχείο SIP

Ένα πιθανό κενό στο SIP είναι ότι εάν ένα αρχείο καθορίζεται στο **`rootless.conf` αλλά δεν υπάρχει αυτή τη στιγμή**, μπορεί να δημιουργηθεί. Κακόβουλο λογισμικό μπορεί να εκμεταλλευτεί αυτό για να **δημιουργήσει μόνιμη παρουσία** στο σύστημα. Για παράδειγμα, ένα κακόβουλο πρόγραμμα μπορεί να δημιουργήσει ένα αρχείο .plist στο `/System/Library/LaunchDaemons` εάν αυτό αναφέρεται στο `rootless.conf` αλλά δεν υπάρχει.

### com.apple.rootless.install.heritable

{% hint style="danger" %}
Το δικαίωμα **`com.apple.rootless.install.heritable`** επιτρέπει την παράκαμψη του SIP.
{% endhint %}

#### Shrootless

[**Ερευνητές από αυτήν την ανάρτηση στο blog**](https://www.microsoft.com/en-us/security/blog/2021/10/28/microsoft-finds-new-macos-vulnerability-shrootless-that-could-bypass-system-integrity-protection/) ανακάλυψαν μια ευπάθεια στο μηχανισμό Προστασίας Ακεραιότητας Συστήματος (SIP) του macOS, με την ονομασία ευπάθειας 'Shrootless'. Αυτή η ευπάθεια επικεντρώνεται στον δαίμονα **`system_installd`**, ο οποίος έχει ένα δικαίωμα, το **`com.apple.rootless.install.heritable`**, που επιτρέπει σε οποιαδήποτε από τις υποδιεργασίες του να παρακάμψει τους περιορισμούς του SIP στο σύστημα αρχείων.

Ο δαίμονας **`system_installd`** θα εγκαταστήσει πακέτα που έχουν υπογραφεί από την **Apple**.

Οι ερευνητές ανακάλυψαν ότι κατά την εγκατάσταση ενός πακέτου που έχει υπογραφεί από την Apple (.pkg αρχείο), ο **`system_installd`** **εκτελεί** οποιαδήποτε **post-install** ενέργεια που περιλαμβάνεται στο πακέτο. Αυτά τα scripts εκτελούνται από το προεπιλεγμένο κέλυφος, το **`zsh`**, το οποίο αυτόματα **εκτελεί** εντολές από το αρχείο **`/etc/zshenv`**, εάν υπάρχει, ακόμη και σε μη διαδραστική λειτουργία. Αυτή η συμπεριφορά μπορεί να εκμεταλλευτεί από επιτιθέμε
```bash
ln -s /System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist /dev/diskX
fsck_cs /dev/diskX 1>&-
touch /Library/Extensions/
reboot
```
Η εκμετάλλευση αυτής της ευπάθειας έχει σοβαρές συνέπειες. Το αρχείο `Info.plist`, που συνήθως είναι υπεύθυνο για τη διαχείριση των δικαιωμάτων για τις πυρήνας επεκτάσεις, γίνεται αναποτελεσματικό. Αυτό περιλαμβάνει την αδυναμία αποκλεισμού ορισμένων επεκτάσεων, όπως το `AppleHWAccess.kext`. Ως αποτέλεσμα, με τον μηχανισμό ελέγχου του SIP να είναι εκτός λειτουργίας, αυτή η επέκταση μπορεί να φορτωθεί, παρέχοντας μη εξουσιοδοτημένη ανάγνωση και εγγραφή στη RAM του συστήματος.


#### [Τοποθέτηση πάνω από τους προστατευμένους φακέλους του SIP](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship)

Ήταν δυνατό να τοποθετηθεί ένα νέο σύστημα αρχείων πάνω από τους **προστατευμένους φακέλους του SIP για να παρακάμψει την προστασία**.
```bash
mkdir evil
# Add contento to the folder
hdiutil create -srcfolder evil evil.dmg
hdiutil attach -mountpoint /System/Library/Snadbox/ evil.dmg
```
#### [Παράκαμψη του Upgrader (2016)](https://objective-see.org/blog/blog\_0x14.html)

Το σύστημα έχει ρυθμιστεί να εκκινεί από ένα ενσωματωμένο δισκοεικό εικονίδιο εγκαταστάτη μέσα στο `Install macOS Sierra.app` για να αναβαθμίσει το λειτουργικό σύστημα, χρησιμοποιώντας το εργαλείο `bless`. Η εντολή που χρησιμοποιείται είναι η εξής:
```bash
/usr/sbin/bless -setBoot -folder /Volumes/Macintosh HD/macOS Install Data -bootefi /Volumes/Macintosh HD/macOS Install Data/boot.efi -options config="\macOS Install Data\com.apple.Boot" -label macOS Installer
```
Η ασφάλεια αυτής της διαδικασίας μπορεί να διακυβευθεί εάν ένας επιτιθέμενος αλλάξει την εικόνα αναβάθμισης (`InstallESD.dmg`) πριν από την εκκίνηση. Η στρατηγική περιλαμβάνει την αντικατάσταση ενός δυναμικού φορτωτή (dyld) με μια κακόβουλη έκδοση (`libBaseIA.dylib`). Αυτή η αντικατάσταση οδηγεί στην εκτέλεση του κώδικα του επιτιθέμενου όταν ξεκινά ο εγκαταστάτης.

Ο κώδικας του επιτιθέμενου αποκτά έλεγχο κατά τη διάρκεια της διαδικασίας αναβάθμισης, εκμεταλλευόμενος την εμπιστοσύνη του συστήματος στον εγκαταστάτη. Η επίθεση συνεχίζεται με την αλλοίωση της εικόνας `InstallESD.dmg` μέσω της μεθόδου swizzling, επικεντρώνοντας ιδιαίτερα στη μέθοδο `extractBootBits`. Αυτό επιτρέπει την εισαγωγή κακόβουλου κώδικα πριν από τη χρήση της εικόνας του δίσκου.

Επιπλέον, μέσα στο `InstallESD.dmg` υπάρχει ένα `BaseSystem.dmg`, το οποίο λειτουργεί ως το ριζικό σύστημα αρχείων του κώδικα αναβάθμισης. Η εισαγωγή μιας δυναμικής βιβλιοθήκης σε αυτό επιτρέπει στον κακόβουλο κώδικα να λειτουργεί μέσα σε ένα διεργασία που μπορεί να αλλάξει αρχεία σε επίπεδο λειτουργικού συστήματος, αυξάνοντας σημαντικά τη δυνατότητα διάβρωσης του συστήματος.


#### [systemmigrationd (2023)](https://www.youtube.com/watch?v=zxZesAN-TEk)

Σε αυτήν την ομιλία από το [**DEF CON 31**](https://www.youtube.com/watch?v=zxZesAN-TEk), δείχνεται πώς το **`systemmigrationd`** (το οποίο μπορεί να παρακάμψει το SIP) εκτελεί ένα σενάριο **bash** και ένα σενάριο **perl**, τα οποία μπορούν να καταχραστούνται μέσω των μεταβλητών περιβάλλοντος **`BASH_ENV`** και **`PERL5OPT`**.

### **com.apple.rootless.install**

{% hint style="danger" %}
Το δικαίωμα **`com.apple.rootless.install`** επιτρέπει την παράκαμψη του SIP
{% endhint %}

Το δικαίωμα `com.apple.rootless.install` είναι γνωστό ότι παρακάμπτει την System Integrity Protection (SIP) στο macOS. Αυτό αναφέρθηκε ιδιαίτερα σε σχέση με το [**CVE-2022-26712**](https://jhftss.github.io/CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/).

Σε αυτήν τη συγκεκριμένη περίπτωση, η υπηρεσία XPC του συστήματος που βρίσκεται στο `/System/Library/PrivateFrameworks/ShoveService.framework/Versions/A/XPCServices/SystemShoveService.xpc` διαθέτει αυτό το δικαίωμα. Αυτό επιτρέπει στη σχετική διεργασία να παρακάμψει τους περιορισμούς του SIP. Επιπλέον, αυτή η υπηρεσία παρουσιάζει μια μέθοδο που επιτρέπει τη μετακίνηση αρχείων χωρίς την εφαρμογή οποιωνδήποτε μέτρων ασφαλείας.


## Σφραγισμένα Στιγμιότυπα Συστήματος

Τα Σφραγισμένα Στιγμιότυπα Συστήματος είναι μια λειτουργία που εισήγαγε η Apple στο **macOS Big Sur (macOS 11)** ως μέρος του μηχανισμού της **System Integrity Protection (SIP)** για να παρέχει ένα επιπλέον επίπεδο ασφάλειας και σταθερότητας του συστήματος. Ουσιαστικά, είναι αναγνώσιμες μόνο εκδόσεις του όγκου του συστήματος.

Ας ρίξουμε μια πιο λεπτομερή ματιά:

1. **Αμετάβλητο Σύστημα**: Τα Σφραγισμένα Στιγμιότυπα Συστήματος καθιστούν τον όγκο του συστήματος του macOS "αμετάβλητο", πράγμα που σημαίνει ότι δεν μπορεί να τροποποιηθεί. Αυτό εμποδίζει οποιεσδήποτε μη εξουσιοδοτημένες ή ακούσιες αλλαγές στο σύστημα που θα μπορούσαν να διακυβεύσουν την ασφάλεια ή τη σταθερότητα του συστήματος.
2. **Ενημερώσεις Λογισμικού Συστήματος**: Όταν εγκαθιστάτε ενημερώσεις ή αναβαθμίσεις του macOS, το macOS δημιουργεί ένα νέο στιγμιότυπο του συστήματος. Ο όγκος εκκίνησης του macOS χ
```bash
csrutil authenticated-root status
Authenticated Root status: enabled
```
Επιπλέον, το δίσκος αντιγράφου ασφαλείας επίσης προσαρτάται ως **μόνο για ανάγνωση**:
```
mount
/dev/disk3s1s1 on / (apfs, sealed, local, read-only, journaled)
```
<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
