# macOS SIP

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдкрд░ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## **рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА**

**System Integrity Protection (SIP)** macOS рдореЗрдВ рдПрдХ рд╕реБрд░рдХреНрд╖рд╛ рдкреНрд░реМрджреНрдпреЛрдЧрд┐рдХреА рд╣реИ рдЬреЛ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдБрдЪ рд╕реЗ рдХреБрдЫ рд╕рд┐рд╕реНрдЯрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдХреА рд░рдХреНрд╖рд╛ рдХрд░рддреА рд╣реИ, рдпрд╣рд╛рдБ рддрдХ рдХрд┐ рд░реВрдЯ рдпреВрдЬрд╝рд░ рдХреЗ рд▓рд┐рдП рднреАред рдпрд╣ рдЗрди рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдореЗрдВ рдлрд╛рдЗрд▓реЛрдВ рдХреЗ рдирд┐рд░реНрдорд╛рдг, рдкрд░рд┐рд╡рд░реНрддрди, рдпрд╛ рд╣рдЯрд╛рдиреЗ рд╕рд╣рд┐рдд рд╕рдВрд╢реЛрдзрдиреЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИред SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдореБрдЦреНрдп рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рд╣реИрдВ:

* **/System**
* **/bin**
* **/sbin**
* **/usr**

рдЗрди рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдФрд░ рдЙрдирдХреА рд╕рдмрдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдХреЗ рд▓рд┐рдП рд╕реБрд░рдХреНрд╖рд╛ рдирд┐рдпрдо **`/System/Library/Sandbox/rootless.conf`** рдлрд╛рдЗрд▓ рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИрдВред рдЗрд╕ рдлрд╛рдЗрд▓ рдореЗрдВ, рдПрдХ рддрд╛рд░рд╛рдВрдХрди (\*) рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкрде SIP рдХреА рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЗ рдЕрдкрд╡рд╛рдж рдХреЛ рджрд░реНрд╢рд╛рддреЗ рд╣реИрдВред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди:
```javascript
/usr
* /usr/libexec/cups
* /usr/local
* /usr/share/man
```
рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ **`/usr`** рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдЖрдо рддреМрд░ рдкрд░ SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╣реЛрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рддреАрди рдЙрдкрдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рд╕рдВрд╢реЛрдзрди рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ (`/usr/libexec/cups`, `/usr/local`, рдФрд░ `/usr/share/man`), рдХреНрдпреЛрдВрдХрд┐ рд╡реЗ рдПрдХ рдЕрдЧреНрд░рдгреА рддрд╛рд░рд╛рдВрдХрди (\*) рдХреЗ рд╕рд╛рде рд╕реВрдЪреАрдмрджреНрдз рд╣реИрдВред

SIP рджреНрд╡рд╛рд░рд╛ рдХрд┐рд╕реА рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдпрд╛ рдлрд╝рд╛рдЗрд▓ рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдк **`ls -lOd`** рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **`restricted`** рдпрд╛ **`sunlnk`** рдлреНрд▓реИрдЧ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:
```bash
ls -lOd /usr/libexec/cups
drwxr-xr-x  11 root  wheel  sunlnk 352 May 13 00:29 /usr/libexec/cups
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, **`sunlnk`** рдлреНрд▓реИрдЧ рдХрд╛ рддрд╛рддреНрдкрд░реНрдп рд╣реИ рдХрд┐ `/usr/libexec/cups` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реНрд╡рдпрдВ **рд╣рдЯрд╛рдИ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддреА**, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕рдХреЗ рдЕрдВрджрд░ рдХреА рдлрд╛рдЗрд▓реЗрдВ рдмрдирд╛рдИ, рд╕рдВрд╢реЛрдзрд┐рдд, рдпрд╛ рд╣рдЯрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред

рджреВрд╕рд░реА рдУрд░:
```bash
ls -lOd /usr/libexec
drwxr-xr-x  338 root  wheel  restricted 10816 May 13 00:29 /usr/libexec
```
рдпрд╣рд╛рдБ, **`restricted`** рдлреНрд▓реИрдЧ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ `/usr/libexec` рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╣реИред SIP-рд╕рдВрд░рдХреНрд╖рд┐рдд рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ, рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдмрдирд╛рдпрд╛, рд╕рдВрд╢реЛрдзрд┐рдд, рдпрд╛ рд╣рдЯрд╛рдпрд╛ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдХрд┐рд╕реА рдлрд╛рдЗрд▓ рдореЗрдВ **`com.apple.rootless`** рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд **рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ** рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдлрд╛рдЗрд▓ рднреА **SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд** рд╣реЛрдЧреАред

**SIP рдЕрдиреНрдп рд░реВрдЯ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рднреА рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИ** рдЬреИрд╕реЗ:

* рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХреЛ рд▓реЛрдб рдХрд░рдирд╛
* Apple-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдЯрд╛рд╕реНрдХ-рдкреЛрд░реНрдЯреНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛
* NVRAM рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдореЗрдВ рд╕рдВрд╢реЛрдзрди рдХрд░рдирд╛
* рдХрд░реНрдиреЗрд▓ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛

рд╡рд┐рдХрд▓реНрдк nvram рд╡реЗрд░рд┐рдПрдмрд▓ рдореЗрдВ рдПрдХ рдмрд┐рдЯрдлреНрд▓реИрдЧ рдХреЗ рд░реВрдк рдореЗрдВ рд░рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ (`csr-active-config` Intel рдкрд░ рдФрд░ `lp-sip0` ARM рдХреЗ рд▓рд┐рдП рдмреВрдЯреЗрдб рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА рд╕реЗ рдкрдврд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ)ред рдЖрдк рдлреНрд▓реИрдЧреНрд╕ рдХреЛ XNU рд╕реЛрд░реНрд╕ рдХреЛрдб рдореЗрдВ `csr.sh` рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../.gitbook/assets/image (720).png" alt=""><figcaption></figcaption></figure>

### SIP рд╕реНрдерд┐рддрд┐

рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ SIP рд╕рдХреНрд╖рдо рд╣реИ рдпрд╛ рдирд╣реАрдВ:
```bash
csrutil status
```
рдпрджрд┐ рдЖрдкрдХреЛ SIP рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд░рд┐рдХрд╡рд░реА рдореЛрдб рдореЗрдВ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░рдирд╛ рд╣реЛрдЧрд╛ (рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдХреЗ рджреМрд░рд╛рди Command+R рджрдмрд╛рдХрд░), рдлрд┐рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ:
```bash
csrutil disable
```
рдпрджрд┐ рдЖрдк SIP рд╕рдХреНрд╖рдо рд░рдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рд╛рде рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
csrutil enable --without debug
```
### рдЕрдиреНрдп рдкреНрд░рддрд┐рдмрдВрдз

SIP рдХрдИ рдЕрдиреНрдп рдкреНрд░рддрд┐рдмрдВрдз рднреА рд▓рдЧрд╛рддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрд╣ **unsigned kernel extensions** (kexts) рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛ рдФрд░ macOS рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЛрд╕реЗрд╕реЗрд╕ рдХреА **debugging** рдХреЛ рд░реЛрдХрддрд╛ рд╣реИред рдпрд╣ dtrace рдЬреИрд╕реЗ рдЯреВрд▓реНрд╕ рдХреЛ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░реЛрд╕реЗрд╕реЗрд╕ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рд╕реЗ рднреА рд░реЛрдХрддрд╛ рд╣реИред

[рдЗрд╕ рдЯреЙрдХ рдореЗрдВ рдФрд░ SIP рдЬрд╛рдирдХрд╛рд░реА](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship).

## SIP Bypasses

рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдпрд╣ рдХрд░ рд╕рдХреЗрдЧрд╛:

* рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдореЗрд▓, рд╕рдВрджреЗрд╢, Safari рдЗрддрд┐рд╣рд╛рд╕... рдкрдврд╝реЗрдВ
* рд╡реЗрдмрдХреИрдо, рдорд╛рдЗрдХреНрд░реЛрдлреЛрди рдпрд╛ рдХреБрдЫ рднреА рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдкреНрд░рджрд╛рди рдХрд░реЗрдВ (SIP рд╕рдВрд░рдХреНрд╖рд┐рдд TCC рдбреЗрдЯрд╛рдмреЗрд╕ рдкрд░ рд╕реАрдзреЗ рд▓рд┐рдЦрдХрд░) - TCC bypass
* Persistence: рд╡рд╣ рдореИрд▓рд╡реЗрдпрд░ рдХреЛ SIP рд╕рдВрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рдкрд░ рд╕рд╣реЗрдЬ рд╕рдХрддрд╛ рд╣реИ рдФрд░ toot рднреА рдЗрд╕реЗ рд╣рдЯрд╛ рдирд╣реАрдВ рдкрд╛рдПрдЧрд╛ред рд╕рд╛рде рд╣реА рд╡рд╣ MRT рдХреЗ рд╕рд╛рде рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ рдХрд░ рд╕рдХрддрд╛ рд╣реИред
* Kernel extensions рд▓реЛрдб рдХрд░рдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛ (рдЗрд╕рдХреЗ рд▓рд┐рдП рдЕрдиреНрдп рдХрдареЛрд░ рд╕реБрд░рдХреНрд╖рд╛ рднреА рдореМрдЬреВрдж рд╣реИрдВ)ред

### Installer Packages

**Apple рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд Installer packages** рдЗрд╕рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдорд╛рдирдХ рдбреЗрд╡рд▓рдкрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреИрдХреЗрдЬ рднреА рдмреНрд▓реЙрдХ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ рдпрджрд┐ рд╡реЗ SIP-рд╕рдВрд░рдХреНрд╖рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдореЗрдВ рд╕рдВрд╢реЛрдзрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВред

### Inexistent SIP file

рдПрдХ рд╕рдВрднрд╛рд╡рд┐рдд рдЫреЗрдж рдпрд╣ рд╣реИ рдХрд┐ рдпрджрд┐ рдХреЛрдИ рдлрд╝рд╛рдЗрд▓ **`rootless.conf` рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИ рд▓реЗрдХрд┐рди рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ**, рддреЛ рдЗрд╕реЗ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдореИрд▓рд╡реЗрдпрд░ рдЗрд╕рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛рдХрд░ рд╕рд┐рд╕реНрдЯрдо рдкрд░ **persistence рд╕реНрдерд╛рдкрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдкреНрд░реЛрдЧреНрд░рд╛рдо `/System/Library/LaunchDaemons` рдореЗрдВ рдПрдХ .plist рдлрд╝рд╛рдЗрд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдпрджрд┐ рдпрд╣ `rootless.conf` рдореЗрдВ рд╕реВрдЪреАрдмрджреНрдз рд╣реИ рд▓реЗрдХрд┐рди рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИред

### com.apple.rootless.install.heritable

{% hint style="danger" %}
рдкреНрд░рддрд┐рдмрдВрдз **`com.apple.rootless.install.heritable`** SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
{% endhint %}

#### Shrootless

[**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдХреЗ рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ рдиреЗ**](https://www.microsoft.com/en-us/security/blog/2021/10/28/microsoft-finds-new-macos-vulnerability-shrootless-that-could-bypass-system-integrity-protection/) macOS рдХреЗ System Integrity Protection (SIP) рддрдВрддреНрд░ рдореЗрдВ рдПрдХ рдХрдордЬреЛрд░реА рдХреА рдЦреЛрдЬ рдХреА, рдЬрд┐рд╕реЗ 'Shrootless' рдХрдордЬреЛрд░реА рдХрд╣рд╛ рдЧрдпрд╛ред рдпрд╣ рдХрдордЬреЛрд░реА **`system_installd`** рдбреЗрдореЙрди рдХреЗ рдЖрд╕рдкрд╛рд╕ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдкреНрд░рддрд┐рдмрдВрдз, **`com.apple.rootless.install.heritable`**, рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдЗрд╕рдХреЗ рдЪрд╛рдЗрд▓реНрдб рдкреНрд░реЛрд╕реЗрд╕реЗрд╕ рдХреЛ SIP рдХреЗ рдлрд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**`system_installd`** рдбреЗрдореЙрди **Apple** рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреИрдХреЗрдЬреЛрдВ рдХреЛ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░реЗрдЧрд╛ред

рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ рдиреЗ рдкрд╛рдпрд╛ рдХрд┐ Apple-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреИрдХреЗрдЬ (.pkg рдлрд╝рд╛рдЗрд▓) рдХреА рд╕реНрдерд╛рдкрдирд╛ рдХреЗ рджреМрд░рд╛рди, **`system_installd`** рдкреИрдХреЗрдЬ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд┐рд╕реА рднреА **post-install** рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ **рдЪрд▓рд╛рддрд╛ рд╣реИ**ред рдпреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╢реЗрд▓, **`zsh`** рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдЬреЛ рдЧреИрд░-рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдореЛрдб рдореЗрдВ рднреА, рдпрджрд┐ **`/etc/zshenv`** рдлрд╝рд╛рдЗрд▓ рдореМрдЬреВрдж рд╣реИ, рддреЛ рдЗрд╕рд╕реЗ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ **рдЪрд▓рд╛рддрд╛ рд╣реИ**ред рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рд╢реЛрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг `/etc/zshenv` рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдХрд░ рдФрд░ **`system_installd` рдХреЗ `zsh` рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХрд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░рдХреЗ**, рд╡реЗ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ рдордирдорд╛рдиреЗ рдСрдкрд░реЗрд╢рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рдХрд┐ **`/etc/zshenv` рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓рд╛ рддрдХрдиреАрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**, рдХреЗрд╡рд▓ SIP рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рд▓рд┐рдП рдирд╣реАрдВред рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ `~/.zshenv` рдлрд╝рд╛рдЗрд▓ рд╣реЛрддреА рд╣реИ, рдЬреЛ `/etc/zshenv` рдХреА рддрд░рд╣ рд╣реА рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддреА рд╣реИ рд▓реЗрдХрд┐рди рдЗрд╕рдХреЗ рд▓рд┐рдП рд░реВрдЯ рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреАред рдпрд╣ рдлрд╝рд╛рдЗрд▓ `zsh` рд╢реБрд░реВ рд╣реЛрдиреЗ рдкрд░ рд╣рд░ рдмрд╛рд░ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкрд░реНрд╕рд┐рд╕реНрдЯреЗрдВрд╕ рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдпрд╛ рдПрдХ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд▓рд┐рд╡реЗрд╢рди рдореИрдХреЗрдирд┐рдЬрд╝реНрдо рдХреЗ рд░реВрдк рдореЗрдВред рдпрджрд┐ рдПрдХ рдПрдбрдорд┐рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ `sudo -s` рдпрд╛ `sudo <command>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд░реВрдЯ рдореЗрдВ рдПрд▓рд┐рд╡реЗрдЯ рдХрд░рддрд╛ рд╣реИ, рддреЛ `~/.zshenv` рдлрд╝рд╛рдЗрд▓ рдЯреНрд░рд┐рдЧрд░ рд╣реЛ рдЬрд╛рдПрдЧреА, рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рд░реВрдЯ рдореЗрдВ рдПрд▓рд┐рд╡реЗрдЯ рд╣реЛ рдЬрд╛рдПрдЧреАред

#### [**CVE-2022-22583**](https://perception-point.io/blog/technical-analysis-cve-2022-22583/)

[**CVE-2022-22583**](https://perception-point.io/blog/technical-analysis-cve-2022-22583/) рдореЗрдВ рдпрд╣ рдкрддрд╛ рдЪрд▓рд╛ рдХрд┐ рд╡рд╣реА **`system_installd`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрднреА рднреА рджреБрд░реБрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **post-install script рдХреЛ `/tmp` рдХреЗ рдЕрдВрджрд░ SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдирд╛рдо рд╡рд╛рд▓реЗ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдЕрдВрджрд░ рд░рдЦ рд░рд╣реА рдереА**ред рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ **`/tmp` рдЦреБрдж SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рдерд╛ рдХрд┐ **рд╡рд░реНрдЪреБрдЕрд▓ рдЗрдореЗрдЬ рдХреЛ рдЗрд╕ рдкрд░ рдорд╛рдЙрдВрдЯ** рдХрд┐рдпрд╛ рдЬрд╛рдП, рдлрд┐рд░ **installer** рд╡рд╣рд╛рдВ рдкрд░ **post-install script** рдбрд╛рд▓реЗрдЧрд╛, **рд╡рд░реНрдЪреБрдЕрд▓ рдЗрдореЗрдЬ рдХреЛ рдЕрдирдорд╛рдЙрдВрдЯ** рдХрд░реЗрдЧрд╛, рд╕рднреА **рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдХреЛ рдкреБрдирдГ рдмрдирд╛рдПрдЧрд╛** рдФрд░ **post installation** рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ **payload** рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝ рджреЗрдЧрд╛ рдЬрд┐рд╕реЗ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рд╣реИред

#### [fsck\_cs utility](https://www.theregister.com/2016/03/30/apple_os_x_rootless/)

рдмрд╛рдпрдкрд╛рд╕ рдиреЗ рдЗрд╕ рддрдереНрдп рдХрд╛ рд╢реЛрд╖рдг рдХрд┐рдпрд╛ рдХрд┐ **`fsck_cs`** **symbolic links** рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдЧрд╛ рдФрд░ рдЙрд╕реЗ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдП рдЧрдП рдлрд╛рдЗрд▓рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдареАрдХ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдЧрд╛ред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ _`/dev/diskX`_ рд╕реЗ `/System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist` рдХреА рдУрд░ рдПрдХ symbolic link рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдкреВрд░реНрд╡ рдкрд░ **`fsck_cs`** рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЬреИрд╕реЗ рд╣реА `Info.plist` рдлрд╝рд╛рдЗрд▓ рднреНрд░рд╖реНрдЯ рд╣реЛ рдЬрд╛рддреА рд╣реИ, рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдЕрдм **kernel extension exclusions рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░ рдкрд╛рдПрдЧрд╛**, рдЗрд╕ рдкреНрд░рдХрд╛рд░ SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рджреЗрдЧрд╛ред

{% code overflow="wrap" %}
```bash
ln -s /System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist /dev/diskX
fsck_cs /dev/diskX 1>&-
touch /Library/Extensions/
reboot
```
{% endcode %}

рдЙрдкрд░реЛрдХреНрдд Info.plist рдлрд╝рд╛рдЗрд▓, рдЬреЛ рдЕрдм рдирд╖реНрдЯ рд╣реЛ рдЪреБрдХреА рд╣реИ, **SIP рджреНрд╡рд╛рд░рд╛ рдХреБрдЫ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХреЛ рд╡реНрд╣рд╛рдЗрдЯрд▓рд┐рд╕реНрдЯ рдХрд░рдиреЗ** рдФрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **рдЕрдиреНрдпреЛрдВ рдХреЛ рд▓реЛрдб рд╣реЛрдиреЗ рд╕реЗ рд░реЛрдХрдиреЗ** рдХреЗ рд▓рд┐рдП рдкреНрд░рдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИред рдпрд╣ рд╕рд╛рдорд╛рдиреНрдпрддрдГ Apple рдХреЗ рдЕрдкрдиреЗ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди **`AppleHWAccess.kext`** рдХреЛ рдмреНрд▓реИрдХрд▓рд┐рд╕реНрдЯ рдХрд░рддреА рд╣реИ, рдкрд░рдВрддреБ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЗ рдирд╖реНрдЯ рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдо рдЗрд╕реЗ рд▓реЛрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рд┐рд╕реНрдЯрдо RAM рдореЗрдВ рдЬреИрд╕реЗ рдЪрд╛рд╣реЗрдВ рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

#### [SIP рд╕рдВрд░рдХреНрд╖рд┐рдд рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship)

**SIP рд╕рдВрд░рдХреНрд╖рд┐рдд рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдкрд░ рдирдИ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рдХреЗ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛** рд╕рдВрднрд╡ рдерд╛ред
```bash
mkdir evil
# Add contento to the folder
hdiutil create -srcfolder evil evil.dmg
hdiutil attach -mountpoint /System/Library/Snadbox/ evil.dmg
```
#### [рдЕрдкрдЧреНрд░реЗрдбрд░ рдмрд╛рдпрдкрд╛рд╕ (2016)](https://objective-see.org/blog/blog\_0x14.html)

рдЬрдм рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЕрдкрдЧреНрд░реЗрдб/рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `Install macOS Sierra.app`) рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдПрдХ рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдбрд┐рд╕реНрдХ рдЗрдореЗрдЬ рд╕реЗ рдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯрдЕрдк рдХрд░рддрд╛ рд╣реИ (рдЬреЛ рдбрд╛рдЙрдирд▓реЛрдб рдХрд┐рдП рдЧрдП рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рднреАрддрд░ рдПрдореНрдмреЗрдбреЗрдб рд╣реЛрддрд╛ рд╣реИ)ред рдпрд╣ рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдбрд┐рд╕реНрдХ рдЗрдореЗрдЬ OS рдХреЛ рдЕрдкрдЧреНрд░реЗрдб рдХрд░рдиреЗ рдХреЗ рд▓реЙрдЬрд┐рдХ рдХреЛ рд╕рдорд╛рд╣рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП OS X El Capitan рд╕реЗ macOS Sierra рддрдХред

рдЕрдкрдЧреНрд░реЗрдб/рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдЗрдореЗрдЬ (`InstallESD.dmg`) рд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, `Install macOS Sierra.app` **`bless`** рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ (рдЬреЛ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ `com.apple.rootless.install.heritable` рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ):

{% code overflow="wrap" %}
```bash
/usr/sbin/bless -setBoot -folder /Volumes/Macintosh HD/macOS Install Data -bootefi /Volumes/Macintosh HD/macOS Install Data/boot.efi -options config="\macOS Install Data\com.apple.Boot" -label macOS Installer
```
{% endcode %}

рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЕрдкрдЧреНрд░реЗрдб рдЗрдореЗрдЬ (`InstallESD.dmg`) рдХреЛ рд╕рд┐рд╕реНрдЯрдо рдмреВрдЯ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдореЙрдбрд┐рдлрд╛рдИ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдЗрдореЗрдЬ рдХреЛ рдореЙрдбрд┐рдлрд╛рдИ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдпрд╣ рдерд╛ рдХрд┐ рдПрдХ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓реЛрдбрд░ (dyld) рдХреЛ рдмрджрд▓ рджрд┐рдпрд╛ рдЬрд╛рдП рдЬреЛ рдирд╛рд╕рдордЭреА рд╕реЗ рдореИрд▓рд┐рд╢рд╕ dylib рдХреЛ рд▓реЛрдб рдФрд░ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдХрд░реЗрдЧрд╛, рдЬреИрд╕реЗ рдХрд┐ **`libBaseIA`** dylibред рдЗрд╕рд▓рд┐рдП, рдЬрдм рднреА рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдЕрд░реНрдерд╛рддреН рд╕рд┐рд╕реНрдЯрдо рдХреЛ рдЕрдкрдЧреНрд░реЗрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП) рд╣рдорд╛рд░рд╛ рдореИрд▓рд┐рд╢рд╕ dylib (рдЬрд┐рд╕рдХрд╛ рдирд╛рдо libBaseIA.dylib рд╣реИ) рднреА рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдореЗрдВ рд▓реЛрдб рдФрд░ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рд╣реЛрдЧрд╛ред

рдЕрдм 'рдЕрдВрджрд░' рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ, рд╣рдо рдЕрдкрдЧреНрд░реЗрдб рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЗрд╕ рдЪрд░рдг рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЪреВрдВрдХрд┐ рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдЗрдореЗрдЬ рдХреЛ 'рдмреНрд▓реЗрд╕' рдХрд░реЗрдЧрд╛, рд╣рдореЗрдВ рдмрд╕ рдЗрддрдирд╛ рдХрд░рдирд╛ рд╣реИ рдХрд┐ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдЗрдореЗрдЬ, **`InstallESD.dmg`**, рдХреЛ рд╕рдмрд╡рд░реНрдЯ рдХрд░ рджреЗрдВред рдпрд╣ **`extractBootBits`** рдореЗрдердб рдХреЛ рдореЗрдердб рд╕реНрд╡рд┐рдЬрд▓рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рд╣реБрдХ рдХрд░рдХреЗ рд╕рдВрднрд╡ рдерд╛ред\
рдореИрд▓рд┐рд╢рд╕ рдХреЛрдб рдХреЛ рдбрд┐рд╕реНрдХ рдЗрдореЗрдЬ рдХреЗ рдЙрдкрдпреЛрдЧ рд╕реЗ рдареАрдХ рдкрд╣рд▓реЗ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕реЗ рдЗрдиреНрдлреЗрдХреНрдЯ рдХрд░рдиреЗ рдХрд╛ рд╕рдордп рд╣реИред

`InstallESD.dmg` рдХреЗ рдЕрдВрджрд░ рдПрдХ рдФрд░ рдПрдореНрдмреЗрдбреЗрдб рдбрд┐рд╕реНрдХ рдЗрдореЗрдЬ `BaseSystem.dmg` рд╣реИ рдЬреЛ рдЕрдкрдЧреНрд░реЗрдб рдХреЛрдб рдХреА 'рд░реВрдЯ рдлрд╛рдЗрд▓-рд╕рд┐рд╕реНрдЯрдо' рд╣реИред рдпрд╣ рд╕рдВрднрд╡ рдерд╛ рдХрд┐ `BaseSystem.dmg` рдореЗрдВ рдПрдХ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЗрдВрдЬреЗрдХреНрдЯ рдХреА рдЬрд╛рдП рддрд╛рдХрд┐ рдореИрд▓рд┐рд╢рд╕ рдХреЛрдб OS-рд▓реЗрд╡рд▓ рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдореЙрдбрд┐рдлрд╛рдИ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдкреНрд░реЛрд╕реЗрд╕ рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реЛред

#### [systemmigrationd (2023)](https://www.youtube.com/watch?v=zxZesAN-TEk)

[**DEF CON 31**](https://www.youtube.com/watch?v=zxZesAN-TEk) рд╕реЗ рдЗрд╕ рдЯреЙрдХ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдХреИрд╕реЗ **`systemmigrationd`** (рдЬреЛ SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ) рдПрдХ **bash** рдФрд░ рдПрдХ **perl** рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдПрдХреНрдЬреАрдХреНрдпреВрдЯ рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ env рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ **`BASH_ENV`** рдФрд░ **`PERL5OPT`** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### **com.apple.rootless.install**

{% hint style="danger" %}
рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ **`com.apple.rootless.install`** SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
{% endhint %}

[**CVE-2022-26712**](https://jhftss.github.io/CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/) рд╕реЗ, рд╕рд┐рд╕реНрдЯрдо XPC рд╕рд░реНрд╡рд┐рд╕ `/System/Library/PrivateFrameworks/ShoveService.framework/Versions/A/XPCServices/SystemShoveService.xpc` рдореЗрдВ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ **`com.apple.rootless.install`** рд╣реИ, рдЬреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХреЛ SIP рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдпрд╣ **рдХрд┐рд╕реА рднреА рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ рдХреЗ рдмрд┐рдирд╛ рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдореВрд╡ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рднреА рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред**

## Sealed System Snapshots

Sealed System Snapshots рдПрдХ рдлреАрдЪрд░ рд╣реИ рдЬрд┐рд╕реЗ Apple рдиреЗ **macOS Big Sur (macOS 11)** рдореЗрдВ рдкреЗрд╢ рдХрд┐рдпрд╛ рдерд╛, рдЬреЛ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ рд╕рд┐рд╕реНрдЯрдо рд╕реНрдерд┐рд░рддрд╛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **System Integrity Protection (SIP)** рддрдВрддреНрд░ рдХрд╛ рд╣рд┐рд╕реНрд╕рд╛ рд╣реИред рдпреЗ рдореВрд▓ рд░реВрдк рд╕реЗ рд╕рд┐рд╕реНрдЯрдо рд╡реЙрд▓реНрдпреВрдо рдХреЗ рд░реАрдб-рдУрдирд▓реА рд╕рдВрд╕реНрдХрд░рдг рд╣реИрдВред

рдпрд╣рд╛рдБ рдПрдХ рд╡рд┐рд╕реНрддреГрдд рдирдЬрд╝рд░ рд╣реИ:

1. **Immutable System**: Sealed System Snapshots macOS рд╕рд┐рд╕реНрдЯрдо рд╡реЙрд▓реНрдпреВрдо рдХреЛ "immutable" рдмрдирд╛рддреЗ рд╣реИрдВ, рдпрд╛рдиреА рдХрд┐ рдЗрд╕реЗ рдореЙрдбрд┐рдлрд╛рдИ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдореЗрдВ рдХрд┐рд╕реА рднреА рдЕрдирдзрд┐рдХреГрдд рдпрд╛ рдЖрдХрд╕реНрдорд┐рдХ рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рд░реЛрдХрддрд╛ рд╣реИ рдЬреЛ рд╕реБрд░рдХреНрд╖рд╛ рдпрд╛ рд╕рд┐рд╕реНрдЯрдо рд╕реНрдерд┐рд░рддрд╛ рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
2. **System Software Updates**: рдЬрдм рдЖрдк macOS рдЕрдкрдбреЗрдЯреНрд╕ рдпрд╛ рдЕрдкрдЧреНрд░реЗрдбреНрд╕ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рддреЗ рд╣реИрдВ, macOS рдПрдХ рдирдпрд╛ рд╕рд┐рд╕реНрдЯрдо рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛рддрд╛ рд╣реИред macOS рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рд╡реЙрд▓реНрдпреВрдо рдлрд┐рд░ **APFS (Apple File System)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рдирдП рд╕реНрдиреИрдкрд╢реЙрдЯ рдкрд░ рд╕реНрд╡рд┐рдЪ рдХрд░рддрд╛ рд╣реИред рдЕрдкрдбреЗрдЯреНрд╕ рд▓рд╛рдЧреВ рдХрд░рдиреЗ рдХреА рдкреВрд░реА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рдФрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рд╣реЛ рдЬрд╛рддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рд╕рд┐рд╕реНрдЯрдо рд╣рдореЗрд╢рд╛ рдЕрдкрдбреЗрдЯ рдХреЗ рджреМрд░рд╛рди рдХреБрдЫ рдЧрд▓рдд рд╣реЛрдиреЗ рдкрд░ рдкрд┐рдЫрд▓реЗ рд╕реНрдиреИрдкрд╢реЙрдЯ рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
3. **Data Separation**: macOS Catalina рдореЗрдВ рдкреЗрд╢ рдХрд┐рдП рдЧрдП рдбреЗрдЯрд╛ рдФрд░ рд╕рд┐рд╕реНрдЯрдо рд╡реЙрд▓реНрдпреВрдо рд╕реЗрдкрд░реЗрд╢рди рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рдХреЗ рд╕рд╛рде, Sealed System Snapshot рдлреАрдЪрд░ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЖрдкрдХрд╛ рд╕рд╛рд░рд╛ рдбреЗрдЯрд╛ рдФрд░ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдПрдХ рдЕрд▓рдЧ "**Data**" рд╡реЙрд▓реНрдпреВрдо рдкрд░ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреЗ рд╣реИрдВред рдпрд╣ рдЕрд▓рдЧрд╛рд╡ рдЖрдкрдХреЗ рдбреЗрдЯрд╛ рдХреЛ рд╕рд┐рд╕реНрдЯрдо рд╕реЗ рд╕реНрд╡рддрдВрддреНрд░ рдмрдирд╛рддрд╛ рд╣реИ, рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдЕрдкрдбреЗрдЯреНрд╕ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рд░рд▓ рдмрдирд╛рддрд╛ рд╣реИ рдФрд░ рд╕рд┐рд╕реНрдЯрдо рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрдврд╝рд╛рддрд╛ рд╣реИред

рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдпреЗ рд╕реНрдиреИрдкрд╢реЙрдЯреНрд╕ macOS рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдкреНрд░рдмрдВрдзрд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдФрд░ APFS рдХреА рд╕реНрдкреЗрд╕ рд╢реЗрдпрд░рд┐рдВрдЧ рдХреНрд╖рдорддрд╛рдУрдВ рдХреЗ рдХрд╛рд░рдг рдЖрдкрдХреА рдбрд┐рд╕реНрдХ рдкрд░ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реНрдерд╛рди рдирд╣реАрдВ рд▓реЗрддреЗ рд╣реИрдВред рдпрд╣ рднреА рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдпреЗ рд╕реНрдиреИрдкрд╢реЙрдЯреНрд╕ **Time Machine рд╕реНрдиреИрдкрд╢реЙрдЯреНрд╕** рд╕реЗ рдЕрд▓рдЧ рд╣реИрдВ, рдЬреЛ рдкреВрд░реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рдпреВрдЬрд░-рдПрдХреНрд╕реЗрд╕рд┐рдмрд▓ рдмреИрдХрдЕрдкреНрд╕ рд╣реИрдВред

### Check Snapshots

рдХрдорд╛рдВрдб **`diskutil apfs list`** APFS рд╡реЙрд▓реНрдпреВрдореНрд╕ рдХреЗ **рд╡рд┐рд╡рд░рдгреЛрдВ рдФрд░ рдЙрдирдХреЗ рд▓реЗрдЖрдЙрдЯ** рдХреЛ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рддрд╛ рд╣реИ:

<pre><code>+-- Container disk3 966B902E-EDBA-4775-B743-CF97A0556A13
|   ====================================================
|   APFS Container Reference:     disk3
|   Size (Capacity Ceiling):      494384795648 B (494.4 GB)
|   Capacity In Use By Volumes:   219214536704 B (219.2 GB) (44.3% used)
|   Capacity Not Allocated:       275170258944 B (275.2 GB) (55.7% free)
|   |
|   +-&#x3C; Physical Store disk0s2 86D4B7EC-6FA5-4042-93A7-D3766A222EBE
|   |   -----------------------------------------------------------
|   |   APFS Physical Store Disk:   disk0s2
|   |   Size:                       494384795648 B (494.4 GB)
|   |
|   +-> Volume disk3s1 7A27E734-880F-4D91-A703-FB55861D49B7
|   |   ---------------------------------------------------
<strong>|   |   APFS Volume Disk (Role):   disk3s1 (System)
</strong>|   |   Name:                      Macintosh HD (Case-insensitive)
<strong>|   |   Mount Point:               /System/Volumes/Update/mnt1
</strong>|   |   Capacity Consumed:         12819210240 B (12.8 GB)
|   |   Sealed:                    Broken
|   |   FileVault:                 Yes (Unlocked)
|   |   Encrypted:                 No
|   |   |
|   |   Snapshot:                  FAA23E0C-791C-43FF-B0E7-0E1C0810AC61
|   |   Snapshot Disk:             disk3s1s1
<strong>|   |   Snapshot Mount Point:      /
</strong><strong>|   |   Snapshot Sealed:           Yes
</strong>[...]
+-> Volume disk3s5 281959B7-07A1-4940-BDDF-6419360F3327
|   ---------------------------------------------------
|   APFS Volume Disk (Role):   disk3s5 (Data)
|   Name:                      Macintosh HD - Data (Case-insensitive)
<strong>    |   Mount Point:               /System/Volumes/Data
</strong><strong>    |   Capacity Consumed:         412071784448 B (412.1 GB)
</strong>    |   Sealed:                    No
|   FileVault:                 Yes (Unlocked)
</code></pre>

рдкрд┐рдЫрд▓реЗ рдЖрдЙрдЯрдкреБрдЯ рдореЗрдВ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдпреВрдЬрд░-рдПрдХреНрд╕реЗрд╕рд┐рдмрд▓ рд▓реЛрдХреЗрд╢рдиреНрд╕** `/System/Volumes/Data` рдХреЗ рддрд╣рдд рдорд╛рдЙрдВрдЯ рдХрд┐рдП рдЧрдП рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, **macOS рд╕рд┐рд╕реНрдЯрдо рд╡реЙрд▓реНрдпреВрдо рд╕реНрдиреИрдкрд╢реЙрдЯ** `/` рдореЗрдВ рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдпрд╣ **рд╕реАрд▓реНрдб** рд╣реИ (OS рджреНрд╡рд╛рд░рд╛ рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХрд▓реА рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛)ред рдЗрд╕рд▓рд┐рдП, рдЕрдЧрд░ SIP рдмрд╛рдпрдкрд╛рд╕ рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдореЙрдбрд┐рдлрд╛рдИ рдХрд░рддрд╛ рд╣реИ, рддреЛ **OS рдЕрдм рдмреВрдЯ рдирд╣реАрдВ рд╣реЛрдЧрд╛**ред

рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рд╕реАрд▓ рд╕рдХреНрд╖рдо рд╣реИ рдпрд╣ рд╡реЗрд░рд┐рдлрд╛рдИ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдЪрд▓рд╛рдПрдВ:
```bash
csrutil authenticated-root status
Authenticated Root status: enabled
```
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╕реНрдиреИрдкрд╢реЙрдЯ рдбрд┐рд╕реНрдХ рдХреЛ **read-only** рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```
mount
/dev/disk3s1s1 on / (apfs, sealed, local, read-only, journaled)
```
<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╢реЗрдпрд░ рдХрд░реЗрдВред

</details>
