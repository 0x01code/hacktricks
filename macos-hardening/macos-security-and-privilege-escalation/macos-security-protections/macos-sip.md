# macOS SIP

{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) рдПрдХ **рдбрд╛рд░реНрдХ-рд╡реЗрдм** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╕рд░реНрдЪ рдЗрдВрдЬрди рд╣реИ рдЬреЛ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП **рдлреНрд░реА** рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХрд┐рд╕реА рдХрдВрдкрдиреА рдпрд╛ рдЙрд╕рдХреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ **рд╕рдордЭреМрддрд╛** рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ **рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░** рджреНрд╡рд╛рд░рд╛ред

WhiteIntel рдХрд╛ рдкреНрд░рд╛рдердорд┐рдХ рд▓рдХреНрд╖реНрдп рдЬрд╛рдирдХрд╛рд░реА-рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░ рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдЕрдХрд╛рдЙрдВрдЯ рдЯреЗрдХрдУрд╡рд░ рдФрд░ рд░реИрдирд╕рдорд╡реЗрдпрд░ рд╣рдорд▓реЛрдВ рд╕реЗ рд▓рдбрд╝рдирд╛ рд╣реИред

рдЖрдк рдЙрдирдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдлреНрд░реА** рдореЗрдВ рдЙрдирдХреЗ рдЗрдВрдЬрди рдХреЛ рдЖрдЬрдорд╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% embed url="https://whiteintel.io" %}

***

## **Basic Information**

**рд╕рд┐рд╕реНрдЯрдо рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рдкреНрд░реЛрдЯреЗрдХреНрд╢рди (SIP)** macOS рдореЗрдВ рдПрдХ рддрдВрддреНрд░ рд╣реИ рдЬрд┐рд╕реЗ рдкреНрд░рдореБрдЦ рд╕рд┐рд╕реНрдЯрдо рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдореЗрдВ рдЕрдирдзрд┐рдХреГрдд рдкрд░рд┐рд╡рд░реНрддрдиреЛрдВ рдХреЛ рд░реЛрдХрдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдЬрд╝рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд╕рдмрд╕реЗ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рд╕реЗ рднреАред рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рд╕рд┐рд╕реНрдЯрдо рдХреА рдЕрдЦрдВрдбрддрд╛ рдмрдирд╛рдП рд░рдЦрдиреЗ рдореЗрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рднреВрдорд┐рдХрд╛ рдирд┐рднрд╛рддреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рд╕рдВрд░рдХреНрд╖рд┐рдд рдХреНрд╖реЗрддреНрд░реЛрдВ рдореЗрдВ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдЬреЛрдбрд╝рдирд╛, рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ рдпрд╛ рд╣рдЯрд╛рдирд╛ред SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдкреНрд░рдореБрдЦ рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* **/System**
* **/bin**
* **/sbin**
* **/usr**

SIP рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдирд┐рдпрдо **`/System/Library/Sandbox/rootless.conf`** рдореЗрдВ рд╕реНрдерд┐рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реИрдВред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ, рдЙрди рдкрдереЛрдВ рдХреЛ рдЬреЛ рдПрдХ рддрд╛рд░рд╛рдВрдХрд┐рдд (\*) рдХреЗ рд╕рд╛рде рдкреНрд░рд╛рд░рдВрдн рд╣реЛрддреЗ рд╣реИрдВ, рдЕрдиреНрдпрдерд╛ рдХрдареЛрд░ SIP рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЗ рдЕрдкрд╡рд╛рдж рдХреЗ рд░реВрдк рдореЗрдВ рджрд░реНрд╢рд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдиреАрдЪреЗ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдкрд░ рд╡рд┐рдЪрд╛рд░ рдХрд░реЗрдВ:
```javascript
/usr
* /usr/libexec/cups
* /usr/local
* /usr/share/man
```
рдпрд╣ рд╕реНрдирд┐рдкреЗрдЯ рдпрд╣ рд╕рдВрдХреЗрдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЬрдмрдХрд┐ SIP рд╕рд╛рдорд╛рдиреНрдпрддрдГ **`/usr`** рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдХреБрдЫ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдЙрдкрдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ (`/usr/libexec/cups`, `/usr/local`, рдФрд░ `/usr/share/man`) рд╣реИрдВ рдЬрд╣рд╛рдБ рд╕рдВрд╢реЛрдзрди рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдЙрдирдХреЗ рдкрдереЛрдВ рдХреЗ рдкрд╣рд▓реЗ рдЕsterisk (\*) рджреНрд╡рд╛рд░рд╛ рд╕рдВрдХреЗрддрд┐рдд рд╣реИред

рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдпрд╛ рдлрд╝рд╛рдЗрд▓ SIP рджреНрд╡рд╛рд░рд╛ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рдЖрдк **`ls -lOd`** рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ **`restricted`** рдпрд╛ **`sunlnk`** рдзреНрд╡рдЬ рдХреА рдЙрдкрд╕реНрдерд┐рддрд┐ рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛ рд╕рдХреЗред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:
```bash
ls -lOd /usr/libexec/cups
drwxr-xr-x  11 root  wheel  sunlnk 352 May 13 00:29 /usr/libexec/cups
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, **`sunlnk`** рдзреНрд╡рдЬ рдпрд╣ рджрд░реНрд╢рд╛рддрд╛ рд╣реИ рдХрд┐ `/usr/libexec/cups` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╕реНрд╡рдпрдВ **рд╣рдЯрд╛рдИ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддреА**, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрд╕рдХреЗ рднреАрддрд░ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рдИ, рд╕рдВрд╢реЛрдзрд┐рдд рдпрд╛ рд╣рдЯрд╛рдИ рдЬрд╛ рд╕рдХрддреА рд╣реИрдВред

рджреВрд╕рд░реА рдУрд░:
```bash
ls -lOd /usr/libexec
drwxr-xr-x  338 root  wheel  restricted 10816 May 13 00:29 /usr/libexec
```
рдпрд╣рд╛рдБ, **`restricted`** рдзреНрд╡рдЬ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ `/usr/libexec` рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╣реИред SIP-рд╕рдВрд░рдХреНрд╖рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдлрд╝рд╛рдЗрд▓реЗрдВ рдмрдирд╛рдИ, рд╕рдВрд╢реЛрдзрд┐рдд рдпрд╛ рд╣рдЯрд╛рдИ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддреАрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ **`com.apple.rootless`** рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд **attribute** рд╣реИ, рддреЛ рд╡рд╣ рдлрд╝рд╛рдЗрд▓ рднреА **SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд** рд╣реЛрдЧреАред

**SIP рдЕрдиреНрдп рд░реВрдЯ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рднреА рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИ** рдЬреИрд╕реЗ:

* рдЕрд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдирд╛
* Apple-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдХрд╛рд░реНрдп-ports рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛
* NVRAM рдЪрд░ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛
* рдХрд░реНрдиреЗрд▓ рдбрд┐рдмрдЧрд┐рдВрдЧ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдирд╛

рд╡рд┐рдХрд▓реНрдк nvram рдЪрд░ рдореЗрдВ рдПрдХ рдмрд┐рдЯрдлреНрд▓реИрдЧ рдХреЗ рд░реВрдк рдореЗрдВ рдмрдирд╛рдП рд░рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВ (`csr-active-config` Intel рдкрд░ рдФрд░ `lp-sip0` ARM рдХреЗ рд▓рд┐рдП рдмреВрдЯ рдХрд┐рдП рдЧрдП рдбрд┐рд╡рд╛рдЗрд╕ рдЯреНрд░реА рд╕реЗ рдкрдврд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ)ред рдЖрдк XNU рд╕реНрд░реЛрдд рдХреЛрдб рдореЗрдВ `csr.sh` рдореЗрдВ рдзреНрд╡рдЬ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../.gitbook/assets/image (1192).png" alt=""><figcaption></figcaption></figure>

### SIP рд╕реНрдерд┐рддрд┐

рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдЬрд╛рдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ SIP рдЖрдкрдХреЗ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рд╕рдХреНрд╖рдо рд╣реИ:
```bash
csrutil status
```
рдпрджрд┐ рдЖрдкрдХреЛ SIP рдХреЛ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рддреЛ рдЖрдкрдХреЛ рдЕрдкрдиреЗ рдХрдВрдкреНрдпреВрдЯрд░ рдХреЛ рд░рд┐рдХрд╡рд░реА рдореЛрдб рдореЗрдВ рдкреБрдирдГ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдирд╛ рд╣реЛрдЧрд╛ (рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдХреЗ рджреМрд░рд╛рди Command+R рджрдмрд╛рдХрд░), рдлрд┐рд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ:
```bash
csrutil disable
```
рдпрджрд┐ рдЖрдк SIP рдХреЛ рд╕рдХреНрд╖рдо рд░рдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рд▓реЗрдХрд┐рди рдбрд┐рдмрдЧрд┐рдВрдЧ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рд╣рдЯрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк рдРрд╕рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
csrutil enable --without debug
```
### рдЕрдиреНрдп рдкреНрд░рддрд┐рдмрдВрдз

* **рдЕрд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** (kexts) рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддрд╛, рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреЗрд╡рд▓ рд╕рддреНрдпрд╛рдкрд┐рдд рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╕рд┐рд╕реНрдЯрдо рдХрд░реНрдиреЗрд▓ рдХреЗ рд╕рд╛рде рдЗрдВрдЯрд░реИрдХреНрдЯ рдХрд░реЗрдВред
* **macOS рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ** рдХрд╛ рдбрд┐рдмрдЧрд┐рдВрдЧ рд░реЛрдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдХреЛрд░ рд╕рд┐рд╕реНрдЯрдо рдШрдЯрдХреЛрдВ рдХреЛ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдФрд░ рд╕рдВрд╢реЛрдзрди рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИред
* **dtrace рдЬреИрд╕реЗ рдЙрдкрдХрд░рдгреЛрдВ** рдХреЛ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдирд┐рд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рд╕реЗ рд░реЛрдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╕рдВрдЪрд╛рд▓рди рдХреА рдЕрдЦрдВрдбрддрд╛ рдХреЛ рдФрд░ рдЕрдзрд┐рдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

[**рдЗрд╕ рд╡рд╛рд░реНрддрд╛ рдореЗрдВ SIP рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдиреЗрдВ**](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship)**ред**

## SIP рдмрд╛рдпрдкрд╛рд╕

SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рд╕реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ:

* **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ рддрдХ рдкрд╣реБрдВрдЪ**: рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЦрд╛рддреЛрдВ рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛ рдЬреИрд╕реЗ рдореЗрд▓, рд╕рдВрджреЗрд╢ рдФрд░ рд╕рдлрд╛рд░реА рдЗрддрд┐рд╣рд╛рд╕ рдкрдврд╝реЗрдВред
* **TCC рдмрд╛рдпрдкрд╛рд╕**: TCC (Transparency, Consent, and Control) рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рд╕реАрдзреЗ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ рд╡реЗрдмрдХреИрдо, рдорд╛рдЗрдХреНрд░реЛрдлреЛрди рдФрд░ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛ рд╕рдХреЗред
* **рд╕реНрдерд╛рдпреАрддрд╛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ**: SIP-рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рдиреЛрдВ рдореЗрдВ рдореИрд▓рд╡реЗрдпрд░ рд░рдЦреЗрдВ, рдЬрд┐рд╕рд╕реЗ рдЗрд╕реЗ рд╣рдЯрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рд░реЛрдзреА рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рд░реВрдЯ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рднреАред рдЗрд╕рдореЗрдВ рдореИрд▓рд╡реЗрдпрд░ рд╣рдЯрд╛рдиреЗ рдХреЗ рдЙрдкрдХрд░рдг (MRT) рдХреЗ рд╕рд╛рде рдЫреЗрдбрд╝рдЫрд╛рдбрд╝ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рднреА рд╢рд╛рдорд┐рд▓ рд╣реИред
* **рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░реЗрдВ**: рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реБрд░рдХреНрд╖рд╛ рдЙрдкрд╛рдп рд╣реИрдВ, SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛ рдЕрд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рд░рд▓ рдмрдирд╛рддрд╛ рд╣реИред

### рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдкреИрдХреЗрдЬ

**рдПрдкреНрдкрд▓ рдХреЗ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдкреИрдХреЗрдЬ** рдЗрд╕рдХреА рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рд╡реЗ SIP-рд╕реБрд░рдХреНрд╖рд┐рдд рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдУрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдорд╛рдирдХ рдбреЗрд╡рд▓рдкрд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреИрдХреЗрдЬ рднреА рдЕрд╡рд░реБрджреНрдз рд╣реЛ рдЬрд╛рдПрдВрдЧреЗред

### рдЕрд╕реНрддрд┐рддреНрд╡рд╣реАрди SIP рдлрд╝рд╛рдЗрд▓

рдПрдХ рд╕рдВрднрд╛рд╡рд┐рдд рдЫрд┐рджреНрд░ рдпрд╣ рд╣реИ рдХрд┐ рдпрджрд┐ **`rootless.conf` рдореЗрдВ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХреА рдЧрдИ рд╣реИ рд▓реЗрдХрд┐рди рд╡рд░реНрддрдорд╛рди рдореЗрдВ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ**, рддреЛ рдЗрд╕реЗ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдореИрд▓рд╡реЗрдпрд░ рдЗрд╕рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдХрд░ **рд╕рд┐рд╕реНрдЯрдо рдкрд░ рд╕реНрдерд╛рдпреАрддрд╛ рд╕реНрдерд╛рдкрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдкреНрд░реЛрдЧреНрд░рд╛рдо `/System/Library/LaunchDaemons` рдореЗрдВ рдПрдХ .plist рдлрд╝рд╛рдЗрд▓ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдпрджрд┐ рдпрд╣ `rootless.conf` рдореЗрдВ рд╕реВрдЪреАрдмрджреНрдз рд╣реИ рд▓реЗрдХрд┐рди рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИред

### com.apple.rootless.install.heritable

{% hint style="danger" %}
рдЕрдзрд┐рдХрд╛рд░ **`com.apple.rootless.install.heritable`** SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ
{% endhint %}

#### [CVE-2019-8561](https://objective-see.org/blog/blog\_0x42.html) <a href="#cve" id="cve"></a>

рдпрд╣ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ **рд╕рд┐рд╕реНрдЯрдо рджреНрд╡рд╛рд░рд╛ рдЗрд╕рдХреЗ рдХреЛрдб** рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдкреИрдХреЗрдЬ рдХреЛ **рд╕реНрд╡реИрдк рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛** рдФрд░ рдлрд┐рд░, рд╕рд┐рд╕реНрдЯрдо рдореВрд▓ рдХреЗ рдмрдЬрд╛рдп рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рдкреИрдХреЗрдЬ рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдЧрд╛ред рдЪреВрдВрдХрд┐ рдпреЗ рдХреНрд░рд┐рдпрд╛рдПрдБ **`system_installd`** рджреНрд╡рд╛рд░рд╛ рдХреА рдЧрдИ рдереАрдВ, рдпрд╣ SIP рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред

#### [CVE-2020тАУ9854](https://objective-see.org/blog/blog\_0x4D.html) <a href="#cve-unauthd-chain" id="cve-unauthd-chain"></a>

рдпрджрд┐ рдПрдХ рдкреИрдХреЗрдЬ рдПрдХ рдорд╛рдЙрдВрдЯреЗрдб рдЗрдореЗрдЬ рдпрд╛ рдмрд╛рд╣рд░реА рдбреНрд░рд╛рдЗрд╡ рд╕реЗ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ **рдЗрдВрд╕реНрдЯреЙрд▓рд░** **рдЙрд╕ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо** рд╕реЗ рдмрд╛рдЗрдирд░реА рдХреЛ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░реЗрдЧрд╛ (SIP-рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рд╕реЗ рдирд╣реАрдВ), рдЬрд┐рд╕рд╕реЗ **`system_installd`** рдПрдХ рдордирдорд╛рдирд╛ рдмрд╛рдЗрдирд░реА рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдЧрд╛ред

#### CVE-2021-30892 - Shrootless

[**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ рдХреЗ рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ**](https://www.microsoft.com/en-us/security/blog/2021/10/28/microsoft-finds-new-macos-vulnerability-shrootless-that-could-bypass-system-integrity-protection/) рдиреЗ macOS рдХреЗ рд╕рд┐рд╕реНрдЯрдо рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рдкреНрд░реЛрдЯреЗрдХреНрд╢рди (SIP) рддрдВрддреНрд░ рдореЗрдВ рдПрдХ рднреЗрджреНрдпрддрд╛ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдпрд╛, рдЬрд┐рд╕реЗ 'Shrootless' рднреЗрджреНрдпрддрд╛ рдХрд╣рд╛ рдЧрдпрд╛ред рдпрд╣ рднреЗрджреНрдпрддрд╛ **`system_installd`** рдбреЗрдорди рдХреЗ рдЪрд╛рд░реЛрдВ рдУрд░ рдХреЗрдВрджреНрд░рд┐рдд рд╣реИ, рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдЕрдзрд┐рдХрд╛рд░ рд╣реИ, **`com.apple.rootless.install.heritable`**, рдЬреЛ рдЗрд╕рдХреЗ рдХрд┐рд╕реА рднреА рдмрд╛рд▓ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ SIP рдХреЗ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдкреНрд░рддрд┐рдмрдВрдзреЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

**`system_installd`** рдбреЗрдорди рдЙрди рдкреИрдХреЗрдЬреЛрдВ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдЧрд╛ рдЬреЛ **Apple** рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реИрдВред

рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ рдиреЗ рдкрд╛рдпрд╛ рдХрд┐ Apple рджреНрд╡рд╛рд░рд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреИрдХреЗрдЬ (.pkg рдлрд╝рд╛рдЗрд▓) рдХреА рд╕реНрдерд╛рдкрдирд╛ рдХреЗ рджреМрд░рд╛рди, **`system_installd`** рдкреИрдХреЗрдЬ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд┐рд╕реА рднреА **рдкреЛрд╕реНрдЯ-рдЗрдВрд╕реНрдЯреЙрд▓** рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ **рдЪрд▓рд╛рддрд╛ рд╣реИ**ред рдпреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╢реЗрд▓, **`zsh`** рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХреА рдЬрд╛рддреА рд╣реИрдВ, рдЬреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ **`/etc/zshenv`** рдлрд╝рд╛рдЗрд▓ рд╕реЗ рдХрдорд╛рдВрдб рдЪрд▓рд╛рддреА рд╣реИ, рдпрджрд┐ рдпрд╣ рдореМрдЬреВрдж рд╣реИ, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рдЧреИрд░-рдЗрдВрдЯрд░реИрдХреНрдЯрд┐рд╡ рдореЛрдб рдореЗрдВ рднреАред рдЗрд╕ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рджреНрд╡рд╛рд░рд╛ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ: рдПрдХ рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг `/etc/zshenv` рдлрд╝рд╛рдЗрд▓ рдмрдирд╛рдХрд░ рдФрд░ **`system_installd` рдХреЛ `zsh`** рдХреЛ рд╕рдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░рдХреЗ, рд╡реЗ рдбрд┐рд╡рд╛рдЗрд╕ рдкрд░ рдордирдорд╛рдиреЗ рдСрдкрд░реЗрд╢рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ **`/etc/zshenv` рдХреЛ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рд╣рдорд▓реЗ рдХреА рддрдХрдиреАрдХ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**, рди рдХрд┐ рдХреЗрд╡рд▓ SIP рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рд▓рд┐рдПред рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдПрдХ `~/.zshenv` рдлрд╝рд╛рдЗрд▓ рд╣реЛрддреА рд╣реИ, рдЬреЛ `/etc/zshenv` рдХреА рддрд░рд╣ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддреА рд╣реИ рд▓реЗрдХрд┐рди рд░реВрдЯ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реЛрддреАред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рд╕реНрдерд╛рдпреАрддрд╛ рддрдВрддреНрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╣рд░ рдмрд╛рд░ `zsh` рд╢реБрд░реВ рд╣реЛрдиреЗ рдкрд░ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрддрд╛ рд╣реИ, рдпрд╛ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдмрдврд╝рд╛рдиреЗ рдХреЗ рддрдВрддреНрд░ рдХреЗ рд░реВрдк рдореЗрдВред рдпрджрд┐ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ `sudo -s` рдпрд╛ `sudo <command>` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд░реВрдЯ рдореЗрдВ рдмрдврд╝рддрд╛ рд╣реИ, рддреЛ `~/.zshenv` рдлрд╝рд╛рдЗрд▓ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧреА, рдкреНрд░рднрд╛рд╡реА рд░реВрдк рд╕реЗ рд░реВрдЯ рдореЗрдВ рдмрдврд╝рддреЗ рд╣реБрдПред

#### [**CVE-2022-22583**](https://perception-point.io/blog/technical-analysis-cve-2022-22583/)

[**CVE-2022-22583**](https://perception-point.io/blog/technical-analysis-cve-2022-22583/) рдореЗрдВ рдпрд╣ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдХрд┐ рд╡рд╣реА **`system_installd`** рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЕрднреА рднреА рджреБрд░реБрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ **`/tmp` рдХреЗ рдЕрдВрджрд░ SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдПрдХ рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдирд╛рдорд┐рдд рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдЕрдВрджрд░ рдкреЛрд╕реНрдЯ-рдЗрдВрд╕реНрдЯреЙрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдбрд╛рд▓ рд░рд╣реА рдереА**ред рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ **`/tmp` рд╕реНрд╡рдпрдВ SIP рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдПрдХ **рд╡рд░реНрдЪреБрдЕрд▓ рдЗрдореЗрдЬ рдХреЛ рдЙрд╕ рдкрд░ рдорд╛рдЙрдВрдЯ** рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛, рдлрд┐рд░ **рдЗрдВрд╕реНрдЯреЙрд▓рд░** рд╡рд╣рд╛рдВ **рдкреЛрд╕реНрдЯ-рдЗрдВрд╕реНрдЯреЙрд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ** рдбрд╛рд▓рддрд╛, **рд╡рд░реНрдЪреБрдЕрд▓ рдЗрдореЗрдЬ рдХреЛ рдЕрдирдорд╛рдЙрдВрдЯ** рдХрд░рддрд╛, **рд╕рднреА рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдХреЛ рдлрд┐рд░ рд╕реЗ рдмрдирд╛рддрд╛** рдФрд░ **рдкреЗрд▓реЛрдб** рдХреЗ рд╕рд╛рде **рдкреЛрд╕реНрдЯ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди** рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рдЬреЛрдбрд╝рддрд╛ред

#### [fsck\_cs рдЙрдкрдпреЛрдЧрд┐рддрд╛](https://www.theregister.com/2016/03/30/apple\_os\_x\_rootless/)

рдПрдХ рднреЗрджреНрдпрддрд╛ рдХреА рдкрд╣рдЪрд╛рди рдХреА рдЧрдИ рдЬрд╣рд╛рдВ **`fsck_cs`** рдХреЛ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдлрд╝рд╛рдЗрд▓ рдХреЛ рднреНрд░рд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧреБрдорд░рд╛рд╣ рдХрд┐рдпрд╛ рдЧрдпрд╛, рдЗрд╕рдХреА **рд╕рд╛рдВрдХреЗрддрд┐рдХ рд▓рд┐рдВрдХ** рдХрд╛ рдкрд╛рд▓рди рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдХреЗ рдХрд╛рд░рдгред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдиреЗ _`/dev/diskX`_ рд╕реЗ рдлрд╝рд╛рдЗрд▓ `/System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist` рдХреЗ рд▓рд┐рдП рдПрдХ рд▓рд┐рдВрдХ рддреИрдпрд╛рд░ рдХрд┐рдпрд╛ред _`/dev/diskX`_ рдкрд░ **`fsck_cs`** рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ `Info.plist` рдХрд╛ рднреНрд░рд╖реНрдЯрд╛рдЪрд╛рд░ рд╣реБрдЖред рдЗрд╕ рдлрд╝рд╛рдЗрд▓ рдХреА рдЕрдЦрдВрдбрддрд╛ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреЗ SIP (рд╕рд┐рд╕реНрдЯрдо рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рдкреНрд░реЛрдЯреЗрдХреНрд╢рди) рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ, рдЬреЛ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЗ рд▓реЛрдбрд┐рдВрдЧ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред рдПрдХ рдмрд╛рд░ рднреНрд░рд╖реНрдЯ рд╣реЛрдиреЗ рдкрд░, SIP рдХреА рдХрд░реНрдиреЗрд▓ рдЕрдкрд╡рд╛рдж рдкреНрд░рдмрдВрдзрди рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛрддреА рд╣реИред

рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХрд╛ рд▓рд╛рдн рдЙрдард╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрджреЗрд╢ рд╣реИрдВ:
```bash
ln -s /System/Library/Extensions/AppleKextExcludeList.kext/Contents/Info.plist /dev/diskX
fsck_cs /dev/diskX 1>&-
touch /Library/Extensions/
reboot
```
рдЗрд╕ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЗ рд╢реЛрд╖рдг рдХреЗ рдЧрдВрднреАрд░ рдкрд░рд┐рдгрд╛рдо рд╣реИрдВред `Info.plist` рдлрд╝рд╛рдЗрд▓, рдЬреЛ рд╕рд╛рдорд╛рдиреНрдпрддрдГ рдХрд░реНрдиреЗрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рдкреНрд░рдмрдВрдзрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рд╣реЛрддреА рд╣реИ, рдЕрдкреНрд░рднрд╛рд╡реА рд╣реЛ рдЬрд╛рддреА рд╣реИред рдЗрд╕рдореЗрдВ рдХреБрдЫ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреЛрдВ, рдЬреИрд╕реЗ `AppleHWAccess.kext` рдХреЛ рдмреНрд▓реИрдХрд▓рд┐рд╕реНрдЯ рдХрд░рдиреЗ рдХреА рдЕрд╕рдорд░реНрдерддрд╛ рд╢рд╛рдорд┐рд▓ рд╣реИред рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, SIP рдХреЗ рдирд┐рдпрдВрддреНрд░рдг рддрдВрддреНрд░ рдХреЗ рдЦрд░рд╛рдм рд╣реЛрдиреЗ рдХреЗ рдХрд╛рд░рдг, рдЗрд╕ рдПрдХреНрд╕рдЯреЗрдВрд╢рди рдХреЛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╕рд┐рд╕реНрдЯрдо рдХреА RAM рддрдХ рдЕрдирдзрд┐рдХреГрдд рдкрдврд╝рдиреЗ рдФрд░ рд▓рд┐рдЦрдиреЗ рдХреА рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

#### [SIP рд╕рдВрд░рдХреНрд╖рд┐рдд рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ](https://www.slideshare.net/i0n1c/syscan360-stefan-esser-os-x-el-capitan-sinking-the-ship)

**рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП SIP рд╕рдВрд░рдХреНрд╖рд┐рдд рдлрд╝реЛрд▓реНрдбрд░реЛрдВ рдкрд░ рдПрдХ рдирдИ рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдгрд╛рд▓реА рдХреЛ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ред**
```bash
mkdir evil
# Add contento to the folder
hdiutil create -srcfolder evil evil.dmg
hdiutil attach -mountpoint /System/Library/Snadbox/ evil.dmg
```
#### [Upgrader bypass (2016)](https://objective-see.org/blog/blog\_0x14.html)

рд╕рд┐рд╕реНрдЯрдо рдХреЛ `Install macOS Sierra.app` рдХреЗ рднреАрддрд░ рдПрдХ рдПрдореНрдмреЗрдбреЗрдб рдЗрдВрд╕реНрдЯреЙрд▓рд░ рдбрд┐рд╕реНрдХ рдЗрдореЗрдЬ рд╕реЗ рдмреВрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рддрд╛рдХрд┐ OS рдХреЛ рдЕрдкрдЧреНрд░реЗрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, `bless` рдЙрдкрдпреЛрдЧрд┐рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдПред рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдХрдорд╛рдВрдб рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╣реИ:
```bash
/usr/sbin/bless -setBoot -folder /Volumes/Macintosh HD/macOS Install Data -bootefi /Volumes/Macintosh HD/macOS Install Data/boot.efi -options config="\macOS Install Data\com.apple.Boot" -label macOS Installer
```
The security of this process can be compromised if an attacker alters the upgrade image (`InstallESD.dmg`) before booting. The strategy involves substituting a dynamic loader (dyld) with a malicious version (`libBaseIA.dylib`). This replacement results in the execution of the attacker's code when the installer is initiated.

The attacker's code gains control during the upgrade process, exploiting the system's trust in the installer. The attack proceeds by altering the `InstallESD.dmg` image via method swizzling, particularly targeting the `extractBootBits` method. This allows the injection of malicious code before the disk image is employed.

Moreover, within the `InstallESD.dmg`, there's a `BaseSystem.dmg`, which serves as the upgrade code's root file system. Injecting a dynamic library into this allows the malicious code to operate within a process capable of altering OS-level files, significantly increasing the potential for system compromise.

#### [systemmigrationd (2023)](https://www.youtube.com/watch?v=zxZesAN-TEk)

In this talk from [**DEF CON 31**](https://www.youtube.com/watch?v=zxZesAN-TEk), it's shown how **`systemmigrationd`** (which can bypass SIP) executes a **bash** and a **perl** script, which can be abused via env variables **`BASH_ENV`** and **`PERL5OPT`**.

#### CVE-2023-42860 <a href="#cve-a-detailed-look" id="cve-a-detailed-look"></a>

As [**detailed in this blog post**](https://blog.kandji.io/apple-mitigates-vulnerabilities-installer-scripts), a `postinstall` script from `InstallAssistant.pkg` packages allowed was executing:
```bash
/usr/bin/chflags┬а-h┬аnorestricted┬а"${SHARED_SUPPORT_PATH}/SharedSupport.dmg"
```
and it was possible to crate a symlink in `${SHARED_SUPPORT_PATH}/SharedSupport.dmg` that would allow a user to **unrestrict any file, bypassing SIP protection**.

### **com.apple.rootless.install**

{% hint style="danger" %}
The entitlement **`com.apple.rootless.install`** allows to bypass SIP
{% endhint %}

The entitlement `com.apple.rootless.install` is known to bypass System Integrity Protection (SIP) on macOS. This was notably mentioned in relation to [**CVE-2022-26712**](https://jhftss.github.io/CVE-2022-26712-The-POC-For-SIP-Bypass-Is-Even-Tweetable/).

In this specific case, the system XPC service located at `/System/Library/PrivateFrameworks/ShoveService.framework/Versions/A/XPCServices/SystemShoveService.xpc` possesses this entitlement. This allows the related process to circumvent SIP constraints. Furthermore, this service notably presents a method that permits the movement of files without enforcing any security measures.

## Sealed System Snapshots

Sealed System Snapshots are a feature introduced by Apple in **macOS Big Sur (macOS 11)** as a part of its **System Integrity Protection (SIP)** mechanism to provide an additional layer of security and system stability. They are essentially read-only versions of the system volume.

Here's a more detailed look:

1. **Immutable System**: Sealed System Snapshots make the macOS system volume "immutable", meaning that it cannot be modified. This prevents any unauthorised or accidental changes to the system that could compromise security or system stability.
2. **System Software Updates**: When you install macOS updates or upgrades, macOS creates a new system snapshot. The macOS startup volume then uses **APFS (Apple File System)** to switch to this new snapshot. The entire process of applying updates becomes safer and more reliable as the system can always revert to the previous snapshot if something goes wrong during the update.
3. **Data Separation**: In conjunction with the concept of Data and System volume separation introduced in macOS Catalina, the Sealed System Snapshot feature makes sure that all your data and settings are stored on a separate "**Data**" volume. This separation makes your data independent from the system, which simplifies the process of system updates and enhances system security.

Remember that these snapshots are automatically managed by macOS and don't take up additional space on your disk, thanks to the space sharing capabilities of APFS. ItтАЩs also important to note that these snapshots are different from **Time Machine snapshots**, which are user-accessible backups of the entire system.

### Check Snapshots

The command **`diskutil apfs list`** lists the **details of the APFS volumes** and their layout:

<pre><code>+-- Container disk3 966B902E-EDBA-4775-B743-CF97A0556A13
|   ====================================================
|   APFS Container Reference:     disk3
|   Size (Capacity Ceiling):      494384795648 B (494.4 GB)
|   Capacity In Use By Volumes:   219214536704 B (219.2 GB) (44.3% used)
|   Capacity Not Allocated:       275170258944 B (275.2 GB) (55.7% free)
|   |
|   +-&#x3C; Physical Store disk0s2 86D4B7EC-6FA5-4042-93A7-D3766A222EBE
|   |   -----------------------------------------------------------
|   |   APFS Physical Store Disk:   disk0s2
|   |   Size:                       494384795648 B (494.4 GB)
|   |
|   +-> Volume disk3s1 7A27E734-880F-4D91-A703-FB55861D49B7
|   |   ---------------------------------------------------
<strong>|   |   APFS Volume Disk (Role):   disk3s1 (System)
</strong>|   |   Name:                      Macintosh HD (Case-insensitive)
<strong>|   |   Mount Point:               /System/Volumes/Update/mnt1
</strong>|   |   Capacity Consumed:         12819210240 B (12.8 GB)
|   |   Sealed:                    Broken
|   |   FileVault:                 Yes (Unlocked)
|   |   Encrypted:                 No
|   |   |
|   |   Snapshot:                  FAA23E0C-791C-43FF-B0E7-0E1C0810AC61
|   |   Snapshot Disk:             disk3s1s1
<strong>|   |   Snapshot Mount Point:      /
</strong><strong>|   |   Snapshot Sealed:           Yes
</strong>[...]
+-> Volume disk3s5 281959B7-07A1-4940-BDDF-6419360F3327
|   ---------------------------------------------------
|   APFS Volume Disk (Role):   disk3s5 (Data)
|   Name:                      Macintosh HD - Data (Case-insensitive)
<strong>    |   Mount Point:               /System/Volumes/Data
</strong><strong>    |   Capacity Consumed:         412071784448 B (412.1 GB)
</strong>    |   Sealed:                    No
|   FileVault:                 Yes (Unlocked)
</code></pre>

In the previous output it's possible to see that **user-accessible locations** are mounted under `/System/Volumes/Data`.

Moreover, **macOS System volume snapshot** is mounted in `/` and it's **sealed** (cryptographically signed by the OS). So, if SIP is bypassed and modifies it, the **OS won't boot anymore**.

It's also possible to **verify that seal is enabled** by running:
```bash
csrutil authenticated-root status
Authenticated Root status: enabled
```
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рд╕реНрдиреИрдкрд╢реЙрдЯ рдбрд┐рд╕реНрдХ рдХреЛ **рдкрдврд╝рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЗрд╡рд▓** рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдорд╛рдЙрдВрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```bash
mount
/dev/disk3s1s1 on / (apfs, sealed, local, read-only, journaled)
```
### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) рдПрдХ **рдбрд╛рд░реНрдХ-рд╡реЗрдм** рджреНрд╡рд╛рд░рд╛ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╕рд░реНрдЪ рдЗрдВрдЬрди рд╣реИ рдЬреЛ **рдореБрдлреНрдд** рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдПрдБ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ рдЬрд╛рдВрдЪрд╛ рдЬрд╛ рд╕рдХреЗ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рдХрдВрдкрдиреА рдпрд╛ рдЙрд╕рдХреЗ рдЧреНрд░рд╛рд╣рдХ **рд╕реНрдЯреАрд▓рд░ рдорд╛рд▓рд╡реЗрдпрд░** рджреНрд╡рд╛рд░рд╛ **рд╕рдордЭреМрддрд╛** рдХрд┐рдП рдЧрдП рд╣реИрдВред

WhiteIntel рдХрд╛ рдкреНрд░рд╛рдердорд┐рдХ рд▓рдХреНрд╖реНрдп рдЬрд╛рдирдХрд╛рд░реА-рдЪреЛрд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдорд╛рд▓рд╡реЗрдпрд░ рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк рдЕрдХрд╛рдЙрдВрдЯ рдЯреЗрдХрдУрд╡рд░ рдФрд░ рд░реИрдирд╕рдорд╡реЗрдпрд░ рд╣рдорд▓реЛрдВ рд╕реЗ рд▓рдбрд╝рдирд╛ рд╣реИред

рдЖрдк рдЙрдирдХреА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдореБрдлреНрдд** рдореЗрдВ рдЙрдирдХреЗ рдЗрдВрдЬрди рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% embed url="https://whiteintel.io" %}
{% hint style="success" %}
Learn & practice AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Learn & practice GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Check the [**subscription plans**](https://github.com/sponsors/carlospolop)!
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** ЁЯРж [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Share hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
{% endhint %}
</details>
