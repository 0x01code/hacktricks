# macOS Installers Missbrauch

{% hint style="success" %}
Lernen Sie und √ºben Sie AWS-Hacking: <img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen Sie und √ºben Sie GCP-Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
{% endhint %}

## Pkg Grundlegende Informationen

Ein macOS **Installationspaket** (auch bekannt als `.pkg`-Datei) ist ein Dateiformat, das von macOS verwendet wird, um **Software zu verteilen**. Diese Dateien sind wie eine **Box, die alles enth√§lt, was eine Software** ben√∂tigt, um korrekt installiert und ausgef√ºhrt zu werden.

Die Paketdatei selbst ist ein Archiv, das eine **Hierarchie von Dateien und Verzeichnissen enth√§lt, die auf dem Zielcomputer installiert werden**. Es kann auch **Skripte** enthalten, um Aufgaben vor und nach der Installation auszuf√ºhren, wie z. B. das Einrichten von Konfigurationsdateien oder das Bereinigen alter Versionen der Software.

### Hierarchie

<figure><img src="../../../.gitbook/assets/Pasted Graphic.png" alt="https://www.youtube.com/watch?v=iASSG0_zobQ"><figcaption></figcaption></figure>

* **Distribution (xml)**: Anpassungen (Titel, Willkommensnachricht...) und Skript/Installationspr√ºfungen
* **PackageInfo (xml)**: Informationen, Installationsanforderungen, Installationsort, Pfade zu auszuf√ºhrenden Skripten
* **Materialliste (bom)**: Liste der zu installierenden, zu aktualisierenden oder zu entfernenden Dateien mit Dateiberechtigungen
* **Payload (CPIO-Archiv gzip-komprimiert)**: Dateien, die im `install-location` aus PackageInfo installiert werden sollen
* **Skripte (CPIO-Archiv gzip-komprimiert)**: Vor- und Nachinstallations-Skripte und weitere Ressourcen, die in ein tempor√§res Verzeichnis extrahiert werden, um ausgef√ºhrt zu werden.

### Dekomprimieren
```bash
# Tool to directly get the files inside a package
pkgutil ‚Äîexpand "/path/to/package.pkg" "/path/to/out/dir"

# Get the files ina. more manual way
mkdir -p "/path/to/out/dir"
cd "/path/to/out/dir"
xar -xf "/path/to/package.pkg"

# Decompress also the CPIO gzip compressed ones
cat Scripts | gzip -dc | cpio -i
cpio -i < Scripts
```
Um den Inhalt des Installers ohne manuelles Entpacken zu visualisieren, k√∂nnen Sie auch das kostenlose Tool [**Suspicious Package**](https://mothersruin.com/software/SuspiciousPackage/) verwenden.

## DMG Grundinformationen

DMG-Dateien oder Apple Disk Images sind ein Dateiformat, das von Apples macOS f√ºr Festplattenabbilder verwendet wird. Eine DMG-Datei ist im Wesentlichen ein **einbindbares Festplattenabbild** (es enth√§lt sein eigenes Dateisystem), das rohe Blockdaten enth√§lt, die typischerweise komprimiert und manchmal verschl√ºsselt sind. Wenn Sie eine DMG-Datei √∂ffnen, **bindet macOS sie ein, als ob es sich um eine physische Festplatte handeln w√ºrde**, was es Ihnen erm√∂glicht, auf deren Inhalt zuzugreifen.

{% hint style="danger" %}
Beachten Sie, dass **`.dmg`**-Installer **so viele Formate** unterst√ºtzen, dass in der Vergangenheit einige von ihnen mit Schwachstellen missbraucht wurden, um **Kernelcodeausf√ºhrung** zu erlangen.
{% endhint %}

### Hierarchie

<figure><img src="../../../.gitbook/assets/image (225).png" alt=""><figcaption></figcaption></figure>

Die Hierarchie einer DMG-Datei kann je nach Inhalt unterschiedlich sein. F√ºr Anwendungs-DMGs folgt sie jedoch in der Regel dieser Struktur:

* Top-Level: Dies ist die Wurzel des Festplattenabbilds. Es enth√§lt oft die Anwendung und m√∂glicherweise einen Link zum Ordner "Programme".
* Anwendung (.app): Dies ist die tats√§chliche Anwendung. In macOS ist eine Anwendung in der Regel ein Paket, das viele einzelne Dateien und Ordner enth√§lt, die die Anwendung ausmachen.
* Anwendungslink: Dies ist eine Verkn√ºpfung zum Ordner "Programme" in macOS. Der Zweck davon ist es, es Ihnen leicht zu machen, die Anwendung zu installieren. Sie k√∂nnen die .app-Datei zu dieser Verkn√ºpfung ziehen, um die App zu installieren.

## Privilege Escalation durch pkg-Missbrauch

### Ausf√ºhrung aus √∂ffentlichen Verzeichnissen

Wenn beispielsweise ein Vor- oder Nachinstallations-Skript aus **`/var/tmp/Installerutil`** ausgef√ºhrt wird und ein Angreifer dieses Skript kontrollieren k√∂nnte, k√∂nnte er Berechtigungen eskalieren, wann immer es ausgef√ºhrt wird. Oder ein √§hnliches Beispiel:

<figure><img src="../../../.gitbook/assets/Pasted Graphic 5.png" alt="https://www.youtube.com/watch?v=iASSG0_zobQ"><figcaption><p><a href="https://www.youtube.com/watch?v=kCXhIYtODBg">https://www.youtube.com/watch?v=kCXhIYtODBg</a></p></figcaption></figure>

### AuthorizationExecuteWithPrivileges

Dies ist eine [√∂ffentliche Funktion](https://developer.apple.com/documentation/security/1540038-authorizationexecutewithprivileg), die von mehreren Installationsprogrammen und Updatern aufgerufen wird, um **etwas als Root auszuf√ºhren**. Diese Funktion akzeptiert den **Pfad** der **Datei**, die als Parameter **ausgef√ºhrt** werden soll. Wenn ein Angreifer jedoch diese Datei **modifizieren** k√∂nnte, k√∂nnte er deren Ausf√ºhrung mit Root-Rechten **missbrauchen**, um Berechtigungen zu **eskaliere**n.
```bash
# Breakpoint in the function to check wich file is loaded
(lldb) b AuthorizationExecuteWithPrivileges
# You could also check FS events to find this missconfig
```
### Ausf√ºhrung durch Einh√§ngen

Wenn ein Installer nach `/tmp/fixedname/bla/bla` schreibt, ist es m√∂glich, **ein Mount √ºber** `/tmp/fixedname` ohne Besitzer zu erstellen, sodass Sie **w√§hrend der Installation jede Datei √§ndern** k√∂nnen, um den Installationsprozess zu missbrauchen.

Ein Beispiel hierf√ºr ist **CVE-2021-26089**, bei dem es gelungen ist, ein periodisches Skript zu √ºberschreiben, um die Ausf√ºhrung als Root zu erhalten. F√ºr weitere Informationen schauen Sie sich den Vortrag an: [**OBTS v4.0: "Mount(ain) of Bugs" - Csaba Fitzl**](https://www.youtube.com/watch?v=jSYPazD4VcE)

## pkg als Malware

### Leerer Payload

Es ist m√∂glich, einfach eine **`.pkg`**-Datei mit **Vor- und Nachinstallations-Skripten** ohne Payload zu generieren.

### JS in Distribution-XML

Es ist m√∂glich, **`<script>`**-Tags in der **Distribution-XML**-Datei des Pakets hinzuzuf√ºgen, und dieser Code wird ausgef√ºhrt, um Befehle mithilfe von **`system.run`** auszuf√ºhren:

<figure><img src="../../../.gitbook/assets/image (1043).png" alt=""><figcaption></figcaption></figure>

## Referenzen

* [**DEF CON 27 - Entpacken von Pkgs Ein Blick in Macos-Installationspakete und h√§ufige Sicherheitsl√ºcken**](https://www.youtube.com/watch?v=iASSG0\_zobQ)
* [**OBTS v4.0: "Die wilde Welt der macOS-Installer" - Tony Lambert**](https://www.youtube.com/watch?v=Eow5uNHtmIg)
* [**DEF CON 27 - Entpacken von Pkgs Ein Blick in MacOS-Installationspakete**](https://www.youtube.com/watch?v=kCXhIYtODBg)
