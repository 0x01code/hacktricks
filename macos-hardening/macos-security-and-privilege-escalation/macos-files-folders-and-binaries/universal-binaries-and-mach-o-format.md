# macOS рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реАрдЬрд╝ рдФрд░ Mach-O рдкреНрд░рд╛рд░реВрдк

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рдЬреАрд░реЛ рд╕реЗ рд╣реАрд░реЛ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

Mac OS рдмрд╛рдЗрдирд░реАрдЬрд╝ рдЖрдо рддреМрд░ рдкрд░ **рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реАрдЬрд╝** рдХреЗ рд░реВрдк рдореЗрдВ рдХреЙрдореНрдкрд╛рдЗрд▓ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рдПрдХ **рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реА** рдореЗрдВ **рдПрдХ рд╣реА рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдХрдИ рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░ рд╕рдХрддрд╛ рд╣реИ**ред

рдпреЗ рдмрд╛рдЗрдирд░реАрдЬрд╝ **Mach-O рд╕рдВрд░рдЪрдирд╛** рдХрд╛ рдкрд╛рд▓рди рдХрд░рддреА рд╣реИрдВ рдЬреЛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реЗ рдмрдирд╛ рд╣реЛрддрд╛ рд╣реИ:

* рд╣реЗрдбрд░
* рд▓реЛрдб рдХрдорд╛рдВрдбреНрд╕
* рдбреЗрдЯрд╛

![https://alexdremov.me/content/images/2022/10/6XLCD.gif](<../../../.gitbook/assets/image (559).png>)

## рдлреИрдЯ рд╣реЗрдбрд░

рдлрд╝рд╛рдЗрд▓ рдХреЛ рдЦреЛрдЬреЗрдВ: `mdfind fat.h | grep -i mach-o | grep -E "fat.h$"`

<pre class="language-c"><code class="lang-c"><strong>#define FAT_MAGIC	0xcafebabe
</strong><strong>#define FAT_CIGAM	0xbebafeca	/* NXSwapLong(FAT_MAGIC) */
</strong>
struct fat_header {
<strong>	uint32_t	magic;		/* FAT_MAGIC or FAT_MAGIC_64 */
</strong><strong>	uint32_t	nfat_arch;	/* number of structs that follow */
</strong>};

struct fat_arch {
cpu_type_t	cputype;	/* cpu specifier (int) */
cpu_subtype_t	cpusubtype;	/* machine specifier (int) */
uint32_t	offset;		/* file offset to this object file */
uint32_t	size;		/* size of this object file */
uint32_t	align;		/* alignment as a power of 2 */
};
</code></pre>

рд╣реЗрдбрд░ рдореЗрдВ **рдореИрдЬрд┐рдХ** рдмрд╛рдЗрдЯреНрд╕ рд╣реЛрддреЗ рд╣реИрдВ рдЬрд┐рдирдХреЗ рдмрд╛рдж рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рдореМрдЬреВрдж **рдЖрд░реНрдХреНрд╕** рдХреА рд╕рдВрдЦреНрдпрд╛ (`nfat_arch`) рд╣реЛрддреА рд╣реИ рдФрд░ рдкреНрд░рддреНрдпреЗрдХ рдЖрд░реНрдХ рдХреЗ рдкрд╛рд╕ `fat_arch` рд╕реНрдЯреНрд░рдХреНрдЯ рд╣реЛрддреА рд╣реИред

рдЗрд╕реЗ рдЪреЗрдХ рдХрд░реЗрдВ:

<pre class="language-shell-session"><code class="lang-shell-session">% file /bin/ls
/bin/ls: Mach-O universal binary with 2 architectures: [x86_64:Mach-O 64-bit executable x86_64] [arm64e:Mach-O 64-bit executable arm64e]
/bin/ls (for architecture x86_64):	Mach-O 64-bit executable x86_64
/bin/ls (for architecture arm64e):	Mach-O 64-bit executable arm64e

% otool -f -v /bin/ls
Fat headers
fat_magic FAT_MAGIC
<strong>nfat_arch 2
</strong><strong>architecture x86_64
</strong>    cputype CPU_TYPE_X86_64
cpusubtype CPU_SUBTYPE_X86_64_ALL
capabilities 0x0
<strong>    offset 16384
</strong><strong>    size 72896
</strong>    align 2^14 (16384)
<strong>architecture arm64e
</strong>    cputype CPU_TYPE_ARM64
cpusubtype CPU_SUBTYPE_ARM64E
capabilities PTR_AUTH_VERSION USERSPACE 0
<strong>    offset 98304
</strong><strong>    size 88816
</strong>    align 2^14 (16384)
</code></pre>

рдпрд╛ [Mach-O View](https://sourceforge.net/projects/machoview/) рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:

<figure><img src="../../../.gitbook/assets/image (5) (1) (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рд╕реЛрдЪ рд░рд╣реЗ рд╣реЛрдВрдЧреЗ, рдЖрдо рддреМрд░ рдкрд░ 2 рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рд▓рд┐рдП рдПрдХ рдпреВрдирд┐рд╡рд░реНрд╕рд▓ рдмрд╛рдЗрдирд░реА рдХрд╛ рдЖрдХрд╛рд░ рдПрдХ рдХреЗ рд▓рд┐рдП рдХреЙрдореНрдкрд╛рдЗрд▓ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдХреЗ рдЖрдХрд╛рд░ рдХреЛ **рджреЛрдЧреБрдирд╛** рдХрд░ рджреЗрддрд╛ рд╣реИред

## **Mach-O рд╣реЗрдбрд░**

рд╣реЗрдбрд░ рдореЗрдВ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА рд╣реЛрддреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдореИрдЬрд┐рдХ рдмрд╛рдЗрдЯреНрд╕ рддрд╛рдХрд┐ рдЗрд╕реЗ рдПрдХ Mach-O рдлрд╝рд╛рдЗрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рдЪрд╛рдирд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рд▓рдХреНрд╖рд┐рдд рдЖрд░реНрдХрд┐рдЯреЗрдХреНрдЪрд░ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реАред рдЖрдк рдЗрд╕реЗ рдпрд╣рд╛рдБ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ: `mdfind loader.h | grep -i mach-o | grep -E "loader.h$"`
```c
#define	MH_MAGIC	0xfeedface	/* the mach magic number */
#define MH_CIGAM	0xcefaedfe	/* NXSwapInt(MH_MAGIC) */
struct mach_header {
uint32_t	magic;		/* mach magic number identifier */
cpu_type_t	cputype;	/* cpu specifier (e.g. I386) */
cpu_subtype_t	cpusubtype;	/* machine specifier */
uint32_t	filetype;	/* type of file (usage and alignment for the file) */
uint32_t	ncmds;		/* number of load commands */
uint32_t	sizeofcmds;	/* the size of all the load commands */
uint32_t	flags;		/* flags */
};

#define MH_MAGIC_64 0xfeedfacf /* the 64-bit mach magic number */
#define MH_CIGAM_64 0xcffaedfe /* NXSwapInt(MH_MAGIC_64) */
struct mach_header_64 {
uint32_t	magic;		/* mach magic number identifier */
int32_t		cputype;	/* cpu specifier */
int32_t		cpusubtype;	/* machine specifier */
uint32_t	filetype;	/* type of file */
uint32_t	ncmds;		/* number of load commands */
uint32_t	sizeofcmds;	/* the size of all the load commands */
uint32_t	flags;		/* flags */
uint32_t	reserved;	/* reserved */
};
```
**рдлрд╝рд╛рдЗрд▓ рдкреНрд░рдХрд╛рд░**:

* MH\_EXECUTE (0x2): рдорд╛рдирдХ Mach-O рдХрд╛рд░реНрдпрдХрд╛рд░реА
* MH\_DYLIB (0x6): рдПрдХ Mach-O рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд┐рдВрдХреНрдб рд▓рд╛рдЗрдмреНрд░реЗрд░реА (рдЕрд░реНрдерд╛рдд .dylib)
* MH\_BUNDLE (0x8): рдПрдХ Mach-O рдмрдВрдбрд▓ (рдЕрд░реНрдерд╛рдд .bundle)
```bash
# Checking the mac header of a binary
otool -arch arm64e -hv /bin/ls
Mach header
magic  cputype cpusubtype  caps    filetype ncmds sizeofcmds      flags
MH_MAGIC_64    ARM64          E USR00     EXECUTE    19       1728   NOUNDEFS DYLDLINK TWOLEVEL PIE
```
рдпрд╛ [Mach-O View](https://sourceforge.net/projects/machoview/) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:

<figure><img src="../../../.gitbook/assets/image (4) (1) (4).png" alt=""><figcaption></figcaption></figure>

## **Mach-O рд▓реЛрдб рдХрдорд╛рдВрдбреНрд╕**

**рдлрд╝рд╛рдЗрд▓ рдХрд╛ рд▓реЗрдЖрдЙрдЯ рдореЗрдореЛрд░реА рдореЗрдВ** рдпрд╣рд╛рдБ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, **рд╕рд┐рдореНрдмрд▓ рдЯреЗрдмрд▓ рдХрд╛ рд╕реНрдерд╛рди**, рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди рдкреНрд░рд╛рд░рдВрдн рдкрд░ рдореБрдЦреНрдп рдзрд╛рдЧреЗ рдХрд╛ рд╕рдВрджрд░реНрдн, рдФрд░ рдЖрд╡рд╢реНрдпрдХ **рд╕рд╛рдЭрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА**ред рдирд┐рд░реНрджреЗрд╢ рджрд┐рдП рдЧрдП рд╣реИрдВ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓реЛрдбрд░ **(dyld)** рдХреЛ рдореЗрдореЛрд░реА рдореЗрдВ рдмрд╛рдЗрдирд░реА рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрд░ред

рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ **load\_command** рд╕рдВрд░рдЪрдирд╛, рдЬреЛ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд **`loader.h`** рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рд╣реИ:
```objectivec
struct load_command {
uint32_t cmd;           /* type of load command */
uint32_t cmdsize;       /* total size of command in bytes */
};
```
рд╡реНрдпрд╡рд╕реНрдерд╛ рдХреЛ рдЕрд▓рдЧ-рдЕрд▓рдЧ рдврдВрдЧ рд╕реЗ рд╕рдВрднрд╛рд▓рдиреЗ рд╡рд╛рд▓реЗ рд▓реЛрдб рдХрдорд╛рдВрдб рдХреЗ рд▓рдЧрднрдЧ **50 рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░** рд╣реИрдВред рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рд╡рд╛рд▓реЗ рд╣реИрдВ: `LC_SEGMENT_64`, `LC_LOAD_DYLINKER`, `LC_MAIN`, `LC_LOAD_DYLIB`, рдФрд░ `LC_CODE_SIGNATURE`ред

### **LC\_SEGMENT/LC\_SEGMENT\_64**

{% hint style="success" %}
рдореВрд▓ рд░реВрдк рд╕реЗ, рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд▓реЛрдб рдХрдорд╛рдВрдб **рдХреИрд╕реЗ \_\_TEXT** (рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдХреЛрдб) **рдФрд░ \_\_DATA** (рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рд▓рд┐рдП рдбреЗрдЯрд╛) **рд╕реЗрдЧрдореЗрдВрдЯ** рдХреЛ **рдбреЗрдЯрд╛ рдЦрдВрдб рдореЗрдВ рджрд┐рдЦрд╛рдП рдЧрдП рдСрдлрд╕реЗрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░** рдмрд╛рдЗрдирд░реА рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
{% endhint %}

рдпреЗ рдХрдорд╛рдВрдб **рд╕реЗрдЧрдореЗрдВрдЯ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд** рдХрд░рддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ **рд╡рд░реНрдЪреБрдЕрд▓ рдореЗрдореЛрд░реА рд╕реНрдкреЗрд╕** рдореЗрдВ **рдореИрдк** рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдЬрдм рдпрд╣ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛрддрд╛ рд╣реИред

рдЗрдирдореЗрдВ **рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рдХрд╛рд░** рдХреЗ рд╕реЗрдЧрдореЗрдВрдЯ рд╣реЛрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ **\_\_TEXT** рд╕реЗрдЧрдореЗрдВрдЯ, рдЬреЛ рдХрд┐рд╕реА рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЗ рдХрд╛рд░реНрдпрд╛рддреНрдордХ рдХреЛрдб рдХреЛ рдзрд╛рд░рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдФрд░ **\_\_DATA** рд╕реЗрдЧрдореЗрдВрдЯ, рдЬреЛ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдбреЗрдЯрд╛ рдХреЛ рд╕рдореЗрддрддрд╛ рд╣реИред рдпреЗ **рд╕реЗрдЧрдореЗрдВрдЯ** рдореИрдЪ-рдУ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдбреЗрдЯрд╛ рд╕реЗрдХреНрд╢рди рдореЗрдВ рд╕реНрдерд┐рдд рд╣реЛрддреЗ рд╣реИрдВред

**рдкреНрд░рддреНрдпреЗрдХ рд╕реЗрдЧрдореЗрдВрдЯ** рдХреЛ рдФрд░ рднреА рдЕрдзрд┐рдХ **рд╡рд┐рднрд╛рдЬрд┐рдд** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред **рд▓реЛрдб рдХрдорд╛рдВрдб рд╕рдВрд░рдЪрдирд╛** рдореЗрдВ **рдЬрд╛рдирдХрд╛рд░реА** рд╣реЛрддреА рд╣реИ **рдЗрди рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рднреАрддрд░ рдХреЗ рдЕрдиреБрднрд╛рдЧреЛрдВ** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВред

рд╣реЗрдбрд░ рдореЗрдВ рдкрд╣рд▓реЗ рдЖрдкрдХреЛ **рд╕реЗрдЧрдореЗрдВрдЯ рд╣реЗрдбрд░** рдорд┐рд▓рддрд╛ рд╣реИ:

<pre class="language-c"><code class="lang-c">struct segment_command_64 { /* for 64-bit architectures */
uint32_t	cmd;		/* LC_SEGMENT_64 */
uint32_t	cmdsize;	/* includes sizeof section_64 structs */
char		segname[16];	/* segment name */
uint64_t	vmaddr;		/* memory address of this segment */
uint64_t	vmsize;		/* memory size of this segment */
uint64_t	fileoff;	/* file offset of this segment */
uint64_t	filesize;	/* amount to map from the file */
int32_t		maxprot;	/* maximum VM protection */
int32_t		initprot;	/* initial VM protection */
<strong>	uint32_t	nsects;		/* number of sections in segment */
</strong>	uint32_t	flags;		/* flags */
};
</code></pre>

рд╕реЗрдЧрдореЗрдВрдЯ рд╣реЗрдбрд░ рдХрд╛ рдЙрджрд╛рд╣рд░рдг:

<figure><img src="../../../.gitbook/assets/image (2) (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ рд╣реЗрдбрд░ **рдЙрди рд╕реЗрдХреНрд╢рдиреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░рддрд╛ рд╣реИ рдЬрд┐рдирдХреЗ рд╣реЗрдбрд░ рдЗрд╕рдХреЗ рдмрд╛рдж рджрд┐рдЦрд╛рдИ рджреЗрддреЗ рд╣реИрдВ**:
```c
struct section_64 { /* for 64-bit architectures */
char		sectname[16];	/* name of this section */
char		segname[16];	/* segment this section goes in */
uint64_t	addr;		/* memory address of this section */
uint64_t	size;		/* size in bytes of this section */
uint32_t	offset;		/* file offset of this section */
uint32_t	align;		/* section alignment (power of 2) */
uint32_t	reloff;		/* file offset of relocation entries */
uint32_t	nreloc;		/* number of relocation entries */
uint32_t	flags;		/* flags (section type and attributes)*/
uint32_t	reserved1;	/* reserved (for offset or index) */
uint32_t	reserved2;	/* reserved (for count or sizeof) */
uint32_t	reserved3;	/* reserved */
};
```
рдЙрджрд╛рд╣рд░рдг рдХрд╛ **рдЦрдВрдб рд╢реАрд░реНрд╖рдХ**:

<figure><img src="../../../.gitbook/assets/image (6) (2).png" alt=""><figcaption></figcaption></figure>

рдпрджрд┐ рдЖрдк **рдЦрдВрдб рдСрдлрд╕реЗрдЯ** (0x37DC) + **рдСрдлрд╕реЗрдЯ** рдЬреЛ **рдЖрд░реНрдХ рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ**, рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ `0x18000` рдЬреЛрдбрд╝реЗрдВ --> `0x37DC + 0x18000 = 0x1B7DC`

<figure><img src="../../../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

рдпрд╣ рднреА рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЖрдк **рдХрдорд╛рдВрдб рд▓рд╛рдЗрди** рд╕реЗ **рд╣реЗрдбрд░реНрд╕ рдЬрд╛рдирдХрд╛рд░реА** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ:
```bash
otool -lv /bin/ls
```
рдЗрд╕ cmd рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рд╛рдорд╛рдиреНрдп рд╕реЗрдЧрдореЗрдВрдЯ:

* **`__PAGEZERO`:** рдпрд╣ рдХрд░реНрдиреЗрд▓ рдХреЛ рдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ **рдкрддрд╛ рд╢реВрдиреНрдп** рдХреЛ **рдореИрдк** рдХрд┐рдпрд╛ рдЬрд╛рдП рддрд╛рдХрд┐ рдЗрд╕реЗ **рдкрдврд╝рд╛ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛, рд▓рд┐рдЦрд╛ рдирд╣реАрдВ рдЬрд╛ рд╕рдХрддрд╛, рдпрд╛ рдирд╣реАрдВ рдЪрд▓рд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛**ред рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ maxprot рдФрд░ minprot рдЪрд░ рдореВрд▓реНрдп рд╢реВрдиреНрдп рдкрд░ рд╕реЗрдЯ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рдЗрд╕ рдкреГрд╖реНрда рдкрд░ **рдХреЛрдИ рдкрдврд╝рдиреЗ-рд▓рд┐рдЦрдиреЗ-рдЪрд▓рд╛рдиреЗ рдХреЗ рдЕрдзрд┐рдХрд╛рд░ рди рд╣реЛрдВ**ред
* рдпрд╣ рдЖрд╡рдВрдЯрди NULL рдкреНрд╡рд╛рдЗрдВрдЯрд░ рдбрд┐рдлрд░реЗрдВрд╕ рд╡рд▓реНрдирд░реЗрдмрд┐рд▓рд┐рдЯреА рдХреЛ **рдХрдо рдХрд░рдиреЗ** рдХреЗ рд▓рд┐рдП рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИред
* **`__TEXT`**: **рдкрд╛рдареНрдпрдХреНрд░рдореАрдп** **рдХреЛрдб** рдХреЛ **рдкрдврд╝рдиреЗ** рдФрд░ **рдЪрд▓рд╛рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ (рдХреЛрдИ рд▓рд┐рдЦрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ)**.** рдЗрд╕ рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ рд╕рд╛рдорд╛рдиреНрдп рдЦрдВрдб:
* `__text`: рдХрдВрдкрд╛рдЗрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдмрд╛рдЗрдирд░реА рдХреЛрдб
* `__const`: рд╕реНрдерд┐рд░ рдбреЗрдЯрд╛
* `__cstring`: рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╕реНрдерд┐рд░
* `__stubs` рдФрд░ `__stubs_helper`: рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд▓реЛрдбрд┐рдВрдЧ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЗ рджреМрд░рд╛рди рд╕рдВрд▓рдЧреНрди
* **`__DATA`**: рдбреЗрдЯрд╛ рдХреЛ **рдкрдврд╝рдиреЗ** рдФрд░ **рд▓рд┐рдЦрдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рд╣реИ (рдХреЛрдИ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ)**.**
* `__data`: рдЧреНрд▓реЛрдмрд▓ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ (рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдкреНрд░рд╛рд░рдВрдн рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* `__bss`: рд╕реНрдереИрддрд┐рдХ рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ (рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдкреНрд░рд╛рд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)
* `__objc_*` (\_\_objc\_classlist, \_\_objc\_protolist, рдЖрджрд┐): рдУрдмреНрдЬреЗрдХреНрдЯрд┐рд╡-рд╕реА рд░рдирдЯрд╛рдЗрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЬрд╛рдирдХрд╛рд░реА
* **`__LINKEDIT`**: рд▓рд┐рдВрдХрд░ (dyld) рдХреЗ рд▓рд┐рдП рдЬрд╛рдирдХрд╛рд░реА рд╢рд╛рдорд┐рд▓ рд╣реИ, рдЬреИрд╕реЗ, "рд╕рд┐рдореНрдмрд▓, рд╕реНрдЯреНрд░рд┐рдВрдЧ, рдФрд░ рд╕реНрдерд╛рдирд╛рдВрддрд░рдг рд╕рд╛рд░рдгрд┐рдпрд╛рдБред"
* **`__OBJC`**: рдУрдмреНрдЬреЗрдХреНрдЯрд┐рд╡-рд╕реА рд░рдирдЯрд╛рдЗрдо рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рдЬрд╛рдирдХрд╛рд░реАред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА \_\_DATA рд╕реЗрдЧрдореЗрдВрдЯ рдореЗрдВ рднреА рдорд┐рд▓ рд╕рдХрддреА рд╣реИ, рд╡рд┐рднрд┐рдиреНрди \_\_objc\_\* рдЦрдВрдбреЛрдВ рдореЗрдВред

### **`LC_MAIN`**

**entryoff рд╡рд┐рд╢реЗрд╖рддрд╛ рдореЗрдВ** рдкреНрд░рд╡реЗрд╢ рдмрд┐рдВрджреБ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИред рд▓реЛрдб рд╕рдордп рдкрд░, **dyld** рдмрд╕ (рдЗрди-рдореЗрдореЛрд░реА) рдХреЗ рдмрд╛рдЗрдирд░реА рдХреЗ **рдореВрд▓реНрдп** рдореЗрдВ рдмрд╕реНрддрд╛ рд╣реИ, рдлрд┐рд░ рдЗрд╕ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдкрд░ рдЬрд╛рддрд╛ рд╣реИ рддрд╛рдХрд┐ рдмрд╛рдЗрдирд░реА рдХреЛрдб рдХрд╛ рдирд┐рд╖реНрдкрд╛рджрди рд╢реБрд░реВ рд╣реЛ рд╕рдХреЗред

### **LC\_CODE\_SIGNATURE**

Macho-O рдлрд╝рд╛рдЗрд▓ рдХреЗ **рдХреЛрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд╢рд╛рдорд┐рд▓ рд╣реИред рдпрд╣ рдХреЗрд╡рд▓ рдПрдХ **рдУрдлрд╝рд╕реЗрдЯ** рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ рдЬреЛ **рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдмреНрд▓реЙрдм** рдХреА рдУрд░ **рдЗрд╢рд╛рд░рд╛ рдХрд░рддрд╛ рд╣реИ**ред рдпрд╣ рдЖрдо рддреМрд░ рдкрд░ рдлрд╝рд╛рдЗрд▓ рдХреЗ рдЕрдВрдд рдореЗрдВ рд╣реЛрддрд╛ рд╣реИред\
рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдЗрд╕ рдЦрдВрдб рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдХреБрдЫ рдЬрд╛рдирдХрд╛рд░реА [**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://davedelong.com/blog/2018/01/10/reading-your-own-entitlements/) рдФрд░ рдЗрд╕ [**рдЧрд┐рд╕реНрдЯ**](https://gist.github.com/carlospolop/ef26f8eb9fafd4bc22e69e1a32b81da4) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

### **LC\_LOAD\_DYLINKER**

рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдкрддреЗ рдореЗрдВ рд╕рд╛рдЭрд╛ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореИрдк рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд┐рдВрдХрд░ рдХрд╛рд░реНрдпрдХреНрд╖рдо рдХреЗ **рдкрде** рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИред **рдорд╛рди рд╣рдореЗрд╢рд╛ `/usr/lib/dyld` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ macOS рдореЗрдВ, dylib рдореИрдкрд┐рдВрдЧ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдореЛрдб** рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ, рдХрд░реНрдиреЗрд▓ рдореЛрдб рдореЗрдВ рдирд╣реАрдВред

### **`LC_LOAD_DYLIB`**

рдпрд╣ рд▓реЛрдб рдХрдорд╛рдВрдб рдПрдХ **рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА** рдЖрд╡рд╢реНрдпрдХрддрд╛ рдХрд╛ рд╡рд░реНрдгрди рдХрд░рддрд╛ рд╣реИ рдЬреЛ **рд▓реЛрдбрд░** (dyld) рдХреЛ **рдЙрд╕ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЛ рд▓реЛрдб рдФрд░ рд▓рд┐рдВрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджреЗрд╢рд┐рдд** рдХрд░рддрд╛ рд╣реИред Mach-O рдмрд╛рдЗрдирд░реА рдХреЗ рдкреНрд░рддреНрдпреЗрдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХреЗ рд▓рд┐рдП рдПрдХ LC\_LOAD\_DYLIB рд▓реЛрдб рдХрдорд╛рдВрдб рд╣реЛрддрд╛ рд╣реИред

* рдпрд╣ рд▓реЛрдб рдХрдорд╛рдВрдб рдПрдХ рдкреНрд░рдХрд╛рд░ рдХреА рд╕рдВрд░рдЪрдирд╛ рд╣реИ **`dylib_command`** (рдЬрд┐рд╕рдореЗрдВ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдирд┐рд░реНрднрд░ рдбрд╛рдпрдирд╛рдорд┐рдХ рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рд╡рд░реНрдгрди рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд╕реНрдЯреНрд░рдХреНрдЯ рдбрд╛рдпрд▓рд┐рдм рд╣реЛрддрд╛ рд╣реИ):
```objectivec
struct dylib_command {
uint32_t        cmd;            /* LC_LOAD_{,WEAK_}DYLIB */
uint32_t        cmdsize;        /* includes pathname string */
struct dylib    dylib;          /* the library identification */
};

struct dylib {
union lc_str  name;                 /* library's path name */
uint32_t timestamp;                 /* library's build time stamp */
uint32_t current_version;           /* library's current version number */
uint32_t compatibility_version;     /* library's compatibility vers number*/
};
```
![](<../../../.gitbook/assets/image (558).png>)

рдЖрдк рдЗрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рднреА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```bash
otool -L /bin/ls
/bin/ls:
/usr/lib/libutil.dylib (compatibility version 1.0.0, current version 1.0.0)
/usr/lib/libncurses.5.4.dylib (compatibility version 5.4.0, current version 5.4.0)
/usr/lib/libSystem.B.dylib (compatibility version 1.0.0, current version 1319.0.0)
```
рдХреБрдЫ рд╕рдВрднрд╛рд╡рд┐рдд рдореИрд▓рд╡реЗрдпрд░ рд╕рдВрдмрдВрдзрд┐рдд рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рд╣реИрдВ:

* **DiskArbitration**: USB рдбреНрд░рд╛рдЗрд╡ рдХреА рдореЙрдирд┐рдЯрд░рд┐рдВрдЧ
* **AVFoundation:** рдСрдбрд┐рдпреЛ рдФрд░ рд╡реАрдбрд┐рдпреЛ рдХреИрдкреНрдЪрд░
* **CoreWLAN**: рд╡рд╛рдИрдлрд╛рдИ рд╕реНрдХреИрдиред

{% hint style="info" %}
рдПрдХ Mach-O рдмрд╛рдЗрдирд░реА рдореЗрдВ рдПрдХ рдпрд╛ **рдПрдХ рд╕реЗ рдЕрдзрд┐рдХ рдирд┐рд░реНрдорд╛рддрд╛рдУрдВ** рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ **LC\_MAIN** рдореЗрдВ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдкрддреЗ рд╕реЗ **рдкрд╣рд▓реЗ** **рдЪрд▓рд╛рдП рдЬрд╛рдПрдВрдЧреЗ**ред\
рдХрд┐рд╕реА рднреА рдирд┐рд░реНрдорд╛рддрд╛рдУрдВ рдХреЗ рдСрдлрд╕реЗрдЯ **\_\_DATA\_CONST** рд╕реЗрдЧрдореЗрдВрдЯ рдХреЗ **\_\_mod\_init\_func** рдЦрдВрдб рдореЗрдВ рд░рдЦреЗ рдЬрд╛рддреЗ рд╣реИрдВред
{% endhint %}

## **Mach-O рдбреЗрдЯрд╛**

рдлрд╝рд╛рдЗрд▓ рдХреЗ рдореВрд▓ рдореЗрдВ рдбреЗрдЯрд╛ рдХреНрд╖реЗрддреНрд░ рд╣реЛрддрд╛ рд╣реИ, рдЬреЛ рд▓реЛрдб-рдХрдорд╛рдВрдбреНрд╕ рдХреНрд╖реЗрддреНрд░ рдореЗрдВ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрдИ рд╕реЗрдЧрдореЗрдВрдЯреЛрдВ рд╕реЗ рдмрдирд╛ рд╣реЛрддрд╛ рд╣реИред **рдкреНрд░рддреНрдпреЗрдХ рд╕реЗрдЧрдореЗрдВрдЯ рдореЗрдВ рдХрдИ рдбреЗрдЯрд╛ рдЦрдВрдб рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ**, рд╣рд░ рдЦрдВрдб **рдХреЛрдб рдпрд╛ рдбреЗрдЯрд╛** рд╡рд┐рд╢реЗрд╖ рдХреЗ рд▓рд┐рдПред

{% hint style="success" %}
рдбреЗрдЯрд╛ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдЙрд╕ рд╕рднреА **рдЬрд╛рдирдХрд╛рд░реА** рдХреЛ рд╕рдореЗрдЯрддрд╛ рд╣реИ рдЬреЛ рд▓реЛрдб рдХрдорд╛рдВрдбреНрд╕ **LC\_SEGMENTS\_64** рджреНрд╡рд╛рд░рд╛ рд▓реЛрдб рдХреА рдЬрд╛рддреА рд╣реИред
{% endhint %}

![https://www.oreilly.com/api/v2/epubs/9781785883378/files/graphics/B05055_02_38.jpg](<../../../.gitbook/assets/image (507) (3).png>)

рдЗрд╕рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

* **рдХрд╛рд░реНрдп рд╕рд╛рд░рдгреА:** рдЬреЛ рдХрд╛рд░реНрдп рдХрд╛рд░реНрдпреЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд░рдЦрддреА рд╣реИред
* **рдкреНрд░рддреАрдХ рд╕рд╛рд░рдгреА**: рдЬреЛ рдмрд╛рдЗрдирд░реА рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ рдмрд╛рд╣реНрдп рдХрд╛рд░реНрдп рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬрд╛рдирдХрд╛рд░реА рд░рдЦрддреА рд╣реИ
* рдпрд╣ рдЖрдВрддрд░рд┐рдХ рдХрд╛рд░реНрдп, рдЪрд░ рдирд╛рдореЛрдВ рдХреЛ рднреА рд╢рд╛рдорд┐рд▓ рдХрд░ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЕрдзрд┐рдХред

рдЗрд╕реЗ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк [**Mach-O View**](https://sourceforge.net/projects/machoview/) рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

<figure><img src="../../../.gitbook/assets/image (2) (1) (4).png" alt=""><figcaption></figcaption></figure>

рдпрд╛ CLI рд╕реЗ:
```bash
size -m /bin/ls
```
<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

рджреВрд╕рд░реЗ рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** PRs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
