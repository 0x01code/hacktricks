# Llavero de macOS

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Revisa los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) es un motor de b칰squeda alimentado por la **dark web** que ofrece funcionalidades **gratuitas** para verificar si una empresa o sus clientes han sido **comprometidos** por **malwares robadores**.

El objetivo principal de WhiteIntel es combatir tomas de cuentas y ataques de ransomware resultantes de malwares que roban informaci칩n.

Puedes visitar su sitio web y probar su motor de forma **gratuita** en:

{% embed url="https://whiteintel.io" %}

***

## Llaveros Principales

* El **Llavero de Usuario** (`~/Library/Keychains/login.keycahin-db`), que se utiliza para almacenar **credenciales espec칤ficas del usuario** como contrase침as de aplicaciones, contrase침as de internet, certificados generados por el usuario, contrase침as de red y claves p칰blicas/privadas generadas por el usuario.
* El **Llavero del Sistema** (`/Library/Keychains/System.keychain`), que almacena **credenciales de todo el sistema** como contrase침as de WiFi, certificados ra칤z del sistema, claves privadas del sistema y contrase침as de aplicaciones del sistema.

### Acceso al Llavero de Contrase침as

Estos archivos, aunque no tienen protecci칩n inherente y pueden ser **descargados**, est치n encriptados y requieren la **contrase침a en texto plano del usuario para ser desencriptados**. Una herramienta como [**Chainbreaker**](https://github.com/n0fate/chainbreaker) podr칤a ser utilizada para la desencriptaci칩n.

## Protecciones de las Entradas del Llavero

### Listas de Control de Acceso (ACLs)

Cada entrada en el llavero est치 gobernada por **Listas de Control de Acceso (ACLs)** que dictan qui칠n puede realizar varias acciones en la entrada del llavero, incluyendo:

* **ACLAuhtorizationExportClear**: Permite al titular obtener el texto claro del secreto.
* **ACLAuhtorizationExportWrapped**: Permite al titular obtener el texto claro encriptado con otra contrase침a proporcionada.
* **ACLAuhtorizationAny**: Permite al titular realizar cualquier acci칩n.

Las ACLs est치n acompa침adas por una **lista de aplicaciones de confianza** que pueden realizar estas acciones sin solicitar permiso. Esto podr칤a ser:

* **N`il`** (no se requiere autorizaci칩n, **todos son de confianza**)
* Una lista **vac칤a** (nadie es de confianza)
* **Lista** de **aplicaciones** espec칤ficas.

Adem치s, la entrada podr칤a contener la clave **`ACLAuthorizationPartitionID`,** que se utiliza para identificar el **teamid, apple,** y **cdhash.**

* Si se especifica el **teamid**, entonces para **acceder al valor de la entrada** sin una **solicitud**, la aplicaci칩n utilizada debe tener el **mismo teamid**.
* Si se especifica el **apple**, entonces la aplicaci칩n debe estar **firmada** por **Apple**.
* Si se indica el **cdhash**, entonces la aplicaci칩n debe tener el **cdhash** espec칤fico.

### Creaci칩n de una Entrada en el Llavero

Cuando se crea una **nueva** **entrada** utilizando **`Keychain Access.app`**, se aplican las siguientes reglas:

* Todas las aplicaciones pueden encriptar.
* **Ninguna aplicaci칩n** puede exportar/desencriptar (sin solicitar al usuario).
* Todas las aplicaciones pueden ver la comprobaci칩n de integridad.
* Ninguna aplicaci칩n puede cambiar las ACLs.
* El **partitionID** se establece en **`apple`**.

Cuando una **aplicaci칩n crea una entrada en el llavero**, las reglas son ligeramente diferentes:

* Todas las aplicaciones pueden encriptar.
* Solo la **aplicaci칩n creadora** (o cualquier otra aplicaci칩n a침adida expl칤citamente) puede exportar/desencriptar (sin solicitar al usuario).
* Todas las aplicaciones pueden ver la comprobaci칩n de integridad.
* Ninguna aplicaci칩n puede cambiar las ACLs.
* El **partitionID** se establece en **`teamid:[teamID aqu칤]`**.

## Accediendo al Llavero

### `security`
```bash
# Dump all metadata and decrypted secrets (a lot of pop-ups)
security dump-keychain -a -d

# Find generic password for the "Slack" account and print the secrets
security find-generic-password -a "Slack" -g

# Change the specified entrys PartitionID entry
security set-generic-password-parition-list -s "test service" -a "test acount" -S
```
### APIs

{% hint style="success" %}
La **enumeraci칩n y volcado de contrase침as** del llavero que **no generar치 un aviso** se puede hacer con la herramienta [**LockSmith**](https://github.com/its-a-feature/LockSmith)
{% endhint %}

Listar y obtener **informaci칩n** sobre cada entrada del llavero:

* La API **`SecItemCopyMatching`** proporciona informaci칩n sobre cada entrada y hay algunos atributos que se pueden configurar al usarla:
* **`kSecReturnData`**: Si es verdadero, intentar치 descifrar los datos (establecer en falso para evitar posibles ventanas emergentes)
* **`kSecReturnRef`**: Obtener tambi칠n la referencia al elemento del llavero (establecer en verdadero en caso de que luego veas que puedes descifrar sin ventana emergente)
* **`kSecReturnAttributes`**: Obtener metadatos sobre las entradas
* **`kSecMatchLimit`**: Cu치ntos resultados devolver
* **`kSecClass`**: Qu칠 tipo de entrada del llavero

Obtener **ACLs** de cada entrada:

* Con la API **`SecAccessCopyACLList`** puedes obtener el **ACL del elemento del llavero**, y devolver치 una lista de ACLs (como `ACLAuhtorizationExportClear` y los otros mencionados anteriormente) donde cada lista tiene:
* Descripci칩n
* **Lista de aplicaciones de confianza**. Esto podr칤a ser:
* Una aplicaci칩n: /Applications/Slack.app
* Un binario: /usr/libexec/airportd
* Un grupo: group://AirPort

Exportar los datos:

* La API **`SecKeychainItemCopyContent`** obtiene el texto plano
* La API **`SecItemExport`** exporta las claves y certificados pero podr칤a ser necesario establecer contrase침as para exportar el contenido cifrado

Y estos son los **requisitos** para poder **exportar un secreto sin un aviso**:

* Si hay **1 o m치s aplicaciones de confianza** listadas:
* Necesita las **autorizaciones** apropiadas (**`Nil`**, o ser **parte** de la lista permitida de aplicaciones en la autorizaci칩n para acceder a la informaci칩n secreta)
* Necesita que la firma del c칩digo coincida con **PartitionID**
* Necesita que la firma del c칩digo coincida con la de una **aplicaci칩n de confianza** (o ser miembro del grupo KeychainAccessGroup correcto)
* Si **todas las aplicaciones son de confianza**:
* Necesita las **autorizaciones** apropiadas
* Necesita que la firma del c칩digo coincida con **PartitionID**
* Si no hay **PartitionID**, entonces esto no es necesario

{% hint style="danger" %}
Por lo tanto, si hay **1 aplicaci칩n listada**, necesitas **inyectar c칩digo en esa aplicaci칩n**.

Si se indica **apple** en el **PartitionID**, podr칤as acceder con **`osascript`** a cualquier cosa que conf칤e en todas las aplicaciones con apple en el PartitionID. **`Python`** tambi칠n podr칤a ser usado para esto.
{% endhint %}

### Dos atributos adicionales

* **Invisible**: Es un indicador booleano para **ocultar** la entrada de la aplicaci칩n del llavero **UI**
* **General**: Es para almacenar **metadatos** (por lo que NO EST츼 CIFRADO)
* Microsoft estaba almacenando en texto plano todos los tokens de actualizaci칩n para acceder a puntos finales sensibles.

## Referencias

* [**#OBTS v5.0: "Lock Picking the macOS Keychain" - Cody Thomas**](https://www.youtube.com/watch?v=jKE1ZW33JpY)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) es un motor de b칰squeda alimentado por la **dark web** que ofrece funcionalidades **gratuitas** para verificar si una empresa o sus clientes han sido **comprometidos** por **malwares robadores**.

El objetivo principal de WhiteIntel es combatir las tomas de cuentas y los ataques de ransomware resultantes de malwares que roban informaci칩n.

Puedes visitar su sitio web y probar su motor de b칰squeda de forma **gratuita** en:

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
Aprende y practica Hacking en AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprende y practica Hacking en GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Apoya a HackTricks</summary>

* 춰Consulta los [**planes de suscripci칩n**](https://github.com/sponsors/carlospolop)!
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Comparte trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
{% endhint %}
