# macOS Keychain

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Κύρια Keychains

* Το **Keychain του χρήστη** (`~/Library/Keychains/login.keycahin-db`), το οποίο χρησιμοποιείται για να αποθηκεύει **συνθηματικά που αφορούν τον χρήστη** όπως κωδικοί πρόσβασης εφαρμογών, κωδικοί πρόσβασης στο διαδίκτυο, πιστοποιητικά που δημιουργήθηκαν από τον χρήστη, κωδικοί πρόσβασης δικτύου και δημόσια/ιδιωτικά κλειδιά που δημιουργήθηκαν από τον χρήστη.
* Το **Keychain του συστήματος** (`/Library/Keychains/System.keychain`), το οποίο αποθηκεύει **συνθηματικά που αφορούν ολόκληρο το σύστημα** όπως κωδικοί πρόσβασης WiFi, πιστοποιητικά ρίζας συστήματος, ιδιωτικά κλειδιά συστήματος και κωδικοί πρόσβασης εφαρμογών συστήματος.

### Πρόσβαση στο Keychain Κωδικού

Αυτά τα αρχεία, παρόλο που δεν έχουν ενσωματωμένη προστασία και μπορούν να **κατεβληθούν**, είναι κρυπτογραφημένα και απαιτούν το **καθαρό κείμενο του κωδικού πρόσβασης του χρήστη για να αποκρυπτογραφηθούν**. Ένα εργαλείο όπως το [**Chainbreaker**](https://github.com/n0fate/chainbreaker) μπορεί να χρησιμοποιηθεί για την αποκρυπτογράφηση.

## Προστασίες Καταχωρήσεων Keychain

### ACLs

Κάθε καταχώρηση στο keychain διέπεται από **Λίστες Ελέγχου Πρόσβασης (ACLs)** που καθορίζουν ποιος μπορεί να εκτελέσει διάφορες ενέργειες στην καταχώρηση του keychain, συμπεριλαμβανομένων:

* **ACLAuhtorizationExportClear**: Επιτρέπει στον κάτοχο να λάβει το καθαρό κείμενο του μυστικού.
* **ACLAuhtorizationExportWrapped**: Επιτρέπει στον κάτοχο να λάβει το καθαρό κείμενο κρυπτογραφημένο με έναν άλλο καθορισμένο κωδικό πρόσβασης.
* **ACLAuhtorizationAny**: Επιτρέπει στον κάτοχο να εκτελέσει οποιαδήποτε ενέργεια.

Οι ACLs συνοδεύονται επίσης από μια **λίστα αξιόπιστων εφαρμογών** που μπορούν να εκτελέσουν αυτές τις ενέργειες χωρίς να ζητηθεί επιβεβαίωση. Αυτό μπορεί να είναι:

* &#x20;**N`il`** (δεν απαιτείται εξουσιοδότηση, **όλοι είναι αξιόπιστοι**)
* Μια **κενή** λίστα (**κανείς** δεν είναι αξιόπιστος)
* **Λίστα** συγκεκριμένων **εφαρμογών**.

Επίσης, η καταχώρηση μπορεί να περιέχει το κλειδί **`ACLAuthorizationPartitionID`**, το οποίο χρησιμοποιείται για την αναγνώριση του **teamid, apple** και **cdhash**.

* Εάν το **teamid** είναι καθορισμένο, τότε για να **έχει πρόσβαση** στην τιμή της καταχώρησης **χωρίς** ερώτημα, η χρησιμοποιούμενη εφαρμογή πρέπει να έχει το **ίδιο teamid**.
* Εάν το **apple** είναι καθορισμένο, τότε η εφαρμογή πρέπει να είναι **υπογεγραμμένη** από την **Apple**.
* Εάν το **cdhash** είναι καθορισμένο, τότε η εφαρμογή πρέπει να έχει το συγκεκριμένο **cdhash**.

### Δημιουργία Καταχώρησης Keychain

Όταν δημιουργείται μια **νέα καταχώρηση** χρησιμοποιώντας το **`Keychain Access.app`**, ισχύουν οι εξής κανόνες:

* Όλες οι εφαρμογές μπορούν να κρυπτογραφήσουν.
* **Καμία εφαρμογή** δεν μπορεί να εξαγάγει/αποκρυπτογραφήσει (χωρίς να ζητηθεί επιβεβαίωση από τον χρήστη).
* Όλες οι εφαρμογές μπορούν να δουν τον έλεγχο ακεραιότητας.
* Καμία εφαρμογή δεν μπορεί να αλλάξει τις ACLs.
* Το **partitionID** ορίζεται σε **`apple`**.

Όταν μια **εφαρμογή δημιουργεί μια καταχώρηση στο keychain**, οι κανόνες είναι ελαφρώς διαφορετ
```bash
# Dump all metadata and decrypted secrets (a lot of pop-ups)
security dump-keychain -a -d

# Find generic password for the "Slack" account and print the secrets
security find-generic-password -a "Slack" -g

# Change the specified entrys PartitionID entry
security set-generic-password-parition-list -s "test service" -a "test acount" -S
```
### ΑΠΙ

{% hint style="success" %}
Η **απαρίθμηση και απόρριψη** μυστικών του **keychain που δεν θα προκαλέσει ερώτηση** μπορεί να γίνει με το εργαλείο [**LockSmith**](https://github.com/its-a-feature/LockSmith)
{% endhint %}

Λίστα και λήψη **πληροφοριών** για κάθε καταχώρηση keychain:

* Η API **`SecItemCopyMatching`** δίνει πληροφορίες για κάθε καταχώρηση και υπάρχουν ορισμένα χαρακτηριστικά που μπορείτε να ορίσετε κατά τη χρήση της:
* **`kSecReturnData`**: Εάν είναι true, θα προσπαθήσει να αποκρυπτογραφήσει τα δεδομένα (ορίστε το σε false για να αποφευχθούν πιθανές αναδυόμενες παράθυρα)
* **`kSecReturnRef`**: Λήψη αναφοράς στο στοιχείο keychain (ορίστε το σε true σε περίπτωση που αργότερα δείτε ότι μπορείτε να αποκρυπτογραφήσετε χωρίς αναδυόμενο παράθυρο)
* **`kSecReturnAttributes`**: Λήψη μεταδεδομένων για τις καταχωρήσεις
* **`kSecMatchLimit`**: Πόσα αποτελέσματα να επιστραφούν
* **`kSecClass`**: Τι είδους καταχώρηση keychain

Λήψη **ACLs** για κάθε καταχώρηση:

* Με την API **`SecAccessCopyACLList`** μπορείτε να λάβετε το **ACL για το στοιχείο keychain**, και θα επιστρέψει μια λίστα με τα ACLs (όπως `ACLAuhtorizationExportClear` και τα άλλα προηγουμένως αναφερθέντα) όπου κάθε λίστα έχει:
* Περιγραφή
* **Λίστα Εμπιστευμένων Εφαρμογών**. Αυτό μπορεί να είναι:
* Μια εφαρμογή: /Applications/Slack.app
* Ένα δυαδικό αρχείο: /usr/libexec/airportd
* Μια ομάδα: group://AirPort

Εξαγωγή των δεδομένων:

* Η API **`SecKeychainItemCopyContent`** λαμβάνει το κείμενο καθαρού κειμένου
* Η API **`SecItemExport`** εξάγει τα κλειδιά και τα πιστοποιητικά, αλλά μπορεί να χρειαστεί να ορίσετε κωδικούς πρόσβασης για να εξαχθούν τα περιεχόμενα κρυπτογραφημένα

Και αυτές είναι οι **απαιτήσεις** για να μπορείτε να **εξάγετε ένα μυστικό χωρίς ερώτηση**:

* Εάν υπάρχουν **1+ εμπιστευμένες** εφαρμογές που αναφέρονται:
* Χρειάζεστε τις κατάλληλες **εξουσιοδοτήσεις** (**`Nil`**, ή να είστε **μέρος** της επιτρεπόμενης λίστας εφαρμογών στην εξουσιοδότηση για πρόσβαση στις πληροφορίες του μυστικού)
* Χρειάζεστε την υπογραφή κώδικα για να ταιριάζει με το **PartitionID**
* Χρειάζεστε την υπογραφή κώδικα για να ταιριάζει με μια **εμπιστευμένη εφαρμογή** (ή να είστε μέλος της σωστής KeychainAccessGroup)
* Εάν **εμπιστεύονται όλες οι εφαρμογές**:
* Χρειάζεστε τις κατάλληλες **εξουσιοδοτήσεις**
* Χρειάζεστε την υπογραφή κώδικα για να ταιριάζει με το **PartitionID**
* Εάν δεν υπάρχει **PartitionID**, τότε αυτό δεν είναι απαραίτητο

{% hint style="danger" %}
Συνεπώς, εάν υπάρχει **1 εφαρμογή που αναφέρεται**, χρειάζεστε να **ενσωματώσετε κώδικα σε αυτήν την εφαρμογή**.

Εάν η λέξη **apple** αναφέρεται στο **partitionID**, μπορείτε να αποκτήσετε πρόσβαση με τη χρήση της εντολής **`osascript`**, οπότε οτιδήποτε εμπιστεύεται όλες τις εφαρμογές με το apple στο partitionID. Μπορεί να χρησιμοποιηθεί επίσης το **`Python`** για αυτό.
{% endhint %}

### Δύο επιπλέον χαρακτηριστικά

* **Αόρατο**: Είναι ένα σημαία boolean για να **αποκρύψει** την καταχώρηση από την εφαρμογή **UI** Keychain
* **Γενικό**: Χρησιμοποιείται για την αποθήκευση **μεταδεδομένων** (οπότε ΔΕΝ ΕΙΝΑΙ ΚΡΥΠΤΟΓΡΑΦΗΜΕΝΟ)
* Η Microsoft αποθήκευε όλα τα διακριτικά ανανέωσης σε καθαρό κείμενο για πρόσβαση σε ευαίσθητα σημεία πρόσβασης.

## Αναφορές

* [**#OBTS v5.0: "Lock Picking the macOS Keychain" - Cody Thomas**](https://www.youtube.com/watch?v=jKE1ZW33JpY)

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στην** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε
