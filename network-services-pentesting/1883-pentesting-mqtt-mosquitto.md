# 1883 - MQTT (Mosquitto) Pentesting

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na (https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

## Temel Bilgiler

**MQ Telemetry Transport (MQTT)**, aşırı basitlik ve hafiflik açısından öne çıkan bir **yayın/abone mesajlaşma protokolü** olarak bilinir. Bu protokol özellikle, cihazların sınırlı yeteneklere sahip olduğu ve düşük bant genişliği, yüksek gecikme süresi veya güvenilir olmayan bağlantılarla karakterize edilen ağlarda çalıştığı ortamlar için özel olarak tasarlanmıştır. MQTT'nin temel amaçları arasında ağ bant genişliğinin kullanımını en aza indirgeme ve cihaz kaynaklarına olan talebi azaltma yer alır. Ayrıca, güvenilir iletişimi sürdürmeyi ve belirli bir teslimat güvencesi düzeyi sağlamayı amaçlar. Bu hedefler, MQTT'yi **makine-makine (M2M) iletişimi** ve **Nesnelerin İnterneti (IoT)** alanı için son derece uygun hale getirir, burada birçok cihazın verimli bir şekilde bağlanması esastır. Ayrıca, MQTT, bant genişliğini ve pil ömrünü korumanın önemli olduğu mobil uygulamalar için son derece faydalıdır.

**Varsayılan port:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## Trafik kontrolü

MQTT brokerlarına bir **CONNECT** paketi geldiğinde, bir **CONNACK** paketi geri gönderilir. Bu paket, bağlantı durumunu anlamak için önemli olan bir dönüş kodunu içerir. **0x00** dönüş kodu, kimlik bilgilerinin kabul edildiğini ve başarılı bir bağlantıyı gösterir. Öte yandan, **0x05** dönüş kodu, kimlik bilgilerinin geçersiz olduğunu belirterek bağlantıyı engeller.

Örneğin, broker kimlik bilgilerinin geçersiz olması nedeniyle bağlantıyı reddederse, senaryo şöyle görünecektir:
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (973).png>)

### [**Brute-Force MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## MQTT Pentesting

**Kimlik doğrulama tamamen isteğe bağlıdır** ve hatta kimlik doğrulaması yapılıyor olsa bile, **varsayılan olarak şifreleme kullanılmaz** (kimlik bilgileri düz metin olarak gönderilir). MITM saldırıları hala gerçekleştirilerek şifreler çalınabilir.

MQTT hizmetine bağlanmak için şu adımları kullanabilirsiniz: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) ve tüm konulara kendinizi abone yapabilirsiniz:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
Ayrıca [**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn) kullanabilirsiniz.
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscriribe to 'test/topic'
```
Ya da **bu kodu çalıştırarak kimlik doğrulaması olmadan bir MQTT servisine bağlanmayı deneyebilir, her konuya abone olabilir ve onları dinleyebilirsiniz**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## Daha fazla bilgi

buradan: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### Yayın/Abone Olma Modeli <a href="#b667" id="b667"></a>

Yayın/abone olma modeli şunlardan oluşur:

- **Yayıncı**: mesajı bir veya birden fazla konuya broker'a yayınlar.
- **Abone**: broker'daki bir veya birden fazla konuya abone olur ve yayıncıdan gönderilen tüm mesajları alır.
- **Broker**: yayıncılardan gelen tüm mesajları abonelere yönlendirir.
- **Konu**: bir veya daha fazla seviyeden oluşur ve bir ileri eğik çizgi ile ayrılır (örneğin, /smartshouse/livingroom/temperature).

### Paket Formatı <a href="#f15a" id="f15a"></a>

Her MQTT paketi sabit bir başlık içerir (Şekil 02). Şekil 02: Sabit Başlık

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### Paket Türleri

- CONNECT (1): İstemcinin sunucuya bağlantı isteğinde bulunmak için başlatılır.
- CONNACK (2): Başarılı bir bağlantının sunucu tarafından onaylanması.
- PUBLISH (3): İstemciden sunucuya veya tersine bir mesaj göndermek için kullanılır.
- PUBACK (4): Bir PUBLISH paketinin onaylanması.
- PUBREC (5): Mesajın alındığından emin olmak için bir iletişim teslimat protokolünün parçası.
- PUBREL (6): Mesaj teslimatında daha fazla güvence sağlayarak bir mesajın serbest bırakılmasını gösterir.
- PUBCOMP (7): Tamamlanmayı gösteren mesaj teslimat protokolünün final kısmı.
- SUBSCRIBE (8): Bir istemcinin bir konudan gelen mesajları dinlemek için bir isteği.
- SUBACK (9): SUBSCRIBE isteğinin sunucu tarafından onaylanması.
- UNSUBSCRIBE (10): Bir istemcinin bir konudan gelen mesajları almaya son vermek için bir isteği.
- UNSUBACK (11): UNSUBSCRIBE isteğine sunucunun yanıtı.
- PINGREQ (12): İstemci tarafından gönderilen bir kalp atışı mesajı.
- PINGRESP (13): Sunucunun kalp atışı mesajına yanıtı.
- DISCONNECT (14): Bağlantıyı sonlandırmak için istemci tarafından başlatılır.
- 0 ve 15 olarak iki değer, ayrılmış olarak işaretlenmiş ve kullanımları yasaktır.

## Shodan

- `port:1883 MQTT`

<details>

<summary><strong>Sıfırdan kahraman olacak şekilde AWS hacklemeyi öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

- **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na (https://github.com/sponsors/carlospolop) göz atın!
- [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
- 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi Twitter'da 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)'da takip edin.
- **Hacking püf noktalarınızı göndererek HackTricks ve HackTricks Cloud github depolarına PR göndererek paylaşın.**

</details>
