## Informaci√≥n B√°sica

MQTT significa MQ Telemetry Transport. Es un protocolo de mensajer√≠a de publicaci√≥n/suscripci√≥n, **extremadamente simple y ligero**, dise√±ado para dispositivos limitados y redes de baja velocidad de ancho de banda, alta latencia o poco confiables. Los principios de dise√±o son minimizar el ancho de banda de la red y los requisitos de recursos del dispositivo, al mismo tiempo que se intenta garantizar la confiabilidad y cierto grado de garant√≠a de entrega. Estos principios tambi√©n resultan ideales para el mundo emergente de "m√°quina a m√°quina" (M2M) o "Internet de las cosas" de dispositivos conectados, y para aplicaciones m√≥viles donde el ancho de banda y la energ√≠a de la bater√≠a son limitados.

**Puerto predeterminado:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## Inspeccionando el tr√°fico

Los brokers MQTT env√≠an un paquete **CONNACK** en **respuesta** a un paquete CONNECT. El **c√≥digo de retorno 0x00** indica que las credenciales son v√°lidas y el c√≥digo de retorno **0x05 indica que no lo son. Ejemplo de 0x05:**

![](<../.gitbook/assets/image (645) (1).png>)

### [**Brute-Force MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## Pentesting MQTT

La **autenticaci√≥n es totalmente opcional** e incluso si se realiza la autenticaci√≥n, **el cifrado no se utiliza por defecto** (las credenciales se env√≠an en texto claro). Los ataques MITM a√∫n pueden ser ejecutados para robar contrase√±as.

Para conectarse a un servicio MQTT se puede utilizar: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) y suscribirse a todos los temas haciendo:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
Tambi√©n puedes utilizar [**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn)
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscriribe to 'test/topic'
```
O tambi√©n puedes **ejecutar este c√≥digo para intentar conectarte a un servicio MQTT sin autenticaci√≥n, suscribirte a todos los temas y escucharlos**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
	client.subscribe('#', qos=1)
	client.subscribe('$SYS/#')

def on_message(client, userdata, message):
	print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
	client = mqtt.Client()
	client.on_connect = on_connect
	client.on_message = on_message
	client.connect(HOST, PORT)
	client.loop_start()
	#time.sleep(10)
	#client.loop_stop()

if __name__ == "__main__":
	main()
```
## M√°s informaci√≥n

desde aqu√≠: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### El patr√≥n Publicar/Suscribir <a href="#b667" id="b667"></a>

El modelo publicar/suscribir est√° compuesto por:

* **Editor**: publica un mensaje en uno (o muchos) tema(s) en el broker.
* **Suscriptor**: se suscribe a uno (o muchos) tema(s) en el broker y recibe todos los mensajes enviados por el editor.
* **Broker**: enruta todos los mensajes de los editores a los suscriptores.
* **Tema**: consta de uno o m√°s niveles que est√°n separados por una barra diagonal (por ejemplo, /smartshouse/livingroom/temperature).

![](https://miro.medium.com/max/1073/1\*sIxvchdgHSqAGebJjFHBAg.png)

### Formato del paquete <a href="#f15a" id="f15a"></a>

Cada paquete MQTT contiene una cabecera fija (Figura 02).Figura 02: Cabecera fija

![](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

El primer campo de la cabecera fija representa el tipo de paquete MQTT. Todos los tipos de paquetes se enumeran en la tabla 01.Tabla 01: Tipos de paquetes MQTT

![](https://miro.medium.com/max/1469/1\*z0fhdUVzGa0PLikH\_cyBmQ.png)

## Shodan

* `port:1883 MQTT`

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øo quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**La familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
