# 1883 - Pentesting MQTT (Mosquitto)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) ist eine von **Dark Web** angetriebene Suchmaschine, die **kostenlose** Funktionen bietet, um zu √ºberpr√ºfen, ob ein Unternehmen oder seine Kunden von **Stealer-Malware** **kompromittiert** wurden.

Das Hauptziel von WhiteIntel ist es, Konto√ºbernahmen und Ransomware-Angriffe zu bek√§mpfen, die durch informationsstehlende Malware verursacht werden.

Sie k√∂nnen ihre Website besuchen und ihren Motor **kostenlos** ausprobieren unter:

{% embed url="https://whiteintel.io" %}

***

## Grundlegende Informationen

**MQ Telemetry Transport (MQTT)** ist als ein **Publish/Subscribe-Messaging-Protokoll** bekannt, das sich durch seine extreme Einfachheit und Leichtigkeit auszeichnet. Dieses Protokoll ist speziell f√ºr Umgebungen konzipiert, in denen Ger√§te √ºber begrenzte F√§higkeiten verf√ºgen und √ºber Netzwerke arbeiten, die durch geringe Bandbreite, hohe Latenzzeiten oder unzuverl√§ssige Verbindungen gekennzeichnet sind. Die Hauptziele von MQTT umfassen die Minimierung des Netzwerkbandbreitenverbrauchs und die Reduzierung der Anforderungen an Ger√§teressourcen. Dar√ºber hinaus zielt es darauf ab, eine zuverl√§ssige Kommunikation aufrechtzuerhalten und ein bestimmtes Ma√ü an Zustellgarantie zu bieten. Diese Ziele machen MQTT besonders geeignet f√ºr das aufstrebende Gebiet der **Maschine-zu-Maschine (M2M)-Kommunikation** und das **Internet der Dinge (IoT)**, wo es entscheidend ist, eine Vielzahl von Ger√§ten effizient zu verbinden. Dar√ºber hinaus ist MQTT f√ºr mobile Anwendungen √§u√üerst vorteilhaft, wo die Bandbreiteneinsparung und die Batterielaufzeit entscheidend sind.

**Standardport:** 1883
```
PORT     STATE SERVICE                 REASON
1883/tcp open  mosquitto version 1.4.8 syn-ack
```
## √úberpr√ºfen des Datenverkehrs

Wenn ein **CONNECT**-Paket von MQTT-Brokern empfangen wird, wird ein **CONNACK**-Paket zur√ºckgesendet. Dieses Paket enth√§lt einen R√ºckgabecode, der entscheidend f√ºr das Verst√§ndnis des Verbindungsstatus ist. Ein R√ºckgabecode von **0x00** bedeutet, dass die Anmeldeinformationen akzeptiert wurden und eine erfolgreiche Verbindung signalisieren. Andererseits deutet ein R√ºckgabecode von **0x05** darauf hin, dass die Anmeldeinformationen ung√ºltig sind und somit die Verbindung verhindern.

Wenn beispielsweise der Broker die Verbindung aufgrund ung√ºltiger Anmeldeinformationen ablehnt, w√ºrde das Szenario wie folgt aussehen:
```
{
"returnCode": "0x05",
"description": "Connection Refused, not authorized"
}
```
![](<../.gitbook/assets/image (976).png>)

### [**Brute-Force MQTT**](../generic-methodologies-and-resources/brute-force.md#mqtt)

## Pentesting MQTT

**Die Authentifizierung ist vollst√§ndig optional** und selbst wenn eine Authentifizierung durchgef√ºhrt wird, **wird standardm√§√üig keine Verschl√ºsselung verwendet** (Anmeldeinformationen werden im Klartext gesendet). MITM-Angriffe k√∂nnen immer noch durchgef√ºhrt werden, um Passw√∂rter zu stehlen.

Um eine Verbindung zu einem MQTT-Dienst herzustellen, k√∂nnen Sie verwenden: [https://github.com/bapowell/python-mqtt-client-shell](https://github.com/bapowell/python-mqtt-client-shell) und sich selbst zu allen Themen abonnieren:
```
> connect (NOTICE that you need to indicate before this the params of the connection, by default 127.0.0.1:1883)
> subscribe "#" 1
> subscribe "$SYS/#"
```
Du k√∂nntest auch [**https://github.com/akamai-threat-research/mqtt-pwn**](https://github.com/akamai-threat-research/mqtt-pwn) verwenden.
```bash
apt-get install mosquitto mosquitto-clients
mosquitto_sub -t 'test/topic' -v #Subscribe to 'test/topic'
mosquitto_sub -h <host-ip> -t "#" -v #Subscribe to ALL topics.
```
Oder Sie k√∂nnten **diesen Code ausf√ºhren, um zu versuchen, eine Verbindung zu einem MQTT-Dienst ohne Authentifizierung herzustellen, alle Themen zu abonnieren und sie anzuh√∂ren**:
```python
#This is a modified version of https://github.com/Warflop/IOT-MQTT-Exploit/blob/master/mqtt.py
import paho.mqtt.client as mqtt
import time
import os

HOST = "127.0.0.1"
PORT = 1883

def on_connect(client, userdata, flags, rc):
client.subscribe('#', qos=1)
client.subscribe('$SYS/#')

def on_message(client, userdata, message):
print('Topic: %s | QOS: %s  | Message: %s' % (message.topic, message.qos, message.payload))

def main():
client = mqtt.Client()
client.on_connect = on_connect
client.on_message = on_message
client.connect(HOST, PORT)
client.loop_start()
#time.sleep(10)
#client.loop_stop()

if __name__ == "__main__":
main()
```
## Weitere Informationen

von hier: [https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b](https://morphuslabs.com/hacking-the-iot-with-mqtt-8edaf0d07b9b)

### Das Publish/Subscribe-Muster <a href="#b667" id="b667"></a>

Das Publish/Subscribe-Modell besteht aus:

- **Publisher**: ver√∂ffentlicht eine Nachricht zu einem (oder mehreren) Thema(s) im Broker.
- **Subscriber**: abonniert ein (oder mehrere) Thema(s) im Broker und empf√§ngt alle Nachrichten, die vom Publisher gesendet werden.
- **Broker**: leitet alle Nachrichten von den Publishern an die Abonnenten weiter.
- **Thema**: besteht aus einer oder mehreren Ebenen, die durch einen Schr√§gstrich getrennt sind (z. B. /smartshouse/livingroom/temperature).

### Paketformat <a href="#f15a" id="f15a"></a>

Jedes MQTT-Paket enth√§lt einen festen Header (Abbildung 02).Abbildung 02: Fester Header

![https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png](https://miro.medium.com/max/838/1\*k6RkAHEk0576geQGUcKSTA.png)

### Pakettypen

- CONNECT (1): Vom Client initiiert, um eine Verbindung zum Server anzufordern.
- CONNACK (2): Die Best√§tigung des Servers √ºber eine erfolgreiche Verbindung.
- PUBLISH (3): Wird verwendet, um eine Nachricht vom Client an den Server oder umgekehrt zu senden.
- PUBACK (4): Best√§tigung eines PUBLISH-Pakets.
- PUBREC (5): Teil eines Nachrichtenzustellungsprotokolls, das sicherstellt, dass die Nachricht empfangen wird.
- PUBREL (6): Weitere Sicherheit bei der Nachrichtenzustellung, die eine Nachrichtenfreigabe anzeigt.
- PUBCOMP (7): Letzter Teil des Nachrichtenzustellungsprotokolls, der den Abschluss anzeigt.
- SUBSCRIBE (8): Eine Anforderung des Clients, Nachrichten zu einem Thema anzuh√∂ren.
- SUBACK (9): Die Best√§tigung des Servers √ºber eine SUBSCRIBE-Anforderung.
- UNSUBSCRIBE (10): Eine Anforderung des Clients, keine Nachrichten zu einem Thema mehr zu empfangen.
- UNSUBACK (11): Die Antwort des Servers auf eine UNSUBSCRIBE-Anforderung.
- PINGREQ (12): Eine Heartbeat-Nachricht, die vom Client gesendet wird.
- PINGRESP (13): Antwort des Servers auf die Heartbeat-Nachricht.
- DISCONNECT (14): Vom Client initiiert, um die Verbindung zu beenden.
- Zwei Werte, 0 und 15, sind als reserviert markiert und ihre Verwendung ist verboten.

## Shodan

- `port:1883 MQTT`

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) ist eine von **Dark Web** angetriebene Suchmaschine, die kostenlose Funktionen bietet, um zu √ºberpr√ºfen, ob ein Unternehmen oder seine Kunden von **Stealer-Malware** **kompromittiert** wurden.

Das Hauptziel von WhiteIntel ist es, Konto√ºbernahmen und Ransomware-Angriffe aufgrund von informationsstehlender Malware zu bek√§mpfen.

Sie k√∂nnen ihre Website besuchen und ihre Engine **kostenlos** ausprobieren unter:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Erfahren Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Weitere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

- Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen** m√∂chten oder **HackTricks im PDF-Format herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
- Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
- Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
- **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys senden.

</details>
