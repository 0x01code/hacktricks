# 2049 - Test d'intrusion du service NFS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [d√©p√¥t hacktricks](https://github.com/carlospolop/hacktricks) et au [d√©p√¥t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## **Informations de base**

**NFS** est un syst√®me con√ßu pour le **client/serveur** qui permet aux utilisateurs d'acc√©der de mani√®re transparente aux fichiers sur un r√©seau comme s'ils se trouvaient dans un r√©pertoire local.

Un aspect notable de ce protocole est son absence de m√©canismes int√©gr√©s d'**authentification** ou d'**autorisation**. Au lieu de cela, l'autorisation repose sur les **informations du syst√®me de fichiers**, le serveur √©tant charg√© de traduire avec pr√©cision les **informations utilisateur fournies par le client** dans le **format d'autorisation requis** du syst√®me de fichiers, suivant principalement la **syntaxe UNIX**.

L'authentification repose g√©n√©ralement sur les **identifiants UNIX `UID`/`GID` et les appartenances aux groupes**. Cependant, un d√©fi se pose en raison du potentiel de divergence dans les **correspondances `UID`/`GID`** entre les clients et les serveurs, ne laissant aucune place √† une v√©rification suppl√©mentaire par le serveur. Par cons√©quent, le protocole est le mieux adapt√© √† une utilisation au sein de **r√©seaux de confiance**, √©tant donn√© sa d√©pendance √† cette m√©thode d'authentification.

**Port par d√©faut**: 2049/TCP/UDP (sauf la version 4, qui n√©cessite uniquement TCP ou UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Versions

- **NFSv2**: Cette version est reconnue pour sa large compatibilit√© avec divers syst√®mes, marquant son importance avec des op√©rations initiales principalement sur UDP. √âtant la **plus ancienne** de la s√©rie, elle a pos√© les bases pour les d√©veloppements futurs.

- **NFSv3**: Introduite avec une s√©rie d'am√©liorations, NFSv3 a √©tendu son pr√©d√©cesseur en prenant en charge des tailles de fichiers variables et en offrant des m√©canismes am√©lior√©s de notification d'erreurs. Malgr√© ses avanc√©es, elle a rencontr√© des limitations en termes de compatibilit√© ascendante compl√®te avec les clients NFSv2.

- **NFSv4**: Version phare de la s√©rie NFS, NFSv4 a apport√© une s√©rie de fonctionnalit√©s con√ßues pour moderniser le partage de fichiers √† travers les r√©seaux. Les am√©liorations notables incluent l'int√©gration de Kerberos pour une **s√©curit√© √©lev√©e**, la capacit√© de traverser les pare-feu et de fonctionner sur Internet sans avoir besoin de mappages de ports, le support des listes de contr√¥le d'acc√®s (ACL), et l'introduction d'op√©rations bas√©es sur l'√©tat. Ses am√©liorations de performances et l'adoption d'un protocole √©tatique distinguent NFSv4 comme une avanc√©e capitale dans les technologies de partage de fichiers en r√©seau.

Chaque version de NFS a √©t√© d√©velopp√©e dans le but de r√©pondre aux besoins √©volutifs des environnements r√©seau, am√©liorant progressivement la s√©curit√©, la compatibilit√© et les performances.

## √ânum√©ration

### Scripts nmap utiles
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### Modules Metasploit utiles
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montage

Pour savoir **quel dossier** le serveur a **disponible** pour le montage, vous pouvez le demander en utilisant :
```bash
showmount -e <IP>
```
Ensuite, montez-le en utilisant :
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Vous devriez sp√©cifier d'**utiliser la version 2** car elle n'a **aucune** **authentification** ou **autorisation**.

**Exemple:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permissions

Si vous montez un dossier qui contient des **fichiers ou dossiers accessibles uniquement par un utilisateur** (par **UID**). Vous pouvez **cr√©er** **localement** un utilisateur avec cet **UID** et en utilisant cet **utilisateur**, vous pourrez **acc√©der** au fichier/dossier.

## NSFShell

Pour lister, monter et changer l'UID et le GID pour avoir acc√®s aux fichiers, vous pouvez utiliser [nfsshell](https://github.com/NetDirect/nfsshell).

[Tutoriel sympa sur NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Fichiers de configuration
```
/etc/exports
/etc/lib/nfs/etab
```
### Param√®tres dangereux

- **Permissions de lecture et d'√©criture (`rw`):** Ce param√®tre permet √† la fois la lecture et l'√©criture sur le syst√®me de fichiers. Il est essentiel de consid√©rer les implications de l'octroi d'un acc√®s aussi large.

- **Utilisation de ports non s√©curis√©s (`insecure`):** Lorsqu'elle est activ√©e, cela permet au syst√®me d'utiliser des ports sup√©rieurs √† 1024. La s√©curit√© des ports au-dessus de cette plage peut √™tre moins stricte, augmentant ainsi les risques.

- **Visibilit√© des syst√®mes de fichiers imbriqu√©s (`nohide`):** Cette configuration rend les r√©pertoires visibles m√™me si un autre syst√®me de fichiers est mont√© sous un r√©pertoire export√©. Chaque r√©pertoire n√©cessite sa propre entr√©e d'exportation pour une gestion ad√©quate.

- **Propri√©t√© des fichiers racine (`no_root_squash`):** Avec ce param√®tre, les fichiers cr√©√©s par l'utilisateur root conservent leur UID/GID d'origine de 0, en ignorant le principe du moindre privil√®ge et en accordant potentiellement des autorisations excessives.

- **Non-√©crasement de tous les utilisateurs (`no_all_squash`):** Cette option garantit que les identit√©s des utilisateurs sont pr√©serv√©es dans tout le syst√®me, ce qui pourrait entra√Æner des probl√®mes de contr√¥le des autorisations et d'acc√®s s'ils ne sont pas correctement g√©r√©s.

## √âl√©vation de privil√®ges en utilisant des erreurs de configuration NFS

[√âl√©vation de privil√®ges NFS no\_root\_squash et no\_all\_squash](../linux-hardening/privilege-escalation/nfs-no\_root_squash-misconfiguration-pe.md)

## Commandes automatiques HackTricks
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [d√©p√¥t hacktricks](https://github.com/carlospolop/hacktricks) et au [d√©p√¥t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
