# 2049 - Pentesting Servi√ßo NFS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## **Informa√ß√µes B√°sicas**

√â um sistema cliente/servidor que permite aos usu√°rios acessar arquivos em uma rede e trat√°-los como se estivessem em um diret√≥rio de arquivos local. Tem o mesmo prop√≥sito que o SMB, mas n√£o pode se comunicar com o SMB.

O protocolo NFS n√£o tem **mecanismo de autentica√ß√£o** ou **autoriza√ß√£o**. A autoriza√ß√£o √© obtida a partir das informa√ß√µes dispon√≠veis do sistema de arquivos, onde o servidor √© respons√°vel por traduzir as informa√ß√µes do **usu√°rio** fornecidas pelo **cliente** para as do **sistema de arquivos** e converter as informa√ß√µes de autoriza√ß√£o correspondentes da maneira mais correta poss√≠vel na sintaxe exigida pelo UNIX.

A autentica√ß√£o mais comum √© via `UID`/`GID` do UNIX e `membros do grupo`, raz√£o pela qual essa sintaxe √© mais prov√°vel de ser aplicada ao protocolo NFS. Um problema √© que o **cliente** e o **servidor** **n√£o necessariamente** precisam ter as **mesmas correspond√™ncias de UID/GID** para usu√°rios e grupos. Nenhuma verifica√ß√£o adicional pode ser feita por parte do servidor. √â por isso que o NFS deve ser usado **apenas** com esse m√©todo de autentica√ß√£o em **redes confi√°veis**.

**Porta padr√£o**: 2049/TCP/UDP (exceto a vers√£o 4, que s√≥ precisa de TCP ou UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Vers√µes

(De [https://academy.hackthebox.com/module/112/section/1068](https://academy.hackthebox.com/module/112/section/1068))

| **Vers√£o** | **Recursos**                                                                                                                                                                                                                                                                 |
| ----------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `NFSv2`     | √â **mais antiga** mas √© suportada por muitos sistemas e inicialmente operava inteiramente sobre UDP.                                                                                                                                                                               |
| `NFSv3`     | Possui mais recursos, incluindo tamanho de arquivo vari√°vel e melhor relat√≥rio de erros, mas n√£o √© totalmente compat√≠vel com clientes NFSv2.                                                                                                                                               |
| `NFSv4`     | Inclui Kerberos, funciona atrav√©s de firewalls e na Internet, **n√£o requer mais portmappers**, suporta ACLs, aplica opera√ß√µes baseadas em estado e fornece melhorias de desempenho e alta **seguran√ßa**. √â tamb√©m a primeira vers√£o a ter um protocolo stateful. |

## Enumera√ß√£o

### Scripts √∫teis do nmap
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### M√≥dulos √∫teis do Metasploit

#### NFS

- `auxiliary/scanner/nfs/nfsmount`: Este m√≥dulo permite verificar se um compartilhamento NFS est√° acess√≠vel e mont√°-lo localmente.
- `auxiliary/scanner/nfs/nfs_showmount`: Este m√≥dulo permite verificar se um compartilhamento NFS est√° acess√≠vel e listar os diret√≥rios compartilhados.
- `exploit/linux/nfs/nfs_trunc`: Este m√≥dulo explora uma vulnerabilidade de truncamento de arquivos no servi√ßo NFS em sistemas Linux.
- `exploit/solaris/nfs/nfs_ilist`: Este m√≥dulo explora uma vulnerabilidade de estouro de buffer no servi√ßo NFS em sistemas Solaris.
- `exploit/solaris/nfs/nfs_sharectl`: Este m√≥dulo explora uma vulnerabilidade de escape de shell no servi√ßo NFS em sistemas Solaris.

#### RPC

- `auxiliary/scanner/portmap/rpcinfo`: Este m√≥dulo permite verificar se um servi√ßo RPC est√° acess√≠vel e listar os programas e vers√µes dispon√≠veis.
- `auxiliary/scanner/portmap/portmap_dump`: Este m√≥dulo permite verificar se um servi√ßo RPC est√° acess√≠vel e listar as informa√ß√µes do mapa de porta.
- `auxiliary/scanner/portmap/portmap_version`: Este m√≥dulo permite verificar se um servi√ßo RPC est√° acess√≠vel e obter a vers√£o do servi√ßo.
- `exploit/freebsd/nfsd/nfsd_setresuid`: Este m√≥dulo explora uma vulnerabilidade de escalonamento de privil√©gios no servi√ßo rpc.nfsd em sistemas FreeBSD.
- `exploit/linux/misc/nfs_rpcidmapd`: Este m√≥dulo explora uma vulnerabilidade de escalonamento de privil√©gios no servi√ßo rpc.idmapd em sistemas Linux.
- `exploit/solaris/rpc/cachefsd`: Este m√≥dulo explora uma vulnerabilidade de escalonamento de privil√©gios no servi√ßo cachefsd em sistemas Solaris.

#### Samba

- `auxiliary/scanner/smb/smb_enumshares`: Este m√≥dulo permite listar os compartilhamentos dispon√≠veis em um servidor Samba.
- `auxiliary/scanner/smb/smb_enumusers`: Este m√≥dulo permite listar os usu√°rios dispon√≠veis em um servidor Samba.
- `auxiliary/scanner/smb/smb_login`: Este m√≥dulo permite tentar fazer login em um servidor Samba com credenciais conhecidas.
- `exploit/linux/samba/is_known_pipename`: Este m√≥dulo explora uma vulnerabilidade de escalonamento de privil√©gios no servi√ßo Samba em sistemas Linux.
- `exploit/multi/samba/usermap_script`: Este m√≥dulo explora uma vulnerabilidade de escalonamento de privil√©gios no servi√ßo Samba em sistemas Unix-like.
- `exploit/windows/smb/ms08_067_netapi`: Este m√≥dulo explora uma vulnerabilidade de execu√ß√£o remota de c√≥digo no servi√ßo Server Message Block (SMB) em sistemas Windows.
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montagem

Para saber **qual pasta** o servidor tem **dispon√≠vel** para montagem, voc√™ pode perguntar usando:
```bash
showmount -e <IP>
```
Em seguida, monte-o usando:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Voc√™ deve especificar o uso da **vers√£o 2** porque ela n√£o possui **nenhuma** forma de **autentica√ß√£o** ou **autoriza√ß√£o**.

**Exemplo:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permiss√µes

Se voc√™ montar uma pasta que cont√©m **arquivos ou pastas acess√≠veis apenas por algum usu√°rio** (por **UID**), voc√™ pode **criar** **localmente** um usu√°rio com esse **UID** e, usando esse **usu√°rio**, voc√™ poder√° **acessar** o arquivo/pasta.

## NSFShell

Para listar, montar e alterar UID e GID para ter acesso a arquivos com facilidade, voc√™ pode usar o [nfsshell](https://github.com/NetDirect/nfsshell).

[Tutorial legal do NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Arquivos de configura√ß√£o
```
/etc/exports
/etc/lib/nfs/etab
```
### Configura√ß√µes perigosas

(De [https://academy.hackthebox.com/module/112/section/1068](https://academy.hackthebox.com/module/112/section/1068))

| **Op√ß√£o**        | **Descri√ß√£o**                                                                                                      |
| ---------------- | -------------------------------------------------------------------------------------------------------------------- |
| `rw`             | Permiss√µes de leitura e escrita.                                                                                    |
| `insecure`       | Portas acima de 1024 ser√£o usadas.                                                                                   |
| `nohide`         | Se outro sistema de arquivos foi montado abaixo de um diret√≥rio exportado, esse diret√≥rio √© exportado por sua pr√≥pria entrada de exporta√ß√£o. |
| `no_root_squash` | Todos os arquivos criados pelo root s√£o mantidos com o UID/GID 0.                                                    |
| `no_all_squash`  |                                                                                                                      |

## Escala√ß√£o de privil√©gios usando m√° configura√ß√£o do NFS

[Escala√ß√£o de privil√©gios NFS no\_root\_squash e no\_all\_squash](../linux-hardening/privilege-escalation/nfs-no\_root\_squash-misconfiguration-pe.md)

## Comandos autom√°ticos do HackTricks
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for NFS
  Note: |
    It is a client/server system that allows users to access files across a network and treat them as if they resided in a local file directory.

    #apt install nfs-common
    showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
    should show you available shares (example /home)

    mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
    cd /mnt
    nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

    https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
  Name: Nmap
  Description: Nmap with NFS Scripts
  Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
