# 2049 - Pentesting Servi√ßo NFS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## **Informa√ß√µes B√°sicas**

**NFS** √© um sistema projetado para **cliente/servidor** que permite aos usu√°rios acessar arquivos em uma rede como se esses arquivos estivessem localizados em um diret√≥rio local.

Um aspecto not√°vel desse protocolo √© a falta de **mecanismos de autentica√ß√£o** ou **autoriza√ß√£o integrados**. Em vez disso, a autoriza√ß√£o depende das **informa√ß√µes do sistema de arquivos**, com o servidor encarregado de traduzir com precis√£o as **informa√ß√µes de usu√°rio fornecidas pelo cliente** para o **formato de autoriza√ß√£o necess√°rio do sistema de arquivos**, seguindo principalmente a **sintaxe UNIX**.

A autentica√ß√£o geralmente depende dos **identificadores UNIX `UID`/`GID` e associa√ß√µes de grupos**. No entanto, surge um desafio devido √† poss√≠vel falta de correspond√™ncia nas **associa√ß√µes de `UID`/`GID`** entre clientes e servidores, n√£o deixando espa√ßo para verifica√ß√£o adicional pelo servidor. Consequentemente, o protocolo √© mais adequado para uso em **redes confi√°veis**, dada sua depend√™ncia desse m√©todo de autentica√ß√£o.

**Porta padr√£o**: 2049/TCP/UDP (exceto a vers√£o 4, que s√≥ precisa de TCP ou UDP).&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### Vers√µes

- **NFSv2**: Esta vers√£o √© reconhecida por sua ampla compatibilidade com v√°rios sistemas, marcando sua import√¢ncia com opera√ß√µes iniciais predominantemente sobre UDP. Sendo a **mais antiga** da s√©rie, ela estabeleceu as bases para desenvolvimentos futuros.

- **NFSv3**: Introduzida com uma s√©rie de aprimoramentos, o NFSv3 expandiu seu antecessor ao suportar tamanhos de arquivo vari√°veis e oferecer mecanismos de relat√≥rio de erros aprimorados. Apesar de seus avan√ßos, enfrentou limita√ß√µes na compatibilidade total com clientes NFSv2.

- **NFSv4**: Uma vers√£o marcante na s√©rie NFS, o NFSv4 trouxe um conjunto de recursos projetados para modernizar o compartilhamento de arquivos em redes. Melhorias not√°veis incluem a integra√ß√£o do Kerberos para **alta seguran√ßa**, a capacidade de atravessar firewalls e operar pela Internet sem a necessidade de portmappers, suporte para Listas de Controle de Acesso (ACLs) e a introdu√ß√£o de opera√ß√µes baseadas em estado. Seus aprimoramentos de desempenho e a ado√ß√£o de um protocolo baseado em estado distinguem o NFSv4 como um avan√ßo fundamental nas tecnologias de compartilhamento de arquivos em rede.

Cada vers√£o do NFS foi desenvolvida com a inten√ß√£o de abordar as necessidades em constante evolu√ß√£o dos ambientes de rede, aprimorando progressivamente a seguran√ßa, compatibilidade e desempenho.

## Enumera√ß√£o

### Scripts nmap √∫teis
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### M√≥dulos √∫teis do metasploit
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### Montagem

Para saber **qual pasta** o servidor tem **dispon√≠vel** para montar, voc√™ pode perguntar usando:
```bash
showmount -e <IP>
```
Em seguida, monte-o usando:
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
Deve-se especificar para **usar a vers√£o 2** porque ela n√£o possui **nenhuma** forma de **autentica√ß√£o** ou **autoriza√ß√£o**.

**Exemplo:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## Permiss√µes

Se voc√™ montar uma pasta que cont√©m **arquivos ou pastas acess√≠veis apenas por algum usu√°rio** (por **UID**), voc√™ pode **criar** **localmente** um usu√°rio com esse **UID** e usar esse **usu√°rio** para **acessar** o arquivo/pasta.

## NSFShell

Para listar, montar e alterar o UID e GID facilmente para ter acesso aos arquivos, voc√™ pode usar [nfsshell](https://github.com/NetDirect/nfsshell).

[Tutorial legal do NFSShell.](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## Arquivos de configura√ß√£o
```
/etc/exports
/etc/lib/nfs/etab
```
### Configura√ß√µes perigosas

- **Permiss√µes de Leitura e Escrita (`rw`):** Essa configura√ß√£o permite tanto a leitura quanto a escrita no sistema de arquivos. √â essencial considerar as implica√ß√µes de conceder um acesso t√£o amplo.

- **Uso de Portas Inseguras (`insecure`):** Quando habilitado, isso permite que o sistema utilize portas acima de 1024. A seguran√ßa das portas acima desse intervalo pode ser menos rigorosa, aumentando o risco.

- **Visibilidade de Sistemas de Arquivos Aninhados (`nohide`):** Essa configura√ß√£o torna os diret√≥rios vis√≠veis mesmo se outro sistema de arquivos estiver montado abaixo de um diret√≥rio exportado. Cada diret√≥rio requer sua pr√≥pria entrada de exporta√ß√£o para um gerenciamento adequado.

- **Propriedade de Arquivos Raiz (`no_root_squash`):** Com essa configura√ß√£o, arquivos criados pelo usu√°rio raiz mant√™m seu UID/GID original de 0, ignorando o princ√≠pio do menor privil√©gio e potencialmente concedendo permiss√µes excessivas.

- **N√£o Supress√£o de Todos os Usu√°rios (`no_all_squash`):** Essa op√ß√£o garante que as identidades dos usu√°rios sejam preservadas em todo o sistema, o que poderia levar a problemas de permiss√£o e controle de acesso se n√£o forem tratados corretamente.

## Escala√ß√£o de Privil√©gios usando configura√ß√µes incorretas do NFS

[Escala√ß√£o de Privil√©gios do NFS no\_root\_squash e no\_all\_squash](../linux-hardening/privilege-escalation/nfs-no\_root_squash-misconfiguration-pe.md)

## Comandos Autom√°ticos do HackTricks
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me no** **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
