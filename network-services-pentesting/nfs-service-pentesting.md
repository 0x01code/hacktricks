# 2049 - NFSサービスのペンテスト

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> - <a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで企業を宣伝**したいですか？または、**PEASSの最新バージョンにアクセス**したいですか、またはHackTricksを**PDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見つけます
* [**公式PEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れます
* **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に**参加**するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。
* **ハッキングトリックを共有**するために、[hacktricks repo](https://github.com/carlospolop/hacktricks)と[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)に**PRを提出**してください。

</details>

## **基本情報**

**NFS**は、**クライアント/サーバ**向けに設計されたシステムで、ユーザーがネットワーク上のファイルにローカルディレクトリ内にあるかのようにシームレスにアクセスできるようにします。

このプロトコルの注目すべき側面は、組み込みの**認証**や**認可メカニズム**の欠如です。代わりに、認可は**ファイルシステム情報**に依存し、サーバーは**クライアントが提供したユーザー情報**をファイルシステムが必要とする**認可形式**に正確に変換することが求められます。これは主に**UNIX構文**に従います。

認証は一般的に**UNIXの`UID`/`GID`識別子とグループメンバーシップ**に依存します。ただし、クライアントとサーバーの間での**`UID`/`GID`のマッピングの不一致**が発生する可能性があるため、サーバーによる追加の検証の余地はありません。そのため、この認証方法に依存するため、プロトコルは**信頼されたネットワーク**内での使用に最適です。

**デフォルトポート**: 2049/TCP/UDP（バージョン4を除く、TCPまたはUDPのみが必要です）。&#x20;
```
2049/tcp open  nfs     2-3 (RPC #100003
```
### バージョン

- **NFSv2**: このバージョンは、さまざまなシステムとの広範な互換性で認識されており、初期の操作は主にUDPを介して行われることでその重要性を示しています。このシリーズで**最も古い**バージョンであり、将来の開発の基盤を築きました。

- **NFSv3**: 様々な改良が施されたNFSv3は、前身の機能を拡張し、可変ファイルサイズのサポートや改善されたエラー報告メカニズムを提供することで特徴付けられています。その進化にもかかわらず、NFSv2クライアントとの完全な後方互換性に制約がありました。

- **NFSv4**: NFSシリーズにおける画期的なバージョンであるNFSv4は、ネットワーク全体でのファイル共有を近代化するために設計された機能群をもたらしました。注目すべき改善点には、**高いセキュリティ**のためのKerberosの統合、ファイアウォールを横断してポートマッパーの必要なしにインターネット上で動作する能力、アクセス制御リスト（ACL）のサポート、および状態ベースの操作の導入が含まれます。そのパフォーマンスの向上とステートフルプロトコルの採用により、NFSv4はネットワークファイル共有技術の重要な進歩として区別されます。

各NFSのバージョンは、ネットワーク環境の進化するニーズに対処するために開発され、セキュリティ、互換性、パフォーマンスを徐々に向上させています。

## 列挙

### 便利なnmapスクリプト
```bash
nfs-ls #List NFS exports and check permissions
nfs-showmount #Like showmount -e
nfs-statfs #Disk statistics and info from NFS share
```
### 便利なMetasploitモジュール
```bash
scanner/nfs/nfsmount #Scan NFS mounts and list permissions
```
### マウント

サーバーがマウント可能な**フォルダ**を知るには、次のコマンドを使用して問い合わせます：
```bash
showmount -e <IP>
```
次に、次のコマンドを使用してマウントします：
```bash
mount -t nfs [-o vers=2] <ip>:<remote_folder> <local_folder> -o nolock
```
あらゆる**認証**や**認可**が**一切**ないため、**バージョン2**を使用するように明記する必要があります。

**例:**
```bash
mkdir /mnt/new_back
mount -t nfs [-o vers=2] 10.12.0.150:/backup /mnt/new_back -o nolock
```
## 権限

特定のユーザー（UIDによってアクセス可能なファイルまたはフォルダーのみを含むフォルダーをマウントする場合、そのUIDを持つユーザーを**ローカル**で作成し、その**ユーザー**を使用してファイル/フォルダーに**アクセス**できます。

## NSFShell

簡単にリスト、マウントし、UIDとGIDを変更してファイルにアクセスするには、[nfsshell](https://github.com/NetDirect/nfsshell)を使用できます。

[NFSShellの素敵なチュートリアル。](https://www.pentestpartners.com/security-blog/using-nfsshell-to-compromise-older-environments/)

## 設定ファイル
```
/etc/exports
/etc/lib/nfs/etab
```
### 危険な設定

- **読み書き権限 (`rw`):** この設定はファイルシステムへの読み取りと書き込みの両方を許可します。このような広範なアクセスを許可することの影響を慎重に考慮することが重要です。

- **安全でないポートの使用 (`insecure`):** 有効にすると、システムが1024を超えるポートを利用できるようになります。この範囲を超えるポートのセキュリティは緩い場合があり、リスクが高まります。

- **ネストされたファイルシステムの可視性 (`nohide`):** この設定により、他のファイルシステムがエクスポートされたディレクトリの下にマウントされていてもディレクトリが表示されます。各ディレクトリには適切な管理のために独自のエクスポートエントリが必要です。

- **ルートファイルの所有権 (`no_root_squash`):** この設定では、ルートユーザーによって作成されたファイルは元のUID/GID 0を維持し、最小特権の原則を無視し、過剰な権限を付与する可能性があります。

- **すべてのユーザーのスクワッシュ解除 (`no_all_squash`):** このオプションは、ユーザーのアイデンティティがシステム全体で保持されることを確認し、適切に処理されない場合には権限とアクセス制御の問題が発生する可能性があります。

## NFSミスコンフィギュレーションを利用した特権昇格

[NFS no\_root\_squashおよびno\_all\_squash特権昇格](../linux-hardening/privilege-escalation/nfs-no\_root_squash-misconfiguration-pe.md)

## HackTricks自動コマンド
```
Protocol_Name: NFS    #Protocol Abbreviation if there is one.
Port_Number:  2049     #Comma separated if there is more than one.
Protocol_Description: Network File System         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for NFS
Note: |
NFS is a system designed for client/server that enables users to seamlessly access files over a network as though these files were located within a local directory.

#apt install nfs-common
showmount 10.10.10.180      ~or~showmount -e 10.10.10.180
should show you available shares (example /home)

mount -t nfs -o ver=2 10.10.10.180:/home /mnt/
cd /mnt
nano into /etc/passwd and change the uid (probably 1000 or 1001) to match the owner of the files if you are not able to get in

https://book.hacktricks.xyz/pentesting/nfs-service-pentesting

Entry_2:
Name: Nmap
Description: Nmap with NFS Scripts
Command: nmap --script=nfs-ls.nse,nfs-showmount.nse,nfs-statfs.nse -p 2049 {IP}
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？**HackTricksで会社を宣伝**したいですか？または**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクションです。
* [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れましょう。
* **[💬 Discordグループ](https://emojipedia.org/speech-balloon/)に参加**するか、[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦で私をフォローしてください[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **ハッキングトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
