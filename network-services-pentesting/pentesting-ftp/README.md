# 21 - Pentesting FTP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** **üê¶**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [d√©p√¥t hacktricks](https://github.com/carlospolop/hacktricks) et [d√©p√¥t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informations de base

Le **protocole de transfert de fichiers (FTP)** est un protocole r√©seau standard utilis√© pour le transfert de fichiers informatiques entre un client et un serveur sur un r√©seau informatique.\
C'est un protocole **en texte clair** qui utilise comme **caract√®re de nouvelle ligne `0x0d 0x0a`** donc parfois vous devez **vous connecter en utilisant `telnet`** ou **`nc -C`**.

**Port par d√©faut:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Connexions Actives & Passives

En **FTP Actif**, le **client FTP** initie d'abord la **connexion de contr√¥le** depuis son port N vers le port de commande du serveur FTP - port 21. Le **client** √©coute ensuite sur le port **N+1** et envoie le port N+1 au serveur FTP. Le serveur FTP **initie** ensuite la **connexion de donn√©es**, depuis **son port M vers le port N+1** du client FTP.

Cependant, si le client FTP a un pare-feu qui contr√¥le les connexions de donn√©es entrantes depuis l'ext√©rieur, le FTP actif peut poser probl√®me. Une solution possible est le FTP passif.

En **FTP Passif**, le client initie la connexion de contr√¥le depuis son port N vers le port 21 du serveur FTP. Ensuite, le client envoie une commande **passv**. Le serveur envoie alors au client l'un de ses num√©ros de port M. Et le **client** **initie** la **connexion de donn√©es** depuis **son port P vers le port M** du serveur FTP.

Source: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### D√©bogage de la Connexion

Les commandes **`debug`** et **`trace`** de **FTP** peuvent √™tre utilis√©es pour voir **comment se d√©roule la communication**.

## √ânum√©ration

### Capture de Banni√®re
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Se connecter √† FTP en utilisant starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Enum√©ration non authentifi√©e

Avec **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Vous pouvez utiliser les commandes `HELP` et `FEAT` pour obtenir des informations sur le serveur FTP :
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Connexion anonyme

_anonymous : anonymous_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Ici, vous pouvez trouver une belle liste avec les identifiants FTP par d√©faut : [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatis√©

Les v√©rifications de connexion Anon et de rebond FTP sont effectu√©es par d√©faut par nmap avec l'option **-sC** ou :
```bash
nmap --script ftp-* -p 21 <ip>
```
## Connexion du navigateur

Vous pouvez vous connecter √† un serveur FTP en utilisant un navigateur (comme Firefox) en utilisant une URL comme suit :
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Notez que si une **application web** envoie des donn√©es contr√¥l√©es par un utilisateur **directement √† un serveur FTP**, vous pouvez envoyer des octets d'encodage d'URL double `%0d%0a` (dans un encodage d'URL double, c'est `%250d%250a`) et faire en sorte que le **serveur FTP effectue des actions arbitraires**. Une de ces actions arbitraires possibles est de t√©l√©charger du contenu √† partir d'un serveur contr√¥l√© par un utilisateur, d'effectuer un balayage de ports ou d'essayer de communiquer avec d'autres services bas√©s sur du texte en clair (comme http).

## T√©l√©charger tous les fichiers depuis FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Si votre nom d'utilisateur/mot de passe contient des caract√®res sp√©ciaux, la [commande suivante](https://stackoverflow.com/a/113900/13647948) peut √™tre utilis√©e :
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Quelques commandes FTP

* **`USER nom_utilisateur`**
* **`PASS mot_de_passe`**
* **`HELP`** Le serveur indique quelles commandes sont support√©es
* **`PORT 127,0,0,1,0,80`** Cela indiquera au serveur FTP d'√©tablir une connexion avec l'IP 127.0.0.1 sur le port 80 (_vous devez mettre le 5e caract√®re comme "0" et le 6e comme le port en d√©cimal ou utiliser le 5e et 6e pour exprimer le port en hexad√©cimal_).
* **`EPRT |2|127.0.0.1|80|`** Cela indiquera au serveur FTP d'√©tablir une connexion TCP (_indiqu√© par "2"_) avec l'IP 127.0.0.1 sur le port 80. Cette commande **prend en charge IPv6**.
* **`LIST`** Cela enverra la liste des fichiers dans le dossier actuel
* **`LIST -R`** Liste de mani√®re r√©cursive (si autoris√© par le serveur)
* **`APPE /chemin/quelquechose.txt`** Cela indiquera au FTP de stocker les donn√©es re√ßues d'une connexion **passive** ou d'une connexion **PORT/EPRT** dans un fichier. Si le nom de fichier existe, il ajoutera les donn√©es.
* **`STOR /chemin/quelquechose.txt`** Comme `APPE` mais √©crasera les fichiers
* **`STOU /chemin/quelquechose.txt`** Comme `APPE`, mais ne fera rien s'il existe d√©j√†.
* **`RETR /chemin/vers/fichier`** Une connexion passive ou de port doit √™tre √©tablie. Ensuite, le serveur FTP enverra le fichier indiqu√© via cette connexion
* **`REST 6`** Cela indiquera au serveur que la prochaine fois qu'il enverra quelque chose en utilisant `RETR`, il doit commencer au 6e octet.
* **`TYPE i`** D√©finit le transfert en binaire
* **`PASV`** Cela ouvrira une connexion passive et indiquera √† l'utilisateur o√π se connecter
* **`PUT /tmp/fichier.txt`** T√©l√©charge le fichier indiqu√© vers le FTP

![](<../../.gitbook/assets/image (227).png>)

## Attaque FTPBounce

Certains serveurs FTP autorisent la commande PORT. Cette commande peut √™tre utilis√©e pour indiquer au serveur que vous souhaitez vous connecter √† un autre serveur FTP sur un certain port. Ensuite, vous pouvez utiliser cela pour scanner les ports ouverts d'un h√¥te via un serveur FTP.

[**Apprenez ici comment abuser d'un serveur FTP pour scanner des ports.**](ftp-bounce-attack.md)

Vous pourriez √©galement abuser de ce comportement pour faire interagir un serveur FTP avec d'autres protocoles. Vous pourriez **t√©l√©charger un fichier contenant une requ√™te HTTP** et faire en sorte que le serveur FTP vuln√©rable **l'envoie √† un serveur HTTP arbitraire** (_peut-√™tre pour ajouter un nouvel utilisateur admin?_) ou m√™me t√©l√©charger une requ√™te FTP et faire en sorte que le serveur FTP vuln√©rable t√©l√©charge un fichier pour un autre serveur FTP.\
La th√©orie est simple :

1. **T√©l√©chargez la requ√™te (√† l'int√©rieur d'un fichier texte) sur le serveur vuln√©rable.** N'oubliez pas que si vous souhaitez communiquer avec un autre serveur HTTP ou FTP, vous devez changer les lignes avec `0x0d 0x0a`
2. **Utilisez `REST X` pour √©viter d'envoyer les caract√®res que vous ne souhaitez pas envoyer** (peut-√™tre pour t√©l√©charger la requ√™te √† l'int√©rieur du fichier, vous avez d√ª ajouter un en-t√™te d'image au d√©but)
3. **Utilisez `PORT` pour vous connecter au serveur et au service arbitraires**
4. **Utilisez `RETR` pour envoyer la requ√™te enregistr√©e au serveur.**

Il est tr√®s probable que cela **g√©n√®re une erreur comme** _**Socket non inscriptible**_ **car la connexion ne dure pas assez longtemps pour envoyer les donn√©es avec `RETR`**. Des suggestions pour essayer d'√©viter cela sont :

* Si vous envoyez une requ√™te HTTP, **mettez la m√™me requ√™te l'une apr√®s l'autre** jusqu'√† **\~0,5 Mo** au moins. Comme ceci :

{% file src="../../.gitbook/assets/posts (1).txt" %}
posts.txt
{% endfile %}

* Essayez de **remplir la requ√™te avec des donn√©es "junk" relatives au protocole** (en parlant √† FTP, peut-√™tre juste des commandes junk ou r√©p√©ter l'instruction `RETR` pour obtenir le fichier)
* Remplissez simplement la requ√™te avec beaucoup de caract√®res nuls ou autres (divis√©s en lignes ou non)

Quoi qu'il en soit, voici un [ancien exemple sur la fa√ßon d'abuser de cela pour faire t√©l√©charger un fichier √† un serveur FTP √† partir d'un autre serveur FTP.](ftp-bounce-download-2oftp-file.md)

## Vuln√©rabilit√© du serveur Filezilla

**FileZilla** se lie g√©n√©ralement √† un **service administratif local** pour le **serveur FileZilla** (port 14147). Si vous pouvez cr√©er un **tunnel** depuis **votre machine** pour acc√©der √† ce port, vous pouvez **vous y connecter** en utilisant un **mot de passe vide** et **cr√©er** un **nouvel utilisateur** pour le service FTP.

## Fichiers de configuration
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Exploitation

La configuration par d√©faut de vsFTPd peut √™tre trouv√©e dans `/etc/vsftpd.conf`. Ici, vous pourriez trouver des param√®tres dangereux :

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - R√©pertoire pour les utilisateurs anonymes.
* `chown_uploads=YES` - Changer la propri√©t√© des fichiers t√©l√©charg√©s de mani√®re anonyme
* `chown_username=username` - Utilisateur √† qui la propri√©t√© des fichiers t√©l√©charg√©s de mani√®re anonyme est attribu√©e
* `local_enable=YES` - Autoriser les utilisateurs locaux √† se connecter
* `no_anon_password=YES` - Ne pas demander de mot de passe aux utilisateurs anonymes
* `write_enable=YES` - Autoriser les commandes : STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, et SITE

### Shodan

* `ftp`
* `port:21`

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

*** 

## Commandes Automatiques HackTricks
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** **üê¶**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [d√©p√¥t hacktricks](https://github.com/carlospolop/hacktricks) et [d√©p√¥t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
