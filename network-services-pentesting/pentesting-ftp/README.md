# 21 - Pentesting FTP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, desde APIs at√© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informa√ß√µes B√°sicas

O **Protocolo de Transfer√™ncia de Arquivos (FTP)** √© um protocolo de rede padr√£o usado para a transfer√™ncia de arquivos de computador entre um cliente e um servidor em uma rede de computadores.\
√â um protocolo de **texto simples** que usa como **caractere de nova linha `0x0d 0x0a`**, ent√£o √†s vezes voc√™ precisa **conectar usando `telnet`** ou **`nc -C`**.

**Porta Padr√£o:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Conex√µes Ativas e Passivas

No **FTP Ativo**, o **cliente FTP** primeiro **inicia** a **conex√£o de controle** a partir da sua porta N para a porta de comando do servidor FTP - porta 21. O **cliente** ent√£o **escuta** na porta **N+1** e envia a porta N+1 para o servidor FTP. O servidor FTP ent√£o **inicia** a **conex√£o de dados**, da sua porta M para a porta N+1 do cliente FTP.

No entanto, se o cliente FTP tiver um firewall configurado que controle as conex√µes de dados recebidas de fora, o FTP ativo pode ser um problema. E uma solu√ß√£o vi√°vel para isso √© o FTP passivo.

No **FTP Passivo**, o cliente inicia a conex√£o de controle a partir da sua porta N para a porta 21 do servidor FTP. Ap√≥s isso, o cliente emite um comando **passv**. O servidor ent√£o envia ao cliente um dos seus n√∫meros de porta M. E o **cliente** **inicia** a **conex√£o de dados** da sua porta P para a porta M do servidor FTP.

Fonte: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Depura√ß√£o da Conex√£o

Os comandos **`debug`** e **`trace`** do FTP podem ser usados para ver **como est√° ocorrendo a comunica√ß√£o**.

## Enumera√ß√£o

### Banner Grabbing
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Conectar ao FTP usando starttls

O protocolo FTP (File Transfer Protocol) √© amplamente utilizado para transferir arquivos entre um cliente e um servidor. No entanto, o FTP n√£o √© um protocolo seguro, pois as informa√ß√µes s√£o transmitidas em texto simples, o que pode permitir que um invasor intercepte e leia os dados confidenciais.

Para aumentar a seguran√ßa da conex√£o FTP, √© poss√≠vel usar o comando `AUTH TLS` ou `AUTH SSL` para estabelecer uma conex√£o segura. No entanto, uma abordagem mais moderna √© usar o comando `STARTTLS`, que permite que a conex√£o seja atualizada para uma conex√£o segura ap√≥s a negocia√ß√£o inicial.

Aqui est√° um exemplo de como conectar ao FTP usando `STARTTLS`:

1. Abra um terminal e digite o seguinte comando:

   ```bash
   ftp
   ```

2. Conecte-se ao servidor FTP digitando o seguinte comando:

   ```bash
   open <endere√ßo_do_servidor_ftp>
   ```

3. Fa√ßa o login com suas credenciais de usu√°rio e senha.

4. Ap√≥s fazer o login, digite o seguinte comando para iniciar a negocia√ß√£o `STARTTLS`:

   ```bash
   quote AUTH TLS
   ```

   ou

   ```bash
   quote AUTH SSL
   ```

5. Se a negocia√ß√£o for bem-sucedida, a conex√£o ser√° atualizada para uma conex√£o segura.

A partir desse ponto, todas as informa√ß√µes transmitidas entre o cliente e o servidor FTP ser√£o criptografadas, garantindo a confidencialidade dos dados.

√â importante ressaltar que nem todos os servidores FTP suportam o comando `STARTTLS`. Portanto, verifique se o servidor que voc√™ est√° tentando acessar oferece suporte a essa funcionalidade antes de tentar estabelecer uma conex√£o segura.
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Enumera√ß√£o n√£o autorizada

Com **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Voc√™ pode usar os comandos `HELP` e `FEAT` para obter algumas informa√ß√µes do servidor FTP:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Login an√¥nimo

_an√¥nimo : an√¥nimo_\
_an√¥nimo :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [For√ßa bruta](../../generic-methodologies-and-resources/brute-force.md#ftp)

Aqui voc√™ pode encontrar uma lista completa com as credenciais padr√£o do ftp: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatizado

Os testes de login an√¥nimo e bounce FTP s√£o realizados por padr√£o pelo nmap com a op√ß√£o **-sC** ou:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Conex√£o do navegador

Voc√™ pode se conectar a um servidor FTP usando um navegador (como o Firefox) usando uma URL como:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Observe que se um **aplicativo da web** estiver enviando dados controlados por um usu√°rio **diretamente para um servidor FTP**, voc√™ pode enviar bytes de codifica√ß√£o de URL dupla `%0d%0a` (na codifica√ß√£o de URL dupla, isso √© `%250d%250a`) e fazer com que o **servidor FTP execute a√ß√µes arbitr√°rias**. Uma dessas poss√≠veis a√ß√µes arbitr√°rias √© baixar conte√∫do de um servidor controlado pelo usu√°rio, realizar varreduras de porta ou tentar se comunicar com outros servi√ßos baseados em texto simples (como http).

## Baixar todos os arquivos do FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
## Alguns comandos FTP

* **`USER nome_de_usu√°rio`**
* **`PASS senha`**
* **`HELP`** O servidor indica quais comandos s√£o suportados
* **`PORT 127,0,0,1,0,80`** Isso indicar√° ao servidor FTP para estabelecer uma conex√£o com o IP 127.0.0.1 na porta 80 (_voc√™ precisa colocar o 5¬∫ caractere como "0" e o 6¬∫ como a porta em decimal ou usar o 5¬∫ e 6¬∫ para expressar a porta em hexadecimal_).
* **`EPRT |2|127.0.0.1|80|`** Isso indicar√° ao servidor FTP para estabelecer uma conex√£o TCP (_indicada por "2"_) com o IP 127.0.0.1 na porta 80. Este comando **suporta IPv6**.
* **`LIST`** Isso enviar√° a lista de arquivos na pasta atual
* **`LIST -R`** Listar recursivamente (se permitido pelo servidor)
* **`APPE /caminho/alguma_coisa.txt`** Isso indicar√° ao FTP para armazenar os dados recebidos de uma conex√£o **passiva** ou de uma conex√£o **PORT/EPRT** em um arquivo. Se o nome do arquivo existir, ele anexar√° os dados.
* **`STOR /caminho/alguma_coisa.txt`** Semelhante ao `APPE`, mas ele substituir√° os arquivos
* **`STOU /caminho/alguma_coisa.txt`** Semelhante ao `APPE`, mas se o arquivo existir, n√£o far√° nada.
* **`RETR /caminho/para/arquivo`** Deve ser estabelecida uma conex√£o passiva ou de porta. Em seguida, o servidor FTP enviar√° o arquivo indicado por essa conex√£o
* **`REST 6`** Isso indicar√° ao servidor que na pr√≥xima vez que ele enviar algo usando `RETR`, ele deve come√ßar no 6¬∫ byte.
* **`TYPE i`** Define a transfer√™ncia para bin√°rio
* **`PASV`** Isso abrir√° uma conex√£o passiva e indicar√° ao usu√°rio onde ele pode se conectar
* **`PUT /tmp/arquivo.txt`** Fazer upload do arquivo indicado para o FTP

![](<../../.gitbook/assets/image (227).png>)

## Ataque FTPBounce

Alguns servidores FTP permitem o comando PORT. Esse comando pode ser usado para indicar ao servidor que voc√™ deseja se conectar a outro servidor FTP em alguma porta. Em seguida, voc√™ pode usar isso para verificar quais portas de um host est√£o abertas por meio de um servidor FTP.

[**Aprenda aqui como abusar de um servidor FTP para verificar portas.**](ftp-bounce-attack.md)

Voc√™ tamb√©m pode abusar desse comportamento para fazer com que um servidor FTP interaja com outros protocolos. Voc√™ pode **fazer upload de um arquivo contendo uma solicita√ß√£o HTTP** e fazer com que o servidor FTP vulner√°vel **a envie para um servidor HTTP arbitr√°rio** (_talvez para adicionar um novo usu√°rio administrador?_) ou at√© mesmo fazer upload de uma solicita√ß√£o FTP e fazer com que o servidor FTP vulner√°vel fa√ßa o download de um arquivo para um servidor FTP diferente.\
A teoria √© simples:

1. **Fa√ßa upload da solicita√ß√£o (dentro de um arquivo de texto) para o servidor vulner√°vel.** Lembre-se de que, se voc√™ quiser conversar com outro servidor HTTP ou FTP, precisar√° alterar as linhas com `0x0d 0x0a`
2. **Use `REST X` para evitar enviar os caracteres que voc√™ n√£o deseja enviar** (talvez para fazer upload da solicita√ß√£o dentro do arquivo, voc√™ precise adicionar algum cabe√ßalho de imagem no in√≠cio)
3. **Use `PORT` para se conectar ao servidor e servi√ßo arbitr√°rios**
4. **Use `RETR` para enviar a solicita√ß√£o salva para o servidor.**

√â altamente prov√°vel que isso **gere um erro como** _**Socket not writable**_ **porque a conex√£o n√£o dura o suficiente para enviar os dados com `RETR`**. Sugest√µes para tentar evitar isso s√£o:

* Se voc√™ estiver enviando uma solicita√ß√£o HTTP, **coloque a mesma solicita√ß√£o uma ap√≥s a outra** at√© **\~0.5MB** pelo menos. Assim:

{% file src="../../.gitbook/assets/posts (1).txt" %}
posts.txt
{% endfile %}

* Tente **preencher a solicita√ß√£o com dados "lixo" relativos ao protocolo** (ao falar com FTP, talvez apenas comandos lixo ou repetindo a instru√ß√£o `RETR` para obter o arquivo)
* Apenas **preencha a solicita√ß√£o com muitos caracteres nulos ou outros** (divididos em linhas ou n√£o)

De qualquer forma, aqui est√° um [exemplo antigo de como abusar disso para fazer um servidor FTP fazer o download de um arquivo de um servidor FTP diferente.](ftp-bounce-download-2oftp-file.md)

## Vulnerabilidade do Filezilla Server

O **FileZilla** geralmente **vincula** a um **servi√ßo administrativo** **local** para o **FileZilla-Server** (porta 14147). Se voc√™ puder criar um **t√∫nel** da **sua m√°quina** para acessar esta porta, voc√™ pode **conectar-se** a **ele** usando uma **senha em branco** e **criar** um **novo usu√°rio** para o servi√ßo FTP.

## Arquivos de configura√ß√£o
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### P√≥s-Explora√ß√£o

A configura√ß√£o padr√£o do vsFTPd pode ser encontrada em `/etc/vsftpd.conf`. Aqui, voc√™ pode encontrar algumas configura√ß√µes perigosas:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Diret√≥rio para usu√°rios an√¥nimos.
* `chown_uploads=YES` - Altera a propriedade dos arquivos enviados anonimamente.
* `chown_username=username` - Usu√°rio que recebe a propriedade dos arquivos enviados anonimamente.
* `local_enable=YES` - Permite que usu√°rios locais fa√ßam login.
* `no_anon_password=YES` - N√£o solicita senha para usu√°rios an√¥nimos.
* `write_enable=YES` - Permite os comandos: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE e SITE.

### Shodan

* `ftp`
* `port:21`

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, realiza varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, desde APIs at√© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm_source=referral&utm_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Comandos Autom√°ticos do HackTricks
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
