# 21 - Pentesting FTP

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

* Lavori in una **azienda di sicurezza informatica**? Vuoi vedere la **tua azienda pubblicizzata su HackTricks**? o vuoi avere accesso all'**ultima versione del PEASS o scaricare HackTricks in PDF**? Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* **Unisciti al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR al** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **e al** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Informazioni di Base

Il **File Transfer Protocol (FTP)** funge da protocollo standard per il trasferimento di file su una rete informatica tra un server e un client.\
√à un protocollo **in chiaro** che utilizza come **carattere di nuova riga `0x0d 0x0a`** quindi a volte √® necessario **connettersi usando `telnet`** o **`nc -C`**.

**Porta predefinita:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Connessioni Attive e Passive

Nel **FTP Attivo** il **client FTP** inizia prima la **connessione di controllo** dalla sua porta N alla porta di comando del Server FTP - porta 21. Il **client** quindi **ascolta** sulla porta **N+1** e invia la porta N+1 al Server FTP. Il Server FTP quindi **inizializza la connessione dati**, dalla **sua porta M alla porta N+1** del Client FTP.

Tuttavia, se il Client FTP ha un firewall che controlla le connessioni dati in ingresso dall'esterno, allora l'FTP attivo potrebbe essere un problema. E, una soluzione fattibile per questo √® l'FTP Passivo.

Nel **FTP Passivo**, il client inizia la connessione di controllo dalla sua porta N alla porta 21 del Server FTP. Dopo questo, il client emette un **comando passv**. Il server invia quindi al client uno dei suoi numeri di porta M. E il **client inizia la connessione dati** dalla **sua porta P alla porta M** del Server FTP.

Fonte: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Debugging della Connessione

I comandi **`debug`** e **`trace`** di **FTP** possono essere utilizzati per vedere **come avviene la comunicazione**.

## Enumerazione

### Banner Grabbing
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Connettersi a FTP utilizzando starttls
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Enumerazione non autorizzata

Con **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Puoi utilizzare i comandi `HELP` e `FEAT` per ottenere alcune informazioni sul server FTP:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Accesso anonimo

_anonymous : anonymous_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Brute force](../../generic-methodologies-and-resources/brute-force.md#ftp)

Qui puoi trovare una bella lista con le credenziali ftp predefinite: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Automatizzato

I controlli di login anonimo e bounce FTP sono eseguiti per impostazione predefinita da nmap con l'opzione **-sC** o:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Connessione del browser

Puoi connetterti a un server FTP utilizzando un browser (come Firefox) utilizzando un URL come:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Nota che se un'applicazione web sta inviando dati controllati da un utente direttamente a un server FTP, puoi inviare una doppia codifica URL `%0d%0a` (in doppia codifica URL questo diventa `%250d%250a`) e far s√¨ che il server FTP esegua azioni arbitrarie. Una di queste possibili azioni arbitrarie √® scaricare contenuti da un server controllato dall'utente, eseguire una scansione delle porte o provare a comunicare con altri servizi basati su testo normale (come http).

## Scaricare tutti i file da FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Se il tuo utente/password contiene caratteri speciali, puoi utilizzare il [seguente comando](https://stackoverflow.com/a/113900/13647948):
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Alcuni comandi FTP

* **`USER username`**
* **`PASS password`**
* **`HELP`** Il server indica quali comandi sono supportati
* \*\*`PORT 127,0,0,1,0,80`\*\* Questo indicher√† al server FTP di stabilire una connessione con l'IP 127.0.0.1 sulla porta 80 (_devi mettere il 5¬∞ carattere come "0" e il 6¬∞ come la porta in decimale o usare il 5¬∞ e 6¬∞ per esprimere la porta in esadecimale_).
* \*\*`EPRT |2|127.0.0.1|80|`\*\* Questo indicher√† al server FTP di stabilire una connessione TCP (_indicata da "2"_) con l'IP 127.0.0.1 sulla porta 80. Questo comando **supporta IPv6**.
* **`LIST`** Questo invier√† l'elenco dei file nella cartella corrente
* **`LIST -R`** Elenca in modo ricorsivo (se consentito dal server)
* **`APPE /percorso/qualcosa.txt`** Questo indicher√† al FTP di memorizzare i dati ricevuti da una connessione **passiva** o da una connessione **PORT/EPRT** in un file. Se il nome del file esiste, verranno aggiunti i dati.
* **`STOR /percorso/qualcosa.txt`** Come `APPE` ma sovrascriver√† i file
* **`STOU /percorso/qualcosa.txt`** Come `APPE`, ma se esiste non far√† nulla.
* **`RETR /percorso/di/file`** Deve essere stabilita una connessione passiva o di porta. Quindi, il server FTP invier√† il file indicato tramite quella connessione
* **`REST 6`** Questo indicher√† al server che la prossima volta che invier√† qualcosa usando `RETR` dovrebbe iniziare dal 6¬∞ byte.
* **`TYPE i`** Imposta il trasferimento in binario
* **`PASV`** Questo aprir√† una connessione passiva e indicher√† all'utente dove pu√≤ connettersi
* **`PUT /tmp/file.txt`** Carica il file indicato sul FTP

![](<../../.gitbook/assets/image (227).png>)

## Attacco FTPBounce

Alcuni server FTP consentono il comando PORT. Questo comando pu√≤ essere utilizzato per indicare al server che si desidera connettersi ad un altro server FTP su una determinata porta. Quindi, √® possibile utilizzarlo per scansionare quali porte di un host sono aperte tramite un server FTP.

[**Scopri qui come abusare di un server FTP per scansionare le porte.**](ftp-bounce-attack.md)

Potresti anche abusare di questo comportamento per far interagire un server FTP con altri protocolli. Potresti **caricare un file contenente una richiesta HTTP** e fare in modo che il server FTP vulnerabile **la invii a un server HTTP arbitrario** (_magari per aggiungere un nuovo utente admin?_) o persino caricare una richiesta FTP e fare in modo che il server FTP vulnerabile scarichi un file per un diverso server FTP.\
La teoria √® semplice:

1. **Carica la richiesta (all'interno di un file di testo) sul server vulnerabile.** Ricorda che se vuoi comunicare con un altro server HTTP o FTP devi cambiare le righe con `0x0d 0x0a`
2. **Usa `REST X` per evitare di inviare i caratteri che non vuoi inviare** (forse per caricare la richiesta all'interno del file hai dovuto inserire un'intestazione dell'immagine all'inizio)
3. **Usa `PORT` per connetterti al server e al servizio arbitrario**
4. **Usa `RETR` per inviare la richiesta salvata al server.**

√à molto probabile che questo **generer√† un errore come** _**Socket non scrivibile**_ **perch√© la connessione non dura abbastanza per inviare i dati con `RETR`**. Suggerimenti per cercare di evitare ci√≤ sono:

* Se stai inviando una richiesta HTTP, **inserisci la stessa richiesta una dopo l'altra** fino a **\~0.5MB** almeno. Cos√¨:

{% file src="../../.gitbook/assets/posts (1).txt" %}
posts.txt
{% endfile %}

* Prova a **riempire la richiesta con dati "spazzatura" relativi al protocollo** (parlando con FTP forse solo comandi spazzatura o ripetendo l'istruzione `RETR` per ottenere il file)
* Riempire semplicemente la richiesta con molti caratteri nulli o altri (divisi su righe o meno)

In ogni caso, qui hai un [vecchio esempio su come abusare di questo per fare in modo che un server FTP scarichi un file da un diverso server FTP.](ftp-bounce-download-2oftp-file.md)

## Vulnerabilit√† del server Filezilla

**FileZilla** di solito si **lega** a un **servizio amministrativo locale** per il **FileZilla-Server** (porta 14147). Se riesci a creare un **tunnel** dalla **tua macchina** per accedere a questa porta, puoi **connetterti** ad **essa** utilizzando una **password vuota** e **creare** un **nuovo utente** per il servizio FTP.

## File di configurazione
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Post-Esploitation

La configurazione predefinita di vsFTPd pu√≤ essere trovata in `/etc/vsftpd.conf`. Qui potresti trovare alcune impostazioni pericolose:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Directory per anonimi.
* `chown_uploads=YES` - Cambia la propriet√† dei file caricati anonimamente
* `chown_username=username` - Utente a cui viene assegnata la propriet√† dei file caricati anonimamente
* `local_enable=YES` - Abilita l'accesso degli utenti locali
* `no_anon_password=YES` - Non richiedere la password agli anonimi
* `write_enable=YES` - Consenti i comandi: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE e SITE

### Shodan

* `ftp`
* `port:21`

***

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Comandi Automatici di HackTricks
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

* Lavori in una **azienda di sicurezza informatica**? Vuoi vedere la **tua azienda pubblicizzata su HackTricks**? o vuoi avere accesso all'**ultima versione del PEASS o scaricare HackTricks in PDF**? Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* **Unisciti al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR al** [**repo di hacktricks**](https://github.com/carlospolop/hacktricks) **e al** [**repo di hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
