# 21 - Kupima Usalama wa FTP

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Je, unafanya kazi katika **kampuni ya usalama wa mtandao**? Je, ungependa kuona **kampuni yako ikionekana katika HackTricks**? Au ungependa kupata ufikiaji wa **toleo jipya zaidi la PEASS au kupakua HackTricks kwa muundo wa PDF**? Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* **Jiunge na** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **nifuatilie** kwenye **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye [repo ya hacktricks](https://github.com/carlospolop/hacktricks) na [repo ya hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Tafuta udhaifu unaofaa zaidi ili uweze kuzirekebisha haraka. Intruder inafuatilia eneo lako la shambulio, inafanya uchunguzi wa vitisho wa kisasa, inapata matatizo katika mfumo wako mzima wa teknolojia, kutoka kwa APIs hadi programu za wavuti na mifumo ya wingu. [**Jaribu bure**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) leo.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Taarifa Msingi

**Itifaki ya Uhamisho wa Faili (FTP)** hutumika kama itifaki ya kawaida ya uhamisho wa faili kwenye mtandao wa kompyuta kati ya seva na mteja.\
Ni itifaki ya **maandishi wazi** inayotumia **tabia mpya ya mstari `0x0d 0x0a`** kwa hivyo mara nyingine unahitaji **kuunganisha kwa kutumia `telnet`** au **`nc -C`**.

**Bandari ya Chaguo-msingi:** 21
```
PORT   STATE SERVICE
21/tcp open  ftp
```
### Uhusiano wa Moja kwa Moja na wa Kupitisha

Katika **FTP ya Moja kwa Moja**, **mteja** wa FTP kwanza **anasisitiza** uhusiano wa udhibiti kutoka kwenye bandari yake N hadi kwenye bandari ya amri ya Seva ya FTP - bandari 21. **Mteja** kisha **anasikiliza** kwenye bandari **N+1** na kutuma bandari N+1 kwa Seva ya FTP. Seva ya FTP kisha **inasisitiza** uhusiano wa data, kutoka kwenye bandari yake M hadi bandari N+1 ya Mteja wa FTP.

Lakini, ikiwa Mteja wa FTP ana usanidi wa firewall ambao unadhibiti uhusiano wa data unaokuja kutoka nje, basi FTP ya moja kwa moja inaweza kuwa tatizo. Na, suluhisho linalowezekana kwa hilo ni FTP ya Kupitisha.

Katika **FTP ya Kupitisha**, mteja anasisitiza uhusiano wa udhibiti kutoka kwenye bandari yake N hadi bandari 21 ya Seva ya FTP. Baada ya hii, mteja anatoa amri ya **passv**. Seva kisha inatuma mteja nambari moja ya bandari yake M. Na **mteja** **anasisitiza** uhusiano wa data kutoka kwenye bandari yake P hadi bandari M ya Seva ya FTP.

Chanzo: [https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/](https://www.thesecuritybuddy.com/vulnerabilities/what-is-ftp-bounce-attack/)

### Uchunguzi wa Uhusiano

Amri za **FTP** **`debug`** na **`trace`** zinaweza kutumika kuona **jinsi mawasiliano yanavyotokea**.

## Uchambuzi

### Kukamata Bango
```bash
nc -vn <IP> 21
openssl s_client -connect crossfit.htb:21 -starttls ftp #Get certificate if any
```
### Kuunganisha kwenye FTP kwa kutumia starttls

To connect to an FTP server using the STARTTLS command, follow these steps:

1. Open a terminal or command prompt.
2. Use the `ftp` command followed by the IP address or domain name of the FTP server you want to connect to. For example:
   ```
   ftp 192.168.1.100
   ```
3. Enter your FTP username and password when prompted.
4. Once connected, use the `quote` command to send the `AUTH TLS` command to the server. This command enables the TLS encryption.
   ```
   quote AUTH TLS
   ```
5. After sending the `AUTH TLS` command, use the `quote` command again to send the `PBSZ 0` command. This command sets the protection buffer size to 0.
   ```
   quote PBSZ 0
   ```
6. Finally, use the `quote` command to send the `PROT P` command. This command sets the data channel protection level to private.
   ```
   quote PROT P
   ```

By following these steps, you will be able to connect to an FTP server using the STARTTLS command and establish a secure connection.
```
lftp
lftp :~> set ftp:ssl-force true
lftp :~> set ssl:verify-certificate no
lftp :~> connect 10.10.10.208
lftp 10.10.10.208:~> login
Usage: login <user|URL> [<pass>]
lftp 10.10.10.208:~> login username Password
```
### Unauth enum

Kwa kutumia **nmap**
```bash
sudo nmap -sV -p21 -sC -A 10.10.10.10
```
Unaweza kutumia amri `HELP` na `FEAT` kupata habari fulani za seva ya FTP:
```
HELP
214-The following commands are recognized (* =>'s unimplemented):
214-CWD     XCWD    CDUP    XCUP    SMNT*   QUIT    PORT    PASV
214-EPRT    EPSV    ALLO*   RNFR    RNTO    DELE    MDTM    RMD
214-XRMD    MKD     XMKD    PWD     XPWD    SIZE    SYST    HELP
214-NOOP    FEAT    OPTS    AUTH    CCC*    CONF*   ENC*    MIC*
214-PBSZ    PROT    TYPE    STRU    MODE    RETR    STOR    STOU
214-APPE    REST    ABOR    USER    PASS    ACCT*   REIN*   LIST
214-NLST    STAT    SITE    MLSD    MLST
214 Direct comments to root@drei.work

FEAT
211-Features:
PROT
CCC
PBSZ
AUTH TLS
MFF modify;UNIX.group;UNIX.mode;
REST STREAM
MLST modify*;perm*;size*;type*;unique*;UNIX.group*;UNIX.mode*;UNIX.owner*;
UTF8
EPRT
EPSV
LANG en-US
MDTM
SSCN
TVFS
MFMT
SIZE
211 End

STAT
#Info about the FTP server (version, configs, status...)
```
### Kuingia kwa Siri

_anonymous : anonymous_\
_anonymous :_\
_ftp : ftp_
```bash
ftp <IP>
>anonymous
>anonymous
>ls -a # List all files (even hidden) (yes, they could be hidden)
>binary #Set transmission to binary instead of ascii
>ascii #Set transmission to ascii instead of binary
>bye #exit
```
### [Kuvunja nguvu](../../generic-methodologies-and-resources/brute-force.md#ftp)

Hapa unaweza kupata orodha nzuri ya siri za msingi za ftp: [https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ftp-betterdefaultpasslist.txt)

### Kiotomatiki

Uthibitishaji wa Anon na uchunguzi wa FTP hutolewa kwa chaguo la **-sC** au nmap kwa chaguo:
```bash
nmap --script ftp-* -p 21 <ip>
```
## Uunganisho wa Kivinjari

Unaweza kuunganisha kwenye seva ya FTP kwa kutumia kivinjari (kama vile Firefox) kwa kutumia URL kama:
```bash
ftp://anonymous:anonymous@10.10.10.98
```
Tafadhali kumbuka kuwa ikiwa **programu ya wavuti** inatuma data inayodhibitiwa na mtumiaji **moja kwa moja kwenye seva ya FTP** unaweza kutuma herufi zilizofichwa mara mbili kwa kutumia URL encode `%0d%0a` (katika URL encode mara mbili hii ni `%250d%250a`) na kufanya **seva ya FTP ifanye vitendo visivyo na mpangilio**. Moja ya vitendo visivyo na mpangilio vinavyowezekana ni kupakua maudhui kutoka kwenye seva inayodhibitiwa na watumiaji, kufanya uchunguzi wa bandari au jaribu kuwasiliana na huduma zingine zinazotegemea maandishi wazi (kama http).

## Pakua faili zote kutoka kwenye FTP
```bash
wget -m ftp://anonymous:anonymous@10.10.10.98 #Donwload all
wget -m --no-passive ftp://anonymous:anonymous@10.10.10.98 #Download all
```
Ikiwa jina lako la mtumiaji/nywila lina herufi maalum, [amri ifuatayo](https://stackoverflow.com/a/113900/13647948) inaweza kutumika:
```bash
wget -r --user="USERNAME" --password="PASSWORD" ftp://server.com/
```
## Baadhi ya amri za FTP

* **`USER jina_la_mtumiaji`**
* **`PASS nenosiri`**
* **`HELP`** Seva inaonyesha ni amri zipi zinasaidiwa
* **`PORT 127,0,0,1,0,80`** Hii itaonyesha seva ya FTP kuweka uhusiano na IP 127.0.0.1 kwenye bandari 80 (_unahitaji kuweka herufi ya 5 kama "0" na ya 6 kama bandari kwa mfumo wa decimali au tumia ya 5 na ya 6 kuonyesha bandari kwa mfumo wa hex_).
* **`EPRT |2|127.0.0.1|80|`** Hii itaonyesha seva ya FTP kuweka uhusiano wa TCP (_unaonyeshwa na "2"_) na IP 127.0.0.1 kwenye bandari 80. Amri hii **inasaidia IPv6**.
* **`LIST`** Hii itatuma orodha ya faili kwenye saraka ya sasa
* **`LIST -R`** Orodhesha kwa njia ya kurekodi (ikiwa inaruhusiwa na seva)
* **`APPE /njia/kitu.txt`** Hii itaonyesha FTP kuweka data iliyopokelewa kutoka kwa uhusiano wa **pasifiki** au kutoka kwa uhusiano wa **PORT/EPRT** kwenye faili. Ikiwa jina la faili lipo, itaongeza data.
* **`STOR /njia/kitu.txt`** Kama `APPE` lakini itaandika juu ya faili
* **`STOU /njia/kitu.txt`** Kama `APPE`, lakini ikiwepo haitafanya chochote.
* **`RETR /njia/ya/faili`** Uhusiano wa pasifiki au uhusiano wa bandari lazima uwe umewekwa. Kisha, seva ya FTP itatuma faili iliyoorodheshwa kupitia uhusiano huo
* **`REST 6`** Hii itaonyesha seva kuwa wakati inatuma kitu kwa kutumia `RETR` inapaswa kuanza kwenye herufi ya 6.
* **`TYPE i`** Weka uhamisho kuwa wa binary
* **`PASV`** Hii itafungua uhusiano wa pasifiki na itaonyesha mtumiaji mahali anaweza kuunganisha
* **`PUT /tmp/faili.txt`** Pakia faili iliyoorodheshwa kwenye FTP

![](<../../.gitbook/assets/image (227).png>)

## Shambulio la FTPBounce

Baadhi ya seva za FTP huruhusu amri ya PORT. Amri hii inaweza kutumika kuonyesha seva kuwa unataka kuunganisha kwenye seva nyingine ya FTP kwenye bandari fulani. Kisha, unaweza kutumia hii kuangalia ni bandari zipi za mwenyeji zimefunguliwa kupitia seva ya FTP.

[Jifunze hapa jinsi ya kutumia seva ya FTP kufanya uchunguzi wa bandari.](ftp-bounce-attack.md)

Unaweza pia kutumia tabia hii kuifanya seva ya FTP iweze kuingiliana na itifaki nyingine. Unaweza **kupakia faili inayojumuisha ombi la HTTP** na kufanya seva ya FTP yenye udhaifu **iyatume kwa seva ya HTTP isiyojulikana** (_labda kuongeza mtumiaji mpya wa admin?_) au hata kupakia ombi la FTP na kufanya seva ya FTP yenye udhaifu ipakue faili kwa seva ya FTP tofauti.\
Nadharia ni rahisi:

1. **Pakia ombi (ndani ya faili ya maandishi) kwenye seva yenye udhaifu.** Kumbuka kuwa ikiwa unataka kuongea na seva nyingine ya HTTP au FTP unahitaji kubadilisha mistari na `0x0d 0x0a`
2. **Tumia `REST X` ili kuepuka kutuma herufi ambazo hauitaki kutuma** (labda kupakia ombi ndani ya faili ulihitaji kuweka kichwa cha picha mwanzoni)
3. **Tumia `PORT` kuunganisha kwenye seva na huduma isiyojulikana**
4. **Tumia `RETR` kutuma ombi lililohifadhiwa kwa seva.**

Inawezekana sana kuwa hii **itatoa kosa kama** _**Socket not writable**_ **kwa sababu uhusiano haudumu vya kutosha kupeleka data na `RETR`**. Mapendekezo ya kujaribu kuepuka hilo ni:

* Ikiwa unatuma ombi la HTTP, **weka ombi lile lile mara moja baada ya nyingine** hadi kufikia angalau **\~0.5MB**. Kama hivi:

{% file src="../../.gitbook/assets/posts (1).txt" %}
posts.txt
{% endfile %}

* Jaribu **kujaza ombi na data "taka" inayohusiana na itifaki** (ukizungumza na FTP labda amri za taka au kurudia maagizo ya `RETR` ili kupata faili)
* Tu **jaza ombi na herufi za null nyingi au nyingine** (zilizogawanywa kwenye mistari au la)

Hoe, hapa una [mfano wa zamani kuhusu jinsi ya kutumia hii kuifanya seva ya FTP ipakue faili kutoka kwa seva ya FTP tofauti.](ftp-bounce-download-2oftp-file.md)

## Udhaifu wa Seva ya Filezilla

**FileZilla** kawaida **inabana** huduma ya **utawala** ya **FileZilla-Server** (bandari 14147) kwa **lokal**. Ikiwa unaweza kuunda **tuneli** kutoka **kwenye kifaa chako** ili kupata bandari hii, unaweza **kuunganisha** kwenye **hiyo** kwa kutumia **nenosiri tupu** na **kuunda** mtumiaji **mpya** kwa huduma ya FTP.

## Faili za mipangilio
```
ftpusers
ftp.conf
proftpd.conf
vsftpd.conf
```
### Baada ya Uvamizi

Mipangilio ya msingi ya vsFTPd inaweza kupatikana katika `/etc/vsftpd.conf`. Hapa, unaweza kupata mipangilio hatari:

* `anonymous_enable=YES`
* `anon_upload_enable=YES`
* `anon_mkdir_write_enable=YES`
* `anon_root=/home/username/ftp` - Saraka kwa ajili ya wageni.
* `chown_uploads=YES` - Badilisha umiliki wa faili zilizopakiwa kwa njia ya wageni
* `chown_username=username` - Mtumiaji ambaye anapewa umiliki wa faili zilizopakiwa kwa njia ya wageni
* `local_enable=YES` - Wezesha watumiaji wa ndani kuingia
* `no_anon_password=YES` - Usiulize wageni kwa nenosiri
* `write_enable=YES` - Ruhusu amri: STOR, DELE, RNFR, RNTO, MKD, RMD, APPE, na SITE

### Shodan

* `ftp`
* `port:21`

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Tafuta udhaifu ambao ni muhimu zaidi ili uweze kuyatatua haraka. Intruder inafuatilia eneo lako la shambulio, inatekeleza uchunguzi wa vitisho wa kujitokeza, inapata matatizo katika mfumo wako mzima wa teknolojia, kutoka kwa APIs hadi programu za wavuti na mifumo ya wingu. [**Jaribu bure**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) leo.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Amri za Kiotomatiki za HackTricks
```
Protocol_Name: FTP    #Protocol Abbreviation if there is one.
Port_Number:  21     #Comma separated if there is more than one.
Protocol_Description: File Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for FTP
Note: |
Anonymous Login
-bi     <<< so that your put is done via binary

wget --mirror 'ftp://ftp_user:UTDRSCH53c"$6hys@10.10.10.59'
^^to download all dirs and files

wget --no-passive-ftp --mirror 'ftp://anonymous:anonymous@10.10.10.98'
if PASV transfer is disabled

https://book.hacktricks.xyz/pentesting/pentesting-ftp

Entry_2:
Name: Banner Grab
Description: Grab FTP Banner via telnet
Command: telnet -n {IP} 21

Entry_3:
Name: Cert Grab
Description: Grab FTP Certificate if existing
Command: openssl s_client -connect {IP}:21 -starttls ftp

Entry_4:
Name: nmap ftp
Description: Anon login and bounce FTP checks are performed
Command: nmap --script ftp-* -p 21 {IP}

Entry_5:
Name: Browser Connection
Description: Connect with Browser
Note: ftp://anonymous:anonymous@{IP}

Entry_6:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -t 1 -l {Username} -P {Big_Passwordlist} -vV {IP} ftp

Entry_7:
Name: consolesless mfs enumeration ftp
Description: FTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ftp/anonymous; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/ftp_version; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/bison_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ftp/colorado_ftp_traversal; set RHOSTS {IP}; set RPORT 21; run; exit' &&  msfconsole -q -x 'use auxiliary/scanner/ftp/titanftp_xcrc_traversal; set RHOSTS {IP}; set RPORT 21; run; exit'
```
<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

* Je, unafanya kazi katika **kampuni ya usalama wa mtandao**? Je, ungependa kuona **kampuni yako ikionekana katika HackTricks**? Au ungependa kupata ufikiaji wa **toleo jipya zaidi la PEASS au kupakua HackTricks kwa PDF**? Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* **Jiunge na** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **nifuatilie** kwenye **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye [repo ya hacktricks](https://github.com/carlospolop/hacktricks) na [repo ya hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
