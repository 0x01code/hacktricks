## SIP (Protocolo de Inicia√ß√£o de Sess√£o)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

O SIP (Protocolo de Inicia√ß√£o de Sess√£o) √© um **protocolo de sinaliza√ß√£o e controle de chamadas** amplamente utilizado para estabelecer, modificar e encerrar sess√µes multim√≠dia, incluindo voz, v√≠deo e mensagens instant√¢neas, em redes IP. Desenvolvido pelo **Internet Engineering Task Force (IETF)**, o SIP √© definido no **RFC 3261** e se tornou o padr√£o de fato para VoIP e comunica√ß√µes unificadas.

Algumas caracter√≠sticas importantes do SIP incluem:

1. **Protocolo baseado em texto**: o SIP √© um protocolo baseado em texto, o que o torna leg√≠vel para humanos e mais f√°cil de depurar. √â baseado em um modelo de solicita√ß√£o-resposta, semelhante ao HTTP, e usa m√©todos como INVITE, ACK, BYE e CANCEL para controlar as sess√µes de chamada.
2. **Escalabilidade e flexibilidade**: o SIP √© altamente escal√°vel e pode ser usado em implanta√ß√µes de pequena escala, bem como em ambientes empresariais e de operadoras de grande porte. Ele pode ser facilmente estendido com novos recursos, tornando-o adapt√°vel a v√°rios casos de uso e requisitos.
3. **Interoperabilidade**: a ampla ado√ß√£o e padroniza√ß√£o do SIP garantem melhor interoperabilidade entre diferentes dispositivos, aplicativos e provedores de servi√ßos, promovendo comunica√ß√£o perfeita em v√°rias plataformas.
4. **Design modular**: o SIP funciona com outros protocolos como **RTP (Protocolo de Transporte em Tempo Real)** para transmiss√£o de m√≠dia e **SDP (Protocolo de Descri√ß√£o de Sess√£o)** para descrever sess√µes multim√≠dia. Esse design modular permite maior flexibilidade e compatibilidade com diferentes tipos e codecs de m√≠dia.
5. **Servidores de proxy e redirecionamento**: o SIP pode usar servidores de proxy e redirecionamento para facilitar o roteamento de chamadas e fornecer recursos avan√ßados como encaminhamento de chamadas, transfer√™ncia de chamadas e servi√ßos de correio de voz.
6. **Presen√ßa e mensagens instant√¢neas**: o SIP n√£o se limita √† comunica√ß√£o de voz e v√≠deo. Ele tamb√©m suporta presen√ßa e mensagens instant√¢neas, permitindo uma ampla gama de aplicativos de comunica√ß√£o unificada.

Apesar de suas muitas vantagens, o SIP pode ser complexo de configurar e gerenciar, especialmente ao lidar com problemas de travessia NAT e firewall. No entanto, sua versatilidade, escalabilidade e amplo suporte em toda a ind√∫stria o tornam uma escolha popular para comunica√ß√£o de VoIP e multim√≠dia.

### M√©todos SIP

Os m√©todos SIP principais definidos no **RFC 3261** incluem:

1. **INVITE**: usado para **iniciar uma nova sess√£o (chamada)** ou modificar uma existente. O m√©todo INVITE carrega a descri√ß√£o da sess√£o (geralmente usando SDP) para informar o destinat√°rio sobre os detalhes da sess√£o proposta, como tipos de m√≠dia, codecs e protocolos de transporte.
2. **ACK**: enviado para **confirmar o recebimento** de uma resposta final a uma solicita√ß√£o INVITE. O m√©todo ACK garante a confiabilidade das transa√ß√µes INVITE fornecendo confirma√ß√£o de ponta a ponta.
3. **BYE**: usado para **encerrar uma sess√£o estabelecida (chamada)**. O m√©todo BYE √© enviado por qualquer uma das partes na sess√£o para indicar que desejam encerrar a comunica√ß√£o.
4. **CANCEL**: enviado para **cancelar uma solicita√ß√£o INVITE pendente** antes que a sess√£o seja estabelecida. O m√©todo CANCEL permite que o remetente interrompa uma transa√ß√£o INVITE se mudar de ideia ou se n√£o houver resposta do destinat√°rio.
5. **OPTIONS**: usado para **consultar as capacidades de um servidor ou agente de usu√°rio SIP**. O m√©todo OPTIONS pode ser enviado para solicitar informa√ß√µes sobre m√©todos suportados, tipos de m√≠dia ou outras extens√µes sem realmente estabelecer uma sess√£o.
6. **REGISTER**: usado por um agente de usu√°rio para **registrar sua localiza√ß√£o atual com um servidor de registro SIP**. O m√©todo REGISTER ajuda a manter um mapeamento atualizado entre o URI SIP de um usu√°rio e seu endere√ßo IP atual, permitindo o roteamento e entrega de chamadas.

{% hint style="warning" %}
Observe que para ligar para algu√©m n√£o √© **necess√°rio usar o REGISTER** para nada.\
No entanto, √© poss√≠vel que, para realizar um **INVITE**, o chamador precise se **autenticar** primeiro ou receber√° uma resposta **`401 N√£o autorizado`**.
{% endhint %}

Al√©m desses m√©todos principais, existem **v√°rios m√©todos de extens√£o SIP** definidos em outros RFCs, como:

1. **SUBSCRIBE**: definido no RFC 6665, o m√©todo SUBSCRIBE √© usado para **solicitar notifica√ß√µes** sobre o estado de um recurso espec√≠fico, como a presen√ßa ou o status da chamada de um usu√°rio.
2. **NOTIFY**: tamb√©m definido no RFC 6665, o m√©todo NOTIFY √© enviado por um servidor para **informar um agente de usu√°rio inscrito** sobre altera√ß√µes no estado de um recurso monitorado.
3. **REFER**: definido no RFC 3515, o m√©todo REFER √© usado para **solicitar que o destinat
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Cada par√¢metro explicado</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Esta linha indica o m√©todo (INVITE), o URI da solicita√ß√£o (sip:[jdoe@example.com](mailto:jdoe@example.com)) e a vers√£o do SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - O cabe√ßalho Via especifica o protocolo de transporte (UDP) e o endere√ßo do cliente (pc33.example.com). O par√¢metro "branch" √© usado para detec√ß√£o de loop e correspond√™ncia de transa√ß√£o.
3. **Max-Forwards**: `Max-Forwards: 70` - Este campo de cabe√ßalho limita o n√∫mero de vezes que a solicita√ß√£o pode ser encaminhada por proxies para evitar loops infinitos.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - O cabe√ßalho To especifica o destinat√°rio da chamada, incluindo seu nome de exibi√ß√£o (John Doe) e URI do SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - O cabe√ßalho From especifica o remetente da chamada, incluindo seu nome de exibi√ß√£o (Jane Smith) e URI do SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). O par√¢metro "tag" √© usado para identificar exclusivamente o papel do remetente no di√°logo.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - O cabe√ßalho Call-ID identifica exclusivamente uma sess√£o de chamada entre dois agentes de usu√°rio.
7. **CSeq**: `CSeq: 314159 INVITE` - O cabe√ßalho CSeq cont√©m um n√∫mero de sequ√™ncia e o m√©todo usado na solicita√ß√£o. √â usado para corresponder respostas a solicita√ß√µes e detectar mensagens fora de ordem.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - O cabe√ßalho Contact fornece uma rota direta para o remetente, que pode ser usado para solicita√ß√µes e respostas subsequentes.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - O cabe√ßalho User-Agent fornece informa√ß√µes sobre o software ou hardware do remetente, incluindo seu nome e vers√£o.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - O cabe√ßalho Allow lista os m√©todos SIP suportados pelo remetente. Isso ajuda o destinat√°rio a entender quais m√©todos podem ser usados durante a comunica√ß√£o.
11. **Content-Type**: `Content-Type: application/sdp` - O cabe√ßalho Content-Type especifica o tipo de m√≠dia do corpo da mensagem, neste caso, SDP (Protocolo de Descri√ß√£o de Sess√£o).
12. **Content-Length**: `Content-Length: 142` - O cabe√ßalho Content-Length indica o tamanho do corpo da mensagem em bytes.
13. **Corpo da mensagem**: O corpo da mensagem cont√©m a descri√ß√£o da sess√£o SDP, que inclui informa√ß√µes sobre os tipos de m√≠dia, codecs e protocolos de transporte para a sess√£o proposta.

* `v=0` - Vers√£o do protocolo (0 para SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Identificador de origem e sess√£o
* `s=-` - Nome da sess√£o (um h√≠fen √∫nico indica que n√£o h√° nome de sess√£o)
* `c=IN IP4 pc33.example.com` - Informa√ß√µes de conex√£o (tipo de rede, tipo de endere√ßo e endere√ßo)
* `t=0 0` - Informa√ß√µes de tempo (hor√°rios de in√≠cio e t√©rmino, 0 0 significa que a sess√£o n√£o est√° limitada)
* `m=audio 49170 RTP/AVP 0` - Descri√ß√£o da m√≠dia (tipo de m√≠dia, n√∫mero da porta, protocolo de transporte e lista de formatos). Neste caso, especifica um fluxo de √°udio usando RTP/AVP (Protocolo de Transporte em Tempo Real / Perfil de V√≠deo) e formato 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atributo que mapeia o formato (0) para o codec (PCMU) e sua taxa de clock (8000 Hz).

</details>

### Exemplo de SIP REGISTER

O m√©todo REGISTER √© usado no Protocolo de Inicia√ß√£o de Sess√£o (SIP) para permitir que um agente de usu√°rio (UA), como um telefone VoIP ou um softphone, **registre sua localiza√ß√£o com um servidor de registro SIP**. Esse processo permite que o servidor saiba **onde encaminhar as solicita√ß√µes SIP recebidas destinadas ao usu√°rio registrado**. O servidor de registro geralmente faz parte de um servidor proxy SIP ou de um servidor de registro dedicado.

Aqui est√° um exemplo detalhado das mensagens SIP envolvidas em um processo de autentica√ß√£o REGISTER: 

1. Solicita√ß√£o **REGISTER** inicial do UA para o servidor de registro:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Esta mensagem REGISTER inicial √© enviada pelo UA (Alice) para o servidor de registro. Ela inclui informa√ß√µes importantes, como a dura√ß√£o desejada do registro (Expires), o URI SIP do usu√°rio (sip:[alice@example.com](mailto:alice@example.com)) e o endere√ßo de contato do usu√°rio (sip:alice@192.168.1.100:5060).

2. Resposta **401 N√£o Autorizado** do servidor de registro:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
O servidor de registro responde com uma mensagem "401 N√£o autorizado", que inclui um cabe√ßalho "WWW-Authenticate". Este cabe√ßalho cont√©m informa√ß√µes necess√°rias para que o UA se autentique, como o **reino de autentica√ß√£o, nonce e algoritmo**.

3. Pedido de registro **com credenciais de autentica√ß√£o**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
O UA envia outro pedido REGISTER, desta vez incluindo o cabe√ßalho "Authorization" com as credenciais necess√°rias, como o nome de usu√°rio, realm, nonce e um valor de resposta calculado usando as informa√ß√µes fornecidas e a senha do usu√°rio.

Assim √© calculada a resposta de autoriza√ß√£o:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
    # 1. Calculate HA1 (concatenation of username, realm, and password)
    ha1_input = f"{username}:{realm}:{password}"
    ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

    # 2. Calculate HA2 (concatenation of method and uri)
    ha2_input = f"{method}:{uri}"
    ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

    # 3. Calculate the final response value (concatenation of h1, stuff and h2)
    response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
    response = hashlib.md5(response_input.encode()).hexdigest()

    return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. Resposta de **registro bem-sucedido** do servidor de registro:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Depois que o servidor de registro verifica as credenciais fornecidas, **ele envia uma resposta "200 OK" para indicar que o registro foi bem-sucedido**. A resposta inclui as informa√ß√µes de contato registradas e o tempo de expira√ß√£o do registro. Neste ponto, o agente do usu√°rio (Alice) est√° registrado com sucesso no servidor de registro SIP e as solicita√ß√µes SIP de entrada para Alice podem ser roteadas para o endere√ßo de contato apropriado.

### Exemplo de Chamada

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
N√£o √© mencionado, mas o Usu√°rio B precisa ter enviado uma mensagem **REGISTER para o Proxy 2** antes de poder receber chamadas.
{% endhint %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
