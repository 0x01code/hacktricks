# SIP (Session Initiation Protocol)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Podstawowe informacje

SIP (Session Initiation Protocol) to **protokół sygnalizacyjny i sterowania połączeniami** szeroko stosowany do nawiązywania, modyfikowania i zamykania sesji multimedialnych, w tym głosowych, wideo i komunikacji natychmiastowej, w sieciach IP. Opracowany przez **Internet Engineering Task Force (IETF)**, SIP jest zdefiniowany w **RFC 3261** i stał się de facto standardem dla VoIP i komunikacji zintegrowanej.

Niektóre kluczowe cechy SIP to:

1. **Protokół oparty na tekście**: SIP jest protokołem opartym na tekście, co czyni go czytelnym dla człowieka i łatwiejszym do debugowania. Opiera się na modelu żądanie-odpowiedź, podobnym do HTTP, i używa metod takich jak INVITE, ACK, BYE i CANCEL do sterowania sesjami połączeń.
2. **Skalowalność i elastyczność**: SIP jest wysoce skalowalny i może być stosowany zarówno w małych implementacjach, jak i w dużych środowiskach przedsiębiorstwowych i operatorskich. Może być łatwo rozszerzany o nowe funkcje, co pozwala na dostosowanie go do różnych przypadków użycia i wymagań.
3. **Interoperacyjność**: Powszechne stosowanie i standaryzacja SIP zapewnia lepszą interoperacyjność między różnymi urządzeniami, aplikacjami i dostawcami usług, promując płynną komunikację na różnych platformach.
4. **Modularna konstrukcja**: SIP współpracuje z innymi protokołami, takimi jak **RTP (Real-time Transport Protocol)** do transmisji multimediów i **SDP (Session Description Protocol)** do opisu sesji multimedialnych. Ta modularna konstrukcja pozwala na większą elastyczność i kompatybilność z różnymi typami mediów i kodekami.
5. **Serwery proxy i przekierowania**: SIP może korzystać z serwerów proxy i przekierowań do ułatwienia routingu połączeń i dostarczania zaawansowanych funkcji, takich jak przekazywanie połączeń, transfer połączeń i usługi poczty głosowej.
6. **Obecność i komunikacja natychmiastowa**: SIP nie jest ograniczony do komunikacji głosowej i wideo. Obsługuje również obecność i komunikację natychmiastową, umożliwiając szeroki zakres zastosowań w komunikacji zintegrowanej.

Mimo wielu zalet, SIP może być skomplikowany w konfiguracji i zarządzaniu, zwłaszcza przy rozwiązywaniu problemów z przekraczaniem NAT i zapory ogniowej. Jednak jego wszechstronność, skalowalność i szerokie wsparcie w całej branży sprawiają, że jest popularnym wyborem dla VoIP i komunikacji multimedialnej.

### Metody SIP

Podstawowe metody SIP zdefiniowane w **RFC 3261** to:

1. **INVITE**: Służy do **inicjowania nowej sesji (połączenia)** lub modyfikowania istniejącej. Metoda INVITE przenosi opis sesji (zwykle za pomocą SDP), informując odbiorcę o szczegółach proponowanej sesji, takich jak typy mediów, kodeki i protokoły transportowe.
2. **ACK**: Wysyłane w celu **potwierdzenia otrzymania** ostatecznej odpowiedzi na żądanie INVITE. Metoda ACK zapewnia niezawodność transakcji INVITE poprzez dostarczenie potwierdzenia od końca do końca.
3. **BYE**: Służy do **zakończenia ustanowionej sesji (połączenia)**. Metoda BYE jest wysyłana przez jedną ze stron w sesji, aby wskazać, że chcą zakończyć komunikację.
4. **CANCEL**: Wysyłane w celu **anulowania oczekującego żądania INVITE** przed ustanowieniem sesji. Metoda CANCEL pozwala nadawcy przerwać transakcję INVITE, jeśli zmieni zdanie lub jeśli nie otrzyma odpowiedzi od odbiorcy.
5. **OPTIONS**: Służy do **zapytania o możliwości serwera SIP lub agenta użytkownika**. Metoda OPTIONS może być wysłana w celu uzyskania informacji o obsługiwanych metodach, typach mediów lub innych rozszerzeniach bez faktycznego ustanawiania sesji.
6. **REGISTER**: Używane przez agenta użytkownika do **zarejestrowania bieżącego położenia z rejestratorem SIP**. Metoda REGISTER pomaga w utrzymaniu aktualnego mapowania między SIP URI użytkownika a jego bieżącym adresem IP, umożliwiając routowanie i dostarczanie połączeń.

{% hint style="warning" %}
Należy zauważyć, że do wykonania połączenia **nie jest konieczne użycie metody REGISTER**.\
Jednak możliwe jest, że w celu wykonania **INVITE** dzwoniący musi się **uwierzytelnić** lub otrzyma odpowiedź **`401 Unauthorized`**.
{% endhint %}

Oprócz tych podstawowych metod, istnieje **kilka rozszerzeń SIP** zdefiniowanych w innych RFC, takich jak:

1. **SUBSCRIBE**: Zdefiniowana w RFC 6665, metoda SUBSCRIBE służy do **żądania powiadomień** o stanie określonego zasobu, takiego jak obecność użytkownika lub status połączenia.
2. **NOTIFY**: Również zdefiniowana w RFC 6665, metoda NOTIFY jest wysyłana przez serwer, aby **poinformować zarejestrowany agent użytkownika** o zmianach w stanie monitorowanego zasobu.
3. **REFER**: Zdefiniowana w RFC 3515, metoda REFER służy do **żądania, aby odbiorca przeprowadził transfer lub skierował do strony trzeciej**. Jest to zwy
## Przykłady

### Przykład SIP INVITE
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Wyjaśnienie każdego parametru</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Ta linia wskazuje metodę (INVITE), URI żądania (sip:[jdoe@example.com](mailto:jdoe@example.com)) i wersję SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Nagłówek Via określa protokół transportowy (UDP) i adres klienta (pc33.example.com). Parametr "branch" jest używany do wykrywania pętli i dopasowywania transakcji.
3. **Max-Forwards**: `Max-Forwards: 70` - To pole nagłówka ogranicza liczbę przekierowań żądania przez serwery pośredniczące, aby uniknąć nieskończonych pętli.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - Nagłówek To określa odbiorcę połączenia, w tym jego nazwę wyświetlaną (John Doe) i URI SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - Nagłówek From określa nadawcę połączenia, w tym jego nazwę wyświetlaną (Jane Smith) i URI SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). Parametr "tag" jest używany do jednoznacznego identyfikowania roli nadawcy w dialogu.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Nagłówek Call-ID jednoznacznie identyfikuje sesję połączenia między dwoma agentami użytkownika.
7. **CSeq**: `CSeq: 314159 INVITE` - Nagłówek CSeq zawiera numer sekwencji i metodę używaną w żądaniu. Służy do dopasowywania odpowiedzi do żądań i wykrywania wiadomości otrzymanych w niewłaściwej kolejności.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Nagłówek Contact zapewnia bezpośrednią trasę do nadawcy, która może być używana do kolejnych żądań i odpowiedzi.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - Nagłówek User-Agent zawiera informacje o oprogramowaniu lub sprzęcie nadawcy, w tym jego nazwę i wersję.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Nagłówek Allow wymienia obsługiwane przez nadawcę metody SIP. Pomaga odbiorcy zrozumieć, które metody mogą być używane podczas komunikacji.
11. **Content-Type**: `Content-Type: application/sdp` - Nagłówek Content-Type określa typ multimediów treści wiadomości, w tym przypadku SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - Nagłówek Content-Length wskazuje rozmiar treści wiadomości w bajtach.
13. **Treść wiadomości**: Treść wiadomości zawiera opis sesji SDP, który zawiera informacje o typach multimediów, kodekach i protokołach transportowych dla proponowanej sesji.

* `v=0` - Wersja protokołu (0 dla SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Identyfikator pochodzącego i sesji
* `s=-` - Nazwa sesji (pojedynczy myślnik oznacza brak nazwy sesji)
* `c=IN IP4 pc33.example.com` - Informacje o połączeniu (typ sieci, typ adresu i adres)
* `t=0 0` - Informacje o czasie (czasy rozpoczęcia i zakończenia, 0 0 oznacza, że sesja nie jest ograniczona)
* `m=audio 49170 RTP/AVP 0` - Opis multimediów (typ multimediów, numer portu, protokół transportowy i lista formatów). W tym przypadku określa strumień audio za pomocą RTP/AVP (Real-time Transport Protocol / Audio Video Profile) i formatu 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atrybut mapujący format (0) na kodek (PCMU) i jego częstotliwość próbkowania (8000 Hz).

</details>

### Przykład rejestracji SIP

Metoda REGISTER jest używana w protokole inicjacji sesji (SIP), aby umożliwić agentowi użytkownika (UA), takiemu jak telefon VoIP lub softfon, **zarejestrowanie swojej lokalizacji w serwerze rejestracyjnym SIP**. Ten proces informuje serwer, **gdzie kierować przychodzące żądania SIP przeznaczone dla zarejestrowanego użytkownika**. Serwer rejestracyjny zwykle jest częścią serwera pośredniczącego SIP lub dedykowanego serwera rejestracji.

Oto szczegółowy przykład wiadomości SIP zaangażowanych w proces uwierzytelniania rejestracji:

1. Początkowe żądanie **REGISTER** od UA do serwera rejestracyjnego:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Ten początkowy komunikat REGISTER jest wysyłany przez UA (Alice) do serwera rejestratora. Zawiera ważne informacje, takie jak pożądany czas trwania rejestracji (Expires), SIP URI użytkownika (sip:[alice@example.com](mailto:alice@example.com)) oraz adres kontaktowy użytkownika (sip:alice@192.168.1.100:5060).

2. Odpowiedź **401 Unauthorized** od serwera rejestratora:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Serwer rejestratora odpowiada wiadomością "401 Unauthorized", która zawiera nagłówek "WWW-Authenticate". Nagłówek ten zawiera informacje wymagane do uwierzytelnienia UA, takie jak **obszar uwierzytelniania, nonce i algorytm**.

3. Żądanie REJESTRACJI **z danymi uwierzytelniającymi**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA wysyła kolejne żądanie REGISTER, tym razem zawierające nagłówek **"Authorization" z niezbędnymi danymi uwierzytelniającymi, takimi jak nazwa użytkownika, obszar, nonce i wartość odpowiedzi** obliczona przy użyciu dostarczonych informacji i hasła użytkownika.

Tak jest obliczana **odpowiedź uwierzytelniająca (Authorization response)**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Pomyślna rejestracja** odpowiedź od serwera rejestracyjnego:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Po weryfikacji dostarczonych danych uwierzytelniających, **serwer rejestratora wysyła odpowiedź "200 OK" w celu potwierdzenia udanej rejestracji**. Odpowiedź zawiera zarejestrowane informacje kontaktowe oraz czas wygaśnięcia rejestracji. W tym momencie agent użytkownika (Alice) jest pomyślnie zarejestrowany w serwerze rejestratora SIP, a przychodzące żądania SIP dla Alice mogą być kierowane na odpowiedni adres kontaktowy.

### Przykład połączenia

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Nie jest to wspomniane, ale Użytkownik B musi wysłać **wiadomość REGISTER do Proxy 2**, zanim będzie mógł odbierać połączenia.
{% endhint %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) **i** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **repozytoriów GitHub.**

</details>
