# SIP (Session Initiation Protocol)

<details>

<summary><strong>AWS hackleme becerilerini sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

## Temel Bilgiler

SIP (Session Initiation Protocol), IP ağları üzerinden ses, video ve anlık iletişim gibi çoklu ortam oturumlarının kurulması, değiştirilmesi ve sonlandırılması için yaygın olarak kullanılan bir **işaret ve çağrı kontrol protokolüdür**. **Internet Engineering Task Force (IETF)** tarafından geliştirilen SIP, **RFC 3261**'de tanımlanmış olup VoIP ve birleşik iletişim için de facto standart haline gelmiştir.

SIP'nin bazı önemli özellikleri şunlardır:

1. **Metin Tabanlı Protokol**: SIP, metin tabanlı bir protokoldür, bu da insan tarafından okunabilir ve hata ayıklaması daha kolay olmasını sağlar. HTTP'ye benzer şekilde istek-cevap modeline dayanır ve çağrı oturumlarını kontrol etmek için INVITE, ACK, BYE ve CANCEL gibi yöntemler kullanır.
2. **Ölçeklenebilirlik ve Esneklik**: SIP, küçük ölçekli dağıtımlardan büyük kurumsal ve taşıyıcı sınıfı ortamlara kadar kullanılabilir. Yeni özelliklerle kolayca genişletilebilir, bu da çeşitli kullanım durumlarına ve gereksinimlere uyum sağlamasını sağlar.
3. **Uyumluluk**: SIP'nin yaygın olarak benimsenmesi ve standartlaştırılması, farklı cihazlar, uygulamalar ve hizmet sağlayıcıları arasında daha iyi uyumluluk sağlar ve çeşitli platformlarda sorunsuz iletişimi teşvik eder.
4. **Modüler Tasarım**: SIP, medya iletimi için **RTP (Real-time Transport Protocol)** ve çoklu ortam oturumlarını tanımlamak için **SDP (Session Description Protocol)** gibi diğer protokollerle birlikte çalışır. Bu modüler tasarım, farklı medya türleri ve kod çözücülerle daha fazla esneklik ve uyumluluk sağlar.
5. **Proxy ve Yönlendirme Sunucuları**: SIP, çağrı yönlendirmeyi kolaylaştırmak ve çağrı yönlendirme, çağrı aktarma ve sesli mesaj hizmetleri gibi gelişmiş özellikler sağlamak için proxy ve yönlendirme sunucularını kullanabilir.
6. **Varlık ve Anlık İletişim**: SIP, sadece ses ve video iletişimle sınırlı değildir. Aynı zamanda varlık ve anlık iletişimi de destekler, geniş bir birleşik iletişim uygulama yelpazesini mümkün kılar.

Birçok avantajına rağmen, SIP, NAT geçişi ve güvenlik duvarı sorunlarıyla uğraşırken yapılandırılması ve yönetimi karmaşık olabilir. Bununla birlikte, çok yönlülüğü, ölçeklenebilirliği ve endüstri genelindeki kapsamlı desteği, VoIP ve çoklu ortam iletişimi için popüler bir seçim yapmaktadır.

### SIP Yöntemleri

**RFC 3261**'de tanımlanan temel SIP yöntemleri şunlardır:

1. **INVITE**: Yeni bir oturumu (çağrıyı) başlatmak veya mevcut bir oturumu değiştirmek için kullanılır. INVITE yöntemi, önerilen oturumun ayrıntıları hakkında alıcıyı bilgilendirmek için oturum açıklamasını (genellikle SDP kullanarak) taşır, medya türleri, kod çözücüler ve iletişim protokolleri gibi.
2. **ACK**: INVITE isteğine verilen nihai yanıtın alındığını **onaylamak** için gönderilir. ACK yöntemi, INVITE işlemlerinin uçtan uca onayını sağlayarak güvenilirliği sağlar.
3. **BYE**: Kurulmuş bir oturumu (çağrıyı) sonlandırmak için kullanılır. BYE yöntemi, iletişimi sonlandırmak isteyen oturumdaki her iki tarafça gönderilir.
4. **CANCEL**: Oturum kurulmadan önce bekleyen bir INVITE isteğini **iptal etmek** için gönderilir. CANCEL yöntemi, gönderenin fikrini değiştirmesi veya alıcıdan yanıt alamaması durumunda bir INVITE işlemini iptal etmesine olanak tanır.
5. **OPTIONS**: Bir SIP sunucusunun veya kullanıcı ajanının yeteneklerini **sorgulamak** için kullanılır. OPTIONS yöntemi, bir oturum kurmadan gerçekleştirilmeden desteklenen yöntemler, medya türleri veya diğer uzantılar hakkında bilgi talep etmek için gönderilebilir.
6. **REGISTER**: Bir kullanıcı ajanının **mevcut konumunu bir SIP kayıt sunucusuna kaydetmek** için kullanılır. REGISTER yöntemi, bir kullanıcının SIP URI'si ile mevcut IP adresi arasında güncel bir eşleme tutulmasına yardımcı olarak çağrı yönlendirmeyi ve teslimatı sağlar.

{% hint style="warning" %}
Birini aramak için **REGISTER'ı kullanmak gerekli değildir**.\
Ancak, **INVITE** işlemini gerçekleştirmek için arayanın önce **kimlik doğrulaması** yapması gerekebilir veya **`401 Unauthorized`** yanıtı alır.
{% endhint %}

Bu temel yöntemlere ek olarak, diğer RFC'lerde tanımlanan **birkaç SIP uzantı yöntemi** bulunur, örneğin:

1. **SUBSCRIBE**: RFC 6665'te tanımlanan SUBSCRIBE yöntemi, belirli bir kaynağın durumu hakkında **bildirimler istemek** için kullanılır, örneğin bir kullanıcının varlığı veya çağrı durumu.
2. **NOTIFY**: Aynı şekilde RFC 6665'te tanımlanan NOTIFY yö
## Örnekler

### SIP INVITE Örneği
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Her Bir Param Açıklaması</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Bu satır, yöntemi (INVITE), istek URI'sini (sip:[jdoe@example.com](mailto:jdoe@example.com)) ve SIP sürümünü (SIP/2.0) belirtir.
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Via başlığı, taşıma protokolünü (UDP) ve istemcinin adresini (pc33.example.com) belirtir. "branch" parametresi, döngü tespiti ve işlem eşleştirmesi için kullanılır.
3. **Max-Forwards**: `Max-Forwards: 70` - Bu başlık alanı, isteğin proxy'ler tarafından sonsuz döngülere yol açmamak için kaç kez yönlendirilebileceğini sınırlar.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - To başlığı, aramanın alıcısını, görüntülenen adlarını (John Doe) ve SIP URI'sini (sip:[jdoe@example.com](mailto:jdoe@example.com)) belirtir.
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - From başlığı, aramanın gönderenini, görüntülenen adlarını (Jane Smith) ve SIP URI'sini (sip:[jsmith@example.org](mailto:jsmith@example.org)) belirtir. "tag" parametresi, gönderenin rolünü benzersiz bir şekilde tanımlamak için kullanılır.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Call-ID başlığı, iki kullanıcı arasındaki bir çağrı oturumunu benzersiz bir şekilde tanımlar.
7. **CSeq**: `CSeq: 314159 INVITE` - CSeq başlığı, bir dizi numarası ve istekte kullanılan yöntemi içerir. Yanıtları isteklere eşleştirmek ve sırasız mesajları tespit etmek için kullanılır.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Contact başlığı, gönderene doğrudan bir rota sağlar ve bu, sonraki istekler ve yanıtlar için kullanılabilir.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - User-Agent başlığı, gönderenin yazılım veya donanımı hakkında bilgi sağlar, adını ve sürümünü içerir.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Allow başlığı, gönderenin desteklediği SIP yöntemlerini listeler. Bu, alıcının iletişim sırasında hangi yöntemlerin kullanılabileceğini anlamasına yardımcı olur.
11. **Content-Type**: `Content-Type: application/sdp` - Content-Type başlığı, ileti gövdesinin ortam türünü belirtir, bu durumda SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - Content-Length başlığı, ileti gövdesinin boyutunu bayt cinsinden belirtir.
13. **İleti Gövdesi**: İleti gövdesi, önerilen oturum için ortam türleri, kodlayıcılar ve taşıma protokollerine ilişkin bilgileri içeren SDP oturum açıklamasını içerir.

* `v=0` - Protokol sürümü (SDP için 0)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Başlatıcı ve oturum kimliği
* `s=-` - Oturum adı (tek bir tire, oturum adı olmadığını gösterir)
* `c=IN IP4 pc33.example.com` - Bağlantı bilgileri (ağ türü, adres türü ve adres)
* `t=0 0` - Zamanlama bilgisi (başlangıç ve bitiş zamanları, 0 0 oturumun sınırlı olmadığını gösterir)
* `m=audio 49170 RTP/AVP 0` - Ortam açıklaması (ortam türü, port numarası, taşıma protokolü ve format listesi). Bu durumda, RTP/AVP (Real-time Transport Protocol / Audio Video Profile) kullanarak bir ses akışını ve format 0'ı (PCMU/8000) belirtir.
* `a=rtpmap:0 PCMU/8000` - Formatı (0) kodeke (PCMU) ve saat hızına (8000 Hz) eşleyen öznitelik.

</details>

### SIP KAYIT Örneği

REGISTER yöntemi, Session Initiation Protocol (SIP) içinde bir kullanıcı ajanının (UA), örneğin bir VoIP telefonunun veya bir softphone'un, **konumunu bir SIP kaydedici sunucuyla kaydetmesine** izin vermek için kullanılır. Bu işlem, sunucunun, kayıtlı kullanıcı için yönlendirilecek gelen SIP isteklerinin **nerelere yönlendirileceğini bilmesini sağlar**. Kaydedici sunucu genellikle bir SIP proxy sunucusunun bir parçası veya ayrı bir kayıt sunucusudur.

İşte bir KAYIT kimlik doğrulama sürecinde yer alan SIP iletilerinin ayrıntılı bir örneği:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Bu başlangıç ​​REGISTER mesajı, UA'nın (Alice) kayıt sunucusuna gönderdiği bir mesajdır. Bu mesaj, istenen kayıt süresi (Expires), kullanıcının SIP URI'si (sip:[alice@example.com](mailto:alice@example.com)) ve kullanıcının iletişim adresi (sip:alice@192.168.1.100:5060) gibi önemli bilgileri içerir.

2. Kayıt sunucusundan gelen **401 Yetkisiz** yanıtı:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Registrar sunucusu, "401 Yetkisiz" mesajıyla yanıt verir ve bunun içinde "WWW-Authenticate" başlığı bulunur. Bu başlık, UA'nın kendini doğrulamak için gereken bilgileri içerir, örneğin **doğrulama alanı, nonce ve algoritma**.

3. Kimlik doğrulama kimlik bilgileriyle REGISTER isteği:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA, bu sefer kullanıcı adı, alan, nonce ve kullanıcının şifresi kullanılarak sağlanan bilgiler ve bir yanıt değeri ile birlikte "Authorization" başlığını içeren başka bir REGISTER isteği gönderir.

İşte "Authorization" yanıtının nasıl hesaplandığı:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Kayıt başarılı** yanıtı, kayıt sunucusundan gelir:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Kayıt sunucusu, sağlanan kimlik bilgilerini doğruladıktan sonra, kaydın başarılı olduğunu belirtmek için bir "200 OK" yanıtı gönderir. Yanıt, kaydedilen iletişim bilgilerini ve kaydın sona erme süresini içerir. Bu noktada, kullanıcı ajanı (Alice), SIP kayıt sunucusuna başarıyla kaydedilmiştir ve Alice için gelen SIP istekleri uygun iletişim adresine yönlendirilebilir.

### Çağrı Örneği

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Belirtilmemiş olsa da, Kullanıcı B'nin çağrıları alabilmesi için önce **Proxy 2'ye bir KAYIT mesajı göndermesi gerekmektedir**.
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'da** takip edin.
* Hacking hilelerinizi **HackTricks** ve **HackTricks Cloud** github depolarına PR göndererek paylaşın.

</details>
