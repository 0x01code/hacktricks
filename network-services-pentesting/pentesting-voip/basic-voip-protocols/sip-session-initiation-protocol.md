# SIP (세션 초기화 프로토콜)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)을 **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 기본 정보

SIP (세션 초기화 프로토콜)은 IP 네트워크를 통해 음성, 비디오, 인스턴트 메시징 등 멀티미디어 세션을 설정, 수정 및 종료하는 데 널리 사용되는 **신호 및 통화 제어 프로토콜**입니다. **인터넷 공학 작업군 (IETF)**에 의해 개발된 SIP은 **RFC 3261**에서 정의되어 VoIP 및 통합 통신의 사실상의 표준이 되었습니다.

SIP의 주요 특징은 다음과 같습니다:

1. **텍스트 기반 프로토콜**: SIP는 텍스트 기반 프로토콜로, 사람이 읽고 디버깅하기 쉽습니다. HTTP와 유사한 요청-응답 모델을 기반으로 하며, INVITE, ACK, BYE 및 CANCEL과 같은 메서드를 사용하여 통화 세션을 제어합니다.
2. **확장성과 유연성**: SIP는 소규모 배포부터 대규모 기업 및 캐리어급 환경까지 고도로 확장 가능합니다. 새로운 기능으로 쉽게 확장할 수 있어 다양한 사용 사례와 요구 사항에 적응할 수 있습니다.
3. **상호 운용성**: SIP의 널리 사용되고 표준화된 채택은 다른 장치, 응용 프로그램 및 서비스 제공자 간의 상호 운용성을 향상시켜 다양한 플랫폼 간의 원활한 통신을 촉진합니다.
4. **모듈식 설계**: SIP는 미디어 전송을 위한 **RTP (실시간 전송 프로토콜)** 및 멀티미디어 세션을 설명하기 위한 **SDP (세션 설명 프로토콜)**와 같은 다른 프로토콜과 함께 작동합니다. 이러한 모듈식 설계는 다양한 미디어 유형 및 코덱과의 더 큰 유연성과 호환성을 가능하게 합니다.
5. **프록시 및 리디렉션 서버**: SIP는 프록시 및 리디렉션 서버를 사용하여 통화 라우팅을 용이하게 하고 통화 전달, 통화 전달 및 음성 메일 서비스와 같은 고급 기능을 제공할 수 있습니다.
6. **존재 및 인스턴트 메시징**: SIP는 음성 및 비디오 통신에만 제한되지 않습니다. 존재 및 인스턴트 메시징도 지원하여 다양한 통합 통신 애플리케이션을 가능하게 합니다.

많은 장점에도 불구하고, SIP는 NAT 트래버스 및 방화벽 문제와 같은 구성 및 관리가 복잡할 수 있습니다. 그러나 다양한 산업에서의 지원과 다양성, 확장성을 통해 VoIP 및 멀티미디어 통신에 대한 인기있는 선택지가 되었습니다.

### SIP 메서드

**RFC 3261**에서 정의된 핵심 SIP 메서드는 다음과 같습니다:

1. **INVITE**: 새 세션(통화)을 **시작**하거나 기존 세션을 수정하기 위해 사용됩니다. INVITE 메서드는 세션 설명 (일반적으로 SDP를 사용)을 전송하여 수신자에게 제안된 세션의 세부 정보 (미디어 유형, 코덱 및 전송 프로토콜 등)를 알립니다.
2. **ACK**: INVITE 요청에 대한 최종 응답의 **수신 확인**을 보장하기 위해 전송되는 메서드입니다. ACK 메서드는 최종 응답의 끝간 확인을 제공하여 INVITE 트랜잭션의 신뢰성을 보장합니다.
3. **BYE**: 설정된 세션(통화)을 **종료**하기 위해 사용됩니다. BYE 메서드는 세션의 어느 쪽에서든 통신을 종료하고자 함을 나타냅니다.
4. **CANCEL**: 세션이 설정되기 전에 보류 중인 INVITE 요청을 **취소**하기 위해 전송됩니다. CANCEL 메서드는 발신자가 마음을 바꾸거나 수신자로부터 응답이 없는 경우 INVITE 트랜잭션을 중단할 수 있습니다.
5. **OPTIONS**: SIP 서버 또는 사용자 에이전트의 **기능을 조회**하기 위해 사용됩니다. OPTIONS 메서드는 세션을 실제로 설정하지 않고도 지원되는 메서드, 미디어 유형 또는 기타 확장에 대한 정보를 요청할 수 있습니다.
6. **REGISTER**: 사용자 에이전트가 현재 위치를 SIP 등록 서버에 **등록**하기 위해 사용됩니다. REGISTER 메서드는 사용자의 SIP URI와 현재 IP 주소 간의 최신 매핑을 유지하여 통화 라우팅 및 전달을 지원합니다.

{% hint style="warning" %}
누군가에게 전화를 거는 데는 **REGISTER를 사용할 필요가 없습니다**.\
그러나 **INVITE**를 수행하기 위해 호출자가 **인증**을 해야 할 수도 있으며, 그렇지 않으면 **`401 Unauthorized`** 응답을 받을 수 있습니다
## 예시

### SIP INVITE 예시

```html
<details>
<summary>Request</summary>

```html
INVITE sip:alice@example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
Max-Forwards: 70
To: <sip:alice@example.com>
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:bob@192.0.2.4>
Content-Type: application/sdp
Content-Length: 142

v=0
o=bob 2890844526 2890844526 IN IP4 192.0.2.4
s=-
c=IN IP4 192.0.2.4
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000
```

</details>
```

```html
<details>
<summary>Response</summary>

```html
SIP/2.0 100 Trying
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Content-Length: 0

```

</details>
```

```html
<details>
<summary>Response</summary>

```html
SIP/2.0 180 Ringing
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>;tag=123456789
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:alice@192.0.2.2>
Content-Length: 0

```

</details>
```

```html
<details>
<summary>Response</summary>

```html
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>;tag=123456789
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:alice@192.0.2.2>
Content-Type: application/sdp
Content-Length: 142

v=0
o=alice 2890844527 2890844527 IN IP4 192.0.2.2
s=-
c=IN IP4 192.0.2.2
t=0 0
m=audio 49172 RTP/AVP 0
a=rtpmap:0 PCMU/8000
```

</details>
```

```html
<details>
<summary>Response</summary>

```html
ACK sip:alice@example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
Max-Forwards: 70
To: <sip:alice@example.com>;tag=123456789
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 ACK
Contact: <sip:bob@192.0.2.4>
Content-Length: 0

```

</details>
```
```html
<details>
<summary>Request</summary>

```html
BYE sip:alice@example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
Max-Forwards: 70
To: <sip:alice@example.com>;tag=123456789
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314160 BYE
Contact: <sip:bob@192.0.2.4>
Content-Length: 0

```

</details>
```

```html
<details>
<summary>Response</summary>

```html
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>;tag=123456789
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314160 BYE
Content-Length: 0

```

</details>
```
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>각 매개변수 설명</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - 이 줄은 메서드 (INVITE), 요청 URI (sip:[jdoe@example.com](mailto:jdoe@example.com)), SIP 버전 (SIP/2.0)을 나타냅니다.
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Via 헤더는 전송 프로토콜 (UDP) 및 클라이언트의 주소 (pc33.example.com)를 지정합니다. "branch" 매개변수는 루프 감지 및 트랜잭션 매칭에 사용됩니다.
3. **Max-Forwards**: `Max-Forwards: 70` - 이 헤더 필드는 무한 루프를 피하기 위해 프록시에 의해 요청이 전달될 수 있는 최대 횟수를 제한합니다.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - To 헤더는 호출의 수신자를 지정합니다. 이는 표시 이름 (John Doe) 및 SIP URI (sip:[jdoe@example.com](mailto:jdoe@example.com))를 포함합니다.
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - From 헤더는 호출의 발신자를 지정합니다. 이는 표시 이름 (Jane Smith) 및 SIP URI (sip:[jsmith@example.org](mailto:jsmith@example.org))를 포함합니다. "tag" 매개변수는 대화 상자에서 발신자의 역할을 고유하게 식별하는 데 사용됩니다.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Call-ID 헤더는 두 사용자 에이전트 간의 호출 세션을 고유하게 식별합니다.
7. **CSeq**: `CSeq: 314159 INVITE` - CSeq 헤더에는 일련 번호와 요청에 사용된 메서드가 포함됩니다. 이는 응답을 요청과 일치시키고 순서가 잘못된 메시지를 감지하는 데 사용됩니다.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Contact 헤더는 발신자로의 직접 경로를 제공하며, 이는 후속 요청 및 응답에 사용될 수 있습니다.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - User-Agent 헤더는 발신자의 소프트웨어 또는 하드웨어에 대한 정보를 제공합니다. 이는 이름과 버전을 포함합니다.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Allow 헤더는 발신자가 지원하는 SIP 메서드를 나열합니다. 이를 통해 수신자는 통신 중에 사용할 수 있는 메서드를 이해할 수 있습니다.
11. **Content-Type**: `Content-Type: application/sdp` - Content-Type 헤더는 메시지 본문의 미디어 유형을 지정합니다. 이 경우 SDP (Session Description Protocol)입니다.
12. **Content-Length**: `Content-Length: 142` - Content-Length 헤더는 메시지 본문의 크기를 바이트 단위로 나타냅니다.
13. **Message Body**: 메시지 본문에는 제안된 세션에 대한 미디어 유형, 코덱 및 전송 프로토콜에 대한 정보를 포함하는 SDP 세션 설명이 포함됩니다.

* `v=0` - 프로토콜 버전 (SDP의 경우 0)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - 발신자 및 세션 식별자
* `s=-` - 세션 이름 (단일 하이픈은 세션 이름이 없음을 나타냄)
* `c=IN IP4 pc33.example.com` - 연결 정보 (네트워크 유형, 주소 유형 및 주소)
* `t=0 0` - 타이밍 정보 (시작 및 종료 시간, 0 0은 세션이 제한되지 않음을 의미)
* `m=audio 49170 RTP/AVP 0` - 미디어 설명 (미디어 유형, 포트 번호, 전송 프로토콜 및 형식 목록). 이 경우 RTP/AVP (실시간 전송 프로토콜 / 오디오 비디오 프로필) 및 형식 0 (PCMU/8000)을 사용하여 오디오 스트림을 지정합니다.
* `a=rtpmap:0 PCMU/8000` - 형식 (0)을 코덱 (PCMU) 및 클록 속도 (8000 Hz)에 매핑하는 속성입니다.

</details>

### SIP REGISTER 예제

REGISTER 메서드는 세션 시작 프로토콜 (SIP)에서 사용되며, VoIP 전화기 또는 소프트폰과 같은 사용자 에이전트 (UA)가 SIP 등록 서버에 **위치를 등록**할 수 있도록 합니다. 이 프로세스를 통해 서버는 등록된 사용자를 대상으로하는 수신 SIP 요청을 **어디로 라우팅할지 알 수 있게 됩니다**. 등록 서버는 일반적으로 SIP 프록시 서버 또는 전용 등록 서버의 일부입니다.

다음은 REGISTER 인증 프로세스에 관련된 SIP 메시지의 자세한 예입니다:

1. UA에서 등록 서버로의 초기 **REGISTER** 요청:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
이 초기 REGISTER 메시지는 UA(Alice)에서 등록 서버로 전송됩니다. 이 메시지에는 원하는 등록 기간(Expires), 사용자의 SIP URI(sip:[alice@example.com](mailto:alice@example.com)), 그리고 사용자의 연락처 주소(sip:alice@192.168.1.100:5060)와 같은 중요한 정보가 포함됩니다.

2. 등록 서버로부터의 **401 Unauthorized** 응답:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
레지스트라 서버는 "401 Unauthorized" 메시지로 응답하며, 이 메시지에는 "WWW-Authenticate" 헤더가 포함됩니다. 이 헤더에는 UA가 자체를 인증하기 위해 필요한 정보인 **인증 영역, nonce 및 알고리즘**이 포함되어 있습니다.

3. 인증 자격 증명을 포함한 REGISTER 요청:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA는 필요한 자격 증명인 사용자 이름, 영역, nonce 및 응답 값과 함께 "Authorization" 헤더를 포함하여 다른 REGISTER 요청을 보냅니다. 

다음은 "Authorization 응답"이 계산되는 방법입니다:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **등록 성공** 응답 (registrar 서버로부터):
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
레지스트라 서버가 제공된 자격 증명을 확인한 후, **"200 OK" 응답을 보내어 등록이 성공했음을 알립니다**. 이 응답에는 등록된 연락처 정보와 등록의 만료 시간이 포함됩니다. 이 시점에서 사용자 에이전트(Alice)는 SIP 레지스트라 서버에 성공적으로 등록되었으며, 에이리스에 대한 들어오는 SIP 요청은 적절한 연락처 주소로 라우팅될 수 있습니다.

### 통화 예제

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
언급되지 않았지만, 사용자 B는 호출을 받을 수 있기 위해 **Proxy 2에게 REGISTER 메시지를 보내야 합니다**.
{% endhint %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>
