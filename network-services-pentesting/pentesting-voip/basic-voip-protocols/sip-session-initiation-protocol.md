# SIP (Session Initiation Protocol)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

SIP (Session Initiation Protocol) est un **protocole de signalisation et de contr√¥le d'appel** largement utilis√© pour √©tablir, modifier et terminer des sessions multim√©dias, y compris la voix, la vid√©o et la messagerie instantan√©e, sur des r√©seaux IP. D√©velopp√© par le **Groupe de travail d'ing√©nierie de l'Internet (IETF)**, SIP est d√©fini dans le **RFC 3261** et est devenu la norme de facto pour la VoIP et les communications unifi√©es.

Certaines caract√©ristiques cl√©s de SIP incluent :

1. **Protocole bas√© sur le texte** : SIP est un protocole bas√© sur le texte, ce qui le rend lisible par l'homme et plus facile √† d√©boguer. Il est bas√© sur un mod√®le de requ√™te-r√©ponse, similaire √† HTTP, et utilise des m√©thodes telles que INVITE, ACK, BYE et CANCEL pour contr√¥ler les sessions d'appel.
2. **Scalabilit√© et flexibilit√©** : SIP est hautement scalable et peut √™tre utilis√© dans des d√©ploiements √† petite √©chelle ainsi que dans des environnements d'entreprise de grande envergure et de qualit√© op√©rateur. Il peut √™tre facilement √©tendu avec de nouvelles fonctionnalit√©s, le rendant adaptable √† divers cas d'utilisation et exigences.
3. **Interop√©rabilit√©** : L'adoption g√©n√©ralis√©e de SIP et sa normalisation garantissent une meilleure interop√©rabilit√© entre diff√©rents appareils, applications et fournisseurs de services, favorisant une communication transparente sur diff√©rentes plateformes.
4. **Conception modulaire** : SIP fonctionne avec d'autres protocoles comme **RTP (Real-time Transport Protocol)** pour la transmission multim√©dia et **SDP (Session Description Protocol)** pour d√©crire les sessions multim√©dias. Cette conception modulaire permet une plus grande flexibilit√© et compatibilit√© avec diff√©rents types de m√©dias et codecs.
5. **Serveurs proxy et de redirection** : SIP peut utiliser des serveurs proxy et de redirection pour faciliter le routage des appels et fournir des fonctionnalit√©s avanc√©es telles que le renvoi d'appels, le transfert d'appels et les services de messagerie vocale.
6. **Pr√©sence et messagerie instantan√©e** : SIP n'est pas limit√© √† la communication vocale et vid√©o. Il prend √©galement en charge la pr√©sence et la messagerie instantan√©e, permettant une large gamme d'applications de communication unifi√©e.

Malgr√© ses nombreux avantages, SIP peut √™tre complexe √† configurer et √† g√©rer, en particulier lorsqu'il s'agit de probl√®mes de travers√©e NAT et de pare-feu. Cependant, sa polyvalence, sa scalabilit√© et son soutien √©tendu dans l'industrie en font un choix populaire pour la VoIP et la communication multim√©dia.

### M√©thodes SIP

Les m√©thodes SIP de base d√©finies dans le **RFC 3261** incluent :

1. **INVITE** : Utilis√© pour **initier une nouvelle session (appel)** ou modifier une session existante. La m√©thode INVITE transporte la description de la session (g√©n√©ralement en utilisant SDP) pour informer le destinataire des d√©tails de la session propos√©e, tels que les types de m√©dias, les codecs et les protocoles de transport.
2. **ACK** : Envoy√© pour **confirmer la r√©ception** d'une r√©ponse finale √† une demande INVITE. La m√©thode ACK garantit la fiabilit√© des transactions INVITE en fournissant un accus√© de r√©ception de bout en bout.
3. **BYE** : Utilis√© pour **terminer une session √©tablie (appel)**. La m√©thode BYE est envoy√©e par l'une ou l'autre des parties de la session pour indiquer qu'elles souhaitent mettre fin √† la communication.
4. **CANCEL** : Envoy√© pour **annuler une demande INVITE en attente** avant l'√©tablissement de la session. La m√©thode CANCEL permet √† l'exp√©diteur d'annuler une transaction INVITE s'il change d'avis ou s'il n'y a pas de r√©ponse du destinataire.
5. **OPTIONS** : Utilis√© pour **interroger les capacit√©s d'un serveur SIP ou d'un agent utilisateur**. La m√©thode OPTIONS peut √™tre envoy√©e pour demander des informations sur les m√©thodes prises en charge, les types de m√©dias ou d'autres extensions sans √©tablir r√©ellement une session.
6. **REGISTER** : Utilis√© par un agent utilisateur pour **enregistrer son emplacement actuel aupr√®s d'un serveur d'enregistrement SIP**. La m√©thode REGISTER aide √† maintenir une correspondance √† jour entre l'URI SIP d'un utilisateur et son adresse IP actuelle, permettant le routage des appels et la livraison.

{% hint style="warning" %}
Notez que pour appeler quelqu'un, il n'est **pas n√©cessaire d'utiliser le REGISTER** pour quoi que ce soit.\
Cependant, il est possible qu'en vue d'effectuer un **INVITE**, l'appelant doit **s'authentifier** d'abord ou il recevra une r√©ponse **`401 Unauthorized`**.
{% endhint %}

En plus de ces m√©thodes de base, il existe **plusieurs m√©thodes d'extension SIP** d√©finies dans d'autres RFC, telles que :

1. **SUBSCRIBE** : D√©finie dans le RFC 6665, la m√©thode SUBSCRIBE est utilis√©e pour **demander des notifications** sur l'√©tat d'une ressource sp√©cifique, telle que la pr√©sence d'un utilisateur ou l'√©tat d'un appel.
2. **NOTIFY** : √âgalement d√©finie dans le RFC 6665, la m√©thode NOTIFY est envoy√©e par un serveur pour **informer un agent utilisateur abonn√©** des changements dans l'√©tat d'une ressource surveill√©e.
3. **REFER** : D√©finie dans le RFC 3515, la m√©thode REFER est utilis√©e pour **demander que le destinataire effectue un transfert ou fasse r√©f√©rence √† un tiers**. C'est g√©n√©ralement utilis√© pour les sc√©narios de **transfert d'appel**.
4. **MESSAGE** : D√©finie dans le RFC 3428, la m√©thode MESSAGE est utilis√©e pour **envoyer des messages instantan√©s entre des agents utilisateurs SIP**, permettant une communication textuelle dans le cadre de SIP.
5. **UPDATE** : D√©finie dans le RFC 3311, la m√©thode UPDATE permet de **modifier une session sans affecter l'√©tat du dialogue existant**. Cela est utile pour mettre √† jour les param√®tres de session, tels que les codecs ou les types de m√©dias, pendant un appel en cours.
6. **PUBLISH** : D√©finie dans le RFC 3903, la m√©thode PUBLISH est utilis√©e par un agent utilisateur pour **publier des informations sur l'√©tat d'un √©v√©nement √† un serveur**, le rendant disponible √† d'autres parties int√©ress√©es.

### Codes de r√©ponse SIP

* **1xx (R√©ponses provisoires)** : Ces r√©ponses indiquent que la demande a √©t√© re√ßue et que le serveur continue de la traiter.
* 100 Trying : La demande a √©t√© re√ßue, et le serveur y travaille.
* 180 Ringing : Le destinataire est alert√© et prendra l'appel.
* 183 Session Progress : Fournit des informations sur l'avancement de l'appel.
* **2xx (R√©ponses r√©ussies)** : Ces r√©ponses indiquent que la demande a √©t√© re√ßue, comprise et accept√©e avec succ√®s.
* 200 OK : La demande a r√©ussi, et le serveur l'a ex√©cut√©e.
* 202 Accepted : La demande a √©t√© accept√©e pour traitement, mais n'a pas encore √©t√© compl√©t√©e.
* **3xx (R√©ponses de redirection)** : Ces r√©ponses indiquent qu'une action suppl√©mentaire est n√©cessaire pour r√©pondre √† la demande, g√©n√©ralement en contactant une ressource alternative.
* 300 Multiple Choices : Il y a plusieurs options disponibles, et l'utilisateur ou le client doit en choisir une.
* 301 Moved Permanently : La ressource demand√©e a re√ßu un nouvel URI permanent.
* 302 Moved Temporarily : La ressource demand√©e est temporairement disponible √† un URI diff√©rent.
* 305 Use Proxy : La demande doit √™tre envoy√©e √† un proxy sp√©cifi√©.
* **4xx (R√©ponses d'erreur client)** : Ces r√©ponses indiquent que la demande contient une syntaxe incorrecte ou ne peut pas √™tre satisfaite par le serveur.
* 400 Bad Request : La demande √©tait mal form√©e ou invalide.
* 401 Unauthorized : La demande n√©cessite une authentification utilisateur.
* 403 Forbidden : Le serveur a compris la demande mais refuse de la satisfaire.
* 404 Not Found : La ressource demand√©e n'a pas √©t√© trouv√©e sur le serveur.
* 408 Request Timeout : Le serveur n'a pas re√ßu une demande compl√®te dans le d√©lai qu'il √©tait pr√™t √† attendre.
* 486 Busy Here : Le destinataire est actuellement occup√© et incapable de prendre l'appel.
* **5xx (R√©ponses d'erreur serveur)** : Ces r√©ponses indiquent que le serveur n'a pas pu satisfaire une demande valide.
* 500 Internal Server Error : Le serveur a rencontr√© une erreur lors du traitement de la demande.
* 501 Not Implemented : Le serveur ne prend pas en charge la fonctionnalit√© requise pour satisfaire la demande.
* 503 Service Unavailable : Le serveur est actuellement incapable de traiter la demande en raison de travaux de maintenance ou de surcharge.
* **6xx (R√©ponses d'√©chec global)** : Ces r√©ponses indiquent que la demande ne peut √™tre satisfaite par aucun serveur.
* 600 Busy Everywhere : Toutes les destinations possibles pour l'appel sont occup√©es.
* 603 Decline : Le destinataire ne souhaite pas participer √† l'appel.
* 604 Does Not Exist Anywhere : La ressource demand√©e n'est disponible nulle part dans le r√©seau.
## Exemples

### Exemple d'INVITE SIP
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Explication de chaque param√®tre</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Cette ligne indique la m√©thode (INVITE), l'URI de la requ√™te (sip:[jdoe@example.com](mailto:jdoe@example.com)), et la version SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - L'en-t√™te Via sp√©cifie le protocole de transport (UDP) et l'adresse du client (pc33.example.com). Le param√®tre "branch" est utilis√© pour la d√©tection de boucle et la correspondance de transaction.
3. **Max-Forwards**: `Max-Forwards: 70` - Ce champ d'en-t√™te limite le nombre de fois que la requ√™te peut √™tre transmise par des proxies pour √©viter les boucles infinies.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - L'en-t√™te To sp√©cifie le destinataire de l'appel, y compris son nom d'affichage (John Doe) et l'URI SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - L'en-t√™te From sp√©cifie l'exp√©diteur de l'appel, y compris son nom d'affichage (Jane Smith) et l'URI SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). Le param√®tre "tag" est utilis√© pour identifier de mani√®re unique le r√¥le de l'exp√©diteur dans le dialogue.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - L'en-t√™te Call-ID identifie de mani√®re unique une session d'appel entre deux agents utilisateurs.
7. **CSeq**: `CSeq: 314159 INVITE` - L'en-t√™te CSeq contient un num√©ro de s√©quence et la m√©thode utilis√©e dans la requ√™te. Il est utilis√© pour faire correspondre les r√©ponses aux requ√™tes et d√©tecter les messages d√©sordonn√©s.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - L'en-t√™te Contact fournit une route directe vers l'exp√©diteur, qui peut √™tre utilis√©e pour les requ√™tes et r√©ponses ult√©rieures.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - L'en-t√™te User-Agent fournit des informations sur le logiciel ou le mat√©riel de l'exp√©diteur, y compris son nom et sa version.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - L'en-t√™te Allow r√©pertorie les m√©thodes SIP prises en charge par l'exp√©diteur. Cela aide le destinataire √† comprendre quelles m√©thodes peuvent √™tre utilis√©es pendant la communication.
11. **Content-Type**: `Content-Type: application/sdp` - L'en-t√™te Content-Type sp√©cifie le type de m√©dia du corps du message, dans ce cas, SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - L'en-t√™te Content-Length indique la taille du corps du message en octets.
13. **Corps du message**: Le corps du message contient la description de session SDP, qui inclut des informations sur les types de m√©dias, les codecs et les protocoles de transport pour la session propos√©e.

* `v=0` - Version du protocole (0 pour SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Originateur et identifiant de session
* `s=-` - Nom de session (un simple tiret indique qu'il n'y a pas de nom de session)
* `c=IN IP4 pc33.example.com` - Informations de connexion (type de r√©seau, type d'adresse et adresse)
* `t=0 0` - Informations de synchronisation (d√©but et fin des temps, 0 0 signifie que la session n'est pas born√©e)
* `m=audio 49170 RTP/AVP 0` - Description des m√©dias (type de m√©dia, num√©ro de port, protocole de transport et liste de formats). Dans ce cas, il sp√©cifie un flux audio utilisant RTP/AVP (Real-time Transport Protocol / Audio Video Profile) et le format 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Attribut faisant correspondre le format (0) au codec (PCMU) et √† sa fr√©quence d'horloge (8000 Hz).

</details>

### Exemple d'enregistrement SIP

La m√©thode REGISTER est utilis√©e dans le protocole d'initiation de session (SIP) pour permettre √† un agent utilisateur (UA), tel qu'un t√©l√©phone VoIP ou un softphone, de **enregistrer son emplacement aupr√®s d'un serveur registraire SIP**. Ce processus permet au serveur de savoir **o√π router les demandes SIP entrantes destin√©es √† l'utilisateur enregistr√©**. Le serveur registraire fait g√©n√©ralement partie d'un serveur proxy SIP ou d'un serveur d'enregistrement d√©di√©.

Voici un exemple d√©taill√© des messages SIP impliqu√©s dans un processus d'authentification REGISTER :

1. Requ√™te **REGISTER** initiale de l'UA au serveur registraire :
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Le message REGISTER initial est envoy√© par l'UA (Alice) au serveur de registre. Il inclut des informations importantes telles que la dur√©e d'enregistrement souhait√©e (Expires), l'URI SIP de l'utilisateur (sip:[alice@example.com](mailto:alice@example.com)), et l'adresse de contact de l'utilisateur (sip:alice@192.168.1.100:5060).

2. R√©ponse **401 Unauthorized** du serveur de registre :
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Le serveur de registre r√©pond avec un message "401 Unauthorized", qui inclut un en-t√™te "WWW-Authenticate". Cet en-t√™te contient les informations n√©cessaires pour que l'UA s'authentifie, telles que le **domaine d'authentification, le nonce et l'algorithme**.

3. Requ√™te REGISTER **avec des identifiants d'authentification**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
Le UA envoie une autre demande REGISTER, cette fois en incluant l'en-t√™te **"Authorization" avec les informations d'identification n√©cessaires, telles que le nom d'utilisateur, le royaume, le nonce et une valeur de r√©ponse** calcul√©e en utilisant les informations fournies et le mot de passe de l'utilisateur.

Voici comment le **r√©ponse d'autorisation** est calcul√©e :
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **R√©ponse d'inscription r√©ussie** du serveur de registre :
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Apr√®s que le serveur d'enregistrement a v√©rifi√© les informations d'identification fournies, **il envoie une r√©ponse "200 OK" pour indiquer que l'enregistrement a r√©ussi**. La r√©ponse inclut les informations de contact enregistr√©es et l'heure d'expiration de l'enregistrement. √Ä ce stade, l'agent utilisateur (Alice) est enregistr√© avec succ√®s aupr√®s du serveur d'enregistrement SIP, et les requ√™tes SIP entrantes pour Alice peuvent √™tre rout√©es vers l'adresse de contact appropri√©e.

### Exemple d'appel

<figure><img src="../../../.gitbook/assets/image (1098).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Il n'est pas mentionn√©, mais l'Utilisateur B doit avoir envoy√© un **message REGISTER √† Proxy 2** avant de pouvoir recevoir des appels.
{% endhint %}
