## SIP (Protocolo de Inicio de Sesi√≥n)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

SIP (Protocolo de Inicio de Sesi√≥n) es un **protocolo de se√±alizaci√≥n y control de llamadas** ampliamente utilizado para establecer, modificar y terminar sesiones multimedia, incluyendo voz, video y mensajer√≠a instant√°nea, sobre redes IP. Desarrollado por el **Grupo de Trabajo de Ingenier√≠a de Internet (IETF)**, SIP est√° definido en **RFC 3261** y se ha convertido en el est√°ndar de facto para VoIP y comunicaciones unificadas.

Algunas caracter√≠sticas clave de SIP incluyen:

1. **Protocolo basado en texto**: SIP es un protocolo basado en texto, lo que lo hace legible para los humanos y m√°s f√°cil de depurar. Est√° basado en un modelo de solicitud-respuesta, similar a HTTP, y utiliza m√©todos como INVITE, ACK, BYE y CANCEL para controlar las sesiones de llamadas.
2. **Escalabilidad y flexibilidad**: SIP es altamente escalable y se puede utilizar en implementaciones de peque√±a escala, as√≠ como en entornos empresariales y de operadores de telecomunicaciones de gran tama√±o. Se puede extender f√°cilmente con nuevas caracter√≠sticas, lo que lo hace adaptable a varios casos de uso y requisitos.
3. **Interoperabilidad**: La amplia adopci√≥n y estandarizaci√≥n de SIP aseguran una mejor interoperabilidad entre diferentes dispositivos, aplicaciones y proveedores de servicios, promoviendo una comunicaci√≥n sin problemas en varias plataformas.
4. **Dise√±o modular**: SIP funciona con otros protocolos como **RTP (Protocolo de Transporte en Tiempo Real)** para la transmisi√≥n de medios y **SDP (Protocolo de Descripci√≥n de Sesi√≥n)** para describir sesiones multimedia. Este dise√±o modular permite una mayor flexibilidad y compatibilidad con diferentes tipos de medios y c√≥decs.
5. **Servidores proxy y de redireccionamiento**: SIP puede utilizar servidores proxy y de redireccionamiento para facilitar el enrutamiento de llamadas y proporcionar funciones avanzadas como el reenv√≠o de llamadas, la transferencia de llamadas y los servicios de correo de voz.
6. **Presencia y mensajer√≠a instant√°nea**: SIP no se limita a la comunicaci√≥n de voz y video. Tambi√©n admite presencia y mensajer√≠a instant√°nea, lo que permite una amplia gama de aplicaciones de comunicaci√≥n unificada.

A pesar de sus muchas ventajas, SIP puede ser complejo de configurar y administrar, especialmente al tratar con problemas de NAT y firewall. Sin embargo, su versatilidad, escalabilidad y amplio soporte en la industria lo convierten en una opci√≥n popular para la comunicaci√≥n multimedia y VoIP.

### M√©todos SIP

Los m√©todos SIP principales definidos en **RFC 3261** incluyen:

1. **INVITE**: Se utiliza para **iniciar una nueva sesi√≥n (llamada)** o modificar una existente. El m√©todo INVITE lleva la descripci√≥n de la sesi√≥n (normalmente utilizando SDP) para informar al destinatario sobre los detalles de la sesi√≥n propuesta, como los tipos de medios, c√≥decs y protocolos de transporte.
2. **ACK**: Se env√≠a para **confirmar la recepci√≥n** de una respuesta final a una solicitud INVITE. El m√©todo ACK garantiza la confiabilidad de las transacciones INVITE proporcionando una confirmaci√≥n de extremo a extremo.
3. **BYE**: Se utiliza para **terminar una sesi√≥n establecida (llamada)**. El m√©todo BYE es enviado por cualquiera de las partes en la sesi√≥n para indicar que desean finalizar la comunicaci√≥n.
4. **CANCEL**: Se env√≠a para **cancelar una solicitud INVITE pendiente** antes de que se establezca la sesi√≥n. El m√©todo CANCEL permite al remitente abortar una transacci√≥n INVITE si cambia de opini√≥n o si no hay respuesta del destinatario.
5. **OPTIONS**: Se utiliza para **consultar las capacidades de un servidor o agente de usuario SIP**. El m√©todo OPTIONS se puede enviar para solicitar informaci√≥n sobre los m√©todos admitidos, los tipos de medios u otras extensiones sin establecer realmente una sesi√≥n.
6. **REGISTER**: Utilizado por un agente de usuario para **registrar su ubicaci√≥n actual con un servidor de registro SIP**. El m√©todo REGISTER ayuda a mantener una asignaci√≥n actualizada entre el URI SIP de un usuario y su direcci√≥n IP actual, lo que permite el enrutamiento y la entrega de llamadas.

{% hint style="warning" %}
Tenga en cuenta que para llamar a alguien no es **necesario usar el REGISTER** para nada.\
Sin embargo, es posible que para realizar un **INVITE** el llamante necesite **autenticarse** primero o recibir√° una respuesta **`401 Unauthorized`**.
{% endhint %}

Adem√°s de estos m√©todos principales, hay **varios m√©todos de extensi√≥n SIP** definidos en otros RFC, como:

1. **SUBSCRIBE**: Definido en RFC 6665, el m√©todo SUBSCRIBE se utiliza para **solicitar notificaciones** sobre el estado de un recurso espec√≠fico, como la presencia de un usuario o el estado de una llamada.
2. **NOTIFY**: Tambi√©n definido en RFC 6665, el m√©todo NOTIFY es enviado por un servidor para **informar a un agente de usuario suscrito** sobre cambios en el estado de un recurso monitoreado.
3. **REFER**: Definido en RFC 3515, el m√©todo REFER se utiliza para **solicitar que el destinatario realice una transferencia o se refiera a un tercero**. Esto se utiliza t√≠picamente para
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Explicaci√≥n de cada par√°metro</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Esta l√≠nea indica el m√©todo (INVITE), el URI de solicitud (sip:[jdoe@example.com](mailto:jdoe@example.com)), y la versi√≥n de SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - La cabecera Via especifica el protocolo de transporte (UDP) y la direcci√≥n del cliente (pc33.example.com). El par√°metro "branch" se utiliza para la detecci√≥n de bucles y la coincidencia de transacciones.
3. **Max-Forwards**: `Max-Forwards: 70` - Este campo de cabecera limita el n√∫mero de veces que la solicitud puede ser reenviada por los proxies para evitar bucles infinitos.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - La cabecera To especifica el destinatario de la llamada, incluyendo su nombre de visualizaci√≥n (John Doe) y URI de SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - La cabecera From especifica el remitente de la llamada, incluyendo su nombre de visualizaci√≥n (Jane Smith) y URI de SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). El par√°metro "tag" se utiliza para identificar de manera √∫nica el papel del remitente en el di√°logo.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - La cabecera Call-ID identifica de manera √∫nica una sesi√≥n de llamada entre dos agentes de usuario.
7. **CSeq**: `CSeq: 314159 INVITE` - La cabecera CSeq contiene un n√∫mero de secuencia y el m√©todo utilizado en la solicitud. Se utiliza para hacer coincidir las respuestas con las solicitudes y detectar mensajes fuera de orden.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - La cabecera Contact proporciona una ruta directa al remitente, que se puede utilizar para solicitudes y respuestas posteriores.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - La cabecera User-Agent proporciona informaci√≥n sobre el software o hardware del remitente, incluyendo su nombre y versi√≥n.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - La cabecera Allow enumera los m√©todos SIP admitidos por el remitente. Esto ayuda al destinatario a entender qu√© m√©todos se pueden utilizar durante la comunicaci√≥n.
11. **Content-Type**: `Content-Type: application/sdp` - La cabecera Content-Type especifica el tipo de medio del cuerpo del mensaje, en este caso, SDP (Protocolo de Descripci√≥n de Sesi√≥n).
12. **Content-Length**: `Content-Length: 142` - La cabecera Content-Length indica el tama√±o del cuerpo del mensaje en bytes.
13. **Cuerpo del mensaje**: El cuerpo del mensaje contiene la descripci√≥n de sesi√≥n SDP, que incluye informaci√≥n sobre los tipos de medios, c√≥decs y protocolos de transporte para la sesi√≥n propuesta.

* `v=0` - Versi√≥n del protocolo (0 para SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Identificador de origen y sesi√≥n
* `s=-` - Nombre de la sesi√≥n (un gui√≥n indica que no hay nombre de sesi√≥n)
* `c=IN IP4 pc33.example.com` - Informaci√≥n de conexi√≥n (tipo de red, tipo de direcci√≥n y direcci√≥n)
* `t=0 0` - Informaci√≥n de temporizaci√≥n (tiempos de inicio y finalizaci√≥n, 0 0 significa que la sesi√≥n no est√° limitada)
* `m=audio 49170 RTP/AVP 0` - Descripci√≥n de medios (tipo de medio, n√∫mero de puerto, protocolo de transporte y lista de formatos). En este caso, especifica un flujo de audio utilizando RTP/AVP (Protocolo de Transporte en Tiempo Real / Perfil de Audio y Video) y formato 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Atributo que asigna el formato (0) al c√≥dec (PCMU) y su frecuencia de reloj (8000 Hz).

</details>

### Ejemplo de SIP REGISTER

El m√©todo REGISTER se utiliza en el Protocolo de Inicio de Sesi√≥n (SIP) para permitir que un agente de usuario (UA), como un tel√©fono VoIP o un softphone, **registre su ubicaci√≥n con un servidor de registro SIP**. Este proceso permite que el servidor sepa **d√≥nde dirigir las solicitudes SIP entrantes destinadas al usuario registrado**. El servidor de registro suele formar parte de un servidor proxy SIP o de un servidor de registro dedicado.

Aqu√≠ hay un ejemplo detallado de los mensajes SIP involucrados en un proceso de autenticaci√≥n REGISTER:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Este mensaje inicial REGISTER es enviado por el UA (Alice) al servidor registrador. Incluye informaci√≥n importante como la duraci√≥n deseada de registro (Expires), el URI SIP del usuario (sip:[alice@example.com](mailto:alice@example.com)), y la direcci√≥n de contacto del usuario (sip:alice@192.168.1.100:5060).

2. Respuesta **401 Unauthorized** del servidor registrador:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
El servidor de registro responde con un mensaje "401 no autorizado", que incluye una cabecera "WWW-Authenticate". Esta cabecera contiene informaci√≥n necesaria para que el UA se autentique, como el **reino de autenticaci√≥n, nonce y algoritmo**.

3. Solicitud de REGISTRO **con credenciales de autenticaci√≥n**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
El UA env√≠a otra solicitud REGISTER, esta vez incluyendo la cabecera **"Authorization" con las credenciales necesarias, como el nombre de usuario, reino, nonce y un valor de respuesta** calculado utilizando la informaci√≥n proporcionada y la contrase√±a del usuario.

As√≠ es como se calcula la **respuesta de autorizaci√≥n**:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
    # 1. Calculate HA1 (concatenation of username, realm, and password)
    ha1_input = f"{username}:{realm}:{password}"
    ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

    # 2. Calculate HA2 (concatenation of method and uri)
    ha2_input = f"{method}:{uri}"
    ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

    # 3. Calculate the final response value (concatenation of h1, stuff and h2)
    response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
    response = hashlib.md5(response_input.encode()).hexdigest()

    return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. Respuesta de **registro exitoso** del servidor de registro:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Despu√©s de que el servidor registrador verifica las credenciales proporcionadas, **env√≠a una respuesta "200 OK" para indicar que el registro fue exitoso**. La respuesta incluye la informaci√≥n de contacto registrada y el tiempo de vencimiento para el registro. En este punto, el agente de usuario (Alice) est√° registrado con √©xito en el servidor registrador SIP, y las solicitudes SIP entrantes para Alice pueden ser enrutadas a la direcci√≥n de contacto correspondiente.

### Ejemplo de llamada

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
No se menciona, pero el Usuario B necesita haber enviado un mensaje **REGISTER al Proxy 2** antes de poder recibir llamadas.
{% endhint %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
