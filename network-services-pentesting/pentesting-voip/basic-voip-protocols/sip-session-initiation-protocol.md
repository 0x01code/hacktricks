# SIP (Itifaki ya Kuanzisha Kikao)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Taarifa Msingi

SIP (Itifaki ya Kuanzisha Kikao) ni **itifaki ya ishara na udhibiti wa simu** inayotumiwa sana kwa kuanzisha, kubadilisha, na kumaliza vikao vya multimedia, ikiwa ni pamoja na sauti, video, na ujumbe wa papo hapo, juu ya mtandao wa IP. Iliyoundwa na **Internet Engineering Task Force (IETF)**, SIP imefafanuliwa katika **RFC 3261** na imekuwa kiwango cha kawaida kwa VoIP na mawasiliano yanayounganishwa.

Baadhi ya sifa muhimu za SIP ni pamoja na:

1. **Itifaki Inayotegemea Nakala**: SIP ni itifaki inayotegemea nakala, ambayo inafanya iwe rahisi kusomeka na kurekebisha makosa. Inategemea mfano wa ombi-jibu, kama HTTP, na hutumia njia kama INVITE, ACK, BYE, na CANCEL kwa udhibiti wa vikao vya simu.
2. **Uwezo wa Kuongezeka na Upanuzi**: SIP inaweza kuongezeka kwa kiasi kikubwa na inaweza kutumika katika mazingira madogo na pia katika mazingira makubwa ya kampuni na watoa huduma. Inaweza kuongezewa kwa urahisi na vipengele vipya, ikiruhusu matumizi mbalimbali na mahitaji tofauti.
3. **Ushirikiano**: Uenezi na kiwango cha SIP huhakikisha ushirikiano bora kati ya vifaa tofauti, programu, na watoa huduma, kukuza mawasiliano laini kwenye majukwaa mbalimbali.
4. **Ubunifu wa Moduli**: SIP inafanya kazi na itifaki zingine kama **RTP (Itifaki ya Usafirishaji wa Wakati Halisi)** kwa usafirishaji wa vyombo vya habari na **SDP (Itifaki ya Maelezo ya Kikao)** kwa kuelezea vikao vya multimedia. Ubunifu huu wa moduli unaruhusu uwezo mkubwa na utangamano na aina tofauti za vyombo vya habari na codecs.
5. **Seva za Proxy na Uelekezaji**: SIP inaweza kutumia seva za proxy na uelekezaji kwa kurahisisha mwelekeo wa simu na kutoa huduma za juu kama kuhamisha simu, kuhamisha simu, na huduma za ujumbe wa sauti.
6. **Uwepo na Ujumbe wa Papo hapo**: SIP haikuwekwa kikomo kwa mawasiliano ya sauti na video. Pia inasaidia uwepo na ujumbe wa papo hapo, kuruhusu matumizi mbalimbali ya mawasiliano yanayounganishwa.

Licha ya faida zake nyingi, SIP inaweza kuwa ngumu kuweka na kusimamia, haswa wakati wa kushughulika na maswala ya NAT na firewall. Walakini, uwezo wake, uwezo wa kuongezeka, na msaada mkubwa katika tasnia hufanya iwe chaguo maarufu kwa VoIP na mawasiliano ya multimedia.

### Njia za SIP

Njia kuu za SIP zilizofafanuliwa katika **RFC 3261** ni pamoja na:

1. **INVITE**: Hutumiwa kuanzisha **kikao kipya (simu)** au kubadilisha kikao kilichopo. Njia ya INVITE inabeba maelezo ya kikao (kwa kawaida kwa kutumia SDP) ili kumjulisha mpokeaji kuhusu maelezo ya kikao kilichopendekezwa, kama vile aina za vyombo vya habari, codecs, na itifaki za usafirishaji.
2. **ACK**: Hutumwa kuthibitisha **mapokezi** ya jibu la mwisho kwa ombi la INVITE. Njia ya ACK inahakikisha uaminifu wa shughuli za INVITE kwa kutoa uthibitisho mwisho hadi mwisho.
3. **BYE**: Hutumiwa kumaliza **kikao kilichowekwa (simu)**. Njia ya BYE hutumwa na moja ya pande katika kikao kuonyesha kuwa wanataka kumaliza mawasiliano.
4. **CANCEL**: Hutumwa kufuta ombi la INVITE linalosubiri kabla ya kikao kuanzishwa. Njia ya CANCEL inaruhusu mtumaji kusitisha shughuli ya INVITE ikiwa wanabadilisha mawazo au ikiwa hakuna jibu kutoka kwa mpokeaji.
5. **OPTIONS**: Hutumiwa kuuliza uwezo wa seva ya SIP au wakala wa mtumiaji. Njia ya OPTIONS inaweza kutumwa kuomba habari kuhusu njia zinazoungwa mkono, aina za vyombo vya habari, au nyongeza zingine bila kuanzisha kikao halisi.
6. **REGISTER**: Hutumiwa na wakala wa mtumiaji kujiandikisha na eneo lake la sasa kwa seva ya usajili ya SIP. Njia ya REGISTER inasaidia kudumisha ramani iliyosasishwa kati ya URI ya SIP ya mtumiaji na anwani yao ya IP ya sasa, kuruhusu mwelekeo na utoaji wa simu.

{% hint style="warning" %}
Tafadhali kumbuka kuwa ili kumpigia mtu simu **siyo lazima kutumia REGISTER** kwa chochote.\
Hata hivyo, inawezekana kuwa ili kufanya **INVITE** mpigaji anahitaji **uthibitisho** kwanza au atapokea jibu la **`401 Unauthorized`**.
{% endhint %}

Mbali na njia hizi kuu, kuna **njia za nyongeza za SIP** zilizofafanuliwa katika RFC zingine, kama vile:

1. **SUBSCRIBE**: Iliyof
## Mifano

### Mfano wa SIP INVITE

```html
<details>
<summary>Request</summary>

```html
INVITE sip:alice@example.com SIP/2.0
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
Max-Forwards: 70
To: <sip:alice@example.com>
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:bob@example.com>
Content-Type: application/sdp
Content-Length: 142

v=0
o=bob 2890844526 2890844526 IN IP4 192.0.2.1
s=-
c=IN IP4 192.0.2.1
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000
```

</details>

<details>
<summary>Response</summary>

```html
SIP/2.0 100 Trying
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE

SIP/2.0 180 Ringing
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>;tag=1234567890
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE

SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.0.2.1:5060;branch=z9hG4bKkdjuw
To: <sip:alice@example.com>;tag=1234567890
From: <sip:bob@example.com>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:alice@example.com>
Content-Type: application/sdp
Content-Length: 142

v=0
o=alice 2890844527 2890844527 IN IP4 192.0.2.2
s=-
c=IN IP4 192.0.2.2
t=0 0
m=audio 49172 RTP/AVP 0
a=rtpmap:0 PCMU/8000
```

</details>
```
```
INVITE sip:jdoe@example.com SIP/2.0
Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds
Max-Forwards: 70
To: John Doe <sip:jdoe@example.com>
From: Jane Smith <sip:jsmith@example.org>;tag=1928301774
Call-ID: a84b4c76e66710
CSeq: 314159 INVITE
Contact: <sip:jsmith@pc33.example.com>
User-Agent: ExampleSIPClient/1.0
Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO
Content-Type: application/sdp
Content-Length: 142

v=0
o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com
s=-
c=IN IP4 pc33.example.com
t=0 0
m=audio 49170 RTP/AVP 0
a=rtpmap:0 PCMU/8000te
```
<details>

<summary>Kila Param Inaelezwa</summary>

1. **Request-Line**: `INVITE sip:jdoe@example.com SIP/2.0` - Mstari huu unaonyesha njia (INVITE), URI ya ombi (sip:[jdoe@example.com](mailto:jdoe@example.com)), na toleo la SIP (SIP/2.0).
2. **Via**: `Via: SIP/2.0/UDP pc33.example.com;branch=z9hG4bK776asdhds` - Kichwa cha Via kinabainisha itifaki ya usafirishaji (UDP) na anwani ya mteja (pc33.example.com). Parameta ya "branch" hutumiwa kwa kugundua mzunguko na kulinganisha shughuli.
3. **Max-Forwards**: `Max-Forwards: 70` - Kichwa hiki kinazuia idadi ya mara ombi linaweza kupelekwa na wakala wa mwendeshaji ili kuepuka mizunguko isiyokuwa na mwisho.
4. **To**: `To: John Doe <sip:jdoe@example.com>` - Kichwa cha To kinabainisha mpokeaji wa simu, pamoja na jina la kuonyesha (John Doe) na URI ya SIP (sip:[jdoe@example.com](mailto:jdoe@example.com)).
5. **From**: `From: Jane Smith <sip:jsmith@example.org>;tag=1928301774` - Kichwa cha From kinabainisha mtumaji wa simu, pamoja na jina lake la kuonyesha (Jane Smith) na URI ya SIP (sip:[jsmith@example.org](mailto:jsmith@example.org)). Parameta ya "tag" hutumiwa kutambua kwa kipekee jukumu la mtumaji katika mazungumzo.
6. **Call-ID**: `Call-ID: a84b4c76e66710` - Kichwa cha Call-ID kinatambua kipekee kikao cha simu kati ya wakala wawili wa watumiaji.
7. **CSeq**: `CSeq: 314159 INVITE` - Kichwa cha CSeq kina nambari ya mfululizo na njia iliyotumiwa katika ombi. Hutumiwa kulinganisha majibu na maombi na kugundua ujumbe usiofuatana.
8. **Contact**: `Contact: <sip:jsmith@pc33.example.com>` - Kichwa cha Contact kinatoa njia moja kwa moja kwa mtumaji, ambayo inaweza kutumiwa kwa maombi na majibu yanayofuata.
9. **User-Agent**: `User-Agent: ExampleSIPClient/1.0` - Kichwa cha User-Agent kinatoa habari juu ya programu au vifaa vya mtumaji, pamoja na jina lake na toleo.
10. **Allow**: `Allow: INVITE, ACK, CANCEL, OPTIONS, BYE, REFER, NOTIFY, MESSAGE, SUBSCRIBE, INFO` - Kichwa cha Allow kinataja njia za SIP zinazoungwa mkono na mtumaji. Hii husaidia mpokeaji kuelewa njia zipi zinaweza kutumiwa wakati wa mawasiliano.
11. **Content-Type**: `Content-Type: application/sdp` - Kichwa cha Content-Type kinabainisha aina ya media ya mwili wa ujumbe, katika kesi hii, SDP (Session Description Protocol).
12. **Content-Length**: `Content-Length: 142` - Kichwa cha Content-Length kinabainisha ukubwa wa mwili wa ujumbe kwa herufi.
13. **Message Body**: Mwili wa ujumbe una habari ya kikao cha SDP, ambayo inajumuisha habari juu ya aina za media, codecs, na itifaki za usafirishaji kwa kikao kilichopendekezwa.

* `v=0` - Toleo la itifaki (0 kwa SDP)
* `o=jsmith 2890844526 2890842807 IN IP4 pc33.example.com` - Mwanzilishi na kitambulisho cha kikao
* `s=-` - Jina la kikao (hyphen moja inaonyesha hakuna jina la kikao)
* `c=IN IP4 pc33.example.com` - Taarifa ya uunganisho (aina ya mtandao, aina ya anwani, na anwani)
* `t=0 0` - Taarifa ya wakati (wakati wa kuanza na kuacha, 0 0 inamaanisha kikao hakina mipaka)
* `m=audio 49170 RTP/AVP 0` - Maelezo ya media (aina ya media, nambari ya bandari, itifaki ya usafirishaji, na orodha ya muundo). Katika kesi hii, inabainisha mkondo wa sauti ukitumia RTP/AVP (Real-time Transport Protocol / Audio Video Profile) na muundo 0 (PCMU/8000).
* `a=rtpmap:0 PCMU/8000` - Sifa inayounganisha muundo (0) na codec (PCMU) na kiwango chake cha saa (8000 Hz).

</details>

### Mfano wa Usajili wa SIP

Njia ya REGISTER hutumiwa katika Itifaki ya Kuanzisha Kikao (SIP) kuruhusu wakala wa mtumiaji (UA), kama simu ya VoIP au simu laini, kujiandikisha na **kusajili eneo lake na seva ya usajili ya SIP**. Mchakato huu huwezesha seva kujua **wapi kupeleka maombi ya SIP yanayoelekezwa kwa mtumiaji aliyesajiliwa**. Seva ya usajili kawaida ni sehemu ya seva ya wakala wa SIP au seva maalum ya usajili.

Hapa kuna mfano wa kina wa ujumbe wa SIP unaohusika katika mchakato wa uthibitishaji wa USAJILI:

1. Ombi la awali la **REGISTER** kutoka UA kwenda kwa seva ya usajili:
```yaml
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Ujumbe wa kwanza wa REGISTER huu hutumwa na UA (Alice) kwa seva ya usajili. Inajumuisha habari muhimu kama muda unaotaka kusajiliwa (Expires), SIP URI ya mtumiaji (sip:[alice@example.com](mailto:alice@example.com)), na anwani ya mawasiliano ya mtumiaji (sip:alice@192.168.1.100:5060).

2. Jibu la **401 Unauthorized** kutoka kwa seva ya usajili:
```css
cssCopy codeSIP/2.0 401 Unauthorized
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 1 REGISTER
WWW-Authenticate: Digest realm="example.com", nonce="abcdefghijk", algorithm=MD5, qop="auth"
Content-Length: 0
```
Seva ya msajili inajibu na ujumbe wa "401 Unauthorized", ambao unajumuisha kichwa cha "WWW-Authenticate". Kichwa hiki kinajumuisha habari inayohitajika kwa UA kujithibitisha yenyewe, kama vile **enzi ya uthibitishaji, nonce, na algorithm**.

3. Ombi la KUJIANDIKISHA **na sifa za uthibitishaji**:
```vbnet
REGISTER sip:example.com SIP/2.0
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
Max-Forwards: 70
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Authorization: Digest username="alice", realm="example.com", nonce="abcdefghijk", uri="sip:example.com", response="65a8e2285879283831b664bd8b7f14d4", algorithm=MD5, cnonce="lmnopqrst", qop=auth, nc=00000001
Content-Length: 0
```
UA inatuma ombi la REGISTER lingine, wakati huu likiwa na kichwa cha **"Authorization" chenye sifa muhimu kama vile jina la mtumiaji, eneo, nonce, na thamani ya jibu** iliyohesabiwa kwa kutumia habari iliyotolewa na nenosiri la mtumiaji.

Hii ndivyo **jibu la Uthibitishaji** linavyohesabiwa:
```python
import hashlib

def calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop):
# 1. Calculate HA1 (concatenation of username, realm, and password)
ha1_input = f"{username}:{realm}:{password}"
ha1 = hashlib.md5(ha1_input.encode()).hexdigest()

# 2. Calculate HA2 (concatenation of method and uri)
ha2_input = f"{method}:{uri}"
ha2 = hashlib.md5(ha2_input.encode()).hexdigest()

# 3. Calculate the final response value (concatenation of h1, stuff and h2)
response_input = f"{ha1}:{nonce}:{nc}:{cnonce}:{qop}:{ha2}"
response = hashlib.md5(response_input.encode()).hexdigest()

return response

# Example usage
username = "alice"
password = "mysecretpassword"
realm = "example.com"
method = "REGISTER"
uri = "sip:example.com"
nonce = "abcdefghijk"
nc = "00000001"
cnonce = "lmnopqrst"
qop = "auth"

response = calculate_sip_md5_response(username, password, realm, method, uri, nonce, nc, cnonce, qop)
print(f"MD5 response value: {response}")
```
4. **Jibu la usajili** lililofanikiwa kutoka kwenye seva ya msajili:
```yaml
SIP/2.0 200 OK
Via: SIP/2.0/UDP 192.168.1.100:5060;branch=z9hG4bK776asdhds
From: Alice <sip:alice@example.com>;tag=565656
To: Alice <sip:alice@example.com>;tag=7878744
Call-ID: 1234567890@192.168.1.100
CSeq: 2 REGISTER
Contact: <sip:alice@192.168.1.100:5060>;expires=3600
Expires: 3600
Content-Length: 0
```
Baada ya seva ya msajili kuthibitisha vitambulisho vilivyotolewa, **inatuma jibu la "200 OK" kuonyesha kuwa usajili ulifanikiwa**. Jibu linajumuisha habari ya mawasiliano iliyosajiliwa na muda wa kumalizika kwa usajili. Wakati huu, wakala wa mtumiaji (Alice) amesajiliwa kwa mafanikio na maombi ya SIP yanayokuja kwa Alice yanaweza kupelekwa kwa anwani sahihi ya mawasiliano.

### Mfano wa Simu

<figure><img src="../../../.gitbook/assets/image (666).png" alt=""><figcaption></figcaption></figure>

{% hint style="info" %}
Haitajwi, lakini Mtumiaji B anahitaji kutuma **ujumbe wa USAJILI kwa Proxy 2** kabla ya kuweza kupokea simu.
{% endhint %}

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
