# 161,162,10161,10162/udp - Pentesting SNMP

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Consejo para bug bounty**: **reg√≠strate** en **Intigriti**, una plataforma premium de bug bounty creada por hackers para hackers. √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo, y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Informaci√≥n B√°sica

**SNMP - Simple Network Management Protocol** es un protocolo utilizado para monitorear diferentes dispositivos en la red (como routers, switches, impresoras, IoTs...).
```
PORT    STATE SERVICE REASON                 VERSION
161/udp open  snmp    udp-response ttl 244   ciscoSystems SNMPv3 server (public)
```
{% hint style="info" %}
SNMP tambi√©n utiliza el puerto **162/UDP** para **traps**. Estos son **paquetes de datos enviados desde el servidor SNMP al cliente sin ser expl√≠citamente solicitados**.
{% endhint %}

### MIB

Para asegurar que el acceso SNMP funcione entre fabricantes y con diferentes combinaciones de cliente-servidor, se cre√≥ la **Base de Informaci√≥n de Gesti√≥n (MIB)**. MIB es un **formato independiente para almacenar informaci√≥n del dispositivo**. Un MIB es un archivo de **texto** en el que todos los **objetos SNMP consultables** de un dispositivo est√°n listados en una jerarqu√≠a de √°rbol **estandarizada**. Contiene al **menos un `Identificador de Objeto` (`OID`)**, que, adem√°s de la necesaria **direcci√≥n √∫nica** y un **nombre**, tambi√©n proporciona informaci√≥n sobre el tipo, derechos de acceso y una descripci√≥n del respectivo objeto.
Los archivos MIB est√°n escritos en el formato de texto ASCII basado en la `Notaci√≥n de Sintaxis Abstracta Uno` (`ASN.1`). Los **MIB no contienen datos**, pero explican **d√≥nde encontrar qu√© informaci√≥n** y c√≥mo es, qu√© valores devuelve para el OID espec√≠fico o qu√© tipo de datos se utiliza.

### OIDs

**OIDs** significa **Identificadores de Objetos**. **Los OIDs identifican de manera √∫nica a los objetos gestionados en una jerarqu√≠a MIB**. Esto se puede representar como un √°rbol, cuyos niveles son asignados por diferentes organizaciones. Los OIDs de objetos MIB de nivel superior pertenecen a diferentes organizaciones est√°ndar.
**Los fabricantes definen ramas privadas que incluyen objetos gestionados para sus propios productos.**

![](../../.gitbook/assets/snmp\_oid\_mib\_tree.png)

Puedes **navegar** a trav√©s de un **√°rbol OID** desde la web aqu√≠: [http://www.oid-info.com/cgi-bin/display?tree=#focus](http://www.oid-info.com/cgi-bin/display?tree=#focus) o **ver qu√© significa un OID** (como `1.3.6.1.2.1.1`) accediendo a [http://oid-info.com/get/1.3.6.1.2.1.1](http://oid-info.com/get/1.3.6.1.2.1.1).
Hay algunos **OIDs conocidos** como los que se encuentran dentro de [1.3.6.1.2.1](http://oid-info.com/get/1.3.6.1.2.1) que hacen referencia a las variables del Protocolo Simple de Gesti√≥n de Redes (SNMP) definidas por MIB-2. Y de los **OIDs pendientes de este** puedes obtener algunos datos interesantes del host (datos del sistema, datos de la red, datos de procesos...)

### **Ejemplo de OID**

**`1 . 3 . 6 . 1 . 4 . 1 . 1452 . 1 . 2 . 5 . 1 . 3 . 21 . 1 . 4 . 7`**

Aqu√≠ hay un desglose de esta direcci√≥n.

* 1 ‚Äì esto se llama ISO y establece que esto es un OID. Por eso todos los OIDs comienzan con "1"
* 3 ‚Äì esto se llama ORG y se utiliza para especificar la organizaci√≥n que construy√≥ el dispositivo.
* 6 ‚Äì esto es el dod o el Departamento de Defensa, que es la organizaci√≥n que estableci√≥ Internet primero.
* 1 ‚Äì este es el valor de internet para denotar que todas las comunicaciones se realizar√°n a trav√©s de Internet.
* 4 ‚Äì este valor determina que este dispositivo est√° hecho por una organizaci√≥n privada y no una gubernamental.
* 1 ‚Äì este valor denota que el dispositivo est√° hecho por una empresa o entidad comercial.

Estos primeros seis valores tienden a ser los mismos para todos los dispositivos y te dan la informaci√≥n b√°sica sobre ellos. Esta secuencia de n√∫meros ser√° la misma para todos los OIDs, excepto cuando el dispositivo est√° hecho por el gobierno.

Pasando al siguiente conjunto de n√∫meros.

* 1452 ‚Äì da el nombre de la organizaci√≥n que fabric√≥ este dispositivo.
* 1 ‚Äì explica el tipo de dispositivo. En este caso, es un reloj despertador.
* 2 ‚Äì determina que este dispositivo es una unidad terminal remota.

El resto de los valores dan informaci√≥n espec√≠fica sobre el dispositivo.

* 5 ‚Äì denota un punto de alarma discreto.
* 1 ‚Äì punto espec√≠fico en el dispositivo
* 3 ‚Äì puerto
* 21 ‚Äì direcci√≥n del puerto
* 1 ‚Äì pantalla para el puerto
* 4 ‚Äì n√∫mero de punto
* 7 ‚Äì estado del punto

_**(Ejemplo tomado de**_ [_**aqu√≠**_](https://www.netadmintools.com/snmp-mib-and-oids)_**)**_

### Versiones de SNMP

Hay 2 versiones importantes de SNMP:

* **SNMPv1**: La principal, sigue siendo la m√°s frecuente, la **autenticaci√≥n se basa en una cadena** (cadena de comunidad) que viaja en **texto plano** (toda la informaci√≥n viaja en texto plano). **La versi√≥n 2 y 2c** tambi√©n env√≠an el **tr√°fico en texto plano** y utilizan una **cadena de comunidad como autenticaci√≥n**.
* **SNMPv3**: Utiliza una mejor forma de **autenticaci√≥n** y la informaci√≥n viaja **encriptada** usando (**se podr√≠a realizar un ataque de diccionario** pero ser√≠a mucho m√°s dif√≠cil encontrar las credenciales correctas que en SNMPv1 y v2).

### Cadenas de Comunidad

Como se mencion√≥ antes, **para acceder a la informaci√≥n guardada en el MIB necesitas conocer la cadena de comunidad en las versiones 1 y 2/2c y las credenciales en la versi√≥n 3.**\
Hay **2 tipos de cadenas de comunidad**:

* **`public`** principalmente funciones de **solo lectura**
* **`private`** **Lectura/Escritura** en general

Nota que **la capacidad de escritura de un OID depende de la cadena de comunidad utilizada**, as√≠ que **incluso** si encuentras que se est√° utilizando "**public**", podr√≠as ser capaz de **escribir algunos valores.** Adem√°s, **puede** haber objetos que son **siempre "Solo Lectura".**\
Si intentas **escribir** un objeto se recibe un error de **`noSuchName` o `readOnly`**.

En las versiones 1 y 2/2c si intentas usar una cadena de comunidad **mala** el servidor no **responder√°**. Por lo tanto, si responde, se utiliz√≥ una **cadena de comunidad v√°lida**.

## Puertos

* El agente SNMP recibe solicitudes en el puerto UDP **161**.
* El gestor recibe notificaciones ([Traps](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol#Trap) y [InformRequests](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol#InformRequest)) en el puerto **162**.
* Cuando se utiliza con [Transport Layer Security](https://en.wikipedia.org/wiki/Transport\_Layer\_Security) o [Datagram Transport Layer Security](https://en.wikipedia.org/wiki/Datagram\_Transport\_Layer\_Security), las solicitudes se reciben en el puerto **10161** y las notificaciones se env√≠an al puerto **10162**.

## Fuerza Bruta de Cadena de Comunidad (v1 y v2c)

Para **adivinar la cadena de comunidad** podr√≠as realizar un ataque de diccionario. Consulta [aqu√≠ diferentes formas de realizar un ataque de fuerza bruta contra SNMP](../../generic-methodologies-and-resources/brute-force.md#snmp). Una cadena de comunidad frecuentemente utilizada es `public`.

## Enumeraci√≥n de SNMP

Se recomienda instalar lo siguiente para ver qu√© significa **cada OID recopilado** del dispositivo:
```bash
apt-get install snmp-mibs-downloader
download-mibs
# Finally comment the line saying "mibs :" in /etc/snmp/snmp.conf
sudo vi /etc/snmp/snmp.conf
```
Si conoces una cadena de comunidad v√°lida, puedes acceder a los datos utilizando **SNMPWalk** o **SNMP-Check**:
```bash
snmpbulkwalk -c [COMM_STRING] -v [VERSION] [IP] . #Don't forget the final dot
snmpbulkwalk -c public -v2c 10.10.11.136 .

snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP]
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] 1.3.6.1.2.1.4.34.1.3 #Get IPv6, needed dec2hex
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] NET-SNMP-EXTEND-MIB::nsExtendObjects #get extended
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] .1 #Enum all

snmp-check [DIR_IP] -p [PORT] -c [COMM_STRING]

nmap --script "snmp* and not snmp-brute" <target>

braa <community string>@<IP>:.1.3.6.* #Bruteforce specific OID
```
Gracias a consultas extendidas (download-mibs), es posible enumerar a√∫n m√°s sobre el sistema con el siguiente comando:
```bash
snmpwalk -v X -c public <IP> NET-SNMP-EXTEND-MIB::nsExtendOutputFull
```
**SNMP** contiene mucha informaci√≥n sobre el host y cosas que pueden resultar interesantes son: **Interfaces de red** (direcci√≥n IPv4 y **IPv6**), Nombres de usuario, Tiempo de actividad, Versi√≥n del Servidor/SO y **procesos**

**en ejecuci√≥n** (pueden contener contrase√±as)....

### **Configuraciones Peligrosas**

**De** [**https://academy.hackthebox.com/module/112/section/1075**](https://academy.hackthebox.com/module/112/section/1075)\*\*\*\*

| **Configuraciones**                              | **Descripci√≥n**                                                                        |
| ------------------------------------------------ | ------------------------------------------------------------------------------------- |
| `rwuser noauth`                                  | Proporciona acceso al √°rbol OID completo sin autenticaci√≥n.                            |
| `rwcommunity <cadena de comunidad> <direcci√≥n IPv4>`  | Proporciona acceso al √°rbol OID completo independientemente de d√≥nde se env√≠en las solicitudes. |
| `rwcommunity6 <cadena de comunidad> <direcci√≥n IPv6>` | Mismo acceso que con `rwcommunity` con la diferencia de usar IPv6.                    |

### Par√°metros de SNMP de Microsoft Windows

| **Valor MIB**                                    | **Descripci√≥n**                                                                        |
| ------------------------------------------------ | ------------------------------------------------------------------------------------- |
| `1.3.6.1.2.1.25.1.6.0`                           | Procesos del Sistema.                                                                  |
| `1.3.6.1.2.1.25.4.2.1.2`                         | Programas en Ejecuci√≥n.                                                                |
| `1.3.6.1.2.1.25.4.2.1.4`                         | Ruta de los Procesos.                                                                  |
| `1.3.6.1.2.1.25.2.3.1.4`                         | Unidades de Almacenamiento.                                                            |
| `1.3.6.1.2.1.25.6.3.1.2`                         | Nombre del Software.                                                                   |
| `1.3.6.1.4.1.77.1.2.25`                          | Cuentas de Usuario.                                                                    |
| `1.3.6.1.2.1.6.13.1.3`                           | Puertos Locales TCP.                                                                   |

### Cisco

Echa un vistazo a esta p√°gina si utilizas equipos Cisco:

{% content-ref url="cisco-snmp.md" %}
[cisco-snmp.md](cisco-snmp.md)
{% endcontent-ref %}

## De SNMP a RCE

Si tienes la **cadena** que te permite **escribir valores** dentro del servicio SNMP, podr√≠as abusar de ella para **ejecutar comandos**:

{% content-ref url="snmp-rce.md" %}
[snmp-rce.md](snmp-rce.md)
{% endcontent-ref %}

## **SNMP Masivo**

[Braa ](https://github.com/mteg/braa)es un esc√°ner SNMP masivo. El uso previsto de tal herramienta es, por supuesto, realizar consultas SNMP ‚Äì pero a diferencia de snmpwalk de net-snmp, es capaz de consultar docenas o cientos de hosts simult√°neamente, y en un solo proceso. Por lo tanto, consume muy pocos recursos del sistema y realiza el escaneo MUY r√°pido.

Braa implementa su PROPIA pila snmp, por lo que NO necesita ninguna biblioteca SNMP como net-snmp.

**Sintaxis:** braa \[Cadena de comunidad]@\[IP del servidor SNMP]:\[id iso]
```
braa ignite123@192.168.1.125:.1.3.6.*
```
Esta puede extraer una gran cantidad de informaci√≥n que no puedes procesar manualmente.

Entonces, busquemos la informaci√≥n m√°s interesante (de [https://blog.rapid7.com/2016/05/05/snmp-data-harvesting-during-penetration-testing/](https://blog.rapid7.com/2016/05/05/snmp-data-harvesting-during-penetration-testing/)):

### Dispositivos

Una de las primeras cosas que hago es extraer los datos MIB sysDesc .1.3.6.1.2.1.1.1.0 de cada archivo para determinar de qu√© dispositivos he recopilado informaci√≥n. Esto se puede hacer f√°cilmente utilizando el siguiente comando grep:
```
grep ".1.3.6.1.2.1.1.1.0" *.snmp
```
### Identificar cadena privada

Como ejemplo, si puedo identificar la cadena de comunidad privada utilizada por una organizaci√≥n en sus enrutadores Cisco IOS, entonces podr√≠a usar esa cadena de comunidad para extraer las configuraciones en ejecuci√≥n de esos enrutadores. El mejor m√©todo para encontrar dichos datos a menudo ha estado relacionado con los datos de SNMP Trap. Por lo tanto, nuevamente, utilizando el siguiente grep podemos analizar r√°pidamente una gran cantidad de datos MIB en busca de la palabra clave "trap":
```bash
grep -i "trap" *.snmp
```
### Nombres de usuario/contrase√±as

Otro √°rea de inter√©s son los registros. He descubierto que hay dispositivos que almacenan registros dentro de las tablas MIB. Estos registros tambi√©n pueden contener intentos fallidos de inicio de sesi√≥n. Piensa en la √∫ltima vez que iniciaste sesi√≥n en un dispositivo v√≠a Telnet o SSH e inadvertidamente ingresaste tu contrase√±a como nombre de usuario. Normalmente busco palabras clave como _fail_, _failed_ o _login_ y examino esos datos para ver si hay algo valioso.
```bash
grep -i "login\|fail" *.snmp
```
### Correos electr√≥nicos
```bash
grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b" *.snmp
```
## Modificaci√≥n de valores SNMP

Puedes usar _**NetScanTools**_ para **modificar valores**. Necesitar√°s conocer la **cadena privada** para poder hacerlo.

## Suplantaci√≥n (Spoofing)

Si hay una ACL que solo permite a algunas IPs consultar el servicio SMNP, puedes suplantar una de estas direcciones dentro del paquete UDP y capturar el tr√°fico.

## Examinar archivos de configuraci√≥n SNMP

* snmp.conf
* snmpd.conf
* snmp-config.xml

## Comandos Autom√°ticos de HackTricks
```
Protocol_Name: SNMP    #Protocol Abbreviation if there is one.
Port_Number:  161     #Comma separated if there is more than one.
Protocol_Description: Simple Network Managment Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SNMP
Note: |
SNMP - Simple Network Management Protocol is a protocol used to monitor different devices in the network (like routers, switches, printers, IoTs...).

https://book.hacktricks.xyz/pentesting/pentesting-snmp

Entry_2:
Name: SNMP Check
Description: Enumerate SNMP
Command: snmp-check {IP}

Entry_3:
Name: OneSixtyOne
Description: Crack SNMP passwords
Command: onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings-onesixtyone.txt {IP} -w 100

Entry_4:
Name: Nmap
Description: Nmap snmp (no brute)
Command: nmap --script "snmp* and not snmp-brute" {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} -v {IP} snmp
```
<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Consejo para cazar recompensas**: **reg√≠strate** en **Intigriti**, una plataforma premium de caza de recompensas creada por hackers, para hackers. ¬°√önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprende a hackear AWS desde cero hasta ser un h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
