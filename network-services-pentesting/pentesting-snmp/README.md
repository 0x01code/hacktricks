# 161,162,10161,10162/udp - SNMPのペンテスト

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**バグバウンティのヒント**: **Intigriti**に**サインアップ**してください。これは、ハッカーによって作成されたプレミアムな**バグバウンティプラットフォーム**です！今すぐ[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)に参加して、最大**$100,000**のバウンティを獲得しましょう！

{% embed url="https://go.intigriti.com/hacktricks" %}

## 基本情報

**SNMP（Simple Network Management Protocol）**は、ネットワーク内のさまざまなデバイス（ルーター、スイッチ、プリンター、IoTなど）を監視するために使用されるプロトコルです。
```
PORT    STATE SERVICE REASON                 VERSION
161/udp open  snmp    udp-response ttl 244   ciscoSystems SNMPv3 server (public)
```
{% hint style="info" %}
SNMPは、**トラップ**のためにポート**162/UDP**も使用します。これらは、明示的に要求されないまま、SNMPサーバからクライアントに送信されるデータ**パケット**です。
{% endhint %}

### MIB

SNMPアクセスがさまざまなメーカーやクライアントサーバの組み合わせで機能するようにするために、**Management Information Base（MIB）**が作成されました。MIBは、デバイス情報を格納するための**独立した形式**です。MIBは、デバイスのすべてのクエリ可能な**SNMPオブジェクト**が**標準化された**ツリー階層でリストされている**テキスト**ファイルです。少なくとも1つの`Object Identifier（OID）`を含み、必要な**一意のアドレス**と**名前**に加えて、各オブジェクトのタイプ、アクセス権、および説明に関する情報も提供します。\
MIBファイルは、`Abstract Syntax Notation One（ASN.1）`ベースのASCIIテキスト形式で書かれています。**MIBにはデータは含まれていません**が、**どの情報をどこで見つけるか**、それがどのように見えるか、特定のOIDに対する返り値や使用されるデータ型などを説明しています。

### OID

**OID**は**オブジェクト識別子**の略です。**OIDはMIB階層内の管理対象オブジェクトを一意に識別**します。これはツリーとして表現され、そのレベルは異なる組織によって割り当てられます。トップレベルのMIBオブジェクトID（OID）は、異なる標準組織に属しています。\
**ベンダーは、自社製品の管理対象オブジェクトを含むプライベートブランチを定義します。**

![](../../.gitbook/assets/snmp_oid_mib_tree.png)

ウェブ上で**OIDツリー**をナビゲートするには、[http://www.oid-info.com/cgi-bin/display?tree=#focus](http://www.oid-info.com/cgi-bin/display?tree=#focus)にアクセスするか、[http://oid-info.com/get/1.3.6.1.2.1.1](http://oid-info.com/get/1.3.6.1.2.1.1)にアクセスして**OIDの意味を確認**できます（例：`1.3.6.1.2.1.1`）。\
[1.3.6.1.2.1](http://oid-info.com/get/1.3.6.1.2.1)内のような**よく知られたOID**もあります。これは、MIB-2で定義されたSimple Network Management Protocol（SNMP）変数を参照しています。そして、このOIDから**保留中のOID**を取得することで、いくつかの興味深いホストデータ（システムデータ、ネットワークデータ、プロセスデータなど）を取得できます。

### **OIDの例**

**`1 . 3 . 6 . 1 . 4 . 1 . 1452 . 1 . 2 . 5 . 1 . 3. 21 . 1 . 4 . 7`**

このアドレスの詳細は以下の通りです。

* 1 - これはISOと呼ばれ、これがOIDであることを確立します。これがすべてのOIDが「1」で始まる理由です。
* 3 - これはORGと呼ばれ、デバイスを構築した組織を指定するために使用されます。
* 6 - これはdodまたはDepartment of Defenseであり、最初にインターネットを確立した組織です。
* 1 - これはインターネットの値で、すべての通信がインターネットを介して行われることを示します。
* 4 - この値は、このデバイスが政府のものではなく、私企業のものであることを示します。
* 1 - この値は、デバイスが企業または事業体によって作られたことを示します。

これらの最初の6つの値は、すべてのデバイスに対して同じであり、基本的な情報を提供します。政府が製造したデバイス以外のすべてのOIDには、この数列が同じになります。

次の数列に進みましょう。

* 1452 - このデバイスを製造した組織の名前を示します。
* 1 - デバイスのタイプを説明します。この場合、アラーム時計です。
* 2 - このデバイスがリモート端末ユニットであることを示します。

残りの値はデバイスに関する具体的な情報を提供します。

* 5 - 離散アラームポイントを示します。
* 1 - デバイス内の特定のポイント
* 3 - ポート
* 21 - ポートのアドレス
* 1 - ポートの表示
* 4 - ポイント番号
* 7 - ポイントの状態

_（例は_ [_こちらから取得しました_](https://www.netadmintools.com/snmp-mib-and-oids)_）_

### SNMPのバージョン

SNMPには2つの重要なバージョンがあります。

* **SNMPv1**：主要なバージョンで、最も頻繁に使用されています。**認証は文字列**（コミュニティストリング）に基づいており、**すべての情報が平文で送信**されます。**バージョン2および2c**も情報を**平文で送信**し、認証には**コミュニティストリング**が使用されます。
* **SNMPv3**：より良い**認証形式**を使用し、情報は**暗号化**されて送信されます（**辞書攻撃**は実行できますが、SNMPv1およびv2よりも正しい認証情報を見つけるのははるかに困難です）。

### コミュニティストリング

前述のように、**MIBに保存された情報にアクセスするには、バージョン1および2/2cではコミュニティストリング、バージョン3では認証情報が必要です。**\
コミュニティストリングには**2つのタイプ**があります。

* **`public`**：主に**読み取り専用**の機能
* **`private`**：一般的に**読み取り/書き込み**の機能

OIDの書き込み可能性は使用されるコミュニティストリングに依存するため、**「public」**が使用されているとわかっても、**一部の値を書き込むことができる**場合があります。また、**常に「読み取り専用」**であるオブジェクトも存在する場合があります。\
オブジェクトに**書き込み**しようとすると、**「noSuchName」または「readOnly」エラー**が受信されます。

バージョン1および2/2cでは、**不正な**コミュニティストリングを使用すると、サーバは**応答しません**。したがって、応答がある場合は、**有効なコミュニティストリングが使用された**ことになります。

## ポート

* SNMPエージェントはUDPポート**161**でリクエストを受信します。
* マネージャはポート**162**で通知（[トラップ](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol#Trap)および[InformRequests](https://en.wikipedia.org/wiki/Simple\_Network\_Management\_Protocol#InformRequest)）を受信します。
* [Transport Layer Security](https://en.wikipedia.org/wiki/Transport\_Layer\_Security)または[Datagram Transport Layer Security](https://en.wikipedia.org/wiki/Datagram\_Transport\_Layer\_Security)と共に使用する場合、リクエストはポート**10161**で受信され、通知はポート**10162**に送信されます。
## Brute-Force Community String (v1 and v2c)

コミュニティストリングを**推測する**ために、辞書攻撃を実行することができます。[ここでSNMPに対してブルートフォース攻撃を実行するさまざまな方法](../../generic-methodologies-and-resources/brute-force.md#snmp)を確認してください。よく使用されるコミュニティストリングは`public`です。

## Enumerating SNMP

デバイスから収集された**各OIDの意味**を確認するために、以下のものをインストールすることをお勧めします：
```bash
apt-get install snmp-mibs-downloader
download-mibs
# Finally comment the line saying "mibs :" in /etc/snmp/snmp.conf
sudo vi /etc/snmp/snmp.conf
```
もし有効なコミュニティストリングを知っている場合、**SNMPWalk**または**SNMP-Check**を使用してデータにアクセスすることができます。
```bash
snmpbulkwalk -c [COMM_STRING] -v [VERSION] [IP] . #Don't forget the final dot
snmpbulkwalk -c public -v2c 10.10.11.136 .

snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP]
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] 1.3.6.1.2.1.4.34.1.3 #Get IPv6, needed dec2hex
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] NET-SNMP-EXTEND-MIB::nsExtendObjects #get extended
snmpwalk -v [VERSION_SNMP] -c [COMM_STRING] [DIR_IP] .1 #Enum all

snmp-check [DIR_IP] -p [PORT] -c [COMM_STRING]

nmap --script "snmp* and not snmp-brute" <target>

braa <community string>@<IP>:.1.3.6.* #Bruteforce specific OID
```
拡張クエリ（download-mibs）のおかげで、次のコマンドを使用してシステムについてさらに詳細な列挙が可能です：
```bash
snmpwalk -v X -c public <IP> NET-SNMP-EXTEND-MIB::nsExtendOutputFull
```
**SNMP**には、ホストに関する多くの情報があります。興味深い情報には、**ネットワークインターフェース**（IPv4および**IPv6**アドレス）、ユーザー名、稼働時間、サーバー/OSのバージョン、および**実行中のプロセス**（パスワードを含む場合があります）が含まれます。

### **危険な設定**

[**https://academy.hackthebox.com/module/112/section/1075**](https://academy.hackthebox.com/module/112/section/1075)から引用

| **設定**                                           | **説明**                                                                                   |
| ------------------------------------------------ | ----------------------------------------------------------------------------------------- |
| `rwuser noauth`                                  | 認証なしで完全なOIDツリーへのアクセスを提供します。                                      |
| `rwcommunity <community string> <IPv4 address>`  | リクエストがどこから送信されたかに関係なく、完全なOIDツリーへのアクセスを提供します。     |
| `rwcommunity6 <community string> <IPv6 address>` | IPv6を使用する点を除いて、`rwcommunity`と同じアクセスを提供します。                         |

### Cisco

Ciscoの機器を使用している場合は、次のページを参照してください：

{% content-ref url="cisco-snmp.md" %}
[cisco-snmp.md](cisco-snmp.md)
{% endcontent-ref %}

## SNMPからRCEへ

SNMPサービス内で**値を書き込む**ことができる**文字列**を持っている場合、それを悪用して**コマンドを実行**することができるかもしれません：

{% content-ref url="snmp-rce.md" %}
[snmp-rce.md](snmp-rce.md)
{% endcontent-ref %}

## **Massive SNMP**

[Braa ](https://github.com/mteg/braa)は大量のSNMPスキャナーです。このツールの意図された使用法は、もちろんSNMPクエリを実行することですが、net-snmpのsnmpwalkとは異なり、数十台または数百台のホストに同時にクエリを実行し、単一のプロセスで行うことができます。そのため、システムリソースを非常に少なく消費し、非常に高速なスキャンを行います。

Braaは独自のSNMPスタックを実装しているため、net-snmpのようなSNMPライブラリは必要ありません。

**構文:** braa \[コミュニティストリング]@\[SNMPサーバーのIP]:\[iso id]
```
braa ignite123@192.168.1.125:.1.3.6.*
```
これは、手動で処理することができないほどの多くの情報を抽出することができます。

では、最も興味深い情報を探してみましょう（[https://blog.rapid7.com/2016/05/05/snmp-data-harvesting-during-penetration-testing/](https://blog.rapid7.com/2016/05/05/snmp-data-harvesting-during-penetration-testing/)から）：

### デバイス

最初に行うことの一つは、各ファイルから sysDesc .1.3.6.1.2.1.1.1.0 MIB データを抽出し、収集した情報からどのデバイスがあるかを判断することです。次の grep コマンドを使用することで簡単に行うことができます：
```
grep ".1.3.6.1.2.1.1.1.0" *.snmp
```
### プライベートストリングの特定

例えば、組織がCisco IOSルーターで使用しているプライベートコミュニティストリングを特定できれば、そのコミュニティストリングを使用してそれらのルーターから実行中の設定を抽出することができます。このようなデータを見つけるための最良の方法は、しばしばSNMPトラップデータに関連しています。したがって、次のgrepを使用して、"trap"というキーワードを検索して多くのMIBデータを迅速に解析することができます。
```bash
grep -i "trap" *.snmp
```
### ユーザー名/パスワード

興味深い別の領域はログです。私はMIBテーブル内にログを保持しているデバイスがいくつかあることを発見しました。これらのログには、ログインの試行が失敗した情報も含まれています。TelnetやSSHを介してデバイスにログインした際に、パスワードをユーザー名として誤って入力したことがあるか思い出してみてください。私は通常、_fail_、_failed_、または_login_などのキーワードを検索し、そのデータを調べて価値のある情報がないか確認します。
```bash
grep -i "login\|fail" *.snmp
```
### メール

Emails are a common communication method used by individuals and organizations. They are often used for sending and receiving messages, files, and other types of information. 

メールは、個人や組織によってよく使われるコミュニケーション手段です。メッセージやファイル、その他の情報を送受信するためによく使用されます。

Emails are typically sent and received through email servers, which are responsible for handling the transmission and delivery of emails. 

メールは通常、メールサーバーを介して送受信されます。メールサーバーは、メールの送信と配信を担当します。

When conducting a penetration test, it is important to assess the security of the email infrastructure to identify any vulnerabilities that could be exploited by an attacker. 

ペネトレーションテストを実施する際には、攻撃者によって悪用される可能性のある脆弱性を特定するために、メールインフラストラクチャのセキュリティを評価することが重要です。

Some common techniques used to assess the security of emails include:

- **Email Spoofing**: This technique involves forging the sender's email address to make it appear as if the email is coming from a different source. It can be used for phishing attacks or to bypass email filters.

- **Email Header Analysis**: By analyzing the email headers, it is possible to gather information about the email's origin, route, and other details that can help in identifying any suspicious activity.

- **Email Content Analysis**: Analyzing the content of the email can provide insights into the intentions and motives of the sender. It can also help in identifying any malicious attachments or links.

- **Email Server Misconfigurations**: Misconfigurations in email servers can lead to security vulnerabilities. By identifying and exploiting these misconfigurations, an attacker can gain unauthorized access to the email system.

- **Email Password Cracking**: If an attacker gains access to an email account, they may attempt to crack the password to gain further access or to impersonate the account owner.

These techniques can help in identifying and mitigating potential security risks associated with emails. It is important to regularly assess and update the security measures in place to protect against email-based attacks.
```bash
grep -E -o "\b[A-Za-z0-9._%+-]+@[A-Za-z0-9.-]+\.[A-Za-z]{2,6}\b" *.snmp
```
## SNMP値の変更

_**NetScanTools**_を使用して値を変更することができます。そのためには、**プライベートストリング**を知る必要があります。

## スプーフィング

SNMPサービスのクエリを許可するIPアドレスが制限されている場合、UDPパケット内のアドレスをスプーフィングしてトラフィックを嗅視することができます。

## SNMP設定ファイルの調査

* snmp.conf
* snmpd.conf
* snmp-config.xml

## HackTricks自動コマンド
```
Protocol_Name: SNMP    #Protocol Abbreviation if there is one.
Port_Number:  161     #Comma separated if there is more than one.
Protocol_Description: Simple Network Managment Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SNMP
Note: |
SNMP - Simple Network Management Protocol is a protocol used to monitor different devices in the network (like routers, switches, printers, IoTs...).

https://book.hacktricks.xyz/pentesting/pentesting-snmp

Entry_2:
Name: SNMP Check
Description: Enumerate SNMP
Command: snmp-check {IP}

Entry_3:
Name: OneSixtyOne
Description: Crack SNMP passwords
Command: onesixtyone -c /usr/share/seclists/Discovery/SNMP/common-snmp-community-strings-onesixtyone.txt {IP} -w 100

Entry_4:
Name: Nmap
Description: Nmap snmp (no brute)
Command: nmap --script "snmp* and not snmp-brute" {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} -v {IP} snmp
```
<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**バグバウンティのヒント**: **Intigriti**に**サインアップ**してください。これは、ハッカーによって作成されたプレミアムな**バグバウンティプラットフォーム**です！今すぐ[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)に参加して、最大**$100,000**の報酬を獲得しましょう！

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ HackTricksで**会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手**したいですか？または、HackTricksをPDFでダウンロードしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。これは、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
