# 22 - Pentesting SSH/SFTP

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de recompensa por bugs**: **inscreva-se** no **Intigriti**, uma plataforma de **recompensas por bugs premium criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Informa√ß√µes B√°sicas

**SSH (Secure Shell ou Secure Socket Shell)** √© um protocolo de rede que permite uma conex√£o segura a um computador em uma rede n√£o segura. √â essencial para manter a confidencialidade e integridade dos dados ao acessar sistemas remotos.

**Porta padr√£o:** 22
```
22/tcp open  ssh     syn-ack
```
**Servidores SSH:**

* [openSSH](http://www.openssh.org) ‚Äì OpenBSD SSH, inclu√≠do em distribui√ß√µes BSD, Linux e Windows desde o Windows 10
* [Dropbear](https://matt.ucc.asn.au/dropbear/dropbear.html) ‚Äì Implementa√ß√£o SSH para ambientes com baixa mem√≥ria e recursos de processamento, inclu√≠do no OpenWrt
* [PuTTY](https://www.chiark.greenend.org.uk/\~sgtatham/putty/) ‚Äì Implementa√ß√£o SSH para Windows, o cliente √© comumente usado, mas o uso do servidor √© mais raro
* [CopSSH](https://www.itefix.net/copssh) ‚Äì Implementa√ß√£o do OpenSSH para Windows

**Bibliotecas SSH (implementando no lado do servidor):**

* [libssh](https://www.libssh.org) ‚Äì Biblioteca C multiplataforma que implementa o protocolo SSHv2 com bindings em [Python](https://github.com/ParallelSSH/ssh-python), [Perl](https://github.com/garnier-quentin/perl-libssh/) e [R](https://github.com/ropensci/ssh); √© usada pelo KDE para sftp e pelo GitHub para a infraestrutura git SSH
* [wolfSSH](https://www.wolfssl.com/products/wolfssh/) ‚Äì Biblioteca de servidor SSHv2 escrita em ANSI C e direcionada para ambientes embarcados, RTOS e com recursos limitados
* [Apache MINA SSHD](https://mina.apache.org/sshd-project/index.html) ‚Äì A biblioteca java Apache SSHD √© baseada no Apache MINA
* [paramiko](https://github.com/paramiko/paramiko) ‚Äì Biblioteca Python de protocolo SSHv2

## Enumera√ß√£o

### Coleta de Banner
```bash
nc -vn <IP> 22
```
### Auditoria automatizada do ssh-audit

O ssh-audit √© uma ferramenta para auditoria de configura√ß√£o de servidor e cliente ssh.

[https://github.com/jtesta/ssh-audit](https://github.com/jtesta/ssh-audit) √© um fork atualizado de [https://github.com/arthepsy/ssh-audit/](https://github.com/arthepsy/ssh-audit/)

**Recursos:**

* Suporte a servidores SSH1 e SSH2;
* analisar a configura√ß√£o do cliente SSH;
* obter banner, reconhecer dispositivo ou software e sistema operacional, detectar compress√£o;
* reunir algoritmos de troca de chaves, chaves de host, criptografia e c√≥digos de autentica√ß√£o de mensagem;
* informa√ß√µes de algoritmo de sa√≠da (dispon√≠vel desde, removido/desativado, inseguro/fraco/antigo, etc);
* recomenda√ß√µes de algoritmo de sa√≠da (adicionar ou remover com base na vers√£o do software reconhecida);
* informa√ß√µes de seguran√ßa de sa√≠da (quest√µes relacionadas, lista de CVE atribu√≠da, etc);
* analisar a compatibilidade da vers√£o do SSH com base nas informa√ß√µes do algoritmo;
* informa√ß√µes hist√≥ricas do OpenSSH, Dropbear SSH e libssh;
* funciona no Linux e Windows;
* sem depend√™ncias
```bash
usage: ssh-audit.py [-1246pbcnjvlt] <host>

-1,  --ssh1             force ssh version 1 only
-2,  --ssh2             force ssh version 2 only
-4,  --ipv4             enable IPv4 (order of precedence)
-6,  --ipv6             enable IPv6 (order of precedence)
-p,  --port=<port>      port to connect
-b,  --batch            batch output
-c,  --client-audit     starts a server on port 2222 to audit client
software config (use -p to change port;
use -t to change timeout)
-n,  --no-colors        disable colors
-j,  --json             JSON output
-v,  --verbose          verbose output
-l,  --level=<level>    minimum output level (info|warn|fail)
-t,  --timeout=<secs>   timeout (in seconds) for connection and reading
(default: 5)
$ python3 ssh-audit <IP>
```
### Chave p√∫blica SSH do servidor

[Veja em a√ß√£o (Asciinema)](https://asciinema.org/a/96ejZKxpbuupTK9j7h8BdClzp)
```bash
ssh-keyscan -t rsa <IP> -p <PORT>
```
### Algoritmos de Cifra Fracos

Isso √© descoberto por padr√£o pelo **nmap**. Mas voc√™ tamb√©m pode usar **sslcan** ou **sslyze**.

### Scripts do Nmap
```bash
nmap -p22 <ip> -sC # Send default nmap scripts for SSH
nmap -p22 <ip> -sV # Retrieve version
nmap -p22 <ip> --script ssh2-enum-algos # Retrieve supported algorythms
nmap -p22 <ip> --script ssh-hostkey --script-args ssh_hostkey=full # Retrieve weak keys
nmap -p22 <ip> --script ssh-auth-methods --script-args="ssh.user=root" # Check authentication methods
```
### Shodan

* `ssh`

## For√ßa bruta em nomes de usu√°rio, senhas e chaves privadas

### Enumera√ß√£o de Nomes de Usu√°rio

Em algumas vers√µes do OpenSSH, voc√™ pode realizar um ataque de tempo para enumerar usu√°rios. Voc√™ pode usar um m√≥dulo do Metasploit para explorar isso:
```
msf> use scanner/ssh/ssh_enumusers
```
### [Brute force](../generic-methodologies-and-resources/brute-force.md#ssh)

Algumas credenciais ssh comuns [aqui](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ssh-betterdefaultpasslist.txt) e [aqui](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Common-Credentials/top-20-common-SSH-passwords.txt) e abaixo.

### For√ßa Bruta de Chave Privada

Se voc√™ conhece algumas chaves privadas ssh que poderiam ser usadas... vamos tentar. Voc√™ pode usar o script nmap:
```
https://nmap.org/nsedoc/scripts/ssh-publickey-acceptance.html
```
Ou o m√≥dulo auxiliar MSF:
```
msf> use scanner/ssh/ssh_identify_pubkeys
```
Ou use `ssh-keybrute.py` (python3 nativo, leve e com algoritmos legados habilitados): [snowdroppe/ssh-keybrute](https://github.com/snowdroppe/ssh-keybrute).

#### Chaves ruins conhecidas podem ser encontradas aqui:

{% embed url="https://github.com/rapid7/ssh-badkeys/tree/master/authorized" %}

#### Chaves SSH fracas / PRNG previs√≠vel do Debian

Alguns sistemas possuem falhas conhecidas na semente aleat√≥ria usada para gerar material criptogr√°fico. Isso pode resultar em um espa√ßo de chaves dramaticamente reduzido que pode ser quebrado por for√ßa bruta. Conjuntos de chaves pr√©-geradas geradas em sistemas Debian afetados por PRNG fraco est√£o dispon√≠veis aqui: [g0tmi1k/debian-ssh](https://github.com/g0tmi1k/debian-ssh).

Voc√™ deve procurar aqui para buscar chaves v√°lidas para a m√°quina v√≠tima.

### Kerberos

**crackmapexec** usando o protocolo `ssh` pode usar a op√ß√£o `--kerberos` para **autenticar via kerberos**.\
Para mais informa√ß√µes execute `crackmapexec ssh --help`.

## Credenciais padr√£o

| **Fornecedor** | **Nomes de usu√°rio**                                                                                         | **Senhas**                                                                                                                                                                                                 |
| -------------- | ------------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| APC            | apc, device                                                                                                  | apc                                                                                                                                                                                                       |
| Brocade        | admin                                                                                                        | admin123, password, brocade, fibranne                                                                                                                                                                     |
| Cisco          | admin, cisco, enable, hsa, pix, pnadmin, ripeop, root, shelladmin                                            | admin, Admin123, default, password, secur4u, cisco, Cisco, \_Cisco, cisco123, C1sco!23, Cisco123, Cisco1234, TANDBERG, change\_it, 12345, ipics, pnadmin, diamond, hsadb, c, cc, attack, blender, changeme |
| Citrix         | root, nsroot, nsmaint, vdiadmin, kvm, cli, admin                                                             | C1trix321, nsroot, nsmaint, kaviza, kaviza123, freebsd, public, rootadmin, wanscaler                                                                                                                      |
| D-Link         | admin, user                                                                                                  | private, admin, user                                                                                                                                                                                      |
| Dell           | root, user1, admin, vkernel, cli                                                                             | calvin, 123456, password, vkernel, Stor@ge!, admin                                                                                                                                                        |
| EMC            | admin, root, sysadmin                                                                                        | EMCPMAdm7n, Password#1, Password123#, sysadmin, changeme, emc                                                                                                                                             |
| HP/3Com        | admin, root, vcx, app, spvar, manage, hpsupport, opc\_op                                                     | admin, password, hpinvent, iMC123, pvadmin, passw0rd, besgroup, vcx, nice, access, config, 3V@rpar, 3V#rpar, procurve, badg3r5, OpC\_op, !manage, !admin                                                  |
| Huawei         | admin, root                                                                                                  | 123456, admin, root, Admin123, Admin@storage, Huawei12#$, HwDec@01, hwosta2.0, HuaWei123, fsp200@HW, huawei123                                                                                            |
| IBM            | USERID, admin, manager, mqm, db2inst1, db2fenc1, dausr1, db2admin, iadmin, system, device, ufmcli, customer | PASSW0RD, passw0rd, admin, password, Passw8rd, iadmin, apc, 123456, cust0mer                                                                                                                              |
| Juniper        | netscreen                                                                                                    | netscreen                                                                                                                                                                                                 |
| NetApp         | admin                                                                                                        | netapp123                                                                                                                                                                                                 |
| Oracle         | root, oracle, oravis, applvis, ilom-admin, ilom-operator, nm2user                                            | changeme, ilom-admin, ilom-operator, welcome1, oracle                                                                                                                                                     |
| VMware         | vi-admin, root, hqadmin, vmware, admin                                                                       | vmware, vmw@re, hqadmin, default                                                                                                                                                                          |

## SSH-MitM

Se voc√™ estiver na rede local como a v√≠tima que vai se conectar ao servidor SSH usando nome de usu√°rio e senha, voc√™ pode tentar **realizar um ataque MitM para roubar essas credenciais:**

**Caminho do ataque:**

* **Redirecionamento de tr√°fego:** O atacante **desvia** o tr√°fego da v√≠tima para sua m√°quina, efetivamente **interceptando** a tentativa de conex√£o com o servidor SSH.
* **Intercepta√ß√£o e Registro:** A m√°quina do atacante age como um **proxy**, **capturando** os detalhes de login do usu√°rio fingindo ser o servidor SSH leg√≠timo.
* **Execu√ß√£o de Comandos e Revezamento:** Por fim, o servidor do atacante **registra as credenciais do usu√°rio**, **encaminha os comandos** para o verdadeiro servidor SSH, **executa** os comandos e **envia os resultados de volta** para o usu√°rio, tornando o processo aparentemente cont√≠nuo e leg√≠timo.

[**SSH MITM**](https://github.com/jtesta/ssh-mitm) faz exatamente o que √© descrito acima.

Para capturar e realizar o MitM real, voc√™ pode usar t√©cnicas como ARP spoofing, DNS spoofing ou outras descritas nos [**ataques de falsifica√ß√£o de rede**](../generic-methodologies-and-resources/pentesting-network/#spoofing).

## SSH-Snake

Se voc√™ deseja percorrer uma rede usando chaves privadas SSH descobertas em sistemas, utilizando cada chave privada em cada sistema para novos hosts, ent√£o [**SSH-Snake**](https://github.com/MegaManSec/SSH-Snake) √© o que voc√™ precisa.

O SSH-Snake realiza automaticamente e de forma recursiva as seguintes tarefas:

1. No sistema atual, encontre quaisquer chaves privadas SSH,
2. No sistema atual, encontre quaisquer hosts ou destinos (usu√°rio@host) que possam aceitar as chaves privadas,
3. Tente fazer SSH em todos os destinos usando todas as chaves privadas descobertas,
4. Se um destino for conectado com sucesso, repete os passos #1 - #4 no sistema conectado.

√â completamente auto-replicante e auto-propagante - e completamente sem arquivos.

## Configura√ß√µes Incorretas de Configura√ß√£o

### Login de root

√â comum que servidores SSH permitam o login do usu√°rio root por padr√£o, o que representa um risco de seguran√ßa significativo. **Desabilitar o login de root** √© um passo cr√≠tico para garantir a seguran√ßa do servidor. O acesso n√£o autorizado com privil√©gios administrativos e ataques de for√ßa bruta podem ser mitigados ao fazer essa altera√ß√£o.

**Para Desabilitar o Login de Root no OpenSSH:**

1. **Edite o arquivo de configura√ß√£o do SSH** com: `sudoedit /etc/ssh/sshd_config`
2. **Altere a configura√ß√£o** de `#PermitRootLogin yes` para **`PermitRootLogin no`**.
3. **Recarregue a configura√ß√£o** usando: `sudo systemctl daemon-reload`
4. **Reinicie o servidor SSH** para aplicar as altera√ß√µes: `sudo systemctl restart sshd`

### For√ßa Bruta SFTP

* [**For√ßa Bruta SFTP**](../generic-methodologies-and-resources/brute-force.md#sftp)

### Execu√ß√£o de comandos SFTP

H√° uma falha comum nas configura√ß√µes de SFTP, onde os administradores pretendem que os usu√°rios troquem arquivos sem habilitar o acesso ao shell remoto. Apesar de configurar os usu√°rios com shells n√£o interativos (por exemplo, `/usr/bin/nologin`) e confin√°-los a um diret√≥rio espec√≠fico, uma brecha de seguran√ßa permanece. **Os usu√°rios podem contornar essas restri√ß√µes** solicitando a execu√ß√£o de um comando (como `/bin/bash`) imediatamente ap√≥s o login, antes que seu shell n√£o interativo designado assuma o controle. Isso permite a execu√ß√£o n√£o autorizada de comandos, minando as medidas de seguran√ßa pretendidas.

[Exemplo daqui](https://community.turgensec.com/ssh-hacking-guide/):
```bash
ssh -v noraj@192.168.1.94 id
...
Password:
debug1: Authentication succeeded (keyboard-interactive).
Authenticated to 192.168.1.94 ([192.168.1.94]:22).
debug1: channel 0: new [client-session]
debug1: Requesting no-more-sessions@openssh.com
debug1: Entering interactive session.
debug1: pledge: network
debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0
debug1: Sending command: id
debug1: client_input_channel_req: channel 0 rtype exit-status reply 0
debug1: client_input_channel_req: channel 0 rtype eow@openssh.com reply 0
uid=1000(noraj) gid=100(users) groups=100(users)
debug1: channel 0: free: client-session, nchannels 1
Transferred: sent 2412, received 2480 bytes, in 0.1 seconds
Bytes per second: sent 43133.4, received 44349.5
debug1: Exit status 0

$ ssh noraj@192.168.1.94 /bin/bash
```
Aqui est√° um exemplo de configura√ß√£o segura do SFTP (`/etc/ssh/sshd_config` - openSSH) para o usu√°rio `noraj`:
```
Match User noraj
ChrootDirectory %h
ForceCommand internal-sftp
AllowTcpForwarding no
PermitTunnel no
X11Forwarding no
PermitTTY no
```
Esta configura√ß√£o permitir√° apenas SFTP: desativando o acesso ao shell for√ßando o comando de in√≠cio e desativando o acesso ao TTY, mas tamb√©m desativando todos os tipos de encaminhamento de porta ou tunelamento.

### Tunelamento SFTP

Se voc√™ tiver acesso a um servidor SFTP, tamb√©m pode encaminhar seu tr√°fego por meio dele, por exemplo, usando o encaminhamento de porta comum:
```bash
sudo ssh -L <local_port>:<remote_host>:<remote_port> -N -f <username>@<ip_compromised>
```
### SFTP Symlink

O **sftp** tem o comando "**symlink**". Portanto, se voc√™ tiver **direitos de escrita** em alguma pasta, voc√™ pode criar **symlinks** de **outras pastas/arquivos**. Como voc√™ provavelmente est√° **preso** dentro de um chroot, isso **n√£o ser√° especialmente √∫til** para voc√™, mas, se voc√™ puder **acessar** o **symlink** criado a partir de um **servi√ßo sem chroot** (por exemplo, se voc√™ puder acessar o symlink pela web), voc√™ poderia **abrir os arquivos symlinkados atrav√©s da web**.

Por exemplo, para criar um **symlink** de um novo arquivo **"**_**froot**_**" para "**_**/**_**"**:
```bash
sftp> symlink / froot
```
Se voc√™ conseguir acessar o arquivo "_froot_" via web, ser√° capaz de listar a pasta raiz ("/") do sistema.

### M√©todos de autentica√ß√£o

Em ambientes de alta seguran√ßa, √© uma pr√°tica comum habilitar apenas a autentica√ß√£o baseada em chave ou de dois fatores em vez da autentica√ß√£o baseada em senha simples. Mas frequentemente os m√©todos de autentica√ß√£o mais fortes s√£o habilitados sem desabilitar os mais fracos. Um caso frequente √© habilitar `publickey` na configura√ß√£o do openSSH e defini-lo como m√©todo padr√£o, mas sem desabilitar `password`. Assim, usando o modo verbose do cliente SSH, um atacante pode ver que um m√©todo mais fraco est√° habilitado:
```bash
ssh -v 192.168.1.94
OpenSSH_8.1p1, OpenSSL 1.1.1d  10 Sep 2019
...
debug1: Authentications that can continue: publickey,password,keyboard-interactive
```
Por exemplo, se um limite de falha de autentica√ß√£o estiver definido e voc√™ nunca tiver a chance de alcan√ßar o m√©todo de senha, voc√™ pode usar a op√ß√£o `PreferredAuthentications` para for√ßar o uso desse m√©todo.
```bash
ssh -v 192.168.1.94 -o PreferredAuthentications=password
...
debug1: Next authentication method: password
```
Rever a configura√ß√£o do servidor SSH √© necess√°rio para verificar se apenas os m√©todos esperados est√£o autorizados. Usar o modo verbose no cliente pode ajudar a ver a efic√°cia da configura√ß√£o.

### Arquivos de configura√ß√£o
```bash
ssh_config
sshd_config
authorized_keys
ssh_known_hosts
known_hosts
id_rsa
```
## Fuzzing

* [https://packetstormsecurity.com/files/download/71252/sshfuzz.txt](https://packetstormsecurity.com/files/download/71252/sshfuzz.txt)
* [https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh\_version\_2](https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh\_version\_2)

## Refer√™ncias

* Voc√™ pode encontrar guias interessantes sobre como fortalecer o SSH em [https://www.ssh-audit.com/hardening\_guides.html](https://www.ssh-audit.com/hardening\_guides.html)
* [https://community.turgensec.com/ssh-hacking-guide](https://community.turgensec.com/ssh-hacking-guide)

<figure><img src="../.gitbook/assets/i3.png" alt=""><figcaption></figcaption></figure>

**Dica de recompensa por bugs**: **inscreva-se** no **Intigriti**, uma plataforma premium de **recompensa por bugs criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Comandos Autom√°ticos do HackTricks
```
Protocol_Name: SSH
Port_Number: 22
Protocol_Description: Secure Shell Hardening

Entry_1:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -v -V -u -l {Username} -P {Big_Passwordlist} -t 1 {IP} ssh

Entry_2:
Name: consolesless mfs enumeration
Description: SSH enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ssh/ssh_version; set RHOSTS {IP}; set RPORT 22; run; exit' && msfconsole -q -x 'use scanner/ssh/ssh_enumusers; set RHOSTS {IP}; set RPORT 22; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ssh/juniper_backdoor; set RHOSTS {IP}; set RPORT 22; run; exit'

```
<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
