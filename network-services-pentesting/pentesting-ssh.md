# 22 - Pentesting SSH/SFTP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## Informa√ß√µes B√°sicas

**SSH ou Secure Shell ou Secure Socket Shell,** √© um protocolo de rede que oferece aos usu√°rios uma **maneira segura de acessar um computador em uma rede n√£o segura.**

**Porta padr√£o:** 22
```
22/tcp open  ssh     syn-ack
```
**Servidores SSH:**

* [openSSH](http://www.openssh.org) - OpenBSD SSH, inclu√≠do em distribui√ß√µes BSD, Linux e Windows desde o Windows 10
* [Dropbear](https://matt.ucc.asn.au/dropbear/dropbear.html) - Implementa√ß√£o SSH para ambientes com baixa mem√≥ria e recursos de processador, inclu√≠do no OpenWrt
* [PuTTY](https://www.chiark.greenend.org.uk/\~sgtatham/putty/) - Implementa√ß√£o SSH para Windows, o cliente √© comumente usado, mas o uso do servidor √© mais raro
* [CopSSH](https://www.itefix.net/copssh) - Implementa√ß√£o do OpenSSH para Windows

**Bibliotecas SSH (implementando o lado do servidor):**

* [libssh](https://www.libssh.org) - Biblioteca C multiplataforma que implementa o protocolo SSHv2, com bindings em [Python](https://github.com/ParallelSSH/ssh-python), [Perl](https://github.com/garnier-quentin/perl-libssh/) e [R](https://github.com/ropensci/ssh); √© usado pelo KDE para sftp e pelo GitHub para a infraestrutura de SSH do git
* [wolfSSH](https://www.wolfssl.com/products/wolfssh/) - Biblioteca de servidor SSHv2 escrita em ANSI C e direcionada para ambientes embarcados, RTOS e com recursos limitados
* [Apache MINA SSHD](https://mina.apache.org/sshd-project/index.html) - A biblioteca Java Apache SSHD √© baseada no Apache MINA
* [paramiko](https://github.com/paramiko/paramiko) - Biblioteca de protocolo SSHv2 em Python

## Enumera√ß√£o

### Banner Grabbing
```bash
nc -vn <IP> 22
```
### Auditoria automatizada de ssh-audit

ssh-audit √© uma ferramenta para auditoria de configura√ß√£o de servidor e cliente ssh.

[https://github.com/jtesta/ssh-audit](https://github.com/jtesta/ssh-audit) √© um fork atualizado de [https://github.com/arthepsy/ssh-audit/](https://github.com/arthepsy/ssh-audit/)

**Recursos:**

* Suporte a servidor SSH1 e SSH2;
* Analisar a configura√ß√£o do cliente SSH;
* Obter banner, reconhecer dispositivo ou software e sistema operacional, detectar compress√£o;
* Coletar algoritmos de troca de chaves, chave de host, criptografia e c√≥digo de autentica√ß√£o de mensagem;
* Informa√ß√µes sobre algoritmos de sa√≠da (dispon√≠veis desde, removidos/desativados, inseguros/fracos/legados, etc);
* Recomenda√ß√µes de algoritmos de sa√≠da (adicionar ou remover com base na vers√£o do software reconhecido);
* Informa√ß√µes de seguran√ßa de sa√≠da (quest√µes relacionadas, lista de CVE atribu√≠das, etc);
* Analisar a compatibilidade da vers√£o do SSH com base nas informa√ß√µes do algoritmo;
* Informa√ß√µes hist√≥ricas do OpenSSH, Dropbear SSH e libssh;
* Funciona no Linux e Windows;
* Sem depend√™ncias
```bash
usage: ssh-audit.py [-1246pbcnjvlt] <host>

-1,  --ssh1             force ssh version 1 only
-2,  --ssh2             force ssh version 2 only
-4,  --ipv4             enable IPv4 (order of precedence)
-6,  --ipv6             enable IPv6 (order of precedence)
-p,  --port=<port>      port to connect
-b,  --batch            batch output
-c,  --client-audit     starts a server on port 2222 to audit client
software config (use -p to change port;
use -t to change timeout)
-n,  --no-colors        disable colors
-j,  --json             JSON output
-v,  --verbose          verbose output
-l,  --level=<level>    minimum output level (info|warn|fail)
-t,  --timeout=<secs>   timeout (in seconds) for connection and reading
(default: 5)
$ python3 ssh-audit <IP>
```
### Chave p√∫blica SSH do servidor

```plaintext
ssh-rsa AAAAB3NzaC1yc2EAAAADAQABAAABAQDZz6Xz3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z3z
```bash
ssh-keyscan -t rsa <IP> -p <PORT>
```
### Algoritmos de Cifra Fracos

Isso √© descoberto por padr√£o pelo **nmap**. Mas voc√™ tamb√©m pode usar o **sslscan** ou **sslyze**.

### Scripts do Nmap
```bash
nmap -p22 <ip> -sC # Send default nmap scripts for SSH
nmap -p22 <ip> -sV # Retrieve version
nmap -p22 <ip> --script ssh2-enum-algos # Retrieve supported algorythms
nmap -p22 <ip> --script ssh-hostkey --script-args ssh_hostkey=full # Retrieve weak keys
nmap -p22 <ip> --script ssh-auth-methods --script-args="ssh.user=root" # Check authentication methods
```
### Shodan

* `ssh`

## For√ßa bruta de nomes de usu√°rio, senhas e chaves privadas

### Enumera√ß√£o de Nomes de Usu√°rio

Em algumas vers√µes do OpenSSH, √© poss√≠vel realizar um ataque de tempo para enumerar usu√°rios. Voc√™ pode usar um m√≥dulo do Metasploit para explorar isso:
```
msf> use scanner/ssh/ssh_enumusers
```
### [For√ßa bruta](../generic-methodologies-and-resources/brute-force.md#ssh)

Algumas credenciais ssh comuns [aqui](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Default-Credentials/ssh-betterdefaultpasslist.txt) e [aqui](https://github.com/danielmiessler/SecLists/blob/master/Passwords/Common-Credentials/top-20-common-SSH-passwords.txt) e abaixo.

### For√ßa Bruta de Chave Privada

Se voc√™ conhece algumas chaves privadas ssh que podem ser usadas... vamos tentar. Voc√™ pode usar o script nmap:
```
https://nmap.org/nsedoc/scripts/ssh-publickey-acceptance.html
```
Ou o m√≥dulo auxiliar do MSF:
```
msf> use scanner/ssh/ssh_identify_pubkeys
```
Ou use `ssh-keybrute.py` (python3 nativo, leve e com algoritmos legados habilitados): [snowdroppe/ssh-keybrute](https://github.com/snowdroppe/ssh-keybrute).

#### Chaves ruins conhecidas podem ser encontradas aqui:

{% embed url="https://github.com/rapid7/ssh-badkeys/tree/master/authorized" %}

#### Chaves SSH fracas / PRNG previs√≠vel do Debian

Alguns sistemas t√™m falhas conhecidas na semente aleat√≥ria usada para gerar material criptogr√°fico. Isso pode resultar em um espa√ßo de chaves dramaticamente reduzido que pode ser quebrado por for√ßa bruta. Conjuntos pr√©-gerados de chaves geradas em sistemas Debian afetados por PRNG fraco est√£o dispon√≠veis aqui: [g0tmi1k/debian-ssh](https://github.com/g0tmi1k/debian-ssh).

Voc√™ deve procurar aqui para procurar chaves v√°lidas para a m√°quina v√≠tima.

### Kerberos

**crackmapexec** usando o protocolo `ssh` pode usar a op√ß√£o `--kerberos` para **autenticar via kerberos**.\
Para mais informa√ß√µes, execute `crackmapexec ssh --help`.

## Credenciais padr√£o

| **Fabricante** | **Nomes de usu√°rio**                                                                                         | **Senhas**                                                                                                                                                                                                 |
| -------------- | ------------------------------------------------------------------------------------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| APC            | apc, device                                                                                                  | apc                                                                                                                                                                                                        |
| Brocade        | admin                                                                                                        | admin123, password, brocade, fibranne                                                                                                                                                                      |
| Cisco          | admin, cisco, enable, hsa, pix, pnadmin, ripeop, root, shelladmin                                            | admin, Admin123, default, password, secur4u, cisco, Cisco, \_Cisco, cisco123, C1sco!23, Cisco123, Cisco1234, TANDBERG, change\_it, 12345, ipics, pnadmin, diamond, hsadb, c, cc, attack, blender, changeme |
| Citrix         | root, nsroot, nsmaint, vdiadmin, kvm, cli, admin                                                             | C1trix321, nsroot, nsmaint, kaviza, kaviza123, freebsd, public, rootadmin, wanscaler                                                                                                                       |
| D-Link         | admin, user                                                                                                  | private, admin, user                                                                                                                                                                                       |
| Dell           | root, user1, admin, vkernel, cli                                                                             | calvin, 123456, password, vkernel, Stor@ge!, admin                                                                                                                                                         |
| EMC            | admin, root, sysadmin                                                                                        | EMCPMAdm7n, Password#1, Password123#, sysadmin, changeme, emc                                                                                                                                              |
| HP/3Com        | admin, root, vcx, app, spvar, manage, hpsupport, opc\_op                                                     | admin, password, hpinvent, iMC123, pvadmin, passw0rd, besgroup, vcx, nice, access, config, 3V@rpar, 3V#rpar, procurve, badg3r5, OpC\_op, !manage, !admin                                                   |
| Huawei         | admin, root                                                                                                  | 123456, admin, root, Admin123, Admin@storage, Huawei12#$, HwDec@01, hwosta2.0, HuaWei123, fsp200@HW, huawei123                                                                                             |
| IBM            | USERID, admin, manager, mqm, db2inst1, db2fenc1, dausr1, db2admin, iadmin, system, device, ufmcli, customer  | PASSW0RD, passw0rd, admin, password, Passw8rd, iadmin, apc, 123456, cust0mer                                                                                                                               |
| Juniper        | netscreen                                                                                                    | netscreen                                                                                                                                                                                                  |
| NetApp         | admin                                                                                                        | netapp123                                                                                                                                                                                                  |
| Oracle         | root, oracle, oravis, applvis, ilom-admin, ilom-operator, nm2user                                            | changeme, ilom-admin, ilom-operator, welcome1, oracle                                                                                                                                                      |
| VMware         | vi-admin, root, hqadmin, vmware, admin                                                                       | vmware, vmw@re, hqadmin, default                                                                                                                                                                           |

## SSH-MitM

Se voc√™ estiver na rede local como a v√≠tima que vai se conectar ao servidor SSH usando nome de usu√°rio e senha, voc√™ pode tentar **realizar um ataque MitM para roubar essas credenciais:**

**Caminho do ataque:**

* o tr√°fego do usu√°rio √© redirecionado para a m√°quina atacante
* o atacante monitora as tentativas de conex√£o com o servidor SSH e as redireciona para seu pr√≥prio servidor SSH
* o servidor SSH do atacante √© configurado, em primeiro lugar, para registrar todos os dados inseridos, incluindo a senha do usu√°rio, e, em segundo lugar, para enviar comandos ao servidor SSH leg√≠timo para o qual o usu√°rio deseja se conectar, para execut√°-los e, em seguida, retornar os resultados ao usu√°rio leg√≠timo

\*\*\*\*[**SSH MITM**](https://github.com/jtesta/ssh-mitm) \*\*\*\* faz exatamente o que foi descrito acima.

Para capturar e realizar o MitM real, voc√™ pode usar t√©cnicas como ARP spoofing, DNS spoofing ou outras descritas em [**Ataques de Spoofing de Rede**](../generic-methodologies-and-resources/pentesting-network/#spoofing).

## Configura√ß√µes incorretas de configura√ß√£o

### Login de root

Por padr√£o, a maioria das implementa√ß√µes de servidor SSH permitir√° o login de root. √â aconselh√°vel desativ√°-lo, porque se as credenciais dessa conta vazarem, os invasores obter√£o privil√©gios administrativos diretamente e isso tamb√©m permitir√° que os invasores realizem ataques de for√ßa bruta nessa conta.

**Como desativar o login de root para o openSSH:**

1. Edite a configura√ß√£o do servidor SSH `sudoedit /etc/ssh/sshd_config`
2. Altere `#PermitRootLogin yes` para `PermitRootLogin no`
3. Leve em considera√ß√£o as altera√ß√µes de configura√ß√£o: `sudo systemctl daemon-reload`
4. Reinicie o servidor SSH `sudo systemctl restart sshd`

### Execu√ß√£o de comandos SFTP

Outra configura√ß√£o incorreta comum do SSH √© frequentemente vista na configura√ß√£o do SFTP. Na maioria das vezes, ao criar um servidor SFTP, o administrador deseja que os usu√°rios tenham acesso SFTP para compartilhar arquivos, mas n√£o para obter um shell remoto na m√°quina. Portanto, eles pensam que criar um usu√°rio, atribuir a ele um shell reservado (como `/usr/bin/nologin` ou `/usr/bin/false`) e restringi-lo em uma pris√£o √© suficiente para evitar o acesso ou abuso de shell em todo o sistema de arquivos. Mas eles est√£o errados, **um usu√°rio pode solicitar a execu√ß√£o de um comando logo ap√≥s a autentica√ß√£o antes que seu comando ou shell padr√£o seja executado**. Portanto, para ignorar o shell reservado que negar√° o acesso ao shell, basta solicitar a execu√ß√£o de um comando (por exemplo, `/bin/bash`) antes, apenas fazendo:
```
$ ssh -v noraj@192.168.1.94 id
...
Password:
debug1: Authentication succeeded (keyboard-interactive).
Authenticated to 192.168.1.94 ([192.168.1.94]:22).
debug1: channel 0: new [client-session]
debug1: Requesting no-more-sessions@openssh.com
debug1: Entering interactive session.
debug1: pledge: network
debug1: client_input_global_request: rtype hostkeys-00@openssh.com want_reply 0
debug1: Sending command: id
debug1: client_input_channel_req: channel 0 rtype exit-status reply 0
debug1: client_input_channel_req: channel 0 rtype eow@openssh.com reply 0
uid=1000(noraj) gid=100(users) groups=100(users)
debug1: channel 0: free: client-session, nchannels 1
Transferred: sent 2412, received 2480 bytes, in 0.1 seconds
Bytes per second: sent 43133.4, received 44349.5
debug1: Exit status 0

$ ssh noraj@192.168.1.94 /bin/bash
```
Aqui est√° um exemplo de configura√ß√£o segura do SFTP (`/etc/ssh/sshd_config` - openSSH) para o usu√°rio `noraj`:

```plaintext
# Permitir apenas SFTP e desativar o acesso SSH
Subsystem sftp internal-sftp

Match User noraj
    ForceCommand internal-sftp
    PasswordAuthentication yes
    ChrootDirectory /home/noraj
    PermitTunnel no
    AllowAgentForwarding no
    AllowTcpForwarding no
    X11Forwarding no
```

Certifique-se de reiniciar o servi√ßo SSH ap√≥s fazer altera√ß√µes na configura√ß√£o.
```
Match User noraj
ChrootDirectory %h
ForceCommand internal-sftp
AllowTcpForwarding no
PermitTunnel no
X11Forwarding no
PermitTTY no
```
Essa configura√ß√£o permitir√° apenas o SFTP: desabilitando o acesso ao shell for√ßando o comando de in√≠cio e desabilitando o acesso TTY, mas tamb√©m desabilitando todos os tipos de encaminhamento de porta ou t√∫nel.

### T√∫nel SFTP

Se voc√™ tiver acesso a um servidor SFTP, tamb√©m poder√° direcionar seu tr√°fego por meio dele, por exemplo, usando o encaminhamento de porta comum:
```
sudo ssh -L <local_port>:<remote_host>:<remote_port> -N -f <username>@<ip_compromised>
```
### SFTP Symlink

O **sftp** possui o comando "**symlink**". Portanto, se voc√™ tiver **direitos de grava√ß√£o** em alguma pasta, voc√™ pode criar **links simb√≥licos** de **outras pastas/arquivos**. Como voc√™ provavelmente est√° **preso** dentro de um chroot, isso **n√£o ser√° especialmente √∫til** para voc√™, mas se voc√™ puder **acessar** o **link simb√≥lico** criado a partir de um **servi√ßo sem chroot** (por exemplo, se voc√™ puder acessar o link simb√≥lico pela web), voc√™ poder√° **abrir os arquivos linkados atrav√©s da web**.

Por exemplo, para criar um **link simb√≥lico** de um novo arquivo **"**_**froot**_**" para "**_**/**_**"**:
```
sftp> symlink / froot
```
Se voc√™ conseguir acessar o arquivo "_froot_" via web, poder√° listar a pasta raiz ("/") do sistema.

### M√©todos de autentica√ß√£o

Em ambientes de alta seguran√ßa, √© comum habilitar apenas autentica√ß√£o baseada em chave ou autentica√ß√£o de dois fatores em vez da autentica√ß√£o simples baseada em senha. No entanto, muitas vezes os m√©todos de autentica√ß√£o mais fortes s√£o habilitados sem desabilitar os mais fracos. Um caso frequente √© habilitar `publickey` na configura√ß√£o do openSSH e defini-lo como o m√©todo padr√£o, mas n√£o desabilitar `password`. Portanto, usando o modo verbose do cliente SSH, um atacante pode ver que um m√©todo mais fraco est√° habilitado:
```
$ ssh -v 192.168.1.94
OpenSSH_8.1p1, OpenSSL 1.1.1d  10 Sep 2019
...
debug1: Authentications that can continue: publickey,password,keyboard-interactive
```
Por exemplo, se um limite de falha de autentica√ß√£o estiver definido e voc√™ nunca tiver a chance de alcan√ßar o m√©todo de senha, voc√™ pode usar a op√ß√£o `PreferredAuthentications` para for√ßar o uso desse m√©todo.
```
$ ssh -v 192.168.1.94 -o PreferredAuthentications=password
...
debug1: Next authentication method: password
```
Revisar a configura√ß√£o do servidor SSH √© necess√°rio para verificar se apenas os m√©todos esperados est√£o autorizados. Usar o modo verbose no cliente pode ajudar a ver a efic√°cia da configura√ß√£o.

### Arquivos de configura√ß√£o
```
ssh_config
sshd_config
authorized_keys
ssh_known_hosts
known_hosts
id_rsa
```
## Fuzzing

* [https://packetstormsecurity.com/files/download/71252/sshfuzz.txt](https://packetstormsecurity.com/files/download/71252/sshfuzz.txt)
* [https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh\_version\_2](https://www.rapid7.com/db/modules/auxiliary/fuzzers/ssh/ssh\_version\_2)

## Refer√™ncias

* Voc√™ pode encontrar guias interessantes sobre como fortalecer o SSH em [https://www.ssh-audit.com/hardening\_guides.html](https://www.ssh-audit.com/hardening\_guides.html)
* [https://community.turgensec.com/ssh-hacking-guide](https://community.turgensec.com/ssh-hacking-guide)

<img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s, escrita e falada, √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## Comandos Autom√°ticos HackTricks
```
Protocol_Name: SSH
Port_Number: 22
Protocol_Description: Secure Shell Hardening

Entry_1:
Name: Hydra Brute Force
Description: Need Username
Command: hydra -v -V -u -l {Username} -P {Big_Passwordlist} -t 1 {IP} ssh

Entry_2:
Name: consolesless mfs enumeration
Description: SSH enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/ssh/ssh_version; set RHOSTS {IP}; set RPORT 22; run; exit' && msfconsole -q -x 'use scanner/ssh/ssh_enumusers; set RHOSTS {IP}; set RPORT 22; run; exit' && msfconsole -q -x 'use auxiliary/scanner/ssh/juniper_backdoor; set RHOSTS {IP}; set RPORT 22; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
