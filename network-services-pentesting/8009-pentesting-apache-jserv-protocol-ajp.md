# 8009 - Pentesting Protocolo Apache JServ (AJP)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando os clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos de blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se a lenda do hacker web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

## Informa√ß√µes B√°sicas

De: [https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/](https://diablohorn.com/2011/10/19/8009-the-forgotten-tomcat-port/)

> AJP √© um protocolo de comunica√ß√£o. √â uma vers√£o otimizada do protocolo HTTP que permite que um servidor web independente, como o [Apache](http://httpd.apache.org/), se comunique com o Tomcat. Historicamente, o Apache tem sido muito mais r√°pido que o Tomcat ao servir conte√∫do est√°tico. A ideia √© permitir que o Apache sirva o conte√∫do est√°tico sempre que poss√≠vel, mas encaminhar a solicita√ß√£o para o Tomcat para conte√∫do relacionado ao Tomcat.

Tamb√©m interessante:

> O protocolo ajp13 √© orientado a pacotes. Um formato bin√°rio foi presumivelmente escolhido em vez do texto simples mais leg√≠vel por motivos de desempenho. O servidor web se comunica com o cont√™iner de servlets por meio de conex√µes TCP. Para reduzir o processo caro de cria√ß√£o de soquetes, o servidor web tentar√° manter conex√µes TCP persistentes com o cont√™iner de servlets e reutilizar uma conex√£o para v√°rios ciclos de solicita√ß√£o/resposta.

**Porta padr√£o:** 8009
```
PORT     STATE SERVICE
8009/tcp open  ajp13
```
## CVE-2020-1938 ['Ghostcat'](https://www.chaitin.cn/en/ghostcat)

Se a porta AJP estiver exposta, o Tomcat pode ser suscet√≠vel √† vulnerabilidade Ghostcat. Aqui est√° um [exploit](https://www.exploit-db.com/exploits/48143) que funciona com esse problema.

Ghostcat √© uma vulnerabilidade LFI, mas um tanto restrita: apenas arquivos de um determinado caminho podem ser extra√≠dos. Ainda assim, isso pode incluir arquivos como `WEB-INF/web.xml`, que podem vazar informa√ß√µes importantes, como credenciais para a interface do Tomcat, dependendo da configura√ß√£o do servidor.

As vers√µes corrigidas em ou acima de 9.0.31, 8.5.51 e 7.0.100 resolveram esse problema.

## Enumera√ß√£o

### Autom√°tica
```bash
nmap -sV --script ajp-auth,ajp-headers,ajp-methods,ajp-request -n -p 8009 <IP>
```
### [**For√ßa bruta**](../generic-methodologies-and-resources/brute-force.md#ajp)

## Proxy AJP

### Proxy AJP do Apache

N√£o √© comum encontrar a porta 8009 aberta e nenhuma outra porta web aberta. Nesse caso, seria bom usar ferramentas existentes como o metasploit para invadi-la, certo? Conforme mencionado em uma das cita√ß√µes, voc√™ pode (abusar) do Apache para fazer proxy das solicita√ß√µes para a porta 8009 do Tomcat. Nas refer√™ncias, voc√™ encontrar√° um guia √∫til sobre como fazer isso (leia-o primeiro), o que segue √© apenas uma vis√£o geral dos comandos que usei em minha pr√≥pria m√°quina. Omiti algumas das instru√ß√µes originais, pois n√£o pareciam ser necess√°rias.
```bash
sudo apt-get install libapache2-mod-jk
sudo vim /etc/apache2/apache2.conf # append the following line to the config
Include ajp.conf
sudo vim /etc/apache2/ajp.conf     # create the following file, change HOST to the target address
ProxyRequests Off
<Proxy *>
Order deny,allow
Deny from all
Allow from localhost
</Proxy>
ProxyPass       / ajp://HOST:8009/
ProxyPassReverse    / ajp://HOST:8009/
sudo a2enmod proxy_http
sudo a2enmod proxy_ajp
sudo systemctl restart apache2
```
Um efeito colateral interessante de usar essa configura√ß√£o √© que voc√™ pode frustrar os sistemas IDS/IPS em vigor, j√° que o protocolo AJP √© em parte bin√°rio, mas eu n√£o verifiquei isso. Agora voc√™ pode simplesmente direcionar sua explora√ß√£o regular do tomcat no metasploit para 127.0.0.1:80 e assumir o controle desse sistema. Aqui est√° tamb√©m a sa√≠da do metasploit:
```bash
msf  exploit(tomcat_mgr_deploy) > show options

Module options (exploit/multi/http/tomcat_mgr_deploy):

Name      Current Setting  Required  Description
----      ---------------  --------  -----------
PASSWORD  tomcat           no        The password for the specified username
PATH      /manager         yes       The URI path of the manager app (/deploy and /undeploy will be used)
Proxies                    no        Use a proxy chain
RHOST     localhost        yes       The target address
RPORT     80               yes       The target port
USERNAME  tomcat           no        The username to authenticate as
VHOST                      no        HTTP server virtual host
```
### Proxy Reverso Nginx & AJP

Quando nos deparamos com uma porta de proxy AJP aberta (8009 TCP), podemos usar o Nginx com o `ajp_module` para acessar o "oculto" Tomcat Manager. Isso pode ser feito compilando o c√≥digo-fonte do Nginx e adicionando o m√≥dulo necess√°rio, da seguinte forma:

* Baixe o c√≥digo-fonte do Nginx
* Baixe o m√≥dulo necess√°rio
* Compile o c√≥digo-fonte do Nginx com o `ajp_module`.
* Crie um arquivo de configura√ß√£o apontando para a porta AJP
```bash
# Download Nginx code
wget https://nginx.org/download/nginx-1.21.3.tar.gz
tar -xzvf nginx-1.21.3.tar.gz

# Compile Nginx source code with the ajp module
git clone https://github.com/dvershinin/nginx_ajp_module.git
cd nginx-1.21.3
sudo apt install libpcre3-dev
./configure --add-module=`pwd`/../nginx_ajp_module --prefix=/etc/nginx --sbin-path=/usr/sbin/nginx --modules-path=/usr/lib/nginx/modules
make
sudo make install
nginx -V
```
Comente todo o bloco `server` e adicione as seguintes linhas dentro do bloco `http` no arquivo `/etc/nginx/conf/nginx.conf`.
```shell-session
upstream tomcats {
server <TARGET_SERVER>:8009;
keepalive 10;
}
server {
listen 80;
location / {
ajp_keep_conn on;
ajp_pass tomcats;
}
}
```
Inicie o Nginx e verifique se tudo est√° funcionando corretamente emitindo uma solicita√ß√£o cURL para o seu host local.
```html
sudo nginx
curl http://127.0.0.1:80

<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Apache Tomcat/X.X.XX</title>
<link href="favicon.ico" rel="icon" type="image/x-icon" />
<link href="favicon.ico" rel="shortcut icon" type="image/x-icon" />
<link href="tomcat.css" rel="stylesheet" type="text/css" />
</headas
<body>
<div id="wrapper">
<div id="navigation" class="curved container">
<span id="nav-home"><a href="https://tomcat.apache.org/">Home</a></span>
<span id="nav-hosts"><a href="/docs/">Documentation</a></span>
<span id="nav-config"><a href="/docs/config/">Configuration</a></span>
<span id="nav-examples"><a href="/examples/">Examples</a></span>
<span id="nav-wiki"><a href="https://wiki.apache.org/tomcat/FrontPage">Wiki</a></span>
<span id="nav-lists"><a href="https://tomcat.apache.org/lists.html">Mailing Lists</a></span>
<span id="nav-help"><a href="https://tomcat.apache.org/findhelp.html">Find Help</a></span>
<br class="separator" />
</div>
<div id="asf-box">
<h1>Apache Tomcat/X.X.XX</h1>
</div>
<div id="upper" class="curved container">
<div id="congrats" class="curved container">
<h2>If you're seeing this, you've successfully installed Tomcat. Congratulations!</h2>
<SNIP>
```
## Refer√™ncias

* [https://academy.hackthebox.com/module/145/section/1295](https://academy.hackthebox.com/module/145/section/1295)

<figure><img src="../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando seus clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos de blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se a lenda do hacker web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) e comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? Ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
