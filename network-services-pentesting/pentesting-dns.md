# 53 - Pentesting DNS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation de la vuln√©rabilit√© et le pentesting**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au rapport. Nous ne rempla√ßons pas les pentesters - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, obtenir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

## **Informations de base**

Le Domain Name Systems (DNS) est l'annuaire t√©l√©phonique d'Internet. Les humains acc√®dent aux informations en ligne via des noms de domaine, comme nytimes.com ou espn.com. Les navigateurs web interagissent via des adresses de protocole Internet (IP). Le DNS traduit les noms de domaine en [adresses IP](https://www.cloudflare.com/learning/dns/glossary/what-is-my-ip-address/) afin que les navigateurs puissent charger les ressources Internet.\
Depuis [ici](https://www.cloudflare.com/learning/dns/what-is-dns/).

**Port par d√©faut :** 53
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Diff√©rents serveurs DNS

Informations issues de [https://academy.hackthebox.com/module/112/section/1069](https://academy.hackthebox.com/module/112/section/1069)

| **Type de serveur**            | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                 |
| ------------------------------ | ------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Serveur racine DNS`           | Les serveurs racines du DNS sont responsables des domaines de premier niveau (`TLD`). En tant que derni√®re instance, ils ne sont sollicit√©s que si le serveur de noms ne r√©pond pas. Ainsi, un serveur racine est une interface centrale entre les utilisateurs et le contenu sur Internet, car il relie le domaine et l'adresse IP. La [Internet Corporation for Assigned Names and Numbers](https://www.icann.org/) (`ICANN`) coordonne le travail des serveurs de noms racines. Il existe `13` serveurs racines de ce type dans le monde. |
| `Serveur de noms faisant autorit√©` | Les serveurs de noms faisant autorit√© d√©tiennent l'autorit√© pour une zone particuli√®re. Ils r√©pondent uniquement aux requ√™tes de leur zone de responsabilit√©, et leurs informations sont contraignantes. Si un serveur de noms faisant autorit√© ne peut pas r√©pondre √† une requ√™te d'un client, le serveur racine prend le relais √† ce moment-l√†.                                                                                                                             |
| `Serveur de noms non autoritatif` | Les serveurs de noms non autoritatifs ne sont pas responsables d'une zone DNS particuli√®re. Au lieu de cela, ils collectent eux-m√™mes des informations sur des zones DNS sp√©cifiques, ce qui est fait en utilisant des requ√™tes DNS r√©cursives ou it√©ratives.                                                                                                                                                                                                                   |
| `Serveur DNS de mise en cache`    | Les serveurs DNS de mise en cache stockent des informations provenant d'autres serveurs de noms pour une p√©riode sp√©cifi√©e. Le serveur de noms faisant autorit√© d√©termine la dur√©e de ce stockage.                                                                                                                                                                                                                                                                             |
| `Serveur de transfert`            | Les serveurs de transfert n'ont qu'une seule fonction : ils transmettent les requ√™tes DNS √† un autre serveur DNS.                                                                                                                                                                                                                                                                                                                                                               |
| `R√©solveur`                       | Les r√©solveurs ne sont pas des serveurs DNS faisant autorit√© mais effectuent la r√©solution de noms localement dans l'ordinateur ou le routeur.                                                                                                                                                                                                                                                                                                                                  |

## √ânum√©ration

### **R√©cup√©ration de banni√®re**

DNS n'a pas de "banni√®re" √† r√©cup√©rer. L'√©quivalent le plus proche est une requ√™te magique pour `version.bind. CHAOS TXT` qui fonctionnera sur la plupart des serveurs de noms BIND.\
Vous pouvez effectuer cette requ√™te en utilisant `dig` :
```bash
dig version.bind CHAOS TXT @DNS
```
Si cela ne fonctionne pas, vous pouvez utiliser des techniques d'empreintes digitales pour d√©terminer la version du serveur distant -- l'outil [`fpdns`](https://github.com/kirei/fpdns) est une option pour cela, mais il en existe d'autres.

Vous pouvez √©galement r√©cup√©rer la banni√®re avec un script **nmap** :
```
--script dns-nsid
```
### **Enregistrement ANY**

L'enregistrement **ANY** demandera au serveur DNS de **retourner** toutes les **entr√©es** disponibles **qu'il accepte de divulguer**.
```bash
dig any victim.com @<DNS_IP>
```
### **Transfert de Zone**

Cette proc√©dure est abr√©g√©e `Asynchronous Full Transfer Zone` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
### Plus d'informations
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Automatisation
```bash
for sub in $(cat <WORDLIST>);do dig $sub.<DOMAIN> @<DNS_IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver <DNS_IP> --enum -p 0 -s 0 -o subdomains.txt -f <WORDLIST> <DOMAIN>
```
#### Utilisation de nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### Modules metasploit utiles
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Scripts nmap utiles
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Attaque par force brute inverse
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
{% hint style="info" %}
Si vous parvenez √† trouver des sous-domaines r√©solvant vers des adresses IP internes, vous devriez essayer de r√©aliser un BF DNS inverse aux NS du domaine en demandant cette plage d'IP.
{% endhint %}

Un autre outil pour cela : [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Vous pouvez interroger des plages d'IP inverses sur [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#\_dns) (cet outil est √©galement utile avec BGP).

### DNS - BF de Sous-domaines
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Serveurs Active Directory
```bash
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com

nslookup -type=srv _kerberos._tcp.<CLIENT_DOMAIN>
nslookup -type=srv _kerberos._tcp.domain.com

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec
```bash
#Query paypal subdomains to ns3.isc-sns.info
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Force brute en utilisant des requ√™tes "AAAA" pour rassembler les IPv6 des sous-domaines.
```bash
dnsdict6 -s -t <domain>
```
Bruteforce du reverse DNS en utilisant des adresses IPv6
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### DNS Recursion DDoS

Si **la r√©cursivit√© DNS est activ√©e**, un attaquant pourrait **usurper** l'**origine** sur le paquet UDP afin de faire **envoyer la r√©ponse DNS au serveur victime**. Un attaquant pourrait abuser des types d'enregistrements **ANY** ou **DNSSEC** car ils ont tendance √† avoir les r√©ponses les plus volumineuses.\
La mani√®re de **v√©rifier** si un DNS prend en charge la **r√©cursivit√©** est de requ√™ter un nom de domaine et de **v√©rifier** si le **drapeau "ra"** (_r√©cursivit√© disponible_) est dans la r√©ponse :
```bash
dig google.com A @<IP>
```
**Non disponible** :

![](<../.gitbook/assets/image (275).png>)

**Disponible** :

![](<../.gitbook/assets/image (276).png>)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation de la vuln√©rabilit√© et le pentesting**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au rapport. Nous ne rempla√ßons pas les pentesters - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, obtenir des acc√®s et s'amuser.

{% embed url="https://pentest-tools.com/" %}

### Courriel vers un compte inexistant

Extrait du livre : Network Security Assessment (3√®me √©dition)

Envoyer simplement un message √©lectronique √† une adresse inexistante dans un domaine cible r√©v√®le souvent des informations utiles sur le r√©seau interne via une _notification de non-distribution_ (NDN).
```
Generating server: noa.nintendo.com

blah@nintendo.com
#550 5.1.1 RESOLVER.ADR.RecipNotFound; not found ##

Original message headers:

Received: from ONERDEDGE02.one.nintendo.com (10.13.20.35) by
onerdexch08.one.nintendo.com (10.13.30.39) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Sat, 26 Apr 2014 16:52:22 -0700
Received: from barracuda.noa.nintendo.com (205.166.76.35) by
ONERDEDGE02.one.nintendo.com (10.13.20.35) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Sat, 26 Apr 2014 16:51:22 -0700
X-ASG-Debug-ID: 1398556333-0614671716199b0d0001-zOQ9WJ
Received: from gateway05.websitewelcome.com (gateway05.websitewelcome.com  [69.93.154.37]) by
barracuda.noa.nintendo.com with ESMTP id xVNPkwaqGgdyH5Ag for <blah@nintendo.com>; Sat,
26 Apr 2014 16:52:13 -0700 (PDT)
X-Barracuda-Envelope-From: chris@example.org
X-Barracuda-Apparent-Source-IP: 69.93.154.37
```
Les donn√©es suivantes dans ce transcript sont utiles :

* Noms d'h√¥tes internes, adresses IP et disposition des sous-domaines
* Le serveur de messagerie utilise Microsoft Exchange Server 2010 SP3
* Un appareil Barracuda Networks est utilis√© pour effectuer le filtrage de contenu

## Fichiers de configuration
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
Param√®tres dangereux lors de la configuration d'un serveur Bind :

| **Option**        | **Description**                                                                |
| ----------------- | ------------------------------------------------------------------------------ |
| `allow-query`     | D√©finit quels h√¥tes peuvent envoyer des requ√™tes au serveur DNS.               |
| `allow-recursion` | D√©finit quels h√¥tes peuvent envoyer des requ√™tes r√©cursives au serveur DNS.    |
| `allow-transfer`  | D√©finit quels h√¥tes peuvent recevoir des transferts de zone du serveur DNS.    |
| `zone-statistics` | Collecte des donn√©es statistiques des zones.                                   |

## Commandes Automatiques HackTricks
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for DNS
Note: |
#These are the commands I run every time I see an open DNS port

dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
dig axfr @{IP}
dig axfr {Domain_Name} @{IP}
nslookup
SERVER {IP}
127.0.0.1
{IP}
Domain_Name
exit

https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
Name: Banner Grab
Description: Grab DNS Banner
Command: dig version.bind CHAOS TXT @DNS

Entry_3:
Name: Nmap Vuln Scan
Description: Scan for Vulnerabilities with Nmap
Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
Name: Zone Transfer
Description: Three attempts at forcing a zone transfer
Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
Name: Active Directory
Description: Eunuerate a DC via DNS
Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"

Entry_6:
Name: consolesless mfs enumeration
Description: DNS enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit'
```
```markdown
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration imm√©diatement disponible pour l'√©valuation de la vuln√©rabilit√© et le pentesting**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au rapport. Nous ne rempla√ßons pas les pentesters - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur redonner du temps pour approfondir, obtenir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
