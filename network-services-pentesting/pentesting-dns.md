# 53 - Pentesting DNS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) avec plus d'une d√©cennie qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique de haut niveau o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence !:

{% embed url="https://www.dragonjarcon.org/" %}

## **Informations de base**

Le syst√®me de noms de domaine (DNS) est l'annuaire t√©l√©phonique d'Internet. Les humains acc√®dent aux informations en ligne via des noms de domaine, comme nytimes.com ou espn.com. Les navigateurs Web interagissent via des adresses de protocole Internet (IP). DNS traduit les noms de domaine en [adresses IP](https://www.cloudflare.com/learning/dns/glossary/what-is-my-ip-address/) afin que les navigateurs puissent charger les ressources Internet.\
√Ä partir de [ici](https://www.cloudflare.com/learning/dns/what-is-dns/).

**Port par d√©faut :** 53
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Diff√©rents serveurs DNS

Information de [https://academy.hackthebox.com/module/112/section/1069](https://academy.hackthebox.com/module/112/section/1069)

| **Type de serveur**             | **Description**                                                                                                                                                                                                                                                                                                                                                                                                                                                                          |
| ------------------------------ | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| `Serveur racine DNS`           | Les serveurs racine du DNS sont responsables des domaines de premier niveau (`TLD`). En tant que derni√®re instance, ils ne sont demand√©s que si le serveur de noms ne r√©pond pas. Ainsi, un serveur racine est une interface centrale entre les utilisateurs et le contenu sur Internet, car il relie le domaine et l'adresse IP. La [Corporation pour l'attribution des noms et des num√©ros sur Internet](https://www.icann.org/) (`ICANN`) coordonne le travail des serveurs de noms racine. Il y a `13` de ces serveurs racine dans le monde. |
| `Serveur de noms autoritaires` | Les serveurs de noms autoritaires ont l'autorit√© sur une zone particuli√®re. Ils ne r√©pondent qu'aux requ√™tes de leur zone de responsabilit√©, et leurs informations sont contraignantes. Si un serveur de noms autoritaire ne peut pas r√©pondre √† la requ√™te d'un client, le serveur de noms racine prend le relais √† ce moment-l√†.                                                                                                                                                                                                            |
| `Serveur de noms non autoritaires` | Les serveurs de noms non autoritaires ne sont pas responsables d'une zone DNS particuli√®re. Au lieu de cela, ils collectent eux-m√™mes des informations sur des zones DNS sp√©cifiques, ce qui est fait √† l'aide d'une requ√™te DNS r√©cursive ou it√©rative.                                                                                                                                                                                                                                                                               |
| `Serveur DNS de mise en cache` | Les serveurs DNS de mise en cache mettent en cache des informations provenant d'autres serveurs de noms pour une p√©riode sp√©cifi√©e. Le serveur de noms autoritaire d√©termine la dur√©e de ce stockage.                                                                                                                                                                                                                                                                                                                             |
| `Serveur de transfert`            | Les serveurs de transfert ne remplissent qu'une seule fonction : ils transf√®rent les requ√™tes DNS vers un autre serveur DNS.                                                                                                                                                                                                                                                                                                                                                                                            |
| `R√©solveur`                     | Les r√©solveurs ne sont pas des serveurs DNS autoritaires mais effectuent une r√©solution de noms localement dans l'ordinateur ou le routeur.                                                                                                                                                                                                                                                                                                                                                                               |

## √ânum√©ration

### **Banner Grabbing**

DNS n'a pas de "banni√®re" √† saisir. L'√©quivalent le plus proche est une requ√™te magique pour `version.bind. CHAOS TXT` qui fonctionnera sur la plupart des serveurs de noms BIND.\
Vous pouvez effectuer cette requ√™te en utilisant `dig`:
```bash
dig version.bind CHAOS TXT @DNS
```
Si cela ne fonctionne pas, vous pouvez utiliser des techniques de reconnaissance d'empreintes pour d√©terminer la version du serveur distant -- l'outil [`fpdns`](https://github.com/kirei/fpdns) est une option pour cela, mais il en existe d'autres.

Vous pouvez √©galement r√©cup√©rer la banni√®re avec un script **nmap** :
```
--script dns-nsid
```
### **Tout enregistrement**

L'enregistrement **ANY** demandera au serveur DNS de **retourner** toutes les **entr√©es** disponibles qu'il est pr√™t √† **divulguer**.
```bash
dig any victim.com @<DNS_IP>
```
### **Transfert de zone**

Cette proc√©dure est abr√©g√©e `Asynchronous Full Transfer Zone` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
Sure, what additional information do you need?
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Utilisation de nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### Modules utiles de Metasploit
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Scripts nmap utiles

#### dns-brute

Le script `dns-brute` est utilis√© pour effectuer une attaque de force brute sur les enregistrements DNS. Il peut √™tre utilis√© pour trouver des sous-domaines et des enregistrements DNS cach√©s.

#### dns-cache-snoop

Le script `dns-cache-snoop` est utilis√© pour effectuer une attaque de type cache poisoning sur les serveurs DNS. Il peut √™tre utilis√© pour obtenir des informations sur les enregistrements DNS et les sous-domaines.

#### dns-zone-transfer

Le script `dns-zone-transfer` est utilis√© pour effectuer une attaque de transfert de zone DNS. Il peut √™tre utilis√© pour obtenir une liste compl√®te des enregistrements DNS pour un domaine donn√©.

#### dns-random-srcport

Le script `dns-random-srcport` est utilis√© pour effectuer une attaque de type port source al√©atoire sur les serveurs DNS. Il peut √™tre utilis√© pour contourner les pare-feu et les syst√®mes de d√©tection d'intrusion.

#### dns-random-txid

Le script `dns-random-txid` est utilis√© pour effectuer une attaque de type ID de transaction al√©atoire sur les serveurs DNS. Il peut √™tre utilis√© pour contourner les pare-feu et les syst√®mes de d√©tection d'intrusion.
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Reverse BF

### DNS - Force brute invers√©
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
{% hint style="info" %}
Si vous √™tes capable de trouver des sous-domaines r√©solvant √† des adresses IP internes, vous devriez essayer d'effectuer une recherche invers√©e DNS sur les serveurs de noms du domaine en demandant cette plage d'adresses IP.
{% endhint %}

Un autre outil pour le faire : [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Vous pouvez interroger les plages d'adresses IP inverses sur [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#\_dns) (cet outil est √©galement utile avec BGP).

### DNS - Recherche de sous-domaines BF
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Serveurs Active Directory
```
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com
nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec

DNSSec (Domain Name System Security Extensions) est une extension de s√©curit√© pour le protocole DNS qui permet de garantir l'authenticit√© et l'int√©grit√© des donn√©es DNS. DNSSec utilise des signatures num√©riques pour v√©rifier l'origine des donn√©es DNS et s'assurer qu'elles n'ont pas √©t√© alt√©r√©es en transit. Les attaquants peuvent exploiter les vuln√©rabilit√©s de DNSSec pour effectuer des attaques de type "cache poisoning" ou "man-in-the-middle". Les testeurs de p√©n√©tration peuvent utiliser des outils tels que dnssec-tools pour √©valuer la s√©curit√© de l'impl√©mentation DNSSec d'un syst√®me.
```bash
 #Query paypal subdomains to ns3.isc-sns.info
 nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Force brute en utilisant des requ√™tes "AAAA" pour collecter les adresses IPv6 des sous-domaines.
```bash
dnsdict6 -s -t <domain>
```
# Bruteforce reverse DNS en utilisant des adresses IPv6

Le bruteforce de reverse DNS est une technique courante utilis√©e pour d√©couvrir des informations sur les adresses IP. Cette technique peut √™tre utilis√©e pour d√©couvrir des noms de domaine associ√©s √† des adresses IPv6.

## √âtape 1: G√©n√©rer une liste de noms de domaine

La premi√®re √©tape consiste √† g√©n√©rer une liste de noms de domaine possibles. Vous pouvez utiliser des outils tels que `cewl` ou `crunch` pour g√©n√©rer une liste de mots-cl√©s qui peuvent √™tre utilis√©s pour g√©n√©rer des noms de domaine.

## √âtape 2: Utiliser `nslookup` pour v√©rifier les noms de domaine

La deuxi√®me √©tape consiste √† utiliser `nslookup` pour v√©rifier si les noms de domaine g√©n√©r√©s sont valides. Vous pouvez utiliser la commande suivante pour v√©rifier un nom de domaine:

```
nslookup -type=PTR <adresse IPv6>
```

Si le nom de domaine est valide, `nslookup` renverra le nom de domaine associ√© √† l'adresse IPv6.

## √âtape 3: Automatiser le processus

Le processus de bruteforce peut √™tre automatis√© en utilisant des scripts tels que `dnsrevenum6` ou `ipv6-toolkit`. Ces scripts peuvent √™tre utilis√©s pour g√©n√©rer une liste de noms de domaine possibles et v√©rifier automatiquement si les noms de domaine sont valides en utilisant `nslookup`.

## Conclusion

Le bruteforce de reverse DNS peut √™tre une technique efficace pour d√©couvrir des informations sur les adresses IPv6. Cependant, il est important de noter que cette technique peut √™tre consid√©r√©e comme une attaque et peut √™tre ill√©gale sans autorisation pr√©alable.
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### DNS Recursion DDoS

Si la **r√©cursivit√© DNS est activ√©e**, un attaquant pourrait **usurper** l'**origine** du paquet UDP afin de faire **envoyer la r√©ponse DNS au serveur victime**. Un attaquant pourrait abuser des types d'enregistrements **ANY** ou **DNSSEC** car ils ont tendance √† avoir des r√©ponses plus importantes.\
La fa√ßon de **v√©rifier** si un DNS prend en charge la **r√©cursivit√©** est de consulter un nom de domaine et de **v√©rifier** si le drapeau "ra" (_r√©cursivit√© disponible_) est pr√©sent dans la r√©ponse :
```bash
dig google.com A @<IP>
```
**Non disponible**:

![](<../.gitbook/assets/image (275).png>)

**Disponible**:

![](<../.gitbook/assets/image (276).png>)

<figure><img src="../.gitbook/assets/image (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui a plus d'une d√©cennie et qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique √©lev√© o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence!:

{% embed url="https://www.dragonjarcon.org/" %}

### Envoi de courrier √† une adresse inexistante

Extrait du livre: Network Security Assessment (3√®me √©dition)

Le simple fait d'envoyer un message √©lectronique √† une adresse inexistante sur un domaine cible r√©v√®le souvent des informations utiles sur le r√©seau interne gr√¢ce √† une notification de non-livraison (NDN).
```
Generating server: noa.nintendo.com

blah@nintendo.com
#550 5.1.1 RESOLVER.ADR.RecipNotFound; not found ##

Original message headers:

Received: from ONERDEDGE02.one.nintendo.com (10.13.20.35) by
 onerdexch08.one.nintendo.com (10.13.30.39) with Microsoft SMTP Server (TLS)
 id 14.3.174.1; Sat, 26 Apr 2014 16:52:22 -0700
Received: from barracuda.noa.nintendo.com (205.166.76.35) by
 ONERDEDGE02.one.nintendo.com (10.13.20.35) with Microsoft SMTP Server (TLS)
 id 14.3.174.1; Sat, 26 Apr 2014 16:51:22 -0700
X-ASG-Debug-ID: 1398556333-0614671716199b0d0001-zOQ9WJ
Received: from gateway05.websitewelcome.com (gateway05.websitewelcome.com  [69.93.154.37]) by 
barracuda.noa.nintendo.com with ESMTP id xVNPkwaqGgdyH5Ag for <blah@nintendo.com>; Sat, 
26 Apr 2014 16:52:13 -0700 (PDT)
X-Barracuda-Envelope-From: chris@example.org
X-Barracuda-Apparent-Source-IP: 69.93.154.37
```
Les donn√©es suivantes dans cette transcription sont utiles :

* Noms d'h√¥tes internes, adresses IP et disposition des sous-domaines
* Le serveur de messagerie utilise Microsoft Exchange Server 2010 SP3
* Un dispositif Barracuda Networks est utilis√© pour effectuer la filtrage de contenu

## Fichiers de configuration
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
Param√®tres dangereux lors de la configuration d'un serveur Bind:

| **Option**        | **Description**                                                                |
| ----------------- | ------------------------------------------------------------------------------ |
| `allow-query`     | D√©finit les h√¥tes autoris√©s √† envoyer des requ√™tes au serveur DNS.            |
| `allow-recursion` | D√©finit les h√¥tes autoris√©s √† envoyer des requ√™tes r√©cursives au serveur DNS.  |
| `allow-transfer`  | D√©finit les h√¥tes autoris√©s √† recevoir des transferts de zone depuis le serveur DNS. |
| `zone-statistics` | Collecte des donn√©es statistiques sur les zones.                                            |

## Commandes automatiques HackTricks
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for DNS
  Note: |
    #These are the commands I run every time I see an open DNS port

    dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
    dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
    dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
    dig axfr @{IP}
    dig axfr {Domain_Name} @{IP}
    nslookup
        SERVER {IP}
        127.0.0.1
        {IP}
        Domain_Name
        exit

    https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
  Name: Banner Grab
  Description: Grab DNS Banner
  Command: dig version.bind CHAOS TXT @DNS

Entry_3:
  Name: Nmap Vuln Scan
  Description: Scan for Vulnerabilities with Nmap
  Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
  Name: Zone Transfer
  Description: Three attempts at forcing a zone transfer
  Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
  Name: Active Directory
  Description: Eunuerate a DC via DNS
  Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"
  
Entry_6:
  Name: consolesless mfs enumeration
  Description: DNS enumeration without the need to run msfconsole
  Note: sourced from https://github.com/carlospolop/legion
  Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit' 
```
<figure><img src="../.gitbook/assets/image (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

[**La Conf√©rence de s√©curit√© DragonJAR est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui a plus d'une d√©cennie et qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique de haut niveau o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence !:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
