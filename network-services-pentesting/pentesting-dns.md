# 53 - Kupima Usalama wa DNS

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

<figure><img src="../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Mazingira yanayopatikana mara moja kwa tathmini ya udhaifu & kupima usalama**. Tekeleza ukaguzi kamili wa usalama kutoka mahali popote na zana & vipengele zaidi ya 20 vinavyoanzia uchunguzi hadi ripoti. Hatuchukui nafasi ya wadukuzi - tuna
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Seva za DNS Tofauti

* **Seva za Mzizi wa DNS**: Hizi ziko juu kabisa mwa mfuatano wa DNS, zikisimamia uwanja wa juu kabisa na kuingilia tu ikiwa seva za viwango vya chini hazijibu. Shirika la Mtandao kwa Majina na Nambari (**ICANN**) linaangalia uendeshaji wao, na idadi ya kimataifa ni 13.
* **Seva za Mamlaka za Majina**: Seva hizi ndizo zinaamua mwisho kwa maswali katika maeneo yao yaliyotengwa, zikitoa majibu ya mwisho. Ikiwa hawawezi kutoa jibu, swali linapelekwa kwa seva za mzizi.
* **Seva Zisizo na Mamlaka za Majina**: Zisizo na umiliki wa maeneo ya DNS, seva hizi hukusanya habari za uwanja kupitia maswali kwa seva nyingine.
* **Seva ya Kuficha ya DNS**: Aina hii ya seva inakumbuka majibu ya maswali ya awali kwa muda uliowekwa ili kuharakisha majibu kwa maombi ya baadaye, na muda wa kuficha unadhibitiwa na seva ya mamlaka.
* **Seva ya Kuelekeza**: Kwa jukumu la moja kwa moja, seva za kuelekeza tu zinapeleka maswali kwa seva nyingine.
* **Mtatuzi**: Imeunganishwa ndani ya kompyuta au rutuba, watauzi hutekeleza ufumbuzi wa jina kwa kienyeji na haziangaliwi kuwa na mamlaka.

## Uthibitishaji

### **Kukamata Bango**

Hakuna mabango katika DNS lakini unaweza kukamata swali la kichawi kwa `version.bind. CHAOS TXT` ambalo litafanya kazi kwa seva nyingi za BIND.\
Unaweza kufanya swali hili kwa kutumia `dig`:
```bash
dig version.bind CHAOS TXT @DNS
```
Zaidi ya hayo, zana [`fpdns`](https://github.com/kirei/fpdns) inaweza pia kutambua alama ya seva.

Pia ni rahisi kunasa bango pia na script ya **nmap**:
```
--script dns-nsid
```
### **Rekodi yoyote**

Rekodi ya **ANY** itaomba **server ya DNS** kutoa **masharti yote** yanayopatikana ambayo **inakubali kufichua**.
```bash
dig any victim.com @<DNS_IP>
```
### **Uhamisho wa Eneo**

Mchakato huu unaitwa `Uhamisho Kamili wa Eneo la Asynchronous` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
### Maelezo zaidi
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Kiotomatiki
```bash
for sub in $(cat <WORDLIST>);do dig $sub.<DOMAIN> @<DNS_IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver <DNS_IP> --enum -p 0 -s 0 -o subdomains.txt -f <WORDLIST> <DOMAIN>
```
#### Kutumia nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### Moduli muhimu ya metasploit
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Skripti za nmap Zinazoweza Kusaidia
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Reverse BF
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
{% hint style="info" %}
Ikiwa unaweza kupata subdomains zinazotatuliwa kwa anwani za IP za ndani, unapaswa kujaribu kufanya reverse dns BF kwa NSs ya kikoa ukiuliza kwa safu hiyo ya IP.
{% endhint %}

Chombo kingine cha kufanya hivyo: [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Unaweza kuuliza safu za IP za reverse kwa [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#\_dns) (chombo hiki pia ni muhimu na BGP).

### DNS - Subdomains BF
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Seva za Active Directory
```bash
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com

nslookup -type=srv _kerberos._tcp.<CLIENT_DOMAIN>
nslookup -type=srv _kerberos._tcp.domain.com

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec

DNSSec ni itifaki inayotumiwa kuhakikisha usalama na uaminifu wa data ya DNS kwa kusaini data ya DNS na kutumia vyeti vya dijiti.
```bash
#Query paypal subdomains to ns3.isc-sns.info
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Kutumia nguvu kubwa kwa kutumia maombi ya "AAAA" kukusanya IPv6 za subdomains.
```bash
dnsdict6 -s -t <domain>
```
### Kufanya nguvu ya bruteforce kwenye DNS ya nyuma kwa kutumia anwani za IPv6

Kufanya nguvu ya bruteforce kwenye DNS ya nyuma kwa kutumia anwani za IPv6 inaweza kufanywa kwa kutumia zana kama `dnsrecon` au `dnsenum`. Unaweza kujaribu kubaini majina ya uwanja yanayolingana na anwani za IPv6 kwa kufanya majaribio ya kiotomatiki. Hii inaweza kusaidia kugundua majina ya uwanja yaliyofichwa au yaliyolindwa kwa njia fulani.
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### DNS Recursion DDoS

Ikiwa **DNS recursion imewezeshwa**, mshambuliaji anaweza **kughushi** asili kwenye pakiti ya UDP ili kufanya **DNS itume jibu kwa seva ya mwathiriwa**. Mshambuliaji anaweza kutumia rekodi za **ANY** au **DNSSEC** kwani zina majibu makubwa zaidi.\
Njia ya **kuangalia** ikiwa DNS inasaidia **recursion** ni kuuliza jina la kikoa na **kuangalia** ikiwa **alama "ra"** (_recursion inapatikana_) iko kwenye jibu:
```bash
dig google.com A @<IP>
```
**Hakipatikani**:

![](<../.gitbook/assets/image (275).png>)

**Inapatikana**:

![](<../.gitbook/assets/image (276).png>)

<figure><img src="../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Usanidi wa haraka wa upimaji wa hatari & uchunguzi wa kuingilia kati**. Tekeleza pentest kamili kutoka mahali popote na zana na vipengele zaidi ya 20 vinavyoanzia uchunguzi hadi ripoti. Hatuchukui nafasi ya wapimaji wa pentest - tuna
```markdown
The original message headers were modified for anonymity and now present randomized data:

Generating server: server.example.com

user@example.com
#550 5.1.1 RESOLVER.ADR.RecipNotFound; not found ##

Original message headers:

Received: from MAILSERVER01.domain.example.com (192.168.1.1) by
mailserver02.domain.example.com (192.168.2.2) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Mon, 25 May 2015 14:52:22 -0700
Received: from filter.example.com (203.0.113.1) by
MAILSERVER01.domain.example.com (192.168.1.1) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Mon, 25 May 2015 14:51:22 -0700
X-ASG-Debug-ID: 1432576343-0614671716190e0d0001-zOQ9WJ
Received: from gateway.domainhost.com (gateway.domainhost.com [198.51.100.37]) by
filter.example.com with ESMTP id xVNPkwaqGgdyH5Ag for user@example.com; Mon,
25 May 2015 14:52:13 -0700 (PDT)
X-Envelope-From: sender@anotherdomain.org
X-Apparent-Source-IP: 198.51.100.37
```
## Faili za Mipangilio
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
Mipangilio hatari wakati wa kusanidi seva ya Bind:

| **Chaguo**        | **Maelezo**                                                                |
| ----------------- | ------------------------------------------------------------------------------ |
| `allow-query`     | Inaainisha ni mwenyeji gani wanaruhusiwa kutuma maombi kwa seva ya DNS.            |
| `allow-recursion` | Inaainisha ni mwenyeji gani wanaruhusiwa kutuma maombi ya kurudia kwa seva ya DNS.  |
| `allow-transfer`  | Inaainisha ni mwenyeji gani wanaruhusiwa kupokea uhamisho wa eneo kutoka kwa seva ya DNS. |
| `zone-statistics` | Inakusanya data za takwimu za maeneo.                                            |

## Marejeo

* [https://www.myrasecurity.com/en/knowledge-hub/dns/](https://www.myrasecurity.com/en/knowledge-hub/dns/)
* Kitabu: **Uthibitishaji wa Usalama wa Mtandao toleo la 3**
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for DNS
Note: |
#These are the commands I run every time I see an open DNS port

dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
dig axfr @{IP}
dig axfr {Domain_Name} @{IP}
nslookup
SERVER {IP}
127.0.0.1
{IP}
Domain_Name
exit

https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
Name: Banner Grab
Description: Grab DNS Banner
Command: dig version.bind CHAOS TXT @DNS

Entry_3:
Name: Nmap Vuln Scan
Description: Scan for Vulnerabilities with Nmap
Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
Name: Zone Transfer
Description: Three attempts at forcing a zone transfer
Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
Name: Active Directory
Description: Eunuerate a DC via DNS
Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"

Entry_6:
Name: consolesless mfs enumeration
Description: DNS enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit'
```
<figure><img src="../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Mipangilio inapatikana mara moja kwa tathmini ya udhaifu na upenyezaji**. Tekeleza pentest kamili kutoka popote ukiwa na zana na vipengele zaidi ya 20 vinavyoanzia uchunguzi hadi ripoti. Hatuchukui nafasi ya wapimaji wa pentest - tunatengeneza zana za desturi, moduli za ugunduzi na uvamizi ili kuwapa muda wa kuchimba kwa kina, kufungua makasha, na kufurahi.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana katika HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
