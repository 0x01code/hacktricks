# 53 - Pentesting DNS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et les tests de p√©n√©tration**. Ex√©cutez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au reporting. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur donner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

## **Informations de base**

Le **Syst√®me de noms de domaine (DNS)** sert de r√©pertoire de l'internet, permettant aux utilisateurs d'acc√©der aux sites web via des **noms de domaine faciles √† retenir** comme google.com ou facebook.com, au lieu des adresses num√©riques du Protocole Internet (IP). En traduisant les noms de domaine en adresses IP, le DNS garantit que les navigateurs web peuvent charger rapidement les ressources internet, simplifiant ainsi notre navigation dans le monde en ligne.

**Port par d√©faut:** 53
```
PORT     STATE SERVICE  REASON
53/tcp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
5353/udp open  zeroconf udp-response
53/udp   open  domain  Microsoft DNS 6.1.7601 (1DB15D39) (Windows Server 2008 R2 SP1)
```
### Diff√©rents serveurs DNS

- **Serveurs racine DNS**: Ils se trouvent en haut de la hi√©rarchie DNS, g√©rant les domaines de premier niveau et intervenant uniquement si les serveurs de niveaux inf√©rieurs ne r√©pondent pas. La Corporation Internet pour les noms et num√©ros attribu√©s (**ICANN**) supervise leur fonctionnement, avec un total mondial de 13 serveurs.

- **Serveurs de noms autoritaires**: Ces serveurs ont le dernier mot pour les requ√™tes dans leurs zones d√©sign√©es, offrant des r√©ponses d√©finitives. S'ils ne peuvent pas fournir de r√©ponse, la requ√™te est renvoy√©e aux serveurs racine.

- **Serveurs de noms non autoritaires**: Ne poss√©dant pas de zones DNS, ces serveurs recueillent des informations de domaine via des requ√™tes √† d'autres serveurs.

- **Serveur DNS en cache**: Ce type de serveur m√©morise les r√©ponses aux requ√™tes pr√©c√©dentes pendant un certain temps pour acc√©l√©rer les temps de r√©ponse pour les futures demandes, la dur√©e du cache √©tant dict√©e par le serveur autoritaire.

- **Serveur de transfert**: Jouant un r√¥le simple, les serveurs de transfert se contentent de relayer les requ√™tes vers un autre serveur.

- **R√©solveur**: Int√©gr√©s dans les ordinateurs ou routeurs, les r√©solveurs ex√©cutent la r√©solution de noms localement et ne sont pas consid√©r√©s comme autoritaires.


## √ânum√©ration

### **Capture de banni√®re**

Il n'y a pas de banni√®res dans les DNS, mais vous pouvez capturer la requ√™te magique pour `version.bind. CHAOS TXT` qui fonctionnera sur la plupart des serveurs de noms BIND.\
Vous pouvez effectuer cette requ√™te en utilisant `dig`:
```bash
dig version.bind CHAOS TXT @DNS
```
De plus, l'outil [`fpdns`](https://github.com/kirei/fpdns) peut √©galement identifier le serveur.

Il est √©galement possible de r√©cup√©rer la banni√®re avec un script **nmap** :
```
--script dns-nsid
```
### **Tout enregistrement**

L'enregistrement **ANY** demandera au serveur DNS de **retourner** toutes les **entr√©es** disponibles qu'**il est pr√™t √† divulguer**.
```bash
dig any victim.com @<DNS_IP>
```
### **Transfert de zone**

Cette proc√©dure est abr√©g√©e `Transfert de zone complet asynchrone` (`AXFR`).
```bash
dig axfr @<DNS_IP> #Try zone transfer without domain
dig axfr @<DNS_IP> <DOMAIN> #Try zone transfer guessing the domain
fierce --domain <DOMAIN> --dns-servers <DNS_IP> #Will try toperform a zone transfer against every authoritative name server and if this doesn'twork, will launch a dictionary attack
```
### Plus d'informations
```bash
dig ANY @<DNS_IP> <DOMAIN>     #Any information
dig A @<DNS_IP> <DOMAIN>       #Regular DNS request
dig AAAA @<DNS_IP> <DOMAIN>    #IPv6 DNS request
dig TXT @<DNS_IP> <DOMAIN>     #Information
dig MX @<DNS_IP> <DOMAIN>      #Emails related
dig NS @<DNS_IP> <DOMAIN>      #DNS that resolves that name
dig -x 192.168.0.2 @<DNS_IP>   #Reverse lookup
dig -x 2a00:1450:400c:c06::93 @<DNS_IP> #reverse IPv6 lookup

#Use [-p PORT]  or  -6 (to use ivp6 address of dns)
```
#### Automatisation
```bash
for sub in $(cat <WORDLIST>);do dig $sub.<DOMAIN> @<DNS_IP> | grep -v ';\|SOA' | sed -r '/^\s*$/d' | grep $sub | tee -a subdomains.txt;done

dnsenum --dnsserver <DNS_IP> --enum -p 0 -s 0 -o subdomains.txt -f <WORDLIST> <DOMAIN>
```
#### Utilisation de nslookup
```bash
nslookup
> SERVER <IP_DNS> #Select dns server
> 127.0.0.1 #Reverse lookup of 127.0.0.1, maybe...
> <IP_MACHINE> #Reverse lookup of a machine, maybe...
```
### Modules Metasploit utiles
```bash
auxiliary/gather/enum_dns #Perform enumeration actions
```
### Scripts nmap utiles
```bash
#Perform enumeration actions
nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" <IP>
```
### DNS - Reverse BF
```bash
dnsrecon -r 127.0.0.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r 127.0.1.0/24 -n <IP_DNS>  #DNS reverse of all of the addresses
dnsrecon -r <IP_DNS>/24 -n <IP_DNS>   #DNS reverse of all of the addresses
dnsrecon -d active.htb -a -n <IP_DNS> #Zone transfer
```
{% hint style="info" %}
Si vous parvenez √† trouver des sous-domaines r√©solvant vers des adresses IP internes, vous devriez essayer d'effectuer une recherche DNS inverse sur les serveurs de noms du domaine en demandant cette plage d'adresses IP.
{% endhint %}

Un autre outil pour le faire : [https://github.com/amine7536/reverse-scan](https://github.com/amine7536/reverse-scan)

Vous pouvez interroger des plages IP inverses sur [https://bgp.he.net/net/205.166.76.0/24#\_dns](https://bgp.he.net/net/205.166.76.0/24#\_dns) (cet outil est √©galement utile avec BGP).

### DNS - Recherche de sous-domaines BF
```bash
dnsenum --dnsserver <IP_DNS> --enum -p 0 -s 0 -o subdomains.txt -f subdomains-1000.txt <DOMAIN>
dnsrecon -D subdomains-1000.txt -d <DOMAIN> -n <IP_DNS>
dnscan -d <domain> -r -w subdomains-1000.txt #Bruteforce subdomains in recursive way, https://github.com/rbsec/dnscan
```
### Serveurs Active Directory
```bash
dig -t _gc._tcp.lab.domain.com
dig -t _ldap._tcp.lab.domain.com
dig -t _kerberos._tcp.lab.domain.com
dig -t _kpasswd._tcp.lab.domain.com

nslookup -type=srv _kerberos._tcp.<CLIENT_DOMAIN>
nslookup -type=srv _kerberos._tcp.domain.com

nmap --script dns-srv-enum --script-args "dns-srv-enum.domain='domain.com'"
```
### DNSSec
```bash
#Query paypal subdomains to ns3.isc-sns.info
nmap -sSU -p53 --script dns-nsec-enum --script-args dns-nsec-enum.domains=paypal.com ns3.isc-sns.info
```
### IPv6

Forcer en utilisant des requ√™tes "AAAA" pour recueillir les adresses IPv6 des sous-domaines.
```bash
dnsdict6 -s -t <domain>
```
Bruteforce reverse DNS in using IPv6 addresses

---

### Introduction

In IPv6 networks, reverse DNS lookup is performed by querying the PTR records in the `ip6.arpa` domain. To bruteforce reverse DNS for IPv6 addresses, you can use tools like `dnsrecon` or `dnsenum`.

### Steps to Bruteforce Reverse DNS for IPv6 Addresses

1. **Generate IPv6 Address List**: Create a list of IPv6 addresses to bruteforce reverse DNS.

2. **Perform Reverse DNS Bruteforce**: Use a tool like `dnsrecon` with the `-t rvl` flag to bruteforce reverse DNS for the IPv6 addresses.

   ```bash
   dnsrecon -t rvl -r ipv6.txt
   ```

3. **Analyze Results**: Analyze the results to identify any misconfigurations or potential security issues in the reverse DNS setup.

### Conclusion

Bruteforcing reverse DNS for IPv6 addresses can help identify misconfigured or vulnerable DNS setups in an IPv6 network. It is essential to regularly perform such tests to ensure the security and integrity of the DNS infrastructure.
```bash
dnsrevenum6 pri.authdns.ripe.net 2001:67c:2e8::/48 #Will use the dns pri.authdns.ripe.net
```
### Attaque DDoS de r√©cursion DNS

Si la **r√©cursion DNS est activ√©e**, un attaquant pourrait **usurper** l'**origine** du paquet UDP afin de faire en sorte que le **DNS envoie la r√©ponse au serveur victime**. Un attaquant pourrait abuser des types d'enregistrements **ANY** ou **DNSSEC** car ils ont tendance √† avoir des r√©ponses plus volumineuses.\
La mani√®re de **v√©rifier** si un DNS prend en charge la **r√©cursion** est d'interroger un nom de domaine et de **v√©rifier** si le drapeau "ra" (_r√©cursion disponible_) est pr√©sent dans la r√©ponse:
```bash
dig google.com A @<IP>
```
**Non disponible**:

![](<../.gitbook/assets/image (275).png>)

**Disponible**:

![](<../.gitbook/assets/image (276).png>)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©e disponible pour l'√©valuation des vuln√©rabilit√©s et les tests de p√©n√©tration**. Ex√©cutez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance aux rapports. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur permettre de gagner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

### Envoi d'un e-mail √† un compte inexistant

En examinant une notification de non-distribution (NDN) d√©clench√©e par un e-mail envoy√© √† une adresse invalide dans un domaine cible, des d√©tails pr√©cieux sur le r√©seau interne sont souvent divulgu√©s.

Le rapport de non-distribution fourni comprend des informations telles que :

- Le serveur g√©n√©rateur a √©t√© identifi√© comme `server.example.com`.
- Un avis d'√©chec pour `user@example.com` avec le code d'erreur `#550 5.1.1 RESOLVER.ADR.RecipNotFound; not found` a √©t√© renvoy√©.
- Des adresses IP internes et des noms d'h√¥tes ont √©t√© divulgu√©s dans les en-t√™tes du message d'origine.
```markdown
The original message headers were modified for anonymity and now present randomized data:

Generating server: server.example.com

user@example.com
#550 5.1.1 RESOLVER.ADR.RecipNotFound; not found ##

Original message headers:

Received: from MAILSERVER01.domain.example.com (192.168.1.1) by
mailserver02.domain.example.com (192.168.2.2) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Mon, 25 May 2015 14:52:22 -0700
Received: from filter.example.com (203.0.113.1) by
MAILSERVER01.domain.example.com (192.168.1.1) with Microsoft SMTP Server (TLS)
id 14.3.174.1; Mon, 25 May 2015 14:51:22 -0700
X-ASG-Debug-ID: 1432576343-0614671716190e0d0001-zOQ9WJ
Received: from gateway.domainhost.com (gateway.domainhost.com [198.51.100.37]) by
filter.example.com with ESMTP id xVNPkwaqGgdyH5Ag for user@example.com; Mon,
25 May 2015 14:52:13 -0700 (PDT)
X-Envelope-From: sender@anotherdomain.org
X-Apparent-Source-IP: 198.51.100.37
```
## Fichiers de configuration
```
host.conf
/etc/resolv.conf
/etc/bind/named.conf
/etc/bind/named.conf.local
/etc/bind/named.conf.options
/etc/bind/named.conf.log
/etc/bind/*
```
| **Option**        | **Description**                                                                |
| ----------------- | ------------------------------------------------------------------------------ |
| `allow-query`     | D√©finit quels h√¥tes sont autoris√©s √† envoyer des requ√™tes au serveur DNS.     |
| `allow-recursion` | D√©finit quels h√¥tes sont autoris√©s √† envoyer des requ√™tes r√©cursives au serveur DNS. |
| `allow-transfer`  | D√©finit quels h√¥tes sont autoris√©s √† recevoir des transferts de zone du serveur DNS. |
| `zone-statistics` | Collecte des donn√©es statistiques sur les zones.                               |

## R√©f√©rences
* [https://www.myrasecurity.com/en/knowledge-hub/dns/](https://www.myrasecurity.com/en/knowledge-hub/dns/)
* Livre : **Network Security Assessment 3rd edition**
```
Protocol_Name: DNS    #Protocol Abbreviation if there is one.
Port_Number:  53     #Comma separated if there is more than one.
Protocol_Description: Domain Name Service        #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for DNS
Note: |
#These are the commands I run every time I see an open DNS port

dnsrecon -r 127.0.0.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r 127.0.1.0/24 -n {IP} -d {Domain_Name}
dnsrecon -r {Network}{CIDR} -n {IP} -d {Domain_Name}
dig axfr @{IP}
dig axfr {Domain_Name} @{IP}
nslookup
SERVER {IP}
127.0.0.1
{IP}
Domain_Name
exit

https://book.hacktricks.xyz/pentesting/pentesting-dns

Entry_2:
Name: Banner Grab
Description: Grab DNS Banner
Command: dig version.bind CHAOS TXT @DNS

Entry_3:
Name: Nmap Vuln Scan
Description: Scan for Vulnerabilities with Nmap
Command: nmap -n --script "(default and *dns*) or fcrdns or dns-srv-enum or dns-random-txid or dns-random-srcport" {IP}

Entry_4:
Name: Zone Transfer
Description: Three attempts at forcing a zone transfer
Command: dig axfr @{IP} && dix axfr @{IP} {Domain_Name} && fierce --dns-servers {IP} --domain {Domain_Name}


Entry_5:
Name: Active Directory
Description: Eunuerate a DC via DNS
Command: dig -t _gc._{Domain_Name} && dig -t _ldap._{Domain_Name} && dig -t _kerberos._{Domain_Name} && dig -t _kpasswd._{Domain_Name} && nmap --script dns-srv-enum --script-args "dns-srv-enum.domain={Domain_Name}"

Entry_6:
Name: consolesless mfs enumeration
Description: DNS enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/dns/dns_amp; set RHOSTS {IP}; set RPORT 53; run; exit' && msfconsole -q -x 'use auxiliary/gather/enum_dns; set RHOSTS {IP}; set RPORT 53; run; exit'
```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©e disponible pour l'√©valuation des vuln√©rabilit√©s et les tests de p√©n√©tration**. Ex√©cutez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance aux rapports. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur donner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
