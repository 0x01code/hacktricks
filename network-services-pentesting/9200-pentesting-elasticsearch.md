# 9200 - Pentesting Elasticsearch

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Depuis la [page principale](https://www.elastic.co/what-is/elasticsearch), vous pouvez trouver des descriptions utiles :

> Elasticsearch est un moteur de recherche et d'analyse distribu√© et open source pour tous types de donn√©es, y compris textuelles, num√©riques, g√©ospatiales, structur√©es et non structur√©es. Elasticsearch est construit sur Apache Lucene et a √©t√© lanc√© pour la premi√®re fois en 2010 par Elasticsearch N.V. (maintenant connu sous le nom d'Elastic). Connu pour ses API REST simples, sa nature distribu√©e, sa vitesse et sa scalabilit√©, Elasticsearch est le composant central de l'Elastic Stack, un ensemble d'outils open source pour l'ingestion, l'enrichissement, le stockage, l'analyse et la visualisation des donn√©es. Commun√©ment appel√© ELK Stack (apr√®s Elasticsearch, Logstash et Kibana), l'Elastic Stack comprend maintenant une riche collection d'agents d'exp√©dition l√©gers connus sous le nom de Beats pour envoyer des donn√©es √† Elasticsearch.

### Qu'est-ce qu'un index Elasticsearch ?

Un _index_ Elasticsearch **est une collection de documents** qui sont li√©s les uns aux autres. Elasticsearch stocke les donn√©es sous forme de documents JSON. Chaque document met en corr√©lation un ensemble de _cl√©s_ (noms de champs ou propri√©t√©s) avec leurs valeurs correspondantes (cha√Ænes, nombres, bool√©ens, dates, tableaux de _valeurs_, g√©olocalisations ou autres types de donn√©es).

Elasticsearch utilise une structure de donn√©es appel√©e _index invers√©_, qui est con√ßue pour permettre des recherches en texte int√©gral tr√®s rapides. Un index invers√© r√©pertorie chaque mot unique apparaissant dans un document et identifie tous les documents dans lesquels chaque mot se trouve.

Pendant le processus d'indexation, Elasticsearch stocke les documents et construit un index invers√© pour rendre les donn√©es des documents recherchables en quasi temps r√©el. L'indexation est initi√©e avec l'API d'index, √† travers laquelle vous pouvez ajouter ou mettre √† jour un document JSON dans un index sp√©cifique.

**Port par d√©faut** : 9200/tcp

## √ânum√©ration manuelle

### Banni√®re

Le protocole utilis√© pour acc√©der √† Elasticsearch est **HTTP**. Lorsque vous y acc√©dez via HTTP, vous trouverez des informations int√©ressantes : `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Si vous ne voyez pas cette r√©ponse en acc√©dant √† `/`, consultez la section suivante.

### Authentification

**Par d√©faut, Elasticsearch n'a pas l'authentification activ√©e**, donc par d√©faut, vous pouvez acc√©der √† tout √† l'int√©rieur de la base de donn√©es sans utiliser d'identifiants.

Vous pouvez v√©rifier que l'authentification est d√©sactiv√©e avec une requ√™te √† :
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Cependant**, si vous envoyez une requ√™te √† `/` et recevez une r√©ponse comme celle-ci :
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Cela signifie que l'authentification est configur√©e et **vous avez besoin de identifiants valides** pour obtenir des informations d'Elasticsearch. Ensuite, vous pouvez [**essayer de le forcer par bruteforce**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (il utilise l'authentification de base HTTP, donc tout ce qui peut bruteforcer l'authentification de base HTTP peut √™tre utilis√©).\
Voici une **liste de noms d'utilisateur par d√©faut** : _**elastic** (superutilisateur), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Les anciennes versions d'Elasticsearch ont le mot de passe par d√©faut **changeme** pour cet utilisateur
```
curl -X GET http://user:password@IP:9200/
```
### √ânum√©ration Basique des Utilisateurs
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Informations sur Elastic

Voici quelques points de terminaison auxquels vous pouvez **acc√©der via GET** pour **obtenir** des **informations** sur elasticsearch :

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Ces points de terminaison ont √©t√© [**pris de la documentation**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) o√π vous pouvez **trouver plus**.\
De plus, si vous acc√©dez √† `/_cat`, la r√©ponse contiendra les points de terminaison `/_cat/*` pris en charge par l'instance.

Dans `/_security/user` (si l'authentification est activ√©e), vous pouvez voir quel utilisateur a le r√¥le `superuser`.

### Indices

Vous pouvez **rassembler tous les indices** en acc√©dant √† `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Pour obtenir **des informations sur le type de donn√©es enregistr√©es dans un index**, vous pouvez acc√©der √† : `http://host:9200/<index>`, par exemple dans ce cas `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Extraire l'index

Si vous souhaitez **extraire tout le contenu** d'un index, vous pouvez acc√©der √† : `http://host:9200/<index>/_search?pretty=true` comme `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_Prenez un moment pour comparer le contenu de chaque document (entr√©e) √† l'int√©rieur de l'index de la banque et les champs de cet index que nous avons vus dans la section pr√©c√©dente._

√Ä ce stade, vous remarquerez qu'il y a **un champ appel√© "total" √† l'int√©rieur de "hits"** qui indique que **1000 documents ont √©t√© trouv√©s** dans cet index, mais seulement 10 ont √©t√© r√©cup√©r√©s. Cela est d√ª au fait que **par d√©faut, il y a une limite de 10 documents**.\
Mais, maintenant que vous savez que **cet index contient 1000 documents**, vous pouvez **les extraire tous** en indiquant le nombre d'entr√©es que vous souhaitez extraire dans le param√®tre **`size`** : `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
_Remarque : Si vous indiquez un nombre plus grand, toutes les entr√©es seront quand m√™me extraites, par exemple vous pourriez indiquer `size=9999` et ce serait √©trange s'il y avait plus d'entr√©es (mais vous devriez v√©rifier)._

### Extraire tout

Pour tout extraire, vous pouvez simplement aller au **m√™me chemin qu'avant mais sans indiquer d'index** `http://host:9200/_search?pretty=true` comme `http://10.10.10.115:9200/_search?pretty=true`\
Rappelez-vous que dans ce cas, la **limite par d√©faut de 10** r√©sultats sera appliqu√©e. Vous pouvez utiliser le param√®tre `size` pour extraire un **plus grand nombre de r√©sultats**. Lisez la section pr√©c√©dente pour plus d'informations.

### Recherche

Si vous recherchez des informations, vous pouvez effectuer une **recherche brute sur tous les indices** en allant √† `http://host:9200/_search?pretty=true&q=<search_term>` comme dans `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Si vous souhaitez juste **rechercher dans un index**, vous pouvez simplement le **sp√©cifier** dans le **chemin** : `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Remarquez que le param√®tre q utilis√© pour rechercher le contenu **prend en charge les expressions r√©guli√®res**_

Vous pouvez √©galement utiliser quelque chose comme [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) pour fuzz un service elasticsearch.

### Permissions d'√©criture

Vous pouvez v√©rifier vos permissions d'√©criture en essayant de cr√©er un nouveau document dans un nouvel index en ex√©cutant quelque chose comme ce qui suit :
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
{
"bookId" : "A00-3",
"author" : "Sankaran",
"publisher" : "Mcgrahill",
"name" : "how to get a job"
}'
```
Cette commande va cr√©er un **nouvel index** appel√© `bookindex` avec un document de type `books` qui poss√®de les attributs "_bookId_", "_author_", "_publisher_" et "_name_"

Remarquez comment le **nouvel index appara√Æt maintenant dans la liste** :

![](<../.gitbook/assets/image (268).png>)

Et notez les **propri√©t√©s cr√©√©es automatiquement** :

![](<../.gitbook/assets/image (269).png>)

## √ânum√©ration Automatique

Certains outils obtiendront certaines des donn√©es pr√©sent√©es pr√©c√©demment :
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
```markdown
{% embed url="https://github.com/theMiddleBlue/nmap-elasticsearch-nse" %}

## Shodan

* `port:9200 elasticsearch`

<details>

<summary><strong>Apprenez le hacking AWS du d√©butant √† l'expert avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
