# 9200 - Teste de penetra√ß√£o no Elasticsearch

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Informa√ß√µes b√°sicas

Na [p√°gina principal](https://www.elastic.co/what-is/elasticsearch) voc√™ pode encontrar algumas descri√ß√µes √∫teis:

> Elasticsearch √© um mecanismo de busca e an√°lise distribu√≠do e de c√≥digo aberto para todos os tipos de dados, incluindo dados textuais, num√©ricos, geoespaciais, estruturados e n√£o estruturados. O Elasticsearch √© constru√≠do sobre o Apache Lucene e foi lan√ßado pela primeira vez em 2010 pela Elasticsearch N.V. (agora conhecida como Elastic). Conhecido por suas APIs REST simples, natureza distribu√≠da, velocidade e escalabilidade, o Elasticsearch √© o componente central do Elastic Stack, um conjunto de ferramentas de c√≥digo aberto para ingest√£o, enriquecimento, armazenamento, an√°lise e visualiza√ß√£o de dados. Comumente referido como ELK Stack (depois de Elasticsearch, Logstash e Kibana), o Elastic Stack agora inclui uma rica cole√ß√£o de agentes de envio leves conhecidos como Beats para enviar dados para o Elasticsearch.

### O que √© um √≠ndice Elasticsearch?

Um _√≠ndice_ do Elasticsearch **√© uma cole√ß√£o de documentos** que est√£o relacionados entre si. O Elasticsearch armazena dados como documentos JSON. Cada documento correlaciona um conjunto de _chaves_ (nomes de campos ou propriedades) com seus valores correspondentes (strings, n√∫meros, Booleans, datas, matrizes de _valores_, geolocaliza√ß√µes ou outros tipos de dados).

O Elasticsearch usa uma estrutura de dados chamada _√≠ndice invertido_, que √© projetada para permitir pesquisas de texto completo muito r√°pidas. Um √≠ndice invertido lista cada palavra √∫nica que aparece em qualquer documento e identifica todos os documentos em que cada palavra ocorre.

Durante o processo de indexa√ß√£o, o Elasticsearch armazena documentos e constr√≥i um √≠ndice invertido para tornar os dados do documento pesquis√°veis em tempo quase real. A indexa√ß√£o √© iniciada com a API de √≠ndice, por meio da qual voc√™ pode adicionar ou atualizar um documento JSON em um √≠ndice espec√≠fico.

**Porta padr√£o**: 9200/tcp

## Enumera√ß√£o manual

### Banner

O protocolo usado para acessar o Elasticsearch √© **HTTP**. Quando voc√™ acessa via HTTP, encontrar√° algumas informa√ß√µes interessantes: `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Se voc√™ n√£o vir essa resposta acessando `/`, consulte a seguinte se√ß√£o.

### Autentica√ß√£o

**Por padr√£o, o Elasticsearch n√£o tem autentica√ß√£o habilitada**, portanto, por padr√£o, voc√™ pode acessar tudo dentro do banco de dados sem usar credenciais.

Voc√™ pode verificar se a autentica√ß√£o est√° desativada com uma solicita√ß√£o para:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**No entanto**, se voc√™ enviar uma solicita√ß√£o para `/` e receber uma resposta como a seguinte:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Isso significa que a autentica√ß√£o est√° configurada e **voc√™ precisa de credenciais v√°lidas** para obter qualquer informa√ß√£o do Elasticsearch. Ent√£o, voc√™ pode [**tentar fazer brute force**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (ele usa autentica√ß√£o b√°sica HTTP, ent√£o qualquer coisa que fa√ßa brute force em autentica√ß√£o b√°sica HTTP pode ser usada).\
Aqui voc√™ tem uma **lista de nomes de usu√°rio padr√£o**: _**elastic** (superusu√°rio), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Vers√µes mais antigas do Elasticsearch t√™m a senha padr√£o **changeme** para este usu√°rio.
```
curl -X GET http://user:password@IP:9200/
```
### Enumera√ß√£o B√°sica de Usu√°rios
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Informa√ß√µes do Elastic

Aqui est√£o alguns endpoints que voc√™ pode **acessar via GET** para **obter** algumas **informa√ß√µes** sobre o Elasticsearch:

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Esses endpoints foram [**retirados da documenta√ß√£o**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) onde voc√™ pode **encontrar mais**.\
Al√©m disso, se voc√™ acessar `/_cat`, a resposta conter√° os endpoints `/_cat/*` suportados pela inst√¢ncia.

Em `/_security/user` (se a autentica√ß√£o estiver habilitada), voc√™ pode ver qual usu√°rio tem a fun√ß√£o `superuser`.

### √çndices

Voc√™ pode **reunir todos os √≠ndices** acessando `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Para obter informa√ß√µes sobre que tipo de dados s√£o salvos em um √≠ndice, voc√™ pode acessar: `http://host:9200/<index>` como, por exemplo, neste caso `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Despejar √≠ndice

Se voc√™ quiser **despejar todo o conte√∫do** de um √≠ndice, voc√™ pode acessar: `http://host:9200/<index>/_search?pretty=true` como `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_Dedique um momento para comparar o conte√∫do de cada documento (entrada) dentro do √≠ndice bank e os campos deste √≠ndice que vimos na se√ß√£o anterior._

Ent√£o, neste ponto, voc√™ pode notar que **h√° um campo chamado "total" dentro de "hits"** que indica que **1000 documentos foram encontrados** dentro deste √≠ndice, mas apenas 10 foram recuperados. Isso ocorre porque **por padr√£o h√° um limite de 10 documentos**.\
Mas, agora que voc√™ sabe que **este √≠ndice cont√©m 1000 documentos**, voc√™ pode **despejar todos eles** indicando o n√∫mero de entradas que deseja despejar no par√¢metro **`size`**: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`asd\
_Observa√ß√£o: Se voc√™ indicar um n√∫mero maior, todas as entradas ser√£o despejadas de qualquer maneira, por exemplo, voc√™ poderia indicar `size=9999` e seria estranho se houvesse mais entradas (mas voc√™ deve verificar)._

### Despejar tudo

Para despejar tudo, voc√™ pode simplesmente ir para o **mesmo caminho que antes, mas sem indicar nenhum √≠ndice** `http://host:9200/_search?pretty=true` como `http://10.10.10.115:9200/_search?pretty=true`\
Lembre-se de que, neste caso, o **limite padr√£o de 10** resultados ser√° aplicado. Voc√™ pode usar o par√¢metro `size` para despejar uma **quantidade maior de resultados**. Leia a se√ß√£o anterior para obter mais informa√ß√µes.

### Pesquisa

Se voc√™ est√° procurando por alguma informa√ß√£o, pode fazer uma **pesquisa bruta em todos os √≠ndices** indo para `http://host:9200/_search?pretty=true&q=<search_term>` como em `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Se voc√™ quiser apenas **pesquisar em um √≠ndice**, pode apenas **especific√°-lo** no **caminho**: `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Obsere que o par√¢metro q usado para pesquisar conte√∫do **suporta express√µes regulares**_

Voc√™ tamb√©m pode usar algo como [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) para fuzz um servi√ßo elasticsearch.

### Permiss√µes de escrita

Voc√™ pode verificar suas permiss√µes de escrita tentando criar um novo documento dentro de um novo √≠ndice executando algo como o seguinte:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
 {
    "bookId" : "A00-3",
    "author" : "Sankaran",
    "publisher" : "Mcgrahill",
    "name" : "how to get a job"
 }'
```
Esse comando ir√° criar um **novo √≠ndice** chamado `bookindex` com um documento do tipo `books` que tem os atributos "_bookId_", "_author_", "_publisher_" e "_name_"

Observe como o **novo √≠ndice aparece agora na lista**:

![](<../.gitbook/assets/image (268).png>)

E observe as **propriedades criadas automaticamente**:

![](<../.gitbook/assets/image (269).png>)

## Enumera√ß√£o Autom√°tica

Algumas ferramentas obter√£o alguns dos dados apresentados anteriormente:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
## Shodan

* `port:9200 elasticsearch`

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
