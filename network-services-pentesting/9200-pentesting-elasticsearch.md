# 9200 - Pentesting Elasticsearch

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Informaci√≥n b√°sica

Desde la [p√°gina principal](https://www.elastic.co/what-is/elasticsearch) se pueden encontrar algunas descripciones √∫tiles:

> Elasticsearch es un motor de b√∫squeda y an√°lisis distribuido y de c√≥digo abierto para todo tipo de datos, incluidos los textuales, num√©ricos, geoespaciales, estructurados y no estructurados. Elasticsearch est√° construido sobre Apache Lucene y fue lanzado por primera vez en 2010 por Elasticsearch N.V. (ahora conocido como Elastic). Conocido por sus sencillas API REST, su naturaleza distribuida, velocidad y escalabilidad, Elasticsearch es el componente central de Elastic Stack, un conjunto de herramientas de c√≥digo abierto para la ingesti√≥n, enriquecimiento, almacenamiento, an√°lisis y visualizaci√≥n de datos. Com√∫nmente conocido como ELK Stack (por Elasticsearch, Logstash y Kibana), Elastic Stack ahora incluye una rica colecci√≥n de agentes de env√≠o ligeros conocidos como Beats para enviar datos a Elasticsearch.

### ¬øQu√© es un √≠ndice de Elasticsearch?

Un _√≠ndice_ de Elasticsearch **es una colecci√≥n de documentos** que est√°n relacionados entre s√≠. Elasticsearch almacena los datos como documentos JSON. Cada documento correlaciona un conjunto de _claves_ (nombres de campos o propiedades) con sus valores correspondientes (cadenas, n√∫meros, booleanos, fechas, matrices de _valores_, geolocalizaciones u otros tipos de datos).

Elasticsearch utiliza una estructura de datos llamada _√≠ndice invertido_, que est√° dise√±ada para permitir b√∫squedas de texto completo muy r√°pidas. Un √≠ndice invertido lista cada palabra √∫nica que aparece en cualquier documento e identifica todos los documentos en los que aparece cada palabra.

Durante el proceso de indexaci√≥n, Elasticsearch almacena documentos y construye un √≠ndice invertido para hacer que los datos del documento sean buscables en tiempo real. La indexaci√≥n se inicia con la API de √≠ndice, a trav√©s de la cual se puede agregar o actualizar un documento JSON en un √≠ndice espec√≠fico.

**Puerto predeterminado**: 9200/tcp

## Enumeraci√≥n manual

### Banner

El protocolo utilizado para acceder a Elasticsearch es **HTTP**. Cuando se accede a √©l a trav√©s de HTTP, se encontrar√° informaci√≥n interesante: `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Si no se ve esa respuesta al acceder a `/`, consulte la siguiente secci√≥n.

### Autenticaci√≥n

**Por defecto, Elasticsearch no tiene la autenticaci√≥n habilitada**, por lo que por defecto se puede acceder a todo lo que hay dentro de la base de datos sin usar credenciales.

Se puede verificar que la autenticaci√≥n est√° deshabilitada con una solicitud a:
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Sin embargo**, si env√≠as una solicitud a `/` y recibes una respuesta como la siguiente:
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Esto significa que la autenticaci√≥n est√° configurada y **necesitas credenciales v√°lidas** para obtener cualquier informaci√≥n de Elasticsearch. Entonces, puedes [**intentar hacer fuerza bruta**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (usa autenticaci√≥n b√°sica HTTP, por lo que cualquier cosa que haga fuerza bruta en autenticaci√≥n b√°sica HTTP puede ser utilizada).\
Aqu√≠ tienes una **lista de nombres de usuario predeterminados**: _**elastic** (superusuario), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Las versiones antiguas de Elasticsearch tienen la contrase√±a predeterminada **changeme** para este usuario.
```
curl -X GET http://user:password@IP:9200/
```
### Enumeraci√≥n b√°sica de usuarios
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Informaci√≥n de Elastic

Aqu√≠ hay algunos puntos finales a los que puedes **acceder mediante GET** para **obtener** informaci√≥n sobre Elasticsearch:

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Estos puntos finales fueron [**tomados de la documentaci√≥n**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) donde puedes **encontrar m√°s**.\
Adem√°s, si accedes a `/_cat`, la respuesta contendr√° los puntos finales `/_cat/*` soportados por la instancia.

En `/_security/user` (si la autenticaci√≥n est√° habilitada) puedes ver qu√© usuario tiene el rol de `superuser`.

### √çndices

Puedes **obtener todos los √≠ndices** accediendo a `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Para obtener **informaci√≥n sobre qu√© tipo de datos se guardan dentro de un √≠ndice**, puedes acceder a: `http://host:9200/<√≠ndice>` como en este ejemplo `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Volcar √≠ndice

Si deseas **volcar todo el contenido** de un √≠ndice, puedes acceder a: `http://host:9200/<√≠ndice>/_search?pretty=true` como en `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_T√≥mate un momento para comparar el contenido de cada documento (entrada) dentro del √≠ndice bank y los campos de este √≠ndice que vimos en la secci√≥n anterior._

Entonces, en este punto, puedes notar que **hay un campo llamado "total" dentro de "hits"** que indica que **se encontraron 1000 documentos** dentro de este √≠ndice, pero solo se recuperaron 10. Esto se debe a que **por defecto hay un l√≠mite de 10 documentos**.\
Pero, ahora que sabes que **este √≠ndice contiene 1000 documentos**, puedes **volcarlos todos** indicando el n√∫mero de entradas que deseas volcar en el par√°metro **`size`**: `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`\
_Nota: Si indicas un n√∫mero mayor, todas las entradas se volcar√°n de todos modos, por ejemplo, podr√≠as indicar `size=9999` y ser√≠a extra√±o si hubiera m√°s entradas (pero deber√≠as verificar)._

### Volcar todo

Para volcar todo, simplemente puedes ir a la **misma ruta que antes pero sin indicar ning√∫n √≠ndice** `http://host:9200/_search?pretty=true` como en `http://10.10.10.115:9200/_search?pretty=true`\
Recuerda que en este caso se aplicar√° el **l√≠mite predeterminado de 10** resultados. Puedes usar el par√°metro `size` para volcar una **mayor cantidad de resultados**. Lee la secci√≥n anterior para obtener m√°s informaci√≥n.

### B√∫squeda

Si est√°s buscando informaci√≥n, puedes hacer una **b√∫squeda en bruto en todos los √≠ndices** yendo a `http://host:9200/_search?pretty=true&q=<t√©rmino_de_b√∫squeda>` como en `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Si solo deseas **buscar en un √≠ndice**, simplemente **especifica** en la **ruta**: `http://host:9200/<√≠ndice>/_search?pretty=true&q=<t√©rmino_de_b√∫squeda>`

_Nota que el par√°metro q utilizado para buscar contenido **admite expresiones regulares**_

Tambi√©n puedes usar algo como [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) para fuzzear un servicio de Elasticsearch.

### Permisos de escritura

Puedes verificar tus permisos de escritura intentando crear un nuevo documento dentro de un nuevo √≠ndice ejecutando algo como lo siguiente:
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
 {
    "bookId" : "A00-3",
    "author" : "Sankaran",
    "publisher" : "Mcgrahill",
    "name" : "how to get a job"
 }'
```
Esa cmd crear√° un **nuevo √≠ndice** llamado `bookindex` con un documento de tipo `books` que tiene los atributos "_bookId_", "_author_", "_publisher_" y "_name_"

Observe c√≥mo el **nuevo √≠ndice aparece ahora en la lista**:

![](<../.gitbook/assets/image (268).png>)

Y observe las **propiedades creadas autom√°ticamente**:

![](<../.gitbook/assets/image (269).png>)

## Enumeraci√≥n Autom√°tica

Algunas herramientas obtendr√°n algunos de los datos presentados anteriormente:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
## Shodan

* `port:9200 elasticsearch`

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
