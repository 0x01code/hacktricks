# 9200 - Pentesting Elasticsearch

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Informations de base

√Ä partir de la [page principale](https://www.elastic.co/what-is/elasticsearch), vous pouvez trouver des descriptions utiles :

> Elasticsearch est un moteur de recherche et d'analyse distribu√© et open source pour tous les types de donn√©es, y compris textuelles, num√©riques, g√©ospatiales, structur√©es et non structur√©es. Elasticsearch est construit sur Apache Lucene et a √©t√© publi√© pour la premi√®re fois en 2010 par Elasticsearch N.V. (maintenant connu sous le nom d'Elastic). Connu pour ses API REST simples, sa nature distribu√©e, sa rapidit√© et sa scalabilit√©, Elasticsearch est le composant central de l'Elastic Stack, un ensemble d'outils open source pour l'ingestion, l'enrichissement, le stockage, l'analyse et la visualisation de donn√©es. Commun√©ment appel√© ELK Stack (apr√®s Elasticsearch, Logstash et Kibana), Elastic Stack comprend maintenant une riche collection d'agents d'exp√©dition l√©gers appel√©s Beats pour l'envoi de donn√©es √† Elasticsearch.

### Qu'est-ce qu'un index Elasticsearch ?

Un _index_ Elasticsearch **est une collection de documents** qui sont li√©s les uns aux autres. Elasticsearch stocke les donn√©es sous forme de documents JSON. Chaque document corr√®le un ensemble de _cl√©s_ (noms de champs ou de propri√©t√©s) avec leurs valeurs correspondantes (cha√Ænes, nombres, bool√©ens, dates, tableaux de _valeurs_, g√©olocalisations ou autres types de donn√©es).

Elasticsearch utilise une structure de donn√©es appel√©e _index invers√©_, con√ßue pour permettre des recherches de texte int√©gral tr√®s rapides. Un index invers√© r√©pertorie chaque mot unique qui appara√Æt dans n'importe quel document et identifie tous les documents dans lesquels chaque mot appara√Æt.

Pendant le processus d'indexation, Elasticsearch stocke les documents et construit un index invers√© pour rendre les donn√©es du document interrogeables en temps quasi r√©el. L'indexation est initi√©e avec l'API d'index, par laquelle vous pouvez ajouter ou mettre √† jour un document JSON dans un index sp√©cifique.

**Port par d√©faut** : 9200/tcp

## √ânum√©ration manuelle

### Banni√®re

Le protocole utilis√© pour acc√©der √† Elasticsearch est **HTTP**. Lorsque vous y acc√©dez via HTTP, vous trouverez des informations int√©ressantes : `http://10.10.10.115:9200/`

![](<../.gitbook/assets/image (264).png>)

Si vous ne voyez pas cette r√©ponse en acc√©dant √† `/`, voir la section suivante.

### Authentification

**Par d√©faut, Elasticsearch n'a pas d'authentification activ√©e**, donc par d√©faut, vous pouvez acc√©der √† tout ce qui se trouve dans la base de donn√©es sans utiliser de cr√©dentials.

Vous pouvez v√©rifier que l'authentification est d√©sactiv√©e avec une requ√™te √† :
```bash
curl -X GET "ELASTICSEARCH-SERVER:9200/_xpack/security/user"
{"error":{"root_cause":[{"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."}],"type":"exception","reason":"Security must be explicitly enabled when using a [basic] license. Enable security by setting [xpack.security.enabled] to [true] in the elasticsearch.yml file and restart the node."},"status":500}
```
**Cependant**, si vous envoyez une requ√™te √† `/` et que vous recevez une r√©ponse comme celle-ci :
```bash
{"error":{"root_cause":[{"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}}],"type":"security_exception","reason":"missing authentication credentials for REST request [/]","header":{"WWW-Authenticate":"Basic realm=\"security\" charset=\"UTF-8\""}},"status":401}
```
Cela signifie que l'authentification est configur√©e et que **vous avez besoin de valides identifiants** pour obtenir des informations √† partir d'Elasticsearch. Ensuite, vous pouvez [**essayer de le bruteforcer**](../generic-methodologies-and-resources/brute-force.md#elasticsearch) (il utilise l'authentification de base HTTP, donc tout ce qui peut bruteforcer l'authentification de base HTTP peut √™tre utilis√©).\
Voici une **liste des noms d'utilisateur par d√©faut** : _**elastic** (superutilisateur), remote\_monitoring\_user, beats\_system, logstash\_system, kibana, kibana\_system, apm\_system,_ \_anonymous\_.\_ Les anciennes versions d'Elasticsearch ont le mot de passe par d√©faut **changeme** pour cet utilisateur.
```
curl -X GET http://user:password@IP:9200/
```
### √ânum√©ration de base des utilisateurs

Pour commencer, nous pouvons utiliser la m√©thode GET pour r√©cup√©rer la liste des index disponibles sur Elasticsearch. Pour cela, nous pouvons envoyer une requ√™te GET √† l'URL `http://<IP>:9200/_cat/indices?v`. Cela nous donnera une liste des index disponibles sur le serveur Elasticsearch.

Ensuite, nous pouvons utiliser la m√©thode GET pour r√©cup√©rer la liste des documents dans un index sp√©cifique. Pour cela, nous pouvons envoyer une requ√™te GET √† l'URL `http://<IP>:9200/<nom_de_l'index>/_search?size=1000`. Cela nous donnera une liste des 1000 premiers documents dans l'index sp√©cifi√©.

Enfin, nous pouvons utiliser la m√©thode GET pour r√©cup√©rer les d√©tails d'un document sp√©cifique. Pour cela, nous pouvons envoyer une requ√™te GET √† l'URL `http://<IP>:9200/<nom_de_l'index>/_doc/<ID_du_document>`. Cela nous donnera les d√©tails du document sp√©cifi√©.
```bash
#List all roles on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/role"

#List all users on the system:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user"

#Get more information about the rights of an user:
curl -X GET "ELASTICSEARCH-SERVER:9200/_security/user/<USERNAME>"
```
### Informations sur Elastic

Voici quelques points d'acc√®s que vous pouvez **obtenir via GET** pour **obtenir** des **informations** sur Elasticsearch :

| \_cat                           | /\_cluster                    | /\_security               |
| ------------------------------- | ----------------------------- | ------------------------- |
| /\_cat/segments                 | /\_cluster/allocation/explain | /\_security/user          |
| /\_cat/shards                   | /\_cluster/settings           | /\_security/privilege     |
| /\_cat/repositories             | /\_cluster/health             | /\_security/role\_mapping |
| /\_cat/recovery                 | /\_cluster/state              | /\_security/role          |
| /\_cat/plugins                  | /\_cluster/stats              | /\_security/api\_key      |
| /\_cat/pending\_tasks           | /\_cluster/pending\_tasks     |                           |
| /\_cat/nodes                    | /\_nodes                      |                           |
| /\_cat/tasks                    | /\_nodes/usage                |                           |
| /\_cat/templates                | /\_nodes/hot\_threads         |                           |
| /\_cat/thread\_pool             | /\_nodes/stats                |                           |
| /\_cat/ml/trained\_models       | /\_tasks                      |                           |
| /\_cat/transforms/\_all         | /\_remote/info                |                           |
| /\_cat/aliases                  |                               |                           |
| /\_cat/allocation               |                               |                           |
| /\_cat/ml/anomaly\_detectors    |                               |                           |
| /\_cat/count                    |                               |                           |
| /\_cat/ml/data\_frame/analytics |                               |                           |
| /\_cat/ml/datafeeds             |                               |                           |
| /\_cat/fielddata                |                               |                           |
| /\_cat/health                   |                               |                           |
| /\_cat/indices                  |                               |                           |
| /\_cat/master                   |                               |                           |
| /\_cat/nodeattrs                |                               |                           |
| /\_cat/nodes                    |                               |                           |

Ces points d'acc√®s ont √©t√© [**pris √† partir de la documentation**](https://www.elastic.co/guide/en/elasticsearch/reference/current/rest-apis.html) o√π vous pouvez **en trouver plus**.\
De plus, si vous acc√©dez √† `/_cat`, la r√©ponse contiendra les points d'acc√®s `/_cat/*` pris en charge par l'instance.

Dans `/_security/user` (si l'authentification est activ√©e), vous pouvez voir quel utilisateur a le r√¥le de `superuser`.

### Indices

Vous pouvez **rassembler tous les indices** en acc√©dant √† `http://10.10.10.115:9200/_cat/indices?v`
```
health status index   uuid                   pri rep docs.count docs.deleted store.size pri.store.size
green  open   .kibana 6tjAYZrgQ5CwwR0g6VOoRg   1   0          1            0        4kb            4kb
yellow open   quotes  ZG2D1IqkQNiNZmi2HRImnQ   5   1        253            0    262.7kb        262.7kb
yellow open   bank    eSVpNfCfREyYoVigNWcrMw   5   1       1000            0    483.2kb        483.2kb
```
Pour obtenir des informations sur le type de donn√©es stock√©es dans un index, vous pouvez acc√©der √† : `http://host:9200/<index>` par exemple dans ce cas `http://10.10.10.115:9200/bank`

![](<../.gitbook/assets/image (265).png>)

### Dump de l'index

Si vous voulez **dump tous les contenus** d'un index, vous pouvez acc√©der √† : `http://host:9200/<index>/_search?pretty=true` comme `http://10.10.10.115:9200/bank/_search?pretty=true`

![](<../.gitbook/assets/image (266).png>)

_Prenez un moment pour comparer le contenu de chaque document (entr√©e) √† l'int√©rieur de l'index bancaire et les champs de cet index que nous avons vus dans la section pr√©c√©dente._

Ainsi, √† ce stade, vous pouvez remarquer qu'il y a un champ appel√© "total" √† l'int√©rieur de "hits" qui indique que **1000 documents ont √©t√© trouv√©s** √† l'int√©rieur de cet index mais seulement 10 ont √©t√© r√©cup√©r√©s. C'est parce que **par d√©faut, il y a une limite de 10 documents**.\
Mais maintenant que vous savez que **cet index contient 1000 documents**, vous pouvez **dump tous les documents** en indiquant le nombre d'entr√©es que vous voulez dans le param√®tre **`size`** : `http://10.10.10.115:9200/quotes/_search?pretty=true&size=1000`\
_Remarque : Si vous indiquez un nombre plus grand, toutes les entr√©es seront quand m√™me dump√©es, par exemple vous pourriez indiquer `size=9999` et ce serait √©trange s'il y avait plus d'entr√©es (mais vous devriez v√©rifier)._

### Dump de tout

Pour tout dump, vous pouvez simplement aller sur le **m√™me chemin qu'avant mais sans indiquer aucun index** `http://host:9200/_search?pretty=true` comme `http://10.10.10.115:9200/_search?pretty=true`\
Rappelez-vous que dans ce cas, la **limite par d√©faut de 10** r√©sultats sera appliqu√©e. Vous pouvez utiliser le param√®tre `size` pour dump une **plus grande quantit√© de r√©sultats**. Lisez la section pr√©c√©dente pour plus d'informations.

### Recherche

Si vous cherchez des informations, vous pouvez faire une **recherche brute sur tous les index** en allant √† `http://host:9200/_search?pretty=true&q=<search_term>` comme dans `http://10.10.10.115:9200/_search?pretty=true&q=Rockwell`

![](<../.gitbook/assets/image (267).png>)

Si vous voulez simplement **chercher dans un index**, vous pouvez simplement le **sp√©cifier** sur le **chemin** : `http://host:9200/<index>/_search?pretty=true&q=<search_term>`

_Remarquez que le param√®tre q utilis√© pour rechercher le contenu **prend en charge les expressions r√©guli√®res**_

Vous pouvez √©galement utiliser quelque chose comme [https://github.com/misalabs/horuz](https://github.com/misalabs/horuz) pour fuzz un service elasticsearch.

### Permissions d'√©criture

Vous pouvez v√©rifier vos permissions d'√©criture en essayant de cr√©er un nouveau document dans un nouvel index en ex√©cutant quelque chose comme ce qui suit :
```bash
curl -X POST '10.10.10.115:9200/bookindex/books' -H 'Content-Type: application/json' -d'
 {
    "bookId" : "A00-3",
    "author" : "Sankaran",
    "publisher" : "Mcgrahill",
    "name" : "how to get a job"
 }'
```
Cette commande va cr√©er un **nouvel index** appel√© `bookindex` avec un document de type `books` qui a les attributs "_bookId_", "_author_", "_publisher_" et "_name_"

Remarquez comment le **nouvel index appara√Æt maintenant dans la liste**:

![](<../.gitbook/assets/image (268).png>)

Et notez les **propri√©t√©s cr√©√©es automatiquement**:

![](<../.gitbook/assets/image (269).png>)

## √ânum√©ration automatique

Certains outils obtiendront certaines des donn√©es pr√©sent√©es pr√©c√©demment:
```bash
msf > use auxiliary/scanner/elasticsearch/indices_enum
```
## Shodan

* `port:9200 elasticsearch`

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
