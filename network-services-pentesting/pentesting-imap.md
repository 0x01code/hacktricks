# 143,993 - IMAP Pentesting

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) **및** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **github 저장소에 PR을 제출**하세요.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

가장 중요한 취약점을 찾아서 더 빠르게 수정하세요. Intruder는 공격 표면을 추적하고 적극적인 위협 스캔을 실행하여 API부터 웹 앱 및 클라우드 시스템까지 전체 기술 스택에서 문제를 찾습니다. [**무료로 시도해보세요**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) 오늘.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## 인터넷 메시지 액세스 프로토콜

**인터넷 메시지 액세스 프로토콜 (IMAP)**은 사용자가 **어떤 위치에서든 이메일 메시지에 액세스**할 수 있도록 설계되었습니다. 주로 인터넷 연결을 통해 이메일이 **개인 장치에 다운로드되고 저장되는 대신 서버에 보관**됩니다. 이는 이메일이 액세스되거나 읽힐 때 **직접 서버에서** 이루어진다는 것을 의미합니다. 이 기능을 통해 **다양한 장치**에서 이메일을 확인할 수 있어 어떤 장치를 사용하더라도 메시지를 놓치지 않을 수 있습니다.

IMAP 프로토콜은 기본적으로 두 개의 포트에서 작동합니다:

* **포트 143** - 기본 IMAP 비암호화 포트입니다.
* **포트 993** - IMAP을 안전하게 연결하려면 사용해야 하는 포트입니다.
```
PORT    STATE SERVICE REASON
143/tcp open  imap    syn-ack
```
## 배너 그랩핑

배너 그랩핑은 네트워크 서비스 펜테스팅에서 사용되는 기술 중 하나입니다. 이 기술은 원격 서버에 연결하여 서비스의 배너 정보를 획득하는 것을 의미합니다. 배너 정보에는 서비스의 버전, 운영 체제, 패치 수준 등이 포함될 수 있습니다. 이 정보는 해커가 서비스의 취약점을 파악하고 악용하는 데 도움이 될 수 있습니다.

배너 그랩핑은 다양한 도구를 사용하여 수행할 수 있습니다. 일반적으로 Telnet, Netcat, Nmap 등의 도구를 사용합니다. 이러한 도구를 사용하여 서비스에 연결하고, 서비스가 응답하는 배너 정보를 확인할 수 있습니다.

배너 그랩핑은 서비스의 취약점을 식별하는 데 중요한 역할을 합니다. 서비스의 버전이나 운영 체제의 취약점은 이미 알려진 취약점으로 분류되어 있을 수 있습니다. 따라서 배너 그랩핑을 통해 이러한 정보를 얻으면, 해당 취약점을 악용하여 시스템에 침투할 수 있습니다.

배너 그랩핑은 펜테스터가 시스템을 평가하고 보안 취약점을 식별하는 데 도움이 되는 강력한 도구입니다. 그러나 이 기술을 사용할 때는 합법적인 목적으로 사용해야 하며, 권한이 있는 시스템에만 적용해야 합니다.
```bash
nc -nv <IP> 143
openssl s_client -connect <IP>:993 -quiet
```
### NTLM 인증 - 정보 노출

서버가 NTLM 인증 (Windows)을 지원하는 경우 민감한 정보 (버전)를 얻을 수 있습니다:
```
root@kali: telnet example.com 143
* OK The Microsoft Exchange IMAP4 service is ready.
>> a1 AUTHENTICATE NTLM
+
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
또는 **nmap** 플러그인 `imap-ntlm-info.nse`를 사용하여 이를 **자동화**할 수 있습니다.

### [IMAP 브루트포스](../generic-methodologies-and-resources/brute-force.md#imap)

## 구문

[여기](https://donsutherland.org/crib/imap)에서 IAMP 명령어 예제를 참조하세요.
```
Login
A1 LOGIN username password
Values can be quoted to enclose spaces and special characters. A " must then be escape with a \
A1 LOGIN "username" "password"

List Folders/Mailboxes
A1 LIST "" *
A1 LIST INBOX *
A1 LIST "Archive" *

Create new Folder/Mailbox
A1 CREATE INBOX.Archive.2012
A1 CREATE "To Read"

Delete Folder/Mailbox
A1 DELETE INBOX.Archive.2012
A1 DELETE "To Read"

Rename Folder/Mailbox
A1 RENAME "INBOX.One" "INBOX.Two"

List Subscribed Mailboxes
A1 LSUB "" *

Status of Mailbox (There are more flags than the ones listed)
A1 STATUS INBOX (MESSAGES UNSEEN RECENT)

Select a mailbox
A1 SELECT INBOX

List messages
A1 FETCH 1:* (FLAGS)
A1 UID FETCH 1:* (FLAGS)

Retrieve Message Content
A1 FETCH 2 body[text]
A1 FETCH 2 all
A1 UID FETCH 102 (UID RFC822.SIZE BODY.PEEK[])

Close Mailbox
A1 CLOSE

Logout
A1 LOGOUT
```
### 진화

IMAP (Internet Message Access Protocol)은 전자 메일 클라이언트가 원격 서버에 저장된 이메일에 액세스할 수 있도록 하는 프로토콜입니다. IMAP은 POP3와 달리 이메일을 서버에 유지하므로 여러 기기에서 동기화할 수 있습니다. IMAP은 다양한 기능을 제공하며, 이메일을 읽고 쓰는 데 사용되는 주요 프로토콜 중 하나입니다.

IMAP 서버는 일반적으로 143번 포트를 사용하여 통신합니다. 그러나 SSL/TLS를 사용하는 경우 993번 포트를 사용할 수도 있습니다. IMAP 서버는 클라이언트의 요청에 따라 이메일을 검색, 다운로드, 삭제, 이동 등의 작업을 수행합니다.

IMAP 서버는 다양한 인증 메커니즘을 지원합니다. 가장 일반적인 인증 방법은 사용자 이름과 비밀번호를 사용하는 "PLAIN" 인증입니다. 그러나 IMAP 서버는 "CRAM-MD5", "DIGEST-MD5", "NTLM" 등과 같은 다른 인증 방법도 지원할 수 있습니다.

IMAP 서버는 일반적으로 다양한 보안 기능을 제공합니다. SSL/TLS를 사용하여 통신을 암호화하고, 사용자 인증을 위해 안전한 인증 메커니즘을 사용할 수 있습니다. 그러나 IMAP 서버는 취약점을 가질 수도 있으며, 악의적인 사용자가 서버에 대한 액세스를 얻을 수 있습니다.

IMAP 서버를 펜테스팅할 때는 다양한 기술과 도구를 사용하여 취약점을 식별하고 악용할 수 있습니다. 이를 통해 시스템의 보안을 강화하고 잠재적인 위협으로부터 안전한 이메일 통신을 보장할 수 있습니다.
```
apt install evolution
```
![](<../.gitbook/assets/image (528).png>)

### CURL

기본적인 탐색은 [CURL](https://ec.haxx.se/usingcurl/usingcurl-reademail#imap)을 사용하여 가능하지만, 문서는 자세한 내용에 대해 자세히 설명하지 않으므로 정확한 세부 정보를 확인하기 위해 [소스](https://github.com/curl/curl/blob/master/lib/imap.c)를 확인하는 것이 좋습니다.

1. 메일함 목록 표시 (imap 명령 `LIST "" "*"`)
```bash
curl -k 'imaps://1.2.3.4/' --user user:pass
```
2. 메일박스에서 메시지 목록 나열하기 (imap 명령어 `SELECT INBOX` 그리고 `SEARCH ALL`)

```bash
curl -k 'imaps://1.2.3.4/INBOX?ALL' --user user:pass
```

The result of this search is a list of message indicies.

Its also possible to provide more complex search terms. e.g. searching for drafts with password in mail body:

```bash
```markdown
# IMAP 서비스 펜테스팅

## IMAP 서비스란?
IMAP(Internet Message Access Protocol)은 이메일 클라이언트가 원격 이메일 서버에 접속하여 이메일을 관리하는 프로토콜입니다. IMAP 서비스는 이메일을 읽고 쓰는 등 다양한 작업을 수행할 수 있도록 해줍니다.

## IMAP 서비스 펜테스팅
IMAP 서비스를 펜테스팅하기 위해서는 다양한 기법을 사용할 수 있습니다. 그 중 하나는 인증 정보 노출 취약점을 이용하는 것입니다.

### 인증 정보 노출 취약점
인증 정보 노출 취약점은 서비스에 로그인하기 위해 필요한 사용자 이름과 비밀번호 등의 정보가 노출되는 취약점입니다. 이 취약점을 이용하면 공격자는 해당 서비스에 로그인하여 권한을 획득할 수 있습니다.

### IMAP 서비스 펜테스팅 예시
다음은 IMAP 서비스 펜테스팅의 예시입니다.

```bash
curl -k 'imaps://1.2.3.4/Drafts?TEXT password' --user user:pass
```

위 명령어는 IMAP 서버에 접속하여 `Drafts` 폴더에서 `password`라는 텍스트를 가져오는 것입니다. `--user` 옵션을 사용하여 사용자 이름과 비밀번호를 지정할 수 있습니다.
```
```html
<p>IMAP 서비스 펜테스팅</p>

<h2>IMAP 서비스란?</h2>

<p>IMAP(Internet Message Access Protocol)은 이메일 클라이언트가 원격 이메일 서버에 접속하여 이메일을 관리하는 프로토콜입니다. IMAP 서비스는 이메일을 읽고 쓰는 등 다양한 작업을 수행할 수 있도록 해줍니다.</p>

<h2>IMAP 서비스 펜테스팅</h2>

<p>IMAP 서비스를 펜테스팅하기 위해서는 다양한 기법을 사용할 수 있습니다. 그 중 하나는 인증 정보 노출 취약점을 이용하는 것입니다.</p>

<h3>인증 정보 노출 취약점</h3>

<p>인증 정보 노출 취약점은 서비스에 로그인하기 위해 필요한 사용자 이름과 비밀번호 등의 정보가 노출되는 취약점입니다. 이 취약점을 이용하면 공격자는 해당 서비스에 로그인하여 권한을 획득할 수 있습니다.</p>

<h3>IMAP 서비스 펜테스팅 예시</h3>

<p>다음은 IMAP 서비스 펜테스팅의 예시입니다.</p>

<pre><code class="language-bash">curl -k 'imaps://1.2.3.4/Drafts?TEXT password' --user user:pass
</code></pre>

<p>위 명령어는 IMAP 서버에 접속하여 <code>Drafts</code> 폴더에서 <code>password</code>라는 텍스트를 가져오는 것입니다. <code>--user</code> 옵션을 사용하여 사용자 이름과 비밀번호를 지정할 수 있습니다.</p>
```
```

A nice overview of the search terms possible is located [here](https://www.atmail.com/blog/imap-commands/).

3.  Downloading a message (imap command `SELECT Drafts` and then `FETCH 1 BODY[]`)

```bash
```markdown
curl -k 'imaps://1.2.3.4/Drafts;MAILINDEX=1' --user user:pass
```

위 명령은 `imaps` 프로토콜을 사용하여 IP 주소가 `1.2.3.4`인 서버의 `Drafts` 폴더에 접근하는 것입니다. `MAILINDEX=1` 매개변수는 메일 인덱스를 지정합니다. `--user user:pass`는 사용자 이름과 비밀번호를 인증에 사용합니다.
```

The mail index will be the same index returned from the search operation.

It is also possible to use `UID` (unique id) to access messages, however it is less conveniant as the search command needs to be manually formatted. E.g.

```bash
```markdown
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```

```html
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```

```korean
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```
```

Also, possible to download just parts of a message, e.g. subject and sender of first 5 messages (the `-v` is required to see the subject and sender):

```bash
```markdown
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```html
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```markdown
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```html
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```markdown
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```html
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```markdown
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```

```html
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
```
```
```

Although, its probably cleaner to just write a little for loop:

```bash
```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

위의 코드는 IMAP 서버에서 이메일 헤더 필드를 가져오는 방법을 보여줍니다. `1.2.3.4`는 대상 IMAP 서버의 IP 주소입니다. `user:pass`는 IMAP 서버에 로그인하기 위한 사용자 이름과 비밀번호입니다. `MAILINDEX=$m`은 가져올 이메일의 인덱스를 지정합니다. `SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)`은 가져올 헤더 필드를 지정합니다. 이 코드는 1부터 5까지의 인덱스를 사용하여 IMAP 서버에서 해당 이메일의 제목과 발신자를 가져옵니다.
```

## Shodan

* `port:143 CAPABILITY`
* `port:993 CAPABILITY`

## HackTricks Automatic Commands

```
Protocol_Name: IMAP    #프로토콜 약어가 있는 경우.
Port_Number:  143,993     #하나 이상인 경우 쉼표로 구분.
Protocol_Description: Internet Message Access Protocol         #약어를 풀어서 쓴 프로토콜 설명

Entry_1:
Name: Notes
Description: WHOIS에 대한 메모
Note: |
인터넷 메시지 액세스 프로토콜(IMAP)은 사용자가 어디에서나 이메일 메시지에 액세스할 수 있도록 설계되었습니다. 주로 인터넷 연결을 통해 이루어지며, 이메일은 개인 장치에 다운로드되고 저장되는 대신 서버에 보관됩니다. 이는 이메일이 서버에서 직접 액세스되거나 읽히는 것을 의미합니다. 이 기능을 통해 여러 장치에서 이메일을 확인할 수 있어 어떤 장치를 사용하더라도 메시지를 놓치지 않을 수 있습니다.

https://book.hacktricks.xyz/pentesting/pentesting-imap

Entry_2:
Name: Banner Grab
Description: Banner Grab 143
Command: nc -nv {IP} 143

Entry_3:
Name: Secure Banner Grab
Description: Banner Grab 993
Command: openssl s_client -connect {IP}:993 -quiet

Entry_4:
Name: consolesless mfs enumeration
Description: msfconsole을 실행하지 않고 IMAP 열거
Note: https://github.com/carlospolop/legion에서 가져옴
Command: msfconsole -q -x 'use auxiliary/scanner/imap/imap_version; set RHOSTS {IP}; set RPORT 143; run; exit'
```

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Find vulnerabilities that matter most so you can fix them faster. Intruder tracks your attack surface, runs proactive threat scans, finds issues across your whole tech stack, from APIs to web apps and cloud systems. [**Try it for free**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) today.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
