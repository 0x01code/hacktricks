# 143,993 - Pentesting IMAP

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks的衣物**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或者 [**telegram群组**](https://t.me/peass) 或者 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

## Internet Message Access Protocol

正如其名称所示，IMAP允许您在任何地方**访问您的电子邮件**；大部分时间，它是通过互联网访问的。基本上，电子邮件**消息存储在服务器上**。每当您检查收件箱时，您的电子邮件客户端会联系服务器，将您与您的消息连接起来。当您使用IMAP阅读电子邮件时，您实际上**并没有下载**或存储它在您的计算机上；相反，您是**从服务器上阅读**它。因此，您可以使用**多个不同的设备**检查电子邮件，而不会错过任何内容。

默认情况下，IMAP协议在两个端口上工作：

* **端口143** - 这是默认的IMAP非加密端口
* **端口993** - 如果您想要使用IMAP安全连接，则需要使用此端口
```
PORT    STATE SERVICE REASON
143/tcp open  imap    syn-ack
```
## 横幅抓取

Banner grabbing（横幅抓取）是一种用于获取目标主机上运行的服务版本信息的技术。通过发送特定的请求，攻击者可以从服务的响应中提取有关服务类型、版本号和其他相关信息。这些信息对于攻击者来说非常有价值，因为它们可以帮助攻击者了解目标系统的弱点和漏洞。

在IMAP（Internet Mail Access Protocol，互联网邮件访问协议）的情况下，攻击者可以使用Banner grabbing技术来识别目标主机上运行的IMAP服务器的版本。通过发送特定的IMAP命令，攻击者可以从服务器的响应中提取有关IMAP服务器的信息，例如版本号和支持的功能。

Banner grabbing是一种非侵入性的技术，因为它不会对目标系统造成任何实质性的影响。然而，攻击者可以利用从Banner grabbing中获得的信息来进行更有针对性的攻击，例如利用已知的漏洞或弱点来入侵目标系统。

为了防止Banner grabbing攻击，系统管理员可以采取一些措施，例如禁用服务版本信息的显示、定期更新服务以修复已知的漏洞，并使用防火墙来限制对敏感服务的访问。
```bash
nc -nv <IP> 143
openssl s_client -connect <IP>:993 -quiet
```
### NTLM身份验证 - 信息泄露

如果服务器支持NTLM身份验证（Windows），您可以获取敏感信息（版本）：
```
root@kali: telnet example.com 143
* OK The Microsoft Exchange IMAP4 service is ready.
>> a1 AUTHENTICATE NTLM
+
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
或者使用nmap插件`imap-ntlm-info.nse`来**自动化**这个过程。

### [IMAP暴力破解](../generic-methodologies-and-resources/brute-force.md#imap)

## 语法
```
Login
A1 LOGIN username password
Values can be quoted to enclose spaces and special characters. A " must then be escape with a \
A1 LOGIN "username" "password"

List Folders/Mailboxes
A1 LIST "" *
A1 LIST INBOX *
A1 LIST "Archive" *

Create new Folder/Mailbox
A1 CREATE INBOX.Archive.2012
A1 CREATE "To Read"

Delete Folder/Mailbox
A1 DELETE INBOX.Archive.2012
A1 DELETE "To Read"

Rename Folder/Mailbox
A1 RENAME "INBOX.One" "INBOX.Two"

List Subscribed Mailboxes
A1 LSUB "" *

Status of Mailbox (There are more flags than the ones listed)
A1 STATUS INBOX (MESSAGES UNSEEN RECENT)

Select a mailbox
A1 SELECT INBOX

List messages
A1 FETCH 1:* (FLAGS)
A1 UID FETCH 1:* (FLAGS)

Retrieve Message Content
A1 FETCH 2 body[text]
A1 FETCH 2 all
A1 UID FETCH 102 (UID RFC822.SIZE BODY.PEEK[])

Close Mailbox
A1 CLOSE

Logout
A1 LOGOUT
```
从[这里](https://donsutherland.org/crib/imap)开始

### 进化

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### Thunderbird

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### Dovecot

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### Cyrus

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### UW-IMAP

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### Courier

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### Zimbra

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```

### Exchange

```bash
nc -C imap.example.com 143
```

```bash
a001 LOGIN user pass
```

```bash
a002 SELECT INBOX
```

```bash
a003 FETCH 1 BODY[]
```

```bash
a004 LOGOUT
```
```
apt install evolution
```
![](<../.gitbook/assets/image (528).png>)

### CURL

使用[CURL](https://ec.haxx.se/usingcurl/usingcurl-reademail#imap)可以进行基本的导航，但是文档中缺乏详细信息，因此建议查看[源代码](https://github.com/curl/curl/blob/master/lib/imap.c)以获取精确的细节。

1.  列出邮箱（imap命令 `LIST "" "*"`）

```bash
$ curl -k 'imaps://1.2.3.4/' --user user:pass
```
2.  列出邮箱中的邮件（imap命令 `SELECT INBOX` 然后 `SEARCH ALL`）

```bash
$ curl -k 'imaps://1.2.3.4/INBOX?ALL' --user user:pass
```

这个搜索的结果是一组邮件索引。

也可以提供更复杂的搜索条件。例如，在邮件正文中搜索包含密码的草稿：

```bash
$ curl -k 'imaps://1.2.3.4/Drafts?TEXT password' --user user:pass
```

可以在[这里](https://www.atmail.com/blog/imap-commands/)找到搜索条件的详细概述。
3.  下载邮件（imap命令 `SELECT Drafts` 然后 `FETCH 1 BODY[]`）

```bash
$ curl -k 'imaps://1.2.3.4/Drafts;MAILINDEX=1' --user user:pass
```

邮件索引将与搜索操作返回的索引相同。

也可以使用`UID`（唯一标识符）来访问邮件，但是这种方式不太方便，因为搜索命令需要手动格式化。例如，使用UID搜索邮件：
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
$ curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```
此外，还可以下载消息的部分内容，例如前5条消息的主题和发件人（需要使用`-v`选项才能查看主题和发件人）：
```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```
虽然，只需编写一个简单的for循环可能更简洁：
```
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```
## Shodan

* `port:143 CAPABILITY`（端口：143 CAPABILITY）
* `port:993 CAPABILITY`（端口：993 CAPABILITY）

## HackTricks 自动命令
```
Protocol_Name: IMAP    #Protocol Abbreviation if there is one.
Port_Number:  143,993     #Comma separated if there is more than one.
Protocol_Description: Internet Message Access Protocol         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for WHOIS
Note: |
As its name implies, IMAP allows you to access your email messages wherever you are; much of the time, it is accessed via the Internet. Basically, email messages are stored on servers. Whenever you check your inbox, your email client contacts the server to connect you with your messages. When you read an email message using IMAP, you aren't actually downloading or storing it on your computer; instead, you are reading it off of the server. As a result, it's possible to check your email from several different devices without missing a thing.

https://book.hacktricks.xyz/pentesting/pentesting-imap

Entry_2:
Name: Banner Grab
Description: Banner Grab 143
Command: nc -nv {IP} 143

Entry_3:
Name: Secure Banner Grab
Description: Banner Grab 993
Command: openssl s_client -connect {IP}:993 -quiet

Entry_4:
Name: consolesless mfs enumeration
Description: IMAP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/imap/imap_version; set RHOSTS {IP}; set RPORT 143; run; exit'
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或者 [**Telegram群组**](https://t.me/peass)，或者在**Twitter**上**关注**我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **通过向[hacktricks仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud仓库](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
