# 143,993 - Pentesting IMAP

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories** senden.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Schwachstellen, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Internet Message Access Protocol

Das **Internet Message Access Protocol (IMAP)** wurde entwickelt, um Benutzern das **Abrufen ihrer E-Mail-Nachrichten von jedem Ort aus** zu erm√∂glichen, haupts√§chlich √ºber eine Internetverbindung. Im Wesentlichen werden E-Mails **auf einem Server gespeichert**, anstatt auf einem pers√∂nlichen Ger√§t des Benutzers heruntergeladen und gespeichert zu werden. Dies bedeutet, dass beim Zugriff oder Lesen einer E-Mail dies **direkt vom Server aus** erfolgt. Diese Funktion erm√∂glicht es, E-Mails von **mehreren Ger√§ten** aus zu √ºberpr√ºfen, um sicherzustellen, dass keine Nachrichten verpasst werden, unabh√§ngig vom verwendeten Ger√§t.

Standardm√§√üig funktioniert das IMAP-Protokoll auf zwei Ports:

* **Port 143** - dies ist der Standard-IMAP-Port ohne Verschl√ºsselung
* **Port 993** - dies ist der Port, den Sie verwenden m√ºssen, wenn Sie eine sichere IMAP-Verbindung herstellen m√∂chten
```
PORT    STATE SERVICE REASON
143/tcp open  imap    syn-ack
```
## Banner abrufen

Banner grabbing ist eine Technik, bei der Informationen √ºber einen Dienst oder eine Anwendung gesammelt werden, indem der Banner oder die Begr√º√üungsnachricht analysiert wird, die der Dienst oder die Anwendung beim Verbindungsaufbau sendet. Dies kann verwendet werden, um Informationen wie die verwendete Softwareversion, den Betriebssystemtyp und andere Details zu erhalten.

### Verwendung von Telnet

Eine M√∂glichkeit, Banner grabbing durchzuf√ºhren, besteht darin, Telnet zu verwenden. Telnet ist ein Protokoll, das verwendet wird, um eine Verbindung zu einem Remote-Host herzustellen und eine interaktive Sitzung zu starten. Durch die Verwendung von Telnet k√∂nnen wir uns mit dem IMAP-Server verbinden und den Banner abrufen.

Um Telnet zu verwenden, f√ºhren Sie den folgenden Befehl aus:

```bash
telnet <ziel-ip> <ziel-port>
```

Ersetzen Sie `<ziel-ip>` durch die IP-Adresse des Zielservers und `<ziel-port>` durch den Port, auf dem der IMAP-Dienst l√§uft (normalerweise Port 143 f√ºr IMAP und Port 993 f√ºr IMAPS).

Nachdem Sie den Befehl ausgef√ºhrt haben, sollten Sie eine Verbindung zum IMAP-Server herstellen und den Banner erhalten. Der Banner enth√§lt normalerweise Informationen wie den Namen und die Version des IMAP-Servers.

### Verwendung von Netcat

Eine weitere M√∂glichkeit, Banner grabbing durchzuf√ºhren, besteht darin, Netcat zu verwenden. Netcat ist ein vielseitiges Netzwerktool, das zum Senden und Empfangen von Daten √ºber TCP- oder UDP-Verbindungen verwendet werden kann.

Um Netcat zu verwenden, f√ºhren Sie den folgenden Befehl aus:

```bash
nc -nv <ziel-ip> <ziel-port>
```

Ersetzen Sie `<ziel-ip>` durch die IP-Adresse des Zielservers und `<ziel-port>` durch den Port, auf dem der IMAP-Dienst l√§uft.

Nachdem Sie den Befehl ausgef√ºhrt haben, sollten Sie eine Verbindung zum IMAP-Server herstellen und den Banner erhalten. Der Banner enth√§lt normalerweise Informationen wie den Namen und die Version des IMAP-Servers.
```bash
nc -nv <IP> 143
openssl s_client -connect <IP>:993 -quiet
```
### NTLM Auth - Informationslecks

Wenn der Server NTLM-Authentifizierung (Windows) unterst√ºtzt, k√∂nnen Sie sensible Informationen (Versionen) erhalten:
```
root@kali: telnet example.com 143
* OK The Microsoft Exchange IMAP4 service is ready.
>> a1 AUTHENTICATE NTLM
+
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
+ TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Oder **automatisieren** Sie dies mit dem **nmap**-Plugin `imap-ntlm-info.nse`

### [IMAP Bruteforce](../generic-methodologies-and-resources/brute-force.md#imap)

## Syntax

IMAP-Befehlsbeispiele von [hier](https://donsutherland.org/crib/imap):
```
Login
A1 LOGIN username password
Values can be quoted to enclose spaces and special characters. A " must then be escape with a \
A1 LOGIN "username" "password"

List Folders/Mailboxes
A1 LIST "" *
A1 LIST INBOX *
A1 LIST "Archive" *

Create new Folder/Mailbox
A1 CREATE INBOX.Archive.2012
A1 CREATE "To Read"

Delete Folder/Mailbox
A1 DELETE INBOX.Archive.2012
A1 DELETE "To Read"

Rename Folder/Mailbox
A1 RENAME "INBOX.One" "INBOX.Two"

List Subscribed Mailboxes
A1 LSUB "" *

Status of Mailbox (There are more flags than the ones listed)
A1 STATUS INBOX (MESSAGES UNSEEN RECENT)

Select a mailbox
A1 SELECT INBOX

List messages
A1 FETCH 1:* (FLAGS)
A1 UID FETCH 1:* (FLAGS)

Retrieve Message Content
A1 FETCH 2 body[text]
A1 FETCH 2 all
A1 UID FETCH 102 (UID RFC822.SIZE BODY.PEEK[])

Close Mailbox
A1 CLOSE

Logout
A1 LOGOUT
```
### Evolution

IMAP (Internet Message Access Protocol) ist ein Protokoll, das zum Abrufen von E-Mails von einem E-Mail-Server verwendet wird. Es wurde entwickelt, um die Einschr√§nkungen von POP (Post Office Protocol) zu √ºberwinden, indem es erweiterte Funktionen wie das Verwalten von E-Mails auf dem Server und das Synchronisieren von E-Mails zwischen verschiedenen Ger√§ten bietet.

IMAP hat im Laufe der Zeit verschiedene Versionen durchlaufen, wobei IMAP4 die aktuellste Version ist. IMAP4 bietet verbesserte Sicherheitsfunktionen wie die Verschl√ºsselung der Kommunikation √ºber SSL/TLS und die Authentifizierung mit Benutzername und Passwort.

Dar√ºber hinaus unterst√ºtzt IMAP4 erweiterte Funktionen wie das Durchsuchen von E-Mail-Ordnern, das Markieren von E-Mails als gelesen oder ungelesen, das L√∂schen von E-Mails und das Verschieben von E-Mails zwischen Ordnern. Es erm√∂glicht auch das Herunterladen von E-Mail-Anh√§ngen und das Verwalten von mehreren E-Mail-Konten √ºber eine einzige IMAP-Verbindung.

IMAP hat sich im Laufe der Zeit weiterentwickelt, um den wachsenden Anforderungen an E-Mail-Kommunikation gerecht zu werden. Es ist ein wichtiges Protokoll f√ºr E-Mail-Clients und wird von vielen E-Mail-Dienstanbietern unterst√ºtzt.
```
apt install evolution
```
![](<../.gitbook/assets/image (528).png>)

### CURL

Grundlegende Navigation ist mit [CURL](https://ec.haxx.se/usingcurl/usingcurl-reademail#imap) m√∂glich, aber die Dokumentation ist knapp an Details, daher wird empfohlen, die [Quelle](https://github.com/curl/curl/blob/master/lib/imap.c) f√ºr genaue Informationen zu √ºberpr√ºfen.

1.  Auflisten von Mailboxen (IMAP-Befehl `LIST "" "*"`)
```bash
curl -k 'imaps://1.2.3.4/' --user user:pass
```
2. Auflisten von Nachrichten in einem Postfach (IMAP-Befehl `SELECT INBOX` und dann `SEARCH ALL`)

```bash
curl -k 'imaps://1.2.3.4/INBOX?ALL' --user user:pass
```

The result of this search is a list of message indicies.

Its also possible to provide more complex search terms. e.g. searching for drafts with password in mail body:

```bash
curl -k 'imaps://1.2.3.4/Drafts?TEXT Passwort' --user Benutzer:Passwort
```

A nice overview of the search terms possible is located [here](https://www.atmail.com/blog/imap-commands/).

3.  Downloading a message (imap command `SELECT Drafts` and then `FETCH 1 BODY[]`)

```bash
curl -k 'imaps://1.2.3.4/Drafts;MAILINDEX=1' --user user:pass

---

curl -k 'imaps://1.2.3.4/Drafts;MAILINDEX=1' --user user:pass
```

The mail index will be the same index returned from the search operation.

It is also possible to use `UID` (unique id) to access messages, however it is less conveniant as the search command needs to be manually formatted. E.g.

```bash
```bash
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```

```bash
curl -k 'imaps://1.2.3.4/INBOX' -X 'UID SEARCH ALL' --user user:pass
curl -k 'imaps://1.2.3.4/INBOX;UID=1' --user user:pass
```
```

Also, possible to download just parts of a message, e.g. subject and sender of first 5 messages (the `-v` is required to see the subject and sender):

```bash
$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'

---

$ curl -k 'imaps://1.2.3.4/INBOX' -X 'FETCH 1:5 BODY[HEADER.FIELDS (SUBJECT FROM)]' --user user:pass -v 2>&1 | grep '^<'
```

Although, its probably cleaner to just write a little for loop:

```bash
```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```

```bash
for m in {1..5}; do
echo $m
curl "imap://1.2.3.4/INBOX;MAILINDEX=$m;SECTION=HEADER.FIELDS%20(SUBJECT%20FROM)" --user user:pass
done
```
```

## Shodan

* `port:143 CAPABILITY`
* `port:993 CAPABILITY`

## HackTricks Automatic Commands

```
Protocol_Name: IMAP    #Protokollabk√ºrzung, falls vorhanden.
Port_Number:  143,993     #Komma getrennt, wenn mehr als einer vorhanden ist.
Protocol_Description: Internet Message Access Protocol         #Vollst√§ndige Bezeichnung des Protokolls

Entry_1:
Name: Notizen
Description: Notizen f√ºr WHOIS
Note: |
Das Internet Message Access Protocol (IMAP) wurde entwickelt, um Benutzern den Zugriff auf ihre E-Mail-Nachrichten von jedem Ort aus zu erm√∂glichen, haupts√§chlich √ºber eine Internetverbindung. Im Wesentlichen werden E-Mails auf einem Server gespeichert, anstatt auf dem pers√∂nlichen Ger√§t einer Person heruntergeladen und gespeichert zu werden. Dies bedeutet, dass beim Zugriff oder Lesen einer E-Mail dies direkt vom Server aus erfolgt. Diese Funktion erm√∂glicht es, E-Mails von mehreren Ger√§ten aus zu √ºberpr√ºfen, um sicherzustellen, dass keine Nachrichten verpasst werden, unabh√§ngig vom verwendeten Ger√§t.

https://book.hacktricks.xyz/pentesting/pentesting-imap

Entry_2:
Name: Banner Grab
Description: Banner Grab 143
Command: nc -nv {IP} 143

Entry_3:
Name: Sicherer Banner Grab
Description: Banner Grab 993
Command: openssl s_client -connect {IP}:993 -quiet

Entry_4:
Name: Enumeration ohne msfconsole
Description: IMAP-Enumeration ohne die Notwendigkeit, msfconsole auszuf√ºhren
Note: Quelle: https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/imap/imap_version; set RHOSTS {IP}; set RPORT 143; run; exit'
```

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Find vulnerabilities that matter most so you can fix them faster. Intruder tracks your attack surface, runs proactive threat scans, finds issues across your whole tech stack, from APIs to web apps and cloud systems. [**Try it for free**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) today.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
