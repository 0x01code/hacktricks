## Información Básica

OMI es una herramienta de gestión de configuración remota de código abierto desarrollada por Microsoft. Los agentes OMI se encuentran comúnmente instalados en servidores Linux de Azure cuando se utilizan los siguientes servicios:

* Automatización de Azure
* Actualización automática de Azure
* Suite de administración de operaciones de Azure
* Análisis de registros de Azure
* Gestión de configuración de Azure
* Diagnóstico de Azure

Cuando se configuran estos servicios, el proceso omiengine escuchará en todas las interfaces y se ejecutará como usuario root.

<figure><img src="../.gitbook/assets/image (1) (3) (2).png" alt=""><figcaption></figcaption></figure>

**Puerto predeterminado:** 5985 (http), 5986 (https)

## [CVE-2021-38647](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)

A partir del 16 de septiembre, los servidores Linux recién creados en Azure todavía se empaquetan con una versión vulnerable del agente OMI. Después de implementar un servidor Linux y habilitar uno de los servicios mencionados anteriormente, el servidor estará en un estado vulnerable.

El servidor OMI recibe mensajes de gestión de configuración a través del punto final /wsman. Por lo general, se pasa una cabecera de autenticación junto con el mensaje y el servidor OMI se asegurará de que el cliente esté autorizado para comunicarse. En este caso, la vulnerabilidad es que cuando no hay cabecera de autenticación, el servidor acepta incorrectamente el mensaje y ejecuta la instrucción bajo el usuario root.

Al publicar una carga útil SOAP "ExecuteShellCommand" en el servidor sin especificar una cabecera de autenticación, se ejecutará el comando como root.
```xml
<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://schemas.xmlsoap.org/ws/2004/08/addressing"
   ...
   <s:Body>
      <p:ExecuteShellCommand_INPUT xmlns:p="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/SCX_OperatingSystem">
         <p:command>id</p:command>
         <p:timeout>0</p:timeout>
      </p:ExecuteShellCommand_INPUT>
   </s:Body>
</s:Envelope>
```
Encuentra el exploit completo en [https://github.com/horizon3ai/CVE-2021-38647](https://github.com/horizon3ai/CVE-2021-38647)

## Referencias

* [https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/](https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/)
* [https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/](https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* ¿Trabajas en una **empresa de ciberseguridad**? ¿Quieres ver tu **empresa anunciada en HackTricks**? ¿O quieres tener acceso a la **última versión de PEASS o descargar HackTricks en PDF**? ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Únete al** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
