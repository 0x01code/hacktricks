# 11211 - Pentesting Memcache

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes do Protocolo

**Memcached** (pron√∫ncia: mem-cached, mem-cash-dee) √© um sistema de [cache de mem√≥ria distribu√≠da](https://en.wikipedia.org/wiki/Memory\_caching) geral. √â frequentemente usado para acelerar sites din√¢micos baseados em banco de dados, armazenando em cache dados e objetos na RAM para reduzir o n√∫mero de vezes que uma fonte de dados externa (como um banco de dados ou API) deve ser lida. (De [wikipedia](https://en.wikipedia.org/wiki/Memcached))\
Embora o Memcached suporte o SASL, a maioria das inst√¢ncias √© **exposta sem autentica√ß√£o**.

**Porta padr√£o:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumera√ß√£o

### Manual

Para extrair todas as informa√ß√µes salvas em uma inst√¢ncia do memcache, voc√™ precisa:

1. Encontrar **slabs** com **itens ativos**
2. Obter os **nomes das chaves** dos slabs detectados anteriormente
3. Extrair os **dados salvos** obtendo os nomes das chaves

Lembre-se de que este servi√ßo √© apenas um **cache**, portanto, **os dados podem aparecer e desaparecer**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2

Este √© um manual para explorar vulnerabilidades no servi√ßo de cache Memcached. O Memcached √© um sistema de cache distribu√≠do de alto desempenho que armazena dados em mem√≥ria RAM. Ele √© frequentemente usado para acelerar aplicativos da web, como sites de com√©rcio eletr√¥nico e redes sociais.

#### Verificando se o servi√ßo Memcached est√° em execu√ß√£o

Antes de come√ßar a explorar o Memcached, √© importante verificar se o servi√ßo est√° em execu√ß√£o na m√°quina de destino. Isso pode ser feito usando o comando `nmap` para verificar as portas abertas na m√°quina:

```
nmap -p 11211 <ip_address>
```

Se a porta 11211 estiver aberta, o servi√ßo Memcached est√° em execu√ß√£o na m√°quina.

#### Explorando o servi√ßo Memcached

Uma vez que o servi√ßo Memcached esteja em execu√ß√£o, voc√™ pode come√ßar a explorar poss√≠veis vulnerabilidades. Algumas das t√©cnicas de explora√ß√£o mais comuns incluem:

- **Ataques de nega√ß√£o de servi√ßo (DoS)**: o Memcached pode ser usado para realizar ataques de DoS em outras m√°quinas. Isso √© feito enviando solicita√ß√µes falsas para o servi√ßo Memcached, fazendo com que ele envie grandes quantidades de dados para a m√°quina de destino.

- **Exfiltra√ß√£o de dados**: o Memcached pode ser usado para exfiltrar dados de outras m√°quinas. Isso √© feito enviando dados para o servi√ßo Memcached e, em seguida, recuperando-os de outra m√°quina.

- **Execu√ß√£o remota de c√≥digo**: o Memcached pode ser usado para executar c√≥digo arbitr√°rio em outras m√°quinas. Isso √© feito enviando comandos especiais para o servi√ßo Memcached, que s√£o ent√£o executados na m√°quina de destino.

#### Preven√ß√£o de vulnerabilidades do Memcached

Para prevenir vulnerabilidades do Memcached, √© importante seguir as melhores pr√°ticas de seguran√ßa, como:

- **Restringir o acesso ao servi√ßo Memcached**: o servi√ßo Memcached deve ser restrito apenas a m√°quinas confi√°veis e n√£o deve ser acess√≠vel a partir da Internet p√∫blica.

- **Usar autentica√ß√£o**: o Memcached suporta autentica√ß√£o, o que pode ajudar a prevenir ataques de DoS e exfiltra√ß√£o de dados.

- **Manter o software atualizado**: √© importante manter o software Memcached atualizado com as √∫ltimas corre√ß√µes de seguran√ßa para prevenir vulnerabilidades conhecidas.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Autom√°tico
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible 
```
## Despejando Chaves do Memcache <a href="#dumping-memcache-keys" id="dumping-memcache-keys"></a>

**Se a sua vers√£o do memcached for superior a 1.4.31, leia a pr√≥xima se√ß√£o para um m√©todo avan√ßado de despejo de chaves.**

O protocolo memcache fornece [comandos](https://lzone.de/articles/memcached.htm) para visualizar os dados organizados por slabs (categorias de dados de um determinado intervalo de tamanho). No entanto, existem algumas limita√ß√µes significativas:

1. Voc√™ s√≥ pode despejar chaves por classe de slab (chaves com tamanho de conte√∫do aproximado)
2. Voc√™ s√≥ pode despejar uma p√°gina por classe de slab (1MB de dados)
3. Esta √© uma funcionalidade n√£o oficial que [pode ser removida a qualquer momento.](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM)

A segunda limita√ß√£o √© provavelmente a mais dif√≠cil, porque 1MB de v√°rios gigabytes √© quase nada. Ainda assim, pode ser √∫til observar como voc√™ usa um subconjunto de suas chaves. Mas isso pode depender do seu caso de uso. Se voc√™ n√£o se importa com os detalhes t√©cnicos, pule para a se√ß√£o de [ferramentas](https://lzone.de/cheat-sheet/memcached#tools) para aprender sobre as ferramentas que permitem despejar tudo facilmente. Alternativamente, siga o guia a seguir e tente os comandos [usando telnet](https://lzone.de/articles/memcached.htm) contra sua configura√ß√£o do memcached. **Como Funciona** Primeiro, voc√™ precisa saber como o memcache organiza sua mem√≥ria. Se voc√™ iniciar o memcache com a op√ß√£o "-vv", ver√° as classes de slab que ele cria. Por exemplo:
```
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
slab class   2: chunk size       120 perslab    8738
slab class   3: chunk size       152 perslab    6898
slab class   4: chunk size       192 perslab    5461
[...]
```
Na configura√ß√£o impressa acima, o memcache manter√° 6898 pe√ßas de dados entre 121 e 152 bytes em um √∫nico slab de tamanho 1MB (6898\*152). Todos os slabs t√™m tamanho de 1MB por padr√£o. Use o seguinte comando para imprimir todos os slabs existentes no momento:
```
stats slabs
```
Se voc√™ adicionou uma √∫nica chave a um memcached vazio 1.4.13 com...
```
set mykey 0 60 1
1
STORED
```
Agora voc√™ ver√° o seguinte resultado para o comando "stats slabs":
```
stats slabs
STAT 1:chunk_size 96
STAT 1:chunks_per_page 10922
STAT 1:total_pages 1
STAT 1:total_chunks 10922
STAT 1:used_chunks 1
STAT 1:free_chunks 0
STAT 1:free_chunks_end 10921
STAT 1:mem_requested 71
STAT 1:get_hits 0
STAT 1:cmd_set 2
STAT 1:delete_hits 0
STAT 1:incr_hits 0
STAT 1:decr_hits 0
STAT 1:cas_hits 0
STAT 1:cas_badval 0
STAT 1:touch_hits 0
STAT active_slabs 1
STAT total_malloced 1048512
END
```
O exemplo mostra que temos apenas um tipo de slab ativo, o #1. Como nossa chave tem apenas um byte de tamanho, ela se encaixa no menor tamanho poss√≠vel de chunk. As estat√≠sticas do slab mostram que atualmente existe apenas uma p√°gina da classe de slab e que apenas um chunk √© usado. **O mais importante √© que ele mostra um contador para cada opera√ß√£o de escrita (set, incr, decr, cas, touch) e um para gets. Usando esses contadores, voc√™ pode determinar a taxa de acertos!** Voc√™ tamb√©m pode obter outro conjunto de informa√ß√µes usando "stats items" com contadores interessantes sobre evas√µes e contadores de falta de mem√≥ria.
```
stats items
STAT items:1:number 1
STAT items:1:age 4
STAT items:1:evicted 0
STAT items:1:evicted_nonzero 0
STAT items:1:evicted_time 0
STAT items:1:outofmemory 0
STAT items:1:tailrepairs 0
STAT items:1:reclaimed 0
STAT items:1:expired_unfetched 0
STAT items:1:evicted_unfetched 0
END
```
**O que podemos deduzir at√© agora...** Dadas as informa√ß√µes estat√≠sticas por classe de blocos, j√° podemos deduzir muitas coisas sobre o comportamento do aplicativo:

1. Qual √© a taxa de cache para diferentes tamanhos de conte√∫do?
   * Qu√£o bom √© o cache de grandes blocos de HTML?
2. Quanta mem√≥ria gastamos em diferentes tamanhos de conte√∫do?
   * Quanto gastamos em contadores num√©ricos simples?
   * Quanto gastamos em nossos dados de sess√£o?
   * Quanto gastamos em grandes blocos de HTML?
3. Quantos objetos grandes podemos armazenar em cache?

Claro, para responder √†s perguntas, voc√™ precisa conhecer os objetos de cache do seu aplicativo. **Agora: Como Despejar Chaves?** As chaves podem ser despejadas por classe de blocos usando o comando "stats cachedump".
```
stats cachedump <slab class> <number of items to dump>
```
Para despejar nossa √∫nica chave na classe #1, execute
```
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
O comando "cachedump" retorna um item por linha. O primeiro n√∫mero entre chaves indica o tamanho em bytes e o segundo o timestamp da cria√ß√£o. Dado o nome da chave, agora voc√™ tamb√©m pode despejar o valor usando.
```
get mykey
VALUE mykey 0 1
1
END
```
Aqui est√°: itere sobre todas as classes de fragmentos que voc√™ deseja, extraia os nomes das chaves e, se necess√°rio, despeje o conte√∫do delas.

### **DESPREZANDO AS CHAVES DO MEMCACHE (VER 1.4.31+)**

Na vers√£o do memcache 1.4.31 e superior, h√° um novo comando para despejar as chaves da mem√≥ria em modo n√£o-bloqueante (leia https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Este m√©todo √© seguro para ser executado em produ√ß√£o. A sa√≠da n√£o √© consistente, mas √© boa o suficiente para encontrar chaves, seu tempo exato de expira√ß√£o (EXP) e o √∫ltimo tempo de acesso (LA). Devido √† enorme sa√≠da gerada, √© recomend√°vel usar o comando ‚Äònc‚Äô. Exemplos:
```
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
key=0dLLX%253Amemcache_test_key exp=1590718787 la=1590718487 cas=2238881166 fetch=yes

echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
key=VQRFX%253Aee6ba58566e234ccbbce13f9a24f9a28 exp=-1 la=1590386157 cas=1776204003 fetch=yes
key=0dLLX%253Aee6ba58566e234ccbbce13f9a24f9a28 exp=-1 la=1590712292 cas=2225524871 fetch=yes
```
EXP=-1 significa que o item nunca expira. EXP=1590718787 (Sex Maio 29 02:19:47 GMT 2020) mant√©m o timestamp Unix quando o item deve expirar. LA=1590712292 (Seg Maio 25 05:55:57 GMT 2020) mant√©m o timestamp Unix quando o item foi acessado pela √∫ltima vez.

### **FERRAMENTAS DE DUMPING**

Existem diferentes ferramentas de dumping, √†s vezes apenas scripts, que ajudam a imprimir as chaves do memcache:

| Linguagens de programa√ß√£o | Ferramentas                                                                                                                         | Funcionalidade                                                                                                                                                          |                                                                             |         |
| ------------------------ | ----------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                      | [script simples](http://snipt.org/xtP)                                                                                               | Imprime nomes de chaves.                                                                                                                                               |                                                                             |         |
| Perl                     | [script simples](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime chaves e valores.                                                                                                                                              |                                                                             |         |
| Ruby                     | [script simples](https://gist.github.com/1365005)                                                                                    | Imprime nomes de chaves.                                                                                                                                               |                                                                             |         |
| Perl                     | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                          | Ferramenta no m√≥dulo CPAN                                                                                                                                             | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                      | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                           | GUI de monitoramento do Memcache que tamb√©m permite o dumping de chaves.                                                                                               |                                                                             |         |
| libmemcached             | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                               | **Congela seu processo memcached!!!** Tenha cuidado ao us√°-lo em produ√ß√£o. Ainda assim, voc√™ pode contornar a limita√ß√£o de 1MB e realmente despejar **todas** as chaves. |                                                                             |         |

## Solu√ß√£o de problemas <a href="#troubleshooting" id="troubleshooting"></a>

### Limite de dados de 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Observe que, antes do memcached 1.4, voc√™ n√£o pode armazenar objetos maiores que 1MB devido ao tamanho m√°ximo de slab padr√£o.

### Nunca defina um tempo limite > 30 dias! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Se voc√™ tentar "set" ou "add" uma chave com um tempo limite maior do que o m√°ximo permitido, pode n√£o obter o que espera, porque o memcached trata o valor como um timestamp Unix. Al√©m disso, se o timestamp estiver no passado, n√£o far√° nada. Seu comando falhar√° silenciosamente.

Portanto, se voc√™ deseja usar o tempo de vida m√°ximo, especifique 2592000. Exemplo:
```
set my_key 0 2592000 1
1
```
### Chaves Desaparecendo em Overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Apesar da documenta√ß√£o dizer algo sobre o valor de transbordamento de 64 bits usando "incr" faz com que o valor desapare√ßa. √â necess√°rio cri√°-lo novamente usando "add" / "set".

### Replica√ß√£o <a href="#replication" id="replication"></a>

O memcached em si n√£o suporta replica√ß√£o. Se voc√™ realmente precisa disso, precisa usar solu√ß√µes de terceiros:

* [repcached](http://repcached.lab.klab.org/): replica√ß√£o ass√≠ncrona multi-mestre (conjunto de patches memcached 1.2)
* [Interface memcached do Couchbase](http://www.couchbase.com/memcached): Use o CouchBase como substituto do memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): armazenamento de valor-chave mestre-escravo compat√≠vel com memcached
* [twemproxy](https://github.com/twitter/twemproxy) (tamb√©m conhecido como nutcracker): proxy com suporte memcached

### Comandos Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Refer√™ncias

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>
