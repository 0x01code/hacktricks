# 11211 - Test d'intrusion Memcache

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations sur le protocole

D'apr√®s [Wikip√©dia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (prononciation : mem-cached, mem-cash-dee) est un syst√®me de mise en cache de m√©moire distribu√©e √† usage g√©n√©ral. Il est souvent utilis√© pour acc√©l√©rer les sites Web dynamiques pilot√©s par une base de donn√©es en mettant en cache des donn√©es et des objets en RAM pour r√©duire le nombre de fois o√π une source de donn√©es externe (comme une base de donn√©es ou une API) doit √™tre lue.

Bien que Memcached prenne en charge SASL, la plupart des instances sont **expos√©es sans authentification**.

**Port par d√©faut :** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## √ânum√©ration

### Manuelle

Pour exfiltrer toutes les informations enregistr√©es √† l'int√©rieur d'une instance memcache, vous devez :

1. Trouver les **slabs** avec des **√©l√©ments actifs**
2. Obtenir les **noms de cl√©** des slabs d√©tect√©s pr√©c√©demment
3. Exfiltrer les **donn√©es enregistr√©es** en **obtenant les noms de cl√©**

Rappelez-vous que ce service est juste un **cache**, donc les **donn√©es peuvent appara√Ætre et dispara√Ætre**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manuel2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatique
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Extraction des cl√©s Memcache**

Dans le domaine de memcache, un protocole qui aide √† organiser les donn√©es par tranches, des commandes sp√©cifiques existent pour inspecter les donn√©es stock√©es, bien que avec des contraintes notables :

1. Les cl√©s ne peuvent √™tre extraites que par classe de tranche, regroupant les cl√©s de taille de contenu similaire.
2. Il existe une limite d'une page par classe de tranche, √©quivalant √† 1 Mo de donn√©es.
3. Cette fonctionnalit√© est non officielle et peut √™tre interrompue √† tout moment, comme discut√© dans les [forums communautaires](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

La limitation de ne pouvoir extraire que 1 Mo parmi potentiellement des gigaoctets de donn√©es est particuli√®rement significative. Cependant, cette fonctionnalit√© peut toujours offrir des informations sur les sch√©mas d'utilisation des cl√©s, en fonction des besoins sp√©cifiques. Pour ceux qui sont moins int√©ress√©s par les m√©canismes, une visite de la [section des outils](https://lzone.de/cheat-sheet/memcached#tools) r√©v√®le des utilitaires pour une extraction compl√®te. Alternativement, le processus d'utilisation de telnet pour une interaction directe avec les configurations memcached est d√©crit ci-dessous.

### **Comment √ßa Marche**

L'organisation de la m√©moire de Memcache est cruciale. L'initialisation de memcache avec l'option "-vv" r√©v√®le les classes de tranches qu'il g√©n√®re, comme illustr√© ci-dessous :
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Pour afficher toutes les dalles actuellement existantes, la commande suivante est utilis√©e :
```bash
stats slabs
```
Ajouter une cl√© unique √† memcached 1.4.13 illustre comment les classes de slab sont peupl√©es et g√©r√©es. Par exemple:
```bash
set mykey 0 60 1
1
STORED
```
Ex√©cuter la commande "stats slabs" apr√®s l'ajout de cl√©s fournit des statistiques d√©taill√©es sur l'utilisation des slab :
```bash
stats slabs
[...]
```
Cet output r√©v√®le les types de slab actifs, les chunks utilis√©s et les statistiques op√©rationnelles, offrant des informations sur l'efficacit√© des op√©rations de lecture et d'√©criture.

Une autre commande utile, "stats items", fournit des donn√©es sur les √©victions, les contraintes de m√©moire et les cycles de vie des √©l√©ments :
```bash
stats items
[...]
```
### **Extraction des cl√©s**

Pour les versions ant√©rieures √† 1.4.31, les cl√©s sont extraites par classe de slab en utilisant :
```bash
stats cachedump <slab class> <number of items to dump>
```
Par exemple, pour vider une cl√© dans la classe #1 :
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Cette m√©thode it√®re sur les classes de slab, extrayant et √©ventuellement d√©versant les valeurs des cl√©s.

### **EXTRACTION DES CL√âS MEMCACHE (VER 1.4.31+)**

Avec la version de memcache 1.4.31 et sup√©rieure, une nouvelle m√©thode plus s√ªre pour extraire les cl√©s dans un environnement de production est introduite, en utilisant le mode non bloquant comme d√©taill√© dans les [notes de version](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Cette approche g√©n√®re une sortie extensive, d'o√π la recommandation d'utiliser la commande 'nc' pour plus d'efficacit√©. Des exemples incluent :
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **OUTILS DE DUMPING**

Tableau [√† partir d'ici](https://lzone.de/blog).

| Langages de programmation | Outils                                                                                                                              | Fonctionnalit√©                                                                                          |                                                                             |         |
| ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------ | --------------------------------------------------------------------------- | ------- |
| PHP                       | [script simple](http://snipt.org/xtP)                                                                                              | Affiche les noms des cl√©s.                                                                              |                                                                             |         |
| Perl                      | [script simple](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Affiche les cl√©s et les valeurs                                                                        |                                                                             |         |
| Ruby                      | [script simple](https://gist.github.com/1365005)                                                                                   | Affiche les noms des cl√©s.                                                                              |                                                                             |         |
| Perl                      | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Outil dans le module CPAN                                                                              | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                       | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Interface graphique de surveillance de Memcache qui permet √©galement de vider les cl√©s                |                                                                             |         |
| libmemcached              | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **G√®le votre processus memcached !!!** Soyez prudent lors de son utilisation en production. En l'utilisant, vous pouvez contourner la limitation de 1 Mo et vraiment vider **toutes** les cl√©s. |                                                                             |         |

## D√©pannage <a href="#troubleshooting" id="troubleshooting"></a>

### Limite de Donn√©es de 1 Mo <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Notez qu'avant memcached 1.4, vous ne pouvez pas stocker des objets de plus de 1 Mo en raison de la taille maximale de slab par d√©faut.

### Ne D√©finissez Jamais un D√©lai > 30 Jours ! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Si vous essayez de "d√©finir" ou "ajouter" une cl√© avec un d√©lai sup√©rieur au maximum autoris√©, vous pourriez ne pas obtenir le r√©sultat attendu car memcached traitera alors la valeur comme un horodatage Unix. De plus, si l'horodatage est dans le pass√©, rien ne se produira du tout. Votre commande √©chouera silencieusement.

Donc, si vous voulez utiliser la dur√©e de vie maximale, sp√©cifiez 2592000. Exemple :
```
set my_key 0 2592000 1
1
```
### Cl√©s Disparaissant en Cas de D√©passement <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Malgr√© la documentation indiquant quelque chose √† propos du d√©passement de 64 bits, une valeur d√©passement en utilisant "incr" fait dispara√Ætre la valeur. Il faut la recr√©er en utilisant "add"/"set" √† nouveau.

### R√©plication <a href="#replication" id="replication"></a>

memcached lui-m√™me ne prend pas en charge la r√©plication. Si vous en avez vraiment besoin, vous devez utiliser des solutions tierces :

* [repcached](http://repcached.lab.klab.org/) : R√©plication asynchrone multi-ma√Ætre (ensemble de correctifs memcached 1.2)
* [Interface memcached de Couchbase](http://www.couchbase.com/memcached) : Utilisez CouchBase comme remplacement de memcached
* [yrmcds](https://cybozu.github.io/yrmcds/) : Magasin de valeurs cl√©s ma√Ætre-esclave compatible avec memcached
* [twemproxy](https://github.com/twitter/twemproxy) (alias nutcracker) : proxy avec support memcached

### Feuille de Triche des Commandes

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## R√©f√©rences

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
