# 11211 - Memcacheのペンテスト

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* **ハッキングテクニックを共有するために、[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する。**

</details>

## プロトコル情報

[wikipedia](https://en.wikipedia.org/wiki/Memcached)から：

> **Memcached**（発音：mem-cashed、mem-cash-dee）は、一般的な分散[メモリキャッシング](https://en.wikipedia.org/wiki/Memory\_caching)システムです。データとオブジェクトをRAMにキャッシュして外部データソース（データベースやAPIなど）の読み取り回数を減らし、動的なデータベース駆動型のウェブサイトの高速化によく使用されます。

MemcachedはSASLをサポートしていますが、ほとんどのインスタンスは**認証なしで公開**されています。

**デフォルトポート:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## 列挙

### 手動

Memcacheインスタンスに保存されているすべての情報を外部に持ち出すには、次の手順が必要です：

1. **アクティブなアイテム**を持つ**スラブ**を見つける
2. 以前に検出したスラブの**キー名**を取得する
3. **キー名**を取得して、保存されたデータを外部に持ち出す

このサービスは単なる**キャッシュ**であるため、**データが現れたり消えたり**する可能性があります。
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### マニュアル2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### 自動
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Memcacheキーのダンプ**

Memcacheの世界では、データをスラブで整理するプロトコルが存在し、格納されたデータを調査するための特定のコマンドがありますが、注目すべき制約があります：

1. キーはスラブクラスごとにダンプすることができます。これは、同様のコンテンツサイズのキーをグループ化します。
2. 1つのスラブクラスごとに1ページの制限があり、これは1MBのデータに相当します。
3. この機能は非公式であり、[コミュニティフォーラム](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM)で議論されているように、いつでも廃止される可能性があります。

潜在的にギガバイトのデータから1MBしかダンプできないという制限は特に重要です。ただし、この機能は、特定のニーズに応じてキーの使用パターンに関する洞察を提供することができます。メカニクスにあまり興味がない人のためには、[ツールセクション](https://lzone.de/cheat-sheet/memcached#tools)を訪れると、包括的なダンプのためのユーティリティが見つかります。また、memcachedセットアップと直接対話するためのtelnetの使用方法については、以下で説明します。

### **動作原理**

Memcacheのメモリ構成は重要です。メモリキャッシュを"-vv"オプションで初期化すると、生成されるスラブクラスが表示されます。
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
現在存在するすべてのスラブを表示するには、次のコマンドを使用します:
```bash
stats slabs
```
memcached 1.4.13に単一のキーを追加することで、スラブクラスがどのように作成および管理されるかが示されます。たとえば：
```bash
set mykey 0 60 1
1
STORED
```
以下は、キーの追加後に "stats slabs" コマンドを実行すると、スラブの利用状況に関する詳細な統計情報が得られます：
```bash
stats slabs
[...]
```
以下の出力は、アクティブなスラブタイプ、利用されているチャンク、および操作統計を示し、読み取りおよび書き込み操作の効率に関する洞察を提供します。

もう1つの便利なコマンドである "stats items" は、エビクション、メモリ制約、およびアイテムのライフサイクルに関するデータを提供します。
```bash
stats items
[...]
```
### **キーのダンプ**

1.4.31以前のバージョンでは、スラブクラスを使用してキーをダンプします。
```bash
stats cachedump <slab class> <number of items to dump>
```
例えば、クラス＃1でキーをダンプするには：
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
このメソッドはスラブクラスを反復処理し、キーの値を抽出してオプションでダンプします。

### **MEMCACHEキーのダンプ（VER 1.4.31+）**

memcacheバージョン1.4.31以降では、[リリースノート](https://github.com/memcached/memcached/wiki/ReleaseNotes1431)で詳細に説明されている非同期モードを利用して、本番環境でキーをダンプするための新しい、安全な方法が導入されました。このアプローチは広範な出力を生成するため、「nc」コマンドを効率的に使用することを推奨します。例：
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **ダンピングツール**

表は[こちら](https://lzone.de/blog)から。

| プログラミング言語 | ツール                                                                                                                              | 機能                                                                                                                                                                 |                                                                             |         |
| --------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                   | [シンプルなスクリプト](http://snipt.org/xtP)                                                                                              | キー名を表示します。                                                                                                                                                      |                                                                             |         |
| Perl                  | [シンプルなスクリプト](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | キーと値を表示します。                                                                                                                                                 |                                                                             |         |
| Ruby                  | [シンプルなスクリプト](https://gist.github.com/1365005)                                                                                   | キー名を表示します。                                                                                                                                                      |                                                                             |         |
| Perl                  | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | CPANモジュール内のツール                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                   | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | キーをダンプすることも可能なMemcacheモニタリングGUI                                                                                                                  |                                                                             |         |
| libmemcached          | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **あなたのmemcachedプロセスをフリーズさせます!!!** 本番環境で使用する際は注意してください。それでも、1MBの制限を回避し、本当に**すべて**のキーをダンプすることができます。 |                                                                             |         |

## トラブルシューティング <a href="#troubleshooting" id="troubleshooting"></a>

### 1MBデータ制限 <a href="#1mb-data-limit" id="1mb-data-limit"></a>

memcached 1.4以前では、デフォルトの最大スラブサイズのため、1MBを超えるオブジェクトを保存することはできません。

### タイムアウトを30日を超える値に設定しないでください！ <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

許可された最大値よりも大きなタイムアウトでキーを「set」または「add」しようとすると、memcachedはその値をUnixタイムスタンプとして扱うため、期待通りの結果が得られない可能性があります。また、タイムスタンプが過去の場合は何も行いません。コマンドは静かに失敗します。

したがって、最大の有効期限を使用したい場合は2592000を指定してください。例：
```
set my_key 0 2592000 1
1
```
### オーバーフロー時のキーの消失 <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

ドキュメントには64ビットを超える値を「incr」を使用してオーバーフローさせると値が消えると記載されています。再度「add」/「set」を使用して作成する必要があります。

### レプリケーション <a href="#replication" id="replication"></a>

memcached自体はレプリケーションをサポートしていません。本当に必要な場合は、以下のようなサードパーティーのソリューションを使用する必要があります：

* [repcached](http://repcached.lab.klab.org/): マルチマスター非同期レプリケーション（memcached 1.2パッチセット）
* [Couchbase memcached interface](http://www.couchbase.com/memcached): CouchBaseをmemcachedの代替として使用
* [yrmcds](https://cybozu.github.io/yrmcds/): memcached互換のマスター・スレーブキー値ストア
* [twemproxy](https://github.com/twitter/twemproxy)（別名nutcracker）: memcachedサポート付きのプロキシ

### コマンドチートシート

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## 参考文献

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで** **会社を宣伝したい** または **HackTricksをPDFでダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)をフォローする。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
