# 11211 - Pentesting Memcache

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes do Protocolo

Do [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (pron√∫ncia: mem-cached, mem-cash-dee) √© um sistema de [cache de mem√≥ria](https://en.wikipedia.org/wiki/Memory\_caching) distribu√≠do de prop√≥sito geral. √â frequentemente usado para acelerar sites din√¢micos baseados em banco de dados, armazenando em cache dados e objetos na RAM para reduzir o n√∫mero de vezes que uma fonte de dados externa (como um banco de dados ou API) precisa ser lida.

Embora o Memcached suporte SASL, a maioria das inst√¢ncias √© **exposta sem autentica√ß√£o**.

**Porta padr√£o:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumera√ß√£o

### Manual

Para exfiltrar todas as informa√ß√µes salvas dentro de uma inst√¢ncia de memcache, voc√™ precisa:

1. Encontrar **slabs** com **itens ativos**
2. Obter os **nomes das chaves** dos slabs detectados anteriormente
3. Exfiltrar os **dados salvos** ao **obter os nomes das chaves**

Lembre-se de que este servi√ßo √© apenas um **cache**, ent√£o os **dados podem estar aparecendo e desaparecendo**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manual2
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Autom√°tico
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Despejando Chaves do Memcache**

No reino do memcache, um protocolo que auxilia na organiza√ß√£o de dados por slabs, existem comandos espec√≠ficos para inspecionar os dados armazenados, embora com limita√ß√µes not√°veis:

1. As chaves s√≥ podem ser despejadas por classe de slab, agrupando chaves de tamanho de conte√∫do semelhante.
2. Existe um limite de uma p√°gina por classe de slab, equivalente a 1MB de dados.
3. Este recurso √© n√£o oficial e pode ser descontinuado a qualquer momento, como discutido em [f√≥runs da comunidade](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

A limita√ß√£o de apenas poder despejar 1MB de potencialmente gigabytes de dados √© particularmente significativa. No entanto, essa funcionalidade ainda pode oferecer insights sobre padr√µes de uso de chaves, dependendo das necessidades espec√≠ficas. Para aqueles menos interessados na mec√¢nica, uma visita √† [se√ß√£o de ferramentas](https://lzone.de/cheat-sheet/memcached#tools) revela utilit√°rios para despejo abrangente. Alternativamente, o processo de usar telnet para intera√ß√£o direta com configura√ß√µes do memcached √© descrito abaixo.

### **Como Funciona**

A organiza√ß√£o da mem√≥ria do Memcache √© fundamental. Iniciar o memcache com a op√ß√£o "-vv" revela as classes de slab que ele gera, conforme mostrado abaixo:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Para exibir todas as lajes atualmente existentes, o seguinte comando √© usado:
```bash
stats slabs
```
Adicionar uma √∫nica chave ao memcached 1.4.13 ilustra como as classes de slab s√£o populadas e gerenciadas. Por exemplo:
```bash
set mykey 0 60 1
1
STORED
```
Executar o comando "stats slabs" ap√≥s a adi√ß√£o de chaves fornece estat√≠sticas detalhadas sobre a utiliza√ß√£o de slabs:
```bash
stats slabs
[...]
```
Este output revela os tipos de slab ativos, chunks utilizados e estat√≠sticas operacionais, oferecendo insights sobre a efici√™ncia das opera√ß√µes de leitura e escrita.

Outro comando √∫til, "stats items", fornece dados sobre evic√ß√µes, restri√ß√µes de mem√≥ria e ciclos de vida dos itens:
```bash
stats items
[...]
```
### **Despejando Chaves**

Para vers√µes anteriores a 1.4.31, as chaves s√£o despejadas por classe de slab usando:
```bash
stats cachedump <slab class> <number of items to dump>
```
Por exemplo, para fazer dump de uma chave na classe #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Este m√©todo itera sobre classes de slab, extraindo e opcionalmente despejando valores de chaves.

### **DESPEJANDO CHAVES MEMCACHE (VER 1.4.31+)**

Com a vers√£o do memcache 1.4.31 e acima, um novo m√©todo mais seguro para despejar chaves em um ambiente de produ√ß√£o √© introduzido, utilizando o modo n√£o-bloqueante conforme detalhado nas [notas de lan√ßamento](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Esta abordagem gera uma sa√≠da extensa, portanto, √© recomendado utilizar o comando 'nc' para efici√™ncia. Exemplos incluem:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **FERRAMENTAS DE DESPEJO**

Tabela [daqui](https://lzone.de/blog).

| Linguagens de Programa√ß√£o | Ferramentas                                                                                                                        | Funcionalidade                                                                                          |                                                                             |         |
| ------------------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                       | [script simples](http://snipt.org/xtP)                                                                                              | Imprime nomes de chaves.                                                                                |                                                                             |         |
| Perl                      | [script simples](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Imprime chaves e valores.                                                                               |                                                                             |         |
| Ruby                      | [script simples](https://gist.github.com/1365005)                                                                                   | Imprime nomes de chaves.                                                                                |                                                                             |         |
| Perl                      | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Ferramenta no m√≥dulo CPAN                                                                              | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                       | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | GUI de Monitoramento do Memcache que tamb√©m permite despejar chaves                                       |                                                                             |         |
| libmemcached              | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Congela seu processo memcached!!!** Tenha cuidado ao usar isso em produ√ß√£o. Ainda assim, voc√™ pode contornar a limita√ß√£o de 1MB e realmente despejar **todas** as chaves. |                                                                             |         |

## Solu√ß√£o de Problemas <a href="#troubleshooting" id="troubleshooting"></a>

### Limite de Dados de 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Observe que antes do memcached 1.4, voc√™ n√£o pode armazenar objetos maiores que 1MB devido ao tamanho m√°ximo padr√£o da laje.

### Nunca Defina um Tempo Limite > 30 Dias! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Se voc√™ tentar "definir" ou "adicionar" uma chave com um tempo limite maior do que o m√°ximo permitido, voc√™ pode n√£o obter o que espera, pois o memcached ent√£o trata o valor como um carimbo de data/hora Unix. Al√©m disso, se o carimbo de data/hora estiver no passado, n√£o far√° nada. Seu comando falhar√° silenciosamente.

Portanto, se voc√™ deseja usar o tempo de vida m√°ximo, especifique 2592000. Exemplo:
```
set my_key 0 2592000 1
1
```
### Chaves Desaparecendo em Overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Apesar da documenta√ß√£o mencionar algo sobre o envolvimento de 64 bits em um valor que transborda usando "incr", faz com que o valor desapare√ßa. √â necess√°rio cri√°-lo novamente usando "add"/"set".

### Replica√ß√£o <a href="#replication" id="replication"></a>

O memcached em si n√£o suporta replica√ß√£o. Se realmente precisar, √© necess√°rio usar solu√ß√µes de terceiros:

- [repcached](http://repcached.lab.klab.org/): Replica√ß√£o ass√≠ncrona multi-mestre (conjunto de patches memcached 1.2)
- [Interface memcached do Couchbase](http://www.couchbase.com/memcached): Use o CouchBase como substituto do memcached
- [yrmcds](https://cybozu.github.io/yrmcds/): Armazenamento de valor de chave Mestre-Escravo compat√≠vel com memcached
- [twemproxy](https://github.com/twitter/twemproxy) (tamb√©m conhecido como nutcracker): proxy com suporte a memcached

### Folha de Dicas de Comandos

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

- `port:11211 "STAT pid"`
- `"STAT pid"`

## Refer√™ncias

- [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

- Se deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
