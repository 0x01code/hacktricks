# 11211 - Kupima Usalama wa Memcache

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalamu wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa za Itifaki

Kutoka [wikipedia](https://en.wikipedia.org/wiki/Memcached):

> **Memcached** (matamshi: mem-cashed, mem-cash-dee) ni mfumo wa kusambaza kumbukumbu ya kawaida ya [kumbukumbu ya kache](https://en.wikipedia.org/wiki/Memory\_caching). Mara nyingi hutumiwa kuongeza kasi ya tovuti za wavuti zinazotumia hifadhidata za kudumu kwa kuhifadhi data na vitu kwenye RAM ili kupunguza idadi ya mara ambazo chanzo cha data nje (kama vile hifadhidata au API) inapaswa kusomwa.

Ingawa Memcached inasaidia SASL, sehemu nyingi zina **hazina uthibitisho**.

**Bandari ya chaguo-msingi:** 11211
```
PORT      STATE SERVICE
11211/tcp open  unknown
```
## Uchambuzi

### Kwa Mkono

Ili kuchukua habari zote zilizohifadhiwa ndani ya kifaa cha memcache unahitaji:

1. Kupata **slabs** na **vitu vilivyopo**
2. Pata **majina ya funguo** za slabs zilizogunduliwa hapo awali
3. Chukua **data iliyohifadhiwa** kwa **kupata majina ya funguo**

Kumbuka kuwa huduma hii ni tu **hifadhi**, kwa hivyo **data inaweza kuonekana na kutoweka**.
```bash
echo "version" | nc -vn -w 1 <IP> 11211      #Get version
echo "stats" | nc -vn -w 1 <IP> 11211        #Get status
echo "stats slabs" | nc -vn -w 1 <IP> 11211  #Get slabs
echo "stats items" | nc -vn -w 1 <IP> 11211  #Get items of slabs with info
echo "stats cachedump <number> 0" | nc -vn -w 1 <IP> 11211  #Get key names (the 0 is for unlimited output size)
echo "get <item_name>" | nc -vn -w 1 <IP> 11211  #Get saved info

#This php will just dump the keys, you need to use "get <item_name> later"
sudo apt-get install php-memcached
php -r '$c = new Memcached(); $c->addServer("localhost", 11211); var_dump( $c->getAllKeys() );'
```
### Mwongozo2

Memcached ni mfumo wa kuhifadhi data ya kumbukumbu ya kati (in-memory caching) ambayo inaweza kutumiwa kuboresha utendaji wa tovuti na programu. Katika mwongozo huu, tutajifunza jinsi ya kufanya pentesting kwenye seva ya Memcached ili kugundua udhaifu na kufanya mashambulizi.

#### Kuanzisha Mazingira

Kabla ya kuanza pentesting, tunahitaji kuwa na mazingira ya Memcached yaliyosanidiwa. Unaweza kufanya hivyo kwa kufuata hatua zifuatazo:

1. Sakinisha Memcached kwenye seva yako.
2. Sanidi Memcached kwa kusikiliza kwenye bandari ya 11211.
3. Hakikisha kuwa Memcached inaruhusu upatikanaji kutoka kwa anwani ya IP ya mtandao wako.

#### Kugundua Memcached

Kabla ya kuanza kufanya mashambulizi, tunahitaji kugundua seva ya Memcached inayopatikana. Tunaweza kutumia zana kama `nmap` au `masscan` kufanya hivyo. Kwa mfano, unaweza kutumia amri ifuatayo:

```bash
nmap -p 11211 --script memcached-info <target>
```

#### Mashambulizi ya Memcached

Kuna aina kadhaa za mashambulizi ambayo tunaweza kufanya kwenye seva ya Memcached. Hapa kuna baadhi yao:

1. Mashambulizi ya kufurika (Flood Attacks): Tunaweza kutumia zana kama `memcrashed` kufanya mashambulizi ya kufurika kwa kutuma maombi mengi ya kumbukumbu kwa seva ya Memcached. Hii inaweza kusababisha kuzidiwa kwa rasilimali na kusababisha kukwama kwa seva.

2. Mashambulizi ya kumbukumbu (Memory Attacks): Tunaweza kutumia zana kama `memcrashed` kufanya mashambulizi ya kumbukumbu kwa kuchukua faida ya udhaifu katika itifaki ya Memcached. Hii inaweza kusababisha kuvuja kwa data nyeti au hata kuchukua udhibiti wa seva.

#### Kujilinda dhidi ya Mashambulizi ya Memcached

Ili kujilinda dhidi ya mashambulizi ya Memcached, unaweza kuchukua hatua zifuatazo:

1. Sanidi Memcached kwa usalama: Hakikisha kuwa Memcached imefungwa kwa anwani za IP zinazofaa na bandari zinazofaa. Pia, hakikisha kuwa Memcached haipatikani kutoka kwa mtandao wote.

2. Tumia firewall: Weka firewall kwenye seva yako ili kuzuia upatikanaji usioidhinishwa kwenye bandari ya Memcached.

3. Fanya upya ufungaji wa Memcached: Ikiwa una wasiwasi kuwa seva yako imeathiriwa, fanya upya ufungaji wa Memcached na sanidi upya mipangilio yote.

Kwa kufuata hatua hizi, unaweza kujilinda dhidi ya mashambulizi ya Memcached na kuhakikisha usalama wa seva yako.
```bash
sudo apt install libmemcached-tools
memcstat --servers=127.0.0.1 #Get stats
memcdump --servers=127.0.0.1 #Get all items
memccat  --servers=127.0.0.1 <item1> <item2> <item3> #Get info inside the item(s)
```
### Kiotomatiki

Memcached is a widely used in-memory caching system that is often deployed in web applications to improve performance. However, misconfigurations in Memcached can lead to security vulnerabilities that can be exploited by attackers.

One common misconfiguration is leaving the Memcached service exposed to the internet without any authentication. This allows anyone to connect to the Memcached service and perform various operations, including retrieving and modifying data.

To automate the process of identifying and exploiting misconfigured Memcached instances, you can use tools like `memcrashed` or `Memcrashed-DDoS-Exploit`. These tools leverage the Memcached protocol to send a large number of UDP packets to the target Memcached server, causing it to amplify the traffic and potentially overload the target's network.

To use these tools, you need to provide the IP address of the target Memcached server and specify the port on which the Memcached service is running (usually port 11211). The tools will then send a series of commands to the Memcached server, such as `stats`, `get`, or `set`, to gather information or manipulate data.

It is important to note that exploiting misconfigured Memcached instances without proper authorization is illegal and unethical. These tools should only be used for legitimate purposes, such as penetration testing or security research, with the explicit permission of the target organization.

To protect your own Memcached instances from being exploited, make sure to follow best practices such as enabling authentication, restricting access to trusted networks, and regularly updating and patching the Memcached software.
```bash
nmap -n -sV --script memcached-info -p 11211 <IP>   #Just gather info
msf > use auxiliary/gather/memcached_extractor      #Extracts saved data
msf > use auxiliary/scanner/memcached/memcached_amp #Check is UDP DDoS amplification attack is possible
```
## **Kudondosha Funguo za Memcache**

Katika ulimwengu wa memcache, itifaki inayosaidia kuandaa data kwa njia ya slabs, amri maalum zipo kwa ajili ya kuangalia data iliyohifadhiwa, ingawa kuna vikwazo muhimu:

1. Funguo zinaweza kudondoshwa tu kwa darasa la slab, kwa kuchanganya funguo zenye ukubwa sawa wa maudhui.
2. Kuna kikomo cha ukurasa mmoja kwa darasa la slab, sawa na 1MB ya data.
3. Kipengele hiki ni kisicho rasmi na kinaweza kuachwa wakati wowote, kama ilivyozungumziwa katika [majadiliano ya jamii](https://groups.google.com/forum/?fromgroups=#!topic/memcached/1-T8I-RVGKM).

Kikwazo cha kuweza kudondosha tu 1MB kutoka kwenye data inayoweza kuwa gigabytes ni muhimu sana. Walakini, kazi hii bado inaweza kutoa ufahamu juu ya mifumo ya matumizi ya funguo, kulingana na mahitaji maalum. Kwa wale ambao hawana nia kubwa na uhandisi, kutembelea [sehemu ya zana](https://lzone.de/cheat-sheet/memcached#tools) kunafunua zana za kudondosha kwa kina. Vinginevyo, mchakato wa kutumia telnet kwa mwingiliano moja kwa moja na mipangilio ya memcached imeelezewa hapa chini.

### **Jinsi Inavyofanya Kazi**

Utaratibu wa kumbukumbu ya memcache ni muhimu. Kuanzisha memcache na chaguo la "-vv" kunafunua darasa za slab inazozalisha, kama inavyoonyeshwa hapa chini:
```bash
$ memcached -vv
slab class   1: chunk size        96 perslab   10922
[...]
```
Kutazama slabs zote zilizopo kwa sasa, tumia amri ifuatayo:
```bash
stats slabs
```
Kuongeza ufunguo mmoja kwa memcached 1.4.13 inaonyesha jinsi darasa za slab zinavyojazwa na kusimamiwa. Kwa mfano:
```bash
set mykey 0 60 1
1
STORED
```
Kutekeleza amri ya "stats slabs" baada ya kuongeza funguo hutoa takwimu za kina kuhusu matumizi ya slabu:
```bash
stats slabs
[...]
```
Hii matokeo inaonyesha aina za slab zilizopo, vipande vilivyotumika, na takwimu za uendeshaji, zinazotoa ufahamu juu ya ufanisi wa operesheni za kusoma na kuandika.

Amri nyingine muhimu, "stats items", hutoa data juu ya kuondolewa, mipaka ya kumbukumbu, na mzunguko wa vitu:
```bash
stats items
[...]
```
Takwimu hizi zinaruhusu makadirio yenye elimu kuhusu tabia ya kuhifadhi programu, ikiwa ni pamoja na ufanisi wa kuhifadhi kwa ukubwa tofauti wa yaliyomo, ugawaji wa kumbukumbu, na uwezo wa kuhifadhi vitu vikubwa.

### **Kuweka Njia za Kuhifadhi**

Kwa toleo kabla ya 1.4.31, njia za kuhifadhi hutiwa kwa kutumia darasa la slab kwa kutumia:
```bash
stats cachedump <slab class> <number of items to dump>
```
Kwa mfano, kumwaga ufunguo katika darasa #1:
```bash
stats cachedump 1 1000
ITEM mykey [1 b; 1350677968 s]
END
```
Mbinu hii inarudia darasa za slab, ikitoa na ikidump muhimu za ufunguo.

### **KUDUMP MEMCACHE UFUNGUO (VER 1.4.31+)**

Kuanzia toleo la memcache 1.4.31 na zaidi, njia mpya na salama ya kudump muhimu katika mazingira ya uzalishaji imeletwa, ikitumia hali ya kutofungwa kama ilivyoelezwa katika [taarifa za kutolewa](https://github.com/memcached/memcached/wiki/ReleaseNotes1431). Njia hii inazalisha matokeo mengi, hivyo inapendekezwa kutumia amri ya 'nc' kwa ufanisi. Mifano ni pamoja na:
```bash
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | head -1
echo 'lru_crawler metadump all' | nc 127.0.0.1 11211 | grep ee6ba58566e234ccbbce13f9a24f9a28
```
### **VIFAA VYA KUDUMU**

Jedwali [kutoka hapa](https://lzone.de/blog).

| Lugha za Programu | Vifaa                                                                                                                              | Uwezo                                                                                                                                                                  |                                                                             |         |
| ----------------- | ---------------------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------------------------------------------------------------------------------------------------------------------------- | --------------------------------------------------------------------------- | ------- |
| PHP               | [script rahisi](http://snipt.org/xtP)                                                                                              | Inachapisha majina ya funguo.                                                                                                                                          |                                                                             |         |
| Perl              | [script rahisi](https://wiki.jasig.org/download/attachments/13572172/memcached-clean.pl?version=1\&modificationDate=1229693957401) | Inachapisha majina na thamani za funguo.                                                                                                                               |                                                                             |         |
| Ruby              | [script rahisi](https://gist.github.com/1365005)                                                                                   | Inachapisha majina ya funguo.                                                                                                                                          |                                                                             |         |
| Perl              | [memdump](https://search.cpan.org/\~dmaki/Memcached-libmemcached-0.4202/src/libmemcached/docs/memdump.pod)                         | Zana katika moduli ya CPAN                                                                                                                                             | [Memcached-libmemcached](https://search.cpan.org/\~dmaki/Memcached-libmemc) | ached/) |
| PHP               | [memcache.php](http://livebookmark.net/journal/2008/05/21/memcachephp-stats-like-apcphp/)                                          | Kiolesura cha Ufuatiliaji cha Memcache ambacho pia kinaruhusu kudumu kwa funguo                                                                                         |                                                                             |         |
| libmemcached      | [peep](http://blog.evanweaver.com/2009/04/20/peeping-into-memcached/)                                                              | **Inafungia mchakato wako wa memcached!!!** Kuwa makini unapotumia hii katika uzalishaji. Hata hivyo, unaweza kuzunguka kizuizi cha 1MB na kudumu kweli **funguo zote**. |                                                                             |         |

## Kutatua Matatizo <a href="#troubleshooting" id="troubleshooting"></a>

### Kikomo cha Data cha 1MB <a href="#1mb-data-limit" id="1mb-data-limit"></a>

Tafadhali kumbuka kuwa kabla ya memcached 1.4 huwezi kuhifadhi vitu vikubwa kuliko 1MB kutokana na ukubwa wa kawaida wa slab.

### Kamwe Usiweke Muda wa Mwisho > Siku 30! <a href="#never-set-a-timeout--30-days" id="never-set-a-timeout--30-days"></a>

Ikiwa unajaribu "kuweka" au "kuongeza" funguo na muda wa mwisho mkubwa kuliko kiwango kilichoruhusiwa, huenda usipate matokeo unayotarajia kwa sababu memcached itachukulia thamani hiyo kama alama ya wakati ya Unix. Pia, ikiwa alama ya wakati iko nyuma, haitafanya chochote kabisa. Amri yako itashindwa kimya kimya.

Kwa hivyo, ikiwa unataka kutumia muda wa maisha wa kiwango cha juu, taja 2592000. Mfano:
```
set my_key 0 2592000 1
1
```
### Vipengele Vinavyotoweka kwa Kujaa <a href="#disappearing-keys-on-overflow" id="disappearing-keys-on-overflow"></a>

Licha ya nyaraka kusema kitu kuhusu kuzunguka kwa 64bit kwa kujaa kwa thamani kwa kutumia "incr" husababisha thamani kutoweka. Inahitaji kuundwa tena kwa kutumia "add" / "set".

### Ulinganishaji <a href="#replication" id="replication"></a>

memcached yenyewe haishikilii ulinganishaji. Ikiwa unahitaji kweli, unahitaji kutumia suluhisho za tatu:

* [repcached](http://repcached.lab.klab.org/): Ulinganishaji wa asinkroni wa multi-master (seti ya patch ya memcached 1.2)
* [Kioo cha Couchbase memcached](http://www.couchbase.com/memcached): Tumia CouchBase kama mbadala wa memcached
* [yrmcds](https://cybozu.github.io/yrmcds/): Uhifadhi wa thamani ya ufunguo wa Mwalimu-Mtumwa unaofanana na memcached
* [twemproxy](https://github.com/twitter/twemproxy) (inayojulikana pia kama nutcracker): proksi yenye msaada wa memcached

### Orodha ya Amri za Kudanganya

{% content-ref url="memcache-commands.md" %}
[memcache-commands.md](memcache-commands.md)
{% endcontent-ref %}

### **Shodan**

* `port:11211 "STAT pid"`
* `"STAT pid"`

## Marejeo

* [https://lzone.de/cheat-sheet/memcached](https://lzone.de/cheat-sheet/memcached)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
