# 5353/UDP Multicast DNS (mDNS) et DNS-SD

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Le Multicast DNS (mDNS) est un **protocole de configuration z√©ro** qui vous permet d'effectuer des **op√©rations similaires √† DNS** sur le r√©seau local en l'absence d'un serveur DNS unicast conventionnel. Le protocole utilise la **m√™me** API, les **formats de paquets**, et la s√©mantique de fonctionnement que DNS, vous permettant de r√©soudre des noms de domaine sur le r√©seau local. **DNS Service Discovery (DNS-SD)** est un protocole qui permet aux clients de **d√©couvrir une liste d'instances nomm√©es de services** (comme test.\_ipps.\_tcp.local, ou linux.\_ssh.\_tcp.local) dans un domaine en utilisant des requ√™tes DNS standard. DNS-SD est le plus souvent utilis√© en conjonction avec mDNS mais n'en d√©pend pas. Ils sont tous deux utilis√©s par de nombreux appareils IoT, tels que les imprimantes r√©seau, les Apple TVs, les Google Chromecast, les dispositifs de stockage en r√©seau (NAS), et les cam√©ras.\
**Port par d√©faut :** 5353/UDP
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
### Fonctionnement de mDNS

Les appareils utilisent mDNS lorsque le r√©seau local **manque** d'un **serveur DNS unicast** conventionnel. Pour r√©soudre un nom de domaine pour une adresse locale en utilisant mDNS, l'appareil envoie une **requ√™te DNS pour un nom de domaine** se terminant par **.local** √† l'**adresse multicast** 224.0.0.251 (pour IPv4) ou FF02::FB (pour IPv6). Vous pouvez √©galement utiliser mDNS pour r√©soudre des **noms de domaine globaux** (non .local), mais les impl√©mentations de mDNS sont cens√©es **d√©sactiver** ce comportement par d√©faut. Les requ√™tes et r√©ponses mDNS utilisent **UDP** et **le port 5353** comme port source et de destination.

Les r√©ponses mDNS contiennent plusieurs drapeaux importants, y compris une valeur **Time-to-Live** (TTL) qui signifie combien de secondes l'enregistrement est valide. Envoyer une r√©ponse avec **TTL=0 signifie que l'enregistrement correspondant doit √™tre effac√©**. Un autre drapeau important est le bit QU, qui indique si la requ√™te est une requ√™te unicast ou non. Si le **bit QU n'est pas d√©fini**, le paquet est une requ√™te **multicast** (QM). Comme il est possible de **recevoir des requ√™tes unicast en dehors du lien local**, les impl√©mentations s√©curis√©es de mDNS devraient toujours **v√©rifier que l'adresse source dans le paquet correspond √† la plage d'adresses du sous-r√©seau local**.

### Fonctionnement de DNS-SD

DNS-SD permet aux clients de **d√©couvrir les services disponibles sur le r√©seau**. Pour l'utiliser, les clients envoient des requ√™tes DNS standard pour des enregistrements pointeur (PTR), qui associent le type de service √† une liste de noms d'instances sp√©cifiques de ce type de service.

Pour demander un enregistrement PTR, les clients utilisent le format de nom "\<Service>.\<Domain>". La partie **\<Service>** est le **nom du service** pr√©c√©d√© de "\_" (par exemple, \_ipps, \_printer ou \_ipp) et soit **\_tcp ou \_udp**. La portion **\<Domain>** est "**.local**".\
Les **r√©pondeurs** renvoient ensuite les enregistrements PTR qui pointent vers les enregistrements de **service (SRV)** et de **texte (TXT)** correspondants. Voici un exemple d'un enregistrement PTR :
```
_ipps._tcp.local: type PTR, class IN, test._ipps._tcp.local
```
La partie du record PTR √† la **gauche** du deux-points est son **nom**, et la partie √† la **droite** est le **record SRV** vers lequel le record PTR pointe. Le record **SRV** liste la cible **h√¥te** et le **port** o√π l'instance du **service** peut √™tre atteinte. Par exemple, l'image suivante montre un record SRV "test.\_ipps.\_tcp.local" dans Wireshark sur l'h√¥te ubuntu.local et le port 8000 :

![](<../.gitbook/assets/image (651) (1) (1) (1) (1).png>)

Par cons√©quent, le **nom du record SRV** est **comme** le record **PTR** **pr√©c√©d√©** par le nom de **\<Instance>** (test dans ce cas). Le record **TXT** a le **m√™me** **nom** que le record **SRV** et contient les informations n√©cessaires lorsque l'adresse IP et le num√©ro de port (contenus dans le record SRV) pour un service ne sont pas suffisants pour l'identifier.

## √ânum√©ration

### nmap
```bash
nmap -Pn -sUC -p5353 192.168.1.2

Starting Nmap 6.46 (http://nmap.org) at 2015-01-01 10:30 GMT
Nmap scan report for 192.168.1.2
PORT     STATE SERVICE
5353/udp open  zeroconf
| dns-service-discovery:
|   9/tcp workstation
|     Address=192.168.1.2
|   22/tcp ssh
|     Address=192.168.1.2
|   22/tcp sftp-ssh
|     Address=192.168.1.2
|   445/tcp smb
|     Address=192.168.1.2
```
### √ânum√©ration du r√©seau

Vous pouvez en apprendre beaucoup sur le r√©seau local en envoyant simplement des requ√™tes mDNS et en capturant le trafic mDNS multicast.

Vous pouvez utiliser l'outil [**Pholus**](https://github.com/aatlasis/Pholus/) pour envoyer des requ√™tes mDNS (-rq) sur le r√©seau local et capturer le trafic mDNS multicast (pour -stimeout 10 secondes) :
```bash
sudo python3 pholus3.py eth0 -rq -stimeout 10
```
## Attaques

### Exploiter la phase de sondage mDNS

Lorsqu'un r√©pondant mDNS d√©marre ou change sa connectivit√©, il interroge le r√©seau local pour savoir s'il existe **une ressource portant le nom qu'il pr√©voit d'utiliser**. Si la r√©ponse contient l'enregistrement en question, l'h√¥te de sondage **doit choisir un nouveau nom**. Si 15 conflits surviennent en 10 secondes, l'h√¥te doit ensuite attendre au moins cinq secondes avant toute nouvelle tentative. De plus, si une minute s'√©coule pendant laquelle l'h√¥te ne parvient pas √† trouver un nom inutilis√©, il signale une erreur √† l'utilisateur.

La ligne de commande suivante emp√™chera tout nouvel appareil d'obtenir un nouveau nom, car elle indiquera que **tout nom est d√©j√† pris** :
```bash
sudo python pholus.py eth0 -afre -stimeout 1000
```
### Spoofing/MitM

L'attaque la plus int√©ressante que vous pouvez r√©aliser sur ce service est d'effectuer un **MitM** dans **la communication entre le client et le vrai serveur**. Vous pourriez √™tre en mesure d'obtenir des fichiers sensibles (MitM la communication avec l'imprimante) ou m√™me des identifiants (authentification Windows).\
Pour plus d'informations, consultez :

{% content-ref url="../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

## R√©f√©rences

* [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical\_IoT\_Hacking.html?id=GbYEEAAAQBAJ\&redir\_esc=y)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
