# 5353/UDP Multicast DNS (mDNS) e DNS-SD

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes B√°sicas

Multicast DNS (mDNS) √© um **protocolo de configura√ß√£o zero** que permite realizar **opera√ß√µes semelhantes ao DNS** na rede local na aus√™ncia de um servidor DNS unicast convencional. O protocolo utiliza a **mesma** API, **formatos de pacotes** e sem√¢nticas de opera√ß√£o que o DNS, permitindo resolver nomes de dom√≠nio na rede local. **DNS Service Discovery (DNS-SD)** √© um protocolo que permite aos clientes **descobrir uma lista de inst√¢ncias nomeadas de servi√ßos** (como test.\_ipps.\_tcp.local ou linux.\_ssh.\_tcp.local) em um dom√≠nio usando consultas DNS padr√£o. DNS-SD √© mais frequentemente usado em conjunto com mDNS, mas n√£o depende dele. Ambos s√£o usados por muitos dispositivos IoT, como impressoras de rede, Apple TVs, Google Chromecast, dispositivos de armazenamento conectados √† rede (NAS) e c√¢meras.\
**Porta padr√£o:** 5353/UDP
```
PORT     STATE SERVICE
5353/udp open  zeroconf
```
### Como o mDNS Funciona

Dispositivos usam mDNS quando a rede local **carece** de um **servidor DNS unicast** convencional. Para resolver um nome de dom√≠nio para um endere√ßo local usando mDNS, o dispositivo envia uma **consulta DNS para um nome de dom√≠nio** terminado em **.local** para o **endere√ßo multicast** 224.0.0.251 (para IPv4) ou FF02::FB (para IPv6). Voc√™ tamb√©m pode usar mDNS para resolver **nomes de dom√≠nio globais** (n√£o terminados em .local), mas as implementa√ß√µes de mDNS devem **desativar** esse comportamento por padr√£o. Solicita√ß√µes e respostas mDNS usam **UDP** e **porta 5353** como porta de origem e destino.

As respostas mDNS cont√™m v√°rias flags importantes, incluindo um valor de **Time-to-Live** (TTL) que indica quantos segundos o registro √© v√°lido. Enviar uma resposta com **TTL=0 significa que o registro correspondente deve ser apagado**. Outra flag importante √© o bit QU, que indica se a consulta √© uma consulta unicast ou n√£o. Se o **bit QU n√£o estiver definido**, o pacote √© uma consulta **multicast** (QM). Como √© poss√≠vel **receber consultas unicast fora do link local**, implementa√ß√µes seguras de mDNS devem sempre **verificar se o endere√ßo de origem no pacote corresponde √† faixa de endere√ßo da sub-rede local**.

### Como o DNS-SD Funciona

DNS-SD permite que clientes **descubram servi√ßos dispon√≠veis na rede**. Para us√°-lo, clientes enviam consultas DNS padr√£o para registros de ponteiros (PTR), que mapeiam o tipo de servi√ßo para uma lista de nomes de inst√¢ncias espec√≠ficas desse tipo de servi√ßo.

Para solicitar um registro PTR, clientes usam o formato de nome "\<Servi√ßo>.\<Dom√≠nio>". A parte **\<Servi√ßo>** √© o **nome do servi√ßo** precedido por "\_" (por exemplo, \_ipps, \_printer ou \_ipp) e **\_tcp ou \_udp**. A parte **\<Dom√≠nio>** √© "**.local**".\
**Respondentes** ent√£o retornam os registros PTR que apontam para os acompanhantes registros de **servi√ßo (SRV)** e **texto (TXT)**. Aqui est√° um exemplo de um registro PTR:
```
_ipps._tcp.local: type PTR, class IN, test._ipps._tcp.local
```
A parte do registro PTR √† **esquerda** do dois pontos √© o seu **nome**, e a parte √† **direita** √© o registro **SRV** ao qual o registro PTR aponta. O registro **SRV** lista o **host** alvo e a **porta** onde a inst√¢ncia do **servi√ßo** pode ser alcan√ßada. Por exemplo, a pr√≥xima imagem mostra um registro SRV "test.\_ipps.\_tcp.local" no Wireshark no host ubuntu.local e porta 8000:

![](<../.gitbook/assets/image (651) (1) (1) (1) (1).png>)

Portanto, o **nome do registro SRV** √© **semelhante** ao registro **PTR** **precedido** pelo nome da **\<Inst√¢ncia>** (test neste caso). O registro **TXT** tem o **mesmo** **nome** que o registro **SRV** e cont√©m as informa√ß√µes necess√°rias quando o endere√ßo IP e o n√∫mero da porta (contidos no registro SRV) para um servi√ßo n√£o s√£o suficientes para identific√°-lo.

## Enumera√ß√£o

### nmap
```bash
nmap -Pn -sUC -p5353 192.168.1.2

Starting Nmap 6.46 (http://nmap.org) at 2015-01-01 10:30 GMT
Nmap scan report for 192.168.1.2
PORT     STATE SERVICE
5353/udp open  zeroconf
| dns-service-discovery:
|   9/tcp workstation
|     Address=192.168.1.2
|   22/tcp ssh
|     Address=192.168.1.2
|   22/tcp sftp-ssh
|     Address=192.168.1.2
|   445/tcp smb
|     Address=192.168.1.2
```
### Enumera√ß√£o de Rede

Voc√™ pode aprender muito sobre a rede local simplesmente enviando solicita√ß√µes mDNS e capturando o tr√°fego mDNS multicast.

Voc√™ pode usar a ferramenta [**Pholus**](https://github.com/aatlasis/Pholus/) para enviar solicita√ß√µes mDNS (-rq) na rede local e capturar o tr√°fego mDNS multicast (por -stimeout 10 segundos):
```bash
sudo python3 pholus3.py eth0 -rq -stimeout 10
```
## Ataques

### Abusando da Fase de Sondagem mDNS

Quando um respondedor mDNS inicia ou altera sua conectividade, ele pergunta √† rede local se h√° **algum recurso com o nome que planeja usar**. Se a resposta contiver o registro em quest√£o, o host de sondagem **deve escolher um novo nome**. Se 15 conflitos ocorrerem em 10 segundos, o host deve ent√£o esperar pelo menos cinco segundos antes de qualquer tentativa adicional. Al√©m disso, se passar um minuto durante o qual o host n√£o conseguir encontrar um nome n√£o utilizado, ele relata um erro ao usu√°rio.

O seguinte comando impedir√° que qualquer novo dispositivo obtenha qualquer novo nome, pois indicar√° que **qualquer nome j√° est√° em uso**:
```bash
sudo python pholus.py eth0 -afre -stimeout 1000
```
### Spoofing/MitM

O ataque mais interessante que voc√™ pode realizar sobre este servi√ßo √© realizar um **MitM** na **comunica√ß√£o entre o cliente e o servidor real**. Voc√™ pode ser capaz de obter arquivos sens√≠veis (MitM na comunica√ß√£o com a impressora) ou at√© mesmo credenciais (autentica√ß√£o do Windows).\
Para mais informa√ß√µes, confira:

{% content-ref url="../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md" %}
[spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md](../generic-methodologies-and-resources/pentesting-network/spoofing-llmnr-nbt-ns-mdns-dns-and-wpad-and-relay-attacks.md)
{% endcontent-ref %}

## Refer√™ncias

* [Practical IoT Hacking: The Definitive Guide to Attacking the Internet of Things](https://books.google.co.uk/books/about/Practical\_IoT\_Hacking.html?id=GbYEEAAAQBAJ\&redir\_esc=y)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>
