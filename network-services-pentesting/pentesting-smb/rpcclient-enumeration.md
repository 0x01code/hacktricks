# rpcclient枚举

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

### **什么是RID**

[相对标识符（RID）](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers)是Windows用于**跟踪和识别对象**的**唯一标识符**（以十六进制格式表示）。为了解释这个概念，让我们看一下下面的例子：

* NAME\_DOMAIN.LOCAL域的[SID](https://docs.microsoft.com/en-us/windows/security/identity-protection/access-control/security-identifiers)是：`S-1-5-21-1038751438-1834703946-36937684957`。
* 当在域中创建一个对象时，上述数字（SID）将与RID组合，以生成用于表示该对象的唯一值。
* 因此，具有RID：\[0x457] Hex 0x457等于十进制`1111`的域用户`john`将具有完整的用户SID：`S-1-5-21-1038751438-1834703946-36937684957-1111`。
* 这对于NAME\_DOMAIN.LOCAL域中的`john`对象是唯一的，您将永远不会看到此配对值与该域或任何其他域中的另一个对象相关联。

定义来自[**这里**](https://academy.hackthebox.com/module/143/section/1269)。

### **使用rpcclient进行枚举**

**本节的一部分摘自书籍 "**_**网络安全评估第三版**_**"**

您可以使用Samba的**`rpcclient`**实用程序通过命名管道与**RPC端点**进行交互。以下是您可以在**建立**SMB会话后（通常需要凭据）向SAMR、LSARPC和LSARPC-DS接口发出的命令列表。

#### 服务器信息

* **服务器信息**：`srvinfo`

#### 用户枚举

* **列出用户**：`querydispinfo`和`enumdomusers`
* **获取用户详细信息**：`queryuser <0xrid>`
* **获取用户组**：`queryusergroups <0xrid>`
* **获取用户的SID**：`lookupnames <username>`
* **获取用户别名**：`queryuseraliases [builtin|domain] <sid>`
```bash
# Brute-Force users RIDs
for i in $(seq 500 1100); do
rpcclient -N -U "" 10.129.14.128 -c "queryuser 0x$(printf '%x\n' $i)" | grep "User Name\|user_rid\|group_rid" && echo "";
done

# You can also use samrdump.py for this purpose
```
#### 枚举组

* **列出组**: `enumdomgroups`
* **获取组详细信息**: `querygroup <0xrid>`
* **获取组成员**: `querygroupmem <0xrid>`

#### 枚举别名组

* **列出别名**: `enumalsgroups <builtin|domain>`
* **获取成员**: `queryaliasmem builtin|domain <0xrid>`

#### 枚举域

* **列出域**: `enumdomains`
* **获取SID**: `lsaquery`
* **域信息**: `querydominfo`

#### 枚举共享

* **枚举所有可用共享**: `netshareenumall`
* **共享信息**: `netsharegetinfo <share>`

#### 更多SID

* **通过名称查找SID**: `lookupnames <username>`
* **查找更多SID**: `lsaenumsid`
* **RID循环（检查更多SID）**: `lookupsids <sid>`

#### **额外命令**

| **命令**             | **接口**                                                                                                                                         | **描述**                                                                                                                             |
| ------------------- | ------------------------------------------------------------------------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------------------------------------------------------- |
| queryuser           | SAMR                                                                                                                                              | 检索用户信息                                                                                                                         |
| querygroup          | 检索组信息                                                                                                                                        |                                                                                                                                     |
| querydominfo        | 检索域信息                                                                                                                                       |                                                                                                                                     |
| enumdomusers        | 枚举域用户                                                                                                                                        |                                                                                                                                     |
| enumdomgroups       | 枚举域组                                                                                                                                          |                                                                                                                                     |
| createdomuser       | 创建域用户                                                                                                                                        |                                                                                                                                     |
| deletedomuser       | 删除域用户                                                                                                                                        |                                                                                                                                     |
| lookupnames         | LSARPC                                                                                                                                            | 查找用户名到SID[a](https://learning.oreilly.com/library/view/network-security-assessment/9781491911044/ch08.html#ch08fn8)值 |
| lookupsids          | 查找SID到用户名（RID[b](https://learning.oreilly.com/library/view/network-security-assessment/9781491911044/ch08.html#ch08fn9)循环） |                                                                                                                                     |
| lsaaddacctrights    | 向用户帐户添加权限                                                                                                                               |                                                                                                                                     |
| lsaremoveacctrights | 从用户帐户中删除权限                                                                                                                             |                                                                                                                                     |
| dsroledominfo       | LSARPC-DS                                                                                                                                         | 获取主域信息                                                                                                                         |
| dsenumdomtrusts     | 枚举AD森林中的受信任域                                                                                                                           |                                                                                                                                     |

要更好地**了解**工具_**samrdump**_和_**rpcdump**_的工作原理，您应该阅读[**Pentesting MSRPC**](../135-pentesting-msrpc.md)。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在HackTricks中**为您的公司做广告**吗？或者您想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>
