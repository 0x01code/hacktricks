# 135, 593 - Pentesting MSRPC

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando os clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos de blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se a lenda do hacker web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

## Informa√ß√µes B√°sicas

Microsoft Remote Procedure Call, tamb√©m conhecido como chamada de fun√ß√£o ou chamada de sub-rotina, √© [um protocolo](http://searchmicroservices.techtarget.com/definition/Remote-Procedure-Call-RPC) que usa o modelo cliente-servidor para permitir que um programa solicite servi√ßo de um programa em outro computador sem precisar entender os detalhes da rede desse computador. O MSRPC foi originalmente derivado de software de c√≥digo aberto, mas foi desenvolvido e protegido por direitos autorais pela Microsoft.

Dependendo da configura√ß√£o do host, o mapeador de ponto de extremidade RPC pode ser acessado atrav√©s das portas TCP e UDP 135, via SMB com uma sess√£o nula ou autenticada (TCP 139 e 445) e como um servi√ßo da web ouvindo na porta TCP 593.
```
135/tcp   open     msrpc         Microsoft Windows RPC
```
## Como funciona o MSRPC?

O processo do MSRPC come√ßa no lado do cliente, com a aplica√ß√£o do cliente chamando um procedimento de stub local em vez de c√≥digo que implementa o procedimento. O c√≥digo de stub do cliente recupera os par√¢metros necess√°rios do espa√ßo de endere√ßo do cliente e os entrega √† biblioteca de tempo de execu√ß√£o do cliente, que ent√£o traduz os par√¢metros em um formato padr√£o de Representa√ß√£o de Dados de Rede para transmitir ao servidor.

O stub do cliente ent√£o chama fun√ß√µes na biblioteca de tempo de execu√ß√£o do cliente RPC para enviar a solicita√ß√£o e os par√¢metros para o servidor. Se o servidor estiver localizado remotamente, a biblioteca de tempo de execu√ß√£o especifica um protocolo de transporte apropriado e um mecanismo e passa o RPC para a pilha de rede para transporte ao servidor.\
A partir daqui: [https://www.extrahop.com/resources/protocols/msrpc/](https://www.extrahop.com/resources/protocols/msrpc/)

![](<../.gitbook/assets/image (133).png>)

**Imagem do livro "**_**Network Security Assesment 3rd Edition**_**"**

## **Identificando Servi√ßos RPC Expostos**

**Se√ß√£o extra√≠da do livro "**_**Network Security Assesment 3rd Edition**_**"**

Voc√™ pode consultar o servi√ßo de localizador RPC e os pontos de extremidade RPC individuais para catalogar servi√ßos interessantes em execu√ß√£o sobre TCP, UDP, HTTP e SMB (por meio de named pipes). Cada valor IFID coletado por meio desse processo denota um servi√ßo RPC (por exemplo, 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc √© a interface Messenger).

As ferramentas rpcdump e ifids do Windows de Todd Sabin consultam tanto o localizador RPC quanto os pontos de extremidade RPC espec√≠ficos para listar os valores IFID. A sintaxe do rpcdump √© a seguinte:
```
D:\rpctools> rpcdump [-p port] 192.168.189.1
IfId: 5a7b91f8-ff00-11d0-a9b2-00c04fb6e6fc version 1.0
Annotation: Messenger Service
UUID: 00000000-0000-0000-0000-000000000000
Binding: ncadg_ip_udp:192.168.189.1[1028]
```
Voc√™ pode acessar o servi√ßo de localiza√ß√£o RPC usando quatro sequ√™ncias de protocolo:

* ncacn\_ip\_tcp e ncadg\_ip\_udp (porta TCP e UDP 135)
* ncacn\_np (o pipe \epmapper nomeado via SMB)
* ncacn\_http (RPC sobre HTTP via porta TCP 80, 593 e outros)
```bash
use auxiliary/scanner/dcerpc/endpoint_mapper
use auxiliary/scanner/dcerpc/hidden
use auxiliary/scanner/dcerpc/management
use auxiliary/scanner/dcerpc/tcp_dcerpc_auditor
rpcdump.py <IP> -p 135
```
_Nota que das op√ß√µes mencionadas, todas exceto **`tcp_dcerpc_auditor`** podem ser executadas apenas contra **msrpc** na porta **135**._

#### Interfaces RPC not√°veis

| **Valor IFID**                       | **Named pipe** | **Descri√ß√£o**                                                                                                                                                                                                                                                                           |
| ------------------------------------ | -------------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| 12345778-1234-abcd-ef00-0123456789ab | \pipe\lsarpc   | Interface LSA, usada para enumerar usu√°rios                                                                                                                                                                                                                                                    |
| 3919286a-b10c-11d0-9ba8-00c04fd92ef5 | \pipe\lsarpc   | Interface LSA Directory Services (DS), usada para enumerar dom√≠nios e relacionamentos de confian√ßa                                                                                                                                                                                                  |
| 12345778-1234-abcd-ef00-0123456789ac | \pipe\samr     | Interface LSA SAMR, usada para acessar elementos p√∫blicos do banco de dados SAM (por exemplo, nomes de usu√°rios) e for√ßar a senha de usu√°rios por for√ßa bruta, independentemente da pol√≠tica de bloqueio de contas [Biblioteca Oreilly](https://learning.oreilly.com/library/view/network-security-assessment/9781491911044/ch08.html#idm139659172852688) |
| 1ff70682-0a51-30e8-076d-740be8cee98b | \pipe\atsvc    | Agendador de tarefas, usado para executar comandos remotamente                                                                                                                                                                                                                                         |
| 338cd001-2244-31f1-aaaa-900038001003 | \pipe\winreg   | Servi√ßo de registro remoto, usado para acessar o registro do sistema                                                                                                                                                                                                                               |
| 367abb81-9844-35f1-ad32-98f038001003 | \pipe\svcctl   | Gerenciador de controle de servi√ßo e servi√ßos do servidor, usado para iniciar e parar servi√ßos remotamente e executar comandos                                                                                                                                                                                |
| 4b324fc8-1670-01d3-1278-5a47bf6ee188 | \pipe\srvsvc   | Gerenciador de controle de servi√ßo e servi√ßos do servidor, usado para iniciar e parar servi√ßos remotamente e executar comandos                                                                                                                                                                                |
| 4d9f4ab8-7d1c-11cf-861e-0020af6e7c57 | \pipe\epmapper | Interface DCOM, suportando WMI                                                                                                                                                                                                                                                            |

### Identificando endere√ßos IP

Usando [https://github.com/mubix/IOXIDResolver](https://github.com/mubix/IOXIDResolver), proveniente da pesquisa da [Airbus](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/), √© poss√≠vel abusar do m√©todo _**ServerAlive2**_ dentro da interface _**IOXIDResolver**_.

Esse m√©todo tem sido usado para obter informa√ß√µes de interface como endere√ßo **IPv6** do HTB box _APT_. Veja [aqui](https://0xdf.gitlab.io/2021/04/10/htb-apt.html) o writeup do APT 0xdf, que inclui um m√©todo alternativo usando rpcmap.py do [Impacket](https://github.com/SecureAuthCorp/impacket/) com _stringbinding_ (veja acima).

Refer√™ncias:

* [https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/](https://www.cyber.airbus.com/the-oxid-resolver-part-1-remote-enumeration-of-network-interfaces-without-any-authentication/)
* [https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/](https://www.cyber.airbus.com/the-oxid-resolver-part-2-accessing-a-remote-object-inside-dcom/)

## Porta 593

O **rpcdump.exe** do [rpctools](https://resources.oreilly.com/examples/9780596510305/tree/master/tools/rpctools) pode interagir com essa porta.

‚Äã

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof √© o lar de todas as recompensas por bugs de criptografia.**

**Seja recompensado sem atrasos**\
As recompensas do HackenProof s√£o lan√ßadas apenas quando os clientes depositam o or√ßamento de recompensa. Voc√™ receber√° a recompensa ap√≥s a verifica√ß√£o do bug.

**Adquira experi√™ncia em pentesting web3**\
Protocolos de blockchain e contratos inteligentes s√£o a nova Internet! Domine a seguran√ßa web3 em seus dias de ascens√£o.

**Torne-se a lenda do hacker web3**\
Ganhe pontos de reputa√ß√£o com cada bug verificado e conquiste o topo do leaderboard semanal.

[**Cadastre-se no HackenProof**](https://hackenproof.com/register) comece a ganhar com seus hacks!

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
