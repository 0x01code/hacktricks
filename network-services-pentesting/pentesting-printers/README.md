# プリンタのペンテスト

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>

**プリンタのペンテストに関連する情報のほとんどは、[http://hacking-printers.net/](http://hacking-printers.net/)で見つけることができる** **巨大で素晴らしい研究**から取得されました。ここではその情報を要約しましたが、トピックについて詳しく学ぶためには常にソースにアクセスできます。

## 基礎知識

プリンタ言語のカプセル化に関する関係の概要は以下の通りです:\\

![プリンタ言語のカプセル化](http://hacking-printers.net/wiki/images/thumb/1/1d/Protocols.png/500px-Protocols.png)

## ネットワーク印刷プロトコル

プリンタデバイスにデータを送信する方法は、**USB/パラレルケーブル**または**ネットワーク**を介して行うことができます。このウィキではネットワーク印刷に焦点を当てていますが、ほとんどの攻撃はローカルプリンタに対しても実行することができます。ネットワーク印刷には、Novellの[_NCP_](https://en.wikipedia.org/wiki/NetWare_Core_Protocol)や[_AppleTalk_](https://en.wikipedia.org/wiki/AppleTalk)などのさまざまなエキゾチックなプロトコルがあります。Windowsの世界では、_SMB/CIFS_プリンタ共有が非常に人気があります。さらに、一部のデバイスは_FTP_や_HTTP_ファイルのアップロードなどの一般的なプロトコルを介して印刷をサポートしています。ただし、ネットワークプリンタが直接サポートしている**最も一般的な印刷プロトコル**は、_**LPD**_**、_**IPP**_**、および**_**raw port 9100**_**です。ネットワーク印刷プロトコルは直接攻撃されることがあります。たとえば、プリンタのLPDデーモンでバッファオーバーフローを悪用することができます。ただし、多くの攻撃シナリオでは、これらのプロトコルは悪意のあるプリンタ言語コードを展開するための**キャリア/チャネル**としてのみ機能します。ネットワークプリンタは通常、ドキュメントを「印刷」するために複数のプロトコルをサポートしているため、攻撃面が広がります。

### **[raw port 9100について詳しくはこちら](../9100-pjl.md)**

### **[Pentesting 515でのLPDについて詳しくはこちら](../515-pentesting-line-printer-daemon-lpd.md)**

### **[Petesting 631でのIPPについて詳しくはこちら](../pentesting-631-internet-printing-protocol-ipp.md)**

## プリンタ制御言語

ジョブ制御言語は、現在の印刷ジョブの出力トレイなどの設定を管理します。通常、印刷プロトコルとページ記述言語の間にオプションのレイヤーとして存在しますが、機能は重複する場合があります。ベンダー固有のジョブ制御言語の例には、[CPCA](http://www.undocprint.org/formats/printer_control_languages/cpca)、[XJCL](http://www.undocprint.org/formats/printer_control_languages/xjcl)、[EJL](http://www.undocprint.org/formats/printer_control_languages/ejl)、および**PJL**があります。PJLはさまざまなプリンタでサポートされており、以下で詳しく説明します。また、**プリンタ制御および管理言語**は、**単一の印刷ジョブだけでなく、デバイス全体**に**影響を与える**ように設計されています。このタスクのために共通の標準を定義するアプローチの1つは、[NPAP](http://www.undocprint.org/formats/printer_control_languages/npap)です。ただし、これは確立されておらず、Lexmarkのみがサポートしています。他のプリンタメーカーは代わりにSNMPまたはその**PJLベース**のメタ言語**PML**を使用します。

### PJL

プリンタジョブ言語（PJL）は、元々HPによって導入されましたが、すぐに印刷ジョブ制御の事実上の標準となりました。'PJLは他のプリンタ言語の上に存在し、用紙トレイやサイズなどの設定を変更するために使用できます。ただし、**PJLは現在の印刷ジョブに限定されるわけではなく、一部の設定は永続的に行うことができます**。PJLはまた、プリンタの表示を変更したり、デバイス上のファイルを読み書きしたりするためにも使用できます。ベンダーはPJLリファレンスにリストされているコマンドのサブセットのみをサポートし、独自のコマンドを追加することが多いため、多くの方言があります。**PJLは、実際の印刷データのファイル形式を設定するためにも使用されます**。このような明示的な言語の切り替えがない場合、プリンタはマジックナンバーに基づいてページ記述言語を識別する必要があります。以下に、PostScriptモードにインタプリタを切り替える前に用紙サイズとコピーの数を設定するための典型的なPJLコマンドの例を示します。
```
@PJL SET PAPER=A4
@PJL SET COPIES=10
@PJL ENTER LANGUAGE=POSTSCRIPT
```
[**ポート9100 'raw port'**のページ](../9100-pjl.md)では、**PJLの列挙方法**についての詳細情報が見つかります。

### PML

**プリンタ管理言語（PML）**は、**HPプリンタ**を制御するための専用言語です。これは基本的に**SNMP**の機能を**PJLと組み合わせたもの**です。公開されているドキュメントは存在しませんが、[LPRng](https://en.wikipedia.org/wiki/LPRng)プロジェクトによって一部の標準が漏洩されました。**PJL Passthrough to PML and SNMP User’s Guide**では、PMLを「オブジェクト指向の要求応答型プリンタ管理プロトコル」と定義し、構文の基本について紹介しています。PMLはPJL内に埋め込まれており、プリンタデバイス上のSNMP値の読み取りと設定に使用することができます。これは特に、**ファイアウォールがSNMPサービス（161/udp）へのアクセスをブロックしている場合に興味深い**です。以下に、プリントジョブ内で`hrDeviceDescr`値（OID 1.3.6.1.2.1.25.3.2.1.3、デバイスのテキスト説明）を取得するためにPMLを使用する例を示します：
```
> @PJL DMINFO ASCIIHEX="000006030302010301"
< "8000000603030201030114106870204c617365724a65742034323530
```
プリンターからの応答である`6870204c617365724a65742034323530`は、16進数で`hp LaserJet 4250`を表しています。これにより、PMLを介してSNMPコマンドの（一部の）呼び出しが可能であることがわかります。PMLのセキュリティに関連する使用法は、通常の印刷ジョブを介してHPプリンターを工場出荷時のデフォルトにリセットすることであり、ユーザーが設定したパスワードなどの保護機構が削除されます。

### UEL

Universal Exit Language（UEL）は、実際には**ジョブ制御の「言語」ではなく、現在のデータストリームを終了するために使用される単一のコマンド**です：エスケープ文字（`\x1b`）の後に`%-12345X`が続きます。これは元々HPのPCLで導入され、**ほとんどの最新のレーザープリンターでサポートされています**。『プリンタードライバー』の良い慣行は、各印刷ジョブの開始時と終了時にUELを呼び出すことで、プリンター言語の解釈が停止/再開され、各ジョブには独自の環境があります。以下に示します：
```
\x1b%-12345X
@PJL SET PAPER=A4
@PJL ENTER LANGUAGE=PCL
...
[PCL datastream]
...
\x1b%-12345X
```
それ以外の場合、たとえば、1つの印刷ジョブで設定されたPJL設定（用紙メディアサイズやPostScriptの定義など）は、次のジョブに影響を与える可能性があります。**UELは、複数のジョブを単一のファイル/データストリームにまとめてプリンタに送信するのに便利です**。これは、**ハードウェアのページカウンター**をだますために使用したり、**クロスサイト印刷攻撃**で印刷言語を切り替えるために使用することができます。

## ページ記述言語

**ページ記述言語（PDL）**は、**実際のドキュメントの外観**を指定します。ただし、一部のPDLは制御が制限されているため、**ページ記述とプリンタ/ジョブ制御言語の明確な区別が常に可能ではありません**。『プリンタドライバ』の機能は、印刷する**ファイル**をプリンタモデルで**理解できるPDL**に**変換**することです。なお、一部の低価格インクジェットプリンタは、高レベルのページ記述言語をサポートしていません。いわゆるホストベースまたは[GDI](https://en.wikipedia.org/wiki/Graphics\_Device\_Interface#GDI\_printers)プリンタは、[ZJS](http://www.undocprint.org/formats/page\_description\_languages/zjstream)のような単純なビットマップデータストリームのみを受け入れますが、実際のレンダリングはプリンタドライバによって行われます。Kyoceraの[PRESCRIBE](http://www.undocprint.org/formats/page\_description\_languages/prescribe)、[SPL](http://www.undocprint.org/formats/page\_description\_languages/spl)、[XES](http://www.undocprint.org/formats/page\_description\_languages/xes)、[CaPSL](http://www.undocprint.org/formats/page\_description\_languages/capsl)、[RPCS](http://www.undocprint.org/formats/page\_description\_languages/rpcs)、[ESC/P](https://en.wikipedia.org/wiki/ESC/P)など、さまざまなプロプライエタリなページ記述言語があります。これらは、ドットマトリックスプリンタで主に使用される[HP-GL](https://en.wikipedia.org/wiki/HPGL)および[HP-GL/2](https://en.wikipedia.org/wiki/HPGL#HP-GL.2F2)、直接の[PDF](https://en.wikipedia.org/wiki/Portable\_Document\_Format)および[XPS](https://en.wikipedia.org/wiki/Open\_XML\_Paper\_Specification)印刷のサポートも、新しいプリンタで一般的です。**ただし、最も一般的な「標準」のページ記述言語はPostScriptとPCLです**。

### PostScript（PS）

「ページ記述」という用語は誤解を招くかもしれませんが、**PostScriptは単なるベクターグラフィックを作成するだけでなく、さらに多くの機能を持っています**。PostScriptは、アドビによって作成されたスタックベースの**チューリング完全**プログラミング言語であり、算術、スタックおよびグラフィックの操作、配列や辞書などのさまざまなデータ型を含む約400の演算子から構成されています。\
技術的には、PostScriptインタプリタへのアクセスはすでに**コードの実行**と分類されることができます。なぜなら、理論的にはどんなアルゴリズム関数でもPostScriptで実装することができるからです。もちろん、ネットワークスタックや追加のオペレーティングシステムライブラリにアクセスできない場合、ビットコインのマイニングなどの任意の数学的計算に限定されます。ただし、PostScriptは、コード、グラフィック、またはフォントファイルを頻繁に使用するための基本的なファイルシステムI/Oも行うことができます。\
元々は機能として設計されたため、このような機能の危険性は、プリンタが相互接続される前には**制限されていました**。リンクされたPostScript（EPS）も注目に値します。これは、[LaTeX](https://en.wikipedia.org/wiki/LaTeX)ドキュメントなどのホストで解釈される他のファイル形式に含まれることができます。**PJL**や**PCL**と同様に、**PostScript**はホストとプリンタ間の**双方向通信**をサポートしています。\
以下に、Hello worldをstdoutにエコーするためのPostScriptコードの例を示します。
```
%!
(Hello world) print
```
BrotherとKyoceraは独自のPostScriptクローン、**Br-Script**と**KPDL**を使用しています。これらのPostScriptのバリエーションは、セキュリティ機能（サーバーループの終了など）に関しては100％互換性がありません。PostScriptは、[サービス拒否攻撃](http://hacking-printers.net/wiki/index.php/Denial\_of\_service)（無限ループによるものなど）、印刷ジョブの[操作](http://hacking-printers.net/wiki/index.php/Print\_job\_manipulation)および[保持](http://hacking-printers.net/wiki/index.php/Print\_job\_retention)、およびプリンタの[ファイルシステム](http://hacking-printers.net/wiki/index.php/File\_system\_access)へのアクセスなど、さまざまな攻撃に使用できます。

#### サーバーループの終了

通常、各印刷ジョブは独自の環境でカプセル化されます。**PostScript**の興味深い機能の1つは、プログラムが印刷ジョブのカプセル化を回避し、後続のジョブのための初期VMを変更できることです。これを行うには、レベル2の機能であるstartjobを使用できます。
```
true 0 startjob
```
またはexitserver（ジョブサーバーを含むすべての実装で利用可能）：
```
serverdict begin 0 exitserver
```
この機能は、デフォルトで `0` のStartJobPasswordによって制御されます（資格情報の漏洩を比較してください）。ジョブサーバーループは通常、ジョブ間でインタプリタの状態をクリーンアップする責任がありますので、サーバーループの外で行われた変更は、すべての後続のジョブの永続的なインタプリタの状態の一部として残ります。言い換えれば、印刷ジョブは他のジョブにアクセスして変更することができます。ビンゴ！

#### オペレータの再定義

**PostScript**ドキュメントが**オペレータを呼び出す**とき、辞書スタックで最初に見つかったバージョンが使用されます。オペレータは通常、systemdict辞書に存在しますが、userdict辞書に新しいバージョンを配置することで、オペレータを実質的に上書きすることができます。なぜなら、**ユーザー定義のバージョンが辞書スタックで最初に見つかるからです**。startjob/exitserverオペレータを使用することで、このような変更を永続的に行うことができますが、プリンタが再起動されるまでです。以下にPostScript辞書スタックのスキームを示します：

\
[![The PostScript dictionary stack](http://hacking-printers.net/wiki/images/thumb/f/ff/Dictstack.png/300px-Dictstack.png)](http://hacking-printers.net/wiki/index.php/File:Dictstack.png)

\
**オペレータの再定義の潜在的な影響**は、創造力によってのみ制限されます。さらに正当なドキュメントが印刷され、再定義されたオペレータが呼び出されると、攻撃者のバージョンが実行されます。これにより、[サービス拒否](http://hacking-printers.net/wiki/index.php/Document\_processing#Showpage\_redefinition)、印刷ジョブの[保持](http://hacking-printers.net/wiki/index.php/Print\_job\_retention)、および[操作](http://hacking-printers.net/wiki/index.php/Print\_job\_manipulation)など、さまざまな攻撃が行われる可能性があります。ただし、これは必ずしもセキュリティのバグではなく、32年前の言語機能であり、ほとんどのPostScriptプリンターと[RIP](https://en.wikipedia.org/wiki/Raster\_image\_processor)で利用可能です。

### PCL

PCL 3およびPCL 4は、フォントとマクロのサポートを追加しましたが、これらはデバイスに永久的にダウンロードされます。ただし、ファイルシステムへの直接アクセスは意図されていませんので、ファイル名ではなく数値IDで参照されます。PCL 1から5は、エスケープシーケンスに続いて解釈されるコマンドを表す1つ以上のASCII文字で構成されています。PCL 6 Enhancedまたは「PCL XL」は、バイナリエンコードされたオブジェクト指向プロトコルを使用します。以下に「Hello world」を印刷するための例となるPCLドキュメントが示されています：
```
<Esc>Hello world
```
PCLはセキュリティの観点からは**攻撃が難しい**ため、特定のプリンタメーカーのPCLフレーバーにおいて興味深いプロプライエタリコマンドを発見しない限り、悪用することは困難です。**PRET**ツールは、**仮想のPCLベースのファイルシステム**を実装しており、マクロを使用してファイルの内容とメタデータをプリンタのメモリに保存します。このハックは、PCLのような最小限のページ記述言語のみをサポートするデバイスでも、著作権侵害物などの任意のファイルを保存するために使用できることを示しています。プリンタをファイル共有サービスに変えること自体はセキュリティ上の脆弱性ではありませんが、企業のポリシーによっては「サービスの誤用」として適用される場合があります。

## その他の攻撃

### USBドライブまたはケーブル

データは[USB](https://en.wikipedia.org/wiki/USB)または[パラレル](https://en.wikipedia.org/wiki/IEEE\_1284)ケーブルを介してローカルプリンタに送信および受信することができます。**PRET**は、デバイスと通信するためにこれらの両方のチャネルをサポートしています。さらに、プリンタやMFPには、ユーザーがUSBデバイスから直接印刷できるType-A USBポートが搭載されていることがよくあります。\
USBプリンタの悪用には、攻撃者がデバイスに物理的にアクセスする必要がありますが、これはほとんどの機関や企業にとって完全に現実的ではありません。プリンタへの物理的アクセスを獲得することは、サーバーやワークステーションなどの他のネットワークコンポーネントに比べて一般的には難しいとは言えません。

### クロスサイト印刷

攻撃者は、クライアントの内部ネットワークに接続されたクライアントの悪意のあるウェブページを介して任意のプリンタを悪用することができます。\
[**ここでそれが可能になる方法を学びましょう。**](cross-site-printing.md)

### ADのスプーラーサービスの悪用

ドメイン内で**スプーラーサービスがリッスン**している場合、それを**悪用**して新しい資格情報を**取得**し、特権を**エスカレート**することができるかもしれません。\
[**スプーラーサービスの悪用方法の詳細についてはこちらを参照してください。**](../../windows-hardening/active-directory-methodology/printers-spooler-service-abuse.md)

## 特権エスカレーション

### 工場出荷時設定

デバイスを工場出荷時の設定に**リセット**するためのいくつかの方法があります。これは、ユーザーが設定したパスワードなどの保護メカニズムを**上書き**するなど、セキュリティ上重要な機能です。\
[**詳細はこちらを参照してください。**](factory-defaults.md)

### **会計バイパス**

既存のユーザーまたは存在しないユーザーを**なりすまして**彼らのアカウントを使用してページを印刷したり、ハードウェアまたはソフトウェアの**カウンタ**を**操作**してより多くのページを印刷したりすることができるかもしれません。\
[**ここでそれを行う方法を学びましょう。**](accounting-bypass.md)

### **スキャナとファックス**

スキャナやファックスの機能にアクセスすることで、他の機能にアクセスすることができるかもしれませんが、これはすべてベンダーに依存します。\
[**詳細はこちらを参照してください。**](scanner-and-fax.md)

## **印刷ジョブへのアクセス**

### **印刷ジョブの保持**

ジョブはメモリに**保持**され、**コントロールパネルから後で再印刷**することができます。また、**PostScript**を使用すると、**印刷される予定のすべてのジョブにリモートでアクセスし、ダウンロード**して印刷することもできます。\
[**詳細はこちらを参照してください。**](print-job-retention.md)

### **印刷ジョブの操作**

印刷されるページに**新しいコンテンツ**を追加したり、印刷されるすべてのコンテンツを**変更**したり、特定の文字や単語だけを**置換**したりすることができます。\
[**ここでそれを行う方法を学びましょう。**](print-job-manipulation.md)

## **情報の漏洩**

### **メモリアクセス**

**NVRAM**メモリを**ダンプ**し、そこから（パスワードなどの）機密情報を**抽出**することができるかもしれません。\
[**ここでその方法を読んでください。**](memory-access.md)

### **ファイルシステムアクセス**

**PJL**または**PostScript**を悪用して、ファイルシステムに**アクセス**することができるかもしれません。\
[**ここでその方法を読んでください。**](file-system-access.md)

### **資格情報の漏洩/ブルートフォース**

**SNMP**や**LDAP**の設定を悪用してパスワードを**漏洩**することができるかもしれません。また、**PJL**や**PostScript**を**ブルートフォース**することもできます。\
[**ここでその方法を読んでください。**](credentials-disclosure-brute-force.md)

## **コード実行**

### **バッファオーバーフロー**

**PJL入力**や**LPDデーモン**で既にいくつかの**バッファオーバーフロー**が見つかっており、さらに存在する可能性があります。\
[**詳細についてはこちらを読んでください。**](buffer-overflows.md)

### ファームウェアの更新

プリンタに対して特別に作成した悪意のあるドライバでドライバを更新させることができるかもしれません。\
[**詳細についてはこちらを読んでください。**](firmware-updates.md)

### **ソフトウェアパッケージ**

プリンタベンダーは、デバイスにカスタムソフトウェアをインストールする**可能性を導入**し始めましたが、情報は一般には公開されていません。プリンタ上で実行されるカスタマイズされたソフ
- **あなたのハッキングのテクニックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>
