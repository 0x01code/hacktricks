<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください**。

</details>


# **はじめに**

**許可なく印刷する**こと自体がセキュリティリスクであり、会社のポリシー違反になる場合があります。印刷ジョブに料金がかかる環境では、内部攻撃者は会計システムをバイパスする動機を持っています。さらに、ネットワークプリンタに対するほとんどの攻撃には、「印刷」することが前提条件となります。

印刷ジョブの会計には、2つの主要なアプローチがあります。**プリンタ自体で処理するか、プリントサーバを使用するか**です。最初のアプローチはベンダー固有であり、通常は特殊な「プリンタドライバ」を使用しますが、ここでは詳しく説明しません。もう一つのアプローチは、[CUPS](https://en.wikipedia.org/wiki/CUPS)や[LPRng](https://en.wikipedia.org/wiki/LPRng)などのソフトウェア実装である別個のプリントサーバを使用して会計を処理する方法であり、企業や機関で一般的です。プリントサーバはLPD、IPP、その他の印刷プロトコルを使用してジョブを実際のプリンタに転送します。**プリンタへの直接ネットワークアクセスを制限することが重要**です。そうしないと、攻撃者は簡単にプリントサーバとその会計メカニズムをバイパスできます。これは、典型的なおよび非典型的なポート（LPD、IPP、raw、HTTP、SMB、FTP、SNMP）へのアクセスをフィルタリングすることを意味します。

印刷ジョブの会計システムを回避するためには、基本的に2つのアプローチがあります。他のユーザをなりすますか、印刷されたページのカウンタを操作するかです。以下では、学術および企業環境で使用される人気のあるオープンソースの印刷システムであるLPRng（v3.8.B）およびCUPS（v2.1.4）のインストールについて、両方のオプションについて説明します。両システムのセキュリティ機能の比較は以下に示されています。

| 印刷システム | プロトコル | 暗号化 | 認証 | ページカウンタ |
| --------------- | -------- | ---------- | -------------- | ------------ |
| **LPRng**       | LPD      | SSL/TLS    | Kerberos, PGP  | ハードウェア     |
| **CUPS**        | IPP      | SSL/TLS    | Kerberos, HTTP | ソフトウェア     |

# 認証バイパス

LPRngとCUPSの両方は、SSLベースのチャネル暗号化と[Kerberos](https://en.wikipedia.org/wiki/Kerberos\_\(protocol\))、[PGP](https://en.wikipedia.org/wiki/Pretty\_Good\_Privacy)による署名済みの印刷ジョブ、またはHTTP [basic](https://en.wikipedia.org/wiki/Basic\_access\_authentication)/[digest](https://en.wikipedia.org/wiki/Digest\_access\_authentication)認証などのセキュアな認証方式を提供しています。**適切に設定されている場合**、かつ攻撃者がプリンタに直接アクセスできない場合、他のユーザを**なりすますことはできません**。ただし、これらのセキュリティ機能は、実際の印刷サーバでは**オプションであり、ほとんど適用されていません**。代わりに、LPD（LPRng）またはIPP（CUPS）パラメータとして指定されたユーザ名がログに記録され、会計されます。クライアント側で任意の値に設定できます。これは、ほとんどの機関で単純なコストと利益の考慮によるものです**: Kerberosはすべてのクライアントで特別なセットアップが必要**であり、**HTTP**認証**では**ユーザが印刷するたびにパスワードを入力**する必要がありますが、いくつかの会計されていない印刷物のコストは耐えられる範囲です。

次のように、**カスタムのユーザ名**で印刷して適切な認証を確認できます：
```
lp -U nobody test.ps
```
# ページカウンターの操作

## ハードウェアのページカウンター

正確な会計のためには、印刷システムによって**印刷されたページ数が決定**される必要がありますが、これは簡単なタスクではありません。**LPRng**の作者は、プリンタに信頼性があり、電源のオン/オフサイクルに対して強固な非揮発性のページカウンターメカニズムがあるという前提を立てています。このような**ハードウェアのページカウンター**は、ほとんどのプリンタでサポートされており、LPRngは**印刷ジョブの後に**PJLを使用してそれらを**読み取り**ます。**HP**はさらに、プリンタをサービスモードに設定することで**ページカウンター**変数に**書き込む**機能を文書化しています。これにより、印刷ジョブ内で_HP LaserJet 1200、HP LaserJet 4200N_および_HP LaserJet 4250N_の**ページカウンター**を**操作**することができます。印刷するドキュメントの最後に[UEL](./#uel)で区切られ、カウンターは単に元の値（例：`2342`）にリセットされるだけです。
```
\x1b%-12345X@PJL JOB
This page was printed for free
\x1b%-12345X@PJL EOJ
\x1b%-12345X@PJL JOB
@PJL SET SERVICEMODE=HPBOISEID
@PJL SET PAGES=2342
\x1b%-12345X@PJL EOJ
```
攻撃者は、印刷されたページ数を負の数に設定することがあります。ただし、テストされたデバイスの一部では、デバイスを[工場出荷時の設定](factory-defaults.md)にリセットすると、ページカウンターもゼロにリセットされることに注意してください。

ページカウンターを下げることは、プリンターを価格以上で売るためにも使用できます。中古車を購入する際のオドメーターと比較できるからです。ただし、ページカウンターをリセットすることは必ずしも悪意のある目的ではないことを強調しておきます。低価格のインクジェットデバイスに高価なインクを販売し、特定のページ数を超えた後に印刷を拒否することで、サードパーティのリフィルキットをブロックするという非倫理的な慣行を扱うために、ページカウンターをリセットすることは完全に正当なビジネスモデルです。

古いHP LaserJetでは、[PRET](https://github.com/RUB-NDS/PRET)の`pagecount`コマンドを使用してハードウェアのページカウンターを簡単に設定することができます。
```
./pret.py -q printer pjl
Connection to printer established

Welcome to the pret shell. Type help or ? to list commands.
printer:/> pagecount 10
Old pagecounter: 53214
New pagecounter: 10
```
## ソフトウェアページカウンター

**CUPS**は、すべての主要なページ記述言語に実装された**ソフトウェアページカウンター**を使用しています。PostScriptの場合、アカウンティングをバイパスする簡単な方法は、以下に示すように、実際にドキュメントを印刷する前にCUPS/Ghostscriptで解釈された場合にfalseを返すPageCountシステムパラメータが存在するかどうかをチェックすることです。
```
currentsystemparams (PageCount) known {
<@\textit{[...] code which is only executed on a printer device [...]}@>
} if
```
この方法では、CUPSが使用する会計ソフトウェアはプリンタとは異なるドキュメントをレンダリングします。CUPSは**1ページだけをカウント**しますが、実際の印刷ジョブには**数百ページ**が含まれる場合があります。IPPの「raw」キュー/オプションを使用しないと、CUPSはページカウンタに到達する前にPostScript-to-PostScriptフィルタ（Ghostscriptのps2write）でコードを解析します。

**この攻撃をテストする方法は？**

**上記のコード**に任意の**複数ページのPostScriptドキュメント**を包み込んで印刷します。その後、[`http://printserver:631/jobs?which_jobs=all`](http://printserver:631/jobs?which_jobs=all)に移動し、この印刷ジョブのCUPSのページカウンタを確認します。なお、生のキューを確立する必要があります。つまり、フィルタリングシステムが関与せず、印刷ジョブが直接プリンタに送信されるキューです。CUPSでは、コンテンツタイプを`application/vnd.cups-raw`に設定することでこれを行います。システムが既にテスト対象のプリントサーバを使用するように構成されている場合は、次のコマンドを使用します：
```
lp -o raw test.ps
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
