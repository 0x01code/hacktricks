<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


Voc√™ pode fazer um usu√°rio enviar uma solicita√ß√£o HTTP POST para a porta 9100 de v√°rios IPs tentando alcan√ßar uma porta de impress√£o bruta aberta. Se encontrada, o **cabe√ßalho HTTP √© impresso como texto simples ou descartado** com base nas configura√ß√µes da impressora. No entanto, os **dados POST** podem **conter** trabalhos de impress√£o arbitr√°rios como comandos **PostScript** ou **PJL** a serem **interpretados**.

### Impress√£o avan√ßada entre sites

Voc√™ pode usar objetos JavaScript XMLHttpRequest (XHR), conforme definido em para realizar solicita√ß√µes HTTP POST para impressoras internas. Uma limita√ß√£o da abordagem de impress√£o entre sites discutida at√© agora √© que **os dados s√≥ podem ser enviados para o dispositivo**, **n√£o recebidos** por causa da pol√≠tica de mesma origem. Para **contornar** as **restri√ß√µes** da pol√≠tica de mesma origem, voc√™ pode **fazer** o **servidor** responder com uma resposta HTTP falsa, mas **v√°lida**, permitindo solicita√ß√µes CORS (incluindo `Access-Control-Allow-Origin=*`). Uma vis√£o esquem√°tica do ataque √© apresentada abaixo:

![Impress√£o avan√ßada entre sites com falsifica√ß√£o de CORS](http://hacking-printers.net/wiki/images/thumb/c/ce/Cross-site-printing.png/900px-Cross-site-printing.png)

Nessa variante aprimorada de XSP - combinada com falsifica√ß√£o de CORS - um atacante da web tem acesso total √† resposta HTTP, o que permite extrair informa√ß√µes arbitr√°rias, como trabalhos de impress√£o capturados do dispositivo de impressora. Um trecho de c√≥digo JavaScript de prova de conceito √© mostrado abaixo:
```javascript
job = "\x1B%-12345X\r\n"
    + "%!\r\n"
    + "(HTTP/1.0 200 OK\\n) print\r\n"
    + "(Server: PostScript HTTPD\\n) print\r\n"
    + "(Access-Control-Allow-Origin: *\\n) print\r\n"
    + "(Connection: close\\n) print\r\n"
    + "(Content-Length: ) print\r\n"
    + "product dup length dup string cvs print\r\n"
    + "(\\n\\n) print\r\n"
    + "print\r\n"
    + "(\\n) print flush\r\n"
    + "\x1B%-12345X\r\n";

var x = new XMLHttpRequest();
x.open("POST", "http://printer:9100");
x.send(job);
x.onreadystatechange = function() {
  if (x.readyState == 4)
    alert(x.responseText);
};
```
### Limita√ß√µes do cross-site printing

Observe que o **PCL** como linguagem de descri√ß√£o de p√°gina n√£o √© aplic√°vel para spoofing de CORS porque permite apenas um **√∫nico n√∫mero** ser **ecoado**. O **PJL** tamb√©m n√£o pode ser usado porque infelizmente ele adiciona `@PJL ECHO` a todas as strings ecoadas, o que torna imposs√≠vel simular um cabe√ßalho HTTP v√°lido. Isso, no entanto, n√£o significa que os ataques **XSP aprimorados** estejam **limitados** a trabalhos **PostScript**: o PostScript pode ser usado para responder com um cabe√ßalho HTTP falsificado e **o** [**UEL**](./#uel)** pode ser invocado para mudar a linguagem da impressora**. Dessa forma, um atacante da web tamb√©m pode obter os resultados para comandos PJL. Existem duas armadilhas de implementa√ß√£o que merecem ser mencionadas: primeiro, um `Content-Length` correto para os dados a serem respondidos precisa ser determinado com PostScript. Se o atacante n√£o puder prever o tamanho geral da resposta e a codifica√ß√£o em blocos tamb√©m n√£o for uma op√ß√£o, ela precisar√° definir um valor muito alto e usar preenchimento. Em segundo lugar, adicionar o campo de cabe√ßalho `Connection: close` √© importante, caso contr√°rio, as conex√µes HTTP/1.1 s√£o mantidas vivas at√© que o cliente da web ou o dispositivo de impressora acione um tempo limite, o que significa que a impressora n√£o estar√° acess√≠vel por algum tempo.

**Se** o dispositivo de impressora suportar **impress√£o de texto simples**, o cabe√ßalho da solicita√ß√£o **HTTP** do XHR √© impresso como c√≥pia impressa - incluindo o campo de cabe√ßalho `Origin` contendo a URL que invocou o JavaScript malicioso, tornando **dif√≠cil** para um atacante **ficar em sil√™ncio**. Isso √© inevit√°vel, pois n√£o ganhamos controle sobre a impressora - e em algumas circunst√¢ncias podemos desativar a funcionalidade de impress√£o - at√© que o corpo HTTP seja processado e o cabe√ßalho HTTP j√° tenha sido interpretado como texto simples pelo dispositivo de impressora. Se reduzir o ru√≠do for uma prioridade, o atacante pode, no entanto, **tentar desativar a funcionalidade de impress√£o primeiro** com comandos PJL propriet√°rios, conforme proposto em [PJL jobmedia](http://hacking-printers.net/wiki/index.php/Document\_processing#PJL\_jobmedia) usando outros canais XSP potenciais como IPP, LPD, FTP ou o servidor web incorporado da impressora. Embora todos os protocolos possam ser testados com sucesso para implantar trabalhos de impress√£o usando variantes de script entre protocolos, eles t√™m algumas desvantagens al√©m de n√£o fornecerem feedback usando cabe√ßalhos CORS falsificados:

* O acesso entre protocolos √†s portas LPD e FTP √© bloqueado por v√°rios navegadores da web
* Os par√¢metros para impress√£o direta no servidor web incorporado s√£o espec√≠ficos do modelo
* O padr√£o IPP requer que o `Content-type` para solicita√ß√µes HTTP POST seja definido como `application/ipp`, o que n√£o pode ser feito com objetos XHR - no entanto, cabe √† implementa√ß√£o realmente se importar com tipos incorretos

Uma compara√ß√£o dos canais de impress√£o entre sites √© apresentada abaixo:

| Canal | Porta | Sem feedback | Impress√µes n√£o solicitadas | Padronizado | Bloqueado por |
| ----- | ----- | ------------ | ------------------------- | ----------- | ------------- |
| Raw   | 9100  | -            | ‚úî                         | ‚úî           | -             |
| Web   | 80    | ‚úî            | -                         | -           | -             |
| IPP   | 631   | ‚úî            | -                         | ‚úî           | -             |
| LPD   | 515   | ‚úî            | -                         | ‚úî           | FF, Ch, Op    |
| FTP   | 21    | ‚úî            | -                         | ‚úî           | FF, Ch, Op, IE |

Um grande problema do XSP √© **encontrar** o **endere√ßo correto** ou o nome do **host da impressora**. Nossa abordagem √© **abusar do WebRTC**, que √© implementado na maioria dos navegadores modernos e tem a fun√ß√£o de enumerar endere√ßos IP para interfaces de rede locais. Dado o endere√ßo IP local, objetos XHR s√£o usados para abrir conex√µes com a porta **9100/tcp** para os 253 endere√ßos restantes para recuperar o nome do produto da impressora usando PostScript e spoofing de CORS, o que leva apenas alguns segundos em nossos testes. Se a impressora estiver na mesma sub-rede que o host da v√≠tima, seu endere√ßo pode ser detectado apenas usando JavaScript. O WebRTC est√° em desenvolvimento para o Safari e √© suportado pelas vers√µes atuais do Firefox, Chrome e Microsoft Edge. O Internet Explorer n√£o tem suporte ao WebRTC, mas o VBScript e o Java tamb√©m podem ser usados para vazar o endere√ßo IP local. Se o endere√ßo da interface local n√£o puder ser recuperado, aplicamos uma abordagem de for√ßa bruta inteligente: tentamos conectar √† porta 80 do roteador da v√≠tima usando objetos XHR. Para isso, foi compilada uma lista de 115 endere√ßos de roteador padr√£o de v√°rios recursos acess√≠veis pela Internet. Se um roteador estiver acess√≠vel, escaneamos a sub-rede em busca de impressoras, conforme descrito anteriormente.

## Prova de conceito

Uma implementa√ß√£o de prova de conceito que demonstra que os ataques avan√ßados de impress√£o entre sites s√£o pr√°ticos e uma amea√ßa real para empresas e institui√ß√µes est√° dispon√≠vel em [hacking-printers.net/xsp/](http://hacking-printers.net/xsp/)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
