<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンやHackTricksのPDFをダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に**参加**するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。

- **ハッキングのトリックを共有するには、[hacktricksのリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudのリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>


悪意のあるファームウェアの更新の危険性はよく知られており、[\[1\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-1)と[\[2\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-2)で早くから議論されてきました。ただし、他のネットワーク接続デバイスとは異なり、**プリンターはファームウェアの更新を通常の印刷ジョブとして展開することが一般的です**。これにより、印刷機能へのアクセスは通常のハードルが低くなり、攻撃者にとって広いゲートウェイが開かれます。このような安全でない設計上の決定の動機については推測するしかありませんが、歴史的な理由が一因となっていると考えられます。プリンターはかつてパラレルまたはUSBケーブルで接続されていました。ネットワーク接続がない場合、セキュリティは重要ではなく、パスワードで保護されたWebサーバーや同様の機能がない場合、印刷チャネルはデバイスにデータを送信する唯一の方法でした。

ネットワークプリンターへのファームウェアの改変攻撃は、[\[3\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-cui2011print-3)によってHPデバイス、[\[4\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-jordon2014wrestling-4)によってCanon PIXMAシリーズ、[\[5\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-heiland2011patched-5)と[\[6\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-weidenbach2016pwn-6)によってさまざまなXeroxモデルで実証されています。対策として、プリンターメーカーはファームウェアにデジタル署名を開始しました[\[7\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-hp2012rfu-7)。

## ベンダー

トップ10のプリンターメーカーの1,400のファームウェアファイルをダウンロードし、[\[8\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-8)によって体系的に分類しました。結果は以下の通りです。

### HP

ファームウェアは[support.hp.com](http://support.hp.com/)またはFTP経由で[ftp.hp.com](ftp://ftp.hp.com/pub/networking/software/pfirmware/)から直接ダウンロードできます。HPの従来のリモートファームウェア更新（`.rfu`）形式のファイル419個と、新しい「HP FutureSmart」バイナリ（`.bdl`）206個を取得できます。`.rfu`ファイルには、`@PJL UPGRADE SIZE=…`のようなプロプライエタリなPJLコマンドが含まれており、ファームウェアの更新が通常の印刷ジョブとして展開されていることを示しています。これは[\[3\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-cui2011print-3)によって実証され、HPは2012年3月以降、すべてのプリンターファームウェアにデジタル署名を施すようになりました[\[7\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-hp2012rfu-7)。

### Canon

ファームウェアは[www.canon.com/support](http://www.canon.com/support/)で入手できます。ただし、Canonでは有効なデバイスシリアル番号が必要です。Canon PIXMAシリーズのファームウェアを変更できた[\[4\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-jordon2014wrestling-4)によると、「署名（正しい方法）はありませんが、非常に弱い暗号化があります」とのことです。Canonの技術サポート担当者とのメールのやり取りによると、「プリンターに受け入れられるためには、ファームウェアはCanonによってデジタル署名される必要があります」とのことです。

### Epson

ファームウェアは[epson.com](http://epson.com/)からダウンロードするか、[download.epson-europe.com](ftp://download.epson-europe.com/)からFTP経由でダウンロードできます。ファイルはWinZipの自己解凍形式（`.exe`）で提供され、unp[\[9\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-9)を使用して展開できます。含まれる`.efu`ファイルは、実際のファームウェアを抽出するためにBinwalk[\[10\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-10)を使用して分析できます。未知の形式（「SEIKO EPSON EpsonNet Form」）の`.rcx`ファイル49個と、PJLコマンド（`@PJL ENTER LANGUAGE=DOWNLOAD`）を含む`.prn`ファイル9個を取得できます。Epsonは保護メカニズムに関する情報を公開していません。2016年以前にリリースされたファームウェアはコード署名を適用しておらず、[\[11\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-11)によって示されるように操作可能でした。彼らは「1999年以降に製造されたデバイスの大量のデバイスが脆弱である可能性がある」と考えています。
### Dell

ファームウェアは[downloads.dell.com](http://downloads.dell.com/)と[ftp.us.dell.com/printer](ftp://ftp.us.dell.com/printer)から入手できます。ファイルはunpを使用して展開し、`.zip`ファイルはunzipのバリアントを使用して抽出できます。Dellは印刷デバイスを製造していませんが、他のベンダーの製品をリバッジしています。そのため、18個の`.hd`ファイル（`@PJL FIRMWARE=…`を含む）、25個の`.prn`ファイル（`@PJL ENTER LANGUAGE=DOWNLOAD`を含む）、30個の`.fls`/`.fly`ファイル（`@PJL LPROGRAMRIP`を含む）など、さまざまなファームウェアファイルが見つかりました。保護メカニズムに関しては、Dellは公開されている情報を提供していません。

### Brother

ファームウェアは簡単にダウンロードすることはできません。代わりに、Windowsバイナリを実行する必要があります。このバイナリは利用可能なプリンタをチェックし、最新のファームウェアのダウンロードリンクをウェブサービスにリクエストします。正しいパラメータを推測することで、98個のファイルのリンクを取得することができます。ファームウェアファイルは展開する必要はありません。79個のファイルは拡張子`.djf`で、`@PJL EXECUTE BRDOWNLOAD`を含みます。また、9個の`.blf`ファイルは`@PJL ENTER LANGUAGE=PCL`を含んでいます。Brotherは保護メカニズムに関して公開されている情報を提供していません。

### Lexmark

ファームウェアは[support.lexmark.com](http://support.lexmark.com/)から入手でき、unpを使用して展開することができます。PJLヘッダー`@PJL LPROGRAMRIP`を含む63個の`fls`ファイルがファームウェアのインストールに使用されます。Lexmarkのセキュリティホワイトペーパーによれば、「パッケージは、Lexmarkのみが知っている対称暗号アルゴリズムを使用して暗号化する必要があり、すべてのデバイスに安全に埋め込まれたキーを介して行われます。ただし、最も強力なセキュリティ対策は、すべてのファームウェアパッケージに、Lexmarkからの複数のデジタル2048ビットRSA署名が含まれていることです。これらの署名が無効である場合、ファームウェアは破棄されます」[\[12\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-12)。

### Samsung

ファームウェアは[www.samsung.com/us/support/download](http://www.samsung.com/us/support/download)からダウンロードできます。取得したファイルはzipアーカイブまたはWindows実行可能ファイルとして提供され、wineで実行してunpを使用してさらに展開することができます。この方法で、`@PJL FIRMWARE`で始まる33個の`.hd`ファイルと関連する`.prn`ファイル（`@PJL DEFAULT SWUPGRADE=ON`を含む）を取得することができました。Samsungは保護メカニズムに関して公開されている情報を提供していません。

### Xerox

ファームウェアは[www.support.xerox.com](http://www.support.xerox.com/)で公開されています。ダウンロードしたファイルはzip形式で提供され、unzipを使用して展開することができます。ファームウェアファイルはさまざまな形式で提供されています。16個の`.hd`ファイルには`@PJL FIRMWARE=…`が含まれ、古いデバイス用の36個のPostScriptファイルと、現在のXeroxで使用されている`.dlm`ファイル（デジタル署名が含まれる形式）が含まれています。ただし、[\[5\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-heiland2011patched-5)によって発見された展開プロセスの欠陥が[\[6\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-weidenbach2016pwn-6)によって拡張され、リモートコード実行が可能となりました。なお、コード署名に使用される秘密鍵とツールはファームウェア自体に含まれています。

### Ricoh

「Firmware Download Center」は[support.ricoh.com](https://support.ricoh.com/)で一般公開されていません。幸いなことに、インターネット上にはドライバ/ファームウェアのダウンロードページへの直接リンクがいくつか存在するため、簡単なGoogle検索（`site:support.ricoh.com firmware`）で31個のファームウェアファイルを入手することができます。ファイルはunpを使用して展開することができます。14個の`.bin`ファイルには`@PJL RSYSTEMUPDATE SIZE=…`が含まれ、15個の`.brn`ファイルには`settings.ini`が含まれており、`@PJL FWDOWNLOAD`と`USERID=sysadm, PASSWORD=sysadm`が含まれています。Ricohは保護メカニズムに関して最新の情報を提供していません。2007年に作成されたホワイトペーパーでは、「ファームウェアの更新を行うために、サービス技術者のみがパスワードと専用アカウントを持っている」と主張しています[\[13\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-13)。

### Kyocera

Kyoceraはエンドユーザー向けにファームウェアをリリースしていません。ただし、公開されているKyoceraディーラーフォーラムでは、さまざまなモデルのファームウェアのダウンロードがリンクされています：[ftp.kdaconnect.com](ftp://ftp.kdaconnect.com/)。ファイルはunpを使用して展開することができ、マウント可能なcramfs[\[14\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-14)およびsquashfs[\[15\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-15)イメージ、および独自のバイナリ形式が含まれています。ファームウェアは、PRESCRIBEページ記述言語のアップグレードコマンド`!R! UPGR'SYS';EXIT;`が前置されたプリントジョブとして展開されます[\[16\]](http://hacking-printers.net/wiki/index.php/Firmware_updates#cite_note-16)。Kyoceraは保護メカニズムに関して公開されている情報を提供していません。

### Konica

Konica Minoltaプリンタのファームウェアは[download6.konicaminolta.eu](http://download6.konicaminolta.eu/)からダウンロードすることができますが、積極的に宣伝されているわけではありません。新しいインターネット接続デバイスでは
| Lexmark | fls | 63 | @PJL LPROGRAMRIP |
| bin, fls | 6 | 不明なバイナリ形式 |  |
| Samsung | hd | 33 | @PJL FIRMWARE=… |
| fls, hd0 | 4 | @PJL DEFAULT P1284VALUE=… |  |
| Xerox | ps | 36 | PostScript \(タイトル：ファームウェアの更新\) |
| dlm | 35 | Xerox Dynamic Loadable Module |  |
| prn, bin | 20 | @PJL ENTER LANGUAGE=DOWNLOAD |  |
| hd | 16 | @PJL FIRMWARE=… |  |
| brn | 10 | 不明なバイナリ、設定ファイルを含む |  |
| bin | 10 | @PJL SET JOBATTR="@SWDL" |  |
| fls, hd, hde | 8 | @PJL DEFAULT P1284VALUE=… |  |
| fls, xfc | 4 | @PJL ENTER LANGUAGE=XFLASH |  |
| pjl | 3 | @PJL FSDOWNLOAD \[name\].rpm |  |
| axf | 3 | RISC OS AIF 実行可能ファイル |  |
| Ricoh | brn | 15 | @PJL FWDOWNLOAD… |
| bin | 14 | @PJL RSYSTEMUPDATE SIZE=… |  |
| fls | 4 | @PJL LPROGRAMRIP |  |
| Kyocera | cramfs, img | 98 | cramfs イメージ |
| bin, squashfs | 79 | squashfs イメージ |  |
| bin, kmmfp | 41 | u-boot legacy uImage |  |
| efi, kmpanel | 13 | プロプライエタリイメージ形式 |  |
| Konica Minolta | bin | 38 | 不明なバイナリ、追加のチェックサムファイル |
| ps | 20 | PostScript \(タイトル：プリンタモジュールのソフトロード\) |  |
| ftp, prn | 11 | @PJL ENTER LANGUAGE=FIRMUPDATE |  |
| upg | 1 | @PJL ENTER LANGUAGE=UPGRADE |  |

**この攻撃をテストする方法**

コード署名のセキュリティは、秘密鍵を長期間の秘密として保つことに基づいています。ただし、まだ更新されていないプリンタや、専有のチェックサムアルゴリズムが暗号的に安全なデジタル署名スキームとして販売されているため、悪意のあるファームウェアの攻撃に潜在的に脆弱なプリンタも存在します。ファームウェアの分析は、ベンダがファームウェアの形式と更新手順を文書化していない場合には困難な場合があります。通常、これには逆アセンブリが必要です。したがって、ファームウェアの変更攻撃の実行可能性をテストすることは容易ではありません。簡単なテストでは、1ビットを反転させて、変更されたファームウェアがプリンタデバイスによってまだ受け入れられるかどうかを確認できます。受け入れられない場合、プリンタによってチェックサムまたはデジタル署名が検証されます。違いを見つけることは常に簡単ではなく、正しいチェックサムを持つ悪意のあるファームウェアを作成することは時間のかかるプロジェクトになる可能性があります。

他の攻撃シナリオには次のものがあります：

* ファームウェアが署名されている場合でも、既知のセキュリティの脆弱性を持つ特定の（署名された）ファームウェアバージョンにダウングレードできる場合があります。
* ファームウェアが署名されている場合でも、さらなる情報を得るためにマウントできる場合があります（特にKonica Minoltaのファームウェアは簡単にマウントできます）。
* ファームウェアが署名されているからといって、必ずしも安全とは限りません。binwalk/grepなどを使用して、[CVE-2015-7547](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2015-7547)のような既知の脆弱性を持つコンポーネントを見つけることができます。


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロードしたりしたいですか？ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！**

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください。**

- **ハッキングのトリックを共有するには、[hacktricksのリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudのリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
