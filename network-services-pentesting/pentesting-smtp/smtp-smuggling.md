# Contrabando SMTP

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

Este tipo de vulnerabilidad fue [**descubierta originalmente en esta publicación**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/) donde se explica que es posible **explotar discrepancias en cómo se interpreta el protocolo SMTP** al finalizar un correo electrónico, lo que permite a un atacante contrabandear más correos electrónicos en el cuerpo del legítimo, permitiendo suplantar a otros usuarios del dominio afectado (como admin@outlook.com) eludiendo defensas como SPF.

### Por qué

Esto se debe a que en el protocolo SMTP, los **datos del mensaje** que se enviarán en el correo electrónico son controlados por un usuario (atacante) que podría enviar datos especialmente diseñados abusando de las diferencias en los analizadores que contrabandearán correos electrónicos adicionales en el receptor. Echa un vistazo a este ejemplo ilustrado de la publicación original:

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### Cómo

Para explotar esta vulnerabilidad, un atacante necesita enviar algunos datos que el **servidor SMTP saliente piensa que es solo 1 correo electrónico pero el servidor SMTP entrante piensa que hay varios correos electrónicos**.

Los investigadores descubrieron que diferentes **servidores entrantes consideran diferentes caracteres como el final de los datos** del mensaje de correo electrónico que los servidores salientes no consideran.\
Por ejemplo, un final regular de los datos es `\r\n.\r\n`. Pero si el servidor SMTP entrante también admite `\n.\n`, un atacante podría simplemente agregar **esos datos en su correo electrónico y comenzar a indicar los comandos SMTP** de uno nuevo para contrabandearlo como en la imagen anterior.

Por supuesto, esto solo funcionaría si el **servidor SMTP saliente tampoco trata estos datos** como el final de los datos del mensaje, porque en ese caso verá 2 correos electrónicos en lugar de solo 1, por lo que al final esta es la desincronización que se está explotando en esta vulnerabilidad.

Datos potenciales de desincronización:

* `\n.\n`
* `\n.\r\n`

También tenga en cuenta que el SPF se evade porque si contrabandea un correo electrónico desde `admin@outlook.com` desde un correo electrónico de `user@outlook.com`, **el remitente sigue siendo `outlook.com`.**

## **Referencias**

* [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **síguenos** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
