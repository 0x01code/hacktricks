# SMTP スマグリング

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 で **@carlospolopm** をフォローする [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する

</details>

## 基本情報

この種の脆弱性は、[**この投稿で最初に発見されました**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)。SMTPプロトコルが電子メールを最終化する際に解釈される方法の違いを悪用することで、攻撃者が合法的な電子メールの本文にさらに多くの電子メールを密輸することが可能で、SPFなどの防御をバイパスして影響を受けるドメインの他のユーザー（たとえばadmin@outlook.com）をなりすますことができます。

### 理由

これは、SMTPプロトコルでは、電子メールで送信されるメッセージのデータがユーザー（攻撃者）によって制御されるため、受信者に追加の電子メールを密輸するパーサーの違いを悪用することができます。元の投稿からのこの図解例をご覧ください：

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### 方法

この脆弱性を悪用するには、攻撃者は、**アウトバウンドSMTPサーバーが1つの電子メールだと思うデータを送信する必要がありますが、インバウンドSMTPサーバーは複数の電子メールがあると考える必要があります**。

研究者たちは、**インバウンドサーバーが電子メールメッセージのデータの終わりとして異なる文字を考慮していることを発見しました**。\
たとえば、通常のデータの終わりは `\r\n.\r\n` です。しかし、インバウンドSMTPサーバーが `\n.\n` もサポートしている場合、攻撃者は単に**そのデータを電子メールに追加し、新しいSMTPコマンドの指示を開始**することで、前述の画像のようにそれを密輸することができます。

もちろん、これは、**アウトバウンドSMTPサーバーもこのデータをメッセージデータの終わりとして扱わない**場合にのみ機能します。そうでない場合、1つではなく2つの電子メールが表示されるため、最終的にはこの脆弱性で悪用されているデシンクロナイゼーションです。

潜在的なデシンクロナイゼーションデータ：

* `\n.\n`
* `\n.\r\n`

また、SPFがバイパスされることに注意してください。なぜなら、`admin@outlook.com` から `user@outlook.com` への電子メールを密輸すると、**送信者は依然として `outlook.com` です。**

## **参考文献**

* [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>を通じてゼロからヒーローまでAWSハッキングを学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい**または **HackTricks をPDFでダウンロードしたい**場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェック！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[**telegramグループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 で **@carlospolopm** をフォローする [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリにPRを提出する

</details>
