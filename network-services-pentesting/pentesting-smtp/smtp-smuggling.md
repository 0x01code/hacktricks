# SMTP 스멀글링

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)를 통해 제로에서 히어로까지 AWS 해킹 배우기</strong></a><strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사가 HackTricks에 광고되길 원하거나 PDF로 HackTricks를 다운로드하고 싶다면** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왜그**](https://peass.creator-spring.com)를 구매하세요
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 당사의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* **💬 [Discord 그룹](https://discord.gg/hRep4RUj7f)** 또는 [텔레그램 그룹](https://t.me/peass)에 **가입**하거나 **트위터** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**를 팔로우**하세요.
* **해킹 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소로 PR을 제출하세요.

</details>

## 기본 정보

이 유형의 취약점은 [**이 게시물에서 최초로 발견되었습니다**](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/), 여기서는 이메일을 완료할 때 SMTP 프로토콜이 해석되는 방식의 **불일치를 악용하여** 공격자가 합법적인 이메일의 본문에 더 많은 이메일을 밀반입할 수 있게 해주며, SPF와 같은 방어 기능을 우회하여 영향을 받는 도메인의 다른 사용자(예: admin@outlook.com)를 흉내 낼 수 있습니다.

### 왜

SMTP 프로토콜에서 **이메일을 보낼 메시지의 데이터**는 사용자(공격자)가 제어하며, 이는 수신자에게 추가 이메일을 밀반입할 수 있는 파서의 차이를 악용하는 특수하게 제작된 데이터를 보낼 수 있음을 의미합니다. 원본 게시물의 이 그림 예제를 살펴보세요:

<figure><img src="../../.gitbook/assets/image (8).png" alt=""><figcaption><p><a href="https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png">https://sec-consult.com/fileadmin/user_upload/sec-consult/Dynamisch/Blogartikel/2023_12/SMTP_Smuggling-Overview__09_.png</a></p></figcaption></figure>

### 방법

이 취약점을 악용하려면 공격자는 **아웃바운드 SMPT 서버가 단순히 1개의 이메일로 간주하지만 인바운드 SMTP 서버는 여러 이메일로 간주하는 데이터를 보내야 합니다**.

연구원들은 **인바운드 서버가 이메일 메시지의 데이터 끝으로 다른 문자를 고려**한다는 것을 발견했습니다.\
예를 들어, 일반적인 데이터의 끝은 `\r\n.\r\n`입니다. 그러나 인바운드 SMTP 서버가 `\n.\n`도 지원하는 경우, 공격자는 이 데이터를 이메일에 추가하고 새로운 SMTP 명령을 나타내기 시작하여 이전 이미지와 같이 밀반입할 수 있습니다.

물론, 이것은 **아웃바운드 SMTP 서버도 이 데이터를 메시지 데이터의 끝으로 처리하지 않는 경우에만 작동**할 수 있습니다. 그렇지 않으면 1개가 아닌 2개의 이메일을 볼 것이므로, 결국 이 취약점에서 악용되는 이것이 바로 동기화가 끊어지는 것입니다.

동기화가 끊어지는 데이터:

* `\n.\n`
* `\n.\r\n`

또한 SPF가 우회되는 이유는 `user@outlook.com`의 이메일에서 `admin@outlook.com`의 이메일을 밀반입하면 **송신자는 여전히 `outlook.com`**이기 때문입니다.

## **참고 자료**

* [https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/](https://sec-consult.com/blog/detail/smtp-smuggling-spoofing-e-mails-worldwide/)
