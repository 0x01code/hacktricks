# S√©curit√© ImageMagick

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Ce post a √©t√© copi√© depuis** [**https://blog.doyensec.com/2023/01/10/imagemagick-security-policy-evaluator.html**](https://blog.doyensec.com/2023/01/10/imagemagick-security-policy-evaluator.html)****

Lors de nos audits, nous tombons parfois sur des fichiers de configuration de la politique de s√©curit√© d'[ImageMagick](https://imagemagick.org/) (`policy.xml`), utiles pour limiter le comportement par d√©faut et les ressources consomm√©es par la biblioth√®que. Dans la nature, ces fichiers contiennent souvent une pl√©thore de recommandations culturelles de cargaison provenant d'Internet. Cela se produit normalement pour deux raisons :

* Ses options sont g√©n√©ralement d√©crites sur la page de documentation en ligne de la biblioth√®que, sans aucune ventilation claire de ce que chaque directive de s√©curit√© autoris√©e par la politique r√©glemente. Bien que la complexit√© architecturale et la granularit√© des options d√©finissables par la politique soient les principaux obstacles pour un novice, la base de connaissances correspondante pourrait √™tre plus accueillante. Par d√©faut, ImageMagick est livr√© avec une politique non restreinte qui doit √™tre ajust√©e par les d√©veloppeurs en fonction de leur utilisation. Selon la documentation, _¬´ cela offre une utilit√© maximale pour les installations ImageMagick qui s'ex√©cutent dans un environnement sandbox√©, peut-√™tre dans une instance Docker, ou derri√®re un pare-feu o√π les risques de s√©curit√© sont consid√©rablement r√©duits par rapport √† un site Web public. ¬ª_ Une politique stricte et s√©curis√©e est √©galement disponible, cependant [comme not√© dans le pass√©](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html), elle n'est pas toujours bien configur√©e.
* ImageMagick [prend en charge plus de 100 formats de fichiers majeurs](https://imagemagick.org/script/formats.php#supported) (sans inclure les sous-formats) types de formats d'image. Les vuln√©rabilit√©s inf√¢mes affectant la biblioth√®que au fil des ans ont produit un certain nombre de correctifs de s√©curit√© urgents et de contournements impliquant l'ajout d'√©l√©ments de politique excluant les formats et fonctionnalit√©s affect√©s (ImageTragick en [2016](https://imagetragick.com/), RCE de [@taviso](https://twitter.com/taviso) via GhostScript en [2018](https://seclists.org/oss-sec/2018/q3/142), injection de shell de [@insertScript](https://twitter.com/insertScript) via le mot de passe PDF en [2020](https://insert-script.blogspot.com/2020/11/imagemagick-shell-injection-via-pdf.html), [@alexisdanizan](https://twitter.com/alexisdanizan) en [2021](https://www.synacktiv.com/en/publications/playing-with-imagetragick-like-its-2016.html)).

### Vers des politiques plus s√ªres <a href="#towards-safer-policies" id="towards-safer-policies"></a>

Dans cette optique, nous avons d√©cid√© d'√©tudier les effets de toutes les options accept√©es par le parseur de politique de s√©curit√© d'ImageMagick et d'√©crire un [outil pour aider les d√©veloppeurs et les √©quipes de s√©curit√© √† concevoir et √† auditer ces fichiers](https://imagemagick-secevaluator.doyensec.com/). En raison du nombre d'options disponibles et de la n√©cessit√© de refuser explicitement tous les param√®tres non s√©curis√©s, il s'agit g√©n√©ralement d'une t√¢che manuelle, qui peut ne pas identifier les contournements subtils qui sapent la force d'une politique. Il est √©galement facile de d√©finir des politiques qui semblent fonctionner, mais qui n'offrent aucun avantage r√©el en termes de s√©curit√©. Les v√©rifications de l'outil sont bas√©es sur nos recherches visant √† aider les d√©veloppeurs √† renforcer leurs politiques et √† am√©liorer la s√©curit√© de leurs applications, afin de s'assurer que les politiques offrent un avantage de s√©curit√© significatif et ne peuvent pas √™tre subverties par des attaquants.

L'outil peut √™tre trouv√© √† [imagemagick-secevaluator.doyensec.com/](https://imagemagick-secevaluator.doyensec.com/).

### Approche de liste blanche vs liste noire <a href="#allowlist-vs-denylist-approach" id="allowlist-vs-denylist-approach"></a>

Un certain nombre de politiques apparemment s√©curis√©es peuvent √™tre trouv√©es en ligne, sp√©cifiant une liste de codeurs non s√©curis√©s similaires √† :
```xml
  ...
  <policy domain="coder" rights="none" pattern="EPHEMERAL" />
  <policy domain="coder" rights="none" pattern="EPI" />
  <policy domain="coder" rights="none" pattern="EPS" />
  <policy domain="coder" rights="none" pattern="MSL" />
  <policy domain="coder" rights="none" pattern="MVG" />
  <policy domain="coder" rights="none" pattern="PDF" />
  <policy domain="coder" rights="none" pattern="PLT" />
  <policy domain="coder" rights="none" pattern="PS" />
  <policy domain="coder" rights="none" pattern="PS2" />
  <policy domain="coder" rights="none" pattern="PS3" />
  <policy domain="coder" rights="none" pattern="SHOW" />
  <policy domain="coder" rights="none" pattern="TEXT" />
  <policy domain="coder" rights="none" pattern="WIN" />
  <policy domain="coder" rights="none" pattern="XPS" />
  ...
```
Dans ImageMagick 6.9.7-7, un [changement non r√©pertori√©](https://blog.awm.jp/2017/02/09/imagemagick-en/) a √©t√© effectu√©. L'analyseur de politique a chang√© de comportement en passant de l'interdiction de l'utilisation d'un codeur s'il y avait au moins une r√®gle de permission `none` dans la politique √† la prise en compte de la derni√®re r√®gle correspondante dans la politique pour le codeur. Cela signifie qu'il est possible d'adopter une approche de liste blanche dans les politiques modernes, en refusant d'abord tous les droits des codeurs et en activant ceux qui ont √©t√© approuv√©s. Une politique plus s√©curis√©e sp√©cifierait :
```xml
  ...
  <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" />
  <policy domain="coder" rights="read | write" pattern="{GIF,JPEG,PNG,WEBP}" />
  ...
```
### Sensibilit√© √† la casse <a href="#case-sensitivity" id="case-sensitivity"></a>

Consid√©rez la directive suivante:
```
  ...
  <policy domain="coder" rights="none" pattern="ephemeral,epi,eps,msl,mvg,pdf,plt,ps,ps2,ps3,show,text,win,xps" />
  ...
```
Avec cela, les conversions seront toujours autoris√©es, car les mod√®les de politique sont sensibles √† la casse. Les codeurs et les modules doivent toujours √™tre en majuscules dans la politique (par exemple, "EPS" et non "eps").

### Limites de ressources <a href="#resource-limits" id="resource-limits"></a>

La cr√©ation d'un d√©ni de service dans ImageMagick est assez facile √† r√©aliser. Pour obtenir un nouvel ensemble de charges utiles, il est pratique de rechercher des mots cl√©s tels que "oom" dans les probl√®mes r√©cemment ouverts signal√©s sur le r√©f√©rentiel Github de la biblioth√®que. Cela pose un probl√®me car une instance ImageMagick acceptant des entr√©es potentiellement malveillantes (ce qui est souvent le cas) sera toujours susceptible d'√™tre exploit√©e. Pour cette raison, l'outil signale √©galement si des limites raisonnables ne sont pas explicitement d√©finies par la politique.

### Fragmentation de la politique <a href="#policy-fragmentation" id="policy-fragmentation"></a>

Une fois qu'une politique est d√©finie, il est important de s'assurer que le fichier de politique est en vigueur. Les packages ImageMagick inclus dans la distribution ou install√©s en tant que d√©pendances via plusieurs gestionnaires de packages peuvent sp√©cifier des politiques diff√©rentes qui interf√®rent les unes avec les autres. Une recherche rapide avec `find` sur votre machine locale identifiera plusieurs occurrences de fichiers `policy.xml`:
```shell-session
$ find / -iname policy.xml

# Example output on macOS
/usr/local/etc/ImageMagick-7/policy.xml
/usr/local/Cellar/imagemagick@6/6.9.12-60/etc/ImageMagick-6/policy.xml
/usr/local/Cellar/imagemagick@6/6.9.12-60/share/doc/ImageMagick-6/www/source/policy.xml
/usr/local/Cellar/imagemagick/7.1.0-45/etc/ImageMagick-7/policy.xml
/usr/local/Cellar/imagemagick/7.1.0-45/share/doc/ImageMagick-7/www/source/policy.xml

# Example output on Ubuntu
/usr/local/etc/ImageMagick-7/policy.xml
/usr/local/share/doc/ImageMagick-7/www/source/policy.xml
/opt/ImageMagick-7.0.11-5/config/policy.xml
/opt/ImageMagick-7.0.11-5/www/source/policy.xml

```
Les politiques peuvent √©galement √™tre configur√©es en utilisant l'argument CLI [-limit](https://imagemagick.org/script/command-line-options.php#limit), les m√©thodes de l'API [MagickCore](https://imagemagick.org/api/resource.php#SetMagickResourceLimit), ou avec des variables d'environnement.

### Une politique restrictive de d√©part <a href="#a-starter-restrictive-policy" id="a-starter-restrictive-policy"></a>

En partant de la politique la plus restrictive d√©crite dans la documentation officielle, nous avons con√ßu une politique restrictive regroupant toutes nos observations :
```xml
<policymap xmlns="">
  <policy domain="resource" name="temporary-path" value="/mnt/magick-conversions-with-restrictive-permissions"/> <!-- the location should only be accessible to the low-privileged user running ImageMagick -->
  <policy domain="resource" name="memory" value="256MiB"/>
  <policy domain="resource" name="list-length" value="32"/>
  <policy domain="resource" name="width" value="8KP"/>
  <policy domain="resource" name="height" value="8KP"/>
  <policy domain="resource" name="map" value="512MiB"/>
  <policy domain="resource" name="area" value="16KP"/>
  <policy domain="resource" name="disk" value="1GiB"/>
  <policy domain="resource" name="file" value="768"/>
  <policy domain="resource" name="thread" value="2"/>
  <policy domain="resource" name="time" value="10"/>
  <policy domain="module" rights="none" pattern="*" /> 
  <policy domain="delegate" rights="none" pattern="*" />
  <policy domain="coder" rights="none" pattern="*" /> 
  <policy domain="coder" rights="write" pattern="{PNG,JPG,JPEG}" /> <!-- your restricted set of acceptable formats, set your rights needs -->
  <policy domain="filter" rights="none" pattern="*" />
  <policy domain="path" rights="none" pattern="@*"/>
  <policy domain="cache" name="memory-map" value="anonymous"/>
  <policy domain="cache" name="synchronize" value="true"/>
  <!-- <policy domain="cache" name="shared-secret" value="my-secret-passphrase" stealth="True"/> Only needed for distributed pixel cache spanning multiple servers -->
  <policy domain="system" name="shred" value="2"/>
  <policy domain="system" name="max-memory-request" value="256MiB"/>
  <policy domain="resource" name="throttle" value="1"/> <!-- Periodically yield the CPU for at least the time specified in ms -->
  <policy xmlns="" domain="system" name="precision" value="6"/>
</policymap>
```
Vous pouvez v√©rifier qu'une politique de s√©curit√© est active en utilisant la commande `identify`:
```
identify -list policy
Path: ImageMagick/policy.xml
...
```
Vous pouvez √©galement jouer avec la politique ci-dessus en utilisant notre outil d'√©valuation tout en d√©veloppant une politique sur mesure.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
