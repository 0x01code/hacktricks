<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**Este conte√∫do foi retirado de** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Conceitos b√°sicos do Artifactory <a href="#artifactory-basics" id="artifactory-basics"></a>

## Usu√°rios e senhas padr√£o <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

As contas padr√£o do Artifactory s√£o:

| Conta        | Senha padr√£o                                   | Notas                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | conta comum de administra√ß√£o                                        |
| access-admin | password (<6.8.0) ou um valor aleat√≥rio (>= 6.8.0) | usada apenas para opera√ß√µes de administra√ß√£o local                    |
| anonymous    | ‚Äô‚Äô                                             | usu√°rio an√¥nimo para recuperar pacotes remotamente, n√£o habilitado por padr√£o |

Por padr√£o, nenhuma pol√≠tica de bloqueio de senha est√° em vigor, o que torna o Artifactory um alvo principal para ataques de preenchimento de credenciais e pulveriza√ß√£o de senhas.

## Autoriza√ß√µes <a href="#authorizations" id="authorizations"></a>

Idealmente, isso √© o que voc√™ deve ver ao se conectar ao Artifactory:

![P√°gina de login](https://www.errno.fr/artifactory/artif\_login.png)

Por outro lado, se voc√™ for recebido com algo mais parecido com isso:

![P√°gina padr√£o](https://www.errno.fr/artifactory/artif\_default.png)

Significa que o "Acesso an√¥nimo" foi habilitado no painel de administra√ß√£o, que √© uma configura√ß√£o comum usada para permitir que aplicativos recuperem artefatos sem problemas, mas permite que voc√™, o atacante, veja mais do que √© prefer√≠vel.

## Verificando os direitos da conta <a href="#checking-account-rights" id="checking-account-rights"></a>

√Äs vezes, devido a uma m√° configura√ß√£o, o acesso an√¥nimo √© permitido para implantar arquivos em alguns reposit√≥rios!

Para verificar em quais reposit√≥rios o usu√°rio an√¥nimo pode implantar, use a seguinte solicita√ß√£o:
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
Se houver entradas `repoKey` na solicita√ß√£o, qualquer pessoa pode implantar nelas, o que √© realmente muito ruim. Voc√™ definitivamente deve estar autenticado para implantar quaisquer arquivos.

Isso pode ser generalizado para outras contas assim que voc√™ obtiver uma senha ou token para elas.

## Listando usu√°rios <a href="#listing-users" id="listing-users"></a>

Por algum motivo, listar usu√°rios √© um direito reservado apenas para administradores. Eu encontrei uma maneira alternativa de listar usu√°rios (aqueles que est√£o implantando ativamente pelo menos) que depende do valor "Implantado por" dos artefatos:

![Implantado por](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[Este script](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a) simplesmente tenta encontrar recursivamente todos os usu√°rios que implantaram artefatos. Observe que pode levar um tempo para ser conclu√≠do se houver muitos reposit√≥rios (> 1000).
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## Permiss√µes <a href="#permissions" id="permissions"></a>

Aqui est√£o as permiss√µes b√°sicas e sua utilidade:

* Gerenciar: ?
* Excluir/Sobrescrever: interessante para pentest
* Implantar/Cache: interessante para pentest
* Anotar: necess√°rio para CVE-2020-7931
* Ler: geralmente uma permiss√£o padr√£o

# Vulnerabilidades conhecidas <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

Aqui est√° uma lista selecionada de vulnerabilidades p√∫blicas de alto impacto:

## CVE-2016-10036: Upload de arquivo arbitr√°rio e RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[Detalhes aqui.](https://www.exploit-db.com/exploits/44543)

Este √© um pouco antigo e √© improv√°vel que voc√™ encontre uma vers√£o t√£o desatualizada do Artifactory. No entanto, √© bastante eficaz, pois √© uma simples travessia de diret√≥rio que permite a execu√ß√£o de c√≥digo arbitr√°rio no n√≠vel do Tomcat.

## CVE-2019-9733: Bypass de autentica√ß√£o (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[Advisory original aqui.](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

Em vers√µes mais antigas do Artifactory (at√© 6.7.3), a conta `access-admin` usava uma senha padr√£o `password`.

Esta conta local normalmente √© proibida de acessar a interface do usu√°rio ou a API, mas at√© a vers√£o 6.8.6 do Artifactory, era poss√≠vel engan√°-lo para acreditar que a solicita√ß√£o emanava localmente se o cabe√ßalho HTTP `X-Forwarded-For` fosse definido como `127.0.0.1`.

## CVE-2020-7931: Inje√ß√£o de modelo do lado do servidor (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[Advisory original aqui.](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

Aqui est√° uma [ferramenta que escrevi](https://github.com/gquere/CVE-2020-7931) para automatizar a explora√ß√£o dessa vulnerabilidade.

Esses s√£o os requisitos para a explora√ß√£o:

* um usu√°rio com direitos de implanta√ß√£o (criar arquivos) e anota√ß√£o (definir filtrados)
* Artifactory Pro

A vulnerabilidade √© bastante simples: se um recurso implantado for definido como filtrado, ele ser√° interpretado como um modelo Freemarker, o que d√° ao atacante uma janela de ataque SSTI. ![Recurso filtrado](https://www.errno.fr/artifactory/artif_filtered.png)

Aqui est√£o as primitivas implementadas:

* leituras b√°sicas do sistema de arquivos
* grava√ß√µes limitadas do sistema de arquivos

Isso deve ser suficiente para dar a voc√™ a execu√ß√£o remota de c√≥digo de v√°rias maneiras, da mais f√°cil/silenciosa √† mais dif√≠cil/barulhenta:

* lendo um segredo no sistema de arquivos que permite que voc√™ pivote (/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa ‚Ä¶)
* adicionando uma chave SSH ao usu√°rio
* implantando um arquivo .war para executar um servlet
* implantando um script de usu√°rio Groovy do Artifactory

### Hist√≥rias .war: manobras de renomea√ß√£o Java renameTo() <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

Esta √© uma pequena hist√≥ria de como bati minha cabe√ßa contra a parede por horas, se n√£o dias, durante um pentest. Encontrei um Artifactory desatualizado que sabia que era vulner√°vel ao CVE-2020-7931. Implantei o modelo SSTI original do advisory e comecei a percorrer o sistema de arquivos. Parecia que o Artifactory havia sido instalado em um local n√£o padr√£o, o que n√£o √© muito incomum, j√° que os administradores gostam de manter parti√ß√µes separadas entre bin√°rios de aplicativos, dados, logs e configura√ß√£o (isso √© uma coisa boa!). N√£o havia chaves SSH ou senhas no diret√≥rio home do usu√°rio que me fornecessem um piv√¥ f√°cil, ent√£o chegou a hora de ser menos discreto e escrever no sistema de arquivos. O envio da carga √∫til inicial (uma chave p√∫blica) para o diret√≥rio de upload do Artifactory correu bem, mas eu simplesmente n√£o conseguia mov√™-la para o diret√≥rio de chaves SSH. Ent√£o voltei para minha sandbox de explora√ß√£o, testei novamente e, eis que funcionou bem. Ent√£o, tinha que haver uma configura√ß√£o diferente que me impedisse de concluir o m√©todo `renameTo()`. Neste ponto, √© sempre uma boa ideia [verificar a documenta√ß√£o](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-) ... que claramente afirma que voc√™ n√£o pode renomear arquivos em diferentes sistemas de arquivos, o que faz sentido dependendo da implementa√ß√£o do m√©todo, ou seja, se ele funciona em um n√≠vel de inode. Arg.

Lembre-se do que eu disse sobre os administradores gostarem de parti√ß√µes? Bem, este √© um caso de um administrador que endureceu sua configura√ß√£o sem saber contra minha explora√ß√£o! Ent√£o, tive que cavar em uma esp√©cie de pris√£o Java para encontrar outro m√©todo que me permitisse gravar um arquivo no disco. E isso n√£o foi nada divertido, j√° que n√£o estou familiarizado com nada do que est√° envolvido: modelos FTL, Java, Tomcat/Catalina. Descobri rapidamente que as fugas regulares da pris√£o Java simplesmente n√£o funcionariam, pois a inst√¢ncia de novas classes era proibida. Depois de horas lendo a documenta√ß√£o das classes Java e Catalina, finalmente encontrei um m√©todo write() em um objeto ao qual eu poderia chegar. Mas estava limitado ao caminho base da aplica√ß√£o da web... Ent√£o, pensei em combinar a grava√ß√£o em outro sistema de arquivos e o `renameTo()` atrav√©s deste novo sistema de arquivos acess√≠vel para, esperan√ßosamente, poder gravar em qualquer lugar? E funcionou mais ou menos. Consegui gravar fora do diret√≥rio de upload tempor√°rio ... mas n√£o t√£o longe dele, pois agora estava preso em outro sistema de arquivos que era o ponto de montagem para todas as coisas do Artifactory: configura√ß√£o, aplica√ß√£o e coisas do tipo. Ent√£o, ainda sem chave SSH para mim.

Ok, eu poderia gravar na pasta raiz do artifactory, com certeza eu poderia fazer algo aqui? Ei, o Tomcat padr√£o automaticamente implanta arquivos WAR escritos em seu caminho de aplica√ß√£o, n√£o √©? Ent√£o usei o msfvenom para gerar um shell da web JSP embalado em um arquivo WAR e testei na minha sandbox... bem, ele foi implantado corretamente, mas n√£o me deu execu√ß√£o de comando. Parece que o Tomcat padr√£o n√£o lida com JSPs. Ugh. Ficando cada vez mais frustrado, procurei outra maneira de executar c√≥digo no Tomcat e encontrei outro m√©todo de execu√ß√£o usando servlets. N√£o consegui encontrar uma carga √∫til apropriada, ent√£o dane-se, estou tudo dentro neste ponto e [criei o meu pr√≥prio que voc√™ pode encontrar aqui](https://github.com/gquere/javaWebShell). Testei na sandbox, funciona, ok. Coloquei no alvo, implantei e ... nada. Acontece que havia um proxy na frente do artifactory que reescrevia todos os URLs para /artifactory. Ent√£o, mesmo que minha porta dos fundos estivesse implantada e em execu√ß√£o, n√£o havia como acess√°-la... Se houvesse alguma execu√ß√£o remota de c√≥digo a ser alcan√ßada neste ponto, teria que ser no contexto do Artifactory, n√£o do Tomcat.

Na manh√£ seguinte, estou chorando em minha mesa olhando pela √∫ltima vez a documenta√ß√£o do Artifactory em v√£s esperan√ßas de uma epifania. E ent√£o as palavras m√°gicas "scripts Groovy" apareceram. A
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
O outro tipo de senha bcrypt n√£o requer nada especial, √© apenas um hash bcrypt padr√£o:
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### Segredos remotos <a href="#remote-secrets" id="remote-secrets"></a>

O Artifactory pode precisar armazenar segredos para se identificar em servi√ßos remotos. Esses segredos n√£o s√£o hash, √© claro, eles s√£o armazenados criptografados no disco, com a chave ao lado deles. Existem dois tipos de segredos mencionados na [documenta√ß√£o oficial](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/).

**Formato antigo (<5.9): DES-EDE**

TODO. [Abra um problema se voc√™ tiver dados criptografados de amostra](https://github.com/gquere/ArtifactoryDecryptor).

**Novo formato (>=5.9): criptografia AES128-CBC, armazenada como base58**

Os segredos externos (como senhas de servidores remotos) s√£o encontrados nos [descritores de configura√ß√£o](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor), por exemplo, `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` e parecem:
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
Onde:

* `AM` sempre denota um segredo criptografado do Artifactory
* `25rLQ` √© o identificador do segredo que deve corresponder ao identificador da chave
* `AES128` obviamente √© o algoritmo usado
* `vJMeK...KRE` √© a codifica√ß√£o base58 de `IV_SIZE|IV|secret|CRC`

Mais segredos podem ser encontrados (tokens, backups de configura√ß√£o...) usando a seguinte express√£o regular:
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
A chave √© armazenada em `/var/opt/jfrog/artifactory/etc/security/artifactory.key` e se parece com:
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
Onde:

* `JS` denota uma chave
* `25rLQ` √© um identificador de chave exclusivo que mant√©m o controle de qual chave pode descriptografar quais segredos
* `AES128` √© obviamente o algoritmo usado
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` √© a codifica√ß√£o base58 da chave e 2 bytes de CRC

Esta ferramenta que escrevi pode ser usada offline para descriptografar segredos do Artifactory: [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# Defendendo o Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

Se voc√™ √© a equipe azul ou um administrador do Artifactory, agora voc√™ deve ter uma boa ideia do que fazer:

* mantenha o Artifactory atualizado, especialmente quando atualiza√ß√µes cr√≠ticas forem emitidas
* implemente uma pol√≠tica de senha s√≥lida (sem senhas padr√£o, senhas fortes obrigat√≥rias, bloqueios), preferencialmente diferida para um LDAP externo para melhor supervis√£o
* restrinja acessos (respeite o princ√≠pio do menor privil√©gio), especialmente para o usu√°rio an√¥nimo
