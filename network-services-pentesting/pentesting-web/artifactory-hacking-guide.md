<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


**Este contenido fue tomado de** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Conceptos b√°sicos de Artifactory <a href="#artifactory-basics" id="artifactory-basics"></a>

## Usuarios y contrase√±as por defecto <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Las cuentas por defecto de Artifactory son:

| Cuenta       | Contrase√±a por defecto                         | Notas                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | cuenta com√∫n de administraci√≥n                                       |
| access-admin | password (<6.8.0) o un valor aleatorio (>= 6.8.0) | utilizada solo para operaciones de administraci√≥n local             |
| anonymous    | ‚Äô‚Äô                                             | usuario an√≥nimo para recuperar paquetes de forma remota, no habilitado por defecto |

Por defecto, no hay una pol√≠tica de bloqueo de contrase√±as, lo que convierte a Artifactory en un objetivo principal para ataques de relleno de credenciales y rociado de contrase√±as.

## Autorizaciones <a href="#authorizations" id="authorizations"></a>

Idealmente, esto es lo que deber√≠as ver al conectarte a Artifactory:

![P√°gina de inicio de sesi√≥n](https://www.errno.fr/artifactory/artif\_login.png)

Por otro lado, si te encuentras con algo m√°s parecido a esto:

![P√°gina por defecto](https://www.errno.fr/artifactory/artif\_default.png)

Significa que se ha habilitado el "Acceso an√≥nimo" en el panel de administraci√≥n, lo cual es una configuraci√≥n com√∫n utilizada para permitir que las aplicaciones recuperen artefactos sin problemas, pero te permite, el atacante, ver m√°s de lo preferible.

## Verificaci√≥n de derechos de cuenta <a href="#checking-account-rights" id="checking-account-rights"></a>

A veces, debido a una mala configuraci√≥n, ¬°se permite al usuario an√≥nimo desplegar archivos en algunos repositorios!

Para verificar a qu√© repositorios el usuario an√≥nimo puede desplegar, utiliza la siguiente solicitud:
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
Si hay entradas de `repoKey` en la solicitud, el usuario an√≥nimo puede desplegar en estos, lo cual es realmente muy malo. Definitivamente deber√≠as estar autenticado para desplegar cualquier archivo.

Esto se puede generalizar a otras cuentas una vez que obtengas una contrase√±a o token para ellas.

## Listado de usuarios <a href="#listing-users" id="listing-users"></a>

Por alguna raz√≥n, el listado de usuarios es un derecho reservado solo para administradores. Encontr√© una forma alternativa de listar usuarios (aquellos que est√°n desplegando activamente al menos) que depende del valor ‚ÄúDesplegado Por‚Äù de los artefactos:

![Desplegado Por](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[Este script](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a) simplemente intenta encontrar recursivamente todos los usuarios que han desplegado artefactos. Ten en cuenta que podr√≠a tardar un tiempo en completarse si hay muchos repositorios (>1000).
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## Permisos <a href="#permissions" id="permissions"></a>

Aqu√≠ est√°n los permisos b√°sicos y su utilidad:

* Manage: ?
* Delete/Overwrite: interesante para pentesting
* Deploy/Cache: interesante para pentesting
* Annotate: necesario para CVE-2020-7931
* Read: generalmente un permiso por defecto

# Vulnerabilidades conocidas <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

Aqu√≠ hay una lista curada de vulnerabilidades p√∫blicas de alto impacto:

## CVE-2016-10036: Carga de Archivos Arbitrarios & RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[Detalles aqu√≠.](https://www.exploit-db.com/exploits/44543)

Esta es un poco antigua y es poco probable que encuentres una versi√≥n de Artifactory tan desactualizada. Sin embargo, es bastante efectiva, ya que es una simple traves√≠a de directorio que permite la ejecuci√≥n de c√≥digo arbitrario a nivel de Tomcat.

## CVE-2019-9733: Bypass de Autenticaci√≥n (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[Advertencia original aqu√≠.](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

En versiones anteriores de Artifactory (hasta 6.7.3), la cuenta `access-admin` utilizaba una contrase√±a predeterminada `password`.

Esta cuenta local normalmente no tiene permiso para acceder a la UI o API, pero hasta la versi√≥n 6.8.6 se pod√≠a enga√±ar a Artifactory para que creyera que la solicitud se originaba localmente si el encabezado HTTP `X-Forwarded-For` se establec√≠a en `127.0.0.1`.

## CVE-2020-7931: Inyecci√≥n de Plantillas en el Servidor (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[Advertencia original aqu√≠.](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

Aqu√≠ hay una [herramienta que escrib√≠](https://github.com/gquere/CVE-2020-7931) para automatizar la explotaci√≥n de esta vulnerabilidad.

Estos son requeridos para la explotaci√≥n:

* un usuario con permisos de deploy (crear archivos) y annotate (establecer filtrado)
* Artifactory Pro

La vulnerabilidad es bastante simple: si un recurso desplegado se establece como filtrado, se interpreta como una Plantilla Freemarker, lo que le da al atacante una ventana de ataque SSTI. ![Recurso Filtrado](https://www.errno.fr/artifactory/artif\_filtered.png)

Aqu√≠ est√°n las primitivas implementadas:

* lecturas b√°sicas del sistema de archivos
* escrituras limitadas en el sistema de archivos

Estas deber√≠an ser suficientes para darte ejecuci√≥n de c√≥digo remoto de varias maneras, desde la m√°s f√°cil/discreta hasta la m√°s dif√≠cil/ruidosa:

* leer un secreto en el sistema de archivos que te permita pivotar (/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa ‚Ä¶)
* a√±adir una clave SSH al usuario
* desplegar un .war para ejecutar un servlet
* desplegar un script de usuario Groovy de Artifactory

### Historias de .war: Travesuras de Java renameTo() <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

Esta es una peque√±a historia de c√≥mo me golpe√© la cabeza contra la pared durante horas, si no d√≠as, durante un pentest. Me encontr√© con un Artifactory desactualizado que sab√≠a que era vulnerable a CVE-2020-7931. Desplegu√© la plantilla SSTI del aviso original y comenc√© a examinar el sistema de archivos. Parec√≠a que Artifactory hab√≠a sido instalado en una ubicaci√≥n no est√°ndar, lo cual no es tan inusual ya que los administradores suelen mantener particiones separadas entre los binarios de la aplicaci√≥n, los datos, los registros y la configuraci√≥n (¬°esto es bueno!). No hab√≠a claves SSH ni contrase√±as en el directorio del usuario que me hubieran proporcionado un pivote f√°cil, as√≠ que lleg√≥ el momento de ser menos discreto y escribir en el sistema de archivos. Dejar el payload inicial (una clave p√∫blica) en el directorio de carga de Artifactory fue bien, pero simplemente no pude moverlo al directorio de claves SSH. As√≠ que volv√≠ a mi sandbox de explotaci√≥n, lo prob√© de nuevo y, he aqu√≠, funcion√≥ bien. As√≠ que ten√≠a que haber una configuraci√≥n diferente que me impidiera completar el m√©todo `renameTo()`. En este punto siempre es una buena idea [consultar la documentaci√≥n](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-) ... que claramente indica que no puedes renombrar archivos a trav√©s de diferentes sistemas de archivos, lo cual supongo que tiene sentido dependiendo de la implementaci√≥n del m√©todo, es decir, si funciona a nivel de inode. Arg.

¬øRecuerdas lo que dije sobre los administradores y las particiones? Bueno, este es un caso de un administrador que sin saberlo fortaleci√≥ su configuraci√≥n contra mi exploit. As√≠ que tuve que investigar lo que es esencialmente una c√°rcel de Java para encontrar otro m√©todo que me permitiera escribir un archivo en el disco. Y eso no fue nada divertido, ya que no estoy familiarizado con ninguna de las cosas involucradas: Plantillas FTL, Java, Tomcat/Catalina. R√°pidamente descubr√≠ que los escapes de c√°rcel de Java regulares simplemente no funcionar√≠an, ya que estaba prohibido instanciar nuevas clases. Despu√©s de horas de leer la documentaci√≥n de las clases de Java y Catalina, finalmente encontr√© un m√©todo write() en un objeto al que pod√≠a acceder. Pero estaba limitado a la ruta base de la aplicaci√≥n web... Entonces pens√© en combinar la escritura a otro sistema de archivos y el `renameTo()` a trav√©s de este nuevo sistema de archivos accesible para poder escribir en cualquier lugar. ¬øY funcion√≥? M√°s o menos. Logr√© escribir fuera del directorio temporal de carga ... pero no muy lejos de √©l, ya que ahora estaba atascado en otro sistema de archivos que era el punto de montaje de todo lo relacionado con artifactory: configuraci√≥n, aplicaci√≥n y cosas. As√≠ que todav√≠a no ten√≠a clave SSH para m√≠.

Bueno, pod√≠a escribir en la carpeta ra√≠z de artifactory, seguramente podr√≠a hacer algo aqu√≠, ¬øno? Oye, el Tomcat predeterminado autom√°ticamente despliega archivos WAR escritos en su ruta de aplicaci√≥n, ¬øno es as√≠? As√≠ que us√© msfvenom para generar un webshell JSP empaquetado en un archivo WAR y lo prob√© en mi sandbox... bueno, se despleg√≥ bien, pero no me proporcion√≥ ejecuci√≥n de comandos. Parece que el Tomcat predeterminado no maneja JSPs. Ugh. Cada vez m√°s frustrado, busqu√© otra forma de ejecutar c√≥digo en Tomcat, y encontr√© otro m√©todo de ejecuci√≥n usando servlets. No pude encontrar un payload apropiado, as√≠ que a la mierda, estoy all in en este punto y [hice mi propio que puedes encontrar aqu√≠](https://github.com/gquere/javaWebShell). Lo prob√© en la sandbox, funciona, ok. Lo puse en el objetivo, se despliega y ... nada. Resulta que hab√≠a un proxy frente a artifactory que reescrib√≠a todas las URLs a /artifactory. As√≠ que aunque mi puerta trasera estaba desplegada y funcionando, no hab√≠a forma de acceder a ella... Si hab√≠a alguna ejecuci√≥n de c√≥digo remoto que lograr en este punto, tendr√≠a que ser en el contexto de Artifactory, no de Tomcat.

A la ma√±ana siguiente, estoy sollozando en mi escritorio mirando por √∫ltima vez la documentaci√≥n de Artifactory con la vana esperanza de una epifan√≠a. Y entonces las palabras m√°gicas "scripts Groovy" aparecieron. Resulta que hay una forma enrevesada de ejecutar scripts Groovy, escribi√©ndolos en disco y luego recarg√°ndolos a trav√©s de la API. ¬°Salvado al fin! As√≠ que lanc√© un reverseshell Groovy a la m√°quina y eso fue todo. A√∫n desear√≠a haber encontrado un m√©todo m√°s limpio que hubiera escrito en cualquier lugar del sistema de archivos usando el SSTI, pero seguro que no iba a volver a desarrollar.

Afortunadamente, no todos los pentests son as√≠ :)

# Post-Explotaci√≥n <a href="#post-exploitation" id="post-exploitation"></a>

Lo siguiente solo es √∫til una vez que has logrado ejecuci√≥n de c√≥digo remoto o lectura de archivos arbitrarios en el servidor y podr√≠a ayudarte a pivotar a otra m√°quina.

## Almacenamiento de contrase√±as y secretos externos <a href="#storage-of-passwords-and-external-secrets" id="storage-of-passwords-and-external-secrets"></a>

### Contrase√±as locales <a href="#local-passwords" id="local-passwords"></a>

Las contrase√±as locales de artifactory se almacenan en forma de MD5 salado o bcrypt, siendo el primero obsoleto.

Las contrase√±as MD5 siempre est√°n saladas con el valor spring codificado `{CAFEBABEEBABEFAC}`, y utilizan una simple concatenaci√≥n sin rondas, es decir, `hash = md5(password + salt)`. La base de datos dice que la sal es `CAFEBABEEBABEFAC` pero cr√©eme, es `{CAFEBABEEBABEFAC}`, me cost√≥ mucho encontrarlo :)

Para romper estas contrase√±as MD5 se requiere usar un modo din√°mico para JtR:
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
El otro tipo de contrase√±a bcrypt no requiere nada especial, es solo un hash bcrypt est√°ndar:
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### Secretos remotos <a href="#remote-secrets" id="remote-secrets"></a>

Artifactory puede necesitar almacenar secretos para identificarse ante servicios remotos. Estos secretos no est√°n hasheados, por supuesto, se almacenan cifrados en el disco, con la clave al lado de ellos. Hay dos tipos de secretos mencionados en la [documentaci√≥n oficial](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/).

**Formato antiguo (<5.9): DES-EDE**

TODO. [Abre un issue si tienes datos cifrados de muestra](https://github.com/gquere/ArtifactoryDecryptor).

**Formato nuevo (>=5.9): cifrado AES128-CBC, almacenado como base58**

Los secretos externos (como contrase√±as de servidores remotos) se encuentran en los [descriptores de configuraci√≥n](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor), por ejemplo, `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` y parecen:
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
Donde:

* `AM` siempre denota un secreto cifrado de artifactory
* `25rLQ` es el identificador del secreto que debe coincidir con el identificador de la clave
* `AES128` obviamente es el algoritmo utilizado
* `vJMeK...KRE` es la codificaci√≥n base58 de `IV_SIZE|IV|secreto|CRC`

Se pueden encontrar m√°s secretos (tokens, copias de seguridad de configuraci√≥n ...) utilizando la siguiente expresi√≥n regular:
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
La clave se almacena en `/var/opt/jfrog/artifactory/etc/security/artifactory.key` y luce as√≠:
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
Donde:

* `JS` denota una clave
* `25rLQ` es un identificador de clave √∫nico que lleva un registro de qu√© clave puede descifrar qu√© secretos
* `AES128` obviamente es el algoritmo utilizado
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` es la codificaci√≥n base58 de la clave y 2 bytes de CRC

Esta herramienta que escrib√≠ se puede usar sin conexi√≥n para descifrar secretos de Artifactory: [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# Defendiendo Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

Si eres del equipo azul o un administrador de Artifactory, para este momento deber√≠as tener una idea bastante clara de qu√© hacer:

* mantener Artifactory actualizado, especialmente cuando se emiten actualizaciones cr√≠ticas
* implementar una pol√≠tica de contrase√±as s√≥lida (sin contrase√±as predeterminadas, contrase√±as fuertes obligatorias, bloqueos), preferiblemente delegada a un LDAP externo para una mejor supervisi√≥n
* restringir accesos (respetar el principio de m√≠nimo privilegio), especialmente para el usuario an√≥nimo


<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
