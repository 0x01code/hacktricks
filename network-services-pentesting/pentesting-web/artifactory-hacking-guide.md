<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n la [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**Este contenido fue tomado de** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Conceptos b√°sicos de Artifactory <a href="#artifactory-basics" id="artifactory-basics"></a>

## Usuarios y contrase√±as predeterminados <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Las cuentas predeterminadas de Artifactory son:

| Cuenta       | Contrase√±a predeterminada                     | Notas                                                                 |
| ------------ | ---------------------------------------------- | --------------------------------------------------------------------- |
| admin        | password                                       | cuenta de administraci√≥n com√∫n                                       |
| access-admin | password (<6.8.0) o un valor aleatorio (>= 6.8.0) | utilizado solo para operaciones de administraci√≥n local               |
| anonymous    | ''                                             | usuario an√≥nimo para recuperar paquetes de forma remota, no habilitado por defecto |

Por defecto, no se aplica ninguna pol√≠tica de bloqueo de contrase√±as, lo que convierte a Artifactory en un objetivo principal para ataques de relleno de credenciales y de rociado de contrase√±as.

## Autorizaciones <a href="#authorizations" id="authorizations"></a>

Idealmente, esto es lo que deber√≠a ver al conectarse a Artifactory:

![P√°gina de inicio de sesi√≥n](https://www.errno.fr/artifactory/artif\_login.png)

Por otro lado, si se le presenta algo m√°s parecido a esto:

![P√°gina predeterminada](https://www.errno.fr/artifactory/artif\_default.png)

Significa que se ha habilitado el "Acceso an√≥nimo" en el panel de administraci√≥n, que es una configuraci√≥n com√∫n utilizada para permitir que las aplicaciones recuperen artefactos sin problemas, pero que le permite a usted, el atacante, ver m√°s de lo que es preferible.

## Comprobaci√≥n de los derechos de la cuenta <a href="#checking-account-rights" id="checking-account-rights"></a>

¬°A veces, debido a una mala configuraci√≥n, se permite que el usuario an√≥nimo implemente archivos en algunos repositorios!

Para comprobar en qu√© repositorios puede implementar el usuario an√≥nimo, utilice la siguiente solicitud:
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
Si hay entradas `repoKey` en la solicitud, cualquier persona an√≥nima puede desplegar en ellas, lo cual es realmente malo. Definitivamente, se debe estar autenticado para desplegar cualquier archivo.

Esto se puede generalizar a otras cuentas una vez que se obtiene una contrase√±a o token para ellas.

## Listado de usuarios <a href="#listing-users" id="listing-users"></a>

Por alguna raz√≥n, la lista de usuarios es un derecho reservado solo para los administradores. Encontr√© una forma alternativa de listar usuarios (aquellos que est√°n desplegando activamente al menos) que se basa en el valor "Desplegado por" de los artefactos:

![Desplegado por](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[Este script](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a) simplemente intenta encontrar recursivamente todos los usuarios que han desplegado artefactos. Tenga en cuenta que podr√≠a tardar un tiempo en completarse si hay muchos repositorios (>1000).
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## Permisos <a href="#permissions" id="permissions"></a>

Aqu√≠ est√°n los permisos b√°sicos y su utilidad:

* Manage: ?
* Delete/Overwrite: interesante para pentest
* Deploy/Cache: interesante para pentest
* Annotate: necesario para CVE-2020-7931
* Read: generalmente un permiso predeterminado

# Vulnerabilidades conocidas <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

Aqu√≠ hay una lista seleccionada de vulnerabilidades p√∫blicas de alto impacto:

## CVE-2016-10036: Carga de archivo arbitraria y RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[Detalles aqu√≠.](https://www.exploit-db.com/exploits/44543)

Este es un poco antiguo y es poco probable que te encuentres con una versi√≥n tan desactualizada de Artifactory. Sin embargo, es bastante efectivo, ya que es una simple traves√≠a de directorios que permite la ejecuci√≥n de c√≥digo arbitrario en el nivel de Tomcat.

## CVE-2019-9733: Bypass de autenticaci√≥n (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[Advertencia original aqu√≠.](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

En versiones anteriores de Artifactory (hasta 6.7.3), la cuenta `access-admin` usaba una contrase√±a predeterminada `password`.

Normalmente, esta cuenta local est√° prohibida para acceder a la interfaz de usuario o la API, pero hasta la versi√≥n 6.8.6, Artifactory pod√≠a ser enga√±ado para creer que la solicitud emanaba localmente si se establec√≠a el encabezado HTTP `X-Forwarded-For` en `127.0.0.1`.

## CVE-2020-7931: Inyecci√≥n de plantillas en el lado del servidor (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[Advertencia original aqu√≠.](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

Aqu√≠ hay una [herramienta que escrib√≠](https://github.com/gquere/CVE-2020-7931) para automatizar la explotaci√≥n de esta vulnerabilidad.

Estos son necesarios para la explotaci√≥n:

* un usuario con derechos de implementaci√≥n (crear archivos) y anotaci√≥n (establecer filtrados)
* Artifactory Pro

La vulnerabilidad es bastante simple: si un recurso implementado se establece en filtrado, se interpreta como una plantilla de Freemarker, lo que le da al atacante una ventana de ataque SSTI. ![Recurso filtrado](https://www.errno.fr/artifactory/artif_filtered.png)

Aqu√≠ est√°n los primitivos implementados:

* lecturas b√°sicas del sistema de archivos
* escrituras limitadas del sistema de archivos

Estos deber√≠an ser suficientes para darle ejecuci√≥n de c√≥digo remoto de varias maneras, desde la m√°s f√°cil/silenciosa hasta la m√°s dif√≠cil/ruidosa:

* leyendo un secreto en el sistema de archivos que le permite pivotar (/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa ‚Ä¶)
* agregando una clave SSH al usuario
* implementando un archivo .war para ejecutar un servlet
* implementando un script de usuario Groovy de Artifactory

### Historias .war: travesuras de Java renameTo() <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

Esta es una peque√±a historia de c√≥mo me golpe√© la cabeza contra la pared durante horas, si no d√≠as, durante una prueba de penetraci√≥n. Me encontr√© con una versi√≥n desactualizada de Artifactory que sab√≠a que era vulnerable a CVE-2020-7931. Implement√© la plantilla SSTI original de la advertencia y comenc√© a buscar en el sistema de archivos. Parec√≠a que Artifactory se hab√≠a instalado en una ubicaci√≥n no est√°ndar, lo que no es demasiado inusual ya que a los administradores les gusta mantener particiones separadas entre binarios de aplicaciones, datos, registros y configuraci√≥n (¬°esto es algo bueno!). No hab√≠a claves SSH o contrase√±as en el directorio principal del usuario que me hubieran proporcionado un pivote f√°cil, as√≠ que lleg√≥ el momento de ser menos discreto y escribir en el sistema de archivos. La carga √∫til inicial (una clave p√∫blica) en el directorio de carga de Artifactory fue bien, pero simplemente no pude moverla al directorio de claves SSH. As√≠ que volv√≠ a mi sandbox de explotaci√≥n, lo prob√© de nuevo y, ¬°oh sorpresa!, funcion√≥ bien. As√≠ que ten√≠a que haber una configuraci√≥n diferente que me impidiera completar el m√©todo `renameTo()`. En este punto, siempre es una buena idea [consultar la documentaci√≥n](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-) ... que claramente establece que no se pueden renombrar archivos en diferentes sistemas de archivos, lo que supongo que tiene sentido dependiendo de la implementaci√≥n del m√©todo, es decir, si funciona a nivel de inodo. Arg.

¬øRecuerdas lo que dije sobre los administradores que les gustan las particiones? Bueno, ¬°este es un caso de un administrador que sin saberlo endureci√≥ su configuraci√≥n contra mi explotaci√≥n! As√≠ que tuve que profundizar en lo que es esencialmente una c√°rcel de Java para encontrar otro m√©todo que me permitiera escribir un archivo en disco. Y eso no fue divertido en absoluto, ya que no estoy familiarizado con ninguna de las cosas involucradas: plantillas FTL, Java, Tomcat/Catalina. R√°pidamente descubr√≠ que las fugas de la c√°rcel de Java regulares simplemente no funcionar√≠an, ya que instanciar nuevas clases estaba prohibido. Despu√©s de horas de leer la documentaci√≥n de las clases de Java y Catalina, finalmente encontr√© un m√©todo write() en un objeto al que pod√≠a acceder. Pero estaba limitado a la ruta base de la aplicaci√≥n web... As√≠ que luego pens√© en combinar la escritura en otro sistema de archivos y el `renameTo()` a trav√©s de este sistema de archivos reci√©n alcanzable para, con suerte, poder escribir en cualquier lugar. Y funcion√≥ un poco. Logr√© escribir fuera del directorio de carga temporal ... pero no tan lejos de √©l, ya que ahora estaba atrapado en otro sistema de archivos que era el punto de montaje de todas las cosas de Artifactory: configuraci√≥n, aplicaci√≥n y cosas. As√≠ que todav√≠a no hay clave SSH para m√≠.

De acuerdo, podr√≠a escribir en la carpeta ra√≠z de Artifactory, ¬øseguramente podr√≠a hacer algo aqu√≠? Oye, ¬øno hace Tomcat por defecto implementar archivos WAR escritos en su ruta de aplicaci√≥n? As√≠ que us√© msfvenom para generar una shell web JSP empaquetada en un archivo WAR y lo prob√© en mi sandbox... bueno, se implement√≥ correctamente, pero no me dio ejecuci√≥n de comandos. Parece que el Tomcat predeterminado no maneja los JSP. Ugh. Cada vez m√°s frustrado, busqu√© otra forma de ejecutar c√≥digo en Tomcat y encontr√© otro m√©todo de ejecuci√≥n usando servlets. No pude encontrar una carga √∫til adecuada, as√≠ que j√≥dete, estoy todo adentro en este punto y [desarroll√© mi propio m√©todo que puedes encontrar aqu√≠](https://github.com/gquere/javaWebShell). Lo prob√© en el sandbox, funciona, bien. Lo puse en el objetivo, se implementa y... nada. Resulta que hab√≠a un proxy delante de Artifactory que reescrib√≠a todas las URL a /artifactory. As√≠ que aunque mi puerta trasera estaba implementada y funcionando, no hab√≠a forma de acceder a ella... Si hubiera alg√∫n tipo de ejecuci√≥n de c√≥digo remoto para lograr en este punto, tendr√≠a que estar en el contexto de Artifactory, no de Tomcat.

Al d√≠a siguiente, estoy sollozando en mi escritorio mirando por √∫ltima vez la documentaci√≥n de Artifactory con la esperanza vana de una epifan√≠a. Y luego aparecieron las palabras m√°gicas "scripts Groovy". Resulta que hay una forma complicada de ejecutar scripts Groovy, escribi√©ndolos en disco y luego recarg
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
El otro tipo de contrase√±a bcrypt no requiere nada especial, es simplemente un hash bcrypt est√°ndar:
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### Secretos remotos <a href="#remote-secrets" id="remote-secrets"></a>

Artifactory puede necesitar almacenar secretos para identificarse en servicios remotos. Estos secretos no est√°n hashados, por supuesto, se almacenan cifrados en el disco, con la clave junto a ellos. Hay dos tipos de secretos mencionados en la [documentaci√≥n oficial](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/).

**Formato antiguo (<5.9): DES-EDE**

TODO. [Abra un problema si tiene datos cifrados de muestra](https://github.com/gquere/ArtifactoryDecryptor).

**Nuevo formato (>=5.9): cifrado AES128-CBC, almacenado como base58**

Los secretos externos (como las contrase√±as de los servidores remotos) se encuentran en los [descriptores de configuraci√≥n](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor), por ejemplo, `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` y se ven as√≠:
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
Donde:

* `AM` siempre denota un secreto cifrado de Artifactory
* `25rLQ` es el identificador del secreto que debe coincidir con el identificador de la clave
* `AES128` obviamente es el algoritmo utilizado
* `vJMeK...KRE` es la codificaci√≥n base58 de `IV_SIZE|IV|secret|CRC`

Se pueden encontrar m√°s secretos (tokens, copias de seguridad de configuraci√≥n...) utilizando la siguiente expresi√≥n regular:
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
La clave se almacena en `/var/opt/jfrog/artifactory/etc/security/artifactory.key` y tiene este aspecto:
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
Donde:

* `JS` denota una clave
* `25rLQ` es un identificador de clave √∫nico que lleva un registro de qu√© clave puede descifrar qu√© secretos
* `AES128` es obviamente el algoritmo utilizado
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` es la codificaci√≥n base58 de la clave y 2 bytes de CRC

Esta herramienta que escrib√≠ se puede utilizar sin conexi√≥n para descifrar secretos de Artifactory: [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# Defendiendo Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

Si eres el equipo azul o un administrador de Artifactory, a estas alturas deber√≠as tener una buena idea de qu√© hacer:

* mantener Artifactory actualizado, especialmente cuando se emiten actualizaciones cr√≠ticas
* implementar una pol√≠tica de contrase√±as s√≥lida (sin contrase√±as predeterminadas, contrase√±as fuertes obligatorias, bloqueos), preferiblemente diferido a un LDAP externo para una mejor supervisi√≥n
* restringir accesos (respetar el principio de menor privilegio), especialmente para el usuario an√≥nimo
