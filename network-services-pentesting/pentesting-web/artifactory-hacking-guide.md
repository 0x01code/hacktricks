<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**Ce contenu a √©t√© pris √† partir de** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Fondamentaux d'Artifactory <a href="#artifactory-basics" id="artifactory-basics"></a>

## Utilisateurs et mots de passe par d√©faut <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Les comptes par d√©faut d'Artifactory sont :

| Compte       | Mot de passe par d√©faut                        | Notes                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | compte d'administration commun                                       |
| access-admin | password (<6.8.0) ou une valeur al√©atoire (>= 6.8.0) | utilis√© uniquement pour les op√©rations d'administration locale        |
| anonymous    | ''                                             | utilisateur anonyme pour r√©cup√©rer des packages √† distance, pas activ√© par d√©faut |

Par d√©faut, aucune politique de verrouillage de mot de passe n'est en place, ce qui fait d'Artifactory une cible privil√©gi√©e pour les attaques de bourrage de mots de passe et de pulv√©risation de mots de passe.

## Autorisations <a href="#authorizations" id="authorizations"></a>

Id√©alement, voici ce que vous devriez voir lorsque vous vous connectez √† Artifactory :

![Page de connexion](https://www.errno.fr/artifactory/artif\_login.png)

D'autre part, si vous √™tes accueilli avec quelque chose de plus proche de ceci :

![Page par d√©faut](https://www.errno.fr/artifactory/artif\_default.png)

Cela signifie que l'acc√®s anonyme a √©t√© activ√© dans le panneau d'administration, ce qui est un param√®tre courant utilis√© pour permettre aux applications de r√©cup√©rer des artefacts sans tracas, mais vous permet, en tant qu'attaquant, de voir plus que ce qui est pr√©f√©rable.

## V√©rification des droits du compte <a href="#checking-account-rights" id="checking-account-rights"></a>

Parfois, en raison d'une mauvaise configuration, anonymous est autoris√© √† d√©ployer des fichiers sur certains r√©f√©rentiels !

Pour v√©rifier sur quels r√©f√©rentiels l'utilisateur anonyme peut d√©ployer, utilisez la requ√™te suivante :
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
Si des entr√©es `repoKey` sont pr√©sentes dans la requ√™te, un utilisateur anonyme peut y d√©ployer des fichiers, ce qui est vraiment tr√®s dangereux. Vous devez absolument √™tre authentifi√© pour d√©ployer des fichiers.

Cela peut √™tre g√©n√©ralis√© √† d'autres comptes une fois que vous avez leur mot de passe ou leur jeton.

## Liste des utilisateurs <a href="#listing-users" id="listing-users"></a>

Pour une raison quelconque, la liste des utilisateurs est r√©serv√©e aux administrateurs uniquement. J'ai trouv√© une m√©thode alternative pour lister les utilisateurs (ceux qui d√©ploient au moins) qui repose sur la valeur "D√©ploy√© par" des artefacts :

![D√©ploy√© par](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[Ce script](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a) essaie simplement de trouver de mani√®re r√©cursive tous les utilisateurs qui ont d√©ploy√© des artefacts. Notez que cela peut prendre un certain temps pour se terminer s'il y a beaucoup de r√©f√©rentiels (>1000).
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## Permissions <a href="#permissions" id="permissions"></a>

Voici les autorisations de base et leur utilit√© :

* G√©rer : ?
* Supprimer/√âcraser : int√©ressant pour le pentest
* D√©ployer/Mettre en cache : int√©ressant pour le pentest
* Annoter : n√©cessaire pour CVE-2020-7931
* Lire : g√©n√©ralement une autorisation par d√©faut

# Vuln√©rabilit√©s connues <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

Voici une liste s√©lectionn√©e de vuln√©rabilit√©s publiques √† fort impact :

## CVE-2016-10036 : T√©l√©chargement de fichiers arbitraires et RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[D√©tails ici.](https://www.exploit-db.com/exploits/44543)

Celle-ci commence √† dater et il est peu probable que vous tombiez sur une version Artifactory aussi obsol√®te. N√©anmoins, elle est assez efficace, car il s'agit d'une simple travers√©e de r√©pertoire qui permet une ex√©cution de code arbitraire au niveau de Tomcat.

## CVE-2019-9733 : Contournement de l'authentification (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[Advisory original ici.](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

Sur les anciennes versions d'Artifactory (jusqu'√† 6.7.3), le compte `access-admin` utilisait un mot de passe par d√©faut `password`.

Ce compte local est normalement interdit d'acc√®s √† l'interface utilisateur ou √† l'API, mais jusqu'√† la version 6.8.6, Artifactory pouvait √™tre tromp√© en croyant que la demande √©manait localement si l'en-t√™te HTTP `X-Forwarded-For` √©tait d√©fini sur `127.0.0.1`.

## CVE-2020-7931 : Injection de mod√®les c√¥t√© serveur (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[Advisory original ici.](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

Voici un [outil que j'ai √©crit](https://github.com/gquere/CVE-2020-7931) pour automatiser l'exploitation de cette vuln√©rabilit√©.

Ces √©l√©ments sont n√©cessaires pour l'exploitation :

* un utilisateur disposant des droits de d√©ploiement (cr√©ation de fichiers) et d'annotation (d√©finition de filtres)
* Artifactory Pro

La vuln√©rabilit√© est assez simple : si une ressource d√©ploy√©e est d√©finie comme filtr√©e, elle est interpr√©t√©e comme un mod√®le Freemarker, ce qui donne √† l'attaquant une fen√™tre d'attaque SSTI. ![Ressource filtr√©e](https://www.errno.fr/artifactory/artif_filtered.png)

Voici les primitives impl√©ment√©es :

* lectures de syst√®me de fichiers de base
* √©critures limit√©es de syst√®me de fichiers

Ces primitives devraient suffire √† vous donner une ex√©cution de code √† distance de plusieurs mani√®res, de la plus facile/la plus silencieuse √† la plus difficile/la plus bruyante :

* lecture d'un secret sur le syst√®me de fichiers qui vous permet de pivoter (/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa ...)
* ajout d'une cl√© SSH √† l'utilisateur
* d√©ploiement d'un fichier .war pour ex√©cuter un servlet
* d√©ploiement d'un script utilisateur Groovy Artifactory

### Histoires de .war : les manigances de Java renameTo() <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

Voici une petite histoire de comment j'ai cogn√© ma t√™te contre le mur pendant des heures, voire des jours, lors d'un pentest. Je suis tomb√© sur une version obsol√®te d'Artifactory que je savais vuln√©rable √† CVE-2020-7931. J'ai d√©ploy√© le mod√®le SSTI de l'avis original et j'ai commenc√© √† parcourir le syst√®me de fichiers. Il semblait qu'Artifactory avait √©t√© install√© dans un emplacement non standard, ce qui n'est pas trop inhabituel car les administrateurs aiment garder des partitions s√©par√©es entre les binaires d'application, les donn√©es, les journaux et la configuration (ce qui est une bonne chose !). Il n'y avait pas de cl√©s SSH ou de mots de passe dans le r√©pertoire personnel de l'utilisateur qui m'auraient permis de pivoter facilement, donc il √©tait temps d'√™tre moins discret et d'√©crire sur le syst√®me de fichiers. Le d√©p√¥t de la charge utile initiale (une cl√© publique) dans le r√©pertoire de t√©l√©chargement d'Artifactory s'est bien pass√©, mais je n'ai tout simplement pas r√©ussi √† la d√©placer vers le r√©pertoire des cl√©s SSH. Alors je suis retourn√© dans mon bac √† sable d'exploitation, je l'ai test√© √† nouveau et √ßa a march√©. Il devait donc y avoir une configuration diff√©rente qui m'emp√™chait de terminer la m√©thode `renameTo()`. √Ä ce stade, il est toujours bon de [v√©rifier la documentation](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-) ... qui indique clairement que vous ne pouvez pas renommer des fichiers entre diff√©rents syst√®mes de fichiers, ce qui a du sens en fonction de la mise en ≈ìuvre de la m√©thode, c'est-√†-dire si elle fonctionne au niveau de l'inode. Arg.

Rappelez-vous ce que j'ai dit sur les administrateurs qui aiment les partitions ? Eh bien, c'est un cas d'un administrateur qui a durci sa configuration √† l'insu de son plein gr√© contre mon exploit ! J'ai donc d√ª fouiller dans ce qui est essentiellement une prison Java pour trouver une autre m√©thode qui me permettrait d'√©crire un fichier sur le disque. Et ce n'√©tait pas amusant du tout, car je ne suis pas familier avec aucune des choses impliqu√©es : les mod√®les FTL, Java, Tomcat/Catalina. J'ai rapidement d√©couvert que les √©vasions de prison Java r√©guli√®res ne suffiraient pas, car l'instanciation de nouvelles classes √©tait interdite. Apr√®s des heures de lecture de la documentation des classes Java et Catalina, j'ai enfin trouv√© une m√©thode write() sur un objet auquel je pouvais acc√©der. Mais elle √©tait limit√©e au chemin de base de l'application web... Alors j'ai pens√© √† combiner l'√©criture sur un autre syst√®me de fichiers et le `renameTo()` sur ce nouveau syst√®me de fichiers accessible pour esp√©rer pouvoir √©crire n'importe o√π ? Et √ßa a march√© un peu. J'ai r√©ussi √† √©crire en dehors du r√©pertoire de t√©l√©chargement temporaire... mais pas tr√®s loin de celui-ci car j'√©tais maintenant bloqu√© sur un autre syst√®me de fichiers qui √©tait le point de montage de toutes les choses Artifactory : configuration, application et autres. Donc toujours pas de cl√© SSH pour moi.

D'accord, je pourrais √©crire dans le dossier racine d'Artifactory, s√ªrement je pourrais faire quelque chose ici ? H√©, Tomcat par d√©faut d√©ploie automatiquement les fichiers WAR √©crits dans son chemin d'application, n'est-ce pas ? Alors j'ai utilis√© msfvenom pour g√©n√©rer un shell web JSP empaquet√© dans un fichier WAR et je l'ai test√© dans mon bac √† sable... eh bien, il a √©t√© d√©ploy√© correctement, mais ne m'a pas donn√© d'ex√©cution de commande. Il semble que Tomcat par d√©faut ne g√®re pas les JSP. Ugh. De plus en plus frustr√©, j'ai cherch√© un autre moyen d'ex√©cuter du code dans Tomcat et j'ai trouv√© une autre m√©thode d'ex√©cution en utilisant des servlets. Je n'ai pas trouv√© de charge utile appropri√©e, alors je me suis dit que je suis tout dedans √† ce stade et [j'ai d√©velopp√© le mien que vous pouvez trouver ici](https://github.com/gquere/javaWebShell). Je l'ai test√© dans le bac √† sable, √ßa marche, ok
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
Le deuxi√®me type de mot de passe bcrypt ne n√©cessite rien de sp√©cial, c'est juste un hachage bcrypt standard :
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### Secrets distants <a href="#remote-secrets" id="remote-secrets"></a>

Artifactory peut avoir besoin de stocker des secrets pour s'identifier aupr√®s de services distants. Ces secrets ne sont √©videmment pas hash√©s, ils sont stock√©s chiffr√©s sur le disque, avec la cl√© √† c√¥t√© d'eux. Il existe deux types de secrets mentionn√©s dans la [documentation officielle](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/).

**Ancien format (<5.9): DES-EDE**

TODO. [Ouvrez une issue si vous avez des donn√©es chiffr√©es d'exemple](https://github.com/gquere/ArtifactoryDecryptor).

**Nouveau format (>=5.9): chiffrement AES128-CBC, stock√© en base58**

Les secrets externes (tels que les mots de passe des serveurs distants) se trouvent dans les [descripteurs de configuration](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor), par exemple `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` et ressemblent √†:
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
O√π :

* `AM` d√©signe toujours un secret chiffr√© d'Artifactory
* `25rLQ` est l'identificateur de secret qui doit correspondre √† l'identificateur de cl√©
* `AES128` est √©videmment l'algorithme utilis√©
* `vJMeK...KRE` est l'encodage en base58 de `IV_SIZE|IV|secret|CRC`

D'autres secrets peuvent √™tre trouv√©s (jetons, sauvegardes de configuration...) en utilisant l'expression r√©guli√®re suivante :
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
La cl√© est stock√©e dans `/var/opt/jfrog/artifactory/etc/security/artifactory.key` et ressemble √† :
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
O√π :

* `JS` repr√©sente une cl√©
* `25rLQ` est un identifiant de cl√© unique qui permet de savoir quelle cl√© peut d√©crypter quels secrets
* `AES128` est √©videmment l'algorithme utilis√©
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` est l'encodage base58 de la cl√© et de 2 octets de CRC

Cet outil que j'ai √©crit peut √™tre utilis√© hors ligne pour d√©crypter les secrets d'Artifactory : [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# D√©fendre Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

Si vous √™tes l'√©quipe bleue ou un administrateur d'Artifactory, √† ce stade, vous devriez avoir une assez bonne id√©e de ce qu'il faut faire :

* maintenir Artifactory √† jour, surtout lorsqu'il y a des mises √† jour critiques
* mettre en place une politique de mot de passe solide (pas de mots de passe par d√©faut, des mots de passe forts obligatoires, des verrouillages), de pr√©f√©rence diff√©r√©e √† un LDAP externe pour une meilleure supervision
* restreindre les acc√®s (respecter le principe du moindre privil√®ge), en particulier pour l'utilisateur anonyme
