<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


**Este conte√∫do foi retirado de** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Fundamentos do Artifactory <a href="#artifactory-basics" id="artifactory-basics"></a>

## Usu√°rios e senhas padr√£o <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

As contas padr√£o do Artifactory s√£o:

| Conta        | Senha padr√£o                                   | Notas                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | conta comum de administra√ß√£o                                         |
| access-admin | password (<6.8.0) ou um valor aleat√≥rio (>= 6.8.0) | usada apenas para opera√ß√µes de administra√ß√£o local                   |
| anonymous    | ‚Äô‚Äô                                             | usu√°rio an√¥nimo para recuperar pacotes remotamente, n√£o ativado por padr√£o |

Por padr√£o, n√£o h√° uma pol√≠tica de bloqueio de senha, o que torna o Artifactory um alvo principal para ataques de preenchimento de credenciais e pulveriza√ß√£o de senhas.

## Autoriza√ß√µes <a href="#authorizations" id="authorizations"></a>

Idealmente, √© isso que voc√™ deve ver ao se conectar ao Artifactory:

![P√°gina de login](https://www.errno.fr/artifactory/artif\_login.png)

Por outro lado, se voc√™ for recebido com algo mais parecido com isto:

![P√°gina padr√£o](https://www.errno.fr/artifactory/artif\_default.png)

Isso significa que o "Acesso An√¥nimo" foi habilitado no painel de administra√ß√£o, o que √© uma configura√ß√£o comum usada para permitir que aplica√ß√µes recuperem artefatos sem problemas, mas permite que voc√™, o atacante, veja mais do que √© prefer√≠vel.

## Verificando direitos de conta <a href="#checking-account-rights" id="checking-account-rights"></a>

√Äs vezes, devido a uma m√° configura√ß√£o, o usu√°rio an√¥nimo tem permiss√£o para implantar arquivos em alguns reposit√≥rios!

Para verificar em quais reposit√≥rios o usu√°rio an√¥nimo pode implantar, use a seguinte solicita√ß√£o:
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
Se houver entradas `repoKey` na solicita√ß√£o, o usu√°rio an√¥nimo pode implantar nelas, o que √© realmente muito ruim. Voc√™ definitivamente deve estar autenticado para implantar quaisquer arquivos.

Isso pode ser generalizado para outras contas assim que voc√™ obter uma senha ou token para elas.

## Listando usu√°rios <a href="#listing-users" id="listing-users"></a>

Por algum motivo, listar usu√°rios √© um direito reservado apenas para administradores. Encontrei uma maneira alternativa de listar usu√°rios (aqueles que est√£o ativamente implantando pelo menos) que depende do valor ‚ÄúImplantado Por‚Äù dos artefatos:

![Implantado Por](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[Este script](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a) simplesmente tenta encontrar recursivamente todos os usu√°rios que implantaram artefatos. Note que pode levar um tempo para ser conclu√≠do se houver muitos reposit√≥rios (>1000).
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## Permiss√µes <a href="#permissions" id="permissions"></a>

Aqui est√£o as permiss√µes b√°sicas e suas utilidades:

* Gerenciar: ?
* Excluir/Sobrescrever: interessante para pentest
* Implementar/Cache: interessante para pentest
* Anotar: necess√°rio para CVE-2020-7931
* Ler: geralmente uma permiss√£o padr√£o

# Vulnerabilidades conhecidas <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

Aqui est√° uma lista selecionada de vulnerabilidades p√∫blicas de alto impacto:

## CVE-2016-10036: Upload de Arquivo Arbitr√°rio & RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[Detalhes aqui.](https://www.exploit-db.com/exploits/44543)

Esta est√° ficando um pouco antiga e √© improv√°vel que voc√™ encontre uma vers√£o t√£o desatualizada do Artifactory. No entanto, √© bastante eficaz, pois √© uma simples travessia de diret√≥rio que permite a execu√ß√£o arbitr√°ria de c√≥digo no n√≠vel do Tomcat.

## CVE-2019-9733: Bypass de Autentica√ß√£o (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[Aviso original aqui.](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

Em vers√µes mais antigas do Artifactory (at√© 6.7.3), a conta `access-admin` usava uma senha padr√£o `password`.

Esta conta local normalmente √© proibida de acessar a UI ou API, mas at√© a vers√£o 6.8.6 o Artifactory poderia ser enganado para acreditar que a solicita√ß√£o emanava localmente se o cabe√ßalho HTTP `X-Forwarded-For` fosse definido como `127.0.0.1`.

## CVE-2020-7931: Inje√ß√£o de Template no Lado do Servidor (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[Aviso original aqui.](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

Aqui est√° uma [ferramenta que escrevi](https://github.com/gquere/CVE-2020-7931) para automatizar a explora√ß√£o desta vulnerabilidade.

Estes s√£o necess√°rios para a explora√ß√£o:

* um usu√°rio com direitos de implementar (criar arquivos) e anotar (definir filtrados)
* Artifactory Pro

A vulnerabilidade √© bastante simples: se um recurso implementado for definido como filtrado, ele √© interpretado como um Template Freemarker, o que d√° ao atacante uma janela de ataque SSTI. ![Recurso Filtrado](https://www.errno.fr/artifactory/artif\_filtered.png)

Aqui est√£o as primitivas implementadas:

* leituras b√°sicas do sistema de arquivos
* escritas limitadas no sistema de arquivos

Estas devem ser suficientes para lhe dar execu√ß√£o de c√≥digo remoto de v√°rias maneiras, da mais f√°cil/discreta √† mais dif√≠cil/barulhenta:

* lendo um segredo no sistema de arquivos que permite pivotar (/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa ‚Ä¶)
* adicionando uma chave SSH ao usu√°rio
* implementando um .war para executar um servlet
* implementando um script de usu√°rio Groovy do Artifactory

### Hist√≥rias de .war: Travessuras do Java renameTo() <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

Esta √© uma pequena hist√≥ria de como bati a cabe√ßa contra a parede por horas, se n√£o dias, durante um pentest. Eu me deparei com um Artifactory desatualizado que eu sabia que era vulner√°vel ao CVE-2020-7931. Implementei o template SSTI do aviso original e comecei a percorrer o sistema de arquivos. Parecia que o Artifactory havia sido instalado em um local n√£o padr√£o, o que n√£o √© t√£o incomum, pois os administradores gostam de manter parti√ß√µes separadas entre bin√°rios de aplicativos, dados, logs e configura√ß√£o (isso √© bom!). N√£o havia chaves SSH ou senhas no diret√≥rio home do usu√°rio que me proporcionassem um pivot f√°cil, ent√£o chegou a hora de ser menos discreto e escrever no sistema de arquivos. Colocar o payload inicial (uma chave p√∫blica) no diret√≥rio de upload do Artifactory foi tranquilo, mas eu simplesmente n√£o conseguia mov√™-lo para o diret√≥rio de chaves SSH. Ent√£o voltei para minha sandbox de explora√ß√£o, testei novamente e veja s√≥, funcionou bem. Ent√£o tinha que haver uma configura√ß√£o diferente que me impedia de completar o m√©todo `renameTo()`. Neste ponto, √© sempre uma boa ideia [verificar a documenta√ß√£o](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-) ... que claramente afirma que voc√™ n√£o pode renomear arquivos entre diferentes sistemas de arquivos, o que eu acho que faz sentido dependendo da implementa√ß√£o do m√©todo, ou seja, se ele funciona a n√≠vel de inode. Arg.

Lembra do que eu disse sobre os administradores gostarem de parti√ß√µes? Bem, este √© um caso de um administrador que, sem saber, refor√ßou sua configura√ß√£o contra meu exploit! Ent√£o eu tive que cavar o que √© essencialmente uma pris√£o Java para encontrar outro m√©todo que me permitisse escrever um arquivo no disco. E isso n√£o foi nada divertido, pois eu n√£o estou familiarizado com nada do que estava envolvido: Templates FTL, Java, Tomcat/Catalina. Rapidamente descobri que as fugas comuns de pris√µes Java simplesmente n√£o funcionariam, pois instanciar novas classes era proibido. Ap√≥s horas lendo a documenta√ß√£o das classes Java e Catalina, finalmente encontrei um m√©todo write() em um objeto ao qual eu poderia chegar. Mas ele era limitado ao caminho base da aplica√ß√£o web... Ent√£o pensei em combinar a escrita em outro sistema de arquivos e o `renameTo()` atrav√©s deste novo sistema de arquivos acess√≠vel para, esperan√ßosamente, poder escrever em qualquer lugar? E meio que funcionou. Eu consegui escrever fora do diret√≥rio tempor√°rio de upload ... mas n√£o t√£o longe dele, pois agora eu estava preso em outro sistema de arquivos que era o ponto de montagem para todas as coisas do artifactory: configura√ß√£o, aplicativo e coisas. Ent√£o ainda n√£o tinha chave SSH para mim.

Ok, eu poderia escrever na pasta raiz do artifactory, certamente eu poderia fazer algo aqui? Ei, o Tomcat padr√£o automaticamente implementa arquivos WAR escritos em seu caminho de aplica√ß√£o, n√£o √©? Ent√£o usei o msfvenom para gerar um webshell JSP embalado em um arquivo WAR e testei na minha sandbox... bem, ele foi implementado, mas n√£o me deu execu√ß√£o de comando. Parece que o Tomcat padr√£o n√£o lida com JSPs. Ugh. Ficando cada vez mais frustrado, procurei outra maneira de executar c√≥digo no Tomcat e encontrei outro m√©todo de execu√ß√£o usando servlets. N√£o consegui encontrar um payload apropriado ent√£o dane-se, estou all in neste ponto e [criei o meu pr√≥prio que voc√™ pode encontrar aqui](https://github.com/gquere/javaWebShell). Testei na sandbox, funciona, ok. Coloquei no alvo, implementa e ... nada. Acontece que havia um proxy na frente do artifactory que reescrevia todas as URLs para /artifactory. Ent√£o, mesmo que minha porta dos fundos estivesse implementada e funcionando, n√£o havia como eu acess√°-la... Se houvesse alguma execu√ß√£o de c√≥digo remoto a ser alcan√ßada neste ponto, teria que ser no contexto do Artifactory, n√£o do Tomcat.

Na manh√£ seguinte, estou solu√ßando na minha mesa olhando pela √∫ltima vez a documenta√ß√£o do Artifactory na v√£ esperan√ßa de uma epifania. E ent√£o as palavras m√°gicas "scripts Groovy" apareceram. Acontece que h√° uma maneira complicada de executar scripts Groovy, escrevendo-os no disco e recarregando-os atrav√©s da API. Salvo no √∫ltimo! Ent√£o eu coloquei um reverseshell Groovy na m√°quina e foi o fim daquilo. Ainda desejo ter encontrado um m√©todo mais limpo que teria escrito em qualquer lugar no sistema de arquivos usando o SSTI, mas com certeza n√£o ia voltar a desenvolver!

Felizmente, nem todos os pentests s√£o assim :)

# P√≥s-Explora√ß√£o <a href="#post-exploitation" id="post-exploitation"></a>

O seguinte s√≥ √© √∫til uma vez que voc√™ tenha alcan√ßado execu√ß√£o de c√≥digo remoto ou leitura arbitr√°ria de arquivo no servidor e pode ajud√°-lo a pivotar para outra m√°quina.

## Armazenamento de senhas e segredos externos <a href="#storage-of-passwords-and-external-secrets" id="storage-of-passwords-and-external-secrets"></a>

### Senhas locais <a href="#local-passwords" id="local-passwords"></a>

Senhas locais do artifactory s√£o armazenadas em forma de MD5 salgado ou bcrypt, sendo o primeiro depreciado.

Senhas MD5 s√£o sempre salgadas com o valor spring codificado `{CAFEBABEEBABEFAC}`, e usam simples concatena√ß√£o sem rodadas, ou seja, `hash = md5(senha + sal)`. O banco de dados diz que o sal √© `CAFEBABEEBABEFAC` mas acredite em mim, √© `{CAFEBABEEBABEFAC}`, eu tive dificuldade para encontr√°-lo :)

Quebrar essas senhas MD5 requer o uso de um modo din√¢mico para JtR:
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
O outro tipo de senha bcrypt n√£o requer nada especial, √© apenas um hash bcrypt padr√£o:
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### Segredos remotos <a href="#remote-secrets" id="remote-secrets"></a>

O Artifactory pode precisar armazenar segredos para se identificar a servi√ßos remotos. Esses segredos n√£o s√£o hasheados, claro, eles s√£o armazenados criptografados no disco, com a chave ao lado deles. Existem dois tipos de segredos mencionados na [documenta√ß√£o oficial](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/).

**Formato antigo (<5.9): DES-EDE**

TODO. [Abra uma issue se voc√™ tiver dados criptografados de exemplo](https://github.com/gquere/ArtifactoryDecryptor).

**Novo formato (>=5.9): Criptografia AES128-CBC, armazenada como base58**

Segredos externos (como senhas de servidores remotos) s√£o encontrados nos [descritores de configura√ß√£o](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor), por exemplo, `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` e parecem com:
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
Onde:

* `AM` sempre denota um segredo criptografado do artifactory
* `25rLQ` √© o identificador do segredo que deve corresponder ao identificador da chave
* `AES128` obviamente √© o algoritmo utilizado
* `vJMeK...KRE` √© a codifica√ß√£o base58 de `IV_SIZE|IV|segredo|CRC`

Mais segredos podem ser encontrados (tokens, backups de configura√ß√£o ...) usando a seguinte express√£o regular:
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
A chave est√° armazenada em `/var/opt/jfrog/artifactory/etc/security/artifactory.key` e parece com:
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
Onde:

* `JS` denota uma chave
* `25rLQ` √© um identificador de chave √∫nico que mant√©m o controle de qual chave pode descriptografar quais segredos
* `AES128` obviamente √© o algoritmo usado
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` √© a codifica√ß√£o base58 da chave e 2 bytes de CRC

Esta ferramenta que escrevi pode ser usada offline para descriptografar segredos do Artifactory: [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# Defendendo o Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

Se voc√™ faz parte da equipe azul ou √© um administrador do Artifactory, at√© agora voc√™ deve ter uma ideia bastante clara do que fazer:

* mantenha o Artifactory atualizado, especialmente quando atualiza√ß√µes cr√≠ticas s√£o emitidas
* implemente uma pol√≠tica de senha s√≥lida (sem senhas padr√£o, senhas fortes obrigat√≥rias, bloqueios), preferencialmente delegada a um LDAP externo para melhor supervis√£o
* restrinja acessos (respeite o princ√≠pio do menor privil√©gio), especialmente para o usu√°rio an√¥nimo


<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
