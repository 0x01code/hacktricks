<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


**Ce contenu a √©t√© pris sur** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Bases d'Artifactory <a href="#artifactory-basics" id="artifactory-basics"></a>

## Utilisateurs et mots de passe par d√©faut <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Les comptes par d√©faut d'Artifactory sont :

| Compte       | Mot de passe par d√©faut                        | Notes                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | compte d'administration courant                                      |
| access-admin | password (<6.8.0) ou une valeur al√©atoire (>= 6.8.0) | utilis√© uniquement pour les op√©rations d'administration locale       |
| anonymous    | ‚Äô‚Äô                                             | utilisateur anonyme pour r√©cup√©rer des paquets √† distance, non activ√© par d√©faut |

Par d√©faut, aucune politique de verrouillage de mot de passe n'est en place, ce qui fait d'Artifactory une cible privil√©gi√©e pour les attaques de remplissage d'identifiants et de pulv√©risation de mots de passe.

## Autorisations <a href="#authorizations" id="authorizations"></a>

Id√©alement, voici ce que vous devriez voir en vous connectant √† Artifactory :

![Page de connexion](https://www.errno.fr/artifactory/artif\_login.png)

D'autre part, si vous √™tes accueilli avec quelque chose de plus semblable √† ceci :

![Page par d√©faut](https://www.errno.fr/artifactory/artif\_default.png)

Cela signifie que "L'acc√®s anonyme" a √©t√© activ√© dans le panneau d'administration, ce qui est un param√®tre courant utilis√© pour permettre aux applications de r√©cup√©rer des artefacts sans probl√®me mais qui vous permet, √† vous l'attaquant, de voir plus que ce qui est pr√©f√©rable.

## V√©rification des droits des comptes <a href="#checking-account-rights" id="checking-account-rights"></a>

Parfois, √† cause d'une mauvaise configuration, anonymous est autoris√© √† d√©ployer des fichiers dans certains d√©p√¥ts !

Pour v√©rifier √† quels d√©p√¥ts l'utilisateur anonyme peut d√©ployer, utilisez la requ√™te suivante :
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
Si des entr√©es `repoKey` sont pr√©sentes dans la requ√™te, l'utilisateur anonyme peut y d√©ployer des fichiers, ce qui est vraiment tr√®s mauvais. Vous devriez d√©finitivement √™tre authentifi√© pour d√©ployer des fichiers.

Cela peut √™tre g√©n√©ralis√© √† d'autres comptes une fois que vous obtenez un mot de passe ou un jeton pour eux.

## Listage des utilisateurs <a href="#listing-users" id="listing-users"></a>

Pour une raison quelconque, lister les utilisateurs est un droit r√©serv√© uniquement aux administrateurs. J'ai trouv√© une autre mani√®re de lister les utilisateurs (ceux qui d√©ploient activement au moins) qui repose sur la valeur ‚ÄúD√©ploy√© par‚Äù des artefacts :

![D√©ploy√© par](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[Ce script](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a) essaie simplement de trouver de mani√®re r√©cursive tous les utilisateurs qui ont d√©ploy√© des artefacts. Notez que cela pourrait prendre du temps pour se compl√©ter s'il y a beaucoup de d√©p√¥ts (>1000).
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## Permissions <a href="#permissions" id="permissions"></a>

Voici les permissions de base et leur utilit√© :

* G√©rer : ?
* Supprimer/√âcraser : int√©ressant pour le pentest
* D√©ployer/Mettre en cache : int√©ressant pour le pentest
* Annoter : n√©cessaire pour CVE-2020-7931
* Lire : g√©n√©ralement une permission par d√©faut

# Vuln√©rabilit√©s connues <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

Voici une liste organis√©e de vuln√©rabilit√©s publiques √† fort impact :

## CVE-2016-10036 : T√©l√©versement de fichier arbitraire & RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[D√©tails ici.](https://www.exploit-db.com/exploits/44543)

Celle-ci commence √† dater et il est peu probable que vous tombiez sur une version aussi obsol√®te d'Artifactory. N√©anmoins, elle est assez efficace, car il s'agit d'une simple travers√©e de r√©pertoire qui permet l'ex√©cution de code arbitraire au niveau de Tomcat.

## CVE-2019-9733 : Contournement d'authentification (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[Conseil original ici.](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

Dans les anciennes versions d'Artifactory (jusqu'√† 6.7.3), le compte `access-admin` utilisait un mot de passe par d√©faut `password`.

Ce compte local est normalement interdit d'acc√®s √† l'UI ou √† l'API, mais jusqu'√† la version 6.8.6, Artifactory pouvait √™tre tromp√© en croyant que la requ√™te provenait localement si l'en-t√™te HTTP `X-Forwarded-For` √©tait d√©fini sur `127.0.0.1`.

## CVE-2020-7931 : Injection de mod√®le c√¥t√© serveur (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[Conseil original ici.](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

Voici un [outil que j'ai √©crit](https://github.com/gquere/CVE-2020-7931) pour automatiser l'exploitation de cette vuln√©rabilit√©.

Ces √©l√©ments sont n√©cessaires pour l'exploitation :

* un utilisateur avec les droits de d√©ploiement (cr√©er des fichiers) et d'annotation (d√©finir filtr√©)
* Artifactory Pro

La vuln√©rabilit√© est assez simple : si une ressource d√©ploy√©e est d√©finie comme filtr√©e, elle est interpr√©t√©e comme un mod√®le Freemarker, ce qui donne √† l'attaquant une fen√™tre d'attaque SSTI. ![Ressource filtr√©e](https://www.errno.fr/artifactory/artif\_filtered.png)

Voici les primitives impl√©ment√©es :

* lectures de base du syst√®me de fichiers
* √©critures limit√©es sur le syst√®me de fichiers

Celles-ci devraient suffire √† vous donner une ex√©cution de code √† distance de plusieurs mani√®res, de la plus facile/la plus discr√®te √† la plus difficile/la plus bruyante :

* lire un secret sur le syst√®me de fichiers qui vous permet de pivoter (/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa ‚Ä¶)
* ajouter une cl√© SSH √† l'utilisateur
* d√©ployer un .war pour ex√©cuter un servlet
* d√©ployer un script utilisateur Groovy d'Artifactory

### Histoires de .war : les manigances de Java renameTo() <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

C'est une petite histoire de comment j'ai but√© contre un mur pendant des heures, voire des jours, lors d'un pentest. Je suis tomb√© sur un Artifactory obsol√®te que je savais vuln√©rable au CVE-2020-7931. J'ai d√©ploy√© le mod√®le SSTI original de l'avis et commenc√© √† parcourir le syst√®me de fichiers. Il semblait qu'Artifactory avait √©t√© install√© dans un emplacement non standard, ce qui n'est pas trop inhabituel car les administrateurs aiment garder des partitions s√©par√©es entre les binaires d'application, les donn√©es, les journaux et la configuration (c'est une bonne chose !). Il n'y avait pas de cl√©s SSH ou de mots de passe dans le r√©pertoire personnel de l'utilisateur qui m'auraient fourni un pivot facile, donc il √©tait temps d'√™tre moins discret et d'√©crire sur le syst√®me de fichiers. D√©poser la charge utile initiale (une cl√© publique) dans le r√©pertoire de t√©l√©versement d'Artifactory s'est bien pass√©, mais je n'arrivais tout simplement pas √† la d√©placer vers le r√©pertoire des cl√©s SSH. Donc je suis retourn√© √† mon bac √† sable d'exploitation, l'ai test√© √† nouveau et, oh surprise, cela a fonctionn√©. Donc, il devait y avoir une configuration diff√©rente qui m'emp√™chait de compl√©ter la m√©thode `renameTo()`. √Ä ce stade, il est toujours bon de [v√©rifier la documentation](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-) ... qui indique clairement que vous ne pouvez pas renommer des fichiers √† travers diff√©rents syst√®mes de fichiers, ce qui, je suppose, a du sens selon l'impl√©mentation de la m√©thode, c'est-√†-dire si elle fonctionne au niveau d'un inode. Argh.

Vous souvenez-vous de ce que j'ai dit √† propos des administrateurs qui aiment les partitions ? Eh bien, c'est un cas o√π un administrateur, sans le savoir, a renforc√© sa configuration contre mon exploit ! J'ai donc d√ª creuser dans ce qui est essentiellement une prison Java pour trouver une autre m√©thode qui me permettrait d'√©crire un fichier sur le disque. Et ce n'√©tait pas du tout amusant, car je ne suis pas familier avec aucune des choses impliqu√©es : les mod√®les FTL, Java, Tomcat/Catalina. J'ai rapidement d√©couvert que les √©vasions de prison Java classiques ne suffiraient pas, car l'instanciation de nouvelles classes √©tait interdite. Apr√®s des heures de lecture de la documentation des classes Java et Catalina, j'ai finalement trouv√© une m√©thode write() sur un objet que je pouvais atteindre. Mais elle √©tait limit√©e au chemin de base de l'application web... Alors j'ai pens√© √† combiner l'√©criture sur un autre syst√®me de fichiers et le `renameTo()` √† travers ce nouveau syst√®me de fichiers accessible pour, esp√©rons-le, pouvoir √©crire n'importe o√π ? Et cela a en quelque sorte fonctionn√©. J'ai r√©ussi √† √©crire en dehors du r√©pertoire de t√©l√©versement temporaire ... mais pas si loin de celui-ci car maintenant j'√©tais coinc√© sur un autre syst√®me de fichiers qui √©tait le point de montage pour tout ce qui concerne artifactory : configuration, application et autres. Donc toujours pas de cl√© SSH pour moi.

D'accord, je pouvais √©crire dans le dossier racine d'artifactory, s√ªrement je pouvais faire quelque chose ici ? H√©, Tomcat par d√©faut d√©ploie automatiquement les fichiers WAR √©crits dans son chemin d'application, n'est-ce pas ? J'ai donc utilis√© msfvenom pour g√©n√©rer un webshell JSP emball√© dans un fichier WAR et l'ai test√© dans mon bac √† sable... eh bien, il a √©t√© d√©ploy√© correctement, mais ne m'a donn√© aucune ex√©cution de commande. Il semble que Tomcat par d√©faut ne g√®re pas les JSP. Ugh. De plus en plus frustr√©, j'ai cherch√© un autre moyen d'ex√©cuter du code dans Tomcat, et j'ai trouv√© une autre m√©thode d'ex√©cution utilisant des servlets. Je n'ai pas trouv√© de charge utile appropri√©e alors tant pis, je suis √† fond √† ce stade et [j'ai cr√©√© la mienne que vous pouvez trouver ici](https://github.com/gquere/javaWebShell). Test√© dans le bac √† sable, √ßa fonctionne, ok. Mis sur la cible, d√©ploy√© et ... nada. Il s'av√®re qu'il y avait un proxy devant artifactory qui r√©√©crivait toutes les URL en /artifactory. Donc m√™me si ma porte d√©rob√©e √©tait d√©ploy√©e et en cours d'ex√©cution, il n'y avait aucun moyen pour moi d'y acc√©der... S'il y avait une ex√©cution de code √† distance √† ce stade, elle devrait √™tre dans le contexte d'Artifactory, pas celui de Tomcat.

Le lendemain matin, je sanglotais √† mon bureau en regardant une derni√®re fois la documentation d'Artifactory dans l'espoir vain d'une √©piphanie. Et puis les mots magiques "scripts Groovy" sont apparus. Il s'av√®re qu'il y a une mani√®re compliqu√©e d'ex√©cuter des scripts Groovy, en les √©crivant sur le disque puis en les rechargeant via l'API. Sauv√© enfin ! J'ai donc lanc√© un reverseshell Groovy sur la machine et c'√©tait la fin de l'histoire. J'aurais quand m√™me souhait√© trouver une m√©thode plus propre qui aurait √©crit n'importe o√π sur le syst√®me de fichiers en utilisant le SSTI, mais je n'allais certainement pas revenir au d√©veloppement !

Heureusement, tous les pentests ne se d√©roulent pas comme √ßa :)

# Post-Exploitation <a href="#post-exploitation" id="post-exploitation"></a>

Les √©l√©ments suivants ne sont utiles qu'une fois que vous avez r√©alis√© une ex√©cution de code √† distance ou une lecture de fichier arbitraire sur le serveur et pourraient vous aider √† pivoter vers une autre machine.

## Stockage des mots de passe et secrets externes <a href="#storage-of-passwords-and-external-secrets" id="storage-of-passwords-and-external-secrets"></a>

### Mots de passe locaux <a href="#local-passwords" id="local-passwords"></a>

Les mots de passe locaux d'artifactory sont stock√©s soit sous forme de MD5 sal√©, soit de bcrypt, le premier √©tant obsol√®te.

Les mots de passe MD5 sont toujours sal√©s avec la valeur spring cod√©e en dur `{CAFEBABEEBABEFAC}`, et utilisent une simple concat√©nation sans tours, c'est-√†-dire `hash = md5(password + salt)`. La base de donn√©es dit que le sel est `CAFEBABEEBABEFAC` mais croyez-moi, c'est `{CAFEBABEEBABEFAC}`, j'ai eu du mal √† le trouver :)

Pour craquer ces mots de passe MD5, il faut utiliser un mode dynamique pour JtR :
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
L'autre type de mot de passe bcrypt ne n√©cessite rien de sp√©cial, c'est juste un hachage bcrypt standard :
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### Secrets distants <a href="#remote-secrets" id="remote-secrets"></a>

Artifactory peut n√©cessiter de stocker des secrets pour s'identifier aupr√®s de services distants. Ces secrets ne sont bien s√ªr pas hach√©s, ils sont stock√©s chiffr√©s sur le disque, avec la cl√© √† c√¥t√© d'eux. Il existe deux types de secrets mentionn√©s dans la [documentation officielle](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/).

**Ancien format (<5.9) : DES-EDE**

TODO. [Ouvrez un probl√®me si vous avez des donn√©es chiffr√©es d'exemple](https://github.com/gquere/ArtifactoryDecryptor).

**Nouveau format (>=5.9) : chiffrement AES128-CBC, stock√© en base58**

Les secrets externes (tels que les mots de passe des serveurs distants) se trouvent dans les [descripteurs de configuration](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor), par exemple `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` et ressemblent √† :
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
O√π :

* `AM` d√©signe toujours un secret chiffr√© d'artifactory
* `25rLQ` est l'identifiant secret qui doit correspondre √† l'identifiant de la cl√©
* `AES128` est √©videmment l'algorithme utilis√©
* `vJMeK...KRE` est l'encodage base58 de `IV_SIZE|IV|secret|CRC`

Plus de secrets peuvent √™tre trouv√©s (jetons, sauvegardes de configuration ‚Ä¶) en utilisant l'expression r√©guli√®re suivante :
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
La cl√© est stock√©e dans `/var/opt/jfrog/artifactory/etc/security/artifactory.key` et ressemble √† :
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
O√π :

* `JS` d√©signe une cl√©
* `25rLQ` est un identifiant de cl√© unique qui permet de suivre quelle cl√© peut d√©chiffrer quels secrets
* `AES128` est √©videmment l'algorithme utilis√©
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` est l'encodage en base58 de la cl√© et de 2 octets de CRC

Cet outil que j'ai √©crit peut √™tre utilis√© hors ligne pour d√©chiffrer les secrets Artifactory : [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# D√©fendre Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

Si vous √™tes l'√©quipe bleue ou un administrateur Artifactory, √† pr√©sent vous devriez avoir une assez bonne id√©e de quoi faire :

* maintenir Artifactory √† jour, surtout lorsque des mises √† jour critiques sont publi√©es
* mettre en ≈ìuvre une politique de mot de passe solide (pas de mots de passe par d√©faut, mots de passe forts obligatoires, verrouillages), de pr√©f√©rence d√©l√©gu√©e √† un LDAP externe pour une meilleure supervision
* restreindre les acc√®s (respecter le principe du moindre privil√®ge), surtout pour l'utilisateur anonyme


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
