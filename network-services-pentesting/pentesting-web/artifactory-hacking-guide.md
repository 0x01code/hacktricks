<details>

<summary><strong>零基础学习AWS黑客攻击成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>


**此内容摘自** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Artifactory基础知识 <a href="#artifactory-basics" id="artifactory-basics"></a>

## 默认用户和密码 <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Artifactory的默认账户有：

| 账户         | 默认密码                                      | 备注                                                                  |
| ------------ | --------------------------------------------- | --------------------------------------------------------------------- |
| admin        | password                                      | 常见的管理账户                                                        |
| access-admin | password (<6.8.0) 或 随机值 (>= 6.8.0)       | 仅用于本地管理操作                                                    |
| anonymous    | ’’                                            | 匿名用户远程检索包，不默认启用                                        |

默认情况下，没有密码锁定策略，这使得Artifactory成为凭证填充和密码喷涂攻击的首要目标。

## 授权 <a href="#authorizations" id="authorizations"></a>

理想情况下，当您连接到Artifactory时，应该看到这样的界面：

![登录页面](https://www.errno.fr/artifactory/artif\_login.png)

另一方面，如果您看到的是类似这样的界面：

![默认页面](https://www.errno.fr/artifactory/artif\_default.png)

这意味着在管理面板中启用了“匿名访问”，这是一个常见的设置，用于让应用程序无障碍地检索工件，但让您，攻击者，看到的内容比预期的要多。

## 检查账户权限 <a href="#checking-account-rights" id="checking-account-rights"></a>

有时，由于配置错误，匿名用户被允许向某些仓库部署文件！

要检查匿名用户可以部署到哪些仓库，请使用以下请求：
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
如果请求中有任何`repoKey`条目，匿名用户可以部署这些条目，这是非常非常糟糕的。你绝对应该经过认证才能部署任何文件。

一旦你获得了其他账户的密码或令牌，这可以推广到其他账户。

## 列出用户 <a href="#listing-users" id="listing-users"></a>

出于某种原因，列出用户是只有管理员才有的权限。我找到了一种替代方法来列出用户（至少是那些活跃部署的用户），这依赖于工件的“部署者”值：

![部署者](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[这个脚本](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a)简单地尝试递归查找所有部署了工件的用户。注意，如果仓库很多（>1000），完成这个操作可能需要一段时间。
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## 权限 <a href="#permissions" id="permissions"></a>

以下是基本权限及其用途：

* 管理：？
* 删除/覆盖：对渗透测试有趣
* 部署/缓存：对渗透测试有趣
* 注释：对于CVE-2020-7931必需
* 读取：通常是默认权限

# 已知漏洞 <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

以下是一份经过策划的高影响力公共漏洞列表：

## CVE-2016-10036：任意文件上传和RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[详情在这里。](https://www.exploit-db.com/exploits/44543)

这个漏洞有点旧，你不太可能遇到这么过时的Artifactory版本。尽管如此，它非常有效，因为它是一个简单的目录遍历，可以在Tomcat级别执行任意代码。

## CVE-2019-9733：身份验证绕过 (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[原始通告在这里。](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

在旧版本的Artifactory（直到6.7.3），`access-admin`账户使用默认密码`password`。

这个本地账户通常被禁止访问UI或API，但在6.8.6版本之前，如果将`X-Forwarded-For` HTTP头设置为`127.0.0.1`，可以欺骗Artifactory认为请求是本地发起的。

## CVE-2020-7931：服务器端模板注入（Artifactory Pro） <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[原始通告在这里。](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

这是我编写的[工具](https://github.com/gquere/CVE-2020-7931)，用于自动化利用这个漏洞。

这些是利用所需的：

* 拥有部署（创建文件）和注释（设置过滤）权限的用户
* Artifactory Pro

漏洞相当简单：如果部署的资源被设置为过滤，它会被解释为Freemarker模板，这为攻击者提供了SSTI攻击窗口。 ![过滤资源](https://www.errno.fr/artifactory/artif\_filtered.png)

以下是实现的原语：

* 基本文件系统读取
* 有限的文件系统写入

这些应该足以以多种方式实现远程代码执行，从最简单/最安静到最困难/最吵闹的：

* 读取文件系统上的秘密，让你转移（/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa …）
* 向用户添加SSH密钥
* 部署.war以执行servlet
* 部署Artifactory Groovy用户脚本

### .war故事：Java renameTo() 把戏 <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

这是一个关于我在渗透测试期间头疼了几个小时甚至几天的小故事。我遇到了一个过时的Artifactory，我知道它对CVE-2020-7931漏洞敏感。我部署了原始通告的SSTI模板，并开始浏览文件系统。看起来Artifactory安装在一个非标准位置，这并不太常见，因为管理员喜欢将应用程序二进制文件、数据、日志和配置保持在分开的分区中（这是好事！）。用户主目录中没有SSH密钥或密码，这本来可以为我提供一个简单的转移，所以到了不那么谨慎并写入文件系统的时候。在Artifactory的上传目录中放置初始有效载荷（一个公钥）进行得很顺利，但我就是无法将其移动到SSH密钥目录。所以我回到我的利用沙箱，再次测试，果然，它工作得很好。所以一定有不同的配置阻止了我完成`renameTo()`方法。这时候，最好是[查看文档](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-)……它明确指出你不能在不同的文件系统中重命名文件，这取决于方法的实现，即如果它在inode级别工作，这是有道理的。哎。

还记得我说的管理员喜欢分区吗？嗯，这是一个管理员在不知情的情况下加强了他的设置以抵御我的利用！所以我不得不深入到本质上是Java监狱的东西中，找到另一种方法，让我能够将文件写入磁盘。这一点都不有趣，因为我对任何涉及的东西都不熟悉：FTL模板、Java、Tomcat/Catalina。我很快发现，常规的Java监狱逃逸根本行不通，因为实例化新类是被禁止的。经过几个小时的阅读Java和Catalina类文档，我终于在一个我可以到达的对象上找到了一个write()方法。但它限于web应用程序的基本路径……那么我想到了结合写入另一个文件系统和`renameTo()`跨这个新可达文件系统，希望能够写入任何地方？这有点工作。我设法写出了临时上传目录……但离它不远，因为现在我被困在另一个文件系统上，这是所有artifactory事物的挂载点：配置、应用程序等等。所以我还是没有SSH密钥。

好吧，我可以写入artifactory根文件夹，我肯定可以在这里做点什么吧？嘿，Tomcat默认会自动部署写入其应用程序路径的WAR文件，不是吗？所以我使用msfvenom生成了一个打包在WAR文件中的JSP webshell，并在我的沙箱中测试了它……它确实部署了，但没有给我任何命令执行。看来默认的Tomcat不处理JSP。唉。越来越沮丧，我寻找另一种在Tomcat中执行代码的方法，并找到了使用servlets的另一种执行方法。找不到合适的有效载荷，所以搞它，我已经全力以赴了，并且[在这里推出了我自己的，你可以找到](https://github.com/gquere/javaWebShell)。在沙箱中测试，工作正常，好的。放在目标上，部署并且……什么也没有。原来，有一个代理在artifactory前面，将所有URL重写为/artifactory。所以即使我的后门部署并运行了，我也无法访问它……如果此时有一些远程代码执行要实现，它将必须在Artifactory的上下文中，而不是Tomcat的。

第二天早上，我在办公桌前哭泣，最后一次徒劳地查看Artifactory的文档，希望有所启示。然后“Groovy脚本”这些神奇的词出现了。原来有一种复杂的方法可以执行Groovy脚本，通过将它们写入磁盘然后通过API重新加载它们。最后得救了！所以我弹出了一个Groovy反向shell到机器，就是这样了。仍然希望我能找到一种更干净的方法，可以使用SSTI在文件系统上的任何地方写入，但我肯定不会回去开发了！

幸运的是，并非所有的渗透测试都是这样进行的 :)

# 后渗透 <a href="#post-exploitation" id="post-exploitation"></a>

以下内容仅在您实现了服务器上的远程代码执行或任意文件读取后有用，并且可能帮助您转移到另一台机器。

## 存储密码和外部秘密 <a href="#storage-of-passwords-and-external-secrets" id="storage-of-passwords-and-external-secrets"></a>

### 本地密码 <a href="#local-passwords" id="local-passwords"></a>

本地artifactory密码以盐化MD5或bcrypt形式存储，前者已被弃用。

MD5密码总是使用硬编码的spring值`{CAFEBABEEBABEFAC}`进行盐化，并且使用简单的连接没有轮次，即`hash = md5(password + salt)`。数据库说盐是`CAFEBABEEBABEFAC`，但相信我，它是`{CAFEBABEEBABEFAC}`，我找了很久 :)

破解这些MD5密码需要使用JtR的动态模式：
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
另一种bcrypt密码不需要任何特殊处理，它只是一个标准的bcrypt散列：
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### 远程秘密 <a href="#remote-secrets" id="remote-secrets"></a>

Artifactory 可能需要存储秘密以识别远程服务。这些秘密当然不是哈希的，它们被加密存储在磁盘上，密钥就在它们旁边。在[官方文档](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/)中提到了两种类型的秘密。

**旧格式 (<5.9): DES-EDE**

待办事项。[如果您有样本加密数据，请开一个问题](https://github.com/gquere/ArtifactoryDecryptor)。

**新格式 (>=5.9): AES128-CBC 加密，存储为 base58**

外部秘密（例如远程服务器的密码）可以在[配置描述符](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor)中找到，例如 `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml`，看起来像：
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
```markdown
在哪里：

* `AM` 总是表示一个加密的秘密
* `25rLQ` 是必须与密钥的标识符匹配的秘密标识符
* `AES128` 显然是使用的算法
* `vJMeK...KRE` 是 `IV_SIZE|IV|secret|CRC` 的 base58 编码

通过使用以下正则表达式可以找到更多秘密（令牌，配置备份等）：
```
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
密钥存储在 `/var/opt/jfrog/artifactory/etc/security/artifactory.key` 中，其内容如下：
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
```
其中：

* `JS` 表示一个密钥
* `25rLQ` 是一个独特的密钥标识符，用于跟踪哪个密钥可以解密哪些秘密
* `AES128` 显然是使用的算法
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` 是密钥的 base58 编码和 2 字节的 CRC

我编写的这个工具可以离线使用，用于解密 Artifactory 秘密：[ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor)。

# 防御 Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

如果你是蓝队或 Artifactory 管理员，到目前为止，你应该对接下来的操作有一个非常好的认识：

* 保持 Artifactory 更新，特别是当发布关键更新时
* 实施合理的密码策略（无默认密码，强制使用强密码，锁定账户），最好委托给外部 LDAP 进行更好的监管
* 限制访问（遵循最小权限原则），特别是对匿名用户的访问


<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 **HackTricks** 中看到你的**公司广告**或**下载 HackTricks 的 PDF** 版本，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向 [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。**

</details>
```
