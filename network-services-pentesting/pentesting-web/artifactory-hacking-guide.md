<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一个**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks的衣物**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


**这段内容来自** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory)

# Artifactory基础 <a href="#artifactory-basics" id="artifactory-basics"></a>

## 默认用户和密码 <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Artifactory的默认账户如下：

| 账户         | 默认密码                                       | 备注                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | 常用的管理账户                                                      |
| access-admin | password (<6.8.0) 或随机值 (>= 6.8.0)          | 仅用于本地管理操作                                                  |
| anonymous    | ’’                                             | 匿名用户，用于远程检索软件包，但默认情况下未启用                      |

默认情况下，Artifactory没有密码锁定策略，这使得Artifactory成为凭证填充和密码喷洒攻击的主要目标。

## 授权 <a href="#authorizations" id="authorizations"></a>

理想情况下，当连接到Artifactory时，您应该看到以下内容：

![登录页面](https://www.errno.fr/artifactory/artif\_login.png)

另一方面，如果您看到以下内容：

![默认页面](https://www.errno.fr/artifactory/artif\_default.png)

这意味着“匿名访问”已在管理面板中启用，这是一种常见的设置，用于让应用程序无需麻烦地检索工件，但也让您作为攻击者看到了更多不应该看到的内容。

## 检查账户权限 <a href="#checking-account-rights" id="checking-account-rights"></a>

有时，由于配置错误，匿名用户被允许向某些存储库部署文件！

要检查匿名用户可以向哪些存储库部署文件，请使用以下请求：
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
如果请求中存在`repoKey`条目，匿名用户可以向这些条目部署文件，这是非常糟糕的。你绝对应该进行身份验证才能部署任何文件。

一旦你获得了其他账户的密码或令牌，这个方法就可以推广到其他账户上。

## 列出用户 <a href="#listing-users" id="listing-users"></a>

由于某种原因，只有管理员才有权列出用户。我找到了一种替代方法来列出用户（至少是那些正在部署的用户），它依赖于工件的“Deployed By”值：

![Deployed By](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[这个脚本](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a)简单地尝试递归地找出所有已部署工件的用户。请注意，如果有很多仓库（>1000），这可能需要一些时间来完成。
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## 权限 <a href="#permissions" id="permissions"></a>

以下是基本权限及其用途：

* 管理：？
* 删除/覆盖：对渗透测试有趣
* 部署/缓存：对渗透测试有趣
* 注释：CVE-2020-7931所需
* 读取：通常是默认权限

# 已知漏洞 <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

以下是一份精选的高影响公开漏洞列表：

## CVE-2016-10036：任意文件上传和RCE（<4.8.6） <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[详细信息在此。](https://www.exploit-db.com/exploits/44543)

这个漏洞有点老了，你很难遇到这样一个过时的Artifactory版本。尽管如此，它非常有效，因为它是一个简单的目录遍历，可以在Tomcat级别上实现任意代码执行。

## CVE-2019-9733：身份验证绕过（<6.8.6） <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[原始公告在此。](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

在旧版本的Artifactory（最高版本为6.7.3）中，`access-admin`帐户使用默认密码`password`。

通常禁止此本地帐户访问UI或API，但在6.8.6版本之前，如果`X-Forwarded-For` HTTP头设置为`127.0.0.1`，Artifactory可能会被欺骗以为请求来自本地。

## CVE-2020-7931：服务器端模板注入（Artifactory Pro） <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[原始公告在此。](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

这是我编写的一个[工具](https://github.com/gquere/CVE-2020-7931)，用于自动化利用此漏洞。

利用此漏洞需要以下条件：

* 具有部署（创建文件）和注释（设置过滤）权限的用户
* Artifactory Pro

漏洞相当简单：如果部署的资源设置为过滤，则将其解释为Freemarker模板，这为攻击者提供了SSTI攻击窗口。 ![Filtered Resource](https://www.errno.fr/artifactory/artif\_filtered.png)

以下是已实现的基本功能：

* 基本文件系统读取
* 有限的文件系统写入

这些应该足以以多种方式实现远程代码执行，从最简单/最安静到最困难/最吵闹：

* 读取文件系统上的秘密信息，以便进行枢轴操作（/home/user/.bash\_history，/home/user/password.txt，/home/user/.ssh/id\_rsa等）
* 向用户添加SSH密钥
* 部署.war文件以执行servlet
* 部署Artifactory Groovy用户脚本

### .war故事：Java renameTo() 技巧 <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

这是我在渗透测试期间苦苦挣扎了数小时甚至数天的一个小故事。我遇到了一个过时的Artifactory，我知道它容易受到CVE-2020-7931的攻击。我部署了原始的SSTI模板，并开始浏览文件系统。似乎Artifactory安装在非标准位置，这并不太常见，因为管理员喜欢在应用程序二进制文件、数据、日志和配置之间保持分离的分区（这是一件好事！）。用户的主目录中没有SSH密钥或密码，这使我无法轻松进行枢轴操作，所以我不得不变得不那么谨慎并写入文件系统。将初始有效负载（公钥）放入Artifactory的上传目录中没有问题，但我就是无法将其移动到SSH密钥目录中。所以我回到我的渗透测试沙盒，再次测试，结果竟然奏效了。所以肯定有不同的配置阻止了我完成`renameTo()`方法。此时，[检查文档](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-)总是一个好主意...文档清楚地说明，您不能在不同的文件系统之间重命名文件，这在方法的实现方式上是有道理的，即如果它在inode级别工作。唉。

还记得我说过管理员喜欢分区吗？好吧，这是一个管理员在不知情的情况下加固了他的设置以防止我的攻击！所以我不得不深入研究实质上是Java监狱的东西，以找到另一种让我写入磁盘的方法。这一点一点都不好玩，因为我对所涉及的任何东西都不熟悉：FTL模板、Java、Tomcat/Catalina。我很快发现，常规的Java监狱逃逸是不够的，因为禁止实例化新类。经过几个小时阅读Java和Catalina类的文档，我终于找到了一个可以让我访问的对象上的write()方法。但它仅限于Web应用程序的基本路径...所以我想到了将写入另一个文件系统和通过这个新可访问的文件系统进行的`renameTo()`结合起来，希望能够写入任何位置？这种方法有点奏效。我设法写入临时上传目录之外的位置...但离它很远，因为现在我被困在另一个文件系统上，这是所有Artifactory的挂载点：配置、应用程序和其他东西。所以对我来说仍然没有SSH密钥。

好吧，我可以写入artifactory根文件夹，我肯定可以在这里做些什么吧？嘿，默认的Tomcat自动部署写入其应用程序路径的WAR文件，对吧？所以我使用msfvenom生成了一个打包在WAR文件中的JSP Webshell，并在我的沙盒中进行了测试...它确实被部署了，但没有给我带来命令执行。似乎默认的Tomcat不处理JSP。呃。越来越沮丧，我寻找另一种在Tomcat中执行代码的方法，并找到了使用servlet的另一种执行方法。找不到合适的有效负载，所以我就全力以赴，[自己开发了一个，你可以在这里找到](https://github.com/gquere/javaWebShell)。在沙盒中进行了测试，可以运行，好。将其放在目标上，部署并...什么都没有。结果，artifactory前面有一个代理，将所有URL重写为/artifactory。所以即使我的后门被部署和运行，我也无法访问它...如果此时有一些远程代码执行要完成，那必须在Artifactory的上下文中完成，而不是在Tomcat的上下文中。

第二天早上，我在办公桌前哭泣，最后一次徒劳地查看Artifactory的文档，希望能有所顿悟。然后神奇的词语“Groovy脚本”出现了。原来有一种复杂的方法可以通过将它们写入磁盘，然后通过API重新加载它们来执行Groovy脚本。终于解脱了！所以我弹出了一个Groovy反向shell到机器上，事情就这样结束了。我仍然希望能找到一种
# 后渗透 <a href="#post-exploitation" id="post-exploitation"></a>

以下内容仅在您已经成功实现对服务器的远程代码执行或任意文件读取，并且可能帮助您转向另一台机器时才有用。

## 密码和外部秘密的存储 <a href="#storage-of-passwords-and-external-secrets" id="storage-of-passwords-and-external-secrets"></a>

### 本地密码 <a href="#local-passwords" id="local-passwords"></a>

本地 artifactory 密码以盐化的 MD5 或 bcrypt 形式存储，前者已被弃用。

MD5 密码始终使用硬编码的 spring 值 `{CAFEBABEEBABEFAC}` 进行盐化，并且使用简单的连接方式，没有轮次，即 `hash = md5(password + salt)`。数据库中显示的盐值是 `CAFEBABEEBABEFAC`，但相信我，它实际上是 `{CAFEBABEEBABEFAC}`，我费了好大劲才找到它 :)

要破解这些 MD5 密码，需要使用 JtR 的动态模式：
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
另一种bcrypt密码类型不需要任何特殊操作，它只是一个标准的bcrypt哈希值：
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### 远程密钥 <a href="#remote-secrets" id="remote-secrets"></a>

Artifactory可能需要存储用于识别远程服务的密钥。这些密钥当然不是哈希值，而是加密存储在磁盘上，并且密钥就在它们旁边。在[官方文档](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/)中提到了两种类型的密钥。

**旧格式 (<5.9): DES-EDE**

TODO. [如果您有加密数据示例，请提交问题](https://github.com/gquere/ArtifactoryDecryptor)。

**新格式 (>=5.9): AES128-CBC加密，以base58格式存储**

外部密钥（例如远程服务器的密码）可以在[配置描述符](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor)中找到，例如：`/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml`，并且看起来像：
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
在这里：

* `AM` 总是表示一个加密的 artifactory 密钥
* `25rLQ` 是必须与密钥的标识符匹配的密钥标识符
* `AES128` 显然是使用的算法
* `vJMeK...KRE` 是 `IV_SIZE|IV|secret|CRC` 的 base58 编码

可以使用以下正则表达式找到更多的密钥（令牌、配置备份...）：
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
密钥存储在 `/var/opt/jfrog/artifactory/etc/security/artifactory.key` 中，格式如下：
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
在这里：

* `JS` 表示一个密钥
* `25rLQ` 是一个唯一的密钥标识符，用于跟踪哪个密钥可以解密哪些秘密
* `AES128` 显然是使用的算法
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` 是密钥和2个CRC字节的base58编码

我编写的这个工具可以离线使用来解密Artifactory的秘密：[ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor)。

# 防御Artifactory <a href="#defending-artifactory" id="defending-artifactory"></a>

如果你是蓝队或Artifactory管理员，现在你应该对该做什么有一个很好的想法：

* 保持Artifactory最新，特别是在发布关键更新时
* 实施健全的密码策略（不使用默认密码，强制使用强密码，锁定账户），最好将其委托给外部LDAP以便更好地监督
* 限制访问（遵循最小权限原则），特别是对于匿名用户


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得最新版本的PEASS或下载HackTricks的PDF吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
