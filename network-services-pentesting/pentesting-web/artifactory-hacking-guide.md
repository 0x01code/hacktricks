<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>


**このコンテンツは** [**https://www.errno.fr/artifactory/Attacking\_Artifactory**](https://www.errno.fr/artifactory/Attacking\_Artifactory) **から取得されました**

# Artifactoryの基本 <a href="#artifactory-basics" id="artifactory-basics"></a>

## デフォルトのユーザーとパスワード <a href="#default-users-and-passwords" id="default-users-and-passwords"></a>

Artifactoryのデフォルトアカウントは以下の通りです:

| アカウント      | デフォルトパスワード                               | 備考                                                                |
| ------------ | ---------------------------------------------- | -------------------------------------------------------------------- |
| admin        | password                                       | 一般的な管理アカウント                                        |
| access-admin | password (<6.8.0) または ランダムな値 (>= 6.8.0) | 本番環境の管理操作のみに使用される                        |
| anonymous    | ’’                                             | デフォルトでは有効になっていない、リモートからパッケージを取得するための匿名ユーザー |

デフォルトでは、パスワードロックポリシーが設定されていないため、Artifactoryはクレデンシャルスタッフィングやパスワードスプレー攻撃の主要なターゲットになります。

## 権限 <a href="#authorizations" id="authorizations"></a>

理想的には、Artifactoryに接続すると次のような画面が表示されるはずです:

![ログインページ](https://www.errno.fr/artifactory/artif\_login.png)

一方で、次のような画面が表示された場合:

![デフォルトページ](https://www.errno.fr/artifactory/artif\_default.png)

これは、管理パネルで「匿名アクセス」が有効になっていることを意味します。これはアプリケーションがアーティファクトを簡単に取得できるようにする一般的な設定ですが、攻撃者にとっては望ましくない情報が見えてしまうことを意味します。

## アカウント権限の確認 <a href="#checking-account-rights" id="checking-account-rights"></a>

時々、設定ミスにより、匿名ユーザーが一部のリポジトリにファイルをデプロイできるようになっていることがあります！

匿名ユーザーがデプロイできるリポジトリを確認するには、次のリクエストを使用します:
```
curl http://localhost:8081/artifactory/ui/repodata?deploy=true
{"repoList":["artifactory-build-info","example-repo-local"]}
```
```
リクエストに`repoKey`エントリがある場合、anonymousはこれらにデプロイできますが、これは非常に悪いことです。ファイルをデプロイするには、必ず認証されている必要があります。

これは、パスワードまたはトークンを取得した他のアカウントにも一般化できます。

## ユーザーのリスト表示 <a href="#listing-users" id="listing-users"></a>

何らかの理由で、ユーザーのリスト表示は管理者のみに予約された権利です。私はアーティファクトの「Deployed By」値に依存する、少なくともアクティブにデプロイしているユーザーをリストする別の方法を見つけました：

![Deployed By](https://www.errno.fr/artifactory/artif\_deployed\_by.png)

[このスクリプト](https://gist.github.com/gquere/347e8e042490be87e6e9e32e428cb47a)は、アーティファクトをデプロイしたすべてのユーザーを再帰的に見つけようとするだけです。リポジトリが多い場合（>1000）、完了するまでに時間がかかる可能性があることに注意してください。
```
```
./artifactory_list_users.py http://127.0.0.1:8081/artifactory
There are 23 repositories to process
Found user admin
Found user test
Found user user
Found user test_deploy
```
## 権限 <a href="#permissions" id="permissions"></a>

基本的な権限とその有用性は以下の通りです：

* Manage: ?
* Delete/Overwrite: ペンテストにおいて興味深い
* Deploy/Cache: ペンテストにおいて興味深い
* Annotate: CVE-2020-7931に必要
* Read: 通常はデフォルト権限

# 既知の脆弱性 <a href="#known-vulnerabilities" id="known-vulnerabilities"></a>

ここには、影響が大きい公開脆弱性のキュレーションリストがあります：

## CVE-2016-10036: 任意のファイルアップロード & RCE (<4.8.6) <a href="#cve-2016-10036-arbitrary-file-upload--rce-486" id="cve-2016-10036-arbitrary-file-upload--rce-486"></a>

[詳細はこちら。](https://www.exploit-db.com/exploits/44543)

これは少し古くなっており、このような古いバージョンのArtifactoryに遭遇することはあまりありません。それでも非常に効果的で、単純なディレクトリトラバーサルにより、Tomcatレベルで任意のコード実行が可能になります。

## CVE-2019-9733: 認証バイパス (<6.8.6) <a href="#cve-2019-9733-authentication-bypass-686" id="cve-2019-9733-authentication-bypass-686"></a>

[オリジナルのアドバイザリーはこちら。](https://www.ciphertechs.com/jfrog-artifactory-advisory/)

Artifactoryの古いバージョン（6.7.3まで）では、`access-admin`アカウントがデフォルトパスワード`password`を使用していました。

このローカルアカウントは通常、UIやAPIへのアクセスが禁止されていますが、バージョン6.8.6までのArtifactoryでは、`X-Forwarded-For` HTTPヘッダーが`127.0.0.1`に設定されている場合、リクエストがローカルから発信されたと誤認させることができました。

## CVE-2020-7931: サーバーサイドテンプレートインジェクション (Artifactory Pro) <a href="#cve-2020-7931-server-side-template-injection-artifactory-pro" id="cve-2020-7931-server-side-template-injection-artifactory-pro"></a>

[オリジナルのアドバイザリーはこちら。](https://github.com/atredispartners/advisories/blob/master/ATREDIS-2019-0006.md)

こちらは、この脆弱性の悪用を自動化するために[私が書いたツールです](https://github.com/gquere/CVE-2020-7931)。

悪用には以下が必要です：

* ファイルを作成する権限（deploy）と、フィルターを設定する権限（annotate）を持つユーザー
* Artifactory Pro

脆弱性はかなり単純です：デプロイされたリソースがフィルターされていると設定されている場合、それはFreemarkerテンプレートとして解釈され、攻撃者にSSTI攻撃の窓を提供します。 ![Filtered Resource](https://www.errno.fr/artifactory/artif\_filtered.png)

実装されたプリミティブは以下の通りです：

* 基本的なファイルシステムの読み取り
* 限定的なファイルシステムへの書き込み

これらは、最も簡単/静かな方法から最も困難/騒々しい方法まで、さまざまな方法でリモートコード実行を行うのに十分なはずです：

* ファイルシステム上の秘密を読み取り、ピボットを行う（/home/user/.bash\_history, /home/user/password.txt, /home/user/.ssh/id\_rsa など）
* ユーザーにSSHキーを追加する
* サーブレットを実行するための.warをデプロイする
* Artifactory Groovyユーザースクリプトをデプロイする

### .warストーリー：Java renameTo()の悪戯 <a href="#war-stories-java-renameto-shenanigans" id="war-stories-java-renameto-shenanigans"></a>

これは、ペンテスト中に何時間も、場合によっては数日間壁に頭をぶつけた小さな話です。私は古いArtifactoryに遭遇し、CVE-2020-7931に脆弱であることを知っていました。私は元のアドバイザリーのSSTIテンプレートをデプロイし、ファイルシステムを調べ始めました。Artifactoryが非標準の場所にインストールされているようでしたが、これは管理者がアプリケーションのバイナリ、データ、ログ、設定を分離したパーティションを好むため、それほど珍しいことではありません（これは良いことです！）。ユーザーのホームディレクトリにはSSHキーもパスワードもなく、簡単なピボットを提供するものはありませんでしたので、ファイルシステムに書き込むためにあまり控えめでない方法を取る時が来ました。Artifactoryのアップロードディレクトリに初期ペイロード（公開キー）をドロップすることはうまくいきましたが、SSHキーのディレクトリに移動することはできませんでした。そこで私は悪用のサンドボックスに戻り、再度テストしました。そしてなんと、うまくいきました。ですので、`renameTo()`メソッドを完了させるのを妨げている異なる設定があるはずでした。この時点で、[ドキュメントをチェックする](https://docs.oracle.com/javase/8/docs/api/java/io/File.html#renameTo-java.io.File-)のは常に良いアイデアです...これは、異なるファイルシステム間でファイルをリネームすることはできないと明確に述べています。これは、メソッドがinodeレベルで動作する場合には意味があるかもしれません。ああ。

管理者がパーティションを好むと言ったことを覚えていますか？さて、これは管理者が私のエクスプロイトに対して無意識のうちにセットアップを強化したケースです！ですので、私はJavaの監獄とも言えるものを掘り下げ、ディスクにファイルを書き込むことを可能にする別の方法を見つけなければなりませんでした。そしてそれは全く楽しいものではありませんでした。なぜなら、私は関与するどの事柄にも慣れていないからです：FTLテンプレート、Java、Tomcat/Catalina。私はすぐに、通常のJavaの監獄からの脱出はうまくいかないことを発見しました。新しいクラスのインスタンス化が禁止されていたからです。JavaとCatalinaのクラスのドキュメントを何時間も読んだ後、私は到達可能なオブジェクト上にwrite()メソッドを見つけました。しかし、それはウェブアプリケーションのベースパスに限定されていました...それから私は、別のファイルシステムへの書き込みと、この新しく到達可能なファイルシステムを越えた`renameTo()`を組み合わせて、どこにでも書き込むことができるのではないかと考えました？そして、それはある程度機能しました。私は一時的なアップロードディレクトリから書き出すことに成功しました...しかし、今度は私はartifactoryのすべてのもののマウントポイントである別のファイルシステムに閉じ込められました：設定、アプリケーションなど。ですので、まだSSHキーは手に入りませんでした。

さて、私はartifactoryのルートフォルダーに書き込むことができました。確かにここで何かできるはずですよね？ねえ、デフォルトのTomcatは自動的にアプリケーションパスに書かれたWARファイルをデプロイしますよね？それで私はmsfvenomを使用してJSPウェブシェルをWARファイルにパックして生成し、サンドボックスでテストしました...まあ、それは確かにデプロイされましたが、コマンド実行は得られませんでした。デフォルトのTomcatはJSPを処理しないようです。うーん。ますますイライラしてきた私は、Tomcatでコードを実行する別の方法を探し、サーブレットを使用する実行方法を見つけました。適切なペイロードが見つからなかったので、もう全部やってしまおうと思い、[自分で作成したものをこちらで見つけることができます](https://github.com/gquere/javaWebShell)。サンドボックスでテストし、動作する、OK。ターゲットに置いて、デプロイして...何も起こりません。artifactoryの前にプロキシがあり、すべてのURLを/artifactoryに書き換えていたことがわかりました。ですので、私のバックドアがデプロイされ実行されていたとしても、私がアクセスする方法はありませんでした...この時点で、何らかのリモートコード実行を達成するとしたら、TomcatのコンテキストではなくArtifactoryのコンテキストでなければなりませんでした。

翌朝、私は机で絶望的にArtifactoryのドキュメントを最後に見て、何かひらめきを得ることを虚しく願っていました。そして、魔法の言葉「Groovyスクリプト」が現れました。Groovyスクリプトを実行する複雑な方法があることがわかりました。それは、ディスクに書き込んでからAPIを通じてリロードすることです。最後に救われました！それで私はGroovyリバースシェルをマシンにポップし、それで終わりでした。SSTIを使用してファイルシステム上のどこにでも書き込むことができるよりクリーンな方法を見つけたかったのですが、開発に戻るつもりはありませんでした！

幸いにも、すべてのペンテストがこのようには進まないです :)

# ポストエクスプロイト <a href="#post-exploitation" id="post-exploitation"></a>

以下は、サーバーでリモートコード実行または任意のファイル読み取りを達成した後にのみ有用であり、別のマシンへのピボットに役立つかもしれません。

## パスワードと外部シークレットのストレージ <a href="#storage-of-passwords-and-external-secrets" id="storage-of-passwords-and-external-secrets"></a>

### ローカルパスワード <a href="#local-passwords" id="local-passwords"></a>

ローカルのartifactoryパスワードは、塩漬けMD5またはbcrypt形式で保存されており、前者は非推奨です。

MD5パスワードは常にハードコードされたspring値`{CAFEBABEEBABEFAC}`で塩漬けされ、ラウンドなしの単純な連結を使用しています。つまり、`hash = md5(password + salt)`です。データベースは塩が`CAFEBABEEBABEFAC`だと言っていますが、信じてください、それは`{CAFEBABEEBABEFAC}`です。見つけるのに苦労しました :)

これらのMD5パスワードをクラックするには、JtRのダイナミックモードを使用する必要があります：
```
cat artifactory.hashes
user:1f70548d73baca61aab8660733c7de81${CAFEBABEEBABEFAC}
john artifactory.hashes --format=dynamic_1
Loaded 1 password hash (dynamic_1 [md5($p.$s) (joomla) 256/256 AVX2 8x3])
password         (user)
```
他のタイプのbcryptパスワードには特別なものは必要ありません。それは単に標準的なbcryptハッシュです：
```
cat artifactory_bcrypt.hashes
admin:$2a$08$EbfHSAjPLoJnG/yHS/zmi.VizaWSipUuKAo7laKt6b8LePPTfDVeW
john artifactory_bcrypt.hashes
Loaded 1 password hash (bcrypt [Blowfish 32/64 X2])
password          (admin)
```
### リモートシークレット <a href="#remote-secrets" id="remote-secrets"></a>

Artifactoryはリモートサービスに識別するためのシークレットを保存する必要があります。これらのシークレットはハッシュ化されていませんが、暗号化されてディスク上に保存され、その鍵は隣にあります。[公式ドキュメント](https://jfrog.com/knowledge-base/what-are-the-artifactory-key-master-key-and-what-are-they-used-for/)には2種類のシークレットが言及されています。

**旧形式 (<5.9): DES-EDE**

TODO。[暗号化されたデータのサンプルがあれば問題を開いてください](https://github.com/gquere/ArtifactoryDecryptor)。

**新形式 (>=5.9): AES128-CBC暗号化、base58として保存**

外部シークレット（リモートサーバーのパスワードなど）は[設定記述子](https://www.jfrog.com/confluence/display/JFROG/Configuration+Files#ConfigurationFiles-GlobalConfigurationDescriptor)で見つかり、例えば `/var/opt/jfrog/artifactory/etc/artifactory.config.latest.xml` には次のように表示されます：
```
<keyStorePassword>AM.25rLQ.AES128.vJMeKkaK6RBRQCUKJWvYEHUw6zs394X1CrRugvJsQGPanhMgQ5be8yjWDhJYC4BEz2KRE</keyStorePassword>
```
```markdown
どこで:

* `AM` は常にアーティファクトリー暗号化シークレットを示します
* `25rLQ` はキーの識別子と一致しなければならないシークレット識別子です
* `AES128` は明らかに使用されるアルゴリズムです
* `vJMeK...KRE` は `IV_SIZE|IV|secret|CRC` のbase58エンコーディングです

以下の正規表現を使用することで、より多くのシークレット（トークン、設定バックアップなど）を見つけることができます:
```
```
grep -r 'AM\..*\.AES128\.' /var/opt/jfrog/artifactory/
```
キーは `/var/opt/jfrog/artifactory/etc/security/artifactory.key` に保存されており、以下のようになります:
```
JS.25rLQ.AES128.7fcJFd3Y2ib3wi4EHnhbvZuxu
```
```
どこで:

* `JS` はキーを示します
* `25rLQ` はどのキーがどの秘密を解読できるかを追跡するユニークなキー識別子です
* `AES128` は明らかに使用されるアルゴリズムです
* `7fcJFd3Y2ib3wi4EHnhbvZuxu` はキーとCRCの2バイトのbase58エンコーディングです

このツールは、Artifactoryの秘密をオフラインで解読するために使用できます: [ArtifactoryDecryptor](https://github.com/gquere/ArtifactoryDecryptor).

# Artifactoryの防御 <a href="#defending-artifactory" id="defending-artifactory"></a>

もしあなたがブルーチームまたはArtifactory管理者なら、今までに何をすべきかについてかなり良いアイデアを持っているはずです:

* 特に重要なアップデートが発行されたときは、Artifactoryを最新の状態に保つ
* 健全なパスワードポリシーを実装する（デフォルトパスワードなし、強力なパスワードの必須、ロックアウト）、できればより良い監視のために外部LDAPに委託する
* アクセスを制限する（最小権限の原則を尊重する）、特に匿名ユーザーに対して


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>!</strong></a></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
```
