# Nginx

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ.**
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference рдПрдХ рдЕрдВрддрд░реНрд░рд╛рд╖реНрдЯреНрд░реАрдп рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдЗрд╡реЗрдВрдЯ рд╣реИ**](https://www.dragonjarcon.org/) рдЬреЛ рдПрдХ рджрд╢рдХ рд╕реЗ рдЕрдзрд┐рдХ рд╕рдордп рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ 7 рдФрд░ 8 рд╕рд┐рддрдВрдмрд░ 2023 рдХреЛ рдмреЛрдЧреЛрдЯрд╛, рдХреЛрд▓рдВрдмрд┐рдпрд╛ рдореЗрдВ рдЖрдпреЛрдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдпрд╣ рдПрдХ рдЙрдЪреНрдЪ рддрдХрдиреАрдХреА рд╕рд╛рдордЧреНрд░реА рд╡рд╛рд▓рд╛ рдЗрд╡реЗрдВрдЯ рд╣реИ рдЬрд╣рд╛рдВ рд╕реНрдкреЗрдирд┐рд╢ рдореЗрдВ рдирд╡реАрдирддрдо рдЕрдиреБрд╕рдВрдзрд╛рди рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдЬреЛ рджреБрдирд┐рдпрд╛ рднрд░ рдХреЗ рд╣реИрдХрд░реНрд╕ рдФрд░ рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЖрдХрд░реНрд╖рд┐рдд рдХрд░рддреЗ рд╣реИрдВред\
рдЕрднреА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд▓рд┐рдВрдХ рдкрд░ рд░рдЬрд┐рд╕реНрдЯрд░ рдХрд░реЗрдВ рдФрд░ рдЗрд╕ рдорд╣рд╛рди рд╕рдореНрдореЗрд▓рди рдХреЛ рдорд┐рд╕ рди рдХрд░реЗрдВ!:

{% embed url="https://www.dragonjarcon.org/" %}

## Missing root location <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
`root` рдирд┐рд░реНрджреЗрд╢ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдХрд┐ Nginx рдХреЗ рд▓рд┐рдП рдореВрд▓ рдлрд╝реЛрд▓реНрдбрд░ рдХреНрдпрд╛ рд╣реИред рдКрдкрд░ рджрд┐рдП рдЧрдП рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдореВрд▓ рдлрд╝реЛрд▓реНрдбрд░ `/etc/nginx` рд╣реИ, рдЬрд┐рд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рд╣рдо рдЙрд╕ рдлрд╝реЛрд▓реНрдбрд░ рдХреЗ рднреАрддрд░ рдХреА рдлрд╝рд╛рдЗрд▓реЛрдВ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддреЗ рд╣реИрдВред рдКрдкрд░ рджрд┐рдП рдЧрдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдореЗрдВ `/ (location / {...})` рдХреЗ рд▓рд┐рдП рдХреЛрдИ рд╕реНрдерд╛рди рдирд╣реАрдВ рд╣реИ, рдХреЗрд╡рд▓ `/hello.txt` рдХреЗ рд▓рд┐рдП рд╣реИред рдЗрд╕ рдХрд╛рд░рдг рд╕реЗ, `root` рдирд┐рд░реНрджреЗрд╢ рд╡реИрд╢реНрд╡рд┐рдХ рд░реВрдк рд╕реЗ рд╕реЗрдЯ рд╣реЛ рдЬрд╛рдПрдЧрд╛, рдпрд╛рдиреА `/` рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдЖрдкрдХреЛ рд╕реНрдерд╛рдиреАрдп рдкрде `/etc/nginx` рдкрд░ рд▓реЗ рдЬрд╛рдПрдЧрд╛ред

рдЬрд┐рддрдирд╛ рд╕рд░рд▓ `GET /nginx.conf` рдЕрдиреБрд░реЛрдз рд╣реЛрдЧрд╛, рд╡рд╣ `/etc/nginx/nginx.conf` рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкреНрд░рдХрдЯ рдХрд░ рджреЗрдЧрд╛ред рдпрджрд┐ рдореВрд▓ `/etc` рдкрд░ рд╕реЗрдЯ рд╣реИ, рддреЛ `/nginx/nginx.conf` рдХреЗ рд▓рд┐рдП `GET` рдЕрдиреБрд░реЛрдз рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓ рдХреЛ рдкреНрд░рдХрдЯ рдХрд░ рджреЗрдЧрд╛ред рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЕрдиреНрдп рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЛрдВ, рдПрдХреНрд╕реЗрд╕-рд▓реЙрдЧреНрд╕ рдФрд░ рдпрд╣рд╛рдВ рддрдХ рдХрд┐ HTTP рдмреЗрд╕рд┐рдХ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЗ рд▓рд┐рдП рдПрдиреНрдХреНрд░рд┐рдкреНрдЯреЗрдб рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕ рддрдХ рдкрд╣реБрдБрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИред

## Alias LFI Misconfiguration <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рдЕрдВрджрд░ "location" рд╡рдХреНрддрд╡реНрдпреЛрдВ рдХреЛ рджреЗрдЦреЗрдВ, рдпрджрд┐ рдХреЛрдИ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ:
```
location /imgs {
alias /path/images/;
}
```
рдЗрд╕рдореЗрдВ LFI рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐:
```
/imgs../flag.txt
```
```markdown
# NGINX рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ

## рд╕рд╛рдорд╛рдиреНрдп рдЬрд╛рдирдХрд╛рд░реА

NGINX рдПрдХ рд▓реЛрдХрдкреНрд░рд┐рдп рд╡реЗрдм рд╕рд░реНрд╡рд░ рд╣реИ рдЬреЛ рдЕрдкрд╛рдЪреЗ рдХреЗ рд╡рд┐рдХрд▓реНрдк рдХреЗ рд░реВрдк рдореЗрдВ рдЙрднрд░рд╛ рд╣реИред рдпрд╣ рдЙрдЪреНрдЪ рдкреНрд░рджрд░реНрд╢рди, рд╕реНрдерд┐рд░рддрд╛, рд╕рд░рд▓ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди, рдФрд░ рдХрдо рд╕рдВрд╕рд╛рдзрди рдХреА рдЦрдкрдд рдХреЗ рд▓рд┐рдП рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИред

## рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ

### рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЬрд╛рдВрдЪ

рд╕рд░реНрд╡рд░ рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЬрд╛рдирдХрд╛рд░реА рдЕрдХреНрд╕рд░ HTTP рд╣реЗрдбрд░реНрд╕ рдореЗрдВ рдкрд╛рдИ рдЬрд╛рддреА рд╣реИред рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХрдорд╛рдВрдб рдХреЗ рд╕рд╛рде рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

```
curl -I <URL>
```

рд╕рд░реНрд╡рд░ рд╕реЗ `Server` рд╣реЗрдбрд░ рдореЗрдВ NGINX рд╕рдВрд╕реНрдХрд░рдг рдХреА рдЬрд╛рдирдХрд╛рд░реА рдорд┐рд▓ рд╕рдХрддреА рд╣реИред

### рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдлрд╝рд╛рдЗрд▓реЗрдВ рдФрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ

NGINX рд╕рд░реНрд╡рд░ рдкрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдлрд╝рд╛рдЗрд▓реЗрдВ рдФрд░ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдБ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рд╕реНрд░реЛрдд рд╣реЛ рд╕рдХрддреА рд╣реИрдВред рдЗрдиреНрд╣реЗрдВ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрдХрд░рдг рдФрд░ рддрдХрдиреАрдХреЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреА рд╣реИрдВ:

- `dirb`
- `gobuster`
- `nikto`

### рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдлрд╝рд╛рдЗрд▓реЗрдВ

рдХреБрдЫ рдлрд╝рд╛рдЗрд▓реЗрдВ рдЬреИрд╕реЗ рдХрд┐ `.git`, `.hg`, `.svn`, `backup.tar.gz`, рдпрд╛ `dump.sql` рд╕рд░реНрд╡рд░ рдкрд░ рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ рдЫреЛрдбрд╝реА рдЧрдИ рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдФрд░ рдпрджрд┐ рдЙрдиреНрд╣реЗрдВ рдПрдХреНрд╕реЗрд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рддреЛ рд╡реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЬрд╛рдирдХрд╛рд░реА рдХрд╛ рдЦреБрд▓рд╛рд╕рд╛ рдХрд░ рд╕рдХрддреА рд╣реИрдВред

### рд╕рд░реНрд╡рд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рддреНрд░реБрдЯрд┐рдпрд╛рдБ

рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╕рд░реНрд╡рд░ рдЕрдирдзрд┐рдХреГрдд рдкрд╣реБрдБрдЪ рдпрд╛ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓реАрдХ рдХрд╛ рдХрд╛рд░рдг рдмрди рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИрдВ:

- рдЕрдиреБрдЪрд┐рдд рдлрд╝рд╛рдЗрд▓ рдЕрдиреБрдорддрд┐рдпрд╛рдБ
- рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХреНрд░реЗрдбреЗрдВрд╢рд┐рдпрд▓реНрд╕
- рдЕрдиреБрдЪрд┐рдд рдбрд╛рдпрд░реЗрдХреНрдЯрд░реА рд▓рд┐рд╕реНрдЯрд┐рдВрдЧреНрд╕

### SSL/TLS рдЬрд╛рдВрдЪ

SSL/TLS рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрдкрдХрд░рдг рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреЗ рд╣реИрдВ:

- `sslyze`
- `testssl.sh`
- `Qualys SSL Labs' SSL Test`

рдпреЗ рдЙрдкрдХрд░рдг рд╕рд░реНрдЯрд┐рдлрд┐рдХреЗрдЯ рдХреА рд╡реИрдзрддрд╛, рд╕рдорд░реНрдерд┐рдд рд╕рд╛рдЗрдлрд░реНрд╕, рдФрд░ рдЕрдиреНрдп рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪреЛрдВ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧреА рд╣реИрдВред

## рдЙрдкрдпреЛрдЧреА рдХрдорд╛рдВрдбреНрд╕

рдпрд╣рд╛рдБ рдХреБрдЫ рдЙрдкрдпреЛрдЧреА рдХрдорд╛рдВрдбреНрд╕ рджреА рдЧрдИ рд╣реИрдВ рдЬреЛ NGINX рдкреЗрдВрдЯреЗрд╕реНрдЯрд┐рдВрдЧ рдХреЗ рджреМрд░рд╛рди рдХрд╛рдо рдЖ рд╕рдХрддреА рд╣реИрдВ:

```
curl -I <URL>
nikto -h <URL>
gobuster dir -u <URL> -w <wordlist>
```

рдЗрди рдХрдорд╛рдВрдбреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рд░реНрд╡рд░ рдХреА рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ, рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдлрд╝рд╛рдЗрд▓реЛрдВ рдХреА рдЦреЛрдЬ рдХрд░рдиреЗ, рдФрд░ рд╕реБрд░рдХреНрд╖рд╛ рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
```
```
/path/images/../flag.txt
```
рд╕рд╣реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реЛрдЧрд╛:
```
location /imgs/ {
alias /path/images/;
}
```
**рддреЛ, рдпрджрд┐ рдЖрдкрдХреЛ рдХреЛрдИ Nginx рд╕рд░реНрд╡рд░ рдорд┐рд▓рддрд╛ рд╣реИ рддреЛ рдЖрдкрдХреЛ рдЗрд╕ рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреА рдЪрд╛рд╣рд┐рдПред рд╕рд╛рде рд╣реА, рдпрджрд┐ рдЖрдк рдкрд╛рддреЗ рд╣реИрдВ рдХрд┐ рдлрд╛рдЗрд▓/рдбрд╛рдпрд░реЗрдХреНрдЯрд░реАрдЬрд╝ рдХреА рдмреНрд░реВрдЯ рдлреЛрд░реНрд╕ рдЕрдЬреАрдм рддрд░рд╣ рд╕реЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░ рд░рд╣реА рд╣реИ, рддреЛ рдЖрдк рдЗрд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВред**

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix рдкрд░реАрдХреНрд╖рдг:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдкрде рдкреНрд░рддрд┐рдмрдВрдз <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рддрд░реАрдХреЗ рдЬрд╛рдирдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рджреЗрдЦреЗрдВ:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╡реЗрд░рд┐рдПрдмрд▓ рдХрд╛ рдЙрдкрдпреЛрдЧ <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

рдПрдХ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг рд╣реИ:
```
location / {
return 302 https://example.com$uri;
}
```
HTTP рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЗ рд▓рд┐рдП рдирдИ рдкрдВрдХреНрддрд┐ рд╡рд░реНрдг \r (Carriage Return) рдФрд░ \n (Line Feed) рд╣реИрдВред рдирдИ рдкрдВрдХреНрддрд┐ рд╡рд░реНрдгреЛрдВ рдХреЛ URL-encoding рдХрд░рдиреЗ рд╕реЗ рд╡рд░реНрдгреЛрдВ рдХрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рддрд┐рдирд┐рдзрд┐рддреНрд╡ `%0d%0a` рд╣реЛрддрд╛ рд╣реИред рдЬрдм рдпреЗ рд╡рд░реНрдг рдПрдХ рдЕрдиреБрд░реЛрдз рдореЗрдВ `http://localhost/%0d%0aDetectify:%20clrf` рдХреА рддрд░рд╣ рд╢рд╛рдорд┐рд▓ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рддреЛ рдПрдХ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╡рд╛рд▓реЗ рд╕рд░реНрд╡рд░ рдХреЛ рднреЗрдЬреЗ рдЬрд╛рдиреЗ рдкрд░, рд╕рд░реНрд╡рд░ `Detectify` рдирд╛рдордХ рдПрдХ рдирдпрд╛ рд╣реЗрдбрд░ рдХреЗ рд╕рд╛рде рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рджреЗрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ $uri рд╡реЗрд░рд┐рдПрдмрд▓ рдореЗрдВ URL-decoded рдирдИ рдкрдВрдХреНрддрд┐ рд╡рд░реНрдг рд╣реЛрддреЗ рд╣реИрдВред
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
CRLF рдЗрдВрдЬреЗрдХреНрд╢рди рдФрд░ рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рд╕реНрдкреНрд▓рд┐рдЯрд┐рдВрдЧ рдХреЗ рдЬреЛрдЦрд┐рдореЛрдВ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЬрд╛рдиреЗрдВ [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/) рдкрд░ред

### рдХреЛрдИ рднреА рд╡реЗрд░рд┐рдПрдмрд▓

рдХреБрдЫ рдорд╛рдорд▓реЛрдВ рдореЗрдВ, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛-рдкреНрд░рджрддреНрдд рдбреЗрдЯрд╛ рдХреЛ Nginx рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдирд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдЕрд╕реНрдкрд╖реНрдЯ рд╣реИ рдХрд┐ рдРрд╕рд╛ рдХреНрдпреЛрдВ рд╣реЛ рд░рд╣рд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдЗрддрдирд╛ рдЕрд╕рд╛рдорд╛рдиреНрдп рдпрд╛ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрд╕рд╛рди рдирд╣реАрдВ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рдЗрд╕ [H1 рд░рд┐рдкреЛрд░реНрдЯ](https://hackerone.com/reports/370094) рдореЗрдВ рджреЗрдЦрд╛ рдЧрдпрд╛ рд╣реИред рдпрджрд┐ рд╣рдо рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢ рдХреА рдЦреЛрдЬ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдпрд╣ [SSI рдлрд┐рд▓реНрдЯрд░ рдореЙрдбреНрдпреВрд▓](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365) рдореЗрдВ рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рдкрддрд╛ рдЪрд▓рддрд╛ рд╣реИ рдХрд┐ рдпрд╣ SSI рдХреЗ рдХрд╛рд░рдг рд╣реИред

рдЗрд╕рдХреА рдЬрд╛рдВрдЪ рдХрд░рдиреЗ рдХрд╛ рдПрдХ рддрд░реАрдХрд╛ рд╣реИ рд░реЗрдлрд░рд░ рд╣реЗрдбрд░ рдорд╛рди рд╕реЗрдЯ рдХрд░рдирд╛:
```
$ curl -H тАШReferer: barтАЩ http://localhost/foo$http_referer | grep тАШfoobarтАЩ
```
рд╣рдордиреЗ рдЗрд╕ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЗ рд▓рд┐рдП рд╕реНрдХреИрди рдХрд┐рдпрд╛ рдФрд░ рдХрдИ рдЙрджрд╛рд╣рд░рдг рдкрд╛рдП рдЬрд╣рд╛рдВ рдПрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ Nginx рд╡реЗрд░рд┐рдПрдмрд▓реНрд╕ рдХрд╛ рдореВрд▓реНрдп рдкреНрд░рд┐рдВрдЯ рдХрд░ рд╕рдХрддрд╛ рдерд╛ред рдкрд╛рдП рдЧрдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдЙрджрд╛рд╣рд░рдгреЛрдВ рдХреА рд╕рдВрдЦреНрдпрд╛ рдореЗрдВ рдХрдореА рдЖрдИ рд╣реИ, рдЬреЛ рдЗрдВрдЧрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдЗрд╕реЗ рдкреИрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

## рдХрдЪреНрдЪреЗ рдмреИрдХрдПрдВрдб рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкрдврд╝рдирд╛

Nginx рдХреЗ `proxy_pass` рдХреЗ рд╕рд╛рде, рдмреИрдХрдПрдВрдб рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рддреНрд░реБрдЯрд┐рдпреЛрдВ рдФрд░ HTTP рд╣реЗрдбрд░реНрд╕ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИред рдпрд╣ рдмрд╣реБрдд рдЙрдкрдпреЛрдЧреА рд╣реИ рдпрджрд┐ рдЖрдк рдЖрдВрддрд░рд┐рдХ рддреНрд░реБрдЯрд┐ рд╕рдВрджреЗрд╢реЛрдВ рдФрд░ рд╣реЗрдбрд░реНрд╕ рдХреЛ рдЫрд┐рдкрд╛рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╡реЗ Nginx рджреНрд╡рд╛рд░рд╛ рд╕рдВрднрд╛рд▓реЗ рдЬрд╛рдПрдВред рдпрджрд┐ рдмреИрдХрдПрдВрдб рдПрдХ рддреНрд░реБрдЯрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЗ рд╕рд╛рде рдЙрддреНрддрд░ рджреЗрддрд╛ рд╣реИ, рддреЛ Nginx рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рд░реВрдк рд╕реЗ рдПрдХ рдХрд╕реНрдЯрдо рддреНрд░реБрдЯрд┐ рдкреГрд╖реНрда рдкреНрд░рджрд╛рди рдХрд░реЗрдЧрд╛ред рд▓реЗрдХрд┐рди рдХреНрдпрд╛ рд╣реЛрдЧрд╛ рдпрджрд┐ Nginx рдХреЛ рд╕рдордЭ рдореЗрдВ рдирд╣реАрдВ рдЖрддрд╛ рдХрд┐ рдпрд╣ рдПрдХ HTTP рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╣реИ?

рдпрджрд┐ рдПрдХ рдХреНрд▓рд╛рдЗрдВрдЯ Nginx рдХреЛ рдПрдХ рдЕрдорд╛рдиреНрдп HTTP рдЕрдиреБрд░реЛрдз рднреЗрдЬрддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рдЕрдиреБрд░реЛрдз рдЬреИрд╕рд╛ рд╣реИ рд╡реИрд╕рд╛ рд╣реА рдмреИрдХрдПрдВрдб рдХреЛ рдлреЙрд░рд╡рд░реНрдб рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдмреИрдХрдПрдВрдб рдЕрдкрдиреА рдХрдЪреНрдЪреА рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рдЙрддреНрддрд░ рджреЗрдЧрд╛ред рдлрд┐рд░, Nginx рдЕрдорд╛рдиреНрдп HTTP рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рд╕рдордЭ рдирд╣реАрдВ рдкрд╛рдПрдЧрд╛ рдФрд░ рдмрд╕ рдЗрд╕реЗ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдлреЙрд░рд╡рд░реНрдб рдХрд░ рджреЗрдЧрд╛ред рдЗрд╕реЗ рдПрдХ uWSGI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рддрд░рд╣ рдХрд▓реНрдкрдирд╛ рдХрд░реЗрдВ:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
рдФрд░ Nginx рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХреЗ рд╕рд╛рде:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
```markdown
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдпрджрд┐ рдмреИрдХрдПрдВрдб рдХрд╛ рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рд╕реНрдЯреЗрдЯрд╕ 300 рд╕реЗ рдЕрдзрд┐рдХ рд╣реИ, рддреЛ рдПрдХ рдХрд╕реНрдЯрдо рд░рд┐рд╕реНрдкреЙрдиреНрд╕ рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рд╣рдорд╛рд░реЗ uWSGI рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдКрдкрд░, рд╣рдо `500 Error` рднреЗрдЬреЗрдВрдЧреЗ рдЬрд┐рд╕реЗ Nginx рджреНрд╡рд╛рд░рд╛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) рдХрд╛рдлреА рд╣рдж рддрдХ рд╕реНрд╡рдпрдВ рд╕реНрдкрд╖реНрдЯ рд╣реИ; рдпрд╣ рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реЗ рдХрд┐рд╕реА рднреА рдирд┐рд░реНрджрд┐рд╖реНрдЯ HTTP рд╣реЗрдбрд░ рдХреЛ рдЫрд┐рдкрд╛рдПрдЧрд╛ред

рдпрджрд┐ рд╣рдо рдПрдХ рд╕рд╛рдорд╛рдиреНрдп `GET` рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреЗ рд╣реИрдВ, рддреЛ Nginx рд╡рд╛рдкрд╕ рдХрд░реЗрдЧрд╛:
```
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
рд▓реЗрдХрд┐рди рдЕрдЧрд░ рд╣рдо рдПрдХ рдЕрдорд╛рдиреНрдп HTTP рдЕрдиреБрд░реЛрдз рднреЗрдЬрддреЗ рд╣реИрдВ, рдЬреИрд╕реЗ рдХрд┐:
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
рд╣рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдорд┐рд▓реЗрдЧреА:
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes рдХреЛ off рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ

[merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) рдирд┐рд░реНрджреЗрд╢ рдХреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ "on" рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рджреЛ рдпрд╛ рдЕрдзрд┐рдХ рдЖрдЧреЗ рдХреА рд╕реНрд▓реИрд╢реЗрдЬрд╝ рдХреЛ рдПрдХ рдореЗрдВ рд╕рдВрдкреАрдбрд╝рд┐рдд рдХрд░рдиреЗ рдХреА рдПрдХ рддрдВрддреНрд░ рд╣реИ, рдЗрд╕рд▓рд┐рдП `///` `/` рдмрди рдЬрд╛рдПрдЧрд╛ред рдпрджрд┐ Nginx рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рд░рд┐рд╡рд░реНрд╕-рдкреНрд░реЙрдХреНрд╕реА рдХреЗ рд░реВрдк рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдкреНрд░реЙрдХреНрд╕реА рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╕реНрдерд╛рдиреАрдп рдлрд╝рд╛рдЗрд▓ рд╕рдорд╛рд╡реЗрд╢рди рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИ, рддреЛ рдЕрдиреБрд░реЛрдз рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рд╕реНрд▓реИрд╢реЗрдЬрд╝ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЗрд╕рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬрдЧрд╣ рдЫреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИред рдЗрд╕реЗ [Danny Robinson рдФрд░ Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд╕реНрддрд╛рд░ рд╕реЗ рд╡рд░реНрдгрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рд╣рдореЗрдВ 33 Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдлрд╝рд╛рдЗрд▓реЗрдВ рдорд┐рд▓реАрдВ рдЬрд┐рдирдореЗрдВ `merge_slashes` рдХреЛ "off" рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

## map рдирд┐рд░реНрджреЗрд╢ рдХреЗ рд▓рд┐рдП default рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реИ

рдпрд╣ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдорд╛рдорд▓рд╛ рдкреНрд░рддреАрдд рд╣реЛрддрд╛ рд╣реИ рдЬрдм **`map` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рд╕реА рдкреНрд░рдХрд╛рд░ рдХреЗ рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдирд┐рдпрдВрддреНрд░рдг рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рд╕рд░рд▓реАрдХреГрдд рдЙрджрд╛рд╣рд░рдг рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджрд┐рдЦ рд╕рдХрддрд╛ рд╣реИ:
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[рдореИрдиреБрдЕрд▓ рдХреЗ рдЕрдиреБрд╕рд╛рд░](https://nginx.org/en/docs/http/ngx_http_map_module.html):

> рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдорд╛рди\
> рдпрджрд┐ рд╕реНрд░реЛрдд рдорд╛рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╡реЗрд░рд┐рдПрдВрдЯреНрд╕ рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рд╕реЗ рднреА рдореЗрд▓ рдирд╣реАрдВ рдЦрд╛рддрд╛ рд╣реИ рддреЛ рдкрд░рд┐рдгрд╛рдореА рдорд╛рди рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред рдЬрдм рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ\
> рдкрд░рд┐рдгрд╛рдореА рдорд╛рди рдПрдХ рдЦрд╛рд▓реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реЛрдЧрд╛ред

`default` рдорд╛рди рдХреЛ рднреВрд▓рдирд╛ рдЖрд╕рд╛рди рд╣реИред рдЗрд╕рд▓рд┐рдП **рджреБрд░реНрднрд╛рд╡рдирд╛рдкреВрд░реНрдг рд╡реНрдпрдХреНрддрд┐ "рдкреНрд░рд╛рдзрд┐рдХрд░рдг рдирд┐рдпрдВрддреНрд░рдг" рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ** рдмрд╕ `/map-poc` рдХреЗ рдЕрдВрджрд░ **рдЕрд╕реНрддрд┐рддреНрд╡рд╣реАрди рдорд╛рдорд▓реЗ рддрдХ рдкрд╣реБрдБрдЪрдХрд░** рдЬреИрд╕реЗ рдХрд┐ `https://targethost.com/map-poc/another-private-area`.

## DNS Spoofing Nginx

рдЗрд╕ рдкреЛрд╕реНрдЯ рдХреЗ рдЕрдиреБрд╕рд╛рд░: [http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **DNS рд░рд┐рдХреЙрд░реНрдбреНрд╕ рдХреЛ рд╕реНрдкреВрдл рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ** Nginx рдХреЗ рд▓рд┐рдП рдпрджрд┐ рдЖрдк **DNS рд╕рд░реНрд╡рд░ рдЬрд╛рдирддреЗ рд╣реИрдВ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ Nginx рдХрд░ рд░рд╣рд╛ рд╣реИ** (рдФрд░ рдЖрдк рдХрд┐рд╕реА рддрд░рд╣ рд╕рдВрдЪрд╛рд░ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕рд▓рд┐рдП рдпрд╣ **рдорд╛рдиреНрдп рдирд╣реАрдВ рд╣реИ рдЕрдЧрд░ 127.0.0.1** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ) рдФрд░ **рдбреЛрдореЗрди рдЬрд┐рд╕реЗ рдпрд╣ рдкреВрдЫ рд░рд╣рд╛ рд╣реИ**ред

Nginx рдЗрд╕рдХреЗ рд╕рд╛рде DNS рд╕рд░реНрд╡рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```
resolver     8.8.8.8;
```
## `proxy_pass` рдФрд░ `internal` рдирд┐рд░реНрджреЗрд╢

**`proxy_pass`** рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ **рдЕрдиреНрдп рд╕рд░реНрд╡рд░реЛрдВ рдХреЛ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рдЕрдиреБрд░реЛрдз рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЪрд╛рд╣реЗ рд╡реЗ рдЖрдВрддрд░рд┐рдХ рд╣реЛрдВ рдпрд╛ рдмрд╛рд╣рд░реАред\
**`internal`** рдирд┐рд░реНрджреЗрд╢ рдХрд╛ рдЙрдкрдпреЛрдЧ Nginx рдХреЛ рдпрд╣ рд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ **рд╕реНрдерд╛рди рдХреЗрд╡рд▓ рдЖрдВрддрд░рд┐рдХ рд░реВрдк рд╕реЗ рд╣реА рдкрд╣реБрдБрдЪрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред

рдЗрди рдирд┐рд░реНрджреЗрд╢реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ **рдХрдордЬреЛрд░реА рдирд╣реАрдВ рд╣реИ рд▓реЗрдХрд┐рди рдЖрдкрдХреЛ рдЬрд╛рдВрдЪрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ рд╡реЗ рдХреИрд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╣реИрдВ**ред

## proxy\_set\_header Upgrade & Connection

рдпрджрд┐ nginx рд╕рд░реНрд╡рд░ Upgrade рдФрд░ Connection рд╣реЗрдбрд░реНрд╕ рдХреЛ рдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рд╕рдВрд░рдХреНрд╖рд┐рдд/рдЖрдВрддрд░рд┐рдХ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рддрдХ рдкрд╣реБрдБрдЪрдиреЗ рдХреЗ рд▓рд┐рдП [**h2c Smuggling рд╣рдорд▓рд╛**](../../pentesting-web/h2c-smuggling.md) рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

{% hint style="danger" %}
рдпрд╣ рдХрдордЬреЛрд░реА рд╣рдорд▓рд╛рд╡рд░ рдХреЛ **`proxy_pass` рдПрдВрдбрдкреЙрдЗрдВрдЯ (`http://backend:9999` рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ) рдХреЗ рд╕рд╛рде рд╕реАрдзрд╛ рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧреА** рдЬрд┐рд╕рдХреА рд╕рд╛рдордЧреНрд░реА nginx рджреНрд╡рд╛рд░рд╛ рдЬрд╛рдВрдЪреА рдирд╣реАрдВ рдЬрд╛рдПрдЧреАред
{% endhint %}

рдпрд╣рд╛рдБ рд╕реЗ `/flag` рдЪреБрд░рд╛рдиреЗ рдХреЗ рд▓рд┐рдП рдХрдордЬреЛрд░ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг [рдпрд╣рд╛рдБ](https://bishopfox.com/blog/h2c-smuggling-request) рд╣реИ:
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ `proxy_pass` рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ **рдкрде** рдЬреИрд╕реЗ рдХрд┐ `http://backend:9999/socket.io` рдХреА рдУрд░ рдЗрд╢рд╛рд░рд╛ рдХрд░ рд░рд╣рд╛ рдерд╛, рддреЛ рднреА рдХрдиреЗрдХреНрд╢рди `http://backend:9999` рдХреЗ рд╕рд╛рде рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ рдЗрд╕рд▓рд┐рдП рдЖрдк **рдЙрд╕ рдЖрдВрддрд░рд┐рдХ рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЗ рдЕрдВрджрд░ рдХрд┐рд╕реА рднреА рдЕрдиреНрдп рдкрде рд╕реЗ рд╕рдВрдкрд░реНрдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЗрд╕рд▓рд┐рдП рдпрд╣ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдирд╣реАрдВ рд╣реИ рдХрд┐ proxy\_pass рдХреЗ URL рдореЗрдВ рдХреЛрдИ рдкрде рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╣реИ рдпрд╛ рдирд╣реАрдВред**
{% endhint %}

## рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рдЖрдЬрдорд╛рдПрдВ

Detectify рдиреЗ рдПрдХ GitHub рд░рд┐рдкреЙрдЬрд┐рдЯрд░реА рдмрдирд╛рдИ рд╣реИ рдЬрд╣рд╛рдБ рдЖрдк Docker рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЕрдкрдирд╛ рдЦреБрдж рдХрд╛ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ Nginx рдЯреЗрд╕реНрдЯ рд╕рд░реНрд╡рд░ рд╕реЗрдЯрдЕрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдЗрд╕ рд▓реЗрдЦ рдореЗрдВ рдЪрд░реНрдЪрд╛ рдХреА рдЧрдИ рдХреБрдЫ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рд╣реИрдВ рдФрд░ рдЦреБрдж рдЙрдиреНрд╣реЗрдВ рдвреВрдВрдврдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## рд╕реНрдЯреИрдЯрд┐рдХ рдПрдирд╛рд▓рд╛рдЗрдЬрд╝рд░ рдЯреВрд▓реНрд╕

### [GIXY](https://github.com/yandex/gixy)

Gixy Nginx рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХрд╛ рд╡рд┐рд╢реНрд▓реЗрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЯреВрд▓ рд╣реИред Gixy рдХрд╛ рдореБрдЦреНрдп рдЙрджреНрджреЗрд╢реНрдп рд╕реБрд░рдХреНрд╖рд╛ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рд░реЛрдХрдирд╛ рдФрд░ рджреЛрд╖ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ рдХреЛ рд╕реНрд╡рдЪрд╛рд▓рд┐рдд рдХрд░рдирд╛ рд╣реИред

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner рдПрдХ рд╕рд░рд▓ рдЯреВрд▓ рд╣реИ рдЬреЛ Nginx рдХреА рд╕рд╛рдорд╛рдиреНрдп рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдФрд░ рдХрдордЬреЛрд░рд┐рдпреЛрдВ рдХреА рддрд▓рд╛рд╢ рдХрд░рддрд╛ рд╣реИред

## рд╕рдВрджрд░реНрдн

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) рдЬреЛ рдПрдХ рджрд╢рдХ рд╕реЗ рдЕрдзрд┐рдХ рд╕рдордп рд╕реЗ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдФрд░ рдпрд╣ 7 рдФрд░ 8 рд╕рд┐рддрдВрдмрд░ 2023 рдХреЛ рдмреЛрдЧреЛрдЯрд╛, рдХреЛрд▓рдВрдмрд┐рдпрд╛ рдореЗрдВ рдЖрдпреЛрдЬрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдпрд╣ рдПрдХ рдЙрдЪреНрдЪ рддрдХрдиреАрдХреА рд╕рд╛рдордЧреНрд░реА рд╡рд╛рд▓рд╛ рдХрд╛рд░реНрдпрдХреНрд░рдо рд╣реИ рдЬрд╣рд╛рдБ рд╕реНрдкреЗрдирд┐рд╢ рдореЗрдВ рдирд╡реАрдирддрдо рдЕрдиреБрд╕рдВрдзрд╛рди рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдЬреЛ рджреБрдирд┐рдпрд╛ рднрд░ рдХреЗ рд╣реИрдХрд░реНрд╕ рдФрд░ рд╢реЛрдзрдХрд░реНрддрд╛рдУрдВ рдХреЛ рдЖрдХрд░реНрд╖рд┐рдд рдХрд░рддрд╛ рд╣реИред\
рдЕрднреА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд▓рд┐рдВрдХ рдкрд░ рдкрдВрдЬреАрдХрд░рдг рдХрд░реЗрдВ рдФрд░ рдЗрд╕ рдорд╣рд╛рди рд╕рдореНрдореЗрд▓рди рдХреЛ рдорд┐рд╕ рди рдХрд░реЗрдВ!:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВред**
* **HackTricks** рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
