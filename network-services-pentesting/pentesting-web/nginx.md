# Nginx

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta convertirte en un experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

**Configuraci√≥n instant√°nea disponible para evaluaci√≥n de vulnerabilidades y pruebas de penetraci√≥n**. Ejecuta una prueba de penetraci√≥n completa desde cualquier lugar con m√°s de 20 herramientas y funciones que van desde la recolecci√≥n de informaci√≥n hasta la generaci√≥n de informes. No reemplazamos a los pentesters, desarrollamos herramientas personalizadas, m√≥dulos de detecci√≥n y explotaci√≥n para darles m√°s tiempo para profundizar, abrir shells y divertirse.

{% embed url="https://pentest-tools.com/" %}

## Falta la ubicaci√≥n ra√≠z <a href="#missing-root-location" id="missing-root-location"></a>

Al configurar el servidor Nginx, la directiva **root** juega un papel cr√≠tico al definir el directorio base desde el cual se sirven los archivos. Considera el siguiente ejemplo:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
En esta configuraci√≥n, `/etc/nginx` est√° designado como el directorio ra√≠z. Esta configuraci√≥n permite acceder a archivos dentro del directorio ra√≠z especificado, como `/hello.txt`. Sin embargo, es crucial tener en cuenta que solo se define una ubicaci√≥n espec√≠fica (`/hello.txt`). No hay configuraci√≥n para la ubicaci√≥n ra√≠z (`location / {...}`). Esta omisi√≥n significa que la directiva ra√≠z se aplica globalmente, lo que permite que las solicitudes al camino ra√≠z `/` accedan a archivos bajo `/etc/nginx`.

Esta configuraci√≥n plantea una consideraci√≥n de seguridad cr√≠tica. Una simple solicitud `GET`, como `GET /nginx.conf`, podr√≠a exponer informaci√≥n sensible al servir el archivo de configuraci√≥n de Nginx ubicado en `/etc/nginx/nginx.conf`. Establecer la ra√≠z en un directorio menos sensible, como `/etc`, podr√≠a mitigar este riesgo, sin embargo, a√∫n podr√≠a permitir el acceso no deseado a otros archivos cr√≠ticos, incluidos otros archivos de configuraci√≥n, registros de acceso e incluso credenciales cifradas utilizadas para la autenticaci√≥n b√°sica de HTTP.

## Configuraci√≥n Incorrecta de Alias LFI <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

En los archivos de configuraci√≥n de Nginx, se justifica una inspecci√≥n detallada de las directivas "location". Una vulnerabilidad conocida como Inclusi√≥n Local de Archivos (LFI) puede introducirse inadvertidamente a trav√©s de una configuraci√≥n que se asemeje a la siguiente:
```
location /imgs {
alias /path/images/;
}
```
Este tipo de configuraci√≥n es propenso a ataques de LFI debido a que el servidor interpreta solicitudes como `/imgs../flag.txt` como un intento de acceder a archivos fuera del directorio previsto, resolvi√©ndose efectivamente como `/path/images/../flag.txt`. Esta falla permite a los atacantes recuperar archivos del sistema de archivos del servidor que no deber√≠an ser accesibles a trav√©s de la web.

Para mitigar esta vulnerabilidad, la configuraci√≥n deber√≠a ajustarse a:
```
location /imgs/ {
alias /path/images/;
}
```
M√°s informaci√≥n: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Pruebas de Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restricci√≥n de ruta insegura <a href="#uso-de-variable-insegura" id="uso-de-variable-insegura"></a>

Verifica la siguiente p√°gina para aprender c√≥mo evadir directivas como:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Uso inseguro de variables / Divisi√≥n de solicitudes HTTP <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
Las variables vulnerables `$uri` y `$document_uri` deben ser reemplazadas por `$request_uri`.

Una expresi√≥n regular tambi√©n puede ser vulnerable como:

`location ~ /docs/([^/])? { ‚Ä¶ $1 ‚Ä¶ }` - Vulnerable&#x20;

`location ~ /docs/([^/\s])? { ‚Ä¶ $1 ‚Ä¶ }` - No vulnerable (verificando espacios)

`location ~ /docs/(.*)? { ‚Ä¶ $1 ‚Ä¶ }`  - No vulnerable
{% endhint %}

Se demuestra una vulnerabilidad en la configuraci√≥n de Nginx en el siguiente ejemplo:
```
location / {
return 302 https://example.com$uri;
}
```
Los caracteres \r (retorno de carro) y \n (avance de l√≠nea) significan caracteres de nueva l√≠nea en las solicitudes HTTP, y sus formas codificadas en URL se representan como `%0d%0a`. Incluir estos caracteres en una solicitud (por ejemplo, `http://localhost/%0d%0aDetectify:%20clrf`) a un servidor mal configurado resulta en que el servidor emita una nueva cabecera llamada `Detectify`. Esto sucede porque la variable $uri decodifica los caracteres de nueva l√≠nea codificados en URL, lo que lleva a una cabecera inesperada en la respuesta:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Aprende m√°s sobre los riesgos de la inyecci√≥n CRLF y la divisi√≥n de respuestas en [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

Tambi√©n esta t√©cnica est√° [**explicada en esta charla**](https://www.youtube.com/watch?v=gWQyWdZbdoY\&list=PL0xCSYnG\_iTtJe2V6PQqamBF73n7-f1Nr\&index=77) con algunos ejemplos vulnerables y mecanismos de detecci√≥n. Por ejemplo, Para detectar esta mala configuraci√≥n desde una perspectiva de caja negra podr√≠as usar estas peticiones:

* `https://example.com/%20X` - Cualquier c√≥digo HTTP
* `https://example.com/%20H` - 400 Solicitud Incorrecta

Si es vulnerable, la primera devolver√° "X" ya que es cualquier m√©todo HTTP y la segunda devolver√° un error ya que H no es un m√©todo v√°lido. As√≠ que el servidor recibir√° algo como: `GET / H HTTP/1.1` y esto provocar√° el error.

Otros ejemplos de detecci√≥n ser√≠an:

* `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - Cualquier c√≥digo HTTP
* `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 Solicitud Incorrecta

Algunas configuraciones vulnerables encontradas presentadas en esa charla fueron:

* Observa c√≥mo **`$uri`** se establece tal cual en la URL final
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* Observa c√≥mo nuevamente **`$uri`** est√° en la URL (esta vez dentro de un par√°metro)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* Ahora en AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Cualquier variable

Se descubri√≥ que los **datos proporcionados por el usuario** podr√≠an ser tratados como una **variable de Nginx** en ciertas circunstancias. La causa de este comportamiento sigue siendo algo esquiva, sin embargo, no es raro ni sencillo de verificar. Esta anomal√≠a fue resaltada en un informe de seguridad en HackerOne, el cual se puede ver [aqu√≠](https://hackerone.com/reports/370094). Una investigaci√≥n m√°s profunda sobre el mensaje de error llev√≥ a la identificaci√≥n de su ocurrencia dentro del [m√≥dulo de filtro SSI del c√≥digo base de Nginx](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), se√±alando a las Inclusiones del Lado del Servidor (SSI) como la causa ra√≠z.

Para **detectar esta mala configuraci√≥n**, se puede ejecutar el siguiente comando, que implica establecer un encabezado de referencia para probar la impresi√≥n de variables:
```bash
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Escaneos para esta mala configuraci√≥n en varios sistemas revelaron m√∫ltiples instancias donde variables de Nginx pod√≠an ser impresas por un usuario. Sin embargo, una disminuci√≥n en el n√∫mero de instancias vulnerables sugiere que los esfuerzos para parchar este problema han sido algo exitosos.

## Lectura de respuesta bruta del backend

Nginx ofrece una caracter√≠stica a trav√©s de `proxy_pass` que permite la intercepci√≥n de errores y encabezados HTTP producidos por el backend, con el objetivo de ocultar mensajes de error y encabezados internos. Esto se logra mediante Nginx sirviendo p√°ginas de error personalizadas en respuesta a errores del backend. Sin embargo, surgen desaf√≠os cuando Nginx se encuentra con una solicitud HTTP inv√°lida. Tal solicitud se reenv√≠a al backend tal como se recibi√≥, y la respuesta bruta del backend se env√≠a directamente al cliente sin intervenci√≥n de Nginx.

Considere un escenario de ejemplo que involucra una aplicaci√≥n uWSGI:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Para gestionar esto, se utilizan directivas espec√≠ficas en la configuraci√≥n de Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): Esta directiva permite a Nginx servir una respuesta personalizada para respuestas del backend con un c√≥digo de estado mayor a 300. Asegura que, para nuestro ejemplo de aplicaci√≥n uWSGI, una respuesta de `Error 500` sea interceptada y manejada por Nginx.
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): Como su nombre indica, esta directiva oculta encabezados HTTP especificados al cliente, mejorando la privacidad y seguridad.

Cuando se realiza una solicitud `GET` v√°lida, Nginx la procesa normalmente, devolviendo una respuesta de error est√°ndar sin revelar ning√∫n encabezado secreto. Sin embargo, una solicitud HTTP no v√°lida evade este mecanismo, lo que resulta en la exposici√≥n de respuestas del backend en bruto, incluidos encabezados secretos y mensajes de error.

## merge\_slashes establecido en off

Por defecto, la directiva **`merge_slashes` de Nginx** est√° establecida en **`on`**, lo que comprime m√∫ltiples barras inclinadas en una URL en una sola barra inclinada. Esta caracter√≠stica, si bien agiliza el procesamiento de URL, puede ocultar inadvertidamente vulnerabilidades en aplicaciones detr√°s de Nginx, especialmente aquellas propensas a ataques de inclusi√≥n de archivos locales (LFI). Los expertos en seguridad **Danny Robinson y Rotem Bar** han destacado los riesgos potenciales asociados con este comportamiento predeterminado, especialmente cuando Nginx act√∫a como un proxy inverso.

Para mitigar tales riesgos, se recomienda **desactivar la directiva `merge_slashes`** para aplicaciones susceptibles a estas vulnerabilidades. Esto asegura que Nginx reenv√≠e las solicitudes a la aplicaci√≥n sin alterar la estructura de la URL, evitando as√≠ enmascarar problemas de seguridad subyacentes.

Para obtener m√°s informaci√≥n, consulta [Danny Robinson y Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Encabezados de Respuesta Maliciosos**

Como se muestra en [**este art√≠culo**](https://mizu.re/post/cors-playground), hay ciertos encabezados que, si est√°n presentes en la respuesta del servidor web, cambiar√°n el comportamiento del proxy de Nginx. Puedes consultarlos [**en la documentaci√≥n**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/):

* `X-Accel-Redirect`: Indica a Nginx redirigir internamente una solicitud a una ubicaci√≥n especificada.
* `X-Accel-Buffering`: Controla si Nginx debe o no almacenar en b√∫fer la respuesta.
* `X-Accel-Charset`: Establece el conjunto de caracteres para la respuesta al usar X-Accel-Redirect.
* `X-Accel-Expires`: Establece el tiempo de expiraci√≥n para la respuesta al usar X-Accel-Redirect.
* `X-Accel-Limit-Rate`: Limita la velocidad de transferencia para respuestas al usar X-Accel-Redirect.

Por ejemplo, el encabezado **`X-Accel-Redirect`** causar√° una **redirecci√≥n interna** en el nginx. Por lo tanto, tener una configuraci√≥n de nginx con algo como **`root /`** y una respuesta del servidor web con **`X-Accel-Redirect: .env`** har√° que nginx env√≠e el contenido de **`/.env`** (Traversing de Rutas).

### **Valor Predeterminado en la Directiva Map**

En la **configuraci√≥n de Nginx**, la directiva `map` a menudo desempe√±a un papel en el **control de autorizaci√≥n**. Un error com√∫n es no especificar un **valor predeterminado**, lo que podr√≠a resultar en un acceso no autorizado. Por ejemplo:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Sin un `default`, un **usuario malicioso** puede evadir la seguridad accediendo a una **URI no definida** dentro de `/map-poc`. [El manual de Nginx](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) recomienda establecer un **valor predeterminado** para evitar este tipo de problemas.

### **Vulnerabilidad de Suplantaci√≥n de DNS**

La suplantaci√≥n de DNS contra Nginx es factible bajo ciertas condiciones. Si un atacante conoce el **servidor DNS** utilizado por Nginx y puede interceptar sus consultas DNS, puede suplantar registros DNS. Sin embargo, este m√©todo es ineficaz si Nginx est√° configurado para usar **localhost (127.0.0.1)** para la resoluci√≥n de DNS. Nginx permite especificar un servidor DNS de la siguiente manera:
```yaml
resolver 8.8.8.8;
```
### Directivas **`proxy_pass`** e **`internal`**

La directiva **`proxy_pass`** se utiliza para redirigir solicitudes a otros servidores, ya sea interna o externamente. La directiva **`internal`** asegura que ciertas ubicaciones solo sean accesibles dentro de Nginx. Si bien estas directivas no son vulnerabilidades por s√≠ mismas, su configuraci√≥n requiere un examen cuidadoso para evitar brechas de seguridad.

## proxy\_set\_header Upgrade & Connection

Si el servidor nginx est√° configurado para pasar los encabezados Upgrade y Connection, se podr√≠a realizar un [**ataque de Smuggling h2c**](../../pentesting-web/h2c-smuggling.md) para acceder a puntos finales protegidos/internos.

{% hint style="danger" %}
Esta vulnerabilidad permitir√≠a a un atacante **establecer una conexi√≥n directa con el punto final de `proxy_pass`** (`http://backend:9999` en este caso) cuyo contenido no ser√° verificado por nginx.
{% endhint %}

Ejemplo de configuraci√≥n vulnerable para robar `/flag` desde [aqu√≠](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Ten en cuenta que incluso si `proxy_pass` apunta a una **ruta** espec√≠fica como `http://backend:9999/socket.io`, la conexi√≥n se establecer√° con `http://backend:9999`, por lo que puedes **acceder a cualquier otra ruta dentro de ese punto final interno. Por lo tanto, no importa si se especifica una ruta en la URL de proxy\_pass.**
{% endhint %}

## Pru√©balo t√∫ mismo

Detectify ha creado un repositorio en GitHub donde puedes usar Docker para configurar tu propio servidor de prueba vulnerable de Nginx con algunas de las configuraciones incorrectas discutidas en este art√≠culo ¬°y tratar de encontrarlas t√∫ mismo!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Herramientas de an√°lisis est√°tico

### [GIXY](https://github.com/yandex/gixy)

Gixy es una herramienta para analizar la configuraci√≥n de Nginx. El objetivo principal de Gixy es prevenir la configuraci√≥n incorrecta de seguridad y automatizar la detecci√≥n de fallas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner es una herramienta simple para buscar configuraciones incorrectas y vulnerabilidades comunes de Nginx.

## Referencias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (14).png" alt=""><figcaption></figcaption></figure>

**Configuraci√≥n disponible instant√°neamente para evaluaci√≥n de vulnerabilidades y pruebas de penetraci√≥n**. Ejecuta una prueba de penetraci√≥n completa desde cualquier lugar con m√°s de 20 herramientas y funciones que van desde la recolecci√≥n de informaci√≥n hasta la generaci√≥n de informes. No reemplazamos a los pentesters, desarrollamos herramientas personalizadas, m√≥dulos de detecci√≥n y explotaci√≥n para darles m√°s tiempo para profundizar, obtener shells y divertirse.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
