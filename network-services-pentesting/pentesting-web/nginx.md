# Nginx

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o imediatamente dispon√≠vel para avalia√ß√£o de vulnerabilidade & pentesting**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas & recursos que v√£o desde reconhecimento at√© relat√≥rios. N√£o substitu√≠mos pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o & explora√ß√£o para lhes dar mais tempo para investigar mais a fundo, explorar vulnerabilidades e se divertir.

{% embed url="https://pentest-tools.com/" %}

## Localiza√ß√£o da raiz ausente <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
A diretiva `root` especifica a pasta raiz para o Nginx. No exemplo acima, a pasta raiz √© `/etc/nginx`, o que significa que podemos acessar arquivos dentro dessa pasta. A configura√ß√£o acima n√£o possui um local para `/ (location / {...})`, apenas para `/hello.txt`. Por causa disso, a diretiva `root` ser√° definida globalmente, o que significa que solicita√ß√µes para `/` levar√£o voc√™ ao caminho local `/etc/nginx`.

Uma solicita√ß√£o t√£o simples quanto `GET /nginx.conf` revelaria o conte√∫do do arquivo de configura√ß√£o do Nginx armazenado em `/etc/nginx/nginx.conf`. Se o root for definido como `/etc`, uma solicita√ß√£o `GET` para `/nginx/nginx.conf` revelaria o arquivo de configura√ß√£o. Em alguns casos, √© poss√≠vel acessar outros arquivos de configura√ß√£o, logs de acesso e at√© credenciais criptografadas para autentica√ß√£o b√°sica HTTP.

## Configura√ß√£o Incorreta de Alias LFI <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dentro da configura√ß√£o do Nginx, procure pelas declara√ß√µes "location", se alguma parecer com:
```
location /imgs {
alias /path/images/;
}
```
H√° uma vulnerabilidade LFI porque:
```
/imgs../flag.txt
```
Transforma-se em:
```
/path/images/../flag.txt
```
A configura√ß√£o correta ser√°:
```
location /imgs/ {
alias /path/images/;
}
```
**Portanto, se voc√™ encontrar algum servidor Nginx, deve verificar essa vulnerabilidade. Al√©m disso, voc√™ pode descobri-la se perceber que o brute force de arquivos/diret√≥rios est√° se comportando de maneira estranha.**

Mais informa√ß√µes: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Testes da Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restri√ß√£o de caminho inseguro <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Verifique a seguinte p√°gina para aprender como contornar diretivas como:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## Uso inseguro de vari√°veis <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Um exemplo de configura√ß√£o vulner√°vel do Nginx √©:
```
location / {
return 302 https://example.com$uri;
}
```
Os caracteres de nova linha para solicita√ß√µes HTTP s√£o \r (Retorno de Carro) e \n (Alimenta√ß√£o de Linha). A codifica√ß√£o de URL dos caracteres de nova linha resulta na seguinte representa√ß√£o dos caracteres `%0d%0a`. Quando esses caracteres s√£o inclu√≠dos em uma solicita√ß√£o como `http://localhost/%0d%0aDetectify:%20clrf` para um servidor com a m√° configura√ß√£o, o servidor responder√° com um novo cabe√ßalho chamado `Detectify`, uma vez que a vari√°vel $uri cont√©m os caracteres de nova linha decodificados por URL.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saiba mais sobre os riscos de inje√ß√£o CRLF e divis√£o de resposta em [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Qualquer vari√°vel

Em alguns casos, dados fornecidos pelo usu√°rio podem ser tratados como uma vari√°vel do Nginx. N√£o est√° claro por que isso pode acontecer, mas n√£o √© t√£o incomum ou f√°cil de testar, como visto neste [relat√≥rio H1](https://hackerone.com/reports/370094). Se procurarmos pela mensagem de erro, podemos ver que ela √© encontrada no [m√≥dulo de filtro SSI](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365), revelando assim que isso se deve ao SSI.

Uma maneira de testar isso √© definir um valor de cabe√ßalho referer:
```
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Realizamos a varredura para essa m√° configura√ß√£o e encontramos v√°rias inst√¢ncias onde um usu√°rio poderia imprimir o valor das vari√°veis do Nginx. O n√∫mero de inst√¢ncias vulner√°veis encontradas diminuiu, o que pode indicar que isso foi corrigido.

## Leitura da resposta do backend bruta

Com o `proxy_pass` do Nginx, existe a possibilidade de interceptar erros e cabe√ßalhos HTTP criados pelo backend. Isso √© muito √∫til se voc√™ quiser ocultar mensagens de erro internas e cabe√ßalhos para que sejam, em vez disso, tratados pelo Nginx. O Nginx servir√° automaticamente uma p√°gina de erro personalizada se o backend responder com uma. Mas e se o Nginx n√£o entender que √© uma resposta HTTP?

Se um cliente enviar uma solicita√ß√£o HTTP inv√°lida para o Nginx, essa solicita√ß√£o ser√° encaminhada como est√° para o backend, e o backend responder√° com seu conte√∫do bruto. Ent√£o, o Nginx n√£o entender√° a resposta HTTP inv√°lida e simplesmente a encaminhar√° para o cliente. Imagine uma aplica√ß√£o uWSGI assim:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
E com as seguintes diretivas no Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) servir√° uma resposta personalizada se o backend tiver um status de resposta superior a 300. Na nossa aplica√ß√£o uWSGI acima, enviaremos um `Erro 500` que seria interceptado pelo Nginx.

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) √© bastante autoexplicativo; ele ocultar√° qualquer cabe√ßalho HTTP especificado do cliente.

Se enviarmos uma requisi√ß√£o `GET` normal, o Nginx retornar√°:
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
Mas se enviarmos uma solicita√ß√£o HTTP inv√°lida, como:
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
Receberemos a seguinte resposta:
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes definido como off

A diretiva [merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) √© definida como "on" por padr√£o, que √© um mecanismo para comprimir duas ou mais barras para frente em uma, ent√£o `///` se tornaria `/`. Se o Nginx for usado como um proxy reverso e a aplica√ß√£o que est√° sendo proxyada for vulner√°vel a inclus√£o de arquivos locais, usar barras extras na solicita√ß√£o poderia deixar espa√ßo para explor√°-la. Isso √© descrito em detalhes por [Danny Robinson e Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

Encontramos 33 arquivos de configura√ß√£o do Nginx com `merge_slashes` definido como "off".

## default n√£o √© especificado para a diretiva map

Parece ser um caso comum quando **`map` √© usado para algum tipo de controle de autoriza√ß√£o**. Um exemplo simplificado poderia ser:
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[De acordo com o manual](https://nginx.org/en/docs/http/ngx_http_map_module.html):

> valor padr√£o\
> define o valor resultante se o valor de origem n√£o corresponder a nenhuma das variantes especificadas. Quando o padr√£o n√£o √© especificado, o\
> valor resultante padr√£o ser√° uma string vazia.

√â f√°cil esquecer do valor `default`. Assim, **um malfeitor pode contornar esse "controle de autoriza√ß√£o"** simplesmente acessando um **caso inexistente dentro de `/map-poc`** como `https://targethost.com/map-poc/another-private-area`.

## DNS Spoofing Nginx

De acordo com este post: [http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **Pode ser poss√≠vel falsificar registros DNS** para o Nginx se voc√™ **souber o servidor DNS que o Nginx** est√° usando (e voc√™ pode interceptar de alguma forma a comunica√ß√£o, ent√£o isso **n√£o √© v√°lido se 127.0.0.1** for usado) e o **dom√≠nio que est√° sendo solicitado**.

O Nginx pode especificar um servidor DNS para usar com:
```
resolver     8.8.8.8;
```
## Diretivas `proxy_pass` e `internal`

A diretiva **`proxy_pass`** pode ser usada para **redirecionar internamente solicita√ß√µes para outros servidores** internos ou externos.\
A diretiva **`internal`** √© usada para deixar claro para o Nginx que a **localiza√ß√£o s√≥ pode ser acessada internamente**.

O uso dessas diretivas **n√£o √© uma vulnerabilidade, mas voc√™ deve verificar como est√£o configuradas**.

## proxy\_set\_header Upgrade & Connection

Se o servidor nginx estiver configurado para passar os cabe√ßalhos Upgrade e Connection, um ataque de [**h2c Smuggling**](../../pentesting-web/h2c-smuggling.md) poderia ser realizado para acessar endpoints protegidos/internos.

{% hint style="danger" %}
Esta vulnerabilidade permitiria a um atacante **estabelecer uma conex√£o direta com o endpoint `proxy_pass`** (`http://backend:9999` neste caso) cujo conte√∫do n√£o vai ser verificado pelo nginx.
{% endhint %}

Exemplo de configura√ß√£o vulner√°vel para roubar `/flag` de [aqui](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Observe que mesmo se o `proxy_pass` estiver apontando para um **caminho** espec√≠fico como `http://backend:9999/socket.io` a conex√£o ser√° estabelecida com `http://backend:9999` ent√£o voc√™ pode **entrar em contato com qualquer outro caminho dentro desse ponto final interno. Portanto, n√£o importa se um caminho √© especificado na URL do proxy\_pass.**
{% endhint %}

## Tente voc√™ mesmo

A Detectify criou um reposit√≥rio no GitHub onde voc√™ pode usar o Docker para configurar seu pr√≥prio servidor de teste Nginx vulner√°vel com algumas das m√°s configura√ß√µes discutidas neste artigo e tentar encontr√°-las voc√™ mesmo!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Ferramentas de An√°lise Est√°tica

### [GIXY](https://github.com/yandex/gixy)

Gixy √© uma ferramenta para analisar a configura√ß√£o do Nginx. O principal objetivo do Gixy √© prevenir m√°s configura√ß√µes de seguran√ßa e automatizar a detec√ß√£o de falhas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner √© uma ferramenta simples para procurar m√°s configura√ß√µes e vulnerabilidades comuns do Nginx.

## Refer√™ncias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configura√ß√£o imediatamente dispon√≠vel para avalia√ß√£o de vulnerabilidade e pentesting**. Execute um pentest completo de qualquer lugar com mais de 20 ferramentas e recursos que v√£o desde reconhecimento at√© relat√≥rios. N√£o substitu√≠mos pentesters - desenvolvemos ferramentas personalizadas, m√≥dulos de detec√ß√£o e explora√ß√£o para lhes dar mais tempo para investigar mais a fundo, explorar sistemas e se divertir.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
