# Nginx

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configurazione istantaneamente disponibile per la valutazione delle vulnerabilit√† e il penetration testing**. Esegui un pentest completo da qualsiasi luogo con oltre 20 strumenti e funzionalit√† che vanno dalla ricognizione alla generazione di report. Non sostituiamo i pentester - sviluppiamo strumenti personalizzati, moduli di rilevamento ed exploit per restituire loro del tempo per approfondire, ottenere shell e divertirsi.

{% embed url="https://pentest-tools.com/" %}

## Missing root location <a href="#missing-root-location" id="missing-root-location"></a>

## **Essenziali per la configurazione della directory radice di Nginx**

Nella configurazione del server Nginx, la **direttiva root** svolge un ruolo critico definendo la directory di base da cui vengono serviti i file. Considera l'esempio seguente:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
In questa configurazione, `/etc/nginx` √® designato come directory principale. Questa impostazione consente l'accesso ai file all'interno della directory principale specificata, come `/hello.txt`. Tuttavia, √® importante notare che √® definita solo una posizione specifica (`/hello.txt`). Non √® presente una configurazione per la posizione principale (`location / {...}`). Questa omissione significa che la direttiva principale si applica globalmente, consentendo alle richieste del percorso principale `/` di accedere ai file sotto `/etc/nginx`.

Da questa configurazione deriva una considerazione critica per la sicurezza. Una semplice richiesta `GET`, come `GET /nginx.conf`, potrebbe esporre informazioni sensibili servendo il file di configurazione di Nginx situato in `/etc/nginx/nginx.conf`. Impostare la directory principale su una directory meno sensibile, come `/etc`, potrebbe mitigare questo rischio, ma potrebbe comunque consentire l'accesso non intenzionale ad altri file critici, inclusi altri file di configurazione, registri di accesso e persino credenziali crittografate utilizzate per l'autenticazione di base HTTP.

## Configurazione errata di Alias LFI <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nei file di configurazione di Nginx, √® necessaria un'attenta ispezione delle direttive "location". Una vulnerabilit√† nota come Local File Inclusion (LFI) pu√≤ essere introdotta involontariamente attraverso una configurazione simile a quella seguente:
```
location /imgs {
alias /path/images/;
}
```
Questa configurazione √® vulnerabile agli attacchi LFI a causa del server che interpreta le richieste come `/imgs../flag.txt` come un tentativo di accedere a file al di fuori della directory prevista, risolvendo effettivamente in `/percorso/immagini/../flag.txt`. Questa falla consente agli attaccanti di recuperare file dal filesystem del server che non dovrebbero essere accessibili tramite il web.

Per mitigare questa vulnerabilit√†, la configurazione dovrebbe essere regolata come segue:
```
location /imgs/ {
alias /path/images/;
}
```
Ulteriori informazioni: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Test di Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restrizione insicura del percorso <a href="#uso-variabile-insicuro" id="uso-variabile-insicuro"></a>

Controlla la seguente pagina per imparare come bypassare le direttive come:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Utilizzo non sicuro di variabili <a href="#utilizzo-non-sicuro-di-variabili" id="utilizzo-non-sicuro-di-variabili"></a>

Una vulnerabilit√† nella configurazione di Nginx √® dimostrata dall'esempio seguente:
```
location / {
return 302 https://example.com$uri;
}
```
I caratteri \r (Carriage Return) e \n (Line Feed) indicano i caratteri di nuova riga nelle richieste HTTP e le loro forme URL-encoded sono rappresentate come `%0d%0a`. Includere questi caratteri in una richiesta (ad esempio, `http://localhost/%0d%0aDetectify:%20clrf`) a un server mal configurato porta il server a emettere un nuovo header chiamato `Detectify`. Questo accade perch√© la variabile $uri decodifica i caratteri di nuova riga URL-encoded, portando a un header inaspettato nella risposta:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Per saperne di pi√π sui rischi dell'iniezione di CRLF e della divisione delle risposte, visita [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Qualsiasi variabile

√à stato scoperto che i dati forniti dall'utente potrebbero essere trattati come una variabile Nginx in determinate circostanze. La causa di questo comportamento rimane in parte sfuggente, ma non √® rara n√© semplice da verificare. Questa anomalia √® stata evidenziata in un rapporto di sicurezza su HackerOne, che puoi visualizzare [qui](https://hackerone.com/reports/370094). Ulteriori indagini sul messaggio di errore hanno portato all'identificazione della sua presenza nel [modulo del filtro SSI del codice di Nginx](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365), individuando gli Include lato server (SSI) come causa principale.

Per **rilevare questa errata configurazione**, √® possibile eseguire il seguente comando, che implica l'impostazione di un header referer per testare la stampa delle variabili:
```bash
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Scansioni per questa configurazione errata su vari sistemi hanno rivelato molteplici istanze in cui le variabili di Nginx potevano essere stampate da un utente. Tuttavia, una diminuzione del numero di istanze vulnerabili suggerisce che gli sforzi per correggere questo problema siano stati in parte efficaci.

## Lettura delle risposte backend grezze


Nginx offre una funzionalit√† tramite `proxy_pass` che consente l'intercettazione degli errori e degli header HTTP prodotti dal backend, al fine di nascondere i messaggi di errore e gli header interni. Ci√≤ viene realizzato da Nginx servendo pagine di errore personalizzate in risposta agli errori del backend. Tuttavia, si presentano delle sfide quando Nginx incontra una richiesta HTTP non valida. Tale richiesta viene inoltrata al backend cos√¨ come ricevuta e la risposta grezza del backend viene quindi inviata direttamente al client senza l'intervento di Nginx.

Considera uno scenario di esempio che coinvolge un'applicazione uWSGI:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Per gestire ci√≤, vengono utilizzate direttive specifiche nella configurazione di Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
- **[proxy_intercept_errors](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_intercept_errors)**: Questa direttiva abilita Nginx a restituire una risposta personalizzata per le risposte del backend con un codice di stato superiore a 300. Assicura che, per il nostro esempio di applicazione uWSGI, una risposta di errore `500` venga intercettata e gestita da Nginx.
- **[proxy_hide_header](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header)**: Come suggerisce il nome, questa direttiva nasconde gli header HTTP specificati dal client, migliorando la privacy e la sicurezza.

Quando viene effettuata una richiesta `GET` valida, Nginx la elabora normalmente, restituendo una risposta di errore standard senza rivelare alcun header segreto. Tuttavia, una richiesta HTTP non valida bypassa questo meccanismo, risultando nell'esposizione delle risposte del backend, inclusi gli header segreti e i messaggi di errore.


## merge\_slashes impostato su off

Per impostazione predefinita, la direttiva **`merge_slashes`** di Nginx √® impostata su **`on`**, il che comprime pi√π barre oblique in un URL in una singola barra. Questa funzionalit√†, pur semplificando l'elaborazione degli URL, pu√≤ involontariamente nascondere vulnerabilit√† nelle applicazioni dietro Nginx, in particolare quelle soggette a attacchi di inclusione di file locali (LFI). Gli esperti di sicurezza **Danny Robinson e Rotem Bar** hanno evidenziato i potenziali rischi associati a questo comportamento predefinito, specialmente quando Nginx agisce come reverse-proxy.

Per mitigare tali rischi, si consiglia di **disabilitare la direttiva `merge_slashes`** per le applicazioni suscettibili a queste vulnerabilit√†. Ci√≤ assicura che Nginx inoltri le richieste all'applicazione senza modificare la struttura dell'URL, non mascherando eventuali problemi di sicurezza sottostanti.

Per ulteriori informazioni, consulta [Danny Robinson e Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Valore predefinito nella direttiva Map**

Nella **configurazione di Nginx**, la direttiva `map` spesso svolge un ruolo nel **controllo delle autorizzazioni**. Un errore comune √® non specificare un valore **predefinito**, il che potrebbe portare a un accesso non autorizzato. Ad esempio:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Senza un `default`, un **utente malintenzionato** pu√≤ aggirare la sicurezza accedendo a un **URI non definito** all'interno di `/map-poc`. [Il manuale di Nginx](https://nginx.org/en/docs/http/ngx_http_map_module.html) consiglia di impostare un **valore predefinito** per evitare tali problemi.

### **Vulnerabilit√† di DNS Spoofing**

Lo spoofing DNS su Nginx √® fattibile in determinate condizioni. Se un attaccante conosce il **server DNS** utilizzato da Nginx e pu√≤ intercettare le sue richieste DNS, pu√≤ falsificare i record DNS. Tuttavia, questo metodo non √® efficace se Nginx √® configurato per utilizzare **localhost (127.0.0.1)** per la risoluzione DNS. Nginx consente di specificare un server DNS nel seguente modo:
```yaml
resolver 8.8.8.8;
```
### **Direttive `proxy_pass` e `internal`**

La direttiva **`proxy_pass`** viene utilizzata per reindirizzare le richieste verso altri server, sia internamente che esternamente. La direttiva **`internal`** garantisce che determinate posizioni siano accessibili solo all'interno di Nginx. Sebbene queste direttive non siano vulnerabilit√† di per s√©, la loro configurazione richiede un'attenta esame per evitare falle di sicurezza.

## proxy\_set\_header Upgrade & Connection

Se il server nginx √® configurato per passare gli header Upgrade e Connection, potrebbe essere possibile eseguire un [**attacco di smuggling h2c**](../../pentesting-web/h2c-smuggling.md) per accedere a endpoint protetti/interni.

{% hint style="danger" %}
Questa vulnerabilit√† consentirebbe a un attaccante di **stabilire una connessione diretta con l'endpoint `proxy_pass`** (`http://backend:9999` in questo caso) il cui contenuto non verr√† controllato da nginx.
{% endhint %}

Esempio di configurazione vulnerabile per rubare `/flag` da [qui](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Nota che anche se `proxy_pass` puntava a un **percorso** specifico come `http://backend:9999/socket.io`, la connessione verr√† stabilita con `http://backend:9999`, quindi √® possibile **contattare qualsiasi altro percorso all'interno di quel endpoint interno. Quindi non importa se viene specificato un percorso nell'URL di proxy\_pass.**
{% endhint %}

## Provalo tu stesso

Detectify ha creato un repository GitHub in cui puoi utilizzare Docker per configurare il tuo server di test Nginx vulnerabile con alcune delle configurazioni errate discusse in questo articolo e provare a trovarle tu stesso!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Strumenti di analisi statica

### [GIXY](https://github.com/yandex/gixy)

Gixy √® uno strumento per analizzare la configurazione di Nginx. L'obiettivo principale di Gixy √® prevenire errori di configurazione della sicurezza e automatizzare la rilevazione delle vulnerabilit√†.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner √® uno strumento semplice per cercare configurazioni errate comuni e vulnerabilit√† di Nginx.

## Riferimenti

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Configurazione immediatamente disponibile per valutazione delle vulnerabilit√† e penetration testing**. Esegui un pentest completo da qualsiasi luogo con oltre 20 strumenti e funzionalit√† che vanno dalla ricognizione alla generazione di report. Non sostituiamo i pentester, sviluppiamo strumenti personalizzati, moduli di rilevamento ed exploit per permettere loro di dedicarsi a indagini pi√π approfondite, ottenere accesso shell e divertirsi.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository GitHub di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
