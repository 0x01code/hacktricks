# Nginx

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) avec plus d'une d√©cennie d'existence qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique de haut niveau o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence !:

{% embed url="https://www.dragonjarcon.org/" %}

## Emplacement racine manquant <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
        root /etc/nginx;

        location /hello.txt {
                try_files $uri $uri/ =404;
                proxy_pass http://127.0.0.1:8080/;
        }
}
```
La directive racine sp√©cifie le dossier racine pour Nginx. Dans l'exemple ci-dessus, le dossier racine est `/etc/nginx`, ce qui signifie que nous pouvons acc√©der aux fichiers dans ce dossier. La configuration ci-dessus n'a pas d'emplacement pour `/ (location / {...})`, seulement pour `/hello.txt`. En raison de cela, la directive `root` sera d√©finie globalement, ce qui signifie que les demandes √† `/` vous am√®neront au chemin local `/etc/nginx`.

Une demande aussi simple que `GET /nginx.conf` r√©v√©lerait le contenu du fichier de configuration Nginx stock√© dans `/etc/nginx/nginx.conf`. Si la racine est d√©finie sur `/etc`, une demande `GET` √† `/nginx/nginx.conf` r√©v√©lerait le fichier de configuration. Dans certains cas, il est possible d'acc√©der √† d'autres fichiers de configuration, journaux d'acc√®s et m√™me √† des informations d'identification chiffr√©es pour l'authentification de base HTTP.

## Mauvaise configuration LFI d'alias <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dans la configuration Nginx, recherchez les d√©clarations "location", si l'une d'entre elles ressemble √†:
```
location /imgs { 
    alias /path/images/;
}
```
Il y a une vuln√©rabilit√© LFI car:
```
/imgs../flag.txt
```
Le contenu suivant provient d'un livre de piratage sur les techniques de piratage de cloud, de plateformes SaaS, de CI/CD... Le contenu suivant provient du fichier /hive/hacktricks/network-services-pentesting/pentesting-web/nginx.md. Traduisez le texte anglais pertinent en fran√ßais et renvoyez la traduction en conservant la syntaxe markdown. Ne traduisez pas les choses comme le code, les noms de techniques de piratage, les noms de plateformes cloud/SaaS (comme Workspace, aws, gcp...), le mot 'leak' et les balises markdown. N'ajoutez √©galement aucun √©l√©ment suppl√©mentaire en dehors de la traduction et de la syntaxe markdown.
```
/path/images/../flag.txt
```
La configuration correcte sera :
```
location /imgs/ { 
    alias /path/images/;
}
```
Donc, si vous trouvez un serveur Nginx, vous devriez v√©rifier cette vuln√©rabilit√©. De plus, vous pouvez la d√©couvrir si vous constatez que la force brute des fichiers/r√©pertoires se comporte de mani√®re √©trange.

Plus d'informations: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Tests Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Utilisation non s√©curis√©e de variables <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Un exemple de configuration Nginx vuln√©rable est :
```
location / {
  return 302 https://example.com$uri;
}
```
Les caract√®res de nouvelle ligne pour les requ√™tes HTTP sont \r (Retour chariot) et \n (Saut de ligne). L'encodage d'URL des caract√®res de nouvelle ligne donne la repr√©sentation suivante des caract√®res `%0d%0a`. Lorsque ces caract√®res sont inclus dans une requ√™te telle que `http://localhost/%0d%0aDetectify:%20clrf` √† un serveur avec une mauvaise configuration, le serveur r√©pondra avec un nouvel en-t√™te nomm√© `Detectify` car la variable $uri contient les caract√®res de nouvelle ligne d√©cod√©s de l'URL.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
En savoir plus sur les risques d'injection CRLF et de fractionnement de r√©ponse sur [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### N'importe quelle variable

Dans certains cas, les donn√©es fournies par l'utilisateur peuvent √™tre trait√©es comme une variable Nginx. Il n'est pas clair pourquoi cela peut se produire, mais ce n'est pas si rare ou facile √† tester comme on peut le voir dans ce [rapport H1](https://hackerone.com/reports/370094). Si nous recherchons le message d'erreur, nous pouvons voir qu'il se trouve dans le module de filtre SSI, r√©v√©lant ainsi que cela est d√ª √† SSI.

Une fa√ßon de tester cela est de d√©finir une valeur d'en-t√™te referer :
```
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Nous avons scann√© cette mauvaise configuration et avons trouv√© plusieurs instances o√π un utilisateur pouvait imprimer la valeur des variables Nginx. Le nombre d'instances vuln√©rables trouv√©es a diminu√©, ce qui pourrait indiquer que cela a √©t√© corrig√©.

## Lecture brute de la r√©ponse du backend

Avec `proxy_pass` de Nginx, il est possible d'intercepter les erreurs et les en-t√™tes HTTP cr√©√©s par le backend. Cela est tr√®s utile si vous voulez masquer les messages d'erreur et les en-t√™tes internes afin qu'ils soient g√©r√©s par Nginx. Nginx servira automatiquement une page d'erreur personnalis√©e si le backend r√©pond avec une telle page. Mais que se passe-t-il si Nginx ne comprend pas qu'il s'agit d'une r√©ponse HTTP ?

Si un client envoie une requ√™te HTTP invalide √† Nginx, cette requ√™te sera transmise telle quelle au backend, et le backend r√©pondra avec son contenu brut. Ensuite, Nginx ne comprendra pas la r√©ponse HTTP invalide et la transmettra simplement au client. Imaginez une application uWSGI comme celle-ci :
```python
def application(environ, start_response):
   start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
   return [b"Secret info, should not be visible!"]
```
Et avec les directives suivantes dans Nginx :
```
http {
   error_page 500 /html/error.html;
   proxy_intercept_errors on;
   proxy_hide_header Secret-Header;
}
```
`proxy_intercept_errors` servira une r√©ponse personnalis√©e si le backend a une r√©ponse avec un statut sup√©rieur √† 300. Dans notre application uWSGI ci-dessus, nous enverrons une `Erreur 500` qui sera intercept√©e par Nginx.

`proxy_hide_header` est assez explicite; il masquera tout en-t√™te HTTP sp√©cifi√© du client.

Si nous envoyons une requ√™te `GET` normale, Nginx renverra:
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
Mais si nous envoyons une requ√™te HTTP invalide, telle que :
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
Nous obtiendrons la r√©ponse suivante :
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes d√©fini sur off

La directive [merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) est d√©finie par d√©faut sur "on", ce qui est un m√©canisme pour compresser deux ou plusieurs barres obliques en une seule, donc `///` deviendrait `/`. Si Nginx est utilis√© en tant que reverse-proxy et que l'application qui est proxifi√©e est vuln√©rable √† une inclusion de fichier local, l'utilisation de barres obliques suppl√©mentaires dans la requ√™te pourrait laisser place √† une exploitation. Cela est d√©crit en d√©tail par [Danny Robinson et Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

Nous avons trouv√© 33 fichiers de configuration Nginx avec `merge_slashes` d√©fini sur "off".

## default n'est pas sp√©cifi√© pour la directive map

Il semble que le cas commun lorsque **`map` est utilis√© pour un certain type de contr√¥le d'autorisation**. Un exemple simplifi√© pourrait ressembler √†:
```
http {
...
    map $uri $mappocallow {
        /map-poc/private 0;
        /map-poc/secret 0;
        /map-poc/public 1;
    }
...
}
```

```
server {
...
    location /map-poc {
        if ($mappocallow = 0) {return 403;}
        return 200 "Hello. It is private area: $mappocallow";
    }
...
}
```
[D'apr√®s le manuel](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html):

> Valeur par d√©faut\
> d√©finit la valeur r√©sultante si la valeur source ne correspond √† aucune des variantes sp√©cifi√©es. Lorsque la valeur par d√©faut n'est pas sp√©cifi√©e, la valeur r√©sultante par d√©faut sera une cha√Æne vide.

Il est facile d'oublier la valeur `default`. Ainsi, **un malfaiteur peut contourner ce "contr√¥le d'autorisation"** en acc√©dant simplement √† un **cas inexistant √† l'int√©rieur de `/map-poc`** comme `https://targethost.com/map-poc/another-private-area`.

## Spoofing DNS Nginx

Selon cet article: [http://blog.zorinaq.com/nginx-resol**ver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/) **Il pourrait √™tre possible de falsifier les enregistrements DNS** pour Nginx si vous **connaissez le serveur DNS que Nginx** utilise (et vous pouvez intercepter la communication d'une mani√®re ou d'une autre, donc cela **n'est pas valable si 127.0.0.1** est utilis√©) et le **domaine qu'il demande**.

Nginx peut sp√©cifier un serveur DNS √† utiliser avec:
```
resolver     8.8.8.8;
```
## Directives `proxy_pass` et `internal`

La directive **`proxy_pass`** peut √™tre utilis√©e pour **rediriger les requ√™tes internes vers d'autres serveurs** internes ou externes.\
La directive **`internal`** est utilis√©e pour indiquer √† Nginx que **l'emplacement ne peut √™tre acc√©d√© qu'en interne**.

L'utilisation de ces directives **n'est pas une vuln√©rabilit√©, mais vous devriez v√©rifier comment elles sont configur√©es**.

## proxy\_set\_header Upgrade & Connection

Si le serveur nginx est configur√© pour passer les en-t√™tes Upgrade et Connection, une [**attaque d'h2c Smuggling**](../../pentesting-web/h2c-smuggling.md) pourrait √™tre effectu√©e pour acc√©der √† des points de terminaison prot√©g√©s/internes.

{% hint style="danger" %}
Cette vuln√©rabilit√© permettrait √† un attaquant d'**√©tablir une connexion directe avec le point de terminaison `proxy_pass`** (`http://backend:9999` dans ce cas) dont le contenu ne sera pas v√©rifi√© par nginx.
{% endhint %}

Exemple de configuration vuln√©rable pour voler `/flag` √† partir de [ici](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
    listen       443 ssl;
    server_name  localhost;

    ssl_certificate       /usr/local/nginx/conf/cert.pem;
    ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

    location / {
     proxy_pass http://backend:9999;
     proxy_http_version 1.1;
     proxy_set_header Upgrade $http_upgrade;
     proxy_set_header Connection $http_connection;
    }

    location /flag {
     deny all;
    }
```
{% hint style="warning" %}
Notez que m√™me si `proxy_pass` pointait vers un **chemin** sp√©cifique tel que `http://backend:9999/socket.io`, la connexion sera √©tablie avec `http://backend:9999`, vous pouvez donc **contacter tout autre chemin √† l'int√©rieur de ce point de terminaison interne. Il n'est donc pas important qu'un chemin soit sp√©cifi√© dans l'URL de proxy\_pass.**
{% endhint %}

## Essayez par vous-m√™me

Detectify a cr√©√© un r√©f√©rentiel GitHub o√π vous pouvez utiliser Docker pour configurer votre propre serveur de test Nginx vuln√©rable avec certaines des mauvaises configurations discut√©es dans cet article et essayer de les trouver vous-m√™me!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Outils d'analyse statique

### [GIXY](https://github.com/yandex/gixy)

Gixy est un outil d'analyse de configuration Nginx. L'objectif principal de Gixy est de pr√©venir les mauvaises configurations de s√©curit√© et d'automatiser la d√©tection des failles.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner est un outil simple pour rechercher les mauvaises configurations et les vuln√©rabilit√©s courantes de Nginx.

## R√©f√©rences

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) avec plus d'une d√©cennie qui se tiendra les 7 et 8 septembre 2023 √† Bogot√°, en Colombie. C'est un √©v√©nement de contenu technique √©lev√© o√π les derni√®res recherches en espagnol sont pr√©sent√©es, attirant des hackers et des chercheurs du monde entier.\
Inscrivez-vous d√®s maintenant sur le lien suivant et ne manquez pas cette grande conf√©rence!:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
