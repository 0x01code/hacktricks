# Nginx

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm).
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference est un √©v√©nement international de cybers√©curit√©**](https://www.dragonjarcon.org/) qui a plus d'une d√©cennie d'existence et se tiendra les 7 et 8 septembre 2023 √† Bogot√°, Colombie. C'est un √©v√©nement au contenu technique √©lev√© o√π sont pr√©sent√©es les derni√®res recherches en espagnol, attirant des hackers et des chercheurs du monde entier.
Inscrivez-vous maintenant au lien suivant et ne manquez pas cette grande conf√©rence ! :

{% embed url="https://www.dragonjarcon.org/" %}

## Emplacement racine manquant <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
La directive `root` sp√©cifie le dossier racine pour Nginx. Dans l'exemple ci-dessus, le dossier racine est `/etc/nginx`, ce qui signifie que nous pouvons acc√©der aux fichiers √† l'int√©rieur de ce dossier. La configuration ci-dessus n'a pas de location pour `/ (location / {...})`, seulement pour `/hello.txt`. De ce fait, la directive `root` sera d√©finie globalement, ce qui signifie que les requ√™tes vers `/` vous am√®neront au chemin local `/etc/nginx`.

Une requ√™te aussi simple que `GET /nginx.conf` r√©v√©lerait le contenu du fichier de configuration Nginx stock√© dans `/etc/nginx/nginx.conf`. Si le root est d√©fini sur `/etc`, une requ√™te `GET` vers `/nginx/nginx.conf` r√©v√©lerait le fichier de configuration. Dans certains cas, il est possible d'acc√©der √† d'autres fichiers de configuration, des journaux d'acc√®s et m√™me des identifiants chiffr√©s pour l'authentification HTTP de base.

## Mauvaise configuration LFI Alias <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dans la configuration Nginx, regardez les instructions "location", si l'une d'elles ressemble √† :
```
location /imgs {
alias /path/images/;
}
```
Il y a une vuln√©rabilit√© LFI car :
```
/imgs../flag.txt
```
```markdown
# Test d'intrusion de Nginx

Nginx est un serveur web haute performance, √©quilibrage de charge et proxy inverse. Comme avec tout service expos√© sur Internet, il est crucial de le s√©curiser. Voici quelques techniques de test d'intrusion sp√©cifiques √† Nginx.

## Fuites d'informations

### Version du serveur

Il est important de ne pas afficher la version de Nginx car cela peut aider un attaquant √† identifier les vuln√©rabilit√©s sp√©cifiques. Pour v√©rifier si la version du serveur est expos√©e:

```bash
curl -I http://example.com
```

La r√©ponse ne doit pas contenir la version de Nginx.

### Fichiers de configuration

Les fichiers de configuration de Nginx ne doivent jamais √™tre accessibles publiquement. Ils peuvent contenir des informations sensibles telles que des emplacements de proxy ou des r√®gles de r√©√©criture. Pour tester l'acc√®s aux fichiers de configuration:

```bash
curl http://example.com/nginx.conf
curl http://example.com/.htpasswd
```

Ces requ√™tes ne devraient pas retourner de contenu sensible.

## Mauvaise configuration

### Listing de r√©pertoires

Le listing de r√©pertoires peut √™tre activ√© par erreur, permettant √† un attaquant de voir tous les fichiers dans un r√©pertoire. Pour le tester:

```bash
curl http://example.com/directory/
```

Cette requ√™te ne devrait pas lister les fichiers du r√©pertoire.

### Ex√©cution de code

Si Nginx est mal configur√©, il peut permettre l'ex√©cution de code sur le serveur. Pour tester cela, on peut essayer d'acc√©der √† des scripts connus pour √™tre mal configur√©s:

```bash
curl http://example.com/test.php
```

La requ√™te ne devrait pas ex√©cuter le script PHP.

## S√©curit√© des headers

Les headers HTTP peuvent √™tre configur√©s pour am√©liorer la s√©curit√©. Les headers suivants devraient √™tre pr√©sents:

- `X-Frame-Options`: emp√™che le clickjacking.
- `X-Content-Type-Options`: emp√™che le navigateur d'interpr√©ter les fichiers de mani√®re incorrecte.
- `X-XSS-Protection`: active la protection contre les attaques XSS dans les navigateurs plus anciens.
- `Content-Security-Policy`: limite les ressources que le navigateur est autoris√© √† charger.

Pour v√©rifier la pr√©sence de ces headers:

```bash
curl -I http://example.com
```

## Conclusion

Tester la configuration de Nginx et s'assurer qu'elle est s√©curis√©e est essentiel pour prot√©ger les applications web. En suivant ces √©tapes, on peut identifier et corriger les probl√®mes de s√©curit√© courants.
```
```
/path/images/../flag.txt
```
La configuration correcte sera :
```
location /imgs/ {
alias /path/images/;
}
```
**Ainsi, si vous trouvez un serveur Nginx, vous devriez v√©rifier cette vuln√©rabilit√©. Vous pouvez √©galement la d√©couvrir si vous constatez que le brute force de fichiers/r√©pertoires se comporte de mani√®re √©trange.**

Plus d'infos : [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Tests Accunetix :
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restriction de chemin non s√©curis√©e <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Consultez la page suivante pour apprendre √† contourner des directives telles que :
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
```markdown
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## Utilisation de variables non s√©curis√©es <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Un exemple de configuration Nginx vuln√©rable est :
```
```
location / {
return 302 https://example.com$uri;
}
```
Les caract√®res de nouvelle ligne pour les requ√™tes HTTP sont \r (Retour chariot) et \n (Saut de ligne). L'encodage en pourcentage des caract√®res de nouvelle ligne donne la repr√©sentation suivante des caract√®res `%0d%0a`. Lorsque ces caract√®res sont inclus dans une requ√™te comme `http://localhost/%0d%0aDetectify:%20clrf` √† un serveur avec la mauvaise configuration, le serveur r√©pondra avec un nouvel en-t√™te nomm√© `Detectify` puisque la variable $uri contient les caract√®res de nouvelle ligne d√©cod√©s par URL.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Apprenez-en plus sur les risques de l'injection CRLF et du fractionnement de r√©ponse √† [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### N'importe quelle variable

Dans certains cas, les donn√©es fournies par l'utilisateur peuvent √™tre trait√©es comme une variable Nginx. Il n'est pas clair pourquoi cela peut se produire, mais ce n'est pas si rare ni facile √† tester comme on peut le voir dans ce [rapport H1](https://hackerone.com/reports/370094). Si nous recherchons le message d'erreur, nous pouvons voir qu'il se trouve dans le [module de filtre SSI](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365), r√©v√©lant ainsi que cela est d√ª au SSI.

Une fa√ßon de tester cela est de d√©finir une valeur d'en-t√™te referer :
```
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Nous avons scann√© cette mauvaise configuration et trouv√© plusieurs instances o√π un utilisateur pouvait imprimer la valeur des variables Nginx. Le nombre d'instances vuln√©rables trouv√©es a diminu√©, ce qui pourrait indiquer que cela a √©t√© corrig√©.

## Lecture de la r√©ponse brute du backend

Avec `proxy_pass` de Nginx, il est possible d'intercepter les erreurs et les en-t√™tes HTTP cr√©√©s par le backend. C'est tr√®s utile si vous souhaitez masquer les messages d'erreur internes et les en-t√™tes pour qu'ils soient plut√¥t g√©r√©s par Nginx. Nginx servira automatiquement une page d'erreur personnalis√©e si le backend r√©pond avec une. Mais que se passe-t-il si Nginx ne comprend pas qu'il s'agit d'une r√©ponse HTTP ?

Si un client envoie une requ√™te HTTP invalide √† Nginx, cette requ√™te sera transmise telle quelle au backend, et le backend r√©pondra avec son contenu brut. Ensuite, Nginx ne comprendra pas la r√©ponse HTTP invalide et la transmettra simplement au client. Imaginez une application uWSGI comme celle-ci :
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
Et avec les directives suivantes dans Nginx :
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) servira une r√©ponse personnalis√©e si le backend a un statut de r√©ponse sup√©rieur √† 300. Dans notre application uWSGI ci-dessus, nous enverrons une `500 Error` qui serait intercept√©e par Nginx.

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) est assez explicite ; il cachera tout en-t√™te HTTP sp√©cifi√© du client.

Si nous envoyons une requ√™te `GET` normale, Nginx retournera :
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
Mais si nous envoyons une requ√™te HTTP invalide, telle que :
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
Nous obtiendrons la r√©ponse suivante :
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes d√©fini sur off

La directive [merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) est d√©finie par d√©faut sur ‚Äúon‚Äù, ce qui est un m√©canisme pour compresser deux barres obliques ou plus en une seule, donc `///` deviendrait `/`. Si Nginx est utilis√© comme un reverse-proxy et que l'application qui est proxifi√©e est vuln√©rable √† l'inclusion de fichiers locaux, l'utilisation de barres obliques suppl√©mentaires dans la requ√™te pourrait laisser de la place pour l'exploiter. Ceci est d√©crit en d√©tail par [Danny Robinson et Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

Nous avons trouv√© 33 fichiers de configuration Nginx avec `merge_slashes` d√©fini sur ‚Äúoff‚Äù.

## default n'est pas sp√©cifi√© pour la directive map

Il semble que ce soit un cas courant lorsque **`map` est utilis√© pour un certain type de contr√¥le d'autorisation**. Un exemple simplifi√© pourrait ressembler √† :
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[Selon le manuel](https://nginx.org/en/docs/http/ngx_http_map_module.html) :

> valeur par d√©faut\
> d√©finit la valeur r√©sultante si la valeur source ne correspond √† aucune des variantes sp√©cifi√©es. Lorsque la valeur par d√©faut n'est pas sp√©cifi√©e, la\
> valeur r√©sultante par d√©faut sera une cha√Æne vide.

Il est facile d'oublier la valeur `default`. Ainsi, **un malveillant peut contourner ce "contr√¥le d'autorisation"** en acc√©dant simplement √† un **cas inexistant √† l'int√©rieur de `/map-poc`** comme `https://targethost.com/map-poc/another-private-area`.

## DNS Spoofing Nginx

Selon cet article : [http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **Il pourrait √™tre possible de falsifier les enregistrements DNS** pour Nginx si vous **connaissez le serveur DNS que Nginx** utilise (et que vous pouvez intercepter la communication d'une mani√®re ou d'une autre, donc cela n'est **pas valable si 127.0.0.1** est utilis√©) et le **domaine qu'il demande**.

Nginx peut sp√©cifier un serveur DNS √† utiliser avec :
```
resolver     8.8.8.8;
```
## Directives `proxy_pass` et `internal`

La directive **`proxy_pass`** peut √™tre utilis√©e pour **rediriger en interne les requ√™tes vers d'autres serveurs**, internes ou externes.\
La directive **`internal`** est utilis√©e pour indiquer √† Nginx que **l'emplacement ne peut √™tre acc√©d√© qu'en interne**.

L'utilisation de ces directives **n'est pas une vuln√©rabilit√©, mais vous devriez v√©rifier comment elles sont configur√©es**.

## proxy\_set\_header Upgrade & Connection

Si le serveur nginx est configur√© pour passer les en-t√™tes Upgrade et Connection, une [**attaque par Smuggling h2c**](../../pentesting-web/h2c-smuggling.md) pourrait √™tre r√©alis√©e pour acc√©der √† des points de terminaison prot√©g√©s/internes.

{% hint style="danger" %}
Cette vuln√©rabilit√© permettrait √† un attaquant d'**√©tablir une connexion directe avec le point de terminaison `proxy_pass`** (`http://backend:9999` dans ce cas) dont le contenu ne sera pas v√©rifi√© par nginx.
{% endhint %}

Exemple de configuration vuln√©rable pour voler `/flag` [ici](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Notez que m√™me si le `proxy_pass` pointait vers un **chemin** sp√©cifique tel que `http://backend:9999/socket.io`, la connexion sera √©tablie avec `http://backend:9999`, vous pouvez donc **contacter tout autre chemin √† l'int√©rieur de ce point de terminaison interne. Donc, cela n'a pas d'importance si un chemin est sp√©cifi√© dans l'URL de proxy\_pass.**
{% endhint %}

## Essayez par vous-m√™me

Detectify a cr√©√© un d√©p√¥t GitHub o√π vous pouvez utiliser Docker pour configurer votre propre serveur de test Nginx vuln√©rable avec certaines des mauvaises configurations discut√©es dans cet article et essayer de les trouver vous-m√™me !

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Outils d'analyse statique

### [GIXY](https://github.com/yandex/gixy)

Gixy est un outil pour analyser la configuration de Nginx. L'objectif principal de Gixy est de pr√©venir la mauvaise configuration de s√©curit√© et d'automatiser la d√©tection des failles.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner est un outil simple pour rechercher des mauvaises configurations et vuln√©rabilit√©s communes de Nginx.

## R√©f√©rences

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con m√°s de una d√©cada que se celebrar√° el 7 y 8 de septiembre de 2023 en Bogot√°, Colombia. Es un evento de gran contenido t√©cnico donde se presentan las √∫ltimas investigaciones en espa√±ol que atrae a hackers e investigadores de todo el mundo.\
Inscrivez-vous maintenant au lien suivant et ne manquez pas cette grande conf√©rence ! :

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
