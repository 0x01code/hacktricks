# Nginx

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference is an international cybersecurity event**](https://www.dragonjarcon.org/) with over a decade of history that will take place on September 7th and 8th, 2023 in Bogot√°, Colombia. It is a highly technical event where the latest research in Spanish is presented, attracting hackers and researchers from around the world.\
Register now at the following link and don't miss this great conference!:

{% embed url="https://www.dragonjarcon.org/" %}

## Localiza√ß√£o raiz ausente <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
A diretiva root especifica a pasta raiz para o Nginx. No exemplo acima, a pasta raiz √© `/etc/nginx`, o que significa que podemos acessar arquivos dentro dessa pasta. A configura√ß√£o acima n√£o possui uma localiza√ß√£o para `/ (location / {...})`, apenas para `/hello.txt`. Por causa disso, a diretiva `root` ser√° definida globalmente, o que significa que solicita√ß√µes para `/` o levar√£o ao caminho local `/etc/nginx`.

Uma solicita√ß√£o simples como `GET /nginx.conf` revelaria o conte√∫do do arquivo de configura√ß√£o do Nginx armazenado em `/etc/nginx/nginx.conf`. Se a raiz estiver definida como `/etc`, uma solicita√ß√£o `GET` para `/nginx/nginx.conf` revelaria o arquivo de configura√ß√£o. Em alguns casos, √© poss√≠vel acessar outros arquivos de configura√ß√£o, logs de acesso e at√© mesmo credenciais criptografadas para autentica√ß√£o b√°sica HTTP.

## Configura√ß√£o incorreta de LFI com Alias <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dentro da configura√ß√£o do Nginx, procure as declara√ß√µes "location", se alguma delas se parecer com:
```
location /imgs {
alias /path/images/;
}
```
Existe uma vulnerabilidade de LFI porque:
```
/imgs../flag.txt
```
# Nginx

Nginx is a popular web server that is commonly used to serve static content, reverse proxy, and load balance web applications. It is known for its high performance, scalability, and reliability.

## Configuration Files

Nginx uses configuration files to define how it should handle incoming requests. The main configuration file is typically located at `/etc/nginx/nginx.conf`. Additional configuration files can be included using the `include` directive.

## Virtual Hosts

Nginx supports virtual hosts, allowing you to host multiple websites on a single server. Each virtual host is defined in a separate configuration file and can have its own set of directives.

## Reverse Proxy

Nginx can be used as a reverse proxy to distribute incoming requests to multiple backend servers. This is useful for load balancing and improving performance.

To configure Nginx as a reverse proxy, you need to define a `server` block with the `proxy_pass` directive pointing to the backend server.

## Load Balancing

Nginx can also be used as a load balancer to distribute incoming requests across multiple backend servers. It supports various load balancing algorithms, such as round-robin, least connections, and IP hash.

To configure Nginx as a load balancer, you need to define an `upstream` block with the backend servers and a `server` block with the `proxy_pass` directive pointing to the upstream servers.

## SSL/TLS Termination

Nginx can terminate SSL/TLS connections, allowing you to offload the SSL/TLS encryption and decryption process from your backend servers. This can improve performance and simplify the configuration of your web applications.

To configure SSL/TLS termination, you need to define a `server` block with the `listen` directive specifying the SSL/TLS port and the `ssl_certificate` and `ssl_certificate_key` directives pointing to the SSL/TLS certificate and private key files.

## Security Considerations

When configuring Nginx, it is important to consider security best practices. Some important considerations include:

- Restricting access to sensitive files and directories
- Implementing secure SSL/TLS configurations
- Protecting against common web vulnerabilities, such as cross-site scripting (XSS) and SQL injection
- Regularly updating Nginx and its modules to patch security vulnerabilities

By following these best practices, you can help ensure the security and integrity of your web applications.
```
/path/images/../flag.txt
```
A configura√ß√£o correta ser√°:
```
location /imgs/ {
alias /path/images/;
}
```
**Portanto, se voc√™ encontrar algum servidor Nginx, voc√™ deve verificar essa vulnerabilidade. Al√©m disso, voc√™ pode descobri-la se perceber que a for√ßa bruta de arquivos/diret√≥rios est√° se comportando de forma estranha.**

Mais informa√ß√µes: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Testes do Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restri√ß√£o de caminho insegura <a href="#uso-de-vari√°vel-insegura" id="uso-de-vari√°vel-insegura"></a>

Verifique a p√°gina a seguir para aprender como contornar diretivas como:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Uso inseguro de vari√°veis <a href="#uso-inseguro-de-vari√°veis" id="uso-inseguro-de-vari√°veis"></a>

Um exemplo de uma configura√ß√£o vulner√°vel do Nginx √©:
```
location / {
return 302 https://example.com$uri;
}
```
Os caracteres de nova linha para solicita√ß√µes HTTP s√£o \r (retorno de carro) e \n (avan√ßo de linha). A codifica√ß√£o de URL dos caracteres de nova linha resulta na seguinte representa√ß√£o dos caracteres `%0d%0a`. Quando esses caracteres s√£o inclu√≠dos em uma solicita√ß√£o como `http://localhost/%0d%0aDetectify:%20clrf` para um servidor com a configura√ß√£o incorreta, o servidor responder√° com um novo cabe√ßalho chamado `Detectify`, pois a vari√°vel $uri cont√©m os caracteres de nova linha decodificados da URL.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Saiba mais sobre os riscos de inje√ß√£o de CRLF e divis√£o de resposta em [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Qualquer vari√°vel

Em alguns casos, os dados fornecidos pelo usu√°rio podem ser tratados como uma vari√°vel do Nginx. N√£o est√° claro por que isso pode estar acontecendo, mas n√£o √© t√£o incomum ou f√°cil de testar, como visto neste [relat√≥rio H1](https://hackerone.com/reports/370094). Se pesquisarmos a mensagem de erro, podemos ver que ela √© encontrada no [m√≥dulo de filtro SSI](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), revelando assim que isso se deve ao SSI.

Uma maneira de testar isso √© definir um valor de cabe√ßalho referer:
```
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Escaneamos essa configura√ß√£o incorreta e encontramos v√°rias inst√¢ncias onde um usu√°rio poderia imprimir o valor das vari√°veis do Nginx. O n√∫mero de inst√¢ncias vulner√°veis encontradas diminuiu, o que pode indicar que isso foi corrigido.

## Leitura bruta da resposta do backend

Com o `proxy_pass` do Nginx, h√° a possibilidade de interceptar erros e cabe√ßalhos HTTP criados pelo backend. Isso √© muito √∫til se voc√™ quiser ocultar mensagens de erro e cabe√ßalhos internos para que sejam tratados pelo Nginx. O Nginx automaticamente servir√° uma p√°gina de erro personalizada se o backend responder com uma. Mas e se o Nginx n√£o entender que √© uma resposta HTTP?

Se um cliente enviar uma solicita√ß√£o HTTP inv√°lida para o Nginx, essa solicita√ß√£o ser√° encaminhada como est√° para o backend, e o backend responder√° com seu conte√∫do bruto. Em seguida, o Nginx n√£o entender√° a resposta HTTP inv√°lida e a encaminhar√° diretamente para o cliente. Imagine um aplicativo uWSGI como este:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
E com as seguintes diretivas no Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) servir√° uma resposta personalizada se o backend tiver um status de resposta maior que 300. Em nossa aplica√ß√£o uWSGI acima, enviaremos um `Erro 500` que ser√° interceptado pelo Nginx.

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) √© bastante autoexplicativo; ele ocultar√° qualquer cabe√ßalho HTTP especificado do cliente.

Se enviarmos uma solicita√ß√£o `GET` normal, o Nginx retornar√°:
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
Mas se enviarmos uma solicita√ß√£o HTTP inv√°lida, como:
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
Obteremos a seguinte resposta:
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes definido como off

A diretiva [merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) √© definida como "on" por padr√£o, o que √© um mecanismo para comprimir duas ou mais barras em uma √∫nica, ent√£o `///` se tornaria `/`. Se o Nginx for usado como um proxy reverso e a aplica√ß√£o que est√° sendo proxy for vulner√°vel a inclus√£o local de arquivos, o uso de barras extras na solicita√ß√£o poderia deixar espa√ßo para explora√ß√£o. Isso √© descrito em detalhes por [Danny Robinson e Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

Encontramos 33 arquivos de configura√ß√£o do Nginx com `merge_slashes` definido como "off".

## default n√£o √© especificado para a diretiva map

Parece ser um caso comum quando **`map` √© usado para algum tipo de controle de autoriza√ß√£o**. Um exemplo simplificado poderia ser:
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[De acordo com o manual](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html):

> valor padr√£o\
> define o valor resultante se o valor de origem n√£o corresponder a nenhuma das variantes especificadas. Quando o valor padr√£o n√£o √© especificado, o valor resultante padr√£o ser√° uma string vazia.

√â f√°cil esquecer do valor `padr√£o`. Portanto, **o malfeitor pode contornar esse "controle de autoriza√ß√£o"** simplesmente acessando um **caso inexistente dentro de `/map-poc`** como `https://targethost.com/map-poc/outra-√°rea-privada`.

## DNS Spoofing no Nginx

De acordo com este post: [http://blog.zorinaq.com/nginx-resol**ver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/) **Pode ser poss√≠vel falsificar registros DNS** para o Nginx se voc√™ **souber o servidor DNS que o Nginx** est√° usando (e puder interceptar de alguma forma a comunica√ß√£o, portanto, isso **n√£o √© v√°lido se 127.0.0.1** for usado) e o **dom√≠nio que est√° sendo solicitado**.

O Nginx pode especificar um servidor DNS a ser usado com:
```
resolver     8.8.8.8;
```
## Diretivas `proxy_pass` e `internal`

A diretiva **`proxy_pass`** pode ser usada para **redirecionar internamente solicita√ß√µes para outros servidores** internos ou externos.\
A diretiva **`internal`** √© usada para deixar claro para o Nginx que a **localiza√ß√£o s√≥ pode ser acessada internamente**.

O uso dessas diretivas **n√£o √© uma vulnerabilidade, mas voc√™ deve verificar como elas est√£o configuradas**.

## proxy\_set\_header Upgrade & Connection

Se o servidor nginx estiver configurado para passar os cabe√ßalhos Upgrade e Connection, um [**ataque de Smuggling h2c**](../../pentesting-web/h2c-smuggling.md) pode ser realizado para acessar endpoints protegidos/internos.

{% hint style="danger" %}
Essa vulnerabilidade permitiria que um invasor **estabelecesse uma conex√£o direta com o endpoint `proxy_pass`** (`http://backend:9999` neste caso), cujo conte√∫do n√£o seria verificado pelo nginx.
{% endhint %}

Exemplo de configura√ß√£o vulner√°vel para roubar `/flag` [aqui](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Observe que mesmo que o `proxy_pass` esteja apontando para um **caminho** espec√≠fico, como `http://backend:9999/socket.io`, a conex√£o ser√° estabelecida com `http://backend:9999`, ent√£o voc√™ pode **acessar qualquer outro caminho dentro desse endpoint interno. Portanto, n√£o importa se um caminho √© especificado na URL do proxy\_pass.**
{% endhint %}

## Experimente voc√™ mesmo

A Detectify criou um reposit√≥rio no GitHub onde voc√™ pode usar o Docker para configurar seu pr√≥prio servidor de teste Nginx vulner√°vel com algumas das configura√ß√µes incorretas discutidas neste artigo e tentar encontr√°-las por conta pr√≥pria!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Ferramentas de An√°lise Est√°tica

### [GIXY](https://github.com/yandex/gixy)

Gixy √© uma ferramenta para analisar a configura√ß√£o do Nginx. O objetivo principal do Gixy √© prevenir a configura√ß√£o incorreta de seguran√ßa e automatizar a detec√ß√£o de falhas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner √© uma ferramenta simples para procurar configura√ß√µes incorretas e vulnerabilidades comuns do Nginx.

## Refer√™ncias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con m√°s de una d√©cada que se celebrar√° el 7 y 8 de septiembre de 2023 en Bogot√°, Colombia. Es un evento de gran contenido t√©cnico donde se presentan las √∫ltimas investigaciones en espa√±ol que atrae a hackers e investigadores de todo el mundo.\
¬°Reg√≠strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? Ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
