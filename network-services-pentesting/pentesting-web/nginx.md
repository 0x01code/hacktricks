# Nginx

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et les tests de p√©n√©tration**. Lancez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au reporting. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur donner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

## Emplacement racine manquant <a href="#missing-root-location" id="missing-root-location"></a>

Lors de la configuration du serveur Nginx, la directive **root** joue un r√¥le critique en d√©finissant le r√©pertoire de base √† partir duquel les fichiers sont servis. Consid√©rez l'exemple ci-dessous :
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
Dans cette configuration, `/etc/nginx` est d√©sign√© comme r√©pertoire racine. Cette configuration permet d'acc√©der aux fichiers dans le r√©pertoire racine sp√©cifi√©, tel que `/hello.txt`. Cependant, il est crucial de noter qu'un emplacement sp√©cifique (`/hello.txt`) est d√©fini. Il n'y a pas de configuration pour l'emplacement racine (`location / {...}`). Cette omission signifie que la directive racine s'applique globalement, permettant aux requ√™tes vers le chemin racine `/` d'acc√©der aux fichiers sous `/etc/nginx`.

Une consid√©ration de s√©curit√© critique d√©coule de cette configuration. Une simple requ√™te `GET`, comme `GET /nginx.conf`, pourrait exposer des informations sensibles en servant le fichier de configuration Nginx situ√© √† `/etc/nginx/nginx.conf`. D√©finir la racine sur un r√©pertoire moins sensible, comme `/etc`, pourrait att√©nuer ce risque, mais cela pourrait encore permettre un acc√®s non intentionnel √† d'autres fichiers critiques, y compris d'autres fichiers de configuration, des journaux d'acc√®s, voire des identifiants chiffr√©s utilis√©s pour l'authentification de base HTTP.

## Configuration de l'alias LFI mal configur√©e <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dans les fichiers de configuration de Nginx, une inspection minutieuse est n√©cessaire pour les directives "location". Une vuln√©rabilit√© connue sous le nom d'Inclusion de Fichier Local (LFI) peut √™tre introduite involontairement via une configuration qui ressemble √† ce qui suit:
```
location /imgs {
alias /path/images/;
}
```
Cette configuration est vuln√©rable aux attaques LFI car le serveur interpr√®te les requ√™tes telles que `/imgs../flag.txt` comme une tentative d'acc√©der √† des fichiers en dehors du r√©pertoire pr√©vu, se r√©solvant effectivement en `/chemin/images/../flag.txt`. Cette faille permet aux attaquants de r√©cup√©rer des fichiers du syst√®me de fichiers du serveur qui ne devraient pas √™tre accessibles via le web.

Pour att√©nuer cette vuln√©rabilit√©, la configuration devrait √™tre ajust√©e comme suit :
```
location /imgs/ {
alias /path/images/;
}
```
Plus d'informations : [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Tests d'Accunetix :
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restriction de chemin non s√©curis√©e <a href="#utilisation-de-variable-non-s√©curis√©e" id="utilisation-de-variable-non-s√©curis√©e"></a>

Consultez la page suivante pour apprendre comment contourner des directives telles que:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## Utilisation non s√©curis√©e des variables / Fractionnement de requ√™te HTTP <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

{% hint style="danger" %}
Les variables vuln√©rables `$uri` et `$document_uri` peuvent √™tre corrig√©es en les rempla√ßant par `$request_uri`.

Une expression r√©guli√®re peut √©galement √™tre vuln√©rable comme suit :

`location ~ /docs/([^/])? { ‚Ä¶ $1 ‚Ä¶ }` - Vuln√©rable

`location ~ /docs/([^/\s])? { ‚Ä¶ $1 ‚Ä¶ }` - Non vuln√©rable (v√©rification des espaces)

`location ~ /docs/(.*)? { ‚Ä¶ $1 ‚Ä¶ }`  - Non vuln√©rable
{% endhint %}

Une vuln√©rabilit√© dans la configuration de Nginx est d√©montr√©e par l'exemple ci-dessous :
```
location / {
return 302 https://example.com$uri;
}
```
Les caract√®res \r (Retour chariot) et \n (Saut de ligne) signifient des caract√®res de nouvelle ligne dans les requ√™tes HTTP, et leurs formes encod√©es en URL sont repr√©sent√©es comme `%0d%0a`. Inclure ces caract√®res dans une requ√™te (par exemple, `http://localhost/%0d%0aDetectify:%20clrf`) √† un serveur mal configur√© entra√Æne le serveur √† √©mettre un nouvel en-t√™te nomm√© `Detectify`. Cela se produit car la variable $uri d√©code les caract√®res de nouvelle ligne encod√©s en URL, entra√Ænant un en-t√™te inattendu dans la r√©ponse:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
D√©couvrez davantage sur les risques d'injection CRLF et de fractionnement de r√©ponse √† [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

Cette technique est √©galement **expliqu√©e dans cette pr√©sentation** avec des exemples vuln√©rables et des m√©canismes de d√©tection. Par exemple, pour d√©tecter cette mauvaise configuration d'un point de vue bo√Æte noire, vous pourriez utiliser ces requ√™tes :

- `https://example.com/%20X` - Tout code HTTP
- `https://example.com/%20H` - 400 Bad Request

Si vuln√©rable, le premier retournera "X" car c'est n'importe quelle m√©thode HTTP et le second renverra une erreur car H n'est pas une m√©thode valide. Ainsi, le serveur recevra quelque chose comme : `GET / H HTTP/1.1` et cela d√©clenchera l'erreur.

D'autres exemples de d√©tection seraient :

- `http://company.tld/%20HTTP/1.1%0D%0AXXXX:%20x` - Tout code HTTP
- `http://company.tld/%20HTTP/1.1%0D%0AHost:%20x` - 400 Bad Request

Certaines configurations vuln√©rables trouv√©es et pr√©sent√©es dans cette pr√©sentation √©taient :

- Remarquez comment **`$uri`** est d√©fini tel quel dans l'URL finale
```
location ^~ /lite/api/ {
proxy_pass http://lite-backend$uri$is_args$args;
}
```
* Notez √† nouveau que **`$uri`** est dans l'URL (cette fois √† l'int√©rieur d'un param√®tre)
```
location ~ ^/dna/payment {
rewrite ^/dna/([^/]+) /registered/main.pl?cmd=unifiedPayment&context=$1&native_uri=$uri break;
proxy_pass http://$back;
```
* Maintenant dans AWS S3
```
location /s3/ {
proxy_pass https://company-bucket.s3.amazonaws.com$uri;
}
```
### Toute variable

Il a √©t√© d√©couvert que des **donn√©es fournies par l'utilisateur** pourraient √™tre trait√©es comme une **variable Nginx** dans certaines circonstances. La cause de ce comportement reste quelque peu insaisissable, mais il n'est ni rare ni simple √† v√©rifier. Cette anomalie a √©t√© soulign√©e dans un rapport de s√©curit√© sur HackerOne, qui peut √™tre consult√© [ici](https://hackerone.com/reports/370094). Une enqu√™te plus approfondie sur le message d'erreur a permis d'identifier son occurrence dans le [module de filtre SSI du code source de Nginx](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), en identifiant les Inclusions C√¥t√© Serveur (SSI) comme la cause principale.

Pour **d√©tecter cette mauvaise configuration**, la commande suivante peut √™tre ex√©cut√©e, ce qui implique de d√©finir un en-t√™te referer pour tester l'impression de variables:
```bash
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Les analyses de cette mauvaise configuration sur les syst√®mes ont r√©v√©l√© de multiples cas o√π les variables Nginx pouvaient √™tre affich√©es par un utilisateur. Cependant, une diminution du nombre d'instances vuln√©rables sugg√®re que les efforts pour corriger ce probl√®me ont √©t√© quelque peu fructueux.

## Lecture brute de la r√©ponse du backend

Nginx offre une fonctionnalit√© via `proxy_pass` qui permet l'interception des erreurs et des en-t√™tes HTTP g√©n√©r√©s par le backend, dans le but de masquer les messages d'erreur et les en-t√™tes internes. Cela est r√©alis√© en faisant en sorte que Nginx serve des pages d'erreur personnalis√©es en r√©ponse aux erreurs du backend. Cependant, des d√©fis surviennent lorsque Nginx rencontre une requ√™te HTTP invalide. Une telle requ√™te est transmise au backend telle qu'elle est re√ßue, et la r√©ponse brute du backend est ensuite directement envoy√©e au client sans l'intervention de Nginx.

Consid√©rez un sc√©nario d'exemple impliquant une application uWSGI :
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Pour g√©rer cela, des directives sp√©cifiques dans la configuration de Nginx sont utilis√©es :
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
* [**proxy\_intercept\_errors**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors): Cette directive permet √† Nginx de servir une r√©ponse personnalis√©e pour les r√©ponses de backend avec un code d'√©tat sup√©rieur √† 300. Cela garantit que, pour notre application uWSGI exemple, une r√©ponse d'erreur `500` est intercept√©e et g√©r√©e par Nginx.
* [**proxy\_hide\_header**](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header): Comme son nom l'indique, cette directive masque les en-t√™tes HTTP sp√©cifi√©s du client, am√©liorant ainsi la confidentialit√© et la s√©curit√©.

Lorsqu'une requ√™te `GET` valide est effectu√©e, Nginx la traite normalement, renvoyant une r√©ponse d'erreur standard sans r√©v√©ler d'en-t√™tes secrets. Cependant, une requ√™te HTTP invalide contourne ce m√©canisme, entra√Ænant l'exposition des r√©ponses brutes du backend, y compris les en-t√™tes secrets et les messages d'erreur.

## merge\_slashes d√©fini sur off

Par d√©faut, la directive **`merge_slashes` de Nginx** est d√©finie sur **`on`**, ce qui compresse plusieurs barres obliques dans une URL en une seule barre oblique. Cette fonctionnalit√©, tout en rationalisant le traitement des URL, peut involontairement dissimuler des vuln√©rabilit√©s dans les applications derri√®re Nginx, en particulier celles sujettes aux attaques d'inclusion de fichiers locaux (LFI). Les experts en s√©curit√© **Danny Robinson et Rotem Bar** ont soulign√© les risques potentiels associ√©s √† ce comportement par d√©faut, en particulier lorsque Nginx agit en tant que reverse-proxy.

Pour att√©nuer de tels risques, il est recommand√© de **d√©sactiver la directive `merge_slashes`** pour les applications susceptibles √† ces vuln√©rabilit√©s. Cela garantit que Nginx transmet les requ√™tes √† l'application sans modifier la structure de l'URL, ne masquant ainsi aucun probl√®me de s√©curit√© sous-jacent.

Pour plus d'informations, consultez [Danny Robinson et Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **En-t√™tes de r√©ponse malveillants**

Comme le montre [**cet article**](https://mizu.re/post/cors-playground), certains en-t√™tes pr√©sents dans la r√©ponse du serveur Web modifieront le comportement du proxy Nginx. Vous pouvez les v√©rifier [**dans la documentation**](https://www.nginx.com/resources/wiki/start/topics/examples/x-accel/):

* `X-Accel-Redirect`: Indique √† Nginx de rediriger internement une requ√™te vers un emplacement sp√©cifi√©.
* `X-Accel-Buffering`: Contr√¥le si Nginx doit mettre en m√©moire tampon la r√©ponse ou non.
* `X-Accel-Charset`: D√©finit l'ensemble de caract√®res pour la r√©ponse lors de l'utilisation de X-Accel-Redirect.
* `X-Accel-Expires`: D√©finit le temps d'expiration pour la r√©ponse lors de l'utilisation de X-Accel-Redirect.
* `X-Accel-Limit-Rate`: Limite le d√©bit de transfert pour les r√©ponses lors de l'utilisation de X-Accel-Redirect.

Par exemple, l'en-t√™te **`X-Accel-Redirect`** provoquera une **redirection interne** dans le nginx. Ainsi, avoir une configuration nginx avec quelque chose comme **`root /`** et une r√©ponse du serveur Web avec **`X-Accel-Redirect: .env`** fera en sorte que nginx envoie le contenu de **`/.env`** (traversal de chemin).

### **Valeur par d√©faut dans la directive Map**

Dans la **configuration de Nginx**, la directive `map` joue souvent un r√¥le dans le **contr√¥le d'autorisation**. Une erreur courante est de ne pas sp√©cifier de **valeur par d√©faut**, ce qui pourrait entra√Æner un acc√®s non autoris√©. Par exemple:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Sans une `default`, un **utilisateur malveillant** peut contourner la s√©curit√© en acc√©dant √† une **URI non d√©finie** dans `/map-poc`. [Le manuel de Nginx](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html) recommande de d√©finir une **valeur par d√©faut** pour √©viter de tels probl√®mes.

### **Vuln√©rabilit√© de l'usurpation DNS**

L'usurpation DNS contre Nginx est r√©alisable dans certaines conditions. Si un attaquant conna√Æt le **serveur DNS** utilis√© par Nginx et peut intercepter ses requ√™tes DNS, il peut usurper des enregistrements DNS. Cette m√©thode, cependant, est inefficace si Nginx est configur√© pour utiliser **localhost (127.0.0.1)** pour la r√©solution DNS. Nginx permet de sp√©cifier un serveur DNS comme suit:
```yaml
resolver 8.8.8.8;
```
### **Directives `proxy_pass` et `internal`**

La directive **`proxy_pass`** est utilis√©e pour rediriger les requ√™tes vers d'autres serveurs, que ce soit en interne ou en externe. La directive **`internal`** garantit que certains emplacements ne sont accessibles qu'√† l'int√©rieur de Nginx. Bien que ces directives ne soient pas des vuln√©rabilit√©s en elles-m√™mes, leur configuration n√©cessite un examen attentif pour √©viter les failles de s√©curit√©.

## proxy\_set\_header Upgrade & Connection

Si le serveur nginx est configur√© pour transmettre les en-t√™tes Upgrade et Connection, une [attaque de type **h2c Smuggling**](../../pentesting-web/h2c-smuggling.md) pourrait √™tre r√©alis√©e pour acc√©der √† des points de terminaison prot√©g√©s/internes.

{% hint style="danger" %}
Cette vuln√©rabilit√© permettrait √† un attaquant d'**√©tablir une connexion directe avec le point de terminaison `proxy_pass`** (`http://backend:9999` dans ce cas) dont le contenu ne serait pas v√©rifi√© par nginx.
{% endhint %}

Exemple de configuration vuln√©rable pour voler `/flag` √† partir de [ici](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Notez que m√™me si le `proxy_pass` pointait vers un **chemin** sp√©cifique tel que `http://backend:9999/socket.io`, la connexion sera √©tablie avec `http://backend:9999`, vous pouvez donc **contacter tout autre chemin √† l'int√©rieur de ce point de terminaison interne. Ainsi, il n'importe pas si un chemin est sp√©cifi√© dans l'URL de proxy\_pass.**
{% endhint %}

## Essayez par vous-m√™me

Detectify a cr√©√© un d√©p√¥t GitHub o√π vous pouvez utiliser Docker pour configurer votre propre serveur de test Nginx vuln√©rable avec certaines des mauvaises configurations discut√©es dans cet article et essayer de les trouver vous-m√™me !

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Outils d'analyse statique

### [GIXY](https://github.com/yandex/gixy)

Gixy est un outil d'analyse de la configuration Nginx. Le but principal de Gixy est de pr√©venir les mauvaises configurations de s√©curit√© et d'automatiser la d√©tection des failles.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner est un outil simple pour rechercher les mauvaises configurations et les vuln√©rabilit√©s courantes de Nginx.

## R√©f√©rences

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (14) (1).png" alt=""><figcaption></figcaption></figure>

**Configuration instantan√©ment disponible pour l'√©valuation des vuln√©rabilit√©s et les tests de p√©n√©tration**. Ex√©cutez un pentest complet de n'importe o√π avec plus de 20 outils et fonctionnalit√©s allant de la reconnaissance au reporting. Nous ne rempla√ßons pas les pentesteurs - nous d√©veloppons des outils personnalis√©s, des modules de d√©tection et d'exploitation pour leur donner du temps pour creuser plus profond√©ment, ouvrir des shells et s'amuser.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous voulez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
