# Nginx

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Άμεσα διαθέσιμη εγκατάσταση για αξιολόγηση ευπαθειών και δοκιμή διείσδυσης**. Εκτελέστε μια πλήρη δοκιμή διείσδυσης από οπουδήποτε με 20+ εργαλεία και χαρακτηριστικά που καλύπτουν από την αναγνώριση έως την αναφορά. Δεν αντικαθιστούμε τους δοκιμαστές διείσδυσης - αναπτύσσουμε προσαρμοσμένα εργαλεία, ανίχνευση και εκμετάλλευση ενοτήτων για να τους δώσουμε πίσω χρόνο για να εξερευνήσουν πιο βαθιά, να ανοίξουν κελύφη και να διασκεδάσουν.

{% embed url="https://pentest-tools.com/" %}

## Λείπει η ρίζα τοποθεσίας <a href="#missing-root-location" id="missing-root-location"></a>

## **Τα βασικά για τη ρύθμιση του καταλόγου ρίζας του Nginx**

Κατά τη διαμόρφωση του διακομιστή Nginx, η **οδηγία root** παίζει κρίσιμο ρόλο καθορίζοντας τον βασικό κατάλογο από τον οποίο εξυπηρετούνται τα αρχεία. Λάβετε υπόψη το παρακάτω παράδειγμα:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
Σε αυτή τη διαμόρφωση, το `/etc/nginx` ορίζεται ως ο κατάλογος ρίζας. Αυτή η ρύθμιση επιτρέπει την πρόσβαση σε αρχεία εντός του καθορισμένου καταλόγου ρίζας, όπως το `/hello.txt`. Ωστόσο, είναι σημαντικό να σημειωθεί ότι ορίζεται μόνο μια συγκεκριμένη τοποθεσία (`/hello.txt`). Δεν υπάρχει ρύθμιση για την τοποθεσία ρίζας (`location / {...}`). Αυτή η παράλειψη σημαίνει ότι η οδηγία ρίζας ισχύει παγκοσμίως, επιτρέποντας αιτήματα στην ρίζα `/` να έχουν πρόσβαση σε αρχεία κάτω από το `/etc/nginx`.

Από αυτή τη διαμόρφωση προκύπτει μια σημαντική ασφαλειακή προβληματική. Ένα απλό αίτημα `GET`, όπως `GET /nginx.conf`, μπορεί να αποκαλύψει ευαίσθητες πληροφορίες παρέχοντας το αρχείο διαμόρφωσης του Nginx που βρίσκεται στο `/etc/nginx/nginx.conf`. Η ρύθμιση της ρίζας σε έναν λιγότερο ευαίσθητο κατάλογο, όπως το `/etc`, μπορεί να μειώσει αυτόν τον κίνδυνο, αλλά εξακολουθεί να επιτρέπει μη επιθυμητή πρόσβαση σε άλλα κρίσιμα αρχεία, συμπεριλαμβανομένων άλλων αρχείων διαμόρφωσης, αρχείων καταγραφής πρόσβασης και ακόμα και κρυπτογραφημένων διαπιστευτηρίων που χρησιμοποιούνται για τη βασική αυθεντικοποίηση HTTP.

## Ευπάθεια Λανθασμένης Ρύθμισης Συνώνυμου LFI <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Στα αρχεία διαμόρφωσης του Nginx, απαιτείται προσεκτική επιθεώρηση των οδηγιών "location". Μια ευπάθεια γνωστή ως Εντοπισμός Τοπικού Αρχείου (LFI) μπορεί να εισαχθεί κατά λάθος μέσω μιας διαμόρφωσης που μοιάζει με την ακόλουθη:
```
location /imgs {
alias /path/images/;
}
```
Αυτή η διαμόρφωση είναι ευάλωτη σε επιθέσεις LFI λόγω του ότι ο διακομιστής ερμηνεύει αιτήματα όπως `/imgs../flag.txt` ως προσπάθεια πρόσβασης σε αρχεία εκτός του επιθυμητού καταλόγου, αναπτύσσοντας το `/path/images/../flag.txt`. Αυτή η αδυναμία επιτρέπει στους επιτιθέμενους να ανακτήσουν αρχεία από το σύστημα αρχείων του διακομιστή που δεν πρέπει να είναι προσβάσιμα μέσω του web.

Για να αντιμετωπιστεί αυτή η ευπάθεια, η διαμόρφωση θα πρέπει να προσαρμοστεί σε:
```
location /imgs/ {
alias /path/images/;
}
```
Περισσότερες πληροφορίες: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Δοκιμές Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Μη ασφαλής περιορισμός διαδρομής <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Ελέγξτε την παρακάτω σελίδα για να μάθετε πώς να παρακάμψετε οδηγίες όπως:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Μη ασφαλής χρήση μεταβλητής <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Μια ευπάθεια στη διαμόρφωση του Nginx αποδεικνύεται από το παρακάτω παράδειγμα:
```
location / {
return 302 https://example.com$uri;
}
```
Οι χαρακτήρες \r (Carriage Return) και \n (Line Feed) υποδηλώνουν νέες γραμμές σε αιτήματα HTTP και οι κωδικοποιημένες μορφές τους σε URL αναπαρίστανται ως `%0d%0a`. Η συμπερίληψη αυτών των χαρακτήρων σε ένα αίτημα (π.χ., `http://localhost/%0d%0aDetectify:%20clrf`) προς έναν κακοδιαμορφωμένο διακομιστή έχει ως αποτέλεσμα τον διακομιστή να εκδίδει ένα νέο κεφαλίδα με το όνομα `Detectify`. Αυτό συμβαίνει επειδή η μεταβλητή $uri αποκωδικοποιεί τους κωδικοποιημένους χαρακτήρες νέας γραμμής, οδηγώντας σε ένα απρόσμενο κεφαλίδα στην απόκριση:
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Μάθετε περισσότερα για τους κινδύνους της εισαγωγής CRLF και της διαίρεσης απόκρισης στο [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Οποιαδήποτε μεταβλητή

Ανακαλύφθηκε ότι τα **δεδομένα που παρέχονται από τον χρήστη** μπορεί να θεωρηθούν ως μια **μεταβλητή Nginx** υπό ορισμένες συνθήκες. Ο λόγος για αυτήν τη συμπεριφορά παραμένει κάπως ασαφής, αλλά δεν είναι σπάνιο ούτε εύκολο να επαληθευτεί. Αυτή η ανωμαλία τέθηκε υπόψη σε ένα αναφορά ασφαλείας στο HackerOne, την οποία μπορείτε να δείτε [εδώ](https://hackerone.com/reports/370094). Περαιτέρω έρευνα στο μήνυμα σφάλματος οδήγησε στον εντοπισμό της εμφάνισής του μέσα στον [SSI filter module του κώδικα του Nginx](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365), εντοπίζοντας τα Server Side Includes (SSI) ως την αρχική αιτία.

Για να **ανιχνεύσετε αυτήν την εσφαλμένη ρύθμιση**, μπορείτε να εκτελέσετε την παρακάτω εντολή, η οποία περιλαμβάνει την ρύθμιση ενός κεφαλίδας αναφοράς για να δοκιμάσετε την εκτύπωση μεταβλητής:
```bash
$ curl -H ‘Referer: bar’ http://localhost/foo$http_referer | grep ‘foobar’
```
Οι σαρώσεις για αυτήν την εσφαλμένη ρύθμιση σε διάφορα συστήματα αποκάλυψαν πολλαπλές περιπτώσεις όπου οι μεταβλητές του Nginx μπορούσαν να εκτυπωθούν από έναν χρήστη. Ωστόσο, η μείωση του αριθμού των ευάλωτων περιπτώσεων υποδηλώνει ότι οι προσπάθειες για την επιδιόρθωση αυτού του προβλήματος ήταν κάπως επιτυχημένες.

## Ανάγνωση ακατέργαστης απόκρισης πίσω από το backend

Το Nginx προσφέρει μια δυνατότητα μέσω του `proxy_pass` που επιτρέπει την παρεμβολή σφαλμάτων και κεφαλίδων HTTP που παράγονται από το backend, με στόχο την απόκρυψη εσωτερικών μηνυμάτων σφάλματος και κεφαλίδων. Αυτό επιτυγχάνεται από το Nginx παρέχοντας προσαρμοσμένες σελίδες σφάλματος ως απόκριση σε σφάλματα του backend. Ωστόσο, προκύπτουν προκλήσεις όταν το Nginx αντιμετωπίζει ένα μη έγκυρο αίτημα HTTP. Ένα τέτοιο αίτημα προωθείται στο backend όπως λαμβάνεται, και η ακατέργαστη απόκριση του backend στέλνεται απευθείας στον πελάτη χωρίς παρέμβαση από το Nginx.

Ας θεωρήσουμε ένα παράδειγμα σεναρίου που αφορά μια εφαρμογή uWSGI:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Για να διαχειριστείτε αυτό, χρησιμοποιούνται συγκεκριμένες οδηγίες στη διαμόρφωση του Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
- **[proxy_intercept_errors](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_intercept_errors)**: Αυτή η οδηγία επιτρέπει στο Nginx να εξυπηρετεί μια προσαρμοσμένη απόκριση για απαντήσεις του backend με κωδικό κατάστασης μεγαλύτερο από 300. Βεβαιώνει ότι, για την παράδειγμα εφαρμογή μας uWSGI, μια απόκριση `500 Error` παρεμβαίνεται και χειρίζεται από το Nginx.
- **[proxy_hide_header](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header)**: Όπως υποδηλώνει το όνομά του, αυτή η οδηγία αποκρύπτει συγκεκριμένες κεφαλίδες HTTP από τον πελάτη, ενισχύοντας την απορρήτου και την ασφάλεια.

Όταν γίνεται ένα έγκυρο αίτημα `GET`, το Nginx το επεξεργάζεται κανονικά, επιστρέφοντας μια τυπική απόκριση σφάλματος χωρίς να αποκαλύπτει κρυφές κεφαλίδες. Ωστόσο, ένα μη έγκυρο αίτημα HTTP παρακάμπτει αυτόν τον μηχανισμό, με αποτέλεσμα την αποκάλυψη ακατέργαστων αποκρίσεων του backend, συμπεριλαμβανομένων των κρυφών κεφαλίδων και μηνυμάτων σφάλματος.


## Η ρύθμιση merge\_slashes ορίζεται σε off

Από προεπιλογή, η οδηγία **`merge_slashes`** του Nginx ορίζεται σε **`on`**, η οποία συμπιέζει πολλαπλά κάθετα πλάγια στοιχεία σε ένα URL σε ένα μόνο κάθετο πλάγιο. Αυτή η λειτουργία, ενώ διευκολύνει την επεξεργασία του URL, μπορεί απροσδόκητα να κρύβει ευπάθειες σε εφαρμογές πίσω από το Nginx, ιδίως αυτές που είναι ευάλωτες σε επιθέσεις τοπικής ενσωμάτωσης αρχείων (LFI). Οι ειδικοί ασφάλειας **Danny Robinson και Rotem Bar** έχουν επισημάνει τους πιθανούς κινδύνους που συνδέονται με αυτήν την προεπιλεγμένη συμπεριφορά, ειδικά όταν το Nginx λειτουργεί ως αντίστροφος διακομιστής.

Για να μειωθούν τέτοιοι κίνδυνοι, συνιστάται να **απενεργοποιηθεί η οδηγία `merge_slashes`** για εφαρμογές που είναι ευάλωτες σε αυτές τις ευπάθειες. Αυτό εξασφαλίζει ότι το Nginx προωθεί τα αιτήματα στην εφαρμογή χωρίς να αλλάζει τη δομή του URL, μην κρύβοντας οποιοδήποτε υποκείμενο θέμα ασφαλείας.

Για περισσότερες πληροφορίες ανατρέξτε στο [Danny Robinson και Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

### **Προεπιλεγμένη τιμή στην οδηγία Map**

Στη ρύθμιση του **Nginx**, η οδηγία `map` συχνά παίζει ρόλο στον **έλεγχο εξουσιοδότησης**. Ένα συνηθές λάθος είναι να μην καθορίζεται μια **προεπιλεγμένη** τιμή, που μπορεί να οδηγήσει σε μη εξουσιοδοτημένη πρόσβαση. Για παράδειγμα:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
Χωρίς ένα `default`, ένας **κακόβουλος χρήστης** μπορεί να παρακάμψει την ασφάλεια προσπελαύνοντας ένα **μη ορισμένο URI** μέσα στο `/map-poc`. [Το εγχειρίδιο του Nginx](https://nginx.org/en/docs/http/ngx_http_map_module.html) συνιστά να ορίσετε μια **προεπιλεγμένη τιμή** για να αποφευχθούν τέτοια προβλήματα.

### **Ευπάθεια DNS Spoofing**

Η επίθεση DNS spoofing είναι εφικτή κατά του Nginx υπό ορισμένες συνθήκες. Αν ένας επιτιθέμενος γνωρίζει τον **DNS server** που χρησιμοποιείται από το Nginx και μπορεί να παρεμβάλει τα DNS ερωτήματά του, μπορεί να παραποιήσει τις εγγραφές DNS. Αυτή η μέθοδος, ωστόσο, δεν είναι αποτελεσματική εάν το Nginx είναι ρυθμισμένο να χρησιμοποιεί το **localhost (127.0.0.1)** για την ανάλυση DNS. Το Nginx επιτρέπει την καθορισμό ενός DNS server ως εξής:
```yaml
resolver 8.8.8.8;
```
### **Οδηγίες `proxy_pass` και `internal`**

Η οδηγία **`proxy_pass`** χρησιμοποιείται για την ανακατεύθυνση αιτημάτων σε άλλους διακομιστές, είτε εσωτερικά είτε εξωτερικά. Η οδηγία **`internal`** εξασφαλίζει ότι ορισμένες τοποθεσίες είναι προσβάσιμες μόνο μέσα στο Nginx. Αν και αυτές οι οδηγίες δεν αποτελούν καθαυτές ευπάθειες, η διαμόρφωσή τους απαιτεί προσεκτική εξέταση για να αποφευχθούν παραβιάσεις ασφάλειας.

## proxy\_set\_header Upgrade & Connection

Εάν ο διακομιστής nginx έχει διαμορφωθεί για να περνά τις κεφαλίδες Upgrade και Connection, μπορεί να πραγματοποιηθεί μια [**επίθεση h2c Smuggling**](../../pentesting-web/h2c-smuggling.md) για να αποκτηθεί πρόσβαση σε προστατευμένα/εσωτερικά σημεία πρόσβασης.

{% hint style="danger" %}
Αυτή η ευπάθεια θα επιτρέπει σε έναν επιτιθέμενο να **καθιερώσει μια άμεση σύνδεση με το `proxy_pass` σημείο πρόσβασης** (`http://backend:9999` σε αυτήν την περίπτωση), το περιεχόμενο του οποίου δεν θα ελεγχθεί από το nginx.
{% endhint %}

Παράδειγμα ευπαθούς διαμόρφωσης για να κλαπεί το `/flag` από [εδώ](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Σημειώστε ότι ακόμη κι αν το `proxy_pass` έδειχνε σε ένα συγκεκριμένο **μονοπάτι** όπως `http://backend:9999/socket.io`, η σύνδεση θα γίνεται με το `http://backend:9999`, οπότε μπορείτε να **επικοινωνήσετε με οποιοδήποτε άλλο μονοπάτι μέσα σε αυτό το εσωτερικό σημείο πρόσβασης. Οπότε δεν έχει σημασία αν ένα μονοπάτι καθορίζεται στο URL του proxy\_pass.**
{% endhint %}

## Δοκιμάστε το μόνοι σας

Η Detectify έχει δημιουργήσει ένα αποθετήριο GitHub όπου μπορείτε να χρησιμοποιήσετε το Docker για να δημιουργήσετε το δικό σας ευάλωτο δοκιμαστικό διακομιστή Nginx με μερικές από τις λανθασμένες ρυθμίσεις που συζητήθηκαν σε αυτό το άρθρο και να προσπαθήσετε να τις βρείτε μόνοι σας!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Εργαλεία Στατικής Ανάλυσης

### [GIXY](https://github.com/yandex/gixy)

Το Gixy είναι ένα εργαλείο για την ανάλυση της διαμόρφωσης του Nginx. Ο κύριος στόχος του Gixy είναι η πρόληψη της ανεπάρκειας ασφαλείας και η αυτοματοποίηση της ανίχνευσης ελαττωμάτων.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Το Nginxpwner είναι ένα απλό εργαλείο για την αναζήτηση κοινών λανθασμένων ρυθμίσεων και ευπαθειών του Nginx.

## Αναφορές

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Άμεσα διαθέσιμη εγκατάσταση για αξιολόγηση ευπαθειών και δοκιμές διείσδυσης**. Εκτελέστε μια πλήρη δοκιμή διείσδυσης από οπουδήποτε με 20+ εργαλεία και χαρακτηριστικά που καλύπτουν από την αναγνώριση έως την αναφορά. Δεν αντικαθιστούμε τους δοκιμαστές διείσδυσης - αναπτύσσουμε προσαρμοσμένα εργαλεία, ανίχνευση και εκμετάλλευση ενοτήτων για να τους δώσουμε πίσω χρόνο για να εξερευνήσουν βαθύτερα, να ανοίξουν κελύφη και να διασκεδάσουν.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>Μάθετε το hacking στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας για το hacking υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
