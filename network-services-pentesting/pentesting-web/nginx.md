# Nginx

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con m√°s de una d√©cada que se celebrar√° el 7 y 8 de septiembre de 2023 en Bogot√°, Colombia. Es un evento de gran contenido t√©cnico donde se presentan las √∫ltimas investigaciones en espa√±ol que atrae a hackers e investigadores de todo el mundo.\
¬°Reg√≠strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

## Falta la ubicaci√≥n ra√≠z <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
La directiva root especifica la carpeta ra√≠z para Nginx. En el ejemplo anterior, la carpeta ra√≠z es `/etc/nginx`, lo que significa que podemos acceder a los archivos dentro de esa carpeta. La configuraci√≥n anterior no tiene una ubicaci√≥n para `/ (location / {...})`, solo para `/hello.txt`. Debido a esto, la directiva `root` se establecer√° de forma global, lo que significa que las solicitudes a `/` te llevar√°n a la ruta local `/etc/nginx`.

Una solicitud tan simple como `GET /nginx.conf` revelar√≠a el contenido del archivo de configuraci√≥n de Nginx almacenado en `/etc/nginx/nginx.conf`. Si la ra√≠z se establece en `/etc`, una solicitud `GET` a `/nginx/nginx.conf` revelar√≠a el archivo de configuraci√≥n. En algunos casos, es posible acceder a otros archivos de configuraci√≥n, registros de acceso e incluso credenciales cifradas para la autenticaci√≥n b√°sica de HTTP.

## Configuraci√≥n incorrecta de Alias LFI <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Dentro de la configuraci√≥n de Nginx, busca las declaraciones "location", si alguna se parece a:
```
location /imgs {
alias /path/images/;
}
```
Existe una vulnerabilidad de LFI debido a:
```
/imgs../flag.txt
```
# Nginx

Nginx is a popular web server that is commonly used to serve static content, reverse proxy, and load balance web applications. It is known for its high performance, scalability, and reliability.

## Configuration Files

Nginx uses configuration files to define how it should handle incoming requests. The main configuration file is typically located at `/etc/nginx/nginx.conf`. Additional configuration files can be included using the `include` directive.

## Virtual Hosts

Nginx supports virtual hosts, allowing multiple websites to be hosted on a single server. Each virtual host is defined in a separate configuration file, typically located in the `/etc/nginx/conf.d/` directory. Virtual hosts can be used to serve different websites based on the domain name or IP address.

## Reverse Proxy

Nginx can be used as a reverse proxy to forward requests to backend servers. This is useful for load balancing, caching, and improving performance. The `proxy_pass` directive is used to specify the backend server to which requests should be forwarded.

## Load Balancing

Nginx can also be used as a load balancer to distribute incoming requests across multiple backend servers. It supports various load balancing algorithms, such as round-robin, least connections, and IP hash. The `upstream` directive is used to define a group of backend servers, and the `proxy_pass` directive is used to forward requests to the backend servers.

## SSL/TLS Termination

Nginx can terminate SSL/TLS connections, allowing it to handle HTTPS requests. It can also be used to offload SSL/TLS processing from backend servers, improving performance. The `ssl_certificate` and `ssl_certificate_key` directives are used to specify the SSL/TLS certificate and private key, respectively.

## Security Considerations

When configuring Nginx, it is important to consider security best practices. This includes properly securing the server, implementing access controls, and protecting sensitive information. Regularly updating Nginx and its modules is also important to address any security vulnerabilities.

## Conclusion

Nginx is a powerful web server that offers a wide range of features and capabilities. Understanding how to configure and use Nginx effectively can greatly enhance the performance, scalability, and security of web applications.
```
/path/images/../flag.txt
```
La configuraci√≥n correcta ser√°:
```
location /imgs/ {
alias /path/images/;
}
```
**Entonces, si encuentras alg√∫n servidor Nginx, debes verificar esta vulnerabilidad. Adem√°s, puedes descubrirla si notas que la fuerza bruta de archivos/directorios se comporta de manera extra√±a.**

M√°s informaci√≥n: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Pruebas de Accunetix:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Restricci√≥n de ruta insegura <a href="#uso-de-variable-insegura" id="uso-de-variable-insegura"></a>

Verifica la siguiente p√°gina para aprender c√≥mo evadir directivas como:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Uso inseguro de variables <a href="#uso-inseguro-de-variables" id="uso-inseguro-de-variables"></a>

Un ejemplo de una configuraci√≥n vulnerable de Nginx es:
```
location / {
return 302 https://example.com$uri;
}
```
Los caracteres de nueva l√≠nea para las solicitudes HTTP son \r (retorno de carro) y \n (salto de l√≠nea). La codificaci√≥n de URL de los caracteres de nueva l√≠nea resulta en la siguiente representaci√≥n de los caracteres `%0d%0a`. Cuando estos caracteres se incluyen en una solicitud como `http://localhost/%0d%0aDetectify:%20clrf` a un servidor con la configuraci√≥n incorrecta, el servidor responder√° con una nueva cabecera llamada `Detectify`, ya que la variable $uri contiene los caracteres de nueva l√≠nea decodificados de la URL.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
Aprende m√°s sobre los riesgos de la inyecci√≥n de CRLF y la divisi√≥n de respuestas en [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/).

### Cualquier variable

En algunos casos, los datos proporcionados por el usuario pueden ser tratados como una variable de Nginx. No est√° claro por qu√© esto puede estar sucediendo, pero no es tan raro o f√°cil de probar como se ve en este [informe de H1](https://hackerone.com/reports/370094). Si buscamos el mensaje de error, podemos ver que se encuentra en el [m√≥dulo de filtro SSI](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx\_http\_ssi\_filter\_module.c#L365), revelando as√≠ que esto se debe a SSI.

Una forma de probar esto es establecer un valor de encabezado referer:
```
$ curl -H ‚ÄòReferer: bar‚Äô http://localhost/foo$http_referer | grep ‚Äòfoobar‚Äô
```
Escaneamos esta configuraci√≥n incorrecta y encontramos varias instancias donde un usuario podr√≠a imprimir el valor de las variables de Nginx. El n√∫mero de instancias vulnerables encontradas ha disminuido, lo que podr√≠a indicar que esto fue parcheado.

## Lectura de respuesta en bruto del backend

Con `proxy_pass` de Nginx, existe la posibilidad de interceptar errores y encabezados HTTP creados por el backend. Esto es muy √∫til si desea ocultar mensajes de error y encabezados internos para que sean manejados por Nginx en su lugar. Nginx autom√°ticamente servir√° una p√°gina de error personalizada si el backend responde con una. Pero, ¬øqu√© sucede si Nginx no entiende que es una respuesta HTTP?

Si un cliente env√≠a una solicitud HTTP inv√°lida a Nginx, esa solicitud se reenviar√° tal cual al backend, y el backend responder√° con su contenido en bruto. Luego, Nginx no entender√° la respuesta HTTP inv√°lida y simplemente la reenviar√° al cliente. Imagina una aplicaci√≥n uWSGI como esta:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
Y con las siguientes directivas en Nginx:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) servir√° una respuesta personalizada si el backend tiene un estado de respuesta mayor a 300. En nuestra aplicaci√≥n uWSGI anterior, enviaremos un `Error 500` que ser√° interceptado por Nginx.

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) es bastante autoexplicativo; ocultar√° cualquier encabezado HTTP especificado del cliente.

Si enviamos una solicitud `GET` normal, Nginx devolver√°:
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
Pero si enviamos una solicitud HTTP inv√°lida, como:
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
Obtendremos la siguiente respuesta:
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes establecido en off

La directiva [merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) est√° establecida en "on" de forma predeterminada, lo cual es un mecanismo para comprimir dos o m√°s barras diagonales en una sola, por lo que `///` se convertir√≠a en `/`. Si Nginx se utiliza como un proxy inverso y la aplicaci√≥n que se est√° proxyando es vulnerable a la inclusi√≥n local de archivos, el uso de barras diagonales adicionales en la solicitud podr√≠a dejar espacio para explotarla. Esto se describe en detalle por [Danny Robinson y Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d).

Encontramos 33 archivos de configuraci√≥n de Nginx con `merge_slashes` establecido en "off".

## default no est√° especificado para la directiva map

Parece ser un caso com√∫n cuando **`map` se utiliza para alg√∫n tipo de control de autorizaci√≥n**. Un ejemplo simplificado podr√≠a ser:
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[Seg√∫n el manual](https://nginx.org/en/docs/http/ngx\_http\_map\_module.html):

> valor por defecto\
> establece el valor resultante si el valor de origen no coincide con ninguno de los variantes especificados. Cuando no se especifica un valor por defecto,\
> el valor resultante por defecto ser√° una cadena vac√≠a.

Es f√°cil olvidarse del valor `default`. Por lo tanto, **un malhechor puede evadir este "control de autorizaci√≥n"** simplemente accediendo a un **caso inexistente dentro de `/map-poc`** como `https://targethost.com/map-poc/another-private-area`.

## Suplantaci√≥n de DNS en Nginx

Seg√∫n esta publicaci√≥n: [http://blog.zorinaq.com/nginx-resol**ver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/) **Podr√≠a ser posible suplantar registros DNS** en Nginx si **conoces el servidor DNS que Nginx** est√° utilizando (y puedes interceptar de alguna manera la comunicaci√≥n, por lo que esto **no es v√°lido si se utiliza 127.0.0.1**) y el **dominio que est√° solicitando**.

Nginx puede especificar un servidor DNS para usar con:
```
resolver     8.8.8.8;
```
## Directivas `proxy_pass` e `internal`

La directiva **`proxy_pass`** se puede utilizar para **redirigir internamente las solicitudes a otros servidores** internos o externos.\
La directiva **`internal`** se utiliza para dejar claro a Nginx que la **ubicaci√≥n solo se puede acceder internamente**.

El uso de estas directivas **no es una vulnerabilidad, pero se debe verificar c√≥mo est√°n configuradas**.

## proxy\_set\_header Upgrade & Connection

Si el servidor nginx est√° configurado para pasar los encabezados Upgrade y Connection, se podr√≠a realizar un [**ataque de h2c Smuggling**](../../pentesting-web/h2c-smuggling.md) para acceder a puntos finales protegidos/internos.

{% hint style="danger" %}
Esta vulnerabilidad permitir√≠a a un atacante **establecer una conexi√≥n directa con el punto final `proxy_pass`** (`http://backend:9999` en este caso) cuyo contenido no ser√° verificado por nginx.
{% endhint %}

Ejemplo de configuraci√≥n vulnerable para robar `/flag` de [aqu√≠](https://bishopfox.com/blog/h2c-smuggling-request):
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Ten en cuenta que incluso si `proxy_pass` apunta a una **ruta** espec√≠fica como `http://backend:9999/socket.io`, la conexi√≥n se establecer√° con `http://backend:9999`, por lo que puedes **contactar cualquier otra ruta dentro de ese punto final interno. Por lo tanto, no importa si se especifica una ruta en la URL de proxy\_pass.**
{% endhint %}

## Pru√©balo t√∫ mismo

Detectify ha creado un repositorio en GitHub donde puedes usar Docker para configurar tu propio servidor de prueba vulnerable de Nginx con algunas de las configuraciones incorrectas discutidas en este art√≠culo y tratar de encontrarlas t√∫ mismo.

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Herramientas de an√°lisis est√°tico

### [GIXY](https://github.com/yandex/gixy)

Gixy es una herramienta para analizar la configuraci√≥n de Nginx. El objetivo principal de Gixy es prevenir la configuraci√≥n incorrecta de seguridad y automatizar la detecci√≥n de fallas.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner es una herramienta sencilla para buscar configuraciones incorrectas comunes y vulnerabilidades de Nginx.

## Referencias

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference es un evento internacional de ciberseguridad**](https://www.dragonjarcon.org/) con m√°s de una d√©cada que se celebrar√° el 7 y 8 de septiembre de 2023 en Bogot√°, Colombia. Es un evento de gran contenido t√©cnico donde se presentan las √∫ltimas investigaciones en espa√±ol que atrae a hackers e investigadores de todo el mundo.\
¬°Reg√≠strate ahora en el siguiente enlace y no te pierdas esta gran conferencia!:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
