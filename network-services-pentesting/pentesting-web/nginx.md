# Nginx

<details>

<summary><strong>从零到英雄学习AWS黑客技术，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference是一个国际网络安全事件**](https://www.dragonjarcon.org/)，已经有十多年的历史，将于2023年9月7日和8日在哥伦比亚波哥大举行。这是一个技术内容丰富的活动，会展示最新的西班牙语研究，吸引了来自世界各地的黑客和研究人员。\
现在就在以下链接注册，不要错过这个盛大的会议！:

{% embed url="https://www.dragonjarcon.org/" %}

## 缺失的根位置 <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
`root` 指令指定了 Nginx 的根文件夹。在上面的例子中，根文件夹是 `/etc/nginx`，这意味着我们可以访问该文件夹内的文件。上述配置没有为 `/ (location / {...})` 设置位置，只为 `/hello.txt` 设置了位置。因此，`root` 指令将被全局设置，这意味着对 `/` 的请求将导航到本地路径 `/etc/nginx`。

一个简单的 `GET /nginx.conf` 请求将揭示存储在 `/etc/nginx/nginx.conf` 中的 Nginx 配置文件的内容。如果根目录设置为 `/etc`，对 `/nginx/nginx.conf` 的 `GET` 请求将揭示配置文件。在某些情况下，可能会访问到其他配置文件、访问日志，甚至是 HTTP 基本认证的加密凭据。

## 别名 LFI 配置错误 <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

在 Nginx 配置中查看 "location" 语句，如果有人看起来像：
```
location /imgs {
alias /path/images/;
}
```
存在LFI漏洞，因为：
```
/imgs../flag.txt
```
```markdown
# Nginx 网络服务渗透测试

## 信息收集

### Nginx 版本

默认情况下，Nginx 会在错误页面和响应头中泄露其版本信息。这可以通过发送一个错误请求来检测，例如请求一个不存在的页面。

```bash
curl -I http://example.com/nonexistentpage
```

如果服务器配置不当，响应头 `Server` 字段可能会显示 Nginx 版本，如 `Server: nginx/1.16.1`。

### 配置文件泄露

Nginx 配置文件（通常是 `/etc/nginx/nginx.conf`）包含重要信息，如果泄露，可能会导致安全风险。攻击者可以尝试直接访问这些文件，看是否可以从 web 服务器下载。

```bash
curl http://example.com/nginx.conf
```

### 目录遍历

如果 Nginx 配置不当，攻击者可能能够通过目录遍历漏洞访问敏感文件。例如，通过使用 `../` 来尝试访问父目录中的文件。

```bash
curl http://example.com/../etc/passwd
```

## 漏洞利用

### 默认文件和目录

Nginx 服务器可能包含默认文件和目录，这些可能包含敏感信息。攻击者应该检查这些资源，例如默认的 `50x.html` 错误页面。

```bash
curl http://example.com/50x.html
```

### 服务器端请求伪造（SSRF）

SSRF 漏洞允许攻击者通过受影响的服务器发送创建的请求。在 Nginx 中，如果 `resolver` 配置不当，可能会导致 SSRF。

### 远程代码执行（RCE）

如果 Nginx 与其他服务（如 PHP-FPM）集成不当，可能会导致 RCE 漏洞。攻击者可以利用这些漏洞执行恶意代码。

## 安全加固

### 版本隐藏

为了防止版本信息泄露，应该在 Nginx 配置中设置 `server_tokens off;`。

### 最小化权限

确保 Nginx 进程以最小权限运行，例如使用专用的低权限用户账户。

### 定期更新

定期更新 Nginx 以修复已知漏洞。

### 使用安全模块

使用如 ModSecurity 等安全模块可以增强 Nginx 的安全性。

## 结论

Nginx 是一个强大的 web 服务器，但如果配置不当，可能会暴露于多种安全风险。通过适当的信息收集、漏洞利用和安全加固，可以显著降低这些风险。
```
```
/path/images/../flag.txt
```
正确的配置将是：
```
location /imgs/ {
alias /path/images/;
}
```
**因此，如果您发现某个Nginx服务器，您应该检查这个漏洞。同时，如果您发现文件/目录暴力破解行为异常，也可以发现它。**

更多信息：[https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix 测试：
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## 不安全的路径限制 <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

查看以下页面，了解如何绕过像这样的指令：
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## 不安全变量使用 <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

一个存在漏洞的 Nginx 配置示例是：
```
location / {
return 302 https://example.com$uri;
}
```
HTTP请求的新行字符是`\r`（回车）和`\n`（换行）。URL编码新行字符会得到字符的以下表示`%0d%0a`。当这些字符被包含在像`http://localhost/%0d%0aDetectify:%20clrf`这样的请求中发送到配置错误的服务器时，服务器会响应一个名为`Detectify`的新头部，因为$uri变量包含了URL解码的新行字符。
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
了解更多关于CRLF注入和响应拆分的风险，请访问 [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/)。

### 任意变量

在某些情况下，用户提供的数据可能会被当作Nginx变量处理。为什么会这样发生尚不清楚，但这并不罕见，也不容易测试，正如这个 [H1报告](https://hackerone.com/reports/370094)中所见。如果我们搜索错误信息，我们可以发现它出现在 [SSI过滤模块](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365)，因此揭示了这是由于SSI造成的。

测试这一点的一种方法是设置一个referer头的值：
```
$ curl -H ‘Referer: bar’ http://localhost/foo$http_referer | grep ‘foobar’
```
我们扫描了这种错误配置，并发现了几个实例，用户可以打印Nginx变量的值。发现的易受攻击实例数量有所下降，这可能表明已经进行了修补。

## 原始后端响应读取

使用Nginx的`proxy_pass`，有可能拦截后端创建的错误和HTTP头。如果你想隐藏内部错误消息和头，以便它们由Nginx处理，这非常有用。如果后端回答错误页面，Nginx将自动提供自定义错误页面。但如果Nginx不理解这是一个HTTP响应怎么办？

如果客户端向Nginx发送无效的HTTP请求，该请求将原样转发给后端，后端将以其原始内容回答。然后，Nginx不会理解无效的HTTP响应，只是将其转发给客户端。想象一下这样的uWSGI应用程序：
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
以下是Nginx中的指令：
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) 如果后端的响应状态码大于300，将提供自定义响应。在我们上面的uWSGI应用程序中，我们将发送一个`500 Error`，这将被Nginx拦截。

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) 的含义非常直接；它将隐藏客户端指定的任何HTTP头。

如果我们发送一个正常的`GET`请求，Nginx将返回：
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
但如果我们发送一个无效的HTTP请求，例如：
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
我们将得到以下响应：
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes 设置为 off

[merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) 指令默认设置为“on”，这是一种机制，用于将两个或更多的正斜杠压缩成一个，因此 `///` 会变成 `/`。如果 Nginx 被用作反向代理，并且被代理的应用程序容易受到本地文件包含的攻击，那么在请求中使用额外的斜杠可能会留下可供利用的空间。这一点由 [Danny Robinson 和 Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) 详细描述。

我们发现了 33 个 Nginx 配置文件将 `merge_slashes` 设置为 “off”。

## map 指令未指定默认值

当**`map` 被用于某种授权控制**时，这似乎是一个常见的情况。简化的例子可能看起来像：
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[根据手册](https://nginx.org/en/docs/http/ngx_http_map_module.html)：

> 默认值\
> 如果源值与指定的变体都不匹配，则设置结果值。当未指定默认值时，\
> 默认的结果值将是一个空字符串。

很容易忘记`default`值。因此，**攻击者可以通过简单地访问`/map-poc`中的一个**不存在的情况来绕过这种“授权控制”，例如`https://targethost.com/map-poc/another-private-area`。

## DNS Spoofing Nginx

根据这篇文章：[http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **可能可以对Nginx进行DNS记录欺骗**，如果你**知道Nginx正在使用的DNS服务器**（并且你可以以某种方式拦截通信，所以如果使用的是127.0.0.1，这**不适用）以及它**正在询问的域名**。

Nginx可以指定使用的DNS服务器：
```
resolver     8.8.8.8;
```
## `proxy_pass` 和 `internal` 指令

**`proxy_pass`** 指令可以用来**将请求内部重定向到其他服务器**，无论是内部的还是外部的。\
**`internal`** 指令用于明确告诉 Nginx，**位置只能内部访问**。

这些指令的使用**不是一个漏洞，但你应该检查它们是如何配置的**。

## proxy\_set\_header Upgrade & Connection

如果 nginx 服务器配置为传递 Upgrade 和 Connection 头，那么可以执行 [**h2c Smuggling 攻击**](../../pentesting-web/h2c-smuggling.md) 来访问受保护的/内部端点。

{% hint style="danger" %}
这个漏洞将允许攻击者**与 `proxy_pass` 端点建立直接连接**（在这个例子中是 `http://backend:9999`），其内容不会被 nginx 检查。
{% endhint %}

以下是一个易受攻击的配置示例，用于从[这里](https://bishopfox.com/blog/h2c-smuggling-request)窃取 `/flag`：
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
请注意，即使 `proxy_pass` 指向一个特定的**路径**，如 `http://backend:9999/socket.io`，连接也会与 `http://backend:9999` 建立，所以你可以**联系该内部端点内的任何其他路径。因此，proxy\_pass 的 URL 中指定的路径并不重要。**
{% endhint %}

## 亲自尝试

Detectify 创建了一个 GitHub 仓库，您可以使用 Docker 在自己的电脑上搭建一个存在本文讨论的一些配置错误的易受攻击的 Nginx 测试服务器，并尝试自己找出这些问题！

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## 静态分析工具

### [GIXY](https://github.com/yandex/gixy)

Gixy 是一个用于分析 Nginx 配置的工具。Gixy 的主要目标是防止安全配置错误并自动检测缺陷。

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner 是一个用于寻找常见 Nginx 配置错误和漏洞的简单工具。

## 参考资料

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="../../.gitbook/assets/image (1) (1) (2) (4).png" alt=""><figcaption></figcaption></figure>

[**DragonJAR Security Conference 是一个国际性的网络安全事件**](https://www.dragonjarcon.org/)，已经举办了十多年，将于 2023 年 9 月 7 日和 8 日在哥伦比亚的波哥大举行。这是一个技术内容丰富的活动，会展示最新的西班牙语研究成果，吸引了来自世界各地的黑客和研究人员。
立即在以下链接注册，不要错过这个重要的会议！:

{% embed url="https://www.dragonjarcon.org/" %}

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 来**分享您的黑客技巧。

</details>
