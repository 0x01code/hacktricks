# Nginx

<details>

<summary><strong>零基础学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**即刻可用的漏洞评估和渗透测试设置**。从任何地方运行完整的渗透测试，拥有20多个工具和功能，从侦察到报告。我们不替代渗透测试人员 - 我们开发定制工具、检测和利用模块，以便他们有更多时间深入挖掘、弹出shell，并享受乐趣。

{% embed url="https://pentest-tools.com/" %}

## 缺失的根位置 <a href="#missing-root-location" id="missing-root-location"></a>
```
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
`root` 指令指定了 Nginx 的根文件夹。在上面的例子中，根文件夹是 `/etc/nginx`，这意味着我们可以访问该文件夹内的文件。上述配置没有为 `/ (location / {...})` 设置位置，只为 `/hello.txt` 设置了位置。因此，`root` 指令将被全局设置，这意味着对 `/` 的请求将带你到本地路径 `/etc/nginx`。

一个简单的请求 `GET /nginx.conf` 将会显示存储在 `/etc/nginx/nginx.conf` 中的 Nginx 配置文件的内容。如果根目录设置为 `/etc`，一个对 `/nginx/nginx.conf` 的 `GET` 请求将会显示配置文件。在某些情况下，可能可以访问其他配置文件、访问日志，甚至是 HTTP 基本认证的加密凭证。

## 别名 LFI 配置错误 <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

在 Nginx 配置中查看 "location" 语句，如果有人看起来像：
```
location /imgs {
alias /path/images/;
}
```
```markdown
因为以下原因存在本地文件包含（LFI）漏洞：
```
```
/imgs../flag.txt
```
```markdown
# Nginx 网络服务渗透测试

## 信息收集

### Nginx 版本

默认情况下，Nginx 会在错误页面和响应头中泄露其版本信息。这可以通过发送一个错误请求（如请求不存在的页面）来触发。例如：

```bash
curl -I http://example.com/nonexistentpage
```

这可能会返回包含 Nginx 版本的响应头。

### 配置文件泄露

Nginx 配置文件（通常是 `/etc/nginx/nginx.conf`）包含重要信息，如果泄露，可能会导致安全风险。攻击者可以尝试直接访问这些文件，看看是否可以从 web 服务器上下载它们。

## 漏洞利用

### 目录遍历

如果 Nginx 配置不当，攻击者可能能够利用目录遍历漏洞来访问不应该公开的文件。例如，通过修改 URL 中的路径来尝试访问系统文件。

### 服务器端请求伪造（SSRF）

SSRF 漏洞允许攻击者通过受影响的服务器发送创建的请求。在 Nginx 中，如果不正确配置 `proxy_pass` 指令，可能会导致 SSRF。

## 防御措施

### 最小化版本泄露

可以通过编辑 Nginx 配置文件来隐藏版本信息。在 `http` 块中添加以下指令：

```nginx
server_tokens off;
```

这将阻止 Nginx 在错误页面和响应头中显示版本号。

### 限制访问

应该限制对敏感文件和目录的访问。这可以通过在 Nginx 配置中使用 `location` 指令来实现，例如：

```nginx
location ~* /(敏感目录|文件) {
    deny all;
}
```

### 使用安全的配置

确保 Nginx 配置是安全的，避免出现漏洞。这包括正确设置权限、使用 SSL/TLS 加密通信，以及定期更新和打补丁。

## 工具和资源

- [Nmap](https://nmap.org/): 网络映射工具，可以用来发现运行 Nginx 的服务器。
- [Nikto](https://cirt.net/Nikto2): Web 服务器扫描工具，可以检测多种安全问题，包括 Nginx 配置问题。
- [Gobuster](https://github.com/OJ/gobuster): 用于暴力破解 URI（目录和文件名）和 DNS 子域的工具。

## 结论

Nginx 是一个强大的 web 服务器，但如果配置不当，可能会暴露于多种安全风险。通过了解和应用正确的渗透测试技术，可以识别和缓解这些风险。
```
```
/path/images/../flag.txt
```
正确的配置将是：
```
location /imgs/ {
alias /path/images/;
}
```
**因此，如果您发现某个Nginx服务器，您应该检查这个漏洞。同时，如果您发现文件/目录暴力破解的行为异常，也可能发现此漏洞。**

更多信息：[https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Acunetix测试：
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## 不安全的路径限制 <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

查看以下页面，了解如何绕过像这样的指令：
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
{% content-ref url="../../pentesting-web/proxy-waf-protections-bypass.md" %}
[proxy-waf-protections-bypass.md](../../pentesting-web/proxy-waf-protections-bypass.md)
{% endcontent-ref %}

## 不安全变量使用 <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

一个存在漏洞的Nginx配置示例是：
```
location / {
return 302 https://example.com$uri;
}
```
HTTP请求的换行字符是`\r`（回车）和`\n`（换行）。对换行字符进行URL编码会得到字符的以下表示`%0d%0a`。当这些字符包含在像`http://localhost/%0d%0aDetectify:%20clrf`这样的请求中发送到配置错误的服务器时，服务器会响应一个名为`Detectify`的新头部，因为$uri变量包含了URL解码的换行字符。
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
了解更多关于CRLF注入和响应拆分的风险，请访问 [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/)。

### 任意变量

在某些情况下，用户提供的数据可能会被当作Nginx变量处理。为什么会这样发生尚不清楚，但这并不罕见，也不容易测试，正如这个 [H1报告](https://hackerone.com/reports/370094)所示。如果我们搜索错误信息，我们可以看到它出现在 [SSI过滤模块](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365)，因此揭示了这是由于SSI造成的。

测试这一点的一种方法是设置一个referer头部值：
```
$ curl -H ‘Referer: bar’ http://localhost/foo$http_referer | grep ‘foobar’
```
我们扫描了这种错误配置，并发现了几个实例，用户可以打印Nginx变量的值。发现的易受攻击实例数量有所下降，这可能表明已经进行了修补。

## 原始后端响应读取

使用Nginx的`proxy_pass`，有可能拦截后端创建的错误和HTTP头。如果你想隐藏内部错误消息和头部，让Nginx来处理，这非常有用。如果后端回答错误，Nginx将自动提供自定义错误页面。但如果Nginx不理解这是一个HTTP响应怎么办？

如果客户端向Nginx发送无效的HTTP请求，该请求将原样转发给后端，后端将以其原始内容回答。然后，Nginx不会理解无效的HTTP响应，只会将其转发给客户端。想象一下这样的uWSGI应用程序：
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type',
'text/html'),('Secret-Header','secret-info')])
return [b"Secret info, should not be visible!"]
```
以下是Nginx中的指令：
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
[proxy\_intercept\_errors](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_intercept\_errors) 如果后端的响应状态码大于300，将提供自定义响应。在我们上面的uWSGI应用程序中，我们将发送一个`500 Error`，这将被Nginx拦截。

[proxy\_hide\_header](http://nginx.org/en/docs/http/ngx\_http\_proxy\_module.html#proxy\_hide\_header) 的含义相当直接；它将隐藏客户端指定的任何HTTP头。

如果我们发送一个普通的`GET`请求，Nginx将返回：
```
HTTP/1.1 500 Internal Server Error
Server: nginx/1.10.3
Content-Type: text/html
Content-Length: 34
Connection: close
```
但如果我们发送一个无效的HTTP请求，例如：
```
GET /? XTTP/1.1
Host: 127.0.0.1
Connection: close
```
我们将得到以下响应：
```
XTTP/1.1 500 Error
Content-Type: text/html
Secret-Header: secret-info

Secret info, should not be visible!
```
## merge\_slashes 设置为 off

[merge\_slashes](http://nginx.org/en/docs/http/ngx\_http\_core\_module.html#merge\_slashes) 指令默认设置为“on”，这是一种机制，用于将两个或更多的正斜杠压缩成一个，因此 `///` 会变成 `/`。如果 Nginx 被用作反向代理，并且被代理的应用程序容易受到本地文件包含的攻击，那么在请求中使用额外的斜杠可能会留下可供利用的空间。这一点由 [Danny Robinson 和 Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) 详细描述。

我们发现了 33 个 Nginx 配置文件将 `merge_slashes` 设置为 “off”。

## map 指令未指定默认值

当**`map` 被用于某种授权控制**时，这似乎是一个常见的情况。简化的例子可能看起来像：
```
http {
...
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
...
}
```

```
server {
...
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
...
}
```
[根据手册](https://nginx.org/en/docs/http/ngx_http_map_module.html)：

> default value\
> 如果源值与指定的任何变体都不匹配，则设置结果值。当未指定 default 时，\
> 默认的结果值将是一个空字符串。

很容易忘记 `default` 值。因此，**攻击者可以通过简单地访问 `/map-poc` 中的**一个**不存在的情况**来绕过这种“授权控制”，例如 `https://targethost.com/map-poc/another-private-area`。

## DNS Spoofing Nginx

根据这篇文章：[http://blog.zorinaq.com/nginx-resolver-vulns/](http://blog.zorinaq.com/nginx-resolver-vulns/) **可能可以对 Nginx 进行 DNS 记录欺骗**，如果你**知道 Nginx 使用的 DNS 服务器**（并且你可以以某种方式拦截通信，所以如果使用的是 127.0.0.1 则**不适用**）以及它**请求的域名**。

Nginx 可以指定使用的 DNS 服务器：
```
resolver     8.8.8.8;
```
## `proxy_pass` 和 `internal` 指令

**`proxy_pass`** 指令可以用来**将请求内部重定向到其他服务器**，无论是内部的还是外部的。\
**`internal`** 指令用于明确告诉 Nginx，**位置只能内部访问**。

这些指令的使用**不是一个漏洞，但你应该检查它们是如何配置的**。

## proxy\_set\_header Upgrade 和 Connection

如果 nginx 服务器配置为传递 Upgrade 和 Connection 头，那么可以执行 [**h2c Smuggling 攻击**](../../pentesting-web/h2c-smuggling.md) 来访问受保护的/内部端点。

{% hint style="danger" %}
这个漏洞将允许攻击者**与 `proxy_pass` 端点建立直接连接**（在这个例子中是 `http://backend:9999`），其内容不会被 nginx 检查。
{% endhint %}

以下是一个易受攻击的配置示例，用于从[这里](https://bishopfox.com/blog/h2c-smuggling-request)窃取 `/flag`：
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
请注意，即使 `proxy_pass` 指向一个特定的**路径**，例如 `http://backend:9999/socket.io`，连接也会与 `http://backend:9999` 建立，所以你可以**联系该内部端点内的任何其他路径。因此，proxy\_pass 的 URL 中指定的路径并不重要。**
{% endhint %}

## 亲自尝试

Detectify 创建了一个 GitHub 仓库，您可以使用 Docker 在其中设置自己的易受攻击的 Nginx 测试服务器，这些服务器包含本文讨论的一些错误配置，并尝试自己找到它们！

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## 静态分析工具

### [GIXY](https://github.com/yandex/gixy)

Gixy 是一个用于分析 Nginx 配置的工具。Gixy 的主要目标是防止安全配置错误并自动检测缺陷。

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner 是一个简单的工具，用于寻找常见的 Nginx 错误配置和漏洞。

## 参考资料

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**即时可用的漏洞评估和渗透测试设置**。从任何地方运行完整的渗透测试，拥有从侦察到报告的 20 多种工具和功能。我们不替代渗透测试人员 - 我们开发定制工具、检测和利用模块，以便他们有更多时间深入挖掘、弹出 shell，并享受乐趣。

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub 仓库提交 PR 来分享您的黑客技巧。

</details>
