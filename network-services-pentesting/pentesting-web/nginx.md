# Nginx

<details>

<summary><strong>AWS hackleme becerilerini sıfırdan ileri seviyeye öğrenmek için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>'ya</strong> katıl<strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Her yerden erişilebilir bir şekilde zafiyet değerlendirmesi ve penetrasyon testi kurulumu**. Keşiften raporlamaya kadar 20'den fazla araç ve özellikle tam bir pentest çalıştırın. Pentester'ları değiştirmiyoruz - onlara daha derine kazma, kabuk açma ve eğlenme zamanı kazandırmak için özel araçlar, tespit ve istismar modülleri geliştiriyoruz.

{% embed url="https://pentest-tools.com/" %}

## Eksik kök konumu <a href="#missing-root-location" id="missing-root-location"></a>

## **Nginx Kök Dizin Yapılandırmanın Temelleri**

Nginx sunucusunu yapılandırırken, **kök yönergesi** dosyaların sunulduğu temel dizini tanımlayarak önemli bir rol oynar. Aşağıdaki örneği düşünün:
```bash
server {
root /etc/nginx;

location /hello.txt {
try_files $uri $uri/ =404;
proxy_pass http://127.0.0.1:8080/;
}
}
```
Bu yapılandırmada, `/etc/nginx` kök dizini olarak belirlenmiştir. Bu yapı, `/hello.txt` gibi belirtilen kök dizini içindeki dosyalara erişime izin verir. Ancak, yalnızca belirli bir konum (`/hello.txt`) tanımlanmıştır. Kök konumu (`location / {...}`) için herhangi bir yapılandırma bulunmamaktadır. Bu eksiklik, kök yönergesinin genel olarak uygulanmasını sağlar ve `/` kök yolu altındaki dosyalara erişim sağlar.

Bu yapılandırmadan kaynaklanan önemli bir güvenlik düşüncesi ortaya çıkar. `/nginx.conf` gibi basit bir `GET` isteği, `/etc/nginx/nginx.conf` konumunda bulunan Nginx yapılandırma dosyasını sunarak hassas bilgilerin ortaya çıkmasına neden olabilir. Kökü daha az hassas bir dizine, örneğin `/etc` olarak ayarlamak, bu riski azaltabilir, ancak diğer yapılandırma dosyaları, erişim günlükleri ve hatta HTTP temel kimlik doğrulaması için kullanılan şifrelenmiş kimlik bilgilerine istenmeyen erişime izin verebilir.

## Alias LFI Yanlış Yapılandırması <a href="#alias-lfi-misconfiguration" id="alias-lfi-misconfiguration"></a>

Nginx'in yapılandırma dosyalarında, "location" yönergeleri için dikkatli bir inceleme gerekmektedir. Yanlışlıkla Local File Inclusion (LFI) olarak bilinen bir güvenlik açığı, aşağıdakine benzeyen bir yapılandırma ile yanlışlıkla tanıtılabilir:
```
location /imgs {
alias /path/images/;
}
```
Bu yapılandırma, sunucunun `/imgs../flag.txt` gibi istekleri, amaçlanan dizinin dışındaki dosyalara erişim girişimi olarak yorumlaması nedeniyle LFI saldırılarına karşı savunmasızdır. Bu, `/path/images/../flag.txt` olarak çözümlenerek, saldırganların web üzerinden erişilememesi gereken dosyaları sunucunun dosya sisteminde almasına olanak tanır.

Bu zafiyeti azaltmak için yapılandırma şu şekilde ayarlanmalıdır:
```
location /imgs/ {
alias /path/images/;
}
```
Daha fazla bilgi: [https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/](https://www.acunetix.com/vulnerabilities/web/path-traversal-via-misconfigured-nginx-alias/)

Accunetix testleri:
```
alias../ => HTTP status code 403
alias.../ => HTTP status code 404
alias../../ => HTTP status code 403
alias../../../../../../../../../../../ => HTTP status code 400
alias../ => HTTP status code 403
```
## Güvensiz yol kısıtlaması <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Direktifleri atlamak için aşağıdaki sayfayı kontrol edin:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
## Güvensiz değişken kullanımı <a href="#unsafe-variable-use" id="unsafe-variable-use"></a>

Nginx yapılandırmasındaki bir zafiyet aşağıdaki örnekle gösterilmektedir:
```
location / {
return 302 https://example.com$uri;
}
```
Karakterler \r (Taşıma İadesi) ve \n (Satır Beslemesi), HTTP isteklerinde yeni satır karakterlerini temsil eder ve URL kodlu formları `%0d%0a` olarak gösterilir. Bu karakterleri bir istekte (örneğin, `http://localhost/%0d%0aDetectify:%20clrf`) hatalı yapılandırılmış bir sunucuya dahil etmek, sunucunun `Detectify` adında yeni bir başlık çıkarmasına neden olur. Bu, $uri değişkeninin URL kodlu yeni satır karakterlerini çözmesi sonucunda beklenmeyen bir başlık oluşur.
```
HTTP/1.1 302 Moved Temporarily
Server: nginx/1.19.3
Content-Type: text/html
Content-Length: 145
Connection: keep-alive
Location: https://example.com/
Detectify: clrf
```
CRLF enjeksiyonu ve yanıt bölünmesi riskleri hakkında daha fazla bilgi için [https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/](https://blog.detectify.com/2019/06/14/http-response-splitting-exploitations-and-mitigations/) adresini ziyaret edin.

### Herhangi bir değişken

Belirli durumlarda, **kullanıcı tarafından sağlanan verilerin** Nginx değişkeni olarak işlenebileceği keşfedildi. Bu davranışın nedeni biraz belirsiz olsa da, nadir değildir ve doğrulaması kolay değildir. Bu anormallik, HackerOne'da yayınlanan bir güvenlik raporunda vurgulanmıştır ve [buradan](https://hackerone.com/reports/370094) görülebilir. Hata mesajının daha fazla incelenmesi, Nginx'in kod tabanındaki [SSI filtre modülünde](https://github.com/nginx/nginx/blob/2187586207e1465d289ae64cedc829719a048a39/src/http/modules/ngx_http_ssi_filter_module.c#L365) bu hatanın meydana geldiğinin tespit edilmesine yol açmıştır ve Server Side Includes (SSI) bunun temel nedeni olarak belirlenmiştir.

Bu yanlış yapılandırmayı **tespit etmek** için aşağıdaki komut çalıştırılabilir, bu komut değişken yazdırma testi için bir referer başlığı ayarlamayı içerir:
```bash
$ curl -H ‘Referer: bar’ http://localhost/foo$http_referer | grep ‘foobar’
```
Sistemler üzerinde yapılan taramalar, kullanıcı tarafından Nginx değişkenlerinin yazdırılabileceği birden fazla durumu ortaya çıkardı. Ancak, savunmasız durumların sayısında yaşanan azalma, bu sorunu düzeltme çabalarının kısmen başarılı olduğunu göstermektedir.

## Ham arka uç yanıtı okuma


Nginx, `proxy_pass` aracılığıyla sunulan bir özellik sunar. Bu özellik, arka uç tarafından üretilen hataları ve HTTP başlıklarını yakalamayı amaçlar ve dahili hata mesajlarını ve başlıklarını gizlemeyi hedefler. Bunun için Nginx, arka uç hatalarına yanıt olarak özel hata sayfaları sunar. Ancak, Nginx geçersiz bir HTTP isteğiyle karşılaştığında zorluklar ortaya çıkar. Bu tür bir istek, alındığı gibi arka uca iletilir ve arka uçun ham yanıtı doğrudan Nginx'in müdahalesi olmadan istemciye gönderilir.

Bir uWSGI uygulamasını içeren bir örnek senaryoyu düşünelim:
```python
def application(environ, start_response):
start_response('500 Error', [('Content-Type', 'text/html'), ('Secret-Header', 'secret-info')])
return [b"Secret info, should not be visible!"]
```
Bu işlemi yönetmek için, Nginx yapılandırmasında belirli yönergeler kullanılır:
```
http {
error_page 500 /html/error.html;
proxy_intercept_errors on;
proxy_hide_header Secret-Header;
}
```
- **[proxy_intercept_errors](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_intercept_errors)**: Bu yönerge, Nginx'in, durum kodu 300'den büyük olan arka uç yanıtları için özel bir yanıt sunmasını sağlar. Örneğimizdeki uWSGI uygulaması için, `500 Hata` yanıtının Nginx tarafından yakalanıp işlenmesini sağlar.
- **[proxy_hide_header](http://nginx.org/en/docs/http/ngx_http_proxy_module.html#proxy_hide_header)**: Adından da anlaşılacağı gibi, bu yönerge belirtilen HTTP başlıklarını istemciden gizler, gizlilik ve güvenliği artırır.

Geçerli bir `GET` isteği yapıldığında, Nginx bunu normal şekilde işler ve gizli başlıkları ifşa etmeden standart bir hata yanıtı döndürür. Ancak geçersiz bir HTTP isteği, bu mekanizmayı atlayarak, gizli başlıkları ve hata mesajlarını da içeren ham arka uç yanıtlarının ortaya çıkmasına neden olur.


## merge\_slashes off olarak ayarlandı

Varsayılan olarak, Nginx'in **`merge_slashes` yönergesi** **`on`** olarak ayarlanmıştır ve bir URL'deki birden fazla eğik çizgiyi tek bir eğik çizgiye sıkıştırır. Bu özellik, URL işleme sürecini kolaylaştırırken, özellikle Nginx'in arkadan proxy olarak kullanıldığı uygulamalarda yerel dosya dahil etme (LFI) saldırılarına karşı hassas olan uygulamalardaki güvenlik açıklarını yanlışlıkla gizleyebilir. Güvenlik uzmanları **Danny Robinson ve Rotem Bar**, özellikle Nginx'in ters proxy olarak kullanıldığı durumlarda, bu varsayılan davranışla ilişkili potansiyel riskleri vurgulamışlardır.

Bu tür riskleri azaltmak için, bu zafiyetlere duyarlı uygulamalar için **`merge_slashes` yönergesini kapatmanız** önerilir. Bu, Nginx'in istekleri URL yapısını değiştirmeden uygulamaya ilettiği ve altta yatan güvenlik sorunlarını gizlemediği anlamına gelir.

Daha fazla bilgi için [Danny Robinson ve Rotem Bar](https://medium.com/appsflyer/nginx-may-be-protecting-your-applications-from-traversal-attacks-without-you-even-knowing-b08f882fd43d) adresini kontrol edin.

### **Map Yönergesindeki Varsayılan Değer**

**Nginx yapılandırmasında**, `map` yönergesi genellikle **yetkilendirme kontrolünde** rol oynar. Yaygın bir hata, bir **varsayılan** değer belirtmemektir, bu da yetkisiz erişime yol açabilir. Örneğin:
```yaml
http {
map $uri $mappocallow {
/map-poc/private 0;
/map-poc/secret 0;
/map-poc/public 1;
}
}
```

```yaml
server {
location /map-poc {
if ($mappocallow = 0) {return 403;}
return 200 "Hello. It is private area: $mappocallow";
}
}
```
`default` olmadan, **kötü niyetli bir kullanıcı**, `/map-poc` içinde **tanımlanmamış bir URI'ye** erişerek güvenliği atlayabilir. [Nginx kılavuzu](https://nginx.org/en/docs/http/ngx_http_map_module.html), bu tür sorunları önlemek için bir **varsayılan değer** belirlemenizi önermektedir.

### **DNS Sahtecilik Zafiyeti**

Belirli koşullar altında Nginx'e karşı DNS sahteciliği mümkündür. Bir saldırgan, Nginx'in kullandığı **DNS sunucusunu** biliyor ve DNS sorgularını onaylayabiliyorsa, DNS kayıtlarını sahtecilik yapabilir. Ancak bu yöntem, Nginx'in DNS çözümlemesi için **localhost (127.0.0.1)** kullanacak şekilde yapılandırıldığında etkisizdir. Nginx, bir DNS sunucusunu aşağıdaki gibi belirtmeye izin verir:
```yaml
resolver 8.8.8.8;
```
### **`proxy_pass` ve `internal` Komutları**

**`proxy_pass`** komutu, istekleri başka sunuculara yönlendirmek için kullanılır, hem içeride hem de dışarıda. **`internal`** komutu ise belirli konumlara sadece Nginx içerisinden erişilebilmesini sağlar. Bu komutlar başlı başına birer güvenlik açığı değillerdir, ancak yapılandırmalarının dikkatli bir şekilde incelenmesi gerekmektedir.

## proxy\_set\_header Upgrade & Connection

Eğer nginx sunucusu, Upgrade ve Connection başlıklarını geçmek için yapılandırılmışsa, [**h2c Smuggling saldırısı**](../../pentesting-web/h2c-smuggling.md) gerçekleştirilerek korumalı/içsel uç noktalara erişilebilir.

{% hint style="danger" %}
Bu güvenlik açığı, bir saldırganın `proxy_pass` uç noktasıyla (`http://backend:9999` bu durumda) doğrudan bir bağlantı kurmasına izin verir ve nginx tarafından kontrol edilmeyecek içeriğe erişmesine olanak sağlar.
{% endhint %}

İşte [buradan](https://bishopfox.com/blog/h2c-smuggling-request) `/flag`'i çalmak için kullanılan bir zafiyetli yapılandırma örneği:
```
server {
listen       443 ssl;
server_name  localhost;

ssl_certificate       /usr/local/nginx/conf/cert.pem;
ssl_certificate_key   /usr/local/nginx/conf/privkey.pem;

location / {
proxy_pass http://backend:9999;
proxy_http_version 1.1;
proxy_set_header Upgrade $http_upgrade;
proxy_set_header Connection $http_connection;
}

location /flag {
deny all;
}
```
{% hint style="warning" %}
Dikkat edin, `proxy_pass` belirli bir **yol**a işaret ediyor olsa bile, örneğin `http://backend:9999/socket.io`, bağlantı `http://backend:9999` ile kurulur, bu yüzden **proxy\_pass URL'sinde bir yol belirtilmiş olsa bile** içerideki herhangi bir yol ile iletişim kurabilirsiniz.
{% endhint %}

## Kendiniz deneyin

Detectify, bu makalede tartışılan bazı yanlış yapılandırmalarla kendi zayıf Nginx test sunucusunu kurmanız ve bunları kendiniz bulmanız için Docker kullanarak bir GitHub deposu oluşturdu!

[https://github.com/detectify/vulnerable-nginx](https://github.com/detectify/vulnerable-nginx)

## Statik Analiz Araçları

### [GIXY](https://github.com/yandex/gixy)

Gixy, Nginx yapılandırmasını analiz etmek için bir araçtır. Gixy'nin ana hedefi, güvenlik yanlı yapılandırmalarını önlemek ve hata tespitini otomatikleştirmektir.

### [Nginxpwner](https://github.com/stark0de/nginxpwner)

Nginxpwner, yaygın Nginx yanlış yapılandırmalarını ve güvenlik açıklarını aramak için basit bir araçtır.

## Referanslar

* [**https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/**](https://blog.detectify.com/2020/11/10/common-nginx-misconfigurations/)
* [**http://blog.zorinaq.com/nginx-resolver-vulns/**](http://blog.zorinaq.com/nginx-resolver-vulns/)
* [**https://github.com/yandex/gixy/issues/115**](https://github.com/yandex/gixy/issues/115)

<figure><img src="/.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

**Anında kullanılabilir zayıflık değerlendirme ve penetrasyon testi kurulumu**. Keşiften raporlamaya kadar olan 20'den fazla araç ve özellikle herhangi bir yerden tam bir pentest çalıştırın. Pentester'ları değiştirmiyoruz - onlara daha derine kazma, kabukları patlatma ve eğlenme için zaman kazandırmak için özel araçlar, tespit ve istismar modülleri geliştiriyoruz.

{% embed url="https://pentest-tools.com/" %}

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklam vermek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'i keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u takip edin.
* Hacking hilelerinizi göndererek HackTricks ve HackTricks Cloud github depolarına PR göndererek **hacking hilelerinizi paylaşın**.

</details>
