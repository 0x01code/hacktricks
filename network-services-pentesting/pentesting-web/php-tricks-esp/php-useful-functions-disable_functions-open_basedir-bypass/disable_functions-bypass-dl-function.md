<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見る
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で私たちを**フォロー**する [**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

**重要な注意:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`**はPHP関数で、PHP拡張機能をロードするために使用できます。この関数が無効にされていない場合、**`disable_functions`をバイパスして任意のコマンドを実行**することができます。\
ただし、いくつかの厳格な制限があります：

* `dl`関数は**環境に存在し、無効にされていなければなりません**
* PHP拡張機能は、サーバーが使用している**同じメジャーバージョン（PHP APIバージョン）でコンパイル**されている必要があります（この情報はphpinfoの出力で確認できます）
* PHP拡張機能は、**`extension_dir`ディレクティブで定義されたディレクトリに配置**されている必要があります（phpinfoの出力で確認できます）。攻撃者がサーバーを悪用しようとする際にこのディレクトリに書き込みアクセス権限を持っている可能性は非常に低いため、この要件はおそらくこのテクニックの悪用を防ぐでしょう。

**これらの要件を満たしている場合は、投稿を続けて読んでください** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **`disable_functions`をバイパスする方法を学ぶ**。以下は要約です：

[dl関数](http://www.php.net/manual/en/function.dl.php)は、スクリプトの実行中にPHP拡張機能を動的にロードするために使用されます。通常、C/C++で書かれたPHP拡張機能は、PHPの機能を拡張します。攻撃者は、`dl`関数が無効にされていないことに気付いた場合、システムコマンドを実行するためのカスタムPHP拡張機能を作成することに決定します。

### 攻撃者が取った手順：

1. **PHPバージョンの特定:**
- 攻撃者は、スクリプト（`<?php echo 'PHP Version is '.PHP_VERSION; ?>`）を使用してPHPバージョンを特定します。

2. **PHPソースの取得:**
- 公式の[PHPウェブサイト](http://www.php.net/downloads.php)または[アーカイブ](http://museum.php.net)からPHPソースをダウンロードします（バージョンが古い場合）。

3. **ローカルPHPセットアップ:**
- 特定のPHPバージョンをシステムに展開してインストールします。

4. **拡張機能の作成:**
- [PHP拡張機能の作成](http://www.php.net/manual/en/zend.creating.php)を学習し、PHPソースコードを調査します。
- `ext/standard/exec.c`にある[exec関数](http://www.php.net/manual/en/function.exec.php)の機能を複製することに焦点を当てます。

### カスタム拡張機能のコンパイルに関する注意事項：

1. **ZEND_MODULE_API_NO:**
- `bypass.c`内の`ZEND_MODULE_API_NO`は、現在のZend Extension Buildと一致する必要があります。次のコマンドで取得できます：
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **PHP_FUNCTIONの修正:**
- 最近のPHPバージョン（5、7、8）の場合、`PHP_FUNCTION(bypass_exec)`を調整する必要があるかもしれません。提供されたコードスニペットがこの修正の詳細を示しています。

### カスタム拡張機能ファイル：

- **bypass.c**:
- カスタム拡張機能のコア機能を実装します。
- **php_bypass.h**:
- 拡張機能のプロパティを定義するヘッダーファイル。
- **config.m4**:
- カスタム拡張機能のビルド環境を構成するために`phpize`によって使用されます。

### 拡張機能のビルド：

1. **コンパイルコマンド:**
- `phpize`、`./configure`、`make`を使用して拡張機能をコンパイルします。
- 生成された`bypass.so`は、modulesサブディレクトリに配置されます。

2. **クリーンアップ:**
- コンパイル後に`make clean`と`phpize --clean`を実行します。

### 被害者ホストにアップロードして実行：

1. **バージョンの互換性:**
- 攻撃者と被害者のシステム間でPHP APIバージョンが一致していることを確認します。

2. **拡張機能のロード:**
- 相対パスを使用するか、スクリプトを使用して制限を回避するために`dl`関数を使用します。

3. **スクリプトの実行:**
- 攻撃者は`bypass.so`とPHPスクリプトを被害者のサーバーにアップロードします。
- スクリプトは`dl_local`関数を使用して`bypass.so`を動的にロードし、`cmd`クエリパラメータを介して渡されたコマンドで`bypass_exec`を呼び出します。

### コマンドの実行：

- 攻撃者は、次のようにアクセスすることでコマンドを実行できます：`http://www.example.com/script.php?cmd=<command>`


この詳細な手順では、`dl`関数を悪用してシステムコマンドを実行するためのPHP拡張機能を作成および展開するプロセスを説明しており、このセキュリティ違反を防ぐために理想的には無効にすべき`dl`関数を悪用しています。


<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを見る
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で私たちを**フォロー**する [**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングトリックを共有するには、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>
