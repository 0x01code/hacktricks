<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

**Nota importante:**

![imagem](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** √© uma fun√ß√£o do PHP que pode ser usada para carregar extens√µes do PHP. Se a fun√ß√£o n√£o estiver desativada, ela pode ser abusada para **burlar `disable_functions` e executar comandos arbitr√°rios**.\
No entanto, ela possui algumas limita√ß√µes rigorosas:

* A fun√ß√£o `dl` deve estar **presente** no **ambiente** e **n√£o desativada**
* A extens√£o do PHP deve ser **compilada com a mesma vers√£o principal** (vers√£o da API do PHP) que o servidor est√° usando (voc√™ pode ver essa informa√ß√£o na sa√≠da do phpinfo)
* A extens√£o do PHP deve estar **localizada no diret√≥rio** definido pela diretiva **`extension_dir`** (voc√™ pode ver isso na sa√≠da do phpinfo). √â muito improv√°vel que um atacante tentando abusar do servidor tenha acesso de grava√ß√£o sobre este diret√≥rio, ent√£o esse requisito provavelmente o impedir√° de abusar dessa t√©cnica).

**Se voc√™ atender a esses requisitos, continue lendo o post** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **para aprender como burlar `disable_functions`**. Aqui est√° um resumo:

A [fun√ß√£o dl](http://www.php.net/manual/en/function.dl.php) √© usada para carregar extens√µes do PHP dinamicamente durante a execu√ß√£o do script. As extens√µes do PHP, normalmente escritas em C/C++, aprimoram a funcionalidade do PHP. O atacante, ao perceber que a fun√ß√£o `dl` n√£o est√° desativada, decide criar uma extens√£o personalizada do PHP para executar comandos do sistema.

### Etapas Realizadas pelo Atacante:

1. **Identifica√ß√£o da Vers√£o do PHP:**
- O atacante determina a vers√£o do PHP usando um script (`<?php echo 'A vers√£o do PHP √© '.PHP_VERSION; ?>`).

2. **Aquisi√ß√£o da Origem do PHP:**
- Baixa a origem do PHP do site oficial do [PHP](http://www.php.net/downloads.php) ou do [arquivo](http://museum.php.net) se a vers√£o for mais antiga.

3. **Configura√ß√£o Local do PHP:**
- Extrai e instala a vers√£o espec√≠fica do PHP em seu sistema.

4. **Cria√ß√£o da Extens√£o:**
- Estuda [cria√ß√£o de extens√µes do PHP](http://www.php.net/manual/en/zend.creating.php) e inspeciona o c√≥digo-fonte do PHP.
- Foca em duplicar a funcionalidade da [fun√ß√£o exec](http://www.php.net/manual/en/function.exec.php) localizada em `ext/standard/exec.c`.

### Notas para Compilar a Extens√£o Personalizada:

1. **ZEND_MODULE_API_NO:**
- O `ZEND_MODULE_API_NO` em `bypass.c` deve corresponder √† compila√ß√£o atual da Extens√£o Zend, obtida com:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```

2. **Modifica√ß√£o da Fun√ß√£o PHP:**
- Para vers√µes recentes do PHP (5, 7, 8), `PHP_FUNCTION(bypass_exec)` pode precisar de ajustes. O trecho de c√≥digo fornecido detalha essa modifica√ß√£o.

### Arquivos da Extens√£o Personalizada:

- **bypass.c**:
- Implementa a funcionalidade principal da extens√£o personalizada.
- **php_bypass.h**:
- Arquivo de cabe√ßalho, definindo propriedades da extens√£o.
- **config.m4**:
- Usado pelo `phpize` para configurar o ambiente de compila√ß√£o para a extens√£o personalizada.

### Compilando a Extens√£o:

1. **Comandos de Compila√ß√£o:**
- Usa `phpize`, `./configure` e `make` para compilar a extens√£o.
- O `bypass.so` resultante √© ent√£o localizado no subdiret√≥rio de m√≥dulos.

2. **Limpeza:**
- Executa `make clean` e `phpize --clean` ap√≥s a compila√ß√£o.

### Upload e Execu√ß√£o no Host da V√≠tima:

1. **Compatibilidade de Vers√£o:**
- Garante que as vers√µes da API do PHP correspondam entre o sistema do atacante e da v√≠tima.

2. **Carregamento da Extens√£o:**
- Utiliza a fun√ß√£o `dl`, contornando restri√ß√µes usando caminhos relativos ou um script para automatizar o processo.

3. **Execu√ß√£o do Script:**
- O atacante faz upload de `bypass.so` e um script PHP para o servidor da v√≠tima.
- O script usa a fun√ß√£o `dl_local` para carregar dinamicamente `bypass.so` e ent√£o chama `bypass_exec` com um comando passado via o par√¢metro de consulta `cmd`.

### Execu√ß√£o de Comandos:

- O atacante agora pode executar comandos acessando: `http://www.example.com/script.php?cmd=<comando>`


Este guia detalhado descreve o processo de cria√ß√£o e implanta√ß√£o de uma extens√£o do PHP para executar comandos do sistema, explorando a fun√ß√£o `dl`, que idealmente deve ser desativada para evitar viola√ß√µes de seguran√ßa desse tipo.


<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
