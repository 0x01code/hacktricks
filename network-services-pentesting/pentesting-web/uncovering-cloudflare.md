# 揭露CloudFlare

<details>

<summary><strong>从零开始学习AWS黑客技术，成为英雄</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

尝试揭露Cloudflare背后的web服务器的技术：

### 技术

* 您也可以使用一些提供域名**历史DNS记录**的服务。也许网页正在之前使用的IP地址上运行。
* 通过**检查历史SSL证书**也可以达到同样的效果，这些证书可能指向原始IP地址。
* 同样检查指向IP的**其他子域的DNS记录**，因为有可能其他子域指向同一服务器（可能提供FTP、邮件或其他服务）。
* 如果您在web应用程序中发现了**SSRF**，您可以滥用它来获取服务器的IP地址。
*

在shodan等浏览器中搜索网页的独特字符串（也许还有google和类似的？）。也许您可以找到带有该内容的IP地址。

* 类似地，您可以使用工具：[https://github.com/karma9874/CloudFlare-IP](https://github.com/karma9874/CloudFlare-IP) 或 [https://github.com/pielco11/fav-up](https://github.com/pielco11/fav-up) 来搜索favicon图标，而不是寻找唯一字符串
* 这种方法不会经常有效，因为服务器必须在通过IP地址访问时发送相同的响应，但你永远不知道。

### 工具

* 在 [http://www.crimeflare.org:82/cfs.html](http://www.crimeflare.org:82/cfs.html) 或 [https://crimeflare.herokuapp.com](https://crimeflare.herokuapp.com) 中搜索域名。或使用工具 [CloudPeler](https://github.com/zidansec/CloudPeler)（使用该API）
* 在 [https://leaked.site/index.php?resolver/cloudflare.0/](https://leaked.site/index.php?resolver/cloudflare.0/) 中搜索域名
* [**CloudFlair**](https://github.com/christophetd/CloudFlair) 是一个工具，它将使用Censys证书搜索包含域名的证书，然后它将在这些证书中搜索IPv4，最后它将尝试在这些IP中访问网页。
* [Censys](https://search.censys.io/)
* [Shodan](https://shodan.io/)
* [Bypass-firewalls-by-DNS-history](https://github.com/vincentcox/bypass-firewalls-by-DNS-history)
* 如果您有一组潜在的IP，网页可能位于那里，您可以使用 [https://github.com/hakluke/hakoriginfinder](https://github.com/hakluke/hakoriginfinder)
```bash
# You can check if the tool is working with
prips 1.0.0.0/30 | hakoriginfinder -h one.one.one.one

# If you know the company is using AWS you could use the previous tool to search the
## web page inside the EC2 IPs
DOMAIN=something.com
WIDE_REGION=us
for ir in `curl https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | select(.region|test("^us")) | .ip_prefix'`; do
echo "Checking $ir"
prips $ir | hakoriginfinder -h "$DOMAIN"
done
```
### 揭露来自AWS机器的Cloudflare

要了解此过程的更好描述，请查看：

{% embed url="https://trickest.com/blog/cloudflare-bypass-discover-ip-addresses-aws/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
```bash
# Find open ports
sudo masscan --max-rate 10000 -p80,443 $(curl -s https://ip-ranges.amazonaws.com/ip-ranges.json | jq -r '.prefixes[] | select(.service=="EC2") | .ip_prefix' | tr '\n' ' ') | grep "open"  > all_open.txt
# Format results
cat all_open.txt | sed 's,.*port \(.*\)/tcp on \(.*\),\2:\1,' | tr -d " " > all_open_formated.txt
# Search actual web pages
httpx -silent -threads 200 -l all_open_formated.txt -random-agent -follow-redirects -json -no-color -o webs.json
# Format web results and remove eternal redirects
cat webs.json | jq -r "select((.failed==false) and (.chain_status_codes | length) < 9) | .url" | sort -u > aws_webs.json

# Search via Host header
httpx -json -no-color -list aws_webs.json -header Host: cloudflare.malwareworld.com -threads 250 -random-agent -follow-redirects -o web_checks.json
```
## 绕过 Cloudflare

### 认证源拉取

此机制依赖于**客户端**的 [**SSL 证书**](https://socradar.io/how-to-monitor-your-ssl-certificates-expiration-easily-and-why/) **来认证连接**，在 **Cloudflare 的反向代理** 服务器和**源**服务器之间，这称为 **mTLS**。

客户无需配置自己的证书，可以简单使用 Cloudflare 的证书允许来自 Cloudflare 的任何连接，**不管租户如何**。

{% hint style="danger" %}
因此，攻击者可以设置一个在 Cloudflare 上使用 Cloudflare 证书的**域名**，并将其指向**受害者**域名的**IP**地址。这样，设置他的域名完全无保护，Cloudflare 将不会保护发送的请求。
{% endhint %}

更多信息[**这里**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/)。

### 允许列表 Cloudflare IP 地址

这将**拒绝不是来自 Cloudflare** IP 地址范围的连接。这也容易受到前面设置的攻击，其中攻击者只需将他自己的域名在 Cloudflare 上**指向受害者的 IP** 地址并攻击它。

更多信息[**这里**](https://socradar.io/cloudflare-protection-bypass-vulnerability-on-threat-actors-radar/)。

## 绕过 Cloudflare 进行抓取

### 缓存

有时你只想绕过 Cloudflare 来抓取网页。有一些选项：

* 使用 Google 缓存：`https://webcache.googleusercontent.com/search?q=cache:https://www.petsathome.com/shop/en/pets/dog`
* 使用其他缓存服务，如 [https://archive.org/web/](https://archive.org/web/)

### Cloudflare 解决方案

已经开发了许多 Cloudflare 解决方案：

* [FlareSolverr](https://github.com/FlareSolverr/FlareSolverr)
* [cloudscraper](https://github.com/VeNoMouS/cloudscraper) [指南在这里](https://scrapeops.io/python-web-scraping-playbook/python-cloudscraper/)
* [cloudflare-scrape](https://github.com/Anorov/cloudflare-scrape)
* [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)
* [Cloudflare-IUAM-Solver](https://github.com/ninja-beans/cloudflare-iuam-solver)
* [cloudflare-bypass](https://github.com/devgianlu/cloudflare-bypass) \[已归档]
* [CloudflareSolverRe](https://github.com/RyuzakiH/CloudflareSolverRe)

### 加固的无头浏览器 <a href="#option-4-scrape-with-fortified-headless-browsers" id="option-4-scrape-with-fortified-headless-browsers"></a>

另一个选项是使用经过加固的无头浏览器来完成整个抓取工作，使其看起来像真实用户的浏览器：

* **Puppeteer：** [puppeteer](https://github.com/puppeteer/puppeteer) 的 [隐身插件](https://github.com/berstend/puppeteer-extra/tree/master/packages/puppeteer-extra-plugin-stealth)。
* **Playwright：** [隐身插件](https://www.npmjs.com/package/playwright-stealth) 即将来到 Playwright。跟进发展[这里](https://github.com/berstend/puppeteer-extra/issues/454)和[这里](https://github.com/berstend/puppeteer-extra/tree/master/packages/playwright-extra)。
* **Selenium：** [undetected-chromedriver](https://github.com/ultrafunkamsterdam/undetected-chromedriver) 是一个优化的 Selenium Chromedriver 补丁。

### 内置 Cloudflare 绕过的智能代理 <a href="#option-5-smart-proxy-with-cloudflare-built-in-bypass" id="option-5-smart-proxy-with-cloudflare-built-in-bypass"></a>

使用开源 Cloudflare 绕过的替代方法是使用开发和维护自己的私有 Cloudflare 绕过的智能代理。

这些通常更可靠，因为 Cloudflare 更难为它们开发补丁，而且它们是由代理公司开发的，这些公司在财务上有动力领先 Cloudflare 一步，并在它们的绕过停止工作的那一刻立即修复。

大多数智能代理提供商（[ScraperAPI](https://www.scraperapi.com/?fp_ref=scrapeops), [Scrapingbee](https://www.scrapingbee.com/?fpr=scrapeops), [Oxylabs](https://oxylabs.go2cloud.org/aff_c?offer_id=7&aff_id=379&url_id=32), [Smartproxy](https://prf.hn/click/camref:1100loxdG/[p_id:1100l442001]/destination:https%3A%2F%2Fsmartproxy.com%2Fscraping%2Fweb)）都有某种形式的 Cloudflare 绕过，它们的工作程度和成本各不相同。

然而，最好的选择之一是使用 [ScrapeOps Proxy Aggregator](https://scrapeops.io/proxy-aggregator/)，因为它将超过 20 个代理提供商集成到同一个代理 API 中，并为您的目标域找到最佳/最便宜的代理提供商。

### 反向工程 Cloudflare 反爬虫保护 <a href="#option-6-reverse-engineer-cloudflare-anti-bot-protection" id="option-6-reverse-engineer-cloudflare-anti-bot-protection"></a>

这种方法有效（这是许多智能代理解决方案所做的），但并非轻而易举。

**优点：** 这种方法的优点是，如果你在大规模抓取，而且你不想运行数百（如果不是数千）个昂贵的完整无头浏览器实例。你可以开发最资源高效的 Cloudflare 绕过。一个专门设计用来通过 Cloudflare JS、TLS 和 IP 指纹测试的绕过。

**缺点：** 这种方法的缺点是，你将不得不深入研究一个故意难以从外部理解的反爬虫系统，并分测试不同的技术来欺骗他们的验证系统。然后维护这个系统，因为 Cloudflare 继续开发他们的反爬虫保护。

## 参考资料

* [https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/](https://scrapeops.io/web-scraping-playbook/how-to-bypass-cloudflare/)

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 **HackTricks** 中看到你的**公司广告**或**下载 HackTricks 的 PDF** 版本，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 收藏品
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。

</details>
