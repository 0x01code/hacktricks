{% hint style="success" %}
Μάθετε & εξασκηθείτε στο AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**Εκπαίδευση HackTricks AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Μάθετε & εξασκηθείτε στο GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**Εκπαίδευση HackTricks GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Υποστηρίξτε το HackTricks</summary>

* Ελέγξτε τα [**σχέδια συνδρομής**](https://github.com/sponsors/carlospolop)!
* **Συμμετέχετε** 💬 στην [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Κοινοποιήστε κόλπα χάκερ υποβάλλοντας PRs** στα αποθετήρια [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) στο GitHub.

</details>
{% endhint %}


# CBC - Cipher Block Chaining

Στη λειτουργία CBC το **προηγούμενο κρυπτογραφημένο μπλοκ χρησιμοποιείται ως IV** για το XOR με το επόμενο μπλοκ:

![https://defuse.ca/images/cbc\_encryption.png](https://defuse.ca/images/cbc\_encryption.png)

Για να αποκρυπτογραφήσετε το CBC γίνονται οι **αντίθετες** **λειτουργίες**:

![https://defuse.ca/images/cbc\_decryption.png](https://defuse.ca/images/cbc\_decryption.png)

Παρατηρήστε πως απαιτείται να χρησιμοποιηθεί ένα **κλειδί κρυπτογράφησης** και ένα **IV**.

# Προσθήκη Μηνύματος

Καθώς η κρυπτογράφηση εκτελείται σε **σταθερά μπλοκ μεγέθους**, συνήθως απαιτείται **προσθήκη** στο τελευταίο **μπλοκ** για να ολοκληρωθεί το μήκος του.\
Συνήθως χρησιμοποιείται το **PKCS7**, το οποίο δημιουργεί μια προσθήκη επαναλαμβάνοντας τον **αριθμό των bytes που απαιτούνται** για να **ολοκληρωθεί** το μπλοκ. Για παράδειγμα, αν το τελευταίο μπλοκ λείπουν 3 bytes, η προσθήκη θα είναι `\x03\x03\x03`.

Ας δούμε περισσότερα παραδείγματα με **2 μπλοκ μήκους 8bytes**:

| byte #0 | byte #1 | byte #2 | byte #3 | byte #4 | byte #5 | byte #6 | byte #7 | byte #0  | byte #1  | byte #2  | byte #3  | byte #4  | byte #5  | byte #6  | byte #7  |
| ------- | ------- | ------- | ------- | ------- | ------- | ------- | ------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- | -------- |
| P       | A       | S       | S       | W       | O       | R       | D       | 1        | 2        | 3        | 4        | 5        | 6        | **0x02** | **0x02** |
| P       | A       | S       | S       | W       | O       | R       | D       | 1        | 2        | 3        | 4        | 5        | **0x03** | **0x03** | **0x03** |
| P       | A       | S       | S       | W       | O       | R       | D       | 1        | 2        | 3        | **0x05** | **0x05** | **0x05** | **0x05** | **0x05** |
| P       | A       | S       | S       | W       | O       | R       | D       | **0x08** | **0x08** | **0x08** | **0x08** | **0x08** | **0x08** | **0x08** | **0x08** |

Σημειώστε πως στο τελευταίο παράδειγμα το **τελευταίο μπλοκ ήταν γεμάτο οπότε δημιουργήθηκε ένα ακόμα μόνο με προσθήκη**.

# Προφυλακτικό Πληροφοριών

Όταν μια εφαρμογή αποκρυπτογραφεί κρυπτογραφημένα δεδομένα, θα αποκρυπτογραφήσει πρώτα τα δεδομένα· στη συνέχεια θα αφαιρέσει την προσθήκη. Κατά την αφαίρεση της προσθήκης, αν μια **μη έγκυρη προσθήκη προκαλεί ανιχνεύσιμη συμπεριφορά**, έχετε μια **ευπάθεια προφυλακτικού πληροφοριών**. Η ανιχνεύσιμη συμπεριφορά μπορεί να είναι ένα **σφάλμα**, έλλειψη αποτελεσμάτων ή **πιο αργή απόκριση**.

Αν ανιχνεύσετε αυτήν τη συμπεριφορά, μπορείτε να **αποκρυπτογραφήσετε τα κρυπτογραφημένα δεδομένα** και ακόμα και να **κρυπτογραφήσετε οποιοδήποτε κείμενο**.

## Πώς να εκμεταλλευτείτε

Μπορείτε να χρησιμοποιήσετε το [https://github.com/AonCyberLabs/PadBuster](https://github.com/AonCyberLabs/PadBuster) για να εκμεταλλευτείτε αυτού του είδους την ευπάθεια ή απλά να κάνετε
```
sudo apt-get install padbuster
```
Για να δοκιμάσετε αν το cookie ενός ιστότοπου είναι ευάλωτο, μπορείτε να δοκιμάσετε:
```bash
perl ./padBuster.pl http://10.10.10.10/index.php "RVJDQrwUdTRWJUVUeBKkEA==" 8 -encoding 0 -cookies "login=RVJDQrwUdTRWJUVUeBKkEA=="
```
**Η κωδικοποίηση 0** σημαίνει ότι χρησιμοποιείται το **base64** (αλλά υπάρχουν και άλλες επιλογές, ελέγξτε το μενού βοήθειας).

Μπορείτε επίσης να **καταχραστείτε αυτήν την ευπάθεια για να κρυπτογραφήσετε νέα δεδομένα. Για παράδειγμα, φανταστείτε ότι το περιεχόμενο του cookie είναι "**_**user=MyUsername**_**", τότε μπορείτε να το αλλάξετε σε "\_user=administrator\_" και να αναβαθμίσετε τα δικαιώματα μέσα στην εφαρμογή. Μπορείτε επίσης να το κάνετε χρησιμοποιώντας το `padbuster` καθορίζοντας την παράμετρο -plaintext**.
```bash
perl ./padBuster.pl http://10.10.10.10/index.php "RVJDQrwUdTRWJUVUeBKkEA==" 8 -encoding 0 -cookies "login=RVJDQrwUdTRWJUVUeBKkEA==" -plaintext "user=administrator"
```
Εάν ο ιστότοπος είναι ευάλωτος, το `padbuster` θα προσπαθήσει αυτόματα να βρει πότε συμβαίνει σφάλμα γέμισης, αλλά μπορείτε επίσης να υποδείξετε το μήνυμα σφάλματος χρησιμοποιώντας την παράμετρο **-error**.
```bash
perl ./padBuster.pl http://10.10.10.10/index.php "" 8 -encoding 0 -cookies "hcon=RVJDQrwUdTRWJUVUeBKkEA==" -error "Invalid padding"
```
## Η θεωρία

Σε **συνοπτική** μορφή, μπορείτε να ξεκινήσετε την αποκρυπτογράφηση των κρυπτογραφημένων δεδομένων μαντεύοντας τις σωστές τιμές που μπορούν να χρησιμοποιηθούν για να δημιουργηθούν όλα τα **διαφορετικά paddings**. Στη συνέχεια, η επίθεση με padding oracle θα αρχίσει να αποκρυπτογραφεί bytes από το τέλος προς την αρχή μαντεύοντας ποια θα είναι η σωστή τιμή που **δημιουργεί ένα padding του 1, 2, 3, κλπ**.

![](<../.gitbook/assets/image (629) (1) (1).png>)

Φανταστείτε ότι έχετε κάποιο κρυπτογραφημένο κείμενο που καταλαμβάνει **2 blocks** που αποτελούνται από τα bytes από **E0 έως E15**.\
Για να **αποκρυπτογραφήσετε** το **τελευταίο block** (**E8** έως **E15**), ολόκληρο το block περνά από τη "αποκρυπτογράφηση block cipher" παράγοντας τα **ενδιάμεσα bytes I0 έως I15**.\
Τέλος, κάθε ενδιάμεσο byte είναι **XORed** με τα προηγούμενα κρυπτογραφημένα bytes (E0 έως E7). Έτσι:

* `C15 = D(E15) ^ E7 = I15 ^ E7`
* `C14 = I14 ^ E6`
* `C13 = I13 ^ E5`
* `C12 = I12 ^ E4`
* ...

Τώρα, είναι δυνατόν να **τροποποιήσετε το `E7` μέχρι να γίνει `C15` `0x01`**, το οποίο θα είναι επίσης ένα σωστό padding. Έτσι, σε αυτήν την περίπτωση: `\x01 = I15 ^ E'7`

Έτσι, βρίσκοντας το E'7, είναι **δυνατό να υπολογιστεί το I15**: `I15 = 0x01 ^ E'7`

Αυτό μας επιτρέπει να **υπολογίσουμε το C15**: `C15 = E7 ^ I15 = E7 ^ \x01 ^ E'7`

Γνωρίζοντας το **C15**, τώρα είναι δυνατό να **υπολογίσουμε το C14**, αλλά αυτή τη φορά με brute-force το padding `\x02\x02`.

Αυτό το BF είναι εξίσου πολύπλοκο με το προηγούμενο καθώς είναι δυνατό να υπολογιστεί το `E''15` του οποίου η τιμή είναι 0x02: `E''7 = \x02 ^ I15` οπότε απλά χρειάζεται να βρεθεί το **`E'14`** που δημιουργεί ένα **`C14` ίσο με `0x02`**.\
Στη συνέχεια, εκτελέστε τα ίδια βήματα για να αποκρυπτογραφήσετε το C14: **`C14 = E6 ^ I14 = E6 ^ \x02 ^ E''6`**

**Ακολουθήστε αυτή την αλυσίδα μέχρι να αποκρυπτογραφήσετε ολόκληρο το κρυπτογραφημένο κείμενο.**

## Ανίχνευση της ευπάθειας

Εγγραφείτε και συνδεθείτε με αυτό το λογαριασμό.\
Αν **συνδεθείτε πολλές φορές** και πάντα λαμβάνετε το **ίδιο cookie**, πιθανόν υπάρχει κάτι **λάθος** στην εφαρμογή. Το **cookie που επιστρέφεται θα πρέπει να είναι μοναδικό** κάθε φορά που συνδέεστε. Αν το cookie είναι **πάντα** το **ίδιο**, πιθανόν θα είναι πάντα έγκυρο και δεν θα υπάρχει τρόπος να το ακυρώσετε.

Τώρα, αν προσπαθήσετε να **τροποποιήσετε** το **cookie**, θα δείτε ότι λαμβάνετε ένα **σφάλμα** από την εφαρμογή.\
Αλλά αν χρησιμοποιήσετε BF το padding (χρησιμοποιώντας για παράδειγμα το padbuster) καταφέρνετε να λάβετε ένα άλλο cookie που είναι έγκυρο για έναν διαφορετικό χρήστη. Αυτό το σενάριο είναι πιθανόν ευάλωτο στο padbuster.

## Αναφορές

* [https://en.wikipedia.org/wiki/Block\_cipher\_mode\_of\_operation](https://en.wikipedia.org/wiki/Block\_cipher\_mode\_of\_operation)
