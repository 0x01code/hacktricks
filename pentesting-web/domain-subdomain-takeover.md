# 域名/子域名接管

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
使用 [**Trickest**](https://trickest.com/?utm_campaign=hacktrics\&utm_medium=banner\&utm_source=hacktricks) 轻松构建并**自动化工作流程**，由世界上**最先进的**社区工具提供支持。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## 域名接管

如果您发现某个域名（domain.tld）**正在被范围内的某项服务使用**，但**公司**已经**失去了**它的**所有权**，您可以尝试**注册**它（如果价格足够便宜），并让公司知道。如果这个域名正在接收一些**敏感信息**，如通过**GET**参数或在**Referer**头中的会话cookie，这肯定是一个**漏洞**。

### 子域名接管

公司的一个子域名指向一个**未注册名称的第三方服务**。如果您能够在这个**第三方服务**中**创建**一个**账户**并**注册**正在使用的**名称**，您就可以执行子域名接管。

有几个带有字典的工具可以检查可能的接管：

* [https://github.com/EdOverflow/can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz)
* [https://github.com/blacklanternsecurity/bbot](https://github.com/blacklanternsecurity/bbot)
* [https://github.com/punk-security/dnsReaper](https://github.com/punk-security/dnsReaper)
* [https://github.com/haccer/subjack](https://github.com/haccer/subjack)
* [https://github.com/anshumanbh/tko-sub](https://github.com/anshumanbh/tko-subs)
* [https://github.com/ArifulProtik/sub-domain-takeover](https://github.com/ArifulProtik/sub-domain-takeover)
* [https://github.com/SaadAhmedx/Subdomain-Takeover](https://github.com/SaadAhmedx/Subdomain-Takeover)
* [https://github.com/Ice3man543/SubOver](https://github.com/Ice3man543/SubOver)
* [https://github.com/m4ll0k/takeover](https://github.com/m4ll0k/takeover)
* [https://github.com/antichown/subdomain-takeover](https://github.com/antichown/subdomain-takeover)
* [https://github.com/musana/mx-takeover](https://github.com/musana/mx-takeover)

#### 使用[BBOT](https://github.com/blacklanternsecurity/bbot)扫描可劫持的子域名：

BBOT的默认子域名枚举包括子域名接管检查。签名直接从[https://github.com/EdOverflow/can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz)拉取。
```bash
bbot -t evilcorp.com -f subdomain-enum
```
### 通过 DNS 通配符生成子域接管

当在域中使用 DNS 通配符时，该域的任何请求子域（如果没有明确的不同地址）都会**解析为相同的信息**。这可能是一个 A IP 地址，一个 CNAME...

例如，如果 `*.testing.com` 被通配到 `1.1.1.1`。那么，`not-existent.testing.com` 将指向 `1.1.1.1`。

然而，如果不是指向 IP 地址，而是系统管理员将其指向**第三方服务的 CNAME**，比如一个**github 子域**（例如 `sohomdatta1.github.io`）。攻击者可以**创建他自己的第三方页面**（在这个例子中是在 Github 上），并声称 `something.testing.com` 指向那里。因为，**CNAME 通配符**会同意，攻击者将能够**为受害者域生成任意指向他页面的子域**。

您可以在 CTF 写作中找到这个漏洞的例子：[https://ctf.zeyu2001.com/2022/nitectf-2022/undocumented-js-api](https://ctf.zeyu2001.com/2022/nitectf-2022/undocumented-js-api)

## 利用子域接管

**此信息复制自** [**https://0xpatrik.com/subdomain-takeover/**](https://0xpatrik.com/subdomain-takeover/)

最近，我[写了](https://0xpatrik.com/subdomain-takeover-basics/)关于子域接管基础的文章。虽然这个概念现在通常被很好地理解了，但我注意到人们通常难以把握子域接管带来的风险。在这篇文章中，我深入探讨了从我的角度看最显著的_子域接管_风险。

_注意：某些风险被云提供商隐式缓解。例如，当在 Amazon CloudFront 上可能发生子域接管时，您无法设置 TXT 记录来绕过 SPF 检查。因此，该帖子旨在提供关于一般子域接管的风险。尽管如此，大多数风险也适用于云提供商。_

### 对浏览器的透明度 <a href="#transparencytoabrowser" id="transparencytoabrowser"></a>

首先，让我们看看涉及 CNAME 时的 DNS 解析：

![DNS resolution](https://0xpatrik.com/content/images/2018/05/resolution-2.png)

请注意，步骤 #7 请求的是 _sub.example.com_ 而不是 _anotherdomain.com_。这是因为网络浏览器不知道 _anotherdomain.com_ 甚至存在。即使使用了 CNAME 记录，浏览器的 URL 栏仍然包含 _sub.example.com_。这就是对浏览器的**透明度**。如果你考虑一下，浏览器将所有信任放在 DNS 解析器上，以提供有关域的准确信息。简化来说，子域接管是针对互联网上一个特定域的 DNS 欺骗。为什么？因为任何执行受影响域 DNS 解析的浏览器都会收到攻击者设置的 A 记录。然后，浏览器会高兴地显示从这个服务器收到的任何内容（认为这是合法的）。

这样的域为钓鱼提供了完美的场景。攻击者经常使用[_错别字攻击_](https://en.wikipedia.org/wiki/Typosquatting)或所谓的[_双胞胎域_](https://en.wikipedia.org/wiki/Doppelg%C3%A4nger)来模仿合法域/网站进行钓鱼目的。攻击者接管了一些合法域名后，普通用户几乎不可能分辨域上的内容是由合法方还是攻击者提供的。让我们以一个随机银行为例。如果银行的一个子域容易受到子域接管的攻击，攻击者可以创建一个模仿银行互联网银行系统登录表单的 HTML 表单。然后，攻击者可以运行针对性钓鱼或大规模钓鱼活动，要求用户登录并更改密码。在这个阶段，密码被控制该域的攻击者捕获。钓鱼电子邮件中提供的 URL 是银行的合法子域。因此，用户不知道有恶意行为正在进行。垃圾邮件过滤器和其他安全措施也不太可能将电子邮件触发为垃圾邮件或恶意，因为它包含信任度更高的域名。

的确，域名本身在成功活动中起着重要作用。拥有易受子域接管攻击的第五级子域远不如拥有一些友好子域名的第二级子域_"合法"_。我看到了几个完美的钓鱼子域，包括：

* _purchases.SOMETHING.com_
* _www.SOMETHING.com_
* _online.SOMETHING.com_
* _shop.SOMETHING.com_

所有这些都容易受到子域接管。它们都是大品牌。谈论完美的钓鱼？

尽管如此，最近的钓鱼活动在包含品牌名称的长域名上托管内容（参见[苹果示例](https://www.phishtank.com/target\_search.php?target\_id=183\&valid=y\&active=All\&Search=Search)）。拥有有效的 SSL 证书（下面会详细介绍），域名中的关键字和模仿目标品牌网站的网站，人们倾向于落入这些攻击。想想这个品牌的合法子域的机会。

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
使用 [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) 轻松构建并**自动化工作流程**，由世界上**最先进**的社区工具提供支持。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

### SSL 证书 <a href="#sslcertificates" id="sslcertificates"></a>

上述攻击可以通过生成有效的 SSL 证书来增强。证书机构如 [_Let's Encrypt_](https://letsencrypt.org/) 允许通过内容验证自动验证域名所有权：

![Let's Encrypt Flow](https://0xpatrik.com/content/images/2018/05/letsencrypt.png)

也就是说，如果在特定的 URL 路径上放置了特定的内容，Let's Encrypt 将批准为给定域发行证书。由于攻击者完全控制了易受子域接管攻击的域的内容，因此这种验证可以在几分钟内完成。因此，攻击者还能够为这样的域生成 SSL 证书，这只会降低钓鱼攻击的怀疑。

### Cookie 窃取 <a href="#cookiestealing" id="cookiestealing"></a>

这与浏览器透明度密切相关，但后果不同。Web 浏览器实现了许多安全策略，以防止恶意网站造成伤害。这包括诸如[同源策略](https://en.wikipedia.org/wiki/Same-origin\_policy)之类的事情。浏览器的主要安全责任之一是保护保存的 cookies。为什么？虽然 HTTP 是一个无状态协议，但 cookies 用于跟踪会话。为了方便，用户经常保存 cookies 较长时间，以防止每次都需要登录。因此，这些 cookies 充当登录令牌，被呈现给 Web 服务器，用户被识别。像[_会话劫持_](https://en.wikipedia.org/wiki/Session\_hijacking)这样的攻击自然从这个概念演变而来。

浏览器会自动向发出它们的域的每个请求呈现存储的 cookies。有一个例外，即 cookies 可能会在子域之间共享（[在此阅读](https://tools.ietf.org/html/rfc6265#section-8.6)，也请注意第 8.7 节）。通常发生在网站使用基于 cookie 的[单点登录](https://en.wikipedia.org/wiki/Single\_sign-on)（SSO）系统时。使用 SSO，用户可以使用一个子域登录，并在广泛的子域范围内共享相同的会话令牌。设置常规 cookie 的语法如下：
```
HTTP/1.1 200 OK
Set-Cookie: name=value
```
如果这个cookie由位于_example.com_的web服务器发出，那么只有这个服务器以后才能访问这个cookie。然而，出于上述解释的原因，cookie可以以以下方式为通配符域名发出：
```
HTTP/1.1 200 OK
Set-Cookie: name=value; domain=example.com
```
```markdown
Cookie 会包含在对 _example.com_ 的 HTTP 请求中，也会包含在对任何其他子域的请求中，例如 _subdomain.example.com_。这种行为创造了使用子域接管进行高严重性攻击的可能性。假设某个特定域名使用通配符域的会话 Cookie。如果有一个子域容易受到子域接管的攻击，那么收集用户会话令牌的唯一方法是诱使他或她访问易受攻击的子域。会话 Cookie 会自动随 HTTP 请求发送。

浏览器还实现了其他针对 Cookie 的安全机制：

* **HttpOnly Cookie** — 默认情况下，Javascript 代码可以访问在创建 Cookie 的网站上运行的 Cookie。Javascript 可以读取、更新和删除 Cookie。_HttpOnly_ Cookie 标志（由 Web 服务器设置）表示特定的 Cookie 不能被 Javascript 代码访问。获取它的唯一方法是通过 HTTP 请求和响应头。
* **Secure Cookie** — 当 Cookie 由 Web 服务器设置了 _Secure_ 标志时，只有在使用 HTTPS 时才能将其传回 Web 服务器。

如果域名容易受到子域接管的攻击，攻击者可以通过诱使用户访问该网站来收集该域名过去发出的 Cookie。HttpOnly 和 Secure 标志无济于事，因为 Cookie 不是通过 Javascript 访问的，而且 SSL 证书可以轻松为被接管的域生成。

Arne Swinnen 在漏洞赏金[报告](https://hackerone.com/reports/172137)中解释了使用接管进行 Cookie 窃取。报告解释了 _Ubiquiti Networks_ 的一个子域（_ping.ubnt.com_）的问题。这个子域容易受到子域接管的攻击，指向未认领的 AWS CloudFront 分发。由于 Ubiquiti Networks 使用带通配符会话 Cookie 的 SSO，所有访问 _ping.ubnt.com_ 的用户都可能被窃取会话 Cookie。即使此域名指向 AWS CloudFront，CloudFront 分发设置也允许在每个请求中记录 Cookie。因此，即使是指向 AWS CloudFront 的子域，提取会话 Cookie 的场景也完全有可能。2017 年，Arne 还展示了针对 [Uber 的 SSO 系统](https://www.arneswinnen.net/2017/06/authentication-bypass-on-ubers-sso-via-subdomain-takeover/) 的类似攻击向量。

上述行为不仅限于 Cookie。由于 Javascript 脚本可以完全控制它们运行的网站，因此有能力在合法网站上替换这些脚本可能会导致灾难性的后果。假设网站使用 _script_ 标签和 _src_ 属性从外部提供商那里使用 Javascript 代码。当外部提供商的域名到期时，浏览器会静默失败，即不会触发普通用户可见的任何警报。如果外部代码没有做任何重要的事情（例如，仅用于跟踪），这样的外部提供商可能会在网站上停留很长时间。攻击者可以接管这个过期的域名，匹配提供的 Javascript 代码的 URL 路径，从而控制每个访问原始网站的访客。

然而，有一种方法可以保护浏览器中 Javascript 文件的完整性。_Subresource Integrity_ [被提出](https://www.w3.org/TR/2016/REC-SRI-20160623/) 作为一种机制，在 HTML5 中将加密哈希作为属性 _integrity_ 包含到 _script_ 标签中。当提供的加密哈希与下载文件不匹配时，浏览器拒绝执行它。

### 电子邮件 <a href="#emails" id="emails"></a>

当 CNAME 子域接管成为可能时，攻击者也可以将 MX 记录设置为任意 Web 服务器。这允许接收发送到某品牌合法子域的电子邮件 - 特别是在（针对性）网络钓鱼攻击中非常有用，攻击者和受害者之间的互动是必要的。攻击者通常伪造 `Return-Path` 头以接收对电子邮件的回复。有了正确的 MX 记录，这个问题就被绕过了。

另一方面，发送电子邮件也是可能的。尽管伪造 `From` 头以包含任何电子邮件地址很简单，但 SPF 过滤器通常会检查 `Return-Path` 头和允许的域邮件发送主机。SPF 在 DNS TXT 记录中存储配置。有了子域接管，TXT 记录也在攻击者的控制之下 - SPF 检查可以轻松通过。

_正如我在开始时所提到的，这些策略通常不适用于大多数云提供商，因为你无法直接控制 DNS 区域。_

### 更高阶的风险 <a href="#higherorderrisks" id="higherorderrisks"></a>

子域接管的概念可以自然地扩展到 NS 记录：如果至少有一个 NS 记录的基础域名可供注册，则源域名容易受到子域接管的攻击。

使用 NS 记录进行子域接管的问题之一是源域名通常有多个 NS 记录。多个 NS 记录用于冗余和负载平衡。在 DNS 解析之前，随机选择名称服务器。假设域名 _sub.example.com_ 有两个 NS 记录：_ns.vulnerable.com_ 和 _ns.nonvulnerable.com_。如果攻击者接管了 _ns.vulnerable.com_，用户查询 _sub.example.com_ 的情况如下：

1. 由于有两个名称服务器，随机选择一个。这意味着查询攻击者控制的名称服务器的概率是 50%。
2. 如果用户的 DNS 解析器选择了 _ns.nonvulnerable.com_（合法名称服务器），则返回正确结果，并可能在 6 到 24 小时之间的某处被缓存。
3. 如果用户的 DNS 解析器选择了 _ns.vulnerable.com_（攻击者拥有的名称服务器），攻击者可能提供一个假结果，这也会被缓存。由于攻击者控制了名称服务器，她可以设置这个特定结果的 TTL 为例如一周。

上述过程每次缓存条目到期时都会重复。当攻击者选择使用高值 TTL 时，假结果将在 DNS 缓存中保留那段时间。在此期间，所有对 _sub.example.com_ 的请求都将使用攻击者缓存的假 DNS 结果。当使用公共 DNS 解析器（例如，Google DNS）时，这个想法甚至被放大。在这种情况下，公共解析器可能会缓存假结果，这意味着所有使用相同 DNS 解析器的用户都会获得假结果，直到缓存被撤销。

除了对源域名的控制外，还获得了对源域名所有更高级别域的控制。这是因为拥有 NS 记录的规范域名意味着拥有源域名的完整 DNS 区域。

2016 年，Matthew Bryant [展示](https://thehackerblog.com/the-international-incident-gaining-control-of-a-int-domain-name-with-dns-trickery/index.html)了在 _maris.int_ 上使用 NS 记录进行的子域接管。.INT 顶级域是一个特殊的 TLD，只有少数域名在使用它。Bryant 展示了，尽管这类域名的注册仅由 IANA 独家批准，但名称服务器可以设置为任意域。由于 _maris.int_ 的一个名称服务器可供注册（_cobalt.aliis.be_），即使在这个受限的 TLD 上也可能进行子域接管。

Matthew 还[展示](https://thehackerblog.com/the-io-error-taking-control-of-all-io-domains-with-a-targeted-registration/index.html)了一种更高严重性的攻击，他能够控制 .IO 顶级域的名称服务器。控制 .IO 意味着控制所有 .IO 域名的响应。在这种情况下，.IO 的一个名称服务器是 _ns-a1.io_，它可供注册。通过注册 _ns-a1.io_，Bryant 能够接收 DNS 查询并控制所有 .IO 域的响应。

### 缓解 <a href="#mitigation" id="mitigation"></a>

对于已经容易受到子域接管攻击的域名，缓解策略相当直接：

* **移除受影响的 DNS 记录** — 最简单的解决方案是从 DNS 区域中移除受影响的记录。如果组织得出结论，受影响的源域名不再需要，通常会使用这一步骤。
* **认领域名** — 这意味着在特定云提供商中注册资源，或者在常规互联网域的情况下，重新购买过期的域名。

为了防止未来的子域接管，组织应该改变他们在基础设施中创建和销毁资源的过程。在资源创建的情况下，DNS 记录创建必须是这个过程的 _最后一步_。这个条件防止了 DNS 记录在任何时候指向一个不存在的域。对于资源销毁，相反的情况成立：DNS 记录需要作为这个过程的 _第一步_ 被移除。工具如 [aquatone](https://github.com/michenriksen/aquatone) 包括对子域接管的检查。这些检查应该由组织的安全团队定期执行，以验证没有易受攻击的域名。组织内部通常没有高效的暴露域名的集中收集过程（由于全球团队等），外部监控通常是最佳选择。

云提供商的缓解策略也应该被考虑。云服务没有验证域名所有权。背后的主要原因是便利性。云提供商没有验证源域名所有权并不引入任何漏洞。因此，用户需要监控其 DNS 记录。另一个原因是，当云资源被移除时，用户通常不再是该服务的客户。云提供商然后问自己的问题是：我们为什么还要关心？

提供商如 [GitLab](https://about.gitlab.com/2018/02/05/gitlab-pages-custom-domain-validation/) 意识到子域接管是一个问题，并实施了域名验证机制。

_本文的某些部分摘自我的_ [_硕士论文_](https://is.muni.cz/th/byrdn/Thesis.pdf)。

下次见！

[Patrik](https://twitter.com/0xpatrik)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
使用 [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) 轻松构建并 **自动化工作流程**，由世界上 **最先进** 的社区工具提供支持。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击，使用</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果你想在 HackTricks 中看到你的 **公司广告** 或 **下载 HackTricks 的 PDF** 版本，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享你的黑客技巧。

</details>
```
