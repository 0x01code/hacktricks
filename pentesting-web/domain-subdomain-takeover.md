# Toma de control de dominio/subdominio

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Usa [**Trickest**](https://trickest.io/) para construir y **automatizar flujos de trabajo** con las **herramientas de la comunidad m√°s avanzadas del mundo**.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Toma de control de dominio

Si descubres alg√∫n dominio (dominio.tld) que est√° siendo utilizado por alg√∫n servicio dentro del alcance, pero la **empresa** ha **perdido la propiedad** del mismo, puedes intentar **registrarlo** (si es lo suficientemente barato) y hacer saber a la empresa. Si este dominio est√° recibiendo alguna **informaci√≥n sensible** como una cookie de sesi√≥n a trav√©s del par√°metro **GET** o en la cabecera **Referer**, esto es sin duda una **vulnerabilidad**.

### Toma de control de subdominio

Un subdominio de la empresa apunta a un **servicio de terceros con un nombre no registrado**. Si puedes **crear** una **cuenta** en este **servicio de terceros** y **registrarte** con el **nombre** que se est√° utilizando, puedes realizar la toma de control del subdominio.

Existen varias herramientas con diccionarios para comprobar posibles tomas de control:

* [https://github.com/EdOverflow/can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz)
* [https://github.com/blacklanternsecurity/bbot](https://github.com/blacklanternsecurity/bbot)
* [https://github.com/punk-security/dnsReaper](https://github.com/punk-security/dnsReaper)
* [https://github.com/haccer/subjack](https://github.com/haccer/subjack)
* [https://github.com/anshumanbh/tko-sub](https://github.com/anshumanbh/tko-subs)
* [https://github.com/ArifulProtik/sub-domain-takeover](https://github.com
```
HTTP/1.1 200 OK
Set-Cookie: name=value
```
Si esta cookie es emitida por un servidor web que reside en _example.com_, solo este servidor puede acceder a esta cookie m√°s adelante. Sin embargo, la cookie puede ser emitida para un dominio comod√≠n (por las razones explicadas anteriormente) de la siguiente manera:
```
HTTP/1.1 200 OK
Set-Cookie: name=value; domain=example.com
```
La cookie ser√° incluida en las solicitudes HTTP a _example.com_ pero tambi√©n a cualquier otro subdominio como _subdominio.example.com_. Este comportamiento crea una posibilidad de ataques de alta severidad usando subdominio takeover. Supongamos que un dominio en particular est√° usando cookies de sesi√≥n para un dominio comod√≠n. Si hay un subdominio vulnerable a subdominio takeover, lo √∫nico que se necesita para recopilar el token de sesi√≥n del usuario es enga√±arlo para que visite el subdominio vulnerable. La cookie de sesi√≥n se env√≠a autom√°ticamente con la solicitud HTTP.

El navegador tambi√©n implementa mecanismos de seguridad adicionales para las cookies:

* **Cookie HttpOnly** - Las cookies pueden ser accedidas por defecto por el c√≥digo Javascript que se ejecuta en el contexto del sitio web que cre√≥ las cookies. Javascript puede leer, actualizar y eliminar las cookies. La bandera de cookie _HttpOnly_ (establecida por el servidor web) indica que la cookie en particular no puede ser accedida por el c√≥digo Javascript. La √∫nica forma de obtenerla es a trav√©s de las cabeceras de solicitud y respuesta HTTP.
* **Cookie segura** - Cuando la cookie tiene la bandera _Secure_ establecida por el servidor web, puede ser comunicada de vuelta al servidor web s√≥lo si se utiliza HTTPS.

Si el dominio es vulnerable a subdominio takeover, un atacante puede recopilar cookies emitidas por ese dominio en el pasado s√≥lo enga√±ando a los usuarios para que visiten ese sitio web. Las banderas HttpOnly y Secure no ayudan ya que la cookie no est√° siendo accedida usando Javascript y el certificado SSL puede ser f√°cilmente generado para el dominio tomado.

El robo de cookies usando takeover fue explicado en el informe de recompensa por errores [report](https://hackerone.com/reports/172137) por Arne Swinnen. El informe explica el problema con uno de los subdominios de _Ubiquiti Networks_ (_ping.ubnt.com_). Este subdominio era vulnerable a subdominio takeover, apuntando a una distribuci√≥n de AWS CloudFront no reclamada. Dado que Ubiquiti Networks est√° usando SSO con cookies de sesi√≥n comod√≠n, todos los usuarios que visiten _ping.ubnt.com_ podr√≠an tener sus cookies de sesi√≥n robadas. Aunque este dominio apunta a AWS CloudFront, la configuraci√≥n de la distribuci√≥n de CloudFront permite registrar cookies con cada solicitud. Por lo tanto, el escenario de extracci√≥n de cookies de sesi√≥n es completamente posible incluso con subdominios que apuntan a AWS CloudFront. En 2017, Arne tambi√©n demostr√≥ un vector de ataque similar contra el sistema SSO de [Uber](https://www.arneswinnen.net/2017/06/authentication-bypass-on-ubers-sso-via-subdomain-takeover/).

El comportamiento explicado anteriormente no se limita a las cookies. Dado que los scripts de Javascript tienen control total sobre los sitios web en los que se ejecutan, tener la capacidad de reemplazar dichos scripts en el sitio web leg√≠timo podr√≠a llevar a consecuencias catastr√≥ficas. Supongamos que un sitio web est√° usando c√≥digo Javascript del proveedor externo usando la etiqueta _script_ y el atributo _src_. Cuando el dominio del proveedor externo expira, el navegador falla en silencio, es decir, no activa ninguna alerta visible para los usuarios regulares. Si el c√≥digo externo no est√° haciendo nada importante (por ejemplo, se utiliza s√≥lo para el seguimiento), dicho proveedor externo puede permanecer en el sitio web durante un per√≠odo prolongado. Un atacante puede tomar el control de este dominio caducado, igualar la ruta de URL del c√≥digo Javascript proporcionado y as√≠ obtener el control sobre cada visitante que visite el sitio web original.

Sin embargo, hay una forma de proteger la integridad de los archivos de Javascript en un navegador. _Subresource Integrity_ [fue propuesto](https://www.w3.org/TR/2016/REC-SRI-20160623/) como un mecanismo para incluir el hash criptogr√°fico como un atributo _integrity_ a la etiqueta _script_ en HTML5. Cuando el hash criptogr√°fico proporcionado no coincide con el archivo de descarga, el navegador se niega a ejecutarlo.

### Correos electr√≥nicos <a href="#emails" id="emails"></a>

Cuando es posible el subdominio takeover de CNAME, los registros MX pueden ser configurados por un atacante a un servidor web arbitrario tambi√©n. Esto permite recibir correos electr√≥nicos a un subdominio leg√≠timo de alguna marca, lo que es particularmente √∫til de nuevo en ataques de (spear) phishing donde es necesaria la interacci√≥n entre un atacante y una v√≠ctima. Los atacantes suelen falsificar la cabecera `Return-Path` para recibir una respuesta al correo electr√≥nico. Con los registros MX correctos, este problema se evita.

Por otro lado, tambi√©n es posible enviar correos electr√≥nicos. Aunque es trivial falsificar la cabecera `From` para incluir cualquier direcci√≥n de correo electr√≥nico, los filtros SPF suelen comprobar la cabecera `Return-Path` y los hosts permitidos para enviar correos electr√≥nicos para el dominio. SPF almacena la configuraci√≥n en los registros DNS TXT. Con el subdominio takeover, los registros TXT tambi√©n est√°n bajo el control del atacante - las comprobaciones SPF pueden ser superadas f√°cilmente
