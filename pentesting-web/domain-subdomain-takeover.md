# Tomada de Dom√≠nio/Subdom√≠nio

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.io/) para construir e **automatizar fluxos de trabalho** com as **ferramentas comunit√°rias mais avan√ßadas do mundo**.\
Obtenha acesso hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Tomada de Dom√≠nio

Se voc√™ descobrir algum dom√≠nio (dom√≠nio.tld) que est√° **sendo usado por algum servi√ßo dentro do escopo** mas a **empresa** perdeu a **propriedade** dele, voc√™ pode tentar **registr√°-lo** (se for barato o suficiente) e informar a empresa. Se este dom√≠nio estiver recebendo alguma **informa√ß√£o sens√≠vel** como um cookie de sess√£o via par√¢metro **GET** ou no cabe√ßalho **Referer**, isso √© com certeza uma **vulnerabilidade**.

### Tomada de Subdom√≠nio

Um subdom√≠nio da empresa est√° apontando para um **servi√ßo de terceiros com um nome n√£o registrado**. Se voc√™ pode **criar** uma **conta** neste **servi√ßo de terceiros** e **registrar** o **nome** em uso, voc√™ pode realizar a tomada de subdom√≠nio.

Existem v√°rias ferramentas com dicion√°rios para verificar poss√≠veis tomadas:

* [https://github.com/EdOverflow/can-i-take-over-xyz](https://github.com/EdOverflow/can-i-take-over-xyz)
* [https://github.com/blacklanternsecurity/bbot](https://github.com/blacklanternsecurity/bbot)
* [https://github.com/punk-security/dnsReaper](https://github.com/punk-security/dnsReaper)
* [https://github.com/haccer/subjack](https://github.com/haccer/subjack)
* [https://github.com/anshumanbh/tko-sub](https://github.com/anshumanbh/tko-subs)
* [https://github.com/ArifulProtik/sub-domain-take
```
HTTP/1.1 200 OK
Set-Cookie: name=value
```
Se este cookie √© emitido pelo servidor web que reside em _example.com_, apenas este servidor pode acessar este cookie posteriormente. No entanto, o cookie pode ser emitido para um dom√≠nio curinga (pelos motivos explicados acima) da seguinte maneira:
```
HTTP/1.1 200 OK
Set-Cookie: name=value; domain=example.com
```
O cookie ser√° inclu√≠do em solicita√ß√µes HTTP para _example.com_, mas tamb√©m para qualquer outro subdom√≠nio, como _subdom√≠nio.example.com_. Esse comportamento cria uma possibilidade de ataques de alta gravidade usando a apropria√ß√£o de subdom√≠nio. Suponha que um dom√≠nio espec√≠fico esteja usando cookies de sess√£o para dom√≠nio curinga. Se houver um subdom√≠nio vulner√°vel √† apropria√ß√£o de subdom√≠nio, a √∫nica coisa para obter o token de sess√£o do usu√°rio √© engan√°-lo para visitar o subdom√≠nio vulner√°vel. O cookie de sess√£o √© enviado automaticamente com a solicita√ß√£o HTTP.

O navegador tamb√©m implementa mecanismos de seguran√ßa adicionais para cookies:

* **Cookie HttpOnly** - Os cookies podem ser acessados por padr√£o pelo c√≥digo Javascript em execu√ß√£o no contexto do site que criou os cookies. O Javascript pode ler, atualizar e excluir os cookies. A flag _HttpOnly_ (definida pelo servidor web) indica que o cookie espec√≠fico n√£o pode ser acessado pelo c√≥digo Javascript. A √∫nica maneira de obt√™-lo √© por meio de cabe√ßalhos de solicita√ß√£o e resposta HTTP.
* **Cookie seguro** - Quando o cookie tem a flag _Secure_ definida pelo servidor web, ele pode ser comunicado de volta ao servidor web somente se o HTTPS for usado.

Se o dom√≠nio for vulner√°vel √† apropria√ß√£o de subdom√≠nio, um invasor pode coletar cookies emitidos por esse dom√≠nio no passado apenas enganando os usu√°rios para visitar esse site. As flags HttpOnly e Secure n√£o ajudam, pois o cookie n√£o est√° sendo acessado usando Javascript e o certificado SSL pode ser facilmente gerado para o dom√≠nio apropriado.

O roubo de cookies usando a apropria√ß√£o foi explicado em um relat√≥rio de recompensa por bug [report](https://hackerone.com/reports/172137) por Arne Swinnen. O relat√≥rio explica o problema com um dos subdom√≠nios da _Ubiquiti Networks_ (_ping.ubnt.com_). Este subdom√≠nio era vulner√°vel √† apropria√ß√£o de subdom√≠nio, apontando para uma distribui√ß√£o n√£o reclamada da AWS CloudFront. Como a Ubiquiti Networks est√° usando SSO com cookies de sess√£o curinga, todos os usu√°rios que visitam _ping.ubnt.com_ podem ter seus cookies de sess√£o roubados. Mesmo que este dom√≠nio esteja apontando para a AWS CloudFront, as configura√ß√µes de distribui√ß√£o do CloudFront permitem o registro de cookies com cada solicita√ß√£o. Portanto, o cen√°rio de extra√ß√£o de cookies de sess√£o √© totalmente poss√≠vel, mesmo com subdom√≠nios apontando para a AWS CloudFront. Em 2017, Arne tamb√©m demonstrou um vetor de ataque semelhante contra o [sistema SSO da Uber](https://www.arneswinnen.net/2017/06/authentication-bypass-on-ubers-sso-via-subdomain-takeover/).

O comportamento explicado acima n√£o se limita a cookies. Como os scripts Javascript t√™m controle total sobre os sites em que s√£o executados, ter a capacidade de substituir esses scripts no site leg√≠timo pode levar a consequ√™ncias catastr√≥ficas. Suponha que o site esteja usando c√≥digo Javascript do provedor externo usando a tag _script_ e o atributo _src_. Quando o dom√≠nio do provedor externo expira, o navegador falha silenciosamente, ou seja, n√£o aciona nenhum alerta vis√≠vel para usu√°rios regulares. Se o c√≥digo externo n√£o estiver fazendo nada importante (por exemplo, √© usado apenas para rastreamento), esse provedor externo pode permanecer no site por um per√≠odo prolongado. Um invasor pode assumir esse dom√≠nio expirado, corresponder ao caminho de URL do c√≥digo Javascript fornecido e, assim, obter o controle sobre cada visitante que visita o site original.

No entanto, h√° uma maneira de proteger a integridade dos arquivos Javascript em um navegador. _Subresource Integrity_ [foi proposto](https://www.w3.org/TR/2016/REC-SRI-20160623/) como um mecanismo para incluir o hash criptogr√°fico como um atributo _integrity_ na tag _script_ em HTML5. Quando o hash criptogr√°fico fornecido n√£o corresponde ao arquivo de download, o navegador se recusa a execut√°-lo.

### E-mails <a href="#emails" id="emails"></a>

Quando a apropria√ß√£o de subdom√≠nio CNAME √© poss√≠vel, registros MX podem ser configurados por um invasor para um servidor web arbitr√°rio tamb√©m. Isso permite receber e-mails para um subdom√≠nio leg√≠timo de alguma marca - particularmente √∫til novamente em ataques de phishing (spear) onde a intera√ß√£o entre um invasor e a v√≠tima √© necess√°ria. Os invasores geralmente falsificam o cabe√ßalho `Return-Path` para receber uma resposta ao e-mail. Com registros MX corretos, esse problema √© contornado.

Por outro lado, tamb√©m √© poss√≠vel enviar e-mails. Embora seja trivial falsificar o cabe√ßalho `From` para incluir qualquer endere√ßo de e-mail, os filtros SPF geralmente verificam o cabe√ßalho `Return-Path` e os hosts de envio de e-mail permitidos para o dom√≠nio. SPF armazena a configura√ß√£o
