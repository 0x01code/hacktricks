# MySQL File priv to SSRF/RCE

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

**Este √© um resumo das t√©cnicas do MySQL/MariaDB/Percona de [https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)**.

### Server-Side Request Forgery (SSRF) via Fun√ß√µes SQL

Na explora√ß√£o da exfiltra√ß√£o de dados Out of Band do SQL, a fun√ß√£o `LOAD_FILE()` √© comumente utilizada para iniciar solicita√ß√µes de rede. No entanto, essa fun√ß√£o √© limitada pelo sistema operacional em que opera e pelas configura√ß√µes de inicializa√ß√£o do banco de dados.

A vari√°vel global `secure_file_priv`, se n√£o definida, tem como padr√£o `/var/lib/mysql-files/`, limitando o acesso a arquivos a este diret√≥rio, a menos que seja definida como uma string vazia (`""`). Este ajuste requer modifica√ß√µes no arquivo de configura√ß√£o do banco de dados ou nos par√¢metros de inicializa√ß√£o.

Dado que `secure_file_priv` est√° desativado (`""`), e assumindo que as permiss√µes necess√°rias de arquivo e `file_priv` s√£o concedidas, arquivos fora do diret√≥rio designado podem ser lidos. No entanto, a capacidade dessas fun√ß√µes de fazer chamadas de rede depende muito do sistema operacional. Em sistemas Windows, chamadas de rede para caminhos UNC s√£o poss√≠veis devido ao entendimento do sistema operacional das conven√ß√µes de nomenclatura UNC, potencialmente levando √† exfiltra√ß√£o de hashes NTLMv2.

Este m√©todo de SSRF √© limitado √† porta TCP 445 e n√£o permite a modifica√ß√£o do n√∫mero da porta, embora possa ser usado para acessar compartilhamentos com privil√©gios de leitura total e, como demonstrado em pesquisas anteriores, para roubar hashes para explora√ß√£o adicional.

### Execu√ß√£o de C√≥digo Remoto (RCE) via Fun√ß√µes Definidas pelo Usu√°rio (UDF)

Bancos de dados MySQL oferecem o uso de Fun√ß√µes Definidas pelo Usu√°rio (UDF) a partir de arquivos de biblioteca externos. Se essas bibliotecas forem acess√≠veis dentro de diret√≥rios espec√≠ficos ou no `$PATH` do sistema, elas podem ser invocadas de dentro do MySQL.

Essa t√©cnica permite a execu√ß√£o de solicita√ß√µes de rede/HTTP por meio de uma UDF, desde que v√°rias condi√ß√µes sejam atendidas, incluindo acesso de grava√ß√£o ao `@@plugin_dir`, `file_priv` definido como `Y` e `secure_file_priv` desativado.

Por exemplo, a biblioteca `lib_mysqludf_sys` ou outras bibliotecas UDF que permitem solicita√ß√µes HTTP podem ser carregadas para realizar SSRF. As bibliotecas devem ser transferidas para o servidor, o que pode ser alcan√ßado por meio da codifica√ß√£o em hexadecimal ou base64 do conte√∫do da biblioteca e, em seguida, gravando-a no diret√≥rio apropriado.

O processo varia se o `@@plugin_dir` n√£o for grav√°vel, especialmente para vers√µes do MySQL acima de `v5.0.67`. Nesses casos, devem ser usados caminhos alternativos que sejam grav√°veis.

A automa√ß√£o desses processos pode ser facilitada por ferramentas como o SQLMap, que suporta inje√ß√£o de UDF, e para inje√ß√µes de SQL cegas, a redire√ß√£o de sa√≠da ou t√©cnicas de contrabando de solicita√ß√£o DNS podem ser utilizadas.

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
