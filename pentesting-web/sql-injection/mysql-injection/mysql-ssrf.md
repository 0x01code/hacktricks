# MySQLファイル権限からSSRF/RCEへ

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で私をフォローする🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **ハッキングトリックを共有するには、**[**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出してください。

</details>

**これは[https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/)からのMySQL/MariaDB/Perconaテクニックの要約です**。

### SQL関数を使用したサーバーサイドリクエストフォージェリ（SSRF）

SQL Out of Bandデータの外部流出を探索する中で、`LOAD_FILE()`関数がネットワークリクエストを開始するために一般的に使用されます。ただし、この関数は、それが動作するオペレーティングシステムとデータベースの起動構成によって制約されます。

`secure_file_priv`グローバル変数は、未設定の場合、`/var/lib/mysql-files/`にデフォルトで設定され、このディレクトリへのファイルアクセスが制限されます（空の文字列（`""`）に設定されていない限り）。この調整には、データベースの構成ファイルや起動パラメータの変更が必要です。

`secure_file_priv`が無効（`""`）であり、必要なファイルと`file_priv`権限が付与されていると仮定すると、指定されたディレクトリの外のファイルを読み取ることができます。ただし、これらの関数がネットワーク呼び出しを行う能力は、オペレーティングシステムに大きく依存します。Windowsシステムでは、UNCパスへのネットワーク呼び出しが可能です。これは、オペレーティングシステムがUNC名前規則を理解しているため、NTLMv2ハッシュの流出につながる可能性があります。

このSSRFメソッドはTCPポート445に限定され、ポート番号の変更は許可されませんが、読み取り権限が完全な共有へのアクセスや、以前の研究で示されたように、ハッシュの盗難などに利用できます。

### ユーザー定義関数（UDF）を介したリモートコード実行（RCE）

MySQLデータベースでは、外部ライブラリファイルからユーザー定義関数（UDF）の使用が提供されます。これらのライブラリが特定のディレクトリ内またはシステムの`$PATH`内でアクセス可能であれば、MySQL内から呼び出すことができます。

このテクニックを使用すると、`@@plugin_dir`への書き込みアクセス、`file_priv`が`Y`に設定されていること、および`secure_file_priv`が無効であることなど、いくつかの条件が満たされれば、UDFを介してネットワーク/HTTPリクエストを実行できます。

たとえば、`lib_mysqludf_sys`ライブラリや他のHTTPリクエストを可能にするUDFライブラリをロードしてSSRFを実行できます。ライブラリはサーバーに転送する必要があり、これはライブラリの内容を16進数やbase64エンコードして適切なディレクトリに書き込むことで実現できます。

`@@plugin_dir`が書き込み可能でない場合、特に`v5.0.67`以上のMySQLバージョンの場合、プロセスは異なります。そのような場合は、書き込み可能な代替パスを使用する必要があります。

これらのプロセスの自動化は、UDFインジェクションをサポートするSQLMapなどのツールによって容易に行うことができ、盲目的なSQLインジェクションの場合、出力リダイレクションやDNSリクエストスマグリング技術を利用することができます。
