# 2FA/OTPバイパス

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## **2要素認証のバイパス**

### **直接バイパス**

2FAをバイパスするには、**次のエンドポイントに直接アクセスしてみてください**（次のエンドポイントのパスを知っている必要があります）。これが機能しない場合は、2FAページから来たかのように**Referrerヘッダー**を変更してみてください。

### **トークンの再利用**

以前に使用したトークンをアカウント内で再利用して認証することができるかもしれません。

### 未使用トークンの共有

アカウントからトークンを取得し、別のアカウントで2FAをバイパスするために使用できるかどうかを確認してください。

### リークされたトークン

ウェブアプリケーションからの応答でトークンがリークしていますか？

### メール確認リンク

**アカウント作成時に受け取ったメール確認リンク**を使用して、2FAが設定されていてもそのリンクだけでプロファイルにアクセスできるかどうかを確認してください（[投稿](https://srahulceh.medium.com/behind-the-scenes-of-a-security-bug-the-perils-of-2fa-cookie-generation-496d9519771b)）。

### セッション権限

同じセッションを使用して、あなたのアカウントと被害者のアカウントでフローを開始します。両方のアカウントで2FAポイントに到達したら、あなたのアカウントで2FAを完了しますが、次の部分にはアクセスしません。その代わりに、被害者のアカウントフローの次のステップにアクセスしてみてください。バックエンドがあなたのセッション内に2FAを正常に通過したというブール値を設定しているだけの場合、被害者の2FAをバイパスできる可能性があります。

### **パスワードリセット機能**

ほとんどのウェブアプリケーションでは、**パスワードリセット機能がリセット手順が完了した後に自動的にユーザーをアプリケーションにログインさせます**。\
**メール**が送信されているかどうか、**リンク**が含まれているかどうか、その**リンク**を**何度でも再利用**してパスワードをリセットできるかどうか（被害者がメールアドレスを変更しても）を確認してください。

パスワードリセット機能を使用して2FAをバイパスする別の方法は、**メールへのアクセスでパスワードをリセット**し、**新しいパスワードでログインする**ことです。パスワード変更後に2FAが使用されない可能性があります。

### OAuth

ユーザーのアカウントを信頼されている**OAuth**プラットフォーム（Google、Facebook...）で侵害できる場合

### ブルートフォース

#### レート制限の欠如

試せるコードの数に制限はありますか？ただブルートフォースできますか？可能な「サイレント」レート制限に注意してください。常に複数のコードを試してから、脆弱性を確認するために本物のコードを試してください。

#### フローレート制限があるがレート制限はない

この場合、フローレート制限があります（非常にゆっくりとブルートフォースする必要があります：1スレッドと2回の試行の前にいくらかのスリープ）が、レート制限はありません。十分な時間があれば、有効なコードを見つけることができます。

#### コードを再送して制限をリセットする

レート制限がありますが、「コードを再送する」と同じコードが送信され、レート制限がリセットされます。その後、レート制限に達することなくコードをブルートフォースしながら再送することができます。

#### クライアント側のレート制限バイパス

{% content-ref url="rate-limit-bypass.md" %}
[rate-limit-bypass.md](rate-limit-bypass.md)
{% endcontent-ref %}

#### ユーザーアカウントのレート制限の欠如

時々、アカウント内のいくつかのアクション（メール、パスワードの変更など）に2FAを設定できます。しかし、ログインしようとしたときにレート制限がある場合でも、アカウント内のアクションを保護するレート制限はありません。

#### SMS経由でコードを再送する際のレート制限の欠如

2FAをバイパスすることはできませんが、会社のお金を無駄にすることができます。

#### 無限のOTP再生成

**無限に新しいOTPを生成**でき、OTPが**十分に単純**（4桁の数字）で、生成されたOTPごとに最大4または5つのトークンを試すことができる場合、同じ4または5つのトークンを毎回試してOTPを生成し続けることができます。それがあなたが使用しているものと一致するまで。

### レースコンディション

以下のページの2FAバイパスに関するセクションを確認してください：

{% content-ref url="race-condition.md" %}
[race-condition.md](race-condition.md)
{% endcontent-ref %}

### CSRF/クリックジャッキング

Cross Site Request Forgery（CSRF）またはクリックジャッキングの脆弱性がないか確認して、2FAを無効にします。

### リメンバーミー機能

#### 推測可能なクッキー

「リメンバーミー」機能が推測可能なコードを使用した新しいクッキーを使用している場合は、それを推測してみてください。

#### IPアドレス

「リメンバーミー」機能があなたのIPアドレスに紐付けられている場合は、被害者のIPアドレスを推測し、**X-Forwarded-For**ヘッダーを使用してそれを偽装することができます。

### 古いバージョン

#### サブドメイン

「テスト」サブドメインでログイン機能を見つけることができれば、それらは2FAをサポートしていない古いバージョンを使用している可能性があります（そのため直接バイパスされます）、またはそれらのエンドポイントが2FAの脆弱なバージョンをサポートしている可能性があります。

#### API

2FAが/v\*/ディレクトリ（例："/v3/"）の下にあるAPIを使用していることがわかった場合、これはおそらく2FAバイパスに脆弱な古いAPIエンドポイントが存在することを意味しています。

### 以前のセッション

2FAが有効になると、以前に作成されたセッションは終了するべきです。これは、クライアントがアカウントを侵害された場合、2FAを有効にすることでそれを保護したいと思うかもしれませんが、以前のセッションが終了していない場合、これは彼を保護しません。

### バックアップコードへの不適切なアクセス制御

バックアップコードは2FAが有効になった直後に生成され、単一のリクエストで利用可能です。その後の各リクエストで、コードは再生成されるか、変更されないまま（静的コード）です。CORSの誤設定/XSSの脆弱性やバックアップコードエンドポイントの応答リクエストからバックアップコードを「引き出す」ことを可能にする他のバグがある場合、攻撃者はコードを盗んで2FAをバイパスできる可能性があります。ユーザー名とパスワードがわかっている場合。

### 情報開示

2FAページに以前は知らなかった機密情報（電話番号など）が表示されることに気づいた場合、これは情報開示の脆弱性と見なすことができます。

### **パスワードリセット == 2FA無効**

1. アカウントを作成し、2FAをオンにします。
2. そのアカウントからログアウトします。
3. 今、パスワードリセットページに行きます。
4. パスワードを変更します。
5. 今、ログインを試みます。
6. 2FAコードを入力するように求められない場合、報告することができます。

## 参考文献

{% embed url="https://medium.com/@iSecMax/two-factor-authentication-security-testing-and-possible-bypasses-f65650412b35" %}

{% embed url="https://azwi.medium.com/2-factor-authentication-bypass-3b2bbd907718" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**PEASSファミリー**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
