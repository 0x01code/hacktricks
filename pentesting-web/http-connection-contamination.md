# HTTP接続の汚染

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

**この投稿の内容は** [**https://portswigger.net/research/http-3-connection-contamination**](https://portswigger.net/research/http-3-connection-contamination) **から取得されました**\*\*\*\*

Webブラウザは、異なるウェブサイトに向けたリクエストに対して、同じIPアドレスに解決し、両方のホスト名に対して有効なTLS証明書を使用する場合、**HTTP接続の結合**を使用します。

**最初のリクエストのルーティング**は、リバースプロキシの危険な動作であり、**プロキシが接続の最初のリクエストを分析**して、それをどのバックエンドにルーティングするかを判断し、その後のすべてのリクエストを**同じバックエンド**に送信します。

**接続の結合と最初のリクエストのルーティングはうまく動作しません**。例えば、secure.example.comとwordpress.example.comが両方ともリバースプロキシの背後にあり、\*.example.comに対して有効な証明書を使用している場合を想像してください。
```shell-session
$ nslookup wordpress.example.com
52.16.179.7 // reverse proxy that supports HTTP/2 and does first-request routing

$ nslookup secure.example.com
52.16.179.7 // same reverse proxy

$ openssl s_client -connect x.portswigger-labs.net:443
subject=/CN=*.example.com // wildcard TLS certificate
```
もしブラウザが**wordpress.example.comにリクエストを送信した後にsecure.example.comにリクエストを送信**しようとする場合、ブラウザの接続統合により、**両方のリクエストが1つの接続に強制的に統合**されます。最初のリクエストのルーティングにより、**secure.example.comへのリクエストが誤ってWordPressのバックエンドにルーティング**されます。つまり、wordpress.example.comで[XSS](https://portswigger.net/web-security/cross-site-scripting)を見つけた場合、それを使用してsecure.example.comを侵害することができます！
```javascript
// create HTTP/2+ connection
fetch('https://wordpress.example.com/', {credentials: 'include'})

// connection coalescing will force this down the same connection...
// ...leading to the front-end misrouting it to WordPress
// the browser thinks our injected JS is coming from secure.example.com
// exposing saved passwords, cookies, etc.
location='https://secure.example.com/plugin/x?q=<script>stealPasswords()'
```
自分で**接続の結合**を探索することができます。Chromeの開発者ツールの**ネットワークタブのタイミンググラフ**を使用して（または masochist なら WireShark を使用して）、fetch()を使用してリクエストペアを発行し、グラフが2番目のリクエストの「初期接続」に費やされた時間を表示し、接続IDの列が一致するかどうかを確認してください：

{% code overflow="wrap" %}
```javascript
fetch('//sub1.hackxor.net/', {mode: 'no-cors', credentials: 'include'}).then(()=>{ fetch('//sub2.hackxor.net/', {mode: 'no-cors', credentials: 'include'}) })
```
{% endcode %}

<figure><img src="../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

この脅威を詳しく調査したり、実際に発生しているかどうかをスキャンする時間を割いていませんが、現在はまれな状況であると考えています。まず、最初のリクエストのルーティングは比較的一般的ではなく、HTTP/2の実装の複雑さから、HTTP/1.1に比べてユニークなHTTP/2サーバーの数は非常に少ないです。また、接続の統合により、最初のリクエストのルーティングを行うHTTP/2サーバーは、正規の訪問者に対して一時的に破損する可能性があるため、所有者は攻撃者の助言なしで脆弱性を修正する可能性があります。

しかし、攻撃者にとってはすべてが悪いわけではありません。**HTTP/3では**、[**IPアドレスの一致が必要な要件を削除することが提案されています**](https://www.rfc-editor.org/rfc/rfc9114.html#name-connection-reuse)**。これにより、最初のリクエストのルーティングを使用し、複数のホストに対して有効な証明書を持つフロントエンドを使用しているすべての人が公開されることになります**。

これにより、最初のリクエストのルーティングとは関係のない第二のリスクも生じます。つまり、ワイルドカード証明書を持つ侵害されたサーバーは、MITMを必要とせずに悪用することができるようになります。実際には、これにより、悪意のある行為者のプールが大幅に増加します。

これらのリスクが現実のものになる前に、リバースプロキシが最初のリクエストのルーティングを行わないように注意してください。Repeaterでこれを手動でテストするには、HTTP/1とHTTP/2の接続の再利用を有効にし、[HTTP Request Smuggler](https://github.com/PortSwigger/http-request-smuggler)で「Connection-State」攻撃を使用してスキャンすることもできます。また、ワイルドカードTLS証明書は常に理想的ではありませんが、HTTP/3により、ワイルドカード証明書を持つ侵害されたサーバーはアクティブなMITMなしで姉妹ドメインを攻撃するために使用される可能性があります。

これらの新たな脅威は、ウェブインフラストラクチャが複雑に絡み合った混乱の中に陥っていくという継続的なトレンドを示しています。個々のサイトの弱点が全体システムのセキュリティに多くの非明示的な影響を与えるということです。これらのリスクが実際にどのように影響するか、興味深いです。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロードしたりしたいですか？** [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) **をチェックしてください！**
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出してください。**

</details>
