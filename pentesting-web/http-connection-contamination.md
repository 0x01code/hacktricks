# Contamina√ß√£o de Conex√£o HTTP

Os navegadores da web usam o [**HTTP connection coalescing**](https://daniel.haxx.se/blog/2016/08/18/http2-connection-coalescing), que permite que eles **reutilizem** uma √∫nica **conex√£o HTTP/2+** para solicita√ß√µes que v√£o para **diferentes sites**, desde que os sites **resolvam para o mesmo IP** e usem um certificado TLS v√°lido para ambos os nomes de host.

O **roteamento da primeira solicita√ß√£o** √© um comportamento perigoso de proxy reverso em que o **proxy analisa a primeira solicita√ß√£o** em uma conex√£o para descobrir **qual back-end** rote√°-la e, em seguida, **envia** todas as **solicita√ß√µes subsequentes** nessa conex√£o para o **mesmo back-end**.

**A coalesc√™ncia de conex√£o e o roteamento da primeira solicita√ß√£o n√£o funcionam bem juntos**. Por exemplo, imagine que secure.example.com e wordpress.example.com est√£o ambos atr√°s de um proxy reverso usando um certificado v√°lido para \*.example.com:
```shell-session
$ nslookup wordpress.example.com
52.16.179.7 // reverse proxy that supports HTTP/2 and does first-request routing

$ nslookup secure.example.com
52.16.179.7 // same reverse proxy

$ openssl s_client -connect x.portswigger-labs.net:443
subject=/CN=*.example.com // wildcard TLS certificate
```
Se um navegador tentar enviar uma solicita√ß√£o para **wordpress.example.com** seguido por **secure.example.com**, a coalesc√™ncia de conex√£o do navegador for√ßar√° **ambas as solicita√ß√µes em uma √∫nica conex√£o** para o front-end. O roteamento da primeira solicita√ß√£o resultar√° na **solicita√ß√£o para secure.example.com ser incorretamente roteada para o back-end do WordPress**. Isso significa que se voc√™ encontrar [XSS](https://portswigger.net/web-security/cross-site-scripting) em wordpress.example.com, voc√™ pode us√°-lo para comprometer secure.example.com!
```javascript
// create HTTP/2+ connection
fetch('https://wordpress.example.com/', {credentials: 'include'})

// connection coalescing will force this down the same connection...
// ...leading to the front-end misrouting it to WordPress
// the browser thinks our injected JS is coming from secure.example.com
// exposing saved passwords, cookies, etc.
location='https://secure.example.com/plugin/x?q=<script>stealPasswords()'
```
Voc√™ pode **explorar a coalesc√™ncia de conex√£o por si mesmo** usando o **gr√°fico de tempo na aba Network nas ferramentas de desenvolvedor do Chrome** (ou usando o WireShark se voc√™ √© um masoquista). Emita pares de solicita√ß√µes usando fetch() e veja se o gr√°fico mostra o tempo gasto na 'Conex√£o inicial' para a segunda solicita√ß√£o, e se a coluna ID de conex√£o corresponde: 

{% code overflow="wrap" %}
```javascript
fetch('//sub1.hackxor.net/', {mode: 'no-cors', credentials: 'include'}).then(()=>{ fetch('//sub2.hackxor.net/', {mode: 'no-cors', credentials: 'include'}) })
```
{% endcode %}

<figure><img src="../.gitbook/assets/image (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

N√£o investi o tempo necess√°rio para explorar essa amea√ßa em profundidade ou procur√°-la na natureza, pois acredito que atualmente √© rara por duas raz√µes. Em primeiro lugar, o roteamento de primeira solicita√ß√£o √© relativamente incomum e a complexidade de implementa√ß√£o do HTTP/2 significa que h√° apenas um pequeno conjunto de servidores HTTP/2 exclusivos em rela√ß√£o ao HTTP/1.1. Em segundo lugar, a coalesc√™ncia de conex√£o significa que os servidores HTTP/2 que executam o roteamento de primeira solicita√ß√£o podem quebrar intermitentemente para visitantes genu√≠nos, ent√£o os propriet√°rios podem acabar corrigindo a vulnerabilidade sem incentivo do atacante.

Dito isso, nem tudo s√£o m√°s not√≠cias para os atacantes. O **HTTP/3 prop√µe** [**remover o requisito de correspond√™ncia de endere√ßo IP**](https://www.rfc-editor.org/rfc/rfc9114.html#name-connection-reuse)**, o que expor√° todos que possuem um front-end que usa o roteamento de primeira solicita√ß√£o e tem um certificado v√°lido para v√°rios hosts**.

Isso tamb√©m cria um segundo risco que n√£o est√° relacionado ao roteamento de primeira solicita√ß√£o - significa que um **servidor comprometido com um certificado curinga n√£o requer mais um MITM para ser explorado**. Na pr√°tica, isso aumenta muito o n√∫mero de atores mal-intencionados que podem se beneficiar disso.

Para evitar esses riscos antes que se tornem realidade, certifique-se de que seus proxies reversos n√£o executem o roteamento de primeira solicita√ß√£o. Voc√™ pode testar isso manualmente no Repeater, habilitando o reuso de conex√£o HTTP/1 e HTTP/2, e tamb√©m procurar por isso usando o ataque 'Connection-State' em [HTTP Request Smuggler](https://github.com/PortSwigger/http-request-smuggler). Al√©m disso, esteja ciente de que, embora os certificados TLS curinga nunca tenham sido ideais, o HTTP/3 significa que um servidor comprometido com um certificado curinga agora pode ser usado para atacar dom√≠nios irm√£os sem um MITM ativo.

Essas novas amea√ßas continuam a tend√™ncia cont√≠nua de infraestrutura da web se transformando em uma bagun√ßa altamente entrela√ßada, onde uma fraqueza em qualquer site individual tem numerosos efeitos colaterais n√£o √≥bvios na seguran√ßa do sistema geral. Ser√° interessante ver como esses riscos se desenrolam na pr√°tica.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
