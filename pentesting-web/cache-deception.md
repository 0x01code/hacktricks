# Envenenamiento de Cach√© y Enga√±o de Cach√©

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Usa [**Trickest**](https://trickest.com/?utm_campaign=hacktrics\&utm_medium=banner\&utm_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente, potenciados por las herramientas comunitarias **m√°s avanzadas**.\
Obt√©n Acceso Hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diferencia

> **¬øCu√°l es la diferencia entre envenenamiento de cach√© web y enga√±o de cach√© web?**
>
> * En el **envenenamiento de cach√© web**, el atacante provoca que la aplicaci√≥n almacene contenido malicioso en la cach√©, y este contenido se sirve desde la cach√© a otros usuarios de la aplicaci√≥n.
> * En el **enga√±o de cach√© web**, el atacante provoca que la aplicaci√≥n almacene contenido sensible perteneciente a otro usuario en la cach√©, y luego el atacante recupera este contenido de la cach√©.

## Envenenamiento de Cach√©

El objetivo de envenenar la cach√© es hacer que los **clientes carguen recursos inesperados parcialmente o controlados por el atacante**.\
La respuesta envenenada solo se servir√° a los usuarios que visiten la p√°gina afectada mientras la cach√© est√© envenenada. Como resultado, el impacto puede variar de inexistente a masivo dependiendo de si la p√°gina es popular o no.

Para realizar un ataque de envenenamiento de cach√©, primero necesitas **identificar entradas no claveadas** (par√°metros que no necesitan aparecer en la solicitud cach√© pero que cambian la p√°gina devuelta), ver **c√≥mo abusar** de este par√°metro y **conseguir que la respuesta se almacene en la cach√©**.

### Descubrimiento: Verificar cabeceras HTTP

Normalmente, cuando una respuesta fue **almacenada en la cach√©** habr√° una **cabecera indic√°ndolo**, puedes verificar qu√© cabeceras deber√≠as prestar atenci√≥n en este post: [**Cabeceras de Cach√© HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descubrimiento: Cach√© de c√≥digo 400

Si piensas que la respuesta est√° siendo almacenada en una cach√©, podr√≠as intentar **enviar solicitudes con una mala cabecera**, que deber√≠a ser respondida con un **c√≥digo de estado 400**. Luego intenta acceder a la solicitud normalmente y si la **respuesta es un c√≥digo de estado 400**, sabes que es vulnerable (y podr√≠as incluso realizar un DoS).\
Una cabecera mal configurada podr√≠a ser simplemente `\:` como cabecera.\
_Nota que a veces estos tipos de c√≥digos de estado no se almacenan en la cach√©, por lo que esta prueba ser√° in√∫til._

### Descubrimiento: Identificar y evaluar entradas no claveadas

Podr√≠as usar [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **fuerza bruta de par√°metros y cabeceras** que puedan estar **cambiando la respuesta de la p√°gina**. Por ejemplo, una p√°gina puede estar utilizando la cabecera `X-Forwarded-For` para indicar al cliente que cargue el script desde all√≠:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Provocar una respuesta perjudicial del servidor back-end

Con el par√°metro/cabecera identificado, verifica c√≥mo est√° siendo **sanitizado** y **d√≥nde** se est√° **reflejando** o afectando la respuesta de la cabecera. ¬øPuedes abusar de √©l de alguna manera (realizar un XSS o cargar un c√≥digo JS controlado por ti? ¬ørealizar un DoS?...)

### Obtener la respuesta almacenada en cach√©

Una vez que hayas **identificado** la **p√°gina** que puede ser abusada, qu√© **par√°metro**/**cabecera** usar y **c√≥mo** **abusar** de ella, necesitas conseguir que la p√°gina se almacene en cach√©. Dependiendo del recurso que est√©s intentando almacenar en cach√©, esto podr√≠a llevar alg√∫n tiempo, es posible que necesites estar intent√°ndolo durante varios segundos.\
La cabecera **`X-Cache`** en la respuesta podr√≠a ser muy √∫til ya que puede tener el valor **`miss`** cuando la solicitud no fue almacenada en cach√© y el valor **`hit`** cuando s√≠ lo est√°.\
La cabecera **`Cache-Control`** tambi√©n es interesante para saber si un recurso est√° siendo almacenado en cach√© y cu√°ndo ser√° la pr√≥xima vez que el recurso se almacene de nuevo: `Cache-Control: public, max-age=1800`\
Otra cabecera interesante es **`Vary`**. Esta cabecera se utiliza a menudo para **indicar cabeceras adicionales** que se tratan como **parte de la clave de cach√©** incluso si normalmente no lo son. Por lo tanto, si el usuario conoce el `User-Agent` de la v√≠ctima a la que est√° apuntando, puede envenenar la cach√© para los usuarios que utilicen ese `User-Agent` espec√≠fico.\
Una cabecera m√°s relacionada con la cach√© es **`Age`**. Define el tiempo en segundos que el objeto ha estado en la cach√© del proxy.

Al almacenar una solicitud en cach√©, ten **cuidado con las cabeceras que usas** porque algunas de ellas podr√≠an ser **utilizadas inesperadamente** como **claveadas** y la **v√≠ctima necesitar√° usar esa misma cabecera**. Siempre **prueba** un envenenamiento de cach√© con **diferentes navegadores** para comprobar si est√° funcionando.

## Ejemplos de Explotaci√≥n

### Ejemplo m√°s sencillo

Una cabecera como `X-Forwarded-For` se refleja en la respuesta sin sanitizar>\
Puedes enviar una carga √∫til XSS b√°sica y envenenar la cach√© para que todos los que accedan a la p√°gina sean XSSed:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Tenga en cuenta que esto envenenar√° una solicitud a `/en?region=uk` no a `/en`_

### Utilizando el envenenamiento de cach√© web para explotar vulnerabilidades en el manejo de cookies

Las cookies tambi√©n podr√≠an reflejarse en la respuesta de una p√°gina. Si puedes abusar de esto para causar un XSS, por ejemplo, podr√≠as ser capaz de explotar XSS en varios clientes que cargan la respuesta maliciosa de la cach√©.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Tenga en cuenta que si la cookie vulnerable es muy utilizada por los usuarios, las solicitudes regulares estar√°n limpiando la cach√©.

### Utilizando m√∫ltiples encabezados para explotar vulnerabilidades de envenenamiento de cach√© web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

A veces necesitar√°s **explotar varias entradas no claveadas** para poder abusar de una cach√©. Por ejemplo, puedes encontrar un **Open redirect** si configuras `X-Forwarded-Host` a un dominio controlado por ti y `X-Forwarded-Scheme` a `http`. **Si** el **servidor** est√° **redirigiendo** todas las solicitudes **HTTP** a **HTTPS** y utilizando el encabezado `X-Forwarded-Scheme` como el nombre de dominio para la redirecci√≥n. Puedes controlar hacia d√≥nde apunta la p√°gina por la redirecci√≥n.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explotaci√≥n con cabecera `Vary` limitada

Si descubres que la cabecera **`X-Host`** se utiliza como **nombre de dominio para cargar un recurso JS** pero la cabecera **`Vary`** en la respuesta indica **`User-Agent`**. Entonces, necesitas encontrar una manera de exfiltrar el User-Agent de la v√≠ctima y envenenar la cach√© utilizando ese user agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Explotaci√≥n de envenenamiento de cach√© HTTP abusando del contrabando de solicitudes HTTP

Aprende aqu√≠ c√≥mo realizar [ataques de envenenamiento de cach√© abusando del contrabando de solicitudes HTTP](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Pruebas automatizadas para envenenamiento de cach√© web

El [Esc√°ner de Vulnerabilidades de Cach√© Web](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) se puede utilizar para probar autom√°ticamente el envenenamiento de cach√© web. Soporta muchas t√©cnicas diferentes y es altamente personalizable.

Ejemplo de uso: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente, potenciados por las herramientas comunitarias **m√°s avanzadas** del mundo.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ejemplos vulnerables

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS reenviaba el fragmento dentro de la URL sin eliminarlo y generaba la clave de cach√© solo usando el host, la ruta y la consulta (ignorando el fragmento). Por lo tanto, la solicitud `/#/../?r=javascript:alert(1)` se enviaba al backend como `/#/../?r=javascript:alert(1)` y la clave de cach√© no ten√≠a el payload dentro de ella, solo host, ruta y consulta.

### GitHub CP-DoS

Enviar un valor incorrecto en el encabezado content-type desencadenaba una respuesta 405 en cach√©. La clave de cach√© conten√≠a la cookie, por lo que solo era posible atacar a usuarios no autenticados.

### GitLab + GCP CP-DoS

GitLab utiliza buckets de GCP para almacenar contenido est√°tico. **Buckets de GCP** soportan el **encabezado `x-http-method-override`**. Por lo tanto, era posible enviar el encabezado `x-http-method-override: HEAD` y envenenar la cach√© para que devuelva un cuerpo de respuesta vac√≠o. Tambi√©n podr√≠a soportar el m√©todo `PURGE`.

### Rack Middleware (Ruby on Rails)

La aplicaci√≥n Ruby on Rails a menudo se implementa junto con el middleware Rack. El c√≥digo de Rack a continuaci√≥n toma el valor del **`x-forwarded-scheme` y lo usa como el esquema de la solicitud**.

![](<../.gitbook/assets/image (159) (2).png>)

Enviar el encabezado `x-forwarded-scheme: http` resultar√≠a en una redirecci√≥n 301 a la misma ubicaci√≥n, lo que causar√≠a un DoS sobre ese recurso como en este ejemplo:

![](<../.gitbook/assets/image (166).png>)

La aplicaci√≥n tambi√©n podr√≠a soportar el encabezado `X-forwarded-host` y redirigir al usuario a ese host, lo que permitir√≠a cargar archivos javascript desde el servidor del atacante:

![](<../.gitbook/assets/image (157) (2).png>)

### 403 y Storage Buckets

Anteriormente, **Cloudflare** sol√≠a **cachear** las respuestas **403**, por lo tanto, enviar encabezados de **Autorizaci√≥n incorrectos** intentando acceder a **S3** o **Azure Storage Blobs** expuestos devolver√≠a un 403 que se cachear√≠a. Cloudflare ya no cach√©a respuestas 403, pero esto podr√≠a funcionar con otros proxies.

![](<../.gitbook/assets/image (171).png>)

### Inyectando par√°metros claveados

A menudo, las cach√©s est√°n configuradas para **incluir solo par√°metros GET espec√≠ficos en la clave de cach√©**.

Por ejemplo, Fastly usando Varnish **cach√©aba el par√°metro `size`** en la solicitud, pero si enviabas **tambi√©n** el par√°metro **`siz%65`** con un valor incorrecto, la **clave de cach√©** se constru√≠a con el par√°metro size bien escrito, pero el **backend** usaba el **valor dentro del par√°metro codificado en la URL**.

![](<../.gitbook/assets/image (180).png>)

Codificar en URL el segundo par√°metro `size` provocaba que la cach√© lo ignorara, pero el backend lo utilizaba. Darle al par√°metro un valor de 0 resultar√≠a en un 400 Bad Request cacheable.

### Reglas de User Agent

Debido a la gran cantidad de tr√°fico que generan herramientas como FFUF o Nuclei, algunos desarrolladores decidieron bloquear solicitudes que coincidan con sus user-agents. Ir√≥nicamente, estos ajustes pueden introducir oportunidades no deseadas de envenenamiento de cach√© y DoS.

![](<../.gitbook/assets/image (167) (2).png>)

Encontr√© que esto funcionaba en m√∫ltiples objetivos, con user-agents de diferentes herramientas o esc√°neres.

### Campos de encabezado ilegales

El formato del nombre del encabezado se define en [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) de la siguiente manera:

![](<../.gitbook/assets/image (175) (2).png>)

En teor√≠a, si un nombre de encabezado contiene caracteres distintos a los listados en **tchar** deber√≠a ser rechazado con un 400 Bad request. Sin embargo, en la pr√°ctica, los servidores no siempre respetan el RFC. La forma m√°s f√°cil de explotar esta sutileza fue apuntando a Akamai, que no rechaza encabezados inv√°lidos, pero los reenv√≠a y cach√©a cualquier error 400 siempre que el encabezado cache-control no est√© presente.

![](<../.gitbook/assets/image (163).png>)

Enviar un encabezado que contenga un car√°cter ilegal, `\`, provocar√≠a un error 400 Bad Request cacheable. Este fue uno de los patrones m√°s com√∫nmente identificados a lo largo de mis pruebas.

### Encontrando nuevos encabezados

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Enga√±o de cach√©

El objetivo del Enga√±o de Cach√© es hacer que los clientes **carguen recursos que van a ser guardados por la cach√© con su informaci√≥n sensible**.

Primero, ten en cuenta que **extensiones** como `.css`, `.js`, `.png`, etc. suelen estar **configuradas** para ser **guardadas** en la **cach√©**. Por lo tanto, si accedes a `www.example.com/profile.php/nonexistent.js`, la cach√© probablemente almacenar√° la respuesta porque ve la **extensi√≥n** `.js`. Pero, si la **aplicaci√≥n** est√° **respondiendo** con los contenidos **sensibles** del usuario almacenados en _www.example.com/profile.php_, puedes **robar** esos contenidos de otros usuarios.

Otras cosas para probar:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Usar extensiones menos conocidas como_ `.avif`

Otro ejemplo muy claro se puede encontrar en este informe: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
En el ejemplo, se explica que si cargas una p√°gina inexistente como _http://www.example.com/home.php/non-existent.css_, el contenido de _http://www.example.com/home.php_ (**con la informaci√≥n sensible del usuario**) se devolver√° y el servidor de cach√© guardar√° el resultado.\
Luego, el **atacante** puede acceder a _http://www.example.com/home.php/non-existent.css_ en su propio navegador y observar la **informaci√≥n confidencial** de los usuarios que accedieron antes.

Ten en cuenta que el **proxy de cach√©** debe estar **configurado** para **cachear** archivos **basados** en la **extensi√≥n** del archivo (_.css_) y no basado en el content-type. En el ejemplo _http://www.example.com/home.php/non-existent.css_ tendr√° un content-type `text/html` en lugar de un mime type `text/css` (que es lo esperado para un archivo _.css_).

Aprende aqu√≠ c√≥mo realizar [ataques de Enga√±o de Cach√© abusando del contrabando de solicitudes HTTP](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).

## Referencias

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente, potenciados por las herramientas comunitarias **m√°s avanzadas** del mundo.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
