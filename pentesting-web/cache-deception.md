# Envenenamiento de Cach√© y Enga√±o de Cach√©

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** con las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diferencia

> **¬øCu√°l es la diferencia entre el envenenamiento de cach√© web y el enga√±o de cach√© web?**
>
> * En el **envenenamiento de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido malicioso en la cach√©, y este contenido se sirve desde la cach√© a otros usuarios de la aplicaci√≥n.
> * En el **enga√±o de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido sensible perteneciente a otro usuario en la cach√©, y luego el atacante recupera este contenido de la cach√©.

## Envenenamiento de Cach√©

El objetivo de envenenar la cach√© es hacer que los **clientes carguen recursos inesperados parcialmente o controlados por el atacante**.\
La respuesta envenenada solo se servir√° a los usuarios que visiten la p√°gina afectada mientras la cach√© est√© envenenada. Como resultado, el impacto puede variar desde inexistente hasta masivo dependiendo de si la p√°gina es popular o no.

Para realizar un ataque de envenenamiento de cach√©, primero debes **identificar las entradas sin clave** (par√°metros que no necesitan aparecer en la solicitud almacenada en cach√© pero que cambian la p√°gina devuelta), ver **c√≥mo abusar** de este par√°metro y **obtener la respuesta en cach√©**.

### Descubrimiento: Verificar las cabeceras HTTP

Por lo general, cuando una respuesta se **almacena en la cach√©**, habr√° una **cabecera que lo indique**, puedes verificar a qu√© cabeceras debes prestar atenci√≥n en esta publicaci√≥n: [**Cabeceras de cach√© HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descubrimiento: Cach√© del c√≥digo 400

Si piensas que la respuesta se est√° almacenando en una cach√©, podr√≠as intentar **enviar solicitudes con una cabecera incorrecta**, que deber√≠a recibir una **c√≥digo de estado 400**. Luego intenta acceder a la solicitud normalmente y si la **respuesta es un c√≥digo de estado 400**, sabes que es vulnerable (e incluso podr√≠as realizar un DoS).\
Una cabecera mal configurada podr√≠a ser simplemente `\:` como cabecera.\
_Ten en cuenta que a veces este tipo de c√≥digos de estado no se almacenan en cach√©, por lo que esta prueba ser√° in√∫til._

### Descubrimiento: Identificar y evaluar las entradas sin clave

Puedes usar [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **brute-force par√°metros y cabeceras** que pueden estar **cambiando la respuesta de la p√°gina**. Por ejemplo, una p√°gina puede estar utilizando la cabecera `X-Forwarded-For` para indicar al cliente que cargue el script desde all√≠:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Obtener una respuesta da√±ina del servidor back-end

Una vez identificado el par√°metro/cabecera, verifica c√≥mo est√° siendo "sanitizado" y d√≥nde se est√° reflejando o afectando la respuesta de la cabecera. ¬øPuedes abusar de ello de alguna manera (realizar un XSS o cargar un c√≥digo JS controlado por ti? ¬ørealizar un DoS?...)

### Obtener la respuesta en cach√©

Una vez que hayas identificado la p√°gina que se puede abusar, qu√© par√°metro/cabecera utilizar y c√≥mo abusar de ello, necesitas obtener la p√°gina en cach√©. Dependiendo del recurso que est√©s intentando obtener en la cach√©, esto podr√≠a llevar alg√∫n tiempo, es posible que necesites intentarlo durante varios segundos.\
La cabecera `X-Cache` en la respuesta puede ser muy √∫til, ya que puede tener el valor "miss" cuando la solicitud no se encuentra en la cach√© y el valor "hit" cuando est√° en cach√©.\
La cabecera `Cache-Control` tambi√©n es interesante para saber si un recurso se est√° almacenando en cach√© y cu√°ndo ser√° la pr√≥xima vez que se almacene en cach√©: `Cache-Control: public, max-age=1800`\
Otra cabecera interesante es `Vary`. Esta cabecera se utiliza a menudo para indicar cabeceras adicionales que se tratan como parte de la clave de la cach√©, incluso si normalmente no se consideran clave. Por lo tanto, si el usuario conoce el `User-Agent` de la v√≠ctima a la que est√° apuntando, puede envenenar la cach√© para los usuarios que utilicen ese `User-Agent` espec√≠fico.\
Otra cabecera relacionada con la cach√© es `Age`. Define el tiempo en segundos que el objeto ha estado en la cach√© del proxy.

Al almacenar en cach√© una solicitud, ten cuidado con las cabeceras que utilizas, ya que algunas de ellas podr√≠an utilizarse de manera inesperada como clave y la v√≠ctima deber√° utilizar esa misma cabecera. Siempre prueba un envenenamiento de cach√© con diferentes navegadores para comprobar si funciona.

## Ejemplos de explotaci√≥n

### Ejemplo m√°s sencillo

Una cabecera como `X-Forwarded-For` se refleja en la respuesta sin ser sanitizada.\
Puedes enviar una carga √∫til b√°sica de XSS y envenenar la cach√© para que todos los que accedan a la p√°gina sean v√≠ctimas de XSS:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Nota que esto envenenar√° una solicitud a `/en?region=uk` y no a `/en`_

### Usando envenenamiento de cach√© web para explotar vulnerabilidades de manejo de cookies

Las cookies tambi√©n pueden reflejarse en la respuesta de una p√°gina. Si puedes abusar de esto para causar un XSS, por ejemplo, podr√≠as ser capaz de explotar XSS en varios clientes que carguen la respuesta de cach√© maliciosa.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
### Uso de m√∫ltiples encabezados para explotar vulnerabilidades de envenenamiento de cach√© web <a href="#uso-de-m√∫ltiples-encabezados-para-explotar-vulnerabilidades-de-envenenamiento-de-cach√©-web" id="uso-de-m√∫ltiples-encabezados-para-explotar-vulnerabilidades-de-envenenamiento-de-cach√©-web"></a>

A veces necesitar√°s **explotar varios inputs sin clave** para poder abusar de una cach√©. Por ejemplo, puedes encontrar una **redirecci√≥n abierta** si estableces `X-Forwarded-Host` en un dominio controlado por ti y `X-Forwarded-Scheme` en `http`. **Si** el **servidor** est√° **redirigiendo** todas las solicitudes **HTTP** a **HTTPS** y utilizando el encabezado `X-Forwarded-Scheme` como el nombre de dominio para la redirecci√≥n. Puedes controlar hacia d√≥nde apunta la p√°gina mediante la redirecci√≥n.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explotando con el encabezado `Vary` limitado

Si descubres que el encabezado **`X-Host`** se utiliza como **nombre de dominio para cargar un recurso JS**, pero el encabezado **`Vary`** en la respuesta indica **`User-Agent`**, entonces necesitas encontrar una forma de extraer el User-Agent de la v√≠ctima y envenenar la cach√© utilizando ese User-Agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Explotando la manipulaci√≥n de cach√© HTTP mediante el abuso de HTTP Request Smuggling

Aprende aqu√≠ c√≥mo realizar ataques de manipulaci√≥n de cach√© mediante el abuso de HTTP Request Smuggling.

### Pruebas automatizadas para la manipulaci√≥n de cach√© web

Se puede utilizar el [Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) para realizar pruebas autom√°ticas de manipulaci√≥n de cach√© web. Admite muchas t√©cnicas diferentes y es altamente personalizable.

Uso de ejemplo: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir y automatizar f√°cilmente flujos de trabajo con las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ejemplos de vulnerabilidades

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS reenviaba el fragmento dentro de la URL sin eliminarlo y generaba la clave de cach√© utilizando solo el host, la ruta y la consulta (ignorando el fragmento). Por lo tanto, la solicitud `/#/../?r=javascript:alert(1)` se enviaba al backend como `/#/../?r=javascript:alert(1)` y la clave de cach√© no conten√≠a la carga √∫til, solo el host, la ruta y la consulta.

### GitHub CP-DoS

Enviar un valor incorrecto en el encabezado de tipo de contenido provocaba una respuesta en cach√© con c√≥digo 405. La clave de cach√© conten√≠a la cookie, por lo que solo era posible atacar a usuarios no autenticados.

### GitLab + GCP CP-DoS

GitLab utiliza los buckets de GCP para almacenar contenido est√°tico. Los **buckets de GCP** admiten el encabezado `x-http-method-override`. Por lo tanto, era posible enviar el encabezado `x-http-method-override: HEAD` y envenenar la cach√© para que devuelva un cuerpo de respuesta vac√≠o. Tambi√©n podr√≠a admitir el m√©todo `PURGE`.

### Rack Middleware (Ruby on Rails)

La aplicaci√≥n Ruby on Rails a menudo se implementa junto con el middleware Rack. El c√≥digo de Rack a continuaci√≥n toma el valor del **encabezado `x-forwarded-scheme` y lo utiliza como el esquema de la solicitud**.

![](<../.gitbook/assets/image (159) (2).png>)

Enviar el encabezado `x-forwarded-scheme: http` resultar√≠a en una redirecci√≥n 301 a la misma ubicaci√≥n, lo que causar√≠a una denegaci√≥n de servicio en ese recurso, como en este ejemplo:

![](<../.gitbook/assets/image (166).png>)

La aplicaci√≥n tambi√©n podr√≠a admitir el encabezado `X-forwarded-host` y redirigir al usuario a ese host, lo que permitir√≠a cargar archivos JavaScript desde el servidor del atacante:

![](<../.gitbook/assets/image (157) (2).png>)

### 403 y Storage Buckets

Anteriormente, **Cloudflare** sol√≠a **almacenar en cach√©** las respuestas **403**, por lo que enviar **encabezados de autorizaci√≥n incorrectos** al intentar acceder a **S3** o **Azure Storage Blobs** expuestos devolver√≠a un 403 que se almacenar√≠a en cach√©. Cloudflare ya no almacena en cach√© las respuestas 403, pero esto podr√≠a funcionar con otros proxies.

![](<../.gitbook/assets/image (171).png>)

### Inyecci√≥n de par√°metros clave

Con frecuencia, las cach√©s est√°n configuradas para **incluir solo par√°metros GET espec√≠ficos en la clave de cach√©**.

Por ejemplo, Fastly utilizando Varnish **almacenaba en cach√© el par√°metro `size`** en la solicitud, pero si tambi√©n enviabas el par√°metro **`siz%65`** con un valor incorrecto, la **clave de cach√©** se constru√≠a con el **par√°metro size bien escrito**, pero el **backend** utilizaba el **valor dentro del par√°metro codificado en la URL**.

![](<../.gitbook/assets/image (180).png>)

Codificar en URL el segundo par√°metro `size` hac√≠a que la cach√© lo ignorara, pero el backend lo utilizaba. Darle al par√°metro un valor de 0 resultar√≠a en una solicitud incorrecta 400 que se puede almacenar en cach√©.

### Reglas de agente de usuario

Debido a la gran cantidad de tr√°fico que generan herramientas como FFUF o Nuclei, algunos desarrolladores decidieron bloquear las solicitudes que coinciden con sus agentes de usuario. Ir√≥nicamente, estas modificaciones pueden introducir oportunidades no deseadas de manipulaci√≥n de cach√© y denegaci√≥n de servicio.

![](<../.gitbook/assets/image (167) (2).png>)

Descubr√≠ que esto funcionaba en varios objetivos, con agentes de usuario de diferentes herramientas o esc√°neres.

### Campos de encabezado ilegales

El formato del nombre del encabezado se define en [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) de la siguiente manera:

![](<../.gitbook/assets/image (175) (2).png>)

En teor√≠a, si el nombre de un encabezado contiene caracteres que no est√°n en la lista de **tchar**, deber√≠a ser rechazado con una solicitud incorrecta 400. Sin embargo, en la pr√°ctica, los servidores no siempre respetan el RFC. La forma m√°s f√°cil de explotar esta sutileza era dirigirse a Akamai, que no rechaza los encabezados no v√°lidos, sino que los reenv√≠a y almacena en cach√© cualquier error 400 siempre que no est√© presente el encabezado de control de cach√©.

![](<../.gitbook/assets/image (163).png>)

Enviar un encabezado que contenga un car√°cter ilegal, `\`, provocar√≠a un error de solicitud incorrecta 400 que se puede almacenar en cach√©. Este fue uno de los patrones m√°s com√∫nmente identificados durante mis pruebas.

### Encontrar nuevos encabezados

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Decepci√≥n de cach√©

El objetivo de la Decepci√≥n de Cach√© es hacer que los clientes **carguen recursos que van a ser guardados por la cach√© con su informaci√≥n confidencial**.

En primer lugar, ten en cuenta que las **extensiones** como `.css`, `.js`, `.png`, etc., suelen estar **configuradas** para **guardarse** en la **cach√©**. Por lo tanto, si accedes a `www.example.com/profile.php/nonexistent.js`, es probable que la cach√© almacene la respuesta porque ve la extensi√≥n `.js`. Pero, si la **aplicaci√≥n** est√° **reproduciendo** los contenidos **sensibles** del usuario almacenados en _www.example.com/profile.php_, puedes **robar** esos contenidos de otros usuarios.

Otras cosas para probar:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Utiliza extensiones menos conocidas como_ `.avif`

Otro ejemplo muy claro se puede encontrar en este informe: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
En el ejemplo, se explica que si cargas una p√°gina inexistente como _http://www.example.com/home.php/non-existent.css_, se devolver√° el contenido de _http://www.example.com/home.php_ (**con la informaci√≥n confidencial del usuario**) y el servidor de cach√© guardar√° el resultado.\
Luego, el **atacante** puede acceder a _http://www.example.com/home.php/non-existent.css_ en su propio navegador y observar la **informaci√≥n confidencial** de los usuarios que accedieron anteriormente.

Ten en cuenta que el **proxy de cach√©** debe estar **configurado** para **almacenar en cach√©** archivos **basados** en la **extensi√≥n** del archivo (_.css_) y no en el tipo de contenido. En el ejemplo, _http://www.example.com/home.php/non-existent.css_ tendr√° un tipo de contenido `text/html` en lugar de un tipo MIME `text/css` (que es el esperado para un archivo _.css_).

Aprende aqu√≠ c√≥mo realizar ataques de Decepci√≥n de Cach√© mediante el abuso de HTTP Request Smuggling.
## Referencias

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** con las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres que tu **empresa sea anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
