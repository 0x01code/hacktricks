# Envenenamiento y Enga√±o de Cach√©

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Usa [**Trickest**](https://trickest.io/) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas de la comunidad m√°s avanzadas del mundo.\
Obt√©n acceso hoy:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diferencia

> **¬øCu√°l es la diferencia entre el envenenamiento y el enga√±o de cach√© web?**
>
> * En el **envenenamiento de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido malicioso en la cach√©, y este contenido se sirve desde la cach√© a otros usuarios de la aplicaci√≥n.
> * En el **enga√±o de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido sensible perteneciente a otro usuario en la cach√©, y luego el atacante recupera este contenido de la cach√©.

## Envenenamiento de Cach√©

El objetivo del envenenamiento de cach√© es hacer que los **clientes carguen recursos inesperados parcialmente o controlados por el atacante**.\
La respuesta envenenada solo se servir√° a los usuarios que visiten la p√°gina afectada mientras la cach√© est√© envenenada. Como resultado, el impacto puede variar desde inexistente hasta masivo dependiendo de si la p√°gina es popular o no.

Para realizar un ataque de envenenamiento de cach√©, primero debes **identificar las entradas sin clave** (par√°metros que no necesitan aparecer en la solicitud en cach√© pero que cambian la p√°gina devuelta), ver **c√≥mo abusar** de este par√°metro y **obtener la respuesta en cach√©**.

### Descubrimiento: Verificar encabezados HTTP

Por lo general, cuando una respuesta se **almacena en la cach√©**, habr√° un **encabezado que lo indique**, puedes verificar a qu√© encabezados debes prestar atenci√≥n en esta publicaci√≥n: [**Encabezados de cach√© HTTP**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descubrimiento: Cach√© de c√≥digo 400

Si piensas que la respuesta se est√° almacenando en una cach√©, podr√≠as intentar **enviar solicitudes con un encabezado incorrecto**, que deber√≠a ser respondido con un **c√≥digo de estado 400**. Luego intenta acceder a la solicitud normalmente y si la **respuesta es un c√≥digo de estado 400**, sabes que es vulnerable (e incluso podr√≠as realizar un DoS).\
Un encabezado mal configurado podr√≠a ser solo `\:` como encabezado.\
_Ten en cuenta que a veces estos tipos de c√≥digos de estado no se almacenan en cach√©, por lo que esta prueba ser√° in√∫til._

### Descubrimiento: Identificar y evaluar entradas sin clave

Podr√≠as usar [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **fuerza bruta de par√°metros y encabezados** que pueden estar **cambiando la respuesta de la p√°gina**. Por ejemplo, una p√°gina puede estar usando el encabezado `X-Forwarded-For` para indicar al cliente que cargue el script desde all√≠:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Obtener una respuesta da√±ina del servidor back-end

Con el par√°metro/cabecera identificado, comprueba c√≥mo se est√° **sanitizando** y **d√≥nde** se est√° **reflejando** o afectando la respuesta de la cabecera. ¬øPuedes abusar de ella de alguna manera (realizar un XSS o cargar un c√≥digo JS controlado por ti? ¬ørealizar un DoS?...)

### Obtener la respuesta en cach√©

Una vez que hayas **identificado** la **p√°gina** que se puede abusar, qu√© **par√°metro/cabecera** usar y **c√≥mo** abusar de ella, necesitas obtener la p√°gina en cach√©. Dependiendo del recurso que est√©s intentando obtener en cach√©, esto podr√≠a llevar alg√∫n tiempo, es posible que necesites intentarlo durante varios segundos.\
La cabecera **`X-Cache`** en la respuesta podr√≠a ser muy √∫til, ya que puede tener el valor **`miss`** cuando la solicitud no se ha almacenado en cach√© y el valor **`hit`** cuando est√° en cach√©.\
La cabecera **`Cache-Control`** tambi√©n es interesante para saber si un recurso se est√° almacenando en cach√© y cu√°ndo se almacenar√° en cach√© de nuevo: `Cache-Control: public, max-age=1800`\
Otra cabecera interesante es **`Vary`**. Esta cabecera se utiliza a menudo para **indicar cabeceras adicionales** que se tratan como **parte de la clave de cach√©** aunque normalmente no lo sean. Por lo tanto, si el usuario conoce el `User-Agent` de la v√≠ctima que est√° atacando, puede envenenar la cach√© para los usuarios que utilizan ese `User-Agent` espec√≠fico.\
Otra cabecera relacionada con la cach√© es **`Age`**. Define los tiempos en segundos que el objeto ha estado en la cach√© del proxy.

Al almacenar en cach√© una solicitud, ten **cuidado con las cabeceras que uses** porque algunas de ellas podr√≠an ser **utilizadas de manera inesperada** como **clave** y la **v√≠ctima necesitar√° usar esa misma cabecera**. Siempre **prueba** un envenenamiento de cach√© con **diferentes navegadores** para comprobar si funciona.

## Ejemplos de explotaci√≥n

### Ejemplo m√°s f√°cil

Una cabecera como `X-Forwarded-For` se refleja en la respuesta sin sanitizar.\
Puedes enviar una carga √∫til b√°sica de XSS y envenenar la cach√© para que todos los que accedan a la p√°gina sean v√≠ctimas de XSS:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Nota que esto envenenar√° una solicitud a `/en?region=uk` y no a `/en`_

### Usando envenenamiento de cach√© web para explotar vulnerabilidades de manejo de cookies

Las cookies tambi√©n pueden reflejarse en la respuesta de una p√°gina. Si puedes abusar de esto para causar un XSS, por ejemplo, podr√≠as ser capaz de explotar XSS en varios clientes que cargan la respuesta de cach√© maliciosa.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Ten en cuenta que si la cookie vulnerable es muy utilizada por los usuarios, las solicitudes regulares limpiar√°n la cach√©.

### Uso de m√∫ltiples encabezados para explotar vulnerabilidades de envenenamiento de cach√© web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

A veces necesitar√°s **explotar varios inputs sin clave** para poder abusar de una cach√©. Por ejemplo, puedes encontrar una **redirecci√≥n abierta** si estableces `X-Forwarded-Host` en un dominio controlado por ti y `X-Forwarded-Scheme` en `http`. **Si** el **servidor** est√° **redirigiendo** todas las solicitudes **HTTP** a **HTTPS** y usando el encabezado `X-Forwarded-Scheme` como el nombre de dominio para la redirecci√≥n. Puedes controlar a d√≥nde apunta la p√°gina mediante la redirecci√≥n.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explotando con el encabezado `Vary` limitado

Si descubres que el encabezado **`X-Host`** se est√° utilizando como **nombre de dominio para cargar un recurso JS** pero el encabezado **`Vary`** en la respuesta indica **`User-Agent`**, entonces necesitas encontrar una forma de exfiltrar el User-Agent de la v√≠ctima y envenenar la cach√© utilizando ese user agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Explotando el Envenenamiento de Cach√© HTTP mediante el abuso de HTTP Request Smuggling

Aprende aqu√≠ c√≥mo realizar ataques de [Envenenamiento de Cach√© mediante el abuso de HTTP Request Smuggling](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Pruebas automatizadas para el Envenenamiento de Cach√© Web

Se puede utilizar el [Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) para probar autom√°ticamente el envenenamiento de cach√© web. Admite muchas t√©cnicas diferentes y es altamente personalizable.

Ejemplo de uso: `wcvs -u example.com`

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Usa [**Trickest**](https://trickest.io/) para construir y automatizar f√°cilmente flujos de trabajo impulsados por las herramientas de la comunidad m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ejemplos Vulnerables

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS reenviaba el fragmento dentro de la URL sin eliminarlo y generaba la clave de cach√© solo usando el host, la ruta y la consulta (ignorando el fragmento). Por lo tanto, la solicitud `/#/../?r=javascript:alert(1)` se envi√≥ al backend como `/#/../?r=javascript:alert(1)` y la clave de cach√© no ten√≠a la carga √∫til dentro de ella, solo el host, la ruta y la consulta.

### GitHub CP-DoS

El env√≠o de un valor incorrecto en el encabezado de tipo de contenido provoc√≥ una respuesta en cach√© 405. La clave de cach√© conten√≠a la cookie, por lo que solo era posible atacar a usuarios no autenticados.

### GitLab + GCP CP-DoS

GitLab utiliza los buckets de GCP para almacenar contenido est√°tico. Los **Buckets de GCP** admiten el **encabezado `x-http-method-override`**. Por lo tanto, era posible enviar el encabezado `x-http-method-override: HEAD` y envenenar la cach√© para que devolviera un cuerpo de respuesta vac√≠o. Tambi√©n podr√≠a admitir el m√©todo `PURGE`.

### Rack Middleware (Ruby on rails)

La aplicaci√≥n Ruby on Rails a menudo se implementa junto con el middleware Rack. El c√≥digo de Rack a continuaci√≥n toma el valor del **valor `x-forwarded-scheme` y lo usa como el esquema de la solicitud**.

![](<../.gitbook/assets/image (159) (2).png>)

El env√≠o del encabezado `x-forwarded-scheme: http` provocar√≠a una redirecci√≥n 301 a la misma ubicaci√≥n, lo que causar√≠a una DoS en ese recurso como en este ejemplo:

![](<../.gitbook/assets/image (166).png>)

La aplicaci√≥n tambi√©n podr√≠a admitir el encabezado `X-forwarded-host` y redirigir al usuario a ese host, lo que permitir√≠a cargar archivos JavaScript desde el servidor del atacante:

![](<../.gitbook/assets/image (157) (2).png>)

### 403 y Buckets de almacenamiento

Anteriormente, **Cloudflare** sol√≠a **almacenar en cach√© las respuestas 403**, por lo tanto, enviar **encabezados de autorizaci√≥n incorrectos** tratando de acceder a **S3** o **Azure Storage Blobs** expuestos devolver√° un 403 que se almacenar√° en cach√©. Cloudflare ya no almacena en cach√© las respuestas 403, pero esto podr√≠a funcionar con otros proxies.

![](<../.gitbook/assets/image (171).png>)

### Inyectando par√°metros clave

Con bastante frecuencia, las cach√©s se configuran para **incluir solo par√°metros GET espec√≠ficos en la clave de cach√©**.

Por ejemplo, Fastly usando Varnish **almacenaba en cach√© el par√°metro `size`** en la solicitud, pero si enviabas **tambi√©n** el par√°metro **`siz%65`** con un valor incorrecto, la **clave de cach√©** se constru√≠a con el **par√°metro de tama√±o bien escrito**, pero el **backend** usaba el **valor dentro del par√°metro codificado en URL**.

![](<../.gitbook/assets/image (180).png>)

Codificar en URL el segundo par√°metro `size` hizo que la cach√© lo ignorara, pero el backend lo us√≥. Darle al par√°metro un valor de 0 dar√≠a como resultado una solicitud incorrecta 400 que se puede almacenar en cach√©.

### Reglas de Agente de Usuario

Debido a la gran cantidad de tr√°fico que generan herramientas como FFUF o Nuclei, algunos desarrolladores decidieron bloquear las solicitudes que coinciden con sus agentes de usuario. Ir√≥nicamente, estos ajustes pueden introducir oportunidades no deseadas de envenenamiento de cach√© y DoS.

![](<../.gitbook/assets/image (167) (2).png>)

Encontr√© que esto funcion√≥ en varios objetivos, con agentes de usuario de diferentes herramientas o esc√°neres.

### Campos de encabezado ilegales

El formato del nombre del encabezado se define en [RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) de la siguiente manera:

![](<../.gitbook/assets/image (175) (2).png>)

En teor√≠a, si un nombre de encabezado contiene caracteres que no son los enumerados en **tchar**, deber√≠a ser rechazado con una solicitud incorrecta 400. En la pr√°ctica, sin embargo, los servidores no siempre respetan el RFC. La forma m√°s f√°cil de explotar esta sutileza era apuntando a Akamai, que no rechaza los encabezados no v√°lidos, sino que los reenv√≠a y almacena cualquier error 400 siempre que el encabezado de control de cach√© no est√© presente.

![](<../.gitbook/assets/image (163).png>)

Enviar un encabezado que contenga un car√°cter ilegal, `\`, provocar√≠a un error de solicitud incorrecta 400 que se puede almacenar
