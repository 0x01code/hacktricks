# Condi√ß√£o de Corrida

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Explorando a Condi√ß√£o de Corrida

O principal problema de abusar da Condi√ß√£o de Corrida √© que voc√™ precisa que as solicita√ß√µes sejam processadas em paralelo com uma diferen√ßa de tempo muito curta (geralmente >1ms). Na se√ß√£o a seguir, s√£o propostas diferentes solu√ß√µes para tornar isso poss√≠vel.

<figure><img src="../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

### Ataque de pacote √∫nico

O HTTP2 permite enviar **2 solicita√ß√µes em uma √∫nica conex√£o TCP** (enquanto no HTTP/1.1 elas devem ser sequenciais).\
O uso de um √∫nico pacote TCP elimina completamente o efeito do jitter de rede, portanto, isso claramente tem potencial para ataques de condi√ß√£o de corrida tamb√©m. No entanto, **duas solicita√ß√µes n√£o s√£o suficientes para um ataque de corrida confi√°vel** devido ao **jitter do lado do servidor** - varia√ß√µes no tempo de processamento da solicita√ß√£o do aplicativo causadas por vari√°veis incontrol√°veis como conten√ß√£o de CPU.

Mas, usando a t√©cnica de '**sincroniza√ß√£o do √∫ltimo byte**' do HTTP/1.1, √© poss√≠vel pr√©-enviar a maior parte dos dados retendo um pequeno fragmento de cada solicita√ß√£o e depois 'completar' **20-30 solicita√ß√µes com um √∫nico pacote TCP**.

Para **pr√©-enviar a maior parte de cada solicita√ß√£o**:

* Se a solicita√ß√£o n√£o tiver corpo, envie todos os cabe√ßalhos, mas n√£o defina a flag END\_STREAM. Retenha um quadro de dados vazio com a flag END\_STREAM definida.
* Se a solicita√ß√£o tiver um corpo, envie os cabe√ßalhos e todos os dados do corpo, exceto o √∫ltimo byte. Retenha um quadro de dados contendo o √∫ltimo byte.

Em seguida, **prepare-se para enviar os quadros finais**:

* Aguarde 100ms para garantir que os quadros iniciais tenham sido enviados.
* Verifique se o TCP\_NODELAY est√° desativado - √© crucial que o algoritmo de Nagle agrupe os quadros finais.
* Envie um pacote de ping para aquecer a conex√£o local. Se voc√™ n√£o fizer isso, a pilha de rede do sistema operacional colocar√° o primeiro quadro final em um pacote separado.

Por fim, envie os quadros retidos. Voc√™ deve ser capaz de verificar que eles chegaram em um √∫nico pacote usando o Wireshark.

{% hint style="info" %}
Observe que isso **n√£o funciona para arquivos est√°ticos** em determinados servidores, mas como arquivos est√°ticos n√£o s√£o relevantes para ataques de condi√ß√£o de corrida. Mas arquivos est√°ticos s√£o irrelevantes para ataques de CC.
{% endhint %}

Usando essa t√©cnica, voc√™ pode fazer com que 20-30 solicita√ß√µes cheguem ao servidor simultaneamente - independentemente do jitter de rede:

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**Adaptando √† arquitetura do alvo**

Vale ressaltar que muitos aplicativos est√£o atr√°s de um servidor de front-end, e estes podem decidir encaminhar algumas solicita√ß√µes por conex√µes existentes para o back-end e criar novas conex√µes para outras.

Portanto, √© importante n√£o atribuir o tempo inconsistente de solicita√ß√£o ao comportamento do aplicativo, como mecanismos de bloqueio que permitem apenas que uma √∫nica thread acesse um recurso de cada vez. Al√©m disso, o roteamento de solicita√ß√µes de front-end geralmente √© feito por conex√£o, portanto, voc√™ pode suavizar o tempo de solicita√ß√£o realizando o aquecimento da conex√£o do lado do servidor - **enviando algumas solicita√ß√µes inconsequentes pela sua conex√£o antes de realizar o ataque**.

Observe que o **PHP faz bloqueio no sessionid por padr√£o**, portanto, voc√™ precisa usar uma **sess√£o separada para cada solicita√ß√£o** em seu lote ou elas ser√£o processadas sequencialmente.

{% hint style="warning" %}
Para obter mais informa√ß√µes sobre essa t√©cnica, consulte o relat√≥rio original em [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

#### Exemplos

Voc√™ pode verificar um exemplo simples de como usar isso no turbo intruder em [https://github.com/PortSwigger/turbo-intruder/blob/master/resources/examples/race-single-packet-attack.py](https://github.com/PortSwigger/turbo-intruder/blob/master/resources/examples/race-single-packet-attack.py).

Tamb√©m est√° dispon√≠vel no **Repeater** por meio da nova op√ß√£o '**Enviar grupo em paralelo**' no Burp Suite.
### BF Bruto

Antes da pesquisa anterior, esses eram alguns payloads usados que apenas tentavam enviar os pacotes o mais r√°pido poss√≠vel para causar uma RC.

* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**

A biblioteca `asyncio` do Python fornece suporte para programa√ß√£o ass√≠ncrona, permitindo que voc√™ escreva c√≥digo concorrente e escal√°vel de forma mais eficiente. Com `asyncio`, voc√™ pode lidar com tarefas ass√≠ncronas, como chamadas de rede, de forma mais eficiente, evitando bloqueios desnecess√°rios.

A programa√ß√£o ass√≠ncrona √© particularmente √∫til ao lidar com condi√ß√µes de corrida em aplicativos da web. Uma condi√ß√£o de corrida ocorre quando duas ou mais opera√ß√µes concorrentes tentam acessar ou modificar um recurso compartilhado ao mesmo tempo, resultando em comportamento imprevis√≠vel ou incorreto.

Ao usar `asyncio`, voc√™ pode evitar condi√ß√µes de corrida implementando mecanismos de exclus√£o m√∫tua, como sem√°foros ou bloqueios, para garantir que apenas uma tarefa possa acessar o recurso compartilhado de cada vez. Isso ajuda a evitar problemas de consist√™ncia de dados e garante que o aplicativo funcione corretamente, mesmo em cen√°rios de alta concorr√™ncia.

A biblioteca `asyncio` tamb√©m oferece suporte a outras funcionalidades √∫teis, como tarefas peri√≥dicas, filas ass√≠ncronas e comunica√ß√£o entre tarefas ass√≠ncronas. Com esses recursos, voc√™ pode criar aplicativos da web mais eficientes e responsivos, capazes de lidar com um grande n√∫mero de solicita√ß√µes simult√¢neas.

Em resumo, o uso da biblioteca `asyncio` do Python √© uma abordagem eficaz para lidar com condi√ß√µes de corrida em aplicativos da web, permitindo que voc√™ escreva c√≥digo concorrente e escal√°vel de forma mais eficiente.
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
* **Intruso**: Envie a **solicita√ß√£o** para o **Intruso**, defina o **n√∫mero de threads** para **30** dentro do menu **Op√ß√µes** e selecione como carga √∫til **Cargas √∫teis nulas** e gere **30**.

## **Metodologia RC**

## **Impactos do RC**

### Limite de estouro

Este √© o tipo mais b√°sico de condi√ß√£o de corrida, onde **vulnerabilidades** que **aparecem** em lugares que **limitam o n√∫mero de vezes que voc√™ pode executar uma a√ß√£o**. Como usar o mesmo c√≥digo de desconto em uma loja virtual v√°rias vezes. Um exemplo muito f√°cil pode ser encontrado neste [**relat√≥rio**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) ou neste [**bug**](https://hackerone.com/reports/759247)**.**

### **Subestados ocultos**

Outra condi√ß√£o de corrida mais complicada explorar√° **subestados no estado da m√°quina** que poderiam permitir que um invasor **abusasse** de estados aos quais ele **nunca deveria ter acesso**, mas h√° uma **pequena janela** para o invasor acess√°-lo.

1. **Prever subestados ocultos e interessantes potenciais**

O primeiro passo √© identificar todos os pontos finais que gravam nele ou l√™em dados dele e, em seguida, usam esses dados para algo importante. Por exemplo, os usu√°rios podem ser armazenados em uma tabela de banco de dados que √© modificada pelo registro, edi√ß√£o de perfil, inicia√ß√£o de redefini√ß√£o de senha e conclus√£o da redefini√ß√£o de senha.

Podemos usar tr√™s perguntas-chave para descartar pontos finais que provavelmente n√£o causar√£o colis√µes. Para cada objeto e os pontos finais associados, pergunte:

**1) Como o estado √© armazenado?**

Dados armazenados em uma estrutura de dados persistente do lado do servidor s√£o ideais para explora√ß√£o. Alguns pontos finais armazenam seu estado inteiramente no lado do cliente, como redefini√ß√µes de senha que funcionam enviando um JWT por e-mail - esses podem ser ignorados com seguran√ßa.

As aplica√ß√µes costumam armazenar algum estado na sess√£o do usu√°rio. Esses s√£o frequentemente um tanto protegidos contra subestados - mais sobre isso depois.

**2) Estamos editando ou anexando?**

Opera√ß√µes que editam dados existentes (como alterar o endere√ßo de e-mail principal de uma conta) t√™m grande potencial de colis√£o, enquanto a√ß√µes que simplesmente anexam a dados existentes (como adicionar um endere√ßo de e-mail adicional) provavelmente n√£o s√£o vulner√°veis a nada al√©m de ataques de limite de estouro.

**3) Em que a opera√ß√£o √© baseada?**

A maioria dos pontos finais opera em um registro espec√≠fico, que √© procurado usando uma 'chave', como um nome de usu√°rio, token de redefini√ß√£o de senha ou nome de arquivo. Para um ataque bem-sucedido, precisamos de duas opera√ß√µes que usem a mesma chave. Por exemplo, imagine duas implementa√ß√µes plaus√≠veis de redefini√ß√£o de senha:

<figure><img src="../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

2. **Investigar pistas**

Neste ponto, √© hora de **lan√ßar alguns ataques de RC** nos pontos finais potencialmente interessantes para tentar encontrar resultados inesperados em compara√ß√£o com os regulares. **Qualquer desvio da resposta esperada**, como uma altera√ß√£o em uma ou mais respostas, ou um efeito de segunda ordem, como conte√∫dos de e-mail diferentes ou uma mudan√ßa vis√≠vel em sua sess√£o, pode ser uma pista indicando que algo est√° errado.

3. **Provar o conceito**

A etapa final √© **provar o conceito e transform√°-lo em um ataque vi√°vel**.

Quando voc√™ envia um lote de solicita√ß√µes, pode descobrir que um par de solicita√ß√µes iniciais aciona um estado final vulner√°vel, mas solicita√ß√µes posteriores sobrescrevem/invalidam esse estado e o estado final n√£o pode ser explorado. Nesse cen√°rio, voc√™ desejar√° eliminar todas as solicita√ß√µes desnecess√°rias - duas devem ser suficientes para explorar a maioria das vulnerabilidades. No entanto, reduzir para duas solicita√ß√µes tornar√° o ataque mais sens√≠vel ao tempo, portanto, talvez seja necess√°rio tentar o ataque v√°rias vezes ou automatiz√°-lo.

## Estudos de caso de subestados ocultos

### Pagar e adicionar um item

[**Verifique este laborat√≥rio**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) para ver como **pagar** em uma loja e **adicionar um item extra** que voc√™ **n√£o precisar√° pagar**.

### Confirmar outros e-mails

A ideia √© **verificar um endere√ßo de e-mail e alter√°-lo ao mesmo tempo** para descobrir se a plataforma verifica o novo endere√ßo alterado.

### Alterar o e-mail para 2 endere√ßos de e-mail

De acordo com [**este relat√≥rio**](https://portswigger.net/research/smashing-the-state-machine), o Gitlab estava vulner√°vel a uma invas√£o dessa maneira porque poderia **enviar o token de verifica√ß√£o de e-mail de um e-mail para o outro e-mail**.

### Persist√™ncia eterna do OAuth2

Existem v√°rios [**provedores de OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Esses servi√ßos permitir√£o que voc√™ crie um aplicativo e autentique usu√°rios registrados pelo provedor. Para fazer isso, o **cliente** precisar√° **permitir que seu aplicativo** acesse alguns de seus dados dentro do **provedor de OAuth**.\
At√© aqui, apenas um login comum com Google/LinkedIn/GitHub... onde voc√™ √© solicitado em uma p√°gina dizendo: "_O aplicativo \<InserirNomeLegal> deseja acessar suas informa√ß√µes, voc√™ deseja permitir?_"

#### Condi√ß√£o de corrida em `authorization_code`

O **problema** ocorre quando voc√™ **aceita** e envia automaticamente um **`authorization_code`** para o aplicativo malicioso. Em seguida, este aplicativo **abusa de uma condi√ß√£o de corrida no provedor de servi√ßos de OAuth para gerar mais de um AT/RT** (_Token de Autentica√ß√£o/Token de Renova√ß√£o_) a partir do **`authorization_code`** para sua conta. Basicamente, ele abusar√° do fato de voc√™ ter aceitado o aplicativo para acessar seus dados e **criar√° v√°rias contas**. Em seguida, se voc√™ **parar de permitir que o aplicativo acesse seus dados, um par de AT/RT ser√° exclu√≠do, mas os outros ainda ser√£o v√°lidos**.

#### Condi√ß√£o de corrida em `Refresh Token`

Depois de **obter um RT v√°lido**, voc√™ pode tentar **abusar dele para gerar v√°rios AT/RT** e, mesmo se o usu√°rio cancelar as permiss√µes para o aplicativo malicioso acessar seus dados, **v√°rios RTs ainda ser√£o v√°lidos**.

## Refer√™ncias

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
