# Hali ya Mashindano

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Tumia [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) kujenga na **kutumia taratibu za kiotomatiki** zinazotumia zana za jamii ya **kisasa zaidi** duniani.\
Pata Ufikiaji Leo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

{% hint style="warning" %}
Ili kupata ufahamu wa kina wa mbinu hii, angalia ripoti asili katika [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

## Kuboresha Mashambulizi ya Hali ya Mashindano

Kizuizi kikuu katika kutumia hali ya mashindano ni kuhakikisha kuwa maombi mengi yanashughulikiwa wakati huo huo, na **tofauti kidogo katika wakati wa usindikaji wao - kimsingi, chini ya 1ms**.

Hapa unaweza kupata baadhi ya mbinu za Kusawazisha Maombi:

#### Shambulio la Pakiti Moja ya HTTP/2 dhidi ya Ufanisi wa Mwisho wa Byte ya HTTP/1.1

- **HTTP/2**: Inasaidia kutuma maombi mawili kupitia muunganisho mmoja wa TCP, kupunguza athari ya kutetemeka kwa mtandao. Walakini, kutokana na tofauti za upande wa seva, maombi mawili hayatoshi kwa shambulio la hali ya mashindano linaloweza kudumu.
- **'Mwisho wa Byte wa HTTP/1.1'**: Inawezesha kutuma sehemu kubwa ya maombi 20-30, ikizuia kipande kidogo, ambacho kisha hutumwa pamoja, kufikia kuwasili kwa wakati mmoja kwenye seva.

**Maandalizi ya Mwisho wa Byte wa Hali ya Mashindano** yanajumuisha:
1. Kutuma vichwa na data ya mwili bila byte ya mwisho bila kumaliza mtiririko.
2. Kusubiri kwa 100ms baada ya kutuma awali.
3. Kulemaza TCP_NODELAY ili kutumia algorithm ya Nagle kwa kubatilisha fremu za mwisho.
4. Kutuma ping ili kuamsha uhusiano.

Kutuma baadaye kwa fremu zilizofichwa inapaswa kusababisha kuwasili kwao kwenye pakiti moja, ambayo inaweza kuthibitishwa kupitia Wireshark. Mbinu hii haifai kwa faili za tuli, ambazo kawaida hazihusiani na mashambulizi ya hali ya mashindano.

### Kuzoea Miundo ya Seva

Kuelewa miundo ya lengo ni muhimu. Seva za mbele zinaweza kuongoza maombi kwa njia tofauti, zikibadilisha wakati. Kupasha joto uhusiano upande wa seva mapema, kupitia maombi yasiyo na maana, kunaweza kawaidaisha wakati wa maombi.

#### Kushughulikia Kufunga kwa Msingi wa Kikao

Mifumo kama kushughulikia kikao cha PHP inasindika maombi kwa kikao, ikificha hatari. Kutumia vitambulisho tofauti vya kikao kwa kila ombi kunaweza kuepuka shida hii.

#### Kushinda Vizuizi vya Kiwango au Rasilmali

Ikiwa kuwasha uhusiano hakufanikiwi, kusababisha kucheleweshwa kwa kiwango au kikomo cha rasilmali cha seva za wavuti kwa makusudi kupitia mfululizo wa maombi bandia kunaweza kurahisisha shambulio la pakiti moja kwa kusababisha kucheleweshwa kwa upande wa seva kwa hali ya mashindano.


## Mifano ya Mashambulizi

* **Tubo Intruder - Shambulio la pakiti moja ya HTTP2 (1 kifaa)**: Unaweza kutuma ombi kwa **Turbo intruder** (`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`), unaweza kubadilisha thamani unayotaka kudhani kwa **`%s`** kama katika `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s` na kisha chagua **`examples/race-single-packer-attack.py`** kutoka kwenye orodha ya kushuka:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Ikiwa unataka **kutuma thamani tofauti**, unaweza kubadilisha nambari na hii ambayo inatumia orodha ya maneno kutoka kwenye ubao wa kunakili:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Ikiwa wavuti haiungi mkono HTTP2 (tu HTTP1.1), tumia `Engine.THREADED` au `Engine.BURP` badala ya `Engine.BURP2`.
{% endhint %}

* **Tubo Intruder - Shambulio la pakiti moja ya HTTP2 (Vipengele kadhaa)**: Ikiwa unahitaji kutuma ombi kwa kipengele 1 na kisha vingine vingi kwa vipengele vingine ili kusababisha RCE, unaweza kubadilisha hati ya `race-single-packet-attack.py` na kitu kama hiki:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Pia inapatikana katika **Repeater** kupitia chaguo jipya la '**Tuma kikundi kwa pamoja**' katika Burp Suite.
* Kwa **kuzidi kikomo**, unaweza tu kuongeza **ombi moja sawa mara 50** katika kikundi.
* Kwa **kuwasha uhusiano**, unaweza **kuongeza** mwanzoni mwa **kikundi** baadhi ya **ombi** kwa sehemu isiyo ya kudumu ya seva ya wavuti.
* Kwa **kuchelewesha** mchakato **kati ya** kusindika **ombi moja na nyingine** katika hatua 2 za substates, unaweza **kuongeza ombi za ziada kati ya** ombi zote mbili.
* Kwa RC ya **multi-endpoint** unaweza kuanza kutuma **ombi** ambalo **linakwenda kwenye hali iliyofichwa** na kisha **ombi 50** mara baada yake ambazo **zinatumia hali iliyofichwa**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Raw BF

Kabla ya utafiti uliopita, haya yalikuwa baadhi ya malipo yaliyotumiwa ambayo yalijaribu tu kutuma pakiti haraka iwezekanavyo ili kusababisha RC.

* **Repeater:** Angalia mifano kutoka sehemu iliyopita.
* **Intruder**: Tuma **ombi** kwa **Intruder**, weka **idadi ya nyuzi** kuwa **30** ndani ya menyu ya **Chaguo** na, chagua malipo ya **Null** na uzalishe **30**.
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **Njia ya RC**

### Kikomo-kuzidi / TOCTOU

Hii ni aina ya msingi kabisa ya hali ya mbio ambapo **udhaifu** unaonekana katika maeneo ambayo **yanazuia idadi ya mara unaweza kufanya kitendo**. Kama kutumia kodi ile ile ya punguzo katika duka la mtandao mara kadhaa. Mfano rahisi sana unaweza kupatikana katika [**ripoti hii**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) au katika [**mdudu huu**](https://hackerone.com/reports/759247)**.**

Kuna mabadiliko mengi ya aina hii ya shambulio, ikiwa ni pamoja na:

* Kumaliza kadi ya zawadi mara kadhaa
* Kupima bidhaa mara kadhaa
* Kutoa au kuhamisha pesa zaidi ya salio lako la akaunti
* Kutumia suluhisho moja la CAPTCHA mara kadhaa
* Kupita kikomo cha kiwango cha nguvu ya brute

### **Hali zisizoonekana**

Kuathiri hali ngumu za mbio mara nyingi kunahusisha kutumia fursa fupi za kuingiliana na hali zisizoonekana au **zisizokusudiwa za mashine**. Hapa ni jinsi ya kukabiliana na hili:

1. **Tambua Hali Zisizoonekana za Siri**
- Anza kwa kubainisha sehemu za mwisho ambazo zinabadilisha au kuingiliana na data muhimu, kama vile maelezo ya mtumiaji au mchakato wa kurejesha nywila. Jikite katika:
- **Uhifadhi**: Chagua sehemu za mwisho ambazo zinashughulikia data ya kudumu upande wa seva kuliko zile zinazoshughulikia data upande wa mteja.
- **Kitendo**: Tafuta shughuli ambazo zinabadilisha data iliyopo, ambazo zina uwezekano mkubwa wa kuunda hali zinazoweza kudukuliwa ikilinganishwa na zile zinazozidisha data mpya.
- **Ufunguo**: Mashambulizi mafanikio kawaida yanahusisha shughuli zinazotegemea kitambulisho kimoja, kama vile jina la mtumiaji au ishara ya kurejesha.

2. **Fanya Uchunguzi wa Awali**
- Jaribu sehemu zilizobainishwa na mashambulio ya hali ya mbio, ukitazama mabadiliko yoyote kutoka kwa matokeo yanayotarajiwa. Majibu yasiyotarajiwa au mabadiliko katika tabia ya programu yanaweza kuashiria udhaifu.

3. **Onyesha Udhaifu**
- Punguza shambulio kwa idadi ndogo ya maombi yanayohitajika kudukua udhaifu, mara nyingi ni mawili tu. Hatua hii inaweza kuhitaji majaribio mengi au uendeshaji wa moja kwa moja kutokana na wakati sahihi unaohusika.

### Mashambulio ya Wakati wa Kujali

Uwiano katika wakati wa maombi unaweza kufichua udhaifu, haswa wakati njia za kutabirika kama alama za wakati hutumiwa kwa ishara za usalama. Kwa mfano, kuzalisha ishara za kurejesha nywila kulingana na alama za wakati inaweza kuruhusu ishara sawa kwa maombi yanayofanyika wakati huo huo.

**Kudukua:**
- Tumia uwiano sahihi, kama shambulio la pakiti moja, kuomba kurejesha nywila kwa wakati mmoja. Ishara sawa zinaashiria udhaifu.

**Mfano:**
- Omba ishara mbili za kurejesha nywila wakati huo huo na uzilinganishe. Ishara zinazolingana zinaonyesha kasoro katika uzalishaji wa ishara.

**Angalia [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities) hii ili kujaribu hili.**


## Uchunguzi wa Hali Zisizoonekana

### Lipa & ongeza Bidhaa

Angalia [**PortSwigger Lab**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) hii ili kuona jinsi ya **kulipa** katika duka na **kuongeza ziada** ya bidhaa ambayo **hutahitaji kulipa**.

### Thibitisha barua pepe nyingine

Wazo ni **kuthibitisha anwani ya barua pepe na kubadilisha kuwa nyingine wakati huo huo** ili kujua ikiwa jukwaa linathibitisha ile mpya iliyobadilishwa.

### Badilisha barua pepe hadi anwani 2 kwa msingi wa Cookie

Kulingana na [**utafiti huu**](https://portswigger.net/research/smashing-the-state-machine) Gitlab ilikuwa na udhaifu wa kuchukuliwa kwa njia hii kwa sababu inaweza **kutuma** ishara ya **uthibitisho wa barua pepe ya barua pepe moja hadi barua pepe nyingine**.

**Angalia [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) hii ili kujaribu hili.**

### Hali Zisizoonekana za Hifadhidata / Kupita Uthibitisho

Ikiwa **kuandika tofauti 2** zinatumika kuongeza **habari** ndani ya **hifadhidata**, kuna sehemu ndogo ya wakati ambapo **data ya kwanza tu imeandikwa** ndani ya hifadhidata. Kwa mfano, wakati wa kuunda mtumiaji, **jina la mtumiaji** na **nywila** inaweza **kuandikwa** na **kisha ishara** ya kuthibitisha akaunti mpya iliyoandikwa. Hii inamaanisha kuwa kwa muda mfupi **ishara ya kuthibitisha akaunti ni tupu**.

Kwa hivyo, **kujiandikisha akaunti na kutuma maombi kadhaa na ishara tupu** (`ishara=` au `ishara[]=` au tofauti yoyote nyingine) ili kuthibitisha akaunti mara moja inaweza kuruhusu **kuthibitisha akaunti** ambapo huwezi kudhibiti barua pepe.

**Angalia [PortSwigger Lab](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) hii ili kujaribu hili.**

### Kupita 2FA

Pseudo-kodi ifuatayo ina udhaifu wa hali ya mbio kwa sababu kwa muda mfupi sana **2FA haijatekelezwa** wakati kikao kinajengwa:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
### Uthabiti wa Kudumu wa OAuth2

Kuna [**watoaji wa OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers) kadhaa. Huduma hizi zitaruhusu kuunda programu na kuthibitisha watumiaji ambao watoa huduma wamewasajili. Ili kufanya hivyo, **mteja** atahitaji **ruhusu ya programu yako** ili kupata baadhi ya data yao ndani ya **mtoa huduma wa OAuth**.\
Kwa hivyo, hadi hapa ni kama kuingia kawaida na google/linkedin/github... ambapo unaulizwa kwenye ukurasa unaosema: "_Application \<InsertCoolName> inataka kupata habari zako, unataka kuiruhusu?_"

#### Mzunguko wa Mashindano katika `authorization_code`

**Tatizo** linatokea unapokuwa **unakubali** na kutuma moja kwa moja **`authorization_code`** kwa programu mbaya. Kisha, programu hii **inatumia Mzunguko wa Mashindano katika mtoa huduma wa OAuth** ili kuzalisha AT/RT (_Authentication Token/Refresh Token_) zaidi ya moja kutoka kwa **`authorization_code`** kwa akaunti yako. Kimsingi, itatumia ukweli kwamba umekubali programu kupata data yako ili **kuunda akaunti kadhaa**. Kisha, ikiwa **utaacha kuruhusu programu kupata data yako, jozi moja ya AT/RT itafutwa, lakini zingine zitaendelea kuwa halali**.

#### Mzunguko wa Mashindano katika `Refresh Token`

Baada ya **kupata RT halali**, unaweza kujaribu **kuitumia vibaya** ili kuzalisha AT/RT kadhaa na **hata ikiwa mtumiaji anafuta ruhusa** kwa programu mbaya kupata data yake, **RT kadhaa bado zitakuwa halali**.

## **Mzunguko wa Mashindano katika WebSockets**

Katika [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC) unaweza kupata PoC katika Java kutuma ujumbe wa websocket kwa **njia sawa** ili kuzalisha **Mzunguko wa Mashindano pia katika Web Sockets**.

## Marejeo

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au **kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Tumia [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) kujenga na **kutumia hatua za kiotomatiki** zinazotumia zana za jamii za **kisasa zaidi**.\
Pata Ufikiaji Leo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
