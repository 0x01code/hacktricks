# Condi√ß√£o de Corrida

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com facilidade, utilizando as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Explorando a Condi√ß√£o de Corrida

O principal problema de abusar da Condi√ß√£o de Corrida √© que voc√™ precisa que as solicita√ß√µes sejam processadas em paralelo com uma diferen√ßa de tempo muito curta (geralmente >1ms). Na se√ß√£o a seguir, s√£o propostas diferentes solu√ß√µes para tornar isso poss√≠vel.

<figure><img src="../.gitbook/assets/image (5) (1).png" alt=""><figcaption></figcaption></figure>

### Ataque de pacote √∫nico (HTTP/2) / Sincroniza√ß√£o do √∫ltimo byte (HTTP/1.1)

O HTTP2 permite enviar **2 solicita√ß√µes em uma √∫nica conex√£o TCP** (enquanto no HTTP/1.1 elas devem ser sequenciais).\
O uso de um √∫nico pacote TCP elimina completamente o efeito da varia√ß√£o de rede, portanto, isso claramente tem potencial para ataques de condi√ß√£o de corrida tamb√©m. No entanto, **duas solicita√ß√µes n√£o s√£o suficientes para um ataque de corrida confi√°vel** devido √† **varia√ß√£o do lado do servidor** - varia√ß√µes no tempo de processamento da solicita√ß√£o do aplicativo causadas por vari√°veis incontrol√°veis, como conten√ß√£o da CPU.

Mas, usando a t√©cnica de '**sincroniza√ß√£o do √∫ltimo byte**' do HTTP/1.1, √© poss√≠vel pr√©-enviar a maior parte dos dados retendo um pequeno fragmento de cada solicita√ß√£o e, em seguida, 'completar' **20-30 solicita√ß√µes com um √∫nico pacote TCP**.

Para **pr√©-enviar a maior parte de cada solicita√ß√£o**:

* Se a solicita√ß√£o n√£o tiver corpo, envie todos os cabe√ßalhos, mas n√£o defina o sinalizador END\_STREAM. Retenha um quadro de dados vazio com o sinalizador END\_STREAM definido.
* Se a solicita√ß√£o tiver um corpo, envie os cabe√ßalhos e todos os dados do corpo, exceto o √∫ltimo byte. Retenha um quadro de dados contendo o √∫ltimo byte.

Em seguida, **prepare-se para enviar os quadros finais**:

* Aguarde 100ms para garantir que os quadros iniciais tenham sido enviados.
* Verifique se o TCP\_NODELAY est√° desativado - √© crucial que o algoritmo de Nagle agrupe os quadros finais.
* Envie um pacote de ping para aquecer a conex√£o local. Se voc√™ n√£o fizer isso, a pilha de rede do sistema operacional colocar√° o primeiro quadro final em um pacote separado.

Por fim, envie os quadros retidos. Voc√™ deve ser capaz de verificar se eles chegaram em um √∫nico pacote usando o Wireshark.

{% hint style="info" %}
Observe que isso **n√£o funciona para arquivos est√°ticos** em determinados servidores, mas como os arquivos est√°ticos n√£o s√£o relevantes para ataques de condi√ß√£o de corrida. Mas arquivos est√°ticos s√£o irrelevantes para ataques de CC.
{% endhint %}

Usando essa t√©cnica, voc√™ pode fazer com que 20-30 solicita√ß√µes cheguem ao servidor simultaneamente - independentemente da varia√ß√£o de rede:

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

**Adaptando √† arquitetura do alvo**

Vale ressaltar que muitos aplicativos est√£o atr√°s de um servidor de front-end, e esses servidores podem decidir encaminhar algumas solicita√ß√µes por meio de conex√µes existentes para o back-end e criar novas conex√µes para outras.

Portanto, √© importante n√£o atribuir o tempo inconsistente de solicita√ß√£o ao comportamento do aplicativo, como mecanismos de bloqueio que permitem apenas que uma √∫nica thread acesse um recurso de cada vez. Al√©m disso, o roteamento de solicita√ß√µes de front-end geralmente √© feito com base em conex√µes individuais, portanto, voc√™ pode suavizar o tempo de solicita√ß√£o realizando o aquecimento da conex√£o do lado do servidor - **enviando algumas solicita√ß√µes inconsequentes pela sua conex√£o antes de realizar o ataque** (isso significa enviar v√°rias solicita√ß√µes antes de iniciar o ataque real)).

#### Mecanismos de bloqueio baseados em sess√£o <a href="#session-based-locking-mechanisms" id="session-based-locking-mechanisms"></a>

Alguns frameworks tentam evitar a corrup√ß√£o acidental de dados usando algum tipo de **bloqueio de solicita√ß√£o**. Por exemplo, o m√≥dulo de manipulador de sess√£o nativo do **PHP processa apenas uma solicita√ß√£o por sess√£o de cada vez**.

√â extremamente importante identificar esse tipo de comportamento, pois ele pode mascarar vulnerabilidades facilmente explor√°veis. Se voc√™ perceber que todas as suas solicita√ß√µes est√£o sendo processadas sequencialmente, tente envi√°-las usando um token de sess√£o diferente para cada uma delas.
#### **Abusando dos limites de taxa ou recursos**

Se o aquecimento da conex√£o n√£o faz diferen√ßa, existem v√°rias solu√ß√µes para esse problema.

Usando o Turbo Intruder, voc√™ pode introduzir um pequeno atraso no lado do cliente. No entanto, como isso envolve dividir suas solicita√ß√µes de ataque reais em v√°rios pacotes TCP, voc√™ n√£o poder√° usar a t√©cnica de ataque de um √∫nico pacote. Como resultado, em alvos com alta varia√ß√£o de lat√™ncia, o ataque provavelmente n√£o funcionar√° de forma confi√°vel, independentemente do atraso definido.

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Em vez disso, voc√™ pode resolver esse problema abusando de um recurso de seguran√ßa comum.

Servidores web frequentemente **atrasam o processamento de solicita√ß√µes se muitas forem enviadas rapidamente**. Ao enviar um grande n√∫mero de solicita√ß√µes falsas para acionar intencionalmente o limite de taxa ou recurso, voc√™ pode causar um atraso adequado no lado do servidor. Isso torna o ataque de um √∫nico pacote vi√°vel mesmo quando a execu√ß√£o atrasada √© necess√°ria.

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Para obter mais informa√ß√µes sobre essa t√©cnica, consulte o relat√≥rio original em [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
{% endhint %}

#### Exemplos de Ataque

* **Tubo Intruder - Ataque de um √∫nico pacote HTTP2 (1 ponto de extremidade)**: Voc√™ pode enviar a solicita√ß√£o para o **Turbo Intruder** (`Extensions` -> `Turbo Intruder` -> `Send to Turbo Intruder`), voc√™ pode alterar na solicita√ß√£o o valor que deseja for√ßar por **`%s`** como em `csrf=Bn9VQB8OyefIs3ShR2fPESR0FzzulI1d&username=carlos&password=%s` e, em seguida, selecione o **`examples/race-single-packer-attack.py`** no menu suspenso:

<figure><img src="../.gitbook/assets/image (4) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ for **enviar valores diferentes**, voc√™ pode modificar o c√≥digo com este que usa uma lista de palavras da √°rea de transfer√™ncia:
```python
passwords = wordlists.clipboard
for password in passwords:
engine.queue(target.req, password, gate='race1')
```
{% hint style="warning" %}
Se o site n√£o suportar HTTP2 (apenas HTTP1.1), use `Engine.THREADED` ou `Engine.BURP` em vez de `Engine.BURP2`.
{% endhint %}

* **Tubo Intruder - Ataque de pacote √∫nico HTTP2 (V√°rios endpoints)**: Caso voc√™ precise enviar uma solicita√ß√£o para 1 endpoint e depois v√°rias para outros endpoints para acionar o RCE, voc√™ pode alterar o script `race-single-packet-attack.py` para algo como:
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=1,
engine=Engine.BURP2
)

# Hardcode the second request for the RC
confirmationReq = '''POST /confirm?token[]= HTTP/2
Host: 0a9c00370490e77e837419c4005900d0.web-security-academy.net
Cookie: phpsessionid=MpDEOYRvaNT1OAm0OtAsmLZ91iDfISLU
Content-Length: 0

'''

# For each attempt (20 in total) send 50 confirmation requests.
for attempt in range(20):
currentAttempt = str(attempt)
username = 'aUser' + currentAttempt

# queue a single registration request
engine.queue(target.req, username, gate=currentAttempt)

# queue 50 confirmation requests - note that this will probably sent in two separate packets
for i in range(50):
engine.queue(confirmationReq, gate=currentAttempt)

# send all the queued requests for this attempt
engine.openGate(currentAttempt)
```
* Tamb√©m est√° dispon√≠vel no **Repeater** atrav√©s da nova op√ß√£o '**Enviar grupo em paralelo**' no Burp Suite.
* Para **limit-overrun**, voc√™ pode simplesmente adicionar a **mesma solicita√ß√£o 50 vezes** no grupo.
* Para **aquecimento de conex√£o**, voc√™ pode **adicionar** no **in√≠cio** do **grupo** algumas **solicita√ß√µes** para alguma parte n√£o est√°tica do servidor web.
* Para **atrasar** o processo **entre** o processamento **de uma solicita√ß√£o e outra** em etapas de 2 subestados, voc√™ pode **adicionar solicita√ß√µes extras entre** ambas as solicita√ß√µes.
* Para um RC de **v√°rios endpoints**, voc√™ pode come√ßar enviando a **solicita√ß√£o** que **vai para o estado oculto** e, em seguida, **50 solicita√ß√µes** logo ap√≥s isso que **exploram o estado oculto**.

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

### Raw BF

Antes da pesquisa anterior, esses eram alguns payloads usados que apenas tentavam enviar os pacotes o mais r√°pido poss√≠vel para causar um RC.

* **Repeater:** Verifique os exemplos da se√ß√£o anterior.
* **Intruder**: Envie a **solicita√ß√£o** para o **Intruder**, defina o **n√∫mero de threads** para **30** dentro do menu **Op√ß√µes** e selecione como payload **Cargas √∫teis nulas** e gere **30**.
* **Turbo Intruder**
```python
def queueRequests(target, wordlists):
engine = RequestEngine(endpoint=target.endpoint,
concurrentConnections=5,
requestsPerConnection=1,
pipeline=False
)
a = ['Session=<session_id_1>','Session=<session_id_2>','Session=<session_id_3>']
for i in range(len(a)):
engine.queue(target.req,a[i], gate='race1')
# open TCP connections and send partial requests
engine.start(timeout=10)
engine.openGate('race1')
engine.complete(timeout=60)

def handleResponse(req, interesting):
table.add(req)
```
* **Python - asyncio**

A biblioteca `asyncio` do Python fornece suporte para programa√ß√£o ass√≠ncrona, permitindo que voc√™ escreva c√≥digo concorrente e escal√°vel de forma mais eficiente. Com `asyncio`, voc√™ pode lidar com tarefas ass√≠ncronas, como chamadas de rede, de forma mais eficiente, evitando bloqueios desnecess√°rios.

A programa√ß√£o ass√≠ncrona √© particularmente √∫til ao lidar com condi√ß√µes de corrida em aplicativos da web. Uma condi√ß√£o de corrida ocorre quando duas ou mais opera√ß√µes concorrentes tentam acessar ou modificar um recurso compartilhado ao mesmo tempo, resultando em comportamento imprevis√≠vel ou incorreto.

Ao usar `asyncio`, voc√™ pode evitar condi√ß√µes de corrida implementando mecanismos de exclus√£o m√∫tua, como sem√°foros ou bloqueios, para garantir que apenas uma tarefa possa acessar o recurso compartilhado de cada vez. Isso ajuda a evitar inconsist√™ncias de dados e garantir a integridade do sistema.

Al√©m disso, `asyncio` tamb√©m oferece suporte a corrotinas, que s√£o fun√ß√µes ass√≠ncronas que podem ser pausadas e retomadas posteriormente. Isso permite que voc√™ escreva c√≥digo ass√≠ncrono de forma mais leg√≠vel e organizada, facilitando o gerenciamento de tarefas concorrentes.

Em resumo, a biblioteca `asyncio` do Python √© uma ferramenta poderosa para lidar com condi√ß√µes de corrida em aplicativos da web, permitindo que voc√™ escreva c√≥digo ass√≠ncrono eficiente e escal√°vel.
```python
import asyncio
import httpx

async def use_code(client):
resp = await client.post(f'http://victim.com', cookies={"session": "asdasdasd"}, data={"code": "123123123"})
return resp.text

async def main():
async with httpx.AsyncClient() as client:
tasks = []
for _ in range(20): #20 times
tasks.append(asyncio.ensure_future(use_code(client)))

# Get responses
results = await asyncio.gather(*tasks, return_exceptions=True)

# Print results
for r in results:
print(r)

# Async2sync sleep
await asyncio.sleep(0.5)
print(results)

asyncio.run(main())
```
## **Metodologia de RC**

### Limite de estouro / TOCTOU

Este √© o tipo mais b√°sico de condi√ß√£o de corrida, onde **vulnerabilidades** que **aparecem** em lugares que **limitam o n√∫mero de vezes que voc√™ pode executar uma a√ß√£o**. Como usar o mesmo c√≥digo de desconto v√°rias vezes em uma loja online. Um exemplo muito f√°cil pode ser encontrado neste [**relat√≥rio**](https://medium.com/@pravinponnusamy/race-condition-vulnerability-found-in-bug-bounty-program-573260454c43) ou neste [**bug**](https://hackerone.com/reports/759247)**.**

Existem muitas varia√ß√µes desse tipo de ataque, incluindo:

* Resgatar um cart√£o-presente v√°rias vezes
* Avaliar um produto v√°rias vezes
* Sacar ou transferir dinheiro al√©m do saldo da sua conta
* Reutilizar uma solu√ß√£o CAPTCHA √∫nica
* Bypass de um limite de taxa anti-brute-force

### **Subestados ocultos**

Outra condi√ß√£o de corrida mais complicada explorar√° **subestados no estado da m√°quina** que poderiam permitir que um invasor **abusasse** de estados aos quais ele **nunca deveria ter acesso**, mas h√° uma **pequena janela** para o invasor acess√°-lo.

1. **Prever subestados ocultos e interessantes potenciais**

O primeiro passo √© identificar todos os pontos finais que gravam nele ou l√™em dados dele e, em seguida, usam esses dados para algo importante. Por exemplo, os usu√°rios podem ser armazenados em uma tabela de banco de dados que √© modificada pelo registro, edi√ß√£o de perfil, inicia√ß√£o de redefini√ß√£o de senha e conclus√£o da redefini√ß√£o de senha.

Podemos usar tr√™s perguntas-chave para descartar pontos finais que provavelmente n√£o causar√£o colis√µes. Para cada objeto e os pontos finais associados, pergunte:

* **Como o estado √© armazenado?**

Dados armazenados em uma estrutura de dados persistente do lado do servidor s√£o ideais para explora√ß√£o. Alguns pontos finais armazenam seu estado inteiramente no lado do cliente, como redefini√ß√µes de senha que funcionam enviando um JWT por e-mail - esses podem ser ignorados com seguran√ßa.

As aplica√ß√µes costumam armazenar algum estado na sess√£o do usu√°rio. Esses estados geralmente s√£o um tanto protegidos contra subestados - mais sobre isso depois.

* **Estamos editando ou anexando?**

Opera√ß√µes que editam dados existentes (como alterar o endere√ßo de e-mail principal de uma conta) t√™m grande potencial de colis√£o, enquanto a√ß√µes que simplesmente anexam a dados existentes (como adicionar um endere√ßo de e-mail adicional) provavelmente n√£o ser√£o vulner√°veis a nada al√©m de ataques de limite de estouro.

* **Em que a opera√ß√£o √© baseada?**

A maioria dos pontos finais opera em um registro espec√≠fico, que √© procurado usando uma 'chave', como um nome de usu√°rio, token de redefini√ß√£o de senha ou nome de arquivo. Para um ataque bem-sucedido, precisamos de duas opera√ß√µes que usem a mesma chave. Por exemplo, imagine duas implementa√ß√µes plaus√≠veis de redefini√ß√£o de senha:

<figure><img src="../.gitbook/assets/image (2) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

2. **Investigar pistas**

Neste ponto, √© hora de **lan√ßar alguns ataques de RC** nos pontos finais potencialmente interessantes para tentar encontrar resultados inesperados em compara√ß√£o com os regulares. **Qualquer desvio da resposta esperada**, como uma mudan√ßa em uma ou mais respostas, ou um efeito de segunda ordem, como conte√∫dos de e-mail diferentes ou uma mudan√ßa vis√≠vel em sua sess√£o, pode ser uma pista indicando que algo est√° errado.

3. **Provar o conceito**

A etapa final √© **provar o conceito e transform√°-lo em um ataque vi√°vel**.

Quando voc√™ envia um lote de solicita√ß√µes, pode descobrir que um par de solicita√ß√µes iniciais aciona um estado final vulner√°vel, mas solicita√ß√µes posteriores sobrescrevem/invalidam esse estado e o estado final n√£o pode ser explorado. Nesse cen√°rio, voc√™ desejar√° eliminar todas as solicita√ß√µes desnecess√°rias - duas devem ser suficientes para explorar a maioria das vulnerabilidades. No entanto, reduzir para duas solicita√ß√µes tornar√° o ataque mais sens√≠vel ao tempo, portanto, talvez seja necess√°rio tentar o ataque v√°rias vezes ou automatiz√°-lo.

### Ataques Sens√≠veis ao Tempo

√Äs vezes, voc√™ pode n√£o encontrar condi√ß√µes de corrida, mas as **t√©cnicas para enviar solicita√ß√µes com tempo preciso** ainda podem revelar a presen√ßa de outras vulnerabilidades.

Um exemplo disso √© quando **carimbos de data/hora de alta resolu√ß√£o s√£o usados em vez de strings aleat√≥rias criptograficamente** seguras para gerar tokens de seguran√ßa.

Considere um **token de redefini√ß√£o de senha que √© apenas randomizado usando um carimbo de data/hora**. Nesse caso, pode ser poss√≠vel **acionar duas redefini√ß√µes de senha para dois usu√°rios diferentes**, que usam **o mesmo token**. Tudo o que voc√™ precisa fazer √© cronometrar as solicita√ß√µes para que elas gerem o mesmo carimbo de data/hora.

{% hint style="warning" %}
Para confirmar, por exemplo, a situa√ß√£o anterior, voc√™ pode simplesmente solicitar **2 tokens de redefini√ß√£o de senha ao mesmo tempo** (usando um ataque de pacote √∫nico) e verificar se eles s√£o **iguais**.
{% endhint %}

Verifique o [**exemplo neste laborat√≥rio**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-exploiting-time-sensitive-vulnerabilities).

## Estudos de caso de subestados ocultos

### Pagar e adicionar um item

[**Verifique este laborat√≥rio**](https://portswigger.net/web-security/logic-flaws/examples/lab-logic-flaws-insufficient-workflow-validation) para ver como **pagar** em uma loja e **adicionar um item extra** que voc√™ **n√£o precisar√° pagar**.

### Confirmar outros e-mails

A ideia √© **verificar um endere√ßo de e-mail e alter√°-lo para um diferente ao mesmo tempo** para descobrir se a plataforma verifica o novo endere√ßo alterado.

### Alterar o e-mail para 2 endere√ßos de e-mail baseados em cookie

De acordo com [**este artigo**](https://portswigger.net/research/smashing-the-state-machine), o Gitlab estava vulner√°vel a uma invas√£o dessa maneira porque poderia **enviar** o **token de verifica√ß√£o de e-mail de um e-mail para o outro e-mail**.

Voc√™ tamb√©m pode verificar [**este laborat√≥rio**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-single-endpoint) para aprender sobre isso.

### Estados ocultos do banco de dados / Bypass de confirma√ß√£o

Se **2 grava√ß√µes diferentes** s√£o usadas para **adicionar** **informa√ß√µes** dentro de um **banco de dados**, h√° uma pequena parte do tempo em que **apenas os primeiros dados foram gravados** no banco de dados. Por exemplo, ao criar um usu√°rio, o **nome de usu√°rio** e a **senha** podem ser **gravados** e, em seguida, o token para confirmar a conta rec√©m-criada √© gravado. Isso significa que por um curto per√≠odo de tempo, o **token para confirmar uma conta √© nulo**.

Portanto, **registrar uma conta e enviar v√°rias solicita√ß√µes com um token vazio** (`token=` ou `token[]=` ou qualquer outra varia√ß√£o) para confirmar a conta imediatamente pode permitir **confirmar uma conta** em que voc√™ n√£o controla o e-mail.

Verifique [**este laborat√≥rio**](https://portswigger.net/web-security/race-conditions/lab-race-conditions-partial-construction) para ver um exemplo.
### Bypassar 2FA

O seguinte pseudo-c√≥digo demonstra como um site pode ser vulner√°vel a uma varia√ß√£o de corrida desse ataque:
```python
session['userid'] = user.userid
if user.mfa_enabled:
session['enforce_mfa'] = True
# generate and send MFA code to user
# redirect browser to MFA code entry form
```
Como voc√™ pode ver, isso √© de fato uma **sequ√™ncia de v√°rios passos dentro de uma √∫nica solicita√ß√£o**. Mais importante ainda, ela passa por um subestado em que o **usu√°rio temporariamente possui uma sess√£o v√°lida logada**, **mas a MFA ainda n√£o est√° sendo aplicada**. Um atacante poderia potencialmente explorar isso enviando uma solicita√ß√£o de login juntamente com uma solicita√ß√£o a um endpoint autenticado sens√≠vel.

### Persist√™ncia eterna do OAuth2

Existem v√°rios [**provedores de OAuth**](https://en.wikipedia.org/wiki/List\_of\_OAuth\_providers). Esses servi√ßos permitir√£o que voc√™ crie um aplicativo e autentique usu√°rios registrados pelo provedor. Para fazer isso, o **cliente** precisar√° **permitir que seu aplicativo** acesse alguns de seus dados dentro do **provedor de OAuth**.\
Ent√£o, at√© aqui, apenas um login comum com google/linkdin/github... onde voc√™ √© solicitado com uma p√°gina dizendo: "_O aplicativo \<InsertCoolName> deseja acessar suas informa√ß√µes, voc√™ deseja permitir?_"

#### Condi√ß√£o de corrida em `authorization_code`

O **problema** ocorre quando voc√™ **aceita** e automaticamente envia um **`authorization_code`** para o aplicativo malicioso. Em seguida, esse **aplicativo abusa de uma Condi√ß√£o de Corrida no provedor de servi√ßos de OAuth para gerar mais de um AT/RT** (_Authentication Token/Refresh Token_) a partir do **`authorization_code`** para sua conta. Basicamente, ele abusar√° do fato de voc√™ ter aceitado o aplicativo para acessar seus dados e **criar√° v√°rias contas**. Ent√£o, se voc√™ **parar de permitir que o aplicativo acesse seus dados, um par de AT/RT ser√° exclu√≠do, mas os outros ainda ser√£o v√°lidos**.

#### Condi√ß√£o de corrida em `Refresh Token`

Depois de **obter um RT v√°lido**, voc√™ pode tentar **abusar dele para gerar v√°rios AT/RT** e, mesmo se o usu√°rio cancelar as permiss√µes para o aplicativo malicioso acessar seus dados, **v√°rios RTs ainda ser√£o v√°lidos**.

## **CC em WebSockets**

No [**WS\_RaceCondition\_PoC**](https://github.com/redrays-io/WS\_RaceCondition\_PoC), voc√™ pode encontrar um PoC em Java para enviar mensagens de websocket em **paralelo** para abusar das **Condi√ß√µes de Corrida tamb√©m em Web Sockets**.

## Refer√™ncias

* [https://hackerone.com/reports/759247](https://hackerone.com/reports/759247)
* [https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html](https://pandaonair.com/2020/06/11/race-conditions-exploring-the-possibilities.html)
* [https://hackerone.com/reports/55140](https://hackerone.com/reports/55140)
* [https://portswigger.net/research/smashing-the-state-machine](https://portswigger.net/research/smashing-the-state-machine)
* [https://portswigger.net/web-security/race-conditions](https://portswigger.net/web-security/race-conditions)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para criar e **automatizar fluxos de trabalho** com facilidade, usando as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
