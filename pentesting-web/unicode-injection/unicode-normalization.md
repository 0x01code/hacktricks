# Normalizaci√≥n Unicode

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repos de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Antecedentes

La normalizaci√≥n asegura que dos cadenas que pueden usar una representaci√≥n binaria diferente para sus caracteres tengan el mismo valor binario despu√©s de la normalizaci√≥n.

Hay dos tipos generales de equivalencia entre caracteres, ‚Äú**Equivalencia Can√≥nica**‚Äù y ‚Äú**Equivalencia de Compatibilidad**‚Äù:\
Los caracteres **Can√≥nicamente Equivalentes** se asumen que tienen la misma apariencia y significado cuando se imprimen o se muestran. La **Equivalencia de Compatibilidad** es una equivalencia m√°s d√©bil, en la que dos valores pueden representar el mismo car√°cter abstracto pero pueden mostrarse de manera diferente. Hay **4 algoritmos de Normalizaci√≥n** definidos por el est√°ndar **Unicode**; **NFC, NFD, NFKD y NFKD**, cada uno aplica t√©cnicas de normalizaci√≥n Can√≥nica y de Compatibilidad de manera diferente. Puedes leer m√°s sobre las diferentes t√©cnicas en Unicode.org.

### Codificaci√≥n Unicode

Aunque Unicode fue dise√±ado en parte para resolver problemas de interoperabilidad, la evoluci√≥n del est√°ndar, la necesidad de soportar sistemas heredados y diferentes m√©todos de codificaci√≥n a√∫n pueden plantear un desaf√≠o.\
Antes de adentrarnos en ataques Unicode, los siguientes son los puntos principales a entender sobre Unicode:

* Cada car√°cter o s√≠mbolo est√° mapeado a un valor num√©rico que se conoce como ‚Äúpunto de c√≥digo‚Äù.
* El valor del punto de c√≥digo (y por lo tanto el car√°cter en s√≠) est√° representado por 1 o m√°s bytes en memoria. Los caracteres LATIN-1 como los utilizados en pa√≠ses de habla inglesa pueden representarse usando 1 byte. Otros idiomas tienen m√°s caracteres y necesitan m√°s bytes para representar todos los diferentes puntos de c√≥digo (tambi√©n porque no pueden usar los ya tomados por LATIN-1).
* El t√©rmino ‚Äúcodificaci√≥n‚Äù significa el m√©todo en el que los caracteres se representan como una serie de bytes. El est√°ndar de codificaci√≥n m√°s com√∫n es UTF-8, usando este esquema de codificaci√≥n los caracteres ASCII pueden representarse usando 1 byte o hasta 4 bytes para otros caracteres.
* Cuando un sistema procesa datos necesita saber la codificaci√≥n utilizada para convertir la secuencia de bytes en caracteres.
* Aunque UTF-8 es el m√°s com√∫n, hay est√°ndares de codificaci√≥n similares llamados UTF-16 y UTF-32, la diferencia entre cada uno es el n√∫mero de bytes utilizados para representar cada car√°cter. Por ejemplo, UTF-16 usa un m√≠nimo de 2 bytes (pero hasta 4) y UTF-32 usa 4 bytes para todos los caracteres.

Un ejemplo de c√≥mo Unicode normaliza dos bytes diferentes que representan el mismo car√°cter:

![](<../../.gitbook/assets/image (156).png>)

**Una lista de caracteres Unicode equivalentes se puede encontrar aqu√≠:** [https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) y [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### Descubrimiento

Si puedes encontrar dentro de una webapp un valor que se est√° reflejando, podr√≠as intentar enviar **‚ÄòKELVIN SIGN‚Äô (U+0212A)** que se **normaliza a "K"** (puedes enviarlo como `%e2%84%aa`). **Si se refleja una "K"**, entonces, se est√° realizando alg√∫n tipo de **normalizaci√≥n Unicode**.

Otro **ejemplo**: `%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` despu√©s de **unicode** es `Leonishan`.

## **Ejemplos Vulnerables**

### **Bypass de filtro de Inyecci√≥n SQL**

Imagina una p√°gina web que est√° utilizando el car√°cter `'` para crear consultas SQL con la entrada del usuario. Esta web, como medida de seguridad, **elimina** todas las ocurrencias del car√°cter **`'`** de la entrada del usuario, pero **despu√©s de esa eliminaci√≥n** y **antes de la creaci√≥n** de la consulta, **normaliza** usando **Unicode** la entrada del usuario.

Entonces, un usuario malicioso podr√≠a insertar un car√°cter Unicode diferente equivalente a `' (0x27)` como `%ef%bc%87`, cuando la entrada se normaliza, se crea una comilla simple y aparece una vulnerabilidad de **SQLInjection**:

![](<../../.gitbook/assets/image (157) (1).png>)

**Algunos caracteres Unicode interesantes**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### Plantilla sqlmap

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS (Cross Site Scripting)

Podr√≠as usar uno de los siguientes caracteres para enga√±ar a la aplicaci√≥n web y explotar un XSS:

![](<../../.gitbook/assets/image (312) (1).png>)

Observa que, por ejemplo, el primer car√°cter Unicode propuesto puede enviarse como: `%e2%89%ae` o como `%u226e`

![](<../../.gitbook/assets/image (215) (1).png>)

### Fuzzing de Regexes

Cuando el backend est√° **verificando la entrada del usuario con un regex**, podr√≠a ser posible que la **entrada** est√© siendo **normalizada** para el **regex** pero **no** para donde se est√° **usando**. Por ejemplo, en una Redirecci√≥n Abierta o SSRF, el regex podr√≠a estar **normalizando la URL enviada** pero luego **accediendo a ella tal cual**.

La herramienta [**recollapse**](https://github.com/0xacb/recollapse) permite **generar variaciones de la entrada** para hacer fuzzing en el backend. Para m√°s informaci√≥n, consulta el **github** y este [**post**](https://0xacb.com/2022/11/21/recollapse/).

## Referencias

**Toda la informaci√≥n de esta p√°gina fue tomada de:** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/#**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/)

**Otras referencias:**

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
