# Unicode 正規化

<details>

<summary><strong>AWS ハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告したい**、または **HackTricks を PDF でダウンロードしたい** 場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com) を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見し、独占的な [**NFT**](https://opensea.io/collection/the-peass-family) コレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f) に**参加する**か、[**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を **フォローする**。
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングのコツを共有する。

</details>

## 背景

正規化は、異なるバイナリ表現を使用する可能性がある2つの文字列が、正規化後に同じバイナリ値を持つことを保証します。

文字間の等価性には、「**正準等価**」と「**互換性等価**」の2つの全体的なタイプがあります：\
**正準等価**文字は、印刷または表示されたときに同じ外観と意味を持つと見なされます。**互換性等価**はより弱い等価性であり、2つの値が同じ抽象的な文字を表す可能性がありますが、異なる方法で表示される可能性があります。**Unicode** 標準によって定義された **4つの正規化アルゴリズム**; **NFC、NFD、NFKD、NFKD** があり、それぞれが正準および互換性の正規化技術を異なる方法で適用します。Unicode.org でさまざまな技術について詳しく読むことができます。

### Unicode エンコーディング

Unicode は部分的に相互運用性の問題を解決するために設計されましたが、標準の進化、レガシーシステムのサポート、および異なるエンコーディング方法の必要性は依然として課題を提起する可能性があります。\
Unicode 攻撃について詳しく説明する前に、Unicode について理解すべき主なポイントは次のとおりです：

* 各文字または記号は数値にマップされ、「コードポイント」と呼ばれます。
* コードポイント値（したがって文字自体）は、メモリ内で1バイト以上のバイトで表されます。英語圏で使用される LATIN-1 文字は1バイトを使用して表すことができます。他の言語にはより多くの文字があり、すべての異なるコードポイントを表すためにより多くのバイトが必要です（LATIN-1 ですでに取られているものを使用することはできません）。
* 「エンコーディング」という用語は、文字がバイトのシリーズとしてどのように表されるかを意味します。最も一般的なエンコーディング標準は UTF-8 で、このエンコーディングスキームを使用すると、ASCII 文字は1バイトを使用して表すことができ、他の文字は最大4バイトを使用して表すことができます。
* システムがデータを処理するとき、バイトストリームを文字に変換するために使用されるエンコーディングを知る必要があります。
* UTF-8 が最も一般的ですが、UTF-16 および UTF-32 という名前の類似のエンコーディング標準があり、それぞれの違いは各文字を表すために使用されるバイト数です。例えば、UTF-16 は最小2バイト（最大4バイトまで）を使用し、UTF-32 はすべての文字に4バイトを使用します。

Unicode が同じ文字を表す2つの異なるバイトをどのように正規化するかの例：

![](<../../.gitbook/assets/image (156).png>)

**Unicode 等価文字のリストはこちらで見つけることができます：** [https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) および [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### 発見

ウェブアプリ内でエコーバックされている値を見つけることができれば、**「ケルビン記号」（U+0212A）** を送信してみることができます。これは **"K" に正規化されます**（`%e2%84%aa` として送信できます）。**"K" がエコーバックされた場合**、何らかの形の **Unicode 正規化** が行われています。

他の **例**：`%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` は **unicode** で `Leonishan` になります。

## **脆弱な例**

### **SQL インジェクション フィルター回避**

ユーザー入力で SQL クエリを作成するために文字 `'` を使用しているウェブページを想像してください。このウェブはセキュリティ対策として、ユーザー入力から文字 **`'`** のすべての出現を **削除します**が、その削除 **後** とクエリの **作成前** に、ユーザーの入力を **Unicode** を使用して **正規化します**。

その後、悪意のあるユーザーは `' (0x27)` に等価な異なる Unicode 文字を挿入することができます。例えば `%ef%bc%87` です。入力が正規化されると、シングルクォートが作成され、**SQLInjection の脆弱性** が現れます：

![](<../../.gitbook/assets/image (157) (1).png>)

**いくつかの興味深い Unicode 文字**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### sqlmap テンプレート

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS (クロスサイトスクリプティング)

以下の文字のいずれかを使用して、webアプリをだましてXSSを利用することができます:

![](<../../.gitbook/assets/image (312) (1).png>)

例えば、最初のUnicode文字は `%e2%89%ae` または `%u226e` として送信できることに注意してください。

![](<../../.gitbook/assets/image (215) (1).png>)

### Fuzzing Regexes

バックエンドが**正規表現でユーザー入力をチェックしている**場合、**入力**が**正規表現**用に**正規化**されているが、使用される場所では**されていない**可能性があります。例えば、オープンリダイレクトやSSRFでは、正規表現が送信されたURLを**正規化**しているかもしれませんが、そのまま**アクセス**している場合があります。

ツール [**recollapse**](https://github.com/0xacb/recollapse) は、バックエンドをfuzzするために**入力のバリエーションを生成**することができます。詳細については、**github**とこの[**ポスト**](https://0xacb.com/2022/11/21/recollapse/)をチェックしてください。

## 参考文献

**このページの情報はすべて以下から取得されました:** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/#**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/)

**その他の参考文献:**

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksに広告を掲載したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* **HackTricks**の[**githubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>
