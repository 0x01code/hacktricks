# LFI2RCE via PHP\_SESSION\_UPLOAD\_PROGRESS

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
### Informa√ß√µes B√°sicas

Se voc√™ encontrou uma **Inclus√£o Local de Arquivo** mesmo que voc√™ **n√£o tenha uma sess√£o** e `session.auto_start` esteja `Off`. Se **`session.upload_progress.enabled`** estiver **`On`** e voc√™ fornecer o **`PHP_SESSION_UPLOAD_PROGRESS`** em dados **multipart POST**, o PHP **ativar√° a sess√£o para voc√™**.
```bash
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange'
$ ls -a /var/lib/php/sessions/
. ..
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange' -d 'PHP_SESSION_UPLOAD_PROGRESS=blahblahblah'
$ ls -a /var/lib/php/sessions/
. ..
$ curl http://127.0.0.1/ -H 'Cookie: PHPSESSID=iamorange' -F 'PHP_SESSION_UPLOAD_PROGRESS=blahblahblah'  -F 'file=@/etc/passwd'
$ ls -a /var/lib/php/sessions/
. .. sess_iamorange

In the last example the session will contain the string blahblahblah
```
Note que com **`PHP_SESSION_UPLOAD_PROGRESS`** voc√™ pode **controlar dados dentro da sess√£o**, ent√£o se voc√™ incluir o arquivo da sua sess√£o, voc√™ pode incluir uma parte que voc√™ controla (um shellcode PHP, por exemplo).

{% hint style="info" %}
Embora a maioria dos tutoriais na Internet recomende que voc√™ defina `session.upload_progress.cleanup` como `Off` para fins de depura√ß√£o, o padr√£o `session.upload_progress.cleanup` no PHP ainda √© `On`. Isso significa que o progresso do upload na sess√£o ser√° limpo o mais r√°pido poss√≠vel. Ent√£o, isso ser√° uma **Condi√ß√£o de Corrida**.
{% endhint %}

### O CTF

No [**CTF original**](https://blog.orange.tw/2018/10/) onde essa t√©cnica √© comentada, n√£o era suficiente explorar a Condi√ß√£o de Corrida, mas o conte√∫do carregado tamb√©m precisava come√ßar com a string `@<?php`.

Devido √† configura√ß√£o padr√£o de `session.upload_progress.prefix`, nosso **arquivo SESSION come√ßar√° com um prefixo irritante** `upload_progress_` Como: `upload_progress_conteudocontroladopeloatacante`

O truque para **remover o prefixo inicial** foi **codificar em base64 o payload 3 vezes** e depois decodific√°-lo atrav√©s dos filtros `convert.base64-decode`, isso porque ao **decodificar base64 o PHP remover√° os caracteres estranhos**, ent√£o ap√≥s 3 vezes **apenas** o **payload** **enviado** pelo atacante **permanecer√°** (e ent√£o o atacante pode controlar a parte inicial).

Mais informa√ß√µes no writeup original [https://blog.orange.tw/2018/10/](https://blog.orange.tw/2018/10/) e exploit final [https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp\_for\_php.py](https://github.com/orangetw/My-CTF-Web-Challenges/blob/master/hitcon-ctf-2018/one-line-php-challenge/exp\_for\_php.py)\
Outro writeup em [https://spyclub.tech/2018/12/21/one-line-and-return-of-one-line-php-writeup/](https://spyclub.tech/2018/12/21/one-line-and-return-of-one-line-php-writeup/)

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
