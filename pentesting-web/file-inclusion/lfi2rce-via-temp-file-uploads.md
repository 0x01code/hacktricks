<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方PEASS和HackTricks的衣物**](https://peass.creator-spring.com)

- **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向[hacktricks repo](https://github.com/carlospolop/hacktricks)和[hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)提交PR来分享你的黑客技巧**。

</details>


## **PHP文件上传**

**PHP**引擎在**接收到带有RFC 1867编码的文件的POST数据包**时，会**创建一个或多个临时文件**，用于**存储上传文件的数据**。处理文件上传的PHP脚本需要使用move\_uploaded\_file函数将上传的临时文件移动到所需的位置（如果脚本在终止后需要文件存在）。**当脚本结束时，PHP引擎会删除所有已上传的临时文件**（如果脚本结束后还有文件剩余）。

{% hint style="info" %}
**由于攻击者通常会知道这些临时文件的位置，在发现本地文件包含漏洞时，他可能会加载正在上传的文件并获取RCE。**
{% endhint %}

访问文件的主要问题基本上是**猜测其名称（它将是“随机”的）**。

## Windows系统利用

在Windows系统上，为了生成**随机名称**，PHP使用了**`GetTempFileName`**函数。查看文档，我们可以找到以下解释：GetTempFileName函数创建一个以下形式的临时文件名：

`<path>\<pre><uuuu>.TMP`

* 路径是`upload_tmp_dir`，通常为`C:\Windows\Temp`
* pre通常为："php"
* \<uuuu>是一个唯一的十六进制值。然而：
* 只使用uUnique参数的低16位。如果lpPathName和lpPrefixString参数保持不变，则GetTempFileName最多可以生成65535个唯一文件名。**可以使用暴力破解来解决这个问题。**

正如我们所见，**在Windows系统中找到**临时文件**相当容易**。而且它将变得更容易，因为这里不需要暴力破解，多亏了某个FindFirstFile的特殊性，它允许在Windows上的LFI路径中使用掩码（<<作为\*，>作为?）。借助这一点，可以形成一个**如下所示的包含路径**：
```
http://site/vuln.php?inc=c:\windows\temp\php<<
```
在某些情况下，可能需要更具体的掩码，例如`php1<<`或`phpA<<`。您可以使用更具体的掩码进行暴力破解，直到找到您上传的临时文件。

## GNU/Linux 漏洞利用

文件名的随机值足够不可预测，也无法通过暴力破解。有关更多信息，请参阅参考资料。

## 参考资料

* [https://gynvael.coldwind.pl/?id=376](https://gynvael.coldwind.pl/?id=376)
* [https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf](https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks 云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- 您在**网络安全公司**工作吗？您想在 HackTricks 中看到您的**公司广告**吗？或者您想获得**PEASS 的最新版本或下载 PDF 格式的 HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！

- 发现我们的独家 [**NFTs**](https://opensea.io/collection/the-peass-family) 集合 - [**The PEASS Family**](https://opensea.io/collection/the-peass-family)

- 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)

- **加入** [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram 群组**](https://t.me/peass)，或在 **Twitter** 上 **关注**我 [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **通过向 [hacktricks 仓库](https://github.com/carlospolop/hacktricks) 和 [hacktricks-cloud 仓库](https://github.com/carlospolop/hacktricks-cloud) 提交 PR 来分享您的黑客技巧**。

</details>
