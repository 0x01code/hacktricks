<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>


## **PHPファイルのアップロード**

**PHP**エンジンは、RFC 1867で**コード化されたファイル**を含む**POSTパケット**を受信すると、**アップロードされたファイルデータを保存するために1つ以上の一時ファイル**を作成します。ファイルのアップロードを処理するPHPスクリプトは、アップロードされた一時ファイルを望む場所に移動するためにmove\_uploaded\_file関数を使用する必要があります（スクリプトが終了した後もファイルが存在する必要がある場合）。**スクリプトが終了すると、PHPエンジンはアップロードされたファイルのすべての一時ファイルを削除**します（スクリプトが終了した後に残っている場合）。

{% hint style="info" %}
**攻撃者は通常、一時ファイルがどこにあるかを知っているため、ローカルファイルインクルージョンを見つけた場合、アップロードされたファイルをロードしてRCEを取得することができます。**
{% endhint %}

ファイルにアクセスするための主な問題は、**その名前（ランダムになる）を推測すること**です。

## Windowsの脆弱性

Windowsでは、**ランダムな名前を生成するために** PHPは**`GetTempFileName`**関数を使用します。ドキュメントを調べると、次の説明が見つかります：GetTempFileName関数は、次の形式の一時ファイル名を作成します。

`<path>\<pre><uuuu>.TMP`

* パスは通常`C:\Windows\Temp`です
* preは通常「php」です
* \<uuuu>は一意の16進数値です。ただし：
* uUniqueパラメータの下位16ビットのみが使用されます。これにより、lpPathNameとlpPrefixStringパラメータが同じ場合、GetTempFileNameは最大で65,535個の一意のファイル名を作成できます。**これをブルートフォースできます。**

見たように、Windowsシステムの一時ファイルには比較的**簡単にアクセス**できます。そして、ここではブルートフォースは必要ありません。WindowsのLFIパスでマスク（<<を\*として、>を?として）を使用できるという特定のFindFirstFileのクセがあるためです。これにより、次のような**インクルードパス**を形成できます：
```
http://site/vuln.php?inc=c:\windows\temp\php<<
```
（場合によっては、`php1<<`や`phpA<<`などのより具体的なマスクが必要になることがあります）。アップロードされた一時ファイルが見つかるまで、より具体的なマスクをブルートフォースできます。

## GNU/Linuxの悪用

ファイル名のランダムな値は、予測不可能でブルートフォースできない程度に十分です。詳細については、参考文献を参照してください。

## 参考文献

* [https://gynvael.coldwind.pl/?id=376](https://gynvael.coldwind.pl/?id=376)
* [https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf](https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**フォロー**するか、[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**を**。

- **ハッキングのトリックを共有するには、[hacktricksのリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudのリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
