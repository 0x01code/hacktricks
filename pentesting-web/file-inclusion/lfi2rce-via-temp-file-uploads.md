<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Experto en Equipos Rojos de AWS de HackTricks)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>



**Consulta todos los detalles de esta t칠cnica en [https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf](https://gynvael.coldwind.pl/download.php?f=PHP\_LFI\_rfc1867\_temporary\_files.pdf)**

## **Cargas de archivos PHP**

Cuando un motor de **PHP** recibe una **solicitud POST** que contiene archivos formateados seg칰n RFC 1867, genera archivos temporales para almacenar los datos cargados. Estos archivos son cruciales para el manejo de carga de archivos en scripts de PHP. La funci칩n `move_uploaded_file` debe usarse para trasladar estos archivos temporales a una ubicaci칩n deseada si se necesita almacenamiento persistente m치s all치 de la ejecuci칩n del script. Despu칠s de la ejecuci칩n, PHP elimina autom치ticamente cualquier archivo temporal restante.

{% hint style="info" %}
**Alerta de seguridad: Los atacantes, al conocer la ubicaci칩n de los archivos temporales, podr칤an explotar una vulnerabilidad de Inclusi칩n de Archivos Locales para ejecutar c칩digo accediendo al archivo durante la carga.**
{% endhint %}

El desaf칤o para el acceso no autorizado radica en predecir el nombre del archivo temporal, que est치 intencionalmente aleatorizado.

#### Explotaci칩n en Sistemas Windows

En Windows, PHP genera nombres de archivo temporales utilizando la funci칩n `GetTempFileName`, lo que resulta en un patr칩n como `<path>\<pre><uuuu>.TMP`. Es importante destacar que:

- La ruta predeterminada suele ser `C:\Windows\Temp`.
- El prefijo suele ser "php".
- El `<uuuu>` representa un valor hexadecimal 칰nico. Es crucial mencionar que, debido a la limitaci칩n de la funci칩n, solo se utilizan los 16 bits inferiores, lo que permite un m치ximo de 65,535 nombres 칰nicos con una ruta y prefijo constantes, lo que hace factible la fuerza bruta.

Adem치s, el proceso de explotaci칩n se simplifica en sistemas Windows. Una peculiaridad en la funci칩n `FindFirstFile` permite el uso de comodines en las rutas de Inclusi칩n de Archivos Locales (LFI). Esto permite crear una ruta de inclusi칩n como la siguiente para localizar el archivo temporal:
```
http://site/vuln.php?inc=c:\windows\temp\php<<
```
En ciertas situaciones, puede ser necesario un m치scara m치s espec칤fica (como `php1<<` o `phpA<<`). Se puede probar sistem치ticamente estas m치scaras para descubrir el archivo temporal subido.

#### Explotaci칩n en Sistemas GNU/Linux

Para sistemas GNU/Linux, la aleatoriedad en la nomenclatura de archivos temporales es s칩lida, lo que hace que los nombres no sean predecibles ni susceptibles a ataques de fuerza bruta. Se pueden encontrar m치s detalles en la documentaci칩n referenciada.
