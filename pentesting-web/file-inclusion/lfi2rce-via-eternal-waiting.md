# LFI2RCE √ºber ewiges Warten

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) **bei oder folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories senden.**

</details>

## Grundlegende Informationen

Standardm√§√üig generiert PHP beim Hochladen einer Datei (auch wenn es nicht erwartet wird) eine tempor√§re Datei in `/tmp` mit einem Namen wie **`php[a-zA-Z0-9]{6}`**, obwohl ich einige Docker-Images gesehen habe, bei denen die generierten Dateien keine Zahlen enthalten.

Bei einer lokalen Dateieinbindung erhalten Sie **RCE, wenn es Ihnen gelingt, diese hochgeladene Datei einzubinden**.

Beachten Sie, dass PHP standardm√§√üig nur das Hochladen von 20 Dateien in einer einzelnen Anfrage zul√§sst (festgelegt in `/etc/php/<version>/apache2/php.ini`):
```
; Maximum number of files that can be uploaded via a single request
max_file_uploads = 20
```
Auch die **Anzahl der potenziellen Dateinamen betr√§gt 62\*62\*62\*62\*62\*62 = 56800235584**.

### Andere Techniken

Andere Techniken basieren darauf, PHP-Protokolle anzugreifen (Sie werden nicht in der Lage sein, wenn Sie nur den letzten Teil des Pfads kontrollieren), den Pfad der Datei offenzulegen, erwartete Dateien zu missbrauchen oder **PHP dazu zu bringen, einen Segmentierungsfehler zu erleiden, sodass hochgeladene tempor√§re Dateien nicht gel√∂scht werden**.\
Diese Technik ist **sehr √§hnlich wie die letzte, aber ohne die Notwendigkeit, eine Zero-Day-Schwachstelle zu finden**.

### Ewige Warte-Technik

Bei dieser Technik **m√ºssen wir nur einen relativen Pfad kontrollieren**. Wenn es uns gelingt, Dateien hochzuladen und die **LFI niemals zu beenden**, haben wir "genug Zeit", um **hochgeladene Dateien per Brute-Force zu durchsuchen** und **eine beliebige hochgeladene Datei zu finden**.

**Vorteile dieser Technik**:

* Sie m√ºssen nur einen relativen Pfad innerhalb eines Includes kontrollieren.
* Es erfordert weder nginx noch einen unerwarteten Zugriff auf Logdateien.
* Es erfordert keinen Zero-Day, um einen Segmentierungsfehler zu verursachen.
* Es erfordert keine Offenlegung des Pfads.

Die **Hauptprobleme** dieser Technik sind:

* Es m√ºssen bestimmte Datei(en) vorhanden sein (es k√∂nnten mehrere sein).
* Die **wahnsinnig** hohe Anzahl potenzieller Dateinamen: **56800235584**.
* Wenn der Server **keine Zahlen verwendet**, betr√§gt die Gesamtzahl der potenziellen Dateinamen: **19770609664**.
* Standardm√§√üig k√∂nnen in einer **einzigen Anfrage nur 20 Dateien** hochgeladen werden.
* Die **maximale Anzahl paralleler Worker** des verwendeten Servers.
* Diese Begrenzung in Verbindung mit den vorherigen kann dazu f√ºhren, dass der Angriff zu lange dauert.
* **Timeout f√ºr eine PHP-Anfrage**. Idealerweise sollte dieser ewig sein oder den PHP-Prozess beenden, ohne die hochgeladenen tempor√§ren Dateien zu l√∂schen. Andernfalls wird dies auch zu einem Problem.

Wie k√∂nnen Sie also **ein PHP-Include niemals beenden**? Einfach indem Sie die Datei **`/sys/kernel/security/apparmor/revision`** einbinden (**leider nicht in Docker-Containern verf√ºgbar**).

Probieren Sie es einfach aus, indem Sie den folgenden Befehl aufrufen:
```bash
php -a # open php cli
include("/sys/kernel/security/apparmor/revision");
```
## Apache2

Standardm√§√üig unterst√ºtzt Apache **150 gleichzeitige Verbindungen**. Gem√§√ü [https://ubiq.co/tech-blog/increase-max-connections-apache/](https://ubiq.co/tech-blog/increase-max-connections-apache/) ist es m√∂glich, diese Zahl auf bis zu 8000 zu erh√∂hen. Befolgen Sie diese Anleitung, um PHP mit diesem Modul zu verwenden: [https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04](https://www.digitalocean.com/community/tutorials/how-to-configure-apache-http-with-mpm-event-and-php-fpm-on-ubuntu-18-04).

Standardm√§√üig (wie ich in meinen Tests festgestellt habe) kann ein **PHP-Prozess ewig dauern**.

Lassen Sie uns etwas Mathematik machen:

* Wir k√∂nnen **149 Verbindungen** verwenden, um **149 \* 20 = 2980 tempor√§re Dateien** mit unserer Webshell zu generieren.
* Verwenden Sie dann die **letzte Verbindung**, um potenzielle Dateien **brute-forcen**.
* Bei einer Geschwindigkeit von **10 Anfragen/s** ergeben sich folgende Zeiten:
* 56800235584 / 2980 / 10 / 3600 \~= **530 Stunden** (50% Wahrscheinlichkeit in 265 Stunden)
* (ohne Dezimalstellen) 19770609664 / 2980 / 10 / 3600 \~= 185 Stunden (50% Wahrscheinlichkeit in 93 Stunden)

{% hint style="warning" %}
Beachten Sie, dass wir in dem vorherigen Beispiel **andere Clients vollst√§ndig DoSen**!
{% endhint %}

Wenn der Apache-Server verbessert wird und wir **4000 Verbindungen** missbrauchen k√∂nnten (halb so viel wie die maximale Anzahl), k√∂nnten wir `3999*20 = 79980` **Dateien** erstellen und die **Zeit** w√ºrde auf etwa **19,7 Stunden** oder **6,9 Stunden** (10 Stunden, 3,5 Stunden 50% Wahrscheinlichkeit) reduziert werden.

## PHP-FPM

Wenn anstelle des regul√§ren PHP-Moduls f√ºr Apache zum Ausf√ºhren von PHP-Skripten die **Webseite PHP-FPM** verwendet wird (was die Effizienz der Webseite verbessert, daher ist es √ºblich, es zu finden), gibt es noch etwas anderes, das getan werden kann, um die Technik zu verbessern.

PHP-FPM erm√∂glicht die Konfiguration des Parameters **`request_terminate_timeout`** in **`/etc/php/<php-version>/fpm/pool.d/www.conf`**.\
Dieser Parameter gibt an, nach wie vielen Sekunden eine Anfrage an PHP beendet werden muss (standardm√§√üig unendlich, aber **30 Sekunden, wenn der Parameter auskommentiert ist**). Wenn eine Anfrage von PHP f√ºr die angegebene Anzahl von Sekunden verarbeitet wird, wird sie **abgebrochen**. Das bedeutet, dass, wenn die Anfrage tempor√§re Dateien hochgeladen hat und der **PHP-Verarbeitungsvorgang gestoppt wurde**, diese **Dateien nicht gel√∂scht werden**. Daher k√∂nnen Sie, wenn Sie eine Anfrage so lange dauern lassen k√∂nnen, Tausende von tempor√§ren Dateien generieren, die nicht gel√∂scht werden, was den Prozess des Auffindens beschleunigt und die Wahrscheinlichkeit eines DoS-Angriffs auf die Plattform verringert, indem alle Verbindungen verbraucht werden.

Um also einen DoS-Angriff zu vermeiden, nehmen wir an, dass ein Angreifer gleichzeitig nur **100 Verbindungen** verwendet und die maximale Verarbeitungszeit von PHP durch **PHP-FPM** (`request_terminate_timeout`**)** **30 Sekunden** betr√§gt. Daher kann die Anzahl der **tempor√§ren Dateien**, die pro Sekunde generiert werden k√∂nnen, wie folgt berechnet werden: `100*20/30 = 66,67`.

Dann w√ºrde ein Angreifer **150 Sekunden** ben√∂tigen, um **10000 Dateien** zu generieren (um **100000 Dateien** zu generieren, w√ºrde die Zeit **25 Minuten** betragen).

Der Angreifer k√∂nnte dann diese **100 Verbindungen** verwenden, um eine **brute-force Suche** durchzuf√ºhren. Bei einer Geschwindigkeit von 300 Anfragen/s ergibt sich die ben√∂tigte Zeit, um dies auszunutzen, wie folgt:

* 56800235584 / 10000 / 300 / 3600 \~= **5,25 Stunden** (50% Wahrscheinlichkeit in 2,63 Stunden)
* (mit 100000 Dateien) 56800235584 / 100000 / 300 / 3600 \~= **0,525 Stunden** (50% Wahrscheinlichkeit in 0,263 Stunden)

Ja, es ist m√∂glich, 100000 tempor√§re Dateien in einer EC2-Medium-Instanz zu generieren:

<figure><img src="../../.gitbook/assets/image (3) (1) (1) (3).png" alt=""><figcaption></figcaption></figure>

{% hint style="warning" %}
Beachten Sie, dass es ausreichen w√ºrde, die anf√§llige LFI-Seite einzuschlie√üen, um den Timeout auszul√∂sen, sodass sie in einer endlosen Include-Schleife landet.
{% endhint %}

## Nginx

Standardm√§√üig unterst√ºtzt Nginx **512 parallele Verbindungen** gleichzeitig (und diese Zahl kann verbessert werden).
