# Inyecciones de correo electr√≥nico

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** con las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres que tu **empresa sea anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inyectar en el correo electr√≥nico enviado

### Inyectar Cc y Bcc despu√©s del argumento del remitente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
El argumento ser√° inyectado.
```
From:sender@domain.com%0ATo:attacker@domain.com
```
El mensaje se enviar√° al destinatario original y a la cuenta del atacante.

### Inyectar el argumento Asunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
El asunto falso se agregar√° al asunto original y en algunos casos lo reemplazar√°. Depende del comportamiento del servicio de correo.

### Cambiar el cuerpo del mensaje

Inyecta un salto de l√≠nea de dos l√≠neas y luego escribe tu mensaje para cambiar el cuerpo del mensaje.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explotaci√≥n de la funci√≥n mail() de PHP

The `mail()` function in PHP is commonly used to send emails from a web application. However, if not properly secured, it can be vulnerable to email injection attacks. Email injection occurs when an attacker is able to manipulate the email headers and inject malicious content into the email.

La funci√≥n `mail()` en PHP se utiliza com√∫nmente para enviar correos electr√≥nicos desde una aplicaci√≥n web. Sin embargo, si no est√° correctamente asegurada, puede ser vulnerable a ataques de inyecci√≥n de correo electr√≥nico. La inyecci√≥n de correo electr√≥nico ocurre cuando un atacante puede manipular los encabezados del correo electr√≥nico e inyectar contenido malicioso en el correo electr√≥nico.

#### How email injection works

The email injection attack takes advantage of the fact that the `mail()` function allows the headers of the email to be specified as a string parameter. If the application does not properly validate and sanitize user input, an attacker can inject additional headers or modify existing ones.

El ataque de inyecci√≥n de correo electr√≥nico aprovecha el hecho de que la funci√≥n `mail()` permite especificar los encabezados del correo electr√≥nico como un par√°metro de cadena. Si la aplicaci√≥n no valida y desinfecta correctamente la entrada del usuario, un atacante puede inyectar encabezados adicionales o modificar los existentes.

For example, consider the following vulnerable code:

Por ejemplo, considera el siguiente c√≥digo vulnerable:

```php
$to = $_POST['email'];
$subject = "Welcome to our website!";
$message = "Thank you for signing up.";
$headers = "From: noreply@example.com";
mail($to, $subject, $message, $headers);
```

In this code, the value of the `email` parameter is directly used as the recipient of the email. An attacker can exploit this by injecting additional headers using a newline character (`\r\n`).

En este c√≥digo, el valor del par√°metro `email` se utiliza directamente como el destinatario del correo electr√≥nico. Un atacante puede explotar esto inyectando encabezados adicionales utilizando un car√°cter de nueva l√≠nea (`\r\n`).

```php
$email = "attacker@example.com\r\nBcc: victim@example.com";
$_POST['email'] = $email;
```

When the email is sent, it will contain an additional `Bcc` header, which will send a copy of the email to the attacker's email address without the recipient's knowledge.

Cuando se env√≠a el correo electr√≥nico, contendr√° un encabezado adicional `Bcc`, que enviar√° una copia del correo electr√≥nico a la direcci√≥n de correo electr√≥nico del atacante sin el conocimiento del destinatario.

#### Impact of email injection

Email injection can have various impacts depending on the attacker's intentions. Some possible consequences include:

La inyecci√≥n de correo electr√≥nico puede tener varios impactos dependiendo de las intenciones del atacante. Algunas posibles consecuencias incluyen:

- Spamming: The attacker can use the email injection to send spam emails to a large number of recipients, potentially causing reputational damage to the sender's domain.

- Spam: El atacante puede utilizar la inyecci√≥n de correo electr√≥nico para enviar correos electr√≥nicos no deseados a un gran n√∫mero de destinatarios, lo que podr√≠a causar da√±o a la reputaci√≥n del dominio del remitente.

- Phishing: By injecting malicious content into the email, the attacker can trick the recipient into revealing sensitive information or performing actions that compromise their security.

- Phishing: Al inyectar contenido malicioso en el correo electr√≥nico, el atacante puede enga√±ar al destinatario para que revele informaci√≥n confidencial o realice acciones que comprometan su seguridad.

- Email spoofing: The attacker can manipulate the email headers to make it appear as if the email is coming from a trusted source, leading the recipient to trust the content of the email.

- Suplantaci√≥n de correo electr√≥nico: El atacante puede manipular los encabezados del correo electr√≥nico para que parezca que el correo electr√≥nico proviene de una fuente confiable, lo que lleva al destinatario a confiar en el contenido del correo electr√≥nico.

#### Prevention and mitigation

To prevent email injection attacks, it is important to properly validate and sanitize user input before using it in the `mail()` function. Here are some best practices to follow:

Para prevenir ataques de inyecci√≥n de correo electr√≥nico, es importante validar y desinfectar correctamente la entrada del usuario antes de utilizarla en la funci√≥n `mail()`. Aqu√≠ hay algunas mejores pr√°cticas a seguir:

- Validate email addresses: Ensure that the input provided by the user is a valid email address. Use regular expressions or built-in PHP functions like `filter_var()` with the `FILTER_VALIDATE_EMAIL` flag.

- Validar direcciones de correo electr√≥nico: Aseg√∫rate de que la entrada proporcionada por el usuario sea una direcci√≥n de correo electr√≥nico v√°lida. Utiliza expresiones regulares o funciones incorporadas de PHP como `filter_var()` con la bandera `FILTER_VALIDATE_EMAIL`.

- Sanitize user input: Remove any newline characters (`\r\n`) or other special characters that could be used to inject additional headers.

- Desinfectar la entrada del usuario: Elimina cualquier car√°cter de nueva l√≠nea (`\r\n`) u otros caracteres especiales que podr√≠an utilizarse para inyectar encabezados adicionales.

- Use a secure email library: Consider using a secure email library that handles email sending and header manipulation securely. These libraries often have built-in protections against email injection attacks.

- Utilizar una biblioteca de correo electr√≥nico segura: Considera utilizar una biblioteca de correo electr√≥nico segura que maneje el env√≠o de correos electr√≥nicos y la manipulaci√≥n de encabezados de manera segura. Estas bibliotecas suelen tener protecciones incorporadas contra ataques de inyecci√≥n de correo electr√≥nico.

By following these practices, you can significantly reduce the risk of email injection attacks and ensure the integrity and security of your email communications.

Siguiendo estas pr√°cticas, puedes reducir significativamente el riesgo de ataques de inyecci√≥n de correo electr√≥nico y garantizar la integridad y seguridad de tus comunicaciones por correo electr√≥nico.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### El quinto par√°metro ($additional\_parameters)

Esta secci√≥n se basar√° en **c√≥mo abusar de este par√°metro suponiendo que un atacante lo controle**.

Este par√°metro se agregar√° a la l√≠nea de comandos que PHP utilizar√° para invocar el binario sendmail. Sin embargo, se sanitizar√° con la funci√≥n `escapeshellcmd($additional_parameters)`.

Un atacante puede **inyectar par√°metros adicionales para sendmail** en este caso.

#### Diferencias en la implementaci√≥n de /usr/sbin/sendmail

La interfaz de **sendmail** es **proporcionada por el software de correo electr√≥nico MTA** (Sendmail, Postfix, Exim, etc.) instalado en el sistema. Aunque la **funcionalidad b√°sica** (como los par√°metros -t -i -f) se mantiene **igual** por razones de compatibilidad, **otras funciones y par√°metros** var√≠an considerablemente seg√∫n el MTA instalado.

Aqu√≠ hay algunos ejemplos de diferentes p√°ginas de manual del comando/interface sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Dependiendo del **origen del binario sendmail**, se han descubierto diferentes opciones para abusar de ellos y **filtrar archivos o incluso ejecutar comandos arbitrarios**. Mira c√≥mo en [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Inyectar en el nombre del correo electr√≥nico

### Partes ignoradas de un correo electr√≥nico

Los s√≠mbolos: **+, -** y **{}** en raras ocasiones se pueden usar para etiquetar y ser ignorados por la mayor√≠a de los servidores de correo electr√≥nico

* Ejemplo: john.doe+intigriti@example.com ‚Üí john.doe@example.com

Los **comentarios entre par√©ntesis ()** al principio o al final tambi√©n se ignorar√°n

* Ejemplo: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de lista blanca

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Comillas

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IPs

Tambi√©n puedes usar IPs como nombres de dominio entre corchetes:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Otras vulnerabilidades

![](<../.gitbook/assets/image (296).png>)

## SSO de terceros

### XSS

Algunos servicios como **github** o **salesforce permiten** crear una **direcci√≥n de correo electr√≥nico con payloads XSS**. Si puedes **usar estos proveedores para iniciar sesi√≥n en otros servicios** y estos servicios **no sanitizan** correctamente el correo electr√≥nico, podr√≠as causar **XSS**.

### Toma de cuenta

Si un servicio de **SSO** te permite **crear una cuenta sin verificar la direcci√≥n de correo electr√≥nico proporcionada** (como **salesforce**) y luego puedes usar esa cuenta para **iniciar sesi√≥n en un servicio diferente** que **conf√≠a** en salesforce, podr√≠as acceder a cualquier cuenta.\
_Ten en cuenta que salesforce indica si el correo electr√≥nico proporcionado fue verificado o no, por lo que la aplicaci√≥n deber√≠a tener en cuenta esta informaci√≥n._

## Reply-To

Puedes enviar un correo electr√≥nico utilizando _**From: company.com**_\*\* \*\* y _**Replay-To: attacker.com**_ y si se env√≠a alguna **respuesta autom√°tica** debido a que el correo electr√≥nico se envi√≥ **desde** una **direcci√≥n interna**, el **atacante** podr√≠a **recibir** esa **respuesta**.

## Tasa de rebote duro

Algunas aplicaciones como AWS tienen una **Tasa de rebote duro** (en AWS es del 10%), que bloquea el servicio de correo electr√≥nico cada vez que est√° sobrecargado.

Un **rebote duro** es un **correo electr√≥nico** que no se pudo entregar por alguna raz√≥n permanente. Tal vez la **direcci√≥n de correo electr√≥nico** sea falsa, tal vez el dominio del **correo electr√≥nico** no sea un dominio real, o tal vez el servidor del destinatario del **correo electr√≥nico** no acepte **correos electr√≥nicos**, eso significa que de un total de 1000 correos electr√≥nicos, si 100 de ellos eran falsos o inv√°lidos y eso caus√≥ que todos rebotaran, **AWS SES** bloquear√° tu servicio.

Entonces, si puedes **enviar correos electr√≥nicos (quiz√°s invitaciones) desde la aplicaci√≥n web a cualquier direcci√≥n de correo electr√≥nico**, podr√≠as provocar este bloqueo enviando cientos de invitaciones a usuarios y dominios inexistentes: Denegaci√≥n de servicio del servicio de correo electr√≥nico.

## Referencias

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1).png" alt=""><figcaption></figcaption></figure>
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente, utilizando las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
