# Email Injections

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で最も**高度な**コミュニティツールによって**強化**された**ワークフロー**を簡単に構築し**自動化**します。\
今すぐアクセスしてください：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>**htARTE (HackTricks AWS Red Team Expert)**で**ゼロからヒーローまでのAWSハッキング**を学びましょう！</summary>

HackTricksをサポートする他の方法：

* **HackTricksで会社を宣伝**したい場合や**HackTricksをPDFでダウンロード**したい場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)で**フォロー**してください。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks)のgithubリポジトリにPRを提出して、**ハッキングトリックを共有**してください。

</details>

## 送信されたメールにインジェクト

### 送信者引数の後にCcとBccをインジェクト
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
### 引数のインジェクション

メッセージは受信者と受信者1のアカウントに送信されます。
```
From:sender@domain.com%0ATo:attacker@domain.com
```
### サブジェクト引数をインジェクトします
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
### メッセージ本文の変更

2行の改行を挿入し、その後にメッセージを書いて、メッセージ本文を変更します。
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() 関数の悪用
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### 第5パラメーター（$additional\_parameters）

このセクションは、**攻撃者がそれを制御すると仮定した場合に、このパラメーターを悪用する方法**に基づいています。

このパラメーターは、PHPがバイナリsendmailを呼び出すために使用するコマンドラインに追加されます。ただし、`escapeshellcmd($additional_parameters)`関数でサニタイズされます。

攻撃者は、この場合に**sendmailのための追加パラメーターを注入**することができます。

#### /usr/sbin/sendmailの実装の違い

**sendmail**インターフェースは、システムにインストールされているMTAメールソフトウェア（Sendmail、Postfix、Eximなど）によって提供されます。**基本機能**（-t -i -fパラメータなど）は互換性のために**同じ**ですが、**その他の機能やパラメーター**はインストールされているMTAによって大きく異なります。

以下は、sendmailコマンド/インターフェースの異なるマニュアルの例です：

- Sendmail MTA: [http://www.sendmail.org/\~ca/email/man/sendmail.html](http://www.sendmail.org/\~ca/email/man/sendmail.html)
- Postfix MTA: [http://www.postfix.org/mailq.1.html](http://www.postfix.org/mailq.1.html)
- Exim MTA: [https://linux.die.net/man/8/eximReferences](https://linux.die.net/man/8/eximReferences)

**sendmailの起源**によって、それらを悪用して**ファイルを漏洩させたり、任意のコマンドを実行したり**するための異なるオプションが発見されています。詳細は[こちら](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)を参照してください。

## メール名に注入

### メールの無視される部分

記号：**+、-**、および**{}**は、稀な場合にタグ付けや無視されるために多くのメールサーバーによって使用されることがあります。

- 例：john.doe+intigriti@example.com → john.doe@example.com

**かっこ内のコメント()**は、先頭または末尾にある場合も無視されます。

- 例：john.doe(intigriti)@example.com → john.doe@example.com

### ホワイトリストのバイパス

<figure><img src="../.gitbook/assets/image (4) (6).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### 引用符

<figure><img src="../.gitbook/assets/image (6) (4).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPアドレス

角かっこ内にドメイン名としてIPアドレスを使用することもできます：

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### その他の脆弱性

![https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](<../.gitbook/assets/image (296).png>)

## サードパーティSSO

### XSS

**github**や**salesforce**などの一部のサービスでは、**XSSペイロードの含まれたメールアドレスを作成**することができます。このプロバイダーを使用して他のサービスにログインし、このサービスがメールを**適切にサニタイズ**していない場合、**XSS**を引き起こす可能性があります。

### アカウント乗っ取り

**salesforce**のような**SSOサービス**が、与えられたメールアドレスを確認せずにアカウントを作成することを許可し、その後そのアカウントを使用して**salesforceを信頼する別のサービスにログイン**できる場合、任意のアカウントにアクセスできます。\
（salesforceは与えられたメールが確認されたかどうかを示しますが、アプリケーションはこの情報を考慮すべきです。）

## Reply-To

**From: company.com**と**Replay-To: attacker.com**を使用してメールを送信し、メールが**内部アドレスから送信**されたために**自動応答**が送信される場合、**攻撃者**はその**応答**を**受信**できるかもしれません。

## ハードバウンス率

AWSなどの一部のサービスでは、通常10%に設定された**ハードバウンス率**として知られる閾値を実装しています。これは、特にメール配信サービスにとって重要なメトリックです。この率を超えると、AWSのメールサービスなどが一時停止またはブロックされる可能性があります。

**ハードバウンス**とは、受信者のアドレスが無効または存在しないために送信者に返送された**メール**を指します。これは、メールが存在しないアドレスに送信されたり、実在しないドメインに送信されたり、受信サーバーが**メール**を受け入れないことによって発生する可能性があります。

AWSの場合、1000通のメールを送信し、そのうち100通がハードバウンス（無効なアドレスやドメインなどの理由で）になった場合、これは10%のハードバウンス率を意味します。この率に達すると、AWS SES（Simple Email Service）がメール送信機能をブロックまたは一時停止する可能性があります。

中断されないメールサービスを確保し、送信者の評判を維持するためには、低いハードバウンス率を維持することが重要です。メーリングリスト内のメールアドレスの品質を監視および管理することは、これを達成するのに大きく役立ちます。

詳細な情報については、AWSの公式ドキュメントである[**AWS SES Bounce Handling**](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types)を参照してください。

## 参考文献

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

- If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
- Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
- Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** us on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
- **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks) and [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で最も高度なコミュニティツールによって強化された**ワークフローを簡単に構築**および**自動化**できます。\
今すぐアクセスしてください：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
