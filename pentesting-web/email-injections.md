# メールインジェクション

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で最も高度なコミュニティツールによって強化された**ワークフローを簡単に構築**および**自動化**します。\
今すぐアクセスを取得：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **および** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## 送信済みメールにインジェクト

### 送信者引数の後にCcとBccをインジェクトする
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
### 引数の注入

The message will be sent to the recipient and recipient1 accounts.

メッセージは、受信者と受信者1のアカウントに送信されます。
```
From:sender@domain.com%0ATo:attacker@domain.com
```
メッセージは元の受信者と攻撃者のアカウントに送信されます。

### Subject引数を注入する
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
偽の件名は元の件名に追加され、場合によっては置き換えられます。これはメールサービスの動作に依存します。

### メッセージの本文を変更する

2行の改行を挿入し、メッセージの本文を変更するためにメッセージを書き込んでください。
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### PHP mail() 関数の悪用

The `mail()` function in PHP is commonly used to send emails from a web application. However, if not properly secured, it can be vulnerable to email injection attacks. Email injection occurs when an attacker is able to manipulate the email headers and inject malicious content into the email.

PHP mail() 関数は、ウェブアプリケーションから電子メールを送信するために一般的に使用されます。しかし、適切に保護されていない場合、メールインジェクション攻撃の脆弱性にさらされる可能性があります。メールインジェクションは、攻撃者が電子メールのヘッダーを操作し、悪意のあるコンテンツを電子メールに注入することができる場合に発生します。

#### Exploiting Email Injection

To exploit email injection, an attacker can manipulate the email headers by injecting special characters such as newline characters (\n) or carriage return characters (\r). This allows the attacker to add additional headers or modify existing ones.

メールインジェクションを悪用するために、攻撃者は改行文字（\n）や復帰文字（\r）などの特殊文字を注入することで、電子メールのヘッダーを操作することができます。これにより、攻撃者は追加のヘッダーを追加したり、既存のヘッダーを変更したりすることができます。

For example, consider the following vulnerable code:

例えば、以下の脆弱なコードを考えてみましょう：

```php
<?php
$to = $_POST['to'];
$subject = $_POST['subject'];
$message = $_POST['message'];
$headers = "From: " . $_POST['from'] . "\r\n";
mail($to, $subject, $message, $headers);
?>
```

In this code, the values for the `to`, `subject`, `message`, and `from` parameters are taken from user input without proper validation or sanitization. This allows an attacker to inject additional headers by manipulating the `from` parameter.

このコードでは、`to`、`subject`、`message`、`from` パラメータの値が適切な検証やサニタイズなしにユーザーの入力から取得されます。これにより、攻撃者は `from` パラメータを操作して追加のヘッダーを注入することができます。

To exploit this vulnerability, an attacker can craft a malicious `from` parameter value that includes additional headers:

この脆弱性を悪用するために、攻撃者は追加のヘッダーを含む悪意のある `from` パラメータの値を作成することができます：

```
from: attacker@example.com\r\nBcc: victim@example.com
```

When the vulnerable code is executed, the email will be sent with the injected headers. This can lead to various attacks, such as email spoofing, information disclosure, or even remote code execution.

脆弱なコードが実行されると、注入されたヘッダーを含む電子メールが送信されます。これにより、電子メールのスプーフィング、情報の漏洩、さらにはリモートコードの実行など、さまざまな攻撃が発生する可能性があります。

#### Prevention

To prevent email injection attacks, it is important to properly validate and sanitize user input before using it in email headers. Here are some best practices to follow:

メールインジェクション攻撃を防ぐためには、電子メールのヘッダーで使用する前に、ユーザーの入力を適切に検証およびサニタイズすることが重要です。以下は、従うべきベストプラクティスのいくつかです：

- Validate and sanitize user input: Ensure that user input is properly validated and sanitized to prevent the injection of special characters.

- ユーザーの入力を検証およびサニタイズする：特殊文字の注入を防ぐために、ユーザーの入力が適切に検証およびサニタイズされていることを確認します。

- Use a secure email library: Instead of using the `mail()` function, consider using a secure email library that handles email headers properly and provides protection against email injection attacks.

- 安全な電子メールライブラリを使用する：`mail()` 関数の代わりに、電子メールのヘッダーを適切に処理し、電子メールインジェクション攻撃に対する保護を提供する安全な電子メールライブラリを使用することを検討してください。

- Implement input validation and filtering: Implement input validation and filtering mechanisms to ensure that user input adheres to expected formats and does not contain any malicious content.

- 入力の検証とフィルタリングの実装：入力の検証とフィルタリングメカニズムを実装して、ユーザーの入力が予想される形式に従っており、悪意のあるコンテンツを含んでいないことを確認します。

By following these practices, you can mitigate the risk of email injection attacks and ensure the security of your web application.

これらのプラクティスに従うことで、電子メールインジェクション攻撃のリスクを軽減し、ウェブアプリケーションのセキュリティを確保することができます。
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### 第5パラメーター（$additional\_parameters）

このセクションでは、**攻撃者がこのパラメーターを制御していると仮定して、どのように悪用できるか**について説明します。

このパラメーターは、PHPがバイナリsendmailを呼び出すために使用するコマンドラインに追加されます。ただし、関数`escapeshellcmd($additional_parameters)`でサニタイズされます。

攻撃者は、この場合に**sendmailのための抽出パラメーターをインジェクト**することができます。

#### /usr/sbin/sendmailの実装の違い

**sendmail**インターフェースは、システムにインストールされているMTAメールソフトウェア（Sendmail、Postfix、Eximなど）によって提供されます。基本的な機能（-t -i -fパラメーターなど）は、互換性のために**同じ**ですが、**他の機能やパラメーター**は、インストールされているMTAによって大きく異なります。

以下は、sendmailコマンド/インターフェースの異なるマニュアルのいくつかの例です：

- Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
- Postfix MTA: http://www.postfix.org/mailq.1.html
- Exim MTA: https://linux.die.net/man/8/eximReferences

**sendmailの起源によって**、それらを悪用して**ファイルを漏洩させたり、任意のコマンドを実行したりする**ためのさまざまなオプションが発見されています。[**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)で詳細を確認してください。

## メール名へのインジェクション

### メールの無視される部分

記号：**+、-**、**{}**は、稀な場合にタグ付けや無視されることがあります。

- 例：john.doe+intigriti@example.com → john.doe@example.com

**丸括弧（）で囲まれたコメント**は、先頭または末尾にある場合も無視されます。

- 例：john.doe(intigriti)@example.com → john.doe@example.com

### ホワイトリストの回避

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### 引用符

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IPアドレス

IPアドレスもドメイン名として角括弧で囲んで使用することができます：

- john.doe@\[127.0.0.1]
- john.doe@\[IPv6:2001:db8::1]

### その他の脆弱性

![](<../.gitbook/assets/image (296).png>)

## サードパーティのSSO

### XSS

**github**や**salesforce**などの一部のサービスでは、**XSSペイロードを含むメールアドレスを作成**することができます。このプロバイダーを使用して他のサービスにログインできる場合、このサービスがメールを正しくサニタイズしていない場合、**XSS**を引き起こすことができます。

### アカウント乗っ取り

**salesforce**のような**SSOサービス**が、与えられたメールアドレスを確認せずにアカウントを作成することを許可してくれる場合、そのアカウントを**salesforceを信頼している別のサービス**に使用することができます。これにより、任意のアカウントにアクセスできます。\
なお、salesforceは与えられたメールが確認されたかどうかを示していますが、アプリケーションはこの情報を考慮する必要があります。

## Reply-To

_**From: company.com**_と_**Replay-To: attacker.com**_を使用してメールを送信し、メールが**内部アドレス**から送信されたために**自動返信**が送信される場合、**攻撃者**はその**応答**を**受け取る**ことができるかもしれません。

## ハードバウンス率

AWSなどの一部のアプリケーションには、**ハードバウンス率**（AWSでは10%）があり、メールサービスが過負荷になるとブロックされます。

**ハードバウンス**とは、永久的な理由で配信できなかった**メール**のことです。メールアドレスが偽のアドレスであるか、メールドメインが実在しないドメインであるか、またはメール受信者のサーバーが**メールを受け入れない**場合などが考えられます。つまり、1000通のメールのうち100通が偽であるか無効であり、それによってすべてのメールがバウンスした場合、**AWS SES**はサービスをブロックします。

したがって、Webアプリケーションから任意のメールアドレスにメール（おそらく招待状）を送信できる場合、存在しないユーザーやドメインに何百もの招待状を送信することで、このブロックを引き起こすことができます：メールサービスのDoS攻撃。

## 参考文献

- [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
- [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
- [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
- [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロードしたりしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！**
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグ
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)を使用して、世界で最も高度なコミュニティツールによって強化された**ワークフローを簡単に構築**し、自動化することができます。
今すぐアクセスを取得してください：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
