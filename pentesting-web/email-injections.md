# Inyecciones de correo electr√≥nico

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Utilice [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y automatizar f√°cilmente flujos de trabajo con las herramientas comunitarias m√°s avanzadas del mundo.\
Obtenga acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inyectar en correo electr√≥nico enviado

### Inyectar Cc y Bcc despu√©s del argumento del remitente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
El argumento ser√° inyectado.
```
From:sender@domain.com%0ATo:attacker@domain.com
```
El mensaje se enviar√° al destinatario original y a la cuenta del atacante.

### Inyectar el argumento Asunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
El asunto falso se agregar√° al asunto original y en algunos casos lo reemplazar√°. Depende del comportamiento del servicio de correo.

### Cambiar el cuerpo del mensaje

Inyecta un salto de l√≠nea de dos l√≠neas y luego escribe tu mensaje para cambiar el cuerpo del mensaje.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explotaci√≥n de la funci√≥n mail() de PHP

The `mail()` function in PHP is commonly used to send emails from a web application. However, if not properly secured, it can be vulnerable to email injection attacks. Email injection occurs when an attacker is able to inject malicious content into the email headers, allowing them to manipulate the email's behavior.

La funci√≥n `mail()` en PHP se utiliza com√∫nmente para enviar correos electr√≥nicos desde una aplicaci√≥n web. Sin embargo, si no est√° debidamente asegurada, puede ser vulnerable a ataques de inyecci√≥n de correo electr√≥nico. La inyecci√≥n de correo electr√≥nico ocurre cuando un atacante puede inyectar contenido malicioso en los encabezados del correo electr√≥nico, lo que les permite manipular el comportamiento del correo electr√≥nico.

#### How email injection works

C√≥mo funciona la inyecci√≥n de correo electr√≥nico

Email injection attacks typically occur when user-supplied data is not properly validated or sanitized before being used in the `mail()` function. Attackers can exploit this vulnerability by injecting special characters into the email headers, such as newline characters (\n) or carriage return characters (\r).

Los ataques de inyecci√≥n de correo electr√≥nico generalmente ocurren cuando los datos proporcionados por el usuario no se validan o se desinfectan correctamente antes de ser utilizados en la funci√≥n `mail()`. Los atacantes pueden explotar esta vulnerabilidad inyectando caracteres especiales en los encabezados del correo electr√≥nico, como caracteres de nueva l√≠nea (\n) o caracteres de retorno de carro (\r).

#### Impact of email injection

Impacto de la inyecci√≥n de correo electr√≥nico

Email injection can have various consequences, including:

La inyecci√≥n de correo electr√≥nico puede tener diversas consecuencias, incluyendo:

- **Spamming**: Attackers can use email injection to send spam emails from the compromised application, potentially damaging the reputation of the sender's domain.

- **Spamming**: Los atacantes pueden utilizar la inyecci√≥n de correo electr√≥nico para enviar correos electr√≥nicos no deseados desde la aplicaci√≥n comprometida, lo que podr√≠a da√±ar la reputaci√≥n del dominio del remitente.

- **Phishing**: By injecting malicious content into the email headers, attackers can trick recipients into revealing sensitive information or performing actions that they shouldn't.

- **Phishing**: Al inyectar contenido malicioso en los encabezados del correo electr√≥nico, los atacantes pueden enga√±ar a los destinatarios para que revelen informaci√≥n confidencial o realicen acciones que no deber√≠an realizar.

- **Email spoofing**: Email injection can be used to spoof the sender's email address, making it appear as if the email was sent from a different source. This can be used for impersonation or to deceive recipients.

- **Suplantaci√≥n de identidad en el correo electr√≥nico**: La inyecci√≥n de correo electr√≥nico se puede utilizar para falsificar la direcci√≥n de correo electr√≥nico del remitente, haciendo que parezca que el correo electr√≥nico se envi√≥ desde una fuente diferente. Esto se puede utilizar para suplantaci√≥n de identidad o para enga√±ar a los destinatarios.

#### Prevention techniques

T√©cnicas de prevenci√≥n

To prevent email injection attacks, it is important to properly validate and sanitize user-supplied data before using it in the `mail()` function. Here are some techniques to prevent email injection:

Para prevenir ataques de inyecci√≥n de correo electr√≥nico, es importante validar y desinfectar correctamente los datos proporcionados por el usuario antes de utilizarlos en la funci√≥n `mail()`. Aqu√≠ hay algunas t√©cnicas para prevenir la inyecci√≥n de correo electr√≥nico:

- **Input validation**: Implement strict input validation to ensure that user-supplied data does not contain any special characters that could be used for email injection.

- **Validaci√≥n de entrada**: Implemente una validaci√≥n estricta de entrada para asegurarse de que los datos proporcionados por el usuario no contengan caracteres especiales que puedan ser utilizados para la inyecci√≥n de correo electr√≥nico.

- **Input sanitization**: Sanitize user-supplied data by removing or encoding any special characters that could be used for email injection.

- **Desinfecci√≥n de entrada**: Desinfecte los datos proporcionados por el usuario eliminando o codificando cualquier car√°cter especial que pueda ser utilizado para la inyecci√≥n de correo electr√≥nico.

- **Use email libraries**: Instead of using the `mail()` function directly, consider using email libraries or frameworks that provide built-in protection against email injection attacks.

- **Utilice bibliotecas de correo electr√≥nico**: En lugar de utilizar la funci√≥n `mail()` directamente, considere utilizar bibliotecas o frameworks de correo electr√≥nico que proporcionen protecci√≥n incorporada contra ataques de inyecci√≥n de correo electr√≥nico.

By implementing these prevention techniques, you can significantly reduce the risk of email injection attacks and ensure the security of your web application.

Al implementar estas t√©cnicas de prevenci√≥n, puede reducir significativamente el riesgo de ataques de inyecci√≥n de correo electr√≥nico y garantizar la seguridad de su aplicaci√≥n web.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### El quinto par√°metro ($additional\_parameters)

Esta secci√≥n se basar√° en **c√≥mo abusar de este par√°metro suponiendo que un atacante lo controle**.

Este par√°metro se agregar√° a la l√≠nea de comandos que PHP utilizar√° para invocar el binario sendmail. Sin embargo, se sanitizar√° con la funci√≥n `escapeshellcmd($additional_parameters)`.

Un atacante puede **inyectar par√°metros adicionales para sendmail** en este caso.

#### Diferencias en la implementaci√≥n de /usr/sbin/sendmail

La interfaz de **sendmail** es **proporcionada por el software de correo electr√≥nico MTA** (Sendmail, Postfix, Exim, etc.) instalado en el sistema. Aunque la **funcionalidad b√°sica** (como los par√°metros -t -i -f) se mantiene **igual** por razones de compatibilidad, **otras funciones y par√°metros** var√≠an considerablemente seg√∫n el MTA instalado.

Aqu√≠ hay algunos ejemplos de diferentes p√°ginas de manual del comando/interface sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Dependiendo del **origen del binario sendmail**, se han descubierto diferentes opciones para abusar de ellos y **filtrar archivos o incluso ejecutar comandos arbitrarios**. Mira c√≥mo en [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Inyectar en el nombre del correo electr√≥nico

### Partes ignoradas de un correo electr√≥nico

Los s√≠mbolos: **+, -** y **{}** en raras ocasiones se pueden usar para etiquetar y ser ignorados por la mayor√≠a de los servidores de correo electr√≥nico

* Ejemplo: john.doe+intigriti@example.com ‚Üí john.doe@example.com

Los **comentarios entre par√©ntesis ()** al principio o al final tambi√©n se ignorar√°n

* Ejemplo: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de lista blanca

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Comillas

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IPs

Tambi√©n puedes usar IPs como nombres de dominio entre corchetes:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Otras vulnerabilidades

![](<../.gitbook/assets/image (296).png>)

## SSO de terceros

### XSS

Algunos servicios como **github** o **salesforce permiten** crear una **direcci√≥n de correo electr√≥nico con payloads XSS**. Si puedes **usar estos proveedores para iniciar sesi√≥n en otros servicios** y estos servicios **no sanitizan** correctamente el correo electr√≥nico, podr√≠as causar **XSS**.

### Toma de cuenta

Si un servicio de **SSO** te permite **crear una cuenta sin verificar la direcci√≥n de correo electr√≥nico proporcionada** (como **salesforce**) y luego puedes usar esa cuenta para **iniciar sesi√≥n en un servicio diferente** que **conf√≠a** en salesforce, podr√≠as acceder a cualquier cuenta.\
Ten en cuenta que salesforce indica si el correo electr√≥nico proporcionado fue verificado o no, pero la aplicaci√≥n debe tener en cuenta esta informaci√≥n.

## Reply-To

Puedes enviar un correo electr√≥nico utilizando _**From: company.com**_\*\* \*\* y _**Replay-To: attacker.com**_ y si se env√≠a alguna **respuesta autom√°tica** debido a que el correo electr√≥nico se envi√≥ **desde** una **direcci√≥n interna**, el **atacante** podr√≠a **recibir** esa **respuesta**.

## Tasa de rebote duro

Algunas aplicaciones como AWS tienen una **Tasa de rebote duro** (en AWS es del 10%), que bloquea el servicio de correo electr√≥nico cada vez que est√° sobrecargado.

Un **rebote duro** es un **correo electr√≥nico** que no se pudo entregar por alguna raz√≥n permanente. Tal vez la direcci√≥n de correo electr√≥nico sea falsa, tal vez el dominio del correo electr√≥nico no sea un dominio real, o tal vez el servidor del destinatario del correo electr√≥nico no acepte **correos electr√≥nicos**, eso significa que de un total de 1000 correos electr√≥nicos, si 100 de ellos son falsos o inv√°lidos y causan que todos reboten, **AWS SES** bloquear√° tu servicio.

Entonces, si puedes **enviar correos electr√≥nicos (quiz√°s invitaciones) desde la aplicaci√≥n web a cualquier direcci√≥n de correo electr√≥nico**, podr√≠as provocar este bloqueo enviando cientos de invitaciones a usuarios y dominios inexistentes: Denegaci√≥n de servicio del servicio de correo electr√≥nico.

## Referencias

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1).png" alt=""><figcaption></figcaption></figure>
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente, utilizando las herramientas comunitarias m√°s avanzadas del mundo.\
Obt√©n acceso hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
