# Inje√ß√µes de Email

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir e **automatizar fluxos de trabalho** com as ferramentas da comunidade mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injetar em e-mails enviados

### Injetar Cc e Bcc ap√≥s o argumento do remetente
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
A mensagem ser√° enviada para as contas do destinat√°rio e destinat√°rio1.

### Injetar argumento
```
From:sender@domain.com%0ATo:attacker@domain.com
```
A mensagem ser√° enviada para o destinat√°rio original e para a conta do atacante.

### Injetar argumento de assunto
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
O assunto falso ser√° adicionado ao assunto original e, em alguns casos, o substituir√°. Isso depende do comportamento do servi√ßo de e-mail.

### Alterar o corpo da mensagem

Injete duas quebras de linha e, em seguida, escreva sua mensagem para alterar o corpo da mensagem.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explora√ß√£o da fun√ß√£o mail() do PHP

#### Descri√ß√£o

A fun√ß√£o `mail()` do PHP √© usada para enviar e-mails a partir de um servidor web. No entanto, se n√£o for usada corretamente, pode ser explorada para enviar e-mails maliciosos ou executar comandos no servidor.

#### Explora√ß√£o

A explora√ß√£o da fun√ß√£o `mail()` geralmente envolve a inje√ß√£o de c√≥digo malicioso no cabe√ßalho do e-mail. Isso pode ser feito atrav√©s da manipula√ß√£o de entradas de formul√°rio que s√£o usadas para construir o cabe√ßalho do e-mail.

Por exemplo, se um formul√°rio permitir que um usu√°rio insira um endere√ßo de e-mail, o atacante pode inserir um cabe√ßalho adicional contendo c√≥digo malicioso. Quando o servidor web processa o formul√°rio e usa a entrada do usu√°rio para construir o cabe√ßalho do e-mail, o c√≥digo malicioso √© executado.

#### Preven√ß√£o

Para prevenir a explora√ß√£o da fun√ß√£o `mail()`, √© importante validar todas as entradas de formul√°rio que s√£o usadas para construir o cabe√ßalho do e-mail. Isso pode ser feito atrav√©s da filtragem de caracteres especiais e da valida√ß√£o do formato do endere√ßo de e-mail.

Al√©m disso, √© importante limitar o acesso √† fun√ß√£o `mail()` para usu√°rios autenticados e autorizados apenas. Isso pode ser feito atrav√©s da implementa√ß√£o de autentica√ß√£o e autoriza√ß√£o adequadas no servidor web.
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
  - Parameters [5] {
    Parameter #0 [ <required> $to ]
    Parameter #1 [ <required> $subject ]
    Parameter #2 [ <required> $message ]
    Parameter #3 [ <optional> $additional_headers ]
    Parameter #4 [ <optional> $additional_parameters ]
  }
}
```
#### O 5¬∫ par√¢metro ($additional\_parameters)

Esta se√ß√£o √© baseada em **como abusar desse par√¢metro supondo que um atacante o controle**.

Este par√¢metro ser√° adicionado √† linha de comando que o PHP usar√° para invocar o bin√°rio sendmail. No entanto, ele ser√° sanitizado com a fun√ß√£o `escapeshellcmd($additional_parameters)`.

Um atacante pode **injetar par√¢metros extras para o sendmail** neste caso.

#### Diferen√ßas na implementa√ß√£o de /usr/sbin/sendmail

A interface **sendmail** √© **fornecida pelo software de e-mail MTA** (Sendmail, Postfix, Exim etc.) instalado no sistema. Embora a **funcionalidade b√°sica** (como os par√¢metros -t -i -f) permane√ßa **a mesma** por raz√µes de compatibilidade, **outras fun√ß√µes e par√¢metros** variam muito dependendo do MTA instalado.

Aqui est√£o alguns exemplos de diferentes p√°ginas de manual do comando/interface sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Dependendo da **origem do bin√°rio sendmail**, diferentes op√ß√µes foram descobertas para abus√°-las e **vazar arquivos ou at√© mesmo executar comandos arbitr√°rios**. Veja como em [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injetar no nome do e-mail

### Partes ignoradas de um e-mail

Os s√≠mbolos: **+, -** e **{}** em raras ocasi√µes podem ser usados para marca√ß√£o e ignorados pela maioria dos servidores de e-mail

* Exemplo: john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Coment√°rios entre par√™nteses ()** no in√≠cio ou no final tamb√©m ser√£o ignorados

* Exemplo: john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de lista branca

<figure><img src="../.gitbook/assets/image (4) (6).png" alt=""><figcaption></figcaption></figure>

### Aspas

<figure><img src="../.gitbook/assets/image (6) (4).png" alt=""><figcaption></figcaption></figure>

### IPs

Voc√™ tamb√©m pode usar IPs como nome de dom√≠nio entre colchetes:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Outras vulnerabilidades

![](<../.gitbook/assets/image (296).png>)

## SSO de terceiros

### XSS

Alguns servi√ßos como **github** ou **salesforce permitem** que voc√™ crie um **endere√ßo de e-mail com payloads XSS** nele. Se voc√™ pode **usar esses provedores para fazer login em outros servi√ßos** e esses servi√ßos **n√£o sanitizam** corretamente o e-mail, voc√™ pode causar **XSS**.

### Account-Takeover

Se um **servi√ßo SSO** permite que voc√™ **crie uma conta sem verificar o endere√ßo de e-mail fornecido** (como **salesforce**) e depois voc√™ pode usar essa conta para **fazer login em um servi√ßo diferente** que **confia** no salesforce, voc√™ pode acessar qualquer conta.\
Observe que o salesforce indica se o e-mail fornecido foi ou n√£o verificado, mas a aplica√ß√£o tamb√©m deve levar em conta essa informa√ß√£o.

## Reply-To

Voc√™ pode enviar um e-mail usando _**From: company.com**_\*\* \*\* e _**Replay-To: attacker.com**_ e se alguma **resposta autom√°tica** for enviada devido ao e-mail ter sido enviado **de** um **endere√ßo interno**, o **atacante** pode ser capaz de **receber** essa **resposta**.

## Taxa de rejei√ß√£o dif√≠cil

Algumas aplica√ß√µes como a AWS t√™m uma **Taxa de rejei√ß√£o dif√≠cil** (na AWS √© de 10%), que sempre que estiver sobrecarregado o servi√ßo de e-mail √© bloqueado.

Um **rejei√ß√£o dif√≠cil** √© um **e-mail** que n√£o p√¥de ser entregue por algumas raz√µes permanentes. Talvez o **endere√ßo de e-mail** seja falso, talvez o dom√≠nio do **e-mail** n√£o seja um dom√≠nio real, ou talvez o servidor do destinat√°rio do **e-mail** n√£o aceite **e-mails**), isso significa que de um total de 1000 e-mails, se 100 deles fossem falsos ou inv√°lidos, isso causaria o bloqueio de todos eles, o **AWS SES** bloquear√° seu servi√ßo.

Portanto, se voc√™ puder **enviar e-mails (talvez convites) do aplicativo da web para qualquer endere√ßo de e-mail, poder√° provocar esse bloqueio enviando centenas de convites para usu√°rios e dom√≠nios inexistentes: DoS do servi√ßo de e-mail.**

## Refer√™ncias

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Use [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para criar e **automatizar fluxos de trabalho** com as ferramentas da comunidade mais avan√ßadas do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
