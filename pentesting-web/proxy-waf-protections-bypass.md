# Contournement des protections Proxy / WAF

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? Ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Contournement des r√®gles ACL Nginx <a href="#heading-bypassing-nginx-acl-rules-with-nodejs" id="heading-bypassing-nginx-acl-rules-with-nodejs"></a>

Exemple de restriction Nginx :
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
### NodeJS

<figure><img src="../.gitbook/assets/image (713).png" alt=""><figcaption></figcaption></figure>

* Comme Nginx inclut le caract√®re `\xa0` dans le chemin d'acc√®s, la r√®gle ACL pour l'URI `/admin` ne sera pas d√©clench√©e. Par cons√©quent, Nginx transmettra le message HTTP √† l'arri√®re-plan ;
* Lorsque le serveur Node.js re√ßoit l'URI `/admin\x0a`, le caract√®re `\xa0` sera supprim√©, permettant ainsi la r√©cup√©ration r√©ussie de l'endpoint `/admin`.

| Version Nginx | **Caract√®res de contournement Node.js** |
| ------------- | -------------------------------------- |
| 1.22.0        | `\xA0`                                 |
| 1.21.6        | `\xA0`                                 |
| 1.20.2        | `\xA0`, `\x09`, `\x0C`                 |
| 1.18.0        | `\xA0`, `\x09`, `\x0C`                 |
| 1.16.1        | `\xA0`, `\x09`, `\x0C`                 |

### Flask

Flask supprime les caract√®res `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` et `\x09` du chemin d'acc√®s de l'URL, mais NGINX ne le fait pas.

<figure><img src="../.gitbook/assets/image (714).png" alt=""><figcaption></figcaption></figure>

| Version Nginx | **Caract√®res de contournement Flask**                                    |
| ------------- | ------------------------------------------------------------------------ |
| 1.22.0        | `\x85`, `\xA0`                                                          |
| 1.21.6        | `\x85`, `\xA0`                                                          |
| 1.20.2        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`            |
| 1.18.0        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`            |
| 1.16.1        | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`            |

### Spring Boot <a href="#heading-bypassing-nginx-acl-rules-with-spring-boot" id="heading-bypassing-nginx-acl-rules-with-spring-boot"></a>

Ci-dessous, vous trouverez une d√©monstration de la fa√ßon dont la protection ACL peut √™tre contourn√©e en ajoutant le caract√®re `\x09` ou √† la fin du chemin d'acc√®s :

<figure><img src="../.gitbook/assets/image (715).png" alt=""><figcaption></figcaption></figure>

| Version Nginx | **Caract√®res de contournement Spring Boot** |
| ------------- | ------------------------------------------- |
| 1.22.0        | `;`                                         |
| 1.21.6        | `;`                                         |
| 1.20.2        | `\x09`, `;`                                 |
| 1.18.0        | `\x09`, `;`                                 |
| 1.16.1        | `\x09`, `;`                                 |

### PHP-FPM <a href="#heading-bypassing-nginx-acl-rules-with-php-fpm-integration" id="heading-bypassing-nginx-acl-rules-with-php-fpm-integration"></a>

Consid√©rons la configuration Nginx FPM suivante :
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Il est possible de contourner cela en acc√©dant √† `/admin.php/index.php` :

<figure><img src="../.gitbook/assets/image (716).png" alt=""><figcaption></figcaption></figure>

### Comment pr√©venir <a href="#heading-how-to-prevent" id="heading-how-to-prevent"></a>

Pour pr√©venir ces probl√®mes, vous devez utiliser l'expression `~` au lieu de l'expression `=` dans les r√®gles ACL de Nginx, par exemple :

COPYCOPY
```plaintext
location ~* ^/admin {
deny all;
}
```
## Contournement de l'ACL AWS WAF avec le pliage de ligne <a href="#heading-bypassing-aws-waf-acl-with-line-folding" id="heading-bypassing-aws-waf-acl-with-line-folding"></a>

Il est possible de contourner la protection AWS WAF dans un en-t√™te HTTP en utilisant la syntaxe suivante, o√π AWS WAF ne comprendra pas que l'en-t√™te X-Query contient une charge utile d'injection SQL tandis que le serveur node en arri√®re-plan le fera :
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
## R√©f√©rences

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
