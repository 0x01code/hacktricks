# Bypassando Prote√ß√µes de Proxy / WAF

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Bypass de Regras ACL do Nginx com Manipula√ß√£o de Caminho <a href="#heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules" id="heading-pathname-manipulation-bypassing-reverse-proxies-and-load-balancers-security-rules"></a>

T√©cnicas [desta pesquisa](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies).

Exemplo de regra do Nginx:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
Para evitar bypasses, o Nginx realiza a normaliza√ß√£o do caminho antes de verific√°-lo. No entanto, se o servidor backend realizar uma normaliza√ß√£o diferente (removendo caracteres que o nginx n√£o remove), pode ser poss√≠vel contornar essa defesa.

### **NodeJS - Express**

| Vers√£o do Nginx | **Caracteres de Bypass do Node.js** |
| --------------- | ----------------------------------- |
| 1.22.0          | `\xA0`                              |
| 1.21.6          | `\xA0`                              |
| 1.20.2          | `\xA0`, `\x09`, `\x0C`              |
| 1.18.0          | `\xA0`, `\x09`, `\x0C`              |
| 1.16.1          | `\xA0`, `\x09`, `\x0C`              |

### **Flask**

| Vers√£o do Nginx | **Caracteres de Bypass do Flask**                                    |
| --------------- | -------------------------------------------------------------------- |
| 1.22.0          | `\x85`, `\xA0`                                                     |
| 1.21.6          | `\x85`, `\xA0`                                                     |
| 1.20.2          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`     |
| 1.18.0          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`     |
| 1.16.1          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B`     |

### **Spring Boot**

| Vers√£o do Nginx | **Caracteres de Bypass do Spring Boot** |
| --------------- | --------------------------------------- |
| 1.22.0          | `;`                                     |
| 1.21.6          | `;`                                     |
| 1.20.2          | `\x09`, `;`                             |
| 1.18.0          | `\x09`, `;`                             |
| 1.16.1          | `\x09`, `;`                             |

### **PHP-FPM**

Configura√ß√£o do Nginx FPM:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
Nginx est√° configurado para bloquear o acesso a `/admin.php`, mas √© poss√≠vel contornar isso acessando `/admin.php/index.php`.

### Como prevenir
```plaintext
location ~* ^/admin {
deny all;
}
```
## Bypassar Regras do Mod Security <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Confus√£o de Caminho

[Neste post](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/) √© explicado que o ModSecurity v3 (at√© 3.0.12) **implementou de forma inadequada a vari√°vel `REQUEST_FILENAME`** que deveria conter o caminho acessado (at√© o in√≠cio dos par√¢metros). Isso ocorreu porque ele realizava um decode de URL para obter o caminho.\
Portanto, uma solicita√ß√£o como `http://example.com/foo%3f';alert(1);foo=` no mod security supor√° que o caminho √© apenas `/foo` porque `%3f` √© transformado em `?` terminando o caminho do URL, mas na realidade o caminho que o servidor receber√° ser√° `/foo%3f';alert(1);foo=`.

As vari√°veis `REQUEST_BASENAME` e `PATH_INFO` tamb√©m foram afetadas por esse bug.

Algo semelhante ocorreu na vers√£o 2 do Mod Security que permitia contornar uma prote√ß√£o que impedia o usu√°rio de acessar arquivos com extens√µes espec√≠ficas relacionadas a arquivos de backup (como `.bak`) simplesmente enviando o ponto codificado em URL em `%2e`, por exemplo: `https://example.com/backup%2ebak`.

## Bypassar AWS WAF ACL <a href="#heading-bypassing-aws-waf-acl" id="heading-bypassing-aws-waf-acl"></a>

### Cabe√ßalho Malformado

[Esta pesquisa](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies) menciona que era poss√≠vel contornar as regras do AWS WAF aplicadas nos cabe√ßalhos HTTP enviando um cabe√ßalho "malformado" que n√£o era corretamente analisado pela AWS, mas sim pelo servidor backend.

Por exemplo, enviando a seguinte solicita√ß√£o com uma inje√ß√£o de SQL no cabe√ßalho X-Query:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
Foi poss√≠vel contornar o AWS WAF porque ele n√£o entendia que a pr√≥xima linha fazia parte do valor do cabe√ßalho, enquanto o servidor NODEJS entendia (isso foi corrigido).

## Refer√™ncias

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)
* [https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/](https://blog.sicuranext.com/modsecurity-path-confusion-bugs-bypass/)


<figure><img src="/.gitbook/assets/WebSec_1500x400_10fps_21sn_lightoptimized_v2.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
