# Bypass de Prote√ß√µes Proxy / WAF

<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Bypass de Regras ACL do Nginx <a href="#heading-bypassing-nginx-acl-rules-with-nodejs" id="heading-bypassing-nginx-acl-rules-with-nodejs"></a>

Exemplo de restri√ß√£o do Nginx:
```plaintext
location = /admin {
deny all;
}

location = /admin/ {
deny all;
}
```
### NodeJS

<figure><img src="../.gitbook/assets/image (713).png" alt=""><figcaption></figcaption></figure>

* Como o Nginx inclui o caractere `\xa0` como parte do caminho, a regra de ACL para o URI `/admin` n√£o ser√° acionada. Consequentemente, o Nginx encaminhar√° a mensagem HTTP para o backend;
* Quando o URI `/admin\x0a` √© recebido pelo servidor Node.js, o caractere `\xa0` ser√° removido, permitindo a recupera√ß√£o bem-sucedida do endpoint `/admin`.

| Vers√£o do Nginx | **Caracteres de Bypass do Node.js** |
| --------------- | ----------------------------------- |
| 1.22.0          | `\xA0`                              |
| 1.21.6          | `\xA0`                              |
| 1.20.2          | `\xA0`, `\x09`, `\x0C`              |
| 1.18.0          | `\xA0`, `\x09`, `\x0C`              |
| 1.16.1          | `\xA0`, `\x09`, `\x0C`              |

### Flask

O Flask remove os caracteres `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` e `\x09` do caminho da URL, mas o NGINX n√£o.

<figure><img src="../.gitbook/assets/image (714).png" alt=""><figcaption></figcaption></figure>

| Vers√£o do Nginx | **Caracteres de Bypass do Flask**                             |
| --------------- | ------------------------------------------------------------- |
| 1.22.0          | `\x85`, `\xA0`                                                |
| 1.21.6          | `\x85`, `\xA0`                                                |
| 1.20.2          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.18.0          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |
| 1.16.1          | `\x85`, `\xA0`, `\x1F`, `\x1E`, `\x1D`, `\x1C`, `\x0C`, `\x0B` |

### Spring Boot <a href="#heading-bypassing-nginx-acl-rules-with-spring-boot" id="heading-bypassing-nginx-acl-rules-with-spring-boot"></a>

Abaixo, voc√™ encontrar√° uma demonstra√ß√£o de como a prote√ß√£o ACL pode ser contornada adicionando o caractere `\x09` ou `;` no final do caminho:

<figure><img src="../.gitbook/assets/image (715).png" alt=""><figcaption></figcaption></figure>

| Vers√£o do Nginx | **Caracteres de Bypass do Spring Boot** |
| --------------- | -------------------------------------- |
| 1.22.0          | `;`                                    |
| 1.21.6          | `;`                                    |
| 1.20.2          | `\x09`, `;`                            |
| 1.18.0          | `\x09`, `;`                            |
| 1.16.1          | `\x09`, `;`                            |

### PHP-FPM <a href="#heading-bypassing-nginx-acl-rules-with-php-fpm-integration" id="heading-bypassing-nginx-acl-rules-with-php-fpm-integration"></a>

Considere a seguinte configura√ß√£o do Nginx FPM:
```plaintext
location = /admin.php {
deny all;
}

location ~ \.php$ {
include snippets/fastcgi-php.conf;
fastcgi_pass unix:/run/php/php8.1-fpm.sock;
}
```
√â poss√≠vel contorn√°-lo acessando `/admin.php/index.php`:

<figure><img src="../.gitbook/assets/image (716).png" alt=""><figcaption></figcaption></figure>

### Como prevenir <a href="#heading-how-to-prevent" id="heading-how-to-prevent"></a>

Para prevenir esses problemas, voc√™ deve usar a express√£o `~` em vez da express√£o `=` nas regras de ACL do Nginx, por exemplo:

COPYCOPY
```plaintext
location ~* ^/admin {
deny all;
}
```
## Burlando ACL do AWS WAF com Dobra de Linha <a href="#heading-bypassing-aws-waf-acl-with-line-folding" id="heading-bypassing-aws-waf-acl-with-line-folding"></a>

√â poss√≠vel burlar a prote√ß√£o do AWS WAF em um cabe√ßalho HTTP usando a seguinte sintaxe onde o AWS WAF n√£o entender√° que o cabe√ßalho X-Query cont√©m um payload de inje√ß√£o SQL enquanto o servidor node por tr√°s entender√°:
```http
GET / HTTP/1.1\r\n
Host: target.com\r\n
X-Query: Value\r\n
\t' or '1'='1' -- \r\n
Connection: close\r\n
\r\n
```
## Refer√™ncias

* [https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies](https://rafa.hashnode.dev/exploiting-http-parsers-inconsistencies)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
