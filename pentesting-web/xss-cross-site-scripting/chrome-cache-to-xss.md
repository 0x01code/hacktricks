# Chrome Cache to XSS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Technique tir√©e [**de ce writeup**](https://blog.arkark.dev/2022/11/18/seccon-en/#web-spanote)**.**

Il existe deux types de cache importants :

* **cache avant/arri√®re (bfcache)**
  * ref. [https://web.dev/i18n/en/bfcache/](https://web.dev/i18n/en/bfcache/)
  * Il stocke un instantan√© complet d'une page, **y compris le tas JavaScript**.
  * Le cache est utilis√© pour les navigations avant/arri√®re.
  * il a la pr√©f√©rence sur le cache disque
* **cache disque**
  * ref. [https://www.chromium.org/developers/design-documents/network-stack/disk-cache/](https://www.chromium.org/developers/design-documents/network-stack/disk-cache/)
  * Il stocke une ressource r√©cup√©r√©e sur le web. Le cache **n'inclut pas le tas JavaScript**.
  * Le cache est √©galement utilis√© pour les navigations avant/arri√®re pour √©viter les co√ªts de communication.

Un point int√©ressant du cache disque est que le **cache inclut** non seulement la r√©ponse HTTP rendue sur une page web, mais aussi **celles r√©cup√©r√©es avec `fetch`**. En d'autres termes, si vous acc√©dez √† l'URL d'une ressource r√©cup√©r√©e, le **navigateur rendra la ressource** sur la page.

Il y a un autre point important. Si √† la fois le cache disque et le bfcache sont valides pour une page consult√©e lors de navigations avant/arri√®re, le **bfcache a la priorit√© sur le cache disque**. Ainsi, si vous devez acc√©der √† une page stock√©e dans les deux caches mais que vous voulez utiliser celui du disque, vous devez d'une mani√®re ou d'une autre **d√©sactiver le bfcache.**

### D√©sactiver le bfcache

Le bfcache est d√©sactiv√© par les [options par d√©faut](https://github.com/puppeteer/puppeteer/blob/v19.2.0/packages/puppeteer-core/src/node/ChromeLauncher.ts#L175) de puppeteer.

Essayons le comportement int√©ressant dans ce d√©fi.

Tout d'abord, vous devez d√©sactiver le bfcache[\[2\]](https://blog.arkark.dev/2022/11/18/seccon-en/#fn2). Il existe de nombreuses conditions o√π le bfcache est d√©sactiv√©, la liste est la suivante :

* [https://source.chromium.org/chromium/chromium/src/+/main:out/mac-Debug/gen/third\_party/blink/renderer/core/inspector/protocol/page.cc?q=BackForwardCacheNotRestoredReasonEnum \&ss=chromium](https://source.chromium.org/chromium/chromium/src/+/main:out/mac-Debug/gen/third\_party/blink/renderer/core/inspector/protocol/page.cc?q=BackForwardCacheNotRestoredReasonEnum%20\&ss=chromium)

La mani√®re la plus simple est d'utiliser `RelatedActiveContentsExist`.

* `RelatedActiveContentsExist` : La page ouverte avec `window.open()` et qui a une r√©f√©rence de `window.opener`.
* ref. [https://web.dev/i18n/en/bfcache/#avoid-windowopener-references](https://web.dev/i18n/en/bfcache/#avoid-windowopener-references)

Par cons√©quent, la proc√©dure suivante reproduit le comportement :

1. Acc√©dez √† une page web (par exemple `https://example.com`)
2. Ex√©cutez `open("http://spanote.seccon.games:3000/api/token")`
   * ![](https://blog.arkark.dev/images/2022/20221118-seccon-spanote-04.png)
   * Le serveur renvoie une r√©ponse avec un code d'√©tat 500.
3. Dans l'onglet ouvert, acc√©dez √† `http://spanote.seccon.games:3000/`
   * ![](https://blog.arkark.dev/images/2022/20221118-seccon-spanote-05.png)
   * Ensuite, la r√©ponse de `http://spanote.seccon.games:3000/api/token` est mise en cache en tant que cache disque.
4. Ex√©cutez `history.back()`
   * ![](https://blog.arkark.dev/images/2022/20221118-seccon-spanote-06.png)
   * La r√©ponse JSON mise en cache est rendue sur la page !

Vous pouvez confirmer que le cache disque est utilis√© en utilisant DevTools dans Google Chrome :\
![](https://blog.arkark.dev/images/2022/20221118-seccon-spanote-07.png)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e
