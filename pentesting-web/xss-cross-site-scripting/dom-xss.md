# XSS DOM

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

* Lavori in una **azienda di sicurezza informatica**? Vuoi vedere la **tua azienda pubblicizzata su HackTricks**? o vuoi avere accesso all'**ultima versione del PEASS o scaricare HackTricks in PDF**? Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* Ottieni il [**merchandising ufficiale PEASS & HackTricks**](https://peass.creator-spring.com)
* **Unisciti al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR al** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **e al** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Vulnerabilit√† DOM

Le vulnerabilit√† DOM si verificano quando i dati provenienti da **fonti** controllate dall'attaccante (come `location.search`, `document.referrer` o `document.cookie`) vengono trasferiti in modo non sicuro a **sinks**. I sinks sono funzioni o oggetti (ad esempio, `eval()`, `document.body.innerHTML`) che possono eseguire o renderizzare contenuti dannosi se forniti con dati maligni.

* Le **fonti** sono input che possono essere manipolati dagli attaccanti, inclusi URL, cookie e messaggi web.
* I **sinks** sono endpoint potenzialmente pericolosi dove dati maligni possono causare effetti avversi, come l'esecuzione di script.

Il rischio sorge quando i dati fluiscono da una fonte a un sink senza una corretta convalida o sanificazione, consentendo attacchi come XSS.

{% hint style="info" %}
**Puoi trovare una lista pi√π aggiornata di fonti e sinks in** [**https://github.com/wisec/domxsswiki/wiki**](https://github.com/wisec/domxsswiki/wiki)
{% endhint %}

**Fonti comuni:**
```javascript
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```
**Sink Comuni:**

| [**Reindirizzamento Aperto**](dom-xss.md#open-redirect)                                    | [**Iniezione di Javascript**](dom-xss.md#javascript-injection)                         | [**Manipolazione dei dati del DOM**](dom-xss.md#dom-data-manipulation) | **jQuery**                                                             |
| -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `location`                                                                       | `eval()`                                                                            | `scriptElement.src`                                           | `add()`                                                                |
| `location.host`                                                                  | `costruttore Function()`                                                            | `scriptElement.text`                                          | `after()`                                                              |
| `location.hostname`                                                              | `setTimeout()`                                                                      | `scriptElement.textContent`                                   | `append()`                                                             |
| `location.href`                                                                  | `setInterval()`                                                                     | `scriptElement.innerText`                                     | `animate()`                                                            |
| `location.pathname`                                                              | `setImmediate()`                                                                    | `someDOMElement.setAttribute()`                               | `insertAfter()`                                                        |
| `location.search`                                                                | `execCommand()`                                                                     | `someDOMElement.search`                                       | `insertBefore()`                                                       |
| `location.protocol`                                                              | `execScript()`                                                                      | `someDOMElement.text`                                         | `before()`                                                             |
| `location.assign()`                                                              | `msSetImmediate()`                                                                  | `someDOMElement.textContent`                                  | `html()`                                                               |
| `location.replace()`                                                             | `range.createContextualFragment()`                                                  | `someDOMElement.innerText`                                    | `prepend()`                                                            |
| `open()`                                                                         | `crypto.generateCRMFRequest()`                                                      | `someDOMElement.outerText`                                    | `replaceAll()`                                                         |
| `domElem.srcdoc`                                                                 | **\`\`**[**Manipolazione del percorso del file locale**](dom-xss.md#local-file-path-manipulation) | `someDOMElement.value`                                        | `replaceWith()`                                                        |
| `XMLHttpRequest.open()`                                                          | `FileReader.readAsArrayBuffer()`                                                    | `someDOMElement.name`                                         | `wrap()`                                                               |
| `XMLHttpRequest.send()`                                                          | `FileReader.readAsBinaryString()`                                                   | `someDOMElement.target`                                       | `wrapInner()`                                                          |
| `jQuery.ajax()`                                                                  | `FileReader.readAsDataURL()`                                                        | `someDOMElement.method`                                       | `wrapAll()`                                                            |
| `$.ajax()`                                                                       | `FileReader.readAsText()`                                                           | `someDOMElement.type`                                         | `has()`                                                                |
| **\`\`**[**Manipolazione della richiesta Ajax**](dom-xss.md#ajax-request-manipulation)    | `FileReader.readAsFile()`                                                           | `someDOMElement.backgroundImage`                              | `constructor()`                                                        |
| `XMLHttpRequest.setRequestHeader()`                                              | `FileReader.root.getFile()`                                                         | `someDOMElement.cssText`                                      | `init()`                                                               |
| `XMLHttpRequest.open()`                                                          | `FileReader.root.getFile()`                                                         | `someDOMElement.codebase`                                     | `index()`                                                              |
| `XMLHttpRequest.send()`                                                          | [**Manipolazione del link**](dom-xss.md#link-manipulation)                               | `someDOMElement.innerHTML`                                    | `jQuery.parseHTML()`                                                   |
| `jQuery.globalEval()`                                                            | `someDOMElement.href`                                                               | `someDOMElement.outerHTML`                                    | `$.parseHTML()`                                                        |
| `$.globalEval()`                                                                 | `someDOMElement.src`                                                                | `someDOMElement.insertAdjacentHTML`                           | [**Iniezione di JSON lato client**](dom-xss.md#client-side-sql-injection) |
| **\`\`**[**Manipolazione dello storage HTML5**](dom-xss.md#html-5-storage-manipulation) | `someDOMElement.action`                                                             | `someDOMElement.onevent`                                      | `JSON.parse()`                                                         |
| `sessionStorage.setItem()`                                                       | [**Iniezione di XPath**](dom-xss.md#xpath-injection)                                   | `document.write()`                                            | `jQuery.parseJSON()`                                                   |
| `localStorage.setItem()`                                                         | `document.evaluate()`                                                               | `document.writeln()`                                          | `$.parseJSON()`                                                        |
| **``**[**`Denial of Service`**](dom-xss.md#denial-of-service)**``**              | `someDOMElement.evaluate()`                                                         | `document.title`                                              | **\`\`**[**Manipolazione dei cookie**](dom-xss.md#cookie-manipulation)      |
| `requestFileSystem()`                                                            | **\`\`**[**Manipolazione del dominio del documento**](dom-xss.md#document-domain-manipulation) | `document.implementation.createHTMLDocument()`                | `document.cookie`                                                      |
| `RegExp()`                                                                       | `document.domain`                                                                   | `history.pushState()`                                         | [**Avvelenamento dell'URL WebSocket**](dom-xss.md#websocket-url-poisoning)      |
| [**Iniezione di SQL lato client**](dom-xss.md#client-side-sql-injection)            | [**Manipolazione del messaggio Web**](dom-xss.md#web-message-manipulation)                 | `history.replaceState()`                                      | `WebSocket`                                                            |
| `executeSql()`                                                                   | `postMessage()`                                                                     | \`\`                                                          | \`\`                                                                   |

Il sink **`innerHTML`** non accetta elementi `script` su nessun browser moderno, n√© verranno attivati eventi `svg onload`. Ci√≤ significa che sar√† necessario utilizzare elementi alternativi come `img` o `iframe.

Questo tipo di XSS √® probabilmente il **pi√π difficile da trovare**, poich√© √® necessario esaminare il codice JS, verificare se sta **utilizzando** un oggetto il cui **valore si controlla**, e in tal caso, verificare se c'√® **qualche modo per abusarne** per eseguire JS arbitrario.

## Strumenti per trovarli

* [https://github.com/mozilla/eslint-plugin-no-unsanitized](https://github.com/mozilla/eslint-plugin-no-unsanitized)
* Estensione del browser per controllare ogni dato che raggiunge un sink potenziale: [https://github.com/kevin-mizu/domloggerpp](https://github.com/kevin-mizu/domloggerpp)

## Esempi

### Reindirizzamento Aperto

Da: [https://portswigger.net/web-security/dom-based/open-redirection](https://portswigger.net/web-security/dom-based/open-redirection)

Le **vulnerabilit√† di reindirizzamento aperto nel DOM** si verificano quando uno script scrive dati, che un attaccante pu√≤ controllare, in un sink in grado di avviare la navigazione tra domini.

√à cruciale comprendere che l'esecuzione di codice arbitrario, come **`javascript:alert(1)`**, √® possibile se si ha il controllo sull'inizio dell'URL in cui si verifica il reindirizzamento.

Sinks:
```javascript
location
location.host
location.hostname
location.href
location.pathname
location.search
location.protocol
location.assign()
location.replace()
open()
domElem.srcdoc
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.ajax()
$.ajax()
```
### Manipolazione dei cookie

Da: [https://portswigger.net/web-security/dom-based/cookie-manipulation](https://portswigger.net/web-security/dom-based/cookie-manipulation)

Le vulnerabilit√† di manipolazione dei cookie basate su DOM si verificano quando uno script incorpora dati, che possono essere controllati da un attaccante, nel valore di un cookie. Questa vulnerabilit√† pu√≤ portare a comportamenti inaspettati della pagina web se il cookie viene utilizzato all'interno del sito. Inoltre, pu√≤ essere sfruttata per effettuare un attacco di fissazione della sessione se il cookie √® coinvolto nel tracciamento delle sessioni utente. Il sink principale associato a questa vulnerabilit√† √®:

Sinks:
```javascript
document.cookie
```
### Iniezione di JavaScript

Da: [https://portswigger.net/web-security/dom-based/javascript-injection](https://portswigger.net/web-security/dom-based/javascript-injection)

Le vulnerabilit√† di iniezione di JavaScript basate su DOM vengono create quando uno script esegue dati, che possono essere controllati da un attaccante, come codice JavaScript.

Sinks:
```javascript
eval()
Function() constructor
setTimeout()
setInterval()
setImmediate()
execCommand()
execScript()
msSetImmediate()
range.createContextualFragment()
crypto.generateCRMFRequest()
```
### Manipolazione del dominio del documento

Da: [https://portswigger.net/web-security/dom-based/document-domain-manipulation](https://portswigger.net/web-security/dom-based/document-domain-manipulation)

Le vulnerabilit√† di **manipolazione del dominio del documento** si verificano quando uno script imposta la propriet√† `document.domain` utilizzando dati che un attaccante pu√≤ controllare.

La propriet√† `document.domain` svolge un **ruolo chiave** nell'**applicazione** della **politica della stessa origine** da parte dei browser. Quando due pagine provenienti da origini diverse impostano il loro `document.domain` allo **stesso valore**, possono interagire senza restrizioni. Anche se i browser impongono certi **limiti** ai valori assegnabili a `document.domain`, impedendo l'assegnazione di valori completamente non correlati all'origine effettiva della pagina, esistono eccezioni. Tipicamente, i browser permettono l'uso di **domini figlio** o **genitore**.

Sorgenti:
```javascript
document.domain
```
### Avvelenamento dell'URL WebSocket

Da: [https://portswigger.net/web-security/dom-based/websocket-url-poisoning](https://portswigger.net/web-security/dom-based/websocket-url-poisoning)

**L'avvelenamento dell'URL WebSocket** si verifica quando uno script utilizza **dati controllabili come URL di destinazione** per una connessione WebSocket.

Sorgenti:

Il costruttore `WebSocket` pu√≤ portare a vulnerabilit√† di avvelenamento dell'URL WebSocket.

### Manipolazione del link

Da: [https://portswigger.net/web-security/dom-based/link-manipulation](https://portswigger.net/web-security/dom-based/link-manipulation)

Le **vulnerabilit√† di manipolazione del link basate sul DOM** sorgono quando uno script scrive **dati controllati dall'attaccante su un obiettivo di navigazione** all'interno della pagina corrente, come un link cliccabile o l'URL di invio di un modulo.

Sorgenti:
```javascript
someDOMElement.href
someDOMElement.src
someDOMElement.action
```
### Manipolazione delle richieste Ajax

Da: [https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation](https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation)

Le vulnerabilit√† di manipolazione delle richieste Ajax sorgono quando uno script scrive dati controllabili dall'attaccante in una richiesta Ajax emessa utilizzando un oggetto `XmlHttpRequest`.

Sinks:
```javascript
XMLHttpRequest.setRequestHeader()
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.globalEval()
$.globalEval()
```
### Manipolazione del percorso del file locale

Da: [https://portswigger.net/web-security/dom-based/local-file-path-manipulation](https://portswigger.net/web-security/dom-based/local-file-path-manipulation)

Le **vulnerabilit√† di manipolazione del percorso del file locale** sorgono quando uno script passa **dati controllabili dall'attaccante a un'API di gestione file** come parametro `filename`. Questa vulnerabilit√† pu√≤ essere sfruttata da un attaccante per costruire un URL che, se visitato da un altro utente, potrebbe portare il **browser dell'utente ad aprire o scrivere un file locale arbitrario**.

Sorgenti:
```javascript
FileReader.readAsArrayBuffer()
FileReader.readAsBinaryString()
FileReader.readAsDataURL()
FileReader.readAsText()
FileReader.readAsFile()
FileReader.root.getFile()
FileReader.root.getFile()
```
### Iniezione SQL lato client

Da: [https://portswigger.net/web-security/dom-based/client-side-sql-injection](https://portswigger.net/web-security/dom-based/client-side-sql-injection)

Le **vulnerabilit√† di iniezione SQL lato client** si verificano quando uno script incorpora **dati controllabili dall'attaccante in una query SQL lato client in modo non sicuro**.

Sinks:
```javascript
executeSql()
```
### Manipolazione dell'archiviazione HTML5

Da: [https://portswigger.net/web-security/dom-based/html5-storage-manipulation](https://portswigger.net/web-security/dom-based/html5-storage-manipulation)

Le vulnerabilit√† della manipolazione dell'archiviazione HTML5 sorgono quando uno script memorizza dati controllabili dall'attaccante nell'archiviazione HTML5 del browser web (`localStorage` o `sessionStorage`). Sebbene questa azione non costituisca intrinsecamente una vulnerabilit√† di sicurezza, diventa problematica se l'applicazione successivamente legge i dati memorizzati e li elabora in modo non sicuro. Ci√≤ potrebbe consentire a un attaccante di sfruttare il meccanismo di archiviazione per condurre altri attacchi basati sul DOM, come cross-site scripting e iniezione di JavaScript.

Sorgenti:
```javascript
sessionStorage.setItem()
localStorage.setItem()
```
### Iniezione di XPath

Da: [https://portswigger.net/web-security/dom-based/client-side-xpath-injection](https://portswigger.net/web-security/dom-based/client-side-xpath-injection)

Le vulnerabilit√† di **iniezione di XPath basate su DOM** si verificano quando uno script incorpora **dati controllabili dall'attaccante in una query XPath**.

Sorgenti:
```javascript
document.evaluate()
someDOMElement.evaluate()
```
### Iniezione di JSON lato client

Da: [https://portswigger.net/web-security/dom-based/client-side-json-injection](https://portswigger.net/web-security/dom-based/client-side-json-injection)

Le vulnerabilit√† di **iniezione di JSON basate su DOM** si verificano quando uno script incorpora **dati controllabili dall'attaccante in una stringa che viene analizzata come una struttura dati JSON e poi elaborata dall'applicazione**.

Sorgenti:
```javascript
JSON.parse()
jQuery.parseJSON()
$.parseJSON()
```
### Manipolazione dei messaggi Web

Da: [https://portswigger.net/web-security/dom-based/web-message-manipulation](https://portswigger.net/web-security/dom-based/web-message-manipulation)

Le vulnerabilit√† dei **messaggi Web** sorgono quando uno script invia **dati controllabili dall'attaccante come messaggio Web a un altro documento** all'interno del browser. Un **esempio** di manipolazione vulnerabile dei messaggi Web pu√≤ essere trovato all' [Accademia di Sicurezza Web di PortSwigger](https://portswigger.net/web-security/dom-based/controlling-the-web-message-source).

Sink:

Il metodo `postMessage()` per l'invio di messaggi Web pu√≤ portare a vulnerabilit√† se l'ascoltatore degli eventi per la ricezione dei messaggi gestisce i dati in ingresso in modo non sicuro.

### Manipolazione dei dati DOM

Da: [https://portswigger.net/web-security/dom-based/dom-data-manipulation](https://portswigger.net/web-security/dom-based/dom-data-manipulation)

Le vulnerabilit√† della **manipolazione dei dati DOM** sorgono quando uno script scrive **dati controllabili dall'attaccante in un campo all'interno del DOM** che viene utilizzato nell'interfaccia utente visibile o nella logica lato client. Questa vulnerabilit√† pu√≤ essere sfruttata da un attaccante per costruire un URL che, se visitato da un altro utente, pu√≤ alterare l'aspetto o il comportamento dell'interfaccia utente lato client.
```javascript
scriptElement.src
scriptElement.text
scriptElement.textContent
scriptElement.innerText
someDOMElement.setAttribute()
someDOMElement.search
someDOMElement.text
someDOMElement.textContent
someDOMElement.innerText
someDOMElement.outerText
someDOMElement.value
someDOMElement.name
someDOMElement.target
someDOMElement.method
someDOMElement.type
someDOMElement.backgroundImage
someDOMElement.cssText
someDOMElement.codebase
document.title
document.implementation.createHTMLDocument()
history.pushState()
history.replaceState()
```
### Denial of Service

Da: [https://portswigger.net/web-security/dom-based/denial-of-service](https://portswigger.net/web-security/dom-based/denial-of-service)

Le vulnerabilit√† di **denial-of-service basate su DOM** si verificano quando uno script passa **dati controllabili dall'attaccante in modo non sicuro a un'API di piattaforma problematica**. Ci√≤ include API che, quando invocate, possono portare il computer dell'utente a consumare **quantit√† eccessive di CPU o spazio su disco**. Tali vulnerabilit√† possono avere effetti collaterali significativi, come il browser che limita la funzionalit√† del sito web rifiutando i tentativi di memorizzare dati in `localStorage` o terminando script occupati.

Sorgenti:
```javascript
requestFileSystem()
RegExp()
```
## Dom Clobbering

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

* Lavori in una **azienda di sicurezza informatica**? Vuoi vedere la **tua azienda pubblicizzata in HackTricks**? o vuoi avere accesso all'**ultima versione del PEASS o scaricare HackTricks in PDF**? Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* **Unisciti al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguimi** su **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR al** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **e al** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
