## XSS DOM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## **Vulnerabilidades DOM XSS**

> **Fontes**
>
> Uma fonte √© uma propriedade JavaScript que aceita dados potencialmente controlados pelo atacante. Um exemplo de fonte √© a propriedade `location.search` porque ela l√™ a entrada da string de consulta, que √© relativamente simples para um atacante controlar. Em √∫ltima an√°lise, qualquer propriedade que possa ser controlada pelo atacante √© uma fonte potencial. Isso inclui o URL de refer√™ncia (exposto pela string `document.referrer`), os cookies do usu√°rio (expostos pela string `document.cookie`) e mensagens da web.

> **Drenos**
>
> Um dreno √© uma fun√ß√£o JavaScript ou objeto DOM potencialmente perigoso que pode causar efeitos indesej√°veis se dados controlados pelo atacante forem passados para ele. Por exemplo, a fun√ß√£o `eval()` √© um dreno porque processa o argumento que lhe √© passado como JavaScript. Um exemplo de dreno HTML √© `document.body.innerHTML` porque potencialmente permite que um atacante injete HTML malicioso e execute JavaScript arbitr√°rio.

Fundamentalmente, as vulnerabilidades baseadas em DOM surgem quando um site **passa dados de uma fonte para um dreno**, que ent√£o manipula os dados de maneira insegura no contexto da sess√£o do cliente.

{% hint style="info" %}
**Voc√™ pode encontrar uma lista mais atualizada de fontes e drenos em** [**https://github.com/wisec/domxsswiki/wiki**](https://github.com/wisec/domxsswiki/wiki)
{% endhint %}

**Fontes comuns:**
```javascript
document.URL
document.documentURI
document.URLUnencoded
document.baseURI
location
document.cookie
document.referrer
window.name
history.pushState
history.replaceState
localStorage
sessionStorage
IndexedDB (mozIndexedDB, webkitIndexedDB, msIndexedDB)
Database
```
**Sinks Comuns:**

| [**Redirecionamento Aberto**](dom-xss.md#open-redirect)                                    | [**Inje√ß√£o de Javascript**](dom-xss.md#javascript-injection)                         | [**Manipula√ß√£o de Dados DOM**](dom-xss.md#dom-data-manipulation) | **jQuery**                                                             |
| -------------------------------------------------------------------------------- | ----------------------------------------------------------------------------------- | ------------------------------------------------------------- | ---------------------------------------------------------------------- |
| `location`                                                                       | `eval()`                                                                            | `scriptElement.src`                                           | `add()`                                                                |
| `location.host`                                                                  | `Function() constructor`                                                            | `scriptElement.text`                                          | `after()`                                                              |
| `location.hostname`                                                              | `setTimeout()`                                                                      | `scriptElement.textContent`                                   | `append()`                                                             |
| `location.href`                                                                  | `setInterval()`                                                                     | `scriptElement.innerText`                                     | `animate()`                                                            |
| `location.pathname`                                                              | `setImmediate()`                                                                    | `someDOMElement.setAttribute()`                               | `insertAfter()`                                                        |
| `location.search`                                                                | `execCommand()`                                                                     | `someDOMElement.search`                                       | `insertBefore()`                                                       |
| `location.protocol`                                                              | `execScript()`                                                                      | `someDOMElement.text`                                         | `before()`                                                             |
| `location.assign()`                                                              | `msSetImmediate()`                                                                  | `someDOMElement.textContent`                                  | `html()`                                                               |
| `location.replace()`                                                             | `range.createContextualFragment()`                                                  | `someDOMElement.innerText`                                    | `prepend()`                                                            |
| `open()`                                                                         | `crypto.generateCRMFRequest()`                                                      | `someDOMElement.outerText`                                    | `replaceAll()`                                                         |
| `domElem.srcdoc`                                                                 | **\`\`**[**Manipula√ß√£o de Caminho de Arquivo Local**](dom-xss.md#local-file-path-manipulation) | `someDOMElement.value`                                        | `replaceWith()`                                                        |
| `XMLHttpRequest.open()`                                                          | `FileReader.readAsArrayBuffer()`                                                    | `someDOMElement.name`                                         | `wrap()`                                                               |
| `XMLHttpRequest.send()`                                                          | `FileReader.readAsBinaryString()`                                                   | `someDOMElement.target`                                       | `wrapInner()`                                                          |
| `jQuery.ajax()`                                                                  | `FileReader.readAsDataURL()`                                                        | `someDOMElement.method`                                       | `wrapAll()`                                                            |
| `$.ajax()`                                                                       | `FileReader.readAsText()`                                                           | `someDOMElement.type`                                         | `has()`                                                                |
| **\`\`**[**Manipula√ß√£o de Requisi√ß√£o Ajax**](dom-xss.md#ajax-request-manipulation)    | `FileReader.readAsFile()`                                                           | `someDOMElement.backgroundImage`                              | `constructor()`                                                        |
| `XMLHttpRequest.setRequestHeader()`                                              | `FileReader.root.getFile()`                                                         | `someDOMElement.cssText`                                      | `init()`                                                               |
| `XMLHttpRequest.open()`                                                          | `FileReader.root.getFile()`                                                         | `someDOMElement.codebase`                                     | `index()`                                                              |
| `XMLHttpRequest.send()`                                                          | [**Manipula√ß√£o de Link**](dom-xss.md#link-manipulation)                               | `someDOMElement.innerHTML`                                    | `jQuery.parseHTML()`                                                   |
| `jQuery.globalEval()`                                                            | `someDOMElement.href`                                                               | `someDOMElement.outerHTML`                                    | `$.parseHTML()`                                                        |
| `$.globalEval()`                                                                 | `someDOMElement.src`                                                                | `someDOMElement.insertAdjacentHTML`                           | [**Inje√ß√£o de JSON do lado do cliente**](dom-xss.md#client-side-sql-injection) |
| **\`\`**[**Manipula√ß√£o de Armazenamento HTML5**](dom-xss.md#html-5-storage-manipulation) | `someDOMElement.action`                                                             | `someDOMElement.onevent`                                      | `JSON.parse()`                                                         |
| `sessionStorage.setItem()`                                                       | [**Inje√ß√£o de XPath**](dom-xss.md#xpath-injection)                                   | `document.write()`                                            | `jQuery.parseJSON()`                                                   |
| `localStorage.setItem()`                                                         | `document.evaluate()`                                                               | `document.writeln()`                                          | `$.parseJSON()`                                                        |
| **``**[**`Nega√ß√£o de Servi√ßo`**](dom-xss.md#denial-of-service)**``**              | `someDOMElement.evaluate()`                                                         | `document.title`                                              | **\`\`**[**Manipula√ß√£o de Cookie**](dom-xss.md#cookie-manipulation)      |
| `requestFileSystem()`                                                            | **\`\`**[**Manipula√ß√£o de Dom√≠nio de Documento**](dom-xss.md#document-domain-manipulation) | `document.implementation.createHTMLDocument()`                | `document.cookie`                                                      |
| `RegExp()`                                                                       | `document.domain`                                                                   | `history.pushState()`                                         | [**Envenenamento de URL WebSocket**](dom-xss.md#websocket-url-poisoning)      |
| [**Inje√ß√£o de SQL do lado do cliente**](dom-xss.md#client-side-sql-injection)            | [**Manipula√ß√£o de Mensagem Web**](dom-xss.md#web-message-manipulation)                 | `history.replaceState()`                                      | `WebSocket`                                                            |
| `executeSql()`                                                                   | `postMessage()`                                                                     | \`\`                                                          | \`\`                                                                   |

O **sink `innerHTML`** n√£o aceita elementos `script` em nenhum navegador moderno, nem os eventos `svg onload` ser√£o disparados. Isso significa que voc√™ precisar√° usar elementos alternativos como `img` ou `iframe`.

Esse tipo de XSS √© provavelmente o **mais dif√≠cil de encontrar**, pois voc√™ precisa olhar dentro do c√≥digo JS, ver se ele est√° **usando** algum objeto cujo **valor voc√™ controla**, e nesse caso, ver se h√° **alguma maneira de abusar** dele para executar JS arbitr√°rio.

## Ferramentas para encontr√°-los

* [https://github.com/mozilla/eslint-plugin-no-unsanitized](https://github.com/mozilla/eslint-plugin-no-unsanitized)

## Exemplos

### Redirecionamento Aberto

De: [https://portswigger.net/web-security/dom-based/open-redirection](https://portswigger.net/web-security/dom-based/open-redirection)

#### Como

As vulnerabilidades de redirecionamento aberto baseadas em DOM surgem quando um script grava dados controlados pelo atacante em um sink que pode acionar navega√ß√£o entre dom√≠nios.

Lembre-se de que **se voc√™ puder iniciar a URL** para onde a v√≠tima ser√° **redirecionada**, voc√™ poder√° executar **c√≥digo arbitr√°rio** como: **`javascript:alert(1)`**

#### Sinks
```
location
location.host
location.hostname
location.href
location.pathname
location.search
location.protocol
location.assign()
location.replace()
open()
domElem.srcdoc
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.ajax()
$.ajax()
```
### Manipula√ß√£o de Cookies

De: [https://portswigger.net/web-security/dom-based/cookie-manipulation](https://portswigger.net/web-security/dom-based/cookie-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de cookies baseadas em DOM ocorrem quando um script escreve **dados control√°veis pelo atacante no valor de um cookie**.\
Isso pode ser abusado para fazer com que a p√°gina se comporte de maneira inesperada (se o cookie for usado na web) ou para realizar um ataque de [fixa√ß√£o de sess√£o](../hacking-with-cookies/#session-fixation) (se o cookie for usado para rastrear a sess√£o do usu√°rio).

#### Pontos de Inje√ß√£o
```
document.cookie
```
### Inje√ß√£o de JavaScript

De: [https://portswigger.net/web-security/dom-based/javascript-injection](https://portswigger.net/web-security/dom-based/javascript-injection)

#### Como

As vulnerabilidades de inje√ß√£o de JavaScript baseadas em DOM ocorrem quando um script executa **dados controlados pelo atacante como JavaScript**.

#### Pontos de Inje√ß√£o (Sinks)
```
eval()
Function() constructor
setTimeout()
setInterval()
setImmediate()
execCommand()
execScript()
msSetImmediate()
range.createContextualFragment()
crypto.generateCRMFRequest()
```
### Manipula√ß√£o de document-domain

De: [https://portswigger.net/web-security/dom-based/document-domain-manipulation](https://portswigger.net/web-security/dom-based/document-domain-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de document-domain surgem quando um script usa dados controlados pelo atacante para definir a propriedade **`document.domain`**.

A propriedade `document.domain` √© usada pelos navegadores em sua **aplica√ß√£o** da **pol√≠tica de mesma origem**. Se **duas p√°ginas** de **origens diferentes** definirem explicitamente o **mesmo valor de `document.domain`**, ent√£o essas duas p√°ginas podem **interagir de maneiras n√£o restritas**.\
Os navegadores **geralmente imp√µem algumas restri√ß√µes** aos valores que podem ser atribu√≠dos a `document.domain` e podem impedir o uso de valores completamente diferentes da origem real da p√°gina. **Mas isso nem sempre ocorre** e geralmente **permitem o uso de dom√≠nios filho** ou **pai**. 

#### Sinks
```
document.domain
```
### Envenenamento de URL de WebSocket

De: [https://portswigger.net/web-security/dom-based/websocket-url-poisoning](https://portswigger.net/web-security/dom-based/websocket-url-poisoning)

#### Como

O envenenamento de URL de WebSocket ocorre quando um script usa **dados control√°veis como URL de destino** de uma conex√£o WebSocket.

#### Sinks

O construtor `WebSocket` pode levar a vulnerabilidades de envenenamento de URL de WebSocket.

### Manipula√ß√£o de link

De: [https://portswigger.net/web-security/dom-based/link-manipulation](https://portswigger.net/web-security/dom-based/link-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de link baseadas em DOM surgem quando um script escreve **dados control√°veis pelo atacante em um destino de navega√ß√£o** dentro da p√°gina atual, como um link clic√°vel ou a URL de envio de um formul√°rio.

#### Sinks
```
someDOMElement.href
someDOMElement.src
someDOMElement.action
```
### Manipula√ß√£o de requisi√ß√£o Ajax

De: [https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation](https://portswigger.net/web-security/dom-based/ajax-request-header-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de requisi√ß√£o Ajax surgem quando um script escreve **dados control√°veis pelo atacante em uma requisi√ß√£o Ajax** que √© emitida usando um objeto `XmlHttpRequest`.

#### Sinks
```
XMLHttpRequest.setRequestHeader()
XMLHttpRequest.open()
XMLHttpRequest.send()
jQuery.globalEval()
$.globalEval()
```
### Manipula√ß√£o de caminho de arquivo local

De: [https://portswigger.net/web-security/dom-based/local-file-path-manipulation](https://portswigger.net/web-security/dom-based/local-file-path-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de caminho de arquivo local surgem quando um script passa dados control√°veis pelo atacante para uma API de manipula√ß√£o de arquivo como par√¢metro `filename`. Um atacante pode usar essa vulnerabilidade para construir uma URL que, se visitada por outro usu√°rio, far√° com que o **navegador do usu√°rio abra/escreva um arquivo local arbitr√°rio**.

#### Pontos de vazamento
```
FileReader.readAsArrayBuffer()
FileReader.readAsBinaryString()
FileReader.readAsDataURL()
FileReader.readAsText()
FileReader.readAsFile()
FileReader.root.getFile()
FileReader.root.getFile()
```
### Inje√ß√£o de SQL do lado do cliente

De: [https://portswigger.net/web-security/dom-based/client-side-sql-injection](https://portswigger.net/web-security/dom-based/client-side-sql-injection)

#### Como

As vulnerabilidades de inje√ß√£o de SQL do lado do cliente surgem quando um script incorpora dados control√°veis pelo atacante em uma consulta de SQL do lado do cliente de maneira insegura.

#### Pontos de Inje√ß√£o
```
executeSql()
```
### Manipula√ß√£o de armazenamento HTML5

De: [https://portswigger.net/web-security/dom-based/html5-storage-manipulation](https://portswigger.net/web-security/dom-based/html5-storage-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de armazenamento HTML5 surgem quando um script **armazena dados controlados pelo atacante no armazenamento HTML5** do navegador da web (seja `localStorage` ou `sessionStorage`).\
Este **comportamento n√£o constitui, em si, uma vulnerabilidade de seguran√ßa**. No entanto, se a aplica√ß√£o posteriormente **ler dados de volta do armazenamento e process√°-los de maneira insegura**, um atacante pode ser capaz de alavancar o mecanismo de armazenamento para entregar outros ataques baseados em DOM, como cross-site scripting e inje√ß√£o de JavaScript.

#### Sinks
```
sessionStorage.setItem()
localStorage.setItem()
```
### Inje√ß√£o de XPath

De: [https://portswigger.net/web-security/dom-based/client-side-xpath-injection](https://portswigger.net/web-security/dom-based/client-side-xpath-injection)

#### Como

As vulnerabilidades de inje√ß√£o de XPath baseadas em DOM ocorrem quando um script incorpora **dados control√°veis pelo atacante em uma consulta XPath**.

#### Pontos de vazamento
```
document.evaluate()
someDOMElement.evaluate()
```
### Inje√ß√£o de JSON do lado do cliente

De: [https://portswigger.net/web-security/dom-based/client-side-json-injection](https://portswigger.net/web-security/dom-based/client-side-json-injection)

#### Como

As vulnerabilidades de inje√ß√£o de JSON baseadas em DOM ocorrem quando um script incorpora **dados control√°veis pelo atacante em uma string que √© analisada como uma estrutura de dados JSON e, em seguida, processada pela aplica√ß√£o**.

#### Pontos de Inje√ß√£o (Sinks)
```
JSON.parse()
jQuery.parseJSON()
$.parseJSON()
```
### Manipula√ß√£o de mensagens da web

De: [https://portswigger.net/web-security/dom-based/web-message-manipulation](https://portswigger.net/web-security/dom-based/web-message-manipulation)

#### Como

As vulnerabilidades de mensagens da web surgem quando um script envia dados control√°veis pelo atacante como uma mensagem da web para outro documento dentro do navegador.\
**Exemplo** de manipula√ß√£o vulner√°vel de mensagens da web em [https://portswigger.net/web-security/dom-based/controlling-the-web-message-source](https://portswigger.net/web-security/dom-based/controlling-the-web-message-source)

#### Sinks

O m√©todo `postMessage()` para enviar mensagens da web pode levar a vulnerabilidades se o ouvinte de eventos para receber mensagens manipula os dados recebidos de forma insegura.

### Manipula√ß√£o de dados do DOM

De: [https://portswigger.net/web-security/dom-based/dom-data-manipulation](https://portswigger.net/web-security/dom-based/dom-data-manipulation)

#### Como

As vulnerabilidades de manipula√ß√£o de dados do DOM surgem quando um script escreve dados control√°veis pelo atacante em um campo dentro do DOM que √© usado na interface do usu√°rio vis√≠vel ou na l√≥gica do lado do cliente. Um atacante pode ser capaz de usar essa vulnerabilidade para construir uma URL que, se visitada por outro usu√°rio, modificar√° a apar√™ncia ou o comportamento da interface do usu√°rio do lado do cliente.

#### Sinks
```
scriptElement.src
scriptElement.text
scriptElement.textContent
scriptElement.innerText
someDOMElement.setAttribute()
someDOMElement.search
someDOMElement.text
someDOMElement.textContent
someDOMElement.innerText
someDOMElement.outerText
someDOMElement.value
someDOMElement.name
someDOMElement.target
someDOMElement.method
someDOMElement.type
someDOMElement.backgroundImage
someDOMElement.cssText
someDOMElement.codebase
document.title
document.implementation.createHTMLDocument()
history.pushState()
history.replaceState()
```
### Nega√ß√£o de Servi√ßo

De: [https://portswigger.net/web-security/dom-based/denial-of-service](https://portswigger.net/web-security/dom-based/denial-of-service)

#### Como

As vulnerabilidades de nega√ß√£o de servi√ßo baseadas em DOM ocorrem quando um script passa **dados control√°veis pelo atacante de maneira insegura para uma API problem√°tica da plataforma**, como uma API cuja invoca√ß√£o pode fazer com que o computador do usu√°rio consuma **quantidades excessivas de CPU ou espa√ßo em disco**. Isso pode resultar em efeitos colaterais se o navegador restringir a funcionalidade do site, por exemplo, rejeitando tentativas de armazenar dados em `localStorage` ou matando scripts ocupados.

#### Pontos de Inje√ß√£o (Sinks)
```
requestFileSystem()
RegExp()
```
## Dom Clobbering

{% content-ref url="dom-clobbering.md" %}
[dom-clobbering.md](dom-clobbering.md)
{% endcontent-ref %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
