# Shadow DOM

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci칩n B치sica

Shadow DOM es parte del conjunto de caracter칤sticas de [Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components), que tiene como objetivo permitir a los desarrolladores de JS crear elementos personalizados reutilizables con su funcionalidad encapsulada lejos del resto del c칩digo del sitio web.

Esencialmente, puedes usar Shadow DOM para **aislar el HTML y CSS de tu componente del resto de la p치gina web**. Por ejemplo, si creas identificadores de elementos en un shadow DOM, estos **no entrar치n en conflicto con los identificadores de elementos en el DOM padre**. Cualquier selector de CSS que utilices en tu shadow DOM solo se aplicar치 dentro del shadow DOM y no al DOM padre, y cualquier selector que utilices en el padre no penetrar치 dentro del shadow DOM.
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
Normalmente, cuando adjuntas un **"open" shadow DOM a un elemento**, puedes obtener una referencia al shadow DOM con **`$element.shadowRoot`**. Sin embargo, si el shadow DOM se adjunta en modo **"closed"**, **no puedes obtener una referencia** de esta manera. Incluso despu칠s de leer toda la documentaci칩n para desarrolladores que pude encontrar, todav칤a no tengo del todo claro el prop칩sito del modo cerrado. [Seg칰n Google](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> Hay otra variante de shadow DOM llamada modo "closed". Cuando creas un 치rbol shadow **closed**, **el JavaScript externo no podr치 acceder al DOM interno de tu componente**. Esto es similar a c칩mo funcionan elementos nativos como `<video>`. JavaScript no puede acceder al shadow DOM de `<video>` porque el navegador lo implementa usando una ra칤z shadow en modo cerrado.

Sin embargo, tambi칠n afirman:

> Las ra칤ces shadow cerradas no son muy 칰tiles. Algunos desarrolladores ver치n el modo cerrado como una **caracter칤stica de seguridad artificial**. Pero seamos claros, **no** es una caracter칤stica de seguridad.

## Accediendo al Shadow DOM

### window.find() y selecciones de texto <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

La funci칩n **`window.find("search_text")` penetra dentro de un shadow DOM**. Esta funci칩n efectivamente tiene la misma funcionalidad que ctrl-F en una p치gina web.

Es posible llamar a **`document.execCommand("SelectAll")`** para expandir la selecci칩n **tanto como sea posible** y luego llamar a **`window.getSelection()`** para **devolver el contenido** del texto seleccionado dentro del shadow DOM.

En **firefox** puedes usar `getSelection()`, que devuelve un objeto [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection), donde `anchorElement` es una **referencia a un elemento en el shadow DOM**. Entonces, podemos exfiltrar contenidos del shadow DOM de la siguiente manera:
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
Pero esto no funciona en Chromium.

### contenteditable o inyecci칩n de CSS <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

Una forma en que podr칤amos interactuar con el shadow DOM es si tenemos una **inyecci칩n de HTML o JS dentro de 칠l**. Hay algunas situaciones interesantes donde puedes obtener una inyecci칩n dentro de un shadow DOM donde no podr칤as en una p치gina crossorigin normal.

Un ejemplo es si tienes cualquier **elemento con el atributo `contenteditable`**. Este es un atributo HTML obsoleto y poco utilizado que declara que el **contenido de ese elemento puede ser editado por el usuario**. 춰Podemos usar selecciones junto con la API **`document.execCommand`** para interactuar con un elemento contenteditable y obtener una inyecci칩n de HTML!
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
Quiz치s a칰n m치s interesante, **`contenteditable`** puede ser declarado en cualquier elemento en chromium aplicando una **propiedad CSS obsoleta: `-webkit-user-modify:read-write`**

Esto nos permite **elevar una inyecci칩n de CSS/estilo a una inyecci칩n de HTML**, a침adiendo la propiedad CSS a un elemento y luego utilizando el comando `insertHTML`.

## CTF

Revisa este informe donde esta t칠cnica fue utilizada como un desaf칤o de CTF: [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## Referencias

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
