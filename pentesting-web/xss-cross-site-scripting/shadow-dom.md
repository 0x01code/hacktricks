# Shadow DOM

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## 基本情報

Shadow DOMは、JS開発者が機能をウェブサイトコードの残りの部分から隔離して再利用可能なカスタム要素を作成できるようにすることを目的とした[Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components)機能スイートの一部です。

基本的に、Shadow DOMを使用して**コンポーネントのHTMLとCSSをウェブページの残りの部分から隔離する**ことができます。例えば、shadow DOM内で要素IDを作成すると、それらは**親DOMの要素IDと競合しません**。shadow DOM内で使用するCSSセレクタはshadow DOM内にのみ適用され、親DOMには適用されず、親で使用するセレクタはshadow DOM内に侵入しません。
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
通常、**"open"なshadow DOMを要素にアタッチすると**、**`$element.shadowRoot`**を使ってshadow DOMへの参照を取得できます。しかし、shadow DOMが**"closed"**モードでアタッチされている場合、この方法では参照を取得**できません**。開発者ドキュメントをすべて読んだ後でも、closedモードの目的についてはまだ少し不明確です。[Googleによると](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> shadow DOMには"closed"モードと呼ばれる別のフレーバーがあります。**closed**なshadowツリーを作成すると、**外部のJavaScriptはコンポーネントの内部DOMにアクセスできなくなります**。これは`<video>`のようなネイティブ要素の動作に似ています。ブラウザはclosedモードのshadow rootを使用して`<video>`を実装しているため、JavaScriptは`<video>`のshadow DOMにアクセスできません。

しかし、彼らはまた次のように述べています:

> Closedなshadow rootはあまり役に立ちません。一部の開発者はclosedモードを**人工的なセキュリティ機能**と見なすかもしれません。しかし、はっきりさせておきましょう、それはセキュリティ機能**ではありません**。

## Shadow DOMへのアクセス

### window.find()とテキスト選択 <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

**`window.find("search_text")`関数はshadow DOM内部に侵入します**。この関数は、ウェブページ上でctrl-Fを使ったときと同じ機能を持っています。

**`document.execCommand("SelectAll")`**を呼び出して選択範囲を**できるだけ広げ**、その後**`window.getSelection()`**を呼び出してshadow DOM内の選択されたテキストの**内容を返す**ことができます。

**firefox**では、[Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection)オブジェクトを返す`getSelection()`を使用でき、`anchorElement`はshadow DOM内の**要素への参照**です。したがって、次のようにしてshadow DOMの内容を抽出できます:
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
しかし、これはChromiumでは機能しません。

### contenteditableまたはCSSインジェクション <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

shadow DOMと対話する方法の一つは、**HTMLまたはJSのインジェクションがそれ内部に存在する場合**です。通常のcrossoriginページではできないshadow DOM内でインジェクションを得る興味深い状況があります。

一つの例として、**`contenteditable`属性を持つ要素**があります。これは非推奨であまり使用されていないHTML属性で、その要素の**内容がユーザーによって編集可能であることを宣言します**。**`document.execCommand`** APIと選択を使用してcontenteditable要素と対話し、HTMLインジェクションを得ることができます！
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
```markdown
さらに興味深いことに、**`contenteditable`** は、非推奨の **CSSプロパティ: `-webkit-user-modify:read-write`** を適用することで、chromiumの任意の要素に宣言することができます。

これにより、要素にCSSプロパティを追加し、その後 `insertHTML` コマンドを利用することで、**CSS/スタイルインジェクションをHTMLインジェクションに昇格させる**ことができます。

## CTF

この技術がCTFチャレンジとして使用されたライトアップをチェックしてください: [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## 参考文献

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの**会社を広告したい、または**HackTricksをPDFでダウンロード**したい場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックしてください
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
```
