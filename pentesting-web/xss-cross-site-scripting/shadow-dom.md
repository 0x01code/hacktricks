# Shadow DOM

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

Shadow DOM √© parte do conjunto de recursos [Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components), que visa permitir que desenvolvedores JS criem elementos personalizados reutiliz√°veis com sua funcionalidade encapsulada, separada do restante do c√≥digo do site.

Essencialmente, voc√™ pode usar o Shadow DOM para **isolar o HTML e CSS do seu componente do restante da p√°gina web**. Por exemplo, se voc√™ criar IDs de elementos em um shadow DOM, eles **n√£o entrar√£o em conflito com IDs de elementos no DOM pai**. Quaisquer seletores CSS que voc√™ utilizar no seu shadow DOM ser√£o aplicados apenas dentro do shadow DOM e n√£o ao DOM pai, e quaisquer seletores que voc√™ utilizar no DOM pai n√£o penetrar√£o dentro do shadow DOM.
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
Normalmente, quando voc√™ anexa um **"open" shadow DOM a um elemento**, voc√™ pode obter uma refer√™ncia ao shadow DOM com **`$element.shadowRoot`**. No entanto, se o shadow DOM for anexado em modo **"closed"**, voc√™ **n√£o pode obter uma refer√™ncia** a ele dessa maneira. Mesmo ap√≥s ler toda a documenta√ß√£o para desenvolvedores que pude encontrar, ainda estou um pouco incerto sobre o prop√≥sito do modo fechado. [De acordo com o Google](https://developers.google.com/web/fundamentals/web-components/shadowdom):

> Existe outra varia√ß√£o de shadow DOM chamada modo "closed". Quando voc√™ cria uma √°rvore shadow **closed**, **o JavaScript externo n√£o ser√° capaz de acessar o DOM interno do seu componente**. Isso √© semelhante a como elementos nativos como `<video>` funcionam. O JavaScript n√£o pode acessar o shadow DOM de `<video>` porque o navegador o implementa usando uma raiz de shadow em modo fechado.

No entanto, eles tamb√©m afirmam:

> Ra√≠zes de shadow em modo fechado n√£o s√£o muito √∫teis. Alguns desenvolvedores ver√£o o modo fechado como um **recurso de seguran√ßa artificial**. Mas vamos deixar claro, **n√£o** √© um recurso de seguran√ßa.

## Acessando o Shadow DOM

### window.find() e sele√ß√µes de texto <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

A fun√ß√£o **`window.find("search_text")` penetra dentro de um shadow DOM**. Essa fun√ß√£o efetivamente tem a mesma funcionalidade que ctrl-F em uma p√°gina da web.

√â poss√≠vel chamar **`document.execCommand("SelectAll")`** para expandir a sele√ß√£o tanto quanto poss√≠vel e, em seguida, chamar **`window.getSelection()`** para **retornar o conte√∫do** do texto selecionado dentro do shadow DOM.

No **firefox**, voc√™ pode usar `getSelection()`, que retorna um objeto [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection), onde `anchorElement` √© uma **refer√™ncia a um elemento no shadow DOM**. Assim, podemos exfiltrar conte√∫dos do shadow DOM da seguinte forma:
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
Mas isso n√£o funciona no Chromium.

### contenteditable ou inje√ß√£o de CSS <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

Uma maneira pela qual podemos interagir com o shadow DOM √© se tivermos uma **inje√ß√£o de HTML ou JS dentro dele**. Existem algumas situa√ß√µes interessantes onde voc√™ pode obter inje√ß√£o dentro de um shadow DOM onde n√£o seria poss√≠vel em uma p√°gina normal com crossorigin.

Um exemplo √© se voc√™ tem algum **elemento com o atributo `contenteditable`**. Este √© um atributo HTML obsoleto e pouco usado que declara o **conte√∫do daquele elemento como edit√°vel pelo usu√°rio**. Podemos usar sele√ß√µes junto com a API **`document.execCommand`** para interagir com um elemento contenteditable e obter uma inje√ß√£o de HTML!
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
Talvez ainda mais interessante, **`contenteditable`** pode ser declarado em qualquer elemento no chromium aplicando uma **propriedade CSS obsoleta: `-webkit-user-modify:read-write`**

Isso nos permite **elevar uma inje√ß√£o de CSS/estilo para uma inje√ß√£o de HTML**, adicionando a propriedade CSS a um elemento e, em seguida, utilizando o comando `insertHTML`.

## CTF

Confira este writeup onde essa t√©cnica foi usada como um desafio de CTF: [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## Refer√™ncias

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
