# Shadow DOM

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## 基本情報

Shadow DOMは、[Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components)の機能スイートの一部であり、JS開発者が再利用可能なカスタム要素を作成し、その機能をウェブサイトの他のコードから隔離することを目的としています。

基本的に、Shadow DOMを使用すると、**コンポーネントのHTMLとCSSをウェブページの他の部分から分離**することができます。たとえば、Shadow DOMで要素のIDを作成する場合、それらは**親DOM内の要素のIDと競合しません**。Shadow DOMで使用するCSSセレクタは、Shadow DOM内にのみ適用され、親DOMには適用されず、親で使用するセレクタはShadow DOM内には浸透しません。
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
通常、要素に**「オープン」シャドウ DOMをアタッチ**すると、**`$element.shadowRoot`**を使用してシャドウ DOMへの参照を取得できます。ただし、シャドウ DOMが**「クローズド」**モードでアタッチされている場合、この方法ではそれに対する参照を取得することはできません。開発者ドキュメントをすべて読んだ後でも、私はクローズドモードの目的について少し曖昧なままです。[Googleによると](https://developers.google.com/web/fundamentals/web-components/shadowdom)：

> 「クローズド」モードと呼ばれる別のシャドウ DOMのバリエーションがあります。クローズドシャドウツリーを作成すると、**外部のJavaScriptはコンポーネントの内部DOMにアクセスできなくなります**。これは、`<video>`のようなネイティブ要素の動作と似ています。ブラウザはクローズドモードのシャドウルートを使用して`<video>`を実装しているため、JavaScriptは`<video>`のシャドウ DOMにアクセスできません。

ただし、彼らはまた次のように述べています：

> クローズドシャドウルートはあまり役に立ちません。一部の開発者は、クローズドモードを**人工的なセキュリティ機能**と見なすかもしれません。しかし、はっきり言って、それは**セキュリティ機能ではありません**。

## シャドウ DOMへのアクセス

### window.find() とテキスト選択 <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

関数**`window.find("search_text")`はシャドウ DOM内に侵入**します。この関数は、ウェブページ上のctrl-Fと同じ機能を持っています。

**`document.execCommand("SelectAll")`**を呼び出して選択範囲を**可能な限り拡大**し、その後**`window.getSelection()`**を呼び出してシャドウ DOM内の選択されたテキストの**内容を返す**ことができます。

**Firefox**では、`getSelection()`を使用して、[Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection)オブジェクトを取得できます。`anchorElement`は**シャドウ DOM内の要素への参照**です。したがって、シャドウ DOMの内容を以下のように外部に漏洩させることができます：
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
しかし、これはChromiumでは機能しません。

### contenteditableまたはCSSインジェクション <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

シャドウDOMとのやり取りを行う方法の一つは、**それ自体の内部にHTMLまたはJSインジェクションがある場合**です。通常のクロスオリジンページではできないようなシャドウDOM内でのインジェクションを取得できる興味深い状況がいくつかあります。

例えば、**`contenteditable`属性を持つ要素**がある場合です。これは非推奨であまり使用されていないHTML属性で、その要素の**コンテンツをユーザーが編集可能**にすることを宣言します。選択と**`document.execCommand`** APIを使用して、contenteditable要素とのやり取りを行い、HTMLインジェクションを取得することができます！
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
おそらくさらに興味深いことに、**`contenteditable`**は、廃止予定の**CSSプロパティ`-webkit-user-modify:read-write`**を適用することで、Chromiumの任意の要素に宣言することができます。

これにより、CSS/styleのインジェクションをHTMLのインジェクションに昇格させることができます。要素にCSSプロパティを追加し、`insertHTML`コマンドを利用することで実現します。

## CTF

このテクニックがCTFの課題として使用された例は、次のリンクで確認できます: [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## 参考文献

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **および** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出してください。**

</details>
