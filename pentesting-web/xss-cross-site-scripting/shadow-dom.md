# Shadow DOM

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

Le Shadow DOM fait partie de la suite de fonctionnalit√©s [Web Components](https://developer.mozilla.org/en-US/docs/Web/Web\_Components), qui vise √† permettre aux d√©veloppeurs JS de cr√©er des √©l√©ments personnalis√©s r√©utilisables avec leur fonctionnalit√© encapsul√©e loin du reste du code du site web.

Essentiellement, vous pouvez utiliser le Shadow DOM pour **isoler le HTML et le CSS de votre composant du reste de la page web**. Par exemple, si vous cr√©ez des identifiants d'√©l√©ments dans un shadow DOM, ils **ne seront pas en conflit avec les identifiants d'√©l√©ments dans le DOM parent**. Tous les s√©lecteurs CSS que vous utilisez dans votre shadow DOM s'appliqueront uniquement dans le shadow DOM et non au DOM parent, et tous les s√©lecteurs que vous utilisez dans le parent ne p√©n√©treront pas dans le shadow DOM.
```js
// creating a shadow DOM
let $element = document.createElement("div");
$shadowDomRef = $element.attachShadow({ mode: "open" }); // open or closed
```
Normalement, lorsque vous attachez un **"open" shadow DOM √† un √©l√©ment**, vous pouvez obtenir une r√©f√©rence au shadow DOM avec **`$element.shadowRoot`**. Cependant, si le shadow DOM est attach√© en mode **"closed"**, vous **ne pouvez pas obtenir de r√©f√©rence** de cette mani√®re. M√™me apr√®s avoir lu toute la documentation pour d√©veloppeurs que j'ai pu trouver, je ne suis toujours pas tout √† fait clair sur le but du mode closed. [Selon Google](https://developers.google.com/web/fundamentals/web-components/shadowdom) :

> Il existe une autre variante de shadow DOM appel√©e mode "closed". Lorsque vous cr√©ez un arbre shadow **closed**, **le JavaScript ext√©rieur ne pourra pas acc√©der au DOM interne de votre composant**. Cela est similaire √† la fa√ßon dont fonctionnent les √©l√©ments natifs comme `<video>`. Le JavaScript ne peut pas acc√©der au shadow DOM de `<video>` car le navigateur l'impl√©mente en utilisant une racine shadow en mode closed.

Cependant, ils d√©clarent √©galement :

> Les racines shadow closed ne sont pas tr√®s utiles. Certains d√©veloppeurs verront le mode closed comme une **fonctionnalit√© de s√©curit√© artificielle**. Mais soyons clairs, ce **n'est pas** une fonctionnalit√© de s√©curit√©.

## Acc√©der au Shadow DOM

### window.find() et s√©lections de texte <a href="#introducing-windowfind-and-text-selections" id="introducing-windowfind-and-text-selections"></a>

La fonction **`window.find("search_text")` p√©n√®tre √† l'int√©rieur d'un shadow DOM**. Cette fonction a effectivement la m√™me fonctionnalit√© que ctrl-F sur une page web.

Il est possible d'appeler **`document.execCommand("SelectAll")`** pour √©tendre la s√©lection autant que possible puis d'appeler **`window.getSelection()`** pour **retourner le contenu** du texte s√©lectionn√© √† l'int√©rieur du shadow DOM.

Dans **firefox**, vous pouvez utiliser `getSelection()` qui retourne un objet [Selection](https://developer.mozilla.org/en-US/docs/Web/API/Selection), o√π `anchorElement` est une **r√©f√©rence √† un √©l√©ment dans le shadow DOM**. Ainsi, nous pouvons exfiltrer le contenu du shadow DOM comme suit :
```js
getSelection().anchorNode.parentNode.parentNode.parentNode.innerHTML
```
Mais cela ne fonctionne pas dans Chromium.

### contenteditable ou injection CSS <a href="#contenteditable-or-css-injection" id="contenteditable-or-css-injection"></a>

Une mani√®re dont nous pourrions interagir avec le shadow DOM est si nous avons une **injection HTML ou JS √† l'int√©rieur de celui-ci**. Il existe des situations int√©ressantes o√π vous pouvez obtenir une injection au sein d'un shadow DOM alors que cela ne serait pas possible sur une page crossorigin normale.

Un exemple est si vous avez des **√©l√©ments avec l'attribut `contenteditable`**. C'est un attribut HTML d√©pr√©ci√© et peu utilis√© qui d√©clare que **le contenu de cet √©l√©ment peut √™tre √©dit√© par l'utilisateur**. Nous pouvons utiliser des s√©lections avec l'API **`document.execCommand`** pour interagir avec un √©l√©ment contenteditable et obtenir une injection HTML !
```js
find('selection within contenteditable');

document.execCommand('insertHTML',false,'<svg/onload=console.log(this.parentElement.outerHTML)>')
```
Peut-√™tre encore plus int√©ressant, **`contenteditable`** peut √™tre d√©clar√© sur n'importe quel √©l√©ment dans chromium en appliquant une **propri√©t√© CSS obsol√®te : `-webkit-user-modify:read-write`**

Cela nous permet de **transformer une injection CSS/style en une injection HTML**, en ajoutant la propri√©t√© CSS √† un √©l√©ment, puis en utilisant la commande `insertHTML`.

## CTF

Consultez ce writeup o√π cette technique a √©t√© utilis√©e comme d√©fi CTF : [https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md](https://github.com/Super-Guesser/ctf/blob/master/2022/dicectf/shadow.md)

## R√©f√©rences

* [https://blog.ankursundara.com/shadow-dom/](https://blog.ankursundara.com/shadow-dom/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
