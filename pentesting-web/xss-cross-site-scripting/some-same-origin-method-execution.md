# SOME - 同源方法执行

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> - <a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在**网络安全公司**工作吗？想要看到你的**公司在 HackTricks 中被宣传**吗？或者想要访问**PEASS 的最新版本或下载 HackTricks 的 PDF**吗？查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 探索[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* **加入** [**💬**](https://emojipedia.org/speech-balloon/) **Discord 群组**](https://discord.gg/hRep4RUj7f) 或 **电报群组**](https://t.me/peass) 或 **关注** 我的 **Twitter** **🐦**[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* 通过向**hacktricks 仓库**](https://github.com/carlospolop/hacktricks) **和** [**hacktricks-cloud 仓库**](https://github.com/carlospolop/hacktricks-cloud) **提交 PR** 来分享你的黑客技巧。

</details>

## 同源方法执行

有时候你可以在页面中执行一些有限的 JavaScript。例如，在你可以[**控制将被执行的回调值**](./#javascript-function)的情况下。

在这种情况下，你可以做的最好的事情之一就是**访问 DOM 来调用**你可以在其中找到的**敏感操作**（比如点击按钮）。然而，通常你会在**没有任何有趣内容的 DOM**中找到这种漏洞。

在这些情况下，这种攻击将非常有用，因为它的目标是能够**滥用来自同一域的不同页面中的 DOM 中的有限 JS 执行**，以执行更有趣的操作。

基本上，攻击流程如下：

* 找到一个**可以滥用的回调**（可能限制为 \[\w\\.\_]）。
* 如果没有限制并且你可以执行任何 JS，你可以像常规 XSS 一样滥用它
* 使**受害者打开**由**攻击者控制**的页面
* **页面将在**一个**不同的窗口中打开**（新窗口将具有引用初始窗口的对象**`opener`**）
* **初始页面**将加载包含**有趣 DOM**的**页面**。
* **第二个页面**将加载**滥用回调**并使用**`opener`**对象在**初始页面**中**访问和执行某些操作**（现在包含有趣 DOM）。

{% hint style="danger" %}
请注意，即使初始页面在创建第二个页面后访问新 URL，第二个页面的**`opener` 对象仍然是对新 DOM 中第一个页面的有效引用**。

此外，为了使第二个页面能够使用 opener 对象，**两个页面必须在同一源**中。这就是为什么为了滥用这个漏洞，你需要找到某种**同源中的 XSS**。
{% endhint %}

### 利用

* 你可以使用此表单来**生成一个 PoC** 来利用这种类型的漏洞：[https://www.someattack.com/Playground/SOMEGenerator](https://www.someattack.com/Playground/SOMEGenerator)
* 为了找到具有点击功能的 HTML 元素的 DOM 路径，你可以使用此浏览器扩展：[https://www.someattack.com/Playground/targeting\_tool](https://www.someattack.com/Playground/targeting\_tool)

### 示例

* 你可以在 [https://www.someattack.com/Playground/](https://www.someattack.com/Playground/) 找到一个有漏洞的示例
* 请注意，在此示例中，服务器正在**生成 JavaScript 代码**并将其基于**回调参数的内容添加**到 HTML 中：`<script>opener.{callbacl_content}</script>`。这就是为什么在这个示例中你不需要显式指示使用 `opener`。
* 还请查看这个 CTF 解题报告：[https://ctftime.org/writeup/36068](https://ctftime.org/writeup/36068)

## 参考资料

* [https://conference.hitb.org/hitbsecconf2017ams/sessions/everybody-wants-some-advance-same-origin-method-execution/](https://conference.hitb.org/hitbsecconf2017ams/sessions/everybody-wants-some-advance-same-origin-method-execution/)
