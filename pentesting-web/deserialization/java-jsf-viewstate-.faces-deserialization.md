<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection d'exclusivit√©s [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


# Introduction

Apr√®s avoir examin√© les [RCEs √† travers les biblioth√®ques JSON mal configur√©es](https://www.alphabot.com/security/blog/2017/net/How-to-configure-Json.NET-to-create-a-vulnerable-web-API.html), nous avons commenc√© √† analyser les ViewStates des impl√©mentations JSF. [JavaServer Faces (JSF)](https://en.wikipedia.org/wiki/JavaServer_Faces) est une technologie d'interface utilisateur (UI) pour la cr√©ation d'interfaces utilisateur Web avec des composants r√©utilisables. JSF est principalement utilis√© pour les applications d'entreprise et une impl√©mentation JSF est g√©n√©ralement utilis√©e par une application Web qui s'ex√©cute sur un serveur d'applications Java tel que JBoss EAP ou WebLogic Server. Il existe deux impl√©mentations bien connues de la sp√©cification JSF :

* Oracle Mojarra (impl√©mentation de r√©f√©rence JSF)
* Apache MyFaces

# Port√©e

Cet article de blog se concentre sur les deux impl√©mentations JSF 2.x : Oracle Mojarra (impl√©mentation de r√©f√©rence) et Apache MyFaces. Les anciennes impl√©mentations (JSF 1.x) sont √©galement susceptibles d'√™tre affect√©es par les vuln√©rabilit√©s d√©crites dans ce post. (JSF 2.0.x a √©t√© initialement publi√© en 2009, la version actuelle est 2.3.x).

# L'√©tat du ViewState

Une diff√©rence entre JSF et les technologies Web similaires est que JSF utilise des ViewStates (en plus des sessions) pour stocker l'√©tat actuel de la vue (par exemple, quelles parties de la vue doivent √™tre affich√©es actuellement). Le ViewState peut √™tre stock√© sur le `serveur` ou le `client`. Les ViewStates JSF sont g√©n√©ralement automatiquement int√©gr√©s dans les formulaires HTML en tant que champ masqu√© avec le nom `javax.faces.ViewState`. Ils sont renvoy√©s au serveur si le formulaire est soumis.

## ViewState c√¥t√© serveur

Si le ViewState JSF est configur√© pour se trouver sur le `serveur`, le champ masqu√© `javax.faces.ViewState` contient un identifiant qui aide le serveur √† r√©cup√©rer l'√©tat correct. Dans le cas de MyFaces, cet identifiant est un **objet Java s√©rialis√©** !

## ViewState c√¥t√© client

Si le ViewState JSF est configur√© pour se trouver sur le `client`, le champ masqu√© `javax.faces.ViewState` contient un **objet Java s√©rialis√©** qui est au moins cod√© en Base64. Vous avez peut-√™tre r√©alis√© √† ce stade que c'est une route potentielle vers la catastrophe ! C'est peut-√™tre l'une des raisons pour lesquelles les ViewStates JSF sont aujourd'hui chiffr√©s et sign√©s avant d'√™tre envoy√©s au client. Les dangers des objets Java s√©rialis√©s

En 2015, lors de la conf√©rence AppSec California, [Gabriel Lawrence](https://twitter.com/gebl) et [Chris Frohoff](https://twitter.com/frohoff) ont pr√©sent√© un expos√© intitul√© [Marshalling Pickles (how deserializing objects can ruin your day)](https://frohoff.github.io/appseccali-marshalling-pickles/). Cette pr√©sentation a mis en lumi√®re des probl√®mes oubli√©s avec la s√©rialisation d'objets Java et a conduit √† la d√©couverte de [plusieurs vuln√©rabilit√©s graves d'ex√©cution de code √† distance (RCE)](https://foxglovesecurity.com/2015/11/06/what-do-weblogic-websphere-jboss-jenkins-opennms-and-your-application-have-in-common-this-vulnerability/).

Malheureusement, cela a conduit certaines personnes √† croire que la vuln√©rabilit√© pouvait √™tre att√©nu√©e en supprimant/mettant √† jour certaines versions de Apache Commons Collections. Une action qui peut en effet aider mais ne r√©sout pas la cause profonde du probl√®me : la d√©s√©rialisation de donn√©es non fiables ([CWE 502](https://cwe.mitre.org/data/definitions/502.html)). En d'autres termes :\
**L'utilisation d'une version de la biblioth√®que Apache Commons Collections "vuln√©rable" ne signifie pas que l'application est vuln√©rable, et l'absence d'une telle version de biblioth√®que ne signifie pas que l'application n'est pas vuln√©rable.**

Cependant, apr√®s qu'un pirate malveillant ait [ferm√© et crypt√© les syst√®mes de la San Francisco Municipal Transportation Agency](https://krebsonsecurity.com/2016/11/san-francisco-rail-system-hacker-hacked/) via une "Mad Gadget"/"Apache Commons Collections Deserialization Vulnerability", Google a lanc√© [Operation Rosehub](https://opensource.googleblog.com/2017/03/operation-rosehub.html). L'objectif de l'op√©ration Rosehub √©tait de trouver autant de projets open source Java que possible qui utilisaient une version de collections commons "amicale pour les attaquants" en tant que d√©pendance et de soumettre des demandes de tirage aux propri√©taires de projets afin que ces projets cessent d'utiliser des versions probl√©matiques de collections commons dans de nouvelles versions.

# L'attaque sur le ViewState

Supposons que nous avons une application Web avec une page de connexion bas√©e sur JSF :

![JSF based login](https://www.alphabot.com/images/blog/jsf-viewstate/jsf-viewstate-login.png)

Cette page de connexion a un ViewState qui n'est ni chiffr√© ni sign√©. Donc, lorsque nous regardons sa source HTML, nous voyons un champ masqu√© contenant le ViewState : ViewState MyFaces non chiffr√© :
```
<input type="hidden" name="javax.faces.ViewState" id="j_id__v_0:javax.faces.ViewState:1" value="rO0ABXVyABNbTGphdmEubGFuZy5PYmplY3Q7kM5YnxBzKWwCAAB4cAAAAAJwdAAML2xvZ2luLnhodG1s" autocomplete="off" />
```
Si vous d√©codez le ViewState ci-dessus en utilisant Base64, vous remarquerez qu'il contient un objet Java s√©rialis√©. Ce ViewState est renvoy√© au serveur via POST lorsque le formulaire est soumis (par exemple, en cliquant sur Connexion). Maintenant, avant que le ViewState ne soit renvoy√© au serveur, l'attaquant remplace le ViewState par son propre ViewState malveillant en utilisant un gadget qui est d√©j√† sur le classpath du serveur (par exemple, `InvokerTransformer` de commons-collections-3.2.1.jar) ou m√™me un gadget qui n'est pas encore connu du public. Avec ledit gadget malveillant plac√© dans le ViewState, l'attaquant sp√©cifie les commandes qu'il veut ex√©cuter sur le serveur. La flexibilit√© de ce qu'un attaquant peut faire est limit√©e par les pouvoirs des gadgets disponibles sur le classpath du serveur. En cas d'utilisation de `InvokerTransformer`, l'attaquant peut sp√©cifier les commandes de ligne de commande qui doivent √™tre ex√©cut√©es sur le serveur. L'attaquant dans notre exemple a choisi de d√©marrer une calculatrice sur l'interface utilisateur de notre serveur Linux.

Apr√®s que l'attaquant a envoy√© son formulaire modifi√© au serveur, l'impl√©mentation JSF tente de d√©s√©rialiser le ViewState fourni. Maintenant, m√™me avant que la d√©s√©rialisation du ViewState ne soit termin√©e, la commande est ex√©cut√©e et la calculatrice est d√©marr√©e sur le serveur :

![calculatrice d√©marr√©e via un ViewState JSF](https://www.alphabot.com/images/blog/jsf-viewstate/jsf-viewstate-started-calculator.png)

Tout s'est pass√© avant que l'impl√©mentation JSF ne puisse examiner le ViewState et d√©cider qu'il n'√©tait pas bon. Lorsque le ViewState a √©t√© jug√© invalide, une erreur est g√©n√©ralement renvoy√©e au client comme "Vue expir√©e". Mais alors il est d√©j√† trop tard. L'attaquant avait acc√®s au serveur et a ex√©cut√© des commandes. (La plupart des attaquants du monde r√©el ne lancent pas une calculatrice, mais ils d√©ploient g√©n√©ralement un shell distant, qu'ils utilisent ensuite pour acc√©der au serveur.)

=> Tout cela d√©montre une vuln√©rabilit√© tr√®s dangereuse d'ex√©cution de code √† distance (RCE) non authentifi√©e.

(Le m√™me sc√©nario d'attaque contre JSF tel que d√©crit ci-dessus a d√©j√† √©t√© pr√©sent√© et d√©montr√© dans la pr√©sentation de 2015 (pages 65 √† 67) : [Marshalling Pickles](https://frohoff.github.io/appseccali-marshalling-pickles/) tenue par Frohoff et Lawrence.)

# Les pr√©conditions pour une attaque r√©ussie

Maintenant, quels sont les ingr√©dients d'une catastrophe ?

* ViewState non chiffr√© (ou possession de la cl√© de chiffrement)
* Gadget sur le classpath du serveur
* Dans le cas de Mojarra : ViewState configur√© pour r√©sider sur le `client`
* Dans le cas de MyFaces : ViewState configur√© pour r√©sider sur le `client` **ou** le `serveur`

Examinons ces points en relation avec les deux impl√©mentations JSF.

# Oracle Mojarra (impl√©mentation de r√©f√©rence JSF)

Comme mentionn√© pr√©c√©demment, Oracle Mojarra est l'impl√©mentation de r√©f√©rence JSF (RI) mais peut ne pas √™tre connue sous ce nom. Elle peut √™tre connue sous le nom de Sun JSF RI, reconnue avec le nom de package java `com.sun.faces` ou avec le nom de jar ambigu `jsf-impl.jar`.

## Mojarra : ViewState non chiffr√©

Voici la chose : Mojarra n'a pas chiffr√© et sign√© le ViewState c√¥t√© client par d√©faut dans la plupart des versions de 2.0.x et 2.1.x. Il est important de noter qu'un ViewState c√¥t√© serveur est la valeur par d√©faut dans les deux impl√©mentations JSF, mais un d√©veloppeur pourrait facilement changer la configuration pour utiliser un ViewState c√¥t√© client en d√©finissant le param√®tre `javax.faces.STATE_SAVING_METHOD` sur `client`. Le nom du param√®tre ne r√©v√®le en aucun cas que le fait de le changer en client introduit de graves vuln√©rabilit√©s d'ex√©cution de code √† distance (par exemple, un ViewState c√¥t√© client pourrait √™tre utilis√© dans des applications Web en cluster).

Bien que le chiffrement du ViewState c√¥t√© client soit la valeur par d√©faut dans Mojarra 2.2 et les versions ult√©rieures, ce n'√©tait pas le cas pour les branches 2.0.x et 2.1.x. Cependant, en mai 2016, les d√©veloppeurs de Mojarra ont commenc√© √† r√©troporter le chiffrement du ViewState c√¥t√© client par d√©faut vers [2.0.x](https://github.com/javaserverfaces/mojarra/issues/4142) et [2.1.x](https://github.com/javaserverfaces/mojarra/issues/4141) lorsqu'ils ont r√©alis√© que les ViewStates non chiffr√©s conduisaient √† des vuln√©rabilit√©s d'ex√©cution de code √† distance.

Ainsi, au moins la version [2.1.29-08](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.1.29-08) (publi√©e en juillet 2016) de la branche 2.1.x et la version [2.0.11-04](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.0.11-04) (√©galement publi√©e en juillet 2016) de la branche 2.0.x ont le chiffrement activ√© par d√©faut.

Lorsque nous avons analys√© les biblioth√®ques Mojarra, nous avons remarqu√© que Red Hat publie √©galement des versions de Mojarra pour les branches 2.1.x et 2.0.x, la derni√®re √©tant [2.1.29-jbossorg-1](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.1.29-jbossorg-1) et [2.0.4-b09-jbossorg-4](https://mvnrepository.com/artifact/com.sun.faces/jsf-impl/2.0.4-b09-jbossorg-4). Comme les deux versions √©taient sans chiffrement ViewState par d√©faut, nous avons contact√© Red Hat et ils ont rapidement cr√©√© [Bug 1479661 - JSF client side view state saving deserializes data](https://bugzilla.redhat.com/show_bug.cgi?id=1479661) dans leur bugtracker avec les conseils d'att√©nuation suivants pour la branche 2.1.x :

> Une application Web vuln√©rable doit avoir d√©fini javax.faces.STATE_SAVING_METHOD sur "client" pour activer l'enregistrement de l'√©tat c√¥t√© client. La valeur par d√©faut sur Enterprise Application Platform (EAP) 6.4.x est "serveur".\
> \
> Si javax.faces.STATE_SAVING_METHOD est d√©fini sur "client", une att√©nuation pour ce probl√®me consiste √† chiffrer la vue en d√©finissant com.sun.faces.ClientStateSavingPassword dans le fichier web.xml de l'application :
>
> ```markup
>   <context-param>
>     <param-name>javax.faces.STATE_SAVING_METHOD</param-name>
>
```python
#!/usr/bin/python3
import sys
import hmac
from urllib import parse
from base64 import b64encode
from hashlib import sha1
from pyDes import *

YELLOW = "\033[93m"
GREEN = "\033[32m"

def encrypt(payload,key):
	cipher = des(key, ECB, IV=None, pad=None, padmode=PAD_PKCS5)
	enc_payload = cipher.encrypt(payload)
	return enc_payload

def hmac_sig(enc_payload,key):
	hmac_sig = hmac.new(key, enc_payload, sha1)
	hmac_sig = hmac_sig.digest()
	return hmac_sig

key = b'JsF9876-'

if len(sys.argv) != 3 :
	print(YELLOW + "[!] Usage : {} [Payload File] [Output File]".format(sys.argv[0]))
else:
	with open(sys.argv[1], "rb") as f:
		payload = f.read()
		f.close()
	print(YELLOW + "[+] Encrypting payload")
	print(YELLOW + "  [!] Key : JsF9876-\n")
	enc_payload = encrypt(payload,key)
	print(YELLOW + "[+] Creating HMAC signature")
	hmac_sig = hmac_sig(enc_payload,key)
	print(YELLOW + "[+] Appending signature to the encrypted payload\n")
	payload = b64encode(enc_payload + hmac_sig)
	payload = parse.quote_plus(payload)
	print(YELLOW + "[*] Final payload : {}\n".format(payload))
	with open(sys.argv[2], "w") as f:
		f.write(payload)
		f.close()
	print(GREEN + "[*] Saved to : {}".format(sys.argv[2]))
```
# D√©tection de cl√© connue avec Badsecrets

![Badsecrets](https://github.com/blacklanternsecurity/badsecrets) est une biblioth√®que capable de d√©tecter l'utilisation de cl√©s cryptographiques connues en examinant les produits qu'elles produisent et en les comparant √† une liste de cl√©s connues ou faibles. Son module `Jsf_viewstate` est capable de d√©tecter les Java Server Faces ViewStates cr√©√©s avec des cl√©s connues sur Mojarra et MyFaces, ainsi que les ViewStates non prot√©g√©s ou compress√©s.

La fa√ßon la plus rapide de l'utiliser est avec l'outil d'exemple `cli.py` comme suit:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/cli.py Ly8gp+FZKt9XsaxT5gZu41DDxO74k029z88gNBOru2jXW0g1Og+RUPdf2d8hGNTiofkD1VvmQTZAfeV+5qijOoD+SPzw6K72Y1H0sxfx5mFcfFtmqX7iN6Gq0fwLM+9PKQz88f+e7KImJqG1cz5KYhcrgT87c5Ayl03wEHvWwktTq9TcBJc4f1VnNHXVZgALGqQuETU8hYwZ1VilDmQ7J4pZbv+pvPUvzk+/e2oNeybso6TXqUrbT2Mz3k7yfe92q3pRjdxRlGxmkO9bPqNOtETlLPE5dDiZYo1U9gr8BBQ=
```
![](https://user-images.githubusercontent.com/24899338/227623883-f760570d-796e-459d-87b0-b87ad33999ae.png)

S'il trouve une correspondance, il listera √©galement la plateforme (Mojarra ou MyFaces), l'algorithme de chiffrement utilis√© et si la compression a √©t√© utilis√©e ou non, ce qui est essentiel pour l'exploitation.

Pour rechercher des viewstates vuln√©rables √† grande √©chelle, en conjonction avec l'√©num√©ration des sous-domaines, le module `badsecrets` [**BBOT**]() peut √™tre utilis√© :
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
# R√©flexions finales

La plupart des faits sur les JSF ViewStates et leurs dangers pr√©sent√©s dans ce billet de blog ne sont pas exactement nouveaux, mais il semble qu'ils n'aient jamais √©t√© pr√©sent√©s de mani√®re aussi condens√©e. Cela a montr√© [une fois de plus](https://www.alphabot.com/security/blog/2017/net/How-to-configure-Json.NET-to-create-a-vulnerable-web-API.html) que des changements de configuration apparemment inoffensifs peuvent conduire √† des vuln√©rabilit√©s graves.

\=> L'un des probl√®mes semble √™tre qu'il n'y a pas assez de transfert de connaissances entre les chercheurs en s√©curit√© et les d√©veloppeurs qui utilisent et configurent r√©ellement des biblioth√®ques qui peuvent √™tre dangereuses lorsqu'elles sont configur√©es de certaines mani√®res.

# R√©f√©rences

* [https://www.alphabot.com/security/blog/2017/java/Misconfigured-JSF-ViewStates-can-lead-to-severe-RCE-vulnerabilities.html](https://www.alphabot.com/security/blog/2017/java/Misconfigured-JSF-ViewStates-can-lead-to-severe-RCE-vulnerabilities.html)
* [https://0xrick.github.io/hack-the-box/arkham/](https://0xrick.github.io/hack-the-box/arkham/)


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
