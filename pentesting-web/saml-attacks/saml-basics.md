<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>


# SAML-√úbersicht

**Security Assertion Markup Language (SAML)** erm√∂glicht es Identit√§tsanbietern (IdP), Autorisierungsinformationen an Dienstanbieter (SP) zu senden und Single Sign-On (SSO) zu erm√∂glichen. Dieser Ansatz vereinfacht die Verwaltung mehrerer Anmeldungen, indem ein Satz von Anmeldeinformationen f√ºr mehrere Websites verwendet wird. Es nutzt XML f√ºr die standardisierte Kommunikation zwischen IdPs und SPs und verkn√ºpft die Authentifizierung der Benutzeridentit√§t mit der Dienstautorisierung.

## Vergleich zwischen SAML und OAuth

- **SAML** ist darauf ausgerichtet, Unternehmen eine gr√∂√üere Kontrolle √ºber die Sicherheit der SSO-Anmeldung zu bieten.
- **OAuth** ist darauf ausgelegt, mobiler zu sein, verwendet JSON und ist eine gemeinsame Anstrengung von Unternehmen wie Google und Twitter.

# SAML-Authentifizierungsablauf

**F√ºr weitere Details lesen Sie den vollst√§ndigen Beitrag unter [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Hier eine Zusammenfassung:

Der SAML-Authentifizierungsprozess umfasst mehrere Schritte, wie im Schema dargestellt:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Ressourcenzugriffsversuch**: Der Benutzer versucht auf eine gesch√ºtzte Ressource zuzugreifen.
2. **Generierung der SAML-Anforderung**: Der SP erkennt den Benutzer nicht und generiert eine SAML-Anforderung.
3. **Weiterleitung an IdP**: Der Benutzer wird mit der SAML-Anforderung √ºber den Browser des Benutzers an den IdP weitergeleitet.
4. **IdP empf√§ngt Anforderung**: Der IdP empf√§ngt die SAML-Anforderung.
5. **Authentifizierung beim IdP**: Der IdP authentifiziert den Benutzer.
6. **Benutzer√ºberpr√ºfung**: Der IdP √ºberpr√ºft die Legitimit√§t des Benutzers, um auf die angeforderte Ressource zuzugreifen.
7. **Erstellung der SAML-Antwort**: Der IdP generiert eine SAML-Antwort mit den erforderlichen Aussagen.
8. **Weiterleitung an SP's ACS-URL**: Der Benutzer wird an die Assertion Consumer Service (ACS)-URL des SP weitergeleitet.
9. **Validierung der SAML-Antwort**: Der ACS validiert die SAML-Antwort.
10. **Ressourcenzugriff gew√§hrt**: Zugriff auf die urspr√ºnglich angeforderte Ressource wird gew√§hrt.

# Beispiel f√ºr eine SAML-Anforderung

Betrachten Sie das Szenario, in dem ein Benutzer Zugriff auf eine sichere Ressource unter [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/) beantragt. Der SP erkennt das Fehlen einer Authentifizierung und generiert eine SAML-Anforderung:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Die rohe SAML-Anfrage sieht folgenderma√üen aus:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Wichtige Elemente dieser Anfrage sind:
- **AssertionConsumerServiceURL**: Gibt an, wohin der IdP die SAML-Antwort nach der Authentifizierung senden soll.
- **Destination**: Die Adresse des IdP, an die die Anfrage gesendet wird.
- **ProtocolBinding**: Definiert die √úbertragungsmethode f√ºr SAML-Protokollnachrichten.
- **saml:Issuer**: Identifiziert die Entit√§t, die die Anfrage initiiert hat.

Nach der Generierung der SAML-Anfrage antwortet der SP mit einer **302-Weiterleitung**, die den Browser zum IdP mit der SAML-Anfrage im HTTP-Antwort-Header **Location** leitet. Der Parameter **RelayState** enth√§lt Informationen zum Zustand w√§hrend der Transaktion und stellt sicher, dass der SP die urspr√ºngliche Ressourcenanfrage erkennt, wenn er die SAML-Antwort erh√§lt. Der Parameter **SAMLRequest** ist eine komprimierte und codierte Version des Roh-XML-Snippets, die die Deflate-Komprimierung und die Base64-Codierung verwendet.


# Beispiel f√ºr eine SAML-Antwort

Eine vollst√§ndige SAML-Antwort finden Sie [hier](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Die wichtigsten Bestandteile der Antwort sind:

- **ds:Signature**: Dieser Abschnitt, eine XML-Signatur, gew√§hrleistet die Integrit√§t und Authentizit√§t des Ausstellers der Aussage. Die SAML-Antwort im Beispiel enth√§lt zwei `ds:Signature`-Elemente, eines f√ºr die Nachricht und eines f√ºr die Aussage.
- **saml:Assertion**: Dieser Teil enth√§lt Informationen zur Identit√§t des Benutzers und m√∂glicherweise andere Attribute.
- **saml:Subject**: Es gibt den Hauptgegenstand aller Aussagen in der Aussage an.
- **saml:StatusCode**: Stellt den Status des Vorgangs in Reaktion auf die entsprechende Anfrage dar.
- **saml:Conditions**: Details zu Bedingungen wie der G√ºltigkeitszeit der Aussage und dem angegebenen Service Provider.
- **saml:AuthnStatement**: Best√§tigt, dass der IdP den Gegenstand der Aussage authentifiziert hat.
- **saml:AttributeStatement**: Enth√§lt Attribute, die den Gegenstand der Aussage beschreiben.

Nach der SAML-Antwort erfolgt eine 302-Weiterleitung vom IdP. Dies f√ºhrt zu einer POST-Anfrage an die Assertion Consumer Service (ACS) URL des Service Providers. Die POST-Anfrage enth√§lt die Parameter `RelayState` und `SAMLResponse`. Der ACS ist f√ºr die Verarbeitung und Validierung der SAML-Antwort verantwortlich.

Nachdem die POST-Anfrage empfangen und die SAML-Antwort validiert wurde, wird der Zugriff auf die gesch√ºtzte Ressource gew√§hrt, die vom Benutzer urspr√ºnglich angefordert wurde. Dies wird mit einer `GET`-Anfrage an den Endpunkt `/secure/` und einer `200 OK`-Antwort veranschaulicht, die einen erfolgreichen Zugriff auf die Ressource anzeigt.


# XML-Signaturen

XML-Signaturen sind vielseitig einsetzbar und k√∂nnen einen gesamten XML-Baum oder bestimmte Elemente darin signieren. Sie k√∂nnen auf jedes XML-Objekt angewendet werden, nicht nur auf Response-Elemente. Im Folgenden sind die wichtigsten Arten von XML-Signaturen aufgef√ºhrt:

### Grundstruktur einer XML-Signatur
Eine XML-Signatur besteht aus den folgenden wesentlichen Elementen:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Jedes `Reference`-Element kennzeichnet eine bestimmte Ressource, die signiert wird und durch das URI-Attribut identifizierbar ist.

### Arten von XML-Signaturen

1. **Enveloped Signature**: Diese Art der Signatur ist ein Nachkomme der Ressource, die sie signiert, was bedeutet, dass die Signatur in der gleichen XML-Struktur wie der signierte Inhalt enthalten ist.

Beispiel:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

Bei einer enveloped signature gibt das `ds:Transform`-Element an, dass es durch den `enveloped-signature`-Algorithmus umschlossen ist.

2. **Enveloping Signature**: Im Gegensatz zu enveloped signatures umschlie√üen enveloping signatures die signierte Ressource.

Beispiel:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Detached Signature**: Diese Art ist von dem Inhalt, den sie signiert, getrennt. Die Signatur und der Inhalt existieren unabh√§ngig voneinander, aber eine Verbindung zwischen den beiden wird aufrechterhalten.

Beispiel:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

Zusammenfassend bieten XML-Signaturen flexible M√∂glichkeiten, XML-Dokumente abzusichern, wobei jeder Typ unterschiedliche strukturelle und sicherheitstechnische Anforderungen erf√ºllt.


## Referenzen
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) **bei oder folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) **und** [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) **GitHub-Repositories senden.**

</details>
