<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Obtén [**artículos oficiales de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repositorios de github.

</details>


# Visión general de SAML

**Security Assertion Markup Language (SAML)** es un estándar abierto que permite a los proveedores de identidad (IdP) enviar credenciales de autorización a los proveedores de servicios (SP). Básicamente, permite el inicio de sesión único (SSO), lo que permite el uso de un conjunto de credenciales en varios sitios web. Esto simplifica la gestión de múltiples inicios de sesión, como en el correo electrónico, software CRM o Active Directory. SAML utiliza XML para facilitar la comunicación estandarizada entre el IdP y los SP, vinculando la autenticación de identidad del usuario con la autorización del servicio.

# Comparación entre SAML y OAuth

Si bien tanto **SAML** como **OAuth** ofrecen inicios de sesión en internet simplificados, tienen sus diferencias:

- **SAML** ofrece más control a las empresas, mejorando la seguridad de los inicios de sesión SSO.
- **OAuth** es más amigable para dispositivos móviles, utiliza JSON y fue co-desarrollado por Google y Twitter.

# Flujo de autenticación SAML

Para más detalles, consulta la publicación completa en [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Este es un resumen:

El proceso de autenticación SAML implica varios pasos, como se ilustra en el esquema:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Intento de acceso a recursos**: El usuario intenta acceder a un recurso protegido.
2. **Generación de solicitud SAML**: El SP no reconoce al usuario y genera una solicitud SAML.
3. **Redirección al IdP**: El usuario es redirigido al IdP, con la solicitud SAML pasando a través del navegador del usuario.
4. **Recepción de solicitud por el IdP**: El IdP recibe la solicitud SAML.
5. **Autenticación en el IdP**: El IdP autentica al usuario.
6. **Validación del usuario**: El IdP valida la legitimidad del usuario para acceder al recurso solicitado.
7. **Creación de respuesta SAML**: El IdP genera una respuesta SAML que contiene las afirmaciones necesarias.
8. **Redirección a la URL ACS del SP**: El usuario es redirigido a la URL del Servicio de Consumidor de Afirmaciones (ACS) del SP.
9. **Validación de la respuesta SAML**: El ACS valida la respuesta SAML.
10. **Acceso a recursos concedido**: Se concede acceso al recurso solicitado inicialmente.

# Ejemplo de solicitud SAML

Considera el escenario en el que un usuario solicita acceso a un recurso seguro en [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). El SP identifica la falta de autenticación y genera una solicitud SAML:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
La solicitud SAML en bruto se ve así:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Los elementos clave de esta solicitud incluyen:
- **AssertionConsumerServiceURL**: Especifica a dónde debe enviar el IdP la Respuesta SAML después de la autenticación.
- **Destination**: La dirección del IdP a la que se envía la solicitud.
- **ProtocolBinding**: Define el método de transmisión de mensajes del protocolo SAML.
- **saml:Issuer**: Identifica la entidad que inició la solicitud.

Después de generar la Solicitud SAML, el SP responde con una **redirección 302**, dirigiendo el navegador al IdP con la Solicitud SAML codificada en la cabecera **Location** de la respuesta HTTP. El parámetro **RelayState** mantiene la información de estado durante la transacción, asegurando que el SP reconozca la solicitud de recurso inicial al recibir la Respuesta SAML. El parámetro **SAMLRequest** es una versión comprimida y codificada del fragmento XML sin procesar, utilizando compresión Deflate y codificación base64.


# Ejemplo de Respuesta SAML

Puedes encontrar una [respuesta SAML completa aquí](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Los componentes clave de la respuesta incluyen:

- **ds:Signature**: Esta sección, una Firma XML, garantiza la integridad y autenticidad del emisor de la afirmación. La respuesta SAML en el ejemplo contiene dos elementos `ds:Signature`, uno para el mensaje y otro para la afirmación.
- **saml:Assertion**: Esta parte contiene información sobre la identidad del usuario y posiblemente otros atributos.
- **saml:Subject**: Especifica el sujeto principal de todas las declaraciones en la afirmación.
- **saml:StatusCode**: Representa el estado de la operación en respuesta a la solicitud correspondiente.
- **saml:Conditions**: Detalla condiciones como el tiempo de validez de la Afirmación y el Proveedor de Servicios especificado.
- **saml:AuthnStatement**: Confirma que el IdP autenticó al sujeto de la Afirmación.
- **saml:AttributeStatement**: Contiene atributos que describen el sujeto de la Afirmación.

Después de la Respuesta SAML, el proceso incluye una redirección 302 desde el IdP. Esto lleva a una solicitud POST a la URL del Servicio de Consumidor de Afirmaciones (ACS) del Proveedor de Servicios. La solicitud POST incluye los parámetros `RelayState` y `SAMLResponse`. El ACS es responsable de procesar y validar la Respuesta SAML.

Después de recibir la solicitud POST y validar la Respuesta SAML, se otorga acceso al recurso protegido solicitado inicialmente por el usuario. Esto se ilustra con una solicitud `GET` al punto final `/secure/` y una respuesta `200 OK`, indicando un acceso exitoso al recurso.


# Firmas XML

Las Firmas XML son versátiles, capaces de firmar un árbol XML completo o elementos específicos dentro de él. Se pueden aplicar a cualquier Objeto XML, no solo a elementos de Respuesta. A continuación se muestran los tipos clave de Firmas XML:

### Estructura Básica de la Firma XML
Una Firma XML consta de elementos esenciales como se muestra:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Cada elemento `Reference` significa un recurso específico que está siendo firmado, identificable por el atributo URI.

### Tipos de Firmas XML

1. **Firma Envolvente**: Este tipo de firma es un descendiente del recurso que firma, lo que significa que la firma está contenida dentro de la misma estructura XML que el contenido firmado.

Ejemplo:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

En una firma envolvente, el elemento `ds:Transform` especifica que está envuelto a través del algoritmo `enveloped-signature`.

2. **Firma Envolvente**: A diferencia de las firmas envolventes, las firmas envolventes envuelven el recurso que está siendo firmado.

Ejemplo:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Firma Desvinculada**: Este tipo está separado del contenido que firma. La firma y el contenido existen de forma independiente, pero se mantiene un enlace entre los dos.

Ejemplo:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

En conclusión, las Firmas XML proporcionan formas flexibles de asegurar documentos XML, con cada tipo sirviendo diferentes necesidades estructurales y de seguridad.


# Referencias
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
