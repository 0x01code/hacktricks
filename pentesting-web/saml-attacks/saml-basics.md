<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>


# Vue d'ensemble de SAML

**Security Assertion Markup Language (SAML)** permet aux fournisseurs d'identit√© (IdP) d'√™tre utilis√©s pour envoyer des informations d'identification d'autorisation aux fournisseurs de services (SP), facilitant la connexion unique (SSO). Cette approche simplifie la gestion de plusieurs connexions en permettant l'utilisation d'un seul ensemble d'informations d'identification sur plusieurs sites Web. Elle exploite XML pour la communication normalis√©e entre les IdP et les SP, liant l'authentification de l'identit√© de l'utilisateur √† l'autorisation de service.

## Comparaison entre SAML et OAuth

- **SAML** est con√ßu pour offrir aux entreprises un plus grand contr√¥le sur la s√©curit√© de la connexion SSO.
- **OAuth** est con√ßu pour √™tre plus adapt√© aux mobiles, utilise JSON et est un effort collaboratif d'entreprises telles que Google et Twitter.

# Flux d'authentification SAML

**Pour plus de d√©tails, consultez l'article complet sur [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Voici un r√©sum√© :

Le processus d'authentification SAML implique plusieurs √©tapes, comme illustr√© dans le sch√©ma :

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Tentative d'acc√®s aux ressources** : L'utilisateur tente d'acc√©der √† une ressource prot√©g√©e.
2. **G√©n√©ration de la demande SAML** : Le SP ne reconna√Æt pas l'utilisateur et g√©n√®re une demande SAML.
3. **Redirection vers l'IdP** : L'utilisateur est redirig√© vers l'IdP, la demande SAML passant par le navigateur de l'utilisateur.
4. **R√©ception de la demande par l'IdP** : L'IdP re√ßoit la demande SAML.
5. **Authentification √† l'IdP** : L'IdP authentifie l'utilisateur.
6. **Validation de l'utilisateur** : L'IdP valide la l√©gitimit√© de l'utilisateur pour acc√©der √† la ressource demand√©e.
7. **Cr√©ation de la r√©ponse SAML** : L'IdP g√©n√®re une r√©ponse SAML contenant les assertions n√©cessaires.
8. **Redirection vers l'URL ACS du SP** : L'utilisateur est redirig√© vers l'URL du service de consommation d'assertions (ACS) du SP.
9. **Validation de la r√©ponse SAML** : L'ACS valide la r√©ponse SAML.
10. **Acc√®s aux ressources accord√©** : L'acc√®s √† la ressource initialement demand√©e est accord√©.

# Exemple de demande SAML

Consid√©rons le sc√©nario o√π un utilisateur demande l'acc√®s √† une ressource s√©curis√©e sur [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). Le SP identifie l'absence d'authentification et g√©n√®re une demande SAML :
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
Le SAML Request brut ressemble √† ceci:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Les √©l√©ments cl√©s de cette demande comprennent :
- **AssertionConsumerServiceURL** : Sp√©cifie o√π l'IdP doit envoyer la r√©ponse SAML apr√®s l'authentification.
- **Destination** : L'adresse de l'IdP √† laquelle la demande est envoy√©e.
- **ProtocolBinding** : D√©finit la m√©thode de transmission des messages du protocole SAML.
- **saml:Issuer** : Identifie l'entit√© qui a initi√© la demande.

Apr√®s la g√©n√©ration de la demande SAML, le SP r√©pond avec une redirection **302**, dirigeant le navigateur vers l'IdP avec la demande SAML encod√©e dans l'en-t√™te **Location** de la r√©ponse HTTP. Le param√®tre **RelayState** maintient les informations d'√©tat tout au long de la transaction, garantissant que le SP reconna√Æt la demande de ressource initiale lors de la r√©ception de la r√©ponse SAML. Le param√®tre **SAMLRequest** est une version compress√©e et encod√©e de l'extrait XML brut, utilisant la compression Deflate et l'encodage base64.


# Exemple de R√©ponse SAML

Vous pouvez trouver une [r√©ponse SAML compl√®te ici](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Les composants cl√©s de la r√©ponse comprennent :

- **ds:Signature** : Cette section, une Signature XML, garantit l'int√©grit√© et l'authenticit√© de l'√©metteur de l'assertion. La r√©ponse SAML dans l'exemple contient deux √©l√©ments `ds:Signature`, un pour le message et l'autre pour l'assertion.
- **saml:Assertion** : Cette partie contient des informations sur l'identit√© de l'utilisateur et √©ventuellement d'autres attributs.
- **saml:Subject** : Il sp√©cifie le sujet principal de toutes les d√©clarations dans l'assertion.
- **saml:StatusCode** : Repr√©sente l'√©tat de l'op√©ration en r√©ponse √† la demande correspondante.
- **saml:Conditions** : D√©taille les conditions telles que la dur√©e de validit√© de l'Assertion et le Fournisseur de Services sp√©cifi√©.
- **saml:AuthnStatement** : Confirme que l'IdP a authentifi√© le sujet de l'Assertion.
- **saml:AttributeStatement** : Contient des attributs d√©crivant le sujet de l'Assertion.

Apr√®s la r√©ponse SAML, le processus comprend une redirection 302 de l'IdP. Cela conduit √† une demande POST vers l'URL du Service de Consommation d'Assertion (ACS) du Fournisseur de Services. La demande POST inclut les param√®tres `RelayState` et `SAMLResponse`. Le ACS est responsable du traitement et de la validation de la r√©ponse SAML.

Apr√®s r√©ception de la demande POST et validation de la r√©ponse SAML, l'acc√®s est accord√© √† la ressource prot√©g√©e initialement demand√©e par l'utilisateur. Cela est illustr√© par une requ√™te `GET` vers l'endpoint `/secure/` et une r√©ponse `200 OK`, indiquant un acc√®s r√©ussi √† la ressource.


# Signatures XML

Les signatures XML sont polyvalentes, capables de signer un arbre XML entier ou des √©l√©ments sp√©cifiques √† l'int√©rieur. Elles peuvent √™tre appliqu√©es √† n'importe quel objet XML, pas seulement aux √©l√©ments de r√©ponse. Voici les principaux types de signatures XML :

### Structure de base de la Signature XML
Une Signature XML se compose d'√©l√©ments essentiels comme indiqu√© :
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Chaque √©l√©ment `Reference` signifie une ressource sp√©cifique sign√©e, identifiable par l'attribut URI.

### Types de Signatures XML

1. **Signature Envelopp√©e**: Ce type de signature est un descendant de la ressource qu'il signe, ce qui signifie que la signature est contenue dans la m√™me structure XML que le contenu sign√©.

Exemple:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
...
</samlp:Response>
```

Dans une signature envelopp√©e, l'√©l√©ment `ds:Transform` sp√©cifie qu'elle est envelopp√©e √† travers l'algorithme `enveloped-signature`.

2. **Signature Enveloppante**: Contrairement aux signatures envelopp√©es, les signatures enveloppantes enveloppent la ressource sign√©e.

Exemple:
```xml
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</ds:Signature>
```

3. **Signature D√©tach√©e**: Ce type est s√©par√© du contenu qu'il signe. La signature et le contenu existent ind√©pendamment, mais un lien entre les deux est maintenu.

Exemple:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</ds:Reference>
</ds:SignedInfo>
</ds:Signature>
```

En conclusion, les Signatures XML offrent des moyens flexibles de s√©curiser les documents XML, chaque type r√©pondant √† des besoins structurels et de s√©curit√© diff√©rents.


## R√©f√©rences
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
