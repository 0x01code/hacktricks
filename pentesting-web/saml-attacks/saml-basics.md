<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>


# Vis√£o Geral do SAML

**Security Assertion Markup Language (SAML)** permite que provedores de identidade (IdP) sejam utilizados para enviar credenciais de autoriza√ß√£o para provedores de servi√ßos (SP), facilitando o logon √∫nico (SSO). Essa abordagem simplifica o gerenciamento de v√°rios logins, permitindo que um √∫nico conjunto de credenciais seja usado em v√°rios sites. Ele utiliza XML para comunica√ß√£o padronizada entre IdPs e SPs, vinculando a autentica√ß√£o da identidade do usu√°rio com a autoriza√ß√£o do servi√ßo.

## Compara√ß√£o entre SAML e OAuth

- **SAML** √© direcionado para fornecer √†s empresas maior controle sobre a seguran√ßa do login SSO.
- **OAuth** √© projetado para ser mais amig√°vel para dispositivos m√≥veis, usa JSON e √© um esfor√ßo colaborativo de empresas como Google e Twitter.

# Fluxo de Autentica√ß√£o SAML

**Para mais detalhes, confira o post completo em [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)**. Este √© um resumo:

O processo de autentica√ß√£o SAML envolve v√°rias etapas, conforme ilustrado no esquema:

![https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg](https://epi052.gitlab.io/notes-to-self/img/saml/saml-flow.jpg)

1. **Tentativa de Acesso ao Recurso**: O usu√°rio tenta acessar um recurso protegido.
2. **Gera√ß√£o de Solicita√ß√£o SAML**: O SP n√£o reconhece o usu√°rio e gera uma Solicita√ß√£o SAML.
3. **Redirecionamento para IdP**: O usu√°rio √© redirecionado para o IdP, com a Solicita√ß√£o SAML passando pelo navegador do usu√°rio.
4. **IdP Recebe Solicita√ß√£o**: O IdP recebe a Solicita√ß√£o SAML.
5. **Autentica√ß√£o no IdP**: O IdP autentica o usu√°rio.
6. **Valida√ß√£o do Usu√°rio**: O IdP valida a legitimidade do usu√°rio para acessar o recurso solicitado.
7. **Cria√ß√£o de Resposta SAML**: O IdP gera uma Resposta SAML contendo as assertivas necess√°rias.
8. **Redirecionamento para URL ACS do SP**: O usu√°rio √© redirecionado para a URL do Servi√ßo de Consumidor de Assertivas (ACS) do SP.
9. **Valida√ß√£o da Resposta SAML**: O ACS valida a Resposta SAML.
10. **Acesso ao Recurso Concedido**: Acesso ao recurso inicialmente solicitado √© concedido.

# Exemplo de Solicita√ß√£o SAML

Considere o cen√°rio em que um usu√°rio solicita acesso a um recurso seguro em [https://shibdemo-sp1.test.edu/secure/](https://shibdemo-sp1.test.edu/secure/). O SP identifica a falta de autentica√ß√£o e gera uma Solicita√ß√£o SAML:
```
GET /secure/ HTTP/1.1
Host: shibdemo-sp1.test.edu
...
```
O pedido SAML bruto se parece com isto:
```xml
<?xml version="1.0"?>
<samlp:AuthnRequest ...
</samlp:AuthnRequest>
```
Os principais elementos desta solicita√ß√£o incluem:
- **AssertionConsumerServiceURL**: Especifica para onde o IdP deve enviar a Resposta SAML p√≥s-autentica√ß√£o.
- **Destination**: O endere√ßo do IdP para o qual a solicita√ß√£o √© enviada.
- **ProtocolBinding**: Define o m√©todo de transmiss√£o de mensagens do protocolo SAML.
- **saml:Issuer**: Identifica a entidade que iniciou a solicita√ß√£o.

Ap√≥s a gera√ß√£o da Solicita√ß√£o SAML, o SP responde com um **redirecionamento 302**, direcionando o navegador para o IdP com a Solicita√ß√£o SAML codificada no cabe√ßalho **Location** da resposta HTTP. O par√¢metro **RelayState** mant√©m as informa√ß√µes de estado durante a transa√ß√£o, garantindo que o SP reconhe√ßa a solicita√ß√£o de recurso inicial ao receber a Resposta SAML. O par√¢metro **SAMLRequest** √© uma vers√£o comprimida e codificada do trecho XML bruto, utilizando compress√£o Deflate e codifica√ß√£o base64.


# Exemplo de Resposta SAML

Voc√™ pode encontrar uma [resposta SAML completa aqui](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/). Os principais componentes da resposta incluem:

- **ds:Signature**: Esta se√ß√£o, uma Assinatura XML, garante a integridade e autenticidade do emissor da declara√ß√£o. A resposta SAML no exemplo cont√©m dois elementos `ds:Signature`, um para a mensagem e outro para a declara√ß√£o.
- **saml:Assertion**: Esta parte cont√©m informa√ß√µes sobre a identidade do usu√°rio e possivelmente outros atributos.
- **saml:Subject**: Especifica o sujeito principal de todas as declara√ß√µes na afirma√ß√£o.
- **saml:StatusCode**: Representa o status da opera√ß√£o em resposta √† solicita√ß√£o correspondente.
- **saml:Conditions**: Detalha condi√ß√µes como o tempo de validade da Declara√ß√£o e o Provedor de Servi√ßo especificado.
- **saml:AuthnStatement**: Confirma que o IdP autenticou o sujeito da Declara√ß√£o.
- **saml:AttributeStatement**: Cont√©m atributos que descrevem o sujeito da Declara√ß√£o.

Ap√≥s a Resposta SAML, o processo inclui um redirecionamento 302 do IdP. Isso leva a uma solicita√ß√£o POST para o URL do Servi√ßo de Consumidor de Declara√ß√µes (ACS) do Provedor de Servi√ßos. A solicita√ß√£o POST inclui os par√¢metros `RelayState` e `SAMLResponse`. O ACS √© respons√°vel por processar e validar a Resposta SAML.

Ap√≥s receber a solicita√ß√£o POST e validar a Resposta SAML, o acesso √© concedido ao recurso protegido inicialmente solicitado pelo usu√°rio. Isso √© ilustrado com uma solicita√ß√£o `GET` para o endpoint `/secure/` e uma resposta `200 OK`, indicando acesso bem-sucedido ao recurso.


# Assinaturas XML

As Assinaturas XML s√£o vers√°teis, capazes de assinar uma √°rvore XML inteira ou elementos espec√≠ficos dentro dela. Elas podem ser aplicadas a qualquer Objeto XML, n√£o apenas a elementos de Resposta. Abaixo est√£o os principais tipos de Assinaturas XML:

### Estrutura B√°sica da Assinatura XML
Uma Assinatura XML consiste nos elementos essenciais conforme mostrado:
```xml
<Signature>
<SignedInfo>
<CanonicalizationMethod />
<SignatureMethod />
<Reference>
<Transforms />
<DigestMethod />
<DigestValue />
</Reference>
...
</SignedInfo>
<SignatureValue />
<KeyInfo />
<Object />
</Signature>
```
Cada elemento `Reference` significa um recurso espec√≠fico sendo assinado, identific√°vel pelo atributo URI.

### Tipos de Assinaturas XML

1. **Assinatura Envelopada**: Este tipo de assinatura √© um descendente do recurso que assina, o que significa que a assinatura est√° contida na mesma estrutura XML que o conte√∫do assinado.

Exemplo:
```xml
<samlp:Response ... ID="..." ... >
...
<ds:Signature>
<ds:SignedInfo>
...
<ds:Reference URI="#...">
...
</Reference>
</SignedInfo>
</Signature>
...
</samlp:Response>
```

Em uma assinatura envelopada, o elemento `ds:Transform` especifica que est√° envelopado atrav√©s do algoritmo `enveloped-signature`.

2. **Assinatura Envelopante**: Em contraste com as assinaturas envelopadas, as assinaturas envelopantes envolvem o recurso sendo assinado.

Exemplo:
```xml
<ds:Signature>
<SignedInfo>
...
<Reference URI="#...">
...
</Reference>
</SignedInfo>
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
</Signature>
```

3. **Assinatura Separada**: Este tipo √© separado do conte√∫do que assina. A assinatura e o conte√∫do existem independentemente, mas uma liga√ß√£o entre os dois √© mantida.

Exemplo:
```xml
<samlp:Response ... ID="..." ... >
...
</samlp:Response>
<ds:Signature>
<SignedInfo>
...
<Reference URI="#...">
...
</Reference>
</SignedInfo>
</Signature>
```

Em conclus√£o, as Assinaturas XML fornecem maneiras flex√≠veis de proteger documentos XML, com cada tipo atendendo a diferentes necessidades estruturais e de seguran√ßa.


# Refer√™ncias
* [https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/](https://epi052.gitlab.io/notes-to-self/blog/2019-03-07-how-to-test-saml-a-methodology/)
