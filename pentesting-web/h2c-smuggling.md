# Αναβάθμιση Κεφαλίδας Εκμετάλλευσης

<details>

<summary><strong>Μάθετε την ειδικότητα AWS Red Team Expert από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι υποστήριξης του HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε** στην 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα τηλεγραφήματος**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα κόλπα σας στο χάκινγκ υποβάλλοντας PRs** στα [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## H2C Εκμετάλλευση <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 Πάνω σε Καθαρό Κείμενο (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

Το H2C, ή **http2 πάνω σε καθαρό κείμενο**, αποκλίνει από τον κανόνα των προσωρινών συνδέσεων HTTP αναβαθμίζοντας μια τυπική σύνδεση HTTP σε μια μόνιμη. Αυτή η αναβαθμισμένη σύνδεση χρησιμοποιεί το δυαδικό πρωτόκολλο http2 για τη συνεχή επικοινωνία, αντί για τη μονοεπίπεδη φύση του καθαρού HTTP.

Το πυρήνα του προβλήματος εκμετάλλευσης προκύπτει με τη χρήση ενός **αντίστροφου διακομιστή**. Συνήθως, ο αντίστροφος διακομιστής επεξεργάζεται και προωθεί τα αιτήματα HTTP προς τον πίσω μέρος, επιστρέφοντας την απάντηση του πίσω μέρους μετά από αυτό. Ωστόσο, όταν η κεφαλίδα `Connection: Upgrade` είναι παρούσα σε ένα αίτημα HTTP (συνηθισμένη στις συνδέσεις websocket), ο αντίστροφος **διακομιστής διατηρεί μια μόνιμη σύνδεση** μεταξύ πελάτη και διακομιστή, διευκολύνοντας τη συνεχή ανταλλαγή που απαιτείται από ορισμένα πρωτόκολλα. Για τις συνδέσεις H2C, η συμμόρφωση με το RFC απαιτεί την παρουσία τριών συγκεκριμένων κεφαλίδων:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
### Ευάλωτοι Διαμεσολαβητές <a href="#exploitation" id="exploitation"></a>

Η ευπάθεια προκύπτει όταν, μετά την αναβάθμιση μιας σύνδεσης, ο αντίστροφος διαμεσολαβητής σταματά να διαχειρίζεται μεμονωμένα αιτήματα, υποθέτοντας ότι η διαδρομή του δρομολόγησης έχει ολοκληρωθεί μετά την καθιέρωση της σύνδεσης. Η εκμετάλλευση του H2C Smuggling επιτρέπει την παράκαμψη των κανόνων του αντίστροφου διαμεσολαβητή που εφαρμόζονται κατά την επεξεργασία των αιτημάτων, όπως η δρομολόγηση βασισμένη σε μονοπάτια, η πιστοποίηση ταυτότητας και η επεξεργασία WAF, υποθέτοντας ότι μια σύνδεση H2C έχει επιτυχώς καθιερωθεί.

### Εκμετάλλευση <a href="#exploitation" id="exploitation"></a>

Είναι ζωτικής σημασίας να σημειωθεί ότι όχι όλοι οι διακομιστές προωθούν από μόνοι τους τα απαιτούμενα κεφαλίδες για μια συμμορφωμένη αναβάθμιση σύνδεσης H2C. Ως εκ τούτου, διακομιστές όπως οι AWS ALB/CLB, NGINX και Apache Traffic Server, μεταξύ άλλων, φυσικά αποκλείουν τις συνδέσεις H2C. Παρ' όλα αυτά, αξίζει να δοκιμάσετε με τη μη συμμορφωμένη παραλλαγή `Connection: Upgrade`, η οποία εξαιρεί την τιμή `HTTP2-Settings` από την κεφαλίδα `Connection`, καθώς μερικά πίσω μέρη ενδέχεται να μη συμμορφώνονται με τα πρότυπα.

{% hint style="danger" %}
Ανεξαρτήτως του συγκεκριμένου **μονοπατιού** που έχει οριστεί στο URL `proxy_pass` (π.χ., `http://backend:9999/socket.io`), η καθιερωμένη σύνδεση προεπιλέγεται στο `http://backend:9999`. Αυτό επιτρέπει την αλληλεπίδραση με οποιοδήποτε μονοπάτι εντός αυτού του εσωτερικού σημείου πρόσβασης, εκμεταλλευόμενο αυτήν την τεχνική. Ως εκ τούτου, η καθορισμένη διαδρομή στο URL `proxy_pass` δεν περιορίζει την πρόσβαση.
{% endhint %}

Τα εργαλεία [**h2csmuggler από την BishopFox**](https://github.com/BishopFox/h2csmuggler) και [**h2csmuggler από την assetnote**](https://github.com/assetnote/h2csmuggler) διευκολύνουν τις προσπάθειες να **παρακαμφθούν οι προστασίες που επιβάλλει ο διαμεσολαβητής** με την καθιέρωση μιας σύνδεσης H2C, επιτρέποντας έτσι την πρόσβαση σε πόρους που προστατεύονται από τον διαμεσολαβητή.

Για περισσότερες πληροφορίες σχετικά με αυτήν την ευπάθεια, ιδιαίτερα όσον αφορά το NGINX, ανατρέξτε σε [**αυτό το λεπτομερές εγχειρίδιο**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).
