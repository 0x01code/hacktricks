# Atualiza√ß√£o de Smuggling de Cabe√ßalho

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

**Grupo de Seguran√ßa Try Hard**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

### Smuggling H2C <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

#### HTTP2 Sobre Texto Puro (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C, ou **http2 sobre texto puro**, se desvia da norma de conex√µes HTTP transit√≥rias, atualizando uma conex√£o HTTP padr√£o para uma persistente. Essa conex√£o atualizada utiliza o protocolo bin√°rio http2 para comunica√ß√£o cont√≠nua, em oposi√ß√£o √† natureza de √∫nica solicita√ß√£o do HTTP em texto simples.

A ess√™ncia do problema de smuggling surge com o uso de um **proxy reverso**. Normalmente, o proxy reverso processa e encaminha solicita√ß√µes HTTP para o backend, retornando a resposta do backend depois disso. No entanto, quando o cabe√ßalho `Connection: Upgrade` est√° presente em uma solicita√ß√£o HTTP (comumente visto com conex√µes websocket), o **proxy reverso mant√©m uma conex√£o persistente** entre cliente e servidor, facilitando a troca cont√≠nua necess√°ria por certos protocolos. Para conex√µes H2C, a conformidade com o RFC exige a presen√ßa de tr√™s cabe√ßalhos espec√≠ficos:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
A vulnerabilidade surge quando, ap√≥s a atualiza√ß√£o de uma conex√£o, o proxy reverso deixa de gerenciar solicita√ß√µes individuais, assumindo que seu trabalho de roteamento est√° completo ap√≥s o estabelecimento da conex√£o. A explora√ß√£o do H2C Smuggling permite contornar as regras do proxy reverso aplicadas durante o processamento da solicita√ß√£o, como roteamento baseado em caminho, autentica√ß√£o e processamento de WAF, assumindo que uma conex√£o H2C seja iniciada com sucesso.

#### Proxies Vulner√°veis <a href="#exploitation" id="exploitation"></a>

A vulnerabilidade depende do tratamento pelo proxy reverso dos cabe√ßalhos `Upgrade` e, √†s vezes, `Connection`. Os seguintes proxies encaminham esses cabe√ßalhos durante o proxy-pass, permitindo assim o H2C smuggling:

* HAProxy
* Traefik
* Nuster

Por outro lado, esses servi√ßos n√£o encaminham esses cabe√ßalhos durante o proxy-pass. No entanto, eles podem ser configurados de forma insegura, permitindo o encaminhamento n√£o filtrado dos cabe√ßalhos `Upgrade` e `Connection`:

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

#### Explora√ß√£o <a href="#exploitation" id="exploitation"></a>

√â crucial observar que nem todos os servidores encaminham os cabe√ßalhos necess√°rios para uma atualiza√ß√£o de conex√£o H2C compat√≠vel. Portanto, servidores como AWS ALB/CLB, NGINX e Apache Traffic Server, entre outros, naturalmente bloqueiam conex√µes H2C. No entanto, vale a pena testar com a variante n√£o compat√≠vel `Connection: Upgrade`, que exclui o valor `HTTP2-Settings` do cabe√ßalho `Connection`, pois alguns backends podem n√£o estar em conformidade com os padr√µes.

{% hint style="danger" %}
Independentemente do **caminho** espec√≠fico designado na URL `proxy_pass` (por exemplo, `http://backend:9999/socket.io`), a conex√£o estabelecida √© padr√£o para `http://backend:9999`. Isso permite interagir com qualquer caminho dentro desse endpoint interno, aproveitando essa t√©cnica. Portanto, a especifica√ß√£o de um caminho na URL `proxy_pass` n√£o restringe o acesso.
{% endhint %}

As ferramentas [**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) e [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) facilitam as tentativas de **contornar as prote√ß√µes impostas pelo proxy** ao estabelecer uma conex√£o H2C, permitindo assim o acesso a recursos protegidos pelo proxy.

Para obter informa√ß√µes adicionais sobre essa vulnerabilidade, especialmente em rela√ß√£o ao NGINX, consulte [**este recurso detalhado**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

O Websocket smuggling, ao contr√°rio da cria√ß√£o de um t√∫nel HTTP2 para um endpoint acess√≠vel por meio de um proxy, estabelece um t√∫nel Websocket para contornar poss√≠veis limita√ß√µes do proxy e facilitar a comunica√ß√£o direta com o endpoint.

### Cen√°rio 1

Neste cen√°rio, um backend que oferece uma API Websocket p√∫blica juntamente com uma API REST interna inacess√≠vel √© alvo de um cliente malicioso em busca de acesso √† API REST interna. O ataque ocorre em v√°rias etapas:

1. O cliente inicia enviando uma solicita√ß√£o de Upgrade para o proxy reverso com uma vers√£o de protocolo `Sec-WebSocket-Version` incorreta no cabe√ßalho. O proxy, falhando em validar o cabe√ßalho `Sec-WebSocket-Version`, considera a solicita√ß√£o de Upgrade v√°lida e a encaminha para o backend.
2. O backend responde com um c√≥digo de status `426`, indicando a vers√£o de protocolo incorreta no cabe√ßalho `Sec-WebSocket-Version`. O proxy reverso, ignorando o status de resposta do backend, assume prontid√£o para a comunica√ß√£o Websocket e repassa a resposta ao cliente.
3. Consequentemente, o proxy reverso √© enganado a acreditar que uma conex√£o Websocket foi estabelecida entre o cliente e o backend, enquanto na realidade, o backend rejeitou a solicita√ß√£o de Upgrade. Apesar disso, o proxy mant√©m uma conex√£o TCP ou TLS aberta entre o cliente e o backend, permitindo ao cliente acesso irrestrito √† API REST privada por meio dessa conex√£o.

Os proxies reversos afetados incluem o Varnish, que se recusou a abordar o problema, e o proxy Envoy na vers√£o 1.8.0 ou mais antiga, com vers√µes posteriores tendo alterado o mecanismo de atualiza√ß√£o. Outros proxies tamb√©m podem ser suscet√≠veis.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

### Cen√°rio 2

Este cen√°rio envolve um backend com uma API Websocket p√∫blica e uma API REST p√∫blica para verifica√ß√£o de sa√∫de, juntamente com uma API REST interna inacess√≠vel. O ataque, mais complexo, envolve as seguintes etapas:

1. O cliente envia uma solicita√ß√£o POST para acionar a API de verifica√ß√£o de sa√∫de, incluindo um cabe√ßalho HTTP adicional `Upgrade: websocket`. O NGINX, atuando como proxy reverso, interpreta isso como uma solicita√ß√£o de Upgrade padr√£o baseada apenas no cabe√ßalho `Upgrade`, ignorando os outros aspectos da solicita√ß√£o, e a encaminha para o backend.
2. O backend executa a API de verifica√ß√£o de sa√∫de, alcan√ßando um recurso externo controlado pelo atacante que retorna uma resposta HTTP com o c√≥digo de status `101`. Essa resposta, uma vez recebida pelo backend e encaminhada para o NGINX, engana o proxy a pensar que uma conex√£o Websocket foi estabelecida devido √† valida√ß√£o apenas do c√≥digo de status.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Aviso:** A complexidade dessa t√©cnica aumenta, pois requer a capacidade de interagir com um endpoint capaz de retornar um c√≥digo de status 101.

No final, o NGINX √© enganado a acreditar que uma conex√£o Websocket existe entre o cliente e o backend. Na realidade, essa conex√£o n√£o existe; a API REST de verifica√ß√£o de sa√∫de era o alvo. No entanto, o proxy reverso mant√©m a conex√£o aberta, permitindo ao cliente acessar a API REST privada por meio dela.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

A maioria dos proxies reversos √© vulner√°vel a esse cen√°rio, mas a explora√ß√£o depende da presen√ßa de uma vulnerabilidade externa SSRF, geralmente considerada um problema de baixa gravidade.

#### Laborat√≥rios

Verifique os laborat√≥rios para testar ambos os cen√°rios em [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

### Refer√™ncias

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)


**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao avan√ßado com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
