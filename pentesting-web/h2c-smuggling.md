# Opgradering van Hoofert Smuggling

<details>

<summary><strong>Leer AWS-hacking vanaf nul tot held met</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Ander maniere om HackTricks te ondersteun:

* As jy wil sien dat jou **maatskappy geadverteer word in HackTricks** of **HackTricks aflaai in PDF-formaat**, kyk na die [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Kry die [**amptelike PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ontdek [**The PEASS Family**](https://opensea.io/collection/the-peass-family), ons versameling eksklusiewe [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Sluit aan by die** üí¨ [**Discord-groep**](https://discord.gg/hRep4RUj7f) of die [**telegram-groep**](https://t.me/peass) of **volg** ons op **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Deel jou hacktruuks deur PR's in te dien by die** [**HackTricks**](https://github.com/carlospolop/hacktricks) en [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github-repos.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Vind kwesbaarhede wat die belangrikste is sodat jy hulle vinniger kan regstel. Intruder volg jou aanvals
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Die kwesbaarheid ontstaan wanneer die omgekeerde proxy ophou om individuele versoek te bestuur nadat 'n verbinding opgegradeer is, en aanneem dat sy roete taak voltooi is na die vestiging van die verbinding. Die uitbuiting van H2C Smuggling maak dit moontlik om omseiling van omgekeerde proxy-re√´ls toe te pas tydens versoekverwerking, soos pad-gebaseerde roetes, outentifikasie en WAF-verwerking, op voorwaarde dat 'n H2C-verbinding suksesvol ge√Ønisieer word.

### Kwesbare Proksies <a href="#exploitation" id="exploitation"></a>

Die kwesbaarheid is afhanklik van die hantering van die `Upgrade` en soms `Connection` koppele deur die omgekeerde proxy. Die volgende proksies stuur inherent hierdie koppele deur tydens proxy-pass, en maak dus H2C-smuggling inherente moontlik:

- HAProxy
- Traefik
- Nuster

Daarenteen stuur hierdie dienste nie inherent beide koppele deur tydens proxy-pass nie. Hulle kan egter onveilig gekonfigureer word, wat ongefilterde deurstuur van die `Upgrade` en `Connection` koppele moontlik maak:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### Uitbuiting <a href="#exploitation" id="exploitation"></a>

Dit is belangrik om daarop te let dat nie alle bedieners inherent die koppele stuur wat nodig is vir 'n voldoenende H2C-verbinding opgradering nie. Gevolglik blokkeer bedieners soos AWS ALB/CLB, NGINX en Apache Traffic Server natuurlik H2C-verbindinge. Dit is egter die moeite werd om te toets met die nie-voldoenende `Connection: Upgrade` variant, wat die `HTTP2-Settings` waarde uit die `Connection` kop uitsluit, aangesien sommige agtergronde nie aan die standaarde voldoen nie.

{% hint style="danger" %}
Ongeag die spesifieke **pad** wat in die `proxy_pass` URL aangedui word (bv. `http://backend:9999/socket.io`), word die gevestigde verbinding standaard na `http://backend:9999` omgeskakel. Dit maak dit moontlik om met enige pad binne daardie interne eindpunt te kommunikeer deur van hierdie tegniek gebruik te maak. Gevolglik beperk die spesifikasie van 'n pad in die `proxy_pass` URL nie toegang nie.
{% endhint %}

Die hulpmiddels [**h2csmuggler deur BishopFox**](https://github.com/BishopFox/h2csmuggler) en [**h2csmuggler deur assetnote**](https://github.com/assetnote/h2csmuggler) fasiliteer pogings om **omseiling van proxy-ge√Ømpliseerde beskerming** te bewerkstellig deur 'n H2C-verbinding te vestig, wat toegang tot hulpbronne wat deur die proxy beskerm word, moontlik maak.

Vir aanvullende inligting oor hierdie kwesbaarheid, veral met betrekking tot NGINX, verwys na [**hierdie gedetailleerde bron**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

# Websocket Smuggling

Websocket-smuggling, in teenstelling met die skep van 'n HTTP2-tunnel na 'n eindpunt wat toeganklik is via 'n proxy, vestig 'n Websocket-tunnel om potensi√´le beperkings van die proxy te omseil en direkte kommunikasie met die eindpunt te fasiliteer.

## Scenario 1

In hierdie scenario word 'n agtergrond wat 'n openbare WebSocket API bied saam met 'n ontoeganklike interne REST API, geteiken deur 'n kwaadwillige kli√´nt wat toegang tot die interne REST API wil verkry. Die aanval ontvou in verskeie stappe:

1. Die kli√´nt begin deur 'n Upgrade-versoek na die omgekeerde proxy te stuur met 'n ongeldige `Sec-WebSocket-Version` protokolverse in die kop. Die proxy, wat nie die `Sec-WebSocket-Version` kop valideer nie, aanvaar dat die Upgrade-versoek geldig is en stuur dit na die agtergrond.
2. Die agtergrond reageer met 'n statuskode `426`, wat die ongeldige protokolverse in die `Sec-WebSocket-Version` kop aandui. Die omgekeerde proxy, wat die antwoordstatus van die agtergrond oorsien, aanvaar gereedheid vir WebSocket-kommunikasie en stuur die antwoord na die kli√´nt.
3. Gevolglik word die omgekeerde proxy mislei om te glo dat 'n WebSocket-verbinding tussen die kli√´nt en agtergrond tot stand gebring is, terwyl die agtergrond die Upgrade-versoek eintlik verwerp het. Ten spyte hiervan handhaaf die proxy 'n oop TCP- of TLS-verbinding tussen die kli√´nt en agtergrond, wat die kli√´nt onbeperkte toegang tot die private REST API deur hierdie verbinding moontlik maak.

Kwesbare omgekeerde proksies sluit Varnish in, wat geweier het om die probleem aan te spreek, en Envoy proxy weergawe 1.8.0 of ouer, met latere weergawes wat die opgraderingsmeganisme verander het. Ander proksies mag ook vatbaar wees.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Scenario 2

Hierdie scenario behels 'n agtergrond met beide 'n openbare WebSocket API en 'n openbare REST API vir gesondheidskontrole, saam met 'n ontoeganklike interne REST API. Die aanval, meer kompleks, behels die volgende stappe:

1. Die kli√´nt stuur 'n POST-versoek om die gesondheidskontrole-API te aktiveer, met 'n bykomende HTTP-kop `Upgrade: websocket`. NGINX, wat as die omgekeerde proxy dien, interpreteer dit as 'n standaard Upgrade-versoek gebaseer op slegs die `Upgrade`-kop, en ignoreer die ander aspekte van die versoek, en stuur dit na die agtergrond.
2. Die agtergrond voer die gesondheidskontrole-API uit en maak kontak met 'n eksterne hulpbron wat deur die aanvaller beheer word en 'n HTTP-antwoord met statuskode `101` terugstuur. Hierdie antwoord, sodra dit deur die agtergrond ontvang en na NGINX gestuur word, mislei die proxy om te dink dat 'n WebSocket-verbinding tot stand gebring is as gevolg van sy validasie van slegs die statuskode.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Waarskuwing:** Die kompleksiteit van hierdie tegniek neem toe omdat dit die vermo√´ vereis om met 'n eindpunt te kommunikeer wat 'n statuskode 101 kan terugstuur.

Uiteindelik word NGINX mislei om te glo dat 'n WebSocket-verbinding tussen die kli√´nt en die agtergrond bestaan. In werklikheid bestaan geen sodanige verbinding nie; die gesondheidskontrole REST API was die teiken. Nietemin handhaaf die omgekeerde proxy die verbinding oop, wat die kli√´nt in staat stel om die private REST API daardeur te benader.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

Die meeste omgekeerde proksies is vatbaar vir hierdie scenario, maar
