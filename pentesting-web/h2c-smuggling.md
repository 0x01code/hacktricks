# Upgrade Header Smuggling

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Sicherheitsl√ºcken, damit Sie sie schneller beheben k√∂nnen. Intruder verfolgt Ihre Angriffsfl√§che, f√ºhrt proaktive Bedrohungsscans durch und findet Probleme in Ihrer gesamten Technologie-Stack, von APIs √ºber Webanwendungen bis hin zu Cloud-Systemen. [**Probieren Sie es noch heute kostenlos aus**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks).

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## H2C-Schmuggel <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 √ºber Klartext (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C oder **http2 √ºber Klartext** weicht von der Norm transienter HTTP-Verbindungen ab, indem es eine Standard-HTTP-**Verbindung zu einer dauerhaften Verbindung** aufr√ºstet. Diese aufger√ºstete Verbindung verwendet das http2-Bin√§rprotokoll f√ºr die fortlaufende Kommunikation, im Gegensatz zur einmaligen Anfrage-Natur von Klartext-HTTP.

Das Kernproblem des Schmuggels entsteht durch die Verwendung eines **Reverse-Proxys**. Normalerweise verarbeitet der Reverse-Proxy HTTP-Anfragen und leitet sie an das Backend weiter, wobei er die Antwort des Backends zur√ºckgibt. Wenn jedoch der Header `Connection: Upgrade` in einer HTTP-Anfrage vorhanden ist (was h√§ufig bei WebSocket-Verbindungen der Fall ist), beh√§lt der Reverse-Proxy eine dauerhafte Verbindung zwischen Client und Server bei, um den kontinuierlichen Austausch zu erm√∂glichen, der von bestimmten Protokollen ben√∂tigt wird. F√ºr H2C-Verbindungen erfordert die Einhaltung des RFC das Vorhandensein von drei spezifischen Headern:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Die Schwachstelle tritt auf, wenn der Reverse Proxy nach dem Upgrade einer Verbindung aufh√∂rt, einzelne Anfragen zu verwalten und davon ausgeht, dass seine Aufgabe der Routing nach der Verbindungsherstellung abgeschlossen ist. Durch die Ausnutzung von H2C Smuggling kann die Umgehung von Reverse Proxy-Regeln w√§hrend der Anfrageverarbeitung erm√∂glicht werden, wie z.B. Routing basierend auf dem Pfad, Authentifizierung und WAF-Verarbeitung, vorausgesetzt, dass eine H2C-Verbindung erfolgreich hergestellt wird.

### Anf√§llige Proxies <a href="#exploitation" id="exploitation"></a>

Die Schwachstelle h√§ngt von der Behandlung der `Upgrade`- und manchmal der `Connection`-Header durch den Reverse Proxy ab. Die folgenden Proxies leiten diese Header inh√§rent w√§hrend des Proxy-Passes weiter und erm√∂glichen somit H2C Smuggling:

- HAProxy
- Traefik
- Nuster

Diese Dienste leiten beide Header nicht inh√§rent w√§hrend des Proxy-Passes weiter. Sie k√∂nnen jedoch unsicher konfiguriert sein und eine ungefilterte Weiterleitung der `Upgrade`- und `Connection`-Header erm√∂glichen:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### Ausnutzung <a href="#exploitation" id="exploitation"></a>

Es ist wichtig zu beachten, dass nicht alle Server die f√ºr ein konformes H2C-Verbindungsupgrade erforderlichen Header inh√§rent weiterleiten. Daher blockieren Server wie AWS ALB/CLB, NGINX und Apache Traffic Server nat√ºrlicherweise H2C-Verbindungen. Es ist jedoch sinnvoll, es mit der nicht konformen Variante `Connection: Upgrade` zu testen, bei der der Wert `HTTP2-Settings` aus dem `Connection`-Header ausgeschlossen ist, da einige Backends m√∂glicherweise nicht den Standards entsprechen.

{% hint style="danger" %}
Unabh√§ngig von dem spezifischen **Pfad**, der in der `proxy_pass`-URL angegeben ist (z.B. `http://backend:9999/socket.io`), wird die hergestellte Verbindung standardm√§√üig auf `http://backend:9999` festgelegt. Dadurch ist eine Interaktion mit jedem Pfad innerhalb dieses internen Endpunkts m√∂glich, indem diese Technik genutzt wird. Die Angabe eines Pfads in der `proxy_pass`-URL beschr√§nkt somit nicht den Zugriff.
{% endhint %}

Die Tools [**h2csmuggler von BishopFox**](https://github.com/BishopFox/h2csmuggler) und [**h2csmuggler von assetnote**](https://github.com/assetnote/h2csmuggler) erleichtern den Versuch, durch Herstellung einer H2C-Verbindung Proxy-bedingte Schutzma√ünahmen zu umgehen und somit auf Ressourcen zuzugreifen, die durch den Proxy gesch√ºtzt sind.

F√ºr weitere Informationen zu dieser Schwachstelle, insbesondere zu NGINX, siehe [**diese ausf√ºhrliche Ressource**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

# Websocket Smuggling

Im Gegensatz zur Erstellung eines HTTP2-Tunnels zu einem √ºber einen Proxy erreichbaren Endpunkt wird beim Websocket Smuggling ein Websocket-Tunnel hergestellt, um potenzielle Proxy-Beschr√§nkungen zu umgehen und eine direkte Kommunikation mit dem Endpunkt zu erm√∂glichen.

## Szenario 1

In diesem Szenario wird ein Backend, das eine √∂ffentliche WebSocket-API neben einer nicht zug√§nglichen internen REST-API anbietet, von einem b√∂sartigen Client angegriffen, der Zugriff auf die interne REST-API erhalten m√∂chte. Der Angriff erfolgt in mehreren Schritten:

1. Der Client initiiert den Vorgang, indem er eine Upgrade-Anfrage an den Reverse Proxy sendet und eine falsche `Sec-WebSocket-Version`-Protokollversion im Header angibt. Der Proxy, der den `Sec-WebSocket-Version`-Header nicht validiert, h√§lt die Upgrade-Anfrage f√ºr g√ºltig und leitet sie an das Backend weiter.
2. Das Backend antwortet mit dem Statuscode `426`, der auf die falsche Protokollversion im `Sec-WebSocket-Version`-Header hinweist. Der Reverse Proxy, der den Antwortstatus des Backends √ºbersieht, geht davon aus, dass eine WebSocket-Kommunikation m√∂glich ist, und leitet die Antwort an den Client weiter.
3. Der Reverse Proxy wird irrt√ºmlicherweise dazu verleitet, zu glauben, dass eine WebSocket-Verbindung zwischen dem Client und dem Backend hergestellt wurde, obwohl das Backend die Upgrade-Anfrage abgelehnt hat. Trotzdem unterh√§lt der Proxy eine offene TCP- oder TLS-Verbindung zwischen dem Client und dem Backend, die es dem Client erm√∂glicht, √ºber diese Verbindung uneingeschr√§nkten Zugriff auf die private REST-API zu erhalten.

Betroffene Reverse Proxies sind Varnish, die sich weigerten, das Problem anzugehen, und Envoy Proxy Version 1.8.0 oder √§lter, wobei sp√§tere Versionen den Upgrade-Mechanismus ge√§ndert haben. Andere Proxies k√∂nnen ebenfalls anf√§llig sein.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Szenario 2

Dieses Szenario betrifft ein Backend mit einer √∂ffentlichen WebSocket-API und einer √∂ffentlichen REST-API zur √úberpr√ºfung der Gesundheit sowie einer nicht zug√§nglichen internen REST-API. Der komplexere Angriff umfasst die folgenden Schritte:

1. Der Client sendet eine POST-Anfrage, um die Health Check-API auszul√∂sen, und f√ºgt einen zus√§tzlichen HTTP-Header `Upgrade: websocket` hinzu. NGINX, der als Reverse Proxy fungiert, interpretiert dies als standardm√§√üige Upgrade-Anfrage, basierend ausschlie√ülich auf dem `Upgrade`-Header, und vernachl√§ssigt die anderen Aspekte der Anfrage, und leitet sie an das Backend weiter.
2. Das Backend f√ºhrt die Health Check-API aus und greift auf eine vom Angreifer kontrollierte externe Ressource zu, die eine HTTP-Antwort mit dem Statuscode `101` zur√ºckgibt. Diese Antwort t√§uscht den Proxy, nachdem sie vom Backend empfangen und an NGINX weitergeleitet wurde, dazu, dass eine WebSocket-Verbindung aufgrund der Validierung nur des Statuscodes hergestellt wurde.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Warnung:** Die Komplexit√§t dieser Technik steigt, da sie die F√§higkeit erfordert, mit einem Endpunkt zu interagieren, der einen Statuscode 101 zur√ºckgeben kann.

Letztendlich wird NGINX dazu gebracht, zu glauben, dass eine WebSocket-Verbindung zwischen dem Client und dem Backend besteht. In Wirklichkeit besteht keine solche Verbindung; die Ziel war die Health Check REST-API. Dennoch h√§lt der Reverse Proxy die Verbindung offen und erm√∂glicht es dem Client, √ºber sie auf die private REST-API zuzugreifen.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

Die meisten Reverse Proxies sind anf√§llig f√ºr dieses Szenario, aber die Ausnutzung h√§ngt von einer externen SSRF-Schwachstelle ab, die in der Regel als geringf√ºgiges Problem angesehen wird.

### Labs

√úberpr√ºfen Sie die Labs, um beide Szenarien unter [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git) zu testen.

## Referenzen

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Finden Sie die wichtigsten Schwachstellen, damit Sie sie schneller beheben k√∂nnen. Intruder √ºberwacht Ihre An
