# Yükseltme Başlığı Smuggling

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahramanla öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong>!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* **Şirketinizi HackTricks'te reklamını görmek isterseniz** veya **HackTricks'i PDF olarak indirmek isterseniz** [**ABONELİK PLANLARINA**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'ı takip edin**.
* **Hacking hilelerinizi paylaşarak** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github reposuna **PR gönderin**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

En önemli olan zayıflıkları bulun, böylece daha hızlı düzeltebilirsiniz. Intruder saldırı yüzeyinizi takip eder, proaktif tehdit taramaları yapar, API'lerden web uygulamalarına ve bulut sistemlerine kadar tüm teknoloji yığınınızda sorunları bulur. [**Ücretsiz deneyin**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) bugün.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### Açık Metin Üzerinden HTTP2 (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

H2C veya **açık metin üzerinden http2**, geçici HTTP bağlantılarının normundan saparak standart bir HTTP bağlantısını sürekli bir bağlantıya yükseltir. Bu yükseltilmiş bağlantı, düz metin HTTP'nin tek istekli doğasının aksine, sürekli iletişim için http2 ikili protokolünü kullanır.

Smuggling sorunu, bir **ters proxy** kullanımıyla ortaya çıkar. Normalde, ters proxy HTTP isteklerini işler ve arka uca ileterek ardından arka uç yanıtını döndürür. Ancak, bir HTTP isteğinde (`Connection: Upgrade` başlığı genellikle websocket bağlantılarıyla görülür) `Connection: Upgrade` başlığı bulunduğunda, ters **proxy istemci ve sunucu arasında sürekli bir bağlantı** sağlayarak belirli protokollerin gerektirdiği sürekli değişimi kolaylaştırır. H2C bağlantıları için, RFC'ye uyum, üç belirli başlığın varlığını gerektirir:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Zafiyet, bir bağlantıyı yükselttikten sonra ters proxy'nin bireysel istekleri yönetmeyi bırakması durumunda ortaya çıkar ve yönlendirme işleminin bağlantı kurulduktan sonra tamamlandığını varsayar. H2C Smuggling'i sömürmek, başarılı bir H2C bağlantısı başlatıldığında, istek işleme sırasında ters proxy tarafından uygulanan kuralları, yani yol tabanlı yönlendirme, kimlik doğrulama ve WAF işleme gibi kuralları atlamayı sağlar.

### Zafiyetli Proxy'ler <a href="#exploitation" id="exploitation"></a>

Zafiyet, ters proxy'nin `Upgrade` ve bazen `Connection` başlıklarını nasıl işlediğine bağlıdır. Aşağıdaki proxy'ler, proxy geçişi sırasında bu başlıkları doğal olarak ileterek H2C smuggling'i etkinleştirir:

- HAProxy
- Traefik
- Nuster

Bununla birlikte, aşağıdaki hizmetler, `Upgrade` ve `Connection` başlıklarını doğal olarak iletmemektedir. Bununla birlikte, bunlar güvensiz bir şekilde yapılandırılabilir ve `Upgrade` ve `Connection` başlıklarının filtresiz bir şekilde iletilmesine izin verebilir:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### Sömürü <a href="#exploitation" id="exploitation"></a>

Bir uyumlu H2C bağlantısı yükseltmek için gereken başlıkları doğal olarak ileten tüm sunucuların olmadığını unutmamak önemlidir. Bu nedenle, AWS ALB/CLB, NGINX ve Apache Traffic Server gibi sunucuların H2C bağlantılarını engellediğini unutmamak önemlidir. Bununla birlikte, standartlara uymayan `Connection: Upgrade` varyantıyla test etmek de faydalı olabilir, çünkü bazı arka uçlar standartlara uymayabilir.

{% hint style="danger" %}
`proxy_pass` URL'sinde belirtilen belirli bir **yol** (örneğin, `http://backend:9999/socket.io`) göz ardı edilir ve kurulan bağlantı varsayılan olarak `http://backend:9999` olarak kabul edilir. Bu, bu teknikten yararlanarak iç uç noktadaki herhangi bir yola etkileşim sağlar. Sonuç olarak, `proxy_pass` URL'sinde bir yol belirtmek erişimi sınırlamaz.
{% endhint %}

[**h2csmuggler by BishopFox**](https://github.com/BishopFox/h2csmuggler) ve [**h2csmuggler by assetnote**](https://github.com/assetnote/h2csmuggler) araçları, H2C bağlantısı kurarak proxy tarafından uygulanan korumaları atlamaya yönelik girişimleri kolaylaştırır ve bu sayede proxy tarafından korunan kaynaklara erişim sağlar.

NGINX hakkında daha fazla bilgi için [**bu ayrıntılı kaynağa**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection) başvurun.

# Websocket Smuggling

Websocket smuggling, bir proxy üzerinden erişilebilen bir uca bir HTTP2 tüneli oluşturmanın aksine, bir Websocket tüneli oluşturarak potansiyel proxy sınırlamalarını atlamayı ve uca doğrudan iletişim sağlamayı amaçlar.

## Senaryo 1

Bu senaryoda, erişilemeyen bir iç REST API yanında halka açık bir WebSocket API sunan bir arka uç, iç REST API'ye erişim sağlamak isteyen kötü niyetli bir istemci tarafından hedef alınır. Saldırı aşağıdaki adımlarla gerçekleşir:

1. İstemci, başlıkta yanlış bir `Sec-WebSocket-Version` protokol sürümü ile birlikte bir Yükseltme isteği göndererek başlar. Proxy, `Sec-WebSocket-Version` başlığını doğrulayamadığı için Yükseltme isteğini geçerli olarak kabul eder ve arka uca iletilir.
2. Arka uç, `Sec-WebSocket-Version` başlığındaki yanlış protokol sürümünü belirten `426` durum koduyla yanıt verir. Ters proxy, arka uç yanıt durumunu göz ardı ederek WebSocket iletişimi için hazır olduğunu varsayar ve yanıtı istemciye ileterek yanıltılır.
3. Sonuç olarak, ters proxy, istemci ve arka uç arasında bir WebSocket bağlantısı kurulduğuna inanırken, aslında arka uç Yükseltme isteğini reddetmiştir. Bununla birlikte, proxy, istemci ve arka uç arasında açık bir TCP veya TLS bağlantısı korur ve istemcinin bu bağlantı üzerinden özel REST API'ye sınırsız erişim sağlamasına olanak tanır.

Etkilenen ters proxy'ler arasında Varnish, sorunu ele almamıştır ve Envoy proxy'nin 1.8.0 veya daha eski sürümleri, daha sonraki sürümlerde yükseltme mekanizmasını değiştirdiği için etkilenir. Diğer proxy'ler de etkilenebilir.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

## Senaryo 2

Bu senaryo, halka açık bir WebSocket API ve sağlık kontrolü için halka açık bir REST API'ye sahip bir arka uç ile erişilemeyen bir iç REST API'ye sahip bir arka uç içerir. Daha karmaşık olan saldırı aşağıdaki adımları içerir:

1. İstemci, bir POST isteği göndererek sağlık kontrolü API'sini tetikler ve ek bir HTTP başlığı olan `Upgrade: websocket`'i içerir. Ters proxy olarak hizmet veren NGINX, yalnızca `Upgrade` başlığına dayanarak bu isteği standart bir Yükseltme isteği olarak yorumlar ve isteğin diğer yönlerini göz ardı eder ve arka uca iletilir.
2. Arka uç, sağlık kontrolü API'sini yürütürken, saldırgan tarafından kontrol edilen bir dış kaynağa ulaşan bir HTTP yanıtıyla `101` durum kodunu döndürür. Bu yanıt, arka uç tarafından alındığında ve NGINX'e iletilirken, yalnızca durum kodunu doğruladığı için proxy'yi WebSocket bağlantısı kurulmuş gibi yanıltır.

![https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

> **Uyarı:** Bu teknik, bir status kodu 101 döndürebilen bir uca etkileşim sağlama yeteneğini gerektirdiği için karmaşıklığı artırır.

Sonuç olarak, NGINX, istemci ve arka uç arasında bir WebSocket bağlantısı olduğuna inanır. Aslında böyle bir bağlantı yoktur; sağlık kontrolü REST API'si hedef alınmıştır. Bununla birlikte, ters proxy bağlantıyı açık tutar ve istemcinin bu bağlantı üzerinden özel REST API'ye er
