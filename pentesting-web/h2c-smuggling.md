# Upgrade de Header Smuggling

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, desde APIs at√© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## H2C Smuggling <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 Sobre Texto Limpo (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

Uma conex√£o HTTP normalmente dura apenas durante a dura√ß√£o de uma √∫nica solicita√ß√£o. No entanto, H2C ou "**http2 sobre texto limpo**" √© onde uma conex√£o http transit√≥ria normal √© atualizada para uma conex√£o persistente que usa o protocolo bin√°rio http2 para se comunicar continuamente em vez de uma solicita√ß√£o usando o protocolo http em texto simples.

A segunda parte do smuggling ocorre quando um **proxy reverso √© usado**. Normalmente, quando solicita√ß√µes http s√£o feitas a um proxy reverso, o proxy lidar√° com a solicita√ß√£o, processar√° uma s√©rie de regras de roteamento e, em seguida, encaminhar√° a solicita√ß√£o para o backend e retornar√° a resposta. Quando uma solicita√ß√£o http inclui um cabe√ßalho `Connection: Upgrade`, como para uma conex√£o websocket, o proxy reverso manter√° a conex√£o persistente entre o cliente e o servidor, permitindo a comunica√ß√£o cont√≠nua necess√°ria para esses protocolos. Para uma conex√£o H2C, o RFC requer que 3 cabe√ßalhos estejam presentes:
```
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Ent√£o, onde est√° o bug? **Ao atualizar uma conex√£o, o proxy reverso geralmente para de lidar com solicita√ß√µes individuais**, assumindo que, uma vez estabelecida a conex√£o, seu trabalho de roteamento est√° conclu√≠do. Usando o H2C Smuggling, podemos contornar as regras que um proxy reverso usa ao processar solicita√ß√µes, como roteamento baseado em caminho, autentica√ß√£o ou processamento do WAF, desde que possamos estabelecer uma conex√£o H2C primeiro.

![](<../.gitbook/assets/image (454).png>)

### Proxies Vulner√°veis <a href="#exploitation" id="exploitation"></a>

Observe na explica√ß√£o da vulnerabilidade que o servidor proxy precisa **encaminhar o cabe√ßalho Upgrade**, e √†s vezes o **cabe√ßalho Connection** tamb√©m precisa ser encaminhado com sucesso.

Por padr√£o, os seguintes servi√ßos **encaminham** os cabe√ßalhos **Upgrade** e **Connection** durante o proxy-pass, permitindo assim o h2c smuggling "out-of-the-box":

* HAProxy
* Traefik
* Nuster

Por padr√£o, esses servi√ßos **n√£o** encaminham ambos os cabe√ßalhos Upgrade e Connection durante o proxy-pass, mas **podem ser configurados de maneira insegura** (passando cabe√ßalhos Upgrade e Connection n√£o filtrados):

* AWS ALB/CLB
* NGINX
* Apache
* Squid
* Varnish
* Kong
* Envoy
* Apache Traffic Server

### Explora√ß√£o <a href="#exploitation" id="exploitation"></a>

A postagem original do blog aponta que nem todos os servidores encaminhar√£o os cabe√ßalhos necess√°rios para uma atualiza√ß√£o de conex√£o H2C compat√≠vel. Isso significa que balanceadores de carga como AWS ALB/CLB, NGINX e Apache Traffic Server, entre outros, **impedir√£o uma conex√£o H2C por padr√£o**. No entanto, no final da postagem do blog, ele menciona que "nem todos os backends eram compat√≠veis, e n√≥s poder√≠amos **testar com a variante n√£o compat√≠vel `Connection: Upgrade`, onde o valor `HTTP2-Settings` √© omitido** do cabe√ßalho `Connection`."

{% hint style="danger" %}
Observe que, mesmo que a URL `proxy_pass` (o ponto final para o qual o proxy encaminha a conex√£o) esteja apontando para um **caminho** espec√≠fico, como `http://backend:9999/socket.io`, a conex√£o ser√° estabelecida com `http://backend:9999`, portanto, voc√™ pode **acessar qualquer outro caminho dentro desse ponto final interno abusando dessa t√©cnica. Portanto, n√£o importa se um caminho √© especificado na URL do proxy\_pass.**
{% endhint %}

Usando as ferramentas [**https://github.com/BishopFox/h2csmuggler**](https://github.com/BishopFox/h2csmuggler) **e** [**https://github.com/assetnote/h2csmuggler**](https://github.com/assetnote/h2csmuggler), voc√™ pode tentar **burlar as prote√ß√µes impostas** pelo proxy estabelecendo uma conex√£o H2C e acessar recursos protegidos pelo proxy.

Siga este link para [**mais informa√ß√µes sobre essa vulnerabilidade no Nginx**](../network-services-pentesting/pentesting-web/nginx.md#proxy\_set\_header-upgrade-and-connection).

## Websocket Smuggling

Semelhante √† t√©cnica anterior, esta **em vez de criar um t√∫nel HTTP2** para um ponto final acess√≠vel por meio de um proxy, criar√° um **t√∫nel Websocket** para o mesmo prop√≥sito, **contornando as limita√ß√µes potenciais dos proxies** e se comunicando diretamente com o ponto final:

![](<../.gitbook/assets/image (651) (2) (1).png>)

### Cen√°rio 1

Temos um backend que exp√µe uma **API WebSocket p√∫blica** e tamb√©m possui uma **API REST interna n√£o dispon√≠vel** externamente. Um cliente malicioso deseja acessar a API REST interna.

No **primeiro** passo, o cliente envia uma **solicita√ß√£o de atualiza√ß√£o** para o proxy reverso, mas com uma **vers√£o de protocolo incorreta** no cabe√ßalho `Sec-WebSocket-Version`. O **proxy** n√£o valida o cabe√ßalho `Sec-WebSocket-Version` e acredita que a **solicita√ß√£o de atualiza√ß√£o est√° correta**. Em seguida, ele traduz a solicita√ß√£o para o backend.

No segundo passo, o backend envia uma **resposta com o c√≥digo de status `426` porque a vers√£o do protocolo est√° incorreta** no cabe√ßalho `Sec-WebSocket-Version`. No entanto, o **proxy reverso n√£o verifica** suficientemente a resposta do backend (incluindo o c√≥digo de status) e **acredita que o backend est√° pronto para a comunica√ß√£o WebSocket**. Em seguida, ele traduz a solicita√ß√£o para o cliente.

Por fim, o **proxy reverso acredita** que a **conex√£o WebSocket est√° estabelecida entre o cliente e o backend**. Na realidade, n√£o h√° conex√£o WebSocket - o backend recusou a solicita√ß√£o de atualiza√ß√£o. Ao mesmo tempo, o proxy mant√©m a conex√£o TCP ou TLS entre o cliente e o backend aberta. O **cliente pode facilmente acessar a API REST privada enviando uma solicita√ß√£o HTTP pela conex√£o**.

![](https://github.com/0ang3el/websocket-smuggle/raw/master/img/2-4.png)

Foi constatado que os seguintes proxies reversos s√£o afetados:

* Varnish - a equipe se recusou a corrigir o problema descrito.
* Envoy proxy 1.8.0 (ou anterior) - nas vers√µes mais recentes, o mecanismo de atualiza√ß√£o foi alterado.
* Outros - A ser anunciado.

### Cen√°rio 2

A maioria dos proxies reversos (por exemplo, NGINX) **verifica o c√≥digo de status do backend** durante a parte de handshake. Isso torna o ataque mais dif√≠cil, mas n√£o imposs√≠vel.

Vamos observar o segundo cen√°rio. Temos um backend que exp√µe uma API WebSocket p√∫blica e uma API REST p√∫blica para verifica√ß√£o de integridade e tamb√©m possui uma **API REST interna n√£o dispon√≠vel externamente**. Um cliente malicioso deseja acessar a API REST interna. O NGINX √© usado como proxy reverso. A API WebSocket est√° dispon√≠vel no caminho `/api/socket.io/` e a API de verifica√ß√£o de integridade no caminho `/api/health`.

A API de verifica√ß√£o de integridade √© invocada enviando uma solicita√ß√£o POST, o par√¢metro com o nome `u` controla a URL. O backend alcan√ßa um recurso externo e retorna o c√≥digo de status de volta para o cliente.

No **primeiro** passo, o cliente envia uma solicita√ß√£o POST para invocar a **API de verifica√ß√£o de integridade, mas com um cabe√ßalho HTTP adicional `Upgrade: websocket`**. O NGINX acredita que √© uma **solicita√ß√£o de atualiza√ß√£o normal**, ele verifica apenas o cabe√ßalho `Upgrade`, ignorando outras partes da solicita√ß√£o. Em seguida, o proxy traduz a solicita√ß√£o para o backend.

No **segundo** passo, o backend invoca a API de verifica√ß√£o de integridade. Ele alcan√ßa um recurso externo controlado por usu√°rios maliciosos que retorna uma **resposta HTTP com o c√≥digo de status `101`**. O backend traduz essa resposta para o proxy reverso. Como o NGINX valida apenas o c√≥digo de status, **ele acreditar√° que o backend est√° pronto para a comunica√ß√£o WebSocket**. Em seguida, ele traduz a solicita√ß√£o para o cliente.

![](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-4.png)

{% hint style="warning" %}
Observe como esse cen√°rio √© muito mais complexo de explorar, pois voc√™ precisa ser capaz de entrar em contato com algum ponto final que **retorne o c√≥digo de status 101**.
{% endhint %}

Finalmente, o **NGINX acredita que a conex√£o WebSocket est√° estabelecida entre o cliente e o backend**. Na realidade, n√£o h√° conex√£o WebSocket - a API REST de verifica√ß√£o de integridade foi invocada no backend. Ao mesmo tempo, o proxy reverso mant√©m a conex√£o TCP ou TLS entre o cliente e o backend aberta. O **cliente pode facilmente acessar a API REST privada enviando uma solicita√ß√£o HTTP pela conex√£o**.

![](https://github.com/0ang3el/websocket-smuggle/raw/master/img/3-5.png)

A maioria dos proxies reversos deve ser afetada por esse cen√°rio. No entanto, a explora√ß√£o requer a exist√™ncia de uma vulnerabilidade externa de SSRF (geralmente considerada um problema de baixa gravidade).
### Laborat√≥rios

Verifique os laborat√≥rios para testar ambos os cen√°rios em [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

## Refer√™ncias

* [https://blog.assetnote.io/2021/03/18/h2c-smuggling/](https://blog.assetnote.io/2021/03/18/h2c-smuggling/)
* [https://bishopfox.com/blog/h2c-smuggling-request](https://bishopfox.com/blog/h2c-smuggling-request)
* [https://github.com/0ang3el/websocket-smuggle.git](https://github.com/0ang3el/websocket-smuggle.git)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que s√£o mais importantes para que voc√™ possa corrigi-las mais rapidamente. O Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha de tecnologia, desde APIs at√© aplicativos da web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!

- Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)

- **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Compartilhe seus truques de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [reposit√≥rio hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
