# Αναβάθμιση Απάτης Κεφαλίδας

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Βρείτε ευπάθειες που έχουν μεγαλύτερη σημασία, ώστε να μπορείτε να τις διορθώσετε πιο γρήγορα. Το Intruder παρακολουθεί την επιθετική επιφάνεια σας, εκτελεί προληπτικές απειλητικές αναζητήσεις, εντοπίζει προβλήματα σε ολόκληρο το τεχνολογικό σας στοίβα, από APIs έως web εφαρμογές και συστήματα στο cloud. [**Δοκιμάστε το δωρεάν**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) σήμερα.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## H2C Απάτη <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

### HTTP2 Πάνω από Καθαρό Κείμενο (H2C) <a href="#http2-over-cleartext-h2c" id="http2-over-cleartext-h2c"></a>

Το H2C, ή **http2 πάνω από καθαρό κείμενο**, αποκλίνει από τον κανόνα των προσωρινών συνδέσεων HTTP αναβαθμίζοντας μια τυπική σύνδεση HTTP σε μια μόνιμη. Αυτή η αναβαθμισμένη σύνδεση χρησιμοποιεί το δυαδικό πρωτόκολλο http2 για τη συνεχή επικοινωνία, αντί για τη μονοαίτητη φύση του καθαρού HTTP.

Το πρόβλημα της απάτης προκύπτει με τη χρήση ενός **αντίστροφου διακομιστή**. Συνήθως, ο αντίστροφος διακομιστής επεξεργάζεται και προωθεί τα αιτήματα HTTP στον πίσω μέρος, επιστρέφοντας την απάντηση του πίσω μέρους μετά από αυτό. Ωστόσο, όταν η κεφαλίδα `Connection: Upgrade` είναι παρούσα σε ένα αίτημα HTTP (συνηθίζεται να βλέπεται με συνδέσεις websocket), ο αντίστροφος διακομιστής διατηρεί μια μόνιμη σύνδεση μεταξύ πελάτη και διακομιστή, διευκολύνοντας τη συνεχή ανταλλαγή που απαιτείται από ορισμένα πρωτόκολλα. Για τις συνδέσεις H2C, η συμμόρφωση με το RFC απαιτεί την παρουσία τριών συγκεκριμένων κεφαλίδων:
``` 
Upgrade: h2c
HTTP2-Settings: AAMAAABkAARAAAAAAAIAAAAA
Connection: Upgrade, HTTP2-Settings
```
Η ευπάθεια προκύπτει όταν, μετά την αναβάθμιση μιας σύνδεσης, ο αντίστροφος διαμεσολαβητής σταματά να διαχειρίζεται τα μεμονωμένα αιτήματα, υποθέτοντας ότι η δρομολόγηση του έχει ολοκληρωθεί μετά την εγκαθίδρυση της σύνδεσης. Η εκμετάλλευση του H2C Smuggling επιτρέπει την παράκαμψη των κανόνων του αντίστροφου διαμεσολαβητή που εφαρμόζονται κατά την επεξεργασία των αιτημάτων, όπως η δρομολόγηση βάσει διαδρομής, η πιστοποίηση και η επεξεργασία WAF, υποθέτοντας ότι μια σύνδεση H2C έχει εγκατασταθεί με επιτυχία.

### Ευπάθεια των Διαμεσολαβητών <a href="#exploitation" id="exploitation"></a>

Η ευπάθεια εξαρτάται από τον τρόπο που ο αντίστροφος διαμεσολαβητής χειρίζεται τους κεφαλίδες `Upgrade` και, μερικές φορές, `Connection`. Οι ακόλουθοι διαμεσολαβητές προωθούν από μόνοι τους αυτές τις κεφαλίδες κατά τη διέλευση του διαμεσολαβητή, επιτρέποντας έτσι αυτόματα το H2C smuggling:

- HAProxy
- Traefik
- Nuster

Αντίθετα, αυτές οι υπηρεσίες δεν προωθούν από μόνες τους και τις δύο κεφαλίδες κατά τη διέλευση του διαμεσολαβητή. Ωστόσο, μπορεί να έχουν ρυθμιστεί με ανασφάλεια, επιτρέποντας την ανεξέλεγκτη προώθηση των κεφαλίδων `Upgrade` και `Connection`:

- AWS ALB/CLB
- NGINX
- Apache
- Squid
- Varnish
- Kong
- Envoy
- Apache Traffic Server

### Εκμετάλλευση <a href="#exploitation" id="exploitation"></a>

Είναι σημαντικό να σημειωθεί ότι όχι όλοι οι διακομιστές προωθούν από μόνοι τους τις κεφαλίδες που απαιτούνται για μια συμμορφωμένη αναβάθμιση σύνδεσης H2C. Για τον λόγο αυτό, διακομιστές όπως οι AWS ALB/CLB, NGINX και Apache Traffic Server, μεταξύ άλλων, φράζουν φυσικά τις συνδέσεις H2C. Ωστόσο, αξίζει να δοκιμάσετε τη μη συμμορφούμενη παραλλαγή `Connection: Upgrade`, η οποία παραλείπει την τιμή `HTTP2-Settings` από την κεφαλίδα `Connection`, καθώς ορισμένα πίσω άκρα ενδέχεται να μην συμμορφώνονται με τα πρότυπα.

{% hint style="danger" %}
Ανεξάρτητα από τη συγκεκριμένη **διαδρομή** που έχει καθοριστεί στο URL `proxy_pass` (π.χ. `http://backend:9999/socket.io`), η εγκατεστημένη σύνδεση προεπιλέγει το `http://backend:9999`. Αυτό επιτρέπει την αλληλεπίδραση με οποιαδήποτε διαδρομή εντός αυτού του εσωτερικού σημείου πρόσβασης, εκμεταλλευόμενος αυτήν την τεχνική. Ως εκ τούτου, η καθορισμένη διαδρομή στο URL `proxy_pass` δεν περιορίζει την πρόσβαση.
{% endhint %}

Τα εργαλεία [**h2csmuggler από την BishopFox**](https://github.com/BishopFox/h2csmuggler) και [**h2csmuggler από την assetnote**](https://github.com/assetnote/h2csmuggler) διευκολύνουν τις προσπάθειες για **παράκαμψη των προστασιών που επιβάλλονται από τον διαμεσολαβητή** με την εγκαθίδρυση μιας σύνδεσης H2C, επιτρέποντας έτσι την πρόσβαση σε πόρους που προστατεύονται από τον διαμεσολαβητή.

Για περισσότερες πληροφορίες σχετικά
