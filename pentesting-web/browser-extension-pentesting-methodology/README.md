# Metodolojia ya Kupima Usalama wa Programu-jalizi ya Kivinjari

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka mwanzo hadi kuwa bingwa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako ikionekana kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

## Taarifa Msingi

Programu-jalizi za kivinjari zimeandikwa kwa JavaScript na hulipwa na kivinjari kwa nyuma. Ina [DOM](https://www.w3schools.com/js/js\_htmldom.asp) yake lakini inaweza kuingiliana na DOM za tovuti nyingine. Hii inamaanisha kuwa inaweza kuhatarisha usiri, uadilifu, na upatikanaji (CIA) wa tovuti nyingine.

## Sehemu Kuu

Muundo wa programu-jalizi unapendeza zaidi wakati unavyoonekana na una sehemu tatu. Hebu tuchunguze kila sehemu kwa undani.

<figure><img src="../../.gitbook/assets/image (4).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Vielezo vya Yaliyomo**

Kila vielezo vya yaliyomo vina ufikiaji wa moja kwa moja kwa DOM ya **ukurasa mmoja wa wavuti** na hivyo kuwekwa wazi kwa **ingizo hatari**. Walakini, vielezo vya yaliyomo havina ruhusa nyingine isipokuwa uwezo wa kutuma ujumbe kwa msingi wa programu-jalizi.

### **Msingi wa Programu-jalizi**

Msingi wa programu-jalizi una ruhusa / ufikiaji mwingi zaidi, lakini msingi wa programu-jalizi unaweza kuingiliana na maudhui ya wavuti kupitia [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) na vielezo vya yaliyomo. Pia, msingi wa programu-jalizi hauna ufikiaji wa moja kwa moja kwa kompyuta mwenyeji.

### **Binary ya Asili**

Programu-jalizi inaruhusu binary ya asili ambayo inaweza **kupata kompyuta mwenyeji kwa ruhusa kamili za mtumiaji.** Binary ya asili inashirikiana na msingi wa programu-jalizi kupitia kiolesura cha programu ya Netscape Plugin ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) kinachotumiwa na Flash na programu-jalizi zingine za kivinjari.

### Mipaka

{% hint style="danger" %}
Ili kupata ruhusa kamili za mtumiaji, mshambuliaji lazima awashawishi programu-jalizi kupitisha kuingiza hatari kutoka kwa vielezo vya yaliyomo hadi msingi wa programu-jalizi na kutoka kwa msingi wa programu-jalizi hadi binary ya asili.
{% endhint %}

Kila sehemu ya programu-jalizi imegawanywa kutoka kwa sehemu nyingine kwa **mipaka madhubuti ya kinga**. Kila sehemu inaendeshwa katika **mchakato tofauti wa mfumo wa uendeshaji**. Vielezo vya yaliyomo na msingi wa programu-jalizi hufanya kazi katika **mchakato wa mchanga** usiopatikana kwa huduma nyingi za mfumo wa uendeshaji.

Zaidi ya hayo, vielezo vya yaliyomo hufanya kazi tofauti na kurasa za wavuti zinazohusiana kwa **kuendesha katika kumbukumbu tofauti ya JavaScript**. Vielezo vya yaliyomo na kurasa za wavuti zina **ufikiaji sawa wa DOM ya msingi**, lakini **hazibadilishani pointi za JavaScript**, kuzuia kuvuja kwa utendaji wa JavaScript.

## **`manifest.json`**

Programu-jalizi ya Chrome ni saraka ya ZIP tu na kipengele cha faili ya [.crx](https://www.lifewire.com/crx-file-2620391). Msingi wa programu-jalizi ni faili ya **`manifest.json`** kwenye mizizi ya saraka, ambayo inaonyesha muundo, ruhusa, na chaguzi zingine za usanidi.

Mfano:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Vitini vya maudhui hulipwa wakati wowote mtumiaji anapoelekea kwenye ukurasa unaofanana, katika kesi yetu ukurasa wowote unaofanana na **`https://example.com/*`** na usiofanana na **`*://*/*/business*`**. Vitini hivi hutekelezwa kama skripti za ukurasa yenyewe na vina ufikiaji usio na kikomo kwenye [Modeli ya Vitu vya Nyaraka (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) ya ukurasa.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Ili kuongeza au kuondoa URL zaidi, ni pia inawezekana kutumia **`include_globs`** na **`exclude_globs`**.

Hii ni skripti ya maudhui ya mfano ambayo itaongeza kitufe cha kuelezea kwenye ukurasa wakati [API ya uhifadhi](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) inatumika kupata thamani ya `message` kutoka kwenye uhifadhi wa kipengele.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Ujumbe hutumwa kwenye kurasa za nyongeza na skripti ya yaliyomo wakati kifungo hiki kinapobonyezwa, kupitia matumizi ya [**runtime.sendMessage() API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Hii ni kutokana na kikomo cha skripti ya yaliyomo katika upatikanaji wa moja kwa moja kwa APIs, na `storage` ikiwa miongoni mwa ubaguzi chache. Kwa utendaji zaidi ya ubaguzi huu, ujumbe hutumwa kwenye kurasa za nyongeza ambazo skripti za yaliyomo zinaweza kuwasiliana nazo.

{% hint style="warning" %}
Kulingana na kivinjari, uwezo wa skripti ya yaliyomo unaweza kutofautiana kidogo. Kwa vivinjari vilivyotegemea Chromium, orodha ya uwezo inapatikana katika [Hati za Chrome Developers](https://developer.chrome.com/docs/extensions/mv3/content_scripts/#capabilities), na kwa Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#webextension_apis) inatumika kama chanzo kikuu.\
Pia ni muhimu kutambua kuwa skripti za yaliyomo zina uwezo wa kuwasiliana na skripti za msingi, kuruhusu kufanya vitendo na kuwasilisha majibu.
{% endhint %}

Kwa kuangalia na kurekebisha skripti za yaliyomo kwenye Chrome, menyu ya zana za maendeleo ya Chrome inaweza kupatikana kutoka Chaguo > Zana zaidi > Zana za maendeleo AU kwa kubonyeza Ctrl + Shift + I.

Baada ya zana za maendeleo kuonyeshwa, **Tab ya Chanzo** inapaswa kubonyezwa, ikifuatiwa na **Tab ya Skripti za Yaliyomo**. Hii inaruhusu uangalizi wa skripti za yaliyomo zinazoendesha kutoka kwa nyongeza mbalimbali na kuweka alama za kusimamisha ili kufuatilia mwendelezo wa utekelezaji.

### Skripti za yaliyomo zilizowekwa

{% hint style="success" %}
Tafadhali kumbuka kuwa **Skripti za Yaliyomo sio lazima** kwani pia ni **inawezekana** **kuweka** skripti kwa njia ya **kudumu** na **kuweka** skripti kwa njia ya **programu** kwenye kurasa za wavuti kupitia **`tabs.executeScript`**. Hii kwa kweli hutoa **udhibiti wa kina** zaidi.
{% endhint %}

Kwa kuweka skripti kwa njia ya programu, nyongeza inahitaji [ruhusa ya mwenyeji](https://developer.chrome.com/docs/extensions/reference/permissions) kwa ukurasa ambao skripti hizo zitawekwa. Ruhusa hizi zinaweza kuhakikishwa kwa **kuomba** katika hati ya nyongeza au kwa muda kupitia [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Mfano wa nyongeza inayotegemea activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Ingiza faili ya JS kwa kubonyeza:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Ingiza kazi** kwa kubonyeza:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Mfano na ruhusa za kutekeleza script

In this example, we will explore how to exploit browser extensions that have scripting permissions. These extensions allow the execution of custom scripts on web pages, which can be leveraged for various attacks.

Katika mfano huu, tutachunguza jinsi ya kutumia upanuzi wa kivinjari ambao una ruhusa za kutekeleza script. Upangishaji huu unaruhusu utekelezaji wa script za desturi kwenye kurasa za wavuti, ambazo zinaweza kutumiwa kwa mashambulizi mbalimbali.

1. First, we need to identify the browser extension that has scripting permissions. This can be done by inspecting the browser's extension settings or by analyzing the extension's manifest file.

   Kwanza, tunahitaji kutambua upanuzi wa kivinjari ambao una ruhusa za kutekeleza script. Hii inaweza kufanywa kwa kuchunguza mipangilio ya upanuzi wa kivinjari au kwa kuchambua faili ya manifesto ya upanuzi.

2. Once we have identified the target extension, we can start analyzing its functionality and potential vulnerabilities. This can be done by reverse engineering the extension's code or by using static analysis tools.

   Mara tu tukitambua upanuzi wa lengo, tunaweza kuanza kuchambua utendaji wake na udhaifu unaowezekana. Hii inaweza kufanywa kwa kurekebisha upya kanuni ya upanuzi au kwa kutumia zana za uchambuzi wa tuli.

3. After identifying a potential vulnerability, we can proceed with exploiting it. This may involve crafting a malicious script that takes advantage of the extension's functionality to perform unauthorized actions or gain access to sensitive information.

   Baada ya kutambua udhaifu unaowezekana, tunaweza kuendelea kutekeleza shambulizi. Hii inaweza kuhusisha kutengeneza script mbaya ambayo inatumia utendaji wa upanuzi kufanya vitendo visivyoruhusiwa au kupata ufikiaji wa habari nyeti.

4. Finally, we can test the exploit by injecting the malicious script into a web page and observing the impact. This will help us confirm if the vulnerability can be successfully exploited and assess the potential risks.

   Hatimaye, tunaweza kujaribu shambulizi kwa kuingiza script mbaya kwenye ukurasa wa wavuti na kuchunguza athari zake. Hii itatusaidia kuthibitisha ikiwa udhaifu unaweza kutekelezwa kwa mafanikio na kutathmini hatari zinazowezekana.
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Ili kuongeza au kuondoa URL zaidi, ni pia inawezekana kutumia **`include_globs`** na **`exclude_globs`**.

### Skrini za Yaliyomo `run_at`

Uga wa `run_at` unadhibiti **wakati faili za JavaScript zinaingizwa kwenye ukurasa wa wavuti**. Thamani inayopendelewa na chaguo-msingi ni `"document_idle"`.

Thamani zinazowezekana ni:

* **`document_idle`**: Wakati wowote inapowezekana
* **`document_start`**: Baada ya faili yoyote kutoka `css`, lakini kabla ya DOM nyingine yoyote kujengwa au script nyingine yoyote kutekelezwa.
* **`document_end`**: Mara moja baada ya DOM kukamilika, lakini kabla ya rasilimali zingine kama picha na fremu kuanza kupakia.

#### Kupitia `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Kupitia **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

Ujumbe uliotumwa na skripti za maudhui unapokelewa na **ukurasa wa nyuma**, ambao unacheza jukumu kuu katika kuratibu sehemu za nyongeza. Hasa, ukurasa wa nyuma unaendelea kuwepo wakati wote wa maisha ya nyongeza, ukifanya kazi bila kuingiliana moja kwa moja na mtumiaji. Ina DOM yake mwenyewe, kuruhusu mwingiliano na usimamizi wa hali ngumu.

**Mambo muhimu**:

- **Jukumu la Ukurasa wa Nyuma:** Unafanya kazi kama kitovu cha nyongeza, kuhakikisha mawasiliano na uratibu kati ya sehemu mbalimbali za nyongeza.
- **Uwepo wa Kudumu:** Ni kitu kinachopatikana kila wakati, hakionekani na mtumiaji lakini ni muhimu kwa utendaji wa nyongeza.
- **Uzalishaji wa Kiotomatiki:** Ikiwa haijatangazwa wazi, kivinjari kitaunda ukurasa wa nyuma kiotomatiki. Ukurasa huu uliotengenezwa kiotomatiki utajumuisha skripti zote za nyuma zilizotajwa katika hati ya nyongeza, kuhakikisha uendeshaji laini wa kazi za nyuma za nyongeza.

{% hint style="success" %}
Urahisi uliotolewa na kivinjari katika kuzalisha ukurasa wa nyuma kiotomatiki (wakati haijatangazwa wazi) huhakikisha kuwa skripti zote muhimu za nyuma zimeunganishwa na zinafanya kazi, kupunguza mchakato wa usanidi wa nyongeza.
{% endhint %}

Mfano wa skripti ya nyuma:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Inatumia [runtime.onMessage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) kusikiliza ujumbe. Wakati ujumbe wa "eleza" unapokelewa, inatumia [tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) kufungua ukurasa katika kichupo kipya.

Ili kurekebisha skripti ya nyuma, unaweza kwenda kwenye **maelezo ya nyongeza na kuchunguza mfanyakazi wa huduma,** hii itafungua zana za watengenezaji na skripti ya nyuma:

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

### Kurasa za chaguo na nyingine

Nyongeza za kivinjari zinaweza kuwa na aina mbalimbali za kurasa:

* **Kurasa za hatua** zinaonyeshwa katika **menyu ya kushuka wakati alama ya nyongeza** inapobonyezwa.
* Kurasa ambazo nyongeza ita **fungua katika kichupo kipya**.
* **Kurasa za Chaguo**: Ukurasa huu unaonyeshwa juu ya nyongeza wakati unapobonyezwa. Katika maelezo ya awali, niliweza kufikia ukurasa huu kwa kutumia `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` au kwa kubonyeza:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Tafadhali kumbuka kuwa kurasa hizi hazidumu kama kurasa za nyuma kwani zinafunga yaliyomo kwa hitaji. Hata hivyo, zina uwezo fulani na kurasa za nyuma:

- **Mawasiliano na Skripti za Yaliyomo:** Kama kurasa za nyuma, kurasa hizi zinaweza kupokea ujumbe kutoka kwa skripti za yaliyomo, kurahisisha mwingiliano ndani ya nyongeza.
- **Upatikanaji wa API za Nyongeza-Maalamu:** Kurasa hizi zina upatikanaji kamili wa API za nyongeza-maalamu, kulingana na ruhusa zilizofafanuliwa kwa nyongeza.

### `permissions` & `host_permissions`

**`permissions`** na **`host_permissions`** ni vipengele kutoka kwa `manifest.json` ambavyo vitaelezea **ruhusa zipi** nyongeza ya kivinjari ina (uhifadhi, eneo...) na **katika kurasa gani za wavuti**.

Kwa kuwa nyongeza za kivinjari zinaweza kuwa na **mamlaka makubwa**, moja inayodhuru au iliyodukuliwa inaweza kuruhusu mtu mwenye nia mbaya **njia tofauti za kuiba habari nyeti na kumpeleleza mtumiaji**.

Angalia jinsi mipangilio hii inavyofanya kazi na jinsi inavyoweza kutumiwa vibaya katika:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

**Sera ya usalama wa yaliyomo** inaweza pia kutangazwa ndani ya `manifest.json`. Ikiwa imefafanuliwa, inaweza kuwa **dhaifu**.

Mipangilio ya msingi kwa kurasa za nyongeza za kivinjari ni ya kizuizi:
```bash
script-src 'self'; object-src 'self';
```
Kwa habari zaidi kuhusu CSP na njia za kuepuka, angalia:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

ili ukurasa wa wavuti uweze kupata ukurasa wa Kifaa cha Kivinjari, kama vile ukurasa wa `.html`, ukurasa huu unahitaji kutajwa katika uga wa **`web_accessible_resources`** wa `manifest.json`.\
Kwa mfano:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Kurasa hizi zinapatikana kwa URL kama:
```
chrome-extension://<extension-id>/message.html
```
Katika vitu vya umma vya nyongeza, **kitambulisho cha nyongeza kinapatikana**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

Hata hivyo, ikiwa parameter ya `manifest.json` ya **`use_dynamic_url`** inatumika, **kitambulisho hiki kinaweza kuwa cha kubadilika**.

Kuruhusu upatikanaji wa kurasa hizi kunafanya kurasa hizi kuwa **hatari ya mashambulizi ya ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Kuruhusu kurasa hizi kupakia tu na nyongeza na sio kwa URL zisizo na mpangilio kunaweza kuzuia mashambulizi ya ClickJacking.
{% endhint %}

### `externally_connectable`

Kulingana na [**nyaraka**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), mali ya mpangilio wa `"externally_connectable"` inatangaza **nyongeza na kurasa za wavuti zinazoweza kuunganisha** na nyongeza yako kupitia [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) na [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Ikiwa ufunguo wa **`externally_connectable`** haujatangazwa katika mpango wa nyongeza yako au umetangazwa kama **`"ids": ["*"]`**, **nyongeza zote zinaweza kuunganisha, lakini kurasa za wavuti hazina uwezo wa kuunganisha**.
* Ikiwa vitambulisho maalum vinatajwa, kama vile katika `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **maombi hayo tu** yanaweza kuunganisha.
* Ikiwa **sawa** zinatajwa, programu za wavuti hizo zitaweza kuunganisha:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Ikiwa imeelekezwa kuwa tupu: **`"externally_connectable": {}`**, hakuna programu au wavuti itakayoweza kuunganisha.

**Upungufu wa vifaa vya kupanua na URL** ulioonyeshwa hapa, **ndogo itakuwa eneo la shambulio**.

{% hint style="danger" %}
Ikiwa ukurasa wa wavuti una **kasoro ya XSS au kuchukua** imeonyeshwa katika **`externally_connectable`**, mshambuliaji ataweza **kutuma ujumbe moja kwa moja kwa skrini ya nyuma**, akizunguka kabisa Skrini ya Yaliyomo na CSP yake.

Kwa hivyo, hii ni **njia yenye nguvu sana**.
{% endhint %}

## Mawasiliano ya Wavuti **‚ÜîÔ∏é** Skrini ya Yaliyomo

Mazingira ambapo **skrini za yaliyomo** hufanya kazi na ambapo kurasa za mwenyeji zipo ni **zimegawanywa** kutoka kwa kila mmoja, ikihakikisha **kutengwa**. Licha ya kutengwa hii, wote wana uwezo wa kuingiliana na **Modeli ya Vitu ya Nyaraka (DOM)** ya ukurasa, rasilimali inayoshirikiwa. Ili ukurasa wa mwenyeji kushiriki katika mawasiliano na **skrini ya yaliyomo**, au kwa njia isiyo ya moja kwa moja na kifaa kupitia skrini ya yaliyomo, inahitajika kutumia **DOM** ambayo inaweza kufikiwa na pande zote mbili kama njia ya mawasiliano.

### Ujumbe wa Posta

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Mawasiliano salama ya Ujumbe wa Post yanapaswa kuhakiki uhalali wa ujumbe uliopokelewa, hii inaweza kufanywa kwa kuhakiki:

* **`event.isTrusted`**: Hii ni kweli tu ikiwa tukio lilisababishwa na hatua ya mtumiaji
* Skrini ya maudhui inaweza kutarajia ujumbe tu ikiwa mtumiaji anafanya hatua fulani
* **Kikoa cha asili**: inaweza kutarajia ujumbe tu kutoka kwa orodha ya kikoa.
* Ikiwa regex inatumika, kuwa mwangalifu sana
* **Chanzo**: `received_message.source !== window` inaweza kutumika kuangalia ikiwa ujumbe ulikuwa **kutoka dirisha sawa** ambapo Skrini ya Maudhui inasikiliza.

Uchunguzi uliopita, hata ikiwa umefanywa, unaweza kuwa na udhaifu, kwa hivyo angalia katika ukurasa ufuatao **njia za kuzunguka za Ujumbe wa Post**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Njia nyingine inayowezekana ya mawasiliano inaweza kuwa kupitia **URL za Iframe**, unaweza kupata mfano katika:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Hii sio njia "sahihi" ya mawasiliano, lakini **mtandao na skrini ya maudhui itakuwa na ufikiaji wa DOM ya wavuti**. Kwa hivyo, ikiwa **skrini ya maudhui** inasoma habari fulani kutoka kwake, **kuiamini DOM ya wavuti**, wavuti inaweza **kurekebisha data hii** (kwa sababu wavuti haipaswi kuaminiwa, au kwa sababu wavuti ina udhaifu wa XSS) na **kudhoofisha Skrini ya Maudhui**.

Unaweza pia kupata mfano wa **DOM msingi wa XSS kudhoofisha kifaa cha kivinjari** katika:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Taarifa Nyeti katika Kumbukumbu/Kificho

Ikiwa Kifaa cha Kivinjari kinahifadhi **taarifa nyeti ndani ya kumbukumbu yake**, hii inaweza **kudondoshwa** (haswa kwenye mashine za Windows) na **kutafutwa** kwa habari hii.

Kwa hivyo, kumbukumbu ya Kifaa cha Kivinjari **haipaswi kuchukuliwa kuwa salama** na **taarifa nyeti** kama vibali au maneno ya mnemoniki **haipaswi kuhifadhiwa**.

Bila shaka, **usitie habari nyeti katika kificho**, kwani itakuwa **wazi**.

## Skrini ya Maudhui **‚ÜîÔ∏é** Mawasiliano ya Skrini ya Nyuma

Skrini ya Maudhui inaweza kutumia kazi [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **au** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) kutuma ujumbe wa **JSON unaoweza kuserialiwa mara moja**.

Kushughulikia **jibu**, tumia **Ahadi** iliyorejeshwa. Ingawa, kwa utangamano wa nyuma, bado unaweza kupitisha **wito wa nyuma** kama hoja ya mwisho.

Kutuma ombi kutoka kwa **skrini ya maudhui** inaonekana kama hii:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Kutuma ombi kutoka kwa **nyongeza** (kawaida ni **scripti ya msingi**) Scripti ya Yaliyomo inaweza kutumia kazi hizo, isipokuwa unahitaji kubainisha kwenye kichupo gani kutuma. Mfano wa jinsi ya kutuma ujumbe kwa scripti ya yaliyomo kwenye kichupo kilichochaguliwa:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Kwenye **upande wa kupokea**, unahitaji kuweka [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **msikilizaji wa tukio** ili kushughulikia ujumbe. Hii inaonekana sawa kutoka kwa skripti ya maudhui au ukurasa wa nyongeza.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
Katika mfano ulioonyeshwa, **`sendResponse()`** ilitekelezwa kwa njia ya kusawazisha. Ili kubadilisha kifaa cha `onMessage` ili kitekelezwe kwa njia ya kiasinkroni, ni muhimu kuunganisha `return true;`.

Jambo muhimu ni kwamba katika hali ambapo kurasa nyingi zimepangwa kupokea matukio ya `onMessage`, **ukurasa wa kwanza kutekeleza `sendResponse()`** kwa tukio maalum ndio pekee utakayoweza kutoa jibu kwa ufanisi. Majibu yoyote yanayofuata kwa tukio hilo hayatazingatiwa.

Wakati wa kuunda vifaa vipya, inashauriwa kutumia ahadi badala ya kurejelea. Kuhusu matumizi ya kurejelea, kazi ya `sendResponse()` inachukuliwa kuwa halali tu ikiwa inatekelezwa moja kwa moja ndani ya muktadha wa kusawazisha, au ikiwa kifaa cha matukio kinaonyesha operesheni ya kiasinkroni kwa kurudisha `true`. Ikiwa hakuna kifaa kinachorudisha `true` au ikiwa kazi ya `sendResponse()` imeondolewa kutoka kumbukumbu (kukusanywa taka), kurejelea inayohusiana na kazi ya `sendMessage()` itaanzishwa kwa chaguo-msingi.

## Kupakia Kifaa cha Kivinjari

1. **Pakua** Kifaa cha Kivinjari na kisitolewe kwenye faili
2. Nenda kwenye **`chrome://extensions/`** na **wezesha** `Developer Mode`
3. Bonyeza kitufe cha **`Load unpacked`**

Katika **Firefox** nenda **`about:debugging#/runtime/this-firefox`** na bonyeza kitufe cha **`Load Temporary Add-on`**.

## Kupata nambari ya chanzo kutoka kwenye duka

Nambari ya chanzo ya kifaa cha Chrome inaweza kupatikana kupitia njia mbalimbali. Hapa chini kuna maelezo na maelekezo ya kina kwa kila chaguo.

### Pakua Kifaa kama ZIP kupitia Mstari wa Amri

Nambari ya chanzo ya kifaa cha Chrome inaweza kupakuliwa kama faili ya ZIP kwa kutumia mstari wa amri. Hii inahusisha kutumia `curl` kupakua faili ya ZIP kutoka kwenye URL maalum na kisha kuchambua maudhui ya faili ya ZIP kwenye saraka. Hapa kuna hatua:

1. Badilisha `"extension_id"` na Kitambulisho halisi cha kifaa.
2. Tekeleza amri zifuatazo:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### Tumia tovuti ya CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Tumia kifaa cha CRX Viewer

Njia nyingine rahisi ni kutumia Kifaa cha Chrome Extension Source Viewer, ambacho ni mradi wa chanzo wazi. Inaweza kusakinishwa kutoka [Duka la Wavuti la Chrome](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). Msimbo wa chanzo wa kifaa hiki unapatikana katika [Hifadhi ya GitHub](https://github.com/Rob--W/crxviewer).

### Angalia chanzo cha kifaa cha kusakinishwa kwenye kompyuta yako

Vifaa vya Chrome vilivyosakinishwa kwenye kompyuta yako pia vinaweza kukaguliwa. Hapa kuna jinsi ya kufanya hivyo:

1. Fikia saraka ya maelezo ya ndani ya Chrome yako kwa kutembelea `chrome://version/` na kupata uga wa "Profile Path".
2. Nenda kwenye saraka ya `Extensions/` ndani ya saraka ya maelezo ya ndani.
3. Saraka hii ina vifaa vyote vilivyosakinishwa, kwa kawaida na msimbo wao wa chanzo katika muundo unaoweza kusomwa.

Ili kutambua vifaa, unaweza kuweka alama za kitambulisho zao kwa majina:

- Wezesha Mode ya Watengenezaji kwenye ukurasa wa `about:extensions` ili uone kitambulisho cha kila kifaa.
- Ndani ya saraka ya kila kifaa, faili ya `manifest.json` ina uga wa kusomwa wa `name`, ikikusaidia kutambua kifaa.

### Tumia Archiver au Unpacker wa Faili
Nenda kwenye Duka la Wavuti la Chrome na pakua kifaa. Faili itakuwa na kifungu cha `.crx`.
Badilisha kifungu cha faili kutoka `.crx` hadi `.zip`.
Tumia archiver yoyote ya faili (kama WinRAR, 7-Zip, nk) kuondoa maudhui ya faili ya ZIP.

### Tumia Mode ya Watengenezaji kwenye Chrome
Fungua Chrome na nenda kwenye `chrome://extensions/`.
Wezesha "Mode ya Watengenezaji" juu kulia.
Bonyeza "Sakinisha kifaa kilichopakuliwa...".
Nenda kwenye saraka ya kifaa chako.
Hii haipakui msimbo wa chanzo, lakini ni muhimu kwa kuangalia na kurekebisha msimbo wa kifaa kilichopakuliwa au kilichotengenezwa tayari.

## Orodha ya Ukaguzi wa Usalama

Ingawa Vifaa vya Kivinjari vina **eneo mdogo la shambulio**, baadhi yao wanaweza kuwa na **mianya** au **maboresho ya ulinzi**. Yafuatayo ni ya kawaida zaidi:

* [ ] **Punguza** kama iwezekanavyo **ruhusa zinazohitajika**
* [ ] **Punguza** kama iwezekanavyo **`host_permissions`**
* [ ] Tumia **`content_security_policy`** yenye nguvu
* [ ] **Punguza** kama iwezekanavyo **`externally_connectable`**, ikiwa hakuna inayohitajika na iwezekanavyo, usiiache kwa chaguo-msingi, eleza **`{}`**
* [ ] Ikiwa **URL inayoweza kudhurika na XSS au kuchukuliwa** inatajwa hapa, mshambuliaji ataweza **kutuma ujumbe kwa skripti za nyuma moja kwa moja**. Kuvuka vizuizi vya nguvu sana.
* [ ] **Punguza** kama iwezekanavyo **`web_accessible_resources`**, hata tupu ikiwezekana.
* [ ] Ikiwa **`web_accessible_resources`** sio hakuna, angalia [**ClickJacking**](browext-clickjacking.md)
* [ ] Ikiwa kuna **mawasiliano yoyote** kutoka **kifaa** kwenda **ukurasa wa wavuti**, [**angalia XSS**](browext-xss-example.md) **mianya** inayosababishwa katika mawasiliano hayo.
* [ ] Ikiwa Ujumbe wa Post unatumika, angalia [**mianya ya Ujumbe wa Post**](../postmessage-vulnerabilities/)**.**
* [ ] Ikiwa **Skripti ya Yaliyomo inapata maelezo ya DOM**, hakikisha kuwa haziingizi XSS ikiwa zitabadilishwa na wavuti
* [ ] Fanya umuhimu maalum ikiwa mawasiliano haya pia yanahusika katika **Mawasiliano ya Skripti ya Yaliyomo -> Skripti ya Nyuma**
* [ ] **Taarifa nyeti hazipaswi kuhifadhiwa** ndani ya Msimbo wa Kifaa cha Kivinjari
* [ ] **Taarifa nyeti hazipaswi kuhifadhiwa** ndani ya Kumbukumbu ya Msimbo wa Kifaa cha Kivinjari

## Zana

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Inapata kifaa chochote cha Chrome kutoka kiunga cha Duka la Wavuti la Chrome kilichotolewa.
* **Mwonekano wa manifest.json**: inaonyesha toleo la JSON la kifaa cha maelezo ya msingi.
* **Uchambuzi wa Alama za Vidole**: Uchunguzi wa [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) na uundaji wa moja kwa moja wa JavaScript ya alama za vidole za kifaa cha Chrome.
* **Uchambuzi wa Clickjacking**: Uchunguzi wa kurasa za HTML za kifaa na agizo la [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources). Hizi zinaweza kuwa hatarini kwa clickjacking kulingana na kusudi la kurasa hizo.
* **Mwonekano wa Onyo la Ruhusa**: inaonyesha orodha ya onyo zote za ruhusa za Chrome ambazo zitaonyeshwa wakati mtumiaji anajaribu kusakinisha kifaa.
* **Kazi Hatari**: inaonyesha eneo la kazi hatari ambalo linaweza kutumiwa na mshambuliaji (k.m. kazi kama innerHTML, chrome.tabs.executeScript).
* **Njia za Kuingia**: inaonyesha wapi kifaa kinapokea pembejeo kutoka kwa mtumiaji/taarifa za nje. Hii ni muhimu kwa kuelewa eneo la kifaa na kutafuta sehemu za uwezekano wa kutuma data iliyoundwa kwa nia mbaya kwa kifaa.
* Skana za Kazi Hatari na Njia za Kuingia zinafuata haya kwa tahadhari zao zilizozalishwa:
* Kipande cha msimbo kinachohusika na mstari uliosababisha tahadhari.
* Maelezo ya suala.
* Kitufe cha "Angalia Faili" ili kuona faili kamili ya chanzo inayohusisha msimbo.
* Njia ya faili iliyosababisha tahadhari.
* URI kamili ya kifaa cha Chrome cha faili iliyosababisha tahadhari.
* Aina ya faili hiyo, kama skripti ya Ukurasa wa Nyuma
* Ikiwa unataka kuona **kampuni yako inayotangazwa katika HackTricks** au **kupakua HackTricks katika PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**bidhaa rasmi za PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kuhack kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>
