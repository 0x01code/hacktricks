# Metodologia de Pentesting de Extens√µes de Navegador

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

As extens√µes de navegador s√£o escritas em JavaScript e carregadas pelo navegador em segundo plano. Elas possuem seu [DOM](https://www.w3schools.com/js/js\_htmldom.asp) mas podem interagir com o DOM de outros sites. Isso significa que elas podem comprometer a confidencialidade, integridade e disponibilidade de outros sites (CIA).

## Componentes Principais

Os layouts de extens√£o ficam melhores quando visualizados e consistem em tr√™s componentes. Vamos analisar cada componente em detalhes.

<figure><img src="../../.gitbook/assets/image (4) (1).png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Scripts de Conte√∫do**

Cada script de conte√∫do tem acesso direto ao DOM de uma **√∫nica p√°gina da web** e, portanto, est√° exposto a **entradas potencialmente maliciosas**. No entanto, o script de conte√∫do n√£o possui permiss√µes al√©m da capacidade de enviar mensagens para o n√∫cleo da extens√£o.

### **N√∫cleo da Extens√£o**

O n√∫cleo da extens√£o cont√©m a maioria dos privil√©gios/acessos da extens√£o, mas o n√∫cleo da extens√£o s√≥ pode interagir com o conte√∫do da web via [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) e scripts de conte√∫do. Al√©m disso, o n√∫cleo da extens√£o n√£o tem acesso direto √† m√°quina hospedeira.

### **Bin√°rio Nativo**

A extens√£o permite um bin√°rio nativo que pode **acessar a m√°quina hospedeira com os privil√©gios completos do usu√°rio**. O bin√°rio nativo interage com o n√∫cleo da extens√£o por meio da Interface de Programa√ß√£o de Aplicativos de Plug-in Netscape Padr√£o ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) usada pelo Flash e outros plug-ins de navegador.

### Limites

{% hint style="danger" %}
Para obter os privil√©gios completos do usu√°rio, um atacante deve convencer a extens√£o a passar uma entrada maliciosa do script de conte√∫do para o n√∫cleo da extens√£o e do n√∫cleo da extens√£o para o bin√°rio nativo.
{% endhint %}

Cada componente da extens√£o √© separado uns dos outros por **fortes limites de prote√ß√£o**. Cada componente √© executado em um **processo de sistema operacional separado**. Os scripts de conte√∫do e os n√∫cleos da extens√£o s√£o executados em **processos de sandbox** indispon√≠veis para a maioria dos servi√ßos do sistema operacional.

Al√©m disso, os scripts de conte√∫do s√£o separados de suas p√°ginas da web associadas por **serem executados em um heap JavaScript separado**. O script de conte√∫do e a p√°gina da web t√™m **acesso ao mesmo DOM subjacente**, mas os dois **nunca trocam ponteiros JavaScript**, impedindo o vazamento de funcionalidades JavaScript.

## **`manifest.json`**

Uma extens√£o do Chrome √© apenas uma pasta ZIP com uma extens√£o de arquivo [.crx](https://www.lifewire.com/crx-file-2620391). O n√∫cleo da extens√£o √© o arquivo **`manifest.json`** na raiz da pasta, que especifica o layout, permiss√µes e outras op√ß√µes de configura√ß√£o.

Exemplo:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Os scripts de conte√∫do s√£o **carregados** sempre que o usu√°rio **navega para uma p√°gina correspondente**, no nosso caso qualquer p√°gina correspondente √† express√£o **`https://example.com/*`** e que n√£o corresponda ao regex **`*://*/*/business*`**. Eles s√£o executados **como os scripts da pr√≥pria p√°gina** e t√™m acesso arbitr√°rio ao [Modelo de Objeto de Documento (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document_Object_Model) da p√°gina.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Para incluir ou excluir mais URLs, tamb√©m √© poss√≠vel usar **`include_globs`** e **`exclude_globs`**.

Este √© um exemplo de script de conte√∫do que adicionar√° um bot√£o de explica√ß√£o √† p√°gina quando [a API de armazenamento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) for usada para recuperar o valor `message` do armazenamento da extens√£o.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Uma mensagem √© enviada para as p√°ginas da extens√£o pelo script de conte√∫do quando este bot√£o √© clicado, atrav√©s da utiliza√ß√£o da [**API runtime.sendMessage()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage). Isso ocorre devido √† limita√ß√£o do script de conte√∫do no acesso direto √†s APIs, sendo o `storage` uma das poucas exce√ß√µes. Para funcionalidades al√©m dessas exce√ß√µes, mensagens s√£o enviadas para as p√°ginas da extens√£o com as quais os scripts de conte√∫do podem se comunicar.

{% hint style="warning" %}
Dependendo do navegador, as capacidades do script de conte√∫do podem variar ligeiramente. Para navegadores baseados em Chromium, a lista de capacidades est√° dispon√≠vel na [documenta√ß√£o dos desenvolvedores do Chrome](https://developer.chrome.com/docs/extensions/mv3/content_scripts/#capabilities), e para o Firefox, a [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content_scripts#webextension_apis) serve como fonte prim√°ria.\
Tamb√©m √© importante notar que os scripts de conte√∫do t√™m a capacidade de se comunicar com scripts de plano de fundo, permitindo que realizem a√ß√µes e transmitam respostas de volta.
{% endhint %}

Para visualizar e depurar scripts de conte√∫do no Chrome, o menu de ferramentas para desenvolvedores do Chrome pode ser acessado em Op√ß√µes > Mais ferramentas > Ferramentas do desenvolvedor OU pressionando Ctrl + Shift + I.

Ao exibir as ferramentas para desenvolvedores, a **aba Origem** deve ser clicada, seguida pela aba **Scripts de Conte√∫do**. Isso permite a observa√ß√£o dos scripts de conte√∫do em execu√ß√£o de v√°rias extens√µes e a defini√ß√£o de pontos de interrup√ß√£o para rastrear o fluxo de execu√ß√£o.

### Scripts de conte√∫do injetados

{% hint style="success" %}
Observe que **Scripts de Conte√∫do n√£o s√£o obrigat√≥rios** pois tamb√©m √© poss√≠vel **injetar scripts dinamicamente** e **injet√°-los programaticamente** em p√°ginas da web via **`tabs.executeScript`**. Isso, na verdade, fornece mais **controles granulares**.
{% endhint %}

Para a inje√ß√£o program√°tica de um script de conte√∫do, a extens√£o deve ter [permiss√µes de host](https://developer.chrome.com/docs/extensions/reference/permissions) para a p√°gina na qual os scripts ser√£o injetados. Essas permiss√µes podem ser garantidas tanto solicitando-as dentro do manifesto da extens√£o quanto temporariamente atrav√©s de [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab).

#### Exemplo de extens√£o baseada em activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
{% endcode %}

* **Injetar um arquivo JS ao clicar:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Injetar uma fun√ß√£o** ao clicar:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Exemplo com permiss√µes de script
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// Another example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Para incluir ou excluir mais URLs, tamb√©m √© poss√≠vel usar **`include_globs`** e **`exclude_globs`**.

### Scripts de Conte√∫do `run_at`

O campo `run_at` controla **quando os arquivos JavaScript s√£o injetados na p√°gina da web**. O valor preferido e padr√£o √© `"document_idle"`.

Os valores poss√≠veis s√£o:

* **`document_idle`**: Sempre que poss√≠vel
* **`document_start`**: Ap√≥s quaisquer arquivos de `css`, mas antes de qualquer outro DOM ser constru√≠do ou qualquer outro script ser executado.
* **`document_end`**: Imediatamente ap√≥s o DOM estar completo, mas antes que subrecursos como imagens e frames sejam carregados.

#### Via `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.example.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Atrav√©s de **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.example.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

As mensagens enviadas pelos scripts de conte√∫do s√£o recebidas pela **p√°gina de fundo**, que desempenha um papel central na coordena√ß√£o dos componentes da extens√£o. Notavelmente, a p√°gina de fundo persiste ao longo da vida da extens√£o, operando discretamente sem intera√ß√£o direta do usu√°rio. Possui seu pr√≥prio Document Object Model (DOM), permitindo intera√ß√µes complexas e gerenciamento de estado.

**Pontos Chave**:

* **Papel da P√°gina de Fundo:** Age como o centro nervoso da extens√£o, garantindo a comunica√ß√£o e coordena√ß√£o entre v√°rias partes da extens√£o.
* **Persist√™ncia:** √â uma entidade sempre presente, invis√≠vel para o usu√°rio, mas fundamental para a funcionalidade da extens√£o.
* **Gera√ß√£o Autom√°tica:** Se n√£o for explicitamente definida, o navegador criar√° automaticamente uma p√°gina de fundo. Esta p√°gina gerada automaticamente incluir√° todos os scripts de fundo especificados no manifesto da extens√£o, garantindo a opera√ß√£o cont√≠nua das tarefas de fundo da extens√£o.

{% hint style="success" %}
A conveni√™ncia fornecida pelo navegador ao gerar automaticamente uma p√°gina de fundo (quando n√£o declarada explicitamente) garante que todos os scripts de fundo necess√°rios sejam integrados e operacionais, simplificando o processo de configura√ß√£o da extens√£o.
{% endhint %}

Exemplo de script de fundo:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Ele usa a [API runtime.onMessage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) para ouvir mensagens. Quando uma mensagem `"explain"` √© recebida, ele usa a [API tabs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) para abrir uma p√°gina em uma nova aba.

Para depurar o script de fundo, voc√™ pode ir para os **detalhes da extens√£o e inspecionar o service worker**, isso abrir√° as ferramentas de desenvolvedor com o script de fundo:

<figure><img src="broken-reference" alt=""><figcaption></figcaption></figure>

### P√°ginas de op√ß√µes e outras

As extens√µes do navegador podem conter v√°rios tipos de p√°ginas:

* **P√°ginas de a√ß√£o** s√£o exibidas em um **menu suspenso quando o √≠cone da extens√£o √© clicado**.
* P√°ginas que a extens√£o ir√° **carregar em uma nova aba**.
* **P√°ginas de op√ß√µes**: Esta p√°gina √© exibida sobre a extens√£o quando clicada. No manifesto anterior, no meu caso, consegui acessar esta p√°gina em `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` ou clicando em:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Observe que essas p√°ginas n√£o s√£o persistentes como as p√°ginas de fundo, pois carregam conte√∫do dinamicamente quando necess√°rio. Apesar disso, elas compartilham certas capacidades com a p√°gina de fundo:

* **Comunica√ß√£o com Scripts de Conte√∫do:** Semelhante √† p√°gina de fundo, essas p√°ginas podem receber mensagens de scripts de conte√∫do, facilitando a intera√ß√£o dentro da extens√£o.
* **Acesso a APIs Espec√≠ficas da Extens√£o:** Essas p√°ginas t√™m amplo acesso a APIs espec√≠ficas da extens√£o, sujeitas √†s permiss√µes definidas para a extens√£o.

### `permissions` & `host_permissions`

**`permissions`** e **`host_permissions`** s√£o entradas do `manifest.json` que indicar√£o **quais permiss√µes** a extens√£o do navegador possui (armazenamento, localiza√ß√£o...) e em **quais p√°ginas da web**.

Como as extens√µes do navegador podem ser t√£o **privilegiadas**, uma maliciosa ou comprometida poderia permitir ao atacante **diferentes meios de roubar informa√ß√µes sens√≠veis e espionar o usu√°rio**.

Verifique como essas configura√ß√µes funcionam e como elas podem ser abusadas em:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

Uma **pol√≠tica de seguran√ßa de conte√∫do** tamb√©m pode ser declarada dentro do `manifest.json`. Se houver uma definida, ela poderia ser **vulner√°vel**.

A configura√ß√£o padr√£o para p√°ginas de extens√£o do navegador √© bastante restritiva:
```bash
script-src 'self'; object-src 'self';
```
Para obter mais informa√ß√µes sobre CSP e poss√≠veis formas de contorn√°-lo, consulte:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

para que uma p√°gina da web acesse uma p√°gina de uma Extens√£o do Navegador, por exemplo, uma p√°gina `.html`, essa p√°gina precisa ser mencionada no campo **`web_accessible_resources`** do `manifest.json`.\
Por exemplo:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Estas p√°ginas s√£o acess√≠veis em URLs como:
```
chrome-extension://<extension-id>/message.html
```
Em extens√µes p√∫blicas, o **ID da extens√£o √© acess√≠vel**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

No entanto, se o par√¢metro `manifest.json` **`use_dynamic_url`** for usado, esse **ID pode ser din√¢mico**.

Permitir o acesso a essas p√°ginas torna essas p√°ginas **potencialmente vulner√°veis ao ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Permitir que essas p√°ginas sejam carregadas apenas pela extens√£o e n√£o por URLs aleat√≥rios poderia prevenir ataques de CLickJacking.
{% endhint %}

### `externally_connectable`

Conforme a [**documenta√ß√£o**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), a propriedade do manifesto `"externally_connectable"` declara **quais extens√µes e p√°ginas da web podem se conectar** √† sua extens√£o via [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) e [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Se a chave **`externally_connectable`** n√£o for declarada no manifesto da sua extens√£o ou for declarada como **`"ids": ["*"]`**, **todas as extens√µes podem se conectar, mas nenhuma p√°gina da web pode se conectar**.
* Se **IDs espec√≠ficos forem especificados**, como em `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **apenas essas aplica√ß√µes** podem se conectar.
* Se **correspond√™ncias** forem especificadas, esses aplicativos da web poder√£o se conectar:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Se for especificado como vazio: **`"externally_connectable": {}`**, nenhum aplicativo ou site poder√° se conectar.

Quanto **menos extens√µes e URLs** forem indicados aqui, **menor ser√° a superf√≠cie de ataque**.

{% hint style="danger" %}
Se uma p√°gina da web **vulner√°vel a XSS ou takeover** for indicada em **`externally_connectable`**, um atacante poder√° **enviar mensagens diretamente para o script de plano de fundo**, contornando completamente o Content Script e sua CSP.

Portanto, este √© um **bypass muito poderoso**.

Al√©m disso, se o cliente instalar uma extens√£o maliciosa, mesmo que n√£o seja permitido se comunicar com a extens√£o vulner√°vel, ela poder√° injetar **dados XSS em uma p√°gina da web permitida** ou abusar das APIs **`WebRequest`** ou **`DeclarativeNetRequest`** para manipular solicita√ß√µes em um dom√≠nio espec√≠fico alterando a solicita√ß√£o de uma p√°gina para um **arquivo JavaScript**. (Observe que a CSP na p√°gina-alvo pode prevenir esses ataques). Essa ideia vem [**deste artigo**](https://www.darkrelay.com/post/opera-zero-day-rce-vulnerability).
{% endhint %}

##

## Comunica√ß√£o Web **‚ÜîÔ∏é** Content Script

Os ambientes onde os **scripts de conte√∫do** operam e onde as p√°ginas hospedeiras existem est√£o **separados** um do outro, garantindo **isolamento**. Apesar desse isolamento, ambos t√™m a capacidade de interagir com o **Modelo de Objeto de Documento (DOM)** da p√°gina, um recurso compartilhado. Para que a p√°gina hospedeira se comunique com o **script de conte√∫do**, ou indiretamente com a extens√£o por meio do script de conte√∫do, √© necess√°rio utilizar o **DOM** acess√≠vel por ambas as partes como canal de comunica√ß√£o.

### Mensagens de Postagem

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
{% endcode %}

{% code title="example.js" %}
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Uma comunica√ß√£o segura de Post Message deve verificar a autenticidade da mensagem recebida, isso pode ser feito verificando:

- **`event.isTrusted`**: Isso √© True apenas se o evento foi acionado por uma a√ß√£o do usu√°rio
- O script de conte√∫do pode esperar uma mensagem apenas se o usu√°rio realizar alguma a√ß√£o
- **dom√≠nio de origem**: pode esperar uma mensagem apenas de uma lista de dom√≠nios permitidos.
- Se uma regex for usada, tenha muito cuidado
- **Fonte**: `received_message.source !== window` pode ser usado para verificar se a mensagem foi **da mesma janela** onde o Script de Conte√∫do est√° ouvindo.

As verifica√ß√µes anteriores, mesmo se realizadas, podem ser vulner√°veis, ent√£o verifique na seguinte p√°gina **poss√≠veis bypasses de Post Message**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Outra poss√≠vel forma de comunica√ß√£o pode ser atrav√©s de **URLs de Iframe**, voc√™ pode encontrar um exemplo em:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Isso n√£o √© "exatamente" uma forma de comunica√ß√£o, mas a **web e o script de conte√∫do ter√£o acesso ao DOM da web**. Portanto, se o **script de conte√∫do** estiver lendo algumas informa√ß√µes dele, **confiando no DOM da web**, a web poderia **modificar esses dados** (porque a web n√£o deve ser confi√°vel, ou porque a web √© vulner√°vel a XSS) e **comprometer o Script de Conte√∫do**.

Voc√™ tamb√©m pode encontrar um exemplo de um **XSS baseado em DOM para comprometer uma extens√£o do navegador** em:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Informa√ß√µes Sens√≠veis na Mem√≥ria/C√≥digo

Se uma Extens√£o do Navegador armazena **informa√ß√µes sens√≠veis em sua mem√≥ria**, isso poderia ser **dumped** (especialmente em m√°quinas Windows) e **procurado** por essas informa√ß√µes.

Portanto, a mem√≥ria da Extens√£o do Navegador **n√£o deve ser considerada segura** e **informa√ß√µes sens√≠veis** como credenciais ou frases mnem√¥nicas **n√£o devem ser armazenadas**.

Claro, **n√£o coloque informa√ß√µes sens√≠veis no c√≥digo**, pois ser√° **p√∫blico**.

## Comunica√ß√£o Script de Conte√∫do **‚ÜîÔ∏é** Script de Fundo

Um Script de Conte√∫do pode usar as fun√ß√µes [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **ou** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) para enviar uma mensagem **serializ√°vel em JSON** de uma vez.

Para lidar com a **resposta**, use a **Promise** retornada. No entanto, para compatibilidade com vers√µes anteriores, ainda √© poss√≠vel passar um **callback** como √∫ltimo argumento.

Enviar uma solicita√ß√£o de um **script de conte√∫do** parece com isso:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Enviar uma solicita√ß√£o da **extens√£o** (geralmente um **script de plano de fundo**) Um Script de Conte√∫do pode usar as fun√ß√µes, exceto que voc√™ precisa especificar para qual aba envi√°-lo. Exemplo de como enviar uma mensagem para o script de conte√∫do na aba selecionada:
```javascript
// From https://stackoverflow.com/questions/36153999/how-to-send-a-message-between-chrome-extension-popup-and-content-script
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
No **lado receptor**, voc√™ precisa configurar um [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **ouvinte de evento** para lidar com a mensagem. Isso parece o mesmo de um script de conte√∫do ou p√°gina de extens√£o.
```javascript
// From https://stackoverflow.com/questions/70406787/javascript-send-message-from-content-js-to-background-js
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
No exemplo destacado, **`sendResponse()`** foi executado de forma s√≠ncrona. Para modificar o manipulador de eventos `onMessage` para execu√ß√£o ass√≠ncrona de `sendResponse()`, √© imperativo incorporar `return true;`.

Uma considera√ß√£o importante √© que em cen√°rios onde v√°rias p√°ginas est√£o configuradas para receber eventos `onMessage`, **a primeira p√°gina a executar `sendResponse()`** para um evento espec√≠fico ser√° a √∫nica capaz de entregar a resposta de forma eficaz. Quaisquer respostas subsequentes ao mesmo evento n√£o ser√£o consideradas.

Ao criar novas extens√µes, a prefer√™ncia deve ser para promessas em vez de callbacks. Em rela√ß√£o ao uso de callbacks, a fun√ß√£o `sendResponse()` √© considerada v√°lida apenas se for executada diretamente no contexto s√≠ncrono, ou se o manipulador de eventos indicar uma opera√ß√£o ass√≠ncrona retornando `true`. Caso nenhum dos manipuladores retorne `true` ou se a fun√ß√£o `sendResponse()` for removida da mem√≥ria (coletada pelo garbage collector), o callback associado √† fun√ß√£o `sendMessage()` ser√° acionado por padr√£o.

## Carregando uma Extens√£o no Navegador

1. **Baixe** a Extens√£o do Navegador e descompacte
2. Acesse **`chrome://extensions/`** e **habilite** o `Modo de Desenvolvedor`
3. Clique no bot√£o **`Carregar sem compacta√ß√£o`**

No **Firefox**, acesse **`about:debugging#/runtime/this-firefox`** e clique no bot√£o **`Carregar Complemento Tempor√°rio`**.

## Obtendo o c√≥digo-fonte da loja

O c√≥digo-fonte de uma extens√£o do Chrome pode ser obtido por v√°rios m√©todos. Abaixo est√£o explica√ß√µes detalhadas e instru√ß√µes para cada op√ß√£o.

### Baixar Extens√£o como ZIP via Linha de Comando

O c√≥digo-fonte de uma extens√£o do Chrome pode ser baixado como um arquivo ZIP usando a linha de comando. Isso envolve usar `curl` para buscar o arquivo ZIP de uma URL espec√≠fica e depois extrair o conte√∫do do arquivo ZIP para um diret√≥rio. Aqui est√£o os passos:

1. Substitua `"extension_id"` pelo ID real da extens√£o.
2. Execute os seguintes comandos:
```bash
extension_id=your_extension_id   # Replace with the actual extension ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
### Usar o site CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Usar a extens√£o CRX Viewer

Outro m√©todo conveniente √© usar o Chrome Extension Source Viewer, que √© um projeto de c√≥digo aberto. Pode ser instalado na [Chrome Web Store](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en). O c√≥digo-fonte do visualizador est√° dispon√≠vel em seu [reposit√≥rio GitHub](https://github.com/Rob--W/crxviewer).

### Visualizar o c√≥digo-fonte da extens√£o instalada localmente

As extens√µes do Chrome instaladas localmente tamb√©m podem ser inspecionadas. Veja como:

1. Acesse o diret√≥rio do perfil local do Chrome visitando `chrome://version/` e localizando o campo "Caminho do Perfil".
2. Navegue at√© a subpasta `Extensions/` dentro do diret√≥rio do perfil.
3. Esta pasta cont√©m todas as extens√µes instaladas, geralmente com seu c√≥digo-fonte em um formato leg√≠vel.

Para identificar as extens√µes, voc√™ pode mapear seus IDs para nomes:

* Ative o Modo de Desenvolvedor na p√°gina `about:extensions` para ver os IDs de cada extens√£o.
* Dentro da pasta de cada extens√£o, o arquivo `manifest.json` cont√©m um campo `name` leg√≠vel, ajudando a identificar a extens√£o.

### Usar um Arquivador ou Descompactador de Arquivos

V√° para a Chrome Web Store e baixe a extens√£o. O arquivo ter√° a extens√£o `.crx`. Altere a extens√£o do arquivo de `.crx` para `.zip`. Use qualquer arquivador de arquivos (como WinRAR, 7-Zip, etc.) para extrair o conte√∫do do arquivo ZIP.

### Usar o Modo Desenvolvedor no Chrome

Abra o Chrome e v√° para `chrome://extensions/`. Ative o "Modo Desenvolvedor" no canto superior direito. Clique em "Carregar extens√£o sem compacta√ß√£o...". Navegue at√© o diret√≥rio da sua extens√£o. Isso n√£o baixa o c√≥digo-fonte, mas √© √∫til para visualizar e modificar o c√≥digo de uma extens√£o j√° baixada ou desenvolvida.

## Lista de Verifica√ß√£o de Auditoria de Seguran√ßa

Embora as Extens√µes do Navegador tenham uma **superf√≠cie de ataque limitada**, algumas delas podem conter **vulnerabilidades** ou **melhorias de fortalecimento potenciais**. As mais comuns s√£o:

* [ ] **Limitar** o m√°ximo poss√≠vel as **`permiss√µes`** solicitadas
* [ ] **Limitar** o m√°ximo poss√≠vel as **`host_permissions`**
* [ ] Usar uma **`content_security_policy`** forte
* [ ] **Limitar** o m√°ximo poss√≠vel o **`externally_connectable`**, se nenhum for necess√°rio e poss√≠vel, n√£o deixe por padr√£o, especifique **`{}`**
* [ ] Se uma **URL vulner√°vel a XSS ou a takeover** for mencionada aqui, um atacante poder√° **enviar mensagens diretamente aos scripts de fundo**. Um bypass muito poderoso.
* [ ] **Limitar** o m√°ximo poss√≠vel os **`web_accessible_resources`**, mesmo vazio, se poss√≠vel.
* [ ] Se **`web_accessible_resources`** n√£o for nenhum, verifique o [**ClickJacking**](browext-clickjacking.md)
* [ ] Se houver **comunica√ß√£o** da **extens√£o** para a **p√°gina da web**, [**verifique XSS**](browext-xss-example.md) **vulnerabilidades** causadas na comunica√ß√£o.
* [ ] Se Post Messages forem usados, verifique [**vulnerabilidades de Post Message**](../postmessage-vulnerabilities/)**.**
* [ ] Se o **Script de Conte√∫do acessar detalhes do DOM**, verifique se eles **n√£o est√£o introduzindo um XSS** se forem **modificados** pela web
* [ ] Fa√ßa um destaque especial se essa comunica√ß√£o tamb√©m estiver envolvida na **comunica√ß√£o do Script de Conte√∫do -> Script de Fundo**
* **Informa√ß√µes sens√≠veis n√£o devem ser armazenadas** dentro do c√≥digo da Extens√£o do Navegador
* **Informa√ß√µes sens√≠veis n√£o devem ser armazenadas** na mem√≥ria da Extens√£o do Navegador

## Ferramentas

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Extrai qualquer extens√£o do Chrome a partir de um link fornecido da Chrome Web Store.
* Visualizador de [**manifest.json**](https://developer.chrome.com/extensions/manifest): exibe simplesmente uma vers√£o JSON formatada do manifesto da extens√£o.
* An√°lise de Impress√£o Digital: Detec√ß√£o de [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) e gera√ß√£o autom√°tica de JavaScript de impress√£o digital de extens√£o do Chrome.
* An√°lise Potencial de Clickjacking: Detec√ß√£o de p√°ginas HTML de extens√£o com a diretiva [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) definida. Essas s√£o potencialmente vulner√°veis ao clickjacking, dependendo do prop√≥sito das p√°ginas.
* Visualizador de Aviso(s) de Permiss√£o: que mostra uma lista de todos os avisos de permiss√£o do Chrome que ser√£o exibidos ao usu√°rio ao tentar instalar a extens√£o.
* Fun√ß√£o(√µes) Perigosa(s): mostra a localiza√ß√£o de fun√ß√µes perigosas que poderiam ser potencialmente exploradas por um atacante (por exemplo, fun√ß√µes como innerHTML, chrome.tabs.executeScript).
* Ponto(s) de Entrada: mostra onde a extens√£o recebe entrada do usu√°rio/externa. Isso √© √∫til para entender a √°rea de superf√≠cie de uma extens√£o e procurar pontos potenciais para enviar dados maliciosamente criados para a extens√£o.
* Tanto as Fun√ß√£o(√µes) Perigosa(s) quanto os scanners de Ponto(s) de Entrada t√™m o seguinte para seus alertas gerados:
* Trecho de c√≥digo relevante e linha que causou o alerta.
* Descri√ß√£o do problema.
* Um bot√£o "Visualizar Arquivo" para visualizar o arquivo de origem completo contendo o c√≥digo.
* O caminho do arquivo alertado.
* O URI completo da extens√£o do Chrome do arquivo alertado.
* O tipo de arquivo que √©, como um script de P√°gina de Fundo, Script de Conte√∫do, A√ß√£o do Navegador, etc.
* Se a linha vulner√°vel estiver em um arquivo JavaScript, os caminhos de todas as p√°ginas onde ele est√° inclu√≠do, bem como o tipo dessas p√°ginas e o status de [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources).
* Analisador de Pol√≠tica de Seguran√ßa de Conte√∫do (CSP) e verificador de bypass: Isso apontar√° fraquezas na CSP da sua extens√£o e tamb√©m iluminar√° quaisquer maneiras potenciais de contornar sua CSP devido a CDNs na lista branca, etc.
* Bibliotecas Vulner√°veis Conhecidas: Isso usa [Retire.js](https://retirejs.github.io/retire.js/) para verificar qualquer uso de bibliotecas JavaScript conhecidas como vulner√°veis.
* Baixar extens√£o e vers√µes formatadas.
* Baixar a extens√£o original.
* Baixar uma vers√£o embelezada da extens√£o (HTML e JavaScript automaticamente embelezados).
* Cache autom√°tico dos resultados da verifica√ß√£o, executar uma verifica√ß√£o de extens√£o levar√° um bom tempo na primeira vez que voc√™ a executa. No entanto, na segunda vez, assumindo que a extens√£o n√£o tenha sido atualizada, ser√° quase instant√¢neo devido aos resultados estarem em cache.
* URLs de Relat√≥rios Link√°veis, facilmente vincule algu√©m a um relat√≥rio de extens√£o gerado pelo tarnish.

### [Neto](https://github.com/elevenpaths/neto)

O Projeto Neto √© um pacote Python 3 concebido para analisar e desvendar recursos ocultos de plugins e extens√µes de navegador para navegadores conhecidos como Firefox e Chrome. Ele automatiza o processo de descompactar os arquivos empacotados para extrair esses recursos de recursos relevantes em uma extens√£o como `manifest.json`, pastas de localiza√ß√£o ou arquivos de origem Javascript e HTML.

## Refer√™ncias

* **Obrigado a** [**@naivenom**](https://twitter.com/naivenom) **pela ajuda com esta metodologia**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)
* [https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0](https://gist.github.com/LongJohnCoder/9ddf5735df3a4f2e9559665fb864eac0)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:
* Se deseja ver a **sua empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
