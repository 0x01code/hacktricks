# Metodologia de Pentesting em Extens√µes de Navegador

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas

Extens√µes de navegador s√£o escritas em JavaScript e carregadas pelo navegador em segundo plano. Possuem seu pr√≥prio [DOM](https://www.w3schools.com/js/js_htmldom.asp), mas podem interagir com o DOM de outros sites. Isso significa que podem comprometer a confidencialidade, integridade e disponibilidade (CIA) de outros sites.

## Componentes Principais

A estrutura de uma extens√£o √© melhor visualizada e consiste em tr√™s componentes. Vamos examinar cada componente em detalhes.

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption><p><a href="http://webblaze.cs.berkeley.edu/papers/Extensions.pdf">http://webblaze.cs.berkeley.edu/papers/Extensions.pdf</a></p></figcaption></figure>

### **Scripts de Conte√∫do**

Cada script de conte√∫do tem acesso direto ao DOM de uma **p√°gina web √∫nica** e, portanto, est√° exposto a **entradas potencialmente maliciosas**. No entanto, o script de conte√∫do n√£o cont√©m permiss√µes al√©m da capacidade de enviar mensagens para o n√∫cleo da extens√£o.

Para visualizar e depurar scripts de conte√∫do no Chrome, voc√™ pode abrir o menu de ferramentas de desenvolvedor do Chrome em Op√ß√µes > Mais ferramentas > Ferramentas do desenvolvedor OU (Pressione - Ctrl + Shift + I).

Com as ferramentas de desenvolvedor exibidas, clique na aba **Source**, depois na aba **Scripts de Conte√∫do**. Aqui voc√™ pode ver os scripts de conte√∫do em execu√ß√£o das v√°rias extens√µes e definir pontos de interrup√ß√£o para monitorar o fluxo de execu√ß√£o. No nosso caso, mostramos atrav√©s da extens√£o do navegador Wappalyzer.&#x20;

<figure><img src="../../.gitbook/assets/image (1).png" alt=""><figcaption></figcaption></figure>

### **N√∫cleo da Extens√£o**

O n√∫cleo da extens√£o cont√©m a maioria dos privil√©gios/acessos da extens√£o, mas s√≥ pode interagir com o conte√∫do da web por meio de [XMLHttpRequest](https://developer.mozilla.org/en-US/docs/Web/API/XMLHttpRequest) e scripts de conte√∫do. Al√©m disso, o n√∫cleo da extens√£o n√£o tem acesso direto √† m√°quina hospedeira.

### **Bin√°rio Nativo**

A extens√£o permite um bin√°rio nativo que pode **acessar a m√°quina hospedeira com todos os privil√©gios do usu√°rio.** O bin√°rio nativo interage com o n√∫cleo da extens√£o atrav√©s da Interface de Programa√ß√£o de Aplicativos de Plug-in Netscape padr√£o ([NPAPI](https://en.wikipedia.org/wiki/NPAPI)) usada pelo Flash e outros plug-ins de navegador.

### Limites

{% hint style="danger" %}
Para obter os privil√©gios completos do usu√°rio, um atacante deve convencer a extens√£o a passar entrada maliciosa do script de conte√∫do para o n√∫cleo da extens√£o e do n√∫cleo da extens√£o para o bin√°rio nativo.
{% endhint %}

Cada componente da extens√£o √© separado um do outro por **fortes barreiras de prote√ß√£o**. Cada componente √© executado em um **processo separado do sistema operacional**. Scripts de conte√∫do e n√∫cleos de extens√£o s√£o executados em **processos de sandbox** inacess√≠veis √† maioria dos servi√ßos do sistema operacional. &#x20;

Al√©m disso, os scripts de conte√∫do s√£o separados das p√°ginas web associadas por **executarem em um heap JavaScript separado**. O script de conte√∫do e a p√°gina web t√™m **acesso ao mesmo DOM subjacente**, mas os dois **nunca trocam ponteiros JavaScript**, prevenindo o vazamento de funcionalidades JavaScript.

## **`manifest.json`**

Uma extens√£o do Chrome √© apenas uma pasta ZIP com uma extens√£o de arquivo [.crx](https://www.lifewire.com/crx-file-2620391). O n√∫cleo da extens√£o √© o arquivo **`manifest.json`** na raiz da pasta, que especifica o layout, permiss√µes e outras op√ß√µes de configura√ß√£o.

Exemplo:
```json
{
"manifest_version": 2,
"name": "My extension",
"version": "1.0",
"permissions": [
"storage"
],
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
"background": {
"scripts": [
"background.js"
]
},
"options_ui": {
"page": "options.html"
}
}
```
### `content_scripts`

Scripts de conte√∫do s√£o **carregados** sempre que o usu√°rio **navega para uma p√°gina correspondente**, no nosso caso qualquer p√°gina que corresponda √† express√£o **`https://example.com/*`** e que n√£o corresponda √† regex **`*://*/*/business*`**. Eles executam **como os pr√≥prios scripts da p√°gina** e t√™m acesso arbitr√°rio ao [Modelo de Objeto de Documento (DOM)](https://developer.mozilla.org/en-US/docs/Web/API/Document\_Object\_Model) da p√°gina.
```json
"content_scripts": [
{
"js": [
"script.js"
],
"matches": [
"https://example.com/*",
"https://www.example.com/*"
],
"exclude_matches": ["*://*/*business*"],
}
],
```
Para incluir ou excluir mais URLs, tamb√©m √© poss√≠vel usar **`include_globs`** e **`exclude_globs`**.

Este √© um exemplo de script de conte√∫do que adicionar√° um bot√£o de explica√ß√£o √† p√°gina quando [a API de armazenamento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para recuperar o valor `message` do armazenamento da extens√£o.
```js
chrome.storage.local.get("message", result =>
{
let div = document.createElement("div");
div.innerHTML = result.message + " <button>Explain</button>";
div.querySelector("button").addEventListener("click", () =>
{
chrome.runtime.sendMessage("explain");
});
document.body.appendChild(div);
});
```
<figure><img src="../../.gitbook/assets/image (7).png" alt=""><figcaption></figcaption></figure>

Quando este bot√£o √© clicado, o script de conte√∫do **usa** a [**runtime.sendMessage() API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/sendMessage) **para enviar uma mensagem √†s p√°ginas da extens√£o**. Isso ocorre porque um script de conte√∫do s√≥ tem acesso direto a um punhado de APIs, como `storage`. Tudo o mais deve ser feito por p√°ginas de extens√£o √†s quais os scripts de conte√∫do podem enviar mensagens.

{% hint style="warning" %}
As **capacidades do script de conte√∫do** diferem ligeiramente dependendo do navegador. Para navegadores baseados em Chromium, voc√™ pode encontrar a lista na [documenta√ß√£o dos Chrome Developers](https://developer.chrome.com/docs/extensions/mv3/content\_scripts/#capabilities), para o Firefox, [MDN](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/Content\_scripts#webextension\_apis) √© a fonte definitiva.\
Lembre-se de que o Script de Conte√∫do tamb√©m pode **comunicar com os scripts de fundo** para que eles realizem a√ß√µes e enviem de volta a resposta.
{% endhint %}

### Scripts de conte√∫do injetados

{% hint style="success" %}
Note que **Scripts de Conte√∫do n√£o s√£o obrigat√≥rios**, pois tamb√©m √© poss√≠vel **injetar** scripts **dinamicamente** e **programaticamente** em p√°ginas web atrav√©s de **`tabs.executeScript`**. Isso na verdade fornece controles mais **granulares**.
{% endhint %}

Para injetar um script de conte√∫do programaticamente, sua extens√£o precisa de [permiss√µes de host](https://developer.chrome.com/docs/extensions/reference/permissions) para a p√°gina na qual est√° tentando injetar scripts. As permiss√µes de host podem ser concedidas **solicitando-as** como parte do manifesto da sua extens√£o ou temporariamente via [**activeTab**](https://developer.chrome.com/docs/extensions/reference/manifest/activeTab)**.**

#### Exemplo de extens√£o baseada em activeTab

{% code title="manifest.json" %}
```json
{
"name": "My extension",
...
"permissions": [
"activeTab",
"scripting"
],
"background": {
"service_worker": "background.js"
},
"action": {
"default_title": "Action Button"
}
}
```
* **Injetar um arquivo JS ao clicar:**
```javascript
// content-script.js
document.body.style.backgroundColor = "orange";

//service-worker.js - Inject the JS file
chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target: { tabId: tab.id },
files: ["content-script.js"]
});
});
```
* **Injetar uma fun√ß√£o** ao clicar:
```javascript
//service-worker.js - Inject a function
function injectedFunction() {
document.body.style.backgroundColor = "orange";
}

chrome.action.onClicked.addListener((tab) => {
chrome.scripting.executeScript({
target : {tabId : tab.id},
func : injectedFunction,
});
});
```
#### Exemplo com permiss√µes de script
```javascript
// service-workser.js
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.nytimes.com/*" ],
excludeMatches : [ "*://*/*business*" ],
js : [ "contentScript.js" ],
}]);

// ANother example
chrome.tabs.executeScript(tabId, { file: "content_script.js" });
```
Para incluir ou excluir mais URLs, tamb√©m √© poss√≠vel usar **`include_globs`** e **`exclude_globs`**.

### Scripts de Conte√∫do `run_at`

O campo `run_at` controla **quando os arquivos JavaScript s√£o injetados na p√°gina web**. O valor preferido e padr√£o √© `"document_idle"`.

Os valores poss√≠veis s√£o:

* **`document_idle`**: Sempre que poss√≠vel
* **`document_start`**: Ap√≥s quaisquer arquivos de `css`, mas antes de qualquer outra constru√ß√£o do DOM ou execu√ß√£o de outro script.
* **`document_end`**: Imediatamente ap√≥s a conclus√£o do DOM, mas antes que subrecursos como imagens e frames sejam carregados.

#### Via `manifest.json`
```json
{
"name": "My extension",
...
"content_scripts": [
{
"matches": ["https://*.nytimes.com/*"],
"run_at": "document_idle",
"js": ["contentScript.js"]
}
],
...
}

```
Via **`service-worker.js`**
```javascript
chrome.scripting.registerContentScripts([{
id : "test",
matches : [ "https://*.nytimes.com/*" ],
runAt : "document_idle",
js : [ "contentScript.js" ],
}]);
```
### `background`

Quando scripts de conte√∫do enviam uma mensagem, o destino √© a **p√°gina de background**. A p√°gina de background √© uma p√°gina especial que est√° **sempre presente** a menos que especificado de outra forma no manifesto da extens√£o. Ela √© invis√≠vel para o usu√°rio, apesar de ser uma p√°gina regular com seu pr√≥prio DOM e tudo mais. Sua fun√ß√£o √© tipicamente coordenar todas as outras partes da extens√£o.

{% hint style="success" %}
Se uma p√°gina de background n√£o for declarada explicitamente, o navegador ir√° gentilmente **gerar uma** automaticamente e garantir que todos os **scripts de background declarados sejam carregados** nela, como no exemplo anterior de manifest.json.
{% endhint %}

Exemplo de script de background:
```js
chrome.runtime.onMessage.addListener((request, sender, sendResponse) =>
{
if (request == "explain")
{
chrome.tabs.create({ url: "https://example.net/explanation" });
}
})
```
Ele usa a [API runtime.onMessage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/runtime/onMessage) para ouvir mensagens. Quando uma mensagem `"explain"` √© recebida, ele usa a [API tabs](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) para abrir uma p√°gina em uma nova aba.

### P√°ginas de op√ß√µes e outras

Extens√µes de navegador podem conter v√°rios tipos de p√°ginas:

* **P√°ginas de a√ß√£o** s√£o exibidas em um **menu suspenso quando o √≠cone da extens√£o** √© clicado.
* P√°ginas que a extens√£o ir√° **carregar em uma nova aba**.
* **P√°ginas de Op√ß√µes**: Esta p√°gina √© exibida sobre a extens√£o quando clicada. No manifesto anterior No meu caso, eu consegui acessar esta p√°gina em `chrome://extensions/?options=fadlhnelkbeojnebcbkacjilhnbjfjca` ou clicando:

<figure><img src="../../.gitbook/assets/image (8).png" alt="" width="375"><figcaption></figcaption></figure>

Ao contr√°rio da p√°gina de fundo, essas p√°ginas n√£o s√£o persistentes, mas sim carregadas quando necess√°rio. No entanto, todas elas podem **receber mensagens de scripts de conte√∫do**. E todas t√™m **acesso total √†s APIs espec√≠ficas da extens√£o**, conforme as permiss√µes da extens√£o permitem.

No total, os contextos relevantes para extens√µes de navegador parecem assim:

<figure><img src="../../.gitbook/assets/image (9).png" alt="" width="563"><figcaption></figcaption></figure>

### `permissions` & `host_permissions`

**`permissions`** e **`host_permissions`** s√£o entradas do `manifest.json` que indicar√£o **quais permiss√µes** a extens√£o do navegador possui (armazenamento, localiza√ß√£o...) e em **quais p√°ginas da web**.

Como as extens√µes de navegador podem ser t√£o **privilegiadas**, uma maliciosa ou comprometida pode permitir ao atacante **diferentes meios de roubar informa√ß√µes sens√≠veis e espionar o usu√°rio**.

Verifique como essas configura√ß√µes funcionam e como elas podem ser abusadas em:

{% content-ref url="browext-permissions-and-host_permissions.md" %}
[browext-permissions-and-host\_permissions.md](browext-permissions-and-host\_permissions.md)
{% endcontent-ref %}

### `content_security_policy`

Uma **pol√≠tica de seguran√ßa de conte√∫do** tamb√©m pode ser declarada dentro do `manifest.json`. Se houver uma definida, ela poderia ser **vulner√°vel**.

A configura√ß√£o padr√£o para p√°ginas de extens√µes de navegador √© bastante restritiva:
```bash
script-src 'self'; object-src 'self';
```
Para mais informa√ß√µes sobre CSP e poss√≠veis bypasses, confira:

{% content-ref url="../content-security-policy-csp-bypass/" %}
[content-security-policy-csp-bypass](../content-security-policy-csp-bypass/)
{% endcontent-ref %}

### `web_accessible_resources`

para que uma p√°gina da web acesse uma p√°gina de uma Extens√£o de Navegador, uma p√°gina `.html` por exemplo, esta p√°gina precisa ser mencionada no campo **`web_accessible_resources`** do `manifest.json`.\
Por exemplo:
```javascript
{
...
"web_accessible_resources": [
{
"resources": [ "images/*.png" ],
"matches": [ "https://example.com/*" ]
},
{
"resources": [ "fonts/*.woff" ],
"matches": [ "https://example.com/*" ]
}
],
...
}
```
Estas p√°ginas s√£o acess√≠veis em URLs como:
```
chrome-extension://<extension-id>/message.html
```
Em extens√µes p√∫blicas, o **extension-id √© acess√≠vel**:

<figure><img src="../../.gitbook/assets/image (722).png" alt="" width="375"><figcaption></figcaption></figure>

No entanto, se o par√¢metro `manifest.json` **`use_dynamic_url`** for usado, esse **id pode ser din√¢mico**.

Ser permitido acessar essas p√°ginas torna essas p√°ginas **potencialmente vulner√°veis a ClickJacking**:

{% content-ref url="browext-clickjacking.md" %}
[browext-clickjacking.md](browext-clickjacking.md)
{% endcontent-ref %}

{% hint style="success" %}
Permitir que essas p√°ginas sejam carregadas apenas pela extens√£o e n√£o por URLs aleat√≥rias pode prevenir ataques de ClickJacking.
{% endhint %}

### `externally_connectable`

Conforme a [**documenta√ß√£o**](https://developer.chrome.com/docs/extensions/reference/manifest/externally-connectable), a propriedade `"externally_connectable"` do manifesto declara **quais extens√µes e p√°ginas da web podem se conectar** √† sua extens√£o atrav√©s de [runtime.connect](https://developer.chrome.com/docs/extensions/reference/runtime#method-connect) e [runtime.sendMessage](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage).

* Se a chave **`externally_connectable`** **n√£o** for declarada no manifesto da sua extens√£o ou for declarada como **`"ids": ["*"]`**, **todas as extens√µes podem se conectar, mas nenhuma p√°gina da web pode se conectar**.
* Se **IDs espec√≠ficos forem especificados**, como em `"ids": ["aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa"]`, **apenas aquelas aplica√ß√µes** podem se conectar.
* Se **matches** forem especificados, aquelas aplica√ß√µes da web poder√£o se conectar:
```json
"matches": [
"https://*.google.com/*",
"*://*.chromium.org/*",
```
* Se estiver especificado como vazio: **`"externally_connectable": {}`**, nenhum aplicativo ou p√°gina web poder√° se conectar.

Quanto **menos extens√µes e URLs** indicadas aqui, **menor ser√° a superf√≠cie de ataque**.

{% hint style="danger" %}
Se uma p√°gina web **vulner√°vel a XSS ou takeover** estiver indicada em **`externally_connectable`**, um atacante poder√° **enviar mensagens diretamente para o script de background**, contornando completamente o Content Script e seu CSP.

Portanto, este √© um **bypass muito poderoso**.
{% endhint %}

## Comunica√ß√£o Web **‚ÜîÔ∏é** Content Script

Embora os ambientes de execu√ß√£o dos **content scripts e das p√°ginas** que os hospedam sejam **isolados** um do outro, eles **compartilham acesso ao DOM da p√°gina**. Se a p√°gina deseja se comunicar com o content script, ou com a extens√£o atrav√©s do content script, deve faz√™-lo atrav√©s do **DOM compartilhado**.

### Postar Mensagens

{% code title="content-script.js" %}
```javascript
var port = chrome.runtime.connect();

window.addEventListener("message", (event) => {
// We only accept messages from ourselves
if (event.source !== window) {
return;
}

if (event.data.type && (event.data.type === "FROM_PAGE")) {
console.log("Content script received: " + event.data.text);
port.postMessage(event.data.text);
}
}, false);
```
```
{% endcode %}

{% code title="example.js" %}
```
```javascript
document.getElementById("theButton").addEventListener("click", () => {
window.postMessage(
{type : "FROM_PAGE", text : "Hello from the webpage!"}, "*");
}, false);
```
{% endcode %}

Uma comunica√ß√£o segura de Post Message deve verificar a autenticidade da mensagem recebida, isso pode ser feito verificando:

* **`event.isTrusted`**: Isso √© verdadeiro apenas se o evento foi acionado por uma a√ß√£o do usu√°rio
* O script de conte√∫do pode estar esperando uma mensagem apenas se o usu√°rio realizar alguma a√ß√£o
* **dom√≠nio de origem**: Pode ser verificado contra uma lista de permiss√µes de dom√≠nios.
* Se um regex √© usado, tenha muito cuidado
* **Fonte**: `received_message.source !== window` pode ser usado para verificar se a mensagem foi **da mesma janela** onde o Script de Conte√∫do est√° ouvindo.

Os controles anteriores, mesmo que realizados, podem ser vulner√°veis, ent√£o verifique na seguinte p√°gina **potenciais bypasses de Post Message**:

{% content-ref url="../postmessage-vulnerabilities/" %}
[postmessage-vulnerabilities](../postmessage-vulnerabilities/)
{% endcontent-ref %}

### Iframe

Outra poss√≠vel forma de comunica√ß√£o pode ser atrav√©s de **URLs de Iframe**, voc√™ pode encontrar um exemplo em:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

### DOM

Isso n√£o √© "exatamente" uma forma de comunica√ß√£o, mas a **web e o script de conte√∫do ter√£o acesso ao DOM da web**. Ent√£o, se o **script de conte√∫do** est√° lendo alguma informa√ß√£o dele, **confiando no DOM da web**, a web poderia **modificar esses dados** (porque a web n√£o deve ser confi√°vel, ou porque a web √© vulner√°vel a XSS) e **comprometer o Script de Conte√∫do**.

Voc√™ tamb√©m pode encontrar um exemplo de um **XSS baseado em DOM para comprometer uma extens√£o de navegador** em:

{% content-ref url="browext-xss-example.md" %}
[browext-xss-example.md](browext-xss-example.md)
{% endcontent-ref %}

## Informa√ß√µes Sens√≠veis na Mem√≥ria/C√≥digo

Se uma Extens√£o de Navegador armazena **informa√ß√µes sens√≠veis dentro de sua mem√≥ria**, isso poderia ser **despejado** (especialmente em m√°quinas Windows) e **procurado** por essas informa√ß√µes.

Portanto, a mem√≥ria da Extens√£o de Navegador **n√£o deve ser considerada segura** e **informa√ß√µes sens√≠veis** como credenciais ou frases mnem√¥nicas **n√£o devem ser armazenadas**.

Claro, **n√£o coloque informa√ß√µes sens√≠veis no c√≥digo**, pois elas ser√£o **p√∫blicas**.

## Comunica√ß√£o Script de Conte√∫do **‚ÜîÔ∏é** Script de Fundo

Um Script de Conte√∫do pode usar as fun√ß√µes [**runtime.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/runtime#method-sendMessage) **ou** [**tabs.sendMessage()**](https://developer.chrome.com/docs/extensions/reference/tabs#method-sendMessage) para enviar uma mensagem **serializ√°vel em JSON de uso √∫nico**.

Para lidar com a **resposta**, use a **Promise** retornada. No entanto, para compatibilidade com vers√µes anteriores, voc√™ ainda pode passar um **callback** como o √∫ltimo argumento.

Enviar uma solicita√ß√£o de um **script de conte√∫do** se parece com isso:
```javascript
(async () => {
const response = await chrome.runtime.sendMessage({greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
Enviando uma solicita√ß√£o da **extens√£o** (geralmente um **script de background**) para um script de conte√∫do √© semelhante, exceto que voc√™ precisa especificar para qual aba envi√°-la. Este exemplo demonstra o envio de uma mensagem para o script de conte√∫do na aba selecionada.
```javascript
(async () => {
const [tab] = await chrome.tabs.query({active: true, lastFocusedWindow: true});
const response = await chrome.tabs.sendMessage(tab.id, {greeting: "hello"});
// do something with response here, not outside the function
console.log(response);
})();
```
No **lado receptor**, voc√™ precisa configurar um [**runtime.onMessage**](https://developer.chrome.com/docs/extensions/reference/runtime#event-onMessage) **ouvinte de evento** para lidar com a mensagem. Isso parece o mesmo de um script de conte√∫do ou p√°gina de extens√£o.
```javascript
chrome.runtime.onMessage.addListener(
function(request, sender, sendResponse) {
console.log(sender.tab ?
"from a content script:" + sender.tab.url :
"from the extension");
if (request.greeting === "hello")
sendResponse({farewell: "goodbye"});
}
);
```
No exemplo acima, **`sendResponse()`** foi chamado de forma s√≠ncrona. Se voc√™ quiser usar `sendResponse()` de forma **ass√≠ncrona**, adicione `return true;` ao manipulador de eventos `onMessage`.

> Se m√∫ltiplas p√°ginas estiverem ouvindo eventos `onMessage`, **apenas a primeira a chamar `sendResponse()`** para um evento espec√≠fico ter√° sucesso em enviar a resposta. Todas as outras respostas para esse evento ser√£o ignoradas.

Para novas extens√µes, voc√™ deve preferir promessas em vez de callbacks. Se voc√™ estiver usando callbacks, o callback `sendResponse()` s√≥ √© v√°lido se usado de forma s√≠ncrona, ou se o manipulador de eventos retornar `true` para indicar que responder√° de forma ass√≠ncrona. O callback da fun√ß√£o `sendMessage()` ser√° invocado automaticamente se nenhum manipulador retornar true ou se o callback `sendResponse()` for coletado como lixo.

## Carregando uma Extens√£o no Navegador

1. **Baixe** a Extens√£o do Navegador e descompacte
2. V√° para **`chrome://extensions/`** e **ative** o `Modo de Desenvolvedor`
3. Clique no bot√£o **`Carregar descompactado`**

No **Firefox**, v√° para **`about:debugging#/runtime/this-firefox`** e clique no bot√£o **`Carregar Complemento Tempor√°rio`**.

## Obtendo o c√≥digo-fonte da loja

A partir [**daqui**](https://gist.github.com/paulirish/78d6c1406c901be02c2d):

### Op√ß√£o 1: Download da extens√£o via linha de comando como zip e extra√ß√£o

{% code overflow="wrap" %}
```bash
extension_id=jifpbeccnghkjeaalbbjmodiffmgedin   # change this ID
curl -L -o "$extension_id.zip" "https://clients2.google.com/service/update2/crx?response=redirect&os=mac&arch=x86-64&nacl_arch=x86-64&prod=chromecrx&prodchannel=stable&prodversion=44.0.2403.130&x=id%3D$extension_id%26uc"
unzip -d "$extension_id-source" "$extension_id.zip"
```
{% endcode %}

Obrigado ao crxviewer pelo [URL de download m√°gico](https://github.com/Rob--W/crxviewer/blob/6113c25e3569e1ec59365ad9a177aa97e2bcda61/src/cws\_pattern.js#L27-L74).

### Op√ß√£o 2: Use o site CRX Viewer

[https://robwu.nl/crxviewer/](https://robwu.nl/crxviewer/)

### Op√ß√£o 3: Use a extens√£o CRX Viewer

A [Chrome extension source viewer](https://chrome.google.com/webstore/detail/chrome-extension-source-v/jifpbeccnghkjeaalbbjmodiffmgedin?hl=en) √© open source ([reposit√≥rio github](https://github.com/Rob--W/crxviewer)) e facilita muito esse processo.

### Op√ß√£o 3: Visualizar o c√≥digo-fonte da extens√£o instalada localmente

1. Encontre o diret√≥rio do perfil local do Chrome. Abra `chrome://version/` e localize o campo "Caminho do Perfil:". Abra essa pasta.
2. Abra a subpasta `Extensions/`
3. Todas as suas extens√µes est√£o aqui, com o c√≥digo-fonte geralmente leg√≠vel.

#### Mapeamento entre IDs de extens√µes instaladas localmente e nomes

* Em `about:extensions`, ative o Modo Desenvolvedor e voc√™ ver√° IDs sob cada entrada
* Dentro das pastas `Extensions/`, o arquivo manifest.json tem um campo `name` leg√≠vel

## Lista de Verifica√ß√£o de Auditoria de Seguran√ßa

Embora as Extens√µes de Navegador tenham uma **superf√≠cie de ataque limitada**, algumas delas podem conter **vulnerabilidades** ou **melhorias de prote√ß√£o potenciais**. As mais comuns s√£o:

* [ ] **Limitar** o m√°ximo poss√≠vel as **`permissions`** solicitadas
* [ ] **Limitar** o m√°ximo poss√≠vel as **`host_permissions`**
* [ ] Usar uma **`content_security_policy`** **forte**
* [ ] **Limitar** o m√°ximo poss√≠vel o **`externally_connectable`**, se nenhum for necess√°rio e poss√≠vel, n√£o deixe por padr√£o, especifique **`{}`**
* [ ] Se **URL vulner√°vel a XSS ou a takeover** for mencionada aqui, um atacante poder√° **enviar mensagens diretamente aos scripts de background**. Um bypass muito poderoso.
* [ ] **Limitar** o m√°ximo poss√≠vel os **`web_accessible_resources`**, at√© mesmo vazio se poss√≠vel.
* [ ] Se **`web_accessible_resources`** n√£o for nenhum, verificar [**ClickJacking**](browext-clickjacking.md)
* [ ] Se houver alguma **comunica√ß√£o** da **extens√£o** para a **p√°gina web**, [**verificar vulnerabilidades de XSS**](browext-xss-example.md) causadas na comunica√ß√£o.
* [ ] Se Post Messages forem usados, verificar [**vulnerabilidades de Post Message**](../postmessage-vulnerabilities/)**.**
* [ ] Se o **Content Script acessar detalhes do DOM**, verificar se eles **n√£o est√£o introduzindo um XSS** se forem **modificados** pela web
* [ ] Dar uma √™nfase especial se essa comunica√ß√£o tamb√©m estiver envolvida na **comunica√ß√£o Content Script -> Background script**
* [ ] **Informa√ß√µes sens√≠veis n√£o devem ser armazenadas** no c√≥digo da Extens√£o de Navegador
* [ ] **Informa√ß√µes sens√≠veis n√£o devem ser armazenadas** na mem√≥ria da Extens√£o de Navegador

## Ferramentas

### [**Tarnish**](https://thehackerblog.com/tarnish/)

* Baixa qualquer extens√£o do Chrome de um link fornecido da Chrome webstore.
* **Visualizador de [**manifest.json**](https://developer.chrome.com/extensions/manifest)**: simplesmente exibe uma vers√£o em JSON formatado do manifesto da extens√£o.
* **An√°lise de Impress√£o Digital**: Detec√ß√£o de [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) e gera√ß√£o autom√°tica de JavaScript para fingerprinting de extens√µes do Chrome.
* **An√°lise Potencial de Clickjacking**: Detec√ß√£o de p√°ginas HTML de extens√£o com a diretiva [web\_accessible\_resources](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources) definida. Estas s√£o potencialmente vulner√°veis a clickjacking dependendo da finalidade das p√°ginas.
* **Visualizador de Aviso(s) de Permiss√£o**: que mostra uma lista de todos os avisos de prompt de permiss√£o do Chrome que ser√£o exibidos quando um usu√°rio tentar instalar a extens√£o.
* **Fun√ß√£o(√µes) Perigosa(s)**: mostra a localiza√ß√£o de fun√ß√µes perigosas que podem potencialmente ser exploradas por um atacante (por exemplo, fun√ß√µes como innerHTML, chrome.tabs.executeScript).
* **Ponto(s) de Entrada**: mostra onde a extens√£o recebe entrada de usu√°rio/externa. Isso √© √∫til para entender a √°rea de superf√≠cie de uma extens√£o e procurar pontos potenciais para enviar dados maliciosamente elaborados para a extens√£o.
* Tanto o scanner de Fun√ß√£o(√µes) Perigosa(s) quanto o de Ponto(s) de Entrada t√™m o seguinte para seus alertas gerados:
* Trecho de c√≥digo relevante e linha que causou o alerta.
* Descri√ß√£o do problema.
* Um bot√£o "Ver Arquivo" para visualizar o arquivo de c√≥digo completo.
* O caminho do arquivo alertado.
* O URI completo da extens√£o do Chrome do arquivo alertado.
* O tipo de arquivo, como um script de P√°gina de Fundo, Content Script, A√ß√£o do Navegador, etc.
* Se a linha vulner√°vel estiver em um arquivo JavaScript, os caminhos de todas as p√°ginas onde ele est√° inclu√≠do, bem como o tipo dessas p√°ginas e o status de [web\_accessible\_resource](https://developer.chrome.com/extensions/manifest/web\_accessible\_resources).
* **Analisador de Pol√≠tica de Seguran√ßa de Conte√∫do (CSP) e verificador de bypass**: Isso apontar√° fraquezas na CSP da sua extens√£o e tamb√©m iluminar√° quaisquer maneiras potenciais de contornar sua CSP devido a CDNs na lista branca, etc.
* **Bibliotecas Vulner√°veis Conhecidas**: Isso usa [Retire.js](https://retirejs.github.io/retire.js/) para verificar o uso de bibliotecas JavaScript conhecidas por serem vulner√°veis.
* Baixar extens√£o e vers√µes formatadas.
* Baixar a extens√£o original.
* Baixar uma vers√£o embelezada da extens√£o (HTML e JavaScript automaticamente formatados).
* Cache autom√°tico dos resultados da an√°lise, executar uma an√°lise de extens√£o levar√° um bom tempo na primeira vez que voc√™ execut√°-la. No entanto, a segunda vez, assumindo que a extens√£o n√£o foi atualizada, ser√° quase instant√¢nea devido aos resultados estarem em cache.
* URLs de Relat√≥rio Link√°veis, facilmente linkar algu√©m para um relat√≥rio de extens√£o gerado pelo tarnish.

### [Neto](https://github.com/elevenpaths/neto)

O projeto Neto √© um pacote Python 3 concebido para analisar e desvendar recursos ocultos de plugins e extens√µes de navegadores bem conhecidos, como Firefox e Chrome. Ele automatiza o processo de descompactar os arquivos empacotados para extrair esses recursos de recursos relevantes em uma extens√£o como `manifest.json`, pastas de localiza√ß√£o ou arquivos-fonte Javascript e HTML.

## Refer√™ncias

* **Agradecimentos a** [**@naivenom**](https://twitter.com/naivenom) **pela ajuda com esta metodologia**
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)
* [https://palant.info/2022/08/10/anatomy-of-a-basic-extension/](https://palant.info/2022/08/10/anatomy-of-a-basic-extension/)
* [https://palant.info/2022/08/24/attack-surface-of-extension-pages/](https://palant.info/2022/08/24/attack-surface-of-extension-pages/)
* [https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/](https://palant.info/2022/08/31/when-extension-pages-are-web-accessible/)
* [https://help.passbolt.com/assets/files/PBL-02-report.pdf](https://help.passbolt.com/assets/files/PBL-02-report.pdf)
* [https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts](https://developer.chrome.com/docs/extensions/develop/concepts/content-scripts)
* [https://developer.chrome.com/docs/extensions/mv2/background-pages](https://developer.chrome.com/docs/extensions/mv2/background-pages)
* [https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/](https://thehackerblog.com/kicking-the-rims-a-guide-for-securely-writing-and-auditing-chrome-extensions/)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga** me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
