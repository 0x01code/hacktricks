# BrowExt - permisos & host\_permissions

<details>

<summary><strong>Aprende hacking en AWS de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue** a **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de GitHub de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Información Básica

### **`permissions`**

Los permisos se definen en el archivo **`manifest.json`** de la extensión utilizando la propiedad **`permissions`** y permiten el acceso a casi todo lo que un navegador puede acceder (Cookies o Almacenamiento Físico):

El manifiesto anterior declara que la extensión requiere el permiso `storage`. Esto significa que puede usar [la API de almacenamiento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para guardar sus datos de forma persistente. A diferencia de las APIs de cookies o `localStorage` que ofrecen a los usuarios cierto nivel de control, **el almacenamiento de la extensión normalmente solo se puede borrar desinstalando la extensión**.

Una extensión solicitará los permisos indicados en su archivo **`manifest.json`** y después de instalar la extensión, puedes **siempre verificar sus permisos en tu navegador**, como se muestra en esta imagen:

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Puedes encontrar la [**lista completa de permisos que una Extensión de Navegador Chromium puede solicitar aquí**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aquí**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

La configuración opcional pero poderosa **`host_permissions`** indica con qué hosts la extensión va a poder interactuar a través de apis como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), y [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Los siguientes `host_permissions` básicamente permiten todo en la web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
```markdown
Estos son los hosts a los que la extensión del navegador puede acceder libremente. Esto se debe a que cuando una extensión del navegador llama a **`fetch("https://gmail.com/")`**, no está restringida por CORS.

## Abusando de `permissions` y `host_permissions`

### Pestañas

Además, **`host_permissions`** también desbloquean la funcionalidad "avanzada" de la [**API de pestañas**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Permiten que la extensión llame a [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) y no solo obtenga una **lista de las pestañas del navegador del usuario** sino que también aprenda qué **página web (es decir, dirección y título) está cargada**.

{% hint style="danger" %}
No solo eso, oyentes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **también se vuelven mucho más útiles**. Estos serán notificados cada vez que una nueva página se cargue en una pestaña.
{% endhint %}

### Ejecutando scripts de contenido <a href="#running-content-scripts" id="running-content-scripts"></a>

Los scripts de contenido no necesariamente se escriben estáticamente en el manifiesto de la extensión. Dados suficientes **`host_permissions`**, **las extensiones también pueden cargarlos dinámicamente llamando a** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **o** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas API permiten ejecutar no solo archivos contenidos en las extensiones como scripts de contenido sino también **código arbitrario**. La primera permite pasar código JavaScript como una cadena, mientras que la segunda espera una función JavaScript, lo cual es menos propenso a vulnerabilidades de inyección. Aún así, ambas API pueden causar estragos si se usan incorrectamente.

{% hint style="danger" %}
Además de las capacidades anteriores, los scripts de contenido podrían, por ejemplo, **interceptar credenciales** a medida que se ingresan en las páginas web. Otra forma clásica de abusar de ellos es **inyectar publicidad** en cada sitio web. Agregar **mensajes de estafa** para abusar de la credibilidad de sitios web de noticias también es posible. Finalmente, podrían **manipular sitios web bancarios** para desviar transferencias de dinero.
{% endhint %}

### Privilegios implícitos <a href="#implicit-privileges" id="implicit-privileges"></a>

Algunos privilegios de extensión **no tienen que declararse explícitamente**. Un ejemplo es la [API de pestañas](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): su funcionalidad básica es accesible sin ningún privilegio. Cualquier extensión puede ser notificada cuando abres y cierras pestañas, simplemente no sabrá a qué sitio web corresponden estas pestañas.

¿Suena demasiado inofensivo? La API [tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) es algo menos inofensiva. Se puede usar para **crear una nueva pestaña**, esencialmente lo mismo que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) que cualquier sitio web puede llamar. Sin embargo, mientras que `window.open()` está sujeto al **bloqueador de ventanas emergentes, `tabs.create()` no lo está**. 

{% hint style="danger" %}
Una extensión puede crear cualquier número de pestañas cuando quiera.
{% endhint %}

Si revisas los posibles parámetros de `tabs.create()`, también notarás que sus capacidades van más allá de lo que `window.open()` tiene permitido controlar. Y mientras que Firefox no permite usar URIs `data:` con esta API, Chrome no tiene tal protección. **El uso de tales URIs en el nivel superior ha sido** [**prohibido debido a que se abusó de ellas para phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) es muy similar a `tabs.create()` pero **modificará una pestaña existente**. Entonces, una extensión maliciosa puede, por ejemplo, cargar arbitrariamente una página de publicidad en una de tus pestañas y también puede activar la pestaña correspondiente.

### Webcam, geolocalización y amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Probablemente sepas que los sitios web pueden solicitar permisos especiales, por ejemplo, para acceder a tu webcam (herramientas de videoconferencia) o ubicación geográfica (mapas). Son características con considerable potencial de abuso, por lo que los usuarios tienen que confirmar cada vez que todavía quieren esto.

{% hint style="danger" %}
No es así con las extensiones de navegador. **Si una extensión del navegador** [**quiere acceder a tu webcam o micrófono**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, solo necesita pedir permiso una vez**
{% endhint %}

Típicamente, una extensión lo hará inmediatamente después de ser instalada. Una vez que se acepta este aviso, **el acceso a la webcam es posible en cualquier momento**, incluso si el usuario no está interactuando con la extensión en ese momento. Sí, un usuario solo aceptará este aviso si la extensión realmente necesita acceso a la webcam. Pero después de eso, tienen que confiar en que la extensión no grabará nada en secreto.

Con acceso a [tu ubicación geográfica exacta](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) o [contenidos de tu portapapeles](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API), otorgar permiso explícitamente es innecesario por completo. **Una extensión simplemente agrega `geolocation` o `clipboard` a la entrada de** [**permisos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de su manifiesto**. Estos privilegios de acceso se otorgan implícitamente cuando se instala la extensión. Por lo tanto, una extensión maliciosa o comprometida con estos privilegios puede crear tu perfil de movimiento o monitorear tu portapapeles en busca de contraseñas copiadas sin que te des cuenta de nada.

Agregar la palabra clave **`history`** a la entrada de [permisos](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) del manifiesto de la extensión otorga **acceso a la** [**API de historial**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Permite recuperar todo el historial de navegación del usuario de una vez, sin esperar a que el usuario visite estos sitios web nuevamente.

El **permiso `bookmarks`** tiene un potencial de abuso similar, este permite **leer todos los marcadores a través de la** [**API de marcadores**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiso de almacenamiento <a href="#the-storage-permission" id="the-storage-permission"></a>

El almacenamiento de la extensión es simplemente una colección de clave-valor, muy similar a [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que cualquier sitio web podría usar. Por lo tanto, no se debe almacenar información sensible aquí.

Sin embargo, las empresas de publicidad también podrían abusar de este almacenamiento.

### Más permisos

Puedes encontrar la [**lista completa de permisos que una Extensión del Navegador Chromium puede solicitar aquí**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) y una [**lista completa para extensiones de Firefox aquí**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Prevención <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Las políticas para desarrolladores de Google [prohíben explícitamente](https://developer.chrome.com/docs/webstore/program_policies/#permissions) solicitar más privilegios de los necesarios para que la extensión funcione. En mi experiencia, esta regla de hecho funciona. Solo puedo pensar en un caso en el que una extensión del navegador [solicitó demasiados privilegios](https://palant.info/2020/01/13/pwning-avast-secure-browser-for-fun-and-profit/#selecting-a-target), y esta extensión en particular se distribuía con el navegador en lugar de a través de alguna tienda de complementos.

En algunos casos, los navegadores podrían hacerlo mejor para **limitar el potencial de abuso** de los privilegios de las extensiones. Por ejemplo, Chrome permite la grabación de pantalla a través de las API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) o [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/). El potencial de abuso es bajo porque la primera solo se puede iniciar como **respuesta a una acción del usuario** (típicamente haciendo clic en el icono de la extensión) mientras que la segunda muestra un aviso para seleccionar la ventana de la aplicación a grabar. Ambos son suficientes para evitar que las extensiones comiencen a grabar en silencio en segundo plano.

Sin embargo, tales mejoras de seguridad tienden a hacer que las extensiones sean **menos flexibles y menos amigables para el usuario**. Un buen ejemplo aquí es el [permiso activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission). Su propósito es hacer innecesario solicitar privilegios de host para todo internet. En su lugar, la **extensión puede acceder a la pestaña actual cuando se activa explícitamente**, típicamente haciendo clic en su icono.

Ese enfoque funciona bien para algunas extensiones, particularmente aquellas donde el usuario necesita activar explícitamente una acción. No **funciona en escenarios donde las extensiones tienen que realizar su trabajo automáticamente** sin embargo (lo que significa ser más conveniente para el usuario) o donde la acción de la extensión no se puede ejecutar inmediatamente y requiere preparación.

## **Referencias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Aprende AWS hacking de cero a héroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** Consulta los [**PLANES DE SUSCRIPCIÓN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colección de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Únete al** 💬 [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sígueme** en **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) en github.

</details>
```
