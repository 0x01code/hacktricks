# BrowExt - permissions & host\_permissions

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informations de base

### **`permissions`**

Les permissions sont d√©finies dans le fichier **`manifest.json`** de l'extension en utilisant la propri√©t√© **`permissions`** et permettent l'acc√®s √† presque tout ce √† quoi un navigateur peut acc√©der (Cookies ou Stockage Physique) :

Le manifeste pr√©c√©dent d√©clare que l'extension n√©cessite la permission `storage`. Cela signifie qu'elle peut utiliser [l'API de stockage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) pour stocker ses donn√©es de mani√®re persistante. Contrairement aux cookies ou aux API `localStorage` qui donnent aux utilisateurs un certain niveau de contr√¥le, **le stockage de l'extension ne peut normalement √™tre effac√© qu'en d√©sinstallant l'extension**.

Une extension demandera les permissions indiqu√©es dans son fichier **`manifest.json`** et apr√®s l'installation de l'extension, vous pouvez **toujours v√©rifier ses permissions dans votre navigateur**, comme le montre cette image :

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Vous pouvez trouver la [**liste compl√®te des permissions qu'une Extension de Navigateur Chromium peut demander ici**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) et une [**liste compl√®te pour les extensions Firefox ici**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

Le param√®tre optionnel mais puissant **`host_permissions`** indique avec quels h√¥tes l'extension va pouvoir interagir via des apis telles que [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), et [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Les `host_permissions` suivants permettent essentiellement √† tous les web :
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Ces h√¥tes sont ceux auxquels l'extension de navigateur peut acc√©der librement. C'est parce que lorsqu'une extension de navigateur appelle **`fetch("https://gmail.com/")`**, elle n'est pas restreinte par CORS.

## Abuser des `permissions` et `host_permissions`

### Onglets

De plus, **`host_permissions`** d√©bloquent √©galement des fonctionnalit√©s avanc√©es de l'[**API des onglets**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Elles permettent √† l'extension d'appeler [tabs.query()](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) et d'obtenir non seulement une **liste des onglets du navigateur de l'utilisateur** mais aussi de conna√Ætre quelle **page web (c'est-√†-dire adresse et titre) est charg√©e**.

{% hint style="danger" %}
Non seulement cela, des √©couteurs comme [**tabs.onUpdated**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **deviennent √©galement beaucoup plus utiles**. Ils seront notifi√©s chaque fois qu'une nouvelle page se charge dans un onglet.
{% endhint %}

### Ex√©cuter des scripts de contenu <a href="#running-content-scripts" id="running-content-scripts"></a>

Les scripts de contenu ne sont pas n√©cessairement √©crits de mani√®re statique dans le manifeste de l'extension. Avec des **`host_permissions`** suffisants, **les extensions peuvent √©galement les charger dynamiquement en appelant** [**tabs.executeScript()**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ou** [**scripting.executeScript()**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ces deux API permettent d'ex√©cuter non seulement des fichiers contenus dans les extensions en tant que scripts de contenu, mais aussi **du code arbitraire**. La premi√®re permet de passer du code JavaScript sous forme de cha√Æne de caract√®res tandis que la seconde attend une fonction JavaScript, ce qui est moins sujet aux vuln√©rabilit√©s d'injection. N√©anmoins, les deux API peuvent causer des ravages si elles sont mal utilis√©es.

{% hint style="danger" %}
En plus des capacit√©s ci-dessus, les scripts de contenu pourraient par exemple **intercepter des identifiants** au fur et √† mesure de leur saisie sur des pages web. Une autre mani√®re classique de les abuser est **d'injecter de la publicit√©** sur chaque site web. Ajouter des **messages d'escroquerie** pour abuser de la cr√©dibilit√© des sites d'actualit√©s est √©galement possible. Enfin, ils pourraient **manipuler des sites bancaires** pour d√©tourner des transferts d'argent.
{% endhint %}

### Privil√®ges implicites <a href="#implicit-privileges" id="implicit-privileges"></a>

Certains privil√®ges d'extension **n'ont pas besoin d'√™tre d√©clar√©s explicitement**. Un exemple est l'[API des onglets](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs) : ses fonctionnalit√©s de base sont accessibles sans aucun privil√®ge. Toute extension peut √™tre notifi√©e lorsque vous ouvrez et fermez des onglets, elle ne saura simplement pas √† quel site web ces onglets correspondent.

Cela semble trop inoffensif ? L'API [tabs.create()](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) l'est un peu moins. Elle peut √™tre utilis√©e pour **cr√©er un nouvel onglet**, essentiellement la m√™me chose que [window.open()](https://developer.mozilla.org/fr/docs/Web/API/Window/open) qui peut √™tre appel√© par n'importe quel site web. Pourtant, alors que `window.open()` est soumis au **bloqueur de pop-up, `tabs.create()` ne l'est pas**.

{% hint style="danger" %}
Une extension peut cr√©er autant d'onglets qu'elle le souhaite, quand elle le veut.
{% endhint %}

Si vous examinez les param√®tres possibles de `tabs.create()`, vous remarquerez √©galement que ses capacit√©s vont bien au-del√† de ce que `window.open()` est autoris√© √† contr√¥ler. Et tandis que Firefox n'autorise pas l'utilisation d'URI `data:` avec cette API, Chrome n'a pas une telle protection. **L'utilisation de telles URI au niveau sup√©rieur a √©t√©** [**interdite en raison de leur utilisation pour le phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) est tr√®s similaire √† `tabs.create()` mais va **modifier un onglet existant**. Ainsi, une extension malveillante peut par exemple charger arbitrairement une page de publicit√© dans l'un de vos onglets, et elle peut √©galement activer l'onglet correspondant.

### Webcam, g√©olocalisation et amis <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Vous savez probablement que les sites web peuvent demander des permissions sp√©ciales, par exemple pour acc√©der √† votre webcam (outils de vid√©oconf√©rence) ou √† votre position g√©ographique (cartes). Ce sont des fonctionnalit√©s avec un potentiel consid√©rable d'abus, donc les utilisateurs doivent chaque fois confirmer qu'ils veulent toujours cela.

{% hint style="danger" %}
Pas avec les extensions de navigateur. **Si une extension de navigateur** [**veut acc√©der √† votre webcam ou √† votre microphone**](https://developer.mozilla.org/fr/docs/Web/API/MediaDevices/getUserMedia)**, elle n'a besoin de demander la permission qu'une seule fois**
{% endhint %}

Typiquement, une extension le fera imm√©diatement apr√®s son installation. Une fois cette invite accept√©e, **l'acc√®s √† la webcam est possible √† tout moment**, m√™me si l'utilisateur n'interagit pas avec l'extension √† ce moment-l√†. Oui, un utilisateur n'acceptera cette invite que si l'extension a vraiment besoin d'acc√©der √† la webcam. Mais apr√®s cela, ils doivent faire confiance √† l'extension pour ne rien enregistrer secr√®tement.

Avec l'acc√®s √† [votre position g√©ographique exacte](https://developer.mozilla.org/fr/docs/Web/API/Geolocation) ou [au contenu de votre presse-papiers](https://developer.mozilla.org/fr/docs/Web/API/Clipboard_API), accorder explicitement la permission est inutile. **Une extension ajoute simplement `geolocation` ou `clipboard` √† l'entr√©e** [**permissions**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de son manifeste**. Ces privil√®ges d'acc√®s sont alors accord√©s implicitement lors de l'installation de l'extension. Ainsi, une extension malveillante ou compromise avec ces privil√®ges peut cr√©er votre profil de mouvement ou surveiller votre presse-papiers pour des mots de passe copi√©s sans que vous ne remarquiez rien.

Ajouter le mot-cl√© **`history`** √† l'entr√©e [permissions](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) du manifeste de l'extension accorde **l'acc√®s √† l'** [**API de l'historique**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/history). Elle permet de r√©cup√©rer l'int√©gralit√© de l'historique de navigation de l'utilisateur en une seule fois, sans attendre que l'utilisateur visite √† nouveau ces sites web.

La **permission `bookmarks`** a un potentiel d'abus similaire, elle permet **de lire tous les favoris via l'** [**API des favoris**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permission de stockage <a href="#the-storage-permission" id="the-storage-permission"></a>

Le stockage de l'extension est simplement une collection cl√©-valeur, tr√®s similaire √† [localStorage](https://developer.mozilla.org/fr/docs/Web/API/Window/localStorage) que n'importe quel site web pourrait utiliser. Donc, aucune information sensible ne devrait √™tre stock√©e ici.

Cependant, les entreprises de publicit√© pourraient √©galement abuser de ce stockage.

### Plus de permissions

Vous pouvez trouver la [**liste compl√®te des permissions qu'une Extension de Navigateur Chromium peut demander ici**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) et une [**liste compl√®te pour les extensions Firefox ici**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Pr√©vention <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Les politiques de d√©veloppement de Google [interdisent explicitement](https://developer.chrome.com/docs/webstore/program_policies/#permissions) de demander plus de privil√®ges que n√©cessaire pour que l'extension fonctionne. D'apr√®s mon exp√©rience, cette r√®gle fonctionne en fait. Je ne peux penser qu'√† un cas o√π une extension de navigateur [a demand√© trop de privil√®ges](https://palant.info/2020/01/13/pwning-avast-secure-browser-for-fun-and-profit/#selecting-a-target), et cette extension particuli√®re √©tait distribu√©e avec le navigateur plut√¥t que via une boutique d'add-ons.

Dans certains cas, les navigateurs pourraient mieux faire pour **limiter le potentiel d'abus** des privil√®ges d'extension. Par exemple, Chrome permet l'enregistrement d'√©cran via les API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) ou [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/). Le potentiel d'abus est faible car le premier ne peut √™tre d√©marr√© qu'en **r√©ponse √† une action de l'utilisateur** (g√©n√©ralement en cliquant sur l'ic√¥ne de l'extension) tandis que le second affiche une invite pour s√©lectionner la fen√™tre de l'application √† enregistrer. Les deux sont suffisants pour emp√™cher les extensions de commencer √† enregistrer en arri√®re-plan en silence.

Cependant, de telles am√©liorations de s√©curit√© ont tendance √† rendre les extensions **moins flexibles et moins conviviales**. Un bon exemple ici est la [permission activeTab](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission). Son but est de rendre inutile la demande de privil√®ges d'h√¥te pour l'ensemble d'internet. Au lieu de cela, **l'extension peut acc√©der √† l'onglet actuel lorsque l'extension est explicitement activ√©e**, g√©n√©ralement en cliquant sur son ic√¥ne.

Cette approche fonctionne bien pour certaines extensions, en particulier celles o√π l'utilisateur doit d√©clencher explicitement une action. Elle **ne fonctionne pas dans les sc√©narios o√π les extensions doivent effectuer leur travail automatiquement** cependant (ce qui signifie √™tre plus pratique pour l'utilisateur) ou lorsque l'action de l'extension ne peut pas √™tre ex√©cut√©e imm√©diatement et n√©cessite une pr√©paration.

## **R√©f√©rences**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF** Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux repos github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
