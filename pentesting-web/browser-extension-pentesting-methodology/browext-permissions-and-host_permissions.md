# BrowExt - permessi e host_permissions

<details>

<summary><strong>Impara l'hacking AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Esperto Red Team AWS di HackTricks)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata su HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR ai** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos di github.

</details>

## Informazioni di base

### **`permissions`**

I permessi sono definiti nel file **`manifest.json`** dell'estensione utilizzando la propriet√† **`permissions`** e consentono l'accesso a quasi tutto ci√≤ a cui un browser pu√≤ accedere (Cookie o Archiviazione Fisica):

Il manifesto precedente dichiara che l'estensione richiede il permesso `storage`. Ci√≤ significa che pu√≤ utilizzare [l'API di archiviazione](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) per archiviare i suoi dati in modo persistente. A differenza dei cookie o delle API `localStorage` che danno agli utenti un certo livello di controllo, **l'archiviazione dell'estensione di solito pu√≤ essere cancellata solo disinstallando l'estensione**.

Un'estensione richieder√† i permessi indicati nel suo file **`manifest.json`** e Dopo aver installato l'estensione, puoi **sempre controllare i suoi permessi nel tuo browser**, come mostrato in questa immagine:

<figure><img src="../../.gitbook/assets/image (2) (1) (1) (1).png" alt=""><figcaption></figcaption></figure>

Puoi trovare l'[**elenco completo dei permessi che un'estensione del browser Chromium pu√≤ richiedere qui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e un [**elenco completo per le estensioni Firefox qui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

L'impostazione opzionale ma potente **`host_permissions`** indica con quali host l'estensione sar√† in grado di interagire tramite API come [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) e [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Le seguenti `host_permissions` permettono praticamente a ogni sito web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Questi sono gli host a cui l'estensione del browser pu√≤ accedere liberamente. Ci√≤ avviene perch√© quando un'estensione del browser chiama **`fetch("https://gmail.com/")`** non √® limitata da CORS.

## Abuso di `permissions` e `host_permissions`

### Schede

Inoltre, le **`host_permissions`** sbloccano anche la "avanzata" [**API delle schede**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Consentono all'estensione di chiamare [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) e non solo ottenere un **elenco delle schede del browser dell'utente**, ma anche sapere quale **pagina web (indirizzo e titolo) √® caricata**.

{% hint style="danger" %}
Non solo, i listener come [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **diventano anche molto pi√π utili**. Saranno notificati ogni volta che una nuova pagina viene caricata in una scheda.
{% endhint %}

### Esecuzione di script di contenuto <a href="#running-content-scripts" id="running-content-scripts"></a>

Gli script di contenuto non sono necessariamente scritti staticamente nel manifesto dell'estensione. Con sufficienti **`host_permissions`**, le **estensioni possono anche caricarli dinamicamente chiamando** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **o** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Entrambe le API consentono di eseguire non solo file contenuti nelle estensioni come script di contenuto, ma anche **codice arbitrario**. La prima consente di passare del codice JavaScript come stringa, mentre la seconda si aspetta una funzione JavaScript che √® meno soggetta a vulnerabilit√† di iniezione. Tuttavia, entrambe le API causeranno problemi se utilizzate in modo errato.

{% hint style="danger" %}
Oltre alle capacit√† sopra elencate, gli script di contenuto potrebbero ad esempio **intercettare credenziali** mentre vengono inserite nelle pagine web. Un altro modo classico per abusarne √® **iniettare pubblicit√†** su ogni sito web. Aggiungere **messaggi di truffa** per abusare della credibilit√† dei siti di notizie √® anche possibile. Infine, potrebbero **manipolare i siti web bancari** per dirottare trasferimenti di denaro.
{% endhint %}

### Privilegi impliciti <a href="#implicit-privileges" id="implicit-privileges"></a>

Alcuni privilegi delle estensioni **non devono essere dichiarati esplicitamente**. Un esempio √® l'API delle [schede](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): la sua funzionalit√† di base √® accessibile senza alcun privilegio. Qualsiasi estensione pu√≤ essere notificata quando si aprono e si chiudono le schede, semplicemente non sapr√† a quale sito web corrispondono queste schede.

Sembra troppo innocuo? L'API [tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) √® un po' meno innocua. Pu√≤ essere utilizzata per **creare una nuova scheda**, essenzialmente la stessa cosa di [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) che pu√≤ essere chiamata da qualsiasi sito web. Tuttavia, mentre `window.open()` √® soggetto al **blocco popup, `tabs.create()` non lo √®**.

{% hint style="danger" %}
Un'estensione pu√≤ creare quante schede desidera in qualsiasi momento.
{% endhint %}

Se si esaminano i possibili parametri di `tabs.create()`, si noter√† che le sue capacit√† vanno ben oltre quelle consentite a `window.open()`. E mentre Firefox non consente l'uso di URI `data:` con questa API, Chrome non ha tale protezione. **L'uso di tali URI a livello superiore √® stato** [**vietato a causa dell'abuso per il phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) √® molto simile a `tabs.create()` ma **modificher√† una scheda esistente**. Quindi un'estensione dannosa pu√≤ ad esempio caricare arbitrariamente una pagina pubblicitaria in una delle tue schede e pu√≤ attivare anche la scheda corrispondente.

### Webcam, geolocalizzazione e amici <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Probabilmente sai che i siti web possono richiedere permessi speciali, ad esempio per accedere alla tua webcam (strumenti di videoconferenza) o alla posizione geografica (mappe). Sono funzionalit√† con un notevole potenziale di abuso, quindi gli utenti devono confermare ogni volta che desiderano questo.

{% hint style="danger" %}
Non √® cos√¨ con le estensioni del browser. **Se un'estensione del browser** [**vuole accedere alla tua webcam o al microfono**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, deve chiedere il permesso una sola volta**
{% endhint %}

Tipicamente, un'estensione lo far√† immediatamente dopo essere stata installata. Una volta accettato questo prompt, **l'accesso alla webcam √® possibile in qualsiasi momento**, anche se l'utente non sta interagendo con l'estensione in quel momento. S√¨, un utente accetter√† questo prompt solo se l'estensione ha davvero bisogno dell'accesso alla webcam. Ma dopo di che deve fidarsi dell'estensione di non registrare nulla segretamente.

Con l'accesso alla [tua esatta posizione geografica](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) o ai [contenuti degli appunti](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), non √® affatto necessario concedere esplicitamente il permesso. **Un'estensione aggiunge semplicemente `geolocation` o `clipboard` all'** [**voce dei permessi**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **del suo manifesto**. Questi privilegi di accesso vengono quindi concessi implicitamente quando l'estensione viene installata. Quindi un'estensione dannosa o compromessa con questi privilegi pu√≤ creare il tuo profilo di movimento o monitorare il tuo appunti per password copiate senza che tu te ne accorga.

Aggiungendo la parola **`history`** all'[voce dei permessi](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) del manifesto dell'estensione concede **accesso all'** [**API della cronologia**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Consente di recuperare l'intera cronologia di navigazione dell'utente in una sola volta, senza dover attendere che l'utente visiti nuovamente questi siti web.

Il permesso **`bookmarks`** ha un potenziale di abuso simile, questo consente di **leggere tutti i segnalibri tramite l'** [**API dei segnalibri**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permesso di archiviazione <a href="#the-storage-permission" id="the-storage-permission"></a>

L'archiviazione dell'estensione √® semplicemente una raccolta chiave-valore, molto simile a [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) che potrebbe essere utilizzata da qualsiasi sito web. Quindi qui non dovrebbero essere memorizzate informazioni sensibili.

Tuttavia, le aziende pubblicitarie potrebbero anche abusare di questa archiviazione.

### Altri permessi

Puoi trovare l'[**elenco completo dei permessi che un'estensione del browser Chromium pu√≤ richiedere qui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e un [**elenco completo per le estensioni Firefox qui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Prevenzione <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

La politica dello sviluppatore di Google vieta esplicitamente alle estensioni di richiedere pi√π privilegi di quelli necessari per la loro funzionalit√†, mitigando efficacemente le richieste eccessive di permessi. Un caso in cui un'estensione del browser ha superato questo limite coinvolgeva la sua distribuzione con il browser stesso anzich√© tramite un negozio di componenti aggiuntivi.

I browser potrebbero limitare ulteriormente l'abuso dei privilegi delle estensioni. Ad esempio, le API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) e [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) di Chrome, utilizzate per la registrazione dello schermo, sono progettate per ridurre al minimo l'abuso. L'API tabCapture pu√≤ essere attivata solo attraverso un'interazione diretta dell'utente, ad esempio facendo clic sull'icona dell'estensione, mentre desktopCapture richiede la conferma dell'utente affinch√© la finestra venga registrata, impedendo attivit√† di registrazione clandestina.

Tuttavia, il rafforzamento delle misure di sicurezza comporta spesso una diminuzione della flessibilit√† e della facilit√† d'uso delle estensioni. Il permesso [activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) illustra questo compromesso. √à stato introdotto per eliminare la necessit√† per le estensioni di richiedere privilegi host in tutto Internet, consentendo alle estensioni di accedere solo alla scheda corrente su esplicita attivazione dell'utente. Questo modello √® efficace per le estensioni che richiedono azioni avviate dall'utente ma non √® sufficiente per quelle che richiedono azioni automatiche o preventive, compromettendo cos√¨ la comodit√† e la reattivit√† immediata.
## **Riferimenti**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Impara l'hacking di AWS da zero a eroe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Altri modi per supportare HackTricks:

* Se desideri vedere la tua **azienda pubblicizzata in HackTricks** o **scaricare HackTricks in PDF** Controlla i [**PIANI DI ABBONAMENTO**](https://github.com/sponsors/carlospolop)!
* Ottieni il [**merchandising ufficiale di PEASS & HackTricks**](https://peass.creator-spring.com)
* Scopri [**La Famiglia PEASS**](https://opensea.io/collection/the-peass-family), la nostra collezione di esclusive [**NFT**](https://opensea.io/collection/the-peass-family)
* **Unisciti al** üí¨ [**gruppo Discord**](https://discord.gg/hRep4RUj7f) o al [**gruppo telegram**](https://t.me/peass) o **seguici** su **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Condividi i tuoi trucchi di hacking inviando PR a** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
