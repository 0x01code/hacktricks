# BrowExt - autorisations et host_permissions

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Informations de base

### **`permissions`**

Les autorisations sont d√©finies dans le fichier **`manifest.json`** de l'extension en utilisant la propri√©t√© **`permissions`** et permettent d'acc√©der √† presque tout ce √† quoi un navigateur peut acc√©der (cookies ou stockage physique) :

Le manifeste pr√©c√©dent d√©clare que l'extension n√©cessite l'autorisation `storage`. Cela signifie qu'elle peut utiliser [l'API de stockage](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) pour stocker ses donn√©es de mani√®re persistante. Contrairement aux cookies ou aux API `localStorage` qui donnent aux utilisateurs un certain niveau de contr√¥le, **le stockage de l'extension ne peut normalement √™tre effac√© que par la d√©sinstallation de l'extension**.

Une extension demandera les autorisations indiqu√©es dans son fichier **`manifest.json`** et apr√®s l'installation de l'extension, vous pouvez **toujours v√©rifier ses autorisations dans votre navigateur**, comme le montre cette image :

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Vous pouvez trouver la [**liste compl√®te des autorisations qu'une extension de navigateur Chromium peut demander ici**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) et une [**liste compl√®te pour les extensions Firefox ici**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

### `host_permissions`

Le param√®tre facultatif mais puissant **`host_permissions`** indique avec quels h√¥tes l'extension va pouvoir interagir via des APIs telles que [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) et [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

Les `host_permissions` suivants permettent essentiellement √† tous les sites web :
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Voici les h√¥tes auxquels l'extension du navigateur peut acc√©der librement. Cela est d√ª au fait que lorsqu'une extension de navigateur appelle **`fetch("https://gmail.com/")`**, elle n'est pas restreinte par CORS.

## Abus des `permissions` et `host_permissions`

### Onglets

De plus, les **`host_permissions`** d√©bloquent √©galement les fonctionnalit√©s avanc√©es de l'API des [**onglets**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Ils permettent √† l'extension d'appeler [tabs.query()](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) et non seulement d'obtenir une **liste des onglets du navigateur de l'utilisateur**, mais aussi de savoir quelle **page web (c'est-√†-dire l'adresse et le titre) est charg√©e**.

{% hint style="danger" %}
De plus, des √©couteurs comme [**tabs.onUpdated**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **deviennent √©galement beaucoup plus utiles**. Ils seront notifi√©s chaque fois qu'une nouvelle page se charge dans un onglet.
{% endhint %}

### Ex√©cution de scripts de contenu <a href="#running-content-scripts" id="running-content-scripts"></a>

Les scripts de contenu ne sont pas n√©cessairement √©crits statiquement dans le manifeste de l'extension. Avec des **`host_permissions`** suffisantes, les **extensions peuvent √©galement les charger dynamiquement en appelant** [**tabs.executeScript()**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ou** [**scripting.executeScript()**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Les deux API permettent d'ex√©cuter non seulement des fichiers contenus dans les extensions en tant que scripts de contenu, mais aussi du **code arbitraire**. Le premier permet de passer du code JavaScript en tant que cha√Æne, tandis que le second attend une fonction JavaScript moins sujette aux vuln√©rabilit√©s d'injection. Cependant, les deux API causeront des ravages s'ils sont mal utilis√©s.

{% hint style="danger" %}
En plus des capacit√©s ci-dessus, les scripts de contenu pourraient par exemple **intercepter des identifiants** au moment o√π ils sont saisis dans les pages web. Une autre fa√ßon classique de les abuser est d'**injecter de la publicit√©** sur chaque site web. Ajouter des **messages d'arnaque** pour abuser de la cr√©dibilit√© des sites d'actualit√©s est √©galement possible. Enfin, ils pourraient **manipuler les sites web bancaires** pour d√©tourner les transferts d'argent.
{% endhint %}

### Privil√®ges implicites <a href="#implicit-privileges" id="implicit-privileges"></a>

Certains privil√®ges d'extension **n'ont pas besoin d'√™tre explicitement d√©clar√©s**. Un exemple est l'API des [onglets](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs) : sa fonctionnalit√© de base est accessible sans aucun privil√®ge. Toute extension peut √™tre notifi√©e lorsque vous ouvrez et fermez des onglets, elle ne saura simplement pas avec quel site web ces onglets correspondent.

Cela semble trop inoffensif ? L'API [tabs.create()](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) l'est un peu moins. Elle peut √™tre utilis√©e pour **cr√©er un nouvel onglet**, essentiellement la m√™me chose que [window.open()](https://developer.mozilla.org/fr/docs/Web/API/Window/open) qui peut √™tre appel√© par n'importe quel site web. Cependant, alors que `window.open()` est soumis au **bloqueur de pop-up, `tabs.create()` ne l'est pas**.

{% hint style="danger" %}
Une extension peut cr√©er autant d'onglets qu'elle le souhaite, √† tout moment.
{% endhint %}

Si vous examinez les param√®tres possibles de `tabs.create()`, vous remarquerez √©galement que ses capacit√©s vont bien au-del√† de ce que `window.open()` est autoris√© √† contr√¥ler. Et bien que Firefox n'autorise pas l'utilisation d'URI `data:` avec cette API, Chrome n'a pas cette protection. **L'utilisation de ces URI au niveau sup√©rieur a √©t√©** [**interdite en raison de leur utilisation abusive pour le phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) est tr√®s similaire √† `tabs.create()` mais **modifiera un onglet existant**. Ainsi, une extension malveillante peut par exemple charger arbitrairement une page publicitaire dans l'un de vos onglets, et elle peut √©galement activer l'onglet correspondant.

### Webcam, g√©olocalisation et compagnie <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Vous savez probablement que les sites web peuvent demander des autorisations sp√©ciales, par exemple pour acc√©der √† votre webcam (outils de visioconf√©rence) ou √† votre emplacement g√©ographique (cartes). Il s'agit de fonctionnalit√©s avec un potentiel consid√©rable d'abus, donc les utilisateurs doivent confirmer √† chaque fois qu'ils le souhaitent.

{% hint style="danger" %}
Ce n'est pas le cas avec les extensions de navigateur. **Si une extension de navigateur** [**veut acc√©der √† votre webcam ou microphone**](https://developer.mozilla.org/fr/docs/Web/API/MediaDevices/getUserMedia)**, elle n'a besoin de demander la permission qu'une seule fois**
{% endhint %}

En g√©n√©ral, une extension le fera imm√©diatement apr√®s son installation. Une fois cette demande accept√©e, **l'acc√®s √† la webcam est possible √† tout moment**, m√™me si l'utilisateur n'interagit pas avec l'extension √† ce moment-l√†. Oui, un utilisateur n'acceptera cette demande que si l'extension a vraiment besoin d'acc√©der √† la webcam. Mais apr√®s cela, il doit faire confiance √† l'extension pour ne pas enregistrer secr√®tement quoi que ce soit.

Avec l'acc√®s √† [votre emplacement g√©ographique exact](https://developer.mozilla.org/fr/docs/Web/API/Geolocation) ou au [contenu de votre presse-papiers](https://developer.mozilla.org/fr/docs/Web/API/Clipboard_API), il n'est pas n√©cessaire de donner une autorisation explicite. **Une extension ajoute simplement `geolocation` ou `clipboard` √† l'entr√©e des** [**permissions**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de son manifeste**. Ces privil√®ges d'acc√®s sont alors accord√©s implicitement lors de l'installation de l'extension. Ainsi, une extension malveillante ou compromise avec ces privil√®ges peut cr√©er votre profil de d√©placement ou surveiller votre presse-papiers pour des mots de passe copi√©s sans que vous ne remarquiez quoi que ce soit.

Ajouter le mot-cl√© **`history`** √† l'entr√©e des [permissions](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) du manifeste de l'extension accorde **l'acc√®s √† l'** [**API de l'historique**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/history). Cela permet de r√©cup√©rer l'int√©gralit√© de l'historique de navigation de l'utilisateur en une seule fois, sans attendre que l'utilisateur visite √† nouveau ces sites web.

La **permission `bookmarks`** a un potentiel d'abus similaire, celle-ci permet de **lire tous les favoris via l'** [**API des favoris**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permission de stockage <a href="#the-storage-permission" id="the-storage-permission"></a>

Le stockage de l'extension est simplement une collection cl√©-valeur, tr√®s similaire √† [localStorage](https://developer.mozilla.org/fr/docs/Web/API/Window/localStorage) que n'importe quel site web pourrait utiliser. Ainsi, aucune information sensible ne devrait √™tre stock√©e ici.

Cependant, les entreprises de publicit√© pourraient √©galement abuser de ce stockage.

### Plus de permissions

Vous pouvez trouver la [**liste compl√®te des permissions qu'une extension de navigateur Chromium peut demander ici**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) et une [**liste compl√®te pour les extensions Firefox ici**](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Pr√©vention <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

La politique des d√©veloppeurs de Google interdit explicitement aux extensions de demander plus de privil√®ges que n√©cessaire pour leur fonctionnalit√©, att√©nuant ainsi les demandes excessives de permissions. Un cas o√π une extension de navigateur a d√©pass√© cette limite impliquait sa distribution avec le navigateur lui-m√™me plut√¥t que par le biais d'un magasin d'extensions.

Les navigateurs pourraient √©galement limiter davantage les abus des privil√®ges des extensions. Par exemple, les API [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) et [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) de Chrome, utilis√©es pour l'enregistrement d'√©cran, sont con√ßues pour minimiser les abus. L'API tabCapture ne peut √™tre activ√©e que par une interaction directe de l'utilisateur, comme en cliquant sur l'ic√¥ne de l'extension, tandis que desktopCapture n√©cessite une confirmation de l'utilisateur pour enregistrer la fen√™tre, emp√™chant ainsi les activit√©s d'enregistrement clandestines.

Cependant, renforcer les mesures de s√©curit√© entra√Æne souvent une diminution de la flexibilit√© et de la convivialit√© des extensions. La [permission activeTab](https://developer.mozilla.org/fr/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission) illustre ce compromis. Elle a √©t√© introduite pour √©liminer le besoin pour les extensions de demander des privil√®ges d'h√¥te sur l'ensemble d'Internet, permettant aux extensions d'acc√©der uniquement √† l'onglet actuel sur activation explicite par l'utilisateur. Ce mod√®le est efficace pour les extensions n√©cessitant des actions initi√©es par l'utilisateur, mais il est insuffisant pour celles n√©cessitant des actions automatiques ou pr√©ventives, compromettant ainsi la commodit√© et la r√©activit√© imm√©diate.

## **R√©f√©rences**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

D'autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez** üí¨ le [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
