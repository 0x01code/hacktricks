# BrowExt - permiss√µes & host\_permissions

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) no github.

</details>

## Informa√ß√µes B√°sicas

### **`permissions`**

Permiss√µes s√£o definidas no arquivo **`manifest.json`** da extens√£o usando a propriedade **`permissions`** e permitem acesso a quase tudo que um navegador pode acessar (Cookies ou Armazenamento F√≠sico):

O manifesto anterior declara que a extens√£o requer a permiss√£o `storage`. Isso significa que ela pode usar [a API de armazenamento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para guardar seus dados de forma persistente. Diferente dos cookies ou APIs `localStorage` que d√£o aos usu√°rios algum n√≠vel de controle, **o armazenamento da extens√£o normalmente s√≥ pode ser limpo desinstalando a extens√£o**.

Uma extens√£o solicitar√° as permiss√µes indicadas em seu arquivo **`manifest.json`** e ap√≥s instalar a extens√£o, voc√™ pode **sempre verificar suas permiss√µes no seu navegador**, como mostrado nesta imagem:

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Voc√™ pode encontrar a [**lista completa de permiss√µes que uma Extens√£o de Navegador Chromium pode solicitar aqui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e uma [**lista completa para extens√µes do Firefox aqui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

A configura√ß√£o opcional, mas poderosa, **`host_permissions`** indica com quais hosts a extens√£o poder√° interagir atrav√©s de APIs como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest), e [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

As seguintes `host_permissions` basicamente permitem tudo na web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Estes s√£o os hosts aos quais a extens√£o do navegador pode acessar livremente. Isso ocorre porque quando uma extens√£o do navegador chama **`fetch("https://gmail.com/")`**, ela n√£o √© restrita pelo CORS.

## Abusando de `permissions` e `host_permissions`

### Abas

Al√©m disso, **`host_permissions`** tamb√©m desbloqueiam funcionalidades "avan√ßadas" da [**API de abas**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Elas permitem que a extens√£o chame [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) e obtenha n√£o apenas uma **lista das abas do navegador do usu√°rio**, mas tamb√©m saiba qual **p√°gina da web (ou seja, endere√ßo e t√≠tulo) est√° carregada**.

{% hint style="danger" %}
N√£o s√≥ isso, ouvintes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **tornam-se muito mais √∫teis tamb√©m**. Eles ser√£o notificados sempre que uma nova p√°gina for carregada em uma aba.
{% endhint %}

### Executando scripts de conte√∫do <a href="#running-content-scripts" id="running-content-scripts"></a>

Scripts de conte√∫do n√£o s√£o necessariamente escritos estaticamente no manifesto da extens√£o. Dadas suficientes **`host_permissions`**, **extens√µes tamb√©m podem carreg√°-los dinamicamente chamando** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ou** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas as APIs permitem executar n√£o apenas arquivos contidos nas extens√µes como scripts de conte√∫do, mas tamb√©m **c√≥digo arbitr√°rio**. A primeira permite passar c√≥digo JavaScript como uma string, enquanto a segunda espera uma fun√ß√£o JavaScript, que √© menos propensa a vulnerabilidades de inje√ß√£o. Ainda assim, ambas as APIs podem causar estragos se mal utilizadas.

{% hint style="danger" %}
Al√©m das capacidades acima, scripts de conte√∫do, por exemplo, podem **interceptar credenciais** √† medida que s√£o inseridas em p√°ginas da web. Outra maneira cl√°ssica de abusar deles √© **injetar publicidade** em cada site. Adicionar **mensagens de golpe** para abusar da credibilidade de sites de not√≠cias tamb√©m √© poss√≠vel. Finalmente, eles podem **manipular sites banc√°rios** para redirecionar transfer√™ncias de dinheiro.
{% endhint %}

### Privil√©gios impl√≠citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Alguns privil√©gios de extens√£o **n√£o precisam ser declarados explicitamente**. Um exemplo √© a [API de abas](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): sua funcionalidade b√°sica √© acess√≠vel sem quaisquer privil√©gios. Qualquer extens√£o pode ser notificada quando voc√™ abre e fecha abas, apenas n√£o saber√° a qual site essas abas correspondem.

Parece inofensivo demais? A [API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) √© um pouco menos. Pode ser usada para **criar uma nova aba**, essencialmente o mesmo que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open), que pode ser chamado por qualquer site. No entanto, enquanto `window.open()` est√° sujeito ao **bloqueador de pop-up, `tabs.create()` n√£o est√°**.

{% hint style="danger" %}
Uma extens√£o pode criar qualquer n√∫mero de abas sempre que quiser.
{% endhint %}

Se voc√™ olhar os poss√≠veis par√¢metros de `tabs.create()`, tamb√©m notar√° que suas capacidades v√£o muito al√©m do que `window.open()` tem permiss√£o para controlar. E enquanto o Firefox n√£o permite o uso de URIs `data:` com esta API, o Chrome n√£o tem tal prote√ß√£o. **O uso de tais URIs no n√≠vel superior foi** [**proibido devido ao abuso para phishing**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) √© muito semelhante a `tabs.create()`, mas **modificar√° uma aba existente**. Ent√£o, uma extens√£o maliciosa pode, por exemplo, carregar arbitrariamente uma p√°gina de publicidade em uma de suas abas e tamb√©m pode ativar a aba correspondente.

### Webcam, geolocaliza√ß√£o e amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Voc√™ provavelmente sabe que sites podem solicitar permiss√µes especiais, por exemplo, para acessar sua webcam (ferramentas de videoconfer√™ncia) ou localiza√ß√£o geogr√°fica (mapas). S√£o recursos com consider√°vel potencial de abuso, ent√£o os usu√°rios t√™m que confirmar cada vez que ainda querem isso.

{% hint style="danger" %}
N√£o √© o caso com extens√µes de navegador. **Se uma extens√£o do navegador** [**quer acesso √† sua webcam ou microfone**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, ela s√≥ precisa pedir permiss√£o uma vez**
{% endhint %}

Normalmente, uma extens√£o far√° isso imediatamente ap√≥s ser instalada. Uma vez que este prompt √© aceito, **o acesso √† webcam √© poss√≠vel a qualquer momento**, mesmo que o usu√°rio n√£o esteja interagindo com a extens√£o naquele momento. Sim, um usu√°rio s√≥ aceitar√° este prompt se a extens√£o realmente precisar de acesso √† webcam. Mas depois disso, eles t√™m que confiar que a extens√£o n√£o gravar√° nada secretamente.

Com acesso √† [sua localiza√ß√£o geogr√°fica exata](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) ou [conte√∫dos da sua √°rea de transfer√™ncia](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API), conceder permiss√£o explicitamente √© desnecess√°rio. **Uma extens√£o simplesmente adiciona `geolocation` ou `clipboard` √† entrada de** [**permiss√µes**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **do seu manifesto**. Esses privil√©gios de acesso s√£o ent√£o concedidos implicitamente quando a extens√£o √© instalada. Assim, uma extens√£o maliciosa ou comprometida com esses privil√©gios pode criar seu perfil de movimento ou monitorar sua √°rea de transfer√™ncia para senhas copiadas sem que voc√™ perceba nada.

Adicionar a palavra-chave **`history`** √† entrada de [permiss√µes](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) do manifesto da extens√£o concede **acesso √†** [**API de hist√≥rico**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Isso permite recuperar todo o hist√≥rico de navega√ß√£o do usu√°rio de uma s√≥ vez, sem esperar que o usu√°rio visite esses sites novamente.

A **permiss√£o `bookmarks`** tem potencial de abuso semelhante, ela permite **ler todos os favoritos atrav√©s da** [**API de favoritos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiss√£o de armazenamento <a href="#the-storage-permission" id="the-storage-permission"></a>

O armazenamento da extens√£o √© meramente uma cole√ß√£o de chave-valor, muito semelhante ao [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que qualquer site poderia usar. Portanto, nenhuma informa√ß√£o sens√≠vel deve ser armazenada aqui.

No entanto, empresas de publicidade tamb√©m poderiam abusar desse armazenamento.

### Mais permiss√µes

Voc√™ pode encontrar a [**lista completa de permiss√µes que uma Extens√£o do Navegador Chromium pode solicitar aqui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e uma [**lista completa para extens√µes do Firefox aqui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Preven√ß√£o <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

As pol√≠ticas de desenvolvedor do Google [pro√≠bem explicitamente](https://developer.chrome.com/docs/webstore/program_policies/#permissions) solicitar mais privil√©gios do que o necess√°rio para a extens√£o funcionar. Na minha experi√™ncia, essa regra de fato funciona. S√≥ consigo pensar em um caso em que uma extens√£o do navegador [solicitou privil√©gios demais](https://palant.info/2020/01/13/pwning-avast-secure-browser-for-fun-and-profit/#selecting-a-target), e essa extens√£o particular estava sendo distribu√≠da com o navegador em vez de via alguma loja de complementos.

Em alguns casos, os navegadores poderiam fazer melhor para **limitar o potencial de abuso** dos privil√©gios das extens√µes. Por exemplo, o Chrome permite a grava√ß√£o de tela atrav√©s das APIs [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) ou [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/). O potencial de abuso √© baixo porque o primeiro s√≥ pode ser iniciado como **resposta a uma a√ß√£o do usu√°rio** (normalmente clicando no √≠cone da extens√£o) enquanto o √∫ltimo traz um prompt para selecionar a janela do aplicativo a ser gravada. Ambos s√£o suficientes para impedir que as extens√µes comecem a gravar silenciosamente em segundo plano.

Tais melhorias de seguran√ßa t√™m a tend√™ncia de tornar as extens√µes **menos flex√≠veis e menos amig√°veis ao usu√°rio** no entanto. Um bom exemplo aqui √© a [permiss√£o activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission). Seu prop√≥sito √© tornar desnecess√°rio solicitar privil√©gios de host para toda a internet. Em vez disso, a **extens√£o pode acessar a aba atual quando a extens√£o √© explicitamente ativada**, normalmente clicando em seu √≠cone.

Essa abordagem funciona bem para algumas extens√µes, particularmente aquelas onde o usu√°rio precisa acionar explicitamente uma a√ß√£o. Ela **n√£o funciona em cen√°rios onde as extens√µes t√™m que realizar seu trabalho automaticamente** no entanto (ou seja, sendo mais conveniente para o usu√°rio) ou onde a a√ß√£o da extens√£o n√£o pode ser executada imediatamente e requer prepara√ß√£o.

## **Refer√™ncias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**merchandising oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
