# BrowExt - permissions & host\_permissions

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告掲載したい場合**や**HackTricksをPDFでダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>

## 基本情報

### **`permissions`**

Permissionsは、ブラウザがアクセスできるほぼすべてのもの（CookiesやPhysical Storage）にアクセスするために、拡張機能の**`manifest.json`**ファイルの**`permissions`**プロパティを使用して定義されます：

上記のmanifestは、拡張機能が`storage` permissionを必要としていることを宣言しています。これは、[storage API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage)を使用してデータを永続的に保存できることを意味します。ユーザーがある程度の制御を持つcookiesや`localStorage`APIとは異なり、**拡張機能のストレージは通常、拡張機能をアンインストールすることでのみクリアできます**。

拡張機能は、**`manifest.json`**ファイルに記載されているpermissionsを要求し、拡張機能をインストールした後、以下の画像に示すように、**ブラウザでいつでもそのpermissionsを確認できます**：

<figure><img src="../../.gitbook/assets/image (2).png" alt=""><figcaption></figcaption></figure>

Chromium Browser Extensionが要求できる[**permissionsの完全なリストはこちら**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions)、Firefox拡張機能の[**完全なリストはこちら**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**です。**

### `host_permissions`

オプションだが強力な設定**`host_permissions`**は、[`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies)、[`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest)、[`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs)などのAPIを介してどのホストと拡張機能が対話できるかを示します。

以下の`host_permissions`は基本的にすべてのwebを許可します：
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
これらはブラウザ拡張機能が自由にアクセスできるホストです。これは、ブラウザ拡張機能が **`fetch("https://gmail.com/")`** を呼び出すとき、CORSによって制限されないためです。

## `permissions` と `host_permissions` の悪用

### タブ

さらに、**`host_permissions`** は「高度な」[**タブ API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) **機能を解除します。** これにより、拡張機能は [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) を呼び出し、**ユーザーのブラウザタブのリスト**だけでなく、どの**ウェブページ（つまりアドレスとタイトル）がロードされているか**も知ることができます。

{% hint style="danger" %}
それだけでなく、[**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) のようなリスナーもはるかに便利になります。これらは、新しいページがタブにロードされるたびに通知されます。
{% endhint %}

### コンテンツスクリプトの実行 <a href="#running-content-scripts" id="running-content-scripts"></a>

コンテンツスクリプトは必ずしも静的に拡張機能マニフェストに書き込まれるわけではありません。十分な **`host_permissions`** を持っていれば、**拡張機能は** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **または** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript) **を呼び出して動的にロードすることもできます。**

両方のAPIは、拡張機能に含まれるファイルだけでなく、**任意のコード**も実行できます。前者はJavaScriptコードを文字列として渡すことができ、後者はインジェクションの脆弱性が少ないJavaScript関数を期待します。それでも、両方のAPIが誤用されると大混乱を引き起こします。

{% hint style="danger" %}
上記の機能に加えて、コンテンツスクリプトは例えばウェブページに入力された**認証情報を傍受する**ことができます。別の典型的な悪用方法は、あらゆるウェブサイトに**広告を注入する**ことです。ニュースウェブサイトの信頼性を悪用するために**詐欺メッセージ**を追加することも可能です。最終的には、**銀行**のウェブサイトを操作して送金をリダイレクトすることもできます。
{% endhint %}

### 暗黙の特権 <a href="#implicit-privileges" id="implicit-privileges"></a>

一部の拡張機能の特権は**明示的に宣言する必要はありません**。一例として、[tabs API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs)：その基本機能は、特権なしでアクセス可能です。任意の拡張機能は、タブを開いたり閉じたりするときに通知を受け取ることができますが、これらのタブがどのウェブサイトに対応しているかは知ることができません。

それは無害に聞こえますか？ [tabs.create() API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) はやや危険です。これは**新しいタブを作成する**ために使用でき、基本的には任意のウェブサイトが呼び出すことができる [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) と同じです。しかし、`window.open()` は**ポップアップブロッカーの対象となりますが、`tabs.create()` はそうではありません。**&#x20;

{% hint style="danger" %}
拡張機能はいつでも任意の数のタブを作成できます。
{% endhint %}

可能な `tabs.create()` パラメーターを見ると、その機能は `window.open()` が制御できる範囲をはるかに超えていることに気付くでしょう。そして、FirefoxはこのAPIで `data:` URIを使用することを許可していませんが、Chromeにはそのような保護はありません。**そのようなURIのトップレベルでの使用は** [**フィッシングに悪用されたために禁止されました**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**。**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) は `tabs.create()` に非常に似ていますが、**既存のタブを変更します**。したがって、悪意のある拡張機能は例えば任意の広告ページをあなたのタブの1つにロードし、対応するタブをアクティブにすることもできます。

### ウェブカメラ、位置情報など <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

ウェブサイトが特別な権限を要求できることはおそらくご存知でしょう。例えば、ウェブカメラへのアクセス（ビデオ会議ツール）や地理的位置情報（地図）などです。これらは悪用の可能性が高い機能なので、ユーザーは毎回これらをまだ使用したいかどうかを確認する必要があります。

{% hint style="danger" %}
しかし、ブラウザ拡張機能ではそうではありません。**ブラウザ拡張機能が** [**ウェブカメラやマイクへのアクセスを望む場合**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**、一度だけ許可を求める必要があります**
{% endhint %}

通常、拡張機能はインストール直後にこれを行います。このプロンプトが受け入れられると、**ウェブカメラへのアクセスはいつでも可能**になります。ユーザーが拡張機能と対話していない時でさえです。はい、ユーザーは拡張機能が本当にウェブカメラアクセスを必要としている場合にのみこのプロンプトを受け入れます。しかし、その後は拡張機能がこっそりと何も録音しないことを信頼しなければなりません。

[あなたの正確な地理的位置](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation)や[クリップボードの内容](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API)へのアクセスには、明示的に許可を与える必要はまったくありません。**拡張機能は単に `geolocation` や `clipboard` を** [**権限エントリ**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **に追加します。** これらのアクセス権限は、拡張機能がインストールされたときに暗黙的に付与されます。したがって、これらの権限を持つ悪意のあるまたは侵害された拡張機能は、あなたが何も気づかないうちにあなたの移動プロファイルを作成したり、コピーされたパスワードを監視するためにクリップボードをモニターすることができます。

拡張機能マニフェストの [権限エントリ](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) に **`history`** キーワードを追加すると、**[**履歴 API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history) へのアクセスが許可されます。** これにより、ユーザーの完全なブラウジング履歴を一度に取得できます。ユーザーがこれらのウェブサイトを再び訪れるのを待つ必要はありません。

**`bookmarks`** **権限**も同様の悪用の可能性があります。これにより、**[**ブックマーク API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks) を介してすべてのブックマークを読み取ることができます。**

### ストレージ権限 <a href="#the-storage-permission" id="the-storage-permission"></a>

拡張機能のストレージは、任意のウェブサイトが使用できる [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) と非常に似たキー値コレクションです。したがって、ここに機密情報を保存すべきではありません。

ただし、広告会社もこのストレージを悪用する可能性があります。

### その他の権限

Chromiumブラウザ拡張機能が要求できる[**完全な権限リストはこちら**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions)、Firefox拡張機能の[**完全なリストはこちら**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**です。**

## 予防 <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

Googleの開発者ポリシーは、拡張機能の機能に必要な以上の特権を要求することを[明示的に禁止しています](https://developer.chrome.com/docs/webstore/program_policies/#permissions)。私の経験では、このルールは実際に機能しています。ブラウザ拡張機能が[特権を多く要求した](https://palant.info/2020/01/13/pwning-avast-secure-browser-for-fun-and-profit/#selecting-a-target)ケースは1つしか思い浮かびませんが、その特定の拡張機能はアドオンストアを介してではなく、ブラウザと一緒に配布されていました。

拡張機能の特権の悪用の可能性を**制限する**ために、ブラウザはもっとうまくやれる場合があります。例えば、Chromeは [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) や [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) APIを介して画面録画を許可しています。悪用の可能性は低いですが、前者はユーザーのアクション（通常は拡張機能のアイコンをクリックする）に応じてのみ開始でき、後者は録画されるアプリケーションウィンドウを選択するプロンプトが表示されます。どちらも、拡張機能がバックグラウンドで静かに録画を開始するのを防ぐのに十分です。

しかし、そのようなセキュリティ向上は、拡張機能を**柔軟性が低く、ユーザーフレンドリーではなくする**傾向があります。ここでの良い例は、[activeTab権限](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab_permission)です。その目的は、インターネット全体のホスト特権を要求する必要をなくすことです。代わりに、**拡張機能は、拡張機能が明示的にアクティブ化されたときに現在のタブにアクセスできます**、通常はそのアイコンをクリックすることによってです。

そのアプローチは、ユーザーが明示的にアクションをトリガーする必要がある一部の拡張機能にはうまく機能します。しかし、拡張機能が自動的に作業を行う必要があるシナリオでは**機能しません**（つまり、ユーザーにとってより便利であることを意味します）または、拡張機能のアクションをすぐに実行できず、準備が必要な場合もあります。

## **参考文献**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Learn AWS hacking from zero to hero with</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Other ways to support HackTricks:

* If you want to see your **company advertised in HackTricks** or **download HackTricks in PDF** Check the [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Get the [**official PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Discover [**The PEASS Family**](https://opensea.io/collection/the-peass-family), our collection of exclusive [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Join the** 💬 [**Discord group**](https://discord.gg/hRep4RUj7f) or the [**telegram group**](https://t.me/peass) or **follow** me on **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Share your hacking tricks by submitting PRs to the** [**HackTricks**](https://github.com/carlospolop/hacktricks)
