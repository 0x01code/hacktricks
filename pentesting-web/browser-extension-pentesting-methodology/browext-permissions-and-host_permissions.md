# BrowExt - permiss√µes e host_permissions

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Obtenha o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Informa√ß√µes B√°sicas

### **`permiss√µes`**

As permiss√µes s√£o definidas no arquivo **`manifest.json`** da extens√£o usando a propriedade **`permissions`** e permitem acesso a quase tudo a que um navegador pode acessar (Cookies ou Armazenamento F√≠sico):

O manifesto anterior declara que a extens√£o requer a permiss√£o `storage`. Isso significa que ela pode usar [a API de armazenamento](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) para armazenar seus dados de forma persistente. Ao contr√°rio dos cookies ou APIs `localStorage` que d√£o aos usu√°rios algum n√≠vel de controle, **o armazenamento da extens√£o normalmente s√≥ pode ser limpo desinstalando a extens√£o**.

Uma extens√£o solicitar√° as permiss√µes indicadas em seu arquivo **`manifest.json`** e Ap√≥s instalar a extens√£o, voc√™ pode **sempre verificar suas permiss√µes no seu navegador**, como mostrado nesta imagem:

<figure><img src="../../.gitbook/assets/image (18).png" alt=""><figcaption></figcaption></figure>

Voc√™ pode encontrar a [**lista completa de permiss√µes que uma Extens√£o do Navegador Chromium pode solicitar aqui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e uma [**lista completa para extens√µes do Firefox aqui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

### `host_permissions`

A configura√ß√£o opcional, mas poderosa, **`host_permissions`** indica com quais hosts a extens√£o ser√° capaz de interagir via APIs como [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) e [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs).

As seguintes `host_permissions` basicamente permitem todo o web:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Estes s√£o os hosts que a extens√£o do navegador pode acessar livremente. Isso ocorre porque quando uma extens√£o do navegador chama **`fetch("https://gmail.com/")`** n√£o √© restrita pelo CORS.

## Abusando de `permissions` e `host_permissions`

### Abas

Al√©m disso, **`host_permissions`** tamb√©m desbloqueiam a funcionalidade "avan√ßada" da [**API de abas**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs). Eles permitem que a extens√£o chame [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) e n√£o apenas obtenha de volta uma **lista das abas do navegador do usu√°rio**, mas tamb√©m saiba qual **p√°gina da web (significando endere√ßo e t√≠tulo) est√° carregada**.

{% hint style="danger" %}
Al√©m disso, ouvintes como [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **tornam-se muito mais √∫teis tamb√©m**. Eles ser√£o notificados sempre que uma nova p√°gina for carregada em uma aba.
{% endhint %}

### Executando scripts de conte√∫do <a href="#running-content-scripts" id="running-content-scripts"></a>

Scripts de conte√∫do n√£o precisam ser necessariamente escritos estaticamente no manifesto da extens√£o. Com permiss√µes **`host_permissions`** suficientes, **as extens√µes tamb√©m podem carreg√°-los dinamicamente chamando** [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) **ou** [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript).

Ambas as APIs permitem a execu√ß√£o n√£o apenas de arquivos contidos nas extens√µes como scripts de conte√∫do, mas tamb√©m **c√≥digo arbitr√°rio**. A primeira permite passar c√≥digo JavaScript como uma string, enquanto a √∫ltima espera uma fun√ß√£o JavaScript que √© menos propensa a vulnerabilidades de inje√ß√£o. Ainda assim, ambas as APIs causar√£o estragos se forem mal utilizadas.

{% hint style="danger" %}
Al√©m das capacidades acima, scripts de conte√∫do poderiam, por exemplo, **interceptar credenciais** √† medida que s√£o inseridas nas p√°ginas da web. Uma maneira cl√°ssica de abus√°-los √© **injetar publicidade** em cada site. Adicionar **mensagens de golpe** para abusar da credibilidade de sites de not√≠cias tamb√©m √© poss√≠vel. Por fim, eles poderiam **manipular** sites de **bancos** para redirecionar transfer√™ncias de dinheiro.
{% endhint %}

### Privil√©gios impl√≠citos <a href="#implicit-privileges" id="implicit-privileges"></a>

Alguns privil√©gios de extens√£o **n√£o precisam ser declarados explicitamente**. Um exemplo √© a [API de abas](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): sua funcionalidade b√°sica √© acess√≠vel sem nenhum privil√©gio. Qualquer extens√£o pode ser notificada quando voc√™ abre e fecha abas, ela simplesmente n√£o saber√° com qual site essas abas correspondem.

Parece inofensivo demais? A [API tabs.create()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) √© um pouco menos. Ela pode ser usada para **criar uma nova aba**, essencialmente o mesmo que [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open) que pode ser chamado por qualquer site. No entanto, enquanto `window.open()` est√° sujeito ao **bloqueador de pop-ups, `tabs.create()` n√£o est√°**.

{% hint style="danger" %}
Uma extens√£o pode criar qualquer n√∫mero de abas sempre que desejar.
{% endhint %}

Se voc√™ examinar os poss√≠veis par√¢metros de `tabs.create()`, tamb√©m notar√° que suas capacidades v√£o muito al√©m do que `window.open()` √© permitido controlar. E enquanto o Firefox n√£o permite que URIs `data:` sejam usados com esta API, o Chrome n√£o tem essa prote√ß√£o. **O uso desses URIs no n√≠vel superior foi** [**proibido por ser abusado para phishing**](https://bugzilla.mozilla.org/show\_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) √© muito semelhante a `tabs.create()` mas ir√° **modificar uma aba existente**. Portanto, uma extens√£o maliciosa pode, por exemplo, carregar arbitrariamente uma p√°gina de publicidade em uma de suas abas e tamb√©m pode ativar a aba correspondente.

### Webcam, geolocaliza√ß√£o e amigos <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Voc√™ provavelmente sabe que os sites podem solicitar permiss√µes especiais, por exemplo, para acessar sua webcam (ferramentas de videoconfer√™ncia) ou localiza√ß√£o geogr√°fica (mapas). S√£o recursos com potencial consider√°vel para abuso, ent√£o os usu√°rios precisam confirmar cada vez que desejam isso.

{% hint style="danger" %}
N√£o √© assim com as extens√µes do navegador. **Se uma extens√£o do navegador** [**deseja acessar sua webcam ou microfone**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)**, ela s√≥ precisa pedir permiss√£o uma vez**
{% endhint %}

Normalmente, uma extens√£o far√° isso imediatamente ap√≥s ser instalada. Uma vez que este prompt √© aceito, **o acesso √† webcam √© poss√≠vel a qualquer momento**, mesmo que o usu√°rio n√£o esteja interagindo com a extens√£o neste momento. Sim, um usu√°rio s√≥ aceitar√° este prompt se a extens√£o realmente precisar de acesso √† webcam. Mas depois disso, eles t√™m que confiar na extens√£o para n√£o gravar nada secretamente.

Com acesso √† [sua localiza√ß√£o geogr√°fica exata](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) ou [conte√∫do da sua √°rea de transfer√™ncia](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard\_API), conceder permiss√£o explicitamente √© desnecess√°rio. **Uma extens√£o simplesmente adiciona `geolocation` ou `clipboard` √†** [**entrada de permiss√µes**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **de seu manifesto**. Esses privil√©gios de acesso s√£o concedidos implicitamente quando a extens√£o √© instalada. Portanto, uma extens√£o maliciosa ou comprometida com esses privil√©gios pode criar seu perfil de movimento ou monitorar sua √°rea de transfer√™ncia para senhas copiadas sem que voc√™ perceba.

Adicionar a palavra-chave **`history`** √† [entrada de permiss√µes](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) do manifesto da extens√£o concede **acesso √†** [**API de hist√≥rico**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Isso permite recuperar todo o hist√≥rico de navega√ß√£o do usu√°rio de uma s√≥ vez, sem esperar que o usu√°rio visite esses sites novamente.

A **permiss√£o `bookmarks`** tem um potencial de abuso semelhante, esta permite **ler todos os favoritos via** [**API de favoritos**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Permiss√£o de armazenamento <a href="#the-storage-permission" id="the-storage-permission"></a>

O armazenamento da extens√£o √© apenas uma cole√ß√£o de chave-valor, muito semelhante ao [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) que qualquer site poderia usar. Portanto, informa√ß√µes sens√≠veis n√£o devem ser armazenadas aqui.

No entanto, empresas de publicidade tamb√©m poderiam abusar deste armazenamento.

### Mais permiss√µes

Voc√™ pode encontrar a [**lista completa de permiss√µes que uma Extens√£o de Navegador Chromium pode solicitar aqui**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) e uma [**lista completa para extens√µes do Firefox aqui**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions)**.**

## Preven√ß√£o <a href="#why-not-restrict-extension-privileges" id="why-not-restrict-extension-privileges"></a>

A pol√≠tica do desenvolvedor do Google pro√≠be explicitamente as extens√µes de solicitar mais privil√©gios do que o necess√°rio para sua funcionalidade, mitigando efetivamente solicita√ß√µes excessivas de permiss√£o. Um caso em que uma extens√£o do navegador ultrapassou esse limite envolveu sua distribui√ß√£o com o pr√≥prio navegador, em vez de atrav√©s de uma loja de complementos.

Os navegadores poderiam ainda restringir o uso indevido dos privil√©gios da extens√£o. Por exemplo, as APIs [tabCapture](https://developer.chrome.com/docs/extensions/reference/tabCapture/) e [desktopCapture](https://developer.chrome.com/docs/extensions/reference/desktopCapture/) do Chrome, usadas para grava√ß√£o de tela, s√£o projetadas para minimizar o abuso. A API tabCapture s√≥ pode ser ativada por meio de intera√ß√£o direta do usu√°rio, como clicar no √≠cone da extens√£o, enquanto o desktopCapture requer confirma√ß√£o do usu√°rio para que a janela seja gravada, impedindo atividades de grava√ß√£o clandestinas.

No entanto, o fortalecimento das medidas de seguran√ßa muitas vezes resulta em uma diminui√ß√£o da flexibilidade e da facilidade de uso das extens√µes. A [permiss√£o activeTab](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#activetab\_permission) ilustra esse compromisso. Foi introduzida para eliminar a necessidade de as extens√µes solicitarem privil√©gios de host em toda a internet, permitindo que as extens√µes acessem apenas a aba atual mediante ativa√ß√£o expl√≠cita pelo usu√°rio. Esse modelo √© eficaz para extens√µes que requerem a√ß√µes iniciadas pelo usu√°rio, mas √© insuficiente para aquelas que exigem a√ß√µes autom√°ticas ou preventivas, comprometendo assim a conveni√™ncia e a capacidade de resposta imediata.
## **Refer√™ncias**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
