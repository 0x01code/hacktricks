# BrowExt - Berechtigungen & host\_permissions

<details>

<summary>Lernen Sie AWS-Hacking von Grund auf mit <a href="https://training.hacktricks.xyz/courses/arte">htARTE (HackTricks AWS Red Team Expert)</a>!</summary>

Andere Möglichkeiten, HackTricks zu unterstützen:

- Wenn Sie Ihr Unternehmen in HackTricks bewerben möchten oder HackTricks als PDF herunterladen möchten, überprüfen Sie die [ABONNEMENTPLÄNE](https://github.com/sponsors/carlospolop)!
- Holen Sie sich das offizielle PEASS & HackTricks-Merchandise
- Entdecken Sie die PEASS-Familie, unsere Sammlung exklusiver NFTs
- Treten Sie der Discord-Gruppe oder der Telegram-Gruppe bei oder folgen Sie uns auf Twitter
- Teilen Sie Ihre Hacking-Tricks, indem Sie PRs zu den HackTricks- und HackTricks Cloud-GitHub-Repositories einreichen

</details>

## Grundlegende Informationen

### `permissions`

Berechtigungen werden in der Datei **`manifest.json`** der Erweiterung definiert und ermöglichen den Zugriff auf fast alles, auf das ein Browser zugreifen kann (Cookies oder physischer Speicher):

Das vorherige Manifest gibt an, dass die Erweiterung die Berechtigung `storage` benötigt. Dies bedeutet, dass sie die [Storage-API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/storage) verwenden kann, um ihre Daten dauerhaft zu speichern. Im Gegensatz zu Cookies oder `localStorage`-APIs, bei denen Benutzer eine gewisse Kontrolle haben, kann der Erweiterungsspeicher normalerweise nur durch Deinstallation der Erweiterung gelöscht werden.

Eine Erweiterung fordert die in ihrer **`manifest.json`**-Datei angegebenen Berechtigungen an. Nach der Installation der Erweiterung können Sie ihre Berechtigungen jederzeit in Ihrem Browser überprüfen, wie in diesem Bild gezeigt:

<figure><img src="../../.gitbook/assets/image (2) (1).png" alt=""><figcaption></figcaption></figure>

Sie können die [vollständige Liste der Berechtigungen, die eine Chromium-Browsererweiterung anfordern kann, hier finden](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) und eine [vollständige Liste für Firefox-Erweiterungen hier](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api\_permissions).

### `host_permissions`

Die optionale, aber leistungsstarke Einstellung **`host_permissions`** gibt an, mit welchen Hosts die Erweiterung über APIs wie [`cookies`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/cookies), [`webRequest`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/webRequest) und [`tabs`](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) interagieren kann.

Die folgenden `host_permissions` erlauben im Grunde genommen jede Webseite:
```json
"host_permissions": [
"*://*/*"
]

// Or:
"host_permissions": [
"http://*/*",
"https://*/*"
]

// Or:
"host_permissions": [
"<all_urls>"
]
```
Dies sind die Hosts, auf die die Browsererweiterung frei zugreifen kann. Dies liegt daran, dass eine Browsererweiterung beim Aufruf von **`fetch("https://gmail.com/")`** nicht durch CORS eingeschränkt wird.

## Missbrauch von `permissions` und `host_permissions`

### Tabs

Darüber hinaus ermöglichen **`host_permissions`** auch erweiterte [**Tabs-API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs) **Funktionalitäten**. Sie ermöglichen es der Erweiterung, [tabs.query()](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/query) aufzurufen und nicht nur eine **Liste der Browser-Tabs des Benutzers** zurückzugeben, sondern auch zu erfahren, welche **Webseite (Adresse und Titel) geladen ist**.

{% hint style="danger" %}
Nicht nur das, auch Listener wie [**tabs.onUpdated**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/onUpdated) **werden ebenfalls viel nützlicher**. Diese werden benachrichtigt, wenn eine neue Seite in einem Tab geladen wird.
{% endhint %}

### Ausführen von Inhalts-Skripten <a href="#running-content-scripts" id="running-content-scripts"></a>

Inhaltsskripte sind nicht unbedingt statisch in das Erweiterungsmanifest geschrieben. Bei ausreichenden **`host_permissions`** können Erweiterungen sie auch dynamisch laden, indem sie [**tabs.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/executeScript) oder [**scripting.executeScript()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/scripting/executeScript) aufrufen.

Beide APIs ermöglichen nicht nur das Ausführen von Dateien, die in den Erweiterungen als Inhalts-Skripte enthalten sind, sondern auch **beliebigen Code**. Die erste API erlaubt das Übergeben von JavaScript-Code als Zeichenkette, während die zweite eine JavaScript-Funktion erwartet, die weniger anfällig für Injektionslücken ist. Dennoch können beide APIs großen Schaden anrichten, wenn sie missbraucht werden.

{% hint style="danger" %}
Zusätzlich zu den oben genannten Fähigkeiten könnten Inhalts-Skripte zum Beispiel **Anmeldeinformationen abfangen**, die in Webseiten eingegeben werden. Eine klassische Möglichkeit, sie zu missbrauchen, besteht darin, auf jeder Website **Werbung einzufügen**. Es ist auch möglich, **Betrugsnachrichten** hinzuzufügen, um die Glaubwürdigkeit von Nachrichtenwebsites zu missbrauchen. Schließlich könnten sie **Banking-Websites manipulieren**, um Geldtransfers umzuleiten.
{% endhint %}

### Implizite Berechtigungen <a href="#implicit-privileges" id="implicit-privileges"></a>

Einige Erweiterungsberechtigungen **müssen nicht explizit deklariert werden**. Ein Beispiel dafür ist die [Tabs-API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs): Ihre grundlegende Funktionalität ist ohne jegliche Berechtigungen zugänglich. Jede Erweiterung kann benachrichtigt werden, wenn Sie Tabs öffnen und schließen, sie weiß jedoch nicht, welche Website diesen Tabs entspricht.

Klingt zu harmlos? Die [tabs.create() API](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/create) ist etwas weniger harmlos. Sie kann verwendet werden, um **einen neuen Tab zu erstellen**, im Wesentlichen das Gleiche wie [window.open()](https://developer.mozilla.org/en-US/docs/Web/API/Window/open), das von jeder Website aufgerufen werden kann. Während `window.open()` jedoch vom Pop-up-Blocker beeinflusst wird, gilt dies nicht für `tabs.create()`.

{% hint style="danger" %}
Eine Erweiterung kann jederzeit beliebig viele Tabs erstellen.
{% endhint %}

Wenn Sie die möglichen Parameter von `tabs.create()` durchsehen, werden Sie auch feststellen, dass seine Fähigkeiten weit über das hinausgehen, was `window.open()` steuern darf. Und während Firefox nicht zulässt, dass `data:` URIs mit dieser API verwendet werden, hat Chrome keinen solchen Schutz. Die Verwendung solcher URIs auf der obersten Ebene wurde aufgrund von Missbrauch für Phishing **verboten** [**(Quelle)**](https://bugzilla.mozilla.org/show_bug.cgi?id=1331351)**.**

[**tabs.update()**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/tabs/update) ist der `tabs.create()` sehr ähnlich, ändert jedoch einen vorhandenen Tab. Eine bösartige Erweiterung kann beispielsweise willkürlich eine Werbeseite in einen Ihrer Tabs laden und den entsprechenden Tab auch aktivieren.

### Webcam, Geolocation und Co. <a href="#webcam-geolocation-and-friends" id="webcam-geolocation-and-friends"></a>

Sie wissen wahrscheinlich, dass Websites spezielle Berechtigungen anfordern können, z. B. um auf Ihre Webcam (Videokonferenz-Tools) oder geografischen Standort (Karten) zuzugreifen. Es handelt sich um Funktionen mit erheblichem Missbrauchspotenzial, sodass Benutzer jedes Mal bestätigen müssen, dass sie dies immer noch möchten.

{% hint style="danger" %}
Nicht so bei Browsererweiterungen. **Wenn eine Browsererweiterung** [**Zugriff auf Ihre Webcam oder Ihr Mikrofon**](https://developer.mozilla.org/en-US/docs/Web/API/MediaDevices/getUserMedia)** möchte, muss sie dies nur einmal anfordern**
{% endhint %}

Normalerweise tut eine Erweiterung dies sofort nach der Installation. Sobald diese Aufforderung akzeptiert wurde, ist **der Zugriff auf die Webcam jederzeit möglich**, auch wenn der Benutzer zu diesem Zeitpunkt nicht mit der Erweiterung interagiert. Ja, ein Benutzer wird diese Aufforderung nur akzeptieren, wenn die Erweiterung wirklich Zugriff auf die Webcam benötigt. Aber danach muss er der Erweiterung vertrauen, nichts heimlich aufzuzeichnen.

Bei Zugriff auf [Ihren genauen geografischen Standort](https://developer.mozilla.org/en-US/docs/Web/API/Geolocation) oder [Inhalte Ihrer Zwischenablage](https://developer.mozilla.org/en-US/docs/Web/API/Clipboard_API) ist eine explizite Berechtigung überhaupt nicht erforderlich. **Eine Erweiterung fügt einfach `geolocation` oder `clipboard` zum** [**permissions-Eintrag**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) **in ihrem Manifest hinzu**. Diese Zugriffsrechte werden dann implizit gewährt, wenn die Erweiterung installiert wird. Daher kann eine bösartige oder kompromittierte Erweiterung mit diesen Berechtigungen Ihr Bewegungsprofil erstellen oder Ihre Zwischenablage nach kopierten Passwörtern überwachen, ohne dass Sie etwas bemerken.

Das Hinzufügen des Schlüsselworts **`history`** zum [permissions-Eintrag](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions) des Erweiterungsmanifests gewährt **Zugriff auf die** [**history API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/history). Dadurch kann die gesamte Browser-History des Benutzers auf einmal abgerufen werden, ohne darauf zu warten, dass der Benutzer diese Websites erneut besucht.

Die **`bookmarks`**-Berechtigung hat ein ähnliches Missbrauchspotenzial. Sie ermöglicht das **Auslesen aller Lesezeichen über die** [**bookmarks API**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/API/bookmarks).

### Berechtigung für Speicher <a href="#the-storage-permission" id="the-storage-permission"></a>

Der Erweiterungsspeicher ist lediglich eine Schlüssel-Wert-Sammlung, die sehr ähnlich zu [localStorage](https://developer.mozilla.org/en-US/docs/Web/API/Window/localStorage) ist, das von jeder Website verwendet werden könnte. Daher sollten hier keine sensiblen Informationen gespeichert werden.

Jedoch könnten Werbeunternehmen diesen Speicher ebenfalls missbrauchen.

### Weitere Berechtigungen

Sie finden die [**vollständige Liste der Berechtigungen, die eine Chromium-Browsererweiterung anfordern kann, hier**](https://developer.chrome.com/docs/extensions/develop/concepts/declare-permissions#permissions) und eine [**vollständige Liste für Firefox-Erweiterungen hier**](https://developer.mozilla.org/en-US/docs/Mozilla/Add-ons/WebExtensions/manifest.json/permissions#api_permissions)**.**

## Prävention <a href="#why-not-restrict
## **Referenzen**

* [https://palant.info/2022/08/17/impact-of-extension-privileges/](https://palant.info/2022/08/17/impact-of-extension-privileges/)
* [https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing](https://www.cobalt.io/blog/introduction-to-chrome-browser-extension-security-testing)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere Möglichkeiten, HackTricks zu unterstützen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben möchten** oder **HackTricks als PDF herunterladen möchten**, überprüfen Sie die [**ABONNEMENTPLÄNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** 💬 [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
