# Attaque de d√©ni de service par expression r√©guli√®re - ReDoS

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une entreprise de **cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Introduction

**Copi√© de** [**https://owasp.org/www-community/attacks/Regular\_expression\_Denial\_of\_Service\_-\_ReDoS**](https://owasp.org/www-community/attacks/Regular\_expression\_Denial\_of\_Service\_-\_ReDoS)

Le **d√©ni de service par expression r√©guli√®re (ReDoS)** est une attaque de [d√©ni de service](https://owasp.org/www-community/attacks/Denial\_of\_Service) qui exploite le fait que la plupart des impl√©mentations d'expressions r√©guli√®res peuvent atteindre des situations extr√™mes qui les font fonctionner tr√®s lentement (exponentiellement li√© √† la taille de l'entr√©e). Un attaquant peut alors amener un programme utilisant une expression r√©guli√®re √† entrer dans ces situations extr√™mes et √† rester bloqu√© pendant tr√®s longtemps.

### Description

#### L'algorithme na√Øf de Regex probl√©matique <a href="#the-problematic-regex-naive-algorithm" id="the-problematic-regex-naive-algorithm"></a>

L'algorithme na√Øf d'expression r√©guli√®re construit un [Automate Fini Non-D√©terministe (AFND)](https://en.wikipedia.org/wiki/Nondeterministic\_finite\_state\_machine), qui est une machine √† √©tats finis o√π pour chaque paire d'√©tat et de symbole d'entr√©e, il peut y avoir plusieurs √©tats suivants possibles. Ensuite, le moteur commence √† effectuer des transitions jusqu'√† la fin de l'entr√©e. Comme il peut y avoir plusieurs √©tats suivants possibles, un algorithme d√©terministe est utilis√©. Cet algorithme essaie un par un tous les chemins possibles (si n√©cessaire) jusqu'√† ce qu'une correspondance soit trouv√©e (ou que tous les chemins soient essay√©s et √©chouent).

Par exemple, l'expression r√©guli√®re `^(a+)+$` est repr√©sent√©e par l'AFND suivant :

![Automate Fini Non-D√©terministe](https://owasp.org/www-community/assets/images/attacks/NFA.png)

Pour l'entr√©e `aaaaX`, il y a 16 chemins possibles dans le graphe ci-dessus. Mais pour `aaaaaaaaaaaaaaaaX`, il y a 65536 chemins possibles, et le nombre double pour chaque `a` suppl√©mentaire. C'est un cas extr√™me o√π l'algorithme na√Øf est probl√©matique, car il doit passer sur de nombreux chemins, puis √©chouer.

Remarquez que tous les algorithmes ne sont pas na√Øfs, et que les algorithmes d'expression r√©guli√®re peuvent en fait √™tre √©crits de mani√®re efficace. Malheureusement, la plupart des moteurs d'expression r√©guli√®re aujourd'hui essaient de r√©soudre non seulement les expressions r√©guli√®res "pures", mais aussi les expressions r√©guli√®res "√©largies" avec des "ajouts sp√©ciaux", tels que des r√©f√©rences arri√®re qui ne peuvent pas toujours √™tre r√©solues efficacement (voir **Patterns for non-regular languages** dans [Wiki-Regex](https://en.wikipedia.org/wiki/Regular\_expression) pour plus de d√©tails). Ainsi, m√™me si l'expression r√©guli√®re n'est pas "√©largie", un algorithme na√Øf est utilis√©.

#### Expressions r√©guli√®res malveillantes <a href="#evil-regexes" id="evil-regexes"></a>

Une expression r√©guli√®re est dite "malveillante" si elle peut rester bloqu√©e sur une entr√©e forg√©e.

**Le mod√®le d'expression r√©guli√®re malveillant contient** :

* Groupement avec r√©p√©tition
* √Ä l'int√©rieur du groupe r√©p√©t√© :
  * R√©p√©tition
  * Alternance avec chevauchement

**Exemples de mod√®les malveillants** :

* `(a+)+`
* `([a-zA-Z]+)*`
* `(a|aa)+`
* `(a|a?)+`
* `(.*a){x} pour x \> 10`

Tous les exemples ci-dessus sont susceptibles de l'entr√©e `aaaaaaaaaaaaaaaaaaaaaaaa!` (la longueur d'entr√©e minimale peut varier l√©g√®rement en fonction des machines plus rapides ou plus lentes).

## Charges utiles ReDoS

### Exfiltration de cha√Æne via ReDoS

Dans un CTF (ou une prime de bug), vous **contr√¥lez l'expression r√©guli√®re avec laquelle une information sensible (le drapeau) est mise en correspondance**. Ensuite, si cela peut √™tre utile, vous pouvez faire **geler la page (temps d'attente ou temps de traitement plus long)** si une **expression r√©guli√®re correspond** et **pas si elle ne correspond pas**. De cette fa√ßon, vous pourrez **exfiltrer** la cha√Æne **caract√®re par caract√®re** :

* Dans [**ce post**](https://portswigger.net/daily-swig/blind-regex-injection-theoretical-exploit-offers-new-way-to-force-web-apps-to-spill-secrets), vous pouvez trouver cette r√®gle ReDoS : `^(?=<flag>)((.*)*)*salt$`
  * Exemple : `^(?=HTB{sOmE_fl¬ßN¬ß)((.*)*)*salt$`
* Dans [**ce writeup**](https://github.com/jorgectf/Created-CTF-Challenges/blob/main/challenges/TacoMaker%20%40%20DEKRA%20CTF%202022/solver/solver.html), vous pouvez trouver celui-ci : `<flag>(((((((.*)*)*)*)*)*)*)!`
* Dans [**ce writeup**](https://ctftime.org/writeup/25869), il a utilis√© : `^(?=${flag_prefix}).*.*.*.*.*.*.*.*!!!!$`

### Contr√¥le d'entr√©e et d'expression r√©guli√®re ReDoS

Les exemples suivants sont des **ReDoS** o√π vous **contr√¥lez** √† la fois l'**entr√©e** et l'**expression r√©guli√®re** :
```javascript
function check_time_regexp(regexp, text){
    var t0 = new Date().getTime();;
    new RegExp(regexp).test(text);
    var t1 = new Date().getTime();;
    console.log("Regexp " + regexp + " took " + (t1 - t0) + " milliseconds.")
}

// This payloads work because the input has several "a"s
[
//  "((a+)+)+$",  //Eternal,
//  "(a?){100}$", //Eternal
    "(a|a?)+$",
    "(\\w*)+$",   //Generic
    "(a*)+$",
    "(.*a){100}$",
    "([a-zA-Z]+)*$", //Generic
    "(a+)*$",
].forEach(regexp => check_time_regexp(regexp, "aaaaaaaaaaaaaaaaaaaaaaaaaa!"))

/*
Regexp (a|a?)+$ took 5076 milliseconds.
Regexp (\w*)+$ took 3198 milliseconds.
Regexp (a*)+$ took 3281 milliseconds.
Regexp (.*a){100}$ took 1436 milliseconds.
Regexp ([a-zA-Z]+)*$ took 773 milliseconds.
Regexp (a+)*$ took 723 milliseconds.
*/
```
## Outils

* [https://github.com/doyensec/regexploit](https://github.com/doyensec/regexploit)
* [https://devina.io/redos-checker](https://devina.io/redos-checker)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

- Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !

- D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)

- Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)

- **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **Partagez vos astuces de piratage en soumettant des PR au [repo hacktricks](https://github.com/carlospolop/hacktricks) et au [repo hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
