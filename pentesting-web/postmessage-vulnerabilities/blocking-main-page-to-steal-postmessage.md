# Bloquer la page principale pour voler le postmessage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©**? Vous voulez voir votre **entreprise annonc√©e dans HackTricks**? ou voulez-vous avoir acc√®s √† la **derni√®re version du PEASS ou t√©l√©charger HackTricks en PDF**? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au [d√©p√¥t hacktricks](https://github.com/carlospolop/hacktricks) et [d√©p√¥t hacktricks-cloud](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

## Gagner des RC avec les Iframes

Selon ce [**writeup de Terjanq**](https://gist.github.com/terjanq/7c1a71b83db5e02253c218765f96a710) les blobs cr√©√©s √† partir d'origines nulles sont isol√©s pour des raisons de s√©curit√©, ce qui signifie que si vous maintenez occup√©e la page principale, la page iframe va s'ex√©cuter.

Essentiellement, dans ce d√©fi, une **iframe isol√©e est ex√©cut√©e** et juste **apr√®s** son **chargement**, la page **parent** va **envoyer un message post** avec le **drapeau**.\
Cependant, cette communication postmessage est **vuln√©rable au XSS** (l'**iframe** peut ex√©cuter du code JS).

Par cons√©quent, l'objectif de l'attaquant est de **permettre au parent de cr√©er l'iframe**, mais **avant** de laisser la page **parent** **envoyer** les donn√©es sensibles (**drapeau**) **le maintenir occup√©** et envoyer la **charge utile √† l'iframe**. Pendant que le **parent est occup√©**, l'**iframe ex√©cute la charge utile** qui sera un peu de JS qui √©coutera le **message postmessage du parent et divulguera le drapeau**.\
Enfin, l'iframe a ex√©cut√© la charge utile et la page parent cesse d'√™tre occup√©e, donc elle envoie le drapeau et la charge utile le divulgue.

Mais comment pourriez-vous faire en sorte que le parent soit **occup√© juste apr√®s avoir g√©n√©r√© l'iframe et juste pendant qu'il attend que l'iframe soit pr√™te √† envoyer les donn√©es sensibles**? Fondamentalement, vous devez trouver une **action asynchrone** que vous pourriez faire ex√©cuter par le parent. Par exemple, dans ce d√©fi, le parent √©coutait les **postmessages** comme ceci:
```javascript
window.addEventListener('message', (e) => {
if (e.data == 'blob loaded') {
$("#previewModal").modal();
}
});
```
Ainsi, il √©tait possible d'envoyer un **grand entier dans un postmessage** qui sera **converti en cha√Æne de caract√®res** dans cette comparaison, ce qui prendra du temps :
```bash
const buffer = new Uint8Array(1e7);
win?.postMessage(buffer, '*', [buffer.buffer]);
```
Et afin d'√™tre pr√©cis et **envoyer** ce **postmessage** juste **apr√®s** la cr√©ation de l'**iframe** mais **avant** qu'elle ne soit **pr√™te** √† recevoir les donn√©es du parent, vous devrez **jouer avec les millisecondes d'un `setTimeout`**.
