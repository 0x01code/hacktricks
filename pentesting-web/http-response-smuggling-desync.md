# HTTPレスポンススミグリング/デシンク

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのスワッグ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**telegramグループ**](https://t.me/peass)に**参加**するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **ハッキングのトリックを共有する**ために、[**hacktricksリポジトリ**](https://github.com/carlospolop/hacktricks)と[**hacktricks-cloudリポジトリ**](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。

</details>

## HTTPリクエストキューデシンクロナイゼーション

まず、この技術は**HTTPリクエストスミグリングの脆弱性**を悪用するため、それが何であるかを知る必要があります。

この技術と一般的なHTTPリクエストスミグリングの**主な違い**は、**攻撃者がプレフィックスを追加して被害者のリクエストを攻撃する代わりに、被害者が受け取るレスポンスを漏洩または変更する**ことです。これは、HTTPリクエストスミグリングを悪用するために1つのリクエストと半分を送信する代わりに、**2つの完全なリクエストを送信してプロキシのレスポンスキューを非同期化**することによって行われます。

これは、レスポンスキューを**非同期化**することができるため、被害者の**正当なリクエストのレスポンスが攻撃者に送信される**か、攻撃者がレスポンスに制御可能なコンテンツを注入することによって、被害者に送信される**レスポンスを攻撃者が制御する**ことができるからです。

### HTTPパイプラインデシンク

HTTP/1.1では、**前のリソースを待つ必要なく、異なるリソースを要求する**ことができます。したがって、**プロキシ**が**中間にある場合**、プロキシの役割は、バックエンドに送信されたリクエストとそれに対するレスポンスの**同期されたマッチを維持する**ことです。

しかし、レスポンスキューを非同期化する問題があります。攻撃者がHTTPレスポンススミグリング攻撃を送信し、**初期リクエストとスミグリングされたリクエストのレスポンスがすぐに返される**場合、スミグリングされたレスポンスは被害者のレスポンスキューに挿入されず、**エラーとして破棄されるだけ**です。

![](<../.gitbook/assets/image (635) (1) (1) (1).png>)

したがって、スミグリングされたリクエストがバックエンドサーバーで処理されるまでに**時間がかかる必要があります**。

この特定の状況で、**被害者がリクエストを送信**し、**スミグリングされたリクエストが正当なリクエストよりも先に応答される**場合、**スミグリングされたレスポンスが被害者に送信されます**。したがって、攻撃者は被害者によって「実行される」リクエストを**制御**することができます。

さらに、**攻撃者がリクエストを実行**し、**被害者**のリクエストに対する**正当なレスポンスが攻撃者のリクエストよりも**先に**応答される場合、**被害者へのレスポンスが攻撃者に送信され**、被害者のレスポンス（たとえばヘッダー**Set-Cookie**を含む）が**盗まれます**。

![](<../.gitbook/assets/image (658) (1).png>)

![](<../.gitbook/assets/image (655) (1) (1) (1).png>)

### 複数のネストされたインジェクション

一般的なHTTPリクエストスミグリングとの**興味深い違い**は、一般的なスミグリング攻撃では、**目標**は被害者のリクエストの**先頭を変更**して予期しないアクションを実行することです。**HTTPレスポンススミグリング攻撃**では、**完全なリクエスト**を送信するため、**1つのペイロードに複数のレスポンス**を注入することができ、これにより**複数のユーザーが非同期化**され、**注入されたレスポンス**を**受信**することができます。

合法的なユーザーに対して**複数のエクスプロイトをより簡単に配布**することができるだけでなく、これはサーバーでの**DoS**を引き起こすためにも使用できます。

### エクスプロイトの組織化

前述のように、この技術を悪用するには、サーバーに**最初のスミグリングメッセージ**を送信するのに**多くの時間がかかる必要があります**。

この**時間のかかるリクエストは、被害者のレスポンスを盗む**だけならば十分です。しかし、より複雑なエクスプロイトを実行したい場合は、この構造がエクスプロイトの一般的な構造になります。

まず、**HTTPリクエストスミグリング**を悪用する**初期リクエスト**、次に**時間のかかるリクエスト**、そして**1つ以上のペイロードリクエスト**が続き、そのレスポンスが被害者に送信されます。

## HTTPレスポンスキューデシンクの悪用

### 他のユーザーのリクエストのキャプチャ<a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

HTTPリクエストスミグリングの既知のペイロードと同様に、**
## レスポンスの非同期化

ここまで、HTTPリクエストスミグリング攻撃を悪用して、**クライアントが受け取るレスポンスを制御**し、その後、**被害者向けのレスポンスを盗む**方法を学びました。

しかし、レスポンスをさらに**非同期化することも可能**です。

**HEAD**リクエストのような興味深いリクエストは、**レスポンスボディにコンテンツが含まれない**ように指定されており、リクエストが**GETリクエストであるかのようにContent-Lengthを含む**必要があります（必須）。

したがって、攻撃者が次のような**HEAD**リクエストを**注入**する場合、次の被害者のリクエストがキューに追加されます：

![](<../.gitbook/assets/image (626).png>)

その後、**被害者**は**HEAD**リクエストからの**レスポンス**を**受け取ります**が、これには**Content-Lengthだけが含まれており、実際のコンテンツは含まれていません**。したがって、プロキシはこのレスポンスを被害者に**送信せず**、実際には**コンテンツ**を待機します。このコンテンツは、攻撃者によって注入された**黄色のリクエストに対するレスポンス**です：

![](<../.gitbook/assets/image (651) (1) (1) (1) (1) (1) (1).png>)

### コンテンツの混乱

前の例に従って、被害者が受け取るレスポンスのボディを**制御**できること、および**HEAD**レスポンスが通常、ヘッダに**Content-TypeとContent-Length**を含むことを知っている場合、次のようなリクエストを**送信**して、ページがXSSに対して脆弱ではない状態で被害者にXSSを引き起こすことができます：

![](<../.gitbook/assets/image (654) (1) (1) (1) (1).png>)

### キャッシュの汚染

先にコメントしたレスポンスの非同期化コンテンツの混乱攻撃を悪用すると、**キャッシュが被害者によって実行されたリクエストのレスポンスを保存し、このレスポンスがXSSを引き起こすような注入されたものである場合、キャッシュが汚染されます**。

XSSペイロードを含む悪意のあるリクエスト：

![](<../.gitbook/assets/image (644) (1).png>)

キャッシュに保存するようにキャッシュに指示するヘッダを含む被害者への悪意のあるレスポンス：

![](<../.gitbook/assets/image (629) (1).png>)

{% hint style="warning" %}
この場合、**「被害者」が攻撃者である**場合、攻撃者は**悪意のあるレスポンスでキャッシュされるURLを制御**できるため、**任意のURLでキャッシュの汚染**を実行できます。
{% endhint %}

### ウェブキャッシュの欺瞞

この攻撃は前の攻撃と似ていますが、**キャッシュ内にペイロードを注入する代わりに、攻撃者はキャッシュ内に被害者の情報をキャッシュします**：

![](<../.gitbook/assets/image (643) (1) (1).png>)

### レスポンスの分割

この攻撃の目的は、再び**レスポンスの非同期化**を悪用して、プロキシが**100%攻撃者が生成したレスポンスを送信**することです。

これを実現するために、攻撃者はレスポンス内のいくつかの値を**反映させるWebアプリケーションのエンドポイント**を見つけ、**HEAD**レスポンスの**コンテンツ長を知る必要があります**。

攻撃者は次のような**エクスプロイト**を送信します：

![](<../.gitbook/assets/image (649) (1) (1) (1).png>)

最初のリクエストが解決され、攻撃者に送り返された後、**被害者のリクエストがキューに追加**されます：

![](<../.gitbook/assets/image (661) (1) (1) (1).png>)

被害者は、**HEAD**レスポンスと**2番目のリクエストのレスポンスのコンテンツ（反映されたデータの一部を含む）**をレスポンスとして受け取ります：

![](<../.gitbook/assets/image (633) (1).png>)

ただし、**反映されたデータはHEAD**レスポンスの**Content-Lengthに応じたサイズ**を持っていたことに注意してください。これにより、**2番目の被害者の次のリクエスト**は、**攻撃者によって完全に作成されたレスポンス**を**受け取る**ことになります。レスポンスが攻撃者によって完全に作成されているため、攻撃者は**プロキシがレスポンスをキャッシュする**こともできます。

## 参考文献

* これらのテクニックを非常によく説明しているこのビデオもチェックしてください：[https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ HackTricksで**会社を宣伝**したいですか？または、**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を見つけてください。独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションです。
* [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。
* [**💬**](https://emojipedia.org/speech-balloon/) [**Discordグループ**](https://discord.gg/hRep4RUj7f)または[**Telegramグループ**](https://t.me/peass)に参加するか、**Twitter** [**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**をフォロー**してください。
* **ハッキングのトリックを共有するには、**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **と** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **にPRを提出**してください。

</details>
