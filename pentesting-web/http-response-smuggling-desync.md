# HTTP Response Smuggling / Desync

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Desincroniza√ß√£o da Fila de Requisi√ß√µes HTTP

Primeiramente, esta t√©cnica **abusa de uma vulnerabilidade de HTTP Request Smuggling**, ent√£o voc√™ precisa saber o que √© isso:

A **principal diferen√ßa** entre esta t√©cnica e um HTTP Request Smuggling comum √© que **em vez de atacar** a **requisi√ß√£o da v√≠tima** **adicionando um prefixo a ela**, vamos **vazar ou modificar a resposta que a v√≠tima recebe**. Isso √© feito, em vez de enviar 1 requisi√ß√£o e meia para abusar do HTTP Request Smuggling, **enviando 2 requisi√ß√µes completas para desincronizar a fila de respostas dos proxies**.

Isso porque vamos conseguir **desincronizar a fila de respostas** de modo que a **resposta** da **requisi√ß√£o leg√≠tima** da **v√≠tima seja enviada ao atacante**, ou **injetando conte√∫do controlado pelo atacante na resposta √† v√≠tima**.

### Desync de Pipeline HTTP

HTTP/1.1 permite solicitar **diferentes recursos sem precisar esperar pelos anteriores**. Portanto, se houver um **proxy** no **meio**, √© tarefa do proxy **manter uma correspond√™ncia sincronizada das requisi√ß√µes enviadas ao backend e das respostas recebidas dele**.

No entanto, h√° um problema ao desincronizar a fila de respostas. Se um atacante enviar um ataque de HTTP Response Smuggling e as respostas para a **requisi√ß√£o inicial e a contrabandeada forem respondidas imediatamente**, a resposta contrabandeada n√£o ser√° inserida na fila de respostas da v√≠tima, mas **ser√° descartada como um erro**.

![](<../.gitbook/assets/image (635) (1) (1) (1).png>)

Portanto, √© necess√°rio que a **requisi√ß√£o contrabandeada** **leve mais tempo para ser processada** dentro do servidor backend. Assim, quando a requisi√ß√£o contrabandeada for processada, a comunica√ß√£o com o atacante j√° ter√° terminado.

Se nessa situa√ß√£o espec√≠fica uma **v√≠tima enviou uma requisi√ß√£o** e a **resposta √† requisi√ß√£o contrabandeada for respondida antes** da requisi√ß√£o leg√≠tima, a **resposta contrabandeada ser√° enviada √† v√≠tima**. Assim, o atacante estar√° **controlando a requisi√ß√£o "realizada" pela v√≠tima**.

Al√©m disso, se o **atacante ent√£o realizar uma requisi√ß√£o** e a **resposta leg√≠tima** √† requisi√ß√£o da **v√≠tima for respondida** **antes** da requisi√ß√£o do atacante. A **resposta √† v√≠tima ser√° enviada ao atacante**, **roubando** a resposta destinada √† v√≠tima (que pode conter, por exemplo, o cabe√ßalho **Set-Cookie**).

![](<../.gitbook/assets/image (658) (1).png>)

![](<../.gitbook/assets/image (655) (1) (1) (1).png>)

### Inje√ß√µes Aninhadas M√∫ltiplas

Outra **diferen√ßa interessante** com o HTTP Request Smuggling comum √© que, em um ataque de smuggling comum, o **objetivo** √© **modificar o in√≠cio da requisi√ß√£o da v√≠tima** para que ela execute uma a√ß√£o inesperada. Em um **ataque de HTTP Response Smuggling**, como voc√™ est√° **enviando requisi√ß√µes completas**, voc√™ pode **injetar em um payload dezenas de respostas** que ir√£o **desincronizar dezenas de usu√°rios** que estar√£o **recebendo** as **respostas injetadas**.

Al√©m de poder **distribuir mais facilmente dezenas de exploits** entre usu√°rios leg√≠timos, isso tamb√©m pode ser usado para causar um **DoS** no servidor.

### Organiza√ß√£o do Exploit

Como explicado anteriormente, para abusar desta t√©cnica, √© necess√°rio que a **primeira mensagem contrabandeada** enviada ao servidor **exija muito tempo para ser processada**.

Esta **requisi√ß√£o que consome tempo √© suficiente** se apenas quisermos **tentar roubar a resposta da v√≠tima.** Mas se voc√™ quiser realizar um exploit mais complexo, esta ser√° uma estrutura comum para o exploit.

Primeiro, a **requisi√ß√£o inicial** abusando do **HTTP Request Smuggling**, depois a **requisi√ß√£o que consome tempo** e ent√£o **1 ou mais requisi√ß√µes de payload** cujas respostas ser√£o enviadas √†s v√≠timas.

## Abusando da Desincroniza√ß√£o da Fila de Respostas HTTP

### Capturando as requisi√ß√µes de outros usu√°rios <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Como com os payloads conhecidos de HTTP Request Smuggling, voc√™ pode **roubar a requisi√ß√£o da v√≠tima** com uma diferen√ßa importante: Neste caso, voc√™ s√≥ precisa que o **conte√∫do enviado seja refletido na resposta**, **nenhum armazenamento persistente** √© necess√°rio.

Primeiro, o atacante envia um payload contendo uma **requisi√ß√£o POST final com o par√¢metro refletido** no final e um Content-Length grande

![](<../.gitbook/assets/image (625).png>)

Ent√£o, uma vez que a **requisi√ß√£o inicial** (azul) foi **processada** e **enquanto** a sonolenta est√° sendo processada (amarelo) a **pr√≥xima requisi√ß√£o que chega de uma v√≠tima** ser√° **anexada na fila logo ap√≥s o par√¢metro refletido**:

![](<../.gitbook/assets/image (634) (1).png>)

Ent√£o, a **v√≠tima** ir√° **receber** a **resposta √† requisi√ß√£o sonolenta** e se, enquanto isso, o **atacante** **enviar** **outra** **requisi√ß√£o**, a **resposta do conte√∫do refletido ser√° enviada a ele**.

## Desincroniza√ß√£o de Resposta

At√© este ponto, aprendemos como abusar de ataques de HTTP Request Smuggling para **controlar** a **requisi√ß√£o** **cuja** **resposta** um **cliente** vai **receber** e como voc√™ pode ent√£o **roubar a resposta que era destinada √† v√≠tima**.

Mas ainda √© poss√≠vel **desincronizar ainda mais** as respostas.

Existem requisi√ß√µes interessantes como a requisi√ß√£o **HEAD** que s√£o especificadas para n√£o ter **nenhum conte√∫do dentro do corpo da resposta** e que devem (obrigatoriamente) **conter o Content-Length** da requisi√ß√£o como **se fosse uma requisi√ß√£o GET**.

Portanto, se um atacante **injetar** uma requisi√ß√£o **HEAD**, como nestas imagens:

![](<../.gitbook/assets/image (626).png>)

Ent√£o, **uma vez que a azul √© respondida ao atacante**, a pr√≥xima requisi√ß√£o da v√≠tima ser√° introduzida na fila:

![](<../.gitbook/assets/image (651) (1) (1) (1) (1) (1) (1).png>)

Ent√£o, a **v√≠tima** ir√° **receber** a **resposta** da requisi√ß√£o **HEAD**, que **vai conter um Content-Length mas nenhum conte√∫do**. Portanto, o proxy **n√£o enviar√° esta resposta** √† v√≠tima, mas **esperar√°** por algum **conte√∫do**, que na verdade ser√° **resposta √† requisi√ß√£o amarela** (tamb√©m injetada pelo atacante):

![](<../.gitbook/assets/image (627) (1).png>)

### Confus√£o de Conte√∫do

Seguindo o exemplo anterior, sabendo que voc√™ pode **controlar o corpo** da requisi√ß√£o cuja resposta ser√° recebida pela v√≠tima e que uma **resposta HEAD** geralmente cont√©m em seus cabe√ßalhos o **Content-Type e o Content-Length**, voc√™ pode **enviar uma requisi√ß√£o como a seguinte** para **causar XSS** na v√≠tima sem a p√°gina ser vulner√°vel a XSS:

![](<../.gitbook/assets/image (654) (1) (1) (1) (1).png>)

### Envenenamento de Cache

Abusando do ataque de desincroniza√ß√£o de resposta e Confus√£o de Conte√∫do comentado anteriormente, **se o cache armazenar a resposta √† requisi√ß√£o realizada pela v√≠tima e esta resposta for uma injetada causando um XSS, ent√£o o cache est√° envenenado**.

Requisi√ß√£o maliciosa contendo o payload XSS:

![](<../.gitbook/assets/image (644) (1).png>)

Resposta maliciosa √† v√≠tima que cont√©m o cabe√ßalho que indica ao cache para armazenar a resposta:

![](<../.gitbook/assets/image (629) (1).png>)

{% hint style="warning" %}
Note que neste caso se o **"v√≠tima" √© o atacante** ele pode agora realizar **envenenamento de cache em URLs arbitr√°rios** pois ele pode **controlar a URL que vai ser armazenada** com a resposta maliciosa.
{% endhint %}

### Engano de Cache Web

Este ataque √© semelhante ao anterior, mas **em vez de injetar um payload dentro do cache, o atacante estar√° armazenando informa√ß√µes da v√≠tima dentro do cache:**

![](<../.gitbook/assets/image (643) (1) (1).png>)

### Divis√£o de Resposta

O **objetivo** deste ataque √© abusar novamente da **desincroniza√ß√£o de resposta** para **fazer o proxy enviar uma resposta 100% gerada pelo atacante**.

Para conseguir isso, o atacante precisa encontrar um ponto final da aplica√ß√£o web que esteja **refletindo alguns valores dentro da resposta** e **conhecer o comprimento do conte√∫do da resposta HEAD**.

Ele enviar√° um **exploit** como:

![](<../.gitbook/assets/image (649) (1) (1) (1).png>)

Ap√≥s a primeira requisi√ß√£o ser resolvida e enviada de volta ao atacante, a **requisi√ß√£o da v√≠tima √© adicionada √† fila**:

![](<../.gitbook/assets/image (661) (1) (1) (1).png>)

A v√≠tima receber√° como resposta a **resposta HEAD + o conte√∫do da segunda resposta √† requisi√ß√£o (contendo parte dos dados refletidos):**

![](<../.gitbook/assets/image (633) (1).png>)

No entanto, note como os **dados refletidos tinham um tamanho de acordo com o Content-Length** da **resposta HEAD** que **gerou uma resposta HTTP v√°lida na fila de respostas**.

Portanto, a **pr√≥xima requisi√ß√£o da segunda v√≠tima** estar√° **recebendo** como **resposta algo completamente criado pelo atacante**. Como a resposta √© completamente criada pelo atacante, ele tamb√©m pode **fazer o proxy armazenar a resposta no cache**.

## Refer√™ncias

* N√£o esque√ßa de conferir este v√≠deo explicando todas essas t√©cnicas muito bem: [https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
