# HTTP Response Smuggling / Desync

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>

**A t√©cnica deste post foi retirada do v√≠deo: [https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)**


## Dessincroniza√ß√£o da Fila de Requisi√ß√µes HTTP

Em primeiro lugar, essa t√©cnica **abusa de uma vulnerabilidade de Smuggling de Requisi√ß√µes HTTP**, ent√£o voc√™ precisa saber o que √© isso:

A **principal** **diferen√ßa** entre essa t√©cnica e um Smuggling de Requisi√ß√µes HTTP comum √© que, **em vez de atacar a requisi√ß√£o da v√≠tima adicionando um prefixo a ela**, vamos **vazar ou modificar a resposta que a v√≠tima recebe**. Isso √© feito enviando **2 requisi√ß√µes completas para dessincronizar a fila de respostas dos proxies**.

Isso ocorre porque seremos capazes de **dessincronizar a fila de respostas** para que a **resposta** da **requisi√ß√£o leg√≠tima da v√≠tima seja enviada ao atacante**, ou **injetando conte√∫do controlado pelo atacante na resposta para a v√≠tima**.

### Dessincroniza√ß√£o de Pipelines HTTP

O HTTP/1.1 permite solicitar **recursos diferentes sem precisar esperar pelos anteriores**. Portanto, se houver um **proxy** no **meio**, √© tarefa dos proxies **manter uma correspond√™ncia sincronizada das requisi√ß√µes enviadas ao backend e das respostas provenientes dele**.

No entanto, h√° um problema de dessincroniza√ß√£o da fila de respostas. Se um atacante enviar um ataque de Smuggling de Resposta HTTP e as respostas para a **requisi√ß√£o inicial e a contrabandeada forem respondidas imediatamente**, a resposta contrabandeada n√£o ser√° inserida na fila da resposta da v√≠tima, mas ser√° **simplesmente descartada como um erro**.

![](<../.gitbook/assets/image (635) (1) (1) (1).png>)

Portanto, √© necess√°rio que a **requisi√ß√£o contrabandeada leve mais tempo para ser processada** no servidor backend. Portanto, quando a requisi√ß√£o contrabandeada for processada, a comunica√ß√£o com o atacante ter√° terminado.

Se, nessa situa√ß√£o espec√≠fica, uma **v√≠tima enviar uma requisi√ß√£o** e a **requisi√ß√£o contrabandeada for respondida antes** da requisi√ß√£o leg√≠tima, a **resposta contrabandeada ser√° enviada √† v√≠tima**. Portanto, o atacante estar√° **controlando a requisi√ß√£o "realizada" pela v√≠tima**.

Al√©m disso, se o **atacante ent√£o realizar uma requisi√ß√£o** e a **resposta leg√≠tima** √† **requisi√ß√£o da v√≠tima for respondida** **antes** da requisi√ß√£o do atacante. A **resposta √† v√≠tima ser√° enviada ao atacante**, **roubando** a resposta da v√≠tima (que pode conter, por exemplo, o cabe√ßalho **Set-Cookie**).

![](<../.gitbook/assets/image (658) (1).png>)

![](<../.gitbook/assets/image (655) (1) (1) (1).png>)

### M√∫ltiplas Inje√ß√µes Aninhadas

Outra **diferen√ßa interessante** com o **Smuggling de Requisi√ß√µes HTTP** comum √© que, em um ataque de contrabando comum, o **objetivo** √© **modificar o in√≠cio da requisi√ß√£o da v√≠tima** para que ela execute uma a√ß√£o inesperada. Em um **ataque de contrabando de resposta HTTP**, como voc√™ est√° **enviando requisi√ß√µes completas**, voc√™ pode **injetar em uma carga √∫til dezenas de respostas** que ir√£o **dessincronizar dezenas de usu√°rios** que estar√£o **recebendo** as **respostas** **injetadas**.

Al√©m de poder **distribuir mais facilmente dezenas de exploits** entre usu√°rios leg√≠timos, isso tamb√©m poderia ser usado para causar um **DoS** no servidor.

### Organiza√ß√£o do Exploit

Como explicado anteriormente, para abusar dessa t√©cnica, √© necess√°rio que a **primeira mensagem contrabandeada** no servidor **leve muito tempo para ser processada**.

Essa **requisi√ß√£o demorada √© suficiente** se voc√™ apenas quiser **tentar roubar a resposta da v√≠tima**. Mas se voc√™ quiser realizar um exploit mais complexo, essa ser√° uma estrutura comum para o exploit.

Primeiro, a **requisi√ß√£o inicial abusando do Smuggling de Requisi√ß√µes HTTP**, em seguida, a **requisi√ß√£o demorada** e depois **1 ou mais requisi√ß√µes de carga √∫til** cujas respostas ser√£o enviadas para as v√≠timas.

## Abusando da Dessincroniza√ß√£o da Fila de Respostas HTTP

### Capturando requisi√ß√µes de outros usu√°rios <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Assim como nos payloads conhecidos de Smuggling de Requisi√ß√µes HTTP, voc√™ pode **roubar a requisi√ß√£o da v√≠tima** com uma diferen√ßa importante: Neste caso, voc√™ s√≥ precisa que o **conte√∫do enviado seja refletido na resposta**, **nenhum armazenamento persistente** √© necess√°rio.

Primeiro, o atacante envia uma carga √∫til contendo uma **requisi√ß√£o POST final com o par√¢metro refletido** no final e um grande Content-Length

![](<../.gitbook/assets/image (625).png>)

Ent√£o, uma vez que a **requisi√ß√£o inicial** (azul) foi **processada** e **enquanto** a **dorminhoca** est√° sendo processada (amarela), a **pr√≥xima requisi√ß√£o que chega de uma v√≠tima** ser√° **anexada na fila logo ap√≥s o par√¢metro refletido**:

![](<../.gitbook/assets/image (634) (1).png>)

Ent√£o, a **v√≠tima** ir√° **receber** a **resposta √† requisi√ß√£o dorminhoca** e se, nesse meio tempo, o **atacante** **enviar** **outra** **requisi√ß√£o**, a **resposta da requisi√ß√£o de conte√∫do refletido ser√° enviada para ele**.

## Dessincroniza√ß√£o de Respostas

At√© este ponto, aprendemos como abusar de ataques de Smuggling de Requisi√ß√µes HTTP para **controlar** a **requisi√ß√£o** cuja **resposta** um **cliente** vai **receber** e como voc√™ pode ent√£o **roubar a resposta que era destinada √† v√≠tima**.

Mas ainda √© poss√≠vel **dessincronizar ainda mais** as respostas.

Existem requisi√ß√µes interessantes como a requisi√ß√£o **HEAD** que s√£o especificadas para n√£o ter **nenhum conte√∫do no corpo das respostas** e que devem (devem) **conter o Content-Length** da requisi√ß√£o como **se fosse uma requisi√ß√£o GET**.

Portanto, se um atacante **injetar** uma requisi√ß√£o **HEAD**, como nestas imagens:

![](<../.gitbook/assets/image (626).png>)

Ent√£o, **uma vez que a azul √© respondida ao atacante**, a pr√≥xima requisi√ß√£o da v√≠tima ser√° introduzida na fila:

![](<../.gitbook/assets/image (651) (1) (1) (1) (1) (1) (1).png>)

Ent√£o, a **v√≠tima** ir√° **receber** a **resposta** da **requisi√ß√£o HEAD**, que **vai conter um Content-Length mas nenhum conte√∫do**. Portanto, o proxy **n√£o enviar√° essa resposta** para a v√≠tima, mas ir√° **aguardar** por algum **conte√∫do**, que na verdade ser√° a **resposta √† requisi√ß√£o amarela** (tamb√©m injetada pelo atacante):

![](<../.gitbook/assets/image (627) (1).png>)

### Confus√£o de Conte√∫do

Seguindo o exemplo anterior, sabendo que voc√™ pode **controlar o corpo** da requisi√ß√£o cuja resposta a v√≠tima vai receber e que uma **resposta HEAD** geralmente cont√©m em seus cabe√ßalhos o **Content-Type e o Content-Length**, voc√™ pode **enviar uma requisi√ß√£o como a seguinte** para **causar XSS** na v√≠tima sem que a p√°gina seja vulner√°vel ao XSS:

![](<../.gitbook/assets/image (654) (1) (1) (1).png>)

### Envenenamento de Cache

Abusando do ataque de Confus√£o de Conte√∫do de dessincroniza√ß√£o de respostas comentado anteriormente, **se o cache armazenar a resposta √† requisi√ß√£o realizada pela v√≠tima e essa resposta for uma injetada causando um XSS, ent√£o o cache estar√° envenenado**.

Requisi√ß√£o maliciosa contendo a carga √∫til XSS:

![](<../.gitbook/assets/image (644) (1).png>)

Resposta maliciosa para a v√≠tima que cont√©m o cabe√ßalho que indica ao cache para armazenar a resposta:

![](<../.gitbook/assets/image (629) (1).png>)

{% hint style="warning" %}
Observe que, neste caso, se o **"v√≠tima" for o atacante**, ele poder√° agora realizar **envenenamento de cache em URLs arbitr√°rias** pois ele pode **controlar a URL que ser√° armazenada em cache** com a resposta maliciosa.
{% endhint %}

### Decep√ß√£o de Cache da Web

Este ataque √© semelhante ao anterior, mas **em vez de injetar uma carga √∫til dentro do cache, o atacante ir√° armazenar informa√ß√µes da v√≠tima dentro do cache:**

![](<../.gitbook/assets/image (643) (1) (1).png>)

### Divis√£o de Respostas

O **objetivo** deste ataque √© abusar novamente da **dessincroniza√ß√£o de respostas** para **fazer o proxy enviar uma resposta 100% gerada pelo atacante**.

Para alcan√ßar isso, o atacante precisa encontrar um endpoint da aplica√ß√£o web que est√° **refletindo alguns valores dentro da resposta** e **saber o comprimento do conte√∫do da resposta HEAD**.

Ele enviar√° um **exploit** como:

![](<../.gitbook/assets/image (649) (1) (1) (1).png>)

Ap√≥s a primeira requisi√ß√£o ser resolvida e enviada de volta ao atacante, a **requisi√ß√£o da v√≠tima √© adicionada √† fila**:

![](<../.gitbook/assets/image (661) (1) (1) (1).png>)

A v√≠tima receber√° como resposta o **HEAD response + o conte√∫do da resposta da segunda requisi√ß√£o (contendo parte dos dados refletidos):**

![](<../.gitbook/assets/image (633) (1).png>)

No entanto, observe como os **dados refletidos tinham um tamanho de acordo com o Content-Length** da **resposta HEAD** que **gerou uma resposta HTTP v√°lida na fila de respostas**.

Portanto, a **pr√≥xima requisi√ß√£o do segundo usu√°rio** ser√° **recebendo** como **resposta algo completamente criado pelo atacante**. Como a resposta √© completamente criada pelo atacante, ele tamb√©m pode **fazer o proxy armazenar em cache a resposta**.


<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) reposit√≥rios do github.

</details>
