# HTTP Odgovor Smugliranje / Desinkronizacija

<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite svoju **kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**PLANOVE ZA PRETPLATU**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**Porodicu PEASS**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili **pratite** nas na **Twitteru** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

**Tehnika ovog posta je preuzeta iz videa:** [**https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s**](https://www.youtube.com/watch?v=suxDcYViwao\&t=1343s)

## Desinkronizacija Reda HTTP Zahteva

Prvo, ova tehnika **zloupotrebljava ranjivost HTTP zahteva za smugliranje**, pa morate znati šta je to:

**Glavna** **razlika** između ove tehnike i običnog HTTP zahteva za smugliranje je što **umesto** **napadanja** **zahteva** **žrtve dodavanjem prefiksa**, mi ćemo **procuriti ili modifikovati odgovor koji žrtva prima**. To se postiže tako što, umesto slanja 1 zahteva i pola za zloupotrebu HTTP zahteva za smugliranje, **šaljemo 2 potpuna zahteva za desinkronizaciju redova odgovora posrednika**.

Ovo je zato što ćemo biti u mogućnosti da **desinkronizujemo red odgovora** tako da **odgovor** sa **legitimnog zahteva** **žrtve bude poslat napadaču**, ili **ubacivanjem sadržaja kontrolisanog od strane napadača u odgovor žrtvi**.

### Desinkronizacija HTTP Pipeline-a

HTTP/1.1 omogućava da se **traže različiti resursi bez potrebe da se čeka na prethodne**. Stoga, ako postoji **posrednik** u **sredini**, posao posrednika je da **održava sinhronizovan odgovarajući skup zahteva poslatih backendu i odgovora koji dolaze od njega**.

Međutim, postoji problem desinkronizacije redova odgovora. Ako napadač pošalje napad za smugliranje HTTP odgovora i odgovori na **početni zahtev i smuglirani odmah stignu**, smuglirani odgovor neće biti ubačen u red odgovora žrtve već će **biti odbačen kao greška**.

![](<../.gitbook/assets/image (630).png>)

Stoga je potrebno da **smuglirani zahtev** **traje duže da se obradi** unutar serverske strane. Dakle, do trenutka kada se smuglirani zahtev obradi, komunikacija sa napadačem će biti završena.

U ovoj specifičnoj situaciji, ako **žrtva pošalje zahtev** i **smuglirani zahtev dobije odgovor pre** legitimnog zahteva, **smuglirani odgovor će biti poslat žrtvi**. Dakle, napadač će **kontrolisati zahtev "izvršen" od strane žrtve**.

Osim toga, ako **napadač zatim izvrši zahtev** i **legitimni odgovor** na **zahtev žrtve** bude **odgovoren** **pre** zahteva napadača. **Odgovor žrtvi će biti poslat napadaču**, **ukradući** odgovor žrtvi (koji može sadržati na primer zaglavlje **Set-Cookie**).

![](<../.gitbook/assets/image (1017).png>)

![](<../.gitbook/assets/image (716).png>)

### Višestruke Ugnježdene Injekcije

Još jedna **interesantna razlika** sa običnim **HTTP zahtevom za smugliranje** je što, u običnom napadu smugliranja, **cilj** je **modifikovati početak zahteva žrtve** kako bi izvršila neočekivanu akciju. U **napadu smugliranja HTTP odgovora**, pošto **šaljete kompletne zahteve**, možete **ubaciti u jedan payload desetine odgovora** koji će **desinkronizovati desetine korisnika** koji će **primiti** **ubacene** **odgovore**.

Osim što možete **jednostavnije distribuirati desetine eksploatacija** među legitimnim korisnicima, ovo takođe može biti korišćeno za izazivanje **DoS** na serveru.

### Organizacija Eksploatacije

Kao što je objašnjeno ranije, da biste zloupotrebili ovu tehniku, potrebno je da **prva smuglirana poruka** u serveru **traje dugo da se obradi**.

Ovaj **zahtev koji traje dugo je dovoljan** ako želite samo da **pokušate ukrasti odgovor žrtve**. Ali ako želite izvršiti složeniju eksploataciju, ovo će biti uobičajena struktura za eksploataciju.

Prvo **početni** zahtev zloupotrebljavajući **HTTP** **zahtev** **za smugliranje**, zatim **zahtev koji traje dugo** i zatim **1 ili više zahteva sa payloadom** čiji će odgovori biti poslati žrtvama.

## Zloupotreba Desinkronizacije Reda HTTP Odgovora

### Hvatanje zahteva drugih korisnika <a href="#capturing-other-users-requests" id="capturing-other-users-requests"></a>

Kao i sa poznatim payloadima za smugliranje HTTP zahteva, možete **ukrasti zahtev žrtve** sa jednom važnom razlikom: U ovom slučaju vam je potrebno samo da **poslati sadržaj bude reflektovan u odgovoru**, **nije potrebno trajno skladištenje**.

Prvo, napadač šalje payload koji sadrži **završni POST zahtev sa reflektovanim parametrom** na kraju i velikim Content-Length

![](<../.gitbook/assets/image (1050).png>)

Zatim, kada je **početni zahtev** (plavi) **obradjen** i **dok** se **spori** zahtev obrađuje (žuti) **naredni zahtev koji stiže od žrtve** će biti **dodat u red odmah posle reflektovanog parametra**:

![](<../.gitbook/assets/image (791).png>)

Zatim, **žrtva** će **primiti** **odgovor na spor** zahtev i ako u međuvremenu **napadač pošalje još jedan** **zahtev**, **odgovor na zahtev sa reflektovanim sadržajem će biti poslat njemu**.

## Desinkronizacija Odgovora

Do sada smo naučili kako zloupotrebiti napade HTTP zahteva za smugliranje da **kontrolišemo** **zahtev** **čiji** **odgovor** će **klijent** **primiti** i kako možete zatim **ukrasti odgovor koji je bio namenjen žrtvi**.

Ali još uvek je moguće **desinkronizovati još više** odgovore.

Postoje interesantni zahtevi poput **HEAD** zahteva koji su specifični da nemaju **nikakav sadržaj unutar tela odgovora** i koji bi (mora) **sadržati Content-Length** zahteva kao **da je to GET zahtev**.

Stoga, ako napadač **ubaci** **HEAD** zahtev, kao na ovim slikama:

![](<../.gitbook/assets/image (1104).png>)

Onda, **kada plavi bude odgovoren napadaču**, sledeći zahtev žrtve će biti ubačen u red:

![](<../.gitbook/assets/image (996).png>)

Zatim, **žrtva** će **primiti** **odgovor** na **HEAD** zahtev, koji će **sadržati Content-Length ali nikakav sadržaj**. Stoga, posrednik **neće poslati ovaj odgovor** žrtvi, već će **čekati** na neki **sadržaj**, koji će zapravo biti **odgovor na žuti zahtev** (takođe ubačen od strane napadača):

![](<../.gitbook/assets/image (732).png>)
### Konfuzija sadržaja

Nakon prethodnog primera, znajući da možete **kontrolisati telo** zahteva čiji će odgovor primiti žrtva i da **HEAD** **odgovor** obično sadrži u zaglavljima **Content-Type i Content-Length**, možete **poslati zahtev kao što je sledeći** kako biste izazvali XSS u žrtvi, a da stranica nije ranjiva na XSS:

![](<../.gitbook/assets/image (685).png>)

### Trovanje keša

Zloupotrebom prethodno komentisanog napada na konfuziju sadržaja odgovora, **ako keš čuva odgovor na zahtev koji je izvršila žrtva i ovaj odgovor je ubačen koji izaziva XSS, tada je keš zaražen**.

Zlonamerni zahtev koji sadrži XSS payload:

![](<../.gitbook/assets/image (611).png>)

Zlonamerni odgovor žrtvi koji sadrži zaglavlje koje ukazuje kešu da sačuva odgovor:

![](<../.gitbook/assets/image (563).png>)

{% hint style="warning" %}
Imajte na umu da u ovom slučaju, ako je **"žrtva" napadač**, on sada može izvršiti **trovanje keša na proizvoljnim URL-ovima** jer može **kontrolisati URL koji će biti keširan** sa zlonamernim odgovorom.
{% endhint %}

### Prevara keša veb stranica

Ovaj napad je sličan prethodnom, ali **umesto ubacivanja payloada unutar keša, napadač će keširati informacije žrtve unutar keša:**

![](<../.gitbook/assets/image (988).png>)

### Podela odgovora

Cilj ovog napada je ponovo zloupotreba **desinhronizacije odgovora** kako bi se **naterao proxy da pošalje odgovor koji je 100% generisan od strane napadača**.

Da bi postigao ovo, napadač mora pronaći krajnju tačku veb aplikacije koja **reflektuje neke vrednosti unutar odgovora** i **znati dužinu sadržaja HEAD odgovora**.

Poslaće **eksploit** poput:

![](<../.gitbook/assets/image (908).png>)

Nakon što se prvi zahtev reši i pošalje nazad napadaču, **zahtev žrtve se dodaje u red**:

![](<../.gitbook/assets/image (734).png>)

Žrtva će kao odgovor primiti **HEAD odgovor + sadržaj odgovora drugog zahteva (koji sadrži deo reflektovanih podataka):**

![](<../.gitbook/assets/image (353).png>)

Međutim, obratite pažnju kako je **reflektovani podatak imao veličinu u skladu sa Content-Length** odgovora **HEAD** koji je **generisao validan HTTP odgovor u redu odgovora**.

Stoga, **naredni zahtev drugog žrtve** će **primiti** kao **odgovor nešto potpuno kreirano od strane napadača**. Pošto je odgovor potpuno kreiran od strane napadača, on takođe može **naterati proxy da kešira odgovor**.
