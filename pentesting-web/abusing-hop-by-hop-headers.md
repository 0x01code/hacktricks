# ホップバイホップヘッダー

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>！</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで企業を宣伝**してみたいですか？または**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れましょう
* **[💬](https://emojipedia.org/speech-balloon/) [Discordグループ](https://discord.gg/hRep4RUj7f)に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**私をフォロー**する🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出して、あなたのハッキングトリックを共有してください。

</details>

**この記事は[https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers](https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers)の要約です**

ホップバイホップヘッダーは、単一のトランスポートレベル接続に固有であり、主にHTTP/1.1で使用され、2つのノード間のデータを管理するために使用されます（クライアント-プロキシまたはプロキシ-プロキシなど）、転送されることを意図していません。標準のホップバイホップヘッダーには、`Keep-Alive`、`Transfer-Encoding`、`TE`、`Connection`、`Trailer`、`Upgrade`、`Proxy-Authorization`、`Proxy-Authenticate`が含まれます。これらは[RFC 2616](https://tools.ietf.org/html/rfc2616#section-13.5.1)で定義されています。追加のヘッダーは、`Connection`ヘッダーを介してホップバイホップとして指定できます。

### ホップバイホップヘッダーの悪用
プロキシによるホップバイホップヘッダーの適切な管理がされていないと、セキュリティの問題が発生する可能性があります。これらのヘッダーを削除することが期待されているプロキシでも、すべてが削除されるわけではなく、潜在的な脆弱性が生じる可能性があります。

### ホップバイホップヘッダーの処理のテスト
ホップバイホップヘッダーの処理は、特定のヘッダーがホップバイホップとしてマークされたときにサーバー応答に変化が見られることでテストできます。ツールやスクリプトを使用してこのプロセスを自動化し、プロキシがこれらのヘッダーをどのように処理するかを特定し、ミス構成やプロキシの動作を明らかにすることができます。

ホップバイホップヘッダーの悪用はさまざまなセキュリティ上の影響をもたらす可能性があります。以下に、これらのヘッダーを悪用して潜在的な攻撃を行う方法を示す例がいくつかあります：

### `X-Forwarded-For`を使用したセキュリティコントロールのバイパス
攻撃者は、`X-Forwarded-For`ヘッダーを操作してIPベースのアクセス制御をバイパスすることができます。このヘッダーは、プロキシがクライアントの元のIPアドレスを追跡するためによく使用されます。ただし、プロキシがこのヘッダーをホップバイホップとして扱い、適切な検証なしに転送する場合、攻撃者は自分のIPアドレスを偽装することができます。

**攻撃シナリオ：**
1. 攻撃者は、`X-Forwarded-For`ヘッダーに偽のIPアドレスを含めて、プロキシの背後にあるWebアプリケーションにHTTPリクエストを送信します。
2. 攻撃者は、`Connection: close, X-Forwarded-For`ヘッダーも含め、プロキシに`X-Forwarded-For`をホップバイホップとして扱うよう促します。
3. 設定が誤っているプロキシは、スプーフィングされた`X-Forwarded-For`ヘッダーを削除せずにWebアプリケーションにリクエストを転送します。
4. 元の`X-Forwarded-For`ヘッダーが見えないWebアプリケーションは、リクエストを信頼されたプロキシから直接受信していると見なし、不正なアクセスを許可する可能性があります。

### ホップバイホップヘッダーインジェクションによるキャッシュの汚染
キャッシュサーバーがホップバイホップヘッダーに基づいてコンテンツを誤ってキャッシュする場合、攻撃者は悪意のあるヘッダーをインジェクトしてキャッシュを汚染することができます。これにより、同じリソースを要求するユーザーに誤ったまたは悪意のあるコンテンツが提供されます。

**攻撃シナリオ：**
1. 攻撃者は、キャッシュされてはならないホップバイホップヘッダーを持つリクエストをWebアプリケーションに送信します（例：`Connection: close, Cookie`）。
2. 設定が不十分なキャッシュサーバーは、ホップバイホップヘッダーを削除せずに、攻撃者のセッションに特化したレスポンスをキャッシュします。
3. 同じリソースを要求する将来のユーザーは、攻撃者向けに調整されたキャッシュされたレスポンスを受け取り、セッションハイジャックや機密情報の公開につながる可能性があります。

<details>

<summary><strong>htARTE（HackTricks AWS Red Team Expert）でAWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>！</strong></a></summary>

* **サイバーセキュリティ企業**で働いていますか？ **HackTricksで企業を宣伝**してみたいですか？または**PEASSの最新バージョンにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFT**](https://opensea.io/collection/the-peass-family)コレクションをご覧ください
* [**公式PEASS＆HackTricksスウェグ**](https://peass.creator-spring.com)を手に入れましょう
* **[💬](https://emojipedia.org/speech-balloon/) [Discordグループ](https://discord.gg/hRep4RUj7f)に参加するか、[telegramグループ](https://t.me/peass)に参加するか、**Twitter**で**私をフォロー**する🐦[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**
* **[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)**にPRを提出して、あなたのハッキングトリックを共有してください。

</details>
