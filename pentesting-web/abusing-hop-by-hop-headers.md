# Cabe√ßalhos hop-by-hop

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## O que √© um cabe√ßalho hop-by-hop?

Um cabe√ßalho hop-by-hop √© um cabe√ßalho projetado para ser processado e consumido pelo proxy que est√° manipulando a solicita√ß√£o, em oposi√ß√£o a um cabe√ßalho end-to-end.

De acordo com o [RFC 2616](https://tools.ietf.org/html/rfc2616#section-13.5.1), a especifica√ß√£o HTTP/1.1 trata os seguintes cabe√ßalhos como hop-by-hop por padr√£o: `Keep-Alive`, `Transfer-Encoding`, `TE`, `Connection`, `Trailer`, `Upgrade`, `Proxy-Authorization` e `Proxy-Authenticate`. Ao encontrar esses cabe√ßalhos em uma solicita√ß√£o, um proxy compat√≠vel deve processar ou executar o que esses cabe√ßalhos est√£o indicando e n√£o encaminh√°-los para o pr√≥ximo hop.

Al√©m desses padr√µes, uma solicita√ß√£o [tamb√©m pode definir um conjunto personalizado de cabe√ßalhos para serem tratados como hop-by-hop](https://tools.ietf.org/html/rfc2616#section-14.10) adicionando-os ao cabe√ßalho `Connection`, como abaixo:
```
Connection: close, X-Foo, X-Bar
```
## A teoria sobre o abuso de cabe√ßalhos hop-by-hop

Em teoria, os proxies devem remover os cabe√ßalhos hop-by-hop recebidos antes de envi√°-los para o pr√≥ximo endere√ßo. Mas voc√™ pode encontrar na pr√°tica que isso √© feito por alguns proxies e outros apenas enviam todos os cabe√ßalhos adicionando seu pr√≥prio cabe√ßalho `Connection`.

![](<../.gitbook/assets/image (138).png>)

## Testando exclus√µes hop-by-hop

Se voc√™ encontrar um cabe√ßalho que faz com que a resposta do servidor mude se ele estiver definido ou n√£o, ent√£o voc√™ pode procurar por exclus√µes hop-by-hop. Por exemplo, o cabe√ßalho cookie far√° com que a resposta do servidor seja dramaticamente diferente se ele estiver definido (com um conte√∫do v√°lido) ou n√£o.

Ent√£o, envie uma solicita√ß√£o com um cabe√ßalho v√°lido e com este valor do cabe√ßalho Connection `Connection: close, Cookie` se a resposta for a mesma que se o cookie n√£o tivesse sido enviado, ent√£o h√° um proxy removendo cabe√ßalhos.

Voc√™ pode descobrir se a resposta do servidor √© diferente se um cabe√ßalho for exclu√≠do usando esta t√©cnica usando [este script](https://gist.github.com/ndavison/298d11b3a77b97c908d63a345d3c624d). Ent√£o, se voc√™ passar uma lista de cabe√ßalhos conhecidos, como [esta](https://github.com/danielmiessler/SecLists/blob/master/Discovery/Web-Content/BurpSuite-ParamMiner/lowercase-headers), voc√™ pode observar quais cabe√ßalhos est√£o causando efeitos apesar de n√£o estarem na sua solicita√ß√£o original:
```
for HEADER in $(cat headers.txt); do python poison-test.py -u "https://target" -x "$HEADER"; sleep 1; done
```
Este ciclo percorrer√° toda a lista de cabe√ßalhos e imprimir√° se a presen√ßa dele na lista hop-by-hop criou um c√≥digo de status diferente ou um tamanho de corpo de resposta.

## Abusando do X-Forwarded-For

Em geral, os proxies adicionam os IPs dos clientes dentro do cabe√ßalho `X-Forwarded-For` para que o pr√≥ximo salto saiba de onde vem a peti√ß√£o. No entanto, se um atacante enviar um valor de Conex√£o como `Connection: close, X-Forwarded-For` e o primeiro proxy enviar os cabe√ßalhos hop-by-hop com seus valores (ele envia o valor especial de Conex√£o), ent√£o o segundo valor pode excluir o cabe√ßalho X-Forward-For.\
No final, o aplicativo final n√£o saber√° quem enviou a solicita√ß√£o e pode pensar que foi o √∫ltimo proxy, e nesse cen√°rio um atacante pode ser capaz de acessar recursos protegidos por lista branca de IP (talvez algum `/admin`?).

Dependendo do sistema que est√° sendo visado, voc√™ tamb√©m pode ter `Forwarded`, `X-Real-IP` e um monte de outros que s√£o menos comuns.

## Detectando Proxies e identificando servi√ßos

Esta t√©cnica pode ser √∫til para detectar proxies (usando a t√©cnica de cookie) ou mesmo para detectar servi√ßos. Por exemplo, se voc√™ abusar dessa t√©cnica para excluir o cabe√ßalho `X-BLUECOAT-VIA` e um erro for lan√ßado, ent√£o voc√™ descobriu que o Bluecoat estava sendo usado.

## Outros ataques

* Para um poss√≠vel envenenamento de cache DoS abusando dessa t√©cnica, leia o link original
* Isso pode ser √∫til em ataques que permitem que voc√™ insira novos cabe√ßalhos (baixa probabilidade)
* Tamb√©m pode ser √∫til para contornar funcionalidades defensivas. Por exemplo, se a falta de um cabe√ßalho significa que uma solicita√ß√£o n√£o deve ser processada por um WAF, voc√™ pode contornar um WAF com essa t√©cnica.

## Refer√™ncias

{% embed url="https://nathandavison.com/blog/abusing-http-hop-by-hop-request-headers" %}

‚Äã

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.\


{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o [reposit√≥rio hacktricks](https://github.com/carlospolop/hacktricks) e [hacktricks-cloud repo](https://github.com/carlospolop/hacktricks-cloud)**.

</details>
