# OAuth para Tomada de Conta

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas <a href="#d4a8" id="d4a8"></a>

Existem algumas vers√µes diferentes do OAuth, voc√™ pode ler [https://oauth.net/2/](https://oauth.net/2/) para ter uma compreens√£o b√°sica.

Neste artigo, estaremos nos concentrando no fluxo mais comum que voc√™ encontrar√° hoje, que √© o [tipo de concess√£o de c√≥digo de autoriza√ß√£o OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/). Em ess√™ncia, o OAuth fornece aos desenvolvedores um **mecanismo de autoriza√ß√£o para permitir que um aplicativo acesse dados ou execute determinadas a√ß√µes em sua conta, a partir de outro aplicativo** (o servidor de autoriza√ß√£o).

Por exemplo, digamos que o site _**https://yourtweetreader.com**_ tenha funcionalidade para **exibir todos os tweets que voc√™ j√° enviou**, incluindo tweets privados. Para fazer isso, o OAuth 2.0 √© introduzido. _https://yourtweetreader.com_ pedir√° que voc√™ **autorize seu aplicativo do Twitter a acessar todos os seus tweets**. Uma p√°gina de consentimento aparecer√° em _https://twitter.com_ exibindo quais **permiss√µes est√£o sendo solicitadas** e quem √© o desenvolvedor que est√° solicitando. Depois de autorizar a solicita√ß√£o, _https://yourtweetreader.com_ ser√° **capaz de acessar seus tweets em seu nome**.

Elementos importantes para entender em um contexto OAuth 2.0:

* **dono do recurso**: O `dono do recurso` √© o **usu√°rio/entidade** que concede acesso ao seu recurso protegido, como seus tweets da conta do Twitter. Neste exemplo, seria **voc√™**.
* **servidor de recursos**: O `servidor de recursos` √© o **servidor que lida com solicita√ß√µes autenticadas** ap√≥s o aplicativo obter um `token de acesso` em nome do `dono do recurso`. Neste exemplo, seria **https://twitter.com**
* **aplicativo cliente**: O `aplicativo cliente` √© o **aplicativo que solicita autoriza√ß√£o** do `dono do recurso`. Neste exemplo, seria **https://yourtweetreader.com**.
* **servidor de autoriza√ß√£o**: O `servidor de autoriza√ß√£o` √© o **servidor que emite `tokens de acesso`** para o `aplicativo cliente` **ap√≥s autenticar com sucesso** o `dono do recurso` e obter autoriza√ß√£o. No exemplo acima, seria **https://twitter.com**
* **client\_id**: O `client_id` √© o **identificador do aplicativo**. Este √© um identificador √∫nico p√∫blico, **n√£o secreto**.
* **client\_secret:** O `client_secret` √© um **segredo conhecido apenas pelo aplicativo e pelo servidor de autoriza√ß√£o**. Isso √© usado para gerar `access_tokens`
* **response\_type**: O `response_type` √© um valor para detalhar **qual tipo de token** est√° sendo solicitado, como `code`
* **scope**: O `scope` √© o **n√≠vel de acesso solicitado** que o `aplicativo cliente` est√° solicitando do `dono do recurso`
* **redirect\_uri**: O `redirect_uri` √© a **URL para a qual o usu√°rio √© redirecionado ap√≥s a conclus√£o da autoriza√ß√£o**. Isso geralmente deve corresponder √† URL de redirecionamento que voc√™ registrou anteriormente no servi√ßo
* **state**: O par√¢metro `state` pode **persistir dados entre o usu√°rio sendo direcionado para o servidor de autoriza√ß√£o e de volta novamente**. √â importante que este seja um valor √∫nico, pois serve como um mecanismo de **prote√ß√£o CSRF** se contiver um valor √∫nico ou aleat√≥rio por solicita√ß√£o
* **grant\_type**: O par√¢metro `grant_type` explica **qual √© o tipo de concess√£o** e qual token ser√° retornado
* **code**: Este `code` √© o c√≥digo de autoriza√ß√£o recebido do `servidor de autoriza√ß√£o`, que estar√° no par√¢metro da string de consulta "code" nesta solicita√ß√£o. Este c√≥digo √© usado em conjunto com o `client_id` e `client_secret` pelo aplicativo cliente para buscar um `access_token`
* **access\_token**: O `access_token` √© o **token que o aplicativo cliente usa para fazer solicita√ß√µes de API** em nome do `dono do recurso`
* **refresh\_token**: O `refresh_token` permite que um aplicativo **obtenha um novo `access_token` sem solicitar ao usu√°rio**

### Exemplo Real

Colocando tudo isso junto, aqui est√° o que um **fluxo OAuth real parece**:

1. Voc√™ visita [https://yourtweetreader.com](https://yourtweetreader.com) e clica no bot√£o "Integrar com o Twitter".
2. [https://yourtweetreader.com](https://yourtweetreader.com) envia uma solicita√ß√£o para [https://twitter.com](https://twitter.com) pedindo que voc√™, o dono do recurso, autorize o aplicativo do Twitter do https://yourtweetreader.com a acessar seus tweets. A solicita√ß√£o ser√° assim:
```
https://twitter.com/auth
 ?response_type=code
 &client_id=yourtweetreader_clientId
 &redirect_uri=https%3A%2F%2Fyourtweetreader.com%2Fcallback
 &scope=readTweets
 &state=kasodk9d1jd992k9klaskdh123
```
3. Voc√™ ser√° solicitado com uma p√°gina de consentimento:

![](https://miro.medium.com/max/1215/1\*y66EY3Fn2qn-NPI9nhZC7A.png)

4. Uma vez aceito, o Twitter enviar√° uma solicita√ß√£o de volta para o `redirect_uri` com os par√¢metros `code` e `state`:
```
https://yourtweetreader.com?code=asd91j3jd91j92j1j9d1&state=kasodk9d1jd992k9klaskdh123
```
5\. Em seguida, o [https://yourtweetreader.com](https://yourtweetreader.com) ir√° pegar esse `code` e, usando o `client_id` e `client_secret` da aplica√ß√£o deles, far√° uma solicita√ß√£o ao servidor para recuperar um `access_token` em seu nome, o que permitir√° que eles acessem as permiss√µes que voc√™ consentiu:
```
POST /oauth/access_token
Host: twitter.com
...{"client_id": "yourtweetreader_clientId", "client_secret": "yourtweetreader_clientSecret", "code": "asd91j3jd91j92j1j9d1", "grant_type": "authorization_code"}
```
6\. Finalmente, o fluxo est√° completo e [https://yourtweetreader.com](https://yourtweetreader.com) far√° uma chamada de API para o Twitter com seu `access_token` para acessar seus Tweets.

## Descobertas de Bug Bounty <a href="#323a" id="323a"></a>

Agora, a parte interessante! Existem muitas coisas que podem dar errado em uma implementa√ß√£o OAuth, aqui est√£o as diferentes categorias de bugs que vejo com frequ√™ncia:

### Configura√ß√£o fraca de `redirect_uri` <a href="#cc36" id="cc36"></a>

O `redirect_uri` √© muito importante porque **dados sens√≠veis, como o `code`, s√£o anexados a esta URL** ap√≥s a autoriza√ß√£o. Se o `redirect_uri` puder ser redirecionado para um **servidor controlado pelo atacante**, isso significa que o atacante pode potencialmente **assumir a conta de uma v√≠tima** usando o `code` eles mesmos e ganhando acesso aos dados da v√≠tima.

A maneira como isso ser√° explorado vai variar de acordo com o servidor de autoriza√ß√£o. **Alguns** s√≥ v√£o **aceitar** o mesmo caminho **`redirect_uri` especificado na aplica√ß√£o cliente**, mas alguns v√£o **aceitar qualquer coisa** no mesmo dom√≠nio ou subdiret√≥rio do `redirect_uri`.

Dependendo da l√≥gica manipulada pelo servidor, existem v√°rias t√©cnicas para contornar um `redirect_uri`. Em uma situa√ß√£o em que um `redirect_uri` √© [https://yourtweetreader.com](https://yourtweetreader.com)/callback, essas incluem:

* Redirecionamentos abertos: [`https://yourtweetreader.com`](https://yourtweetreader.com)`/callback?redirectUrl=https://evil.com`
* Traversal de caminho: `https://yourtweetreader.com/callback/../redirect?url=https://evil.com`
* Regexes de `redirect_uri` fracos: `https://yourtweetreader.com.evil.com`
* Inje√ß√£o de HTML e roubo de tokens via cabe√ßalho referer: `https://yourtweetreader.com/callback/home/attackerimg.jpg`

**Outros par√¢metros** que podem ser vulner√°veis a Redirecionamentos Abertos s√£o:

* **client_uri** - URL da p√°gina inicial da aplica√ß√£o cliente
* **policy_uri** - URL que o aplicativo cliente do Relying Party fornece para que o usu√°rio final possa ler sobre como seus dados de perfil ser√£o usados.
* **tos_uri** - URL que o cliente do Relying Party fornece para que o usu√°rio final possa ler sobre os termos de servi√ßo do Relying Party.
* **initiate_login_uri** - URI usando o esquema https que um terceiro pode usar para iniciar um login pelo RP. Tamb√©m deve ser usado para redirecionamento do lado do cliente.

Todos esses par√¢metros s√£o **opcionais de acordo com as especifica√ß√µes do OAuth e OpenID** e nem sempre s√£o suportados em um servidor espec√≠fico, portanto, sempre vale a pena identificar quais par√¢metros s√£o suportados em seu servidor.

Se voc√™ direcionar um servidor OpenID, o ponto de descoberta em \*\*`.well-known/openid-configuration`\*\* √†s vezes cont√©m par√¢metros como "_registration\_endpoint_", "_request\_uri\_parameter\_supported_" e "_require\_request\_uri\_registration_". Isso pode ajud√°-lo a encontrar o ponto de registro e outros valores de configura√ß√£o do servidor.

### XSS na implementa√ß√£o de redirecionamento <a href="#bda5" id="bda5"></a>

Como mencionado neste relat√≥rio de bug bounty [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), pode ser poss√≠vel que a **URL de redirecionamento esteja sendo refletida na resposta** do servidor ap√≥s o usu√°rio se autenticar, sendo **vulner√°vel a XSS**. Carga √∫til poss√≠vel para teste:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Manipula√ß√£o inadequada do par√¢metro de estado <a href="#bda5" id="bda5"></a>

Muitas vezes, o par√¢metro **`state` √© completamente omitido ou usado de maneira incorreta**. Se um par√¢metro de estado **n√£o existir** ou for um valor est√°tico que nunca muda, o fluxo do OAuth provavelmente estar√° **vulner√°vel a CSRF**. √Äs vezes, mesmo que haja um par√¢metro `state`, a **aplica√ß√£o pode n√£o validar o par√¢metro** e um ataque funcionar√°. A maneira de explorar isso seria passar pelo processo de autoriza√ß√£o em sua pr√≥pria conta e pausar logo ap√≥s a autoriza√ß√£o. Voc√™ encontrar√° uma solicita√ß√£o como esta:
```
https://yourtweetreader.com?code=asd91j3jd91j92j1j9d1
```
Depois de receber essa solicita√ß√£o, voc√™ pode **descartar a solicita√ß√£o porque esses c√≥digos s√£o geralmente de uso √∫nico**. Em seguida, voc√™ pode enviar esta URL para um usu√°rio conectado e ela adicionar√° sua conta √† conta deles. A princ√≠pio, isso pode n√£o parecer muito sens√≠vel, j√° que voc√™ est√° simplesmente adicionando sua conta √† conta da v√≠tima. No entanto, muitas implementa√ß√µes do OAuth s√£o para fins de login, ent√£o se voc√™ puder adicionar sua conta do Google, que √© usada para fazer login, voc√™ poder√° potencialmente realizar uma **Assun√ß√£o de Conta** com um √∫nico clique, j√° que fazer login com sua conta do Google lhe daria acesso √† conta da v√≠tima.

Voc√™ pode encontrar um **exemplo** sobre isso neste [**CTF writeup**](https://github.com/gr455/ctf-writeups/blob/master/hacktivity20/notes\_surfer.md) e na **caixa HTB chamada Oouch**.

Tamb√©m vi o par√¢metro de estado usado como um valor de redirecionamento adicional v√°rias vezes. O aplicativo usar√° `redirect_uri` para o redirecionamento inicial, mas ent√£o o par√¢metro `state` como um segundo redirecionamento que poderia conter o `code` nos par√¢metros de consulta ou no cabe√ßalho referer.

Uma coisa importante a observar √© que isso n√£o se aplica apenas a situa√ß√µes de login e assun√ß√£o de conta. Vi m√°s configura√ß√µes em:

* Integra√ß√µes do Slack permitindo que um invasor adicione sua conta do Slack como destinat√°rio de todas as notifica√ß√µes/mensagens
* Integra√ß√µes do Stripe permitindo que um invasor substitua as informa√ß√µes de pagamento e aceite pagamentos dos clientes da v√≠tima
* Integra√ß√µes do PayPal permitindo que um invasor adicione sua conta do PayPal √† conta da v√≠tima, o que depositaria dinheiro na conta do PayPal do invasor

### Pr√©-Assun√ß√£o de Conta <a href="#ebe4" id="ebe4"></a>

Um dos outros problemas mais comuns que vejo √© quando os aplicativos permitem "Entrar com X", mas tamb√©m nome de usu√°rio/senha. Existem 2 maneiras diferentes de atacar isso:

1. Se o aplicativo **n√£o exigir verifica√ß√£o de e-mail na cria√ß√£o da conta**, tente **criar uma conta com o endere√ßo de e-mail da v√≠tima e a senha do invasor** antes que a v√≠tima se registre. Se a **v√≠tima** ent√£o tentar se registrar ou entrar **com um terceiro**, como o Google, √© poss√≠vel que o aplicativo fa√ßa uma pesquisa, veja que o e-mail j√° est√° registrado e, em seguida, **vincule a conta do Google deles √† conta criada pelo invasor**. Isso √© uma "pr√©-assun√ß√£o de conta" em que um invasor ter√° acesso √† conta da v√≠tima se a criou antes do registro da v√≠tima.
2. Se um **aplicativo OAuth n√£o exigir verifica√ß√£o de e-mail**, tente se inscrever com esse aplicativo OAuth com um **endere√ßo de e-mail da v√≠tima**. O mesmo problema acima pode existir, mas voc√™ estaria atacando-o na outra dire√ß√£o e obtendo acesso √† conta da v√≠tima para uma assun√ß√£o de conta.

### Divulga√ß√£o de Segredos <a href="#e177" id="e177"></a>

√â muito importante reconhecer **quais dos muitos par√¢metros do OAuth s√£o secretos** e proteg√™-los. Por exemplo, vazar o `client_id` √© perfeitamente normal e necess√°rio, mas vazar o **`client_secret` √© perigoso**. Se isso for vazado, o **invasor** pode potencialmente **abusar da confian√ßa e identidade do aplicativo cliente confi√°vel para roubar `access_tokens` do usu√°rio e informa√ß√µes/acesso privado para suas contas integradas**. Voltando ao nosso exemplo anterior, um problema que vi √© realizar esta etapa do cliente, em vez do servidor:

_5._ [_https://yourtweetreader.com_](https://yourtweetreader.com) _ent√£o pegar√° esse `code` e, usando o `client_id` e o `client_secret` de sua aplica√ß√£o, far√° uma solicita√ß√£o do servidor para recuperar um `access_token` em seu nome, o que permitir√° que eles acessem as permiss√µes que voc√™ consentiu._

**Se isso for feito do cliente, o `client_secret` ser√° vazado e os usu√°rios poder√£o gerar `access_tokens` em nome do aplicativo**. Com alguma engenharia social, eles tamb√©m podem **adicionar mais escopos √† autoriza√ß√£o do OAuth** e tudo parecer√° leg√≠timo, j√° que a solicita√ß√£o vir√° do aplicativo cliente confi√°vel.

### Bruteforce de Segredo do Cliente

Voc√™ pode tentar **for√ßar o segredo do cliente** de um provedor de servi√ßos com o provedor de identidade para tentar roubar contas.\
A solicita√ß√£o para BF pode ser semelhante a:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Vazamento de Cabe√ßalho Referer + C√≥digo de Estado

Depois que o cliente tem o **c√≥digo e o estado**, se ele for **refletido dentro do cabe√ßalho Referer** quando ele navega para uma p√°gina diferente, ent√£o h√° uma vulnerabilidade.

### Token de Acesso Armazenado no Hist√≥rico do Navegador

V√° para o **hist√≥rico do navegador e verifique se o token de acesso est√° salvo l√°**.

### C√≥digo de Autoriza√ß√£o Eterno

O **c√≥digo de autoriza√ß√£o deve viver apenas por algum tempo para limitar a janela de tempo em que um invasor pode roub√°-lo e us√°-lo**.

### Token de Autoriza√ß√£o/Atualiza√ß√£o n√£o vinculado ao cliente

Se voc√™ pode obter o **c√≥digo de autoriza√ß√£o e us√°-lo com um cliente diferente, ent√£o voc√™ pode assumir o controle de outras contas**.

### Caminhos Felizes, XSS, Iframes e Mensagens de Postagem para vazar valores de c√≥digo e estado

### AWS Cognito <a href="#bda5" id="bda5"></a>

Neste relat√≥rio de recompensa por bugs: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) voc√™ pode ver que o **token** que o **AWS Cognito** retorna ao usu√°rio pode ter **permiss√µes suficientes para sobrescrever os dados do usu√°rio**. Portanto, se voc√™ puder **alterar o e-mail do usu√°rio para um e-mail de usu√°rio diferente**, poder√° **assumir o controle** de outras contas.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
    "CodeDeliveryDetailsList": [
        {
            "Destination": "i***@f***.com",
            "DeliveryMedium": "EMAIL",
            "AttributeName": "email"
        }
    ]
}
```
Para obter informa√ß√µes mais detalhadas sobre como abusar do AWS Cognito, consulte:

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Dois links e cookie <a href="#bda5" id="bda5"></a>

De acordo com [**este artigo**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), era poss√≠vel fazer com que a v√≠tima abrisse uma p√°gina com um **returnUrl** apontando para o host do atacante. Essa informa√ß√£o seria **armazenada em um cookie (RU)** e em um **passo posterior**, o **prompt** perguntaria ao **usu√°rio** se ele queria dar acesso a esse host do atacante.

Para contornar esse prompt, era poss√≠vel abrir uma guia para iniciar o **fluxo Oauth** que definiria esse cookie RU usando o **returnUrl**, fechar a guia antes que o prompt fosse exibido e abrir uma nova guia sem esse valor. Ent√£o, o **prompt n√£o informar√° sobre o host do atacante**, mas o cookie ser√° definido para ele, ent√£o o **token ser√° enviado para o host do atacante** na redire√ß√£o.

### Par√¢metros SSRFs <a href="#bda5" id="bda5"></a>

Uma das URLs ocultas que voc√™ pode perder √© o **endpoint de registro de cliente din√¢mico**. Para autenticar com sucesso os usu√°rios, os servidores OAuth precisam saber detalhes sobre o aplicativo cliente, como "client\_name", "client\_secret", "redirect\_uris" e assim por diante. Esses detalhes podem ser fornecidos por meio de configura√ß√£o local, mas os servidores de autoriza√ß√£o OAuth tamb√©m podem ter um **endpoint de registro especial**. Esse endpoint normalmente √© mapeado para "/register" e aceita solicita√ß√µes POST com o seguinte formato:
```json
POST /connect/register HTTP/1.1
Content-Type: application/json
Host: server.example.com
Authorization: Bearer eyJhbGciOiJSUzI1NiJ9.eyJ ...

{
 "application_type": "web",
 "redirect_uris": ["https://client.example.org/callback"],
 "client_name": "My Example",
 "logo_uri": "https://client.example.org/logo.png",
 "subject_type": "pairwise",
 "sector_identifier_uri": "https://example.org/rdrct_uris.json",
 "token_endpoint_auth_method": "client_secret_basic",
 "jwks_uri": "https://client.example.org/public_keys.jwks",
 "contacts": ["ve7jtb@example.org"],
 "request_uris": ["https://client.example.org/rf.txt"]
}
```
Existem duas especifica√ß√µes que definem par√¢metros nesta solicita√ß√£o: [RFC7591](https://tools.ietf.org/html/rfc7591) para OAuth e [Openid Connect Registration 1.0](https://openid.net/specs/openid-connect-registration-1\_0.html#rfc.section.3.1).

Como voc√™ pode ver aqui, v√°rios desses valores s√£o passados por refer√™ncias de URL e parecem ser poss√≠veis alvos para [Server Side Request Forgery](https://portswigger.net/web-security/ssrf). Ao mesmo tempo, a maioria dos servidores que testamos n√£o resolvem essas URLs imediatamente quando recebem uma solicita√ß√£o de registro. Em vez disso, eles apenas **salvam esses par√¢metros e os usam posteriormente durante o fluxo de autoriza√ß√£o do OAuth**. Em outras palavras, isso √© mais como um SSRF de segunda ordem, o que torna a detec√ß√£o de caixa preta mais dif√≠cil.

Os seguintes par√¢metros s√£o particularmente interessantes para ataques SSRF:

* **logo\_uri** - URL que referencia um **logotipo para o aplicativo do cliente**. **Depois de registrar um cliente**, voc√™ pode tentar chamar o ponto de extremidade de autoriza√ß√£o do OAuth ("/authorize") usando seu novo "client\_id". Ap√≥s o login, o servidor solicitar√° que voc√™ aprove a solicita√ß√£o e **pode exibir a imagem do "logo\_uri"**. Se o **servidor buscar a imagem por si mesmo**, o SSRF deve ser acionado por esta etapa. Alternativamente, o servidor pode incluir o logotipo por meio de uma **tag "\<img>" do lado do cliente**. Embora isso n√£o leve a SSRF, pode levar a **XSS se a URL n√£o for escapada**.
*   **jwks\_uri** - URL para o conjunto de chaves JSON do cliente \[JWK\]. Este conjunto de chaves √© necess√°rio no servidor para validar solicita√ß√µes assinadas feitas para o ponto de extremidade de token ao usar JWTs para autentica√ß√£o do cliente \[RFC7523\]. Para testar o SSRF neste par√¢metro, **registre um novo aplicativo cliente com um "jwks\_uri" malicioso**, execute o processo de autoriza√ß√£o para **obter um c√≥digo de autoriza√ß√£o para qualquer usu√°rio e, em seguida, busque o ponto de extremidade "/token"** com o seguinte corpo:

    `POST /oauth/token HTTP/1.1`\
    `...`\
    \`\`\
    `grant_type=authorization_code&code=n0esc3NRze7LTCu7iYzS6a5acc3f0ogp4&client_assertion_type=urn:ietf:params:oauth:client-assertion-type:jwt-bearer&client_assertion=eyJhbGci...`

    Se vulner√°vel, o **servidor deve realizar uma solicita√ß√£o HTTP de servidor para servidor para o "jwks\_uri" fornecido** porque precisa dessa chave para verificar a validade do par√¢metro "client\_assertion" em sua solicita√ß√£o. Isso provavelmente ser√° apenas uma vulnerabilidade de SSRF cega, pois o servidor espera uma resposta JSON adequada.
* **sector\_identifier\_uri** - Esta URL faz refer√™ncia a um arquivo com um √∫nico **array JSON de valores redirect\_uri**. Se suportado, o servidor pode **buscar esse valor assim que voc√™ enviar a solicita√ß√£o de registro din√¢mico**. Se isso n√£o for buscado imediatamente, tente executar a autoriza√ß√£o para este cliente no servidor. Como ele precisa saber os redirect\_uris para concluir o fluxo de autoriza√ß√£o, isso for√ßar√° o servidor a fazer uma solicita√ß√£o para o seu setor\_identifier\_uri malicioso.
*   **request\_uris** - Uma matriz dos **request\_uris permitidos para este cliente**. O par√¢metro "request\_uri" pode ser suportado no ponto de extremidade de autoriza√ß√£o para fornecer uma URL que cont√©m um JWT com as informa√ß√µes da solicita√ß√£o (consulte [https://openid.net/specs/openid-connect-core-1\_0.html#rfc.section.6.2](https://openid.net/specs/openid-connect-core-1\_0.html#rfc.section.6.2)).

    Mesmo que o registro din√¢mico do cliente n√£o esteja habilitado ou exija autentica√ß√£o, podemos tentar o SSRF no ponto de extremidade de autoriza√ß√£o simplesmente usando "request\_uri":\\

    `GET /authorize?response_type=code%20id_token&client_id=sclient1&request_uri=https://ybd1rc7ylpbqzygoahtjh6v0frlh96.burpcollaborator.net/request.jwt`

    Nota: n√£o confunda este par√¢metro com "redirect\_uri". O "redirect\_uri" √© usado para redirecionamento ap√≥s a autoriza√ß√£o, enquanto **"request\_uri" √© buscado pelo servidor no in√≠cio do processo de autoriza√ß√£o**.

    Ao mesmo tempo, muitos servidores que vimos n√£o permitem valores arbitr√°rios de "request\_uri": eles permitem apenas URLs na lista branca que foram pr√©-registradas durante o processo de registro do cliente. √â por isso que precisamos fornecer "request\_uris": "https://ybd1rc7ylpbqzygoahtjh6v0frlh96.burpcollaborator.net/request.jwt" antecipadamente.

## Condi√ß√µes de corrida de provedores OAuth

Se a plataforma que voc√™ est√° testando for um provedor OAuth, [**leia isto para testar poss√≠veis condi√ß√µes de corrida**](race-condition.md).

## Refer√™ncias

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga** me no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
