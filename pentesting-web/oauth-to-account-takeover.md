# OAuth para Assumir o Controle da Conta

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Informa√ß√µes B√°sicas <a href="#d4a8" id="d4a8"></a>

O OAuth oferece v√°rias vers√µes, com informa√ß√µes fundamentais acess√≠veis na [documenta√ß√£o do OAuth 2.0](https://oauth.net/2/). Esta discuss√£o se concentra principalmente no amplamente utilizado [tipo de concess√£o de c√≥digo de autoriza√ß√£o OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/), fornecendo um **framework de autoriza√ß√£o que permite que um aplicativo acesse ou execute a√ß√µes na conta de um usu√°rio em outro aplicativo** (o servidor de autoriza√ß√£o).

Considere um site hipot√©tico _**https://exemplo.com**_, projetado para **mostrar todas as suas postagens em redes sociais**, incluindo as privadas. Para alcan√ßar isso, √© utilizado o OAuth 2.0. _https://exemplo.com_ solicitar√° sua permiss√£o para **acessar suas postagens em redes sociais**. Consequentemente, uma tela de consentimento aparecer√° em _https://redesocial.com_, detalhando as **permiss√µes solicitadas e o desenvolvedor fazendo a solicita√ß√£o**. Ap√≥s sua autoriza√ß√£o, _https://exemplo.com_ ganha a capacidade de **acessar suas postagens em seu nome**.

√â essencial compreender os seguintes componentes dentro do framework do OAuth 2.0:

- **dono do recurso**: Voc√™, como **usu√°rio/entidade**, autoriza o acesso ao seu recurso, como suas postagens em redes sociais.
- **servidor de recursos**: O **servidor que gerencia solicita√ß√µes autenticadas** ap√≥s o aplicativo ter obtido um `token de acesso` em nome do `dono do recurso`, por exemplo, **https://redesocial.com**.
- **aplicativo cliente**: O **aplicativo que busca autoriza√ß√£o** do `dono do recurso`, como **https://exemplo.com**.
- **servidor de autoriza√ß√£o**: O **servidor que emite `tokens de acesso`** para o `aplicativo cliente` ap√≥s a autentica√ß√£o bem-sucedida do `dono do recurso` e a obten√ß√£o de autoriza√ß√£o, por exemplo, **https://redesocial.com**.
- **client\_id**: Um identificador p√∫blico e √∫nico para o aplicativo.
- **client\_secret:** Uma chave confidencial, conhecida apenas pelo aplicativo e pelo servidor de autoriza√ß√£o, usada para gerar `tokens de acesso`.
- **response\_type**: Um valor que especifica **o tipo de token solicitado**, como `c√≥digo`.
- **escopo**: O **n√≠vel de acesso** que o `aplicativo cliente` est√° solicitando do `dono do recurso`.
- **redirect\_uri**: A **URL para a qual o usu√°rio √© redirecionado ap√≥s a autoriza√ß√£o**. Isso geralmente deve estar alinhado com a URL de redirecionamento pr√©-registrada.
- **state**: Um par√¢metro para **manter dados durante o redirecionamento do usu√°rio para e do servidor de autoriza√ß√£o**. Sua singularidade √© fundamental para servir como um **mecanismo de prote√ß√£o CSRF**.
- **grant\_type**: Um par√¢metro que indica **o tipo de concess√£o e o tipo de token a ser retornado**.
- **c√≥digo**: O c√≥digo de autoriza√ß√£o do `servidor de autoriza√ß√£o`, usado em conjunto com `client_id` e `client_secret` pelo aplicativo cliente para adquirir um `token de acesso`.
- **token de acesso**: O **token que o aplicativo cliente usa para solicita√ß√µes de API** em nome do `dono do recurso`.
- **refresh\_token**: Permite que o aplicativo **obtenha um novo `token de acesso` sem solicitar novamente a permiss√£o do usu√°rio**.

### Fluxo

O **fluxo real do OAuth** procede da seguinte forma:

1. Voc√™ navega at√© [https://exemplo.com](https://exemplo.com) e seleciona o bot√£o "Integrar com Redes Sociais".
2. O site ent√£o envia uma solicita√ß√£o para [https://redesocial.com](https://redesocial.com) pedindo sua autoriza√ß√£o para permitir que o aplicativo de https://exemplo.com acesse suas postagens. A solicita√ß√£o √© estruturada da seguinte forma:
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Em seguida, voc√™ √© apresentado a uma p√°gina de consentimento.

4. Ap√≥s a sua aprova√ß√£o, a Rede Social envia uma resposta para o `redirect_uri` com os par√¢metros `code` e `state`:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com utiliza este `c√≥digo`, juntamente com seu `client_id` e `client_secret`, para fazer uma solicita√ß√£o do lado do servidor para obter um `access_token` em seu nome, permitindo o acesso √†s permiss√µes que voc√™ consentiu:
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Finalmente, o processo √© conclu√≠do quando https://example.com utiliza seu `access_token` para fazer uma chamada de API para as Redes Sociais para acessar

## Vulnerabilidades <a href="#323a" id="323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

O `redirect_uri` √© crucial para a seguran√ßa nas implementa√ß√µes de OAuth e OpenID, pois direciona para onde os dados sens√≠veis, como c√≥digos de autoriza√ß√£o, s√£o enviados p√≥s-autoriza√ß√£o. Se mal configurado, poderia permitir que atacantes redirecionassem essas solicita√ß√µes para servidores maliciosos, possibilitando a tomada de controle da conta.

As t√©cnicas de explora√ß√£o variam com base na l√≥gica de valida√ß√£o do servidor de autoriza√ß√£o. Podem variar desde a correspond√™ncia estrita de caminho at√© a aceita√ß√£o de qualquer URL dentro do dom√≠nio ou subdiret√≥rio especificado. M√©todos comuns de explora√ß√£o incluem redirecionamentos abertos, travessia de caminho, explora√ß√£o de regex fracos e inje√ß√£o de HTML para roubo de token.

Al√©m do `redirect_uri`, outros par√¢metros do OAuth e OpenID como `client_uri`, `policy_uri`, `tos_uri` e `initiate_login_uri` tamb√©m s√£o suscet√≠veis a ataques de redirecionamento. Esses par√¢metros s√£o opcionais e seu suporte varia entre os servidores.

Para aqueles visando um servidor OpenID, o ponto de descoberta (`**.well-known/openid-configuration**`) frequentemente lista detalhes valiosos de configura√ß√£o como `registration_endpoint`, `request_uri_parameter_supported` e "`require_request_uri_registration`. Esses detalhes podem auxiliar na identifica√ß√£o do ponto de registro e outras especificidades de configura√ß√£o do servidor.

### XSS na implementa√ß√£o de redirecionamento <a href="#bda5" id="bda5"></a>

Conforme mencionado neste relat√≥rio de recompensa por bugs [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), pode ser poss√≠vel que a **URL de redirecionamento esteja sendo refletida na resposta** do servidor ap√≥s o usu√°rio se autenticar, sendo **vulner√°vel a XSS**. Payload poss√≠vel para teste:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Manipula√ß√£o inadequada do par√¢metro de estado <a href="#bda5" id="bda5"></a>

Nas implementa√ß√µes do OAuth, o uso indevido ou omiss√£o do **par√¢metro `state`** pode aumentar significativamente o risco de ataques de **Cross-Site Request Forgery (CSRF)**. Essa vulnerabilidade surge quando o par√¢metro `state` √© **n√£o utilizado, usado como um valor est√°tico ou n√£o validado corretamente**, permitindo que os atacantes ignorem as prote√ß√µes contra CSRF.

Os atacantes podem explorar isso interceptando o processo de autoriza√ß√£o para vincular sua conta √† conta de uma v√≠tima, levando a poss√≠veis **tomadas de controle de conta**. Isso √© especialmente cr√≠tico em aplica√ß√µes onde o OAuth √© usado para **fins de autentica√ß√£o**.

Exemplos do mundo real dessa vulnerabilidade foram documentados em v√°rios desafios de **CTF** e **plataformas de hacking**, destacando suas implica√ß√µes pr√°ticas. O problema tamb√©m se estende a integra√ß√µes com servi√ßos de terceiros como **Slack**, **Stripe** e **PayPal**, onde os atacantes podem redirecionar notifica√ß√µes ou pagamentos para suas contas.

O tratamento adequado e a valida√ß√£o do **par√¢metro `state`** s√£o cruciais para proteger contra CSRF e garantir a seguran√ßa do fluxo do OAuth.

### Pr√© Tomada de Conta <a href="#ebe4" id="ebe4"></a>

1. **Sem Verifica√ß√£o de Email na Cria√ß√£o de Conta**: Os atacantes podem criar antecipadamente uma conta usando o email da v√≠tima. Se a v√≠tima posteriormente usar um servi√ßo de terceiros para fazer login, a aplica√ß√£o pode inadvertidamente vincular essa conta de terceiros √† conta pr√©-criada do atacante, resultando em acesso n√£o autorizado.

2. **Explorando a Verifica√ß√£o de Email Laxa do OAuth**: Os atacantes podem explorar servi√ßos OAuth que n√£o verificam emails ao se registrar no servi√ßo e, em seguida, alterar o email da conta para o da v√≠tima. Esse m√©todo tamb√©m apresenta riscos de acesso n√£o autorizado √† conta, semelhante ao primeiro cen√°rio, mas por meio de um vetor de ataque diferente.

### Divulga√ß√£o de Segredos <a href="#e177" id="e177"></a>

Identificar e proteger par√¢metros secretos do OAuth √© crucial. Enquanto o **`client_id`** pode ser divulgado com seguran√ßa, revelar o **`client_secret`** representa riscos significativos. Se o `client_secret` for comprometido, os atacantes podem explorar a identidade e a confian√ßa da aplica√ß√£o para **roubar `access_tokens`** e informa√ß√µes privadas.

Uma vulnerabilidade comum surge quando as aplica√ß√µes lidam erroneamente com a troca do `code` de autoriza√ß√£o por um `access_token` no lado do cliente em vez do lado do servidor. Esse erro resulta na exposi√ß√£o do `client_secret`, permitindo que os atacantes gerem `access_tokens` sob a apar√™ncia da aplica√ß√£o. Al√©m disso, por meio de engenharia social, os atacantes podem escalar privil√©gios adicionando escopos adicionais √† autoriza√ß√£o do OAuth, explorando ainda mais o status confi√°vel da aplica√ß√£o.

### Bruteforce do Client Secret

Voc√™ pode tentar **fazer bruteforce no client\_secret** de um provedor de servi√ßos com o provedor de identidade para tentar roubar contas.\
A solicita√ß√£o para o BF pode se parecer com:
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Cabe√ßalho Referer vazando C√≥digo + Estado

Uma vez que o cliente tenha o **c√≥digo e estado**, se estiver **refletido dentro do cabe√ßalho Referer** ao navegar para uma p√°gina diferente, ent√£o est√° vulner√°vel.

### Token de Acesso Armazenado no Hist√≥rico do Navegador

V√° para o **hist√≥rico do navegador e verifique se o token de acesso est√° salvo l√°**.

### C√≥digo de Autoriza√ß√£o Eterno

O **c√≥digo de autoriza√ß√£o deve existir apenas por algum tempo para limitar a janela de tempo em que um atacante pode roub√°-lo e us√°-lo**.

### Token de Autoriza√ß√£o/Atualiza√ß√£o n√£o vinculado ao cliente

Se voc√™ conseguir obter o **c√≥digo de autoriza√ß√£o e us√°-lo com um cliente diferente, ent√£o pode assumir o controle de outras contas**.

### Caminhos Felizes, XSS, Iframes e Mensagens Post para vazar c√≥digos e valores de estado

**[Confira este post](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)**

### AWS Cognito <a href="#bda5" id="bda5"></a>

Neste relat√≥rio de recompensa por bugs: [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) voc√™ pode ver que o **token** que o **AWS Cognito** devolve ao usu√°rio pode ter **permiss√µes suficientes para sobrescrever os dados do usu√°rio**. Portanto, se voc√™ puder **alterar o e-mail do usu√°rio por um e-mail de usu√°rio diferente**, voc√™ pode **assumir** outras contas.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
### Abusando de tokens de outros aplicativos <a href="#bda5" id="bda5"></a>

Como [**mencionado neste artigo**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), os fluxos do OAuth que esperam receber o **token** (e n√£o um c√≥digo) podem ser vulner√°veis se n√£o verificarem se o token pertence ao aplicativo.

Isso ocorre porque um **atacante** poderia criar um **aplicativo que suporta OAuth e fazer login com o Facebook** (por exemplo) em seu pr√≥prio aplicativo. Ent√£o, uma vez que uma v√≠tima faz login com o Facebook no **aplicativo do atacante**, o atacante poderia obter o **token OAuth do usu√°rio fornecido ao seu aplicativo e us√°-lo para fazer login no aplicativo OAuth da v√≠tima usando o token de usu√°rio da v√≠tima**.

{% hint style="danger" %}
Portanto, se o atacante conseguir fazer com que o usu√°rio acesse seu pr√≥prio aplicativo OAuth, ele poder√° assumir o controle da conta da v√≠tima em aplicativos que esperam um token e n√£o verificam se o token foi concedido para o ID de seu aplicativo.
{% endhint %}

### Dois links e cookie <a href="#bda5" id="bda5"></a>

De acordo com [**este artigo**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), era poss√≠vel fazer com que uma v√≠tima abrisse uma p√°gina com um **returnUrl** apontando para o host do atacante. Essas informa√ß√µes seriam **armazenadas em um cookie (RU)** e em uma **etapa posterior**, o **prompt** perguntaria ao **usu√°rio** se ele deseja conceder acesso a esse host do atacante.

Para contornar esse prompt, era poss√≠vel abrir uma guia para iniciar o **fluxo OAuth** que definiria esse cookie RU usando o **returnUrl**, fechar a guia antes que o prompt fosse exibido e abrir uma nova guia sem esse valor. Assim, o **prompt n√£o informar√° sobre o host do atacante**, mas o cookie ser√° definido para ele, ent√£o o **token ser√° enviado para o host do atacante** na redire√ß√£o.

### Par√¢metros SSRFs <a href="#bda5" id="bda5"></a>

**[Confira esta pesquisa](https://portswigger.net/research/hidden-oauth-attack-vectors) para mais detalhes sobre essa t√©cnica.**

O Registro Din√¢mico de Clientes no OAuth serve como um vetor menos √≥bvio, mas cr√≠tico para vulnerabilidades de seguran√ßa, especificamente para ataques de **Server-Side Request Forgery (SSRF)**. Este endpoint permite que servidores OAuth recebam detalhes sobre aplicativos clientes, incluindo URLs sens√≠veis que podem ser explorados.

**Pontos-chave:**

- O **Registro Din√¢mico de Clientes** geralmente √© mapeado para `/register` e aceita detalhes como `client_name`, `client_secret`, `redirect_uris` e URLs para logotipos ou Conjuntos de Chaves Web JSON (JWKs) via solicita√ß√µes POST.
- Este recurso segue as especifica√ß√µes estabelecidas no **RFC7591** e **OpenID Connect Registration 1.0**, que incluem par√¢metros potencialmente vulner√°veis ao SSRF.
- O processo de registro pode inadvertidamente expor servidores ao SSRF de v√°rias maneiras:
- **`logo_uri`**: Um URL para o logotipo do aplicativo cliente que pode ser buscado pelo servidor, desencadeando SSRF ou levando a XSS se o URL for manipulado de forma inadequada.
- **`jwks_uri`**: Um URL para o documento JWK do cliente, que se for maliciosamente elaborado, pode fazer com que o servidor fa√ßa solicita√ß√µes de sa√≠da para um servidor controlado pelo atacante.
- **`sector_identifier_uri`**: Faz refer√™ncia a um array JSON de `redirect_uris`, que o servidor pode buscar, criando uma oportunidade de SSRF.
- **`request_uris`**: Lista URIs de solicita√ß√£o permitidos para o cliente, que podem ser explorados se o servidor buscar esses URIs no in√≠cio do processo de autoriza√ß√£o.

**Estrat√©gia de Explora√ß√£o:**

- O SSRF pode ser acionado registrando um novo cliente com URLs maliciosos em par√¢metros como `logo_uri`, `jwks_uri` ou `sector_identifier_uri`.
- Embora a explora√ß√£o direta via `request_uris` possa ser mitigada por controles de lista branca, fornecer um `request_uri` controlado pelo atacante pr√©-registrado pode facilitar o SSRF durante a fase de autoriza√ß√£o.

## Condi√ß√µes de corrida de provedores OAuth

Se a plataforma que voc√™ est√° testando for um provedor OAuth, [**leia isso para testar poss√≠veis Condi√ß√µes de Corrida**](race-condition.md).

## Refer√™ncias

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
