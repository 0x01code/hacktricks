# OAuth vers la prise de contr√¥le de compte

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Expert en √©quipe rouge AWS de HackTricks)</strong></a><strong>!</strong></summary>

Autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) d√©p√¥ts GitHub.

</details>

## Informations de base <a href="#d4a8" id="d4a8"></a>

OAuth propose diff√©rentes versions, avec des informations fondamentales accessibles sur la [documentation OAuth 2.0](https://oauth.net/2/). Cette discussion se concentre principalement sur le largement utilis√© [type de subvention de code d'autorisation OAuth 2.0](https://oauth.net/2/grant-types/authorization-code/), fournissant un **cadre d'autorisation permettant √† une application d'acc√©der ou d'effectuer des actions sur le compte d'un utilisateur dans une autre application** (le serveur d'autorisation).

Consid√©rons un site web hypoth√©tique _**https://example.com**_, con√ßu pour **pr√©senter tous vos messages sur les r√©seaux sociaux**, y compris les priv√©s. Pour ce faire, OAuth 2.0 est utilis√©. _https://example.com_ demandera votre autorisation pour **acc√©der √† vos messages sur les r√©seaux sociaux**. Par cons√©quent, un √©cran de consentement appara√Ætra sur _https://socialmedia.com_, d√©taillant les **autorisations demand√©es et le d√©veloppeur faisant la demande**. Apr√®s votre autorisation, _https://example.com_ acquiert la capacit√© d'**acc√©der √† vos messages en votre nom**.

Il est essentiel de comprendre les composants suivants dans le cadre OAuth 2.0 :

- **propri√©taire de la ressource** : Vous, en tant qu'**utilisateur/entit√©**, autorisez l'acc√®s √† votre ressource, comme vos messages de compte sur les r√©seaux sociaux.
- **serveur de ressources** : Le **serveur g√©rant les demandes authentifi√©es** apr√®s que l'application a obtenu un `jeton d'acc√®s` au nom du `propri√©taire de la ressource`, par exemple, **https://socialmedia.com**.
- **application cliente** : L'**application demandant l'autorisation** du `propri√©taire de la ressource`, comme **https://example.com**.
- **serveur d'autorisation** : Le **serveur qui d√©livre des `jetons d'acc√®s`** √† l'`application cliente` apr√®s l'authentification r√©ussie du `propri√©taire de la ressource` et la s√©curisation de l'autorisation, par exemple, **https://socialmedia.com**.
- **client_id** : Un identifiant public et unique pour l'application.
- **client_secret** : Une cl√© confidentielle, connue uniquement de l'application et du serveur d'autorisation, utilis√©e pour g√©n√©rer des `jetons d'acc√®s`.
- **response_type** : Une valeur sp√©cifiant **le type de jeton demand√©**, comme `code`.
- **scope** : Le **niveau d'acc√®s** demand√© par l'`application cliente` au `propri√©taire de la ressource`.
- **redirect_uri** : L'**URL vers laquelle l'utilisateur est redirig√© apr√®s autorisation**. Cela doit g√©n√©ralement correspondre √† l'URL de redirection pr√©alablement enregistr√©e.
- **state** : Un param√®tre pour **maintenir des donn√©es lors de la redirection de l'utilisateur vers et depuis le serveur d'autorisation**. Sa singularit√© est cruciale pour servir de **m√©canisme de protection CSRF**.
- **grant_type** : Un param√®tre indiquant **le type de subvention et le type de jeton √† renvoyer**.
- **code** : Le code d'autorisation du `serveur d'autorisation`, utilis√© conjointement avec `client_id` et `client_secret` par l'application cliente pour acqu√©rir un `jeton d'acc√®s`.
- **access_token** : Le **jeton que l'application cliente utilise pour les requ√™tes API** au nom du `propri√©taire de la ressource`.
- **refresh_token** : Permet √† l'application d'**obtenir un nouveau `jeton d'acc√®s` sans redemander √† l'utilisateur**.

### Flux

Le **flux OAuth r√©el** se d√©roule comme suit :

1. Vous acc√©dez √† [https://example.com](https://example.com) et s√©lectionnez le bouton "Int√©grer avec les r√©seaux sociaux".
2. Le site envoie ensuite une demande √† [https://socialmedia.com](https://socialmedia.com) vous demandant l'autorisation de permettre √† l'application de https://example.com d'acc√©der √† vos messages. La demande est structur√©e comme suit :
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Ensuite, vous √™tes pr√©sent√© avec une page de consentement.

4. Apr√®s votre approbation, les m√©dias sociaux envoient une r√©ponse √† l'`redirect_uri` avec les param√®tres `code` et `state`:
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com utilise ce `code`, ainsi que son `client_id` et `client_secret`, pour effectuer une requ√™te c√¥t√© serveur afin d'obtenir un `access_token` en votre nom, permettant l'acc√®s aux autorisations auxquelles vous avez consenti :
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Enfin, le processus se termine lorsque https://example.com utilise votre `access_token` pour effectuer un appel API vers les m√©dias sociaux afin d'acc√©der

## Vuln√©rabilit√©s <a href="#323a" id="323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

Le `redirect_uri` est crucial pour la s√©curit√© dans les impl√©mentations OAuth et OpenID, car il indique o√π les donn√©es sensibles, comme les codes d'autorisation, sont envoy√©es apr√®s l'autorisation. S'il est mal configur√©, il pourrait permettre aux attaquants de rediriger ces requ√™tes vers des serveurs malveillants, facilitant la prise de contr√¥le de compte.

Les techniques d'exploitation varient en fonction de la logique de validation du serveur d'autorisation. Elles peuvent aller de la correspondance stricte des chemins √† l'acceptation de n'importe quelle URL dans le domaine ou le sous-r√©pertoire sp√©cifi√©. Les m√©thodes d'exploitation courantes incluent les redirections ouvertes, la travers√©e de chemin, l'exploitation de regex faibles et l'injection HTML pour le vol de jetons.

Outre `redirect_uri`, d'autres param√®tres OAuth et OpenID comme `client_uri`, `policy_uri`, `tos_uri` et `initiate_login_uri` sont √©galement susceptibles d'√™tre attaqu√©s par redirection. Ces param√®tres sont facultatifs et leur prise en charge varie selon les serveurs.

Pour ceux ciblant un serveur OpenID, le point de d√©couverte (`**.well-known/openid-configuration**`) liste souvent des d√©tails de configuration pr√©cieux comme `registration_endpoint`, `request_uri_parameter_supported` et "`require_request_uri_registration`. Ces d√©tails peuvent aider √† identifier le point de registre et d'autres sp√©cificit√©s de configuration du serveur.

### XSS dans l'impl√©mentation de redirection <a href="#bda5" id="bda5"></a>

Comme mentionn√© dans ce rapport de prime au bogue [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html), il est possible que l'**URL de redirection soit refl√©t√©e dans la r√©ponse** du serveur apr√®s l'authentification de l'utilisateur, √©tant **vuln√©rable aux XSS**. Charge utile possible √† tester:
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Gestion incorrecte du param√®tre d'√©tat <a href="#bda5" id="bda5"></a>

Dans les impl√©mentations OAuth, l'utilisation incorrecte ou l'omission du **param√®tre `state`** peut augmenter consid√©rablement le risque d'attaques de **falsification de requ√™te intersite (CSRF)**. Cette vuln√©rabilit√© survient lorsque le param√®tre `state` n'est **pas utilis√©, utilis√© comme une valeur statique, ou non correctement valid√©**, permettant aux attaquants de contourner les protections CSRF.

Les attaquants peuvent exploiter cela en interceptant le processus d'autorisation pour lier leur compte √† celui d'une victime, entra√Ænant des **prises de contr√¥le de compte potentielles**. Cela est particuli√®rement critique dans les applications o√π OAuth est utilis√© √† des fins d'**authentification**.

Des exemples concrets de cette vuln√©rabilit√© ont √©t√© document√©s dans divers **d√©fis CTF** et **plateformes de piratage**, mettant en √©vidence ses implications pratiques. Le probl√®me s'√©tend √©galement aux int√©grations avec des services tiers tels que **Slack**, **Stripe** et **PayPal**, o√π les attaquants peuvent rediriger des notifications ou des paiements vers leurs comptes.

La gestion et la validation appropri√©es du **param√®tre `state`** sont cruciales pour se prot√©ger contre les CSRF et s√©curiser le flux OAuth.

### Pr√©prise de contr√¥le de compte <a href="#ebe4" id="ebe4"></a>

1. **Sans v√©rification d'email lors de la cr√©ation de compte** : Les attaquants peuvent cr√©er pr√©ventivement un compte en utilisant l'email de la victime. Si la victime utilise ult√©rieurement un service tiers pour se connecter, l'application pourrait involontairement lier ce compte tiers au compte pr√©-cr√©√© de l'attaquant, entra√Ænant un acc√®s non autoris√©.

2. **Exploitation de la v√©rification d'email laxiste d'OAuth** : Les attaquants peuvent exploiter les services OAuth qui ne v√©rifient pas les emails en s'inscrivant avec leur service, puis en changeant l'email du compte pour celui de la victime. Cette m√©thode comporte √©galement des risques d'acc√®s non autoris√© au compte, similaire au premier sc√©nario mais √† travers un vecteur d'attaque diff√©rent.

### Divulgation de secrets <a href="#e177" id="e177"></a>

Identifier et prot√©ger les param√®tres secrets OAuth est crucial. Alors que le **`client_id`** peut √™tre divulgu√© en toute s√©curit√©, r√©v√©ler le **`client_secret`** pose des risques importants. Si le `client_secret` est compromis, les attaquants peuvent exploiter l'identit√© et la confiance de l'application pour **voler les `access_tokens`** des utilisateurs et des informations priv√©es.

Une vuln√©rabilit√© courante survient lorsque les applications g√®rent incorrectement l'√©change du `code` d'autorisation pour un `access_token` c√¥t√© client plut√¥t que c√¥t√© serveur. Cette erreur conduit √† l'exposition du `client_secret`, permettant aux attaquants de g√©n√©rer des `access_tokens` sous l'apparence de l'application. De plus, via l'ing√©nierie sociale, les attaquants pourraient augmenter les privil√®ges en ajoutant des √©tendues suppl√©mentaires √† l'autorisation OAuth, exploitant davantage le statut de confiance de l'application.

### Bruteforce du secret client

Vous pouvez essayer de **bruteforcer le client\_secret** d'un fournisseur de services avec le fournisseur d'identit√© afin de tenter de voler des comptes.\
La requ√™te de BF peut ressembler √† :
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### En-t√™te Referer divulguant Code + State

Une fois que le client a le **code et l'√©tat**, s'il est **refl√©t√© dans l'en-t√™te Referer** lorsqu'il navigue vers une autre page, alors il est vuln√©rable.

### Jeton d'acc√®s stock√© dans l'historique du navigateur

Allez dans **l'historique du navigateur et v√©rifiez si le jeton d'acc√®s est enregistr√© l√†-dedans**.

### Code d'autorisation √©ternel

Le **code d'autorisation ne devrait vivre que pendant un certain temps pour limiter la fen√™tre temporelle o√π un attaquant peut le voler et l'utiliser**.

### Jeton d'autorisation/rafra√Æchissement non li√© au client

Si vous pouvez obtenir le **code d'autorisation et l'utiliser avec un client diff√©rent, alors vous pouvez prendre le contr√¥le d'autres comptes**.

### Chemins heureux, XSS, Iframes & Post Messages pour divulguer les valeurs du code & de l'√©tat

**[Consultez ce post](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)**

### AWS Cognito <a href="#bda5" id="bda5"></a>

Dans ce rapport de prime de bug : [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/), vous pouvez voir que le **jeton** que **AWS Cognito** renvoie √† l'utilisateur pourrait avoir **suffisamment de permissions pour √©craser les donn√©es utilisateur**. Par cons√©quent, si vous pouvez **changer l'e-mail de l'utilisateur pour un e-mail d'utilisateur diff√©rent**, vous pourriez √™tre en mesure de **prendre le contr√¥le** d'autres comptes.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Pour plus d'informations d√©taill√©es sur la mani√®re d'abuser d'AWS Cognito, consultez :

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abuser des jetons d'autres applications <a href="#bda5" id="bda5"></a>

Comme [**mentionn√© dans cet article**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), les flux OAuth qui s'attendent √† recevoir le **jeton** (et non un code) pourraient √™tre vuln√©rables s'ils ne v√©rifient pas que le jeton appartient √† l'application.

Cela est d√ª au fait qu'un **attaquant** pourrait cr√©er une **application prenant en charge OAuth et se connecter avec Facebook** (par exemple) dans sa propre application. Ensuite, une fois qu'une victime se connecte avec Facebook dans l'**application de l'attaquant**, l'attaquant pourrait obtenir le **jeton OAuth de l'utilisateur donn√© √† son application, et l'utiliser pour se connecter √† l'application OAuth de la victime en utilisant le jeton de l'utilisateur de la victime**.

{% hint style="danger" %}
Par cons√©quent, si l'attaquant parvient √† obtenir l'acc√®s de l'utilisateur √† sa propre application OAuth, il pourra prendre le contr√¥le du compte de la victime dans les applications qui attendent un jeton et ne v√©rifient pas si le jeton a √©t√© accord√© √† leur ID d'application.
{% endhint %}

### Deux liens et cookie <a href="#bda5" id="bda5"></a>

Selon [**cet article**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), il √©tait possible de faire en sorte qu'une victime ouvre une page avec un **returnUrl** pointant vers l'h√¥te de l'attaquant. Ces informations seraient **stock√©es dans un cookie (RU)** et √† **une √©tape ult√©rieure**, le **prompt** demandera √† l'utilisateur s'il souhaite donner acc√®s √† cet h√¥te d'attaquant.

Pour contourner ce prompt, il √©tait possible d'ouvrir un onglet pour initier le **flux OAuth** qui d√©finirait ce cookie RU en utilisant le **returnUrl**, de fermer l'onglet avant l'affichage du prompt, et d'ouvrir un nouvel onglet sans cette valeur. Ensuite, le **prompt ne mentionnera pas l'h√¥te de l'attaquant**, mais le cookie sera d√©fini sur celui-ci, de sorte que le **jeton sera envoy√© √† l'h√¥te de l'attaquant** dans la redirection.

### Param√®tres SSRF <a href="#bda5" id="bda5"></a>

**[Consultez cette recherche](https://portswigger.net/research/hidden-oauth-attack-vectors) pour plus de d√©tails sur cette technique.**

L'enregistrement dynamique du client dans OAuth sert de vecteur moins √©vident mais critique pour les vuln√©rabilit√©s de s√©curit√©, en particulier pour les attaques de **falsification de requ√™te c√¥t√© serveur (SSRF)**. Ce point de terminaison permet aux serveurs OAuth de recevoir des d√©tails sur les applications clientes, y compris des URL sensibles qui pourraient √™tre exploit√©es.

**Points cl√©s :**

- L'enregistrement dynamique du client est souvent associ√© √† `/register` et accepte des d√©tails tels que `client_name`, `client_secret`, `redirect_uris`, et des URLs pour des logos ou des ensembles de cl√©s JSON Web (JWKs) via des requ√™tes POST.
- Cette fonctionnalit√© respecte les sp√©cifications √©nonc√©es dans **RFC7591** et **OpenID Connect Registration 1.0**, qui incluent des param√®tres potentiellement vuln√©rables aux SSRF.
- Le processus d'enregistrement peut exposer involontairement les serveurs aux SSRF de plusieurs mani√®res :
- **`logo_uri`** : Une URL pour le logo de l'application cliente qui pourrait √™tre r√©cup√©r√© par le serveur, d√©clenchant un SSRF ou conduisant √† une XSS si l'URL est mal g√©r√©e.
- **`jwks_uri`** : Une URL vers le document JWK du client, qui s'il est malveillamment con√ßu, peut amener le serveur √† effectuer des requ√™tes sortantes vers un serveur contr√¥l√© par l'attaquant.
- **`sector_identifier_uri`** : Fait r√©f√©rence √† un tableau JSON de `redirect_uris`, que le serveur pourrait r√©cup√©rer, cr√©ant une opportunit√© de SSRF.
- **`request_uris`** : Liste les URI de requ√™te autoris√©s pour le client, qui peuvent √™tre exploit√©s si le serveur r√©cup√®re ces URIs au d√©but du processus d'autorisation.

**Strat√©gie d'exploitation :**

- Le SSRF peut √™tre d√©clench√© en enregistrant un nouveau client avec des URLs malveillantes dans des param√®tres tels que `logo_uri`, `jwks_uri`, ou `sector_identifier_uri`.
- Bien que l'exploitation directe via `request_uris` puisse √™tre att√©nu√©e par des contr√¥les de liste blanche, fournir un `request_uri` pr√©enregistr√© et contr√¥l√© par l'attaquant peut faciliter le SSRF pendant la phase d'autorisation.

## Conditions de course des fournisseurs OAuth

Si la plateforme que vous testez est un fournisseur OAuth, [**lisez ceci pour tester d'√©ventuelles conditions de course**](race-condition.md).

## R√©f√©rences

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

D'autres fa√ßons de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez** nous sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
