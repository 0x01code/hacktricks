# OAuth to Account takeover

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e sur HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez les [**produits d√©riv√©s officiels PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

## Informations de base <a href="#d4a8" id="d4a8"></a>

OAuth propose diff√©rentes versions, avec des informations de base accessibles sur [OAuth 2.0 documentation](https://oauth.net/2/). Cette discussion se concentre principalement sur le tr√®s utilis√© [OAuth 2.0 authorization code grant type](https://oauth.net/2/grant-types/authorization-code/), fournissant un **cadre d'autorisation qui permet √† une application d'acc√©der ou d'effectuer des actions sur le compte d'un utilisateur dans une autre application** (le serveur d'autorisation).

Consid√©rons un site web hypoth√©tique _**https://example.com**_, con√ßu pour **pr√©senter tous vos posts sur les r√©seaux sociaux**, y compris ceux priv√©s. Pour ce faire, OAuth 2.0 est utilis√©. _https://example.com_ demandera votre permission pour **acc√©der √† vos posts sur les r√©seaux sociaux**. Par cons√©quent, un √©cran de consentement appara√Ætra sur _https://socialmedia.com_, d√©crivant les **autorisations demand√©es et le d√©veloppeur faisant la demande**. Apr√®s votre autorisation, _https://example.com_ obtient la capacit√© de **consulter vos posts en votre nom**.

Il est essentiel de comprendre les composants suivants dans le cadre OAuth 2.0 :

* **resource owner** : Vous, en tant qu'**utilisateur/entit√©**, autorisez l'acc√®s √† votre ressource, comme les posts de votre compte de r√©seau social.
* **resource server** : Le **serveur g√©rant les requ√™tes authentifi√©es** apr√®s que l'application a s√©curis√© un `access token` au nom du `resource owner`, par exemple, **https://socialmedia.com**.
* **client application** : L'**application cherchant l'autorisation** du `resource owner`, telle que **https://example.com**.
* **authorization server** : Le **serveur qui √©met des `access tokens`** √† l'`application cliente` apr√®s l'authentification r√©ussie du `resource owner` et l'obtention de l'autorisation, par exemple, **https://socialmedia.com**.
* **client\_id** : Un identifiant public et unique pour l'application.
* **client\_secret** : Une cl√© confidentielle, connue uniquement de l'application et du serveur d'autorisation, utilis√©e pour g√©n√©rer des `access_tokens`.
* **response\_type** : Une valeur sp√©cifiant **le type de jeton demand√©**, comme `code`.
* **scope** : Le **niveau d'acc√®s** que l'`application cliente` demande au `resource owner`.
* **redirect\_uri** : L'**URL vers laquelle l'utilisateur est redirig√© apr√®s l'autorisation**. Cela doit g√©n√©ralement correspondre √† l'URL de redirection pr√©enregistr√©e.
* **state** : Un param√®tre pour **maintenir les donn√©es lors de la redirection de l'utilisateur vers et depuis le serveur d'autorisation**. Son unicit√© est cruciale pour servir de **m√©canisme de protection CSRF**.
* **grant\_type** : Un param√®tre indiquant **le type de subvention et le type de jeton √† retourner**.
* **code** : Le code d'autorisation du `authorization server`, utilis√© en tandem avec `client_id` et `client_secret` par l'application cliente pour acqu√©rir un `access_token`.
* **access\_token** : Le **jeton que l'application cliente utilise pour les requ√™tes API** au nom du `resource owner`.
* **refresh\_token** : Permet √† l'application de **obtenir un nouveau `access_token` sans redemander √† l'utilisateur**.

### Flux

Le **flux OAuth r√©el** se d√©roule comme suit :

1. Vous naviguez vers [https://example.com](https://example.com) et s√©lectionnez le bouton ‚ÄúInt√©grer avec les r√©seaux sociaux‚Äù.
2. Le site envoie alors une demande √† [https://socialmedia.com](https://socialmedia.com) demandant votre autorisation pour permettre √† l'application de https://example.com d'acc√©der √† vos posts. La demande est structur√©e comme suit :
```
https://socialmedia.com/auth
?response_type=code
&client_id=example_clientId
&redirect_uri=https%3A%2F%2Fexample.com%2Fcallback
&scope=readPosts
&state=randomString123
```
3. Vous √™tes ensuite pr√©sent√© avec une page de consentement.
4. Apr√®s votre approbation, Social Media envoie une r√©ponse √† l'`redirect_uri` avec les param√®tres `code` et `state` :
```
https://example.com?code=uniqueCode123&state=randomString123
```
5. https://example.com utilise ce `code`, ainsi que son `client_id` et `client_secret`, pour faire une requ√™te c√¥t√© serveur afin d'obtenir un `access_token` en votre nom, permettant l'acc√®s aux permissions auxquelles vous avez consenti :
```
POST /oauth/access_token
Host: socialmedia.com
...{"client_id": "example_clientId", "client_secret": "example_clientSecret", "code": "uniqueCode123", "grant_type": "authorization_code"}
```
6. Enfin, le processus se termine lorsque https://example.com utilise votre `access_token` pour effectuer un appel API √† Social Media pour acc√©der

## Vuln√©rabilit√©s <a href="#id-323a" id="id-323a"></a>

### Open redirect\_uri <a href="#cc36" id="cc36"></a>

Le `redirect_uri` est crucial pour la s√©curit√© dans les impl√©mentations OAuth et OpenID, car il dirige o√π les donn√©es sensibles, comme les codes d'autorisation, sont envoy√©es apr√®s l'autorisation. S'il est mal configur√©, il pourrait permettre aux attaquants de rediriger ces requ√™tes vers des serveurs malveillants, permettant ainsi la prise de contr√¥le de compte.

Les techniques d'exploitation varient en fonction de la logique de validation du serveur d'autorisation. Elles peuvent aller de la correspondance stricte des chemins √† l'acceptation de toute URL dans le domaine ou le sous-r√©pertoire sp√©cifi√©. Les m√©thodes d'exploitation courantes incluent les redirections ouvertes, la travers√©e de chemin, l'exploitation de regex faibles et l'injection HTML pour le vol de jetons.

En plus de `redirect_uri`, d'autres param√®tres OAuth et OpenID comme `client_uri`, `policy_uri`, `tos_uri`, et `initiate_login_uri` sont √©galement susceptibles aux attaques de redirection. Ces param√®tres sont optionnels et leur support varie selon les serveurs.

Pour ceux ciblant un serveur OpenID, le point de d√©couverte (`**.well-known/openid-configuration**`) liste souvent des d√©tails de configuration pr√©cieux comme `registration_endpoint`, `request_uri_parameter_supported`, et "`require_request_uri_registration`. Ces d√©tails peuvent aider √† identifier le point d'enregistrement et d'autres sp√©cificit√©s de configuration du serveur.

### XSS dans l'impl√©mentation de redirection <a href="#bda5" id="bda5"></a>

Comme mentionn√© dans ce rapport de bug bounty [https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html](https://blog.dixitaditya.com/2021/11/19/account-takeover-chain.html) il est possible que l'URL de redirection **soit refl√©t√©e dans la r√©ponse** du serveur apr√®s l'authentification de l'utilisateur, √©tant **vuln√©rable √† XSS**. Payload possible √† tester :
```
https://app.victim.com/login?redirectUrl=https://app.victim.com/dashboard</script><h1>test</h1>
```
### CSRF - Mauvaise gestion du param√®tre state <a href="#bda5" id="bda5"></a>

Dans les impl√©mentations OAuth, la mauvaise utilisation ou l'omission du **param√®tre `state`** peut augmenter consid√©rablement le risque d'attaques par **Cross-Site Request Forgery (CSRF)**. Cette vuln√©rabilit√© survient lorsque le param√®tre `state` est soit **non utilis√©, utilis√© comme une valeur statique, ou non correctement valid√©**, permettant aux attaquants de contourner les protections CSRF.

Les attaquants peuvent exploiter cela en interceptant le processus d'autorisation pour lier leur compte √† celui de la victime, conduisant √† des **prises de contr√¥le de compte** potentielles. Cela est particuli√®rement critique dans les applications o√π OAuth est utilis√© √† des **fins d'authentification**.

Des exemples concrets de cette vuln√©rabilit√© ont √©t√© document√©s dans divers **d√©fis CTF** et **plateformes de hacking**, soulignant ses implications pratiques. Le probl√®me s'√©tend √©galement aux int√©grations avec des services tiers comme **Slack**, **Stripe**, et **PayPal**, o√π les attaquants peuvent rediriger des notifications ou des paiements vers leurs comptes.

Une gestion et une validation appropri√©es du **param√®tre `state`** sont cruciales pour se prot√©ger contre les CSRF et s√©curiser le flux OAuth.

### Prise de contr√¥le de compte pr√©alable <a href="#ebe4" id="ebe4"></a>

1. **Sans v√©rification de l'email lors de la cr√©ation de compte** : Les attaquants peuvent cr√©er un compte de mani√®re pr√©ventive en utilisant l'email de la victime. Si la victime utilise plus tard un service tiers pour se connecter, l'application pourrait par inadvertance lier ce compte tiers au compte pr√©-cr√©√© par l'attaquant, conduisant √† un acc√®s non autoris√©.
2. **Exploitation d'une v√©rification d'email OAuth laxiste** : Les attaquants peuvent exploiter des services OAuth qui ne v√©rifient pas les emails en s'inscrivant avec leur service puis en changeant l'email du compte pour celui de la victime. Cette m√©thode pr√©sente un risque similaire d'acc√®s non autoris√©, semblable au premier sc√©nario mais via un vecteur d'attaque diff√©rent.

### Divulgation de secrets <a href="#e177" id="e177"></a>

Identifier et prot√©ger les param√®tres secrets OAuth est crucial. Bien que le **`client_id`** puisse √™tre divulgu√© en toute s√©curit√©, r√©v√©ler le **`client_secret`** pose des risques significatifs. Si le `client_secret` est compromis, les attaquants peuvent exploiter l'identit√© et la confiance de l'application pour **voler les `access_tokens`** des utilisateurs et des informations priv√©es.

Une vuln√©rabilit√© courante survient lorsque les applications g√®rent par erreur l'√©change du `code` d'autorisation pour un `access_token` c√¥t√© client plut√¥t que c√¥t√© serveur. Cette erreur conduit √† l'exposition du `client_secret`, permettant aux attaquants de g√©n√©rer des `access_tokens` sous l'apparence de l'application. De plus, par ing√©nierie sociale, les attaquants pourraient escalader les privil√®ges en ajoutant des port√©es suppl√©mentaires √† l'autorisation OAuth, exploitant davantage le statut de confiance de l'application.

### Bruteforce du Client Secret

Vous pouvez essayer de **bruteforcer le client\_secret** d'un fournisseur de services avec le fournisseur d'identit√© afin d'essayer de voler des comptes.\
La requ√™te pour BF peut ressembler √† :
```
POST /token HTTP/1.1
content-type: application/x-www-form-urlencoded
host: 10.10.10.10:3000
content-length: 135
Connection: close

code=77515&redirect_uri=http%3A%2F%2F10.10.10.10%3A3000%2Fcallback&grant_type=authorization_code&client_id=public_client_id&client_secret=[bruteforce]
```
### Referer Header leaking Code + State

Une fois que le client a le **code et l'√©tat**, s'ils sont **r√©fl√©chis dans l'en-t√™te Referer** lorsqu'il navigue vers une autre page, alors c'est vuln√©rable.

### Access Token Stored in Browser History

Allez dans l'**historique du navigateur et v√©rifiez si le jeton d'acc√®s y est enregistr√©**.

### Everlasting Authorization Code

Le **code d'autorisation ne devrait vivre que pendant un certain temps pour limiter la fen√™tre de temps o√π un attaquant peut le voler et l'utiliser**.

### Authorization/Refresh Token not bound to client

Si vous pouvez obtenir le **code d'autorisation et l'utiliser avec un client diff√©rent, alors vous pouvez prendre le contr√¥le d'autres comptes**.

### Happy Paths, XSS, Iframes & Post Messages to leak code & state values

[**Consultez cet article**](https://labs.detectify.com/writeups/account-hijacking-using-dirty-dancing-in-sign-in-oauth-flows/#gadget-2-xss-on-sandbox-third-party-domain-that-gets-the-url)

### AWS Cognito <a href="#bda5" id="bda5"></a>

Dans ce rapport de bug bounty : [**https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/**](https://security.lauritz-holtmann.de/advisories/flickr-account-takeover/) vous pouvez voir que le **jeton** que **AWS Cognito** renvoie √† l'utilisateur pourrait avoir **suffisamment de permissions pour √©craser les donn√©es de l'utilisateur**. Par cons√©quent, si vous pouvez **changer l'email de l'utilisateur pour un autre email**, vous pourriez √™tre capable de **prendre le contr√¥le** d'autres comptes.
```bash
# Read info of the user
aws cognito-idp get-user --region us-east-1 --access-token eyJraWQiOiJPVj[...]

# Change email address
aws cognito-idp update-user-attributes --region us-east-1 --access-token eyJraWQ[...] --user-attributes Name=email,Value=imaginary@flickr.com
{
"CodeDeliveryDetailsList": [
{
"Destination": "i***@f***.com",
"DeliveryMedium": "EMAIL",
"AttributeName": "email"
}
]
}
```
Pour plus d'informations d√©taill√©es sur la mani√®re d'abuser de AWS cognito, consultez :

{% embed url="https://cloud.hacktricks.xyz/pentesting-cloud/aws-pentesting/aws-unauthenticated-enum-access/aws-cognito-unauthenticated-enum" %}

### Abuser des tokens d'autres applications <a href="#bda5" id="bda5"></a>

Comme [**mentionn√© dans cet article**](https://salt.security/blog/oh-auth-abusing-oauth-to-take-over-millions-of-accounts), les flux OAuth qui s'attendent √† recevoir le **token** (et non un code) pourraient √™tre vuln√©rables s'ils ne v√©rifient pas que le token appartient √† l'application.

Cela est d√ª au fait qu'un **attaquant** pourrait cr√©er une **application supportant OAuth et se connecter avec Facebook** (par exemple) dans sa propre application. Ensuite, une fois qu'une victime se connecte avec Facebook dans l'**application de l'attaquant**, l'attaquant pourrait obtenir le **token OAuth de l'utilisateur donn√© √† son application, et l'utiliser pour se connecter √† l'application OAuth de la victime en utilisant le token utilisateur de la victime**.

{% hint style="danger" %}
Par cons√©quent, si l'attaquant parvient √† faire acc√©der l'utilisateur √† sa propre application OAuth, il pourra prendre le contr√¥le du compte de la victime dans les applications qui attendent un token et ne v√©rifient pas si le token a √©t√© accord√© √† leur ID d'application.
{% endhint %}

### Deux liens & cookie <a href="#bda5" id="bda5"></a>

Selon [**cet article**](https://medium.com/@metnew/why-electron-apps-cant-store-your-secrets-confidentially-inspect-option-a49950d6d51f), il √©tait possible de faire ouvrir √† une victime une page avec un **returnUrl** pointant vers l'h√¥te de l'attaquant. Cette information serait **stock√©e dans un cookie (RU)** et √† une **√©tape ult√©rieure**, le **prompt** demandera √† l'**utilisateur** s'il souhaite donner acc√®s √† cet h√¥te de l'attaquant.

Pour contourner ce prompt, il √©tait possible d'ouvrir un onglet pour initier le **flux OAuth** qui d√©finirait ce cookie RU en utilisant le **returnUrl**, de fermer l'onglet avant que le prompt ne soit affich√©, et d'ouvrir un nouvel onglet sans cette valeur. Ensuite, le **prompt n'informera pas de l'h√¥te de l'attaquant**, mais le cookie serait d√©fini pour celui-ci, donc le **token sera envoy√© √† l'h√¥te de l'attaquant** dans la redirection.

### Contournement de l'interaction du prompt <a href="#bda5" id="bda5"></a>

Comme expliqu√© dans [**cette vid√©o**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), certaines impl√©mentations OAuth permettent d'indiquer le param√®tre GET **`prompt`** comme None (**`&prompt=none`**) pour **emp√™cher les utilisateurs d'√™tre invit√©s √† confirmer** l'acc√®s donn√© dans un prompt sur le web s'ils sont d√©j√† connect√©s √† la plateforme.

### response\_mode

Comme [**expliqu√© dans cette vid√©o**](https://www.youtube.com/watch?v=n9x7\_J\_a\_7Q), il pourrait √™tre possible d'indiquer le param√®tre **`response_mode`** pour indiquer o√π vous souhaitez que le code soit fourni dans l'URL finale :

* `response_mode=query` -> Le code est fourni dans un param√®tre GET : `?code=2397rf3gu93f`
* `response_mode=fragment` -> Le code est fourni dans le param√®tre fragment de l'URL `#code=2397rf3gu93f`
* `response_mode=form_post` -> Le code est fourni dans un formulaire POST avec un input appel√© `code` et la valeur
* `response_mode=web_message` -> Le code est envoy√© dans un message post : `window.opener.postMessage({"code": "asdasdasd...`

### Param√®tres SSRFs <a href="#bda5" id="bda5"></a>

[**Consultez cette recherche**](https://portswigger.net/research/hidden-oauth-attack-vectors) **pour plus de d√©tails sur cette technique.**

L'enregistrement dynamique des clients dans OAuth sert de vecteur moins √©vident mais critique pour les vuln√©rabilit√©s de s√©curit√©, sp√©cifiquement pour les attaques **Server-Side Request Forgery (SSRF)**. Ce point de terminaison permet aux serveurs OAuth de recevoir des d√©tails sur les applications clientes, y compris des URL sensibles qui pourraient √™tre exploit√©es.

**Points cl√©s :**

* **L'enregistrement dynamique des clients** est souvent mapp√© √† `/register` et accepte des d√©tails comme `client_name`, `client_secret`, `redirect_uris`, et des URL pour les logos ou les ensembles de cl√©s JSON Web (JWKs) via des requ√™tes POST.
* Cette fonctionnalit√© adh√®re aux sp√©cifications √©nonc√©es dans **RFC7591** et **OpenID Connect Registration 1.0**, qui incluent des param√®tres potentiellement vuln√©rables aux SSRF.
* Le processus d'enregistrement peut involontairement exposer les serveurs aux SSRF de plusieurs mani√®res :
* **`logo_uri`** : Une URL pour le logo de l'application cliente qui pourrait √™tre r√©cup√©r√©e par le serveur, d√©clenchant une SSRF ou menant √† une XSS si l'URL est mal g√©r√©e.
* **`jwks_uri`** : Une URL vers le document JWK du client, qui, si elle est malicieusement con√ßue, peut amener le serveur √† faire des requ√™tes sortantes vers un serveur contr√¥l√© par l'attaquant.
* **`sector_identifier_uri`** : R√©f√©rence un tableau JSON de `redirect_uris`, que le serveur pourrait r√©cup√©rer, cr√©ant une opportunit√© de SSRF.
* **`request_uris`** : Liste les URIs de requ√™te autoris√©es pour le client, qui peuvent √™tre exploit√©es si le serveur r√©cup√®re ces URIs au d√©but du processus d'autorisation.

**Strat√©gie d'exploitation :**

* La SSRF peut √™tre d√©clench√©e en enregistrant un nouveau client avec des URL malveillantes dans des param√®tres comme `logo_uri`, `jwks_uri`, ou `sector_identifier_uri`.
* Bien que l'exploitation directe via `request_uris` puisse √™tre att√©nu√©e par des contr√¥les de liste blanche, fournir une `request_uri` pr√©enregistr√©e et contr√¥l√©e par l'attaquant peut faciliter la SSRF pendant la phase d'autorisation.

## Conditions de course des fournisseurs OAuth

Si la plateforme que vous testez est un fournisseur OAuth, [**lisez ceci pour tester les conditions de course possibles**](race-condition.md).

## R√©f√©rences

* [**https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1**](https://medium.com/a-bugz-life/the-wondeful-world-of-oauth-bug-bounty-edition-af3073b354c1)
* [**https://portswigger.net/research/hidden-oauth-attack-vectors**](https://portswigger.net/research/hidden-oauth-attack-vectors)

<figure><img src="https://pentest.eu/RENDER_WebSec_10fps_21sec_9MB_29042024.gif" alt=""><figcaption></figcaption></figure>

{% embed url="https://websec.nl/" %}

<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez les [**produits d√©riv√©s officiels PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe Telegram**](https://t.me/peass) ou **suivez-nous** sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux** [**repos github HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
