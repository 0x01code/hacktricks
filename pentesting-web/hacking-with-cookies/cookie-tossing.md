<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


## Description

Si un attaquant peut **contr√¥ler un sous-domaine ou le domaine d'une entreprise ou trouve un XSS dans un sous-domaine**, il pourra r√©aliser cette attaque.

Comme indiqu√© dans la section Cookies Hacking, lorsqu'un **cookie est d√©fini pour un domaine (en le sp√©cifiant), il sera utilis√© dans le domaine et les sous-domaines.**

{% hint style="danger" %}
Par cons√©quent, **un attaquant pourra d√©finir pour le domaine et les sous-domaines un cookie sp√©cifique en faisant quelque chose comme** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Cela peut √™tre dangereux car l'attaquant pourrait :

* **Fixer le cookie de la victime sur le compte de l'attaquant** donc si l'utilisateur ne le remarque pas, **il effectuera les actions sur le compte de l'attaquant** et l'attaquant pourrait obtenir des informations int√©ressantes (v√©rifier l'historique des recherches de l'utilisateur sur la plateforme, la victime pourrait enregistrer sa carte de cr√©dit sur le compte...)
* Si le **cookie ne change pas apr√®s la connexion**, l'attaquant pourrait simplement **fixer un cookie**, attendre que la victime se connecte puis **utiliser ce cookie pour se connecter en tant que victime**.
* Si le **cookie d√©finit une valeur initiale** (comme dans flask o√π le **cookie** peut **d√©finir** le **CSRF token** de la session et cette valeur sera maintenue apr√®s que la victime se connecte), **l'attaquant pourrait d√©finir cette valeur connue puis en abuser** (dans ce sc√©nario, l'attaquant pourrait alors faire ex√©cuter √† l'utilisateur une requ√™te CSRF puisqu'il conna√Æt le CSRF token).

## Ordre des Cookies

Lorsqu'un navigateur re√ßoit deux cookies portant le m√™me nom **affectant partiellement le m√™me p√©rim√®tre** (domaine, sous-domaines et chemin), le **navigateur enverra les deux valeurs du cookie** lorsque les deux sont valides pour la requ√™te.

Selon qui a **le chemin le plus sp√©cifique** ou lequel est **le plus ancien**, le navigateur **d√©finira la valeur du cookie en premier** puis celle de l'autre comme dans : `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

La plupart des **sites web n'utiliseront que la premi√®re valeur**. Ainsi, si un attaquant veut d√©finir un cookie, il vaut mieux le faire avant qu'un autre soit d√©fini ou le d√©finir avec un chemin plus sp√©cifique.

{% hint style="warning" %}
De plus, la capacit√© √† **d√©finir un cookie dans un chemin plus sp√©cifique** est tr√®s int√©ressante car vous pourrez faire en sorte que **la victime travaille avec son cookie sauf dans le chemin sp√©cifique o√π le cookie malveillant d√©fini sera envoy√© en premier**.
{% endhint %}

## Contournement de Protection

Une protection possible contre cette attaque serait que le **serveur web n'accepte pas les requ√™tes avec deux cookies portant le m√™me nom mais deux valeurs diff√©rentes**.

Pour contourner le sc√©nario o√π l'attaquant d√©finit un cookie apr√®s que la victime a d√©j√† re√ßu le cookie, l'attaquant pourrait provoquer un **d√©bordement de cookie** et ensuite, une fois le **cookie l√©gitime supprim√©, d√©finir le malveillant**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Un autre **contournement** utile pourrait √™tre d'**encoder l'URL du nom du cookie** car certaines protections v√©rifient la pr√©sence de 2 cookies avec le m√™me nom dans une requ√™te puis le serveur d√©codera les noms des cookies.

## Bombe √† Cookies

Une attaque de Cookie Tossing peut √©galement √™tre utilis√©e pour r√©aliser une attaque de **Bombe √† Cookies** :

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

## D√©fenses

### **Utiliser le pr√©fixe `__Host` dans le nom du cookie**

* Si un nom de cookie a ce pr√©fixe, il **sera accept√© uniquement** dans une directive Set-Cookie s'il est marqu√© comme Secure, a √©t√© envoy√© depuis une origine s√©curis√©e, ne comprend pas d'attribut Domain et a l'attribut Path d√©fini sur /
* **Cela emp√™che les sous-domaines de forcer un cookie sur le domaine principal puisque ces cookies peuvent √™tre consid√©r√©s comme "verrouill√©s sur le domaine"**

## R√©f√©rences

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop) !
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PRs aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
