# Cookie Tossing

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>

### Beschreibung

Wenn ein Angreifer **eine Subdomain oder die Domain eines Unternehmens kontrollieren kann oder ein XSS in einer Subdomain findet**, kann er diesen Angriff durchf√ºhren.

Wie bereits im Abschnitt Cookies Hacking angegeben, wenn ein **Cookie auf eine Domain gesetzt wird (diese spezifiziert), wird es in der Domain und den Subdomains verwendet.**

{% hint style="danger" %}
Daher **kann ein Angreifer ein spezifisches Cookie f√ºr die Domain und Subdomains setzen, indem er etwas wie** `document.cookie="session=1234; Path=/app/login; domain=.example.com"` macht.
{% endhint %}

Dies kann gef√§hrlich sein, da der Angreifer m√∂glicherweise:

* **Das Cookie des Opfers auf das Konto des Angreifers fixieren kann**, sodass, wenn der Benutzer es nicht bemerkt, **er die Aktionen im Konto des Angreifers ausf√ºhrt** und der Angreifer m√∂glicherweise einige interessante Informationen erh√§lt (√ºberpr√ºfen Sie die Suchhistorie des Benutzers auf der Plattform, das Opfer k√∂nnte seine Kreditkarte im Konto hinterlegt haben...)
* Wenn das **Cookie nach dem Login nicht ge√§ndert wird**, kann der Angreifer einfach **ein Cookie fixieren (Session-Fixierung)**, warten, bis das Opfer sich einloggt, und dann **dieses Cookie verwenden, um sich als das Opfer einzuloggen**.
* Manchmal, auch wenn sich die Sitzungscookies √§ndern, kann der Angreifer das vorherige verwenden und erh√§lt auch das neue.
* Wenn das **Cookie einen anf√§nglichen Wert setzt** (wie in Flask, wo das **Cookie** den **CSRF-Token** der Sitzung **setzen** kann und dieser Wert nach dem Einloggen des Opfers beibehalten wird), **kann der Angreifer diesen bekannten Wert setzen und dann missbrauchen** (in diesem Szenario kann der Angreifer den Benutzer dann dazu bringen, eine CSRF-Anfrage auszuf√ºhren, da er den CSRF-Token kennt).
* Genauso wie das Setzen des Werts k√∂nnte der Angreifer auch ein nicht authentifiziertes Cookie erhalten, das vom Server generiert wurde, den CSRF-Token daraus erhalten und verwenden.

### Cookie-Reihenfolge

Wenn ein Browser zwei Cookies mit demselben Namen erh√§lt, die **teilweise denselben Bereich betreffen** (Domain, Subdomains und Pfad), wird der **Browser beide Cookie-Werte senden**, wenn beide f√ºr die Anfrage g√ºltig sind.

Abh√§ngig davon, wer den **spezifischeren Pfad hat** oder welcher der **√§ltere ist**, wird der Browser **zuerst den Wert des einen Cookies setzen** und dann den Wert des anderen wie in: `Cookie: iduser=MehrSpezifischUnd√ÑlteresCookie; iduser=WenigerSpezifisch;`

Die meisten **Websites verwenden nur den ersten Wert**. Wenn ein Angreifer also ein Cookie setzen m√∂chte, ist es besser, es zu setzen, bevor ein anderes gesetzt wird oder es mit einem spezifischeren Pfad zu setzen.

{% hint style="warning" %}
Dar√ºber hinaus ist die F√§higkeit, **ein Cookie in einem spezifischeren Pfad zu setzen**, sehr interessant, da Sie den **Benutzer mit seinem Cookie arbeiten lassen k√∂nnen, au√üer im spezifischen Pfad, wo das b√∂sartige Cookie vor dem Versenden des Cookies gesetzt wird**.
{% endhint %}

### Schutzumgehung

Ein m√∂glicher Schutz gegen diesen Angriff w√§re, dass der **Webserver keine Anfragen mit zwei Cookies mit demselben Namen, aber zwei verschiedenen Werten akzeptiert**.

Um das Szenario zu umgehen, in dem der Angreifer ein Cookie setzt, nachdem dem Opfer bereits das Cookie gegeben wurde, k√∂nnte der Angreifer einen **Cookie-Overflow** verursachen und dann, sobald das **legitime Cookie gel√∂scht ist, das b√∂sartige setzen**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Eine weitere n√ºtzliche **Umgehung** k√∂nnte sein, den Namen des Cookies **URL-codiert** zu verwenden, da einige Schutzmechanismen nach 2 Cookies mit demselben Namen in einer Anfrage suchen und dann der Server die Namen der Cookies decodiert.

### Cookie-Bombe

Ein Cookie-Tossing-Angriff kann auch verwendet werden, um einen **Cookie-Bomben**-Angriff durchzuf√ºhren:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

### Verteidigung**en**

#### **Verwenden Sie das Pr√§fix `__Host` im Cookienamen**

* Wenn ein Cookiename dieses Pr√§fix hat, wird er **nur akzeptiert**, wenn er in einer Set-Cookie-Anweisung als Secure markiert ist, von einem sicheren Ursprung gesendet wurde, keinen Domain-Attribut enth√§lt und das Pfadattribut auf / gesetzt ist.
* **Dies verhindert, dass Subdomains ein Cookie auf die Hauptdomain erzwingen, da diese Cookies als "domain-gesperrt" angesehen werden k√∂nnen**

### Referenzen

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)
* [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Andere M√∂glichkeiten, HackTricks zu unterst√ºtzen:

* Wenn Sie Ihr **Unternehmen in HackTricks beworben sehen m√∂chten** oder **HackTricks als PDF herunterladen m√∂chten**, √ºberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Treten Sie der** üí¨ [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie uns auf **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an die** [**HackTricks**](https://github.com/carlospolop/hacktricks) und [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) GitHub-Repositories einreichen.

</details>
