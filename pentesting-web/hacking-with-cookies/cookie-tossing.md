<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>


## Descri√ß√£o

Se um atacante pode **controlar um subdom√≠nio ou o dom√≠nio de uma empresa ou encontrar um XSS em um subdom√≠nio**, ele poder√° realizar esse ataque.

Como foi indicado na se√ß√£o de Hacking de Cookies, quando um **cookie √© definido para um dom√≠nio (especificando-o), ele ser√° usado no dom√≠nio e subdom√≠nios.**

{% hint style="danger" %}
Portanto, **um atacante poder√° definir para o dom√≠nio e subdom√≠nios um cookie espec√≠fico fazendo algo como** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

Isso pode ser perigoso, pois o atacante pode:

* **Fixar o cookie da v√≠tima na conta do atacante** para que, se o usu√°rio n√£o perceber, **ele realizar√° as a√ß√µes na conta do atacante** e o atacante poder√° obter algumas informa√ß√µes interessantes (verificar o hist√≥rico de buscas do usu√°rio na plataforma, a v√≠tima pode cadastrar seu cart√£o de cr√©dito na conta...)
* Se o **cookie n√£o mudar ap√≥s o login**, o atacante pode simplesmente **fixar um cookie**, esperar at√© que a v√≠tima fa√ßa login e ent√£o **usar esse cookie para entrar como a v√≠tima**.
* Se o **cookie estiver definindo algum valor inicial** (como no flask onde o **cookie** pode **definir** o **token CSRF** da sess√£o e esse valor ser√° mantido ap√≥s o login da v√≠tima), o **atacante pode definir esse valor conhecido e ent√£o abusar dele** (nesse cen√°rio, o atacante pode fazer o usu√°rio realizar uma solicita√ß√£o CSRF, pois ele conhece o token CSRF).

## Ordem dos Cookies

Quando um navegador recebe dois cookies com o mesmo nome **afetando parcialmente o mesmo escopo** (dom√≠nio, subdom√≠nios e caminho), o **navegador enviar√° ambos os valores do cookie** quando ambos forem v√°lidos para a solicita√ß√£o.

Dependendo de quem tem **o caminho mais espec√≠fico** ou qual √© o **mais antigo**, o navegador **definir√° o valor do cookie primeiro** e depois o valor do outro, como em: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

A maioria dos **sites usar√° apenas o primeiro valor**. Ent√£o, se um atacante quiser definir um cookie, √© melhor definir antes que outro seja definido ou definir com um caminho mais espec√≠fico.

{% hint style="warning" %}
Al√©m disso, a capacidade de **definir um cookie em um caminho mais espec√≠fico** √© muito interessante, pois voc√™ poder√° fazer a **v√≠tima trabalhar com seu cookie, exceto no caminho espec√≠fico onde o cookie malicioso definido ser√° enviado antes**.
{% endhint %}

## Prote√ß√£o Bypass

Uma poss√≠vel prote√ß√£o contra esse ataque seria que o **servidor web n√£o aceitasse solicita√ß√µes com dois cookies com o mesmo nome, mas com dois valores diferentes**.

Para contornar o cen√°rio em que o atacante est√° definindo um cookie depois que a v√≠tima j√° recebeu o cookie, o atacante poderia causar um **overflow de cookie** e ent√£o, uma vez que o **cookie leg√≠timo seja exclu√≠do, definir o malicioso**.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

Outro **bypass** √∫til poderia ser **codificar o nome do cookie na URL** j√° que algumas prote√ß√µes verificam se h√° 2 cookies com o mesmo nome em uma solicita√ß√£o e ent√£o o servidor decodificar√° os nomes dos cookies.

## Cookie Bomb

Um ataque de Cookie Tossing tamb√©m pode ser usado para realizar um ataque de **Cookie Bomb**:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

## Defesas

### **Use o prefixo `__Host` no nome do cookie**

* Se um nome de cookie tiver esse prefixo, ele **ser√° aceito** apenas em uma diretiva Set-Cookie se estiver marcado como Seguro, foi enviado de uma origem segura, n√£o incluir um atributo de Dom√≠nio e tiver o atributo de Caminho definido para /
* **Isso impede que subdom√≠nios forcem um cookie para o dom√≠nio principal, j√° que esses cookies podem ser vistos como "bloqueados por dom√≠nio"**

## Refer√™ncias

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)


<details>

<summary><strong>Aprenda hacking no AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios github do** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
