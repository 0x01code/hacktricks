<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)을 **팔로우**하세요.
* **HackTricks**와 **HackTricks Cloud** github 저장소에 **PR을 제출하여** 여러분의 해킹 기교를 **공유**하세요.

</details>


## 설명

공격자가 **회사의 서브도메인 또는 도메인을 제어하거나 서브도메인에서 XSS를 찾을 수 있다면** 이 공격을 수행할 수 있습니다.

쿠키 해킹 섹션에서 언급했듯이, **쿠키가 도메인에 설정되면 (지정된 도메인을 지정하는) 도메인 및 서브도메인에서 사용됩니다.**

{% hint style="danger" %}
따라서, **공격자는 도메인 및 서브도메인에 특정 쿠키를 설정할 수 있습니다.** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`와 같은 방식으로
{% endhint %}

이는 공격자가 다음과 같은 작업을 수행할 수 있기 때문에 위험할 수 있습니다:

* 피해자의 쿠키를 공격자의 계정으로 **고정시키면**, 사용자가 알아채지 못하면 **피해자는 공격자의 계정에서 작업을 수행**하게 되며, 공격자는 피해자의 플랫폼에서 흥미로운 정보를 얻을 수 있습니다 (플랫폼에서 사용자의 검색 기록을 확인하거나, 피해자가 계정에 신용 카드를 설정할 수 있습니다...)
* **로그인 후 쿠키가 변경되지 않는다면**, 공격자는 단순히 **쿠키를 고정시키고, 피해자가 로그인할 때까지 기다린 다음 그 쿠키를 사용하여 피해자로서 로그인**할 수 있습니다.
* **쿠키가 초기 값을 설정**하는 경우 (예: 플라스크에서 **쿠키**가 세션의 **CSRF 토큰**을 **설정**할 수 있으며, 이 값은 피해자가 로그인한 후에도 유지됩니다), **공격자는이 알려진 값을 설정한 다음 악용**할 수 있습니다 (이 시나리오에서 공격자는 CSRF 토큰을 알기 때문에 사용자로 하여금 CSRF 요청을 수행하도록 할 수 있습니다).

## 쿠키 순서

브라우저가 동일한 이름을 가진 두 개의 쿠키를 받을 때 **동일한 범위** (도메인, 서브도메인 및 경로)를 **부분적으로 영향**받는다면, 브라우저는 두 쿠키의 값을 모두 요청에 보냅니다.

가장 **구체적인 경로를 가진 쿠키** 또는 가장 **오래된 쿠키**에 따라, 브라우저는 **먼저 쿠키의 값을 설정**한 다음 다른 쿠키의 값을 설정합니다. 예: `Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

대부분의 **웹 사이트는 첫 번째 값만 사용**합니다. 따라서, 공격자가 쿠키를 설정하려면 다른 쿠키가 설정되기 전에 설정하거나 더 구체적인 경로로 설정하는 것이 좋습니다.

{% hint style="warning" %}
또한, **더 구체적인 경로에 쿠키를 설정**할 수 있는 능력은 매우 흥미로울 수 있습니다. 이렇게 하면 **피해자는 악성 쿠키가 설정된 특정 경로를 제외한 곳에서 쿠키를 사용**할 수 있습니다.
{% endhint %}

## 보호 우회

이러한 공격에 대한 가능한 보호는 **웹 서버가 두 개의 다른 값으로 동일한 이름의 쿠키를 허용하지 않도록 하는 것**일 수 있습니다.

공격자가 이미 피해자에게 쿠키가 제공된 후에 쿠키를 설정하고 있는 시나리오를 우회하기 위해, 공격자는 **쿠키 오버플로우**를 유발하고, **합법적인 쿠키가 삭제된 후에 악성 쿠키를 설정**할 수 있습니다.

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

또 다른 유용한 **우회 방법**은 쿠키의 이름을 **URL 인코딩**하는 것입니다. 일부 보호 기능은 요청에서 동일한 이름의 2 개의 쿠키를 확인하고 서버가 쿠키의 이름을 디코딩하기 때문에 이를 확인합니다.

## 쿠키 폭탄

쿠키 토싱 공격은 **쿠키 폭탄** 공격을 수행하는 데에도 사용될 수 있습니다:

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

## 방어

### 쿠키 이름에 접두사 `__Host` 사용

* 쿠키 이름에 이 접두사가 있으면, **안전한 원본에서 보내진 Secure로 표시된 쿠키만** Set-Cookie 지시문에서 **허용**됩니다. 또한, Domain 속성을 포함하지 않고 Path 속성이 /로 설정된 경우에만 허용됩니다.
* **이로 인해 서브도메인이 쿠키를 최상위 도메인에 강제로 설정하는 것을 방지**할 수 있습니다.

## 참고 자료

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)


<details>

<summary><strong>htARTE (HackTricks AWS Red Team Expert)</strong>를 통해 AWS 해킹을 처음부터 전문가까지 배워보세요<strong>!</strong></summary>

HackTricks를 지원하는 다른 방법:

* **회사를 HackTricks에서 광고하거나 HackTricks를 PDF로 다운로드**하려면 [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)를 확인하세요!
* [**공식 PEASS & HackTricks 스웨그**](https://peass.creator-spring.com)를 얻으세요.
* 독점적인 [**NFT**](https://opensea.io/collection/the-peass-family) 컬렉션인 [**The PEASS Family**](https://opensea.io/collection/the-peass-family)를 발견하세요.
* 💬 [**Discord 그룹**](https://discord.gg/hRep4RUj7f) 또는 [**텔레그램 그룹**](https://t.me/peass)에 **참여**하거나 **Twitter** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)을 **팔로우**하세요.
* **HackTr
