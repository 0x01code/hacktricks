<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>


## 描述

如果攻击者能够**控制一个子域名或公司的域名，或者在子域名中找到一个XSS**，他将能够执行这种攻击。

正如在Cookies Hacking部分所指出的，当**cookie被设置到一个域名（指定它）时，它将在域名和子域名中使用。**

{% hint style="danger" %}
因此，**攻击者将能够设置特定cookie到域名和子域名，类似于** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`
{% endhint %}

这可能是危险的，因为攻击者可能能够：

* **将受害者的cookie固定到攻击者的账户**，所以如果用户没有注意到，**他将在攻击者的账户中执行操作**，攻击者可能获得一些有趣的信息（检查用户在平台上的搜索历史，受害者可能在账户中设置他的信用卡...）
* 如果**登录后cookie没有变化**，攻击者可能只是**固定一个cookie**，等到受害者登录后，然后**使用该cookie作为受害者登录**。
* 如果**cookie设置了一些初始值**（如在flask中，**cookie**可能**设置**会话的**CSRF token**，并且这个值在受害者登录后将被保持），**攻击者可能设置这个已知值然后滥用它**（在这种情况下，攻击者可能会让用户执行CSRF请求，因为他知道CSRF token）。

## Cookie顺序

当浏览器接收到两个具有相同名称的cookie并且**部分影响相同范围**（域名、子域名和路径）时，如果两个cookie对请求都有效，**浏览器将发送两个cookie的值**。

根据谁拥有**最具体的路径**或哪个是**最旧的**，浏览器将**首先设置cookie的值**，然后是另一个的值，如：`Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

大多数**网站只会使用第一个值**。因此，如果攻击者想要设置cookie，最好是在另一个cookie被设置之前设置它，或者用更具体的路径设置它。

{% hint style="warning" %}
此外，能够**在更具体的路径中设置cookie**的能力非常有趣，因为你将能够让**受害者在除了特定路径外的地方使用他的cookie，在那里恶意cookie设置将会先发送**。
{% endhint %}

## 绕过保护

对这种攻击的可能保护是**web服务器不接受带有相同名称但两个不同值的两个cookie的请求**。

为了绕过攻击者在受害者已经获得cookie之后设置cookie的情况，攻击者可以引起**cookie溢出**，然后，一旦**合法cookie被删除，设置恶意cookie**。

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

另一个有用的**绕过**可能是**URL编码cookie的名称**，因为一些保护措施会检查请求中是否有两个同名的cookie，然后服务器将解码cookie的名称。

## Cookie炸弹

Cookie Tossing攻击也可以用来执行**Cookie炸弹**攻击：

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

## 防御

### **在cookie名称中使用前缀`__Host`**

* 如果cookie名称有这个前缀，它**只会在Set-Cookie指令中被接受**，如果它被标记为Secure，是从一个安全的来源发送的，不包括Domain属性，并且将Path属性设置为/
* **这防止了子域名强制cookie到顶级域名，因为这些cookie可以被视为“域名锁定”**

## 参考资料

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers)
* [**https://github.blog/2013-04-09-yummy-cookies-across-domains/**](https://github.blog/2013-04-09-yummy-cookies-across-domains/)


<details>

<summary><strong>通过</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>从零开始学习AWS黑客攻击！</strong></summary>

支持HackTricks的其他方式：

* 如果您想在**HackTricks中看到您的公司广告**或**下载HackTricks的PDF版本**，请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 获取[**官方PEASS & HackTricks商品**](https://peass.creator-spring.com)
* 探索[**PEASS家族**](https://opensea.io/collection/the-peass-family)，我们独家的[**NFTs系列**](https://opensea.io/collection/the-peass-family)
* **加入** 💬 [**Discord群组**](https://discord.gg/hRep4RUj7f) 或 [**telegram群组**](https://t.me/peass) 或在 **Twitter** 🐦 上**关注**我 [**@carlospolopm**](https://twitter.com/carlospolopm)**。**
* **通过向** [**HackTricks**](https://github.com/carlospolop/hacktricks) 和 [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github仓库提交PR来分享您的黑客技巧。**

</details>
