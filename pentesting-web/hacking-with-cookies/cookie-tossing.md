<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks Cloud ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

- **サイバーセキュリティ会社**で働いていますか？ **HackTricksで会社を宣伝**したいですか？または、**最新バージョンのPEASSにアクセスしたり、HackTricksをPDFでダウンロード**したいですか？[**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)をチェックしてください！

- 独占的な[**NFT**](https://opensea.io/collection/the-peass-family)のコレクションである[**The PEASS Family**](https://opensea.io/collection/the-peass-family)を発見してください。

- [**公式のPEASS＆HackTricksのグッズ**](https://peass.creator-spring.com)を手に入れましょう。

- **[💬](https://emojipedia.org/speech-balloon/) Discordグループ**に参加するか、[**telegramグループ**](https://t.me/peass)に参加するか、**Twitter**で**フォロー**してください[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks_live)**。**

- **ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。**

</details>


## 説明

もし攻撃者が**企業のサブドメインまたはドメインを制御できるか、サブドメインでXSSを見つける**ことができれば、この攻撃を実行することができます。

Cookieハッキングのセクションで示されているように、**cookieがドメインに設定されると（それを指定して）ドメインとサブドメインで使用されます。**

{% hint style="danger" %}
したがって、**攻撃者はドメインとサブドメインに特定のcookieを設定することができます。** `document.cookie="session=1234; Path=/app/login; domain=.example.com"`のようなことを行います。
{% endhint %}

これは危険です。攻撃者は次のことができるかもしれません：

* **被害者のcookieを攻撃者のアカウントに固定化**することで、ユーザーが気づかない場合、**彼は攻撃者のアカウントで操作を行い**、攻撃者は興味深い情報を入手するかもしれません（プラットフォームでのユーザーの検索履歴をチェックしたり、被害者がクレジットカードをアカウントに設定したり...）
* もし**ログイン後にcookieが変わらない**場合、攻撃者は単に**cookieを固定化**し、被害者がログインするのを待ってから、そのcookieを使用して**被害者としてログイン**することができます。
* もし**cookieが初期値を設定している**場合（flaskのように**cookie**がセッションの**CSRFトークン**を**設定**し、この値が被害者がログインした後も維持される場合）、**攻撃者はこの既知の値を設定し、それを悪用**することができます（このシナリオでは、攻撃者はCSRFトークンを知っているため、ユーザーにCSRFリクエストを実行させることができます）。

## Cookieの順序

ブラウザが同じ名前の2つのcookieを受け取った場合、**同じスコープ（ドメイン、サブドメイン、パス）に部分的に影響を与える場合、ブラウザは両方のcookieの値を送信します**。

最も**具体的なパスを持つもの**または**最も古いもの**によって、ブラウザは**最初にcookieの値を設定**し、その後に他のcookieの値を設定します。例：`Cookie: iduser=MoreSpecificAndOldestCookie; iduser=LessSpecific;`

ほとんどの**ウェブサイトは最初の値のみを使用**します。したがって、攻撃者がcookieを設定する場合は、他のcookieが設定される前に設定するか、より具体的なパスで設定する方が良いです。

{% hint style="warning" %}
さらに、**より具体的なパスでcookieを設定**できる能力は非常に興味深いです。これにより、**被害者は自分のcookieで作業できるようになりますが、悪意のあるcookieが送信されるパスでは、そのcookieが先に送信されます**。
{% endhint %}

## 保護のバイパス

この攻撃に対する可能な保護策は、**ウェブサーバーが2つの異なる値を持つ同じ名前のcookieを受け入れない**ようにすることです。

攻撃者が被害者にすでにcookieが与えられた後にcookieを設定しているシナリオをバイパスするために、攻撃者は**cookieオーバーフロー**を引き起こし、その後、**正規のcookieが削除された後に悪意のあるcookieを設定**することができます。

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

また、**バイパス**に役立つもう1つの方法は、**cookieの名前をURLエンコード**することです。一部の保護は、リクエスト内の同じ名前の2つのcookieをチェックし、サーバーがcookieの名前をデコードするため、名前のエンコードをチェックします。

## Cookie Bomb

Cookie Tossing攻撃は、**Cookie Bomb**攻撃を実行するためにも使用できます：

{% content-ref url="cookie-bomb.md" %}
[cookie-bomb.md](cookie-bomb.md)
{% endcontent-ref %}

## 防御策

### cookie名に接頭辞`__Host`を使用する

* cookie名にこの接頭辞がある場合、それは**Secureにマークされ、セキュアなオリジンから送信され、Domain属性を含まず、Path属性が/に設定されている**場合にのみ、Set-Cookieディレクティブで受け入れられます。
* **これにより、サブドメインがcookieをapexドメインに強制することができなくなります。これらのcookieは「ドメインロックされた」と見なされる可能性があります。**

## 参考文献

* [**@blueminimal**](https://twitter.com/blueminimal)
* [**https://speakerdeck.com/filedescriptor/the-cookie-monster-in-your-browsers**](https://speakerdeck.com/filedescriptor/the-cookie-mon
- [💬](https://emojipedia.org/speech-balloon/) [Discordグループ](https://discord.gg/hRep4RUj7f)に参加するか、[テレグラムグループ](https://t.me/peass)に参加するか、[Twitter](https://twitter.com/hacktricks_live)で私をフォローしてください[🐦](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[@carlospolopm](https://twitter.com/hacktricks_live)。

- ハッキングのトリックを共有するには、[hacktricksリポジトリ](https://github.com/carlospolop/hacktricks)と[hacktricks-cloudリポジトリ](https://github.com/carlospolop/hacktricks-cloud)にPRを提出してください。
