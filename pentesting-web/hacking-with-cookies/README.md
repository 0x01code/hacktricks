# Piratage de Cookies

<details>

<summary><strong>Apprenez le piratage AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de piratage en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s les plus importantes pour les corriger plus rapidement. Intruder suit votre surface d'attaque, effectue des analyses de menaces proactives, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Attributs des Cookies

### Expires & Max-Age

* `Expires` d√©finit une date d'expiration pour la suppression d'un cookie
* `Max-age` d√©finit le temps en secondes avant la suppression d'un cookie **(utilisez ceci, nous ne sommes plus en 2009)**

### **Domain**

L'attribut `Domain` sp√©cifie **quels h√¥tes peuvent recevoir un cookie**. S'il n'est pas sp√©cifi√©, l'attribut **prend par d√©faut** le **m√™me h√¥te** qui a d√©fini le cookie, _**√† l'exclusion des sous-domaines**_. **Si `Domain` est** **sp√©cifi√©**, alors **les sous-domaines sont toujours inclus**. Par cons√©quent, sp√©cifier `Domain` est moins restrictif que de l'omettre. Cependant, cela peut √™tre utile lorsque les sous-domaines doivent partager des informations sur un utilisateur.

Par exemple, si vous d√©finissez `Domain=mozilla.org`, les cookies sont disponibles sur des sous-domaines comme `developer.mozilla.org`. Mais si vous ne le faites pas, le cookie ne sera pas envoy√© aux sous-domaines.

Si un **sous-domaine** `sub.example.com` **d√©finit un cookie** avec un attribut _domain_ de **`.example.com`**, il sera **envoy√©** lors des requ√™tes au **domaine parent.**

### **Path**

L'attribut `Path` indique un **chemin URL qui doit exister dans l'URL demand√©e pour envoyer l'en-t√™te `Cookie`**. Le caract√®re `%x2F` ("/") est consid√©r√© comme un s√©parateur de r√©pertoire, et les sous-r√©pertoires correspondent √©galement.

#### Ordre

Lorsque 2 cookies ont le **m√™me nom**, celui qui est envoy√© est :

* Celui avec le **chemin le plus long** correspondant au chemin de l'URL
* Le **plus r√©cent** si les deux ont le m√™me chemin

### SameSite

Cela indiquera au navigateur si le **cookie** peut √™tre envoy√© **depuis d'autres domaines**. Il a 3 valeurs possibles :

* **Strict** : Le cookie ne sera pas envoy√© avec une requ√™te par des sites tiers.
* **Lax** : Le cookie sera envoy√© avec la requ√™te GET initi√©e par des sites tiers.
* **None** : Le cookie est envoy√© de n'importe quel domaine tiers

| **Type de Requ√™te** | **Code Exemple**                   | **Cookies Envoy√©s Quand** |
| ------------------- | ---------------------------------- | ------------------------- |
| Lien                | \<a href="...">\</a>               | NotSet\*, Lax, None       |
| Prerender           | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None       |
| Form GET            | \<form method="GET" action="...">  | NotSet\*, Lax, None       |
| Form POST           | \<form method="POST" action="..."> | NotSet\*, None            |
| iframe              | \<iframe src="...">\</iframe>      | NotSet\*, None            |
| AJAX                | $.get("...")                       | NotSet\*, None            |
| Image               | \<img src="...">                   | NetSet\*, None            |

Tableau de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) et l√©g√®rement modifi√©.\
Un cookie avec l'attribut _**SameSite**_ **att√©nuera les attaques CSRF** o√π une session connect√©e est n√©cessaire.

**\*Remarquez qu'√† partir de Chrome80 (f√©v/2019) le comportement par d√©faut d'un cookie sans attribut samesite** **sera lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Notez que temporairement, apr√®s l'application de ce changement, les **cookies sans politique SameSite** dans Chrome seront **trait√©s comme None** pendant les **premi√®res 2 minutes puis comme Lax pour les requ√™tes POST inter-sites de niveau sup√©rieur.**

## Drapeaux des Cookies

### HttpOnly

Cela emp√™che le **client** d'acc√©der au cookie (Via **Javascript** par exemple : `document.cookie`)

#### **Contournements**

* Si la page **envoie les cookies comme r√©ponse** √† une requ√™te (par exemple sur une page **PHPinfo**), il est possible d'abuser du XSS pour envoyer une requ√™te √† cette page et **voler les cookies** de la r√©ponse (consultez un exemple sur [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Cela pourrait √™tre contourn√© avec des requ√™tes **HTTP TRACE** car la r√©ponse du serveur (si cette m√©thode HTTP est disponible) refl√©tera les cookies envoy√©s. Cette technique est appel√©e **Cross-Site Tracking**.
* Cette technique est √©vit√©e par les **navigateurs modernes en ne permettant pas l'envoi d'une requ√™te TRACE** depuis JS. Cependant, certains contournements ont √©t√© trouv√©s dans des logiciels sp√©cifiques comme l'envoi de `\r\nTRACE` au lieu de `TRACE` √† IE6.0 SP2.
* Une autre fa√ßon est l'exploitation de vuln√©rabilit√©s zero/day des navigateurs.
* Il est possible de **r√©√©crire des cookies HttpOnly** en effectuant une attaque par d√©bordement de Cookie Jar :

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Il est possible d'utiliser l'attaque [**Cookie Smuggling**](./#cookie-smuggling) pour exfiltrer ces cookies

### Secure

La requ√™te **n'envoie** le cookie dans une requ√™te HTTP **que si** la requ√™te est transmise sur un canal s√©curis√© (typiquement **HTTPS**).

## Pr√©fixes des Cookies

**Pr√©fixe `__Secure-`** : doit √™tre d√©fini avec le drapeau `secure` √† partir d'une page s√©curis√©e (HTTPS).

**Pr√©fixe `__Host-`** : doit √™tre d√©fini avec le drapeau `secure`, doit provenir d'une page s√©curis√©e (HTTPS), ne doit pas avoir de domaine sp√©cifi√© (et donc, n'est pas envoy√© aux sous-domaines), et le chemin doit √™tre `/`.

Les cookies pr√©fix√©s par `__Host-` ne peuvent pas √™tre envoy√©s aux superdomaines (cookies des sous-domaines vers les domaines) ou aux sous-domaines (cookies des domaines vers les sous-domaines), donc, si vous voulez isoler les cookies de votre application, les pr√©fixer tous avec `__Host-` n'est pas une mauvaise id√©e.

## Attaques sur les Cookies

Si vous trouvez un type de cookie personnalis√© contenant des donn√©es sensibles (sessionID, nom d'utilisateur, emails, etc.), vous devriez absolument essayer de l'exploiter

### D√©codage du cookie

Si le **cookie** utilise un **encodage de base** (comme Base64) ou similaire, vous pourriez √™tre capable de **le d√©coder**, **changer** le **contenu** et **usurper** des utilisateurs arbitraires.

### D√©tournement de session

Voler un cookie et l'utiliser pour usurper l'identit√© de l'utilisateur au sein d'une application

### Fixation de session

L'attaquant obtient un cookie d'une page web et envoie un lien √† la victime pour **se connecter en utilisant le m√™me cookie**. Si le cookie n'est pas chang√© lorsqu'un utilisateur se connecte, cela pourrait √™tre utile car l'attaquant pourrait √™tre capable d'usurper l'utilisateur √† travers un cookie.

Si vous avez trouv√© un **XSS dans un sous-domaine** ou si vous **contr√¥lez un sous-domaine**, lisez :

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Donation de session

L'attaquant envoie sa propre session √† la victime. La victime verra qu'elle est d√©j√† connect√©e et supposera qu'elle est dans son compte mais **les actions seront effectu√©es dans le compte de l'attaquant**.

Si vous avez trouv√© un **XSS dans un sous-domaine** ou si vous **contr√¥lez un sous-domaine**, lisez :

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookie JWT](../hacking-jwt-json-web-tokens.md)

Cliquez sur le lien pr√©c√©dent pour acc√©der √† une page expliquant les failles possibles dans les JWT.

### Cookie Vide

Les navigateurs permettent un cookie avec un nom vide
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // empty name
document.cookie = "b=v2"
```
Cela entra√Æne l'envoi de l'en-t√™te de cookie :
```
a=v1; test value; b=v2;
```
Plus int√©ressant encore, si vous disposez d'un vecteur qui vous permet de **d√©finir le cookie vide**, vous pouvez **contr√¥ler tout autre cookie** :
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // this sets the empty cookie to a=b
```
Bien que, dans le navigateur, cela soit d√©fini comme le cookie nomm√© vide, cela entra√Ænera l'**en-t√™te de cookie envoy√© :**
```
a=b;
```
Cela signifie que chaque serveur web l'interpr√©tera comme le cookie `a` √©tant d√©fini avec la valeur `b`.

### Bug Chrome - corruption de document.cookie <a href="#chrome-bugdocumentcookie-corruption" id="chrome-bugdocumentcookie-corruption"></a>

Si un point de code substitut Unicode est pr√©sent dans un cookie d√©fini, `document.cookie` sera d√©finitivement corrompu et renverra une cha√Æne vide.
```js
document.cookie
// "a=b;"
document.cookie = "\ud800=meep";
document.cookie
// ""
```
### D√©tournement de Cookie

Plusieurs serveurs web, y compris les serveurs Java Jetty, TomCat, Undertow, et le framework web Python Zope, ainsi que des serveurs/frameworks web Python comme cherrypy, web.py, aiohttp server, bottle, et webob, se sont av√©r√©s **analyser incorrectement les cha√Ænes de cookies** en raison du support r√©siduel pour RFC2965, un m√©canisme de citation de cookies obsol√®te qui utilise RFC2616 pour une d√©finition de cha√Æne entre guillemets.

Plus pr√©cis√©ment, **ces serveurs continuent de lire une cha√Æne de cookie lorsqu'ils rencontrent une valeur de cookie entre guillemets doubles (dquoted), m√™me si un point-virgule est rencontr√©**. Cela pose probl√®me car **les points-virgules sont cens√©s s√©parer les paires cl√©-valeur** dans la cha√Æne de cookie.

Par exemple, si un **navigateur envoie trois cookies, RENDER\_TEXT, JSESSIONID,** et **ASDF :**
```basic
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
ces serveurs les interpr√®tent comme faisant partie d'une **valeur de cookie unique** plut√¥t que de trois cookies s√©par√©s.

Cela conduit √† un risque de s√©curit√© : si un attaquant obtient un acc√®s de type cross-site scripting (XSS), il peut utiliser ce bug pour **exfiltrer des cookies sensibles comme les cookies HttpOnly**.

### Injection de Cookie

De nombreux serveurs web, y compris Undertow de Java, Zope de Python, et ceux utilisant http.cookie.SimpleCookie et http.cookie.BaseCookie de la biblioth√®que standard de Python, ont √©t√© trouv√©s pour **analyser incorrectement les cookies, en utilisant de mauvais d√©limiteurs pour commencer la paire nom/valeur du cookie suivant**. Cela permet √† un attaquant de **simuler plusieurs cookies tout en ne contr√¥lant qu'une seule valeur de cookie**.

Dans le cas d'**Undertow**, il commence l'analyse du cookie suivant imm√©diatement apr√®s **la fin d'une valeur de cookie entre guillemets**, sans attendre de point-virgule :
```bash
LANGUAGE="en-us" CSRF_TOKEN="SPOOFED_VALUE"
```
**Zope** commence l'analyse du cookie suivant sur une **virgule** :
```bash
LANGUAGE=en-us,CSRF_TOKEN=SPOOFED_VALUE
```
Et **Python's SimpleCookie** et **BaseCookie** commencent imm√©diatement √† analyser le prochain cookie sur un caract√®re **espace** :
```
LANGUAGE=en-us CSRF_TOKEN=SPOOFED_VALUE
```
En cons√©quence, les serveurs tels que **cherrypy**, **web.py**, **aiohttp** server, **bottle** et **webob** (Pyramid, TurboGears) sont tous vuln√©rables √† ce type d'attaque.

Ce probl√®me pr√©sente des **implications de s√©curit√©** significatives. Par exemple, si une application web utilise une **protection CSRF bas√©e sur les cookies**, un attaquant peut **injecter** un **cookie de jeton CSRF** falsifi√© pour contourner cette protection. De plus, le dernier nom de cookie en double dans les paquets http.cookie de Python remplace tous les pr√©c√©dents, rendant ce type d'attaque particuli√®rement facile.

De plus, le **spoofing** des cookies **`__Secure-`** et **`__Host-`** peut √™tre abus√© dans un contexte non s√©curis√©. Aussi, dans une configuration o√π les cookies sont transmis √† un serveur backend, **l'injection de cookies pourrait conduire √† des contournements d'autorisation** si le serveur backend est sensible au spoofing mais pas le serveur frontend.

### V√©rifications suppl√©mentaires des cookies vuln√©rables

#### **V√©rifications de base**

* Le **cookie** est **identique** √† chaque fois que vous vous **connectez**.
* D√©connectez-vous et essayez d'utiliser le m√™me cookie.
* Essayez de vous connecter avec 2 appareils (ou navigateurs) sur le m√™me compte en utilisant le m√™me cookie.
* V√©rifiez si le cookie contient des informations et essayez de le modifier.
* Essayez de cr√©er plusieurs comptes avec des noms d'utilisateur presque identiques et v√©rifiez si vous pouvez voir des similitudes.
* V√©rifiez l'option "**se souvenir de moi**" si elle existe pour voir comment elle fonctionne. Si elle existe et pourrait √™tre vuln√©rable, utilisez toujours le cookie de **se souvenir de moi** sans aucun autre cookie.
* V√©rifiez si le cookie pr√©c√©dent fonctionne m√™me apr√®s avoir chang√© le mot de passe.

#### **Attaques avanc√©es sur les cookies**

Si le cookie reste le m√™me (ou presque) lorsque vous vous connectez, cela signifie probablement que le cookie est li√© √† un champ de votre compte (probablement le nom d'utilisateur). Alors vous pouvez :

* Essayez de cr√©er beaucoup de **comptes** avec des noms d'utilisateur tr√®s **similaires** et essayez de **deviner** comment fonctionne l'algorithme.
* Essayez de **forcer brutalement le nom d'utilisateur**. Si le cookie sert uniquement de m√©thode d'authentification pour votre nom d'utilisateur, alors vous pouvez cr√©er un compte avec le nom d'utilisateur "**Bmin**" et **forcer brutalement** chaque **bit** de votre cookie car l'un des cookies que vous essayerez sera celui appartenant √† "**admin**".
* Essayez **Padding Oracle** (vous pouvez d√©chiffrer le contenu du cookie). Utilisez **padbuster**.

**Padding Oracle - Exemples avec Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster effectuera plusieurs tentatives et vous demandera quelle condition est la condition d'erreur (celle qui n'est pas valide).

Ensuite, il commencera √† d√©chiffrer le cookie (cela peut prendre plusieurs minutes)

Si l'attaque a √©t√© r√©alis√©e avec succ√®s, alors vous pourriez essayer de chiffrer une cha√Æne de votre choix. Par exemple, si vous vouliez **chiffrer** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Cette ex√©cution vous donnera le cookie correctement chiffr√© et encod√© avec la cha√Æne **user=administrator** √† l'int√©rieur.

**CBC-MAC**

Il se peut qu'un cookie ait une certaine valeur et soit sign√© en utilisant CBC. Ensuite, l'int√©grit√© de la valeur est la signature cr√©√©e en utilisant CBC avec la m√™me valeur. Comme il est recommand√© d'utiliser comme IV un vecteur nul, ce type de v√©rification d'int√©grit√© pourrait √™tre vuln√©rable.

**L'attaque**

1. Obtenez la signature du nom d'utilisateur **administ** = **t**
2. Obtenez la signature du nom d'utilisateur **rator\x00\x00\x00 XOR t** = **t'**
3. D√©finissez dans le cookie la valeur **administrator+t'** (**t'** sera une signature valide de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Si le cookie est chiffr√© en utilisant ECB, il pourrait √™tre vuln√©rable.\
Lorsque vous vous connectez, le cookie que vous recevez doit toujours √™tre le m√™me.

**Comment d√©tecter et attaquer :**

Cr√©ez 2 utilisateurs avec des donn√©es presque identiques (nom d'utilisateur, mot de passe, email, etc.) et essayez de d√©couvrir un motif √† l'int√©rieur du cookie donn√©

Cr√©ez un utilisateur appel√© par exemple "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" et v√©rifiez s'il y a un motif dans le cookie (comme ECB chiffre avec la m√™me cl√© chaque bloc, les m√™mes octets chiffr√©s pourraient appara√Ætre si le nom d'utilisateur est chiffr√©).

Il devrait y avoir un motif (de la taille d'un bloc utilis√©). Ainsi, sachant comment un tas de "a" est chiffr√©, vous pouvez cr√©er un nom d'utilisateur : "a"\*(taille du bloc)+"admin". Ensuite, vous pourriez supprimer le motif chiffr√© d'un bloc de "a" du cookie. Et vous aurez le cookie du nom d'utilisateur "admin".

## R√©f√©rences

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Trouvez les vuln√©rabilit√©s qui comptent le plus afin de les corriger plus rapidement. Intruder suit votre surface d'attaque, lance des scans de menaces proactifs, trouve des probl√®mes dans l'ensemble de votre pile technologique, des API aux applications web et aux syst√®mes cloud. [**Essayez-le gratuitement**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) aujourd'hui.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Apprenez le hacking AWS de z√©ro √† h√©ros avec</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Autres moyens de soutenir HackTricks :

* Si vous souhaitez voir votre **entreprise annonc√©e dans HackTricks** ou **t√©l√©charger HackTricks en PDF**, consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* Obtenez le [**merchandising officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* D√©couvrez [**La Famille PEASS**](https://opensea.io/collection/the-peass-family), notre collection d'[**NFTs**](https://opensea.io/collection/the-peass-family) exclusifs
* **Rejoignez le** üí¨ [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Partagez vos astuces de hacking en soumettant des PR aux d√©p√¥ts github** [**HackTricks**](https://github.com/carlospolop/hacktricks) et [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
