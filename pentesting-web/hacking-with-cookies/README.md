# Hacking de Cookies

<details>

<summary><strong>Aprenda hacking na AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ deseja ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira [**produtos oficiais PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-nos** no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

***

## Atributos de Cookies

Os cookies v√™m com v√°rios atributos que controlam seu comportamento no navegador do usu√°rio. Aqui est√° uma vis√£o geral desses atributos em uma voz mais passiva:

### Expira e Max-Age

A data de expira√ß√£o de um cookie √© determinada pelo atributo `Expires`. Por outro lado, o atributo `Max-age` define o tempo em segundos at√© que um cookie seja exclu√≠do. **Opte por `Max-age`, pois reflete pr√°ticas mais modernas.**

### Dom√≠nio

Os hosts para receber um cookie s√£o especificados pelo atributo `Domain`. Por padr√£o, isso √© definido como o host que emitiu o cookie, sem incluir seus subdom√≠nios. No entanto, quando o atributo `Domain` √© definido explicitamente, ele abrange tamb√©m os subdom√≠nios. Isso torna a especifica√ß√£o do atributo `Domain` uma op√ß√£o menos restritiva, √∫til para cen√°rios em que o compartilhamento de cookies entre subdom√≠nios √© necess√°rio. Por exemplo, definir `Domain=mozilla.org` torna os cookies acess√≠veis em seus subdom√≠nios como `developer.mozilla.org`.

### Caminho

Um caminho de URL espec√≠fico que deve estar presente na URL solicitada para que o cabe√ßalho `Cookie` seja enviado √© indicado pelo atributo `Path`. Este atributo considera o caractere `/` como um separador de diret√≥rio, permitindo correspond√™ncias em subdiret√≥rios tamb√©m.

### Regras de Ordena√ß√£o

Quando dois cookies t√™m o mesmo nome, o escolhido para envio √© baseado em:

* O cookie que corresponde ao caminho mais longo na URL solicitada.
* O cookie mais recentemente definido se os caminhos forem id√™nticos.

### SameSite

* O atributo `SameSite` dita se os cookies s√£o enviados em solicita√ß√µes originadas de dom√≠nios de terceiros. Ele oferece tr√™s configura√ß√µes:
* **Strict**: Restringe o cookie de ser enviado em solicita√ß√µes de terceiros.
* **Lax**: Permite que o cookie seja enviado com solicita√ß√µes GET iniciadas por sites de terceiros.
* **None**: Permite que o cookie seja enviado de qualquer dom√≠nio de terceiros.

Lembre-se, ao configurar cookies, entender esses atributos pode ajudar a garantir que eles se comportem conforme o esperado em diferentes cen√°rios.

| **Tipo de Solicita√ß√£o** | **C√≥digo de Exemplo**                   | **Cookies Enviados Quando** |
| ---------------- | ---------------------------------- | --------------------- |
| Link             | \<a href="...">\</a>               | NotSet\*, Lax, None   |
| Pr√©-renderiza√ß√£o        | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None   |
| Formul√°rio GET         | \<form method="GET" action="...">  | NotSet\*, Lax, None   |
| Formul√°rio POST        | \<form method="POST" action="..."> | NotSet\*, None        |
| iframe           | \<iframe src="...">\</iframe>      | NotSet\*, None        |
| AJAX             | $.get("...")                       | NotSet\*, None        |
| Imagem            | \<img src="...">                   | NetSet\*, None        |

Tabela de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) e ligeiramente modificada.\
Um cookie com atributo _**SameSite**_ ir√° **mitigar ataques CSRF** onde uma sess√£o logada √© necess√°ria.

**\*Observe que a partir do Chrome80 (fev/2019) o comportamento padr√£o de um cookie sem um atributo samesite** **ser√° lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Observe que temporariamente, ap√≥s aplicar essa altera√ß√£o, os **cookies sem uma pol√≠tica SameSite** **no Chrome ser√£o tratados como None** durante os **primeiros 2 minutos e depois como Lax para solicita√ß√µes POST entre sites de alto n√≠vel.**

## Flags de Cookies

### HttpOnly

Isso evita que o **cliente** acesse o cookie (por exemplo, via **Javascript**: `document.cookie`)

#### **Burlas**

* Se a p√°gina estiver **enviando os cookies como resposta** de uma solicita√ß√£o (por exemplo, em uma p√°gina **PHPinfo**), √© poss√≠vel abusar do XSS para enviar uma solicita√ß√£o para esta p√°gina e **roubar os cookies** da resposta (ver um exemplo em [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Isso poderia ser Burlado com solicita√ß√µes **HTTP TRACE** como a resposta do servidor (se este m√©todo HTTP estiver dispon√≠vel) refletir√° os cookies enviados. Essa t√©cnica √© chamada de **Cross-Site Tracking**.
* Essa t√©cnica √© evitada por **navegadores modernos ao n√£o permitir o envio de uma solicita√ß√£o TRACE** a partir do JS. No entanto, foram encontradas algumas formas de burlar isso em software espec√≠fico, como enviar `\r\nTRACE` em vez de `TRACE` para o IE6.0 SP2.
* Outra maneira √© a explora√ß√£o de vulnerabilidades zero/day dos navegadores.
* √â poss√≠vel **sobrescrever cookies HttpOnly** realizando um ataque de overflow do Cookie Jar:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* √â poss√≠vel usar um ataque de [**Cookie Smuggling**](./#cookie-smuggling) para exfiltrar esses cookies

### Seguro

A solicita√ß√£o enviar√° o cookie **apenas** em uma solicita√ß√£o HTTP se a solicita√ß√£o for transmitida por um canal seguro (tipicamente **HTTPS**).

## Prefixos de Cookies

Cookies prefixados com `__Secure-` devem ser definidos juntamente com a flag `secure` em p√°ginas que s√£o protegidas por HTTPS.

Para cookies prefixados com `__Host-`, v√°rias condi√ß√µes devem ser atendidas:

* Eles devem ser definidos com a flag `secure`.
* Eles devem originar de uma p√°gina protegida por HTTPS.
* √â proibido especificar um dom√≠nio para eles, impedindo sua transmiss√£o para subdom√≠nios.
* O caminho para esses cookies deve ser definido como `/`.

√â importante observar que cookies prefixados com `__Host-` n√£o podem ser enviados para superdom√≠nios ou subdom√≠nios. Essa restri√ß√£o ajuda a isolar cookies de aplicativos. Assim, empregar o prefixo `__Host-` para todos os cookies de aplicativos pode ser considerado uma boa pr√°tica para melhorar a seguran√ßa e a isolamento.
### Sobrescrevendo cookies

Portanto, uma das prote√ß√µes dos cookies prefixados com `__Host-` √© impedir que sejam sobrescritos por subdom√≠nios. Prevenindo, por exemplo, ataques de [**Cookie Tossing**](cookie-tossing.md). Na palestra [**Cookie Crumbles: Unveiling Web Session Integrity Vulnerabilities**](https://www.youtube.com/watch?v=F\_wAzF4a7Xg) ([**artigo**](https://www.usenix.org/system/files/usenixsecurity23-squarcina.pdf)) √© apresentado que era poss√≠vel definir cookies prefixados com \_\_HOST- a partir de subdom√≠nios, enganando o analisador, por exemplo, adicionando "=" no in√≠cio ou no in√≠cio e no final...:

<figure><img src="../../.gitbook/assets/image.png" alt=""><figcaption></figcaption></figure>

Ou em PHP era poss√≠vel adicionar **outros caracteres no in√≠cio** do nome do cookie que seriam **substitu√≠dos por caracteres de sublinhado**, permitindo sobrescrever cookies `__HOST-`:

<figure><img src="../../.gitbook/assets/image (1).png" alt="" width="373"><figcaption></figcaption></figure>

## Ataques a Cookies

Se um cookie personalizado cont√©m dados sens√≠veis, verifique-o (especialmente se estiver participando de um CTF), pois pode ser vulner√°vel.

### Decodifica√ß√£o e Manipula√ß√£o de Cookies

Dados sens√≠veis incorporados em cookies devem sempre ser examinados. Cookies codificados em Base64 ou formatos semelhantes muitas vezes podem ser decodificados. Essa vulnerabilidade permite que os atacantes alterem o conte√∫do do cookie e se fa√ßam passar por outros usu√°rios codificando seus dados modificados de volta no cookie.

### Sequestro de Sess√£o

Esse ataque envolve roubar o cookie de um usu√°rio para obter acesso n√£o autorizado √† sua conta em um aplicativo. Ao usar o cookie roubado, um atacante pode se passar pelo usu√°rio leg√≠timo.

### Fixa√ß√£o de Sess√£o

Neste cen√°rio, um atacante engana uma v√≠tima para usar um cookie espec√≠fico para fazer login. Se o aplicativo n√£o atribuir um novo cookie ao fazer login, o atacante, possuindo o cookie original, pode se passar pela v√≠tima. Essa t√©cnica depende da v√≠tima fazer login com um cookie fornecido pelo atacante.

Se voc√™ encontrou um **XSS em um subdom√≠nio** ou voc√™ **controla um subdom√≠nio**, leia:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Doa√ß√£o de Sess√£o

Aqui, o atacante convence a v√≠tima a usar o cookie de sess√£o do atacante. A v√≠tima, acreditando estar logada em sua pr√≥pria conta, inadvertidamente realizar√° a√ß√µes no contexto da conta do atacante.

Se voc√™ encontrou um **XSS em um subdom√≠nio** ou voc√™ **controla um subdom√≠nio**, leia:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [Cookies JWT](../hacking-jwt-json-web-tokens.md)

Clique no link anterior para acessar uma p√°gina explicando poss√≠veis falhas em JWT.

Tokens Web JSON (JWT) usados em cookies tamb√©m podem apresentar vulnerabilidades. Para obter informa√ß√µes detalhadas sobre poss√≠veis falhas e como explor√°-las, √© recomendado acessar o documento vinculado sobre hacking JWT.

### Falsifica√ß√£o de Solicita√ß√£o entre Sites (CSRF)

Esse ataque for√ßa um usu√°rio logado a executar a√ß√µes indesejadas em um aplicativo da web no qual ele est√° autenticado. Os atacantes podem explorar cookies que s√£o enviados automaticamente com cada solicita√ß√£o ao site vulner√°vel.

### Cookies Vazios

(Verifique mais detalhes na [pesquisa original](https://blog.ankursundara.com/cookie-bugs/)) Navegadores permitem a cria√ß√£o de cookies sem nome, o que pode ser demonstrado por meio de JavaScript da seguinte forma:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
O resultado no cabe√ßalho do cookie enviado √© `a=v1; valor de teste; b=v2;`. Curiosamente, isso permite a manipula√ß√£o de cookies se um cookie com nome vazio for definido, potencialmente controlando outros cookies ao definir o cookie vazio para um valor espec√≠fico:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
Isso leva o navegador a enviar um cabe√ßalho de cookie interpretado por todos os servidores da web como um cookie chamado `a` com um valor `b`.

#### Bug no Chrome: Problema com Ponto de C√≥digo de Substituto Unicode

No Chrome, se um ponto de c√≥digo de substituto Unicode fizer parte de um cookie definido, `document.cookie` se corrompe, retornando subsequentemente uma string vazia:
```js
document.cookie = "\ud800=meep";
```
Isso resulta em `document.cookie` produzindo uma string vazia, indicando corrup√ß√£o permanente.

#### Contrabando de Cookies Devido a Problemas de An√°lise

(Verifique mais detalhes na [pesquisa original](https://blog.ankursundara.com/cookie-bugs/)) V√°rios servidores web, incluindo os de Java (Jetty, TomCat, Undertow) e Python (Zope, cherrypy, web.py, aiohttp, bottle, webob), lidam incorretamente com strings de cookies devido ao suporte desatualizado ao RFC2965. Eles interpretam um valor de cookie entre aspas duplas como um √∫nico valor, mesmo que inclua ponto e v√≠rgula, que normalmente deveria separar pares chave-valor:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Vulnerabilidades de Inje√ß√£o de Cookies

(Consulte mais detalhes na [pesquisa original](https://blog.ankursundara.com/cookie-bugs/)) A an√°lise incorreta de cookies por servidores, especialmente Undertow, Zope e aqueles que usam `http.cookie.SimpleCookie` e `http.cookie.BaseCookie` do Python, cria oportunidades para ataques de inje√ß√£o de cookies. Esses servidores falham em delimitar corretamente o in√≠cio de novos cookies, permitindo que atacantes falsifiquem cookies:

- Undertow espera um novo cookie imediatamente ap√≥s um valor entre aspas sem ponto e v√≠rgula.
- Zope procura por uma v√≠rgula para iniciar a an√°lise do pr√≥ximo cookie.
- As classes de cookies do Python come√ßam a an√°lise em um caractere de espa√ßo.

Essa vulnerabilidade √© particularmente perigosa em aplica√ß√µes web que dependem de prote√ß√£o CSRF baseada em cookies, pois permite que os atacantes injetem cookies de token CSRF falsificados, potencialmente contornando medidas de seguran√ßa. O problema √© agravado pelo tratamento de nomes de cookies duplicados pelo Python, onde a √∫ltima ocorr√™ncia substitui as anteriores. Tamb√©m levanta preocupa√ß√µes para cookies `__Secure-` e `__Host-` em contextos inseguros e pode levar a bypass de autoriza√ß√£o quando cookies s√£o enviados para servidores back-end suscet√≠veis a falsifica√ß√£o.

### Verifica√ß√µes Extras de Cookies Vulner√°veis

#### **Verifica√ß√µes b√°sicas**

- O **cookie** √© o **mesmo** toda vez que voc√™ **faz login**.
- Fa√ßa logout e tente usar o mesmo cookie.
- Tente fazer login com 2 dispositivos (ou navegadores) na mesma conta usando o mesmo cookie.
- Verifique se o cookie cont√©m alguma informa√ß√£o e tente modific√°-lo.
- Tente criar v√°rias contas com usernames quase iguais e verifique se consegue ver semelhan√ßas.
- Verifique a op√ß√£o de "**lembrar-me**" se existir para ver como funciona. Se existir e puder ser vulner√°vel, sempre use o cookie de **lembrar-me** sem nenhum outro cookie.
- Verifique se o cookie anterior funciona mesmo depois de voc√™ alterar a senha.

#### **Ataques avan√ßados de cookies**

Se o cookie permanecer o mesmo (ou quase) ao fazer login, isso provavelmente significa que o cookie est√° relacionado a algum campo de sua conta (provavelmente o nome de usu√°rio). Ent√£o voc√™ pode:

- Tente criar muitas **contas** com usernames muito **semelhantes** e tente **adivinhar** como o algoritmo est√° funcionando.
- Tente **bruteforce no username**. Se o cookie salvar apenas como um m√©todo de autentica√ß√£o para seu nome de usu√°rio, ent√£o voc√™ pode criar uma conta com o nome de usu√°rio "**Bmin**" e **bruteforce** cada **bit** do seu cookie porque um dos cookies que voc√™ tentar√° ser√° o pertencente ao "**admin**".
- Tente **Padding** **Oracle** (voc√™ pode descriptografar o conte√∫do do cookie). Use **padbuster**.

**Padding Oracle - Exemplos do Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster far√° v√°rias tentativas e perguntar√° qual √© a condi√ß√£o de erro (aquela que n√£o √© v√°lida).

Em seguida, ele come√ßar√° a descriptografar o cookie (isso pode levar v√°rios minutos).

Se o ataque for realizado com sucesso, ent√£o voc√™ poder√° tentar criptografar uma string de sua escolha. Por exemplo, se voc√™ quiser **criptografar** **user=administrador**.
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Esta execu√ß√£o lhe dar√° o cookie corretamente criptografado e codificado com a string **user=administrator** dentro.

**CBC-MAC**

Talvez um cookie possa ter algum valor e ser assinado usando CBC. Ent√£o, a integridade do valor √© a assinatura criada usando CBC com o mesmo valor. Como √© recomendado usar um vetor nulo como IV, esse tipo de verifica√ß√£o de integridade pode ser vulner√°vel.

**O ataque**

1. Obter a assinatura do nome de usu√°rio **administ** = **t**
2. Obter a assinatura do nome de usu√°rio **rator\x00\x00\x00 XOR t** = **t'**
3. Definir no cookie o valor **administrator+t'** (**t'** ser√° uma assinatura v√°lida de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Se o cookie for criptografado usando ECB, pode ser vulner√°vel.\
Quando voc√™ faz login, o cookie que voc√™ recebe deve ser sempre o mesmo.

**Como detectar e atacar:**

Crie 2 usu√°rios com dados quase iguais (nome de usu√°rio, senha, e-mail, etc.) e tente descobrir algum padr√£o dentro do cookie fornecido.

Crie um usu√°rio chamado, por exemplo, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" e verifique se h√° algum padr√£o no cookie (como o ECB criptografa com a mesma chave a cada bloco, os mesmos bytes criptografados podem aparecer se o nome de usu√°rio for criptografado).

Deve haver um padr√£o (com o tamanho de um bloco usado). Assim, sabendo como um monte de "a" √© criptografado, voc√™ pode criar um nome de usu√°rio: "a"\*(tamanho do bloco)+"admin". Em seguida, voc√™ pode excluir o padr√£o criptografado de um bloco de "a" do cookie. E voc√™ ter√° o cookie do nome de usu√°rio "admin".

## Refer√™ncias

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653\_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)

**Try Hard Security Group**

<figure><img src="../.gitbook/assets/telegram-cloud-document-1-5159108904864449420.jpg" alt=""><figcaption></figcaption></figure>

{% embed url="https://discord.gg/tryhardsecurity" %}

<details>

<summary><strong>Aprenda hacking AWS do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF**, confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**swag oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou nos siga no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para os reposit√≥rios** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
