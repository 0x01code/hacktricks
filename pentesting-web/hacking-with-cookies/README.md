# Hakerski napad na kolačiće

<details>

<summary><strong>Naučite hakerski napad na AWS od početka do kraja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu na HackTricks-u** ili **preuzmete HackTricks u PDF formatu**, proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakerske trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Pronađite najvažnije ranjivosti kako biste ih brže popravili. Intruder prati vašu površinu napada, pokreće proaktivne pretnje, pronalazi probleme u celokupnom tehnološkom skupu, od API-ja do veb aplikacija i sistemima u oblaku. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Atributi kolačića

Kolačići dolaze sa nekoliko atributa koji kontrolišu njihovo ponašanje u korisnikovom pregledaču. Evo pregleda ovih atributa u pasivnijem glasu:

### Isteče i Max-Age

Datum isteka kolačića određuje atribut `Expires`. S druge strane, atribut `Max-age` definiše vreme u sekundama do brisanja kolačića. **Preporučuje se korišćenje `Max-age` jer odražava modernije prakse.**

### Domen

Domeni koji primaju kolačić su navedeni atributom `Domain`. Prema podrazumevanim podešavanjima, to je postavljeno na domen koji je izdao kolačić, ne uključujući njegove poddomene. Međutim, kada je eksplicitno postavljen atribut `Domain`, on obuhvata i poddomene. Ovo čini postavljanje atributa `Domain` manje restriktivnom opcijom, korisnom za scenarije u kojima je deljenje kolačića između poddomena neophodno. Na primer, postavljanje `Domain=mozilla.org` omogućava pristup kolačićima na njegovim poddomenima poput `developer.mozilla.org`.

### Putanja

Specifična URL putanja koja mora biti prisutna u zahtevanom URL-u kako bi se poslao zaglavlje `Cookie` je naznačena atributom `Path`. Ovaj atribut razmatra karakter `/` kao separator direktorijuma, omogućavajući podudaranja i u poddirektorijumima.

### Pravila za redosled

Kada dva kolačića imaju isto ime, onaj koji se šalje se određuje na osnovu:
- Kolačić koji se podudara sa najdužom putanjom u zahtevanom URL-u.
- Najskorije postavljen kolačić ako su putanje identične.

### SameSite

- Atribut `SameSite` određuje da li se kolačići šalju u zahtevima koji potiču sa domena treće strane. Ima tri podešavanja:
- **Strict**: Ograničava slanje kolačića u zahtevima treće strane.
- **Lax**: Omogućava slanje kolačića sa GET zahtevima pokrenutim od strane veb lokacija treće strane.
- **None**: Dozvoljava slanje kolačića sa bilo kog domena treće strane.

Zapamtite, prilikom konfigurisanja kolačića, razumevanje ovih atributa može pomoći da se osigura da se ponašaju onako kako se očekuje u različitim scenarijima.


| **Tip zahteva** | **Primer koda**                     | **Kolačići poslati kada** |
| --------------- | ---------------------------------- | ----------------------- |
| Link            | \<a href="...">\</a>               | NotSet\*, Lax, None     |
| Prerender       | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None     |
| Form GET        | \<form method="GET" action="...">  | NotSet\*, Lax, None     |
| Form POST       | \<form method="POST" action="..."> | NotSet\*, None          |
| iframe          | \<iframe src="...">\</iframe>      | NotSet\*, None          |
| AJAX            | $.get("...")                       | NotSet\*, None          |
| Slika           | \<img src="...">                   | NetSet\*, None          |

Tabela preuzeta sa [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) i blago izmenjena.\
Kolačić sa atributom _**SameSite**_ će **smanjiti CSRF napade** gde je potrebna prijavljena sesija.

**\*Primetite da od Chrome80 (feb/2019) podrazumevano ponašanje kolačića bez atributa samesite** **će biti lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Primetite da će privremeno, nakon primene ove promene, **kolačići bez SameSite politike** u Chrome-u biti **tretirani kao None** tokom **prvih 2 minuta, a zatim kao Lax za POST zahtev preko glavnog domena.**

## Zastavice kolačića

### HttpOnly

Ovo sprečava **klijenta** da pristupi kolačiću (Na primer, putem **Javascript-a**: `document.cookie`)

#### **Bypass-ovi**

* Ako stranica **šalje kolačiće kao odgovor** na zahtev (na primer, na **PHPinfo** stranici), moguće je zloupotrebiti XSS da se pošalje zahtev ovoj stranici i **ukrade kolačiće** iz odgovora (proverite primer na [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Ovo se može zaobići pomoću **TRACE** **HTTP** zahteva, jer će odgovor sa servera (ako je ovaj HTTP metod dostupan) odražavati poslate kolačiće. Ova tehnika se naziva **Cross-Site Tracking**.
* Ovu tehniku moderni pregledači izbegavaju tako što ne dozvoljavaju slanje TRACE zahteva iz JS-a. Međutim, neki zaobiđi za ovo su pronađeni u specifičnom softveru, kao što je slanje `\r\nTRACE` umesto `TRACE` na IE6.0 SP2.
* Drugi način je iskorišćavanje zero/day ranjivosti pregledača.
* Moguće je **prepisati HttpOnly kolačiće** izvršavanjem napada prelivanja Cookie Jar-a:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* Moguće je koristiti napad [**Cookie Smuggling**](./#cookie-smuggling) za izvlačenje ovih kolačića

### Secure

Zahtev će **samo** poslati kolačić u HTTP zahtevu samo ako je zahtev prenet preko sigurnog kanala (tipično **HTTPS**).
## Prefiksi kolačića

Kolačići sa prefiksom `__Secure-` moraju biti postavljeni zajedno sa zastavicom `secure` na stranicama koje su obezbeđene putem HTTPS protokola.

Za kolačiće sa prefiksom `__Host-`, moraju se ispuniti nekoliko uslova:
- Moraju biti postavljeni sa zastavicom `secure`.
- Moraju poticati sa stranice obezbeđene HTTPS protokolom.
- Zabranjeno je navođenje domena, čime se sprečava njihovo slanje na poddomene.
- Putanja za ove kolačiće mora biti postavljena na `/`.

Važno je napomenuti da kolačići sa prefiksom `__Host-` nisu dozvoljeni da se šalju superdomenima ili poddomenima. Ova restrikcija pomaže u izolaciji kolačića aplikacije. Stoga, korišćenje prefiksa `__Host-` za sve kolačiće aplikacije može se smatrati dobrom praksom za poboljšanje sigurnosti i izolacije.

## Napadi na kolačiće

Ako prilagođeni kolačić sadrži osetljive podatke, proverite ga (posebno ako igrate CTF), jer može biti ranjiv.

### Dekodiranje i manipulacija kolačićima

Osetljivi podaci ugrađeni u kolačiće uvek treba pažljivo pregledati. Kolačići kodirani u Base64 ili sličnim formatima često se mogu dekodirati. Ova ranjivost omogućava napadačima da izmene sadržaj kolačića i preuzmu identitet drugih korisnika enkodirajući svoje izmenjene podatke nazad u kolačić.

### Hakovanje sesije

Ovaj napad uključuje krađu korisničkog kolačića radi neovlašćenog pristupa njihovom nalogu unutar aplikacije. Korišćenjem ukradenog kolačića, napadač može sebe predstaviti kao legitimni korisnik.

### Fiksacija sesije

U ovom scenariju, napadač vara žrtvu da koristi određeni kolačić za prijavu. Ako aplikacija ne dodeli novi kolačić prilikom prijave, napadač koji poseduje originalni kolačić može se predstaviti kao žrtva. Ova tehnika se oslanja na to da žrtva prijavi sa kolačićem koji je obezbedio napadač.

Ako ste pronašli **XSS u poddomenu** ili **kontrolišete poddomen**, pročitajte:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Donacija sesije

Ovde napadač ubedi žrtvu da koristi kolačić sesije napadača. Žrtva, verujući da je prijavljena na svoj nalog, nesvesno će izvršavati radnje u kontekstu naloga napadača.

Ako ste pronašli **XSS u poddomenu** ili **kontrolišete poddomen**, pročitajte:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [JWT Kolačići](../hacking-jwt-json-web-tokens.md)

Kliknite na prethodni link da biste pristupili stranici koja objašnjava moguće slabosti u JWT. 

JSON Web Tokens (JWT) koji se koriste u kolačićima takođe mogu imati ranjivosti. Za detaljne informacije o potencijalnim slabostima i načinima njihovog iskorišćavanja, preporučuje se pristupanje povezanom dokumentu o hakovanju JWT.

### CSRF (Cross-Site Request Forgery)

Ovaj napad prisiljava prijavljenog korisnika da izvrši neželjene radnje na veb aplikaciji na kojoj je trenutno prijavljen. Napadači mogu iskoristiti kolačiće koji se automatski šalju sa svakim zahtevom ka ranjivoj stranici.

### Prazni kolačići

(Pogledajte dalje detalje u [originalnom istraživanju](https://blog.ankursundara.com/cookie-bugs/))
Preglednici dozvoljavaju kreiranje kolačića bez imena, što se može demonstrirati putem JavaScript-a kako sledi:
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // Setting an empty named cookie
document.cookie = "b=v2"
```
Rezultat u poslatom zaglavlju kolačića je `a=v1; test vrednost; b=v2;`. Zanimljivo je da ovo omogućava manipulaciju kolačićima ako se postavi prazan kolačić sa imenom, potencijalno kontrolišući druge kolačiće postavljanjem praznog kolačića na određenu vrednost:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // Setting the empty cookie modifies another cookie's value
```
Ovo dovodi do toga da pregledač šalje zaglavlje kolačića koje svaki veb server tumači kao kolačić sa imenom `a` i vrednošću `b`.

#### Chrome greška: Problem sa Unicode zamenskim kodnim tačkama

U Chrome-u, ako je Unicode zamenska kodna tačka deo postavljenog kolačića, `document.cookie` postaje oštećen, vraćajući prazan string naknadno:
```js
document.cookie = "\ud800=meep";
```
Ovo rezultira da `document.cookie` ispisuje prazan string, što ukazuje na trajno oštećenje.

#### Cookie Smuggling zbog problema sa parsiranjem

(Proverite dodatne detalje u [originalnom istraživanju](https://blog.ankursundara.com/cookie-bugs/))
Nekoliko web servera, uključujući one iz Java (Jetty, TomCat, Undertow) i Python (Zope, cherrypy, web.py, aiohttp, bottle, webob) okreću se cookie stringovima zbog zastarele podrške za RFC2965. Oni čitaju cookie vrednost u dvostrukim navodnicima kao jednu vrednost čak i ako sadrži tačke-zareze, koje bi normalno trebale razdvajati parove ključ-vrednost:
```
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
#### Vulnerabilnosti ubrizgavanja kolačića

(Proverite dodatne detalje u [originalnom istraživanju](https://blog.ankursundara.com/cookie-bugs/))
Nekorektno parsiranje kolačića od strane servera, posebno Undertow, Zope i onih koji koriste Python-ove `http.cookie.SimpleCookie` i `http.cookie.BaseCookie`, stvara mogućnosti za napade ubrizgavanjem kolačića. Ovi serveri nepravilno ograničavaju početak novih kolačića, omogućavajući napadačima da lažiraju kolačiće:

- Undertow očekuje novi kolačić odmah nakon navodnog vrednosti bez tačke-zareza.
- Zope traži zarez kako bi započeo parsiranje sledećeg kolačića.
- Python-ove klase kolačića započinju parsiranje na osnovu razmaka.

Ova ranjivost je posebno opasna u veb aplikacijama koje se oslanjaju na CSRF zaštitu zasnovanu na kolačićima, jer omogućava napadačima da ubrizgaju lažirane kolačiće sa CSRF-tokenima, potencijalno zaobilazeći sigurnosne mere. Problem se pogoršava Python-ovom obradom duplikata imena kolačića, gde poslednje pojavljivanje zamenjuje prethodna. Takođe izaziva zabrinutost za `__Secure-` i `__Host-` kolačiće u nesigurnim kontekstima i može dovesti do zaobilaženja autorizacije kada se kolačići prosleđuju serverskoj strani koja je podložna lažiranju.

### Dodatne provere ranjivih kolačića

#### **Osnovne provere**

* **Kolačić** je **uvek isti** prilikom **prijavljivanja**.
* Odjavite se i pokušajte da koristite isti kolačić.
* Pokušajte da se prijavite sa 2 uređaja (ili pregledača) na isti nalog koristeći isti kolačić.
* Proverite da li kolačić sadrži neke informacije i pokušajte da ga izmenite.
* Pokušajte da kreirate nekoliko naloga sa gotovo istim korisničkim imenom i proverite da li možete primetiti sličnosti.
* Proverite da li postoji opcija "**zapamti me**" i vidite kako funkcioniše. Ako postoji i može biti ranjiva, uvek koristite samo kolačić za **zapamti me** bez drugih kolačića.
* Proverite da li prethodni kolačić i dalje funkcioniše čak i nakon promene lozinke.

#### **Napredni napadi na kolačiće**

Ako se kolačić ne menja (ili se malo menja) prilikom prijavljivanja, to verovatno znači da je kolačić povezan sa nekim poljem vašeg naloga (verovatno korisničkim imenom). Tada možete:

* Pokušajte da kreirate mnogo **naloga** sa vrlo **sličnim** korisničkim imenima i pokušajte da **pretpostavite** kako algoritam funkcioniše.
* Pokušajte da **bruteforce-ujete korisničko ime**. Ako kolačić čuva samo autentifikacioni metod za vaše korisničko ime, možete kreirati nalog sa korisničkim imenom "**Bmin**" i **bruteforce-ovati** svaki **bit** vašeg kolačića jer jedan od kolačića koji ćete pokušati će biti onaj koji pripada "**admin**".
* Pokušajte **Padding Oracle** (možete dešifrovati sadržaj kolačića). Koristite **padbuster**.

**Padding Oracle - Primeri padbuster-a**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster će napraviti nekoliko pokušaja i pitati vas koja je uslovna greška (onaj koji nije validan).

Zatim će početi dešifrovanje kolačića (može potrajati nekoliko minuta).

Ako je napad uspešno izvršen, možete pokušati da šifrujete željeni string. Na primer, ako želite da **šifrujete** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Ova izvršenja će vam dati kolačić pravilno enkriptovan i kodiran sa stringom **user=administrator** unutra.

**CBC-MAC**

Možda kolačić može imati neku vrednost i može biti potpisan koristeći CBC. Zatim, celovitost vrednosti je potpis kreiran korišćenjem CBC sa istom vrednošću. Kako se preporučuje korišćenje nultog vektora kao IV, ovaj tip provere celovitosti može biti ranjiv.

**Napad**

1. Dobijte potpis korisničkog imena **administ** = **t**
2. Dobijte potpis korisničkog imena **rator\x00\x00\x00 XOR t** = **t'**
3. Postavite u kolačiću vrednost **administrator+t'** (**t'** će biti validan potpis **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Ako je kolačić enkriptovan koristeći ECB, može biti ranjiv.\
Kada se prijavite, kolačić koji dobijete mora uvek biti isti.

**Kako otkriti i napasti:**

Kreirajte 2 korisnika sa skoro istim podacima (korisničko ime, lozinka, email, itd.) i pokušajte otkriti neki obrazac unutar datog kolačića.

Kreirajte korisnika koji se zove na primer "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" i proverite da li postoji neki obrazac u kolačiću (kako ECB enkriptuje sa istim ključem svaki blok, isti enkriptovani bajtovi mogu se pojaviti ako je korisničko ime enkriptovano).

Treba da postoji obrazac (veličine korišćenog bloka). Dakle, znajući kako su enkriptovani nizovi "a", možete kreirati korisničko ime: "a"\*(veličina bloka)+"admin". Zatim, možete izbrisati enkriptovani obrazac bloka "a" iz kolačića. Imaćete kolačić korisničkog imena "admin".

## Reference

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)
* [https://www.linkedin.com/posts/rickey-martin-24533653_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd](https://www.linkedin.com/posts/rickey-martin-24533653_100daysofhacking-penetrationtester-ethicalhacking-activity-7016286424526180352-bwDd)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Pronađite najvažnije ranjivosti kako biste ih brže popravili. Intruder prati vašu površinu napada, pokreće proaktivne pretnje, pronalazi probleme u celokupnom tehnološkom skupu, od API-ja do veb aplikacija i cloud sistema. [**Isprobajte ga besplatno**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) danas.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Naučite hakovanje AWS-a od nule do heroja sa</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Drugi načini podrške HackTricks-u:

* Ako želite da vidite **vašu kompaniju reklamiranu u HackTricks-u** ili **preuzmete HackTricks u PDF formatu** Proverite [**SUBSCRIPTION PLANS**](https://github.com/sponsors/carlospolop)!
* Nabavite [**zvanični PEASS & HackTricks swag**](https://peass.creator-spring.com)
* Otkrijte [**The PEASS Family**](https://opensea.io/collection/the-peass-family), našu kolekciju ekskluzivnih [**NFT-ova**](https://opensea.io/collection/the-peass-family)
* **Pridružite se** 💬 [**Discord grupi**](https://discord.gg/hRep4RUj7f) ili [**telegram grupi**](https://t.me/peass) ili nas **pratite** na **Twitter-u** 🐦 [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Podelite svoje hakovanje trikove slanjem PR-ova na** [**HackTricks**](https://github.com/carlospolop/hacktricks) i [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repozitorijume.

</details>
