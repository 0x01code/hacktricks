# Hacking de Cookies

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Atributos de Cookies

### Expires & Max-Age

* `Expires` define uma data de expira√ß√£o para quando um cookie ser√° exclu√≠do
* `Max-age` define o tempo em segundos para quando um cookie ser√° exclu√≠do **(use isso, n√£o √© mais 2009)**

### **Domain**

O atributo `Domain` especifica **quais hosts podem receber um cookie**. Se n√£o especificado, o atributo **padr√£o** √© o **mesmo host** que definiu o cookie, _**excluindo subdom√≠nios**_. **Se `Domain` for especificado**, ent√£o **subdom√≠nios s√£o sempre inclu√≠dos**. Portanto, especificar `Domain` √© menos restritivo do que omiti-lo. No entanto, pode ser √∫til quando subdom√≠nios precisam compartilhar informa√ß√µes sobre um usu√°rio.

Por exemplo, se voc√™ definir `Domain=mozilla.org`, os cookies estar√£o dispon√≠veis em subdom√≠nios como `developer.mozilla.org`. Mas se voc√™ n√£o definir, o cookie n√£o ser√° enviado para subdom√≠nios.

Se um **subdom√≠nio** `sub.example.com` **definir um cookie** com o atributo _domain_ de **`.example.com`**, ele ser√° **enviado** em solicita√ß√µes para o **dom√≠nio pai.**

### **Path**

O atributo `Path` indica um **caminho de URL que deve existir no URL solicitado para enviar o cabe√ßalho `Cookie`**. O caractere `%x2F` ("/") √© considerado um separador de diret√≥rio, e subdiret√≥rios tamb√©m correspondem.

#### Ordem

Quando 2 cookies t√™m o **mesmo nome**, aquele que √© enviado √©:

* Aquele com o **caminho mais longo** correspondente ao caminho do URL
* O **mais recente** se ambos tiverem o mesmo caminho

### SameSite

Isso indicar√° ao navegador se o **cookie** pode ser enviado **de outros dom√≠nios**. Tem 3 valores poss√≠veis:

* **Estrito**: o cookie n√£o ser√° enviado junto com uma solicita√ß√£o por sites de terceiros.
* **Lax**: o cookie ser√° enviado junto com a solicita√ß√£o GET iniciada por sites de terceiros.
* **Nenhum**: o cookie √© enviado de qualquer dom√≠nio de terceiros

| **Tipo de solicita√ß√£o** | **C√≥digo de exemplo**               | **Cookies enviados quando** |
| ----------------------- | ---------------------------------- | --------------------------- |
| Link                    | \<a href="...">\</a>               | N√£o definido\*, Lax, Nenhum  |
| Prerender               | \<link rel="prerender" href=".."/> | N√£o definido\*, Lax, Nenhum  |
| Formul√°rio GET          | \<form method="GET" action="...">  | N√£o definido\*, Lax, Nenhum  |
| Formul√°rio POST         | \<form method="POST" action="..."> | N√£o definido\*, Nenhum       |
| iframe                  | \<iframe src="...">\</iframe>      | N√£o definido\*, Nenhum       |
| AJAX                    | $.get("...")                       | N√£o definido\*, Nenhum       |
| Imagem                  | \<img src="...">                   | NetSet\*, Nenhum             |

Tabela de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) e ligeiramente modificada.\
Um cookie com o atributo _**SameSite**_ ir√° **mitigar ataques CSRF** onde √© necess√°ria uma sess√£o iniciada.

**\*Observe que a partir do Chrome80 (fev/2019) o comportamento padr√£o de um cookie sem um atributo samesite de cookie ser√° lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Observe que temporariamente, ap√≥s a aplica√ß√£o dessa altera√ß√£o, os **cookies sem uma pol√≠tica SameSite** no Chrome ser√£o **tratados como Nenhum** durante os **primeiros 2 minutos e depois como Lax para solicita√ß√µes POST entre sites de n√≠vel superior.**

## Flags de Cookies

### HttpOnly

Isso evita que o **cliente** acesse o cookie (por exemplo, via **Javascript**: `document.cookie`)

#### **Bypasses**

* Se a p√°gina estiver **enviando os cookies como resposta** de uma solicita√ß√£o (por exemplo, em uma p√°gina **PHPinfo**), √© poss√≠vel abusar do XSS para enviar uma solicita√ß√£o para esta p√°gina e **roubar os cookies** da resposta (verifique um exemplo em [https://hackcommander.github.io/pentesting-article-1/)](https://hackcommander.github.io/pentesting-article-1/)
* Isso pode ser contornado com solicita√ß√µes **HTTP TRACE** **se a resposta do servidor refletir os cookies enviados** (se este m√©todo HTTP estiver dispon√≠vel). Essa t√©cnica √© chamada de **Cross-Site Tracking**.
  * Essa t√©cnica √© evitada por **navegadores modernos por n√£o permitir o envio de uma solicita√ß√£o TRACE** de JS. No entanto, alguns contornos para isso foram encontrados em software espec√≠fico, como o envio de `\
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // empty name
document.cookie = "b=v2"
```
Isso resulta no cabe√ßalho de cookie enviado:
```
a=v1; test value; b=v2;
```
Mais interessante ainda, se voc√™ tiver um vetor que de alguma forma permita **definir o cookie vazio**, voc√™ pode **controlar qualquer outro cookie**:
```js
function setCookie(name, value) {
    document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // this sets the empty cookie to a=b
```
Embora internamente no navegador, isso seja definido como o cookie nomeado vazio, resultar√° no **cabe√ßalho do cookie enviado:**
```
a=b;
```
Significando que todo servidor web ir√° interpret√°-lo como o cookie `a` sendo definido com o valor `b`.

### Bug do Chrome - corrup√ß√£o do document.cookie <a href="#chrome-bugdocumentcookie-corruption" id="chrome-bugdocumentcookie-corruption"></a>

Se um ponto de c√≥digo de substituto Unicode estiver em um cookie definido, `document.cookie` ser√° permanentemente corrompido e retornar√° uma string vazia.
```js
document.cookie
// "a=b;"
document.cookie = "\ud800=meep";
document.cookie
// ""
```
### Contrabando de Cookies

V√°rios servidores web, incluindo os servidores Java Jetty, TomCat, Undertow e o framework web Python Zope, bem como servidores/frameworks web Python como cherrypy, web.py, aiohttp server, bottle e webob, s√£o encontrados para **analisar incorretamente as strings de cookie** devido ao suporte restante para RFC2965, um mecanismo de cita√ß√£o de cookie desatualizado que usa RFC2616 para uma defini√ß√£o de string citada.

Especificamente, **esses servidores continuam lendo uma string de cookie quando encontram um valor de cookie entre aspas duplas (dquoted), mesmo que um ponto e v√≠rgula seja encontrado**. Isso √© problem√°tico porque **pontos e v√≠rgulas devem separar pares chave-valor** na string de cookie.

Por exemplo, se um **navegador envia tr√™s cookies, RENDER\_TEXT, JSESSIONID** e **ASDF:**
```basic
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
esses servidores os interpretam como parte de um **√∫nico valor de cookie** em vez de tr√™s cookies separados.

Isso leva a um risco de seguran√ßa: se um invasor ganhar acesso de script entre sites (XSS), ele pode usar esse bug para **extrair cookies sens√≠veis como cookies HttpOnly**.

### Inje√ß√£o de Cookie

Muitos servidores da web, incluindo o Undertow do Java, o Zope do Python e aqueles que usam o http.cookie.SimpleCookie e http.cookie.BaseCookie do stdlib do Python, foram encontrados para **analisar incorretamente cookies, usando delimitadores errados para iniciar o pr√≥ximo par de nome/valor do cookie**. Isso permite que um invasor **falsifique v√°rios cookies enquanto controla apenas um valor de cookie**.

No caso do **Undertow**, ele come√ßa a analisar o pr√≥ximo cookie imediatamente ap√≥s o **final de um valor de cookie entre aspas**, sem esperar por um ponto e v√≠rgula:
```bash
LANGUAGE="en-us" CSRF_TOKEN="SPOOFED_VALUE"
```
**Zope** come√ßa a analisar o pr√≥ximo cookie em uma **v√≠rgula**:
```bash
LANGUAGE=en-us,CSRF_TOKEN=SPOOFED_VALUE
```
E o **SimpleCookie** e o **BaseCookie** do Python imediatamente come√ßam a analisar o pr√≥ximo cookie em um caractere **espa√ßo**.
```
LANGUAGE=en-us CSRF_TOKEN=SPOOFED_VALUE
```
Como resultado, servidores como **cherrypy**, **web.py**, servidor **aiohttp**, **bottle** e **webob** (Pyramid, TurboGears) s√£o todos vulner√°veis a esse tipo de ataque.

Esse problema apresenta implica√ß√µes significativas de **seguran√ßa**. Por exemplo, se um aplicativo da web usa **prote√ß√£o CSRF baseada em cookie**, um invasor pode **injetar** um **cookie de token CSRF falsificado** para contornar essa prote√ß√£o. Al√©m disso, o √∫ltimo nome de cookie duplicado nos pacotes http.cookie do Python substitui todos os anteriores, tornando esse tipo de ataque especialmente f√°cil.

Al√©m disso, a **falsifica√ß√£o** de cookies **`__Secure-`** e **`__Host-`** pode ser explorada em um contexto inseguro. Al√©m disso, em uma configura√ß√£o em que os cookies s√£o passados para um servidor backend, a **inje√ß√£o de cookie pode levar a bypasses de autoriza√ß√£o** se o servidor backend for suscet√≠vel a falsifica√ß√£o, mas o servidor frontend n√£o for.

### Verifica√ß√µes extras de vulnerabilidade de cookies

#### **Verifica√ß√µes b√°sicas**

* O **cookie** √© o **mesmo** toda vez que voc√™ **faz login**.
* Fa√ßa logout e tente usar o mesmo cookie.
* Tente fazer login com 2 dispositivos (ou navegadores) na mesma conta usando o mesmo cookie.
* Verifique se o cookie tem alguma informa√ß√£o nele e tente modific√°-lo.
* Tente criar v√°rias contas com nomes de usu√°rio quase iguais e verifique se voc√™ pode ver semelhan√ßas.
* Verifique a op√ß√£o "**lembrar-me**" se ela existir para ver como funciona. Se existir e puder ser vulner√°vel, sempre use o cookie de **lembrar-me** sem nenhum outro cookie.
* Verifique se o cookie anterior funciona mesmo depois de voc√™ alterar a senha.

#### **Ataques avan√ßados de cookies**

Se o cookie permanecer o mesmo (ou quase o mesmo) quando voc√™ fizer login, isso provavelmente significa que o cookie est√° relacionado a algum campo da sua conta (provavelmente o nome de usu√°rio). Ent√£o voc√™ pode:

* Tente criar muitas **contas** com nomes de usu√°rio muito **semelhantes** e tente **adivinhar** como o algoritmo est√° funcionando.
* Tente **for√ßar o nome de usu√°rio**. Se o cookie salvar apenas como um m√©todo de autentica√ß√£o para o seu nome de usu√°rio, voc√™ pode criar uma conta com o nome de usu√°rio "**Bmin**" e **for√ßar** cada **bit** do seu cookie porque um dos cookies que voc√™ tentar√° ser√° o que pertence a "**admin**".
* Tente o **Padding** **Oracle** (voc√™ pode descriptografar o conte√∫do do cookie). Use o **padbuster**.

**Padding Oracle - Exemplos do Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
O Padbuster far√° v√°rias tentativas e perguntar√° qual √© a condi√ß√£o de erro (aquela que n√£o √© v√°lida).

Em seguida, ele come√ßar√° a descriptografar o cookie (isso pode levar v√°rios minutos).

Se o ataque for bem-sucedido, voc√™ poder√° tentar criptografar uma string de sua escolha. Por exemplo, se voc√™ quiser **criptografar** **user=administrador**.
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Essa execu√ß√£o ir√° fornecer o cookie corretamente criptografado e codificado com a string **user=administrator** dentro.

**CBC-MAC**

Talvez um cookie possa ter algum valor e ser assinado usando CBC. Ent√£o, a integridade do valor √© a assinatura criada usando CBC com o mesmo valor. Como √© recomendado usar um vetor nulo como IV, esse tipo de verifica√ß√£o de integridade pode ser vulner√°vel.

**O ataque**

1. Obter a assinatura do nome de usu√°rio **administ** = **t**
2. Obter a assinatura do nome de usu√°rio **rator\x00\x00\x00 XOR t** = **t'**
3. Definir no cookie o valor **administrator+t'** (**t'** ser√° uma assinatura v√°lida de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Se o cookie for criptografado usando ECB, ele pode ser vulner√°vel.\
Quando voc√™ faz login, o cookie que voc√™ recebe tem que ser sempre o mesmo.

**Como detectar e atacar:**

Crie 2 usu√°rios com dados quase iguais (nome de usu√°rio, senha, e-mail, etc.) e tente descobrir algum padr√£o dentro do cookie fornecido.

Crie um usu√°rio chamado, por exemplo, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" e verifique se h√° algum padr√£o no cookie (como ECB criptografa com a mesma chave a cada bloco, os mesmos bytes criptografados podem aparecer se o nome de usu√°rio for criptografado).

Deve haver um padr√£o (com o tamanho de um bloco usado). Ent√£o, sabendo como um monte de "a" √© criptografado, voc√™ pode criar um nome de usu√°rio: "a"\*(tamanho do bloco)+"admin". Ent√£o, voc√™ pode excluir o padr√£o criptografado de um bloco de "a" do cookie. E voc√™ ter√° o cookie do nome de usu√°rio "admin".

## Refer√™ncias

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo do Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo do telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e para o** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
