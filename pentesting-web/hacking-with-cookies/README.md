# Piratage de cookies

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

## Attributs des cookies

### Expires & Max-Age

* `Expires` d√©finit une date d'expiration pour la suppression d'un cookie
* `Max-age` d√©finit le temps en secondes pour la suppression d'un cookie **(utilisez cela, ce n'est plus 2009)**

### **Domaine**

L'attribut `Domain` sp√©cifie **quels h√¥tes peuvent recevoir un cookie**. S'il n'est pas sp√©cifi√©, l'attribut **par d√©faut** est le **m√™me h√¥te** qui a d√©fini le cookie, _**√† l'exclusion des sous-domaines**_. **Si `Domain` est sp√©cifi√©**, alors **les sous-domaines sont toujours inclus**. Par cons√©quent, sp√©cifier `Domain` est moins restrictif que l'omission. Cependant, cela peut √™tre utile lorsque les sous-domaines doivent partager des informations sur un utilisateur.

Par exemple, si vous d√©finissez `Domain=mozilla.org`, les cookies sont disponibles sur des sous-domaines tels que `developer.mozilla.org`. Mais si vous ne le faites pas, le cookie ne sera pas envoy√© aux sous-domaines.

Si un **sous-domaine** `sub.example.com` **d√©finit un cookie** avec l'attribut _domain_ de **`.example.com`**, il sera **envoy√©** sur les demandes du **domaine parent**.

### **Chemin**

L'attribut `Path` indique un **chemin d'URL qui doit exister dans l'URL demand√©e pour envoyer l'en-t√™te `Cookie`**. Le caract√®re `%x2F` ("/") est consid√©r√© comme un s√©parateur de r√©pertoire, et les sous-r√©pertoires correspondent √©galement.

#### Ordre

Lorsque 2 cookies ont le **m√™me nom**, celui qui est envoy√© est :

* Celui avec le **chemin le plus long** correspondant au chemin de l'URL
* Le **plus r√©cent** si les deux ont le m√™me chemin

### SameSite

Cela indiquera au navigateur si le **cookie** peut √™tre envoy√© **√† partir d'autres domaines**. Il a 3 valeurs possibles :

* **Strict** : Le cookie ne sera pas envoy√© avec une demande par des sites Web tiers.
* **Lax** : Le cookie sera envoy√© avec la demande GET initi√©e par des sites Web tiers.
* **None** : Le cookie est envoy√© √† partir de n'importe quel domaine tiers.

| **Type de demande** | **Code d'exemple**                  | **Cookies envoy√©s lorsque** |
| ------------------- | ---------------------------------- | --------------------------- |
| Lien                | \<a href="...">\</a>               | Non d√©fini\*, Lax, None     |
| Pr√©chargement       | \<link rel="prerender" href=".."/> | Non d√©fini\*, Lax, None     |
| Formulaire GET      | \<form method="GET" action="...">  | Non d√©fini\*, Lax, None     |
| Formulaire POST     | \<form method="POST" action="..."> | Non d√©fini\*, None          |
| iframe              | \<iframe src="...">\</iframe>      | Non d√©fini\*, None          |
| AJAX                | $.get("...")                       | Non d√©fini\*, None          |
| Image               | \<img src="...">                   | NetSet\*, None              |

Tableau de [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) et l√©g√®rement modifi√©.\
Un cookie avec l'attribut _**SameSite**_ **att√©nuera les attaques CSRF** o√π une session connect√©e est n√©cessaire.

**\*Notez qu'√† partir de Chrome80 (f√©v/2019), le comportement par d√©faut d'un cookie sans l'attribut samesite** **sera lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Notez que temporairement, apr√®s l'application de ce changement, les **cookies sans politique SameSite** dans Chrome seront **trait√©s comme None** pendant les **2 premi√®res minutes, puis comme Lax pour les demandes POST inter-sites de niveau sup√©rieur.**

## Drapeaux des cookies

### HttpOnly

Cela √©vite au **client** d'acc√©der au cookie (via **Javascript** par exemple : `document.cookie`)

#### **Contournements**

* Si la page envoie les cookies en tant que r√©ponse d'une demande (par exemple dans une page **PHPinfo**), il est possible d'exploiter la XSS pour envoyer une demande √† cette page et **voler les cookies** de la r√©ponse (voir un exemple dans [https://hackcommander.github.io/pentesting-article-1/)](https://hackcommander.github.io/pentesting-article-1/)
* Cela peut √™tre contourn√© avec des demandes HTTP **TRACE** car la r√©ponse du serveur (si cette m√©thode HTTP est disponible) refl√©tera les cookies envoy√©s. Cette technique s'appelle **Cross-Site Tracking**.
  * Cette technique est √©vit√©e par **les navigateurs modernes en n'autorisant pas l'envoi d'une demande TRACE** depuis JS. Cependant, certains contournements ont √©t√© trouv√©s dans des log
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // empty name
document.cookie = "b=v2"
```
Cela donne comme r√©sultat l'en-t√™te de cookie envoy√© :
```
a=v1; test value; b=v2;
```
Plus int√©ressant encore, si vous avez un vecteur qui vous permet d'une mani√®re ou d'une autre de **d√©finir le cookie vide**, vous pouvez **contr√¥ler n'importe quel autre cookie** :
```js
function setCookie(name, value) {
    document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // this sets the empty cookie to a=b
```
Bien que, en interne dans le navigateur, cela soit d√©fini comme un cookie nomm√© vide, cela se traduira par l'**en-t√™te de cookie envoy√© :**
```
a=b;
```
Cela signifie que chaque serveur web l'interpr√©tera comme si le cookie `a` √©tait d√©fini √† la valeur `b`.

### Bug Chrome - corruption de document.cookie <a href="#chrome-bugdocumentcookie-corruption" id="chrome-bugdocumentcookie-corruption"></a>

Si un point de code de substitution Unicode est pr√©sent dans un cookie d√©fini, `document.cookie` sera corrompu de mani√®re permanente et renverra une cha√Æne vide.
```js
document.cookie
// "a=b;"
document.cookie = "\ud800=meep";
document.cookie
// ""
```
### Contrebande de cookies

Plusieurs serveurs web, y compris les serveurs Java Jetty, TomCat, Undertow et le framework web Python Zope, ainsi que les serveurs/frameworks web Python tels que cherrypy, web.py, aiohttp server, bottle et webob, sont trouv√©s pour **analyser incorrectement les cha√Ænes de cookies** en raison du support restant pour RFC2965, un m√©canisme de citation de cookie obsol√®te qui utilise RFC2616 pour une d√©finition de cha√Æne cit√©e.

Plus pr√©cis√©ment, **ces serveurs continuent de lire une cha√Æne de cookies lorsqu'ils rencontrent une valeur de cookie entre guillemets doubles (dquoted), m√™me s'ils rencontrent un point-virgule**. Cela pose probl√®me car **les points-virgules sont cens√©s s√©parer les paires cl√©-valeur** dans la cha√Æne de cookies.

Par exemple, si un **navigateur envoie trois cookies, RENDER\_TEXT, JSESSIONID,** et **ASDF:**
```basic
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
Ces serveurs les interpr√®tent comme faisant partie d'une **seule valeur de cookie** plut√¥t que de trois cookies distincts.

Cela entra√Æne un risque de s√©curit√© : si un attaquant obtient un acc√®s de script intersite (XSS), il peut utiliser cette faille pour **exfiltrer des cookies sensibles tels que les cookies HttpOnly**.

### Injection de cookie

De nombreux serveurs Web, y compris Undertow de Java, Zope de Python et ceux utilisant http.cookie.SimpleCookie et http.cookie.BaseCookie de la biblioth√®que standard de Python, ont √©t√© trouv√©s pour **analyser incorrectement les cookies, en utilisant de mauvais d√©limiteurs pour commencer la paire nom/valeur du cookie suivant**. Cela permet √† un attaquant de **fausser plusieurs cookies tout en ne contr√¥lant qu'une seule valeur de cookie**.

Dans le cas d'**Undertow**, il commence √† analyser le cookie suivant imm√©diatement apr√®s la **fin d'une valeur de cookie entre guillemets**, sans attendre un point-virgule :
```bash
LANGUAGE="en-us" CSRF_TOKEN="SPOOFED_VALUE"
```
**Zope** commence √† analyser le cookie suivant sur une **virgule** :
```bash
LANGUAGE=en-us,CSRF_TOKEN=SPOOFED_VALUE
```
Et **SimpleCookie** et **BaseCookie** de Python commencent imm√©diatement √† analyser le cookie suivant sur un caract√®re **espace** :
```
LANGUAGE=en-us CSRF_TOKEN=SPOOFED_VALUE
```
En cons√©quence, des serveurs tels que **cherrypy**, **web.py**, le serveur **aiohttp**, **bottle** et **webob** (Pyramid, TurboGears) sont tous vuln√©rables √† ce type d'attaque.

Ce probl√®me pr√©sente des **implications de s√©curit√©** importantes. Par exemple, si une application Web utilise une protection CSRF bas√©e sur les cookies, un attaquant peut **injecter** un **cookie de jeton CSRF falsifi√©** pour contourner cette protection. De plus, le dernier nom de cookie en double dans les packages http.cookie de Python remplace tous les pr√©c√©dents, rendant ce type d'attaque particuli√®rement facile.

De plus, le **falsification** des cookies **`__Secure-`** et **`__Host-`** peut √™tre exploit√©e dans un contexte non s√©curis√©. De plus, dans une configuration o√π les cookies sont transmis √† un serveur backend, l'injection de cookies pourrait entra√Æner des contournements d'autorisation si le serveur backend est susceptible de falsification mais que le serveur frontend ne l'est pas.

### V√©rifications suppl√©mentaires des cookies vuln√©rables

#### **V√©rifications de base**

* Le **cookie** est le **m√™me** √† chaque fois que vous **vous connectez**.
* D√©connectez-vous et essayez d'utiliser le m√™me cookie.
* Essayez de vous connecter avec 2 appareils (ou navigateurs) sur le m√™me compte en utilisant le m√™me cookie.
* V√©rifiez si le cookie contient des informations et essayez de le modifier.
* Essayez de cr√©er plusieurs comptes avec des noms d'utilisateur presque identiques et v√©rifiez si vous pouvez voir des similitudes.
* V√©rifiez l'option "**se souvenir de moi**" si elle existe pour voir comment elle fonctionne. Si elle existe et qu'elle peut √™tre vuln√©rable, utilisez toujours le cookie de **se souvenir de moi** sans aucun autre cookie.
* V√©rifiez si le cookie pr√©c√©dent fonctionne m√™me apr√®s avoir chang√© le mot de passe.

#### **Attaques de cookies avanc√©es**

Si le cookie reste le m√™me (ou presque) lorsque vous vous connectez, cela signifie probablement que le cookie est li√© √† un champ de votre compte (probablement le nom d'utilisateur). Ensuite, vous pouvez :

* Essayez de cr√©er beaucoup de **comptes** avec des noms d'utilisateur tr√®s **similaires** et essayez de **deviner** comment fonctionne l'algorithme.
* Essayez de **forcer le nom d'utilisateur**. Si le cookie ne sauvegarde que comme m√©thode d'authentification pour votre nom d'utilisateur, vous pouvez cr√©er un compte avec le nom d'utilisateur "**Bmin**" et **forcer** chaque **bit** de votre cookie car l'un des cookies que vous essayerez sera celui appartenant √† "**admin**".
* Essayez **Padding** **Oracle** (vous pouvez d√©crypter le contenu du cookie). Utilisez **padbuster**.

**Padding Oracle - Exemples de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster effectuera plusieurs tentatives et vous demandera quelle condition est la condition d'erreur (celle qui n'est pas valide).

Ensuite, il commencera √† d√©crypter le cookie (cela peut prendre plusieurs minutes).

Si l'attaque a r√©ussi, vous pouvez essayer de crypter une cha√Æne de votre choix. Par exemple, si vous voulez **crypter** **user=administrateur**.
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Cette ex√©cution vous donnera le cookie correctement crypt√© et encod√© avec la cha√Æne **user=administrator** √† l'int√©rieur.

**CBC-MAC**

Il se peut qu'un cookie ait une certaine valeur et qu'il puisse √™tre sign√© en utilisant CBC. Ensuite, l'int√©grit√© de la valeur est la signature cr√©√©e en utilisant CBC avec la m√™me valeur. Comme il est recommand√© d'utiliser un vecteur nul comme IV, ce type de v√©rification d'int√©grit√© pourrait √™tre vuln√©rable.

**L'attaque**

1. Obtenir la signature de l'utilisateur **administ** = **t**
2. Obtenir la signature de l'utilisateur **rator\x00\x00\x00 XOR t** = **t'**
3. D√©finir dans le cookie la valeur **administrator+t'** (**t'** sera une signature valide de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Si le cookie est crypt√© en utilisant ECB, il pourrait √™tre vuln√©rable.\
Lorsque vous vous connectez, le cookie que vous recevez doit √™tre toujours le m√™me.

**Comment d√©tecter et attaquer:**

Cr√©ez 2 utilisateurs avec presque les m√™mes donn√©es (nom d'utilisateur, mot de passe, e-mail, etc.) et essayez de d√©couvrir un certain mod√®le √† l'int√©rieur du cookie donn√©.

Cr√©ez un utilisateur appel√©, par exemple, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" et v√©rifiez s'il y a un mod√®le dans le cookie (comme ECB chiffre avec la m√™me cl√© chaque bloc, les m√™mes octets chiffr√©s pourraient appara√Ætre si le nom d'utilisateur est chiffr√©).

Il devrait y avoir un mod√®le (avec la taille d'un bloc utilis√©). Ainsi, en sachant comment un tas de "a" est chiffr√©, vous pouvez cr√©er un nom d'utilisateur: "a"\*(taille du bloc)+"admin". Ensuite, vous pouvez supprimer le mod√®le chiffr√© d'un bloc de "a" du cookie. Et vous aurez le cookie de l'utilisateur "admin".

## R√©f√©rences

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Travaillez-vous dans une **entreprise de cybers√©curit√©** ? Voulez-vous voir votre **entreprise annonc√©e dans HackTricks** ? ou voulez-vous avoir acc√®s √† la **derni√®re version de PEASS ou t√©l√©charger HackTricks en PDF** ? Consultez les [**PLANS D'ABONNEMENT**](https://github.com/sponsors/carlospolop)!
* D√©couvrez [**The PEASS Family**](https://opensea.io/collection/the-peass-family), notre collection exclusive de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obtenez le [**swag officiel PEASS & HackTricks**](https://peass.creator-spring.com)
* **Rejoignez le** [**üí¨**](https://emojipedia.org/speech-balloon/) [**groupe Discord**](https://discord.gg/hRep4RUj7f) ou le [**groupe telegram**](https://t.me/peass) ou **suivez** moi sur **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Partagez vos astuces de piratage en soumettant des PR au** [**repo hacktricks**](https://github.com/carlospolop/hacktricks) **et au** [**repo hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
