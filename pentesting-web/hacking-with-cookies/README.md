# Cookies Hacking

<details>

<summary><strong>Aprenda AWS hacking do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras formas de apoiar o HackTricks:

* Se voc√™ quer ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao grupo** üí¨ [**Discord**](https://discord.gg/hRep4RUj7f) ou ao grupo [**telegram**](https://t.me/peass) ou **siga** me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para os reposit√≥rios do GitHub** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais r√°pido. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gr√°tis**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}

***

## Atributos de Cookies

### Expires & Max-Age

* `Expires` define uma data de expira√ß√£o para quando um cookie √© deletado
* `Max-age` define o tempo em segundos para quando um cookie ser√° deletado **(use isso, n√£o estamos mais em 2009)**

### **Domain**

O atributo `Domain` especifica **quais hosts podem receber um cookie**. Se n√£o especificado, o atributo **assume por padr√£o** o **mesmo host** que definiu o cookie, _**excluindo subdom√≠nios**_. **Se `Domain` √©** **especificado**, ent√£o **subdom√≠nios s√£o sempre inclu√≠dos**. Portanto, especificar `Domain` √© menos restritivo do que omiti-lo. No entanto, pode ser √∫til quando subdom√≠nios precisam compartilhar informa√ß√µes sobre um usu√°rio.

Por exemplo, se voc√™ definir `Domain=mozilla.org`, cookies estar√£o dispon√≠veis em subdom√≠nios como `developer.mozilla.org`. Mas se voc√™ n√£o definir, o cookie n√£o ser√° enviado para subdom√≠nios.

Se um **subdom√≠nio** `sub.example.com` **definir um cookie** com atributo _domain_ de **`.example.com`**, ele ser√° **enviado** em solicita√ß√µes para o **dom√≠nio pai.**

### **Path**

O atributo `Path` indica um **caminho URL que deve existir na URL solicitada para enviar o cabe√ßalho `Cookie`**. O caractere `%x2F` ("/") √© considerado um separador de diret√≥rio, e subdiret√≥rios tamb√©m s√£o correspondidos.

#### Ordem

Quando 2 cookies t√™m o **mesmo nome**, o que √© enviado √©:

* Aquele com o **caminho mais longo** correspondente ao caminho da URL
* O **mais novo** se ambos tiverem o mesmo caminho

### SameSite

Isso indicar√° ao navegador se o **cookie** pode ser enviado **de outros dom√≠nios**. Tem 3 valores poss√≠veis:

* **Strict**: O cookie n√£o ser√° enviado junto com uma solicita√ß√£o por sites de terceiros.
* **Lax**: O cookie ser√° enviado junto com a solicita√ß√£o GET iniciada por sites de terceiros.
* **None**: O cookie √© enviado de qualquer dom√≠nio de terceiros

| **Tipo de Solicita√ß√£o** | **C√≥digo de Exemplo**                   | **Cookies Enviados Quando** |
| ---------------- | ---------------------------------- | --------------------- |
| Link             | \<a href="...">\</a>               | NotSet\*, Lax, None   |
| Prerender        | \<link rel="prerender" href=".."/> | NotSet\*, Lax, None   |
| Form GET         | \<form method="GET" action="...">  | NotSet\*, Lax, None   |
| Form POST        | \<form method="POST" action="..."> | NotSet\*, None        |
| iframe           | \<iframe src="...">\</iframe>      | NotSet\*, None        |
| AJAX             | $.get("...")                       | NotSet\*, None        |
| Image            | \<img src="...">                   | NetSet\*, None        |

Tabela da [Invicti](https://www.netsparker.com/blog/web-security/same-site-cookie-attribute-prevent-cross-site-request-forgery/) e ligeiramente modificada.\
Um cookie com atributo _**SameSite**_ **mitigar√° ataques CSRF** onde uma sess√£o logada √© necess√°ria.

**\*Observe que a partir do Chrome80 (fev/2019) o comportamento padr√£o de um cookie sem um atributo samesite** **ser√° lax** ([https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/](https://www.troyhunt.com/promiscuous-cookies-and-their-impending-death-via-the-samesite-policy/)).\
Observe que temporariamente, ap√≥s aplicar essa mudan√ßa, os **cookies sem uma pol√≠tica SameSite** no Chrome ser√£o **tratados como None** durante os **primeiros 2 minutos e depois como Lax para solicita√ß√£o POST cross-site de n√≠vel superior.**

## Bandeiras de Cookies

### HttpOnly

Isso impede que o **cliente** acesse o cookie (Via **Javascript**, por exemplo: `document.cookie`)

#### **Bypasses**

* Se a p√°gina est√° **enviando os cookies como resposta** de uma solicita√ß√£o (por exemplo, em uma p√°gina **PHPinfo**), √© poss√≠vel abusar do XSS para enviar uma solicita√ß√£o a esta p√°gina e **roubar os cookies** da resposta (confira um exemplo em [https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/](https://hackcommander.github.io/posts/2022/11/12/bypass-httponly-via-php-info-page/).
* Isso poderia ser contornado com solicita√ß√µes **TRACE** **HTTP** j√° que a resposta do servidor (se este m√©todo HTTP estiver dispon√≠vel) refletir√° os cookies enviados. Esta t√©cnica √© chamada de **Cross-Site Tracking**.
* Esta t√©cnica √© evitada por **navegadores modernos por n√£o permitirem o envio de uma solicita√ß√£o TRACE** a partir do JS. No entanto, alguns bypasses para isso foram encontrados em softwares espec√≠ficos, como enviar `\r\nTRACE` em vez de `TRACE` para o IE6.0 SP2.
* Outra forma √© a explora√ß√£o de vulnerabilidades zero/day dos navegadores.
* √â poss√≠vel **sobrescrever cookies HttpOnly** realizando um ataque de estouro de Cookie Jar:

{% content-ref url="cookie-jar-overflow.md" %}
[cookie-jar-overflow.md](cookie-jar-overflow.md)
{% endcontent-ref %}

* √â poss√≠vel usar o ataque de [**Cookie Smuggling**](./#cookie-smuggling) para exfiltrar esses cookies

### Secure

A solicita√ß√£o **apenas** enviar√° o cookie em uma solicita√ß√£o HTTP se a solicita√ß√£o for transmitida por um canal seguro (tipicamente **HTTPS**).

## Prefixos de Cookies

**`__Secure-` prefixo**: deve ser definido com a bandeira `secure` a partir de uma p√°gina segura (HTTPS).

**`__Host-` prefixo**: deve ser definido com a bandeira `secure`, deve ser de uma p√°gina segura (HTTPS), n√£o deve ter um dom√≠nio especificado (e, portanto, n√£o s√£o enviados para subdom√≠nios), e o caminho deve ser `/`.

Cookies com prefixo `__Host-` n√£o podem ser enviados para superdom√≠nios (cookies de subdom√≠nios para dom√≠nios) ou subdom√≠nios (cookies de dom√≠nios para subdom√≠nios), ent√£o, se voc√™ quiser isolar os cookies da sua aplica√ß√£o, prefixar tudo com `__Host-` n√£o √© uma m√° ideia.

## Ataques de Cookies

Se voc√™ encontrar algum tipo de cookie personalizado contendo dados sens√≠veis (sessionID, nome de usu√°rio, emails, etc.) voc√™ definitivamente deve tentar explor√°-lo

### Decodificando o cookie

Se o **cookie** estiver usando algum **Base encoding** (como Base64) ou similar, voc√™ pode ser capaz de **decodific√°-lo**, **alterar** o **conte√∫do** e **impersonar** usu√°rios arbitr√°rios.

### Session Hijacking

Roubar um cookie e us√°-lo para se passar pelo usu√°rio dentro de uma aplica√ß√£o

### Session fixation

O atacante obt√©m um cookie de uma p√°gina web e envia um link para a v√≠tima para **entrar usando exatamente o mesmo cookie**. Se o cookie n√£o for alterado quando um usu√°rio faz login, isso pode ser √∫til porque o atacante poderia ser capaz de se passar pelo usu√°rio atrav√©s de um cookie.

Se voc√™ encontrou um **XSS em um subdom√≠nio** ou voc√™ **controla um subdom√≠nio**, leia:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### Session donation

O atacante envia sua pr√≥pria sess√£o para a v√≠tima. A v√≠tima ver√° que j√° est√° logada e supor√° que est√° dentro de sua conta, mas **as a√ß√µes ser√£o realizadas dentro da conta do atacante**.

Se voc√™ encontrou um **XSS em um subdom√≠nio** ou voc√™ **controla um subdom√≠nio**, leia:

{% content-ref url="cookie-tossing.md" %}
[cookie-tossing.md](cookie-tossing.md)
{% endcontent-ref %}

### [JWT Cookie](../hacking-jwt-json-web-tokens.md)

Clique no link anterior para acessar uma p√°gina explicando poss√≠veis falhas em JWT.

### Cookie Vazio

Navegadores permitem um cookie com um nome vazio
```js
document.cookie = "a=v1"
document.cookie = "=test value;" // empty name
document.cookie = "b=v2"
```
Isso resulta no cabe√ßalho de cookie enviado:
```
a=v1; test value; b=v2;
```
Mais interessante ainda, se voc√™ tiver um vetor que de alguma forma permita **definir o cookie vazio**, voc√™ pode **controlar qualquer outro cookie**:
```js
function setCookie(name, value) {
document.cookie = `${name}=${value}`;
}

setCookie("", "a=b"); // this sets the empty cookie to a=b
```
Embora internamente no navegador, isso seja definido como o cookie de nome vazio, isso resultar√° no **cabe√ßalho do cookie enviado:**
```
a=b;
```
Significa que todo servidor web o interpretar√° como o cookie `a` sendo definido com o valor `b`.

### Bug do Chrome - corrup√ß√£o de document.cookie <a href="#chrome-bugdocumentcookie-corruption" id="chrome-bugdocumentcookie-corruption"></a>

Se um ponto de c√≥digo substituto unicode estiver em um cookie definido, `document.cookie` ser√° permanentemente corrompido e retornar√° uma string vazia.
```js
document.cookie
// "a=b;"
document.cookie = "\ud800=meep";
document.cookie
// ""
```
### Contrabando de Cookies

V√°rios servidores web, incluindo servidores Java como Jetty, TomCat, Undertow, e o framework web Python Zope, bem como servidores/frameworks web Python como cherrypy, web.py, aiohttp server, bottle e webob, s√£o encontrados para **interpretar incorretamente strings de cookies** devido ao suporte remanescente para RFC2965, um mecanismo de cota√ß√£o de cookies desatualizado que usa RFC2616 para uma defini√ß√£o de string entre aspas.

Especificamente, **esses servidores continuam lendo uma string de cookie quando encontram um valor de cookie entre aspas duplas (dquoted), mesmo se um ponto e v√≠rgula for encontrado**. Isso √© problem√°tico porque **pontos e v√≠rgulas devem separar pares chave-valor** na string de cookie.

Por exemplo, se um **navegador envia tr√™s cookies, RENDER\_TEXT, JSESSIONID,** e **ASDF:**
```basic
RENDER_TEXT="hello world; JSESSIONID=13371337; ASDF=end";
```
esses servidores os interpretam como parte de um **valor √∫nico de cookie** em vez de tr√™s cookies separados.

Isso leva a um risco de seguran√ßa: se um atacante obtiver acesso a cross-site scripting (XSS), ele pode usar esse bug para **exfiltrar cookies sens√≠veis como cookies HttpOnly**.

### Inje√ß√£o de Cookie

Muitos servidores web, incluindo o Undertow do Java, o Zope do Python e aqueles que usam o http.cookie.SimpleCookie e o http.cookie.BaseCookie da stdlib do Python, foram encontrados **interpretando incorretamente os cookies, usando delimitadores errados para iniciar o pr√≥ximo par nome/valor do cookie**. Isso permite que um atacante **simule m√∫ltiplos cookies enquanto controla apenas o valor de um cookie**.

No caso do **Undertow**, ele come√ßa a interpretar o pr√≥ximo cookie imediatamente ap√≥s o **final de um valor de cookie entre aspas**, sem esperar por um ponto e v√≠rgula:
```bash
LANGUAGE="en-us" CSRF_TOKEN="SPOOFED_VALUE"
```
**Zope** come√ßa a analisar o pr√≥ximo cookie em uma **v√≠rgula**:
```bash
LANGUAGE=en-us,CSRF_TOKEN=SPOOFED_VALUE
```
E o **Python's SimpleCookie** e o **BaseCookie** come√ßam imediatamente a analisar o pr√≥ximo cookie em um caractere de **espa√ßo**:
```
LANGUAGE=en-us CSRF_TOKEN=SPOOFED_VALUE
```
Como resultado, servidores como **cherrypy**, **web.py**, **aiohttp** server, **bottle** e **webob** (Pyramid, TurboGears) s√£o todos vulner√°veis a esse tipo de ataque.

Essa quest√£o apresenta significativas **implica√ß√µes de seguran√ßa**. Por exemplo, se uma aplica√ß√£o web usa **prote√ß√£o CSRF baseada em cookie**, um atacante pode **injetar** um **cookie de token CSRF** falsificado para burlar essa prote√ß√£o. Al√©m disso, o √∫ltimo nome de cookie duplicado nos pacotes http.cookie do Python sobrescreve quaisquer anteriores, tornando esse tipo de ataque especialmente f√°cil.

Al√©m disso, o **spoofing** de cookies **`__Secure-`** e **`__Host-`** pode ser abusado em um contexto inseguro. Tamb√©m, em uma configura√ß√£o onde cookies s√£o passados para um servidor backend, **inje√ß√£o de cookie pode levar a bypasses de autoriza√ß√£o** se o servidor backend for suscet√≠vel a spoofing, mas o servidor frontend n√£o for.

### Verifica√ß√µes Extras de Cookies Vulner√°veis

#### **Verifica√ß√µes b√°sicas**

* O **cookie** √© o **mesmo** toda vez que voc√™ faz **login**.
* Fa√ßa logout e tente usar o mesmo cookie.
* Tente fazer login com 2 dispositivos (ou navegadores) na mesma conta usando o mesmo cookie.
* Verifique se o cookie tem alguma informa√ß√£o nele e tente modific√°-lo.
* Tente criar v√°rias contas com nomes de usu√°rio quase iguais e verifique se voc√™ pode ver semelhan√ßas.
* Verifique a op√ß√£o "**lembrar de mim**" se ela existir para ver como funciona. Se existir e puder ser vulner√°vel, sempre use o cookie de **lembrar de mim** sem nenhum outro cookie.
* Verifique se o cookie anterior funciona mesmo ap√≥s voc√™ mudar a senha.

#### **Ataques avan√ßados com cookies**

Se o cookie permanece o mesmo (ou quase) quando voc√™ faz login, isso provavelmente significa que o cookie est√° relacionado a algum campo da sua conta (provavelmente o nome de usu√°rio). Ent√£o voc√™ pode:

* Tentar criar v√°rias **contas** com nomes de usu√°rio muito **semelhantes** e tentar **adivinhar** como o algoritmo est√° funcionando.
* Tentar **for√ßa bruta no nome de usu√°rio**. Se o cookie salva apenas como um m√©todo de autentica√ß√£o para o seu nome de usu√°rio, ent√£o voc√™ pode criar uma conta com o nome de usu√°rio "**Bmin**" e **for√ßar a bruta** em cada **bit** do seu cookie porque um dos cookies que voc√™ tentar ser√° o pertencente a "**admin**".
* Tentar **Padding Oracle** (voc√™ pode descriptografar o conte√∫do do cookie). Use **padbuster**.

**Padding Oracle - Exemplos de Padbuster**
```bash
padbuster <URL/path/when/successfully/login/with/cookie> <COOKIE> <PAD[8-16]>
# When cookies and regular Base64
padbuster http://web.com/index.php u7bvLewln6PJPSAbMb5pFfnCHSEd6olf 8 -cookies auth=u7bvLewln6PJPSAbMb5pFfnCHSEd6olf

# If Base64 urlsafe or hex-lowercase or hex-uppercase --encoding parameter is needed, for example:
padBuster http://web.com/home.jsp?UID=7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6
7B216A634951170FF851D6CC68FC9537858795A28ED4AAC6 8 -encoding 2
```
Padbuster far√° v√°rias tentativas e perguntar√° qual condi√ß√£o √© a condi√ß√£o de erro (a que n√£o √© v√°lida).

Em seguida, come√ßar√° a descriptografar o cookie (pode levar v√°rios minutos)

Se o ataque foi realizado com sucesso, ent√£o voc√™ poderia tentar criptografar uma string de sua escolha. Por exemplo, se voc√™ quisesse **criptografar** **user=administrator**
```
padbuster http://web.com/index.php 1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== 8 -cookies thecookie=1dMjA5hfXh0jenxJQ0iW6QXKkzAGIWsiDAKV3UwJPT2lBP+zAD0D0w== -plaintext user=administrator
```
Esta execu√ß√£o fornecer√° o cookie corretamente criptografado e codificado com a string **user=administrator** dentro.

**CBC-MAC**

Talvez um cookie possa ter algum valor e possa ser assinado usando CBC. Ent√£o, a integridade do valor √© a assinatura criada usando CBC com o mesmo valor. Como √© recomendado usar como IV um vetor nulo, esse tipo de verifica√ß√£o de integridade pode ser vulner√°vel.

**O ataque**

1. Obter a assinatura do nome de usu√°rio **administ** = **t**
2. Obter a assinatura do nome de usu√°rio **rator\x00\x00\x00 XOR t** = **t'**
3. Definir no cookie o valor **administrator+t'** (**t'** ser√° uma assinatura v√°lida de **(rator\x00\x00\x00 XOR t) XOR t** = **rator\x00\x00\x00**

**ECB**

Se o cookie √© criptografado usando ECB, ele pode ser vulner√°vel.\
Quando voc√™ faz login, o cookie que voc√™ recebe tem que ser sempre o mesmo.

**Como detectar e atacar:**

Crie 2 usu√°rios com dados quase iguais (nome de usu√°rio, senha, email, etc.) e tente descobrir algum padr√£o dentro do cookie dado

Crie um usu√°rio chamado, por exemplo, "aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa" e verifique se h√° algum padr√£o no cookie (como ECB criptografa com a mesma chave cada bloco, os mesmos bytes criptografados podem aparecer se o nome de usu√°rio for criptografado).

Deve haver um padr√£o (com o tamanho de um bloco usado). Ent√£o, sabendo como um monte de "a" √© criptografado, voc√™ pode criar um nome de usu√°rio: "a"\*(tamanho do bloco)+"admin". Ent√£o, voc√™ poderia deletar o padr√£o criptografado de um bloco de "a" do cookie. E voc√™ ter√° o cookie do nome de usu√°rio "admin".

## Refer√™ncias

* [https://blog.ankursundara.com/cookie-bugs/](https://blog.ankursundara.com/cookie-bugs/)

<figure><img src="/.gitbook/assets/image (675).png" alt=""><figcaption></figcaption></figure>

Encontre vulnerabilidades que importam mais para que voc√™ possa corrigi-las mais r√°pido. Intruder rastreia sua superf√≠cie de ataque, executa varreduras proativas de amea√ßas, encontra problemas em toda a sua pilha tecnol√≥gica, de APIs a aplicativos web e sistemas em nuvem. [**Experimente gratuitamente**](https://www.intruder.io/?utm\_source=referral\&utm\_campaign=hacktricks) hoje.

{% embed url="https://www.intruder.io/?utm_campaign=hacktricks&utm_source=referral" %}


<details>

<summary><strong>Aprenda AWS hacking do zero ao her√≥i com</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Outras maneiras de apoiar o HackTricks:

* Se voc√™ quiser ver sua **empresa anunciada no HackTricks** ou **baixar o HackTricks em PDF** Confira os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Adquira o [**material oficial PEASS & HackTricks**](https://peass.creator-spring.com)
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos
* **Junte-se ao** üí¨ [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga**-me no **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/carlospolopm)**.**
* **Compartilhe suas dicas de hacking enviando PRs para os reposit√≥rios github** [**HackTricks**](https://github.com/carlospolop/hacktricks) e [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
